const ACTIVATION_PIN_URL = 'https://gist.githubusercontent.com/cx3300-1/f04ec50b5e8f2d88365d17ff35efffcf/raw/cd28d8825c5c34ea10bda8a4518a1a6a1f5a7d13/pin.txt';

// ========== QQ‰∏ªÂ±èÂπïUndefinedËøáÊª§Âô®ÔºàÂ§ñÈìæÂäüËÉΩÔºâ ==========
/**
 * ËøáÊª§Ê∂àÊÅØÂÜÖÂÆπ‰∏≠ÁöÑundefinedÊñáÊú¨
 * Áî®‰∫é‰∏ªÂ±èÂπïQQËÅäÂ§©ÔºåÂΩìËßíËâ≤ËæìÂá∫undefinedÊó∂Ëá™Âä®ËøáÊª§
 * @param {string} content - ÂéüÂßãÊ∂àÊÅØÂÜÖÂÆπ
 * @returns {string} - ËøáÊª§ÂêéÁöÑÊ∂àÊÅØÂÜÖÂÆπ
 */
function qqUndefinedFilter(content) {
  if (!content || typeof content !== 'string') {
    return content;
  }

  // ËøáÊª§ÂêÑÁßçÂΩ¢ÂºèÁöÑundefined
  let filtered = content
    // ËøáÊª§ÂçïÁã¨ÁöÑundefinedÔºàÂâçÂêéÂèØËÉΩÊúâÁ©∫Ê†º„ÄÅÊç¢Ë°åÁ≠âÔºâ
    .replace(/^\s*undefined\s*$/gi, '')
    // ËøáÊª§Âè•Â≠êÂºÄÂ§¥ÁöÑundefined
    .replace(/^\s*undefined\s+/gi, '')
    // ËøáÊª§Âè•Â≠êÁªìÂ∞æÁöÑundefined
    .replace(/\s+undefined\s*$/gi, '')
    // ËøáÊª§Âè•Â≠ê‰∏≠Èó¥ÁöÑundefinedÔºà‰∏§ËæπÊúâÁ©∫Ê†ºÔºâ
    .replace(/\s+undefined\s+/gi, ' ')
    // ËøáÊª§ËøûÁª≠Â§ö‰∏™undefined
    .replace(/undefined\s*undefined/gi, '')
    // ËøáÊª§undefinedÂêéÈù¢Ë∑üÊ†áÁÇπÁ¨¶Âè∑ÁöÑÊÉÖÂÜµ
    .replace(/undefined([,Ôºå.„ÄÇ!ÔºÅ?Ôºü;Ôºõ:Ôºö])/gi, '$1')
    // ËøáÊª§Ê†áÁÇπÁ¨¶Âè∑ÂêéÈù¢Ë∑üundefinedÁöÑÊÉÖÂÜµ
    .replace(/([,Ôºå.„ÄÇ!ÔºÅ?Ôºü;Ôºõ:Ôºö])\s*undefined/gi, '$1');

  // Â¶ÇÊûúËøáÊª§ÂêéÂè™Ââ©Á©∫ÁôΩÂ≠óÁ¨¶ÔºåËøîÂõûÁ©∫Â≠óÁ¨¶‰∏≤
  filtered = filtered.trim();

  // Â¶ÇÊûúÊï¥‰∏™ÂÜÖÂÆπÈÉΩÊòØundefinedÔºåËøîÂõûÁ©∫Â≠óÁ¨¶‰∏≤
  if (filtered === '' || filtered.toLowerCase() === 'undefined') {
    return '';
  }

  return filtered;
}
// ========== QQ‰∏ªÂ±èÂπïUndefinedËøáÊª§Âô®ÁªìÊùü ==========

// ========== Ë¥ßÂ∏ÅÊò†Â∞ÑÈÖçÁΩÆ ==========
const CURRENCY_MAP = {
  'China': { symbol: '¬•', name: '‰∫∫Ê∞ëÂ∏Å', code: 'CNY', rate: 1.0 },
  'USA': { symbol: '$', name: 'ÁæéÂÖÉ', code: 'USD', rate: 7.25 },
  'Japan': { symbol: '¬•', name: 'Êó•ÂÖÉ', code: 'JPY', rate: 0.05 },
  'UK': { symbol: '¬£', name: 'Ëã±Èïë', code: 'GBP', rate: 9.15 },
  'Europe': { symbol: '‚Ç¨', name: 'Ê¨ßÂÖÉ', code: 'EUR', rate: 7.8 },
  'Austria': { symbol: '‚Ç¨', name: 'Ê¨ßÂÖÉ', code: 'EUR', rate: 7.8 },
  'Korea': { symbol: '‚Ç©', name: 'Èü©ÂÖÉ', code: 'KRW', rate: 0.0054 },
  'Russia': { symbol: '‚ÇΩ', name: 'Âç¢Â∏É', code: 'RUB', rate: 0.075 },
  'India': { symbol: '‚Çπ', name: 'Âç¢ÊØî', code: 'INR', rate: 0.086 },
  'Canada': { symbol: 'C$', name: 'Âä†ÂÖÉ', code: 'CAD', rate: 5.15 },
  'Australia': { symbol: 'A$', name: 'Êæ≥ÂÖÉ', code: 'AUD', rate: 4.65 },
  'Singapore': { symbol: 'S$', name: 'Êñ∞Âä†Âù°ÂÖÉ', code: 'SGD', rate: 5.38 },
  'Thailand': { symbol: '‡∏ø', name: 'Ê≥∞Èì¢', code: 'THB', rate: 0.21 },
  'Vietnam': { symbol: '‚Ç´', name: 'Ë∂äÂçóÁõæ', code: 'VND', rate: 0.0003 },
  'None': { symbol: '¬•', name: '‰∫∫Ê∞ëÂ∏Å', code: 'CNY', rate: 1.0 } // Êó†ÂõΩÁ±çÈªòËÆ§‰∫∫Ê∞ëÂ∏Å
};

// Ëé∑ÂèñËßíËâ≤ÁöÑË¥ßÂ∏Å‰ø°ÊÅØ
function getCurrencyForChat(chat) {
  if (!chat || !chat.country) {
    return CURRENCY_MAP['China']; // ÈªòËÆ§‰∏≠ÂõΩ
  }
  return CURRENCY_MAP[chat.country] || CURRENCY_MAP['China'];
}

// Ëé∑ÂèñËßíËâ≤ÁöÑËÆ∞ÂøÜ‰∏ä‰∏ãÊñáÔºàËá™Âä®Âà§Êñ≠ÊòØÂê¶‰ΩøÁî®ÁªìÊûÑÂåñËÆ∞ÂøÜÔºâ
function getMemoryContextForPrompt(chat, options = {}) {
  const { includeTimestamp = false } = options;
  
  // Â¶ÇÊûúÂºÄÂêØ‰∫ÜÁªìÊûÑÂåñËÆ∞ÂøÜ‰∏îÊ®°ÂùóÂ∑≤Âä†ËΩΩ
  if (chat.settings && chat.settings.enableStructuredMemory && window.structuredMemoryManager) {
    return window.structuredMemoryManager.serializeForPrompt(chat);
  }
  
  // ÂéüÊúâÈÄªËæë
  if (!chat.longTermMemory || chat.longTermMemory.length === 0) {
    return '- (ÊöÇÊó†)';
  }
  
  if (includeTimestamp) {
    // formatTimeAgo Âú® DOMContentLoaded ÂÜÖÈÉ®ÂÆö‰πâÔºåËøôÈáåÁî®ÁÆÄÂçïÁöÑÊó∂Èó¥Ê†ºÂºèÊõø‰ª£
    return chat.longTermMemory.map(mem => {
      const d = new Date(mem.timestamp);
      const dateStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      return `- (${dateStr}) ${mem.content}`;
    }).join('\n');
  }
  return chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
}

// Â§ñÂ∏ÅÊç¢ÁÆóÊàê‰∫∫Ê∞ëÂ∏Å
function convertToCNY(amount, currency) {
  if (!currency || !currency.rate) {
    return amount; // ÈªòËÆ§‰∏çÊç¢ÁÆó
  }
  return amount * currency.rate;
}
// ========== Ë¥ßÂ∏ÅÊò†Â∞ÑÈÖçÁΩÆÁªìÊùü ==========

function escapeHTML(str) {
  if (!str) return '';
  return str.replace(/[&<>"']/g, function (match) {
    return {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[match];
  });
}
function generateRandomPacketAmounts(totalAmount, count) {
  let remainingAmount = totalAmount;
  let remainingCount = count;
  const amounts = [];
  const min = 0.01;

  for (let i = 0; i < count - 1; i++) {

    const avg = remainingAmount / remainingCount;
    const absoluteMax = remainingAmount - (remainingCount - 1) * min;

    let max = Math.min(avg * 2, absoluteMax);
    if (max < min) {
      max = min;
    }

    let amount = Math.random() * (max - min) + min;
    amount = parseFloat(amount.toFixed(2));

    amounts.push(amount);
    remainingAmount -= amount;
    remainingCount--;
  }


  amounts.push(parseFloat(remainingAmount.toFixed(2)));

  for (let i = amounts.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [amounts[i], amounts[j]] = [amounts[j], amounts[i]];
  }

  console.log(`[Á∫¢ÂåÖÁîüÊàê]: ÊÄªÈáëÈ¢ù ${totalAmount}, Êï∞Èáè ${count}. ÂàÜÈÖçÁªìÊûú:`, amounts);
  return amounts;
}

function getDeviceId() {
  let deviceId = localStorage.getItem('ephoneDeviceId');
  if (!deviceId) {

    deviceId = ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
    localStorage.setItem('ephoneDeviceId', deviceId);
  }
  return deviceId;
}


const EPHONE_DEVICE_ID = getDeviceId();
console.log(`EPhone ËÆæÂ§áID: ${EPHONE_DEVICE_ID}`);

// ÂÖ®Â±Ä API Ë∞ÉÁî®ÊéßÂà∂Âô®
let currentApiController = null;

let isPinActivated = localStorage.getItem('ephonePinActivated') === 'true';



const translations = {
  'zh-CN': {

    save: '‰øùÂ≠ò',
    cancel: 'ÂèñÊ∂à',
    confirm: 'Á°ÆÂÆö',
    edit: 'ÁºñËæë',
    done: 'ÂÆåÊàê',
    add: 'Ê∑ªÂä†',
    back: 'ËøîÂõû',
    next: '‰∏ã‰∏ÄÊ≠•',
    close: 'ÂÖ≥Èó≠',
    reset: 'ÈáçÁΩÆ',
    upload: '‰∏ä‰º†',
    send: 'ÂèëÈÄÅ',
    manage: 'ÁÆ°ÁêÜ',
    share: 'ÂàÜ‰∫´',
    delete: 'Âà†Èô§',
    publish: 'ÂèëÂ∏É',
    refresh: 'Âà∑Êñ∞',
    search: 'ÊêúÁ¥¢',
    remove: 'ÁßªÈô§',
    finish: 'ÁªìÊùü',
    details: 'ËØ¶ÊÉÖ',
    settings: 'ËÆæÁΩÆ',
    title: 'Ê†áÈ¢ò',
    content: 'ÂÜÖÂÆπ',
    category: 'ÂàÜÁ±ª',
    name: 'ÂêçÁß∞',
    description: 'ÊèèËø∞',
    status: 'Áä∂ÊÄÅ',
    ok: 'Â•ΩÁöÑ',
    error: 'ÈîôËØØ',
    success: 'ÊàêÂäü',
    warning: 'Ë≠¶Âëä',
    loading: 'Âä†ËΩΩ‰∏≠...',
    processing: 'Â§ÑÁêÜ‰∏≠...',
    pleaseWait: 'ËØ∑Á®çÂÄô...',
    languageChangedAlert: 'ËØ≠Ë®ÄÂ∑≤ÂàáÊç¢ÔºåÈ°µÈù¢Âç≥Â∞ÜÂà∑Êñ∞‰ª•Â∫îÁî®Êõ¥Êîπ„ÄÇ',


    // --- ‰∏ªÂ±èÂπï & Dock ---
    homeAppQQ: 'QQ',
    homeAppWorldBook: '‰∏ñÁïå‰π¶',
    homeAppAppearance: 'Â§ñËßÇËÆæÁΩÆ',
    homeAppRenderer: 'Ê∏≤ÊüìÂô®',
    homeAppApiSettings: 'ËÆæÁΩÆ',
    homeAppFont: 'Â≠ó‰Ωì',
    homeAppCPhone: 'CPhone',
    homeAppDouban: 'Ë±ÜÁì£',
    homeAppPreset: 'È¢ÑËÆæ',
    homeAppTutorial: 'ÊïôÁ®ã',
    homeAppWerewolf: 'Áãº‰∫∫ÊùÄ',
    homeAppX: 'X',
    homeAppCharGenerator: 'ËßíËâ≤ÁîüÊàê',

    // --- ËÅäÂ§©ÂàóË°®È°µ ---
    chatListTitle: 'Ê∂àÊÅØ',
    navMessages: 'Ê∂àÊÅØ',
    navQzone: 'Âä®ÊÄÅ',
    navMemories: 'ÂõûÂøÜ',
    navFavorites: 'Êî∂Ëóè',
    navNpcList: 'NPC',

    // --- QZone & Âä®ÊÄÅ ---
    qzoneTitle: 'Â•ΩÂèãÂä®ÊÄÅ',
    qzoneActionShuoshuo: 'ËØ¥ËØ¥',
    qzoneActionPost: 'Âä®ÊÄÅ',
    qzoneActionAlbum: 'Áõ∏ÂÜå',

    // --- CPhone (ËßíËâ≤ÊâãÊú∫) ---
    cphoneTitleSelect: 'ÈÄâÊã©‰∏ÄÈÉ®ÊâãÊú∫',
    cphoneAppQQ: 'QQ',
    cphoneAppAlbum: 'Áõ∏ÂÜå',
    cphoneAppBrowser: 'ÊµèËßàÂô®',
    cphoneAppTaobao: 'Ê∑òÂÆù',
    cphoneAppMemo: 'Â§áÂøòÂΩï',
    cphoneAppDiary: 'Êó•ËÆ∞',
    cphoneAppAmap: 'È´òÂæ∑Âú∞Âõæ',
    cphoneAppUsage: 'AppËÆ∞ÂΩï',
    cphoneAppMusic: 'ÁΩëÊòì‰∫ë',
    cphoneAppEphone: 'Ephone',
    cphoneAppFootprints: 'Ë∂≥Ëøπ',
    cphoneAlbumTitle: 'TAÁöÑÁõ∏ÂÜå',
    cphoneBrowserTitle: 'TAÁöÑÊµèËßàÂô®ÂéÜÂè≤',
    cphoneTaobaoTitle: 'TAÁöÑÊ∑òÂÆùËÆ¢Âçï',
    cphoneWalletTitle: 'Èí±ÂåÖ',
    cphoneMemoTitle: 'Â§áÂøòÂΩï',
    cphoneDiaryTitle: 'Êó•ËÆ∞',
    cphoneUsageTitle: 'App‰ΩøÁî®ËÆ∞ÂΩï',
    cphoneMusicTitle: 'TAÁöÑÊ≠åÂçï',
    cphoneArticleTitle: 'ÊñáÁ´†',
    cphoneSimulatedChatPlaceholder: 'ËøôÊòØÊ®°ÊãüÂØπËØùÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØ',

    // --- ‰∏ñÁïå‰π¶ ---
    worldBookTitle: '‰∏ñÁïå‰π¶',
    worldBookEditorTitle: 'ÁºñËæë‰∏ñÁïå‰π¶',
    worldBookEntryEditorTitle: 'ÁºñËæëÊù°ÁõÆ',
    worldBookNameLabel: '‰π¶Âêç',
    worldBookCategoryLabel: 'ÂàÜÁ±ª',
    worldBookEntriesLabel: 'ÂÜÖÂÆπÊù°ÁõÆ',
    worldBookAddEntryBtn: '[+] Ê∑ªÂä†Êñ∞Êù°ÁõÆ',
    worldBookNamePlaceholder: 'ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÁöÑÂêçÁß∞...',
    worldBookImportTitle: 'ÂØºÂÖ•‰∏ñÁïå‰π¶',

    // --- È¢ÑËÆæ ---
    presetTitle: 'È¢ÑËÆæ',
    presetEditorTitle: 'ÁºñËæëÈ¢ÑËÆæ',
    presetNameLabel: 'È¢ÑËÆæÂêçÁß∞',
    presetCategoryLabel: 'ÂàÜÁ±ª',
    presetEntriesLabel: 'ÂÜÖÂÆπÊù°ÁõÆ',
    presetAddEntryBtn: '[+] Ê∑ªÂä†Êñ∞Êù°ÁõÆ',

    // --- ÊïôÁ®ã ---
    tutorialTitle: 'ÊïôÁ®ã',

    // --- API ËÆæÁΩÆ ---
    apiSettingsTitle: 'API ËÆæÁΩÆ',
    languageLabel: 'ËØ≠Ë®Ä',
    apiPresetManagement: 'API È¢ÑËÆæÁÆ°ÁêÜ',
    apiPresetSelectLabel: 'ÈÄâÊã©ÊàñÂàáÊç¢È¢ÑËÆæ',
    apiPrimarySettings: '‰∏ªAPIËÆæÁΩÆ (Áî®‰∫éËÅäÂ§©)',
    apiProxyUrlLabel: 'Âèç‰ª£Âú∞ÂùÄ (‰∏çÈúÄË¶ÅÊ∑ªÂä†/v1Âô¢~)',
    apiKeyLabel: 'ÂØÜÈí• (API Key)',
    apiModelLabel: 'Ê®°Âûã',
    apiFetchModelsBtn: 'ÊãâÂèñ‰∏ªÊ®°Âûã',
    apiSecondarySettings: 'ÂâØAPIËÆæÁΩÆ (Áî®‰∫éÊÄªÁªìÈïøÊúüËÆ∞ÂøÜ)',
    apiSecondaryProxyUrlLabel: 'ÂâØÂèç‰ª£Âú∞ÂùÄ',
    apiSecondaryKeyLabel: 'ÂâØÂØÜÈí•',
    apiSecondaryModelLabel: 'ÂâØÊ®°Âûã',
    apiFetchSecondaryModelsBtn: 'ÊãâÂèñÂâØÊ®°Âûã',
    apiBgActivitySettings: 'ÂêéÂè∞Ê¥ªÂä®ËÆæÁΩÆ',
    apiEnableBgActivityLabel: 'ÂêØÁî®ÂêéÂè∞ËßíËâ≤Ê¥ªÂä®',
    apiBgIntervalLabel: 'ÂêéÂè∞Ê¥ªÂä®Ê£ÄÊµãÈó¥Èöî (Áßí)',
    apiBlockCooldownLabel: 'AIË¢´ÊãâÈªëÂêéÂÜ∑ÈùôÊúü (Â∞èÊó∂)',
    apiTtsSettings: 'ËØ≠Èü≥Ê∂àÊÅØËÆæÁΩÆ (Minimax TTS)',
    apiTtsModelLabel: 'ËØ≠Èü≥Ê®°Âûã (Model)',
    apiPerformanceSettings: 'ÊÄßËÉΩ‰∏éÊòæÁ§∫ËÆæÁΩÆ',
    apiChatListRenderWindowLabel: 'ËÅäÂ§©ÂàóË°®ÊØèÊ¨°Âä†ËΩΩÊù°Êï∞',
    apiChatRenderWindowLabel: 'ËÅäÂ§©ÁïåÈù¢ÂàùÂßãÂä†ËΩΩÊù°Êï∞',
    apiImageGenSettings: 'ÁîüÂõæÂäüËÉΩËÆæÁΩÆ',
    apiEnableImageGenLabel: 'ÂêØÁî®AIÁîüÂõæÂäüËÉΩ',
    apiEnableNovelAILabel: 'ÂêØÁî® NovelAI ÂõæÂÉèÁîüÊàê',
    apiNovelAIModelLabel: 'NovelAI Ê®°Âûã',
    apiNovelAIKeyLabel: 'NovelAI API Key',
    apiNovelAIGenSettingsBtn: 'ÁîüÊàêËÆæÁΩÆ',
    apiNovelAITestBtn: 'ÊµãËØïÁîüÊàê',
    apiStorageOptimization: 'Â≠òÂÇ®Á©∫Èó¥‰ºòÂåñ',
    apiCompressImagesBtn: '‰∏ÄÈîÆÂéãÁº©Êú¨Âú∞ÂõæÁâá',
    apiSaveAllBtn: '‰øùÂ≠òÊâÄÊúâËÆæÁΩÆ',
    apiViewDataDistributionBtn: 'Êü•ÁúãÊï∞ÊçÆÂàÜÂ∏É',
    apiExportDataBtn: 'ÂØºÂá∫Êï∞ÊçÆ',
    apiImportDataBtn: 'ÂØºÂÖ•Â§á‰ªΩÊñá‰ª∂',
    apiCleanupDataBtn: 'Ê∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆ',
    apiDeleteWorldBooksBtn: 'Âà†Èô§‰∏ñÁïå‰π¶',
    apiAdvancedCleanupBtn: 'È´òÁ∫ßÊï∞ÊçÆÊ∏ÖÁêÜ',
    apiCheckAndFixDataBtn: 'Êï∞ÊçÆÊ£ÄÊü•‰∏é‰øÆÂ§ç',

    // --- ËÅäÂ§©ÁïåÈù¢ ---
    chatHeaderOnline: 'Âú®Á∫ø',
    chatHeaderLongTermMemory: 'ÈïøÊúüËÆ∞ÂøÜ',
    chatHeaderListenTogether: '‰∏ÄËµ∑Âê¨',
    chatHeaderChatSettings: 'ËÅäÂ§©ËÆæÁΩÆ',
    chatSelectionCancel: 'ÂèñÊ∂à',
    chatSelectionScreenshot: 'ÈïøÊà™Âõæ',
    chatSelectionFavorite: 'Êî∂Ëóè',
    chatSelectionForward: 'ËΩ¨Âèë',
    chatSelectionShare: 'ÂàÜ‰∫´',
    chatSelectionSoftDelete: 'Âà†Èô§(ÈÄöÁü•AI)',
    chatSelectionHardDelete: 'ÂΩªÂ∫ïÂà†Èô§',
    chatReplyTo: 'ÂõûÂ§ç',
    chatInputPlaceholder: 'ËæìÂÖ•Ê∂àÊÅØ...',
    chatWaitForReply: 'Á≠âÂæÖÂõûÂ§ç',

    // --- Â§ñËßÇËÆæÁΩÆ ---
    appearanceTitle: 'Â§ñËßÇËÆæÁΩÆ',
    appearanceSaveAll: '‰øùÂ≠òÊâÄÊúâÂ§ñËßÇËÆæÁΩÆ',

    // --- Â≠ó‰ΩìËÆæÁΩÆ ---
    fontSettingsTitle: 'Â≠ó‰ΩìËÆæÁΩÆ',
    fontPresetManagement: 'Â≠ó‰ΩìÈ¢ÑËÆæÁÆ°ÁêÜ',
    fontFileUrlLabel: 'Â≠ó‰ΩìÊñá‰ª∂URL (.ttf, .otf, .woffÁ≠â)',
    fontPreviewLabel: 'ÂÆûÊó∂È¢ÑËßà',
    fontPreviewText1: '‰Ω†Â•Ω‰∏ñÁïå Hello World',
    fontPreviewText2: 'ËøôÊòØÂ≠ó‰ΩìÈ¢ÑËßàÊïàÊûúÔºå12345„ÄÇ',
    fontSaveAndApply: '‰øùÂ≠òÂπ∂Â∫îÁî®',
    fontResetDefault: 'ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì',

    // --- Ê∏≤ÊüìËßÑÂàô ---
    rendererTitle: 'Ê∏≤ÊüìËßÑÂàô',
    rendererEditorTitle: 'ÁºñËæëËßÑÂàô',
    rendererCreateTitle: 'ÂàõÂª∫Êñ∞ËßÑÂàô',
    rendererRuleName: 'ËßÑÂàôÂêçÁß∞',
    rendererBindScope: 'ÁªëÂÆöËåÉÂõ¥',
    rendererScopeGlobal: 'ÂÖ¨Áî® (ÊâÄÊúâËßíËâ≤)',
    rendererRegex: 'Ê≠£ÂàôË°®ËææÂºè (‰ΩøÁî®g‰Ωú‰∏∫Ê†áÂøó)',
    rendererHtmlTemplate: 'HTML Ê®°Êùø (Áî® $1, $2 ÂºïÁî®)',
    rendererEnableRule: 'ÂêØÁî®ËßÑÂàô',

    // --- ÂÖ∂‰ªñ ---
    myAlbumTitle: 'ÊàëÁöÑÁõ∏ÂÜå',
    albumPhotosTitle: 'Áõ∏ÂÜåÂêçÁß∞',
    npcEditorTitleAdd: 'Ê∑ªÂä† NPC',
    npcEditorTitleEdit: 'ÁºñËæë NPC',
    npcAvatarLabel: 'NPC Â§¥ÂÉè',
    npcUploadAvatar: '‰∏ä‰º†Â§¥ÂÉè',
    npcNicknameLabel: 'NPC ÊòµÁß∞',
    npcPersonaLabel: 'NPC ‰∫∫ËÆæ',
    npcEnableBgActivity: 'ÂêØÁî®Áã¨Á´ãÂêéÂè∞Ê¥ªÂä®',
    npcActionCooldown: 'Áã¨Á´ãË°åÂä®ÂÜ∑Âç¥ (ÂàÜÈíü)',
    npcAssociatedChars: 'ÂÖ≥ËÅîÁöÑËßíËâ≤ (NPC‰ºöÂéªËØÑËÆ∫Ëøô‰∫õËßíËâ≤ÁöÑÂä®ÊÄÅ)',


  },
  'en': {

    save: 'Save',
    cancel: 'Cancel',
    confirm: 'Confirm',
    edit: 'Edit',
    done: 'Done',
    add: 'Add',
    back: 'Back',
    next: 'Next',
    close: 'Close',
    reset: 'Reset',
    upload: 'Upload',
    send: 'Send',
    manage: 'Manage',
    share: 'Share',
    delete: 'Delete',
    publish: 'Publish',
    refresh: 'Refresh',
    search: 'Search',
    remove: 'Remove',
    finish: 'Finish',
    details: 'Details',
    settings: 'Settings',
    title: 'Title',
    content: 'Content',
    category: 'Category',
    name: 'Name',
    description: 'Description',
    status: 'Status',
    ok: 'OK',
    error: 'Error',
    success: 'Success',
    warning: 'Warning',
    loading: 'Loading...',
    processing: 'Processing...',
    pleaseWait: 'Please wait...',
    languageChangedAlert: 'Language switched. The page will reload to apply changes.',


    // --- Home Screen & Dock ---
    homeAppQQ: 'QQ',
    homeAppWorldBook: 'World Book',
    homeAppAppearance: 'Appearance',
    homeAppRenderer: 'Renderer',
    homeAppApiSettings: 'Settings',
    homeAppFont: 'Fonts',
    homeAppCPhone: 'CPhone',
    homeAppDouban: 'Douban',
    homeAppPreset: 'Presets',
    homeAppTutorial: 'Tutorial',
    homeAppWerewolf: 'Werewolf',
    homeAppX: 'X',
    homeAppCharGenerator: 'Character Generator',

    // --- Chat List Screen ---
    chatListTitle: 'Messages',
    navMessages: 'Messages',
    navQzone: 'Moments',
    navMemories: 'Memories',
    navFavorites: 'Favorites',
    navNpcList: 'NPCs',

    // --- QZone & Moments ---
    qzoneTitle: 'Moments',
    qzoneActionShuoshuo: 'Status',
    qzoneActionPost: 'Post',
    qzoneActionAlbum: 'Album',

    // --- CPhone (Character's Phone) ---
    cphoneTitleSelect: 'Select a Phone',
    cphoneAppQQ: 'QQ',
    cphoneAppAlbum: 'Album',
    cphoneAppBrowser: 'Browser',
    cphoneAppTaobao: 'Taobao',
    cphoneAppMemo: 'Memo',
    cphoneAppDiary: 'Diary',
    cphoneAppAmap: 'Amap',
    cphoneAppUsage: 'App Usage',
    cphoneAppMusic: 'Music',
    cphoneAppEphone: 'Ephone',
    cphoneAppFootprints: 'Footprints',
    cphoneAlbumTitle: 'Their Album',
    cphoneBrowserTitle: 'Their Browser History',
    cphoneTaobaoTitle: 'Their Taobao Orders',
    cphoneWalletTitle: 'Wallet',
    cphoneMemoTitle: 'Memo',
    cphoneDiaryTitle: 'Diary',
    cphoneUsageTitle: 'App Usage Log',
    cphoneMusicTitle: 'Their Playlist',
    cphoneArticleTitle: 'Article',
    cphoneSimulatedChatPlaceholder: 'This is a simulated chat, messages cannot be sent',

    // --- World Book ---
    worldBookTitle: 'World Book',
    worldBookEditorTitle: 'Edit World Book',
    worldBookEntryEditorTitle: 'Edit Entry',
    worldBookNameLabel: 'Book Name',
    worldBookCategoryLabel: 'Category',
    worldBookEntriesLabel: 'Content Entries',
    worldBookAddEntryBtn: '[+] Add New Entry',
    worldBookNamePlaceholder: 'Enter the name of the world book...',
    worldBookImportTitle: 'Import World Book',

    // --- Presets ---
    presetTitle: 'Presets',
    presetEditorTitle: 'Edit Preset',
    presetNameLabel: 'Preset Name',
    presetCategoryLabel: 'Category',
    presetEntriesLabel: 'Content Entries',
    presetAddEntryBtn: '[+] Add New Entry',

    // --- Tutorial ---
    tutorialTitle: 'Tutorial',

    // --- API Settings ---
    apiSettingsTitle: 'API Settings',
    languageLabel: 'Language',
    apiPresetManagement: 'API Preset Management',
    apiPresetSelectLabel: 'Select or Switch Preset',
    apiPrimarySettings: 'Primary API Settings (for Chat)',
    apiProxyUrlLabel: 'Proxy URL (No /v1 needed~)',
    apiKeyLabel: 'API Key',
    apiModelLabel: 'Model',
    apiFetchModelsBtn: 'Fetch Primary Models',
    apiSecondarySettings: 'Secondary API Settings (for Summarization)',
    apiSecondaryProxyUrlLabel: 'Secondary Proxy URL',
    apiSecondaryKeyLabel: 'Secondary API Key',
    apiSecondaryModelLabel: 'Secondary Model',
    apiFetchSecondaryModelsBtn: 'Fetch Secondary Models',
    apiTemperatureLabel: 'API Temperature',
    apiBgActivitySettings: 'Background Activity Settings',
    apiEnableBgActivityLabel: 'Enable Background Character Activity',
    apiBgIntervalLabel: 'Background Activity Interval (sec)',
    apiBlockCooldownLabel: 'AI Block Cooldown (hours)',
    apiTtsSettings: 'Voice Message Settings (Minimax TTS)',
    apiTtsModelLabel: 'Voice Model',
    apiPerformanceSettings: 'Performance & Display Settings',
    apiChatListRenderWindowLabel: 'Chat List Batch Load Count',
    apiChatRenderWindowLabel: 'Chat View Initial Load Count',
    apiImageGenSettings: 'Image Generation Settings',
    apiEnableImageGenLabel: 'Enable AI Image Generation',
    apiEnableNovelAILabel: 'Enable NovelAI Image Generation',
    apiNovelAIModelLabel: 'NovelAI Model',
    apiNovelAIKeyLabel: 'NovelAI API Key',
    apiNovelAIGenSettingsBtn: 'Generation Settings',
    apiNovelAITestBtn: 'Test Generation',
    apiStorageOptimization: 'Storage Optimization',
    apiCompressImagesBtn: 'Compress Local Images',
    apiSaveAllBtn: 'Save All Settings',
    apiViewDataDistributionBtn: 'View Data Distribution',
    apiExportDataBtn: 'Export Data',
    apiImportDataBtn: 'Import Backup File',
    apiCleanupDataBtn: 'Cleanup Redundant Data',
    apiDeleteWorldBooksBtn: 'Delete World Books',
    apiAdvancedCleanupBtn: 'Advanced Data Cleanup',
    apiCheckAndFixDataBtn: 'Data Check & Repair',

    // --- Chat Screen ---
    chatHeaderOnline: 'Online',
    chatHeaderLongTermMemory: 'Long-term Memory',
    chatHeaderListenTogether: 'Listen Together',
    chatHeaderChatSettings: 'Chat Settings',
    chatSelectionCancel: 'Cancel',
    chatSelectionScreenshot: 'Long Screenshot',
    chatSelectionFavorite: 'Favorite',
    chatSelectionForward: 'Forward',
    chatSelectionShare: 'Share',
    chatSelectionSoftDelete: 'Delete (Notify AI)',
    chatSelectionHardDelete: 'Erase',
    chatReplyTo: 'Reply to',
    chatInputPlaceholder: 'Type a message...',
    chatWaitForReply: 'Wait for Reply',

    // --- Appearance Settings ---
    appearanceTitle: 'Appearance Settings',
    appearanceSaveAll: 'Save All Appearance Settings',

    // --- Font Settings ---
    fontSettingsTitle: 'Font Settings',
    fontPresetManagement: 'Font Preset Management',
    fontFileUrlLabel: 'Font File URL (.ttf, .otf, .woff, etc.)',
    fontPreviewLabel: 'Live Preview',
    fontPreviewText1: 'Hello World ‰Ω†Â•Ω‰∏ñÁïå',
    fontPreviewText2: 'This is a font preview effect, 12345.',
    fontSaveAndApply: 'Save and Apply',
    fontResetDefault: 'Reset to Default Font',

    // --- Renderer ---
    rendererTitle: 'Rendering Rules',
    rendererEditorTitle: 'Edit Rule',
    rendererCreateTitle: 'Create New Rule',
    rendererRuleName: 'Rule Name',
    rendererBindScope: 'Binding Scope',
    rendererScopeGlobal: 'Global (All Characters)',
    rendererRegex: 'Regular Expression (use g flag)',
    rendererHtmlTemplate: 'HTML Template (use $1, $2)',
    rendererEnableRule: 'Enable Rule',

    // --- Others ---
    myAlbumTitle: 'My Albums',
    albumPhotosTitle: 'Album Name',
    npcEditorTitleAdd: 'Add NPC',
    npcEditorTitleEdit: 'Edit NPC',
    npcAvatarLabel: 'NPC Avatar',
    npcUploadAvatar: 'Upload Avatar',
    npcNicknameLabel: 'NPC Nickname',
    npcPersonaLabel: 'NPC Persona',
    npcEnableBgActivity: 'Enable Independent Background Activity',
    npcActionCooldown: 'Independent Action Cooldown (min)',
    npcAssociatedChars: 'Associated Characters (NPC will comment on their moments)',

  }
};

let currentLanguage = 'zh-CN';

function setLanguage(lang) {
  if (!translations[lang]) {
    console.warn(`Language "${lang}" not found. Defaulting to 'zh-CN'.`);
    lang = 'zh-CN';
  }
  currentLanguage = lang;
  localStorage.setItem('ephone-language', lang);
  document.documentElement.lang = lang;

  document.querySelectorAll('[data-lang-key]').forEach(el => {
    const key = el.getAttribute('data-lang-key');
    if (translations[lang][key]) {
      el.textContent = translations[lang][key];
    }
  });

  document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
    const key = el.getAttribute('data-lang-key-placeholder');
    if (translations[lang][key]) {
      el.placeholder = translations[lang][key];
    }
  });

  document.querySelectorAll('[data-lang-key-title]').forEach(el => {
    const key = el.getAttribute('data-lang-key-title');
    if (translations[lang][key]) {
      el.title = translations[lang][key];
    }
  });
}

function initLanguage() {
  const savedLang = localStorage.getItem('ephone-language') || 'zh-CN';
  const langSelector = document.getElementById('language-select');

  if (langSelector) {
    langSelector.value = savedLang;
    langSelector.addEventListener('change', (e) => {
      const newLang = e.target.value;
      alert(translations[newLang].languageChangedAlert);
      localStorage.setItem('ephone-language', newLang);
      setTimeout(() => window.location.reload(), 100);
    });
  }
  setLanguage(savedLang);
}

(function () {
  'use strict';


  function downloadImage(imageSrc, filename) {
    try {

      const link = document.createElement('a');
      link.href = imageSrc;
      link.download = filename;
      link.style.display = 'none';

      document.body.appendChild(link);
      link.click();


      setTimeout(() => {
        document.body.removeChild(link);
      }, 100);

      console.log('‚úÖ [NAI‰∏ãËΩΩ] ÂºÄÂßã‰∏ãËΩΩÂõæÁâá:', filename);

      // ÊòæÁ§∫‰∏ãËΩΩÊèêÁ§∫
      showDownloadToast();
    } catch (error) {
      console.error('‚ùå [NAI‰∏ãËΩΩ] ‰∏ãËΩΩÂ§±Ë¥•:', error);
      showDownloadToast('‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
    }
  }


  function showDownloadToast(message = 'üì• ÂõæÁâá‰∏ãËΩΩ‰∏≠...', type = 'success') {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : '#f44336'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                pointer-events: none;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.3s ease;
            `;

    document.body.appendChild(toast);


    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    }, 10);


    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 2000);
  }


  function generateFilename(imgElement) {

    const title = imgElement.getAttribute('title') || imgElement.getAttribute('alt') || '';


    let cleanTitle = title
      .replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g, '_')
      .replace(/\s+/g, '_')
      .substring(0, 30);

    if (!cleanTitle) {
      cleanTitle = 'NAI_Image';
    }


    const timestamp = new Date().toISOString()
      .replace(/[-:]/g, '')
      .replace('T', '_')
      .split('.')[0];


    return `${cleanTitle}_${timestamp}.png`;
  }


  function addVisualFeedback(imgElement) {
    const originalTransform = imgElement.style.transform || '';
    const originalTransition = imgElement.style.transition || '';


    imgElement.style.transition = 'transform 0.15s ease';
    imgElement.style.transform = 'scale(0.95)';

    setTimeout(() => {
      imgElement.style.transform = originalTransform;
      setTimeout(() => {
        imgElement.style.transition = originalTransition;
      }, 150);
    }, 150);
  }
  window.downloadImage = downloadImage;     // Êää‰∏ãËΩΩÂáΩÊï∞Êö¥Èú≤ÁªôÂÖ®Â±Ä
  window.generateFilename = generateFilename; // ÊääÊñá‰ª∂ÂêçÁîüÊàêÊö¥Èú≤ÁªôÂÖ®Â±Ä
  window.addVisualFeedback = addVisualFeedback;

  let clickCount = 0;
  let clickTimer = null;
  let lastClickedElement = null;


  document.addEventListener('click', function (e) {
    const target = e.target;


    if (target.tagName === 'IMG' &&
      (target.classList.contains('realimag-image') ||
        target.classList.contains('naiimag-image'))) {


      if (target === lastClickedElement) {
        clickCount++;
      } else {

        clickCount = 1;
        lastClickedElement = target;
      }

      // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
      if (clickTimer) {
        clearTimeout(clickTimer);
      }


      if (clickCount === 3) {

        clickCount = 0;
        lastClickedElement = null;


        e.preventDefault();
        e.stopPropagation();

        console.log('üñºÔ∏è [NAI‰∏ãËΩΩ] Ê£ÄÊµãÂà∞‰∏âÂáªNAIÂõæÁâá');


        addVisualFeedback(target);


        const imageSrc = target.src;

        if (!imageSrc || imageSrc === 'about:blank') {
          console.warn('‚ö†Ô∏è [NAI‰∏ãËΩΩ] ÂõæÁâáÊ∫ê‰∏∫Á©∫ÔºåÊó†Ê≥ï‰∏ãËΩΩ');
          showDownloadToast('ÂõæÁâáÂä†ËΩΩ‰∏≠ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
          return;
        }


        const filename = generateFilename(target);


        downloadImage(imageSrc, filename);
      } else {

        clickTimer = setTimeout(() => {
          clickCount = 0;
          lastClickedElement = null;
        }, 500);
      }
    }
  }, true);

  console.log('‚úÖ [NAI‰∏ãËΩΩ] ‰∏âÂáª‰∏ãËΩΩÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ');
  console.log('üí° [NAI‰∏ãËΩΩ] ÊèêÁ§∫Ôºö‰∏âÂáª‰ªªÊÑèNAIÂõæÁâáÂç≥ÂèØ‰∏ãËΩΩ');
})();


if ('serviceWorker' in navigator) {

  window.addEventListener('load', () => {

    navigator.serviceWorker.register('./sw.js')
      .then(registration => {

        console.log('ServiceWorker Ê≥®ÂÜåÊàêÂäüÔºå‰ΩúÁî®Âüü‰∏∫: ', registration.scope);
      })
      .catch(error => {

        console.log('ServiceWorker Ê≥®ÂÜåÂ§±Ë¥•: ', error);
      });
  });
}

if (!Array.prototype.findLastIndex) {
  Object.defineProperty(Array.prototype, 'findLastIndex', {
    value: function (predicate) {
      if (this == null) {
        throw new TypeError('Cannot read property \'findLastIndex\' of null or undefined');
      }
      if (typeof predicate !== 'function') {
        throw new TypeError('predicate must be a function');
      }
      let o = Object(this);
      let len = o.length >>> 0;
      let thisArg = arguments[1];
      let k = len - 1;
      while (k >= 0) {
        let kValue = o[k];
        if (predicate.call(thisArg, kValue, k, o)) {
          return k;
        }
        k--;
      }
      return -1;
    },
    configurable: true,
    writable: true
  });
}

const dynamicIslandContent = document.getElementById('dynamic-island-content');
const islandAlbumArt = document.getElementById('island-album-art');
const islandLyricContainer = document.getElementById('island-lyric-container');
const islandLyricText = document.getElementById('island-lyric-text');
const phoneScreenForIsland = document.getElementById('phone-screen');

let activeMessageTimestamp = null;
let activeTransferTimestamp = null;

let lastRawAiResponse = '';
let lastResponseTimestamps = [];
let lastPrivateMessagesSent = [];
let lastGroupMessagesSent = [];
let currentQzoneReplyContext = null;
let editingNpcId = null;
let pendingBackupData = null;
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models'
function findBestStickerMatch(meaning, availableStickers) {
  if (!meaning || !availableStickers || availableStickers.length === 0) {
    return null;
  }

  const SIMILARITY_THRESHOLD = 0.7;
  const candidates = [];
  let highestScore = 0;

  const getTokens = (str) => [...new Set(str.replace(/\s+/g, ''))];
  const meaningTokens = getTokens(meaning);

  availableStickers.forEach(sticker => {
    if (!sticker.name) return;

    const stickerNameTokens = getTokens(sticker.name);
    const intersection = stickerNameTokens.filter(token => meaningTokens.includes(token));
    // Jaccard Similarity Score
    const score = intersection.length / (stickerNameTokens.length + meaningTokens.length - intersection.length);


    if (score > highestScore) {
      highestScore = score;
    }


    if (score >= SIMILARITY_THRESHOLD) {
      candidates.push({ sticker, score });
    }
  });

  if (candidates.length > 0) {

    const bestCandidates = candidates.filter(c => c.score === highestScore);


    const randomIndex = Math.floor(Math.random() * bestCandidates.length);
    const chosenSticker = bestCandidates[randomIndex].sticker;

    console.log(`[Ê®°Á≥äÈöèÊú∫ÂåπÈÖçÊàêÂäü] AIÂê´‰πâ: "${meaning}", ÂåπÈÖçÂà∞ ${bestCandidates.length} ‰∏™ÊúÄ‰Ω≥ÈÄâÈ°π, ÈöèÊú∫ÈÄâ‰∏≠: "${chosenSticker.name}", Áõ∏‰ººÂ∫¶: ${highestScore.toFixed(2)}`);
    return chosenSticker;
  }

  console.log(`[Ê®°Á≥äÈöèÊú∫ÂåπÈÖçÂ§±Ë¥•] AIÂê´‰πâ: "${meaning}", ÊúÄÈ´òÁõ∏‰ººÂ∫¶‰∏∫ ${highestScore.toFixed(2)}ÔºåÊú™ËææÂà∞ÈòàÂÄº ${SIMILARITY_THRESHOLD}„ÄÇ`);
  return null;
}
function getRandomValue(str) {

  if (str.includes(',')) {

    const arr = str.split(',').map(item => item.trim());

    const randomIndex = Math.floor(Math.random() * arr.length);

    return arr[randomIndex];
  }

  return str;
}

function isImage(content) {
  if (content.image_url && content.image_url.url) {
    let currentImageData = content.image_url.url

    const base64Data = currentImageData.split(',')[1];

    const mimeType = currentImageData.match(/^data:(.*);base64/)[1];
    return [{
      text: 'Áî®Êà∑Âêë‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá'
    },
    {
      inline_data: {
        mime_type: mimeType,
        data: base64Data
      }
    }
    ]
  }
  return []
}



function getGeminiResponseText(data) {


  if (data.choices && Array.isArray(data.choices) && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
    return data.choices[0].message.content;
  }


  if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts) {
    return data.candidates[0].content.parts[0].text;
  }


  console.error("APIËøîÂõû‰∫ÜÈùûÈ¢ÑÊúüÁöÑÊ†ºÂºè:", data);
  let errorReason = "AIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπÊàñÊú™Áü•Ê†ºÂºè„ÄÇ";


  if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0 && data.candidates[0].finishReason === 'SAFETY') {
    const safetyRatings = data.candidates[0].safetyRatings;
    const blockedCategories = safetyRatings
      .filter(r => r.probability !== 'NEGLIGIBLE' && r.probability !== 'LOW')
      .map(r => `${r.category} (Ê¶ÇÁéá: ${r.probability})`)
      .join(', ');
    errorReason = `ÂÜÖÂÆπÂõ†ÂÆâÂÖ®Á≠ñÁï•Ë¢´Â±èËîΩ„ÄÇËß¶ÂèëÁ±ªÂà´: ${blockedCategories || 'Êú™Áü•'}`;
  }

  else if (data.promptFeedback?.blockReason) {
    const reason = data.promptFeedback.blockReason;
    const details = data.promptFeedback.safetyRatings?.map(r => `${r.category}: ${r.probability}`).join(', ');
    errorReason = `ÂÜÖÂÆπÂõ†ÂÆâÂÖ®Á≠ñÁï•Ë¢´Â±èËîΩ (ÂéüÂõ†: ${reason})„ÄÇËØ¶ÊÉÖ: ${details || 'Êó†'}`;
  }

  else if (data.error?.message) {
    errorReason = `APIÈîôËØØ: ${data.error.message}`;
  }

  else if (data.message) {
    errorReason = `APIÈîôËØØ: ${data.message}`;
  }

  else if (data.detail) {
    errorReason = `APIÈîôËØØ: ${data.detail}`;
  }

  else if (data.error && typeof data.error === 'string') {
    errorReason = `APIÈîôËØØ: ${data.error}`;
  }

  throw new Error(errorReason);
}


document.addEventListener('DOMContentLoaded', () => {

  // ========================================
  // üõ°Ô∏è Â¥©Ê∫ÉÊÅ¢Â§çÊ£ÄÊµã - Â∫îÁî®ÂêØÂä®Êó∂ÊâßË°å
  // ========================================
  (async () => {
    // Á≠âÂæÖÊï∞ÊçÆÂ∫ìÂ∞±Áª™
    await window.dbReadyPromise;
    
    // Ê£ÄÊµãÊòØÂê¶ÊúâÂºÇÂ∏∏ÈÄÄÂá∫
    const hadCrash = CrashRecoveryDetector.markSessionStart();
    
    if (hadCrash) {
      console.warn('‚ö†Ô∏è Ê£ÄÊµãÂà∞‰∏äÊ¨°ÂºÇÂ∏∏ÈÄÄÂá∫');
      
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊìç‰ΩúÊó•Âøó
      const unsavedLogs = OperationLogger.getLogs();
      const lastSnapshot = DualWriteManager.getSnapshot();
      const lastSaveTime = DualWriteManager.getLastSaveTime();
      
      // ÊûÑÂª∫ÊÅ¢Â§ç‰ø°ÊÅØ
      let recoveryInfo = '„ÄêÊÇ®ÁöÑÊï∞ÊçÆÊòØÂÆâÂÖ®ÁöÑÔºåËØ∑ÊîæÂøÉÔºÅ„Äë\n\n';
      recoveryInfo += 'Ê£ÄÊµãÂà∞Â∫îÁî®‰∏äÊ¨°Ê≤°ÊúâÊ≠£Â∏∏ÂÖ≥Èó≠ÔºàÂèØËÉΩÊòØÊµèËßàÂô®Â¥©Ê∫É„ÄÅÁîµËÑëÊñ≠ÁîµÊàñÂº∫Âà∂ÂÖ≥Èó≠Ôºâ„ÄÇ\n\n';
      recoveryInfo += '„Äê‰∏∫‰ªÄ‰πà‰ºöÊúâËøô‰∏™ÊèêÁ§∫Ôºü„Äë\n';
      recoveryInfo += 'Â∫îÁî®ÂÖ∑ÊúâÂºÇÂ∏∏ÈÄÄÂá∫Ê£ÄÊµãÂäüËÉΩÔºåÂΩìÊ£ÄÊµãÂà∞‰∏äÊ¨°Ê≤°ÊúâÊ≠£Â∏∏ÈÄÄÂá∫Êó∂Ôºå‰ºöËá™Âä®ÊòæÁ§∫Ëøô‰∏™ÊèêÁ§∫ÔºåËÆ©ÊÇ®‰∫ÜËß£ÂΩìÂâçÁöÑÊï∞ÊçÆÁä∂ÊÄÅ„ÄÇ\n\n';
      recoveryInfo += '„ÄêÊï∞ÊçÆ‰øùÂ≠òÊú∫Âà∂ËØ¥Êòé„Äë\n';
      recoveryInfo += '‚Ä¢ ÊÇ®ÁöÑÊâÄÊúâÊï∞ÊçÆÈÉΩÂÆûÊó∂Ëá™Âä®‰øùÂ≠òÂú®ÊµèËßàÂô®Êú¨Âú∞Êï∞ÊçÆÂ∫ì‰∏≠\n';
      recoveryInfo += '‚Ä¢ Âç≥‰ΩøÂºÇÂ∏∏ÈÄÄÂá∫ÔºåÂ∑≤‰øùÂ≠òÁöÑÊï∞ÊçÆ‰πü‰∏ç‰ºö‰∏¢Â§±\n';
      recoveryInfo += '‚Ä¢ Á≥ªÁªü‰ºöÂÆöÊúüÂàõÂª∫Êï∞ÊçÆÂø´ÁÖßÔºåÁ°Æ‰øùÊï∞ÊçÆÂÆâÂÖ®\n';
      recoveryInfo += '‚Ä¢ Â¶ÇÊûúÊÇ®ÂºÄÂêØ‰∫Ü‰∫ëÂ§á‰ªΩÔºåÊï∞ÊçÆËøò‰ºöÂêåÊ≠•Âà∞‰∫ëÁ´Ø\n\n';
      
      recoveryInfo += '„ÄêÂΩìÂâçÊï∞ÊçÆÁä∂ÊÄÅ„Äë\n';
      
      if (lastSaveTime) {
        const timeDiff = Date.now() - lastSaveTime;
        const minutesAgo = Math.floor(timeDiff / 60000);
        recoveryInfo += `ÊúÄÂêé‰øùÂ≠òÊó∂Èó¥Ôºö${minutesAgo} ÂàÜÈíüÂâç\n`;
      }
      
      if (lastSnapshot) {
        recoveryInfo += `ËÅäÂ§©Êï∞Ôºö${lastSnapshot.summary?.chatsCount || 0}\n`;
        recoveryInfo += `ËØ¥ËØ¥Êï∞Ôºö${lastSnapshot.summary?.qzonePostsCount || 0}\n`;
        recoveryInfo += `NPCÊï∞Ôºö${lastSnapshot.summary?.npcsCount || 0}\n`;
      }
      
      if (unsavedLogs.length > 0) {
        recoveryInfo += `\nÊ£ÄÊµãÂà∞ ${unsavedLogs.length} Êù°Êú™‰øùÂ≠òÁöÑÊìç‰ΩúËÆ∞ÂΩï\n`;
        
        // ÊòæÁ§∫ÊúÄËøëÁöÑÂá†Êù°Êìç‰Ωú
        const recentOps = unsavedLogs.slice(-5).map(log => {
          const time = new Date(log.timestamp).toLocaleTimeString();
          return `  ‚Ä¢ ${time}Ôºö${log.operation} ${log.tableName}`;
        }).join('\n');
        
        recoveryInfo += '\nÊúÄËøëÁöÑÊìç‰ΩúÔºö\n' + recentOps;
      }
      
      recoveryInfo += '\n\nÊÇ®ÂèØ‰ª•ÁªßÁª≠Ê≠£Â∏∏‰ΩøÁî®ÔºåÊï∞ÊçÆÂ∑≤ÁªèÊÅ¢Â§çÂÆåÊàê„ÄÇÂ¶ÇÊúâ‰ªª‰ΩïÁñëÈóÆÔºåÂèØ‰ª•Ê£ÄÊü•‰∫ëÂ§á‰ªΩËÆ∞ÂΩï„ÄÇ';
      
      // ÊòæÁ§∫ÊÅ¢Â§çÊèêÁ§∫Ôºà‰ΩøÁî®ÂéüÊúâÁöÑ showCustomAlertÔºâ
      if (typeof showCustomAlert === 'function') {
        await showCustomAlert('Ê≠£Â∏∏ÂêØÂä®ÊèêÁ§∫', recoveryInfo);
      } else {
        // Â¶ÇÊûú showCustomAlert ËøòÊú™ÂÆö‰πâÔºå‰ΩøÁî® alert
        alert('Ê≠£Â∏∏ÂêØÂä®ÊèêÁ§∫\n\n' + recoveryInfo);
      }
      
      console.log('[Â¥©Ê∫ÉÊÅ¢Â§ç] ÊÅ¢Â§ç‰ø°ÊÅØ:', {
        unsavedLogs: unsavedLogs.length,
        lastSnapshot,
        lastSaveTime: lastSaveTime ? new Date(lastSaveTime).toLocaleString() : null
      });
    } else {
      console.log('[Â¥©Ê∫ÉÊÅ¢Â§ç] Ê≠£Â∏∏ÂêØÂä®ÔºåÊó†ÈúÄÊÅ¢Â§ç');
    }
    
    // ÂêØÂä®ÂàùÂßãÂø´ÁÖß‰øùÂ≠ò
    setTimeout(() => {
      DualWriteManager.saveSnapshot();
    }, 5000); // ÂêØÂä® 5 ÁßíÂêé‰øùÂ≠òÁ¨¨‰∏Ä‰∏™Âø´ÁÖß
  })();
  // ========================================
  // üõ°Ô∏è Â¥©Ê∫ÉÊÅ¢Â§çÊ£ÄÊµãÁªìÊùü
  // ========================================

  document.getElementById('user-city-search-btn').addEventListener('click', async () => {
    const query = document.getElementById('user-real-city-search').value.trim();
    if (!query) return alert("ËØ∑ËæìÂÖ•ÁúüÂÆûÂüéÂ∏ÇÊãºÈü≥ÊàñËã±ÊñáÂêçÁß∞");

    const result = await searchCityGeo(query);
    if (result) {
      document.getElementById('user-city-lat').value = result.latitude;
      document.getElementById('user-city-lon').value = result.longitude;
      document.getElementById('user-city-result').textContent = `Â∑≤ÈÄâ‰∏≠: ${result.name}, ${result.country} (${result.latitude}, ${result.longitude})`;
      document.getElementById('user-city-result').style.color = 'green';
      // ÂèØ‰ª•Âú® dataset ÊöÇÂ≠òÁúüÂÆûÂüéÂ∏ÇÂêç
      document.getElementById('user-real-city-search').dataset.realName = result.name;
    } else {
      alert("Êú™ÊâæÂà∞ËØ•ÂüéÂ∏ÇÔºåËØ∑Â∞ùËØï‰ΩøÁî®ÊãºÈü≥ÊàñËã±Êñá (Â¶Ç Shanghai)„ÄÇ");
    }
  });

  document.getElementById('char-city-search-btn').addEventListener('click', async () => {
    const query = document.getElementById('char-real-city-search').value.trim();
    if (!query) return alert("ËØ∑ËæìÂÖ•ÁúüÂÆûÂüéÂ∏ÇÊãºÈü≥ÊàñËã±ÊñáÂêçÁß∞");

    const result = await searchCityGeo(query);
    if (result) {
      document.getElementById('char-city-lat').value = result.latitude;
      document.getElementById('char-city-lon').value = result.longitude;
      document.getElementById('char-city-result').textContent = `Â∑≤ÈÄâ‰∏≠: ${result.name}, ${result.country} (${result.latitude}, ${result.longitude})`;
      document.getElementById('char-city-result').style.color = 'green';
      document.getElementById('char-real-city-search').dataset.realName = result.name;
    } else {
      alert("Êú™ÊâæÂà∞ËØ•ÂüéÂ∏ÇÔºåËØ∑Â∞ùËØï‰ΩøÁî®ÊãºÈü≥ÊàñËã±Êñá (Â¶Ç New York)„ÄÇ");
    }
  });

  // ÊâãÂä®ÊÄªÁªìÂºπÁ™ó‰∫ã‰ª∂ÁõëÂê¨Âô®
  document.getElementById('manual-summary-btn').addEventListener('click', openManualSummaryModal);
  document.getElementById('manual-summary-close-btn').addEventListener('click', closeManualSummaryModal);
  document.getElementById('manual-summary-cancel-btn').addEventListener('click', closeManualSummaryModal);
  document.getElementById('manual-summary-confirm-btn').addEventListener('click', executeManualSummary);

  // ÊöÇÂÅúË∞ÉÁî®ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
  const stopApiCallBtn = document.getElementById('stop-api-call-btn');
  if (stopApiCallBtn) {
    stopApiCallBtn.addEventListener('click', () => {
      if (currentApiController) {
        console.log('Áî®Êà∑ÁÇπÂáªÊöÇÂÅúË∞ÉÁî®ÊåâÈíÆÔºåÊ≠£Âú®ÂèñÊ∂àAPIËØ∑Ê±Ç...');
        currentApiController.abort();

        // Á´ãÂç≥ÈöêËóèÊåâÈíÆÂπ∂ÁßªÈô§Âä®Áîª
        stopApiCallBtn.style.display = 'none';
        stopApiCallBtn.classList.remove('active');

        // ÊòæÁ§∫ÂèñÊ∂àÊèêÁ§∫Ôºà‰ªÖÁªôÁî®Êà∑ÁúãÔºå‰∏ç‰ºöËøõÂÖ•ËÅäÂ§©ÂéÜÂè≤Ôºâ
        showCustomAlert('Â∑≤ÂÅúÊ≠¢', 'ÂØπËØùÂ∑≤ÂÅúÊ≠¢ÁîüÊàê');
      }
    });
  }

  const PREFILLED_SALT = "bu_wan_jiu_guan_bu_yao_huo_qu";


  async function generatePin(deviceId, salt) {
    if (!deviceId || !salt) {
      throw new Error("ËÆæÂ§áIDÂíåÂØÜÈí•Áõê‰∏çËÉΩ‰∏∫Á©∫„ÄÇ");
    }
    const dataToHash = deviceId + salt;
    const dataBuffer = new TextEncoder().encode(dataToHash);
    const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex.substring(0, 6).toUpperCase();
  }


  function requirePinActivation() {

    return new Promise(async (resolve, reject) => {

      if (isPinActivated) {
        resolve(true);
        return;
      }


      const modal = document.getElementById('pin-modal-overlay');
      const deviceIdDisplay = document.getElementById('pin-device-id-display');
      const pinInput = document.getElementById('pin-input');
      const confirmBtn = document.getElementById('pin-modal-confirm-btn');
      const cancelBtn = document.getElementById('pin-modal-cancel-btn');


      deviceIdDisplay.value = EPHONE_DEVICE_ID;
      pinInput.value = '';



      const onConfirmClick = async () => {
        const userPin = pinInput.value;


        modal.classList.remove('visible');


        confirmBtn.removeEventListener('click', onConfirmClick);
        cancelBtn.removeEventListener('click', onCancelClick);

        if (!userPin || !userPin.trim()) {
          await showCustomAlert('Êìç‰ΩúÂèñÊ∂à', 'ÊÇ®Ê≤°ÊúâËæìÂÖ•ÊøÄÊ¥ªÁ†Å„ÄÇ');
          reject(new Error('Áî®Êà∑ÂèñÊ∂à‰∫ÜËæìÂÖ•„ÄÇ'));
          return;
        }


        await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®È™åËØÅÊøÄÊ¥ªÁ†Å...");


        try {

          const correctPin = await generatePin(EPHONE_DEVICE_ID, PREFILLED_SALT);


          if (userPin.trim().toUpperCase() === correctPin) {

            localStorage.setItem('ephonePinActivated', 'true');
            isPinActivated = true;
            await showCustomAlert('ÊøÄÊ¥ªÊàêÂäüÔºÅ', 'Ê≠§ÂäüËÉΩÂ∑≤‰∏∫ÊÇ®ÁöÑËÆæÂ§áÊ∞∏‰πÖËß£ÈîÅ„ÄÇ');


            updateLockedFeatureUI();


            resolve(true);
          } else {

            await showCustomAlert('ÊøÄÊ¥ªÂ§±Ë¥•', 'ÊÇ®ËæìÂÖ•ÁöÑÊøÄÊ¥ªÁ†Å‰∏çÊ≠£Á°Æ„ÄÇ');
            reject(new Error('ÊøÄÊ¥ªÁ†Å‰∏çÊ≠£Á°Æ„ÄÇ'));
          }
        } catch (error) {

          console.error("Êú¨Âú∞PINÁ†ÅÈ™åËØÅËøáÁ®ãÂá∫Èîô:", error);
          await showCustomAlert('ÊøÄÊ¥ªÂ§±Ë¥•', `È™åËØÅËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºö${error.message}`);
          reject(error);
        }

      };


      const onCancelClick = async () => { // <--- Ê∑ªÂä† async
        modal.classList.remove('visible');

        confirmBtn.removeEventListener('click', onConfirmClick);
        cancelBtn.removeEventListener('click', onCancelClick);


        await showCustomAlert('Êìç‰ΩúÂèñÊ∂à', 'ÊøÄÊ¥ªÊµÅÁ®ãÂ∑≤ÂèñÊ∂à„ÄÇ');
        reject(new Error('Áî®Êà∑ÂèñÊ∂à‰∫ÜÊøÄÊ¥ª„ÄÇ'));
      };


      confirmBtn.addEventListener('click', onConfirmClick);
      cancelBtn.addEventListener('click', onCancelClick);


      modal.classList.add('visible');
      pinInput.focus();
    });
  }


  function updateLockedFeatureUI() {
    const isActivated = localStorage.getItem('ephonePinActivated') === 'true';
    const presetImportBtn = document.getElementById('import-preset-btn');


    const worldBookImportBtn = document.getElementById('import-world-book-btn');



    if (presetImportBtn) {
      presetImportBtn.classList.toggle('locked-feature', !isActivated);
    }


    if (worldBookImportBtn) {
      worldBookImportBtn.classList.toggle('locked-feature', !isActivated);
    }

  }
  document.addEventListener('visibilitychange', () => {

    if (document.visibilityState === 'visible') {
      console.log('Â∫îÁî®Â∑≤ËøîÂõûÂâçÂè∞ÔºåÊ≠£Âú®Ê£ÄÊü•Êõ¥Êñ∞...');

      navigator.serviceWorker.ready.then(registration => {

        registration.update();
      });
    }
  });

  function toGeminiRequestData(model, apiKey, systemInstruction, messagesForDecision) {
    const apiTemperature = state.globalSettings.apiTemperature || 0.8;
    const roleType = {
      user: 'user',
      assistant: 'model',
      system: 'user'
    };


    const contents = [{
      role: 'user',
      parts: [{
        text: systemInstruction
      }]
    },
    {
      role: 'model',
      parts: [{
        text: 'Â•ΩÁöÑÔºåÊàëÊòéÁôΩ‰∫Ü„ÄÇÊàë‰ºö‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏äÊâÄÊúâËßÑÂàôÂíåËÆæÂÆö„ÄÇ'
      }]
    },

    ...messagesForDecision.map((item) => {
      const parts = [];

      if (Array.isArray(item.content)) {
        item.content.forEach(part => {
          if (part.type === 'text') {
            parts.push({
              text: part.text
            });
          } else if (part.type === 'image_url' && part.image_url && part.image_url.url) {

            const currentImageData = part.image_url.url;
            const base64Data = currentImageData.split(',')[1];
            const mimeTypeMatch = currentImageData.match(/^data:(.*);base64/);
            if (mimeTypeMatch && base64Data) {
              parts.push({
                inline_data: {
                  mime_type: mimeTypeMatch[1],
                  data: base64Data
                }
              });
            }
          }
        });
      } else {

        parts.push({
          text: String(item.content)
        });
      }
      return {
        role: roleType[item.role],
        parts: parts
      };
    })
    ];


    return {
      url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${getRandomValue(apiKey)}`,
      data: {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          contents: contents,
          generationConfig: {
            temperature: apiTemperature,
          },
        })
      }
    };
  }





  const db = new Dexie('GeminiChatDB');
  const avatarFrames = [{
    id: 'none',
    url: '',
    name: 'Êó†'
  }, {
    id: 'frame_cat_ear',
    url: 'https://i.postimg.cc/fLDnz5Pn/IMG-5574.gif',
    name: '1'
  }, {
    id: 'frame_ribbon',
    url: 'https://i.postimg.cc/HxH3cNHz/IMG-6871.gif',
    name: '2'
  }, {
    id: 'frame_flower',
    url: 'https://i.postimg.cc/jCVK0fGL/IMG-6890.gif',
    name: '3'
  }, {
    id: 'frame_tech',
    url: 'https://i.postimg.cc/85Zsyjwn/IMG-6895.gif',
    name: '4'
  }, {
    id: 'frame_5',
    url: 'https://i.postimg.cc/cJtpZCB3/IMG-6894.gif',
    name: '5'
  }, {
    id: 'frame_6',
    url: 'https://i.postimg.cc/63sDQKMm/IMG-6893.gif',
    name: '6'
  }, {
    id: 'frame_7',
    url: 'https://i.postimg.cc/cHQPgzj4/IMG-6888.gif',
    name: '7'
  }, {
    id: 'frame_8',
    url: 'https://i.postimg.cc/dVLXm3Xf/IMG-6885.gif',
    name: '8'
  }, {
    id: 'frame_9',
    url: 'https://i.postimg.cc/kGsZwbq0/IMG-6886.gif',
    name: '9'
  }, {
    id: 'frame_10',
    url: 'https://i.postimg.cc/63NmX03s/IMG-4366.gif',
    name: '10'
  }, {
    id: 'frame_11',
    url: 'https://i.postimg.cc/zvz2LGK0/IMG-4367.gif',
    name: '11'
  }, {
    id: 'frame_12',
    url: 'https://i.postimg.cc/prsGKMBx/IMG-4370.gif',
    name: '12'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/gk0BmrY0/IMG-4371.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/fRt2SFSn/IMG-4368.gif',
    name: '14'
  }, {
    id: 'frame_cat_ear',
    url: 'https://i.postimg.cc/kGgwJhPH/IMG-4374.gif',
    name: '1'
  }, {
    id: 'frame_ribbon',
    url: 'https://i.postimg.cc/PrcKH436/IMG-4376.gif',
    name: '2'
  }, {
    id: 'frame_flower',
    url: 'https://i.postimg.cc/fRV86FMq/IMG-4381.gif',
    name: '3'
  }, {
    id: 'frame_tech',
    url: 'https://i.postimg.cc/HsyqMVyk/IMG-4385.gif',
    name: '4'
  }, {
    id: 'frame_5',
    url: 'https://i.postimg.cc/qBbKK7dS/IMG-4386.gif',
    name: '5'
  }, {
    id: 'frame_6',
    url: 'https://i.postimg.cc/05wnd389/IMG-4388.gif',
    name: '6'
  }, {
    id: 'frame_7',
    url: 'https://i.postimg.cc/RZNLhbbr/IMG-4389.gif',
    name: '7'
  }, {
    id: 'frame_8',
    url: 'https://i.postimg.cc/fLTc42dg/IMG-4391.gif',
    name: '8'
  }, {
    id: 'frame_9',
    url: 'https://i.postimg.cc/FzbGNdRT/IMG-4392.gif',
    name: '9'
  }, {
    id: 'frame_10',
    url: 'https://i.postimg.cc/XY63sTS3/IMG-4393.gif',
    name: '10'
  }, {
    id: 'frame_11',
    url: 'https://i.postimg.cc/Cx9vCVWH/IMG-4395.gif',
    name: '11'
  }, {
    id: 'frame_12',
    url: 'https://i.postimg.cc/kMfPQBwQ/IMG-4396.gif',
    name: '12'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/CLrZQMMD/IMG-4398.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/L4zwDhTC/IMG-4399.gif',
    name: '14'
  }, {
    id: 'frame_cat_ear',
    url: 'https://i.postimg.cc/yN3s8szM/IMG-4400.gif',
    name: '1'
  }, {
    id: 'frame_ribbon',
    url: 'https://i.postimg.cc/59Cn1tkB/IMG-4401.gif',
    name: '2'
  }, {
    id: 'frame_flower',
    url: 'https://i.postimg.cc/g0s1V0PX/IMG-4402.gif',
    name: '3'
  }, {
    id: 'frame_tech',
    url: 'https://i.postimg.cc/Jn1DFPgY/IMG-4403.gif',
    name: '4'
  }, {
    id: 'frame_5',
    url: 'https://i.postimg.cc/q7cQnDy1/IMG-4404.gif',
    name: '5'
  }, {
    id: 'frame_6',
    url: 'https://i.postimg.cc/RFK3q2t0/IMG-4407.gif',
    name: '6'
  }, {
    id: 'frame_7',
    url: 'https://i.postimg.cc/gcV0VR2t/IMG-4408.gif',
    name: '7'
  }, {
    id: 'frame_8',
    url: 'https://i.postimg.cc/W1CjLb4J/IMG-4409.gif',
    name: '8'
  }, {
    id: 'frame_9',
    url: 'https://i.postimg.cc/Ss7pM6fW/IMG-4410.gif',
    name: '9'
  }, {
    id: 'frame_10',
    url: 'https://i.postimg.cc/nrFfYX3N/IMG-4412.gif',
    name: '10'
  }, {
    id: 'frame_11',
    url: 'https://i.postimg.cc/cHWp0KG6/IMG-4413.gif',
    name: '11'
  }, {
    id: 'frame_12',
    url: 'https://i.postimg.cc/4yNjHrdg/IMG-4414.gif',
    name: '12'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/hPX5F8Qp/IMG-4415.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/vHCSG1WM/IMG-4416.gif',
    name: '14'
  }, {
    id: 'frame_cat_ear',
    url: 'https://i.postimg.cc/x1Hp80Rm/IMG-4417.gif',
    name: '1'
  }, {
    id: 'frame_ribbon',
    url: 'https://i.postimg.cc/FHRcCGfH/IMG-4418.gif',
    name: '2'
  }, {
    id: 'frame_flower',
    url: 'https://i.postimg.cc/13hhJ77p/IMG-4419.gif',
    name: '3'
  }, {
    id: 'frame_tech',
    url: 'https://i.postimg.cc/J4WCQd2j/IMG-4420.gif',
    name: '4'
  }, {
    id: 'frame_5',
    url: 'https://i.postimg.cc/Dydkpd9H/IMG-4421.gif',
    name: '5'
  }, {
    id: 'frame_6',
    url: 'https://i.postimg.cc/mrkvDxPW/IMG-4422.gif',
    name: '6'
  }, {
    id: 'frame_7',
    url: 'https://i.postimg.cc/76Tj3g1B/IMG-4425.gif',
    name: '7'
  }, {
    id: 'frame_8',
    url: 'https://i.postimg.cc/3N5Vndn3/IMG-4426.gif',
    name: '8'
  }, {
    id: 'frame_9',
    url: 'https://i.postimg.cc/05DLr0yj/IMG-4427.gif',
    name: '9'
  }, {
    id: 'frame_10',
    url: 'https://i.postimg.cc/GhR6DT4Q/IMG-4428.gif',
    name: '10'
  }, {
    id: 'frame_11',
    url: 'https://i.postimg.cc/fRTF24jS/IMG-4430.gif',
    name: '11'
  }, {
    id: 'frame_12',
    url: 'https://i.postimg.cc/R0WYmcYM/IMG-4431.gif',
    name: '12'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/nrJSqNhz/IMG-4432.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/tC9mJ0cv/IMG-4438.gif',
    name: '14'
  }, {
    id: 'frame_cat_ear',
    url: 'https://i.postimg.cc/XNkQTHvf/IMG-5561.gif',
    name: '1'
  }, {
    id: 'frame_ribbon',
    url: 'https://i.postimg.cc/Mpv5fzm5/IMG-4439.gif',
    name: '2'
  }, {
    id: 'frame_flower',
    url: 'https://i.postimg.cc/T1tjhsyB/IMG-4720.gif',
    name: '3'
  }, {
    id: 'frame_tech',
    url: 'https://i.postimg.cc/c4JMPd2W/IMG-4724.gif',
    name: '4'
  }, {
    id: 'frame_5',
    url: 'https://i.postimg.cc/g2XykNGB/IMG-4727.gif',
    name: '5'
  }, {
    id: 'frame_6',
    url: 'https://i.postimg.cc/y8MmJcd6/IMG-4728.gif',
    name: '6'
  }, {
    id: 'frame_7',
    url: 'https://i.postimg.cc/Lsjzj5Yt/IMG-4729.gif',
    name: '7'
  }, {
    id: 'frame_8',
    url: 'https://i.postimg.cc/bNdk33SN/IMG-4893.gif',
    name: '8'
  }, {
    id: 'frame_9',
    url: 'https://i.postimg.cc/4x9tTy1D/IMG-5563.gif',
    name: '9'
  }, {
    id: 'frame_10',
    url: 'https://i.postimg.cc/DZshzKv6/IMG-5576.gif',
    name: '10'
  }, {
    id: 'frame_11',
    url: 'https://i.postimg.cc/Fsvr71JL/IMG-5573.gif',
    name: '11'
  }, {
    id: 'frame_12',
    url: 'https://i.postimg.cc/Fz3HwLk9/IMG-5569.gif',
    name: '12'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/wjH180kn/IMG-5566.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/MG6qtLYK/IMG-5565.gif',
    name: '14'
  }, {
    id: 'frame_cat_ear',
    url: 'https://i.postimg.cc/CKgDNYVb/IMG-5577.gif',
    name: '1'
  }, {
    id: 'frame_ribbon',
    url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif',
    name: '2'
  }, {
    id: 'frame_flower',
    url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif',
    name: '3'
  }, {
    id: 'frame_tech',
    url: 'https://i.postimg.cc/C5XnfpNB/IMG-5579.gif',
    name: '4'
  }, {
    id: 'frame_5',
    url: 'https://i.postimg.cc/4y7mGFgJ/IMG-5716.gif',
    name: '5'
  }, {
    id: 'frame_6',
    url: 'https://i.postimg.cc/FzM1Hgr0/IMG-5717.gif',
    name: '6'
  }, {
    id: 'frame_7',
    url: 'https://i.postimg.cc/rF4KYbjj/IMG-5720.gif',
    name: '7'
  }, {
    id: 'frame_8',
    url: 'https://i.postimg.cc/6pLTBvDG/IMG-5721.gif',
    name: '8'
  }, {
    id: 'frame_9',
    url: 'https://i.postimg.cc/VNK6Ccsf/IMG-5722.gif',
    name: '9'
  }, {
    id: 'frame_10',
    url: 'https://i.postimg.cc/wx72fhr2/IMG-5968.gif',
    name: '10'
  }, {
    id: 'frame_11',
    url: 'https://i.postimg.cc/QdrqdvdY/IMG-5969.gif',
    name: '11'
  }, {
    id: 'frame_12',
    url: 'https://i.postimg.cc/0yd0MZ6k/IMG-5971.gif',
    name: '12'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/1zmcp66p/IMG-5973.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/wBw5Fvcn/IMG-5974.gif',
    name: '14'
  }, {
    id: 'frame_cat_ear',
    url: 'https://i.postimg.cc/R0pfKYvB/IMG-5976.gif',
    name: '1'
  }, {
    id: 'frame_ribbon',
    url: 'https://i.postimg.cc/9fQZ425b/IMG-5975.gif',
    name: '2'
  }, {
    id: 'frame_flower',
    url: 'https://i.postimg.cc/v8V9xXjJ/IMG-6137.gif',
    name: '3'
  }, {
    id: 'frame_tech',
    url: 'https://i.postimg.cc/WbmkXzsS/IMG-6138.gif',
    name: '4'
  }, {
    id: 'frame_5',
    url: 'https://i.postimg.cc/Dw2bDhZh/IMG-6140.gif',
    name: '5'
  }, {
    id: 'frame_6',
    url: 'https://i.postimg.cc/ZqQBCyLY/IMG-6144.gif',
    name: '6'
  }, {
    id: 'frame_7',
    url: 'https://i.postimg.cc/qRCtnMms/IMG-6145.gif',
    name: '7'
  }, {
    id: 'frame_8',
    url: 'https://i.postimg.cc/1Rwn3XVP/IMG-6146.gif',
    name: '8'
  }, {
    id: 'frame_9',
    url: 'https://i.postimg.cc/Kv51tW5H/IMG-6147.gif',
    name: '9'
  }, {
    id: 'frame_10',
    url: 'https://i.postimg.cc/nhcC21Rc/IMG-6148.gif',
    name: '10'
  }, {
    id: 'frame_11',
    url: 'https://i.postimg.cc/fTWzQRx8/IMG-6149.gif',
    name: '11'
  }, {
    id: 'frame_12',
    url: 'https://i.postimg.cc/LXyyqDbY/IMG-6294.gif',
    name: '12'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/7Zgm1wRy/IMG-6295.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/5tbpnDcQ/IMG-6296.gif',
    name: '14'
  }, {
    id: 'frame_cat_ear',
    url: 'https://i.postimg.cc/YSRRV8kn/IMG-6297.gif',
    name: '1'
  }, {
    id: 'frame_ribbon',
    url: 'https://i.postimg.cc/k45sd8gn/IMG-6375.gif',
    name: '2'
  }, {
    id: 'frame_flower',
    url: 'https://i.postimg.cc/50k390X8/IMG-6376.gif',
    name: '3'
  }, {
    id: 'frame_tech',
    url: 'https://i.postimg.cc/90RBDh9K/IMG-6377.gif',
    name: '4'
  }, {
    id: 'frame_5',
    url: 'https://i.postimg.cc/cCpBYbMH/IMG-6552.gif',
    name: '5'
  }, {
    id: 'frame_6',
    url: 'https://i.postimg.cc/Pf9g2fSL/IMG-6554.gif',
    name: '6'
  }, {
    id: 'frame_7',
    url: 'https://i.postimg.cc/gkhf597g/IMG-6555.gif',
    name: '7'
  }, {
    id: 'frame_8',
    url: 'https://i.postimg.cc/g2PfbSFm/IMG-6556.gif',
    name: '8'
  }, {
    id: 'frame_9',
    url: 'https://i.postimg.cc/pLY3WfR8/IMG-6557.gif',
    name: '9'
  }, {
    id: 'frame_10',
    url: 'https://i.postimg.cc/65Cmcr7S/IMG-6559.gif',
    name: '10'
  }, {
    id: 'frame_11',
    url: 'https://i.postimg.cc/Y94XWYKd/IMG-6560.gif',
    name: '11'
  }, {
    id: 'frame_12',
    url: 'https://i.postimg.cc/ydwLXx7s/IMG-6562.gif',
    name: '12'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/G3y73Fj2/IMG-6563.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/TYvkKKkc/IMG-6565.gif',
    name: '14'
  }, {
    id: 'frame_cat_ear',
    url: 'https://i.postimg.cc/GmcqjZn8/IMG-6566.gif',
    name: '1'
  }, {
    id: 'frame_ribbon',
    url: 'https://i.postimg.cc/k5Gs0K47/IMG-6567.gif',
    name: '2'
  }, {
    id: 'frame_flower',
    url: 'https://i.postimg.cc/XJy8JWdh/IMG-6568.gif',
    name: '3'
  }, {
    id: 'frame_tech',
    url: 'https://i.postimg.cc/fycfcvHf/IMG-6569.gif',
    name: '4'
  }, {
    id: 'frame_5',
    url: 'https://i.postimg.cc/J7ZxC11H/IMG-6570.gif',
    name: '5'
  }, {
    id: 'frame_6',
    url: 'https://i.postimg.cc/hPnrSHjy/IMG-4434.gif',
    name: '6'
  }, {
    id: 'frame_7',
    url: 'https://i.postimg.cc/YqxxjbLp/IMG-6572.gif',
    name: '7'
  }, {
    id: 'frame_8',
    url: 'https://i.postimg.cc/wjfcQMkZ/IMG-6573.gif',
    name: '8'
  }, {
    id: 'frame_9',
    url: 'https://i.postimg.cc/Vv8jkCYr/IMG-6574.gif',
    name: '9'
  }, {
    id: 'frame_10',
    url: 'https://i.postimg.cc/MZ77rdDy/IMG-6850.gif',
    name: '10'
  }, {
    id: 'frame_11',
    url: 'https://i.postimg.cc/T3NvqJCZ/IMG-6851.gif',
    name: '11'
  }, {
    id: 'frame_12',
    url: 'https://i.postimg.cc/28TsrxRV/IMG-6852.gif',
    name: '12'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/VkV2bLNw/IMG-6853.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/gJ95NSRB/IMG-6854.gif',
    name: '14'
  }, {
    id: 'frame_cat_ear',
    url: 'https://i.postimg.cc/d1qsQsbQ/IMG-6855.gif',
    name: '1'
  }, {
    id: 'frame_ribbon',
    url: 'https://i.postimg.cc/gJNYx9pV/IMG-6856.gif',
    name: '2'
  }, {
    id: 'frame_flower',
    url: 'https://i.postimg.cc/fyPDvxJk/IMG-6860.gif',
    name: '3'
  }, {
    id: 'frame_tech',
    url: 'https://i.postimg.cc/QMDsSNxg/IMG-6861.gif',
    name: '4'
  }, {
    id: 'frame_5',
    url: 'https://i.postimg.cc/vBqsQW7X/IMG-6858.gif',
    name: '5'
  }, {
    id: 'frame_6',
    url: 'https://i.postimg.cc/Y0vwjhb7/IMG-6857.gif',
    name: '6'
  }, {
    id: 'frame_7',
    url: 'https://i.postimg.cc/90sH9Cn7/IMG-6868.gif',
    name: '7'
  }, {
    id: 'frame_8',
    url: 'https://i.postimg.cc/Y2PHZzCC/IMG-6866.gif',
    name: '8'
  }, {
    id: 'frame_9',
    url: 'https://i.postimg.cc/7Z8yYP7v/IMG-6889.gif',
    name: '9'
  }, {
    id: 'frame_10',
    url: 'https://i.postimg.cc/nryNzTXK/IMG-6915.gif',
    name: '10'
  }, {
    id: 'frame_11',
    url: 'https://i.postimg.cc/Qx5dqyJ3/IMG-6917.gif',
    name: '11'
  }, {
    id: 'frame_12',
    url: 'https://i.postimg.cc/Wbr0JSDD/IMG-5316.gif',
    name: '12'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/tgR6wjBP/IMG-5570.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/d0WCKxff/IMG-6932.gif',
    name: '14'
  }, {
    id: 'frame_11',
    url: 'https://i.postimg.cc/Ss3znzk7/IMG-6934.gif',
    name: '11'
  }, {
    id: 'frame_12',
    url: 'https://i.postimg.cc/nrm9BcL8/IMG-6941.gif',
    name: '12'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/ZYvd1jxf/IMG-6937.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/sDFhySn3/IMG-6936.gif',
    name: '14'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/43PhvxRq/IMG-6922.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/3Rb46fRZ/IMG-6923.gif',
    name: '14'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/PJppkbvn/IMG-6918.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/XqRZNZ9G/IMG-6916.gif',
    name: '14'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/RVt6sRzc/IMG-6939.gif',
    name: '14'
  }, {
    id: 'frame_13',
    url: 'https://i.postimg.cc/mgGc0HbK/IMG-6926.gif',
    name: '13'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/P5zLh5JJ/IMG-6942.gif',
    name: '14'
  }, {
    id: 'frame_14',
    url: 'https://i.postimg.cc/xCqqKGRN/IMG-6929.gif',
    name: '14'
  },
  {
    id: 'frame_12',
    url: 'https://i.postimg.cc/7LSRp4hx/e7fa949b9pc84cff0dabe57defceb54c.gif',
    name: '12'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/DZgMwc1H/817178fdbpf2ff7740dc98e26ab78759.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/3NffgJSZ/e09c07034ld7e62266c0a5de6a36ae62.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/vHDNGfT2/35ac7f372v588bf48d4f659077196b85.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/KvVsjjgG/3c3aa5219s18b90187ef1f54b3db7ba8.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/k5P1NHcL/55f3e31d8qbc8a02d152b07b99d31567.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/FFCTCzpy/641bad3b3udc599fdb63ca75fde427e5.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/8k7YSLjK/1689aa46aqc4b9ffc0f970e668f56537.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/J0CZSwyW/IMG-6938.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/Df1qLzDf/IMG-6927.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/CLNkrQSW/IMG-6925.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/y8p9s3Jj/IMG-6919.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/Lsr1Zd3Z/IMG-6928.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/Ssgbv41n/IMG-6876.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/SNByPrf9/IMG-7005.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/Z5nrCyS5/IMG-7006.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/mDfMXXFP/IMG-7007.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/DZrGtrqB/IMG-7008.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/ZnJNZWHZ/IMG-7009.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/RhGH0vpt/IMG-7010.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/tRzPkzRg/IMG-7012.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/wTTNGs3Q/IMG-7013.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/3JSG5Jv5/IMG-7014.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/rwDr8X1d/IMG-7015.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/DzDy2vS7/IMG-7017.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/QMVdG9x6/IMG-7016.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/mZ9hgH3J/IMG-7019.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/t4ksHGdg/IMG-7020.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/hP9JpdfT/IMG-7023.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/wTKyXVT9/IMG-7024.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/ZqjKXPSv/IMG-7025.gif',
    name: '14'
  },

  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/gj3Tmqz5/mmexport1751030241029.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/4yCXW52F/mmexport1751030908335.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/VkXngG72/mmexport1751031208329.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/LscBkxZb/mmexport1751017556565.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/1XqzGKwJ/mmexport1751018282681.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/8kHCQwbQ/mmexport1751020645824.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/HWynLK7f/mmexport1751021724230.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/JnwFp3Kx/mmexport1751031208329.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/HLZNWkQw/mmexport1751031767634.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/vH2X6N1y/mmexport1751032231179.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/NFS4ZyvM/mmexport1751032686953.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/3RpmWc8c/mmexport1751033102811.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/L5RLr3tg/mmexport1751035976943.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/4NCPsp5d/mmexport1751034427637.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/CMv02LHm/mmexport1751034842120.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/rFnSzWGx/mmexport1751035618517.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/7YRbzN51/mmexport1751036276038.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/cJpbtPWq/mmexport1751036607799.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/HxLV5v92/mmexport1751036977582.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/D01rYy86/mmexport1751037965259.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/J4fwkTLW/mmexport1751038167142.gif',
    name: '14'
  },


  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/xjpN4swz/IMG-7240.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/ZnzbGdxX/IMG-7239.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/DyYDmKtw/IMG-7238.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/W40f9qtd/IMG-7098.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/8PsK20jQ/IMG-7236.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/cHsTXDVz/IMG-7235.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/sXwm8Yzg/IMG-7234.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/xTk5xN49/IMG-7233.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/k5yv6QBv/IMG-7232.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/yx2m4nbs/IMG-7231.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/vZt0fFKn/IMB-r-HMBXY.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/pddJj9zN/IMG-7094.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/rmB17Qbc/IMB-f-VDf-Fc.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/VkKjzYTK/IMB-f4kk-CT.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/B6KD52vz/IMG-7096.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/9XPwWmwy/IMB-Kf7um-P.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/mrFhKBGz/IMB-e-QWBpa.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/bw4wxW2z/IMB-16r-COL.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/3x0Kx1fz/IMB-K1u-Jp-P.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/CLz0cJ0d/IMG-7116.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/fyyGgW61/IMG-7115.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/gkk7s0vD/IMG-6984.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/0NpZPgYj/IMG-6985.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/tTWKKmTN/IMG-7073.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/jS8tc9wW/IMG-7083.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/rmRVKJpD/IMG-7087.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/zvWGPjms/IMG-7090.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/YSkqDg8V/IMG-7092.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/FzqHTBng/IMG-7093.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/tTpZ6wLs/IMG-7095.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/8P5vt8sW/IMG-7097.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/wMxmCZVC/IMG-7099.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/2jxd0FGp/IMG-7100.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/B6T59xGK/IMG-7101.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/kXfcgFRN/IMG-7106.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/htZppbS4/IMG-7107.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/hPgyjtyn/IMG-7108.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/HLKvs0Kv/IMG-7109.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/wjwbnYkp/IMG-7111.gif',
    name: '14'
  },
  {
    id: 'frame_13',
    url: 'https://i.postimg.cc/bJDMQVkj/IMG-7112.gif',
    name: '13'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/SNWBTP5S/IMG-7113.gif',
    name: '14'
  },
  {
    id: 'frame_14',
    url: 'https://i.postimg.cc/jCVMQsKH/IMG-7114.gif',
    name: '14'
  },

  ];
  let billState = {
    page: 0,
    pageSize: 30,
    isLoading: false,
    hasMore: true,
    filterDate: '',
    filterType: 'all'
  };
  let state = {
    chats: {},
    activeChatId: null,
    globalSettings: {},
    apiConfig: {},
    userStickers: [],
    worldBooks: [],
    personaPresets: [],
    qzoneSettings: {},
    activeAlbumId: null,
    cache: {
      songs: new Map(),
      lyrics: new Map()
    },
    ttsCache: new Map(),
    quickReplies: []
  };

  // „ÄêÊñ∞Â¢û„ÄëÊö¥Èú≤ state Âà∞ windowÔºå‰æõËÅîÊú∫ÂäüËÉΩËÆøÈóÆ
  window.state = state;

  let memoryCache = []; // ÁºìÂ≠òÊâÄÊúâÈúÄË¶ÅÊòæÁ§∫ÁöÑËÆ∞ÂøÜ
  let memoryRenderCount = 0; // ÂΩìÂâçÂ∑≤Ê∏≤ÊüìÊï∞Èáè
  let isLoadingMoreMemories = false; // Èò≤ÊäñÈîÅ

  // ÂæÖÂäû‰∫ãÈ°πÂàÜÈ°µÁä∂ÊÄÅ
  let todoCache = [];
  let todoRenderCount = 0;
  let isLoadingMoreTodos = false;
  async function uploadImageToImgBB(base64String) {
    // 1. Ê£ÄÊü•ÂäüËÉΩÊòØÂê¶ÂºÄÂêØ
    if (!state.apiConfig.imgbbEnable || !state.apiConfig.imgbbApiKey) {
      // console.log("ImgBB Êú™ÂºÄÂêØÔºåËøîÂõûÂéüÂßã Base64„ÄÇ");
      return base64String; // ÂäüËÉΩÊú™ÂºÄÂêØÔºåÁõ¥Êé•ËøîÂõû
    }

    // 2. Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊòØ URL
    if (!base64String || !base64String.startsWith('data:image')) {
      // console.log("ËæìÂÖ•Â∑≤ÊòØ URL Êàñ‰∏∫Á©∫ÔºåÊó†ÈúÄ‰∏ä‰º†„ÄÇ");
      return base64String; // Â∑≤ÁªèÊòØ URL Êàñ‰∏∫Á©∫ÔºåÊó†ÈúÄ‰∏ä‰º†
    }

    // 3. ÊèêÂèñ Base64 Êï∞ÊçÆ
    // Ê†ºÂºè‰∏∫ data:image/png;base64,iVBORw0KGgo...
    const base64Data = base64String.split(',')[1];
    if (!base64Data) {
      console.warn("Êó†Ê≥ï‰ªéÂ≠óÁ¨¶‰∏≤‰∏≠ÊèêÂèñ Base64 Êï∞ÊçÆ:", base64String.substring(0, 50) + "...");
      return base64String; // Ê†ºÂºèÈîôËØØÔºåËøîÂõûÂéüÊñá
    }

    console.log(`[ImgBB] ÂºÄÂßã‰∏ä‰º†ÂõæÁâá... (Â§ßÂ∞è: ${(base64String.length / 1024).toFixed(1)} KB)`);

    try {
      const formData = new FormData();
      formData.append('image', base64Data);

      const response = await fetch(`https://api.imgbb.com/1/upload?key=${state.apiConfig.imgbbApiKey}`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (result.success && result.data && result.data.url) {
        console.log("[ImgBB] ‰∏ä‰º†ÊàêÂäü! URL:", result.data.url);
        return result.data.url; // ÊàêÂäüÔºÅËøîÂõû URL
      } else {
        // ImgBB API ËøîÂõû‰∫ÜÈîôËØØ
        throw new Error(result.error?.message || 'ImgBB API ËøîÂõû‰∫ÜÊú™Áü•ÈîôËØØ„ÄÇ');
      }
    } catch (error) {
      console.error("[ImgBB] ‰∏ä‰º†Â§±Ë¥•:", error);
      // ÊäõÂá∫ÈîôËØØÔºåËÆ©Ë∞ÉÁî®Ê≠§ÂáΩÊï∞ÁöÑ‰∏äÂ±ÇÈÄªËæëÁü•ÈÅì‰∏ä‰º†Â§±Ë¥•‰∫Ü
      throw new Error(`ImgBB ‰∏ä‰º†Â§±Ë¥•: ${error.message}`);
    }
  }
  async function uploadFileToCatbox(fileObject) {
    // 1. Ê£ÄÊü•ÂäüËÉΩÊòØÂê¶ÂºÄÂêØ
    if (!state.apiConfig.catboxEnable || !state.apiConfig.catboxUserHash) {
      console.log("[Catbox] ÂäüËÉΩÊú™ÂºÄÂêØÊàñÊú™ÈÖçÁΩÆ User HashÔºåË∑≥Ëøá‰∏ä‰º†„ÄÇ");
      return null; // ÂäüËÉΩÊú™ÂºÄÂêØÔºåËøîÂõû null ‰ª•‰æøÂõûÈÄÄ
    }

    const userHash = state.apiConfig.catboxUserHash;
    console.log(`[Catbox] ÂºÄÂßã‰∏ä‰º†Êñá‰ª∂: ${fileObject.name || 'blob.mp3'}... (Â§ßÂ∞è: ${(fileObject.size / 1024 / 1024).toFixed(2)} MB)`);

    try {
      const formData = new FormData();
      formData.append('reqtype', 'fileupload');
      formData.append('userhash', userHash);
      formData.append('fileToUpload', fileObject, fileObject.name || 'track.mp3'); // Êèê‰æõÊñá‰ª∂Âêç

      // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë ‚ñº‚ñº‚ñº
      // 1. ÂÆö‰πâ Catbox API URL
      let apiUrl = 'https://catbox.moe/user/api.php';

      // 2. Ëé∑Âèñ CORS ‰ª£ÁêÜËÆæÁΩÆ (Â§çÁî® NovelAI ÁöÑËÆæÁΩÆ)
      const proxySettings = getNovelAISettings(); // This function is around line 4504
      let corsProxy = proxySettings.cors_proxy;
      if (corsProxy === 'custom') {
        corsProxy = proxySettings.custom_proxy_url || '';
      }

      // 3. Â¶ÇÊûú‰ª£ÁêÜÂ≠òÂú®, Âàô‰ΩøÁî®‰ª£ÁêÜ
      if (corsProxy && corsProxy !== '') {
        // „ÄêÈáçË¶Å„ÄëCatbox API URL ‰∏çÈúÄË¶ÅÁºñÁ†ÅÔºåËÄå NovelAI ÈúÄË¶ÅÔºåËøôÈáåÊàë‰ª¨Áõ¥Êé•ÊãºÊé•
        apiUrl = corsProxy + apiUrl;
        console.log(`[Catbox] Ê£ÄÊµãÂà∞CORS‰ª£ÁêÜÔºå‰ΩøÁî®‰ª£ÁêÜ‰∏ä‰º†: ${apiUrl}`);
      } else {
        console.log("[Catbox] Êú™ÈÖçÁΩÆCORS‰ª£ÁêÜÔºåÂ∞ùËØïÁõ¥Ëøû... (ËøôÂæàÂèØËÉΩ‰ºöÂ§±Ë¥•)");
      }
      // ‚ñ≤‚ñ≤‚ñ≤ „Äê‰øÆÂ§çÁªìÊùü„Äë ‚ñ≤‚ñ≤‚ñ≤

      const response = await fetch(apiUrl, { // <-- ÊõøÊç¢‰∏∫ apiUrl
        method: 'POST',
        body: formData
      });

      const responseText = await response.text();

      if (response.ok && responseText.startsWith('http')) {
        console.log("[Catbox] ‰∏ä‰º†ÊàêÂäü! URL:", responseText);
        return responseText; // ÊàêÂäüÔºÅËøîÂõû URL
      } else {
        // Catbox API ËøîÂõû‰∫ÜÈîôËØØÊñáÊú¨
        throw new Error(responseText || 'Catbox API ËøîÂõû‰∫ÜÊú™Áü•ÈîôËØØ„ÄÇ');
      }
    } catch (error) {
      console.error("[Catbox] ‰∏ä‰º†Â§±Ë¥•:", error);
      // ÊäõÂá∫ÈîôËØØÔºåËÆ©Ë∞ÉÁî®Ê≠§ÂáΩÊï∞ÁöÑ‰∏äÂ±ÇÈÄªËæëÁü•ÈÅì‰∏ä‰º†Â§±Ë¥•‰∫Ü
      // „ÄêÈáçË¶Å„ÄëÊàë‰ª¨Âú®ËøôÈáåÂè™ÊäõÂá∫ÂéüÂßãÈîôËØØÔºå‰ª•‰æø‰∏äÂ±ÇÂáΩÊï∞ÂèØ‰ª•ÊçïËé∑Âπ∂ÊòæÁ§∫ÂÆÉ
      throw error;
    }
  }
  async function silentlyUpdateDbUrl(table, recordId, pathString, base64ToFind, nameToMatch = null) {
    if (!state.apiConfig.imgbbEnable || !state.apiConfig.imgbbApiKey) {
      console.log(`[ImgBB Silent Update] ImgBB is disabled, skipping silent upload for ${table.name}.${recordId}.${pathString}.`);
      return; // ImgBB not enabled, do nothing.
    }

    let imageUrl;
    try {
      imageUrl = await uploadImageToImgBB(base64ToFind);
      if (imageUrl === base64ToFind) {
        console.log("[ImgBB Silent Update] Upload returned Base64 (or failed), no update needed.");
        return; // Upload failed or was skipped
      }
    } catch (uploadError) {
      console.error(`[ImgBB Silent Update] Background upload failed for ${table.name}.${recordId}.${pathString}:`, uploadError.message);
      return; // Upload failed
    }

    console.log(`[ImgBB Silent Update] Success. New URL: ${imageUrl}. Finding record to update...`);

    try {
      const record = await table.get(recordId);
      if (!record) {
        console.warn(`[ImgBB Silent Update] Could not find record ${recordId} in table ${table.name}.`);
        return;
      }

      let updated = false;

      // ËæÖÂä©ÂáΩÊï∞ÔºöÈÄöËøáË∑ØÂæÑÂ≠óÁ¨¶‰∏≤Ê∑±ÂÖ•ÂØπË±°ÔºåËøîÂõûÁà∂Á∫ßÂíåÊúÄÂêéÁöÑÈîÆ
      function getNestedParent(obj, path) {
        const keys = path.split('.');
        let current = obj;
        for (let i = 0; i < keys.length - 1; i++) {
          if (current[keys[i]] === undefined || current[keys[i]] === null) {
            console.warn(`[ImgBB Silent Update] Invalid path: ${path} in record at key ${keys[i]}.`);
            return null; // Path does not exist
          }
          current = current[keys[i]];
        }
        return { parent: current, finalKey: keys[keys.length - 1] };
      }

      if (nameToMatch) {
        // --- ÈÄªËæë A: ÊêúÁ¥¢Êï∞ÁªÑ ---
        const result = getNestedParent(record, pathString);
        if (result && Array.isArray(result.parent[result.finalKey])) {
          const arrayToSearch = result.parent[result.finalKey];
          const itemToUpdate = arrayToSearch.find(item => item.url === base64ToFind && item.name === nameToMatch);

          if (itemToUpdate) {
            itemToUpdate.url = imageUrl;
            updated = true;
            console.log(`[ImgBB Silent Update] Found and updated item "${nameToMatch}" in array ${pathString}.`);
          } else {
            console.warn(`[ImgBB Silent Update] Could not find item "${nameToMatch}" with matching Base64 in array ${pathString} to update.`);
          }
        } else {
          console.warn(`[ImgBB Silent Update] Path ${pathString} did not resolve to a valid array.`);
        }
      } else {
        // --- ÈÄªËæë B: Êõ¥Êñ∞ÁÆÄÂçïÂ±ûÊÄß (Â¶Ç 'url' Êàñ 'widgetData.polaroid-img-1') ---
        const result = getNestedParent(record, pathString);
        if (result && result.parent[result.finalKey] === base64ToFind) {
          result.parent[result.finalKey] = imageUrl;
          updated = true;
          console.log(`[ImgBB Silent Update] Found and updated simple path ${pathString}.`);
        } else if (result) {
          console.warn(`[ImgBB Silent Update] Value changed since upload for ${pathString}. Expected Base64, found: ${String(result.parent[result.finalKey]).substring(0, 30)}...`);
        } else {
          console.warn(`[ImgBB Silent Update] Path ${pathString} did not resolve to a matching string.`);
        }
      }


      if (updated) {
        await table.put(record);
        console.log(`[ImgBB Silent Update] Successfully updated DB for ${table.name}.${recordId}.${pathString}.`);

        // Êõ¥Êñ∞ÂÜÖÂ≠ò (state.globalSettings)
        if (table.name === 'globalSettings' && recordId === 'main') {
          // (ÈáçÊñ∞Ëé∑ÂèñÊõ¥Êñ∞ÂêéÁöÑÂÜÖÂ≠òÁä∂ÊÄÅ)
          const stateResult = getNestedParent(state, `globalSettings.${pathString}`);
          if (nameToMatch && stateResult && Array.isArray(stateResult.parent[stateResult.finalKey])) {
            const stateArray = stateResult.parent[stateResult.finalKey];
            const stateItem = stateArray.find(item => item.url === base64ToFind && item.name === nameToMatch);
            if (stateItem) stateItem.url = imageUrl;
          } else if (!nameToMatch && stateResult && stateResult.parent[stateResult.finalKey] === base64ToFind) {
            stateResult.parent[stateResult.finalKey] = imageUrl;
          }
          console.log(`[ImgBB Silent Update] In-memory state.globalSettings updated.`);
        }
      }
    } catch (dbError) {
      console.error(`[ImgBB Silent Update] Failed to save updated URL to DB for ${table.name}.${recordId}.${pathString}:`, dbError);
    }
  }
  let werewolfGameState = {
    isActive: false,
    gameMode: null,
    chatId: null,
    players: [],
    currentDay: 1,
    currentPhase: 'setup',
    nightActions: {},
    gameLog: [],
    discussionLog: [],
    voteResults: {},
    electionInfo: {
      candidates: [],
      votes: {}
    },
    sheriffId: null,
    lastFailedAction: null,
  };

  let thoughtsHistoryRenderCount = 0;
  const THOUGHTS_RENDER_WINDOW = 15;


  let qzonePostsRenderCount = 0;
  const QZONE_RENDER_WINDOW = 10;

  let qzonePostsCache = [];

  let musicState = {
    isActive: false,
    activeChatId: null,
    isPlaying: false,
    playlist: [],
    currentIndex: -1,
    playMode: 'order',
    totalElapsedTime: 0,
    timerId: null,

    parsedLyrics: [],
    currentLyricIndex: -1
  };
  let qzoneStickerPanelState = {
    isOpen: false,
    activePostId: null,
    panelEl: null,
    gridEl: null
  };
  const audioPlayer = document.getElementById('audio-player');
  // ÂèòÈáèÂ£∞ÊòéÂå∫Âüü
  let isQuickReplyManagementMode = false;
  let selectedQuickReplies = new Set();
  let newWallpaperBase64 = null;
  let isRuleManagementMode = false;
  let selectedRules = new Set();
  let isSelectionMode = false;
  let cphoneRenderedCount = 0;
  let cphoneActiveConversationType = null;
  let isLoadingMoreCphoneMessages = false;
  let myphoneRenderedCount = 0;
  let myphoneActiveConversationIndex = null;
  let isLoadingMoreMyPhoneMessages = false;
  let activeStickerCategoryId = 'all';
  let selectedMessages = new Set();
  let editingMemberId = null;
  let isAddingNpcToGroup = false;
  let editingWorldBookId = null;
  let editingRuleId = null;
  let isLoadingMoreChats = false;
  let isLoadingMoreMessages = false;
  let isLoadingMoreThoughts = false;
  let isLoadingMorePosts = false;
  let sortedChatListItems = [];
  let editingPersonaPresetId = null;
  let isManageMode = false;
  let selectedPresetIds = new Set();
  let pendingTavernPersonas = [];
  let currentReplyContext = null;
  let waimaiTimers = {};
  let currentSpectatorMode = 'group';
  let activeMessageTimestamp = null;
  let activeCharacterId = null;
  let editingMemoId = null;
  let editingDiaryId = null;
  let activeDiaryForViewing = null;
  let activeArticleForViewing = null;
  let activeMemoForViewing = null;
  let currentNaiPresetId = null;
  let shoppingCart = [];
  let editingProductId = null;
  let activeProductId = null;
  let selectedProducts = new Set();
  let activeQuickReplyCategoryId = 'all';

  // ========== Ë¥≠Áâ©ËΩ¶ÊåÅ‰πÖÂåñÂäüËÉΩ ==========
  // ‰øùÂ≠òË¥≠Áâ©ËΩ¶Âà∞localStorage
  function saveShoppingCart() {
    try {
      localStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
      console.log('Ë¥≠Áâ©ËΩ¶Â∑≤‰øùÂ≠ò', shoppingCart.length, '‰ª∂ÂïÜÂìÅ');
    } catch (error) {
      console.error('‰øùÂ≠òË¥≠Áâ©ËΩ¶Â§±Ë¥•:', error);
    }
  }

  // ‰ªélocalStorageÂä†ËΩΩË¥≠Áâ©ËΩ¶
  function loadShoppingCart() {
    try {
      const saved = localStorage.getItem('shoppingCart');
      if (saved) {
        shoppingCart = JSON.parse(saved);
        console.log('Ë¥≠Áâ©ËΩ¶Â∑≤ÊÅ¢Â§ç', shoppingCart.length, '‰ª∂ÂïÜÂìÅ');
        updateCartCount();
      }
    } catch (error) {
      console.error('Âä†ËΩΩË¥≠Áâ©ËΩ¶Â§±Ë¥•:', error);
      shoppingCart = [];
    }
  }
  // ========== Ë¥≠Áâ©ËΩ¶ÊåÅ‰πÖÂåñÂäüËÉΩÁªìÊùü ==========

  let currentQzoneReplyContext = null;

  let activePostId = null;
  let activeDoubanPostId = null;
  let photoViewerState = {
    isOpen: false,
    photos: [],
    currentIndex: -1,
  };

  let unreadPostsCount = 0;

  let isFavoritesSelectionMode = false;
  let selectedFavorites = new Set()

  let simulationIntervalId = null;
  let currentTodoDate = new Date(); // ÂΩìÂâçÊü•ÁúãÁöÑÊó•Êúü
  let editingTodoId = null;
  const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
  const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
  const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
  const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
  let notificationTimeout;
  let ruleCache = {};

  const DEFAULT_NOTIFICATION_SOUND = 'https://www.myinstants.com/media/sounds/notification-sound-2.mp3';

  let gomokuState = {};
  let readingState = {};
  let drawGuessState = {
    isActive: false,
    partnerId: null,
    history: [],
    isAiResponding: false,
    mode: 'online', // 'online' Êàñ 'offline'ÔºåÈªòËÆ§Á∫ø‰∏äÊ®°Âºè
    messageManager: {
      isOpen: false,
      mode: null,
      selectedTimestamps: new Set()
    }
  };
  let originalChatMessagesPaddingTop = null;



  const DEFAULT_APP_ICONS = {
    'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
    'world-book': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
    'wallpaper': 'https://i.postimg.cc/T1j03pQr/IMG-6440.jpg',
    'renderer': 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg',
    'api-settings': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
    'font': 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg',

    'char-phone': 'https://i.postimg.cc/pXj9h20L/IMG-7275.jpg',
    'douban': 'https://i.postimg.cc/Pq2xJN1g/IMG-7301.jpg',

    'preset': 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg',

    'tutorial': 'https://i.postimg.cc/d10GjC4g/IMG-7302.jpg',
    'werewolf': 'https://i.postimg.cc/k401K5g7/IMG-7304.jpg',

    'x': 'https://i.postimg.cc/Y9d3BztC/1.png',
    'alipay': 'https://i.postimg.cc/Hs7BLh76/alipay.png',
    'auction': 'https://i.postimg.cc/Hs7BLh76/alipay.png',
    'green-river': 'https://i.postimg.cc/0j55Pj1L/green-river-icon.png',
    'mail': 'https://i.postimg.cc/PfR7f37x/mail.png',

    // Á¨¨‰∏âÈ°µÁöÑAPP
    'myphone': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
    'draw-guess': 'https://i.postimg.cc/k5dG3B4p/draw-guess-icon.png',
    'char-generator': 'https://i.postimg.cc/nzGYM8qb/character-gen.jpg'
  };


  const DEFAULT_CPHONE_ICONS = {
    'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
    'album': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
    'browser': 'https://i.postimg.cc/KzC2gTq6/IMG-7276.jpg',
    'taobao': 'https://i.postimg.cc/L6R7x16R/IMG-7278.jpg',
    'memo': 'https://i.postimg.cc/J0b6Nym4/IMG-7279.jpg',
    'diary': 'https://i.postimg.cc/DZ541sbt/IMG-7280.jpg',
    'amap': 'https://i.postimg.cc/Jz2Tz0dw/IMG-7281.jpg',
    'usage': 'https://i.postimg.cc/WbF8kzz9/IMG-7282.jpg',
    'music': 'https://is1-ssl.mzstatic.com/image/thumb/Purple112/v4/64/9d/21/649d21e8-a151-6136-3914-256e54f15d9a/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/1200x630wa.png',
    'bilibili': 'https://i.postimg.cc/Wz5gV0jB/bilibili-icon.png',
    'reddit': 'https://www.redditinc.com/assets/images/site/reddit-logo.png',
    'ephone': 'https://i.postimg.cc/pXj9h20L/IMG-7275.jpg'
  };

  const DEFAULT_MYPHONE_ICONS = {
    'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
    'album': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
    'browser': 'https://i.postimg.cc/KzC2gTq6/IMG-7276.jpg',
    'taobao': 'https://i.postimg.cc/L6R7x16R/IMG-7278.jpg',
    'memo': 'https://i.postimg.cc/J0b6Nym4/IMG-7279.jpg',
    'diary': 'https://i.postimg.cc/DZ541sbt/IMG-7280.jpg',
    'amap': 'https://i.postimg.cc/Jz2Tz0dw/IMG-7281.jpg',
    'usage': 'https://i.postimg.cc/WbF8kzz9/IMG-7282.jpg',
    'music': 'https://is1-ssl.mzstatic.com/image/thumb/Purple112/v4/64/9d/21/649d21e8-a151-6136-3914-256e54f15d9a/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/1200x630wa.png',
    'settings': 'https://i.postimg.cc/hvFpZYjJ/IMG-7283.jpg',
    'records': 'https://i.postimg.cc/fyXNLqYL/IMG-7284.jpg',
    'ephone': 'https://i.postimg.cc/pXj9h20L/IMG-7275.jpg'
  };

  let repostTargetId = null;
  const STICKER_REGEX = /(^https:\/\/i\.postimg\.cc\/.+|^https:\/\/files\.catbox\.moe\/.+|^https?:\/\/sharkpan\.xyz\/.+|^data:image|\.(png|jpg|jpeg|gif|webp)\?.*$|\.(png|jpg|jpeg|gif|webp)$)/i;

  let currentRenderedCount = 0;
  let lastKnownBatteryLevel = 1;
  let alertFlags = {
    hasShown40: false,
    hasShown20: false,
    hasShown10: false
  };
  let batteryAlertTimeout;
  const dynamicFontStyle = document.createElement('style');
  dynamicFontStyle.id = 'dynamic-font-style';
  document.head.appendChild(dynamicFontStyle);

  const modalOverlay = document.getElementById('custom-modal-overlay');
  const modalTitle = document.getElementById('custom-modal-title');
  const modalBody = document.getElementById('custom-modal-body');
  const modalConfirmBtn = document.getElementById('custom-modal-confirm');
  const modalCancelBtn = document.getElementById('custom-modal-cancel');
  let modalResolve;

  function showCustomModal() {
    modalOverlay.classList.add('visible');
  }

  function hideCustomModal() {
    modalOverlay.classList.remove('visible');
    modalConfirmBtn.classList.remove('btn-danger');
    if (modalResolve) modalResolve(null);
  }

  function applyLyricsBarPosition(chat) {
    const lyricsBar = document.getElementById('global-lyrics-bar');

    const settings = chat.settings.lyricsPosition || {
      vertical: 'top',
      horizontal: 'center',
      offset: 10
    };


    lyricsBar.style.top = 'auto';
    lyricsBar.style.bottom = 'auto';
    lyricsBar.style.left = 'auto';
    lyricsBar.style.right = 'auto';
    lyricsBar.style.transform = 'none';


    if (settings.vertical === 'top') {
      lyricsBar.style.top = `${settings.offset}px`;
    } else {
      lyricsBar.style.bottom = `${settings.offset}px`;
    }


    switch (settings.horizontal) {
      case 'left':
        lyricsBar.style.left = '15px';
        break;
      case 'right':
        lyricsBar.style.right = '15px';
        break;
      case 'center':
      default:
        lyricsBar.style.left = '50%';
        lyricsBar.style.transform = 'translateX(-50%)';
        break;
    }
  }




  async function handleLocalGroupAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    let base64Url = await new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });

    // [Â∑≤Âà†Èô§] AIÂëΩÂêçÊèêÁ§∫
    // await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAI‰∏∫Êñ∞Áæ§Â§¥ÂÉèÂëΩÂêç...");

    try {
      // [‰øÆÊîπ] Â∞ÜAIÂëΩÂêçÊîπ‰∏∫ÊâãÂä®ËæìÂÖ•
      // const description = await getAvatarDescriptionFromApi(base64Url);
      const description = await showCustomPrompt("ÂëΩÂêçÁæ§Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Êñ∞Áæ§Â§¥ÂÉèÂëΩÂêç");

      // [‰øÆÊîπ] Ê£ÄÊü•ÊòØÂê¶ËæìÂÖ•‰∫ÜÂêçÁß∞
      // if (!description) {
      //   throw new Error("AIÊú™ËÉΩÊàêÂäüÊèèËø∞ÂõæÁâá„ÄÇ");
      // }
      if (!description || !description.trim()) {
        await showCustomAlert("Êìç‰ΩúÂèñÊ∂à", "‰Ω†Ê≤°ÊúâËæìÂÖ•ÂêçÁß∞ÔºåÂ∑≤ÂèñÊ∂à‰∏ä‰º†„ÄÇ");
        event.target.value = null; // Ê∏ÖÁ©∫ input
        return;
      }

      const chat = state.chats[state.activeChatId];
      if (!chat.settings.groupAvatarLibrary) {
        chat.settings.groupAvatarLibrary = [];
      }

      const newItem = {
        name: description, // ‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑÂêçÁß∞
        url: base64Url
      };
      chat.settings.groupAvatarLibrary.push(newItem);
      await db.chats.put(chat);

      renderGroupAvatarLibrary();

      // [‰øÆÊîπ] Êõ¥ÊîπÊàêÂäüÊèêÁ§∫
      // await showCustomAlert("‰∏ä‰º†ÊàêÂäüÔºÅ", `AIÂ∑≤Â∞ÜÊñ∞Áæ§Â§¥ÂÉèÂëΩÂêç‰∏∫Ôºö‚Äú${description}‚Äù\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);
      await showCustomAlert("‰∏ä‰º†ÊàêÂäüÔºÅ", `Áæ§Â§¥ÂÉèÂ∑≤ÂëΩÂêç‰∏∫Ôºö‚Äú${description}‚Äù\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);

      // „Äê„Äê„ÄêÂ∑≤‰øÆÂ§çÁöÑË∞ÉÁî®„Äë„Äë„Äë
      (async () => {
        await silentlyUpdateDbUrl(
          db.chats, // table
          chat.id,  // recordId
          'settings.groupAvatarLibrary', // pathString (ÊåáÂêëÊï∞ÁªÑ)
          base64Url, // base64ToFind
          description // [‰øÆÊîπ] ‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑÂêçÁß∞
        );
      })();

    } catch (error) {
      // [‰øÆÊîπ] Êõ¥ÊîπÂ§±Ë¥•ÊèêÁ§∫
      console.error("Êú¨Âú∞Áæ§Â§¥ÂÉè‰∏ä‰º†ÂèäËØÜÂà´Â§±Ë¥•:", error);
      // await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `Êó†Ê≥ï‰∏∫Â§¥ÂÉèÂëΩÂêçÔºåËØ∑Ê£ÄÊü•Ôºà‰∏ª/ÂâØÔºâAPIÈÖçÁΩÆÊòØÂê¶Ê≠£Á°ÆÂπ∂ÊîØÊåÅVision„ÄÇ\nÈîôËØØ: ${error.message}`);
      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `‰∏ä‰º†Êó∂ÂèëÁîüÈîôËØØ„ÄÇ\nÈîôËØØ: ${error.message}`);
    } finally {
      event.target.value = null;
    }
  }



  async function handleLocalAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    let base64Url = await new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });

    // [Â∑≤Âà†Èô§] AIÂëΩÂêçÊèêÁ§∫
    // await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAI‰∏∫Êñ∞Â§¥ÂÉèÂëΩÂêç...");

    try {
      // [‰øÆÊîπ] Â∞ÜAIÂëΩÂêçÊîπ‰∏∫ÊâãÂä®ËæìÂÖ•
      // const description = await getAvatarDescriptionFromApi(base64Url);
      const description = await showCustomPrompt("ÂëΩÂêçÂ§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Êñ∞Â§¥ÂÉèÂëΩÂêç");

      // [‰øÆÊîπ] Ê£ÄÊü•ÊòØÂê¶ËæìÂÖ•‰∫ÜÂêçÁß∞
      // if (!description) {
      //   throw new Error("AIÊú™ËÉΩÊàêÂäüÊèèËø∞ÂõæÁâá„ÄÇ");
      // }
      if (!description || !description.trim()) {
        await showCustomAlert("Êìç‰ΩúÂèñÊ∂à", "‰Ω†Ê≤°ÊúâËæìÂÖ•ÂêçÁß∞ÔºåÂ∑≤ÂèñÊ∂à‰∏ä‰º†„ÄÇ");
        event.target.value = null; // Ê∏ÖÁ©∫ input
        return;
      }

      const chat = state.chats[state.activeChatId];
      if (!chat.settings.aiAvatarLibrary) {
        chat.settings.aiAvatarLibrary = [];
      }

      const newItem = {
        name: description, // ‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑÂêçÁß∞
        url: base64Url
      };
      chat.settings.aiAvatarLibrary.push(newItem);
      await db.chats.put(chat);

      renderAiAvatarLibrary();

      // [‰øÆÊîπ] Êõ¥ÊîπÊàêÂäüÊèêÁ§∫
      // await showCustomAlert("‰∏ä‰º†ÊàêÂäüÔºÅ", `AIÂ∑≤Â∞ÜÊñ∞Â§¥ÂÉèÂëΩÂêç‰∏∫Ôºö‚Äú${description}‚Äù\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);
      await showCustomAlert("‰∏ä‰º†ÊàêÂäüÔºÅ", `Â§¥ÂÉèÂ∑≤ÂëΩÂêç‰∏∫Ôºö‚Äú${description}‚Äù\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);

      // „Äê„Äê„ÄêÂ∑≤‰øÆÂ§çÁöÑË∞ÉÁî®„Äë„Äë„Äë
      (async () => {
        await silentlyUpdateDbUrl(
          db.chats, // table
          chat.id,  // recordId
          'settings.aiAvatarLibrary', // pathString (ÊåáÂêëÊï∞ÁªÑ)
          base64Url, // base64ToFind
          description // [‰øÆÊîπ] ‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑÂêçÁß∞
        );
      })();

    } catch (error) {
      // [‰øÆÊîπ] Êõ¥ÊîπÂ§±Ë¥•ÊèêÁ§∫
      console.error("Êú¨Âú∞Â§¥ÂÉè‰∏ä‰º†ÂèäËØÜÂà´Â§±Ë¥•:", error);
      // await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `Êó†Ê≥ï‰∏∫Â§¥ÂÉèÂëΩÂêçÔºåËØ∑Ê£ÄÊü•Ôºà‰∏ª/ÂâØÔºâAPIÈÖçÁΩÆÊòØÂê¶Ê≠£Á°ÆÂπ∂ÊîØÊåÅVision„ÄÇ\nÈîôËØØ: ${error.message}`);
      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `‰∏ä‰º†Êó∂ÂèëÁîüÈîôËØØ„ÄÇ\nÈîôËØØ: ${error.message}`);
    } finally {
      event.target.value = null;
    }
  }


  async function getAvatarDescriptionFromApi(base64Url) {

    const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
    const {
      proxyUrl,
      apiKey,
      model
    } = useSecondaryApi
        ?
        {
          proxyUrl: state.apiConfig.secondaryProxyUrl,
          apiKey: state.apiConfig.secondaryApiKey,
          model: state.apiConfig.secondaryModel
        } :
        state.apiConfig;

    if (!proxyUrl || !apiKey || !model) {
      throw new Error("‰∏ªAPIÂíåÂâØAPIÂùáÊú™ÈÖçÁΩÆÊàñÈÖçÁΩÆ‰∏çÂÆåÊï¥„ÄÇ");
    }

    const prompt = "ËØ∑‰∏∫ËøôÂº†ÂõæÁâáËµ∑‰∏Ä‰∏™ÁÆÄÊ¥ÅÁöÑ„ÄÅÈÄÇÂêà‰Ωú‰∏∫Â§¥ÂÉèÂ∫ìÊ†áÁ≠æÁöÑÂêçÂ≠ó„ÄÇ‰æãÂ¶ÇÔºö‚ÄúÂæÆÁ¨ëËá™Êãç‚Äù„ÄÅ‚ÄúÈò≥ÂÖâ‰∏ãÁöÑÁå´Âí™‚Äù„ÄÅ‚ÄúËìùÂèëÂä®Êº´Â∞ëÂ•≥‚Äù„ÄÇËØ∑Áõ¥Êé•ÂõûÁ≠îÂêçÂ≠óÔºå‰∏çË¶ÅÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑËß£Èáä„ÄÇ";

    let isGemini = proxyUrl.includes('generativelanguage');
    let response;

    if (isGemini) {
      const mimeType = base64Url.match(/^data:(.*);base64/)[1];
      const base64Data = base64Url.split(',')[1];
      const payload = {
        contents: [{
          parts: [{
            text: prompt
          },
          {
            inline_data: {
              mime_type: mimeType,
              data: base64Data
            }
          }
          ]
        }]
      };
      response = await fetch(`${proxyUrl}/${model}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

    } else {
      const payload = {
        model: model,
        messages: [{
          role: 'user',
          content: [{
            type: 'text',
            text: prompt
          },
          {
            type: 'image_url',
            image_url: {
              url: base64Url
            }
          }
          ]
        }],
        max_tokens: 50
      };
      response = await fetch(`${proxyUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify(payload)
      });
    }

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`API ÈîôËØØ: ${errorData.error.message}`);
    }

    const data = await response.json();
    let description = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;


    return description.trim().replace(/["'‚Äú‚Äù‚Äò‚Äô]/g, '');
  }


  async function syncCharacterNameInGroups(characterChat) {

    if (!characterChat || characterChat.isGroup) {
      console.warn("syncCharacterNameInGroups: ‰º†ÂÖ•ÁöÑ‰∏çÊòØÊúâÊïàÁöÑÂçïËÅäÂØπË±°ÔºåÂ∑≤Ë∑≥ËøáÂêåÊ≠•„ÄÇ");
      return;
    }

    const characterId = characterChat.id;
    const newRemarkName = characterChat.name;
    const newOriginalName = characterChat.originalName;

    console.log(`Ê≠£Âú®‰∏∫ËßíËâ≤ ${characterId} ÂêåÊ≠•ÊâÄÊúâÁæ§ËÅäÂÜÖÁöÑÂêçÁß∞‰ø°ÊÅØ...`);


    for (const chatId in state.chats) {
      const groupChat = state.chats[chatId];


      if (groupChat.isGroup && groupChat.members) {

        const memberToUpdate = groupChat.members.find(m => m.id === characterId);


        if (memberToUpdate) {
          let needsDbUpdate = false;


          if (memberToUpdate.groupNickname !== newRemarkName) {
            memberToUpdate.groupNickname = newRemarkName;
            needsDbUpdate = true;
          }


          if (memberToUpdate.originalName !== newOriginalName) {
            memberToUpdate.originalName = newOriginalName;
            needsDbUpdate = true;
          }


          if (needsDbUpdate) {
            await db.chats.put(groupChat);
            console.log(`ÊàêÂäüÂ∞ÜÁæ§ËÅä "${groupChat.name}" ‰∏≠ÁöÑÊàêÂëò‰ø°ÊÅØÊõ¥Êñ∞`);
          }
        }
      }
    }
  }






  async function syncCharacterAvatarInGroups(characterChat) {

    if (!characterChat || characterChat.isGroup) {
      console.warn("syncCharacterAvatarInGroups: ‰º†ÂÖ•ÁöÑ‰∏çÊòØÊúâÊïàÁöÑÂçïËÅäÂØπË±°ÔºåÂ∑≤Ë∑≥ËøáÂêåÊ≠•„ÄÇ");
      return;
    }

    const characterId = characterChat.id;
    const newAvatar = characterChat.settings.aiAvatar;

    console.log(`Ê≠£Âú®‰∏∫ËßíËâ≤ ${characterId} ÂêåÊ≠•ÊâÄÊúâÁæ§ËÅäÂÜÖÁöÑÂ§¥ÂÉè...`);


    for (const groupChat of Object.values(state.chats)) {
      if (groupChat.isGroup && groupChat.members) {

        const memberToUpdate = groupChat.members.find(m => m.id === characterId);


        if (memberToUpdate && memberToUpdate.avatar !== newAvatar) {
          memberToUpdate.avatar = newAvatar;


          await db.chats.put(groupChat);
          console.log(`ÊàêÂäüÂ∞ÜËßíËâ≤ ${characterId} ÁöÑÊñ∞Â§¥ÂÉèÂêåÊ≠•Âà∞Áæ§ËÅä "${groupChat.name}"`);
        }
      }
    }
  }



  function getDisplayNameInGroup(groupChat, originalName) {

    if (!groupChat || !groupChat.isGroup || !originalName) {
      return originalName;
    }





    const userOriginalName = state.qzoneSettings.nickname || '{{user}}';
    if (originalName === userOriginalName) {

      return groupChat.settings.myNickname || 'Êàë';
    }


    const member = groupChat.members.find(m => m.originalName === originalName);


    return member ? member.groupNickname : originalName;
  }




  function switchRuleCategory(categoryId) {

    document.querySelectorAll('.rules-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
    });

    document.querySelectorAll('.rules-category-pane').forEach(pane => {
      pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
    });
  }






  function getDisplayNameByOriginalName(nameIdentifier) {

    if (!nameIdentifier) return '';


    if (state.qzoneSettings && nameIdentifier === state.qzoneSettings.nickname) {
      return state.qzoneSettings.nickname;
    }



    let characterChat = Object.values(state.chats).find(chat => !chat.isGroup && chat.originalName === nameIdentifier);
    if (characterChat) {
      return characterChat.name;
    }


    characterChat = Object.values(state.chats).find(chat =>
      !chat.isGroup &&
      (chat.nameHistory && chat.nameHistory.includes(nameIdentifier))
    );
    if (characterChat) {
      return characterChat.name;
    }



    return nameIdentifier;
  }





  function processMentions(text, chat = null) {

    if (!text || typeof text !== 'string' || !text.includes('@[[')) {
      return text;
    }


    return text.replace(/@\[\[([^\]]+)\]\]/g, (match, originalName) => {
      const trimmedOriginalName = originalName.trim();
      let displayName;


      if (chat && chat.isGroup) {


        displayName = getDisplayNameInGroup(chat, trimmedOriginalName);
      } else {

        displayName = getDisplayNameByOriginalName(trimmedOriginalName);
      }


      return `@${displayName}`;
    });
  }




  function showCustomConfirm(title, message, options = {}) {
    return new Promise(resolve => {
      modalResolve = resolve;
      modalTitle.textContent = title;
      modalBody.innerHTML = `<p>${message}</p>`;

      // --- „Äê‰øÆÂ§çÂºÄÂßã„ÄëÔºöÂº∫Âà∂ÈáçÁΩÆ Footer ÁªìÊûÑ ---
      // Âõ†‰∏∫ showChoiceModalÂèØËÉΩ‰ºöÁ†¥ÂùèFooterÁªìÊûÑÂØºËá¥ID‰∏¢Â§±ÔºåËøôÈáåÂøÖÈ°ªÈáçÂª∫
      const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');
      if (modalFooter) {
        modalFooter.style.flexDirection = 'row'; // ÊÅ¢Â§çÊ®™ÂêëÂ∏ÉÂ±Ä
        modalFooter.style.justifyContent = 'flex-end'; // ÊåâÈíÆÈù†Âè≥
        modalFooter.innerHTML = `
              <button id="custom-modal-cancel">ÂèñÊ∂à</button>
              <button id="custom-modal-confirm" class="confirm-btn">Á°ÆÂÆö</button>
          `;
      }
      // --- „Äê‰øÆÂ§çÁªìÊùü„Äë ---

      const confirmBtn = document.getElementById('custom-modal-confirm');
      const cancelBtn = document.getElementById('custom-modal-cancel');

      // Ê≠§Êó∂ cancelBtn ÂøÖÂÆöÂ≠òÂú®
      cancelBtn.style.display = 'block';

      confirmBtn.textContent = options.confirmText || 'Á°ÆÂÆö';
      cancelBtn.textContent = options.cancelText || 'ÂèñÊ∂à';

      if (options.confirmButtonClass) {
        confirmBtn.className = `confirm-btn ${options.confirmButtonClass}`; // ÈáçÁΩÆclassÂπ∂Ê∑ªÂä†Ëá™ÂÆö‰πâclass
      } else {
        confirmBtn.className = 'confirm-btn'; // ÊÅ¢Â§çÈªòËÆ§
      }

      confirmBtn.onclick = () => {
        resolve(true);
        hideCustomModal();
      };
      cancelBtn.onclick = () => {
        resolve(false);
        hideCustomModal();
      };
      showCustomModal();
    });
  }


  function showDownloadToast(message = 'üì• ÂõæÁâá‰∏ãËΩΩ‰∏≠...', type = 'success') {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : '#f44336'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 14px;
        pointer-events: none;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    }, 10);

    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 2000);
  }

  function generateFilenameForNai(prompt) {
    let cleanTitle = (prompt || 'NAI_Image')
      .replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g, '_')
      .replace(/\s+/g, '_')
      .substring(0, 30);

    const timestamp = new Date().toISOString()
      .replace(/[-:]/g, '')
      .replace('T', '_')
      .split('.')[0];

    return `${cleanTitle}_${timestamp}.png`;
  }


  function downloadNaiImage(imageSrc, prompt) {
    try {
      const filename = generateFilenameForNai(prompt);
      const link = document.createElement('a');
      link.href = imageSrc;
      link.download = filename;
      link.style.display = 'none';

      document.body.appendChild(link);
      link.click();

      setTimeout(() => {
        document.body.removeChild(link);
      }, 100);

      showDownloadToast('üì• ÂõæÁâá‰∏ãËΩΩ‰∏≠...');
    } catch (error) {
      console.error('‚ùå [NAI‰∏ãËΩΩ] ‰∏ãËΩΩÂ§±Ë¥•:', error);
      showDownloadToast('‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
    }
  }
  // --- Êñ∞Â¢ûÔºöÈ´òÁ´ØÈùû‰æµÂÖ•ÂºèÈÄöÁü• ---
  function showToast(message, type = 'info', duration = 3000) {
    let container = document.querySelector('.toast-container');
    if (!container) {
      container = document.createElement('div');
      container.className = 'toast-container';
      document.body.appendChild(container);
    }

    // ÂÆö‰πâÂõæÊ†á (SVG)
    const icons = {
      success: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
      loading: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg>`,
      error: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`,
      info: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`
    };

    const iconSvg = icons[type] || icons.info;
    const spinClass = type === 'loading' ? 'spinning' : '';

    // Êô∫ËÉΩÊà™Êñ≠ËøáÈïøÁöÑÊ∂àÊÅØ
    const displayMsg = message.length > 25 ? message.substring(0, 24) + '...' : message;

    const toast = document.createElement('div');
    toast.className = 'toast-item';
    toast.innerHTML = `
        <div class="toast-icon ${spinClass}">${iconSvg}</div>
        <span>${displayMsg}</span>
    `;

    container.appendChild(toast);

    // Âä®ÁîªÂÖ•Âú∫
    requestAnimationFrame(() => {
      toast.classList.add('visible');
    });

    // Ëá™Âä®Ê∂àÂ§± (Â¶ÇÊûúÊòØ loading Á±ªÂûãÔºåÂàô‰∏çËá™Âä®Ê∂àÂ§±ÔºåÈúÄË¶ÅÂ§ñÈÉ®ÁßªÈô§ÈÄªËæëÔºåÊàñËÄÖÁÆÄÂçïÁÇπËÆæ‰∏™ÈïøÊó∂Èôê)
    if (type !== 'loading') {
      setTimeout(() => {
        toast.classList.remove('visible');
        setTimeout(() => toast.remove(), 400); // Á≠âÂæÖËøáÊ∏°ÁªìÊùü
      }, duration);
    }

    return toast; // ËøîÂõûÂÖÉÁ¥†‰ª•‰æøÊâãÂä®ÁßªÈô§
  }
  window.showCustomAlert = showCustomAlert; // ÂØºÂá∫Âà∞ÂÖ®Â±ÄÔºå‰æõÂ§ñÈÉ®Ê®°ÂùóË∞ÉÁî®
  function showCustomAlert(title, message) {
    return new Promise(resolve => {
      modalResolve = resolve;
      modalTitle.textContent = title;
      modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;

      // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÂºÄÂßã„Äë ---
      // Ëé∑Âèñ Footer ÂÆπÂô®
      const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');

      // Âº∫Âà∂ÈáçÁΩÆ Footer ÁªìÊûÑÔºåÈò≤Ê≠¢Ë¢´ showChoiceModal ‰øÆÊîπÂêéÂØºËá¥ ID ‰∏¢Â§±
      if (modalFooter) {
        modalFooter.style.flexDirection = 'row'; // ÊÅ¢Â§çÈªòËÆ§Ê®™ÂêëÂ∏ÉÂ±Ä
        modalFooter.innerHTML = `
              <button id="custom-modal-cancel">ÂèñÊ∂à</button>
              <button id="custom-modal-confirm" class="confirm-btn">Á°ÆÂÆö</button>
          `;
      }
      // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÁªìÊùü„Äë ---

      const confirmBtn = document.getElementById('custom-modal-confirm');
      const cancelBtn = document.getElementById('custom-modal-cancel');

      // Ê≠§Êó∂ confirmBtn Âíå cancelBtn ÂøÖÂÆöÂ≠òÂú®
      if (cancelBtn) cancelBtn.style.display = 'none';
      if (confirmBtn) confirmBtn.textContent = 'Â•ΩÁöÑ';

      if (confirmBtn) {
        confirmBtn.onclick = () => {
          if (cancelBtn) cancelBtn.style.display = 'block'; // ÊÅ¢Â§çÊòæÁ§∫Ôºå‰ª•ÂÖçÂΩ±ÂìçÂÖ∂‰ªñÂäüËÉΩ
          confirmBtn.textContent = 'Á°ÆÂÆö';
          resolve(true);
          hideCustomModal();
        };
      }

      if (cancelBtn) {
        cancelBtn.onclick = hideCustomModal;
      }

      showCustomModal();
    });
  }


  async function copyTextToClipboard(textToCopy, successMessage = 'ÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ') {
    if (!textToCopy) {
      await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Ê≤°ÊúâÂèØÂ§çÂà∂ÁöÑÂÜÖÂÆπ„ÄÇ');
      return;
    }
    try {
      await navigator.clipboard.writeText(textToCopy);
      await showCustomAlert('Â§çÂà∂ÊàêÂäü', successMessage);
    } catch (err) {
      console.error('Â§çÂà∂Â§±Ë¥•:', err);
      await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
    }
  }

  // Êü•Êâæ function showCustomPrompt Âπ∂ÂÆåÂÖ®ÊõøÊç¢‰∏∫‰ª•‰∏ãÂÜÖÂÆπÔºö

  function showCustomPrompt(title, message, initialValue = '', type = 'text', extraHtml = '') {
    return new Promise(resolve => {
      modalResolve = resolve;
      modalTitle.textContent = title;
      const inputId = 'custom-prompt-input';

      // Ê∑ªÂä†Ê∂àÊÅØÊòæÁ§∫Âå∫Âüü
      const messageHtml = message ? `<div style="margin-bottom: 15px; color: #333; line-height: 1.6;">${message}</div>` : '';

      const inputHtml = type === 'textarea' ?
        `<textarea id="${inputId}" placeholder="" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>` :
        `<input type="${type}" id="${inputId}" placeholder="" value="${initialValue}">`;

      modalBody.innerHTML = messageHtml + extraHtml + inputHtml;
      const input = document.getElementById(inputId);

      // ÁªëÂÆöÈ¢ùÂ§ñÁöÑÊ†ºÂºèÂåñÊåâÈíÆ‰∫ã‰ª∂ÔºàÂ¶ÇÊûúÊúâÔºâ
      modalBody.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const templateStr = btn.dataset.template;
          if (templateStr) {
            try {
              const templateObj = JSON.parse(templateStr);
              input.value = JSON.stringify(templateObj, null, 2);
              input.focus();
            } catch (e) {
              console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e);
            }
          }
        });
      });

      // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÂºÄÂßã„ÄëÔºöÂº∫Âà∂ÈáçÂª∫ Footer ÁªìÊûÑ ---
      // Èò≤Ê≠¢Âõ†‰∏∫‰πãÂâçË∞ÉÁî®Ëøá showChoiceModal ÂØºËá¥ÊåâÈíÆ‰∏¢Â§±
      const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');
      if (modalFooter) {
        modalFooter.style.flexDirection = 'row';
        modalFooter.style.justifyContent = 'flex-end';
        modalFooter.style.maxHeight = '';
        modalFooter.style.overflowY = '';

        // Êö¥ÂäõÈáçÁΩÆÔºöÊääÊåâÈíÆÂ°ûÂõûÂéª
        modalFooter.innerHTML = `
            <button id="custom-modal-cancel">ÂèñÊ∂à</button>
            <button id="custom-modal-confirm" class="confirm-btn">Á°ÆÂÆö</button>
          `;
      }
      // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÁªìÊùü„Äë ---

      const confirmBtn = document.getElementById('custom-modal-confirm');
      const cancelBtn = document.getElementById('custom-modal-cancel');

      // Á°Æ‰øùÊåâÈíÆÂ≠òÂú®ÂêéÂÜçÊìç‰Ωú
      if (confirmBtn) {
        confirmBtn.textContent = 'Á°ÆÂÆö'; // ÈáçÁΩÆÂèØËÉΩË¢´‰øÆÊîπÁöÑÊñáÂ≠ó
        confirmBtn.className = 'confirm-btn'; // ÈáçÁΩÆÂèØËÉΩË¢´‰øÆÊîπÁöÑÊ†∑Âºè
        confirmBtn.style.display = 'block';

        confirmBtn.onclick = () => {
          resolve(input.value);
          hideCustomModal();
        };
      }

      if (cancelBtn) {
        cancelBtn.textContent = 'ÂèñÊ∂à';
        cancelBtn.style.display = 'block';

        cancelBtn.onclick = () => {
          resolve(null);
          hideCustomModal();
        };
      }

      showCustomModal();

      // Âä†‰∏™ÂÆâÂÖ®Âà§Êñ≠Èò≤Ê≠¢ input ‰∏∫Á©∫
      setTimeout(() => {
        if (input) input.focus();
      }, 100);
    });
  }





  // Â¢ûÂº∫Áâà showChoiceModalÔºö‰ºòÂåñÊªëÂä®‰ΩìÈ™å
  function showChoiceModal(title, options) {
    return new Promise(resolve => {
      const modal = document.getElementById('custom-modal-overlay');
      const modalTitle = document.getElementById('custom-modal-title');
      const modalBody = document.getElementById('custom-modal-body');
      const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');

      modalTitle.textContent = title;
      modalBody.innerHTML = ''; // Ê∏ÖÁ©∫‰∏ª‰ΩìÔºåÈÄâÈ°π‰∏ªË¶ÅÂú® Footer

      // Ê∏ÖÁ©∫ Footer Âπ∂ËÆæÁΩÆ‰∏∫ÂàóÂ∏ÉÂ±Ä
      modalFooter.innerHTML = '';
      modalFooter.style.flexDirection = 'column';

      // --- „ÄêÊ†∏ÂøÉ‰ºòÂåñÔºöÊªëÂä®ËÆæÁΩÆ„Äë ---
      modalFooter.style.maxHeight = '50vh'; // ÈôêÂà∂È´òÂ∫¶ÔºåÁïôÂá∫Á©∫Èó¥
      modalFooter.style.overflowY = 'auto'; // ÂÖÅËÆ∏ÂûÇÁõ¥ÊªöÂä®
      modalFooter.style.webkitOverflowScrolling = 'touch'; // iOS ÊµÅÁïÖÊªöÂä®
      modalFooter.style.overscrollBehavior = 'contain'; // Èò≤Ê≠¢ÊªöÂä®Á©øÈÄèÂà∞Â∫ïÂ±Ç
      modalFooter.style.padding = '10px'; // Â¢ûÂä†ÂÜÖËæπË∑ù
      modalFooter.style.gap = '8px'; // ÊåâÈíÆÈó¥Ë∑ù
      // ---------------------------

      // --- ÂàÜÈ°µÈÄªËæëÂºÄÂßã ---
      let renderedCount = 0;
      const PAGE_SIZE = 10; // ÊØèÊ¨°Âä†ËΩΩ10‰∏™

      // ÂàõÂª∫‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆ
      const loadMoreBtn = document.createElement('button');
      loadMoreBtn.textContent = 'Âä†ËΩΩÊõ¥Â§ö...';
      loadMoreBtn.style.cssText = 'background-color: #f0f0f0; color: #666; margin-top: 8px; width: 100%; border-radius: 8px; padding: 10px; border: none;';
      loadMoreBtn.style.display = 'none'; // ÂàùÂßãÈöêËóè

      // Ê∏≤ÊüìÂáΩÊï∞
      const renderBatch = () => {
        const nextBatch = options.slice(renderedCount, renderedCount + PAGE_SIZE);

        nextBatch.forEach(option => {
          const button = document.createElement('button');

          // ÂÖÅËÆ∏Ê∏≤Êüì HTML ÂÜÖÂÆπ
          button.innerHTML = option.text;

          // Ê∑ªÂä†ÁæéÂåñÁ±ªÂêçÂíåÊ†∑Âºè
          button.className = 'payment-option-item';
          button.style.width = '100%';
          button.style.textAlign = 'left';
          button.style.padding = '12px 15px';
          button.style.marginBottom = '0'; // Áî±Áà∂ÂÆπÂô® gap ÊéßÂà∂

          button.onclick = () => {
            modal.classList.remove('visible');
            resolve(option.value);
          };
          // ÊèíÂÖ•Âà∞‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆ‰πãÂâç
          modalFooter.insertBefore(button, loadMoreBtn);
        });

        renderedCount += nextBatch.length;

        // Â¶ÇÊûúËøòÊúâÂâ©‰ΩôÈÄâÈ°πÔºåÊòæÁ§∫Âä†ËΩΩÊõ¥Â§öÊåâÈíÆÔºåÂê¶ÂàôÈöêËóè
        if (renderedCount < options.length) {
          loadMoreBtn.style.display = 'block';
          loadMoreBtn.textContent = `Âä†ËΩΩÊõ¥Â§ö (${options.length - renderedCount} ‰∏™Ââ©‰Ωô)`;
        } else {
          loadMoreBtn.style.display = 'none';
        }
      };

      // ÁªëÂÆöÂä†ËΩΩÊõ¥Â§ö‰∫ã‰ª∂
      loadMoreBtn.onclick = (e) => {
        e.stopPropagation();
        renderBatch();
      };

      // ÂÖàÊääÂä†ËΩΩÊõ¥Â§öÊåâÈíÆÊîæËøõÂéª
      modalFooter.appendChild(loadMoreBtn);

      // ÂàùÂßãÊ∏≤ÊüìÁ¨¨‰∏ÄÈ°µ
      renderBatch();
      // --- ÂàÜÈ°µÈÄªËæëÁªìÊùü ---

      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'ÂèñÊ∂à';
      cancelButton.style.marginTop = '15px';
      cancelButton.style.borderRadius = '8px';
      cancelButton.style.backgroundColor = '#fff';
      cancelButton.style.border = '1px solid #ddd';
      cancelButton.style.color = '#666';
      cancelButton.style.padding = '12px';
      cancelButton.style.width = '100%';

      cancelButton.onclick = () => {
        modal.classList.remove('visible');
        resolve(null);
      };
      modalFooter.appendChild(cancelButton);

      modal.classList.add('visible');

    }).finally(() => {
      // Promise ÁªìÊùüÂêéÁöÑÊ∏ÖÁêÜÂ∑•‰ΩúÔºàÂ¶ÇÊûúÊúâÔºâ
    });
  }




  // Â¢ûÂº∫ÁâàÂàÜÁ±ªÈÄâÊã©ÂºπÁ™óÔºöÊîØÊåÅËá™ÂÆö‰πâÂàÜÁ±ªÁöÑÊñ∞Âª∫„ÄÅÁºñËæë„ÄÅÂà†Èô§
  function showCategoryPickerModal(chat) {
    return new Promise(resolve => {
      const modal = document.getElementById('custom-modal-overlay');
      const modalTitle = document.getElementById('custom-modal-title');
      const modalBody = document.getElementById('custom-modal-body');
      const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');

      let resolved = false;
      const resetModalStyles = () => {
        modalBody.style.maxHeight = '';
        modalBody.style.overflowY = '';
        modalBody.style.webkitOverflowScrolling = '';
        modalBody.style.overscrollBehavior = '';
        modalBody.style.padding = '';
        modalFooter.style.flexDirection = '';
        modalFooter.style.maxHeight = '';
        modalFooter.style.overflowY = '';
        modalFooter.style.webkitOverflowScrolling = '';
        modalFooter.style.overscrollBehavior = '';
        modalFooter.style.padding = '';
        modalFooter.style.gap = '';
      };
      const safeResolve = (val) => {
        if (resolved) return;
        resolved = true;
        modal.classList.remove('visible');
        resetModalStyles();
        resolve(val);
      };

      const renderPicker = () => {
        const categories = window.structuredMemoryManager.getCategories(chat);
        const mgr = window.structuredMemoryManager;

        modalTitle.textContent = 'ÈÄâÊã©ÂàÜÁ±ª';

        // ÂàÜÁ±ªÂàóË°®Êîæ modalBodyÔºàÂèØÊªöÂä®Ôºâ
        modalBody.innerHTML = '';
        modalBody.style.maxHeight = '45vh';
        modalBody.style.overflowY = 'auto';
        modalBody.style.webkitOverflowScrolling = 'touch';
        modalBody.style.overscrollBehavior = 'contain';
        modalBody.style.padding = '10px';

        const listWrap = document.createElement('div');
        listWrap.style.cssText = 'display:flex; flex-direction:column; gap:6px;';

        // Ê∏≤ÊüìÊØè‰∏™ÂàÜÁ±ªÈÄâÈ°π
        Object.entries(categories).forEach(([code, cat]) => {
          const isCustom = !!(cat.isCustom);
          const row = document.createElement('div');
          row.style.cssText = 'display:flex; align-items:center; gap:6px; width:100%;';

          const btn = document.createElement('button');
          btn.className = 'payment-option-item';
          btn.style.cssText = 'flex:1; text-align:left; padding:12px 15px; margin:0; min-width:0;';
          btn.innerHTML = `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${cat.color || '#666'};margin-right:8px;"></span>${code} - ${cat.name}`;
          btn.onclick = () => safeResolve(code);
          row.appendChild(btn);

          if (isCustom) {
            const editBtn = document.createElement('button');
            editBtn.style.cssText = 'background:none; border:1px solid #ddd; border-radius:8px; padding:8px 10px; font-size:14px; cursor:pointer; flex-shrink:0;';
            editBtn.textContent = '‚úèÔ∏è';
            editBtn.title = 'ÁºñËæëÂàÜÁ±ª';
            editBtn.onclick = async (e) => {
              e.stopPropagation();
              modal.classList.remove('visible');
              resetModalStyles();
              const action = await showChoiceModal('ÁºñËæëÂàÜÁ±ª: ' + cat.name, [
                { text: '‚úèÔ∏è ÈáçÂëΩÂêç', value: 'rename' },
                { text: 'üé® ‰øÆÊîπÈ¢úËâ≤', value: 'color' },
                { text: 'üóëÔ∏è Âà†Èô§ÂàÜÁ±ª', value: 'delete' }
              ]);
              if (action === 'rename') {
                const newName = await showCustomPrompt('ÈáçÂëΩÂêçÂàÜÁ±ª', 'ËæìÂÖ•Êñ∞ÂêçÁß∞Ôºö', cat.name);
                if (newName && newName.trim()) {
                  mgr.renameCustomCategory(chat, code, newName.trim());
                  await db.chats.put(chat);
                  renderStructuredMemoryView();
                }
              } else if (action === 'color') {
                const colors = [
                  { text: 'üîµ ËìùËâ≤', value: '#007aff' },
                  { text: 'üü¢ ÁªøËâ≤', value: '#34c759' },
                  { text: 'üü† Ê©ôËâ≤', value: '#ff9500' },
                  { text: 'üü£ Á¥´Ëâ≤', value: '#5856d6' },
                  { text: 'üî¥ Á∫¢Ëâ≤', value: '#ff2d55' },
                  { text: 'ü©∑ Á≤âËâ≤', value: '#af52de' },
                  { text: 'üü§ Ê£ïËâ≤', value: '#a2845e' },
                  { text: '‚ö´ ÁÅ∞Ëâ≤', value: '#666666' }
                ];
                const newColor = await showChoiceModal('ÈÄâÊã©È¢úËâ≤', colors);
                if (newColor) {
                  mgr.recolorCustomCategory(chat, code, newColor);
                  await db.chats.put(chat);
                  renderStructuredMemoryView();
                }
              } else if (action === 'delete') {
                const mem = mgr.getStructuredMemory(chat);
                const itemCount = (mem._custom[code] || []).length;
                const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§ÂàÜÁ±ª',
                  `Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁ±ª"${cat.name}"ÂêóÔºü${itemCount > 0 ? `ÂÖ∂‰∏≠ÁöÑ ${itemCount} Êù°ËÆ∞ÂøÜ‰πü‰ºöË¢´Âà†Èô§„ÄÇ` : ''}Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`,
                  { confirmButtonClass: 'btn-danger', confirmText: 'Á°ÆËÆ§Âà†Èô§' }
                );
                if (confirmed) {
                  mgr.deleteCustomCategory(chat, code);
                  await db.chats.put(chat);
                  renderStructuredMemoryView();
                  showToast(`ÂàÜÁ±ª"${cat.name}"Â∑≤Âà†Èô§`, 'info');
                }
              }
              resolved = false;
              modal.classList.add('visible');
              renderPicker();
            };
            row.appendChild(editBtn);
          }

          listWrap.appendChild(row);
        });

        modalBody.appendChild(listWrap);

        // Â∫ïÈÉ®Âõ∫ÂÆöÂå∫ÂüüÔºöÊñ∞Âª∫ÂàÜÁ±ª + ÂèñÊ∂à
        modalFooter.innerHTML = '';
        modalFooter.style.flexDirection = 'column';
        modalFooter.style.padding = '10px';
        modalFooter.style.gap = '8px';
        modalFooter.style.maxHeight = '';
        modalFooter.style.overflowY = '';

        const addBtn = document.createElement('button');
        addBtn.className = 'payment-option-item';
        addBtn.style.cssText = 'width:100%; text-align:center; padding:12px 15px; margin:0; color:#007aff; font-weight:600;';
        addBtn.textContent = 'Ôºã Êñ∞Âª∫Ëá™ÂÆö‰πâÂàÜÁ±ª';
        addBtn.onclick = async (e) => {
          e.stopPropagation();
          modal.classList.remove('visible');
          resetModalStyles();

          const name = await showCustomPrompt('Êñ∞Âª∫Ëá™ÂÆö‰πâÂàÜÁ±ª', 'ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞ÔºàÂ¶ÇÔºöÁ∫¶‰ºöËÆ∞ÂΩï„ÄÅÂÖ±ÂêåÁà±Â•Ω„ÄÅÂêµÊû∂ËÆ∞ÂΩïÔºâ');
          if (!name || !name.trim()) {
            resolved = false;
            modal.classList.add('visible');
            renderPicker();
            return;
          }

          const existingCodes = Object.keys(window.structuredMemoryManager.getCategories(chat));
          let code = name.trim().substring(0, 2).toUpperCase();
          let suffix = 1;
          let finalCode = code;
          while (existingCodes.includes(finalCode)) {
            finalCode = code + suffix;
            suffix++;
          }

          mgr.addCustomCategory(chat, finalCode, name.trim());
          await db.chats.put(chat);
          renderStructuredMemoryView();
          showToast(`ÂàÜÁ±ª"${name.trim()}"Â∑≤ÂàõÂª∫`, 'success');

          resolved = false;
          modal.classList.add('visible');
          renderPicker();
        };
        modalFooter.appendChild(addBtn);

        const cancelBtn = document.createElement('button');
        cancelBtn.style.cssText = 'border-radius:8px; background:#fff; border:1px solid #ddd; color:#666; padding:12px; width:100%;';
        cancelBtn.textContent = 'ÂèñÊ∂à';
        cancelBtn.onclick = () => safeResolve(null);
        modalFooter.appendChild(cancelBtn);
      };

      renderPicker();
      modal.classList.add('visible');
    });
  }

  async function getLrcContent() {

    const choice = await showChoiceModal('ÈÄâÊã©Ê≠åËØçÂØºÂÖ•ÊñπÂºè', [{
      text: 'üìÅ ‰ªéÊú¨Âú∞Êñá‰ª∂ (.lrc)',
      value: 'file'
    },
    {
      text: 'üìã Áõ¥Êé•Á≤òË¥¥Ê≠åËØçÊñáÊú¨',
      value: 'paste'
    }
    ]);


    if (choice === 'file') {

      return new Promise(resolve => {
        const lrcInput = document.getElementById('lrc-upload-input');
        const lrcChangeHandler = (e) => {
          const lrcFile = e.target.files[0];
          if (lrcFile) {
            const reader = new FileReader();
            reader.onload = (readEvent) => resolve(readEvent.target.result);
            reader.onerror = () => resolve("");
            reader.readAsText(lrcFile);
          } else {
            resolve(null);
          }
          lrcInput.removeEventListener('change', lrcChangeHandler);
          lrcInput.value = '';
        };
        lrcInput.addEventListener('change', lrcChangeHandler, {
          once: true
        });
        lrcInput.click();
      });
    } else if (choice === 'paste') {

      const pastedText = await showCustomPrompt(
        'Á≤òË¥¥Ê≠åËØç',
        'ËØ∑Âú®Ê≠§Â§ÑÁ≤òË¥¥ÂÆåÊï¥ÁöÑLRCÊ†ºÂºèÊ≠åËØç...',
        '',
        'textarea'
      );


      if (pastedText) {


        const formattedText = pastedText.replace(/\[/g, '\n[').trim();
        return formattedText;
      }
      return pastedText;


    } else {

      return null;
    }
  }






  db.version(50).stores({
    doubanPosts: '++id, timestamp',
    chats: '&id, isGroup, groupId, isPinned, memos, diary, appUsageLog, lastIntelligentSummaryTimestamp',
    apiConfig: '&id, minimaxGroupId, minimaxApiKey',
    globalSettings: '&id',
    userStickers: '&id, url, name, categoryId',
    stickerVisionCache: '&url, description, timestamp',
    worldBooks: '&id, name, categoryId',
    worldBookCategories: '++id, name',
    musicLibrary: '&id',
    personaPresets: '&id',
    qzoneSettings: '&id',
    qzonePosts: '++id, timestamp, authorId',
    qzoneAlbums: '++id, name, createdAt',
    qzonePhotos: '++id, albumId',
    favorites: '++id, type, timestamp, originalTimestamp',
    qzoneGroups: '++id, name',
    memories: '++id, chatId, timestamp, type, targetDate',
    callRecords: '++id, chatId, timestamp, customName',
    shoppingProducts: '++id, name, description',
    shoppingCategories: '++id, name',
    apiPresets: '++id, name',
    renderingRules: '++id, name, chatId',
    appearancePresets: '++id, name, type',
    stickerCategories: '++id, name',
    customAvatarFrames: '++id, name',
    presets: '&id, name, categoryId',
    presetCategories: '++id, name',
    readingLibrary: '++id, title, lastOpened, linkedStoryId',
    quickReplies: '++id, text, categoryId', // ‰øÆÊîπÔºöÂ¢ûÂä† categoryId Á¥¢Âºï
  });

  // Âø´Êç∑ÂõûÂ§çÂàÜÁ±ªÁ≥ªÁªü - Êñ∞Â¢ûÊï∞ÊçÆË°®
  db.version(51).stores({
    quickReplyCategories: '++id, name',
    npcs: '++id, name, npcGroupId, enableBackgroundActivity, actionCooldownMinutes, lastActionTimestamp',
    npcGroups: '++id, name',
    naiPresets: '++id, name',
    grAuthors: '++id, name',
    grStories: '++id, title, authorId, lastUpdated',
    userWallet: '&id',
    userTransactions: '++id, timestamp, type, amount, description',
    funds: '&id, code, name, riskLevel, currentNav, lastDayNav, history',
    auctions: '++id, status, itemName, endTime', // ÊãçÂçñËÆ∞ÂΩï
    inventory: '++id, name, type, acquiredTime',
    emails: '++id, sender, senderType, recipient, subject, content, timestamp, isRead'
  }).upgrade(tx => {

    return tx.table('worldBooks').toCollection().modify(book => {

      if (typeof book.content === 'string' && book.content.trim() !== '') {
        book.content = [{
          keys: [],
          comment: '‰ªéÊóßÁâàÊú¨ËøÅÁßªÁöÑÊù°ÁõÆ',
          content: book.content
        }];
      }
    });
  });

  // ËßÇÂΩ±Êí≠ÊîæÂàóË°®
  db.version(52).stores({
    watchTogetherPlaylist: '++id, name, timestamp'
  });

  window.db = db;

  // ========================================
  // ÊµèËßàÂô®ÊåÅ‰πÖÂåñÂ≠òÂÇ®‰øùÊä§
  // Èò≤Ê≠¢ÊµèËßàÂô®Âú®Â≠òÂÇ®ÂéãÂäõ‰∏ãËá™Âä®Ê∏ÖÈô§Á´ôÁÇπÊï∞ÊçÆ
  // ========================================
  async function requestStoragePersistence() {
    try {
      if (navigator.storage && navigator.storage.persist) {
        const alreadyPersisted = await navigator.storage.persisted();
        if (alreadyPersisted) {
          console.log('‚úÖ Â≠òÂÇ®Â∑≤Â§Ñ‰∫éÊåÅ‰πÖÂåñ‰øùÊä§Áä∂ÊÄÅ');
          return true;
        }

        const granted = await navigator.storage.persist();
        if (granted) {
          console.log('‚úÖ ÊµèËßàÂô®Â∑≤Êéà‰∫àÊåÅ‰πÖÂåñÂ≠òÂÇ®ÊùÉÈôêÔºåÊï∞ÊçÆ‰∏ç‰ºöË¢´Ëá™Âä®Ê∏ÖÈô§');
        } else {
          console.warn('‚ö†Ô∏è ÊµèËßàÂô®ÊãíÁªù‰∫ÜÊåÅ‰πÖÂåñÂ≠òÂÇ®ËØ∑Ê±ÇÔºåÊï∞ÊçÆÂú®Â≠òÂÇ®ÂéãÂäõ‰∏ãÂèØËÉΩË¢´Ê∏ÖÈô§ÔºåÂª∫ËÆÆÂÆöÊúüÂ§á‰ªΩ');
        }
        return granted;
      } else {
        console.warn('‚ö†Ô∏è ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅ Storage Persistence API');
        return false;
      }
    } catch (error) {
      console.error('ËØ∑Ê±ÇÊåÅ‰πÖÂåñÂ≠òÂÇ®Â§±Ë¥•:', error);
      return false;
    }
  }

  // Êö¥Èú≤ÁªôÂÖ®Â±ÄÔºå‰æõËÆæÁΩÆÈ°µÈù¢Êü•ËØ¢Áä∂ÊÄÅ
  window.checkStoragePersistence = async function () {
    try {
      if (navigator.storage && navigator.storage.persisted) {
        return await navigator.storage.persisted();
      }
      return null; // ‰∏çÊîØÊåÅ
    } catch (e) {
      return null;
    }
  };

  window.getStorageEstimate = async function () {
    try {
      if (navigator.storage && navigator.storage.estimate) {
        const estimate = await navigator.storage.estimate();
        return {
          usage: estimate.usage,
          quota: estimate.quota,
          usagePercent: ((estimate.usage / estimate.quota) * 100).toFixed(2)
        };
      }
      return null;
    } catch (e) {
      return null;
    }
  };

  // Á°Æ‰øùÊï∞ÊçÆÂ∫ìÂÆåÂÖ®ÊâìÂºÄÂíåÂ∞±Áª™
  window.dbReady = false;
  window.dbReadyPromise = db.open().then(() => {
    console.log('Êï∞ÊçÆÂ∫ìÂ∑≤ÂÆåÂÖ®ÂàùÂßãÂåñÂπ∂ÊâìÂºÄ');
    console.log('Êï∞ÊçÆÂ∫ìË°®Áä∂ÊÄÅÊ£ÄÊü•:', {
      chats: !!db.chats,
      messages: !!db.messages,
      chatsType: typeof db.chats,
      messagesType: typeof db.messages
    });
    window.dbReady = true;
    // Ëß¶ÂèëËá™ÂÆö‰πâ‰∫ã‰ª∂ÈÄöÁü•Êï∞ÊçÆÂ∫ìÂ∑≤Â∞±Áª™
    window.dispatchEvent(new Event('dbready'));

    // ËØ∑Ê±ÇÊµèËßàÂô®ÊåÅ‰πÖÂåñÂ≠òÂÇ®ÔºåÈò≤Ê≠¢Ëá™Âä®Ê∏ÖÈô§ IndexedDB / localStorage Êï∞ÊçÆ
    requestStoragePersistence();

    return db;
  }).catch(err => {
    console.error('Êï∞ÊçÆÂ∫ìÊâìÂºÄÂ§±Ë¥•:', err);
    window.dbReady = false;
    throw err;
  });

  // ========================================
  // üõ°Ô∏è Â¢ûÂº∫Êï∞ÊçÆ‰øùÊä§Êú∫Âà∂
  // ========================================
  
  /**
   * Êìç‰ΩúÊó•ÂøóÁÆ°ÁêÜÂô®ÔºàOP LogÔºâ
   * Âè™‰øùÁïôÊúÄËøë 50 Êù°Êàñ 30 ÂàÜÈíüÂÜÖÁöÑÊìç‰ΩúÔºåÈò≤Ê≠¢Êï∞ÊçÆËÜ®ËÉÄ
   * ‰ºòÂåñÔºöÊâπÈáèÂºÇÊ≠•ÂÜôÂÖ•ÔºåÂáèÂ∞ëÊÄßËÉΩÂΩ±Âìç
   */
  const OperationLogger = {
    MAX_LOGS: 50, // ÊúÄÂ§ö‰øùÁïô 50 Êù°Êó•Âøó
    MAX_AGE_MS: 30 * 60 * 1000, // ÊúÄÂ§ö‰øùÁïô 30 ÂàÜÈíü
    STORAGE_KEY: 'ephone-operation-logs',
    _pendingLogs: [], // ÂæÖÂÜôÂÖ•ÁöÑÊó•ÂøóÁºìÂÜ≤Âå∫
    _flushTimer: null, // ÊâπÈáèÂÜôÂÖ•ÂÆöÊó∂Âô®
    _flushInterval: 3000, // ÊØè 3 ÁßíÊâπÈáèÂÜôÂÖ•‰∏ÄÊ¨°
    
    // ËÆ∞ÂΩïÊìç‰ΩúÔºàÂºÇÊ≠•ÊâπÈáèÔºâ
    log(operation, tableName, recordId, data) {
      try {
        // ÂÖàÂä†ÂÖ•ÁºìÂÜ≤Âå∫Ôºå‰∏çÁ´ãÂç≥ÂÜôÂÖ• localStorage
        this._pendingLogs.push({
          timestamp: Date.now(),
          operation, // 'add', 'update', 'delete'
          tableName,
          recordId,
          data: this._compress(data) // ÂéãÁº©Êï∞ÊçÆ
        });
        
        // Â¶ÇÊûúÁºìÂÜ≤Âå∫ËøáÂ§ßÔºåÁ´ãÂç≥Âà∑Êñ∞
        if (this._pendingLogs.length >= 10) {
          this._flushNow();
        } else {
          // Âê¶ÂàôÂª∂ËøüÊâπÈáèÂÜôÂÖ•
          this._scheduleFlush();
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Êìç‰ΩúÊó•ÂøóÁºìÂÜ≤Â§±Ë¥•:', error);
      }
    },
    
    // Ë∞ÉÂ∫¶ÊâπÈáèÂÜôÂÖ•
    _scheduleFlush() {
      if (this._flushTimer) return; // Â∑≤ÁªèÊúâÂÆöÊó∂Âô®‰∫Ü
      
      this._flushTimer = setTimeout(() => {
        this._flushNow();
      }, this._flushInterval);
    },
    
    // Á´ãÂç≥Âà∑Êñ∞Âà∞ localStorage
    _flushNow() {
      if (this._flushTimer) {
        clearTimeout(this._flushTimer);
        this._flushTimer = null;
      }
      
      if (this._pendingLogs.length === 0) return;
      
      try {
        // ËØªÂèñÁé∞ÊúâÊó•Âøó
        const existingLogs = this.getLogs();
        
        // ÂêàÂπ∂ÂæÖÂÜôÂÖ•ÁöÑÊó•Âøó
        existingLogs.push(...this._pendingLogs);
        
        // Ê∏ÖÁêÜÊóßÊó•Âøó
        this._cleanup(existingLogs);
        
        // ÊâπÈáèÂÜôÂÖ• localStorage
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(existingLogs));
        
        // Ê∏ÖÁ©∫ÁºìÂÜ≤Âå∫
        this._pendingLogs = [];
      } catch (error) {
        console.warn('‚ö†Ô∏è Êìç‰ΩúÊó•ÂøóÂÜôÂÖ•Â§±Ë¥•:', error);
        // Â¶ÇÊûú localStorage Êª°‰∫ÜÔºåÊ∏ÖÁ©∫ÊóßÊó•Âøó
        if (error.name === 'QuotaExceededError') {
          localStorage.removeItem(this.STORAGE_KEY);
          this._pendingLogs = [];
        }
      }
    },
    
    // Ëé∑ÂèñÊâÄÊúâÊó•Âøó
    getLogs() {
      try {
        const logsStr = localStorage.getItem(this.STORAGE_KEY);
        return logsStr ? JSON.parse(logsStr) : [];
      } catch {
        return [];
      }
    },
    
    // Ê∏ÖÁêÜÊóßÊó•Âøó
    _cleanup(logs) {
      const now = Date.now();
      // Âè™‰øùÁïôÊúÄËøëÁöÑÊó•Âøó
      let cleaned = logs.filter(log => (now - log.timestamp) < this.MAX_AGE_MS);
      // Â¶ÇÊûúËøòÊòØÂ§™Â§öÔºåÂè™‰øùÁïôÊúÄÊñ∞ÁöÑ
      if (cleaned.length > this.MAX_LOGS) {
        cleaned = cleaned.slice(-this.MAX_LOGS);
      }
      logs.length = 0;
      logs.push(...cleaned);
    },
    
    // ÁÆÄÂçïÂéãÁº©ÔºàÂè™‰øùÁïôÂÖ≥ÈîÆÂ≠óÊÆµÔºâ
    _compress(data) {
      if (!data || typeof data !== 'object') return data;
      
      // ÂØπ‰∫éÂ§ßÂØπË±°ÔºåÂè™‰øùÁïôÂÖ≥ÈîÆ‰ø°ÊÅØ
      if (JSON.stringify(data).length > 5000) {
        return {
          _compressed: true,
          id: data.id,
          timestamp: data.timestamp || Date.now(),
          _note: 'Êï∞ÊçÆËøáÂ§ßÔºåÂ∑≤ÁúÅÁï•ËØ¶ÁªÜÂÜÖÂÆπ'
        };
      }
      return data;
    },
    
    // Ê∏ÖÈô§ÊâÄÊúâÊó•Âøó
    clear() {
      localStorage.removeItem(this.STORAGE_KEY);
    }
  };
  
  window.OperationLogger = OperationLogger;
  
  /**
   * ÂèåÂÜôÊú∫Âà∂ÁÆ°ÁêÜÂô®
   * localStorage Âè™Â≠òÊúÄÊñ∞ÁöÑÂÖ≥ÈîÆÊï∞ÊçÆÂø´ÁÖßÔºàÂéãÁº©Ôºâ
   */
  const DualWriteManager = {
    SNAPSHOT_KEY: 'ephone-data-snapshot',
    LAST_SAVE_KEY: 'ephone-last-save-time',
    MAX_SNAPSHOT_SIZE: 2 * 1024 * 1024, // 2MB ÈôêÂà∂
    
    // ‰øùÂ≠òÂÖ≥ÈîÆÊï∞ÊçÆÂø´ÁÖß
    async saveSnapshot() {
      try {
        if (!db || !window.dbReady) return;
        
        // Âè™‰øùÂ≠òÊúÄÂÖ≥ÈîÆÁöÑÊï∞ÊçÆ
        const snapshot = {
          timestamp: Date.now(),
          version: 1,
          // Âè™‰øùÂ≠òÂÖ≥ÈîÆË°®ÁöÑÊëòË¶Å‰ø°ÊÅØ
          summary: {
            chatsCount: await db.chats?.count() || 0,
            qzonePostsCount: await db.qzonePosts?.count() || 0,
            npcsCount: await db.npcs?.count() || 0
          },
          // ‰øùÂ≠òÊúÄÂêé‰øÆÊîπÁöÑÂá†Êù°Êï∞ÊçÆÔºàÁî®‰∫éÊÅ¢Â§çÔºâ
          recentData: {
            lastChat: null,
            lastPost: null
          }
        };
        
        // Ëé∑ÂèñÊúÄÂêé‰∏ÄÊù°ËÅäÂ§©ËÆ∞ÂΩïÔºàÊëòË¶ÅÔºâ
        try {
          const lastChat = await db.chats?.orderBy('id').last();
          if (lastChat) {
            snapshot.recentData.lastChat = {
              id: lastChat.id,
              name: lastChat.name,
              timestamp: Date.now()
            };
          }
        } catch (e) {
          console.warn('Êó†Ê≥ïËé∑ÂèñÊúÄÂêéËÅäÂ§©ËÆ∞ÂΩï:', e);
        }
        
        // Ê£ÄÊü•Â§ßÂ∞è
        const snapshotStr = JSON.stringify(snapshot);
        if (snapshotStr.length > this.MAX_SNAPSHOT_SIZE) {
          console.warn('‚ö†Ô∏è Âø´ÁÖßËøáÂ§ßÔºåË∑≥Ëøá‰øùÂ≠ò');
          return;
        }
        
        // ‰øùÂ≠òÂà∞ localStorage
        localStorage.setItem(this.SNAPSHOT_KEY, snapshotStr);
        localStorage.setItem(this.LAST_SAVE_KEY, Date.now().toString());
        
        console.log('‚úÖ Êï∞ÊçÆÂø´ÁÖßÂ∑≤‰øùÂ≠òÂà∞ localStorage');
      } catch (error) {
        console.warn('‚ö†Ô∏è Êï∞ÊçÆÂø´ÁÖß‰øùÂ≠òÂ§±Ë¥•:', error);
        if (error.name === 'QuotaExceededError') {
          // localStorage Êª°‰∫ÜÔºåÊ∏ÖÁêÜÊóßÂø´ÁÖß
          localStorage.removeItem(this.SNAPSHOT_KEY);
        }
      }
    },
    
    // Ëé∑ÂèñÂø´ÁÖß
    getSnapshot() {
      try {
        const snapshotStr = localStorage.getItem(this.SNAPSHOT_KEY);
        return snapshotStr ? JSON.parse(snapshotStr) : null;
      } catch {
        return null;
      }
    },
    
    // Ëé∑ÂèñÊúÄÂêé‰øùÂ≠òÊó∂Èó¥
    getLastSaveTime() {
      const time = localStorage.getItem(this.LAST_SAVE_KEY);
      return time ? parseInt(time) : null;
    }
  };
  
  window.DualWriteManager = DualWriteManager;
  
  /**
   * Â¥©Ê∫ÉÊÅ¢Â§çÊ£ÄÊµãÂô®
   */
  const CrashRecoveryDetector = {
    SESSION_KEY: 'ephone-session-active',
    CRASH_FLAG_KEY: 'ephone-possible-crash',
    LAST_HEARTBEAT_KEY: 'ephone-last-heartbeat',
    CRASH_TIME_THRESHOLD: 60 * 1000, // 1ÂàÜÈíüÂÜÖÈáçÂêØÊâçÁÆóÂºÇÂ∏∏ÈÄÄÂá∫
    
    // Ê†áËÆ∞‰ºöËØùÂºÄÂßã
    markSessionStart() {
      sessionStorage.setItem(this.SESSION_KEY, 'true');
      const now = Date.now();
      
      // Ê£ÄÊü•ÊòØÂê¶ÂèØËÉΩÂ¥©Ê∫ÉËøá
      const possibleCrash = localStorage.getItem(this.CRASH_FLAG_KEY);
      const lastHeartbeat = localStorage.getItem(this.LAST_HEARTBEAT_KEY);
      
      let isCrash = false;
      if (possibleCrash === 'true' && lastHeartbeat) {
        const timeSinceLastHeartbeat = now - parseInt(lastHeartbeat);
        // Âè™ÊúâÂú®ÂæàÁü≠Êó∂Èó¥ÂÜÖÔºà10ÁßíÔºâÈáçÂêØÊâçËÆ§‰∏∫ÊòØÂºÇÂ∏∏ÈÄÄÂá∫
        if (timeSinceLastHeartbeat < this.CRASH_TIME_THRESHOLD) {
          console.warn('‚ö†Ô∏è Ê£ÄÊµãÂà∞ÂºÇÂ∏∏ÈÄÄÂá∫ÔºàË∑ù‰∏äÊ¨°ÂøÉË∑≥ ' + Math.round(timeSinceLastHeartbeat / 1000) + ' ÁßíÔºâ');
          isCrash = true;
        } else {
          console.log('‚úÖ Ê≠£Â∏∏ÂÖ≥Èó≠ÔºàË∑ù‰∏äÊ¨°ÂøÉË∑≥ ' + Math.round(timeSinceLastHeartbeat / 1000) + ' ÁßíÔºåË∂ÖËøáÈòàÂÄºÔºâ');
        }
      }
      
      // Êõ¥Êñ∞ÂøÉË∑≥ÂíåÂ¥©Ê∫ÉÊ†áËÆ∞
      localStorage.setItem(this.LAST_HEARTBEAT_KEY, now.toString());
      localStorage.setItem(this.CRASH_FLAG_KEY, 'true');
      
      return isCrash;
    },
    
    // Ê†áËÆ∞Ê≠£Â∏∏ÈÄÄÂá∫
    markNormalExit() {
      sessionStorage.removeItem(this.SESSION_KEY);
      localStorage.removeItem(this.CRASH_FLAG_KEY);
      console.log('‚úÖ Ê≠£Â∏∏ÈÄÄÂá∫ÔºåÂ∑≤Ê∏ÖÈô§Â¥©Ê∫ÉÊ†áËÆ∞');
    },
    
    // ÂøÉË∑≥ÔºàËØÅÊòéÂ∫îÁî®ËøòÊ¥ªÁùÄÔºâ
    heartbeat() {
      localStorage.setItem(this.LAST_HEARTBEAT_KEY, Date.now().toString());
    },
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊìç‰ΩúÊó•Âøó
    hasUnsavedLogs() {
      const logs = OperationLogger.getLogs();
      return logs.length > 0;
    }
  };
  
  window.CrashRecoveryDetector = CrashRecoveryDetector;
  
  /**
   * ÂåÖË£Ö db.put() Êìç‰ΩúÔºåËá™Âä®ËÆ∞ÂΩïÊó•Âøó
   */
  function wrapDatabaseOperations() {
    if (!db || !window.dbReady) return;
    
    const originalPut = Dexie.Table.prototype.put;
    const originalAdd = Dexie.Table.prototype.add;
    const originalDelete = Dexie.Table.prototype.delete;
    
    // ÂåÖË£Ö put Êìç‰Ωú
    Dexie.Table.prototype.put = function(data, key) {
      const tableName = this.name;
      
      // ËÆ∞ÂΩïÊìç‰ΩúÊó•Âøó
      OperationLogger.log('update', tableName, data.id || key, data);
      
      // Ë∞ÉÁî®ÂéüÂßãÊñπÊ≥ï
      return originalPut.call(this, data, key);
    };
    
    // ÂåÖË£Ö add Êìç‰Ωú
    Dexie.Table.prototype.add = function(data, key) {
      const tableName = this.name;
      
      // ËÆ∞ÂΩïÊìç‰ΩúÊó•Âøó
      OperationLogger.log('add', tableName, data.id || key, data);
      
      // Ë∞ÉÁî®ÂéüÂßãÊñπÊ≥ï
      return originalAdd.call(this, data, key);
    };
    
    // ÂåÖË£Ö delete Êìç‰Ωú
    Dexie.Table.prototype.delete = function(key) {
      const tableName = this.name;
      
      // ËÆ∞ÂΩïÊìç‰ΩúÊó•Âøó
      OperationLogger.log('delete', tableName, key, { id: key });
      
      // Ë∞ÉÁî®ÂéüÂßãÊñπÊ≥ï
      return originalDelete.call(this, key);
    };
    
    console.log('‚úÖ Êï∞ÊçÆÂ∫ìÊìç‰ΩúÁõëÊéßÂ∑≤ÂêØÂä®ÔºàÂèåÂÜô + Êìç‰ΩúÊó•ÂøóÔºâ');
  }
  
  // Âú®Êï∞ÊçÆÂ∫ìÂ∞±Áª™ÂêéÂêØÂä®ÂåÖË£Ö
  window.dbReadyPromise.then(() => {
    wrapDatabaseOperations();
  });
  
  /**
   * Â¢ûÂº∫ÂÆûÊó∂‰øùÂ≠òÊú∫Âà∂
   */
  let autoSaveTimer = null;
  
  function triggerAutoSave() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(async () => {
      console.log('üîÑ Ëß¶ÂèëËá™Âä®‰øùÂ≠ò...');
      await DualWriteManager.saveSnapshot();
      CrashRecoveryDetector.heartbeat();
    }, 1000); // Èò≤Êäñ 1 Áßí
  }
  
  // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂‰øùÂ≠ò
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      console.log('üì± È°µÈù¢ËøõÂÖ•ÂêéÂè∞ÔºåÁ´ãÂç≥‰øùÂ≠òÊï∞ÊçÆ...');
      
      // Á´ãÂç≥Âà∑Êñ∞ÊâÄÊúâÂæÖÂÜôÂÖ•ÁöÑÊó•Âøó
      OperationLogger._flushNow();
      
      DualWriteManager.saveSnapshot();
      CrashRecoveryDetector.heartbeat();
    }
  });
  
  // È°µÈù¢ÂÖ≥Èó≠Ââç‰øùÂ≠ò
  window.addEventListener('beforeunload', (event) => {
    console.log('üëã È°µÈù¢Âç≥Â∞ÜÂÖ≥Èó≠Ôºå‰øùÂ≠òÊï∞ÊçÆÂπ∂Ê†áËÆ∞Ê≠£Â∏∏ÈÄÄÂá∫...');
    
    // Á´ãÂç≥Âà∑Êñ∞ÊâÄÊúâÂæÖÂÜôÂÖ•ÁöÑÊó•Âøó
    OperationLogger._flushNow();
    
    DualWriteManager.saveSnapshot();
    CrashRecoveryDetector.markNormalExit();
    // ‰∏çÈòªÊ≠¢È°µÈù¢ÂÖ≥Èó≠
  });
  
  // ÂÆöÊúüÂøÉË∑≥ÔºàÊØè 30 ÁßíÔºâ
  setInterval(() => {
    CrashRecoveryDetector.heartbeat();
  }, 30 * 1000);
  
  // ÂÆöÊúü‰øùÂ≠òÂø´ÁÖßÔºàÊØè 2 ÂàÜÈíüÔºâ
  setInterval(() => {
    DualWriteManager.saveSnapshot();
  }, 2 * 60 * 1000);
  
  console.log('‚úÖ Â¢ûÂº∫Êï∞ÊçÆ‰øùÊä§Êú∫Âà∂Â∑≤ÂêØÂä®ÔºàÊÄßËÉΩ‰ºòÂåñÁâàÔºâ');
  console.log('   - ÂèåÂÜôÊú∫Âà∂: localStorage Âø´ÁÖß‰øùÊä§');
  console.log('   - Êìç‰ΩúÊó•Âøó: ÊâπÈáèÂºÇÊ≠•ÂÜôÂÖ•ÔºàÊØè 3 ÁßíÊàñÁ¥ØÁßØ 10 Êù°Ôºâ');
  console.log('   - Êï∞ÊçÆÈôêÂà∂: ÊúÄÂ§ö 50 Êù°Êàñ 30 ÂàÜÈíüÂÜÖÁöÑÊìç‰Ωú');
  console.log('   - ÂÆûÊó∂‰øùÂ≠ò: visibilitychange + beforeunload');
  console.log('   - Â¥©Ê∫ÉÊ£ÄÊµã: ÂºÇÂ∏∏ÈÄÄÂá∫Ëá™Âä®Ê£ÄÊµã');
  console.log('   - ÊÄßËÉΩÂΩ±Âìç: ËØªÂèñÈõ∂ÂΩ±ÂìçÔºåÂÜôÂÖ•Âü∫Êú¨Êó†ÊÑüÁü•');
  
  /**
   * üîß Ë∞ÉËØïÂ∑•ÂÖ∑ - ‰æõÁî®Êà∑Âú®ÊéßÂà∂Âè∞Êü•ÁúãÊï∞ÊçÆ‰øùÊä§Áä∂ÊÄÅ
   */
  window.DataProtectionDebug = {
    // Êü•ÁúãÊâÄÊúâÊìç‰ΩúÊó•Âøó
    viewLogs() {
      const logs = OperationLogger.getLogs();
      const pendingCount = OperationLogger._pendingLogs.length;
      
      console.log(`üìã Êìç‰ΩúÊó•Âøó (Â∑≤‰øùÂ≠ò: ${logs.length} Êù°, ÂæÖÂÜôÂÖ•: ${pendingCount} Êù°):`);
      
      // ÊòæÁ§∫Â∑≤‰øùÂ≠òÁöÑÊó•Âøó
      logs.forEach((log, index) => {
        const time = new Date(log.timestamp).toLocaleString();
        console.log(`${index + 1}. [${time}] ${log.operation.toUpperCase()} ${log.tableName} (ID: ${log.recordId})`);
      });
      
      // ÊòæÁ§∫ÂæÖÂÜôÂÖ•ÁöÑÊó•Âøó
      if (pendingCount > 0) {
        console.log(`\n‚è≥ ÂæÖÂÜôÂÖ•ÁºìÂÜ≤Âå∫ (${pendingCount} Êù°):`);
        OperationLogger._pendingLogs.forEach((log, index) => {
          const time = new Date(log.timestamp).toLocaleString();
          console.log(`${index + 1}. [${time}] ${log.operation.toUpperCase()} ${log.tableName} (ID: ${log.recordId})`);
        });
      }
      
      return { saved: logs, pending: OperationLogger._pendingLogs };
    },
    
    // Êü•ÁúãÂø´ÁÖßÁä∂ÊÄÅ
    viewSnapshot() {
      const snapshot = DualWriteManager.getSnapshot();
      const lastSaveTime = DualWriteManager.getLastSaveTime();
      
      if (!snapshot) {
        console.log('‚ö†Ô∏è ÊöÇÊó†Êï∞ÊçÆÂø´ÁÖß');
        return null;
      }
      
      console.log('üì∏ Êï∞ÊçÆÂø´ÁÖßÁä∂ÊÄÅ:');
      console.log(`  ÂàõÂª∫Êó∂Èó¥: ${new Date(snapshot.timestamp).toLocaleString()}`);
      console.log(`  ÊúÄÂêé‰øùÂ≠ò: ${lastSaveTime ? new Date(lastSaveTime).toLocaleString() : 'Êú™Áü•'}`);
      console.log(`  ËÅäÂ§©Êï∞: ${snapshot.summary?.chatsCount || 0}`);
      console.log(`  ËØ¥ËØ¥Êï∞: ${snapshot.summary?.qzonePostsCount || 0}`);
      console.log(`  NPCÊï∞: ${snapshot.summary?.npcsCount || 0}`);
      
      return snapshot;
    },
    
    // Êü•ÁúãÊï∞ÊçÆ‰øùÊä§Êï¥‰ΩìÁä∂ÊÄÅ
    viewStatus() {
      const logs = OperationLogger.getLogs();
      const snapshot = DualWriteManager.getSnapshot();
      const lastSaveTime = DualWriteManager.getLastSaveTime();
      const lastHeartbeat = localStorage.getItem(CrashRecoveryDetector.LAST_HEARTBEAT_KEY);
      
      console.log('üõ°Ô∏è Êï∞ÊçÆ‰øùÊä§Êú∫Âà∂Áä∂ÊÄÅ:');
      console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
      console.log(`üìã Êìç‰ΩúÊó•Âøó: ${logs.length} Êù°`);
      console.log(`üì∏ Âø´ÁÖßÁä∂ÊÄÅ: ${snapshot ? 'Â∑≤‰øùÂ≠ò' : 'Êú™‰øùÂ≠ò'}`);
      console.log(`üíæ ÊúÄÂêé‰øùÂ≠ò: ${lastSaveTime ? new Date(lastSaveTime).toLocaleString() : 'Êú™‰øùÂ≠ò'}`);
      console.log(`üíì ÊúÄÂêéÂøÉË∑≥: ${lastHeartbeat ? new Date(parseInt(lastHeartbeat)).toLocaleString() : 'Êú™Áü•'}`);
      console.log(`üîß Êï∞ÊçÆÂ∫ìÁä∂ÊÄÅ: ${window.dbReady ? 'Â∞±Áª™' : 'Êú™Â∞±Áª™'}`);
      console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
      
      // localStorage ‰ΩøÁî®ÊÉÖÂÜµ
      try {
        const used = new Blob(Object.values(localStorage)).size;
        console.log(`üíΩ localStorage ‰ΩøÁî®: ${(used / 1024).toFixed(2)} KB`);
      } catch (e) {
        console.log('üíΩ localStorage ‰ΩøÁî®: Êó†Ê≥ïËÆ°ÁÆó');
      }
      
      return {
        logsCount: logs.length,
        hasSnapshot: !!snapshot,
        lastSaveTime: lastSaveTime ? new Date(lastSaveTime) : null,
        lastHeartbeat: lastHeartbeat ? new Date(parseInt(lastHeartbeat)) : null,
        dbReady: window.dbReady
      };
    },
    
    // Ê∏ÖÈô§ÊâÄÊúâÊìç‰ΩúÊó•Âøó
    clearLogs() {
      if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊìç‰ΩúÊó•ÂøóÂêóÔºüËøô‰∏ç‰ºöÂΩ±ÂìçÂÆûÈôÖÊï∞ÊçÆ„ÄÇ')) {
        OperationLogger.clear();
        console.log('‚úÖ Êìç‰ΩúÊó•ÂøóÂ∑≤Ê∏ÖÈô§');
      }
    },
    
    // ÊâãÂä®Ëß¶ÂèëÂø´ÁÖß‰øùÂ≠ò
    async saveNow() {
      console.log('üíæ Ê≠£Âú®ÊâãÂä®‰øùÂ≠òÂø´ÁÖß...');
      OperationLogger._flushNow(); // ÂÖàÂà∑Êñ∞Êó•Âøó
      await DualWriteManager.saveSnapshot();
      console.log('‚úÖ Âø´ÁÖß‰øùÂ≠òÂÆåÊàê');
    },
    
    // ÊâãÂä®Âà∑Êñ∞Êìç‰ΩúÊó•Âøó
    flushLogs() {
      const pendingCount = OperationLogger._pendingLogs.length;
      if (pendingCount === 0) {
        console.log('‚úÖ Ê≤°ÊúâÂæÖÂÜôÂÖ•ÁöÑÊó•Âøó');
        return;
      }
      
      console.log(`üíæ Ê≠£Âú®Âà∑Êñ∞ ${pendingCount} Êù°ÂæÖÂÜôÂÖ•Êó•Âøó...`);
      OperationLogger._flushNow();
      console.log('‚úÖ Êó•ÂøóÂ∑≤Âà∑Êñ∞Âà∞ localStorage');
    },
    
    // Êü•Áúã localStorage Â≠òÂÇ®Â§ßÂ∞è
    checkStorage() {
      console.log('üíΩ localStorage Â≠òÂÇ®ÂàÜÊûê:');
      console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
      
      const keys = [
        OperationLogger.STORAGE_KEY,
        DualWriteManager.SNAPSHOT_KEY,
        CrashRecoveryDetector.LAST_HEARTBEAT_KEY,
        CrashRecoveryDetector.CRASH_FLAG_KEY
      ];
      
      keys.forEach(key => {
        const value = localStorage.getItem(key);
        if (value) {
          const size = new Blob([value]).size;
          console.log(`  ${key}: ${(size / 1024).toFixed(2)} KB`);
        } else {
          console.log(`  ${key}: (Êú™ËÆæÁΩÆ)`);
        }
      });
      
      console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
      
      // ÊÄª‰ΩìÂ≠òÂÇ®‰º∞ÁÆó
      try {
        const total = new Blob(Object.values(localStorage)).size;
        console.log(`üìä ÊÄªËÆ°: ${(total / 1024).toFixed(2)} KB / ~5-10 MB ÈôêÂà∂`);
      } catch (e) {
        console.log('üìä ÊÄªËÆ°: Êó†Ê≥ïËÆ°ÁÆó');
      }
    }
  };
  
  // ÊèêÁ§∫Áî®Êà∑ÂèØ‰ª•‰ΩøÁî®Ë∞ÉËØïÂ∑•ÂÖ∑
  console.log('');
  console.log('üí° Êï∞ÊçÆ‰øùÊä§Ë∞ÉËØïÂ∑•ÂÖ∑Â∑≤Âä†ËΩΩÔºÅ');
  console.log('   ‰ΩøÁî® DataProtectionDebug.viewStatus() Êü•ÁúãÁä∂ÊÄÅ');
  console.log('   ‰ΩøÁî® DataProtectionDebug.viewLogs() Êü•ÁúãÊìç‰ΩúÊó•Âøó');
  console.log('   ‰ΩøÁî® DataProtectionDebug.viewSnapshot() Êü•ÁúãÂø´ÁÖß');
  console.log('   ‰ΩøÁî® DataProtectionDebug.checkStorage() Êü•ÁúãÂ≠òÂÇ®‰ΩøÁî®');
  console.log('   ‰ΩøÁî® DataProtectionDebug.flushLogs() ÊâãÂä®Âà∑Êñ∞Êó•Âøó');
  console.log('');
  
  // ========================================
  // üõ°Ô∏è Â¢ûÂº∫Êï∞ÊçÆ‰øùÊä§Êú∫Âà∂ÁªìÊùü
  // ========================================




  function showScreen(screenId) {
    // Ê£ÄÊü•ÊòØÂê¶‰ªé‰Ω†ÁîªÊàëÁåúÂ±èÂπïÁ¶ªÂºÄ
    const currentActiveScreen = document.querySelector('.screen.active');
    if (currentActiveScreen && currentActiveScreen.id === 'draw-guess-screen' && screenId !== 'draw-guess-screen') {
      // Ê≠£Âú®Á¶ªÂºÄ‰Ω†ÁîªÊàëÁåúÂ±èÂπï
      if (drawGuessState.isActive && drawGuessState.partnerId && drawGuessState.history.length > 1) {
        // ÊúâÊ∏∏ÊàèËÆ∞ÂΩïÔºåÂ∞ÜÂÖ∂ÂèëÈÄÅÂà∞ËÅäÂ§©ÂéÜÂè≤
        (async () => {
          try {
            const chat = state.chats[drawGuessState.partnerId];
            if (chat) {
              const userNickname = chat.settings.myNickname || 'Êàë';

              // ÊûÑÂª∫Ê∏∏ÊàèËÆ∞ÂΩïÊëòË¶Å
              let gameRecord = `[Á≥ªÁªüÊèêÁ§∫ÔºöÂàöÂàö‰Ω†‰ª¨Áé©‰∫Ü‰Ω†ÁîªÊàëÁåúÊ∏∏Êàè„ÄÇ‰ª•‰∏ãÊòØÊ∏∏ÊàèÁöÑÂØπËØùËÆ∞ÂΩï]\n\n`;

              drawGuessState.history.forEach(msg => {
                gameRecord += `${msg.sender}: ${msg.content}\n`;
              });

              // Ê∑ªÂä†‰∏∫ÁÅ∞Ëâ≤Á≥ªÁªüÊ∂àÊÅØÂíåÈöêËóèË∞ÉËØïÂ±Ç
              const gameLog = {
                role: 'system',
                content: gameRecord,
                timestamp: Date.now(),
                isHidden: true,
                isGrayNotice: true
              };

              chat.history.push(gameLog);
              await db.chats.put(chat);

              console.log(`[‰Ω†ÁîªÊàëÁåúËÆ∞ÂΩï] Â∑≤Â∞ÜÊ∏∏ÊàèËÆ∞ÂΩïÊ∑ªÂä†Âà∞ ${chat.name} ÁöÑËÅäÂ§©ÂéÜÂè≤‰∏≠`);
            }
          } catch (error) {
            console.error('[‰Ω†ÁîªÊàëÁåúËÆ∞ÂΩï] ‰øùÂ≠òÊ∏∏ÊàèËÆ∞ÂΩïÂ§±Ë¥•:', error);
          }
        })();
      }
    }

    if (screenId === 'chat-list-screen') {
      window.renderChatListProxy();
      switchToChatListView('messages-view');
      // Ê£ÄÊü•ÊòØÂê¶ÊúâË¥≠Áâ©ËΩ¶Ê∏ÖÁ©∫ÈÄöÁü•
      checkPendingCartNotifications();
    }
    if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
    if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
    if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
    if (screenId === 'x-social-screen') window.renderXSocialScreenProxy();
    if (screenId === 'douban-screen') renderDoubanScreen();
    if (screenId === 'online-app-screen' && typeof onlineChatManager !== 'undefined') {
      onlineChatManager.renderChatList();
      onlineChatManager.showView('online-app-list-view');
    }
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screenToShow = document.getElementById(screenId);
    if (screenToShow) screenToShow.classList.add('active');
    if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
    if (screenId === 'font-settings-screen') {
      loadFontPresetsDropdown();
      document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
      applyCustomFont(state.globalSettings.fontUrl || '', true);
      // ÂàùÂßãÂåñÂ≠ó‰ΩìÂ§ßÂ∞èÊªëÂä®Êù°
      const fontSize = state.globalSettings.globalFontSize || 16;
      document.getElementById('font-size-slider').value = fontSize;
      document.getElementById('font-size-value').textContent = fontSize;
      // ÂàùÂßãÂåñÂ≠ó‰ΩìÂ∫îÁî®ËåÉÂõ¥ UI
      const scope = state.globalSettings.fontScope || { all: true };
      const allCb = document.getElementById('font-scope-all');
      const scopeList = document.getElementById('font-scope-list');
      allCb.checked = !!scope.all;
      scopeList.style.display = scope.all ? 'none' : 'flex';
      document.querySelectorAll('#font-scope-list input[data-scope]').forEach(cb => {
        cb.checked = scope[cb.dataset.scope] !== false;
      });
    }
  }
  window.updateListenTogetherIconProxy = () => { };

  function switchToChatListView(viewId) {
    const chatListScreen = document.getElementById('chat-list-screen');
    const views = {
      'messages-view': document.getElementById('messages-view'),
      'qzone-screen': document.getElementById('qzone-screen'),
      'favorites-view': document.getElementById('favorites-view'),
      'memories-view': document.getElementById('memories-view'),
      'npc-list-view': document.getElementById('npc-list-view')
    };
    const mainHeader = document.getElementById('main-chat-list-header');
    const mainBottomNav = document.getElementById('chat-list-bottom-nav');

    if (isFavoritesSelectionMode) {
      document.getElementById('favorites-edit-btn').click();
    }


    Object.values(views).forEach(v => v.classList.remove('active'));

    if (views[viewId]) {
      views[viewId].classList.add('active');
    }


    document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
      item.classList.toggle('active', item.dataset.view === viewId);
    });


    if (viewId === 'messages-view') {
      mainHeader.style.display = 'flex';
      mainBottomNav.style.display = 'flex';
    } else {
      mainHeader.style.display = 'none';
      mainBottomNav.style.display = 'none';
    }


    if (viewId !== 'memories-view') {
      activeCountdownTimers.forEach(timerId => clearInterval(timerId));
      activeCountdownTimers = [];
    }


    switch (viewId) {
      case 'qzone-screen':
        views['qzone-screen'].style.backgroundColor = '#f0f2f5';
        updateUnreadIndicator(0);
        renderQzoneScreen();
        renderQzonePosts();
        break;
      case 'favorites-view':
        views['favorites-view'].style.backgroundColor = '#f9f9f9';
        renderFavoritesScreen();
        break;
      case 'messages-view':

        break;
      case 'npc-list-view':
        renderNpcListScreen();
        break;
    }
  }

  function renderXSocialScreen() {

    console.log("Ê∏≤ÊüìXÁ§æ‰∫§È°µÈù¢");
  }
  window.renderXSocialScreenProxy = renderXSocialScreen;

  function renderQzoneScreen() {
    if (state && state.qzoneSettings) {
      const settings = state.qzoneSettings;
      document.getElementById('qzone-nickname').textContent = settings.nickname;
      document.getElementById('qzone-avatar-img').src = settings.avatar;
      document.getElementById('qzone-banner-img').src = settings.banner;
    }
  }
  window.renderQzoneScreenProxy = renderQzoneScreen;

  async function saveQzoneSettings() {
    if (db && state.qzoneSettings) {
      await db.qzoneSettings.put(state.qzoneSettings);
    }
  }

  function formatPostTimestamp(timestamp) {
    if (!timestamp) return '';
    const now = new Date();
    const date = new Date(timestamp);
    const diffSeconds = Math.floor((now - date) / 1000);
    const diffMinutes = Math.floor(diffSeconds / 60);
    const diffHours = Math.floor(diffMinutes / 60);
    if (diffMinutes < 1) return 'ÂàöÂàö';
    if (diffMinutes < 60) return `${diffMinutes}ÂàÜÈíüÂâç`;
    if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    if (now.getFullYear() === year) {
      return `${month}-${day} ${hours}:${minutes}`;
    } else {
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
  }


















  async function createOrUpdatePostElement(post) {
    const existingPostContainer = document.querySelector(`.qzone-post-container[data-post-id="${post.id}"]`);
    const isUpdating = !!existingPostContainer;

    const postContainer = isUpdating ? existingPostContainer : document.createElement('div');
    if (!isUpdating) {
      postContainer.className = 'qzone-post-container';
      postContainer.dataset.postId = post.id;
    }

    const postEl = isUpdating ? postContainer.querySelector('.qzone-post-item') : document.createElement('div');
    if (!isUpdating) {
      postEl.className = 'qzone-post-item';
    }

    let authorAvatar = '',
      authorNickname = '',
      commentAvatar = state.qzoneSettings.avatar;


    if (post.authorId === 'user') {
      authorAvatar = state.qzoneSettings.avatar;
      authorNickname = state.qzoneSettings.nickname;
    } else if (state.chats[post.authorId]) {
      const authorChat = state.chats[post.authorId];
      authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
      authorNickname = authorChat.name;
    } else if (String(post.authorId).startsWith('npc_')) {

      const npcId = parseInt(String(post.authorId).replace('npc_', ''));
      if (!isNaN(npcId)) {
        const npc = await db.npcs.get(npcId);
        if (npc) {
          authorAvatar = npc.avatar || defaultGroupMemberAvatar;
          authorNickname = npc.name;
        } else {
          authorNickname = post.authorOriginalName || 'Êú™Áü•NPC';
          authorAvatar = defaultGroupMemberAvatar;
        }
      }
    } else {

      authorNickname = getDisplayNameByOriginalName(post.authorOriginalName);
      authorAvatar = defaultAvatar;
    }


    function renderOriginalPostContent(targetPost) {
      let innerContentHtml = '';
      const publicTextHtml = targetPost.publicText ? `<div class="post-content">${parseMarkdown(targetPost.publicText).replace(/\n/g, '<br>')}</div>` : '';

      if (targetPost.type === 'shuoshuo') {
        innerContentHtml = `<div class="post-content" style="margin-bottom: 10px;">${parseMarkdown(targetPost.content).replace(/\n/g, '<br>')}</div>`;
      } else if (targetPost.type === 'image_post' && targetPost.imageUrl) {

        innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${targetPost.imageUrl}" class="chat-image"></div>` : `<img src="${targetPost.imageUrl}" class="chat-image">`;
      } else if (targetPost.type === 'text_image') {

        const postImageUrl = state.globalSettings.enableAiDrawing && targetPost.image_prompt ? `https://image.pollinations.ai/prompt/${targetPost.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
        innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}"></div>` : `<img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}">`;
      } else if (targetPost.type === 'naiimag' || targetPost.type === 'googleimag') {

        const imageUrls = targetPost.imageUrls || (targetPost.imageUrl ? [targetPost.imageUrl] : []);

        if (imageUrls.length > 0) {
          const imageCount = imageUrls.length;
          let imagesHtml = '';

          // ‰ΩøÁî®Áªü‰∏ÄÁöÑÂ§öÂõæÂ∏ÉÂ±ÄÔºàÂåÖÊã¨ÂçïÂº†ÂõæÁâáÔºâ
          imagesHtml = `<div class="post-images-grid grid-${imageCount}">`;
          imageUrls.forEach((url, index) => {
            imagesHtml += `<img src="${url}" class="naiimag-image" alt="ÂõæÁâá${index + 1}" loading="lazy" onerror="this.src='https://i.postimg.cc/KYr2qRCK/1.jpg'; this.alt='ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•';">`;
          });
          imagesHtml += '</div>';

          innerContentHtml = publicTextHtml ? `${publicTextHtml}${imagesHtml}` : imagesHtml;
        }
      }
      return innerContentHtml;
    }

    let mainContentHtml;

    if (post.type === 'repost') {
      const repostCommentHtml = post.repostComment ? `<div class="post-content">${post.repostComment.replace(/\n/g, '<br>')}</div>` : '';
      let originalAuthorAvatar = defaultAvatar;
      let originalAuthorNickname = 'Âéü‰ΩúËÄÖ';
      if (post.originalPost.authorId === 'user') {
        originalAuthorAvatar = state.qzoneSettings.avatar;
        originalAuthorNickname = state.qzoneSettings.nickname;
      } else {
        const originalAuthorChat = state.chats[post.originalPost.authorId];
        if (originalAuthorChat) {
          originalAuthorAvatar = originalAuthorChat.settings.aiAvatar || defaultAvatar;
        }
        originalAuthorNickname = getDisplayNameByOriginalName(post.originalPost.authorOriginalName);
      }
      mainContentHtml = `
                    ${repostCommentHtml}
                    <div class="reposted-content-wrapper">
                        <div class="post-header">
                            <img src="${originalAuthorAvatar}" class="post-avatar">
                            <div class="post-info">
                                <span class="post-nickname">@${originalAuthorNickname}</span>
                                <span class="post-timestamp">${formatPostTimestamp(post.originalPost.timestamp)}</span>
                            </div>
                        </div>
                        <div class="post-main-content">${renderOriginalPostContent(post.originalPost)}</div>
                    </div>
                `;
    } else {
      mainContentHtml = `<div class="post-main-content">${renderOriginalPostContent(post)}</div>`;
    }

    let likesHtml = '';
    if (post.likes && post.likes.length > 0) {
      const displayLikes = post.likes.map(name => getDisplayNameByOriginalName(name)).join('„ÄÅ');
      likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${displayLikes} ËßâÂæóÂæàËµû</span></div>`;
    }


    let commentsHtml = '';
    if (post.comments && post.comments.length > 0) {
      commentsHtml = '<div class="post-comments-container">';
      post.comments.forEach((comment, index) => {

        if (typeof comment === 'object' && comment !== null && comment.commenterName) {
          const commenterOriginalName = comment.commenterName;

          const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);

          let innerCommentContent;
          if (STICKER_REGEX.test(comment.text)) {
            innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
          } else {
            innerCommentContent = parseMarkdown(comment.text);
          }

          let commentLineHtml = '';

          if (comment.replyTo) {
            const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> ÂõûÂ§ç <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
          } else {
            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
          }

          commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                            <div class="comment-text">${commentLineHtml}</div>
                                            <span class="comment-delete-btn" data-comment-index="${index}">√ó</span>
                                         </div>`;

        } else {

          commentsHtml += `<div class="legacy-comment-item">
                                            <span class="comment-text">${String(comment)}</span>
                                         </div>`;
        }
      });
      commentsHtml += '</div>';
    }


    const userOriginalName = state.qzoneSettings.nickname;
    const isLikedByUser = post.likes && post.likes.includes(userOriginalName);
    const isFavoritedByUser = state.favoritedPostIds && state.favoritedPostIds.has(post.id);

    let repostIconHtml = '';
    if (post.type !== 'repost') {
      repostIconHtml = `
                    <span class="action-icon repost">
                        <svg viewBox="0 0 24 24"><path d="M17 2.1l4 4-4 4 M3 11.5v-3a4 4 0 0 1 4-4h13 M7 21.9l-4-4 4-4 M21 12.5v3a4 4 0 0 1-4 4H4"></path></svg>
                    </span>`;
    }

    postEl.innerHTML = `
                <div class="post-header">
                    <img src="${authorAvatar}" class="post-avatar" data-author-id="${post.authorId}">
                    <div class="post-info">
                        <span class="post-nickname">${authorNickname}</span>
                        <span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
                    </div>
                    <div class="post-actions-btn">‚Ä¶</div>
                </div>
                ${mainContentHtml}
                <div class="post-feedback-icons">
                    ${repostIconHtml}
                    <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                    <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                </div>
                ${likesHtml}
                ${commentsHtml}
                <div class="post-footer">
                    <div class="comment-section">
                        <img src="${commentAvatar}" class="comment-avatar">
                        <input type="text" class="comment-input" placeholder="ÂèãÂñÑÁöÑËØÑËÆ∫ÊòØ‰∫§ÊµÅÁöÑËµ∑ÁÇπ">
                        <button class="comment-sticker-btn">
        <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 14 Q 12 16 16 14"></path>
            <line x1="9" y1="9" x2="9.01" y2="9"></line>
            <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
        </button>
                        <div class="at-mention-popup"></div>
                    </div>
                    <button class="comment-send-btn">ÂèëÈÄÅ</button>
                </div>
            `;

    if (!isUpdating) {
      const deleteAction = document.createElement('div');
      deleteAction.className = 'qzone-post-delete-action';
      deleteAction.innerHTML = '<span>Âà†Èô§</span>';
      postContainer.appendChild(postEl);
      postContainer.appendChild(deleteAction);
    }

    return postContainer;
  }


  async function updateSinglePostInDOM(postId) {
    const postData = await db.qzonePosts.get(postId);
    if (!postData) {

      const postContainer = document.querySelector(`.qzone-post-container[data-post-id="${postId}"]`);
      if (postContainer) {
        postContainer.remove();
      }
      return;
    }


    const cacheIndex = qzonePostsCache.findIndex(p => p.id === postId);
    if (cacheIndex > -1) {
      qzonePostsCache[cacheIndex] = postData;
    }


    const favorites = await db.favorites.where('type').equals('qzone_post').toArray();
    state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));


    await createOrUpdatePostElement(postData);
  }




  async function renderQzonePosts() {
    const postsListEl = document.getElementById('qzone-posts-list');
    if (!postsListEl) return;

    const [postsFromDb, favorites] = await Promise.all([
      db.qzonePosts.orderBy('timestamp').reverse().filter(post => !post.isDeleted).toArray(),
      db.favorites.where('type').equals('qzone_post').toArray()
    ]);
    qzonePostsCache = postsFromDb;
    state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));

    postsListEl.innerHTML = '';
    qzonePostsRenderCount = 0;

    if (qzonePostsCache.length === 0) {
      postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">ËøôÈáåÁ©∫Á©∫Â¶Ç‰πüÔºåÂø´Êù•ÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°ËØ¥ËØ¥ÂêßÔºÅ</p>';
      return;
    }


    loadMoreQzonePosts();
  }




  async function loadMoreQzonePosts() {
    if (isLoadingMorePosts) return;
    isLoadingMorePosts = true;

    const postsListEl = document.getElementById('qzone-posts-list');
    if (!postsListEl) {
      isLoadingMorePosts = false;
      return;
    }

    showLoader(postsListEl, 'bottom');


    setTimeout(async () => {
      hideLoader(postsListEl);

      const nextSliceStart = qzonePostsRenderCount;
      const nextSliceEnd = qzonePostsRenderCount + QZONE_RENDER_WINDOW;
      const postsToAppend = qzonePostsCache.slice(nextSliceStart, nextSliceEnd);

      const fragment = document.createDocumentFragment();
      for (const post of postsToAppend) {
        const postElement = await createOrUpdatePostElement(post);
        fragment.appendChild(postElement);
      }
      postsListEl.appendChild(fragment);

      qzonePostsRenderCount += postsToAppend.length;

      isLoadingMorePosts = false;
    }, 500);
  }



  function openQzoneStickerPanel(postId, buttonElement) {
    const panel = qzoneStickerPanelState.panelEl;
    const grid = qzoneStickerPanelState.gridEl;


    grid.innerHTML = '';
    if (state.userStickers.length === 0) {
      grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1; padding-top: 20px;">ËØ∑ÂÖàÂú®ËÅäÂ§©ÁïåÈù¢ÁöÑ<br>Ë°®ÊÉÖÈù¢Êùø‰∏≠Ê∑ªÂä†Ë°®ÊÉÖÂåÖ</p>';
    } else {
      state.userStickers.forEach(sticker => {
        const item = document.createElement('div');
        item.className = 'sticker-item';
        item.style.backgroundImage = `url(${sticker.url})`;
        item.title = sticker.name;
        grid.appendChild(item);
      });
    }




    const btnRect = buttonElement.getBoundingClientRect();
    const phoneScreenRect = document.getElementById('phone-screen').getBoundingClientRect();

    panel.style.display = 'flex';
    const panelRect = panel.getBoundingClientRect();
    const panelHeight = panelRect.height;
    const panelWidth = panelRect.width;


    panel.style.top = `${btnRect.top - panelHeight - 5 - phoneScreenRect.top}px`;


    const desiredLeftPosition = btnRect.left - phoneScreenRect.left;


    if (desiredLeftPosition + panelWidth > phoneScreenRect.width) {

      panel.style.left = 'auto';
      panel.style.right = '5px';
    } else {

      panel.style.left = `${desiredLeftPosition}px`;
      panel.style.right = 'auto';
    }




    qzoneStickerPanelState.isOpen = true;
    qzoneStickerPanelState.activePostId = postId;
  }



  function closeQzoneStickerPanel() {

    if (qzoneStickerPanelState.isOpen) {

      qzoneStickerPanelState.panelEl.style.display = 'none';


      qzoneStickerPanelState.isOpen = false;
      qzoneStickerPanelState.activePostId = null;
    }
  }






  async function sendQzoneStickerComment(postId, sticker) {
    if (!sticker || !sticker.url) return;

    const post = await db.qzonePosts.get(postId);
    if (!post) {
      console.error("sendQzoneStickerComment: Êâæ‰∏çÂà∞Â∏ñÂ≠ê:", postId);
      return;
    }

    if (!post.comments) {
      post.comments = [];
    }

    const newComment = {
      commenterName: state.qzoneSettings.nickname,
      text: sticker.url,
      meaning: sticker.name,
      timestamp: Date.now()
    };

    post.comments.push(newComment);

    await db.qzonePosts.update(postId, {
      comments: post.comments
    });

    closeQzoneStickerPanel();
    await renderQzonePosts();

    const postSummary = (post.publicText || post.content || `[ÂõæÁâáÂä®ÊÄÅ]`).substring(0, 30);


    for (const chatId in state.chats) {
      const chat = state.chats[chatId];
      if (!chat.isGroup) {
        const intelligentPrompt = `[Á≥ªÁªüÊèêÁ§∫Ôºö'${state.qzoneSettings.nickname}' Âú®‰Ω†ÁöÑÂä®ÊÄÅ(ID: ${postId}, ÂÜÖÂÆπÊëòË¶Å: ‚Äú${postSummary}‚Äù)‰∏ãÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖËØÑËÆ∫ÔºåÊÑèÊÄùÊòØÔºö‚Äú${sticker.name}‚Äù„ÄÇËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ]`;

        const historyMessage = {
          role: 'system',
          content: intelligentPrompt,
          timestamp: Date.now(),
          isHidden: true
        };
        chat.history.push(historyMessage);
        await db.chats.put(chat);
      }
    }

  }







  function openRepostModal(postId) {
    repostTargetId = postId;
    document.getElementById('repost-comment-input').value = '';
    document.getElementById('repost-modal').classList.add('visible');
  }


  function hideRepostModal() {
    document.getElementById('repost-modal').classList.remove('visible');
    repostTargetId = null;
  }


  async function handleConfirmRepost() {
    if (!repostTargetId) return;

    const comment = document.getElementById('repost-comment-input').value.trim();
    const originalPost = await db.qzonePosts.get(repostTargetId);

    if (!originalPost) {
      alert("ÈîôËØØÔºöÊâæ‰∏çÂà∞Ë¶ÅËΩ¨ÂèëÁöÑÂéüÂßãÂä®ÊÄÅ„ÄÇ");
      hideRepostModal();
      return;
    }

    const newPost = {
      type: 'repost',
      timestamp: Date.now(),
      authorId: 'user',
      repostComment: comment,
      originalPost: originalPost,
      visibleGroupIds: null
    };

    await db.qzonePosts.add(newPost);
    hideRepostModal();
    await renderQzonePosts();
    alert('ËΩ¨ÂèëÊàêÂäüÔºÅ');
  }




  function displayFilteredFavorites(items) {
    const listEl = document.getElementById('favorites-list');
    listEl.innerHTML = '';

    if (items.length === 0) {
      const searchTerm = document.getElementById('favorites-search-input').value;
      const message = searchTerm ? 'Êú™ÊâæÂà∞Áõ∏ÂÖ≥Êî∂Ëóè' : '‰Ω†ÁöÑÊî∂ËóèÂ§πÊòØÁ©∫ÁöÑÔºå<br>Âø´ÂéªÂä®ÊÄÅÊàñËÅäÂ§©‰∏≠Êî∂ËóèÂñúÊ¨¢ÁöÑÂÜÖÂÆπÂêßÔºÅ';
      listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
      return;
    }

    for (const item of items) {
      const card = document.createElement('div');
      card.className = 'favorite-item-card';
      card.dataset.favid = item.id;

      let headerHtml = '',
        contentHtml = '',
        sourceText = '',
        footerHtml = '';

      if (item.type === 'qzone_post') {
        const post = item.content;
        sourceText = 'Êù•Ëá™Âä®ÊÄÅ';
        let authorAvatar = defaultAvatar,
          authorNickname = 'Êú™Áü•Áî®Êà∑';

        if (post.authorId === 'user') {
          authorAvatar = state.qzoneSettings.avatar;
          authorNickname = state.qzoneSettings.nickname;
        } else if (state.chats[post.authorId]) {
          authorAvatar = state.chats[post.authorId].settings.aiAvatar;
          authorNickname = state.chats[post.authorId].name;
        }

        headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;

        const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
        if (post.type === 'shuoshuo') {
          contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
        } else if (post.type === 'image_post' && post.imageUrl) {
          const postImageUrl = state.globalSettings.enableAiDrawing && post.image_prompt ? `https://image.pollinations.ai/prompt/${post.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
          contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image"></div>` : `<img src="${postImageUrl}" class="chat-image">`;
        } else if (post.type === 'text_image') {
          const postImageUrl = state.globalSettings.enableAiDrawing && post.image_prompt ? `https://image.pollinations.ai/prompt/${post.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
          contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
        }




        let likesHtml = '';

        if (post.likes && post.likes.length > 0) {

          likesHtml = `
                            <div class="post-likes-section">
                                <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                <span>${post.likes.join('„ÄÅ')} ËßâÂæóÂæàËµû</span>
                            </div>`;
        }



        let commentsHtml = '';
        if (post.comments && post.comments.length > 0) {
          commentsHtml = '<div class="post-comments-container">';
          post.comments.forEach((comment, index) => {

            if (typeof comment === 'object' && comment !== null && comment.commenterName) {

              const commenterOriginalName = comment.commenterName;
              const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);

              let innerCommentContent;
              if (STICKER_REGEX.test(comment.text)) {
                innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
              } else {
                innerCommentContent = comment.text;
              }

              let commentLineHtml = '';
              if (comment.replyTo) {
                const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
                commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> ÂõûÂ§ç <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
              } else {
                commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
              }

              commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                        <div class="comment-text">${commentLineHtml}</div>
                                        <span class="comment-delete-btn" data-comment-index="${index}">√ó</span>
                                     </div>`;

            } else {


              commentsHtml += `<div class="legacy-comment-item">
                                        <span class="comment-text">${String(comment)}</span>
                                     </div>`;
            }
          });
          commentsHtml += '</div>';
        }



        footerHtml = `${likesHtml}${commentsHtml}`;



      } else if (item.type === 'chat_message') {
        const msg = item.content;
        const chat = state.chats[item.chatId];
        if (!chat) continue;

        sourceText = `Êù•Ëá™‰∏é ${chat.name} ÁöÑËÅäÂ§©`;
        const isUser = msg.role === 'user';
        let senderName, senderAvatar;

        if (isUser) {

          senderName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
          senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
        } else {
          if (chat.isGroup) {


            const member = chat.members.find(m => m.originalName === msg.senderName);


            senderName = msg.senderName;

            senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
          } else {

            senderName = chat.name;
            senderAvatar = chat.settings.aiAvatar || defaultAvatar;
          }
        }


        headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;

        if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
          contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
        } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
          contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
        } else {
          contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
        }
      } else if (item.type === 'char_diary') {
        const diary = item.content;
        sourceText = `Êù•Ëá™ ${diary.characterName} ÁöÑÊó•ËÆ∞`;

        const charChat = state.chats[diary.characterId];
        const authorAvatar = charChat ? charChat.settings.aiAvatar : defaultAvatar;

        headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${diary.characterName}</div></div>`;


        const fullDiaryContent = diary.content || '';

        const formattedContent = parseMarkdown(fullDiaryContent).replace(/\n/g, '<br>');


        contentHtml = `
                <span class="diary-title">${diary.title}</span>
                <div class="fav-card-content-full">${formattedContent}</div>
            `;
      } else if (item.type === 'char_browser_article') {
        const article = item.content;
        sourceText = `Êù•Ëá™ ${article.characterName} ÁöÑÊµèËßàËÆ∞ÂΩï`;

        const charChat = state.chats[article.characterId];
        const authorAvatar = charChat ? charChat.settings.aiAvatar : defaultAvatar;

        headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${article.characterName}</div></div>`;


        contentHtml = `
            <span class="diary-title">${article.title}</span>
            <div class="memo-content-preview">${(article.content || '').replace(/\n/g, '<br>')}</div>
        `;
      } else if (item.type === 'char_memo') {
        const memo = item.content;
        sourceText = `Êù•Ëá™ ${memo.characterName} ÁöÑÂ§áÂøòÂΩï`;

        const charChat = state.chats[memo.characterId];
        const authorAvatar = charChat ? charChat.settings.aiAvatar : defaultAvatar;

        headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${memo.characterName}</div></div>`;


        contentHtml = `
        <span class="memo-title">${memo.title}</span>
        <div class="memo-content-preview">${memo.content.replace(/\n/g, '<br>')}</div>
    `;
      }


      card.innerHTML = `
                    <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
                    <div class="fav-card-content">${contentHtml}</div>
                    ${footerHtml}`;

      listEl.appendChild(card);
    }
  }




  async function renderFavoritesScreen() {

    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();


    const searchInput = document.getElementById('favorites-search-input');
    const clearBtn = document.getElementById('favorites-search-clear-btn');
    searchInput.value = '';
    clearBtn.style.display = 'none';


    displayFilteredFavorites(allFavoriteItems);
  }



  function resetCreatePostModal() {
    document.getElementById('post-public-text').value = '';
    document.getElementById('post-image-preview').src = '';
    document.getElementById('post-image-description').value = '';
    document.getElementById('post-image-preview-container').classList.remove('visible');
    document.getElementById('post-image-desc-group').style.display = 'none';
    document.getElementById('post-local-image-input').value = '';
    document.getElementById('post-hidden-text').value = '';
    document.getElementById('switch-to-image-mode').click();
  }

  async function cleanupRedundantData() {
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Ê∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆÔºü',
      'Ê≠§Êìç‰ΩúÂ∞ÜÊâ´ÊèèÊï∞ÊçÆÂ∫ìÔºåÁßªÈô§ÊâÄÊúâ‰∏éÂ∑≤Âà†Èô§ËßíËâ≤Áõ∏ÂÖ≥ÁöÑÂ≠§Á´ãÊï∞ÊçÆÔºàÂ¶ÇÂä®ÊÄÅ„ÄÅËØÑËÆ∫„ÄÅËÆ∞ÂøÜÁ≠âÔºâ„ÄÇ<br><br><strong>Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºå‰ΩÜÈÄöÂ∏∏ÊòØÂÆâÂÖ®ÁöÑ„ÄÇNPCÊï∞ÊçÆ‰∏ç‰ºöË¢´Âà†Èô§„ÄÇ</strong><br><br>Âª∫ËÆÆÂú®Êìç‰ΩúÂâçÂÖàÂØºÂá∫Êï∞ÊçÆÂ§á‰ªΩ„ÄÇ', {
      confirmButtonClass: 'btn-danger',
      confirmText: 'Á°ÆËÆ§Ê∏ÖÁêÜ'
    }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÂºÄÂßãÊ∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆÔºåËØ∑‰∏çË¶ÅÂÖ≥Èó≠È°µÈù¢...");
    console.log("ÂÜó‰ΩôÊï∞ÊçÆÊ∏ÖÁêÜÊµÅÁ®ãÂ∑≤ÂêØÂä®...");

    let cleanupCounts = {
      posts: 0,
      likes: 0,
      comments: 0,
      memories: 0,
      callRecords: 0,
      renderingRules: 0,
      groupMembers: 0,
      chatLinks: 0,
    };

    try {
      await db.transaction('rw', db.tables, async () => {

        const allChats = await db.chats.toArray();
        const allNpcs = await db.npcs.toArray();

        const existingChatIds = new Set(allChats.map(c => c.id));
        const existingNpcIds = new Set(allNpcs.map(n => `npc_${n.id}`));

        const existingOriginalNames = new Set(allChats.filter(c => !c.isGroup).map(c => c.originalName));
        existingOriginalNames.add(state.qzoneSettings.nickname || '{{user}}');

        allNpcs.forEach(npc => existingOriginalNames.add(npc.name));


        for (const chat of allChats) {
          let chatModified = false;
          if (chat.isGroup && chat.members) {
            const originalMemberCount = chat.members.length;



            chat.members = chat.members.filter(member =>
              existingChatIds.has(member.id) || existingNpcIds.has(member.id)
            );

            if (chat.members.length < originalMemberCount) {
              cleanupCounts.groupMembers += (originalMemberCount - chat.members.length);
              chatModified = true;
            }
          }

          if (chat.settings?.linkedMemoryChatIds?.length > 0) {
            const originalLinkCount = chat.settings.linkedMemoryChatIds.length;
            chat.settings.linkedMemoryChatIds = chat.settings.linkedMemoryChatIds.filter(id => existingChatIds.has(id));
            if (chat.settings.linkedMemoryChatIds.length < originalLinkCount) {
              cleanupCounts.chatLinks += (originalLinkCount - chat.settings.linkedMemoryChatIds.length);
              chatModified = true;
            }
          }
          if (chatModified) {
            await db.chats.put(chat);
          }
        }


        const allPosts = await db.qzonePosts.toArray();
        for (const post of allPosts) {
          let postModified = false;



          const isAuthorValid = post.authorId === 'user' || existingChatIds.has(post.authorId) || existingNpcIds.has(post.authorId);

          if (!isAuthorValid) {
            await db.qzonePosts.delete(post.id);
            cleanupCounts.posts++;
            continue;
          }

          if (post.likes && post.likes.length > 0) {
            const originalLikeCount = post.likes.length;
            post.likes = post.likes.filter(name => existingOriginalNames.has(name));
            if (post.likes.length < originalLikeCount) {
              cleanupCounts.likes += (originalLikeCount - post.likes.length);
              postModified = true;
            }
          }
          if (post.comments && post.comments.length > 0) {
            const originalCommentCount = post.comments.length;
            post.comments = post.comments.filter(comment => {
              if (typeof comment === 'object' && comment.commenterName) {
                return existingOriginalNames.has(comment.commenterName);
              }
              return true;
            });
            if (post.comments.length < originalCommentCount) {
              cleanupCounts.comments += (originalCommentCount - post.comments.length);
              postModified = true;
            }
          }
          if (postModified) {
            await db.qzonePosts.put(post);
          }
        }


        await db.memories.where('chatId').noneOf([...existingChatIds]).delete().then(c => cleanupCounts.memories += c);
        await db.callRecords.where('chatId').noneOf([...existingChatIds]).delete().then(c => cleanupCounts.callRecords += c);
        const allRules = await db.renderingRules.toArray();
        for (const rule of allRules) {
          if (rule.chatId !== 'global' && !existingChatIds.has(rule.chatId)) {
            await db.renderingRules.delete(rule.id);
            cleanupCounts.renderingRules++;
          }
        }
      });

      let summary = "‚úÖ Ê∏ÖÁêÜÂÆåÊàêÔºÅ\n\n";
      let cleanedSomething = false;
      Object.entries(cleanupCounts).forEach(([key, value]) => {
        if (value > 0) {
          const keyMap = {
            posts: 'Âä®ÊÄÅ',
            likes: 'ÁÇπËµû',
            comments: 'ËØÑËÆ∫',
            memories: 'ËÆ∞ÂøÜ',
            callRecords: 'ÈÄöËØùËÆ∞ÂΩï',
            renderingRules: 'Ê∏≤ÊüìËßÑÂàô',
            groupMembers: 'Áæ§ÊàêÂëò',
            chatLinks: 'ËÆ∞ÂøÜÈìæÊé•'
          };
          summary += `- Ê∏ÖÁêÜ‰∫Ü ${value} Êù°Êó†ÊïàÁöÑ${keyMap[key] || key}„ÄÇ\n`;
          cleanedSomething = true;
        }
      });
      if (!cleanedSomething) {
        summary = "‚úÖ Ê£ÄÊü•ÂÆåÊàêÔºåÊú™ÂèëÁé∞‰ªª‰ΩïÂÜó‰ΩôÊï∞ÊçÆ„ÄÇ";
      }
      summary += "\nÂª∫ËÆÆÂà∑Êñ∞È°µÈù¢‰ª•Á°Æ‰øùÊâÄÊúâÊõ¥ÊîπÁîüÊïà„ÄÇ";

      await showCustomAlert("Êìç‰ΩúÊàêÂäü", summary);

      const confirmedReload = await showCustomConfirm("Âà∑Êñ∞È°µÈù¢Ôºü", "‰∏∫‰∫ÜÁ°Æ‰øùÊâÄÊúâÊï∞ÊçÆÂêåÊ≠•ÔºåÂª∫ËÆÆÁ´ãÂç≥Âà∑Êñ∞È°µÈù¢„ÄÇ");
      if (confirmedReload) {
        location.reload();
      }

    } catch (error) {
      console.error("Ê∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆÊó∂Âá∫Èîô:", error);
      await showCustomAlert('Ê∏ÖÁêÜÂ§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
    }
  }

  async function exportBackup() {
    try {
      const backupData = {
        version: 1,
        timestamp: Date.now()
      };

      const [
        chats, worldBooks, userStickers, apiConfig, globalSettings,
        personaPresets, musicLibrary, qzoneSettings, qzonePosts,
        qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
        memories, worldBookCategories,
        apiPresets, shoppingProducts, callRecords,
        renderingRules,

        doubanPosts,
        stickerCategories,

        appearancePresets,

        presets,
        presetCategories,

        npcs,

        // Êñ∞Â¢ûÁöÑË°®
        stickerVisionCache,
        shoppingCategories,
        customAvatarFrames,
        readingLibrary,
        quickReplies,
        quickReplyCategories,
        npcGroups,
        naiPresets,
        grAuthors,
        grStories,
        userWallet,
        userTransactions,
        funds,
        auctions,
        inventory,
        emails,
        watchTogetherPlaylist
      ] = await Promise.all([
        db.chats.toArray(),
        db.worldBooks.toArray(),
        db.userStickers.toArray(),
        db.apiConfig.get('main'),
        db.globalSettings.get('main'),
        db.personaPresets.toArray(),
        db.musicLibrary.get('main'),
        db.qzoneSettings.get('main'),
        db.qzonePosts.toArray(),
        db.qzoneAlbums.toArray(),
        db.qzonePhotos.toArray(),
        db.favorites.toArray(),
        db.qzoneGroups.toArray(),
        db.memories.toArray(),
        db.worldBookCategories.toArray(),
        db.apiPresets.toArray(),
        db.shoppingProducts.toArray(),
        db.callRecords.toArray(),
        db.renderingRules.toArray(),

        db.doubanPosts.toArray(),
        db.stickerCategories.toArray(),

        db.appearancePresets.toArray(),

        db.presets.toArray(),
        db.presetCategories.toArray(),

        db.npcs.toArray(),

        // Êñ∞Â¢ûÁöÑË°®
        db.stickerVisionCache.toArray(),
        db.shoppingCategories.toArray(),
        db.customAvatarFrames.toArray(),
        db.readingLibrary.toArray(),
        db.quickReplies.toArray(),
        db.quickReplyCategories.toArray(),
        db.npcGroups.toArray(),
        db.naiPresets.toArray(),
        db.grAuthors.toArray(),
        db.grStories.toArray(),
        db.userWallet.get('main'),
        db.userTransactions.toArray(),
        db.funds.toArray(),
        db.auctions.toArray(),
        db.inventory.toArray(),
        db.emails.toArray(),
        db.watchTogetherPlaylist.toArray()
      ]);

      // ÊñπÊ°à3ÔºöÂØºÂá∫Êó∂ÁßªÈô§APIÂéÜÂè≤ËÆ∞ÂΩï
      const cleanedChats = removeApiHistoryFromChats(chats);

      Object.assign(backupData, {
        chats: cleanedChats,
        worldBooks,
        userStickers,
        apiConfig,
        globalSettings,
        personaPresets,
        musicLibrary,
        qzoneSettings,
        qzonePosts,
        qzoneAlbums,
        qzonePhotos,
        favorites,
        qzoneGroups,
        memories,
        worldBookCategories,
        apiPresets,
        shoppingProducts,
        callRecords,
        renderingRules,

        doubanPosts,
        stickerCategories,

        appearancePresets,

        presets,
        presetCategories,

        npcs,

        // Êñ∞Â¢ûÁöÑË°®
        stickerVisionCache,
        shoppingCategories,
        customAvatarFrames,
        readingLibrary,
        quickReplies,
        quickReplyCategories,
        npcGroups,
        naiPresets,
        grAuthors,
        grStories,
        userWallet,
        userTransactions,
        funds,
        auctions,
        inventory,
        emails,
        watchTogetherPlaylist
      });

      const blob = new Blob(
        [JSON.stringify(backupData, null, 2)], {
        type: 'application/json'
      }
      );
      const url = URL.createObjectURL(blob);
      const link = Object.assign(document.createElement('a'), {
        href: url,
        download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
      });
      link.click();
      URL.revokeObjectURL(url);

      await showCustomAlert('ÂØºÂá∫ÊàêÂäü', 'Â∑≤ÊàêÂäüÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆÔºÅ');

    } catch (error) {
      console.error("ÂØºÂá∫Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
    }
  }



  // Ê∏ÖÁêÜÊåáÂÆöÊï∞ÊçÆË°®
  async function cleanupTableData(tableName, statElem) {
    // ‰∏çÂèØÊ∏ÖÁêÜÁöÑÊ†∏ÂøÉË°®
    const protectedTables = ['apiConfig', 'globalSettings', 'userWallet'];
    
    if (protectedTables.includes(tableName)) {
      await showCustomAlert("Êó†Ê≥ïÊ∏ÖÁêÜ", "Ê≠§Êï∞ÊçÆË°®‰∏∫Á≥ªÁªüÊ†∏ÂøÉÈÖçÁΩÆÔºå‰∏çÂèØÊ∏ÖÁêÜ„ÄÇ");
      return false;
    }

    const confirmed = await showCustomConfirm(
      "Á°ÆËÆ§Ê∏ÖÁêÜÊï∞ÊçÆ",
      `Âç≥Â∞ÜÊ∏ÖÁ©∫ <strong>${statElem.dataset.tableCnName}</strong> ÁöÑÊâÄÊúâÊï∞ÊçÆ„ÄÇ<br><br>‚ö†Ô∏è <strong>Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ</strong><br>Âª∫ËÆÆÂú®Ê∏ÖÁêÜÂâçÂÖàÂ§á‰ªΩÊï∞ÊçÆ„ÄÇ`,
      {
        confirmButtonClass: 'btn-danger',
        confirmText: 'Á°ÆËÆ§Ê∏ÖÁêÜ'
      }
    );

    if (!confirmed) return false;

    try {
      // ÊâßË°åÊ∏ÖÁêÜ
      await db.table(tableName).clear();
      return true;
    } catch (error) {
      console.error(`Ê∏ÖÁêÜË°® ${tableName} Â§±Ë¥•:`, error);
      await showCustomAlert("Ê∏ÖÁêÜÂ§±Ë¥•", `ÂèëÁîüÈîôËØØ: ${error.message}`);
      return false;
    }
  }

  // Êü•ÁúãÊï∞ÊçÆÂàÜÂ∏ÉÁªüËÆ°ÔºàÊîπ‰∏∫ÊòæÁ§∫ÂÖ®Â±èÁïåÈù¢Ôºâ
  async function viewDataDistribution() {
    // ÊòæÁ§∫Êï∞ÊçÆÂàÜÊûêÁªüËÆ°ÁïåÈù¢
    showScreen('data-distribution-screen');
    
    // Ëé∑ÂèñÂÆπÂô®Âπ∂Ê∏≤ÊüìÊï∞ÊçÆ
    const container = document.getElementById('data-distribution-container');
    await renderDistributionData(container);
  }

  // Ê∏≤ÊüìÊï∞ÊçÆÂàÜÂ∏ÉÂÜÖÂÆπ
  async function renderDistributionData(container) {
    container.innerHTML = '<p style="text-align: center; padding: 40px 0;">Ê≠£Âú®ÁªüËÆ°Êï∞ÊçÆ...</p>';

    try {
      // Êï∞ÊçÆË°®ÁöÑ‰∏≠ÊñáÂêçÁß∞Êò†Â∞Ñ
      const tableNameMap = {
        chats: 'ËÅäÂ§©ËÆ∞ÂΩï',
        worldBooks: '‰∏ñÁïå‰π¶',
        userStickers: 'Ë°®ÊÉÖÂåÖ',
        apiConfig: 'APIÈÖçÁΩÆ',
        globalSettings: 'ÂÖ®Â±ÄËÆæÁΩÆ',
        personaPresets: '‰∫∫ËÆæÈ¢ÑËÆæ',
        musicLibrary: 'Èü≥‰πêÂ∫ì',
        qzoneSettings: 'Á©∫Èó¥ËÆæÁΩÆ',
        qzonePosts: 'Á©∫Èó¥Âä®ÊÄÅ',
        qzoneAlbums: 'Áõ∏ÂÜå',
        qzonePhotos: 'Áõ∏Áâá',
        favorites: 'Êî∂Ëóè',
        qzoneGroups: 'ÂàÜÁªÑ',
        memories: 'ËÆ∞ÂøÜ',
        worldBookCategories: '‰∏ñÁïå‰π¶ÂàÜÁ±ª',
        apiPresets: 'APIÈ¢ÑËÆæ',
        shoppingProducts: 'ÂïÜÂìÅ',
        callRecords: 'ÈÄöËØùËÆ∞ÂΩï',
        renderingRules: 'Ê∏≤ÊüìËßÑÂàô',
        doubanPosts: 'Ë±ÜÁì£Â∏ñÂ≠ê',
        stickerCategories: 'Ë°®ÊÉÖÂåÖÂàÜÁ±ª',
        appearancePresets: 'Â§ñËßÇÈ¢ÑËÆæ',
        presets: 'È¢ÑËÆæ',
        presetCategories: 'È¢ÑËÆæÂàÜÁ±ª',
        npcs: 'NPC',
        stickerVisionCache: 'Ë°®ÊÉÖËØÜÂà´ÁºìÂ≠ò',
        shoppingCategories: 'ÂïÜÂìÅÂàÜÁ±ª',
        customAvatarFrames: 'Ëá™ÂÆö‰πâÂ§¥ÂÉèÊ°Ü',
        readingLibrary: 'ÈòÖËØªÂ∫ì',
        quickReplies: 'Âø´Êç∑ÂõûÂ§ç',
        quickReplyCategories: 'Âø´Êç∑ÂõûÂ§çÂàÜÁ±ª',
        npcGroups: 'NPCÂàÜÁªÑ',
        naiPresets: 'NAIÈ¢ÑËÆæ',
        grAuthors: 'ÁªøÊ±ü‰ΩúËÄÖ',
        grStories: 'ÁªøÊ±üÊïÖ‰∫ã',
        userWallet: 'Èí±ÂåÖ',
        userTransactions: '‰∫§ÊòìËÆ∞ÂΩï',
        funds: 'Âü∫Èáë',
        auctions: 'ÊãçÂçñ',
        inventory: 'ËÉåÂåÖ',
        emails: 'ÈÇÆ‰ª∂',
        watchTogetherPlaylist: 'ËßÇÂΩ±Êí≠ÊîæÂàóË°®'
      };

      // ÁªüËÆ°ÂêÑË°®Êï∞ÊçÆ
      const stats = [];
      let totalRecords = 0;
      let totalSize = 0;

      for (const table of db.tables) {
        const tableName = table.name;
        const count = await table.count();
        
        if (count > 0) {
          // Ëé∑ÂèñË°®Êï∞ÊçÆÂπ∂ËÆ°ÁÆóÂ§ßÂ∞è
          const data = await table.toArray();
          const dataStr = JSON.stringify(data);
          const sizeBytes = new Blob([dataStr]).size;
          const sizeMB = (sizeBytes / 1024 / 1024).toFixed(2);
          
          stats.push({
            name: tableNameMap[tableName] || tableName,
            tableName: tableName,
            count: count,
            size: sizeBytes,
            sizeMB: sizeMB
          });
          
          totalRecords += count;
          totalSize += sizeBytes;
        }
      }

      // ÊåâÊï∞ÊçÆÈáèÂ§ßÂ∞èÊéíÂ∫è
      stats.sort((a, b) => b.size - a.size);

      // ËÆ°ÁÆóÊÄªÂ§ßÂ∞è
      const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);

      // ÁîüÊàêHTMLÊòæÁ§∫
      let html = `
        <div style="text-align: left;">
          <div style="background: var(--bg-secondary, #f5f5f5); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: var(--text-primary);">üìä Êï∞ÊçÆÊÄªËßà</h3>
            <p style="margin: 5px 0; font-size: 14px;">
              <strong>ÊÄªËÆ∞ÂΩïÊï∞Ôºö</strong><span style="color: #007bff;">${totalRecords.toLocaleString()}</span> Êù°
            </p>
            <p style="margin: 5px 0; font-size: 14px;">
              <strong>ÊÄªÊï∞ÊçÆÈáèÔºö</strong><span style="color: #28a745;">${totalSizeMB}</span> MB
            </p>
            <p style="margin: 5px 0; font-size: 14px;">
              <strong>ÂåÖÂê´Ë°®Êï∞Ôºö</strong><span style="color: #6c757d;">${stats.length}</span> ‰∏™
            </p>
          </div>

          <div style="background: var(--bg-primary, #fff); border-radius: 10px; overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead style="background: var(--bg-secondary, #f5f5f5); position: sticky; top: 0;">
                <tr>
                  <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color, #ddd); min-width: 140px;">Êï∞ÊçÆÁ±ªÂûã</th>
                  <th style="padding: 10px; text-align: right; border-bottom: 1px solid var(--border-color, #ddd); width: 90px;">ËÆ∞ÂΩïÊï∞</th>
                  <th style="padding: 10px; text-align: right; border-bottom: 1px solid var(--border-color, #ddd); width: 80px;">Â§ßÂ∞è(MB)</th>
                  <th style="padding: 10px; text-align: right; border-bottom: 1px solid var(--border-color, #ddd); width: 150px;">Âç†ÊØî</th>
                  <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color, #ddd); width: 80px;">Êìç‰Ωú</th>
                </tr>
              </thead>
              <tbody>
      `;

      stats.forEach((stat, index) => {
        const percentage = ((stat.size / totalSize) * 100).toFixed(1);
        const bgColor = index % 2 === 0 ? 'transparent' : 'var(--bg-secondary, #f9f9f9)';
        const canClean = !['apiConfig', 'globalSettings', 'userWallet'].includes(stat.tableName);
        
        html += `
          <tr class="stat-row" data-table-name="${stat.tableName}" data-table-cn-name="${stat.name}" style="background: ${bgColor};">
            <td style="padding: 10px; border-bottom: 1px solid var(--border-color, #eee);">
              <div style="font-weight: 500;">${stat.name}</div>
              <div style="font-size: 11px; color: var(--text-secondary, #999);">${stat.tableName}</div>
            </td>
            <td class="stat-count" style="padding: 10px; text-align: right; border-bottom: 1px solid var(--border-color, #eee); color: #007bff;">
              ${stat.count.toLocaleString()}
            </td>
            <td class="stat-size" style="padding: 10px; text-align: right; border-bottom: 1px solid var(--border-color, #eee); color: #28a745;">
              ${stat.sizeMB}
            </td>
            <td class="stat-percentage" style="padding: 10px; text-align: right; border-bottom: 1px solid var(--border-color, #eee);">
              <div style="display: flex; align-items: center; justify-content: flex-end; gap: 5px;">
                <div style="width: 60px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                  <div class="percentage-bar" style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); border-radius: 4px;"></div>
                </div>
                <span class="percentage-text" style="font-size: 12px; color: var(--text-secondary); min-width: 45px;">${percentage}%</span>
              </div>
            </td>
            <td style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color, #eee);">
              ${canClean ? `
                <button class="cleanup-btn" data-table="${stat.tableName}" style="
                  background: #ff3b30;
                  color: white;
                  border: none;
                  padding: 5px 12px;
                  border-radius: 5px;
                  font-size: 12px;
                  cursor: pointer;
                  transition: all 0.2s;
                " onmouseover="this.style.background='#d32f2f'" onmouseout="this.style.background='#ff3b30'">
                  Ê∏ÖÁêÜ
                </button>
              ` : `<span style="font-size: 11px; color: #999;">‰∏çÂèØÊ∏ÖÁêÜ</span>`}
            </td>
          </tr>
        `;
      });

      html += `
              </tbody>
            </table>
          </div>

          <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
            <p style="margin: 0; font-size: 12px; color: #856404;">
              üí° <strong>ÊèêÁ§∫Ôºö</strong>ÁÇπÂáª"Ê∏ÖÁêÜ"ÊåâÈíÆÂèØ‰ª•Ê∏ÖÁ©∫ÂØπÂ∫îÊï∞ÊçÆË°®„ÄÇÊ∏ÖÁêÜÂêéÊï∞ÊçÆÂ∞ÜÂÆûÊó∂Êõ¥Êñ∞„ÄÇ<strong>Ê∏ÖÁêÜÂâçËØ∑Âä°ÂøÖÂ§á‰ªΩÔºÅ</strong>
            </p>
          </div>
        </div>
      `;

      container.innerHTML = html;

      // ÁªëÂÆöÊ∏ÖÁêÜÊåâÈíÆ‰∫ã‰ª∂
      container.querySelectorAll('.cleanup-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const tableName = btn.dataset.table;
          const row = btn.closest('.stat-row');
          
          // ÊâßË°åÊ∏ÖÁêÜ
          const success = await cleanupTableData(tableName, row);
          
          if (success) {
            // Ê∏ÖÁêÜÊàêÂäüÔºåÂà∑Êñ∞ÊòæÁ§∫
            showToast('Êï∞ÊçÆÂ∑≤Ê∏ÖÁêÜÔºåÊ≠£Âú®Âà∑Êñ∞ÁªüËÆ°...', 'success');
            await renderDistributionData(container);
          }
        });
      });

    } catch (error) {
      console.error("ÁªüËÆ°Êï∞ÊçÆÂàÜÂ∏ÉÊó∂Âá∫Èîô:", error);
      container.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
          <p style="color: #ff3b30; font-size: 16px; margin-bottom: 10px;">‚ö†Ô∏è ÁªüËÆ°Â§±Ë¥•</p>
          <p style="color: #666; font-size: 14px;">${error.message}</p>
        </div>
      `;
    }
  }


  async function importStreamedBackup(backupData) {
    try {
      await db.transaction('rw', db.tables, async () => {

        for (const table of db.tables) {
          await table.clear();
        }


        for (const tableName in backupData) {
          if (Array.isArray(backupData[tableName])) {
            console.log(`Ê≠£Âú®ÂØºÂÖ•Ë°®: ${tableName}, ËÆ∞ÂΩïÊï∞: ${backupData[tableName].length}`);
            await db.table(tableName).bulkPut(backupData[tableName]);
          }
        }
      });

    } catch (error) {

      throw new Error(`Êï∞ÊçÆÂ∫ìÂÜôÂÖ•Â§±Ë¥•: ${error.message}`);
    }
  }





  async function handleSmartImport(file) {
    if (!file) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØªÂèñÂπ∂Ëß£ÊûêÂ§á‰ªΩÊñá‰ª∂...");

    try {
      const text = await file.text();
      const data = JSON.parse(text);

      let backupDataContent;
      let backupType;


      if (data.data && typeof data.data === 'object' && (data.data.chats || data.data.worldBooks)) {
        console.log("Ê£ÄÊµãÂà∞Êñ∞ÁâàÊµÅÂºèÂ§á‰ªΩÊñá‰ª∂...");
        backupDataContent = data.data;
        backupType = 'streamed'; // 'streamed' or 'legacy'
      } else if (data.chats || data.worldBooks) {
        console.log("Ê£ÄÊµãÂà∞ÊóßÁâàÂÆåÊï¥Â§á‰ªΩÊñá‰ª∂...");
        backupDataContent = data;
        backupType = 'legacy';
      } else {
        throw new Error("Êñá‰ª∂Ê†ºÂºèÊó†Ê≥ïËØÜÂà´„ÄÇËØ∑Á°Æ‰øùÊÇ®ÈÄâÊã©ÁöÑÊòØÊúâÊïàÁöÑ EPhone Â§á‰ªΩÊñá‰ª∂„ÄÇ");
      }


      pendingBackupData = {
        type: backupType,
        content: backupDataContent
      };


      openImportOptionsModal(backupDataContent);

    } catch (error) {
      console.error("ÂØºÂÖ•Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
      pendingBackupData = null;
      await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ëß£ÊûêÊàñÂ∫îÁî®Â§±Ë¥•: ${error.message}`);
    }
  }


  function openImportOptionsModal(backupDataContent) {
    const modal = document.getElementById('import-options-modal');
    const listEl = document.getElementById('import-preview-list');
    listEl.innerHTML = '';

    const contentSummary = {
      'chats': 'ËÅäÂ§©‰ºöËØù',
      'worldBooks': '‰∏ñÁïå‰π¶',
      'worldBookCategories': '‰∏ñÁïå‰π¶ÂàÜÁ±ª',
      'presets': 'Á¶ªÁ∫øÈ¢ÑËÆæ',
      'presetCategories': 'È¢ÑËÆæÂàÜÁ±ª',
      'userStickers': 'Ë°®ÊÉÖÂåÖ',
      'stickerCategories': 'Ë°®ÊÉÖÂàÜÁ±ª',
      'customAvatarFrames': 'Â§¥ÂÉèÊ°Ü',
      'apiConfig': 'APIÈÖçÁΩÆ',
      'globalSettings': 'ÂÖ®Â±ÄËÆæÁΩÆ',
      'personaPresets': '‰∫∫ËÆæÈ¢ÑËÆæ',
      'qzoneSettings': 'Á©∫Èó¥ËÆæÁΩÆ',
      'qzonePosts': 'Âä®ÊÄÅ',
      'qzoneAlbums': 'Áõ∏ÂÜå',
      'qzonePhotos': 'Áõ∏ÂÜåÁÖßÁâá',
      'favorites': 'Êî∂Ëóè',
      'qzoneGroups': 'Á©∫Èó¥ÂàÜÁªÑ',
      'memories': 'ÂõûÂøÜ',
      'callRecords': 'ÈÄöËØùËÆ∞ÂΩï',
      'shoppingProducts': 'ÂïÜÂìÅ',
      'shoppingCategories': 'ÂïÜÂìÅÂàÜÁ±ª',
      'apiPresets': 'APIÈ¢ÑËÆæ',
      'renderingRules': 'Ê∏≤ÊüìËßÑÂàô',
      'appearancePresets': 'Â§ñËßÇÈ¢ÑËÆæ',
      'npcs': 'NPCs',
      'npcGroups': 'NPCÂàÜÁªÑ',
      'doubanPosts': 'Ë±ÜÁì£Âä®ÊÄÅ',
      'stickerVisionCache': 'Ë°®ÊÉÖÁºìÂ≠ò',
      'readingLibrary': 'ÈòÖËØªÂ∫ì',
      'quickReplies': 'Âø´Êç∑ÂõûÂ§ç',
      'quickReplyCategories': 'Âø´Êç∑ÂõûÂ§çÂàÜÁ±ª',
      'naiPresets': 'NAIÈ¢ÑËÆæ',
      'grAuthors': 'ÊïÖ‰∫ã‰ΩúËÄÖ',
      'grStories': 'ÊïÖ‰∫ã',
      'userWallet': 'Áî®Êà∑Èí±ÂåÖ',
      'userTransactions': '‰∫§ÊòìËÆ∞ÂΩï',
      'funds': 'Âü∫Èáë',
      'auctions': 'ÊãçÂçñËÆ∞ÂΩï',
      'inventory': 'Áâ©ÂìÅÊ∏ÖÂçï',
      'emails': 'ÈÇÆ‰ª∂',
      'watchTogetherPlaylist': 'ËßÇÂΩ±Êí≠ÊîæÂàóË°®'
    };

    let foundData = false;
    for (const key in contentSummary) {
      if (backupDataContent[key] && (Array.isArray(backupDataContent[key]) ? backupDataContent[key].length > 0 : backupDataContent[key])) {
        const count = Array.isArray(backupDataContent[key]) ? backupDataContent[key].length : 1;
        const li = document.createElement('li');
        li.textContent = `${contentSummary[key]}: ${count} Êù°/‰∏™`;
        listEl.appendChild(li);
        foundData = true;
      }
    }

    if (!foundData) {
      listEl.innerHTML = '<li>Êú™Âú®Ê≠§Êñá‰ª∂‰∏≠ÊâæÂà∞ÂèØËØÜÂà´ÁöÑÊï∞ÊçÆ„ÄÇ</li>';
    }


    document.getElementById('confirm-full-import-btn').onclick = () => {
      modal.classList.remove('visible');
      handleFullImport(pendingBackupData);
    };
    document.getElementById('confirm-selective-import-btn').onclick = () => {
      modal.classList.remove('visible');
      openSelectiveImportModal(pendingBackupData.content);
    };
    document.getElementById('cancel-import-options-btn').onclick = () => {
      modal.classList.remove('visible');
      pendingBackupData = null;
    };

    modal.classList.add('visible');
  }


  async function handleFullImport(backupInfo) {
    if (!backupInfo) return;

    const confirmed = await showCustomConfirm(
      '‰∏•ÈáçË≠¶ÂëäÔºÅ',
      '„ÄêÂÆåÂÖ®ÂØºÂÖ•„ÄëÂ∞ÜÂà†Èô§ÊÇ®ÂΩìÂâçÁöÑÊâÄÊúâÊï∞ÊçÆÂπ∂ÊõøÊç¢‰∏∫Â§á‰ªΩÊñá‰ª∂‰∏≠ÁöÑÂÜÖÂÆπ„ÄÇÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ<br><br><strong>Á°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü</strong>', {
      confirmButtonClass: 'btn-danger',
      confirmText: 'ÊàëÊòéÁôΩÔºåË¶ÜÁõñÊâÄÊúâÊï∞ÊçÆ'
    }
    );
    if (!confirmed) {
      pendingBackupData = null;
      return;
    }

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÊâßË°åÂÆåÂÖ®ÂØºÂÖ•ÔºåËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢...");

    try {
      if (backupInfo.type === 'streamed') {
        await importStreamedBackup(backupInfo.content);
      } else if (backupInfo.type === 'legacy') {
        await importLegacyBackup(backupInfo.content);
      } else {
        throw new Error("Êú™Áü•ÁöÑÂ§á‰ªΩÁ±ªÂûã„ÄÇ");
      }

      await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', 'ÊâÄÊúâÊï∞ÊçÆÂ∑≤ÊàêÂäüÊÅ¢Â§çÔºÅÂ∫îÁî®Âç≥Â∞ÜÂà∑Êñ∞‰ª•Â∫îÁî®ÊâÄÊúâÊõ¥Êîπ„ÄÇ');
      try {
        const restoredApiConfig = await db.apiConfig.get('main');
        if (restoredApiConfig) {
          // ÂêåÊ≠• ImgBB
          if (restoredApiConfig.imgbbApiKey) localStorage.setItem('imgbb-api-key', restoredApiConfig.imgbbApiKey);
          if (restoredApiConfig.imgbbEnable !== undefined) localStorage.setItem('imgbb-enabled', restoredApiConfig.imgbbEnable);

          // ÂêåÊ≠• Minimax
          if (restoredApiConfig.minimaxGroupId) localStorage.setItem('minimax-group-id', restoredApiConfig.minimaxGroupId);
          if (restoredApiConfig.minimaxApiKey) localStorage.setItem('minimax-api-key', restoredApiConfig.minimaxApiKey);
          if (restoredApiConfig.minimaxModel) localStorage.setItem('minimax-model', restoredApiConfig.minimaxModel);

          // ÂêåÊ≠• Catbox
          if (restoredApiConfig.catboxUserHash) localStorage.setItem('catbox-userhash', restoredApiConfig.catboxUserHash);
          if (restoredApiConfig.catboxEnable !== undefined) localStorage.setItem('catbox-enabled', restoredApiConfig.catboxEnable);

          // ÂêåÊ≠• NovelAI
          const novelaiSettings = localStorage.getItem('novelai-settings'); // NovelAIÈÖçÁΩÆÊØîËæÉÁâπÊÆäÔºåÈÄöÂ∏∏Âú®localStorageÔºåÂ¶ÇÊûúÂ§á‰ªΩÈáåÊúâ‰πüÂèØ‰ª•ÊÅ¢Â§ç
          // Ê≥®ÊÑèÔºö‰Ω†ÁöÑ‰ª£Á†Å‰ºº‰πéÊ≤°ÊúâÊää novelai ÁöÑ key Â≠òÂÖ• apiConfig Ë°®ÔºåËÄåÊòØÁõ¥Êé•Â≠ò localStorageÔºå
          // Â¶ÇÊûú‰Ω†ÁöÑÂ§á‰ªΩÈÄªËæëÈáåÊ≤°ÊúâÂåÖÂê´ localStorage ÁöÑ novelai Êï∞ÊçÆÔºåÂØºÂÖ•ÂêéÁ°ÆÂÆû‰ºö‰∏¢Â§±„ÄÇ
          // ‰ΩÜËøôÈáåÊàë‰ª¨‰∏ªË¶Å‰øÆÂ§ç ImgBB/Minimax/Catbox„ÄÇ
        }
        console.log("API ÈÖçÁΩÆÂ∑≤Âº∫Âà∂ÂêåÊ≠•Âà∞Êú¨Âú∞ÁºìÂ≠ò„ÄÇ");
      } catch (e) {
        console.error("ÂêåÊ≠•ÈÖçÁΩÆÂ§±Ë¥•:", e);
      }
      setTimeout(() => window.location.reload(), 1500);

    } catch (error) {
      console.error("ÂÆåÂÖ®ÂØºÂÖ•Â§±Ë¥•:", error);
      await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Â∫îÁî®Â§±Ë¥•: ${error.message}`);
    } finally {
      pendingBackupData = null;
    }
  }


  function openSelectiveImportModal(backupDataContent) {
    const modal = document.getElementById('selective-import-modal');
    const listEl = document.getElementById('selective-import-list');
    const selectAllCheckbox = document.getElementById('select-all-import-types');
    listEl.innerHTML = '';
    selectAllCheckbox.checked = true;

    const contentSummary = {
      'chats': 'ËÅäÂ§©‰ºöËØù',
      'worldBooks': '‰∏ñÁïå‰π¶',
      'worldBookCategories': '‰∏ñÁïå‰π¶ÂàÜÁ±ª',
      'presets': 'Á¶ªÁ∫øÈ¢ÑËÆæ',
      'presetCategories': 'È¢ÑËÆæÂàÜÁ±ª',
      'userStickers': 'Ë°®ÊÉÖÂåÖ',
      'stickerCategories': 'Ë°®ÊÉÖÂàÜÁ±ª',
      'customAvatarFrames': 'Â§¥ÂÉèÊ°Ü',
      'apiConfig': 'APIÈÖçÁΩÆ',
      'globalSettings': 'ÂÖ®Â±ÄËÆæÁΩÆ',
      'personaPresets': '‰∫∫ËÆæÈ¢ÑËÆæ',
      'qzoneSettings': 'Á©∫Èó¥ËÆæÁΩÆ',
      'qzonePosts': 'Âä®ÊÄÅ',
      'qzoneAlbums': 'Áõ∏ÂÜå',
      'qzonePhotos': 'Áõ∏ÂÜåÁÖßÁâá',
      'qzoneGroups': 'Á©∫Èó¥ÂàÜÁªÑ',
      'favorites': 'Êî∂Ëóè',
      'memories': 'ÂõûÂøÜ',
      'callRecords': 'ÈÄöËØùËÆ∞ÂΩï',
      'shoppingProducts': 'ÂïÜÂìÅ',
      'shoppingCategories': 'ÂïÜÂìÅÂàÜÁ±ª',
      'apiPresets': 'APIÈ¢ÑËÆæ',
      'renderingRules': 'Ê∏≤ÊüìËßÑÂàô',
      'appearancePresets': 'Â§ñËßÇÈ¢ÑËÆæ',
      'npcs': 'NPCs',
      'npcGroups': 'NPCÂàÜÁªÑ',
      'doubanPosts': 'Ë±ÜÁì£Âä®ÊÄÅ',
      'stickerVisionCache': 'Ë°®ÊÉÖÁºìÂ≠ò',
      'readingLibrary': 'ÈòÖËØªÂ∫ì',
      'quickReplies': 'Âø´Êç∑ÂõûÂ§ç',
      'quickReplyCategories': 'Âø´Êç∑ÂõûÂ§çÂàÜÁ±ª',
      'naiPresets': 'NAIÈ¢ÑËÆæ',
      'grAuthors': 'ÊïÖ‰∫ã‰ΩúËÄÖ',
      'grStories': 'ÊïÖ‰∫ã',
      'userWallet': 'Áî®Êà∑Èí±ÂåÖ',
      'userTransactions': '‰∫§ÊòìËÆ∞ÂΩï',
      'funds': 'Âü∫Èáë',
      'auctions': 'ÊãçÂçñËÆ∞ÂΩï',
      'inventory': 'Áâ©ÂìÅÊ∏ÖÂçï',
      'emails': 'ÈÇÆ‰ª∂',
      'watchTogetherPlaylist': 'ËßÇÂΩ±Êí≠ÊîæÂàóË°®'
    };

    let hasContent = false;
    for (const key in contentSummary) {
      if (backupDataContent[key] && (Array.isArray(backupDataContent[key]) ? backupDataContent[key].length > 0 : backupDataContent[key])) {
        const count = Array.isArray(backupDataContent[key]) ? backupDataContent[key].length : 1;
        const isSingleObject = !Array.isArray(backupDataContent[key]);

        const item = document.createElement('div');
        item.className = 'clear-posts-item selected';
        item.dataset.typeId = key;
        item.innerHTML = `
                <div class="checkbox selected"></div>
                <div>
                    <span class="name">${contentSummary[key]} (${count} Êù°/‰∏™)</span>
                    ${isSingleObject ? '<p style="font-size: 12px; color: #ff8c00; margin: 4px 0 0;">(Ê≥®ÊÑè: ËøôÂ∞Ü„ÄêË¶ÜÁõñ„ÄëÊÇ®ÂΩìÂâçÁöÑËÆæÁΩÆ)</p>' : ''}
                </div>
            `;
        listEl.appendChild(item);
        hasContent = true;
      }
    }

    if (!hasContent) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Êñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÂèØÂêàÂπ∂ÁöÑÊï∞ÊçÆ„ÄÇ</p>';
    }


    document.getElementById('confirm-merge-import-btn').onclick = () => handleSelectiveImport(pendingBackupData);
    document.getElementById('cancel-selective-import-btn').onclick = () => {
      modal.classList.remove('visible');
      pendingBackupData = null;
    };

    selectAllCheckbox.onchange = (e) => {
      const isChecked = e.target.checked;
      listEl.querySelectorAll('.clear-posts-item').forEach(item => {
        item.classList.toggle('selected', isChecked);
        item.querySelector('.checkbox').classList.toggle('selected', isChecked);
      });
    };

    listEl.onclick = (e) => {
      const item = e.target.closest('.clear-posts-item');
      if (item) {
        item.classList.toggle('selected');
        item.querySelector('.checkbox').classList.toggle('selected');
      }
    };

    modal.classList.add('visible');
  }


  async function handleSelectiveImport(backupInfo) {
    if (!backupInfo) return;

    const selectedItems = document.querySelectorAll('#selective-import-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÁßçË¶ÅÂêàÂπ∂ÁöÑÊï∞ÊçÆÁ±ªÂûã„ÄÇ");
      return;
    }

    const typesToMerge = Array.from(selectedItems).map(item => item.dataset.typeId);
    const dataToMerge = backupInfo.content;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§ÂêàÂπ∂Ôºü',
      'ËøôÂ∞ÜÊääÊÇ®ÈÄâÊã©ÁöÑÊï∞ÊçÆ„ÄêÊ∑ªÂä†Âπ∂Ë¶ÜÁõñ„ÄëÂà∞Áé∞ÊúâÊï∞ÊçÆ‰∏≠„ÄÇÂêåIDÁöÑÊï∞ÊçÆÂ∞ÜË¢´Êõ¥Êñ∞ÔºåÊñ∞Êï∞ÊçÆÂ∞ÜË¢´Ê∑ªÂä†„ÄÇ<br><br><strong>Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ</strong>', {
      confirmText: 'Á°ÆËÆ§ÂêàÂπ∂'
    }
    );
    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÂêàÂπ∂Êï∞ÊçÆÔºåËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢...");

    try {

      await db.transaction('rw', db.tables, async () => {
        for (const type of typesToMerge) {
          const data = dataToMerge[type];
          if (!data) continue;

          const table = db.table(type);
          if (!table) {
            console.warn(`Êâæ‰∏çÂà∞Ë°®: ${type}, Ë∑≥Ëøá...`);
            continue;
          }

          if (Array.isArray(data)) {

            console.log(`Ê≠£Âú®ÂêàÂπ∂ ${data.length} Êù°ËÆ∞ÂΩïÂà∞ ${type}...`);
            await table.bulkPut(data);
          } else if (typeof data === 'object' && data.id) {

            console.log(`Ê≠£Âú®ÂêàÂπ∂ÂçïÊù°ËÆ∞ÂΩïÂà∞ ${type}...`);
            await table.put(data);
          } else if (typeof data === 'object') {

            console.log(`Ê≠£Âú®ÂêàÂπ∂ÈùûÊ†áÂØπË±°Âà∞ ${type}...`);
            const existingData = await table.toCollection().first() || {};
            const mergedData = {
              ...existingData,
              ...data
            };


            if (existingData.id) {
              mergedData.id = existingData.id;
            } else if (type === 'apiConfig' || type === 'qzoneSettings' || type === 'globalSettings' || type === 'musicLibrary' || type === 'userWallet') {
              mergedData.id = 'main';
            }

            await table.put(mergedData);
          }
        }
      });

      await showCustomAlert('ÂêàÂπ∂ÊàêÂäü', 'Êï∞ÊçÆÂ∑≤ÊàêÂäüÂêàÂπ∂ÔºÅÂ∫îÁî®Âç≥Â∞ÜÂà∑Êñ∞‰ª•Â∫îÁî®ÊâÄÊúâÊõ¥Êîπ„ÄÇ');
      setTimeout(() => window.location.reload(), 1500);

    } catch (error) {
      console.error("ÈÄâÊã©ÊÄßÂØºÂÖ•Â§±Ë¥•:", error);
      await showCustomAlert('ÂêàÂπ∂Â§±Ë¥•', `Êñá‰ª∂Â∫îÁî®Â§±Ë¥•: ${error.message}`);
    } finally {
      pendingBackupData = null;
    }
  }


  async function importLegacyBackup(backupData) {
    try {
      await db.transaction('rw', db.tables, async () => {
        await db.chats.clear();
        await db.worldBooks.clear();

        for (const table of db.tables) {
          await table.clear();
        }

        if (Array.isArray(backupData.chats)) await db.chats.bulkPut(backupData.chats);
        if (Array.isArray(backupData.worldBooks)) await db.worldBooks.bulkPut(backupData.worldBooks);

        if (Array.isArray(backupData.userStickers)) await db.userStickers.bulkPut(backupData.userStickers);
        if (backupData.apiConfig) await db.apiConfig.put(backupData.apiConfig);
        if (backupData.globalSettings) await db.globalSettings.put(backupData.globalSettings);

        if (Array.isArray(backupData.personaPresets)) await db.personaPresets.bulkPut(backupData.personaPresets);
        if (backupData.musicLibrary) await db.musicLibrary.put(backupData.musicLibrary);
        if (backupData.qzoneSettings) await db.qzoneSettings.put(backupData.qzoneSettings);
        if (Array.isArray(backupData.qzonePosts)) await db.qzonePosts.bulkPut(backupData.qzonePosts);
        if (Array.isArray(backupData.qzoneAlbums)) await db.qzoneAlbums.bulkPut(backupData.qzoneAlbums);
        if (Array.isArray(backupData.qzonePhotos)) await db.qzonePhotos.bulkPut(backupData.qzonePhotos);
        if (Array.isArray(backupData.favorites)) await db.favorites.bulkPut(backupData.favorites);
        if (Array.isArray(backupData.qzoneGroups)) await db.qzoneGroups.bulkPut(backupData.qzoneGroups);
        if (Array.isArray(backupData.memories)) await db.memories.bulkPut(backupData.memories);
        if (Array.isArray(backupData.worldBookCategories)) await db.worldBookCategories.bulkPut(backupData.worldBookCategories);
        if (Array.isArray(backupData.apiPresets)) await db.apiPresets.bulkPut(backupData.apiPresets);
        if (Array.isArray(backupData.shoppingProducts)) await db.shoppingProducts.bulkPut(backupData.shoppingProducts);
        if (Array.isArray(backupData.callRecords)) await db.callRecords.bulkPut(backupData.callRecords);
        if (Array.isArray(backupData.renderingRules)) await db.renderingRules.bulkPut(backupData.renderingRules);
        if (Array.isArray(backupData.doubanPosts)) await db.doubanPosts.bulkPut(backupData.doubanPosts);
        if (Array.isArray(backupData.stickerCategories)) await db.stickerCategories.bulkPut(backupData.stickerCategories);
        if (Array.isArray(backupData.appearancePresets)) await db.appearancePresets.bulkPut(backupData.appearancePresets);
        if (Array.isArray(backupData.presets)) await db.presets.bulkPut(backupData.presets);
        if (Array.isArray(backupData.presetCategories)) await db.presetCategories.bulkPut(backupData.presetCategories);
        if (Array.isArray(backupData.npcs)) await db.npcs.bulkPut(backupData.npcs);

        // Êñ∞Â¢ûÁöÑË°®
        if (Array.isArray(backupData.stickerVisionCache)) await db.stickerVisionCache.bulkPut(backupData.stickerVisionCache);
        if (Array.isArray(backupData.shoppingCategories)) await db.shoppingCategories.bulkPut(backupData.shoppingCategories);
        if (Array.isArray(backupData.customAvatarFrames)) await db.customAvatarFrames.bulkPut(backupData.customAvatarFrames);
        if (Array.isArray(backupData.readingLibrary)) await db.readingLibrary.bulkPut(backupData.readingLibrary);
        if (Array.isArray(backupData.quickReplies)) await db.quickReplies.bulkPut(backupData.quickReplies);
        if (Array.isArray(backupData.quickReplyCategories)) await db.quickReplyCategories.bulkPut(backupData.quickReplyCategories);
        if (Array.isArray(backupData.npcGroups)) await db.npcGroups.bulkPut(backupData.npcGroups);
        if (Array.isArray(backupData.naiPresets)) await db.naiPresets.bulkPut(backupData.naiPresets);
        if (Array.isArray(backupData.grAuthors)) await db.grAuthors.bulkPut(backupData.grAuthors);
        if (Array.isArray(backupData.grStories)) await db.grStories.bulkPut(backupData.grStories);
        if (backupData.userWallet) await db.userWallet.put(backupData.userWallet);
        if (Array.isArray(backupData.userTransactions)) await db.userTransactions.bulkPut(backupData.userTransactions);
        if (Array.isArray(backupData.funds)) await db.funds.bulkPut(backupData.funds);
        if (Array.isArray(backupData.auctions)) await db.auctions.bulkPut(backupData.auctions);
        if (Array.isArray(backupData.inventory)) await db.inventory.bulkPut(backupData.inventory);
        if (Array.isArray(backupData.emails)) await db.emails.bulkPut(backupData.emails);
        if (Array.isArray(backupData.watchTogetherPlaylist)) await db.watchTogetherPlaylist.bulkPut(backupData.watchTogetherPlaylist);
      });
    } catch (error) {
      throw new Error(`ÊóßÁâàÂ§á‰ªΩÊï∞ÊçÆÂÜôÂÖ•Êï∞ÊçÆÂ∫ìÂ§±Ë¥•: ${error.message}`);
    }
  }


  // Â≠ó‰ΩìËåÉÂõ¥ ‚Üí CSS ÈÄâÊã©Âô®Êò†Â∞Ñ
  const FONT_SCOPE_SELECTORS = {
    homeScreen: '#home-screen',
    qq: '#chat-list-screen, #chat-interface-screen',
    cphone: '#character-phone-screen, #character-selection-screen',
    myphone: '#myphone-screen, #myphone-selection-screen',
    worldBook: '#world-book-screen, #world-book-editor-screen',
    douban: '#douban-screen, #douban-post-detail-screen',
    alipay: '#alipay-screen, #fund-screen',
    settings: '#font-settings-screen, #wallpaper-screen, #rendering-rules-screen, #preset-screen, #preset-editor-screen, #chat-settings-screen, #long-term-memory-screen'
  };

  function applyCustomFont(fontUrl, isPreviewOnly = false) {
    const globalFontSize = state.globalSettings.globalFontSize || 16;
    const fontSizeCss = globalFontSize !== 16 ? `font-size: ${globalFontSize}px;` : '';

    if (!fontUrl) {
      // Âç≥‰ΩøÊ≤°ÊúâËá™ÂÆö‰πâÂ≠ó‰ΩìÔºå‰πüË¶ÅÂ∫îÁî®Â≠ó‰ΩìÂ§ßÂ∞è
      if (fontSizeCss) {
        dynamicFontStyle.innerHTML = `body { ${fontSizeCss} }`;
      } else {
        dynamicFontStyle.innerHTML = '';
      }
      document.getElementById('font-preview').style.fontFamily = '';
      return;
    }
    const fontName = 'custom-user-font';
    const newStyle = `
                        @font-face {
                          font-family: '${fontName}';
                          src: url('${fontUrl}');
                          font-display: swap;
                        }`;
    if (isPreviewOnly) {
      const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
      previewStyle.id = 'preview-font-style';
      previewStyle.innerHTML = newStyle;
      if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
      document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
      document.getElementById('font-preview').style.fontSize = `${globalFontSize}px`;
    } else {
      const scope = state.globalSettings.fontScope || { all: true };
      const fontFamily = `'${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif`;
      if (scope.all) {
        dynamicFontStyle.innerHTML = `${newStyle}\nbody { font-family: ${fontFamily}; ${fontSizeCss} }`;
      } else {
        const selectors = Object.keys(FONT_SCOPE_SELECTORS)
          .filter(key => scope[key])
          .map(key => FONT_SCOPE_SELECTORS[key])
          .join(', ');
        if (selectors) {
          dynamicFontStyle.innerHTML = `${newStyle}\n${selectors} { font-family: ${fontFamily}; ${fontSizeCss} }`;
        } else {
          dynamicFontStyle.innerHTML = fontSizeCss ? `${newStyle}\nbody { ${fontSizeCss} }` : '';
        }
      }
    }
  }

  async function resetFontByScope() {
    const fontUrl = state.globalSettings.fontUrl;
    if (!fontUrl) {
      alert('ÂΩìÂâçÊ≤°Êúâ‰ΩøÁî®Ëá™ÂÆö‰πâÂ≠ó‰Ωì„ÄÇ');
      return;
    }

    const scope = state.globalSettings.fontScope || { all: true };
    const scopeLabels = {
      homeScreen: '‰∏ªÂ±èÂπï', qq: 'QQ (ËÅäÂ§©)', cphone: 'Cphone',
      myphone: 'Myphone', worldBook: '‰∏ñÁïå‰π¶', douban: 'Ë±ÜÁì£',
      alipay: 'ÊîØ‰ªòÂÆù', settings: 'ËÆæÁΩÆÈ°µÈù¢'
    };
    const activeScopes = scope.all
      ? Object.keys(scopeLabels)
      : Object.keys(scopeLabels).filter(k => scope[k]);

    if (activeScopes.length === 0) {
      alert('ÂΩìÂâçÊ≤°ÊúâÂå∫ÂüüÂú®‰ΩøÁî®Ëá™ÂÆö‰πâÂ≠ó‰Ωì„ÄÇ');
      return;
    }

    // ÊûÑÂª∫ checkbox ÂàóË°® HTML
    const checkboxHtml = activeScopes.map(key =>
      `<label style="display:flex;align-items:center;gap:10px;padding:8px 0;cursor:pointer;">
        <input type="checkbox" value="${key}" style="width:18px;height:18px;accent-color:#007aff;">
        <span>${scopeLabels[key]}</span>
      </label>`
    ).join('');

    const contentHtml = `
      <div style="max-height:300px;overflow-y:auto;margin:10px 0;">
        ${checkboxHtml}
      </div>
      <p style="font-size:12px;color:#999;margin-top:8px;">ÂãæÈÄâÁöÑÂå∫ÂüüÂ∞ÜÊÅ¢Â§ç‰∏∫Á≥ªÁªüÈªòËÆ§Â≠ó‰ΩìÔºåÂÖ∂‰ªñÂå∫Âüü‰∏çÂèóÂΩ±Âìç„ÄÇ</p>
    `;

    return new Promise(resolve => {
      modalResolve = null;
      modalTitle.textContent = 'ÈÄâÊã©Ë¶ÅÊÅ¢Â§çÈªòËÆ§ÁöÑÂå∫Âüü';
      modalBody.innerHTML = contentHtml;

      const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');
      if (modalFooter) {
        modalFooter.style.flexDirection = 'row';
        modalFooter.style.justifyContent = 'flex-end';
        modalFooter.innerHTML = `
          <button id="custom-modal-cancel">ÂèñÊ∂à</button>
          <button id="custom-modal-confirm" class="confirm-btn btn-danger">ÊÅ¢Â§çÈÄâ‰∏≠Âå∫Âüü</button>
        `;
      }

      const confirmBtn = document.getElementById('custom-modal-confirm');
      const cancelBtn = document.getElementById('custom-modal-cancel');

      confirmBtn.onclick = async () => {
        const checked = modalBody.querySelectorAll('input[type="checkbox"]:checked');
        if (checked.length === 0) {
          alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Âå∫Âüü„ÄÇ');
          return;
        }

        const resetKeys = Array.from(checked).map(cb => cb.value);
        const newScope = { ...scope, all: false };
        resetKeys.forEach(key => { newScope[key] = false; });

        const anyActive = Object.keys(scopeLabels).some(k => newScope[k]);
        if (!anyActive) {
          state.globalSettings.fontUrl = '';
          state.globalSettings.fontScope = { all: true, homeScreen: true, qq: true, cphone: true, myphone: true, worldBook: true, douban: true, alipay: true, settings: true };
          dynamicFontStyle.innerHTML = '';
          document.getElementById('font-url-input').value = '';
          document.getElementById('font-preview').style.fontFamily = '';
        } else {
          state.globalSettings.fontScope = newScope;
          applyCustomFont(state.globalSettings.fontUrl, false);
        }

        await db.globalSettings.put(state.globalSettings);

        // Âà∑Êñ∞Â≠ó‰ΩìËÆæÁΩÆÈ°µÈù¢ UI
        const allCb = document.getElementById('font-scope-all');
        if (allCb) {
          allCb.checked = state.globalSettings.fontScope.all;
          document.getElementById('font-scope-list').style.display = state.globalSettings.fontScope.all ? 'none' : 'flex';
          document.querySelectorAll('#font-scope-list input[data-scope]').forEach(cb => {
            cb.checked = state.globalSettings.fontScope[cb.dataset.scope] !== false;
          });
        }

        hideCustomModal();
        const names = resetKeys.map(k => scopeLabels[k]).join('„ÄÅ');
        alert(`Â∑≤ÊÅ¢Â§ç‰ª•‰∏ãÂå∫ÂüüÁöÑÈªòËÆ§Â≠ó‰ΩìÔºö${names}`);
        resolve(true);
      };

      cancelBtn.onclick = () => {
        hideCustomModal();
        resolve(false);
      };

      showCustomModal();
    });
  }

  async function resetToDefaultFont() {
    dynamicFontStyle.innerHTML = '';
    state.globalSettings.fontUrl = '';
    state.globalSettings.globalFontSize = 16;
    state.globalSettings.fontScope = { all: true, homeScreen: true, qq: true, cphone: true, myphone: true, worldBook: true, douban: true, alipay: true, settings: true };
    await db.globalSettings.put(state.globalSettings);
    document.getElementById('font-url-input').value = '';
    document.getElementById('font-preview').style.fontFamily = '';
    document.getElementById('font-preview').style.fontSize = '';
    document.getElementById('font-size-slider').value = 16;
    document.getElementById('font-size-value').textContent = '16';
    // ÈáçÁΩÆ UI
    const allCb = document.getElementById('font-scope-all');
    if (allCb) {
      allCb.checked = true;
      document.getElementById('font-scope-list').style.display = 'none';
      document.querySelectorAll('#font-scope-list input[type="checkbox"]').forEach(cb => cb.checked = true);
    }
    alert('Â∑≤ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì„ÄÇ');
  }


  async function loadAllDataFromDB() {
    const [
      chatsArr, apiConfig, loadedGlobalSettings, userStickers, worldBooks,
      musicLib, personaPresets, qzoneSettings, initialFavorites,
      allMemories,

      allPresets,
      allQuickReplies
    ] = await Promise.all([
      db.chats.toArray(), db.apiConfig.get('main'), db.globalSettings.get('main'),
      db.userStickers.toArray(), db.worldBooks.toArray(), db.musicLibrary.get('main'),
      db.personaPresets.toArray(), db.qzoneSettings.get('main'), db.favorites.orderBy('timestamp').reverse().toArray(),
      db.memories.toArray(),

      db.presets.toArray(),
      db.quickReplies.toArray()
    ]);


    state.presets = allPresets || [];
    state.quickReplies = allQuickReplies || [];
    await initUserWallet();
    const defaultGlobalSettings = {
      id: 'main',
      showStatusBar: false,
      wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)',
      fontUrl: '',
      fontScope: { all: true, homeScreen: true, qq: true, cphone: true, myphone: true, worldBook: true, douban: true, alipay: true, settings: true },
      globalFontSize: 16,
      enableThoughts: false,              // Êñ∞Â¢ûÔºöÂÖ®Â±ÄÂøÉÂ£∞ÂºÄÂÖ≥ÔºåÈªòËÆ§ÂÖ≥Èó≠
      enableQzoneActions: false,          // Êñ∞Â¢ûÔºöÂÖ®Â±ÄÂä®ÊÄÅÂºÄÂÖ≥ÔºåÈªòËÆ§ÂÖ≥Èó≠
      enableViewMyPhone: false,           // Êñ∞Â¢ûÔºöÂÖ®Â±ÄÊü•ÁúãUserÊâãÊú∫ÂºÄÂÖ≥ÔºåÈªòËÆ§ÂÖ≥Èó≠
      enableBackgroundActivity: false,
      backgroundActivityInterval: 60,
      blockCooldownHours: 1,
      apiTemperature: 0.8,
      appIcons: {
        ...DEFAULT_APP_ICONS
      },
      cphoneWallpaper: 'linear-gradient(135deg, #f6d365, #fda085)',
      cphoneAppIcons: {
        ...DEFAULT_CPHONE_ICONS
      },
      myphoneWallpaper: 'linear-gradient(135deg, #a8edea, #fed6e3)',
      myphoneAppIcons: {
        ...DEFAULT_MYPHONE_ICONS
      },
      globalCss: '',
      notificationSoundUrl: '',
      notificationVolume: 1.0, // Ê∂àÊÅØÊèêÁ§∫Èü≥Èü≥Èáè (0.0-1.0)
      soundPresets: [], // Ê∂àÊÅØÊèêÁ§∫Èü≥È¢ÑËÆæÂàóË°®
      widgetData: {},
      globalChatBackground: '',
      enableAiDrawing: true,
      showPhoneFrame: false,
      lockScreenEnabled: false,
      lockScreenPassword: '',
      lockScreenWallpaper: '',
      alwaysShowMusicIsland: false,
      detachStatusBar: false,
      enableMinimalChatUI: false,
      chatActionButtonsOrder: null,
      shoppingCategoryCount: 3,
      shoppingProductCount: 8,
      chatRenderWindow: 50,
      systemNotification: {
        enabled: false,
        appName: 'EPhone',
        notifyInChatPage: false,  // Âú®ËÅäÂ§©È°µÈù¢‰πüÂèëÈÄÅÈÄöÁü•
        disableInternalNotification: false,  // Á¶ÅÁî®ÂÜÖÈÉ®ÂºπÁ™ó
        pushServer: {
          enabled: false,
          serverUrl: '',
          apiKey: ''
        },
        vibration: {
          enabled: false,
          pattern: 'short'
        },
        sound: {
          enabled: false,
          useGlobalSound: true,
          customSoundUrl: ''
        }
      },
    };
    state.globalSettings = {
      ...defaultGlobalSettings,
      ...(loadedGlobalSettings || {})
    };

    // Á°Æ‰øù systemNotification ÈÖçÁΩÆÂÆåÊï¥
    if (!state.globalSettings.systemNotification) {
      state.globalSettings.systemNotification = defaultGlobalSettings.systemNotification;
    } else {
      state.globalSettings.systemNotification = {
        ...defaultGlobalSettings.systemNotification,
        ...state.globalSettings.systemNotification,
        pushServer: {
          ...defaultGlobalSettings.systemNotification.pushServer,
          ...(state.globalSettings.systemNotification.pushServer || {})
        },
        vibration: {
          ...defaultGlobalSettings.systemNotification.vibration,
          ...(state.globalSettings.systemNotification.vibration || {})
        },
        sound: {
          ...defaultGlobalSettings.systemNotification.sound,
          ...(state.globalSettings.systemNotification.sound || {})
        }
      };
    }

    state.globalSettings.appIcons = {
      ...defaultGlobalSettings.appIcons,
      ...(state.globalSettings.appIcons || {})
    };
    state.globalSettings.cphoneAppIcons = {
      ...defaultGlobalSettings.cphoneAppIcons,
      ...(state.globalSettings.cphoneAppIcons || {})
    };
    state.globalSettings.myphoneAppIcons = {
      ...defaultGlobalSettings.myphoneAppIcons,
      ...(state.globalSettings.myphoneAppIcons || {})
    };

    chatsArr.forEach(chat => {
      if (typeof chat.settings.enableTimePerception === 'undefined') {
        chat.settings.enableTimePerception = true;
      }
      if (!chat.settings.lyricsPosition) {
        chat.settings.lyricsPosition = {
          vertical: 'top',
          horizontal: 'center',
          offset: 10
        };
      }
      if (!chat.isGroup && !chat.settings.myAvatarLibrary) {
        chat.settings.myAvatarLibrary = [];
      }
      if (!chat.isGroup && typeof chat.originalName === 'undefined') {
        chat.originalName = chat.name;
      }
    });
    state.chats = chatsArr.reduce((acc, chat) => {
      if (typeof chat.unreadCount === 'undefined') chat.unreadCount = 0;
      if (chat.isGroup) {
        if (typeof chat.settings.enableBackgroundActivity === 'undefined') {
          chat.settings.enableBackgroundActivity = true;
        }
        if (chat.members && chat.members.length > 0 && chat.members[0].name) {
          chat.members.forEach(member => {
            if (typeof member.originalName === 'undefined') {
              member.originalName = member.name;
              member.groupNickname = member.name;
              delete member.name;
            }
          });
        }
      }
      if (!chat.settings) chat.settings = {};
      if (typeof chat.settings.actionCooldownMinutes === 'undefined') {
        chat.settings.actionCooldownMinutes = 10;
      }
      if (!chat.isGroup && !chat.status) chat.status = {
        text: 'Âú®Á∫ø',
        lastUpdate: Date.now(),
        isBusy: false
      };
      // ÂàùÂßãÂåñUSERÁä∂ÊÄÅ
      if (!chat.settings.userStatus) chat.settings.userStatus = {
        text: 'Âú®Á∫ø',
        lastUpdate: Date.now(),
        isBusy: false
      };
      if (!chat.isGroup && !chat.relationship) chat.relationship = {
        status: 'friend',
        blockedTimestamp: null,
        applicationReason: ''
      };
      if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) {
        if (!chat.settings) chat.settings = {};
        chat.settings.aiAvatarLibrary = [];
      }
      if (chat.isGroup) {
        (chat.members || []).forEach(member => {
          if (typeof member.avatarFrame === 'undefined') member.avatarFrame = '';
        });
      }
      if (!chat.musicData) chat.musicData = {
        totalTime: 0
      };
      if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
        chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
        delete chat.settings.linkedWorldBookId;
      }
      if (typeof chat.isPinned === 'undefined') chat.isPinned = false;
      if (!chat.isGroup && typeof chat.settings.myNickname === 'undefined') {
        chat.settings.myNickname = 'Êàë';
      }
      if (chat.isGroup && chat.members) {
        let needsUpdate = false;
        chatsArr.forEach(c => {
          if (c.id === chat.id && c.originalName) {
            delete c.originalName;
          }
        });
        chat.members.forEach(member => {
          const originalCharacter = chatsArr.find(c => c.id === member.id);
          if (originalCharacter && originalCharacter.settings) {
            const correctAvatar = originalCharacter.settings.aiAvatar;
            if (correctAvatar && member.avatar !== correctAvatar) {
              member.avatar = correctAvatar;
              needsUpdate = true;
            }
            const correctFrame = originalCharacter.settings.aiAvatarFrame || '';
            if (member.avatarFrame !== correctFrame) {
              member.avatarFrame = correctFrame;
              needsUpdate = true;
            }
          } else if (typeof member.avatarFrame === 'undefined') {
            member.avatarFrame = '';
            needsUpdate = true;
          }
        });
        if (needsUpdate) db.chats.put(chat);
      }
      if (!chat.settings.enableAutoMemory) chat.settings.enableAutoMemory = false;
      if (!chat.settings.autoMemoryInterval) chat.settings.autoMemoryInterval = 20;
      if (typeof chat.settings.enableDiaryMode === 'undefined') chat.settings.enableDiaryMode = false;
      if (!chat.longTermMemory) chat.longTermMemory = [];
      if (!chat.lastMemorySummaryTimestamp) chat.lastMemorySummaryTimestamp = 0;
      if (!chat.isGroup) {
        if (typeof chat.settings.enableBackgroundActivity === 'undefined') {
          chat.settings.enableBackgroundActivity = true;
        }
        if (typeof chat.settings.enableTts === 'undefined') {
          chat.settings.enableTts = false;
        }
        if (typeof chat.settings.enableAutoCartClear === 'undefined') {
          chat.settings.enableAutoCartClear = false;
        }
        if (!chat.status) chat.status = {
          text: 'Âú®Á∫ø',
          lastUpdate: Date.now(),
          isBusy: false
        };
        // ÂàùÂßãÂåñUSERÁä∂ÊÄÅ
        if (!chat.settings.userStatus) chat.settings.userStatus = {
          text: 'Âú®Á∫ø',
          lastUpdate: Date.now(),
          isBusy: false
        };
        if (!chat.relationship) chat.relationship = {
          status: 'friend',
          blockedTimestamp: null,
          applicationReason: ''
        };
        if (!chat.settings || !chat.settings.aiAvatarLibrary) {
          if (!chat.settings) chat.settings = {};
          chat.settings.aiAvatarLibrary = [];
        }
        if (typeof chat.settings.isOfflineMode === 'undefined') chat.settings.isOfflineMode = false;
        if (typeof chat.settings.offlineMinLength === 'undefined') chat.settings.offlineMinLength = 100;
        if (typeof chat.settings.offlineMaxLength === 'undefined') chat.settings.offlineMaxLength = 300;
        if (typeof chat.settings.offlineContinuousLayout === 'undefined') chat.settings.offlineContinuousLayout = false;

        if (typeof chat.settings.injectLatestThought === 'undefined') {
          chat.settings.injectLatestThought = false;
        }

        // Êñ∞Â¢ûÔºöÂàùÂßãÂåñÂøÉÂ£∞ÂíåÂä®ÊÄÅÂäüËÉΩÂºÄÂÖ≥
        if (typeof chat.settings.enableThoughts === 'undefined') {
          chat.settings.enableThoughts = null; // nullË°®Á§∫‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆ
        }
        if (typeof chat.settings.enableQzoneActions === 'undefined') {
          chat.settings.enableQzoneActions = null; // nullË°®Á§∫‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆ
        }
        if (typeof chat.settings.enableViewMyPhone === 'undefined') {
          chat.settings.enableViewMyPhone = null; // nullË°®Á§∫‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆ
        }

        if (typeof chat.heartfeltVoice === 'undefined') chat.heartfeltVoice = '...';
        if (typeof chat.randomJottings === 'undefined') chat.randomJottings = '...';
        if (!Array.isArray(chat.thoughtsHistory)) {
          chat.thoughtsHistory = [];
        }
      }
      if (typeof chat.settings.stickerCategoryIds === 'undefined') {

        if (chat.settings.stickerCategoryId) {

          chat.settings.stickerCategoryIds = [chat.settings.stickerCategoryId];
        } else {

          chat.settings.stickerCategoryIds = [];
        }

        delete chat.settings.stickerCategoryId;
      }
      acc[chat.id] = chat;
      return acc;
    }, {});
    const memoriesToUpdate = [];
    allMemories.forEach(memory => {
      if (memory.type === 'ai_generated' && memory.authorName && !memory.authorId) {
        const foundChat = chatsArr.find(c => !c.isGroup && c.originalName === memory.authorName);
        if (foundChat) {
          memory.authorId = foundChat.id;
          memoriesToUpdate.push(memory);
        } else {
          const fallbackChat = chatsArr.find(c => !c.isGroup && c.name === memory.authorName);
          if (fallbackChat) {
            memory.authorId = fallbackChat.id;
            memoriesToUpdate.push(memory);
          }
        }
      }
    });
    if (memoriesToUpdate.length > 0) {
      await db.memories.bulkPut(memoriesToUpdate);
    }
    state.apiConfig = apiConfig || {
      id: 'main',
      proxyUrl: '',
      apiKey: '',
      model: '',
      secondaryProxyUrl: '',
      secondaryApiKey: '',
      secondaryModel: '',
      minimaxGroupId: '',
      minimaxApiKey: '',
      minimaxModel: 'speech-01',
      imgbbEnable: false,
      imgbbApiKey: '',

      catboxEnable: false,
      catboxUserHash: '',
      githubEnable: false, // ÈªòËÆ§‰∏∫ÂÖ≥Èó≠
      githubAutoBackup: false,
      githubUsername: '',
      githubRepo: '',
      githubToken: '',
      githubFilename: 'ephone_backup.json'
    };
    if (localStorage.getItem('imgbb-enabled') !== null) {
      state.apiConfig.imgbbEnable = localStorage.getItem('imgbb-enabled') === 'true';
    }
    if (localStorage.getItem('imgbb-api-key') !== null) {
      state.apiConfig.imgbbApiKey = localStorage.getItem('imgbb-api-key');
    }
    if (localStorage.getItem('catbox-enabled') !== null) {
      state.apiConfig.catboxEnable = localStorage.getItem('catbox-enabled') === 'true';
    }
    if (localStorage.getItem('catbox-userhash') !== null) {
      state.apiConfig.catboxUserHash = localStorage.getItem('catbox-userhash');
    }
    if (localStorage.getItem('minimax-group-id') !== null) {
      state.apiConfig.minimaxGroupId = localStorage.getItem('minimax-group-id');
    }
    if (localStorage.getItem('minimax-api-key') !== null) {
      state.apiConfig.minimaxApiKey = localStorage.getItem('minimax-api-key');
    }
    if (localStorage.getItem('minimax-model') !== null) {
      state.apiConfig.minimaxModel = localStorage.getItem('minimax-model');
    }
    if (localStorage.getItem('github-proxy-enabled') !== null) {
      state.apiConfig.githubProxyEnable = localStorage.getItem('github-proxy-enabled') === 'true';
    }
    if (localStorage.getItem('github-proxy-url') !== null) {
      state.apiConfig.githubProxyUrl = localStorage.getItem('github-proxy-url');
    }
    state.userStickers = userStickers || [];
    state.worldBooks = worldBooks || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
    state.qzoneSettings = qzoneSettings || {
      id: 'main',
      nickname: '{{user}}',
      avatar: 'https://files.catbox.moe/q6z5fc.jpeg',
      banner: 'https://files.catbox.moe/r5heyt.gif'
    };
    allFavoriteItems = initialFavorites || [];
  }


  async function saveGlobalPlaylist() {
    await db.musicLibrary.put({
      id: 'main',
      playlist: musicState.playlist
    });
  }

  function formatTimestamp(timestamp, chatId = null) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');

    // Âà§Êñ≠ÊòØÂê¶ÊòæÁ§∫ÁßíÊï∞
    let showSeconds = false;

    // Â¶ÇÊûúÊèê‰æõ‰∫Ü chatIdÔºåÊ£ÄÊü•Âçï‰∏™ËßíËâ≤ËÆæÁΩÆÔºà‰ºòÂÖàÁ∫ßÊúÄÈ´òÔºâ
    if (chatId && state.chats[chatId] && state.chats[chatId].settings) {
      if (state.chats[chatId].settings.showSeconds !== undefined) {
        showSeconds = state.chats[chatId].settings.showSeconds;
      } else {
        // Â¶ÇÊûúËßíËâ≤Ê≤°ÊúâÂçïÁã¨ËÆæÁΩÆÔºå‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆ
        showSeconds = state.globalSettings.showSeconds || false;
      }
    } else {
      // Ê≤°Êúâ chatId Êó∂Ôºå‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆ
      showSeconds = state.globalSettings.showSeconds || false;
    }

    return showSeconds ? `${hours}:${minutes}:${seconds}` : `${hours}:${minutes}`;
  }

  function formatTimeAgo(timestamp) {
    const now = Date.now();
    const seconds = Math.floor((now - timestamp) / 1000);

    if (seconds < 60) return 'ÂàöÂàö';

    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}ÂàÜÈíüÂâç`;

    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}Â∞èÊó∂Ââç`;

    const days = Math.floor(hours / 24);
    if (days < 30) return `${days}Â§©Ââç`;

    const months = Math.floor(days / 30);
    if (months < 12) return `Â§ßÁ∫¶${months}‰∏™ÊúàÂâç`;

    const years = Math.floor(days / 365);
    return `Â§ßÁ∫¶${years}Âπ¥Ââç`;
  }

  function formatTimestampForAI(timestamp) {
    if (!timestamp) return '';

    const now = new Date();
    const date = new Date(timestamp);

    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const timeString = `${hours}:${minutes}`;


    if (now.toDateString() === date.toDateString()) {
      return `‰ªäÂ§© ${timeString}`;
    }


    const yesterday = new Date();
    yesterday.setDate(now.getDate() - 1);
    if (yesterday.toDateString() === date.toDateString()) {
      return `Êò®Â§© ${timeString}`;
    }


    if (now.getFullYear() === date.getFullYear()) {
      const month = String(date.getMonth() + 1);
      const day = String(date.getDate());
      return `${month}Êúà${day}Êó• ${timeString}`;
    }


    const year = date.getFullYear();
    const month = String(date.getMonth() + 1);
    const day = String(date.getDate());
    return `${year}Âπ¥${month}Êúà${day}Êó• ${timeString}`;
  }

  // --- Êñ∞Â¢û NAI È¢ÑËÆæÁõ∏ÂÖ≥ÂáΩÊï∞ ---

  // 1. Âä†ËΩΩÈ¢ÑËÆæ‰∏ãÊãâËèúÂçï
  async function loadNaiPresetsDropdown() {
    const selectEl = document.getElementById('nai-preset-select');
    // ‰øùÁïôÁ¨¨‰∏Ä‰∏™ÈÄâÈ°π
    selectEl.innerHTML = '<option value="">-- ÂΩìÂâç‰∏¥Êó∂ËÆæÁΩÆ --</option>';

    const presets = await db.naiPresets.toArray();
    presets.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name;
      selectEl.appendChild(opt);
    });

    // ÊÅ¢Â§çÈÄâ‰∏≠Áä∂ÊÄÅ
    if (currentNaiPresetId) {
      selectEl.value = currentNaiPresetId;
      updateNaiPresetButtons(true);
    } else {
      updateNaiPresetButtons(false);
    }
  }

  // 2. Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
  // 2. Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ (Êõ¥Êñ∞Ëøô‰∏™ÂáΩÊï∞)
  function updateNaiPresetButtons(hasSelection) {
    const updateBtn = document.getElementById('update-nai-preset-btn');
    const bindBtn = document.getElementById('bind-nai-preset-btn');
    const deleteBtn = document.getElementById('delete-nai-preset-btn');
    const saveBtn = document.getElementById('save-nai-preset-btn');

    if (hasSelection) {
      updateBtn.style.display = 'block';
      bindBtn.style.display = 'block';
      deleteBtn.style.display = 'block';
      // ÊîπÂä®ÔºöÈÄâ‰∏≠Áä∂ÊÄÅ‰∏ãÊòæÁ§∫"Âè¶Â≠ò" (2‰∏™Â≠ó)
      saveBtn.textContent = 'Âè¶Â≠ò';
    } else {
      updateBtn.style.display = 'none';
      bindBtn.style.display = 'none';
      deleteBtn.style.display = 'none';
      // ÊîπÂä®ÔºöÊú™ÈÄâ‰∏≠Áä∂ÊÄÅ‰∏ãÊòæÁ§∫"Êñ∞Â¢û" (2‰∏™Â≠ó)
      saveBtn.textContent = 'Êñ∞Â¢û';
    }
  }

  // 3. Êî∂ÈõÜÂΩìÂâçÁïåÈù¢‰∏äÁöÑÊâÄÊúâËÆæÁΩÆ
  function gatherNaiUiSettings() {
    return {
      resolution: document.getElementById('nai-resolution').value,
      steps: parseInt(document.getElementById('nai-steps').value),
      cfg_scale: parseFloat(document.getElementById('nai-cfg-scale').value),
      sampler: document.getElementById('nai-sampler').value,
      seed: parseInt(document.getElementById('nai-seed').value),
      uc_preset: parseInt(document.getElementById('nai-uc-preset').value),
      quality_toggle: document.getElementById('nai-quality-toggle').checked,
      smea: document.getElementById('nai-smea').checked,
      smea_dyn: document.getElementById('nai-smea-dyn').checked,
      default_positive: document.getElementById('nai-default-positive').value,
      default_negative: document.getElementById('nai-default-negative').value,
      // Ê≥®ÊÑèÔºöAPI Key Âíå Proxy ËøôÁßçÊïèÊÑü/ÂÖ®Â±ÄÈÖçÁΩÆÈÄöÂ∏∏‰∏çÂ≠òÂÖ•È£éÊ†ºÈ¢ÑËÆæÔºå‰ΩÜ‰Ω†ÂèØ‰ª•Ê†πÊçÆÈúÄÊ±ÇÂÜ≥ÂÆö
      // ËøôÈáå‰∏∫‰∫ÜÈ£éÊ†ºÂàáÊç¢Êñπ‰æøÔºåÊàë‰ª¨Âè™Â≠òÂèÇÊï∞ÔºåKey Âíå Proxy ËøòÊòØËµ∞ÂÖ®Â±Ä
    };
  }

  // 4. Â∫îÁî®ËÆæÁΩÆÂà∞ UI
  function applyNaiUiSettings(settings) {
    if (!settings) return;
    document.getElementById('nai-resolution').value = settings.resolution || '1024x1024';
    document.getElementById('nai-steps').value = settings.steps || 28;
    document.getElementById('nai-cfg-scale').value = settings.cfg_scale || 5;
    document.getElementById('nai-sampler').value = settings.sampler || 'k_euler_ancestral';
    document.getElementById('nai-seed').value = settings.seed ?? -1;
    document.getElementById('nai-uc-preset').value = settings.uc_preset || 1;
    document.getElementById('nai-quality-toggle').checked = settings.quality_toggle !== false;
    document.getElementById('nai-smea').checked = settings.smea !== false;
    document.getElementById('nai-smea-dyn').checked = settings.smea_dyn || false;
    document.getElementById('nai-default-positive').value = settings.default_positive || '';
    document.getElementById('nai-default-negative').value = settings.default_negative || '';
  }

  // 5. ‰øùÂ≠ò/Êñ∞Âª∫È¢ÑËÆæ
  async function handleSaveNaiPreset(isUpdate = false) {
    const settings = gatherNaiUiSettings();

    if (isUpdate && currentNaiPresetId) {
      const confirmed = await showCustomConfirm("Êõ¥Êñ∞È¢ÑËÆæ", "Á°ÆÂÆöË¶ÅË¶ÜÁõñÂΩìÂâçÈ¢ÑËÆæÁöÑÂèÇÊï∞ÂêóÔºü");
      if (!confirmed) return;

      await db.naiPresets.update(parseInt(currentNaiPresetId), { settings });
      alert("È¢ÑËÆæÂ∑≤Êõ¥Êñ∞ÔºÅ");
    } else {
      const name = await showCustomPrompt("Êñ∞Âª∫È¢ÑËÆæ", "ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞Ôºà‰æãÂ¶ÇÔºöÂéöÊ∂ÇÈ£é„ÄÅÂÉèÁ¥†È£éÔºâ");
      if (!name) return;

      const id = await db.naiPresets.add({ name, settings });
      currentNaiPresetId = id;
      await loadNaiPresetsDropdown();
      alert("È¢ÑËÆæÂ∑≤ÂàõÂª∫ÔºÅ");
    }
  }

  // 6. Âà†Èô§È¢ÑËÆæ
  async function handleDeleteNaiPreset() {
    if (!currentNaiPresetId) return;
    const confirmed = await showCustomConfirm("Âà†Èô§È¢ÑËÆæ", "Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§È¢ÑËÆæÂêóÔºüÁªëÂÆö‰∫ÜÊ≠§È¢ÑËÆæÁöÑËßíËâ≤Â∞ÜÂõûÈÄÄÂà∞ÂÖ®Â±ÄËÆæÁΩÆ„ÄÇ", { confirmButtonClass: 'btn-danger' });
    if (!confirmed) return;

    await db.naiPresets.delete(parseInt(currentNaiPresetId));

    // Ê∏ÖÈô§ÊâÄÊúâËÅäÂ§©‰∏≠ÁöÑÁªëÂÆöÂºïÁî®
    const allChats = await db.chats.toArray();
    for (const chat of allChats) {
      if (chat.settings?.naiPresetId === parseInt(currentNaiPresetId)) {
        delete chat.settings.naiPresetId;
        await db.chats.put(chat);
      }
    }

    currentNaiPresetId = null;
    await loadNaiPresetsDropdown();
  }

  // 7. Â§ÑÁêÜ‰∏ãÊãâÊ°ÜÂàáÊç¢
  async function handleNaiPresetChange(e) {
    const val = e.target.value;
    if (val) {
      currentNaiPresetId = parseInt(val);
      const preset = await db.naiPresets.get(currentNaiPresetId);
      if (preset && preset.settings) {
        applyNaiUiSettings(preset.settings);
      }
      updateNaiPresetButtons(true);
    } else {
      currentNaiPresetId = null;
      updateNaiPresetButtons(false);
      // ÊÅ¢Â§çÂà∞ localStorage ÈáåÁöÑÂÖ®Â±ÄËÆæÁΩÆ
      loadNovelAISettings();
    }
  }

  // 8. ÊâìÂºÄÁªëÂÆöÂºπÁ™ó
  async function openNaiBindingModal() {
    if (!currentNaiPresetId) return;
    const preset = await db.naiPresets.get(parseInt(currentNaiPresetId));
    if (!preset) return;

    const modal = document.getElementById('nai-binding-modal');
    const listEl = document.getElementById('nai-binding-list');
    const titleEl = modal.querySelector('.modal-header span');

    titleEl.textContent = `Â∞ÜÈ¢ÑËÆæ‚Äú${preset.name}‚ÄùÁªëÂÆöÂà∞...`;
    listEl.innerHTML = '';

    const allChats = Object.values(state.chats).sort((a, b) => a.name.localeCompare(b.name));

    allChats.forEach(chat => {
      const isBound = chat.settings?.naiPresetId === currentNaiPresetId;

      const item = document.createElement('div');
      item.className = 'contact-picker-item'; // Â§çÁî®Ê†∑Âºè
      item.innerHTML = `
            <input type="checkbox" class="nai-binding-checkbox" data-chat-id="${chat.id}" ${isBound ? 'checked' : ''} style="margin-right: 15px;">
            <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
            <div style="display:flex; flex-direction:column;">
                <span class="name">${chat.name}</span>
                ${isBound ? '<span style="font-size:10px; color:green;">Â∑≤ÁªëÂÆö</span>' : ''}
            </div>
        `;
      // ÁÇπÂáªË°åÂàáÊç¢
      item.addEventListener('click', (e) => {
        if (e.target.type !== 'checkbox') {
          const cb = item.querySelector('input');
          cb.checked = !cb.checked;
        }
      });
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
  }

  // 9. ‰øùÂ≠òÁªëÂÆö
  async function saveNaiBinding() {
    if (!currentNaiPresetId) return;

    const checkboxes = document.querySelectorAll('.nai-binding-checkbox');
    const updates = [];

    for (const cb of checkboxes) {
      const chatId = cb.dataset.chatId;
      const chat = state.chats[chatId];
      const shouldBind = cb.checked;

      if (chat) {
        if (shouldBind) {
          // Â¶ÇÊûúÂãæÈÄâÔºåÁªëÂÆöÂΩìÂâçÈ¢ÑËÆæ
          if (chat.settings.naiPresetId !== currentNaiPresetId) {
            chat.settings.naiPresetId = currentNaiPresetId;
            updates.push(chat);
          }
        } else {
          // Â¶ÇÊûúÂèñÊ∂àÂãæÈÄâÔºå‰∏îÂΩìÂâçÊ≠£ÊòØÁªëÂÆö‰∫ÜËøô‰∏™È¢ÑËÆæÔºåÂàôËß£Áªë
          if (chat.settings.naiPresetId === currentNaiPresetId) {
            delete chat.settings.naiPresetId;
            updates.push(chat);
          }
        }
      }
    }

    if (updates.length > 0) {
      await db.chats.bulkPut(updates);
      await showCustomAlert("‰øùÂ≠òÊàêÂäü", `Â∑≤Êõ¥Êñ∞ ${updates.length} ‰∏™ËßíËâ≤ÁöÑÁªëÂÆöËÆæÁΩÆ„ÄÇ`);
    } else {
      // Êó†ÂèòÂåñ
    }

    document.getElementById('nai-binding-modal').classList.remove('visible');
  }
  function loadNovelAISettings() {
    const settings = getNovelAISettings();
    document.getElementById('nai-resolution').value = settings.resolution;
    document.getElementById('nai-steps').value = settings.steps;
    document.getElementById('nai-cfg-scale').value = settings.cfg_scale;
    document.getElementById('nai-sampler').value = settings.sampler;
    document.getElementById('nai-seed').value = settings.seed;
    document.getElementById('nai-uc-preset').value = settings.uc_preset;
    document.getElementById('nai-quality-toggle').checked = settings.quality_toggle;
    document.getElementById('nai-smea').checked = settings.smea;
    document.getElementById('nai-smea-dyn').checked = settings.smea_dyn;
    document.getElementById('nai-default-positive').value = settings.default_positive;
    document.getElementById('nai-default-negative').value = settings.default_negative;
    document.getElementById('nai-cors-proxy').value = settings.cors_proxy;
    document.getElementById('nai-custom-proxy-url').value = settings.custom_proxy_url || '';


    const customProxyGroup = document.getElementById('nai-custom-proxy-group');
    customProxyGroup.style.display = settings.cors_proxy === 'custom' ? 'block' : 'none';
    loadNaiPresetsDropdown();
  }

  function saveNovelAISettings() {

    const novelaiEnabled = document.getElementById('novelai-switch').checked;
    const novelaiModel = document.getElementById('novelai-model').value;
    const novelaiApiKey = document.getElementById('novelai-api-key').value.trim();

    localStorage.setItem('novelai-enabled', novelaiEnabled);
    localStorage.setItem('novelai-model', novelaiModel);
    localStorage.setItem('novelai-api-key', novelaiApiKey);


    const settings = {
      resolution: document.getElementById('nai-resolution').value,
      steps: parseInt(document.getElementById('nai-steps').value),
      cfg_scale: parseFloat(document.getElementById('nai-cfg-scale').value),
      sampler: document.getElementById('nai-sampler').value,
      seed: parseInt(document.getElementById('nai-seed').value),
      uc_preset: parseInt(document.getElementById('nai-uc-preset').value),
      quality_toggle: document.getElementById('nai-quality-toggle').checked,
      smea: document.getElementById('nai-smea').checked,
      smea_dyn: document.getElementById('nai-smea-dyn').checked,
      default_positive: document.getElementById('nai-default-positive').value,
      default_negative: document.getElementById('nai-default-negative').value,
      cors_proxy: document.getElementById('nai-cors-proxy').value,
      custom_proxy_url: document.getElementById('nai-custom-proxy-url').value
    };

    localStorage.setItem('novelai-settings', JSON.stringify(settings));
  }

  function resetNovelAISettings() {
    localStorage.removeItem('novelai-settings');
    loadNovelAISettings();
    alert('Â∑≤ÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆÔºÅ');
  }

  // ========== Google Imagen ÁîüÂõæÂäüËÉΩ ==========
  function getGoogleImagenSettings() {
    const defaultSettings = {
      model: 'imagen-4.0-generate-001',
      endpoint: 'https://generativelanguage.googleapis.com',
      aspectRatio: '1:1',
      numberOfImages: 1
    };
    const saved = localStorage.getItem('google-imagen-settings');
    if (saved) {
      try { return { ...defaultSettings, ...JSON.parse(saved) }; }
      catch (e) { return defaultSettings; }
    }
    return defaultSettings;
  }

  function saveGoogleImagenSettings() {
    const enabled = document.getElementById('google-imagen-switch').checked;
    const model = document.getElementById('google-imagen-model').value;
    const apiKey = document.getElementById('google-imagen-api-key').value.trim();
    const endpoint = document.getElementById('google-imagen-endpoint').value.trim();
    const aspectRatio = document.getElementById('google-imagen-aspect-ratio').value;

    localStorage.setItem('google-imagen-enabled', enabled);
    localStorage.setItem('google-imagen-model', model);
    localStorage.setItem('google-imagen-api-key', apiKey);

    const settings = { model, endpoint: endpoint || 'https://generativelanguage.googleapis.com', aspectRatio };
    localStorage.setItem('google-imagen-settings', JSON.stringify(settings));
  }

  async function generateGoogleImagenFromPrompt(aiPrompt) {
    console.log(`üé® [Google Imagen] ÂºÄÂßãÁîüÊàê... Prompt: "${aiPrompt}"`);

    const apiKey = localStorage.getItem('google-imagen-api-key');
    if (!apiKey) {
      throw new Error('Google Imagen API KeyÊú™ÈÖçÁΩÆ„ÄÇËØ∑Âú®Google ImagenËÆæÁΩÆ‰∏≠Â°´ÂÜôAPI Key„ÄÇ');
    }

    const settings = getGoogleImagenSettings();
    const model = localStorage.getItem('google-imagen-model') || settings.model;
    const baseEndpoint = (settings.endpoint || 'https://generativelanguage.googleapis.com').replace(/\/+$/, '');
    const isGemini = baseEndpoint.includes('generativelanguage.googleapis.com');

    let apiUrl, requestBody, headers;

    if (isGemini) {
      // ÂÆòÊñπ Google API ‚Üí Áî® :predict Á´ØÁÇπ
      apiUrl = `${baseEndpoint}/v1beta/models/${model}:predict`;
      requestBody = {
        instances: [{ prompt: aiPrompt }],
        parameters: {
          sampleCount: 1,
          aspectRatio: settings.aspectRatio || '1:1'
        }
      };
      headers = {
        'Content-Type': 'application/json',
        'x-goog-api-key': getRandomValue(apiKey)
      };
    } else {
      // Á¨¨‰∏âÊñπ‰∏≠ËΩ¨Á´ô ‚Üí Ëµ∞ OpenAI ÂÖºÂÆπÁöÑ /v1/images/generations
      apiUrl = `${baseEndpoint}/v1/images/generations`;
      requestBody = {
        model: model,
        prompt: aiPrompt,
        response_format: 'b64_json',
        n: 1
      };
      headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getRandomValue(apiKey)}`
      };
    }

    console.log('üöÄ ÂèëÈÄÅGoogle ImagenËØ∑Ê±Ç:', apiUrl, requestBody);

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 180000); // 3ÂàÜÈíüË∂ÖÊó∂

    let response;
    try {
      response = await fetch(apiUrl, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(requestBody),
        signal: controller.signal
      });
    } catch (error) {
      clearTimeout(timeoutId);
      if (error.name === 'AbortError') {
        throw new Error('Google Imagen ËØ∑Ê±ÇË∂ÖÊó∂ÔºàË∂ÖËøá3ÂàÜÈíüÔºâÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÁ®çÂêéÈáçËØï„ÄÇ');
      }
      throw error;
    }
    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Google Imagen APIËØ∑Ê±ÇÂ§±Ë¥• (${response.status}): ${errorText}`);
    }

    const data = await response.json();
    console.log('üì¶ Google Imagen ÂìçÂ∫î:', JSON.stringify(data).substring(0, 500));

    // ‰ªéÂìçÂ∫î‰∏≠ÊèêÂèñ base64 ÂõæÁâáÔºàÂÖºÂÆπÂ§öÁßçÊ†ºÂºèÔºâ
    let base64Data = null;
    if (data.predictions && data.predictions.length > 0) {
      // ÂÆòÊñπ Vertex AI / Gemini API :predict Ê†ºÂºè
      base64Data = data.predictions[0].bytesBase64Encoded;
      // Â¶ÇÊûúË¢´ÂÆâÂÖ®ËøáÊª§Êã¶Êà™‰∫Ü
      if (!base64Data && data.predictions[0].raiFilteredReason) {
        throw new Error(`ÂõæÁâáË¢´GoogleÂÆâÂÖ®ËøáÊª§Êã¶Êà™: ${data.predictions[0].raiFilteredReason}`);
      }
    } else if (data.generatedImages && data.generatedImages.length > 0) {
      // Gemini SDK generateImages Ê†ºÂºè
      const img = data.generatedImages[0].image || data.generatedImages[0];
      base64Data = img.imageBytes || img.bytesBase64Encoded;
    } else if (data.data && data.data.length > 0) {
      // OpenAI ÂÖºÂÆπÊ†ºÂºè - ÊîØÊåÅ b64_json Âíå url ‰∏§Áßç
      base64Data = data.data[0].b64_json;
      if (!base64Data && data.data[0].url) {
        // Á¨¨‰∏âÊñπ‰∏≠ËΩ¨Á´ôËøîÂõûÁöÑÊòØÂõæÁâáURLÔºåÁõ¥Êé•‰ΩøÁî®
        console.log('‚úÖ [Google Imagen] ÁîüÊàêÊàêÂäüÔºÅ(URLÊ†ºÂºè)');
        return {
          imageUrl: data.data[0].url,
          fullPrompt: data.data[0].revised_prompt || aiPrompt
        };
      }
    }

    if (!base64Data) {
      throw new Error(`Google Imagen ÂìçÂ∫î‰∏≠Êú™ÊâæÂà∞ÂõæÁâáÊï∞ÊçÆ„ÄÇÂìçÂ∫îÁªìÊûÑ: ${JSON.stringify(Object.keys(data))}ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞Êó•ÂøóÊü•ÁúãÂÆåÊï¥ÂìçÂ∫î„ÄÇ`);
    }

    const imageDataUrl = `data:image/png;base64,${base64Data}`;
    console.log('‚úÖ [Google Imagen] ÁîüÊàêÊàêÂäüÔºÅ');

    return {
      imageUrl: imageDataUrl,
      fullPrompt: aiPrompt
    };
  }

  async function testGoogleImagenGeneration() {
    const apiKey = document.getElementById('google-imagen-api-key').value.trim();
    if (!apiKey) {
      alert('ËØ∑ÂÖàÂ°´ÂÜô Google Imagen API KeyÔºÅ');
      return;
    }
    // ÂÖà‰øùÂ≠òÂΩìÂâçËÆæÁΩÆ
    saveGoogleImagenSettings();

    const testBtn = document.getElementById('google-imagen-test-btn');
    const resultDiv = document.getElementById('google-imagen-test-result');
    const resultImg = document.getElementById('google-imagen-result-image');
    testBtn.disabled = true;
    resultDiv.style.display = 'none';

    let seconds = 0;
    const timer = setInterval(() => {
      seconds++;
      testBtn.textContent = `‚è≥ ÁîüÊàê‰∏≠... (${seconds}s)`;
    }, 1000);
    testBtn.textContent = '‚è≥ ÁîüÊàê‰∏≠... (0s)';

    try {
      const result = await generateGoogleImagenFromPrompt('A beautiful sunset over the ocean, vibrant colors, high quality');
      resultImg.src = result.imageUrl;
      resultDiv.style.display = 'block';
      console.log('ÊµãËØïÂõæÁâá:', result.imageUrl.substring(0, 100) + '...');
    } catch (error) {
      alert('‚ùå Google Imagen ÊµãËØïÂ§±Ë¥•: ' + error.message);
      console.error('Google Imagen ÊµãËØïÈîôËØØ:', error);
    } finally {
      clearInterval(timer);
      testBtn.disabled = false;
      testBtn.textContent = 'üß™ ÊµãËØïÁîüÊàê';
    }
  }

  async function fetchGoogleImagenModels() {
    const apiKey = document.getElementById('google-imagen-api-key').value.trim();
    const endpoint = document.getElementById('google-imagen-endpoint').value.trim() || 'https://generativelanguage.googleapis.com';

    if (!apiKey || !endpoint) {
      alert('ËØ∑ÂÖàÂ°´ÂÜô API Âú∞ÂùÄÂíåÂØÜÈí•ÔºÅ');
      return;
    }

    const fetchBtn = document.getElementById('google-imagen-fetch-models-btn');
    fetchBtn.disabled = true;
    fetchBtn.textContent = '‚è≥ ÊãâÂèñ‰∏≠...';

    try {
      // Ë∑ü‰∏ªAPIÊãâÂèñÈÄªËæëÂÆåÂÖ®‰∏ÄËá¥
      const isGemini = endpoint.replace(/\/+$/, '') === GEMINI_API_URL || 
                        endpoint.includes('generativelanguage.googleapis.com');

      const fetchUrl = isGemini 
        ? `${GEMINI_API_URL}?key=${getRandomValue(apiKey)}`
        : `${endpoint.replace(/\/+$/, '')}/v1/models`;

      const fetchOptions = isGemini ? {
        method: 'GET',
        mode: 'cors',
        cache: 'no-cache',
        credentials: 'omit'
      } : {
        method: 'GET',
        mode: 'cors',
        cache: 'no-cache',
        credentials: 'omit',
        headers: {
          'Authorization': `Bearer ${getRandomValue(apiKey)}`,
          'Content-Type': 'application/json'
        }
      };

      console.log('üîÑ [Google Imagen] ÊãâÂèñÊ®°ÂûãÂàóË°®:', fetchUrl);

      const response = await fetch(fetchUrl, fetchOptions);

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`ÊãâÂèñÂ§±Ë¥• (${response.status}): ${errorText}`);
      }

      const data = await response.json();
      console.log('üì¶ Ê®°ÂûãÂàóË°®ÂìçÂ∫î:', data);

      // Ë∑ü‰∏ªAPI‰∏ÄÊ†∑ÁöÑËß£ÊûêÊñπÂºè
      let models = isGemini 
        ? (data.models || []).map(model => ({ id: model.name.split('/')[1] || model.name }))
        : (data.data || []);

      if (!models || models.length === 0) {
        throw new Error('ËøîÂõûÁöÑÊ®°ÂûãÂàóË°®‰∏∫Á©∫');
      }

      const select = document.getElementById('google-imagen-model');
      const currentValue = select.value;
      select.innerHTML = '';

      models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.id;
        option.textContent = model.id;
        if (model.id === currentValue) option.selected = true;
        select.appendChild(option);
      });

      alert(`‚úÖ Ê®°ÂûãÂàóË°®Â∑≤Êõ¥Êñ∞ÔºåÂÖ± ${models.length} ‰∏™Ê®°Âûã„ÄÇ`);

    } catch (error) {
      alert('‚ùå ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•: ' + error.message);
      console.error('ÊãâÂèñÊ®°ÂûãÈîôËØØ:', error);
    } finally {
      fetchBtn.disabled = false;
      fetchBtn.textContent = 'üîÑ ÊãâÂèñ';
    }
  }
  // ========== Google Imagen ÁªìÊùü ==========

  function getNovelAISettings() {
    const defaultSettings = {
      resolution: '1024x1024',
      steps: 28,
      cfg_scale: 5,
      sampler: 'k_euler_ancestral',
      seed: -1,
      uc_preset: 1,
      quality_toggle: true,
      smea: true,
      smea_dyn: false,
      default_positive: 'masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style',
      default_negative: 'lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry',
      cors_proxy: 'https://corsproxy.io/?',
      custom_proxy_url: ''
    };

    const saved = localStorage.getItem('novelai-settings');
    if (saved) {
      try {
        return {
          ...defaultSettings,
          ...JSON.parse(saved)
        };
      } catch (e) {
        return defaultSettings;
      }
    }
    return defaultSettings;
  }

  async function generateNaiImageFromPrompt(aiPrompt, chatId) {
      console.log(`üé® [NAIÊ†∏ÂøÉÁîüÊàê] ÂºÄÂßã... Prompt: "${aiPrompt}", ChatID: ${chatId}`);

      const apiKey = localStorage.getItem('novelai-api-key');
      const model = localStorage.getItem('novelai-model') || 'nai-diffusion-4-5-full';
      let settings = getNovelAISettings();
      let boundPresetSettings = null;

      // „ÄêÁ¨¨1Ê≠•„ÄëÂÖàÊ£ÄÊü•ËßíËâ≤ÊúâÊ≤°ÊúâÁªëÂÆöÈ¢ÑËÆæÔºåÊãøÂà∞È¢ÑËÆæÊï∞ÊçÆ
      if (chatId && state.chats[chatId] && state.chats[chatId].settings.naiPresetId) {
        const presetId = state.chats[chatId].settings.naiPresetId;
        const preset = await db.naiPresets.get(presetId);

        if (preset && preset.settings) {
          console.log(`üé® [NAI] Ê£ÄÊµãÂà∞ËßíËâ≤ÁªëÂÆö‰∫ÜÈ¢ÑËÆæ "${preset.name}"ÔºåÊ≠£Âú®Â∫îÁî®È¢ÑËÆæÂèÇÊï∞...`);
          boundPresetSettings = preset.settings;
          settings = { ...settings, ...boundPresetSettings };
        } else {
          console.warn(`[NAI] ËßíËâ≤ÁªëÂÆö‰∫ÜÈ¢ÑËÆæID ${presetId}Ôºå‰ΩÜÊï∞ÊçÆÂ∫ì‰∏≠Êú™ÊâæÂà∞ÔºåÂ∞Ü‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆ„ÄÇ`);
        }
      }

      // „ÄêÁ¨¨2Ê≠•„ÄëÂÜ≥ÂÆöÊèêÁ§∫ËØçÔºå‰ºòÂÖàÁ∫ßÔºöËßíËâ≤‰∏ìÂ±ûÁîªÂ∏à‰∏≤ > ÁªëÂÆöÈ¢ÑËÆæÁîªÂ∏à‰∏≤ > ÂÖ®Â±ÄÈªòËÆ§
      const naiPrompts = getCharacterNAIPrompts(chatId);
      let positiveBase = naiPrompts.positive;
      let negativeBase = naiPrompts.negative;

      // Â¶ÇÊûúËßíËâ≤Ê≤°Êúâ‰∏ìÂ±ûÁîªÂ∏à‰∏≤Ôºå‰ΩÜÁªëÂÆö‰∫ÜÈ¢ÑËÆæ‰∏îÈ¢ÑËÆæÈáåÊúâÁîªÂ∏à‰∏≤ÔºåÁî®È¢ÑËÆæÁöÑ
      if (naiPrompts.source !== 'character' && boundPresetSettings) {
        if (boundPresetSettings.default_positive) {
          positiveBase = boundPresetSettings.default_positive;
          console.log('üìù ‰ΩøÁî®ÁªëÂÆöÈ¢ÑËÆæÁöÑÊ≠£Èù¢ÊèêÁ§∫ËØç:', positiveBase);
        }
        if (boundPresetSettings.default_negative) {
          negativeBase = boundPresetSettings.default_negative;
          console.log('üìù ‰ΩøÁî®ÁªëÂÆöÈ¢ÑËÆæÁöÑË¥üÈù¢ÊèêÁ§∫ËØç:', negativeBase);
        }
      }

      const finalPositivePrompt = aiPrompt + ', ' + positiveBase;
      const finalNegativePrompt = negativeBase;

      console.log(`üìù ÊèêÁ§∫ËØçÊù•Ê∫ê: ${naiPrompts.source === 'character' ? 'ËßíËâ≤‰∏ìÂ±û' : (boundPresetSettings ? 'ÁªëÂÆöÈ¢ÑËÆæ' : 'Á≥ªÁªüÈªòËÆ§')}`);
      console.log('   [+] ÊúÄÁªàÊ≠£Èù¢ÊèêÁ§∫ËØç:', finalPositivePrompt);
      console.log('   [-] ÊúÄÁªàË¥üÈù¢ÊèêÁ§∫ËØç:', finalNegativePrompt);

      if (!apiKey) {
        throw new Error('NovelAI API KeyÊú™ÈÖçÁΩÆ„ÄÇËØ∑Âú®NovelAIËÆæÁΩÆ‰∏≠Â°´ÂÜôAPI Key„ÄÇ');
      }

      const [width, height] = settings.resolution.split('x').map(Number);


      let requestBody;
      if (model.includes('nai-diffusion-4')) {
        requestBody = {
          input: finalPositivePrompt,
          model: model,
          action: 'generate',
          parameters: {
            params_version: 3,
            width: width,
            height: height,
            scale: settings.cfg_scale,
            sampler: settings.sampler,
            steps: settings.steps,
            seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
            n_samples: 1,
            ucPreset: settings.uc_preset,
            qualityToggle: settings.quality_toggle,
            add_original_image: true,
            noise_schedule: 'karras',
            v4_prompt: {
              caption: {
                base_caption: finalPositivePrompt,
                char_captions: []
              },
              use_coords: false,
              use_order: true
            },
            v4_negative_prompt: {
              caption: {
                base_caption: finalNegativePrompt,
                char_captions: []
              },
              legacy_uc: false
            },
            negative_prompt: finalNegativePrompt,
            autoSmea: false,
            dynamic_thresholding: false,
            controlnet_strength: 1,
            legacy: false,
            cfg_rescale: 0,
            legacy_v3_extend: false,
            skip_cfg_above_sigma: null,
            use_coords: false,
            legacy_uc: false,
            normalize_reference_strength_multiple: true,
            inpaintImg2ImgStrength: 1,
            characterPrompts: [],
            deliberate_euler_ancestral_bug: false,
            prefer_brownian: true
          }
        };
      } else {

        requestBody = {
          input: finalPositivePrompt,
          model: model,
          action: 'generate',
          parameters: {
            width: width,
            height: height,
            scale: settings.cfg_scale,
            sampler: settings.sampler,
            steps: settings.steps,
            seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
            n_samples: 1,
            ucPreset: settings.uc_preset,
            qualityToggle: settings.quality_toggle,
            sm: settings.smea,
            sm_dyn: settings.smea_dyn,
            negative_prompt: finalNegativePrompt,
            dynamic_thresholding: false,
            controlnet_strength: 1,
            legacy: false,
            add_original_image: false,
            cfg_rescale: 0,
            noise_schedule: 'native'
          }
        };
      }

      console.log('üöÄ ÂèëÈÄÅNAIËØ∑Ê±Ç:', requestBody);


      let apiUrl;
      if (model.includes('nai-diffusion-4')) {
        apiUrl = 'https://image.novelai.net/ai/generate-image-stream';
      } else {
        apiUrl = 'https://image.novelai.net/ai/generate-image';
      }

      let corsProxy = settings.cors_proxy;
      if (corsProxy === 'custom') {
        corsProxy = settings.custom_proxy_url || '';
      }
      if (corsProxy && corsProxy !== '') {
        apiUrl = corsProxy + apiUrl;
      }


      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + apiKey
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥• (${response.status}): ${errorText}`);
      }

      const contentType = response.headers.get('content-type');
      let zipBlob;
      let imageDataUrl;


      if (contentType && contentType.includes('text/event-stream')) {

        const text = await response.text();
        const lines = text.trim().split('\n');
        let base64Data = null;

        for (let i = lines.length - 1; i >= 0; i--) {
          const line = lines[i].trim();
          if (line.startsWith('data: ') && line !== 'data: [DONE]') {
            const dataContent = line.substring(6);
            try {
              const jsonData = JSON.parse(dataContent);
              if (jsonData.event_type === 'final' && jsonData.image) {
                base64Data = jsonData.image;
                break;
              }
              if (jsonData.data) {
                base64Data = jsonData.data;
                break;
              }
              if (jsonData.image) {
                base64Data = jsonData.image;
                break;
              }
            } catch (e) {
              base64Data = dataContent;
              break;
            }
          }
        }
        if (!base64Data) throw new Error('Êó†Ê≥ï‰ªé SSE ÂìçÂ∫î‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');

        const isPNG = base64Data.startsWith('iVBORw0KGgo');
        const isJPEG = base64Data.startsWith('/9j/');

        if (isPNG || isJPEG) {

          imageDataUrl = `data:${isPNG ? 'image/png' : 'image/jpeg'};base64,${base64Data}`;
        } else {

          const binaryString = atob(base64Data);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
          zipBlob = new Blob([bytes]);
        }
      } else {

        zipBlob = await response.blob();
      }


      if (!imageDataUrl && zipBlob) {
        if (typeof JSZip === 'undefined') throw new Error('JSZipÂ∫ìÊú™Âä†ËΩΩ');

        const zip = await JSZip.loadAsync(zipBlob);
        let imageFile = null;
        for (let filename in zip.files) {
          if (filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
            imageFile = zip.files[filename];
            break;
          }
        }
        if (!imageFile) throw new Error('ZIPÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÂõæÁâá');

        const imageBlob = await imageFile.async('blob');


        imageDataUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(imageBlob);
        });
      }

      console.log(`‚úÖ [NAIÊ†∏ÂøÉÁîüÊàê] ÊàêÂäüÔºÅ`);
      return {
        imageUrl: imageDataUrl,
        fullPrompt: finalPositivePrompt
      };
    }


  function getCharacterNAIPrompts(chatId) {

    const systemSettings = getNovelAISettings();


    if (!chatId || !state.chats[chatId]) {
      console.log('‚ö†Ô∏è NAIÊèêÁ§∫ËØçÔºöÊ≤°ÊúâËßíËâ≤Ôºå‰ΩøÁî®Á≥ªÁªüÈÖçÁΩÆ');
      return {
        positive: systemSettings.default_positive,
        negative: systemSettings.default_negative,
        source: 'system'
      };
    }

    const chat = state.chats[chatId];
    const naiSettings = chat.settings.naiSettings || {};


    if (naiSettings.promptSource === 'character') {
      console.log('‚úÖ NAIÊèêÁ§∫ËØçÔºö‰ΩøÁî®ËßíËâ≤ÈÖçÁΩÆ');
      console.log('   Ê≠£Èù¢:', naiSettings.characterPositivePrompt || '(Á©∫)');
      console.log('   Ë¥üÈù¢:', naiSettings.characterNegativePrompt || '(Á©∫)');

      return {
        positive: naiSettings.characterPositivePrompt || '',
        negative: naiSettings.characterNegativePrompt || '',
        source: 'character'
      };
    } else {
      console.log('‚úÖ NAIÊèêÁ§∫ËØçÔºö‰ΩøÁî®Á≥ªÁªüÈÖçÁΩÆ');
      console.log('   Ê≠£Èù¢:', systemSettings.default_positive || '(Á©∫)');
      console.log('   Ë¥üÈù¢:', systemSettings.default_negative || '(Á©∫)');

      return {
        positive: systemSettings.default_positive,
        negative: systemSettings.default_negative,
        source: 'system'
      };
    }
  }


  async function generateNovelAIImage() {
    const apiKey = document.getElementById('novelai-api-key').value.trim();
    const model = document.getElementById('novelai-model').value;
    const prompt = document.getElementById('nai-test-prompt').value.trim();

    if (!apiKey) {
      alert('ËØ∑ÂÖàÈÖçÁΩÆNovelAI API KeyÔºÅ');
      return;
    }

    if (!prompt) {
      alert('ËØ∑ËæìÂÖ•ÊèêÁ§∫ËØçÔºÅ');
      return;
    }

    const settings = getNovelAISettings();
    const negativePrompt = document.getElementById('nai-test-negative').value.trim();

    const statusDiv = document.getElementById('nai-test-status');
    const resultDiv = document.getElementById('nai-test-result');
    const errorDiv = document.getElementById('nai-test-error');
    const generateBtn = document.getElementById('nai-generate-btn');

    statusDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    errorDiv.style.display = 'none';
    generateBtn.disabled = true;
    generateBtn.textContent = 'ÁîüÊàê‰∏≠...';

    try {
      const [width, height] = settings.resolution.split('x').map(Number);


      let requestBody;

      if (model.includes('nai-diffusion-4')) {

        requestBody = {
          input: prompt,
          model: model,
          action: 'generate',
          parameters: {
            params_version: 3, // V4ÂøÖÈ°ª‰ΩøÁî®ÁâàÊú¨3
            width: width,
            height: height,
            scale: settings.cfg_scale,
            sampler: settings.sampler,
            steps: settings.steps,
            seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
            n_samples: 1,
            ucPreset: settings.uc_preset,
            qualityToggle: settings.quality_toggle,
            autoSmea: false,
            dynamic_thresholding: false,
            controlnet_strength: 1,
            legacy: false,
            add_original_image: true,
            cfg_rescale: 0,
            noise_schedule: 'karras', // V4‰ΩøÁî®karras
            legacy_v3_extend: false,
            skip_cfg_above_sigma: null,
            use_coords: false,
            legacy_uc: false,
            normalize_reference_strength_multiple: true,
            inpaintImg2ImgStrength: 1,
            characterPrompts: [],

            v4_prompt: {
              caption: {
                base_caption: prompt,
                char_captions: []
              },
              use_coords: false,
              use_order: true
            },

            v4_negative_prompt: {
              caption: {
                base_caption: negativePrompt,
                char_captions: []
              },
              legacy_uc: false
            },
            negative_prompt: negativePrompt,
            deliberate_euler_ancestral_bug: false,
            prefer_brownian: true

          }
        };
      } else {

        requestBody = {
          input: prompt,
          model: model,
          action: 'generate',
          parameters: {
            width: width,
            height: height,
            scale: settings.cfg_scale,
            sampler: settings.sampler,
            steps: settings.steps,
            seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
            n_samples: 1,
            ucPreset: settings.uc_preset,
            qualityToggle: settings.quality_toggle,
            sm: settings.smea,
            sm_dyn: settings.smea_dyn,
            dynamic_thresholding: false,
            controlnet_strength: 1,
            legacy: false,
            add_original_image: false,
            cfg_rescale: 0,
            noise_schedule: 'native',
            negative_prompt: negativePrompt
          }
        };
      }

      console.log('üì§ ÂèëÈÄÅËØ∑Ê±ÇÂà∞ NovelAI API');
      console.log('üìä ‰ΩøÁî®Ê®°Âûã:', model);
      console.log('üìã ËØ∑Ê±Ç‰Ωì:', JSON.stringify(requestBody, null, 2));


      let apiUrl;


      if (model.includes('nai-diffusion-4')) {

        apiUrl = 'https://image.novelai.net/ai/generate-image-stream';
      } else {

        apiUrl = 'https://image.novelai.net/ai/generate-image';
      }

      let corsProxy = settings.cors_proxy;


      if (corsProxy === 'custom') {
        corsProxy = settings.custom_proxy_url || '';
      }


      if (corsProxy && corsProxy !== '') {
        apiUrl = corsProxy + encodeURIComponent(apiUrl);
      }


      const isChrome = /Chrome/.test(navigator.userAgent) && !/Edg/.test(navigator.userAgent);
      let fetchOptions = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + apiKey
        },
        body: JSON.stringify(requestBody)
      };


      if (isChrome) {
        console.log('üîß Ê£ÄÊµãÂà∞ChromeÊµèËßàÂô®ÔºåÂêØÁî®headersÂÖºÂÆπÊÄßÂ§ÑÁêÜ');
        const cleanHeaders = {};
        for (const [key, value] of Object.entries(fetchOptions.headers)) {

          cleanHeaders[key] = value.replace(/[^\x00-\xFF]/g, '');
        }
        fetchOptions.headers = cleanHeaders;
      }

      const response = await fetch(apiUrl, fetchOptions);

      console.log('Response status:', response.status);
      console.log('Response headers:', [...response.headers.entries()]);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('APIÈîôËØØÂìçÂ∫î:', errorText);
        throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥• (${response.status}): ${errorText}`);
      }


      const contentType = response.headers.get('content-type');
      console.log('Content-Type:', contentType);


      let zipBlob;
      if (contentType && contentType.includes('text/event-stream')) {
        console.log('Ê£ÄÊµãÂà∞ SSE ÊµÅÂºèÂìçÂ∫îÔºåÂºÄÂßãËß£Êûê...');
        statusDiv.textContent = 'Ê≠£Âú®Êé•Êî∂ÊµÅÂºèÊï∞ÊçÆ...';


        const text = await response.text();
        console.log('Êî∂Âà∞ SSE Êï∞ÊçÆÔºåÂ§ßÂ∞è:', text.length);

        const lines = text.trim().split('\n');
        let base64Data = null;

        for (let i = lines.length - 1; i >= 0; i--) {
          const line = lines[i].trim();
          if (line.startsWith('data: ') && line !== 'data: [DONE]') {
            const dataContent = line.substring(6);


            try {
              const jsonData = JSON.parse(dataContent);


              if (jsonData.event_type === 'final' && jsonData.image) {
                base64Data = jsonData.image;
                console.log('‚úÖ ÊâæÂà∞ final ‰∫ã‰ª∂ÁöÑÂõæÁâáÊï∞ÊçÆ');
                break;
              }


              if (jsonData.data) {
                base64Data = jsonData.data;
                console.log('‰ªé JSON.data ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                break;
              }
              if (jsonData.image) {
                base64Data = jsonData.image;
                console.log('‰ªé JSON.image ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                break;
              }
            } catch (e) {

              base64Data = dataContent;
              console.log('Áõ¥Êé•‰ΩøÁî® base64 Êï∞ÊçÆ');
              break;
            }
          }
        }

        if (!base64Data) {
          throw new Error('Êó†Ê≥ï‰ªé SSE ÂìçÂ∫î‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
        }


        const isPNG = base64Data.startsWith('iVBORw0KGgo');
        const isJPEG = base64Data.startsWith('/9j/');

        if (isPNG || isJPEG) {
          console.log('‚úÖ Ê£ÄÊµãÂà∞Áõ¥Êé•ÁöÑÂõæÁâá base64 Êï∞ÊçÆ (PNG/JPEG)');

          const binaryString = atob(base64Data);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const imageBlob = new Blob([bytes], {
            type: isPNG ? 'image/png' : 'image/jpeg'
          });
          console.log('ÂõæÁâá Blob ÂàõÂª∫ÊàêÂäüÔºåÂ§ßÂ∞è:', imageBlob.size);

          // Áõ¥Êé•ÊòæÁ§∫ÂõæÁâá
          const imageUrl = URL.createObjectURL(imageBlob);
          document.getElementById('nai-result-image').src = imageUrl;
          statusDiv.style.display = 'none';
          resultDiv.style.display = 'block';
          console.log('‚úÖ ÂõæÁâáÊòæÁ§∫ÊàêÂäüÔºÅüé®');
          return;
        }


        console.log('ÂΩì‰Ωú ZIP Êñá‰ª∂Â§ÑÁêÜ...');
        const binaryString = atob(base64Data);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        zipBlob = new Blob([bytes]);
        console.log('ZIP Blob Â§ßÂ∞è:', zipBlob.size);

      } else {

        zipBlob = await response.blob();
        console.log('Êî∂Âà∞Êï∞ÊçÆÔºåÁ±ªÂûã:', zipBlob.type, 'Â§ßÂ∞è:', zipBlob.size);
      }


      try {

        if (typeof JSZip === 'undefined') {
          throw new Error('JSZipÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
        }

        statusDiv.textContent = 'Ê≠£Âú®Ëß£ÂéãÂõæÁâá...';

        const zip = await JSZip.loadAsync(zipBlob);
        console.log('ZIPÊñá‰ª∂ÂÜÖÂÆπ:', Object.keys(zip.files));

        let imageFile = null;
        for (let filename in zip.files) {
          if (filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
            imageFile = zip.files[filename];
            console.log('ÊâæÂà∞ÂõæÁâáÊñá‰ª∂:', filename);
            break;
          }
        }

        if (!imageFile) {
          throw new Error('ZIPÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÂõæÁâá');
        }

        const imageBlob = await imageFile.async('blob');
        console.log('ÊèêÂèñÁöÑÂõæÁâáÂ§ßÂ∞è:', imageBlob.size);

        const imageUrl = URL.createObjectURL(imageBlob);
        console.log('ÁîüÊàêÁöÑÂõæÁâáURL:', imageUrl);

        document.getElementById('nai-result-image').src = imageUrl;
        statusDiv.style.display = 'none';
        resultDiv.style.display = 'block';

      } catch (zipError) {
        console.error('ZIPËß£ÂéãÂ§±Ë¥•:', zipError);

        console.log('Â∞ùËØïÁõ¥Êé•‰Ωú‰∏∫ÂõæÁâáÊòæÁ§∫...');

        if (zipBlob.type.startsWith('image/')) {
          const imageUrl = URL.createObjectURL(zipBlob);
          document.getElementById('nai-result-image').src = imageUrl;
          statusDiv.style.display = 'none';
          resultDiv.style.display = 'block';
        } else {
          throw new Error('ÂõæÁâáÊ†ºÂºèÂ§ÑÁêÜÂ§±Ë¥•: ' + zipError.message);
        }
      }

    } catch (error) {
      console.error('NovelAIÁîüÊàêÂ§±Ë¥•:', error);
      statusDiv.style.display = 'none';
      errorDiv.style.display = 'block';
      errorDiv.textContent = 'ÁîüÊàêÂ§±Ë¥•: ' + error.message;
    } finally {
      generateBtn.disabled = false;
      generateBtn.textContent = 'ÁîüÊàêÂõæÂÉè';
    }
  }

  function showNotification(chatId, messageContent) {
    const chat = state.chats[chatId];
    if (!chat) return;

    // Ê£ÄÊü•ÊòØÂê¶Á¶ÅÁî®ÂÜÖÈÉ®ÂºπÁ™óÈÄöÁü•
    const disableInternalNotification = state.globalSettings.systemNotification?.disableInternalNotification || false;

    // Â¶ÇÊûúÊú™Á¶ÅÁî®ÂÜÖÈÉ®ÂºπÁ™óÔºåÂàôÊòæÁ§∫ÂÜÖÈÉ®ÂºπÁ™ó
    if (!disableInternalNotification) {
      playNotificationSound();

      clearTimeout(notificationTimeout);

      const bar = document.getElementById('notification-bar');

      document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar;
      document.getElementById('notification-content').querySelector('.name').textContent = chat.name;
      document.getElementById('notification-content').querySelector('.message').textContent = messageContent;

      bar.classList.remove('visible');

      void bar.offsetWidth;

      bar.classList.add('visible');

      const newBar = bar.cloneNode(true);
      bar.parentNode.replaceChild(newBar, bar);
      newBar.addEventListener('click', () => {
        openChat(chatId);
        newBar.classList.remove('visible');
      });

      notificationTimeout = setTimeout(() => {
        newBar.classList.remove('visible');
      }, 4000);
      updateBackButtonUnreadCount();
    }

    // Êñ∞Â¢ûÔºöËß¶ÂèëÁ≥ªÁªüÁ∫ßÈÄöÁü•
    console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] showNotification Ë¢´Ë∞ÉÁî®:', {
      chatId,
      messageContent,
      systemNotificationEnabled: state.globalSettings.systemNotification?.enabled,
      disableInternalNotification: disableInternalNotification,
      notificationPermission: typeof Notification !== 'undefined' ? Notification.permission : 'N/A'
    });

    if (state.globalSettings.systemNotification?.enabled) {
      console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ÂáÜÂ§áË∞ÉÁî® handleSystemNotification');
      handleSystemNotification(chatId, messageContent);
    } else {
      console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] Á≥ªÁªüÈÄöÁü•Êú™ÂêØÁî®ÊàñÈÖçÁΩÆ‰∏çÂ≠òÂú®');
    }
  }

  // Êñ∞Â¢ûÔºöÂú®ËÅäÂ§©È°µÈù¢‰πüËß¶ÂèëÁ≥ªÁªüÁ∫ßÈÄöÁü•ÔºàÂ¶ÇÊûúÂêØÁî®‰∫ÜÁõ∏Â∫îÈÄâÈ°πÔºâ
  function triggerSystemNotificationInChatPage(chatId, messageContent) {
    // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®‰∫Ü"Âú®ËÅäÂ§©È°µÈù¢‰πüÂèëÈÄÅÈÄöÁü•"ÈÄâÈ°π
    const notifyInChatPage = state.globalSettings.systemNotification?.notifyInChatPage || false;

    if (notifyInChatPage && state.globalSettings.systemNotification?.enabled) {
      console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] Âú®ËÅäÂ§©È°µÈù¢Ëß¶ÂèëÁ≥ªÁªüÁ∫ßÈÄöÁü•:', {
        chatId,
        messageContent
      });
      handleSystemNotification(chatId, messageContent);
    }
  }

  function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit'
    });
    const dateString = now.toLocaleDateString('zh-CN', {
      weekday: 'long',
      month: 'long',
      day: 'numeric'
    });


    document.getElementById('status-bar-time').textContent = timeString;

  }



  function parseAiResponse(content) {
    if (!content) return [{
      type: 'text',
      content: '(AIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπ)'
    }];

    let trimmedContent = content.trim();


    const markdownRegex = /```json\s*([\s\S]*?)\s*```/;
    const markdownMatch = trimmedContent.match(markdownRegex);

    if (markdownMatch && markdownMatch[1]) {

      trimmedContent = markdownMatch[1].trim();
      console.log("Ëß£ÊûêÂô®ÔºöÂ∑≤ÂêØÁî® Markdown ÊèêÂèñÊ®°Âºè„ÄÇ");
    }


    if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
      try {
        const parsed = JSON.parse(trimmedContent);
        if (Array.isArray(parsed)) {
          console.log("Ëß£ÊûêÊàêÂäüÔºöÊ†áÂáÜJSONÊï∞ÁªÑÊ†ºÂºè„ÄÇ");
          return parsed;
        }
      } catch (e) {
        console.warn("Ê†áÂáÜJSONÊï∞ÁªÑËß£ÊûêÂ§±Ë¥•ÔºåÂ∞ÜÂ∞ùËØïÂº∫ÂäõÊèêÂèñ...");
      }
    }


    const startIndex = trimmedContent.indexOf('[');


    const lastBraceIndex = trimmedContent.lastIndexOf('}');

    if (startIndex !== -1 && lastBraceIndex !== -1 && lastBraceIndex > startIndex) {


      const endIndex = trimmedContent.indexOf(']', lastBraceIndex);

      if (endIndex !== -1) {
        const arrayString = trimmedContent.substring(startIndex, endIndex + 1);
        try {
          const parsed = JSON.parse(arrayString);
          if (Array.isArray(parsed)) {
            console.log("Ëß£ÊûêÊàêÂäüÔºöÈÄöËøáÂº∫ÂäõÊèêÂèñ [ ... } ... ] Ê®°Âºè„ÄÇ");
            return parsed;
          }
        } catch (e) {
          console.warn("Âº∫ÂäõÊèêÂèñ [ ... } ... ] Â§±Ë¥•ÔºåÂ∞ÜÂ∞ùËØïÊèêÂèñÂçï‰∏™ÂØπË±°...");
        }
      }
    }


    const jsonMatches = trimmedContent.match(/{[^{}]*}/g);
    if (jsonMatches) {
      const results = [];
      for (const match of jsonMatches) {
        try {
          const parsedObject = JSON.parse(match);
          results.push(parsedObject);
        } catch (e) {
          console.warn("Ë∑≥Ëøá‰∏Ä‰∏™Êó†ÊïàÁöÑJSONÁâáÊÆµ:", match);
        }
      }

      if (results.length > 0) {
        console.log("Ëß£ÊûêÊàêÂäüÔºöÈÄöËøáÂº∫ÂäõÊèêÂèñ {...} Ê®°Âºè„ÄÇ");
        return results;
      }
    }


    console.error("ÊâÄÊúâËß£ÊûêÊñπÊ°àÂùáÂ§±Ë¥•ÔºÅÂ∞ÜËøîÂõûÂéüÂßãÊñáÊú¨„ÄÇÂéüÂßãÂõûÂ§ç:", content);
    return [{
      type: 'text',
      content: content
    }];
  }

  function getTimeOfDayGreeting(date = new Date()) {
    const hour = date.getHours();
    if (hour >= 0 && hour < 5) {
      return "ÂáåÊô®";
    } else if (hour >= 5 && hour < 9) {
      return "Êó©‰∏ä";
    } else if (hour >= 9 && hour < 13) {
      return "‰∏äÂçà";
    } else if (hour >= 13 && hour < 18) {
      return "‰∏ãÂçà";
    } else if (hour >= 18 && hour < 24) {
      return "Êôö‰∏ä";
    }
    return "Áé∞Âú®";
  }



  async function loadApiPresetsDropdown(forceSelectedId = null) {
    const selectEl = document.getElementById('api-preset-select');
    selectEl.innerHTML = '<option value="current">ÂΩìÂâçÈÖçÁΩÆ (Êú™‰øùÂ≠ò)</option>';

    const presets = await db.apiPresets.toArray();
    presets.forEach(preset => {
      const option = document.createElement('option');
      option.value = preset.id;
      option.textContent = preset.name;
      selectEl.appendChild(option);
    });

    if (forceSelectedId) { // <--- 2. Êñ∞Â¢ûËøôÊÆµÂà§Êñ≠ÈÄªËæë
      selectEl.value = forceSelectedId;
      return;
    }
    const currentConfig = state.apiConfig;
    let matchingPresetId = null;
    for (const preset of presets) {

      if (
        preset.proxyUrl === currentConfig.proxyUrl &&
        preset.apiKey === currentConfig.apiKey &&
        preset.model === currentConfig.model &&
        preset.secondaryProxyUrl === currentConfig.secondaryProxyUrl &&
        preset.secondaryApiKey === currentConfig.secondaryApiKey &&
        preset.secondaryModel === currentConfig.secondaryModel &&

        (preset.minimaxGroupId || '') === (currentConfig.minimaxGroupId || '') &&
        (preset.minimaxApiKey || '') === (currentConfig.minimaxApiKey || '') &&
        (preset.minimaxModel || 'speech-01') === (currentConfig.minimaxModel || 'speech-01')
      ) {
        matchingPresetId = preset.id;
        break;
      }
    }

    if (matchingPresetId) {
      selectEl.value = matchingPresetId;
    } else {
      selectEl.value = 'current';
    }
  }


  async function handlePresetSelectionChange() {
    const selectEl = document.getElementById('api-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
      return;
    }

    const preset = await db.apiPresets.get(selectedId);
    if (preset) {
      // 1. Âä†ËΩΩÈ¢ÑËÆæ (Ëøô‰ºöË¶ÜÁõñÂΩìÂâçÁöÑ config)
      state.apiConfig = {
        id: 'main',
        proxyUrl: preset.proxyUrl,
        apiKey: preset.apiKey,
        model: preset.model,
        secondaryProxyUrl: preset.secondaryProxyUrl,
        secondaryApiKey: preset.secondaryApiKey,
        secondaryModel: preset.secondaryModel,
        minimaxGroupId: preset.minimaxGroupId,
        minimaxApiKey: preset.minimaxApiKey,
        minimaxModel: preset.minimaxModel
      };


      const savedImgbbEnabled = localStorage.getItem('imgbb-enabled');
      const savedImgbbKey = localStorage.getItem('imgbb-api-key');
      const savedCatboxEnabled = localStorage.getItem('catbox-enabled');
      const savedCatboxHash = localStorage.getItem('catbox-userhash');

      if (savedImgbbEnabled !== null) state.apiConfig.imgbbEnable = (savedImgbbEnabled === 'true');
      if (savedImgbbKey !== null) state.apiConfig.imgbbApiKey = savedImgbbKey;

      if (savedCatboxEnabled !== null) state.apiConfig.catboxEnable = (savedCatboxEnabled === 'true');
      if (savedCatboxHash !== null) state.apiConfig.catboxUserHash = savedCatboxHash;
      const savedMinimaxGroupId = localStorage.getItem('minimax-group-id');
      const savedMinimaxApiKey = localStorage.getItem('minimax-api-key');
      const savedMinimaxModel = localStorage.getItem('minimax-model');

      if (savedMinimaxGroupId !== null) state.apiConfig.minimaxGroupId = savedMinimaxGroupId;
      if (savedMinimaxApiKey !== null) state.apiConfig.minimaxApiKey = savedMinimaxApiKey;
      if (savedMinimaxModel !== null) state.apiConfig.minimaxModel = savedMinimaxModel;
      const savedGhEnabled = localStorage.getItem('github-enabled');
      const savedGhAuto = localStorage.getItem('github-auto-backup');
      const savedGhInterval = localStorage.getItem('github-backup-interval');
      const savedGhProxyEnabled = localStorage.getItem('github-proxy-enabled');
      const savedGhProxyUrl = localStorage.getItem('github-proxy-url');

      // ÂÖ≥ÈîÆÔºöËØªÂèñË¥¶Âè∑‰ø°ÊÅØ
      const savedGhUsername = localStorage.getItem('github-username');
      const savedGhRepo = localStorage.getItem('github-repo');
      const savedGhToken = localStorage.getItem('github-token');
      const savedGhFilename = localStorage.getItem('github-filename');

      if (savedGhEnabled !== null) state.apiConfig.githubEnable = (savedGhEnabled === 'true');
      if (savedGhAuto !== null) state.apiConfig.githubAutoBackup = (savedGhAuto === 'true');
      if (savedGhInterval !== null) state.apiConfig.githubBackupInterval = parseInt(savedGhInterval);
      if (savedGhProxyEnabled !== null) state.apiConfig.githubProxyEnable = (savedGhProxyEnabled === 'true');
      if (savedGhProxyUrl !== null) state.apiConfig.githubProxyUrl = savedGhProxyUrl;

      if (savedGhUsername !== null) state.apiConfig.githubUsername = savedGhUsername;
      if (savedGhRepo !== null) state.apiConfig.githubRepo = savedGhRepo;
      if (savedGhToken !== null) state.apiConfig.githubToken = savedGhToken;
      if (savedGhFilename !== null) state.apiConfig.githubFilename = savedGhFilename;
      await db.apiConfig.put(state.apiConfig);

      renderApiSettings(selectedId);

      // Á°Æ‰øùÊâãÂÜôËæìÂÖ•Ê°ÜË¢´Ê≠£Á°ÆÂ°´ÂÖÖ
      document.getElementById('model-input').value = preset.model || '';
      document.getElementById('secondary-model-input').value = preset.secondaryModel || '';

      document.getElementById('fetch-models-btn').click();
      if (preset.secondaryProxyUrl && preset.secondaryApiKey) {
        document.getElementById('fetch-secondary-models-btn').click();
      }
      //alert(`Â∑≤Âä†ËΩΩÈ¢ÑËÆæ ‚Äú${preset.name}‚Äù`);
    }
  }


  async function saveApiPreset() {
    const name = await showCustomPrompt('‰øùÂ≠ò API È¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
    if (!name || !name.trim()) return;


    const presetData = {
      name: name.trim(),
      proxyUrl: document.getElementById('proxy-url').value.trim(),
      apiKey: document.getElementById('api-key').value.trim(),
      // ‰ºòÂÖà‰øùÂ≠òÊâãÂÜôËæìÂÖ•Ê°ÜÁöÑÂÄº
      model: document.getElementById('model-input').value.trim() || document.getElementById('model-select').value,
      secondaryProxyUrl: document.getElementById('secondary-proxy-url').value.trim(),
      secondaryApiKey: document.getElementById('secondary-api-key').value.trim(),
      // ‰ºòÂÖà‰øùÂ≠òÊâãÂÜôËæìÂÖ•Ê°ÜÁöÑÂÄº
      secondaryModel: document.getElementById('secondary-model-input').value.trim() || document.getElementById('secondary-model-select').value,

      minimaxGroupId: document.getElementById('minimax-group-id').value.trim(),
      minimaxApiKey: document.getElementById('minimax-api-key').value.trim(),
      minimaxModel: document.getElementById('minimax-model-select').value

    };


    const existingPreset = await db.apiPresets.where('name').equals(presetData.name).first();
    if (existingPreset) {
      const confirmed = await showCustomConfirm('Ë¶ÜÁõñÈ¢ÑËÆæ', `Âêç‰∏∫ ‚Äú${presetData.name}‚Äù ÁöÑÈ¢ÑËÆæÂ∑≤Â≠òÂú®„ÄÇË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      });
      if (!confirmed) return;
      presetData.id = existingPreset.id;
    }

    await db.apiPresets.put(presetData);
    await loadApiPresetsDropdown();
    alert('API È¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ');
  }


  async function deleteApiPreset() {
    const selectEl = document.getElementById('api-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
      alert('ËØ∑ÂÖà‰ªé‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ„ÄÇ');
      return;
    }

    const preset = await db.apiPresets.get(selectedId);
    if (!preset) return;

    const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ ‚Äú${preset.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.apiPresets.delete(selectedId);
      await loadApiPresetsDropdown();
      alert('È¢ÑËÆæÂ∑≤Âà†Èô§„ÄÇ');
    }
  }

  function renderApiSettings(forcePresetId = null) {

    document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || '';
    document.getElementById('api-key').value = state.apiConfig.apiKey || '';
    document.getElementById('secondary-proxy-url').value = state.apiConfig.secondaryProxyUrl || '';
    document.getElementById('secondary-api-key').value = state.apiConfig.secondaryApiKey || '';
    document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;
    document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
    document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;
    document.getElementById('enable-ai-drawing-switch').checked = state.globalSettings.enableAiDrawing;

    // Êñ∞Â¢ûÔºöËØªÂèñÂøÉÂ£∞ÂíåÂä®ÊÄÅÂäüËÉΩÂºÄÂÖ≥
    document.getElementById('global-enable-thoughts-switch').checked = state.globalSettings.enableThoughts || false;
    document.getElementById('global-enable-qzone-actions-switch').checked = state.globalSettings.enableQzoneActions || false;
    document.getElementById('global-enable-view-myphone-switch').checked = state.globalSettings.enableViewMyPhone || false;

    document.getElementById('chat-render-window-input').value = state.globalSettings.chatRenderWindow || 50;
    document.getElementById('chat-list-render-window-input').value = state.globalSettings.chatListRenderWindow || 30;
    const tempSlider = document.getElementById('api-temperature-slider');
    const tempValue = document.getElementById('api-temperature-value');
    const savedTemp = state.globalSettings.apiTemperature || 0.8;
    tempSlider.value = savedTemp;
    tempValue.textContent = savedTemp;
    
    // ÊñπÊ°à4ÔºöÂä†ËΩΩAPIÂéÜÂè≤ËÆ∞ÂΩïÂºÄÂÖ≥Áä∂ÊÄÅÔºàÈªòËÆ§ÂÖ≥Èó≠‰ª•ÂáèÂ∞èÂØºÂá∫Êñá‰ª∂‰ΩìÁßØÔºâ
    const apiHistorySwitch = document.getElementById('enable-api-history-switch');
    if (apiHistorySwitch) {
      apiHistorySwitch.checked = state.globalSettings.enableApiHistory || false;
    }
    const savedMinimaxGroupId = localStorage.getItem('minimax-group-id');
    const savedMinimaxApiKey = localStorage.getItem('minimax-api-key');
    const savedMinimaxModel = localStorage.getItem('minimax-model');


    if (savedMinimaxGroupId !== null) state.apiConfig.minimaxGroupId = savedMinimaxGroupId;
    if (savedMinimaxApiKey !== null) state.apiConfig.minimaxApiKey = savedMinimaxApiKey;
    if (savedMinimaxModel !== null) state.apiConfig.minimaxModel = savedMinimaxModel;


    document.getElementById('minimax-group-id').value = state.apiConfig.minimaxGroupId || '';
    document.getElementById('minimax-api-key').value = state.apiConfig.minimaxApiKey || '';
    const minimaxSelect = document.getElementById('minimax-model-select');
    if (minimaxSelect) {
      // 1. Â°´ÂÖÖÊ®°ÂûãÂàóË°® (Â∑≤Êé•ÂÖ• Minimax ÂÖ®Á≥ªÂàóÊ®°Âûã)
      const supportedMinimaxModels = [
        // --- 01 Á≥ªÂàó (ÁªèÂÖ∏) ---

        { id: 'speech-01-turbo', name: 'Speech-01 Turbo (Âø´ÈÄüÁâà)' },
        { id: 'speech-01-hd', name: 'Speech-01 HD (È´òÊ∏ÖÁâà)' },


        // --- 02 Á≥ªÂàó ---

        { id: 'speech-02-turbo', name: 'Speech-02 Turbo' },
        { id: 'speech-02-hd', name: 'Speech-02 HD' },

        // --- 2.x Á≥ªÂàó (ÂåÖÂê´ÊÇ®Ë¶ÅÁöÑ 2.5) ---
        { id: 'speech-2.5-hd-preview', name: 'Speech-2.5 HD (È´òÊ∏Ö)' },
        { id: 'speech-2.6-turbo', name: 'Speech-2.6 Turbo' },
        { id: 'speech-2.6-hd', name: 'Speech-2.6 HD' },


      ];

      minimaxSelect.innerHTML = '';
      supportedMinimaxModels.forEach(m => {
        const option = document.createElement('option');
        option.value = m.id;
        option.textContent = m.name;
        minimaxSelect.appendChild(option);
      });
      minimaxSelect.value = state.apiConfig.minimaxModel || 'speech-01';

      // 2. „ÄêÊñ∞Â¢û„ÄëÂä®ÊÄÅÊèíÂÖ•‚ÄúÊé•Âè£ÂüüÂêç‚ÄùÈÄâÊã©Ê°Ü (Â¶ÇÊûúËøòÊ≤°ÊúâÁöÑËØù)


      // 3. „ÄêÊñ∞Â¢û„ÄëÂõûÊòæ‰øùÂ≠òÁöÑËÆæÁΩÆ
      const domainSelect = document.getElementById('minimax-domain-select');
      if (domainSelect) {
        // ‰ºòÂÖàËØªÂèñ stateÔºåÊ≤°ÊúâÂàôËØªÂèñ localStorageÔºåÈªòËÆ§ÂõΩÂÜÖ
        domainSelect.value = state.apiConfig.minimaxDomain || localStorage.getItem('minimax-domain') || 'https://api.minimax.chat';
      }
    }


    const novelaiEnabled = localStorage.getItem('novelai-enabled') === 'true';
    const novelaiModel = localStorage.getItem('novelai-model') || 'nai-diffusion-4-5-full';
    const novelaiApiKey = localStorage.getItem('novelai-api-key') || '';
    document.getElementById('novelai-switch').checked = novelaiEnabled;
    document.getElementById('novelai-model').value = novelaiModel;
    document.getElementById('novelai-api-key').value = novelaiApiKey;
    document.getElementById('novelai-details').style.display = novelaiEnabled ? 'block' : 'none';

    // Google Imagen ËÆæÁΩÆÂä†ËΩΩ
    const googleImagenEnabled = localStorage.getItem('google-imagen-enabled') === 'true';
    const googleImagenModel = localStorage.getItem('google-imagen-model') || 'imagen-4.0-generate-001';
    const googleImagenApiKey = localStorage.getItem('google-imagen-api-key') || '';
    const googleImagenSettings = getGoogleImagenSettings();
    document.getElementById('google-imagen-switch').checked = googleImagenEnabled;
    document.getElementById('google-imagen-model').value = googleImagenModel;
    document.getElementById('google-imagen-api-key').value = googleImagenApiKey;
    document.getElementById('google-imagen-endpoint').value = googleImagenSettings.endpoint || 'https://generativelanguage.googleapis.com';
    document.getElementById('google-imagen-aspect-ratio').value = googleImagenSettings.aspectRatio || '1:1';
    document.getElementById('google-imagen-details').style.display = googleImagenEnabled ? 'block' : 'none';

    const imgbbEnableSwitch = document.getElementById('imgbb-enable-switch');
    const imgbbApiKeyInput = document.getElementById('imgbb-api-key');
    const imgbbDetailsDiv = document.getElementById('imgbb-settings-details');


    const savedImgbbEnabled = localStorage.getItem('imgbb-enabled');
    const savedImgbbKey = localStorage.getItem('imgbb-api-key');


    if (savedImgbbEnabled !== null) state.apiConfig.imgbbEnable = (savedImgbbEnabled === 'true');
    if (savedImgbbKey !== null) state.apiConfig.imgbbApiKey = savedImgbbKey;

    if (imgbbEnableSwitch) {
      imgbbEnableSwitch.checked = state.apiConfig.imgbbEnable || false;
      imgbbApiKeyInput.value = state.apiConfig.imgbbApiKey || '';
      imgbbDetailsDiv.style.display = imgbbEnableSwitch.checked ? 'block' : 'none';
    }


    const catboxEnableSwitch = document.getElementById('catbox-enable-switch');
    const catboxUserHashInput = document.getElementById('catbox-userhash');
    const catboxDetailsDiv = document.getElementById('catbox-settings-details');


    const savedCatboxEnabled = localStorage.getItem('catbox-enabled');
    const savedCatboxHash = localStorage.getItem('catbox-userhash');


    if (savedCatboxEnabled !== null) state.apiConfig.catboxEnable = (savedCatboxEnabled === 'true');
    if (savedCatboxHash !== null) state.apiConfig.catboxUserHash = savedCatboxHash;

    if (catboxEnableSwitch) {
      catboxEnableSwitch.checked = state.apiConfig.catboxEnable || false;
      catboxUserHashInput.value = state.apiConfig.catboxUserHash || '';
      catboxDetailsDiv.style.display = catboxEnableSwitch.checked ? 'block' : 'none';
    }
    const ghSwitch = document.getElementById('github-enable-switch');
    const ghDetails = document.getElementById('github-settings-details');

    // ‰ªé localStorage ËØªÂèñÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôËØªÂèñ apiConfig (‰øùÊåÅ‰∏ÄËá¥ÊÄß)
    const savedGhEnabled = localStorage.getItem('github-enabled');
    if (savedGhEnabled !== null) state.apiConfig.githubEnable = (savedGhEnabled === 'true');

    if (ghSwitch) {
      ghSwitch.checked = state.apiConfig.githubEnable || false;

      // Ê†∏ÂøÉÈÄªËæëÔºöÊ†πÊçÆÂºÄÂÖ≥Áä∂ÊÄÅÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫ËØ¶ÊÉÖÊ°Ü
      ghDetails.style.display = ghSwitch.checked ? 'block' : 'none';
      const ghAutoSwitch = document.getElementById('github-auto-backup-switch');
      const ghIntervalInput = document.getElementById('github-backup-interval'); // „ÄêÊñ∞Â¢û„Äë

      if (ghAutoSwitch) {
        const savedAuto = localStorage.getItem('github-auto-backup');
        ghAutoSwitch.checked = savedAuto !== null ? (savedAuto === 'true') : false;

        // „ÄêÊñ∞Â¢û„ÄëÂõûÊòæÂàÜÈíüÊï∞ÔºåÈªòËÆ§ 30
        const savedInterval = localStorage.getItem('github-backup-interval');
        if (ghIntervalInput) {
          ghIntervalInput.value = savedInterval ? parseInt(savedInterval) : 30;
        }
      }
      // ÂõûÊòæËæìÂÖ•Ê°ÜÁöÑÂÄº
      document.getElementById('github-username').value = state.apiConfig.githubUsername || '';
      document.getElementById('github-repo').value = state.apiConfig.githubRepo || '';
      document.getElementById('github-token').value = state.apiConfig.githubToken || '';
      document.getElementById('github-filename').value = state.apiConfig.githubFilename || 'ephone_backup.json';
      const ghProxySwitch = document.getElementById('github-proxy-switch');
      const ghProxyInputDiv = document.getElementById('github-proxy-input-group');
      const ghProxyUrlInput = document.getElementById('github-proxy-url');

      // ËØªÂèñ‰øùÂ≠òÁöÑËÆæÁΩÆ
      const savedGhProxyEnabled = localStorage.getItem('github-proxy-enabled');
      const savedGhProxyUrl = localStorage.getItem('github-proxy-url');

      // ËÆæÁΩÆÁä∂ÊÄÅ
      state.apiConfig.githubProxyEnable = savedGhProxyEnabled === 'true';
      state.apiConfig.githubProxyUrl = savedGhProxyUrl || '';

      if (ghProxySwitch) {
        ghProxySwitch.checked = state.apiConfig.githubProxyEnable;
        ghProxyInputDiv.style.display = ghProxySwitch.checked ? 'block' : 'none';
        ghProxyUrlInput.value = state.apiConfig.githubProxyUrl || '';

        // ÁªëÂÆöÂàáÊç¢‰∫ã‰ª∂ÔºåÊéßÂà∂ËæìÂÖ•Ê°ÜÊòæÁ§∫
        ghProxySwitch.addEventListener('change', (e) => {
          ghProxyInputDiv.style.display = e.target.checked ? 'block' : 'none';
        });
      }
    }

    // Â°´ÂÖÖÊâãÂÜôËæìÂÖ•Ê°ÜÔºàÊ®°ÂûãÔºâ
    const modelInput = document.getElementById('model-input');
    const secondaryModelInput = document.getElementById('secondary-model-input');
    if (modelInput) {
      modelInput.value = state.apiConfig.model || '';
    }
    if (secondaryModelInput) {
      secondaryModelInput.value = state.apiConfig.secondaryModel || '';
    }

    loadApiPresetsDropdown(forcePresetId);
    displayTotalImageSize();
  }

  window.renderApiSettingsProxy = renderApiSettings;



  async function renderNpcListScreen() {
    const listEl = document.getElementById('npc-list');
    listEl.innerHTML = '';

    const npcs = await db.npcs.toArray();

    if (npcs.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰ΩïNPCÔºå<br>ÁÇπÂáªÂè≥‰∏äËßí‚Äú+‚ÄùÊ∑ªÂä†Á¨¨‰∏Ä‰∏™ÂêßÔºÅ</p>';
      return;
    }

    npcs.forEach(npc => {
      const item = document.createElement('div');
      item.className = 'chat-list-item';
      item.dataset.npcId = npc.id;

      item.innerHTML = `
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar" style="border-radius: 50%;">
            <div class="info">
                <div class="name-line">
                    <span class="name">${npc.name}</span>
                </div>
                <div class="last-msg">${npc.persona.substring(0, 30)}...</div>
            </div>
        `;

      item.addEventListener('click', () => openNpcEditor(npc.id));


      addLongPressListener(item, async () => {
        await deleteNpc(npc.id);
      });

      listEl.appendChild(item);
    });
  }



  async function openNpcEditor(npcId = null) {
    editingNpcId = npcId;
    const modal = document.getElementById('npc-editor-modal');
    const titleEl = document.getElementById('npc-editor-title');
    const nameInput = document.getElementById('npc-name-input');
    const personaInput = document.getElementById('npc-persona-input');
    const avatarPreview = document.getElementById('npc-avatar-preview');
    const associationListEl = document.getElementById('npc-association-list');


    const groupSelectEl = document.getElementById('npc-group-select');

    const activitySwitch = document.getElementById('npc-background-activity-switch');
    const cooldownInput = document.getElementById('npc-action-cooldown-input');

    associationListEl.innerHTML = '';
    groupSelectEl.innerHTML = '<option value="">-- Êú™ÂàÜÁªÑ --</option>';


    const npcGroups = await db.npcGroups.toArray();
    npcGroups.forEach(group => {
      const option = document.createElement('option');
      option.value = group.id;
      option.textContent = group.name;
      groupSelectEl.appendChild(option);
    });


    associationListEl.innerHTML += `<label><input type="checkbox" value="user"> ${state.qzoneSettings.nickname || 'Êàë'} (Áî®Êà∑)</label>`;
    Object.values(state.chats).filter(c => !c.isGroup).forEach(char => {
      associationListEl.innerHTML += `<label><input type="checkbox" value="${char.id}"> ${char.name} (ËßíËâ≤)</label>`;
    });

    if (npcId) {
      titleEl.textContent = 'ÁºñËæë NPC';
      const npc = await db.npcs.get(npcId);
      if (npc) {
        nameInput.value = npc.name;
        personaInput.value = npc.persona;
        avatarPreview.src = npc.avatar || defaultGroupMemberAvatar;
        activitySwitch.checked = npc.enableBackgroundActivity !== false;
        cooldownInput.value = npc.actionCooldownMinutes || 15;
        groupSelectEl.value = npc.npcGroupId || '';

        if (npc.associatedWith && Array.isArray(npc.associatedWith)) {
          npc.associatedWith.forEach(id => {
            const checkbox = associationListEl.querySelector(`input[value="${id}"]`);
            if (checkbox) checkbox.checked = true;
          });
        }
      }
    } else {
      titleEl.textContent = 'Ê∑ªÂä† NPC';
      nameInput.value = '';
      personaInput.value = '';
      avatarPreview.src = defaultGroupMemberAvatar;
      activitySwitch.checked = true;
      cooldownInput.value = 15;
      groupSelectEl.value = '';

      const userCheckbox = associationListEl.querySelector('input[value="user"]');
      if (userCheckbox) userCheckbox.checked = true;
    }

    modal.classList.add('visible');
  }




  async function saveNpc() {
    const name = document.getElementById('npc-name-input').value.trim();
    const persona = document.getElementById('npc-persona-input').value.trim();
    if (!name || !persona) {
      alert("NPCÁöÑÊòµÁß∞Âíå‰∫∫ËÆæÈÉΩ‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
      return;
    }

    const selectedAssociations = Array.from(document.querySelectorAll('#npc-association-list input:checked')).map(cb => cb.value);
    const enableBackgroundActivity = document.getElementById('npc-background-activity-switch').checked;
    const actionCooldownMinutes = parseInt(document.getElementById('npc-action-cooldown-input').value) || 15;


    const npcGroupId = parseInt(document.getElementById('npc-group-select').value) || null;

    const npcData = {
      name,
      persona,
      avatar: document.getElementById('npc-avatar-preview').src,
      associatedWith: selectedAssociations,
      enableBackgroundActivity: enableBackgroundActivity,
      actionCooldownMinutes: actionCooldownMinutes,
      npcGroupId: npcGroupId
    };

    if (editingNpcId) {
      await db.npcs.update(editingNpcId, npcData);
    } else {
      const newNpcId = await db.npcs.add(npcData);
      if (isAddingNpcToGroup && state.activeChatId) {
        const chat = state.chats[state.activeChatId];
        if (chat.isGroup) {
          chat.members.push({
            id: `npc_${newNpcId}`,
            originalName: name,
            groupNickname: name,
            persona: persona,
            avatar: npcData.avatar,
            isNpc: true
          });
          await db.chats.put(chat);
        }
      }
    }

    document.getElementById('npc-editor-modal').classList.remove('visible');

    if (isAddingNpcToGroup) {
      isAddingNpcToGroup = false;
      openMemberManagementScreen();
    } else {
      await renderNpcListScreen();
    }
  }
  async function openNpcGroupManager() {
    await renderNpcGroupsInManager();
    document.getElementById('npc-group-manager-modal').classList.add('visible');
  }


  async function renderNpcGroupsInManager() {
    const listEl = document.getElementById('existing-npc-groups-list');
    const categories = await db.npcGroups.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁªÑ</p>';
    }
    categories.forEach(cat => {
      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">√ó</span>
        `;
      listEl.appendChild(item);
    });
  }


  async function addNewNpcGroup() {
    const input = document.getElementById('new-npc-group-name-input');
    const name = input.value.trim();
    if (!name) {
      alert('ÂàÜÁªÑÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      return;
    }
    const existing = await db.npcGroups.where('name').equals(name).first();
    if (existing) {
      alert(`ÂàÜÁªÑ "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);
      return;
    }
    await db.npcGroups.add({
      name
    });
    input.value = '';
    await renderNpcGroupsInManager();
  }


  async function deleteNpcGroup(groupId) {
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      'Âà†Èô§ÂàÜÁªÑÂêéÔºåËØ•ÁªÑÂÜÖÁöÑÊâÄÊúâNPCÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁªÑ‚Äù„ÄÇÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    }
    );
    if (confirmed) {
      await db.npcGroups.delete(groupId);
      // Â∞ÜÂ±û‰∫éËØ•ÂàÜÁªÑÁöÑNPCÁöÑ npcGroupId ËÆæ‰∏∫ null
      await db.npcs.where('npcGroupId').equals(groupId).modify({
        npcGroupId: null
      });
      await renderNpcGroupsInManager();
    }
  }


  async function deleteNpc(npcId) {
    const npc = await db.npcs.get(npcId);
    if (!npc) return;
    const confirmed = await showCustomConfirm('Âà†Èô§NPC', `Á°ÆÂÆöË¶ÅÂà†Èô§NPC ‚Äú${npc.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.npcs.delete(npcId);
      await renderNpcListScreen();
    }
  }


  let chatListRenderCount = 0;




  function createChatGroupContainer(group) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'chat-group-container';
    groupContainer.innerHTML = `
        <div class="chat-group-header">
            <span class="arrow">‚ñº</span>
            <span class="group-name">${group.name}</span>
        </div>
        <div class="chat-group-content"></div>
    `;
    return groupContainer;
  }




  function loadMoreChats(sortedItems) {
    const chatListEl = document.getElementById('chat-list');
    const loadMoreBtn = document.getElementById('load-more-chats-btn');
    if (loadMoreBtn) loadMoreBtn.remove();

    const nextSliceStart = chatListRenderCount;
    const nextSliceEnd = chatListRenderCount + CHAT_LIST_RENDER_WINDOW;
    const itemsToAppend = sortedItems.slice(nextSliceStart, nextSliceEnd);


    const fragment = document.createDocumentFragment();
    let currentGroupContent = chatListEl.querySelector('.chat-group-content:last-of-type');

    itemsToAppend.forEach(item => {
      if (item.type === 'groupHeader') {
        const groupContainer = createChatGroupContainer(item.group);
        fragment.appendChild(groupContainer);
        currentGroupContent = groupContainer.querySelector('.chat-group-content');
      } else if (item.type === 'chatItem') {
        const listItem = createChatListItem(item.chat);
        if (currentGroupContent && item.chat.groupId) {
          currentGroupContent.appendChild(listItem);
        } else {
          fragment.appendChild(listItem);
          currentGroupContent = null;
        }
      }
    });


    chatListEl.appendChild(fragment);
    chatListRenderCount += itemsToAppend.length;

    if (sortedItems.length > chatListRenderCount) {
      appendLoadMoreChatsButton(chatListEl, sortedItems);
    }


    document.querySelectorAll('.chat-group-header').forEach(header => {
      const newHeader = header.cloneNode(true);
      header.parentNode.replaceChild(newHeader, header);
      newHeader.addEventListener('click', () => {
        newHeader.classList.toggle('collapsed');
        newHeader.nextElementSibling.classList.toggle('collapsed');
      });
    });
  }


  async function renderChatList() {
    const chatListEl = document.getElementById('chat-list');
    chatListEl.innerHTML = '';


    const allChats = Object.values(state.chats).filter(chat => {
      // ËøáÊª§ÊéâËÅîÊú∫Â•ΩÂèãÔºàÂ∑≤ËøÅÁßªÂà∞Áã¨Á´ãÁöÑËøûÊé•APPÔºâ
      if (chat.isOnlineFriend || chat.isGroupChat) return false;
      return true;
    }).sort((a, b) => {
      const pinDiff = (b.isPinned || false) - (a.isPinned || false);
      if (pinDiff !== 0) return pinDiff;
      return (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0);
    });

    const allGroups = await db.qzoneGroups.toArray();

    if (allChats.length === 0) {
      chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÊàñÁæ§ÁªÑÂõæÊ†áÊ∑ªÂä†ËÅäÂ§©</p>';
      return;
    }

    allGroups.forEach(group => {
      const latestChatInGroup = allChats.find(chat => chat.groupId === group.id);
      group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
    });
    allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);


    sortedChatListItems = [];
    const processedChatIds = new Set();


    allChats.forEach(chat => {
      if (chat.isPinned) {
        sortedChatListItems.push({
          type: 'chatItem',
          chat
        });
        processedChatIds.add(chat.id);
      }
    });


    allGroups.forEach(group => {

      const groupChats = allChats.filter(chat =>
        !chat.isPinned &&
        !chat.isGroup &&
        chat.groupId === group.id
      );


      if (groupChats.length > 0) {
        sortedChatListItems.push({
          type: 'groupHeader',
          group
        });

        groupChats.forEach(chat => {
          sortedChatListItems.push({
            type: 'chatItem',
            chat
          });
          processedChatIds.add(chat.id);
        });
      }
    });


    allChats.forEach(chat => {
      if (!processedChatIds.has(chat.id)) {
        sortedChatListItems.push({
          type: 'chatItem',
          chat
        });
        processedChatIds.add(chat.id);
      }
    });


    chatListRenderCount = 0;
    loadMoreChats();
  }




  function createChatGroupContainer(group) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'chat-group-container';
    groupContainer.innerHTML = `
                <div class="chat-group-header">
                    <span class="arrow">‚ñº</span>
                    <span class="group-name">${group.name}</span>
                </div>
                <div class="chat-group-content"></div>
            `;
    return groupContainer;
  }

  function appendLoadMoreChatsButton(container, sortedItems) {
    const button = document.createElement('button');
    button.id = 'load-more-chats-btn';
    button.textContent = 'Âä†ËΩΩÊõ¥Êó©ÁöÑ‰ºöËØù';
    button.className = 'load-more-btn';


    button.addEventListener('click', () => loadMoreChats(sortedItems), {
      once: true
    });

    container.prepend(button);
  }


  function loadMoreChats() {
    if (isLoadingMoreChats) return;

    const chatListEl = document.getElementById('chat-list');
    const scrollContainer = document.getElementById('messages-view');
    if (!chatListEl || !scrollContainer) return;
    if (chatListRenderCount >= sortedChatListItems.length) return;

    isLoadingMoreChats = true;


    const isInitialLoad = chatListRenderCount === 0;


    const renderContent = () => {
      hideLoader(chatListEl);

      const renderWindow = state.globalSettings.chatListRenderWindow || 30;
      const nextSliceStart = chatListRenderCount;
      const nextSliceEnd = chatListRenderCount + renderWindow;
      const itemsToAppend = sortedChatListItems.slice(nextSliceStart, nextSliceEnd);

      const fragment = document.createDocumentFragment();
      let currentGroupContent = chatListEl.querySelector('.chat-group-content:last-of-type');

      itemsToAppend.forEach(item => {
        if (item.type === 'groupHeader') {
          const groupContainer = createChatGroupContainer(item.group);
          fragment.appendChild(groupContainer);
          currentGroupContent = groupContainer.querySelector('.chat-group-content');
        } else if (item.type === 'chatItem') {
          const listItem = createChatListItem(item.chat);
          if (item.chat.groupId && currentGroupContent) {
            currentGroupContent.appendChild(listItem);
          } else {
            fragment.appendChild(listItem);
            if (!item.chat.groupId) currentGroupContent = null;
          }
        }
      });

      chatListEl.appendChild(fragment);
      chatListRenderCount += itemsToAppend.length;

      chatListEl.querySelectorAll('.chat-group-header:not([data-has-listener="true"])').forEach(header => {
        header.dataset.hasListener = "true";
        header.addEventListener('click', () => {
          header.classList.toggle('collapsed');
          header.nextElementSibling.classList.toggle('collapsed');
        });
      });

      isLoadingMoreChats = false;

      if (scrollContainer.scrollHeight <= scrollContainer.clientHeight && chatListRenderCount < sortedChatListItems.length) {
        loadMoreChats();
      }
    };


    if (isInitialLoad) {

      renderContent();
    } else {

      showLoader(chatListEl, 'bottom');
      setTimeout(renderContent, 500);
    }
  }

  function createChatListItem(chat) {

    try {
      const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
      let lastMsgDisplay;

      if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
        lastMsgDisplay = `<span style="color: #ff8c00;">[Â•ΩÂèãÁî≥ËØ∑] ${chat.relationship.applicationReason || 'ËØ∑Ê±ÇÊ∑ªÂä†‰Ω†‰∏∫Â•ΩÂèã'}</span>`;
      } else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
        lastMsgDisplay = `<span style="color: #dc3545;">[‰Ω†Â∑≤Ë¢´ÂØπÊñπÊãâÈªë]</span>`;
      } else if (chat.isGroup) {
        if (lastMsgObj.type === 'pat_message') {
          lastMsgDisplay = `[Á≥ªÁªüÊ∂àÊÅØ] ${lastMsgObj.content}`;
        } else if (lastMsgObj.type === 'transfer') {
          lastMsgDisplay = '[ËΩ¨Ë¥¶]';
        } else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo' || lastMsgObj.type === 'naiimag' || lastMsgObj.type === 'googleimag') {
          lastMsgDisplay = '[ÁÖßÁâá]';
        } else if (lastMsgObj.type === 'voice_message') {
          lastMsgDisplay = '[ËØ≠Èü≥]';
        } else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) {
          lastMsgDisplay = lastMsgObj.meaning ? `[Ë°®ÊÉÖ: ${lastMsgObj.meaning}]` : '[Ë°®ÊÉÖ]';
        } else if (Array.isArray(lastMsgObj.content)) {
          lastMsgDisplay = `[ÂõæÁâá]`;
        } else {
          lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20);
        }

        if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
          const senderDisplayName = getDisplayNameInGroup(chat, lastMsgObj.senderName);
          lastMsgDisplay = `${senderDisplayName}: ${lastMsgDisplay}`;
        }
      } else {
        const statusText = chat.status?.text || 'Âú®Á∫ø';
        lastMsgDisplay = `[${statusText}]`;
      }

      const item = document.createElement('div');
      item.className = 'chat-list-item';
      item.dataset.chatId = chat.id;
      if (chat.isPinned) {
        item.classList.add('pinned');
      }

      const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
      const avatarFrameSrc = chat.isGroup ? '' : (chat.settings.aiAvatarFrame || '');
      let avatarHtml;
      if (avatarFrameSrc) {
        avatarHtml = `<div class="avatar-with-frame"><img src="${avatar || defaultAvatar}" class="avatar-img"><img src="${avatarFrameSrc}" class="avatar-frame"></div>`;
      } else {
        avatarHtml = `<img src="${avatar || defaultAvatar}" class="avatar">`;
      }
      const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
      const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;

      item.innerHTML = `
            ${avatarGroupHtml}
            <div class="info">
                <div class="name-line">
                    <span class="name">${chat.name}</span>
                    ${chat.isGroup ? '<span class="group-tag">Áæ§ËÅä</span>' : ''}
                </div>
                <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
            </div>
            <div class="unread-count-wrapper">
                <span class="unread-count" style="display: none;">0</span>
            </div>
        `;

      const unreadCount = chat.unreadCount || 0;
      const unreadEl = item.querySelector('.unread-count');
      if (unreadCount > 0) {
        unreadEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
        unreadEl.style.display = 'inline-flex';
      } else {
        unreadEl.style.display = 'none';
      }

      const avatarGroupEl = item.querySelector('.avatar-group');
      if (avatarGroupEl) {
        avatarGroupEl.style.cursor = 'pointer';
        avatarGroupEl.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          const nameToPat = chat.isGroup ? chat.name : chat.originalName;
          handleUserPat(chat.id, nameToPat);
        });
      }

      const infoEl = item.querySelector('.info');
      if (infoEl) {
        infoEl.addEventListener('click', () => openChat(chat.id));
      }

      addLongPressListener(item, async (e) => {
        const action = await showChatListActions(chat);
        switch (action) {
          case 'pin':
            chat.isPinned = !chat.isPinned;
            await db.chats.put(chat);
            renderChatList();
            break;
          case 'delete':
            const deleteConfirmed = await showCustomConfirm('Âà†Èô§ÂØπËØù', `Á°ÆÂÆöË¶ÅÂà†Èô§‰∏é "${chat.name}" ÁöÑÊï¥‰∏™ÂØπËØùÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, {
              confirmButtonClass: 'btn-danger'
            });
            if (deleteConfirmed) {
              if (musicState.isActive && musicState.activeChatId === chat.id) {
                await endListenTogetherSession(false);
              }
              delete state.chats[chat.id];
              if (state.activeChatId === chat.id) state.activeChatId = null;
              await db.chats.delete(chat.id);
              renderChatList();
            }
            break;
          default:
            break;
        }
      });
      return item;

    } catch (error) {

      console.error(`Ê∏≤ÊüìËÅäÂ§©È°π [${chat.name || 'Êú™Áü•'}] (ID: ${chat.id}) Êó∂Âá∫Èîô:`, error);
      return null;
    }
  }


  async function renderChatInterface(chatId) {
    applyButtonOrder();
    cleanupWaimaiTimers();
    const chat = state.chats[chatId];
    if (!chat) return;

    exitSelectionMode();

    const messagesContainer = document.getElementById('chat-messages');
    const chatInputArea = document.getElementById('chat-input-area');
    const lockOverlay = document.getElementById('chat-lock-overlay');
    const lockContent = document.getElementById('chat-lock-content');

    messagesContainer.dataset.theme = chat.settings.theme || 'default';
    const fontSize = chat.settings.fontSize || 13;
    messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
    applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');

    document.getElementById('chat-header-title').textContent = chat.name;
    const statusContainer = document.getElementById('chat-header-status');
    const statusTextEl = statusContainer.querySelector('.status-text');

    if (chat.isGroup) {
      statusContainer.style.display = 'none';
      document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
    } else {
      statusContainer.style.display = 'flex';
      document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
      statusTextEl.textContent = chat.status?.text || 'Âú®Á∫ø';
      statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
    }

    const chatScreen = document.getElementById('chat-interface-screen');
    const individualBg = chat.settings.background;
    const globalBg = state.globalSettings.globalChatBackground;
    const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
    const defaultColor = isDarkMode ? '#000000' : '#f0f2f5';

    if (individualBg) {
      chatScreen.style.backgroundImage = `url("${individualBg}")`;
      chatScreen.style.backgroundColor = 'transparent';
    } else if (globalBg) {
      chatScreen.style.backgroundImage = `url("${globalBg}")`;
      chatScreen.style.backgroundColor = 'transparent';
    } else {
      chatScreen.style.backgroundImage = 'none';
      chatScreen.style.backgroundColor = defaultColor;
    }


    if (chat.isSpectatorGroup) {
      chatInputArea.style.display = 'none';
      lockOverlay.style.display = 'flex';
      lockContent.innerHTML = `
                    <span class="lock-text">Ê≠£Âú®Âõ¥ËßÇAI‰ª¨ÁöÑÁæ§ËÅä...</span>
                    <div class="spectator-actions-container">
                        <button id="spectator-reroll-btn" class="lock-action-btn secondary" title="ÈáçÊñ∞ÁîüÊàê‰∏ä‰∏ÄËΩÆÂØπËØù">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                            </svg>
                        </button>
                        <button id="spectator-propel-btn" class="lock-action-btn">üé¨ Êé®ËøõÂâßÊÉÖ</button>
                        <button id="spectator-edit-btn" class="lock-action-btn secondary" title="ÂØºÊºîÂâ™ËæëÂÆ§ÔºöÁºñËæëAI‰∏ä‰∏ÄËΩÆÁöÑÂìçÂ∫î">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                                <line x1="16" y1="8" x2="2" y2="22"></line>
                                <line x1="17.5" y1="15" x2="9" y2="15"></line>
                            </svg>
                        </button>
                    </div>
                `;
      document.getElementById('spectator-propel-btn').onclick = triggerSpectatorGroupAiAction;
    } else {
      chatInputArea.style.display = 'flex';
      lockOverlay.style.display = 'none';
      lockContent.innerHTML = '';
      if (!chat.isGroup && chat.relationship.status !== 'friend') {
        lockOverlay.style.display = 'flex';
        chatInputArea.style.visibility = 'hidden';

        let lockHtml = '';
        switch (chat.relationship.status) {
          case 'blocked_by_user':
            const isSimulationRunning = simulationIntervalId !== null;
            const blockedTimestamp = chat.relationship.blockedTimestamp;
            const cooldownHours = state.globalSettings.blockCooldownHours || 1;
            const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
            const timeSinceBlock = Date.now() - blockedTimestamp;
            const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
            const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));

            lockHtml = `
                                <span class="lock-text">‰Ω†Â∑≤Â∞Ü‚Äú${chat.name}‚ÄùÊãâÈªë„ÄÇ</span>
                                <button id="unblock-btn" class="lock-action-btn">Ëß£Èô§ÊãâÈªë</button>
                                <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                                    <strong style="color: #333;">„ÄêÂºÄÂèëËÄÖËØäÊñ≠Èù¢Êùø„Äë</strong><br>
                                    - ÂêéÂè∞Ê¥ªÂä®ÊÄªÂºÄÂÖ≥: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">Â∑≤ÂºÄÂêØ</span>' : '<span style="color: red;">Â∑≤ÂÖ≥Èó≠</span>'}<br>
                                    - Á≥ªÁªüÂøÉË∑≥ËÆ°Êó∂Âô®: ${isSimulationRunning ? '<span style="color: green;">ËøêË°å‰∏≠</span>' : '<span style="color: red;">Êú™ËøêË°å</span>'}<br>
                                    - ÂΩìÂâçËßíËâ≤Áä∂ÊÄÅ: <strong>${chat.relationship.status}</strong><br>
                                    - ÈúÄË¶ÅÂÜ∑Èùô(Â∞èÊó∂): <strong>${cooldownHours}</strong><br>
                                    - ÂÜ∑ÈùôÊúüÊòØÂê¶ÁªìÊùü: ${isCooldownOver ? '<span style="color: green;">ÊòØ</span>' : `<span style="color: orange;">Âê¶ (ËøòÂâ©Á∫¶ ${timeRemainingMinutes} ÂàÜÈíü)</span>`}<br>
                                    - Ëß¶ÂèëÊù°‰ª∂: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">Â∑≤Êª°Ë∂≥ÔºåÁ≠âÂæÖ‰∏ãÊ¨°Á≥ªÁªüÂøÉË∑≥</span>' : '<span style="color: red;">Êú™Êª°Ë∂≥</span>'}
                                </div>
                                <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">Âº∫Âà∂Ëß¶Âèë‰∏ÄÊ¨°Â•ΩÂèãÁî≥ËØ∑Ê£ÄÊµã</button>
                            `;
            break;
          case 'blocked_by_ai':
            lockHtml = `
                                <span class="lock-text">‰Ω†Ë¢´ÂØπÊñπÊãâÈªë‰∫Ü„ÄÇ</span>
                                <button id="apply-friend-btn" class="lock-action-btn">ÈáçÊñ∞Áî≥ËØ∑Âä†‰∏∫Â•ΩÂèã</button>
                            `;
            break;
          case 'pending_user_approval':
            lockHtml = `
                                <span class="lock-text">‚Äú${chat.name}‚ÄùËØ∑Ê±ÇÊ∑ªÂä†‰Ω†‰∏∫Â•ΩÂèãÔºö<br><i>‚Äú${chat.relationship.applicationReason}‚Äù</i></span>
                                <button id="accept-friend-btn" class="lock-action-btn">Êé•Âèó</button>
                                <button id="reject-friend-btn" class="lock-action-btn secondary">ÊãíÁªù</button>
                            `;
            break;
          case 'pending_ai_approval':
            lockHtml = `<span class="lock-text">Â•ΩÂèãÁî≥ËØ∑Â∑≤ÂèëÈÄÅÔºåÁ≠âÂæÖÂØπÊñπÈÄöËøá...</span>`;
            break;
        }
        lockContent.innerHTML = lockHtml;
      } else {
        lockOverlay.style.display = 'none';
        chatInputArea.style.visibility = 'visible';
      }
    }

    messagesContainer.innerHTML = '';
    const history = chat.history;
    currentRenderedCount = 0;
    const renderWindow = state.globalSettings.chatRenderWindow || 50;
    const initialMessages = history.slice(-renderWindow);



    const fragment = document.createDocumentFragment();
    let lastTimestamp = 0;


    for (const msg of initialMessages) {

      if (!msg.isHidden) {
        if (lastTimestamp > 0 && (msg.timestamp - lastTimestamp > 600000)) {

          fragment.appendChild(createSystemTimestampElement(msg.timestamp));
        }
        lastTimestamp = msg.timestamp;
      }


      const messageEl = await createMessageElement(msg, chat, true);

      if (messageEl) {
        fragment.appendChild(messageEl);
      }
    }


    messagesContainer.appendChild(fragment);

    currentRenderedCount = initialMessages.length;

    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.style.display = 'none';
    typingIndicator.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...';
    messagesContainer.appendChild(typingIndicator);
    const images = messagesContainer.querySelectorAll('img');
    const imageLoadPromises = [];

    images.forEach(img => {

      if (!img.complete) {

        imageLoadPromises.push(new Promise(resolve => {
          img.onload = resolve;
          img.onerror = resolve;
        }));
      }
    });


    Promise.all(imageLoadPromises).then(() => {

      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      console.log('ÊâÄÊúâÂàùÂßãÂõæÁâáÂä†ËΩΩÂÆåÊàêÔºåÂ∑≤ÊªöÂä®Âà∞Â∫ïÈÉ®„ÄÇ');
    }).catch(err => {

      console.error("Á≠âÂæÖÂõæÁâáÂä†ËΩΩÊó∂Âá∫Èîô:", err);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
    setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
  }




  async function loadMoreMessages() {
    if (isLoadingMoreMessages) return;
    isLoadingMoreMessages = true;

    const messagesContainer = document.getElementById('chat-messages');
    const chat = state.chats[state.activeChatId];
    if (!chat) {
      isLoadingMoreMessages = false;
      return;
    }


    showLoader(messagesContainer, 'top');
    const oldScrollHeight = messagesContainer.scrollHeight;


    await new Promise(resolve => setTimeout(resolve, 100));


    const totalMessages = chat.history.length;
    const renderWindow = state.globalSettings.chatRenderWindow || 50;
    const nextSliceStart = totalMessages - currentRenderedCount - renderWindow;
    const nextSliceEnd = totalMessages - currentRenderedCount;
    const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd);


    if (messagesToPrepend.length === 0) {
      hideLoader(messagesContainer);
      isLoadingMoreMessages = false;
      return;
    }
    currentRenderedCount += messagesToPrepend.length;

    const messageElements = [];
    for (const msg of messagesToPrepend) {
      const el = await createMessageElement(msg, chat);
      messageElements.push(el);
    }



    const fragment = document.createDocumentFragment();
    const firstVisibleMessage = messagesContainer.querySelector('.message-wrapper[data-timestamp]');

    let timestampOfFirstVisible = firstVisibleMessage ? parseInt(firstVisibleMessage.dataset.timestamp) : 0;

    let lastTimestampInNewBatch = 0;


    messagesToPrepend.forEach((msg, index) => {
      if (!msg.isHidden) {

        if (lastTimestampInNewBatch > 0 && (msg.timestamp - lastTimestampInNewBatch > 600000)) {
          fragment.appendChild(createSystemTimestampElement(msg.timestamp));
        }
        lastTimestampInNewBatch = msg.timestamp;
      }

      const element = messageElements[index];
      if (element) {
        fragment.appendChild(element);
      }
    });

    if (timestampOfFirstVisible > 0 && (timestampOfFirstVisible - lastTimestampInNewBatch > 600000)) {
      fragment.appendChild(createSystemTimestampElement(timestampOfFirstVisible));
    }



    hideLoader(messagesContainer);
    messagesContainer.prepend(fragment);


    const newScrollHeight = messagesContainer.scrollHeight;
    messagesContainer.scrollTop = newScrollHeight - oldScrollHeight;

    isLoadingMoreMessages = false;

  }




  function renderWallpaperScreen(forcePresetId = null) {
    loadCssPresetsDropdown();
    // ËøôÈáå‰º†ÂÖ• forcePresetId
    loadAppearancePresetsDropdown(forcePresetId);

    const ephonePreview = document.getElementById('wallpaper-preview');

    if (newWallpaperBase64) {
      ephonePreview.style.backgroundImage = `url("${newWallpaperBase64}")`;
      ephonePreview.textContent = '';
    } else {
      const ephoneBg = state.globalSettings.wallpaper;
      if (ephoneBg && ephoneBg.trim() !== '') {
        ephonePreview.style.backgroundImage = `url("${ephoneBg}")`;
        ephonePreview.textContent = '';
      } else {
        ephonePreview.style.backgroundImage = 'none';
        ephonePreview.style.backgroundColor = '#ffffff';
        ephonePreview.textContent = 'ÁÇπÂáª‰∏ãÊñπ‰∏ä‰º†';
      }
    }

    const cphonePreview = document.getElementById('cphone-wallpaper-preview');
    const cphoneBg = state.globalSettings.cphoneWallpaper;
    if (cphoneBg) {
      cphonePreview.style.backgroundImage = `url("${cphoneBg}")`;
      cphonePreview.textContent = '';
    } else {
      cphonePreview.style.backgroundImage = 'none';
      cphonePreview.style.backgroundColor = '#ffffff';
      cphonePreview.textContent = 'ÂΩìÂâç‰∏∫ÁôΩËâ≤';
    }

    const myphonePreview = document.getElementById('myphone-wallpaper-preview');
    const myphoneBg = state.globalSettings.myphoneWallpaper;
    if (myphoneBg) {
      myphonePreview.style.backgroundImage = `url("${myphoneBg}")`;
      myphonePreview.textContent = '';
    } else {
      myphonePreview.style.backgroundImage = 'none';
      myphonePreview.style.backgroundColor = '#ffffff';
      myphonePreview.textContent = 'ÂΩìÂâç‰∏∫ÁôΩËâ≤';
    }

    const globalBgPreview = document.getElementById('global-bg-preview');
    const globalBg = state.globalSettings.globalChatBackground;
    if (globalBg) {
      globalBgPreview.style.backgroundImage = `url(${globalBg})`;
      globalBgPreview.textContent = '';
    } else {
      globalBgPreview.style.backgroundImage = 'none';
      globalBgPreview.style.backgroundColor = '#ffffff';
      globalBgPreview.textContent = 'ÁÇπÂáª‰∏ãÊñπ‰∏ä‰º†';
    }

    renderIconSettings();
    renderCPhoneIconSettings();
    renderMyPhoneIconSettings();
    document.getElementById('global-css-input').value = state.globalSettings.globalCss || '';
    document.getElementById('notification-sound-url-input').value = state.globalSettings.notificationSoundUrl || '';

    // ÂàùÂßãÂåñÈü≥ÈáèÊªëÂä®Êù°
    const volumeValue = (state.globalSettings.notificationVolume !== undefined ? state.globalSettings.notificationVolume : 1.0) * 100;
    document.getElementById('notification-volume-slider').value = volumeValue;
    document.getElementById('notification-volume-label').textContent = Math.round(volumeValue) + '%';

    if (typeof renderSoundPresets === 'function') {
      renderSoundPresets(); // Ê∏≤ÊüìÊèêÁ§∫Èü≥È¢ÑËÆæÂàóË°®
    }
    document.getElementById('status-bar-toggle-switch').checked = state.globalSettings.showStatusBar || false;
    document.getElementById('global-show-seconds-switch').checked = state.globalSettings.showSeconds || false;
    document.getElementById('phone-frame-toggle-switch').checked = state.globalSettings.showPhoneFrame || false;
    document.getElementById('minimal-chat-ui-switch').checked = state.globalSettings.enableMinimalChatUI || false;
    document.getElementById('dynamic-island-music-toggle-switch').checked = state.globalSettings.alwaysShowMusicIsland || false;
    document.getElementById('detach-status-bar-switch').checked = state.globalSettings.detachStatusBar || false;
    document.getElementById('lock-screen-toggle').checked = state.globalSettings.lockScreenEnabled || false; // ÈîÅÂ±èÂõûÊòæ
    document.getElementById('lock-screen-password-input').value = state.globalSettings.lockScreenPassword || ''; // ÂØÜÁ†ÅÂõûÊòæ

    // ÈîÅÂ±èÂ£ÅÁ∫∏ÂõûÊòæ
    const lockPreview = document.getElementById('lock-wallpaper-preview');
    if (state.globalSettings.lockScreenWallpaper) {
      lockPreview.style.backgroundImage = `url(${state.globalSettings.lockScreenWallpaper})`;
      lockPreview.textContent = '';
    } else {
      lockPreview.style.backgroundImage = 'linear-gradient(135deg, #1c1c1e, #3a3a3c)';
      lockPreview.textContent = 'ÈªòËÆ§Â£ÅÁ∫∏';
    }

    renderButtonOrderEditor();
    initializeButtonOrderEditor();

    // Âä†ËΩΩÁ≥ªÁªüÈÄöÁü•ËÆæÁΩÆ
    loadSystemNotificationSettings();
  }

  window.renderWallpaperScreenProxy = renderWallpaperScreen;

  function applyGlobalWallpaper() {
    const homeScreen = document.getElementById('home-screen');
    const wallpaper = state.globalSettings.wallpaper;
    if (wallpaper) {

      homeScreen.style.backgroundImage = `url("${wallpaper}")`;
      homeScreen.style.backgroundColor = '';
    } else {

      homeScreen.style.backgroundImage = 'none';
      homeScreen.style.backgroundColor = '#ffffff';
    }
  }



  function switchWorldBookCategory(categoryId) {

    document.querySelectorAll('.world-book-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
    });

    document.querySelectorAll('.world-book-category-pane').forEach(pane => {
      pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
    });
  }


  async function renderWorldBookScreen() {
    const tabsContainer = document.getElementById('world-book-tabs');
    const contentContainer = document.getElementById('world-book-content-container');
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';


    const [books, categories] = await Promise.all([
      db.worldBooks.toArray(),
      db.worldBookCategories.orderBy('name').toArray()
    ]);

    state.worldBooks = books;

    if (books.length === 0) {
      contentContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏ÄÊú¨‰∏ñÁïå‰π¶</p>';
      return;
    }


    const allTab = document.createElement('button');
    allTab.className = 'world-book-tab active';
    allTab.textContent = 'ÂÖ®ÈÉ®';
    allTab.dataset.categoryId = 'all';
    tabsContainer.appendChild(allTab);

    const allPane = document.createElement('div');
    allPane.className = 'world-book-category-pane active';
    allPane.dataset.categoryId = 'all';
    contentContainer.appendChild(allPane);


    categories.forEach(category => {
      const categoryTab = document.createElement('button');
      categoryTab.className = 'world-book-tab';
      categoryTab.textContent = category.name;
      categoryTab.dataset.categoryId = String(category.id);
      tabsContainer.appendChild(categoryTab);

      const categoryPane = document.createElement('div');
      categoryPane.className = 'world-book-category-pane';
      categoryPane.dataset.categoryId = String(category.id);
      contentContainer.appendChild(categoryPane);
    });


    const hasUncategorized = books.some(book => !book.categoryId);
    if (hasUncategorized) {
      const uncategorizedTab = document.createElement('button');
      uncategorizedTab.className = 'world-book-tab';
      uncategorizedTab.textContent = 'Êú™ÂàÜÁ±ª';
      uncategorizedTab.dataset.categoryId = 'uncategorized';
      tabsContainer.appendChild(uncategorizedTab);

      const uncategorizedPane = document.createElement('div');
      uncategorizedPane.className = 'world-book-category-pane';
      uncategorizedPane.dataset.categoryId = 'uncategorized';
      contentContainer.appendChild(uncategorizedPane);
    }


    books.forEach(book => {
      let contentPreview = 'ÊöÇÊó†ÂÜÖÂÆπ...';
      if (Array.isArray(book.content) && book.content.length > 0) {
        const firstEntry = book.content[0];
        contentPreview = firstEntry.comment || firstEntry.content || '';
      } else if (typeof book.content === 'string' && book.content.trim() !== '') {
        contentPreview = book.content;
      }

      const card = document.createElement('div');
      card.className = 'world-book-card';
      card.innerHTML = `
                    <div class="card-title">${book.name}</div>
                    <div class="card-content-preview">${contentPreview}</div>
                `;


      const cardClickHandler = () => openWorldBookEditor(book.id);
      const cardLongPressHandler = async () => {
        const confirmed = await showCustomConfirm('Âà†Èô§‰∏ñÁïå‰π¶', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${book.name}„ÄãÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          await db.worldBooks.delete(book.id);
          state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id);
          renderWorldBookScreen();
        }
      };

      card.addEventListener('click', cardClickHandler);
      addLongPressListener(card, cardLongPressHandler);


      const clonedCardForAll = card.cloneNode(true);
      clonedCardForAll.addEventListener('click', cardClickHandler);
      addLongPressListener(clonedCardForAll, cardLongPressHandler);
      allPane.appendChild(clonedCardForAll);


      const categoryKey = book.categoryId ? String(book.categoryId) : 'uncategorized';
      const targetPane = contentContainer.querySelector(`.world-book-category-pane[data-category-id="${categoryKey}"]`);
      if (targetPane) {
        targetPane.appendChild(card);
      }
    });


    document.querySelectorAll('.world-book-tab').forEach(tab => {
      tab.addEventListener('click', () => switchWorldBookCategory(tab.dataset.categoryId));
    });
  }



  function createWorldBookGroup(groupName, books) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'world-book-group-container';

    groupContainer.innerHTML = `
                <div class="world-book-group-header">
                    <span class="arrow">‚ñº</span>
                    <span class="group-name">${groupName}</span>
                </div>
                <div class="world-book-group-content"></div>
            `;

    const contentEl = groupContainer.querySelector('.world-book-group-content');
    books.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));

    books.forEach(book => {

      let contentPreview = 'ÊöÇÊó†ÂÜÖÂÆπ...';


      if (Array.isArray(book.content) && book.content.length > 0) {


        const firstEntry = book.content[0];
        contentPreview = firstEntry.comment || firstEntry.content || '';
      } else if (typeof book.content === 'string' && book.content.trim() !== '') {

        contentPreview = book.content;
      }


      const item = document.createElement('div');
      item.className = 'list-item';
      item.dataset.bookId = book.id;

      item.innerHTML = `
                    <div class="item-title">${book.name}</div>
                    <div class="item-content">${String(contentPreview).substring(0, 50)}</div>
                `;
      item.addEventListener('click', () => openWorldBookEditor(book.id));
      addLongPressListener(item, async () => {
        const confirmed = await showCustomConfirm('Âà†Èô§‰∏ñÁïå‰π¶', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${book.name}„ÄãÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          await db.worldBooks.delete(book.id);
          state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id);
          renderWorldBookScreen();
        }
      });
      contentEl.appendChild(item);
    });

    return groupContainer;
  }

  window.renderWorldBookScreenProxy = renderWorldBookScreen;


  async function openWorldBookEditor(bookId) {


    showScreen('world-book-editor-screen');

    editingWorldBookId = bookId;
    const [book, categories] = await Promise.all([
      db.worldBooks.get(bookId),
      db.worldBookCategories.toArray()
    ]);


    if (!book) {
      console.error("Â∞ùËØïÊâìÂºÄ‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑ‰∏ñÁïå‰π¶ÔºåID:", bookId);
      showScreen('world-book-screen');
      return;
    }


    document.getElementById('world-book-editor-title').textContent = book.name;
    document.getElementById('world-book-name-input').value = book.name;


    const selectEl = document.getElementById('world-book-category-select');
    selectEl.innerHTML = '<option value="">-- Êú™ÂàÜÁ±ª --</option>';
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat.id;
      option.textContent = cat.name;
      if (book.categoryId === cat.id) option.selected = true;
      selectEl.appendChild(option);
    });

    // ËÆæÁΩÆÂÖ®Â±ÄÂºÄÂÖ≥Áä∂ÊÄÅÔºàÈªòËÆ§‰∏∫ÂÖ≥Èó≠Ôºâ
    const globalSwitch = document.getElementById('world-book-global-switch');
    if (globalSwitch) {
      globalSwitch.checked = book.isGlobal === true;
    }

    // ËÆæÁΩÆÊ≥®ÂÖ•‰ΩçÁΩÆÁöÑÂÄºÔºàÈªòËÆ§‰∏∫'before'Ôºâ
    const injectPositionSelect = document.getElementById('world-book-inject-position-select');
    if (injectPositionSelect) {
      injectPositionSelect.value = book.injectPosition || 'before';
    }


    const entriesContainer = document.getElementById('world-book-entries-container');
    entriesContainer.innerHTML = '';

    if (Array.isArray(book.content) && book.content.length > 0) {
      book.content.forEach(entry => {
        const block = createWorldBookEntryBlock(entry);
        entriesContainer.appendChild(block);
      });
    } else {
      entriesContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 20px;">ËøòÊ≤°ÊúâÂÜÖÂÆπÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†Á¨¨‰∏ÄÊù°ÂêßÔºÅ</p>';
    }


  }



  async function renderStickerPanel(rerenderTabs = true) {
    const grid = document.getElementById('sticker-grid');
    const tabsContainer = document.getElementById('sticker-category-tabs');
    const searchInput = document.getElementById('sticker-search-input');
    const searchTerm = searchInput.value.trim().toLowerCase();


    if (rerenderTabs) {
      tabsContainer.innerHTML = '';
      const categories = await db.stickerCategories.toArray();

      tabsContainer.innerHTML += `<button class="sticker-category-tab ${activeStickerCategoryId === 'all' ? 'active' : ''}" data-category-id="all">ÂÖ®ÈÉ®</button>`;
      categories.forEach(cat => {
        tabsContainer.innerHTML += `<button class="sticker-category-tab ${activeStickerCategoryId === cat.id ? 'active' : ''}" data-category-id="${cat.id}">${cat.name}</button>`;
      });
      tabsContainer.innerHTML += `<button class="sticker-category-tab ${activeStickerCategoryId === 'uncategorized' ? 'active' : ''}" data-category-id="uncategorized">Êú™ÂàÜÁ±ª</button>`;
    }


    grid.innerHTML = '';


    let stickersByCategory;
    if (activeStickerCategoryId === 'all') {
      stickersByCategory = state.userStickers;
    } else if (activeStickerCategoryId === 'uncategorized') {
      stickersByCategory = state.userStickers.filter(s => !s.categoryId);
    } else {
      stickersByCategory = state.userStickers.filter(s => s.categoryId === activeStickerCategoryId);
    }


    const stickersToShow = searchTerm ?
      stickersByCategory.filter(sticker => sticker.name.toLowerCase().includes(searchTerm)) :
      stickersByCategory;


    if (stickersToShow.length === 0) {
      const message = searchTerm ? 'Êâæ‰∏çÂà∞ÂåπÈÖçÁöÑË°®ÊÉÖ' : 'Ëøô‰∏™ÂàÜÁ±ª‰∏ãËøòÊ≤°ÊúâË°®ÊÉÖÂì¶~';
      grid.innerHTML = `<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1; padding-top: 20px;">${message}</p>`;
      return;
    }

    stickersToShow.forEach(sticker => {
      const item = document.createElement('div');
      item.className = 'sticker-item';
      item.title = sticker.name;
      item.dataset.stickerId = sticker.id;
      item.innerHTML = `
            <div class="sticker-image-container" style="background-image: url(${sticker.url})"></div>
            <span class="sticker-name">${sticker.name}</span>
        `;
      item.addEventListener('click', () => {
        if (isStickerManagementMode) {
          handleStickerSelection(item);
        } else {
          sendSticker(sticker);
        }
      });
      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn';
      deleteBtn.innerHTML = '&times;';
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        const confirmed = await showCustomConfirm('Âà†Èô§Ë°®ÊÉÖ', `Á°ÆÂÆöË¶ÅÂà†Èô§Ë°®ÊÉÖ "${sticker.name}" ÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          await db.userStickers.delete(sticker.id);
          state.userStickers = state.userStickers.filter(s => s.id !== sticker.id);
          renderStickerPanel();
        }
      };
      item.appendChild(deleteBtn);
      grid.appendChild(item);
    });
  }



  let isStickerManagementMode = false;
  let selectedStickers = new Set();
  let isPlaylistManagementMode = false;
  let selectedPlaylistItems = new Set();
  let isNaiGalleryManagementMode = false;
  let selectedNaiImages = new Set();
  let naiGalleryCache = { local: [], cloud: [] };
  let naiGalleryRenderCount = { local: 0, cloud: 0 };
  let isLoadingMoreNaiImages = { local: false, cloud: false };
  let activeNaiGalleryTab = 'local';
  const NAI_GALLERY_RENDER_WINDOW = 45;

  function togglePlaylistManagementMode() {
    isPlaylistManagementMode = !isPlaylistManagementMode;
    const panel = document.getElementById('music-playlist-panel');
    const manageBtn = document.getElementById('manage-playlist-btn');
    const actionBar = document.getElementById('playlist-action-bar');
    const selectAllCheckbox = document.getElementById('select-all-playlist-checkbox');

    panel.classList.toggle('management-mode', isPlaylistManagementMode);

    if (isPlaylistManagementMode) {
      manageBtn.textContent = translations[currentLanguage].done; // ‰ΩøÁî®ÁøªËØë
      manageBtn.setAttribute('data-lang-key', 'done');
      actionBar.style.display = 'flex';
      selectedPlaylistItems.clear();
      selectAllCheckbox.checked = false;
      updatePlaylistActionBar();
      // ÊòæÁ§∫Â§çÈÄâÊ°Ü
      panel.querySelectorAll('.playlist-item-checkbox').forEach(cb => cb.style.display = 'block');
    } else {
      manageBtn.textContent = translations[currentLanguage].manage; // ‰ΩøÁî®ÁøªËØë
      manageBtn.setAttribute('data-lang-key', 'manage');
      actionBar.style.display = 'none';
      // ÈöêËóèÂ§çÈÄâÊ°ÜÂπ∂ÂèñÊ∂àÈÄâ‰∏≠
      panel.querySelectorAll('.playlist-item').forEach(item => {
        item.classList.remove('selected');
        const cb = item.querySelector('.playlist-item-checkbox');
        if (cb) {
          cb.style.display = 'none';
          cb.checked = false;
        }
      });
    }
  }

  function handlePlaylistSelection(index) {
    if (!isPlaylistManagementMode) return;

    const item = document.querySelector(`.playlist-item[data-index="${index}"]`);
    if (!item) return;
    const checkbox = item.querySelector('.playlist-item-checkbox');

    // ÂàáÊç¢Áä∂ÊÄÅ
    const isSelected = selectedPlaylistItems.has(index);
    item.classList.toggle('selected', !isSelected);
    checkbox.checked = !isSelected;

    if (isSelected) {
      selectedPlaylistItems.delete(index);
    } else {
      selectedPlaylistItems.add(index);
    }
    updatePlaylistActionBar();
  }

  function updatePlaylistActionBar() {
    const uploadBtn = document.getElementById('upload-selected-to-catbox-btn');
    const deleteBtn = document.getElementById('delete-selected-songs-btn');
    const count = selectedPlaylistItems.size;
    if (uploadBtn) uploadBtn.textContent = `‰∏ä‰º†Catbox (${count})`;
    if (deleteBtn) deleteBtn.textContent = `Âà†Èô§ (${count})`;
  }

  function handleSelectAllPlaylistItems() {
    const checkbox = document.getElementById('select-all-playlist-checkbox');
    const shouldSelect = checkbox.checked;

    document.querySelectorAll('.playlist-item').forEach(item => {
      const index = parseInt(item.dataset.index);
      if (isNaN(index)) return;

      item.classList.toggle('selected', shouldSelect);
      item.querySelector('.playlist-item-checkbox').checked = shouldSelect;

      if (shouldSelect) {
        selectedPlaylistItems.add(index);
      } else {
        selectedPlaylistItems.delete(index);
      }
    });
    updatePlaylistActionBar();
  }

  async function executeDeleteSelectedSongs() {
    if (selectedPlaylistItems.size === 0) {
      await showCustomAlert("Êú™ÈÄâÊã©", "ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊ≠åÊõ≤„ÄÇ");
      return;
    }

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§Ôºü',
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedPlaylistItems.size} È¶ñÊ≠åÊõ≤ÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ`,
      { confirmText: 'Á°ÆËÆ§Âà†Èô§', cancelText: 'ÂèñÊ∂à' }
    );

    if (!confirmed) return;

    // Â∞ÜÈÄâ‰∏≠ÁöÑÁ¥¢ÂºïËΩ¨‰∏∫Êï∞ÁªÑÂπ∂‰ªéÂ§ßÂà∞Â∞èÊéíÂ∫èÔºàÈÅøÂÖçÂà†Èô§Êó∂Á¥¢ÂºïÈîô‰π±Ôºâ
    const indicesToDelete = Array.from(selectedPlaylistItems).sort((a, b) => b - a);

    // ‰ªéÊí≠ÊîæÂàóË°®‰∏≠Âà†Èô§Ê≠åÊõ≤
    for (const index of indicesToDelete) {
      if (index >= 0 && index < musicState.playlist.length) {
        musicState.playlist.splice(index, 1);
      }
    }

    // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®Êí≠ÊîæÁöÑÊ≠åÊõ≤Ë¢´Âà†Èô§ÔºåÈúÄË¶ÅË∞ÉÊï¥currentIndex
    if (indicesToDelete.includes(musicState.currentIndex)) {
      // Â¶ÇÊûúÊí≠ÊîæÂàóË°®ËøòÊúâÊ≠åÊõ≤ÔºåÊí≠ÊîæÁ¨¨‰∏ÄÈ¶ñÔºåÂê¶ÂàôÂÅúÊ≠¢
      if (musicState.playlist.length > 0) {
        musicState.currentIndex = 0;
        loadCurrentSong();
      } else {
        musicState.currentIndex = -1;
        if (musicState.audio) {
          musicState.audio.pause();
          musicState.audio.src = '';
        }
      }
    } else if (musicState.currentIndex >= musicState.playlist.length) {
      // Ë∞ÉÊï¥Á¥¢Âºï
      musicState.currentIndex = Math.max(0, musicState.playlist.length - 1);
    }

    // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
    await saveGlobalPlaylist();

    // ÊòæÁ§∫ÁªìÊûú
    await showCustomAlert("Âà†Èô§ÊàêÂäü", `Â∑≤Âà†Èô§ ${indicesToDelete.length} È¶ñÊ≠åÊõ≤„ÄÇ`);

    // Ê∏ÖÁ©∫ÈÄâÊã©Âπ∂ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°Âºè
    selectedPlaylistItems.clear();
    togglePlaylistManagementMode();
    updatePlaylistUI();
  }

  async function executeBatchUploadToCatbox() {
    // 1. Ê£ÄÊü• Catbox ÈÖçÁΩÆ
    if (!state.apiConfig.catboxEnable || !state.apiConfig.catboxUserHash) {
      await showCustomAlert("ÂäüËÉΩÊú™ÂºÄÂêØ", "ËØ∑ÂÖàÂú®‚ÄúAPIËÆæÁΩÆ‚Äù -> ‚ÄúCatbox.moe‚Äù‰∏≠ÂºÄÂêØÊ≠§ÂäüËÉΩÂπ∂Â°´ÂÜôÊÇ®ÁöÑ User Hash„ÄÇ");
      return;
    }

    if (selectedPlaylistItems.size === 0) {
      await showCustomAlert("Êú™ÈÄâÊã©", "ËØ∑ÂÖàÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÊ≠åÊõ≤„ÄÇ");
      return;
    }

    // 2. ËøáÊª§ÊéâÂ∑≤ÁªèÊòØ Catbox ÈìæÊé•ÁöÑÊ≠åÊõ≤
    const indicesToUpload = Array.from(selectedPlaylistItems).filter(index => {
      const song = musicState.playlist[index];
      return song && song.src && !String(song.src).includes('catbox.moe');
    });

    if (indicesToUpload.length === 0) {
      await showCustomAlert("Êó†ÈúÄ‰∏ä‰º†", "ÊÇ®ÈÄâÊã©ÁöÑÊâÄÊúâÊ≠åÊõ≤ÂùáÂ∑≤Âú® Catbox ‰∏ä„ÄÇ");
      togglePlaylistManagementMode();
      return;
    }

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§‰∏ä‰º†Ôºü',
      `Âç≥Â∞Ü‰∏ä‰º† ${indicesToUpload.length} È¶ñÊ≠åÊõ≤Âà∞ Catbox.moe„ÄÇ\n\nËøô‰ºöËΩ¨Êç¢Êú¨Âú∞Èü≥‰πêÂíåÂ§ñÈÉ®ÈìæÊé•ÔºåÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥Âπ∂Ê∂àËÄóÊµÅÈáè„ÄÇ\nÔºàÂ∑≤Âú® Catbox ‰∏äÁöÑÊ≠åÊõ≤Â∞ÜË¢´Ëá™Âä®Ë∑≥ËøáÔºâ`,
      { confirmText: 'ÂºÄÂßã‰∏ä‰º†' }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÂºÄÂßã‰∏ä‰º† ${indicesToUpload.length} È¶ñÊ≠åÊõ≤ÔºåËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢...`);

    let successCount = 0;
    let failCount = 0;
    const failedNames = [];

    const proxySettings = getNovelAISettings();
    let corsProxy = proxySettings.cors_proxy;
    if (corsProxy === 'custom') {
      corsProxy = proxySettings.custom_proxy_url || '';
    }


    for (const index of indicesToUpload) {
      const song = musicState.playlist[index];
      try {
        let fileToUpload;
        let songName = song.name || 'unknown_track.mp3';

        if (song.isLocal) {
          // 4a. Â§ÑÁêÜÊú¨Âú∞Ê≠åÊõ≤ (ArrayBuffer Êàñ Blob) - ËøôÈÉ®ÂàÜÈÄªËæëÊòØÊ≠£Á°ÆÁöÑ
          console.log(`[Catbox ÊâπÈáè‰∏ä‰º†] Â§ÑÁêÜÊú¨Âú∞Ê≠åÊõ≤: ${song.name}`);
          fileToUpload = new Blob([song.src], { type: song.fileType || 'audio/mpeg' });
        } else {
          // 4b. Â§ÑÁêÜÁΩëÁªúÊ≠åÊõ≤ (ÈúÄË¶ÅCORS‰ª£ÁêÜ)
          console.log(`[Catbox ÊâπÈáè‰∏ä‰º†] Â§ÑÁêÜÁΩëÁªúÊ≠åÊõ≤: ${song.name} from ${song.src}`);


          let fetchUrl = song.src;
          // Ê£ÄÊü•‰ª£ÁêÜÊòØÂê¶Â∑≤ÈÖçÁΩÆÔºåÂπ∂‰∏îÊ≠åÊõ≤Ê∫ê‰∏çÊòØ data: URI
          if (corsProxy && corsProxy !== '' && !fetchUrl.startsWith('data:')) {
            // „ÄêÈáçË¶Å„ÄëÂøÖÈ°ªÂØπÊ∫êURLËøõË°åÁºñÁ†ÅÔºå‰ª•Èò≤URL‰∏≠ÊúâÁâπÊÆäÂ≠óÁ¨¶
            fetchUrl = corsProxy + encodeURIComponent(song.src);
            console.log(`[Catbox ÊâπÈáè‰∏ä‰º†] ‰ΩøÁî®‰ª£ÁêÜ‰∏ãËΩΩ: ${fetchUrl}`);
          } else {
            console.log(`[Catbox ÊâπÈáè‰∏ä‰º†] ‰∏ç‰ΩøÁî®‰ª£ÁêÜÔºåÂ∞ùËØïÁõ¥Ëøû‰∏ãËΩΩ... (ËøôÂú®Safari‰∏ä‰ºöÂ§±Ë¥•)`);
          }

          const response = await fetch(fetchUrl); // <--- Áé∞Âú®Ëøô‰∏™ fetch ÊòØÂ∏¶‰ª£ÁêÜÁöÑ
          if (!response.ok) throw new Error(`‰∏ãËΩΩÊ≠åÊõ≤Â§±Ë¥•ÔºåÁä∂ÊÄÅ: ${response.status}`);
          fileToUpload = await response.blob();
        }

        // Á°Æ‰øùÊñá‰ª∂ÂêçÊúâÂêéÁºÄ
        if (!songName.match(/\.(mp3|wav|flac|m4a|ogg)$/i)) {
          songName += '.mp3';
        }

        // 5. Ë∞ÉÁî®Êàë‰ª¨‰πãÂâç‰øÆÂ§çËøáÁöÑ‰∏ä‰º†ÂáΩÊï∞
        // (uploadFileToCatbox ÂáΩÊï∞Âú® 1667 Ë°åÈôÑËøë)
        const newCatboxUrl = await uploadFileToCatbox(new File([fileToUpload], songName, { type: fileToUpload.type }));

        // 6. Êõ¥Êñ∞ musicState
        song.src = newCatboxUrl;
        song.isLocal = false;
        delete song.fileType;
        successCount++;

      } catch (error) {
        console.error(`[Catbox ÊâπÈáè‰∏ä‰º†] ‰∏ä‰º†Â§±Ë¥•: ${song.name}`, error);
        failCount++;
        failedNames.push(song.name);
      }
    }

    // 7. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
    await saveGlobalPlaylist();

    // 8. ÊòæÁ§∫ÊÄªÁªìÊä•Âëä
    let summary = `‰∏ä‰º†ÂÆåÊàêÔºÅ\n\nÊàêÂäü: ${successCount} È¶ñ`;
    if (failCount > 0) {
      summary += `\nÂ§±Ë¥•: ${failCount} È¶ñ\n(${failedNames.join(', ')})`;
    }
    await showCustomAlert("Êìç‰ΩúÂÆåÊàê", summary);

    // 9. ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°ÂºèÂπ∂Âà∑Êñ∞UI
    togglePlaylistManagementMode();
    updatePlaylistUI();
  }

  function toggleStickerManagementMode() {
    isStickerManagementMode = !isStickerManagementMode;
    const grid = document.getElementById('sticker-grid');
    const manageBtn = document.getElementById('manage-stickers-btn');
    const actionBar = document.getElementById('sticker-action-bar');
    const selectAllCheckbox = document.getElementById('select-all-stickers-checkbox');

    grid.classList.toggle('management-mode', isStickerManagementMode);

    if (isStickerManagementMode) {
      manageBtn.textContent = 'ÂÆåÊàê';
      actionBar.style.display = 'flex';
      selectedStickers.clear();
      selectAllCheckbox.checked = false;
      updateDeleteStickerButton();
    } else {
      manageBtn.textContent = 'ÁÆ°ÁêÜ';
      actionBar.style.display = 'none';
      grid.querySelectorAll('.sticker-item.selected').forEach(item => item.classList.remove('selected'));
    }
  }



  function handleSelectAllStickers() {
    const checkbox = document.getElementById('select-all-stickers-checkbox');
    const shouldSelect = checkbox.checked;


    let stickersToSelect;
    if (activeStickerCategoryId === 'all') {
      stickersToSelect = state.userStickers;
    } else if (activeStickerCategoryId === 'uncategorized') {
      stickersToSelect = state.userStickers.filter(s => !s.categoryId);
    } else {
      stickersToSelect = state.userStickers.filter(s => s.categoryId === activeStickerCategoryId);
    }


    stickersToSelect.forEach(sticker => {
      const stickerId = sticker.id;
      const itemEl = document.querySelector(`.sticker-item[data-sticker-id="${stickerId}"]`);

      if (shouldSelect) {

        selectedStickers.add(stickerId);
        if (itemEl) itemEl.classList.add('selected');
      } else {

        selectedStickers.delete(stickerId);
        if (itemEl) itemEl.classList.remove('selected');
      }
    });


    updateDeleteStickerButton();
  }


  function updateDeleteStickerButton() {
    const count = selectedStickers.size;
    const delBtn = document.getElementById('delete-selected-stickers-btn');
    const exportBtn = document.getElementById('export-selected-stickers-btn');
    const moveBtn = document.getElementById('move-selected-stickers-btn'); // Êñ∞Â¢û

    if (delBtn) delBtn.textContent = `Âà†Èô§ (${count})`;
    if (exportBtn) exportBtn.textContent = `ÂØºÂá∫ (${count})`;
    if (moveBtn) moveBtn.textContent = `ÁßªÂä® (${count})`; // Êñ∞Â¢û
  }
  async function executeBatchMoveStickers() {
    if (selectedStickers.size === 0) {
      alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁßªÂä®ÁöÑË°®ÊÉÖ„ÄÇ");
      return;
    }

    // 1. Ëé∑ÂèñÊâÄÊúâÂàÜÁ±ª
    const categories = await db.stickerCategories.toArray();
    const options = [
      { text: 'Êú™ÂàÜÁ±ª', value: 'uncategorized' },
      ...categories.map(c => ({ text: c.name, value: c.id }))
    ];

    // 2. ÂºπÂá∫ÈÄâÊã©Ê°Ü
    const targetCategoryId = await showChoiceModal("ÁßªÂä®Âà∞ÂàÜÁ±ª", options);
    if (!targetCategoryId) return;

    // 3. Â§ÑÁêÜÁõÆÊ†áID (Êú™ÂàÜÁ±ªÂ≠ò‰∏∫ null)
    const finalCategoryId = targetCategoryId === 'uncategorized' ? null : parseInt(targetCategoryId);

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÁßªÂä®Ë°®ÊÉÖ...");

    // 4. Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
    const idsToMove = Array.from(selectedStickers);
    await db.transaction('rw', db.userStickers, async () => {
      for (const id of idsToMove) {
        await db.userStickers.update(id, { categoryId: finalCategoryId });
        // Êõ¥Êñ∞ÂÜÖÂ≠ò
        const s = state.userStickers.find(item => item.id === id);
        if (s) s.categoryId = finalCategoryId;
      }
    });

    // 5. Âà∑Êñ∞ÁïåÈù¢
    toggleStickerManagementMode(); // ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°Âºè
    await renderStickerPanel(); // Âà∑Êñ∞ÂàóË°® (Ëøô‰ºöÊ†πÊçÆÂΩìÂâçÈÄâ‰∏≠ÁöÑTabÂà∑Êñ∞ÔºåÁßªÂä®Ëµ∞ÁöÑË°®ÊÉÖ‰ºöÊ∂àÂ§±)

    await showCustomAlert("ÊàêÂäü", `Â∑≤Â∞Ü ${idsToMove.length} ‰∏™Ë°®ÊÉÖÁßªÂä®Âà∞Êñ∞ÂàÜÁ±ª„ÄÇ`);
  }
  /**
   * Â§ÑÁêÜÁî®Êà∑ÁÇπÂáªÈÄâÊã©ÊàñÂèñÊ∂àÈÄâÊã©Ë°®ÊÉÖ
   * @param {HTMLElement} item - Ë¢´ÁÇπÂáªÁöÑË°®ÊÉÖDOMÂÖÉÁ¥†
   */
  function handleStickerSelection(item) {
    if (!isStickerManagementMode) return;

    const stickerId = item.dataset.stickerId;
    if (!stickerId) return;

    item.classList.toggle('selected');

    if (selectedStickers.has(stickerId)) {
      selectedStickers.delete(stickerId);
    } else {
      selectedStickers.add(stickerId);
    }
    updateDeleteStickerButton();
  }


  async function executeBatchDeleteStickers() {
    if (selectedStickers.size === 0) return;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedStickers.size} ‰∏™Ë°®ÊÉÖÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`, {
      confirmButtonClass: 'btn-danger'
    }
    );

    if (confirmed) {
      const idsToDelete = [...selectedStickers];


      await db.userStickers.bulkDelete(idsToDelete);


      state.userStickers = state.userStickers.filter(s => !idsToDelete.includes(s.id));


      toggleStickerManagementMode();
      renderStickerPanel();

      await showCustomAlert('Âà†Èô§ÊàêÂäü', 'ÈÄâ‰∏≠ÁöÑË°®ÊÉÖÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ');
    }
  }

  async function executeBatchExportStickers() {
    if (selectedStickers.size === 0) {
      alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂØºÂá∫ÁöÑË°®ÊÉÖÂåÖ„ÄÇ");
      return;
    }

    let exportText = "";
    let exportedCount = 0;


    state.userStickers.forEach(sticker => {
      if (selectedStickers.has(sticker.id)) {

        exportText += `${sticker.name}: ${sticker.url}\n`;
        exportedCount++;
      }
    });

    if (exportedCount === 0) {
      alert("Êú™ÊâæÂà∞ÊâÄÈÄâË°®ÊÉÖÁöÑÊï∞ÊçÆ„ÄÇ");
      return;
    }

    const finalText = exportText.trim();
    const textareaId = 'batch-export-textarea-' + Date.now();


    const alertHtml = `
        <p style="text-align:left; font-size: 14px; margin: 0 0 10px 0;">
            Â∑≤‰∏∫ÊÇ®ÁîüÊàê ${exportedCount} Êù°Âø´Êç∑ÂØºÂÖ•Ê†ºÂºèÁöÑÊñáÊú¨Ôºö
        </p>
        <textarea id="${textareaId}" 
                  rows="10" 
                  style="width: 100%; font-size: 12px; resize: vertical; border-radius: 6px; border: 1px solid #ccc;"
                  readonly>${finalText}</textarea>
    `;


    showCustomAlert("Â§çÂà∂Ë°®ÊÉÖÂåÖÊï∞ÊçÆ", alertHtml);

    const modalConfirmBtn = document.getElementById('custom-modal-confirm');

    if (modalConfirmBtn) {


      modalConfirmBtn.textContent = '‰∏ÄÈîÆÂ§çÂà∂';


      const originalOnclick = modalConfirmBtn.onclick;


      modalConfirmBtn.onclick = async (e) => {
        try {

          await navigator.clipboard.writeText(finalText);
          modalConfirmBtn.textContent = 'Â§çÂà∂ÊàêÂäü!';


          setTimeout(() => {
            modalConfirmBtn.textContent = 'ÂÆåÊàê';
            modalConfirmBtn.onclick = originalOnclick;
          }, 1500);

        } catch (err) {

          alert('Ëá™Âä®Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÈïøÊåâÊñáÊú¨Ê°ÜÊâãÂä®Â§çÂà∂„ÄÇ');

          modalConfirmBtn.textContent = 'ÂÆåÊàê';
          modalConfirmBtn.onclick = originalOnclick;
        }
      };
    }
  }



  async function openBatchStickerImportModal() {
    // 1. ËÆ©Áî®Êà∑ÈÄâÊã©ÂØºÂÖ•ÊñπÂºè
    const choice = await showChoiceModal('ÊâπÈáèÂØºÂÖ•Ë°®ÊÉÖ', [
      { text: 'üìã Á≤òË¥¥ÊñáÊú¨', value: 'paste' },
      { text: 'üìÅ ‰∏ä‰º†Êñá‰ª∂ (.txt/.json/.docx)', value: 'file' }
    ]);

    if (choice === 'paste') {
      // --- ÊñπÂºè A: Á≤òË¥¥ÊñáÊú¨ (‰øùÊåÅÂéüÊúâÈÄªËæë) ---
      const placeholderText = `ËØ∑ËæìÂÖ•Ë°®ÊÉÖÊï∞ÊçÆÔºå‰∏ÄË°å‰∏Ä‰∏™„ÄÇ
„ÄêËßÑÂàô„ÄëÔºöÂåÖÂê´„ÄêÂêçÂ≠ó„ÄëÂíå„ÄêÈìæÊé•„Äë„ÄÇ
„ÄêÁ§∫‰æã„ÄëÔºö
ÂºÄÂøÉ: https://xx.com/1.jpg
Âì≠Ê≥£Ôºöhttps://xx.com/2.png
ÁîüÊ∞îhttps://xx.com/3.gif
https://xx.com/4.jpg ÁñëÊÉë`;

      const pastedText = await showCustomPrompt(
        'ÊâπÈáèÂØºÂÖ•Ë°®ÊÉÖ',
        placeholderText,
        '',
        'textarea'
      );

      if (pastedText && pastedText.trim()) {
        await handleBatchStickerImport(pastedText);
      }

    } else if (choice === 'file') {
      // --- ÊñπÂºè B: ‰∏ä‰º†Êñá‰ª∂ ---
      await handleStickerFileImport();
    }
  }



  async function handleBatchStickerImport(text) {
    const lines = text.trim().split('\n');
    const newStickers = [];
    const baseUrl = 'https://files.catbox.moe/';
    let errorCount = 0;
    let skippedPureLinks = 0; // ÁªüËÆ°Ë¢´Ë∑≥ËøáÁöÑÁ∫ØÈìæÊé•
    const currentCategoryId = (activeStickerCategoryId !== 'all' && activeStickerCategoryId !== 'uncategorized') ? activeStickerCategoryId : null;

    // 1. ÊèêÂèñURLÁöÑÊ≠£Âàô (ÊîØÊåÅ http/https Âíå data:image)
    const urlRegex = /(https?:\/\/[^\s]+|data:image\/[^\s]+)/;

    for (const line of lines) {
      const trimmedLine = line.trim();

      // Ë∑≥ËøáÁ©∫Ë°åÊàñÂåÖÂê´ÊèêÁ§∫ËØ≠ÁöÑË°å
      if (!trimmedLine || trimmedLine.includes('Â°´ÂÖ•') || trimmedLine.includes('Ê†ºÂºè')) {
        continue;
      }

      // --- Á¨¨‰∏ÄÊ≠•ÔºöÂØªÊâæÈìæÊé• ---
      const urlMatch = trimmedLine.match(urlRegex);

      // 2. Â¶ÇÊûúÊ≤°ÊâæÂà∞Ê†áÂáÜÈìæÊé•ÔºåÂ∞ùËØïÂÖºÂÆπÊóßÁâà Catbox Áü≠Á†Å (ÂêçÂ≠ó code.png)
      if (!urlMatch) {
        // Â∞ùËØïÂåπÈÖç: ‰ªªÊÑèÊñáÂ≠ó + Á©∫Ê†º + (Â≠óÊØçÊï∞Â≠ó.ÂêéÁºÄ)
        const catboxMatch = trimmedLine.match(/^(.+?)\s+([a-zA-Z0-9]+\.[a-zA-Z0-9]+)$/);
        if (catboxMatch) {
          newStickers.push({
            id: 'sticker_' + Date.now() + Math.random(),
            name: catboxMatch[1].trim(),
            url: baseUrl + catboxMatch[2].trim(),
            categoryId: currentCategoryId
          });
        } else {
          errorCount++;
          console.warn('Êó†Ê≥ïËØÜÂà´Ë°å:', trimmedLine);
        }
        continue;
      }

      // --- Á¨¨‰∫åÊ≠•ÔºöÊèêÂèñÂπ∂Ê∏ÖÊ¥óÊï∞ÊçÆ ---
      const url = urlMatch[0];

      // ‰ªéÊï¥Ë°å‰∏≠ÊääÈìæÊé•Âà†ÊéâÔºåÂâ©‰∏ãÁöÑÂ∞±ÊòØÂêçÂ≠ó
      // ‰æãÂ¶Ç "ÂºÄÂøÉ:http://..." -> Ââ©‰∏ã "ÂºÄÂøÉ:" (Ëã±ÊñáÂÜíÂè∑)
      // ‰æãÂ¶Ç "ÂºÄÂøÉÔºöhttp://..." -> Ââ©‰∏ã "ÂºÄÂøÉÔºö" (‰∏≠ÊñáÂÜíÂè∑)
      let rawName = trimmedLine.replace(url, '').trim();

      // --- Á¨¨‰∏âÊ≠•ÔºöÊô∫ËÉΩÊ∏ÖÊ¥óÂêçÂ≠ó (Ê†∏ÂøÉ‰øÆÊîπ) ---
      // Ê≠£ÂàôËß£ÈáäÔºö
      // ^[\s:Ôºö,Ôºå]+  -> ÂéªÊéâÂºÄÂ§¥ÁöÑÊâÄÊúâ Á©∫Ê†º„ÄÅËã±ÊñáÂÜíÂè∑„ÄÅ‰∏≠ÊñáÂÜíÂè∑„ÄÅÈÄóÂè∑
      // |             -> ÊàñËÄÖ
      // [\s:Ôºö,Ôºå]+$  -> ÂéªÊéâÁªìÂ∞æÁöÑÊâÄÊúâ Á©∫Ê†º„ÄÅËã±ÊñáÂÜíÂè∑„ÄÅ‰∏≠ÊñáÂÜíÂè∑„ÄÅÈÄóÂè∑
      let cleanName = rawName.replace(/^[\s:Ôºö,Ôºå]+|[\s:Ôºö,Ôºå]+$/g, '');

      // --- Á¨¨ÂõõÊ≠•Ôºö‰∏•Ê†ºÊ†°È™å (Á¶ÅÊ≠¢Á∫ØÈìæÊé•) ---
      // Â¶ÇÊûúÊ∏ÖÊ¥óÂêéÂêçÂ≠ó‰∏∫Á©∫ÔºåËØ¥ÊòéËøô‰∏ÄË°åÂè™ÊúâÈìæÊé•
      if (!cleanName) {
        skippedPureLinks++;
        console.warn('Ë∑≥ËøáÁ∫ØÈìæÊé• (Êú™Êèê‰æõÂêçÂ≠ó):', trimmedLine);
        continue;
      }

      // Ê∑ªÂä†Âà∞ÂàóË°®
      newStickers.push({
        id: 'sticker_' + Date.now() + Math.random(),
        name: cleanName,
        url: url,
        categoryId: currentCategoryId
      });
    }

    // --- Á¨¨‰∫îÊ≠•ÔºöÁªìÊûúÂèçÈ¶à ---
    let resultMsg = '';

    if (newStickers.length > 0) {
      await db.userStickers.bulkAdd(newStickers);
      state.userStickers.push(...newStickers);
      renderStickerPanel();
      resultMsg = `ÊàêÂäüÂØºÂÖ• ${newStickers.length} ‰∏™Êñ∞Ë°®ÊÉÖÔºÅ`;
    }

    if (skippedPureLinks > 0) {
      resultMsg += `\n‚ö†Ô∏è Êúâ ${skippedPureLinks} Ë°åÂõ†Âè™ÊúâÈìæÊé•(Êó†ÂêçÂ≠ó)Ë¢´Ë∑≥Ëøá„ÄÇ`;
    }

    if (errorCount > 0) {
      resultMsg += `\n‚ùå Êúâ ${errorCount} Ë°åÊ†ºÂºèÊó†Ê≥ïËØÜÂà´„ÄÇ`;
    }

    if (resultMsg) {
      await showCustomAlert('ÂØºÂÖ•ÁªìÊûú', resultMsg);
    } else if (lines.length > 0) {
      await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', 'Êú™ËÉΩËØÜÂà´‰ªª‰ΩïÊúâÊïàÊï∞ÊçÆÔºåËØ∑Á°Æ‰øùÊØèË°åÈÉΩÂåÖÂê´„ÄêÂêçÂ≠ó„ÄëÂíå„ÄêÈìæÊé•„Äë„ÄÇ');
    }
  }
  // Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
  function handleStickerFileImport() {
    return new Promise(resolve => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.txt,.json,.docx'; // ÈôêÂà∂Êñá‰ª∂Á±ªÂûã

      input.onchange = async e => {
        const file = e.target.files[0];
        if (!file) {
          resolve();
          return;
        }

        try {
          await showCustomAlert("Ê≠£Âú®Ëß£Êûê...", "Ê≠£Âú®ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπÔºåËØ∑Á®çÂÄô...");
          const textContent = await processStickerFile(file);

          if (textContent && textContent.trim()) {
            // Ëß£ÊûêÊàêÂäüÂêéÔºåÁõ¥Êé•Â§çÁî®‰πãÂâçÁöÑÊñáÊú¨Ëß£ÊûêÈÄªËæë
            // ËøôÊ†∑Êó†ËÆ∫ÊòØÊñá‰ª∂ËøòÊòØÁ≤òË¥¥ÔºåÈÉΩÊîØÊåÅÈÇ£ÁßçÁÅµÊ¥ªÁöÑÊ†ºÂºèÔºà‰∏≠ÊñáÂÜíÂè∑„ÄÅÊó†Á©∫Ê†ºÁ≠âÔºâ
            await handleBatchStickerImport(textContent);
          } else {
            alert("Êñá‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫ÊàñÊó†Ê≥ïËß£Êûê„ÄÇ");
          }
        } catch (error) {
          console.error("Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•:", error);
          alert(`Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•: ${error.message}`);
        }
        resolve();
      };

      input.click();
    });
  }

  // Ê†∏ÂøÉÔºöÊ†πÊçÆÂêéÁºÄÂêçËß£ÊûêÊñá‰ª∂ÂÜÖÂÆπ
  async function processStickerFile(file) {
    const fileName = file.name.toLowerCase();

    // 1. Â§ÑÁêÜ .txt Êñá‰ª∂
    if (fileName.endsWith('.txt')) {
      return await file.text();
    }

    // 2. Â§ÑÁêÜ .docx Êñá‰ª∂ (‰æùËµñ mammoth.js)
    if (fileName.endsWith('.docx')) {
      if (typeof mammoth === 'undefined') {
        throw new Error("Êú™Âä†ËΩΩ mammoth.js Â∫ìÔºåÊó†Ê≥ïËØªÂèñ Word ÊñáÊ°£„ÄÇ");
      }
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
      return result.value; // ËøîÂõû Word ‰∏≠ÁöÑÁ∫ØÊñáÊú¨
    }

    // 3. Â§ÑÁêÜ .json Êñá‰ª∂
    if (fileName.endsWith('.json')) {
      const text = await file.text();
      let json;
      try {
        json = JSON.parse(text);
      } catch (e) {
        throw new Error("JSON Ê†ºÂºèÈîôËØØ");
      }

      // Â∞Ü JSON ËΩ¨Êç¢‰∏∫ "ÂêçÂ≠ó: ÈìæÊé•" ÁöÑÊñáÊú¨Ê†ºÂºèÔºå‰ª•‰æøÂ§çÁî® handleBatchStickerImport
      let convertedText = "";

      if (Array.isArray(json)) {
        // ÊÉÖÂÜµ A: Êï∞ÁªÑÊ†ºÂºè [{name: "ÂºÄÂøÉ", url: "http..."}, ...]
        json.forEach(item => {
          // Â∞ùËØïÂ§öÁßçÂèØËÉΩÁöÑÈîÆÂêç
          const name = item.name || item.key || item.title || item.meaning;
          const url = item.url || item.src || item.content || item.link;
          if (name && url) {
            convertedText += `${name}: ${url}\n`;
          }
        });
      } else if (typeof json === 'object') {
        // ÊÉÖÂÜµ B: ÂØπË±°Ê†ºÂºè {"ÂºÄÂøÉ": "http...", "Âì≠Ê≥£": "http..."}
        // ÊàñËÄÖ Tavern Ê†ºÂºè {"entries": ...}
        if (json.entries) {
          // ÁÆÄÂçïÁöÑÂÖºÂÆπ Tavern Ê†ºÂºè
          const entries = Array.isArray(json.entries) ? json.entries : Object.values(json.entries);
          entries.forEach(item => {
            const name = item.comment || item.key?.toString() || "Ë°®ÊÉÖ";
            const url = item.content || item.url;
            if (url && url.startsWith('http')) {
              convertedText += `${name}: ${url}\n`;
            }
          });
        } else {
          // ÊôÆÈÄö Key-Value ÂØπ
          for (let key in json) {
            const val = json[key];
            if (typeof val === 'string' && (val.startsWith('http') || val.startsWith('data:image'))) {
              convertedText += `${key}: ${val}\n`;
            }
          }
        }
      }
      return convertedText;
    }

    throw new Error("‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè");
  }

  // Â§ÑÁêÜËßíËâ≤Êñá‰ª∂ÂØºÂÖ• (.txt/.docx/.zip) - ÊîØÊåÅÂ§öÊñá‰ª∂‰∏ÄÊ¨°ÊÄßÂØºÂÖ•
  function handleCharacterFileImport() {
    return new Promise(resolve => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.txt,.docx,.zip'; // ÊîØÊåÅ TXT„ÄÅDOCX Âíå ZIP
      input.multiple = true; // ÊîØÊåÅÂ§öÊñá‰ª∂ÈÄâÊã©

      input.onchange = async e => {
        const files = Array.from(e.target.files);
        if (!files || files.length === 0) {
          resolve();
          return;
        }

        // ÂàÜÁ¶ª ZIP Êñá‰ª∂ÂíåÊôÆÈÄöÊñá‰ª∂
        const zipFiles = files.filter(f => f.name.toLowerCase().endsWith('.zip'));
        const normalFiles = files.filter(f => !f.name.toLowerCase().endsWith('.zip'));

        // ÂÖàÂ§ÑÁêÜ ZIP Êñá‰ª∂
        for (const zipFile of zipFiles) {
          try {
            await handleZipFileImport(zipFile);
          } catch (error) {
            console.error(`ZIPÊñá‰ª∂"${zipFile.name}"Â§ÑÁêÜÂ§±Ë¥•:`, error);
            await showCustomAlert('ZIPÊñá‰ª∂Â§ÑÁêÜÂ§±Ë¥•', `Êñá‰ª∂"${zipFile.name}"Â§ÑÁêÜÂ§±Ë¥•: ${error.message}`);
          }
        }

        // Â¶ÇÊûúÊ≤°ÊúâÊôÆÈÄöÊñá‰ª∂ÔºåÁõ¥Êé•ÁªìÊùü
        if (normalFiles.length === 0) {
          resolve();
          return;
        }

        let importedCount = 0;
        let skippedCount = 0;
        let failedCount = 0;

        // ÈÄê‰∏™Â§ÑÁêÜÊôÆÈÄöÊñá‰ª∂
        for (let i = 0; i < normalFiles.length; i++) {
          const file = normalFiles[i];

          try {
            // Ëß£ÊûêÊñá‰ª∂ÂÜÖÂÆπ
            const textContent = await processCharacterFile(file);

            if (!textContent || !textContent.trim()) {
              await showCustomAlert('Êñá‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫', `Êñá‰ª∂"${file.name}"ÂÜÖÂÆπ‰∏∫Á©∫ÊàñÊó†Ê≥ïËß£ÊûêÔºåÂ∑≤Ë∑≥Ëøá„ÄÇ`);
              skippedCount++;
              continue;
            }

            // ÊòæÁ§∫ÂÜÖÂÆπÁ°ÆËÆ§ÂºπÁ™óÔºàÂ∏¶Êñá‰ª∂ÂêçÂíåËøõÂ∫¶Ôºâ
            const action = await showMultiFileContentConfirmModal(
              textContent,
              file.name,
              i + 1,
              normalFiles.length
            );

            if (action === 'cancel') {
              // Áî®Êà∑ÈÄâÊã©ÂèñÊ∂àÊï¥‰∏™ÂØºÂÖ•ÊµÅÁ®ã
              break;
            } else if (action === 'skip') {
              // Ë∑≥ËøáÂΩìÂâçÊñá‰ª∂ÔºåÁªßÁª≠‰∏ã‰∏Ä‰∏™
              skippedCount++;
              continue;
            }

            // ËøõÂÖ•ÊâãÂä®ÂàõÂª∫ÊµÅÁ®ã
            const remarkName = await showCustomPrompt(
              `ÂàõÂª∫ËßíËâ≤ [${i + 1}/${normalFiles.length}] (Á¨¨1/2Ê≠•)`,
              `Êñá‰ª∂: ${file.name}\n\nËØ∑ËæìÂÖ•‰Ω†ÊÉ≥‰∏∫TaËÆæÁΩÆÁöÑ„ÄêÂ§áÊ≥®Âêç„Äë`
            );
            if (!remarkName || !remarkName.trim()) {
              skippedCount++;
              continue;
            }

            const originalName = await showCustomPrompt(
              `ÂàõÂª∫ËßíËâ≤ [${i + 1}/${normalFiles.length}] (Á¨¨2/2Ê≠•)`,
              `Êñá‰ª∂: ${file.name}\n\nËØ∑ËæìÂÖ•TaÁöÑ„ÄêÊú¨Âêç„Äë`
            );
            if (!originalName || !originalName.trim()) {
              skippedCount++;
              continue;
            }

            // ÂàõÂª∫Êñ∞ËÅäÂ§©ÔºåaiPersona ‰ΩøÁî®ÂØºÂÖ•ÁöÑÂÜÖÂÆπ
            const newChatId = 'chat_' + Date.now() + '_' + i; // Ê∑ªÂä†Á¥¢ÂºïÈÅøÂÖçIDÂÜ≤Á™Å
            const newChat = {
              id: newChatId,
              name: remarkName.trim(),
              originalName: originalName.trim(),
              isGroup: false,
              isPinned: false,
              unreadCount: 0,
              country: 'China', // ÈªòËÆ§‰∏≠ÂõΩÔºåÂêéÁª≠ÂèØ‰ª•Ëá™Âä®ËØÜÂà´ÊàñÊâãÂä®‰øÆÊîπ
              relationship: {
                status: 'friend',
                blockedTimestamp: null,
                applicationReason: ''
              },
              status: {
                text: 'Âú®Á∫ø',
                lastUpdate: Date.now(),
                isBusy: false
              },
              settings: {
                aiPersona: textContent.trim(), // ‰ΩøÁî®ÂØºÂÖ•ÁöÑÂÜÖÂÆπ‰Ωú‰∏∫ÂØπÊñπ‰∫∫ËÆæ
                myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ',
                myNickname: 'Êàë',
                maxMemory: 10,
                aiAvatar: defaultAvatar,
                myAvatar: defaultAvatar,
                background: '',
                theme: 'default',
                fontSize: 13,
                customCss: '',
                linkedWorldBookIds: [],
                aiAvatarLibrary: [],
                myAvatarLibrary: [],
                enableBackgroundActivity: true,
                actionCooldownMinutes: 15,
                enableTimePerception: true,
                isOfflineMode: false,
                offlineMinLength: 100,
                offlineMaxLength: 300,
                offlinePresetId: null,
                offlineContinuousLayout: false,
                timeZone: 'Asia/Shanghai',
                myPhoneLockScreenEnabled: false,
                myPhoneLockScreenPassword: '',
                userStatus: {
                  text: 'Âú®Á∫ø',
                  lastUpdate: Date.now(),
                  isBusy: false
                }
              },
              history: [],
              musicData: {
                totalTime: 0
              },
              longTermMemory: [],
              thoughtsHistory: []
            };

            state.chats[newChatId] = newChat;
            await db.chats.put(newChat);
            importedCount++;

            // ÊØèÂØºÂÖ•‰∏Ä‰∏™ÂêéÂà∑Êñ∞ÂàóË°®
            renderChatList();

          } catch (error) {
            console.error(`Êñá‰ª∂"${file.name}"ÂØºÂÖ•Â§±Ë¥•:`, error);
            await showCustomAlert('Êñá‰ª∂ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂"${file.name}"Ëß£ÊûêÂ§±Ë¥•: ${error.message}`);
            failedCount++;
          }
        }

        // ÊòæÁ§∫ÊÄªÁªì‰ø°ÊÅØ
        if (importedCount > 0 || skippedCount > 0 || failedCount > 0) {
          let summary = `ÂØºÂÖ•ÂÆåÊàêÔºÅ\n\n`;
          if (importedCount > 0) summary += `‚úì ÊàêÂäüÂØºÂÖ•: ${importedCount} ‰∏™ËßíËâ≤\n`;
          if (skippedCount > 0) summary += `‚óã Â∑≤Ë∑≥Ëøá: ${skippedCount} ‰∏™Êñá‰ª∂\n`;
          if (failedCount > 0) summary += `‚úó Â§±Ë¥•: ${failedCount} ‰∏™Êñá‰ª∂\n`;

          await showCustomAlert('ÊâπÈáèÂØºÂÖ•ÁªìÊûú', summary);
        }

        resolve();
      };

      input.click();
    });
  }

  // Ëß£ÊûêËßíËâ≤Êñá‰ª∂ÂÜÖÂÆπ (ÊîØÊåÅ .txt Âíå .docx)
  async function processCharacterFile(file) {
    const fileName = file.name.toLowerCase();

    // Â§ÑÁêÜ .txt Êñá‰ª∂
    if (fileName.endsWith('.txt')) {
      return await file.text();
    }

    // Â§ÑÁêÜ .docx Êñá‰ª∂ (‰æùËµñ mammoth.js)
    if (fileName.endsWith('.docx')) {
      if (typeof mammoth === 'undefined') {
        throw new Error("Êú™Âä†ËΩΩ mammoth.js Â∫ìÔºåÊó†Ê≥ïËØªÂèñ Word ÊñáÊ°£„ÄÇ");
      }

      const arrayBuffer = await file.arrayBuffer();

      try {
        // ÊñπÊ°à 1: Â∞ùËØïÊèêÂèñÁ∫ØÊñáÊú¨
        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });

        if (result.value && result.value.trim()) {
          return result.value;
        }

        // Â¶ÇÊûúÁ∫ØÊñáÊú¨‰∏∫Á©∫ÔºåÂ∞ùËØïËΩ¨Êç¢‰∏∫ HTML ÂÜçÊèêÂèñ
        const htmlResult = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
        if (htmlResult.value) {
          // ÁÆÄÂçïÁßªÈô§ HTML Ê†áÁ≠æ
          const textContent = htmlResult.value.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
          if (textContent) {
            return textContent;
          }
        }

        throw new Error("DOCX Êñá‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫");

      } catch (error) {
        console.error("DOCX Ëß£ÊûêÈîôËØØ:", error);
        // Êèê‰æõÊõ¥ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
        throw new Error(
          "Êó†Ê≥ïËß£ÊûêÊ≠§ DOCX Êñá‰ª∂ÔºåÂèØËÉΩÂéüÂõ†Ôºö\n" +
          "1. Êñá‰ª∂ÊçüÂùèÊàñÊ†ºÂºè‰∏çÊ†áÂáÜ\n" +
          "2. Êñá‰ª∂‰ΩøÁî®‰∫Ü‰∏çÂÖºÂÆπÁöÑ Word ÂäüËÉΩ\n\n" +
          "Âª∫ËÆÆËß£ÂÜ≥ÊñπÊ°àÔºö\n" +
          "‚Ä¢ Áî® Word ÊâìÂºÄÊñá‰ª∂ÔºåÂè¶Â≠ò‰∏∫Êñ∞ÁöÑ .docx\n" +
          "‚Ä¢ ÊàñËÄÖÂè¶Â≠ò‰∏∫ .txt Á∫ØÊñáÊú¨Ê†ºÂºèÂêéÂÜçÂØºÂÖ•"
        );
      }
    }

    // ÁâπÂà´ÊèêÁ§∫Ôºö‰∏çÊîØÊåÅÊóßÁâà .doc Ê†ºÂºè
    if (fileName.endsWith('.doc')) {
      throw new Error("‰∏çÊîØÊåÅÊóßÁâà .doc Ê†ºÂºèÔºåËØ∑Â∞ÜÊñá‰ª∂Âè¶Â≠ò‰∏∫ .docx Êàñ .txt Ê†ºÂºèÂêéÂÜçÂØºÂÖ•„ÄÇ");
    }

    throw new Error("‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºèÔºå‰ªÖÊîØÊåÅ .txt Âíå .docx");
  }

  // Â§ÑÁêÜZIPÊñá‰ª∂ÂØºÂÖ•
  async function handleZipFileImport(zipFile) {
    try {
      // Ê£ÄÊü•JSZipÊòØÂê¶ÂèØÁî®
      if (typeof JSZip === 'undefined') {
        throw new Error("Êú™Âä†ËΩΩ JSZip Â∫ìÔºåÊó†Ê≥ïËß£Êûê ZIP Êñá‰ª∂„ÄÇ");
      }

      // ËØªÂèñZIPÊñá‰ª∂
      const zip = await JSZip.loadAsync(zipFile);

      // ÊèêÂèñÊâÄÊúâ .txt Âíå .docx Êñá‰ª∂
      const fileEntries = [];

      for (const [filename, zipEntry] of Object.entries(zip.files)) {
        // Ë∑≥ËøáÁõÆÂΩïÂíåÈöêËóèÊñá‰ª∂
        if (zipEntry.dir || filename.startsWith('__MACOSX') || filename.startsWith('.')) {
          continue;
        }

        const lowerName = filename.toLowerCase();
        if (lowerName.endsWith('.txt') || lowerName.endsWith('.docx')) {
          fileEntries.push({
            filename: filename,
            zipEntry: zipEntry,
            type: lowerName.endsWith('.txt') ? 'txt' : 'docx'
          });
        }
      }

      if (fileEntries.length === 0) {
        await showCustomAlert('ZIPÊñá‰ª∂‰∏∫Á©∫', `ZIPÊñá‰ª∂"${zipFile.name}"‰∏≠Ê≤°ÊúâÊâæÂà∞ .txt Êàñ .docx Êñá‰ª∂„ÄÇ`);
        return;
      }

      // ÊòæÁ§∫Êñá‰ª∂ÈÄâÊã©ÁïåÈù¢
      const selectedFiles = await showZipFileSelectionModal(fileEntries, zipFile.name);

      if (!selectedFiles || selectedFiles.length === 0) {
        return; // Áî®Êà∑ÂèñÊ∂àÊàñÊ≤°ÊúâÈÄâÊã©‰ªª‰ΩïÊñá‰ª∂
      }

      // Â§ÑÁêÜÈÄâ‰∏≠ÁöÑÊñá‰ª∂
      let importedCount = 0;
      let skippedCount = 0;
      let failedCount = 0;

      for (let i = 0; i < selectedFiles.length; i++) {
        const entry = selectedFiles[i];

        try {
          // Ëß£ÊûêÊñá‰ª∂ÂÜÖÂÆπ
          let textContent;

          if (entry.type === 'txt') {
            // ËØªÂèñTXTÊñá‰ª∂
            textContent = await entry.zipEntry.async('text');
          } else if (entry.type === 'docx') {
            // ËØªÂèñDOCXÊñá‰ª∂
            if (typeof mammoth === 'undefined') {
              throw new Error("Êú™Âä†ËΩΩ mammoth.js Â∫ìÔºåÊó†Ê≥ïËØªÂèñ Word ÊñáÊ°£„ÄÇ");
            }

            const arrayBuffer = await entry.zipEntry.async('arraybuffer');
            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });

            if (result.value && result.value.trim()) {
              textContent = result.value;
            } else {
              // Â∞ùËØïËΩ¨Êç¢‰∏∫HTMLÂÜçÊèêÂèñ
              const htmlResult = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
              textContent = htmlResult.value.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
            }
          }

          if (!textContent || !textContent.trim()) {
            await showCustomAlert('Êñá‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫', `Êñá‰ª∂"${entry.filename}"ÂÜÖÂÆπ‰∏∫Á©∫ÊàñÊó†Ê≥ïËß£ÊûêÔºåÂ∑≤Ë∑≥Ëøá„ÄÇ`);
            skippedCount++;
            continue;
          }

          // ÊòæÁ§∫ÂÜÖÂÆπÁ°ÆËÆ§ÂºπÁ™ó
          const action = await showMultiFileContentConfirmModal(
            textContent,
            entry.filename,
            i + 1,
            selectedFiles.length
          );

          if (action === 'cancel') {
            break;
          } else if (action === 'skip') {
            skippedCount++;
            continue;
          }

          // ÂàõÂª∫ËßíËâ≤ÊµÅÁ®ã
          const remarkName = await showCustomPrompt(
            `ÂàõÂª∫ËßíËâ≤ [${i + 1}/${selectedFiles.length}] (Á¨¨1/2Ê≠•)`,
            `Êñá‰ª∂: ${entry.filename}\n\nËØ∑ËæìÂÖ•‰Ω†ÊÉ≥‰∏∫TaËÆæÁΩÆÁöÑ„ÄêÂ§áÊ≥®Âêç„Äë`
          );

          if (!remarkName || !remarkName.trim()) {
            skippedCount++;
            continue;
          }

          const originalName = await showCustomPrompt(
            `ÂàõÂª∫ËßíËâ≤ [${i + 1}/${selectedFiles.length}] (Á¨¨2/2Ê≠•)`,
            `Êñá‰ª∂: ${entry.filename}\n\nËØ∑ËæìÂÖ•TaÁöÑ„ÄêÊú¨Âêç„Äë`
          );

          if (!originalName || !originalName.trim()) {
            skippedCount++;
            continue;
          }

          // ÂàõÂª∫Êñ∞ËÅäÂ§©
          const newChatId = 'chat_' + Date.now() + '_' + i;
          const newChat = {
            id: newChatId,
            name: remarkName.trim(),
            originalName: originalName.trim(),
            isGroup: false,
            isPinned: false,
            unreadCount: 0,
            country: 'China', // ÈªòËÆ§‰∏≠ÂõΩÔºåÂêéÁª≠ÂèØ‰ª•Ëá™Âä®ËØÜÂà´ÊàñÊâãÂä®‰øÆÊîπ
            relationship: {
              status: 'friend',
              blockedTimestamp: null,
              applicationReason: ''
            },
            status: {
              text: 'Âú®Á∫ø',
              lastUpdate: Date.now(),
              isBusy: false
            },
            settings: {
              aiPersona: textContent.trim(),
              myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ',
              myNickname: 'Êàë',
              maxMemory: 10,
              aiAvatar: defaultAvatar,
              myAvatar: defaultAvatar,
              background: '',
              theme: 'default',
              fontSize: 13,
              customCss: '',
              linkedWorldBookIds: [],
              aiAvatarLibrary: [],
              myAvatarLibrary: [],
              enableBackgroundActivity: true,
              actionCooldownMinutes: 15,
              enableTimePerception: true,
              isOfflineMode: false,
              offlineMinLength: 100,
              offlineMaxLength: 300,
              offlinePresetId: null,
              offlineContinuousLayout: false,
              timeZone: 'Asia/Shanghai',
              userStatus: {
                text: 'Âú®Á∫ø',
                lastUpdate: Date.now(),
                isBusy: false
              }
            },
            history: [],
            musicData: {
              totalTime: 0
            },
            longTermMemory: [],
            thoughtsHistory: []
          };

          state.chats[newChatId] = newChat;
          await db.chats.put(newChat);
          importedCount++;
          renderChatList();

        } catch (error) {
          console.error(`Êñá‰ª∂"${entry.filename}"ÂØºÂÖ•Â§±Ë¥•:`, error);
          await showCustomAlert('Êñá‰ª∂ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂"${entry.filename}"Ëß£ÊûêÂ§±Ë¥•: ${error.message}`);
          failedCount++;
        }
      }

      // ÊòæÁ§∫ÊÄªÁªì
      if (importedCount > 0 || skippedCount > 0 || failedCount > 0) {
        let summary = `ZIPÊñá‰ª∂ÂØºÂÖ•ÂÆåÊàêÔºÅ\n\n`;
        if (importedCount > 0) summary += `‚úì ÊàêÂäüÂØºÂÖ•: ${importedCount} ‰∏™ËßíËâ≤\n`;
        if (skippedCount > 0) summary += `‚óã Â∑≤Ë∑≥Ëøá: ${skippedCount} ‰∏™Êñá‰ª∂\n`;
        if (failedCount > 0) summary += `‚úó Â§±Ë¥•: ${failedCount} ‰∏™Êñá‰ª∂\n`;

        await showCustomAlert('ZIPÂØºÂÖ•ÁªìÊûú', summary);
      }

    } catch (error) {
      console.error('ZIPÊñá‰ª∂Â§ÑÁêÜÂ§±Ë¥•:', error);
      throw error;
    }
  }

  // ÊòæÁ§∫ZIPÊñá‰ª∂ÈÄâÊã©ÁïåÈù¢
  function showZipFileSelectionModal(fileEntries, zipFileName) {
    return new Promise(resolve => {
      const modal = document.createElement('div');
      modal.className = 'custom-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

      const modalContent = document.createElement('div');
      modalContent.style.cssText = 'background: white; border-radius: 12px; padding: 20px; max-width: 600px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;';

      const title = document.createElement('h3');
      title.textContent = 'ZIPÊñá‰ª∂ÂØºÂÖ• - ÈÄâÊã©Êñá‰ª∂';
      title.style.cssText = 'margin: 0 0 10px 0; font-size: 18px; text-align: center; color: #333;';

      const zipNameLabel = document.createElement('p');
      zipNameLabel.textContent = `üì¶ ${zipFileName}`;
      zipNameLabel.style.cssText = 'margin: 0 0 15px 0; text-align: center; font-size: 13px; color: #666; background: #f0f0f0; padding: 8px; border-radius: 6px; font-weight: 500;';

      const infoText = document.createElement('p');
      infoText.textContent = `ÊâæÂà∞ ${fileEntries.length} ‰∏™ÂèØÂØºÂÖ•ÁöÑÊñá‰ª∂ÔºåËØ∑ÈÄâÊã©Ë¶ÅÂØºÂÖ•ÁöÑÊñá‰ª∂Ôºö`;
      infoText.style.cssText = 'margin: 0 0 12px 0; font-size: 14px; color: #555;';

      // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâÊåâÈíÆ
      const selectAllContainer = document.createElement('div');
      selectAllContainer.style.cssText = 'display: flex; gap: 8px; margin-bottom: 12px; justify-content: flex-end;';

      const selectAllBtn = document.createElement('button');
      selectAllBtn.textContent = 'ÂÖ®ÈÄâ';
      selectAllBtn.style.cssText = 'padding: 6px 12px; border: 1px solid #007AFF; border-radius: 6px; background: white; color: #007AFF; font-size: 13px; cursor: pointer;';

      const deselectAllBtn = document.createElement('button');
      deselectAllBtn.textContent = 'ÂèñÊ∂àÂÖ®ÈÄâ';
      deselectAllBtn.style.cssText = 'padding: 6px 12px; border: 1px solid #999; border-radius: 6px; background: white; color: #666; font-size: 13px; cursor: pointer;';

      selectAllContainer.appendChild(selectAllBtn);
      selectAllContainer.appendChild(deselectAllBtn);

      // Êñá‰ª∂ÂàóË°®ÂÆπÂô®
      const fileListContainer = document.createElement('div');
      fileListContainer.style.cssText = 'flex: 1; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; margin-bottom: 15px; background: #fafafa; max-height: 400px;';

      const checkboxes = [];

      // ÂàõÂª∫Êñá‰ª∂ÂàóË°®È°π
      fileEntries.forEach((entry, index) => {
        const fileItem = document.createElement('label');
        fileItem.style.cssText = 'display: flex; align-items: center; padding: 10px; margin-bottom: 6px; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e0e0e0; transition: background 0.2s;';

        fileItem.onmouseover = () => fileItem.style.background = '#f0f8ff';
        fileItem.onmouseout = () => fileItem.style.background = 'white';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true; // ÈªòËÆ§ÂÖ®ÈÄâ
        checkbox.style.cssText = 'width: 18px; height: 18px; margin-right: 10px; cursor: pointer;';
        checkboxes.push(checkbox);

        const fileIcon = document.createElement('span');
        fileIcon.textContent = entry.type === 'txt' ? 'üìÑ' : 'üìù';
        fileIcon.style.cssText = 'font-size: 18px; margin-right: 8px;';

        const fileName = document.createElement('span');
        fileName.textContent = entry.filename;
        fileName.style.cssText = 'flex: 1; font-size: 13px; color: #333; word-break: break-all;';

        const fileType = document.createElement('span');
        fileType.textContent = `.${entry.type}`;
        fileType.style.cssText = 'font-size: 11px; color: #999; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-left: 8px;';

        fileItem.appendChild(checkbox);
        fileItem.appendChild(fileIcon);
        fileItem.appendChild(fileName);
        fileItem.appendChild(fileType);

        fileListContainer.appendChild(fileItem);
      });

      // ÂÖ®ÈÄâÊåâÈíÆ‰∫ã‰ª∂
      selectAllBtn.onclick = () => {
        checkboxes.forEach(cb => cb.checked = true);
      };

      // ÂèñÊ∂àÂÖ®ÈÄâÊåâÈíÆ‰∫ã‰ª∂
      deselectAllBtn.onclick = () => {
        checkboxes.forEach(cb => cb.checked = false);
      };

      // ËÆ°Êï∞ÊòæÁ§∫
      const countLabel = document.createElement('p');
      countLabel.style.cssText = 'margin: 0 0 15px 0; text-align: center; font-size: 13px; color: #666;';

      const updateCount = () => {
        const selectedCount = checkboxes.filter(cb => cb.checked).length;
        countLabel.textContent = `Â∑≤ÈÄâÊã© ${selectedCount} / ${fileEntries.length} ‰∏™Êñá‰ª∂`;
      };

      checkboxes.forEach(cb => cb.addEventListener('change', updateCount));
      updateCount();

      // ÊåâÈíÆÂÆπÂô®
      const buttonContainer = document.createElement('div');
      buttonContainer.style.cssText = 'display: flex; gap: 10px;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'ÂèñÊ∂à';
      cancelBtn.style.cssText = 'flex: 1; padding: 12px; border: none; border-radius: 8px; background: #ddd; font-size: 16px; cursor: pointer;';
      cancelBtn.onclick = () => {
        document.body.removeChild(modal);
        resolve(null);
      };

      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'Á°ÆËÆ§ÂØºÂÖ•';
      confirmBtn.style.cssText = 'flex: 1; padding: 12px; border: none; border-radius: 8px; background: #007AFF; color: white; font-size: 16px; cursor: pointer;';
      confirmBtn.onclick = () => {
        const selectedFiles = fileEntries.filter((entry, index) => checkboxes[index].checked);

        if (selectedFiles.length === 0) {
          alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂ÔºÅ');
          return;
        }

        document.body.removeChild(modal);
        resolve(selectedFiles);
      };

      buttonContainer.appendChild(cancelBtn);
      buttonContainer.appendChild(confirmBtn);

      modalContent.appendChild(title);
      modalContent.appendChild(zipNameLabel);
      modalContent.appendChild(infoText);
      modalContent.appendChild(selectAllContainer);
      modalContent.appendChild(fileListContainer);
      modalContent.appendChild(countLabel);
      modalContent.appendChild(buttonContainer);

      modal.appendChild(modalContent);
      document.body.appendChild(modal);
    });
  }

  // ÊòæÁ§∫ÂÜÖÂÆπÁ°ÆËÆ§ÂºπÁ™ó
  function showContentConfirmModal(content) {
    return new Promise(resolve => {
      const modal = document.createElement('div');
      modal.className = 'custom-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

      const modalContent = document.createElement('div');
      modalContent.style.cssText = 'background: white; border-radius: 12px; padding: 20px; max-width: 500px; width: 90%; max-height: 70vh; display: flex; flex-direction: column;';

      const title = document.createElement('h3');
      title.textContent = 'ÂÜÖÂÆπÁ°ÆËÆ§';
      title.style.cssText = 'margin: 0 0 15px 0; font-size: 18px; text-align: center;';

      const contentBox = document.createElement('div');
      contentBox.style.cssText = 'flex: 1; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; white-space: pre-wrap; word-wrap: break-word; font-size: 14px; line-height: 1.6; max-height: 400px;';
      contentBox.textContent = content;

      const question = document.createElement('p');
      question.textContent = 'ÊòØÂê¶Â∞Ü‰ª•‰∏äÂÜÖÂÆπÂÆåÂÖ®Â°´ÂÖ•Âà∞ÂØπÊñπ‰∫∫ËÆæ‰∏≠Ôºü';
      question.style.cssText = 'margin: 0 0 15px 0; text-align: center; font-size: 15px;';

      const buttonContainer = document.createElement('div');
      buttonContainer.style.cssText = 'display: flex; gap: 10px;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'ÂèñÊ∂à';
      cancelBtn.style.cssText = 'flex: 1; padding: 12px; border: none; border-radius: 8px; background: #ddd; font-size: 16px; cursor: pointer;';
      cancelBtn.onclick = () => {
        document.body.removeChild(modal);
        resolve(false);
      };

      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'Á°ÆÂÆö';
      confirmBtn.style.cssText = 'flex: 1; padding: 12px; border: none; border-radius: 8px; background: #007AFF; color: white; font-size: 16px; cursor: pointer;';
      confirmBtn.onclick = () => {
        document.body.removeChild(modal);
        resolve(true);
      };

      buttonContainer.appendChild(cancelBtn);
      buttonContainer.appendChild(confirmBtn);

      modalContent.appendChild(title);
      modalContent.appendChild(contentBox);
      modalContent.appendChild(question);
      modalContent.appendChild(buttonContainer);

      modal.appendChild(modalContent);
      document.body.appendChild(modal);
    });
  }

  // Â§öÊñá‰ª∂ÂØºÂÖ•‰∏ìÁî®ÁöÑÂÜÖÂÆπÁ°ÆËÆ§ÂºπÁ™óÔºàÊîØÊåÅË∑≥ËøáÔºâ
  function showMultiFileContentConfirmModal(content, fileName, currentIndex, totalCount) {
    return new Promise(resolve => {
      const modal = document.createElement('div');
      modal.className = 'custom-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

      const modalContent = document.createElement('div');
      modalContent.style.cssText = 'background: white; border-radius: 12px; padding: 20px; max-width: 550px; width: 90%; max-height: 75vh; display: flex; flex-direction: column;';

      const title = document.createElement('h3');
      title.textContent = `Êñá‰ª∂ÂÜÖÂÆπÁ°ÆËÆ§ [${currentIndex}/${totalCount}]`;
      title.style.cssText = 'margin: 0 0 10px 0; font-size: 18px; text-align: center; color: #333;';

      const fileNameLabel = document.createElement('p');
      fileNameLabel.textContent = `üìÑ ${fileName}`;
      fileNameLabel.style.cssText = 'margin: 0 0 15px 0; text-align: center; font-size: 13px; color: #666; background: #f0f0f0; padding: 8px; border-radius: 6px; font-weight: 500;';

      const contentBox = document.createElement('div');
      contentBox.style.cssText = 'flex: 1; overflow-y: auto; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; white-space: pre-wrap; word-wrap: break-word; font-size: 13px; line-height: 1.6; max-height: 400px; border: 1px solid #e0e0e0;';
      contentBox.textContent = content;

      const question = document.createElement('p');
      question.innerHTML = 'ÊòØÂê¶Â∞Ü‰ª•‰∏äÂÜÖÂÆπÂ°´ÂÖ•Âà∞<strong>ÂØπÊñπ‰∫∫ËÆæ</strong>‰∏≠Ôºü';
      question.style.cssText = 'margin: 0 0 15px 0; text-align: center; font-size: 15px; color: #444;';

      const buttonContainer = document.createElement('div');
      buttonContainer.style.cssText = 'display: flex; gap: 8px;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'ÂèñÊ∂àÂÖ®ÈÉ®';
      cancelBtn.style.cssText = 'flex: 1; padding: 12px; border: none; border-radius: 8px; background: #e74c3c; color: white; font-size: 15px; cursor: pointer; transition: background 0.2s;';
      cancelBtn.onmouseover = () => cancelBtn.style.background = '#c0392b';
      cancelBtn.onmouseout = () => cancelBtn.style.background = '#e74c3c';
      cancelBtn.onclick = () => {
        document.body.removeChild(modal);
        resolve('cancel');
      };

      const skipBtn = document.createElement('button');
      skipBtn.textContent = 'Ë∑≥ËøáÊ≠§Êñá‰ª∂';
      skipBtn.style.cssText = 'flex: 1; padding: 12px; border: none; border-radius: 8px; background: #95a5a6; color: white; font-size: 15px; cursor: pointer; transition: background 0.2s;';
      skipBtn.onmouseover = () => skipBtn.style.background = '#7f8c8d';
      skipBtn.onmouseout = () => skipBtn.style.background = '#95a5a6';
      skipBtn.onclick = () => {
        document.body.removeChild(modal);
        resolve('skip');
      };

      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'Á°ÆÂÆöÂØºÂÖ•';
      confirmBtn.style.cssText = 'flex: 1; padding: 12px; border: none; border-radius: 8px; background: #27ae60; color: white; font-size: 15px; cursor: pointer; transition: background 0.2s; font-weight: 600;';
      confirmBtn.onmouseover = () => confirmBtn.style.background = '#229954';
      confirmBtn.onmouseout = () => confirmBtn.style.background = '#27ae60';
      confirmBtn.onclick = () => {
        document.body.removeChild(modal);
        resolve('confirm');
      };

      buttonContainer.appendChild(cancelBtn);
      buttonContainer.appendChild(skipBtn);
      buttonContainer.appendChild(confirmBtn);

      modalContent.appendChild(title);
      modalContent.appendChild(fileNameLabel);
      modalContent.appendChild(contentBox);
      modalContent.appendChild(question);
      modalContent.appendChild(buttonContainer);

      modal.appendChild(modalContent);
      document.body.appendChild(modal);

      // ÊîØÊåÅÈîÆÁõòÂø´Êç∑ÈîÆ
      const keyHandler = (e) => {
        if (e.key === 'Escape') {
          document.body.removeChild(modal);
          document.removeEventListener('keydown', keyHandler);
          resolve('skip');
        }
      };
      document.addEventListener('keydown', keyHandler);
    });
  }

  function scrollToOriginalMessage(originalTimestamp) {
    const selector = `.message-bubble[data-timestamp="${originalTimestamp}"]`;
    const originalMessageBubble = document.querySelector(selector);

    if (originalMessageBubble) {
      originalMessageBubble.scrollIntoView({
        behavior: 'smooth',
        block: 'center'
      });

      originalMessageBubble.classList.add('highlighted');
      setTimeout(() => {
        if (document.body.contains(originalMessageBubble)) {
          originalMessageBubble.classList.remove('highlighted');
        }
      }, 1500);

    } else {

      alert("Êâæ‰∏çÂà∞ÂéüÂßãÊ∂àÊÅØ„ÄÇÂèØËÉΩÂ∑≤Ë¢´Âà†Èô§Êàñ‰Ωç‰∫éÊõ¥Êó©ÁöÑÂéÜÂè≤ËÆ∞ÂΩï‰∏≠„ÄÇ");
    }
  }
  async function createMessageElement(msg, chat) {

    // „Äê‰∏ªÂ±èÂπïQQ undefinedËøáÊª§„ÄëÂ¶ÇÊûúÊòØAIÊ∂àÊÅØ‰∏îÂÜÖÂÆπ‰∏∫Á©∫ÊàñundefinedÔºåÁõ¥Êé•ËøîÂõûnull‰∏çÊòæÁ§∫
    if (msg.role === 'assistant' && msg.type !== 'recalled_message' && msg.type !== 'post_deleted_notice' &&
      msg.type !== 'narration' && msg.type !== 'pat_message' && !msg.type?.startsWith('waimai_') &&
      msg.type !== 'red_packet' && msg.type !== 'transfer' && msg.type !== 'poll' && msg.type !== 'gift' &&
      msg.type !== 'kinship_request' && msg.type !== 'synth_music' && msg.type !== 'naiimag' && msg.type !== 'realimag' && msg.type !== 'googleimag' &&
      msg.type !== 'ai_image' && msg.type !== 'user_photo') {
      const contentStr = String(msg.content || '').trim().toLowerCase();
      if (contentStr === '' || contentStr === 'undefined') {
        console.log('[QQ UndefinedËøáÊª§] Â∑≤ËøáÊª§Á©∫Ê∂àÊÅØÊàñundefinedÊ∂àÊÅØ:', msg);
        return null;
      }
    }

    if (msg.type === 'recalled_message') {
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper system-pat';
      wrapper.dataset.timestamp = msg.timestamp;
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble recalled-message-placeholder';
      bubble.dataset.timestamp = msg.timestamp;
      bubble.textContent = msg.content;
      wrapper.appendChild(bubble);
      addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
      wrapper.addEventListener('click', () => {
        if (isSelectionMode) {
          toggleMessageSelection(msg.timestamp);
        }
      });
      return wrapper;
    } else if (msg.type === 'post_deleted_notice') {
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper system-pat';
      wrapper.dataset.timestamp = msg.timestamp;
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble post-deleted-placeholder';
      bubble.dataset.postId = msg.postId;
      bubble.textContent = msg.content;
      wrapper.appendChild(bubble);
      addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
      wrapper.addEventListener('click', () => {
        if (isSelectionMode) {
          toggleMessageSelection(msg.timestamp);
        }
      });
      return wrapper;
    }

    if (msg.isHidden && !chat.settings.showHiddenMessages) {
      return null;
    }
    if (msg.type === 'narration') {
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper system-pat'; // Â§çÁî®Á≥ªÁªüÊ∂àÊÅØÊ†∑Âºè(Â±Ö‰∏≠ÁÅ∞Ëâ≤)
      wrapper.dataset.timestamp = msg.timestamp; // ÂÖ≥ÈîÆÔºöÂøÖÈ°ªÊúâÊó∂Èó¥Êà≥ÊâçËÉΩÁºñËæë/Âà†Èô§

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble system-bubble';
      // ÂèØ‰ª•Âä†‰∏™ÂõæÊ†áËÆ©ÂÆÉÂíåÊôÆÈÄöÊãç‰∏ÄÊãçÂå∫ÂàÜÂºÄÔºå‰πüÂèØ‰ª•‰∏çÂä†
      bubble.innerHTML = `<span style="font-style:italic; opacity: 0.9;">${msg.content}</span>`;
      bubble.dataset.timestamp = msg.timestamp;

      wrapper.appendChild(bubble);

      // „ÄêÂÖ≥ÈîÆ„ÄëÊ∑ªÂä†ÈïøÊåâÁõëÂê¨ÔºåÂÆûÁé∞Âà†Èô§/ÁºñËæëÂäüËÉΩ
      addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));

      // ÊîØÊåÅÂ§öÈÄâ
      wrapper.addEventListener('click', () => {
        if (isSelectionMode) toggleMessageSelection(msg.timestamp);
      });

      return wrapper;
    }
    if (msg.type === 'pat_message') {
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper system-pat';
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble system-bubble';
      bubble.dataset.timestamp = msg.timestamp;
      bubble.textContent = msg.content;
      wrapper.appendChild(bubble);
      addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
      wrapper.addEventListener('click', () => {
        if (isSelectionMode) toggleMessageSelection(msg.timestamp);
      });
      return wrapper;
    }


    const isUser = msg.role === 'user';
    const myNickname = chat.settings.myNickname || 'Êàë';
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;
    if (msg.isHidden) {
      wrapper.classList.add('hidden-revealed');
    }
    if (msg.isExcluded) {
      wrapper.classList.add('msg-excluded');
    }
    if (chat.isGroup && !isUser) {
      const member = chat.members.find(m => m.originalName === msg.senderName)
                  || chat.members.find(m => m.groupNickname === msg.senderName);
      const senderNameDiv = document.createElement('div');
      senderNameDiv.className = 'sender-name';
      senderNameDiv.textContent = member ? member.groupNickname : (msg.senderName || 'Êú™Áü•ÊàêÂëò');
      wrapper.appendChild(senderNameDiv);
    }

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
    bubble.dataset.timestamp = msg.timestamp;

    const timestampEl = document.createElement('span');
    timestampEl.className = 'timestamp';
    timestampEl.textContent = formatTimestamp(msg.timestamp, chat.id);

    let avatarSrc, avatarFrameSrc = '';
    if (isUser) {
      avatarSrc = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
      avatarFrameSrc = chat.settings.myAvatarFrame || '';
    } else {
      if (chat.isGroup) {
        const member = chat.members.find(m => m.originalName === msg.senderName)
                    || chat.members.find(m => m.groupNickname === msg.senderName);
        if (member) {
          const characterProfile = state.chats[member.id];
          avatarSrc = member.avatar || (characterProfile ? characterProfile.settings.aiAvatar : defaultGroupMemberAvatar);
          avatarFrameSrc = member.avatarFrame || (characterProfile ? characterProfile.settings.aiAvatarFrame : '');
        } else {
          avatarSrc = defaultGroupMemberAvatar;
          avatarFrameSrc = '';
        }
      } else {
        avatarSrc = chat.settings.aiAvatar || defaultAvatar;
        avatarFrameSrc = chat.settings.aiAvatarFrame || '';
      }
    }

    let avatarHtml;
    if (avatarFrameSrc) {
      avatarHtml = `<div class="avatar-with-frame"><img src="${avatarSrc}" class="avatar-img"><img src="${avatarFrameSrc}" class="avatar-frame"></div>`;
    } else {
      avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
    }
    const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
    const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;

    let contentHtml;
    let quoteHtml = '';
    if (msg.quote) {
      const quotedSenderDisplayName = getDisplayNameInGroup(chat, msg.quote.senderName);
      const fullQuotedContent = String(msg.quote.content || '');
      quoteHtml = `
                    <div class="quoted-message" data-original-timestamp="${msg.quote.timestamp}" style="cursor: pointer;">
                        <div class="quoted-sender">ÂõûÂ§ç ${quotedSenderDisplayName}:</div>
                        <div class="quoted-content">${fullQuotedContent}</div>
                    </div>
                `;
    }





    let rawContent = msg.content;

    if (typeof rawContent === 'string' && rawContent.trim().startsWith('<') && rawContent.trim().endsWith('>')) {
      contentHtml = rawContent;
      bubble.classList.add('is-raw-html');
    } else if (msg.type === 'offline_text' || msg.type === 'share_link' || msg.type === 'share_card' || msg.type === 'location_share' || msg.type === 'ai_image' || msg.type === 'user_photo' || msg.type === 'voice_message' || msg.type === 'transfer' || msg.type === 'waimai_request' || msg.type === 'waimai_order' || msg.type === 'red_packet' || msg.type === 'poll' || msg.type === 'gift' || msg.type === 'realimag' || msg.type === 'naiimag' || msg.type === 'googleimag' || msg.type === 'kinship_request' || msg.type === 'forwarded_email' || msg.type === 'reddit_share') {

      if (msg.type === 'offline_text') {

        const combinedText = msg.content || `${msg.dialogue || ''} ${msg.description || ''}`.trim();

        const useContinuousLayout = chat && chat.settings && chat.settings.offlineContinuousLayout;

        if (useContinuousLayout) {
          // ËøûÁª≠ÊéíÁâàÊ®°ÂºèÔºöÊï¥‰ΩìÊ∏≤ÊüìÔºåÂØπËØùÈÉ®ÂàÜÂè™Âä†Ê†∑Âºè‰∏çÊãÜÊÆµ
          const dialogueRegex = /(„Äå.*?„Äç|‚Äú.*?‚Äù)/gs;
          let lastIndex = 0;
          let htmlParts = [];
          let match;
          while ((match = dialogueRegex.exec(combinedText)) !== null) {
            // ÂØπËØùÂâçÁöÑÊèèÂÜôÈÉ®ÂàÜ
            if (match.index > lastIndex) {
              const desc = combinedText.slice(lastIndex, match.index);
              if (desc.trim()) {
                htmlParts.push(parseMarkdown(desc).replace(/\n/g, '<br>'));
              }
            }
            // ÂØπËØùÈÉ®ÂàÜ
            htmlParts.push('<span class="offline-dialogue">' + parseMarkdown(match[0]) + '</span>');
            lastIndex = dialogueRegex.lastIndex;
          }
          // Ââ©‰ΩôÁöÑÊèèÂÜôÈÉ®ÂàÜ
          if (lastIndex < combinedText.length) {
            const remaining = combinedText.slice(lastIndex);
            if (remaining.trim()) {
              htmlParts.push(parseMarkdown(remaining).replace(/\n/g, '<br>'));
            }
          }
          contentHtml = '<div class="offline-continuous">' + htmlParts.join('') + '</div>';
        } else {
          // ÂéüÊúâÈÄªËæëÔºöÂØπËØùÂíåÊèèÂÜôÂàÜÂùóÊòæÁ§∫
          const regex = /(„Äå.*?„Äç|‚Äú.*?‚Äù)/g;
          const parts = combinedText.split(regex).filter(part => part);

          contentHtml = parts.map(part => {
            if (part.startsWith('„Äå') || part.startsWith('‚Äú')) {
              return '<span class="offline-dialogue">' + parseMarkdown(part) + '</span>';
            } else {
              return '<span class="offline-description">' + parseMarkdown(part.trim()).replace(/\n/g, '<br>') + '</span>';
            }
          }).join('');
        }
      } else if (msg.type === 'share_link') {
        bubble.classList.add('is-link-share', 'is-card-like');
        contentHtml = `<div class="link-share-card" data-timestamp="${msg.timestamp}"><div class="title">${msg.title || 'Êó†Ê†áÈ¢ò'}</div><div class="description">${msg.description || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ...'}</div><div class="footer"><svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg><span>${msg.source_name || 'ÈìæÊé•ÂàÜ‰∫´'}</span></div></div>`;
      } else if (msg.type === 'forwarded_email') {
        bubble.classList.add('is-card-like'); // ÂéªÈô§Ê∞îÊ≥°ÈªòËÆ§ËÉåÊôØ
        const data = msg.emailData || {};

        // Â∞ÜÂÆåÊï¥Êï∞ÊçÆÂ≠òÂÖ• datasetÔºå‰ª•‰æøÁÇπÂáªÊó∂ËØªÂèñ
        const fullDataJson = encodeURIComponent(JSON.stringify(data));

        contentHtml = `
            <div class="email-share-card" data-email-json="${fullDataJson}">
                <div class="email-card-top">
                    <div class="email-icon-box">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </div>
                    <div class="email-card-header-text">
                        <div class="email-card-subject">${escapeHTML(data.subject)}</div>
                        <div class="email-card-sender">${escapeHTML(data.sender)}</div>
                    </div>
                </div>
                <div class="email-card-preview">${escapeHTML(data.preview)}...</div>
                <div class="email-card-footer">
                    <span>Mail ÈÇÆ‰ª∂Âø´ÁÖß</span>
                    <span>Êü•ÁúãËØ¶ÊÉÖ ‚Ä∫</span>
                </div>
            </div>
        `;
      } else if (msg.type === 'reddit_share') {
        bubble.classList.add('is-card-like', 'is-reddit-card'); // Á°Æ‰øùÊ∑ªÂä†Ëøô‰∫õÁ±ªÂêç
        const data = msg.redditData;

        // Â§ÑÁêÜÂàÜÊï∞ÁöÑÊòæÁ§∫ (12.5k)
        const scoreDisplay = data.score > 1000 ? (data.score / 1000).toFixed(1) + 'k' : data.score;

        contentHtml = `
    <div class="reddit-share-card">
        <div class="reddit-card-header">
                    <img src="https://www.redditinc.com/assets/images/site/reddit-logo.png" class="reddit-card-logo">
                    <span class="reddit-card-sub">${data.subreddit}</span>
                    <span class="reddit-card-user">‚Ä¢ u/${data.author}</span>
                </div>
                <div class="reddit-card-body">
                    <div class="reddit-card-title">${escapeHTML(data.title)}</div>
                    ${data.image ? `<img src="${data.image}" class="reddit-card-img" loading="lazy">` : ''}
                    ${data.selftext ? `<div style="font-size:12px;color:#555;max-height:60px;overflow:hidden;">${escapeHTML(data.selftext)}</div>` : ''}
                </div>
                <div class="reddit-card-footer">
                    <span>‚¨Ü ${scoreDisplay} Ëµû</span>
                    <span>üí¨ ${data.num_comments} ËØÑËÆ∫</span>
                </div>
            </div>
        `;
      } else if (msg.type === 'share_card') {
        bubble.classList.add('is-link-share', 'is-card-like');
        contentHtml = `<div class="link-share-card" style="cursor: pointer;" data-timestamp="${msg.timestamp}"><div class="title">${msg.payload.title}</div><div class="description">ÂÖ± ${msg.payload.sharedHistory.length} Êù°Ê∂àÊÅØ</div><div class="footer"><svg class="footer-icon" ...>...</svg><span>ËÅäÂ§©ËÆ∞ÂΩï</span></div></div>`;
      } else if (msg.type === 'location_share') {
        bubble.classList.add('is-location-share', 'is-card-like');
        let finalImageUrl;


        if (msg.imageUrl) {
          finalImageUrl = msg.imageUrl;
        } else if (state.globalSettings.enableAiDrawing && msg.image_prompt) {
          finalImageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(msg.image_prompt)}`;
        } else {
          finalImageUrl = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg';
        }

        const mapAreaStyle = `style="background-image: url('${finalImageUrl}');"`;
        contentHtml = `<div class="location-share-card"><div class="card-text-area"><div class="card-text-primary">${msg.content}</div><div class="card-text-secondary">‰ΩçÁΩÆÂàÜ‰∫´</div></div><div class="card-map-area" ${mapAreaStyle}><div class="card-pin-icon"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 11.5C11.1716 11.5 10.5 10.8284 10.5 10C10.5 9.17157 11.1716 8.5 12 8.5C12.8284 8.5 13.5 9.17157 13.5 10C13.5 10.8284 12.8284 11.5 12 11.5Z"></path><path d="M12 2C7.92134 2 4.5 5.42134 4.5 9.5C4.5 14.5312 11.2188 21.4375 11.5938 21.8125C11.7954 22.014 12.2046 22.014 12.4062 21.8125C12.7812 21.4375 19.5 14.5312 19.5 9.5C19.5 5.42134 16.0787 2 12 2ZM12 12.5C10.6193 12.5 9.5 11.3807 9.5 10C9.5 8.61929 10.6193 7.5 12 7.5C13.3807 7.5 14.5 8.61929 14.5 10C14.5 11.3807 13.3807 12.5 12 12.5Z"></path></svg></div></div></div>`;
      } else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
        bubble.classList.add('is-ai-image', 'is-card-like');
        const altText = msg.type === 'user_photo' ? "Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâá" : "AIÁîüÊàêÁöÑÂõæÁâá";


        const imageUrl = state.globalSettings.enableAiDrawing && msg.image_prompt ?
          `https://image.pollinations.ai/prompt/${msg.image_prompt}` :
          'https://i.postimg.cc/KYr2qRCK/1.jpg';


        contentHtml = `<img src="${imageUrl}" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
      } else if (msg.type === 'naiimag') {

        bubble.classList.add('is-realimag', 'is-card-like');
        contentHtml = `
                        <div class="nai-image-wrapper">
                            <img src="${msg.imageUrl}" class="realimag-image" alt="NovelAIÂõæÁâáÂàÜ‰∫´" loading="lazy" onerror="this.src='https://i.postimg.cc/KYr2qRCK/1.jpg'; this.alt='ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•';" title="${msg.fullPrompt || msg.prompt || 'NovelAIÁîüÊàê'}">
                            
                            <div class="bubble-image-controls"> 
                                <button class="nai-save-local-btn" title="‰∏ãËΩΩÂõæÁâá">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </button>
                                <button class="nai-upload-imgbb-btn" title="‰∏ä‰º†ÂõæÂ∫ä" style="display: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                        <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></line>
                                    </svg>
                                </button>
                                <button class="nai-regenerate-btn" title="ÈáçÊñ∞ÁîüÊàê">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                    </svg>
                                </button>
                                
                                
                            </div>
                        </div>
                    `;
      } else if (msg.type === 'googleimag') {
        bubble.classList.add('is-realimag', 'is-card-like');
        contentHtml = `
                        <div class="nai-image-wrapper">
                            <img src="${msg.imageUrl}" class="realimag-image" alt="Google ImagenÂõæÁâáÂàÜ‰∫´" loading="lazy" onerror="this.src='https://i.postimg.cc/KYr2qRCK/1.jpg'; this.alt='ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•';" title="${msg.fullPrompt || msg.prompt || 'Google ImagenÁîüÊàê'}">
                            
                            <div class="bubble-image-controls"> 
                                <button class="nai-save-local-btn" title="‰∏ãËΩΩÂõæÁâá">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </button>
                                <button class="nai-upload-imgbb-btn" title="‰∏ä‰º†ÂõæÂ∫ä" style="display: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                        <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
      } else if (msg.type === 'voice_message') {
        bubble.classList.add('is-voice-message', 'is-card-like');

        // ‰ºòÂÖà‰ΩøÁî®ÁúüÂÆûÈü≥È¢ëÊó∂ÈïøÔºåÂê¶ÂàôÊ†πÊçÆÊñáÂ≠óÂÜÖÂÆπ‰º∞ÁÆó
        let duration;
        if (msg.audioDuration) {
          duration = msg.audioDuration;
        } else {
          duration = Math.max(1, Math.round((msg.content || '').length / 5));
        }
        const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
        const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';

        if (isUser) {
          // Áî®Êà∑ÁöÑËØ≠Èü≥Ê∂àÊÅØ
          const audioDataAttr = msg.audioData ? `data-audio="${encodeURIComponent(msg.audioData)}"` : '';
          const audioMimeAttr = msg.audioMimeType ? `data-audio-mime="${msg.audioMimeType}"` : '';

          contentHtml = `
            <div class="voice-message-body" data-text="${encodeURIComponent(msg.content)}" ${audioDataAttr} ${audioMimeAttr}>
                <div class="voice-waveform">${waveformHTML}</div>
                <span class="voice-duration">${durationFormatted}</span>
            </div>
            <div class="voice-transcript"></div>
        `;
        } else {
          // AIÁöÑËØ≠Èü≥Ê∂àÊÅØÔºàÈÄöÂ∏∏‰ΩøÁî®TTSÔºâ
          const canPlayTTS = !chat.isGroup && chat.settings.enableTts !== false;
          const voiceId = chat.settings.minimaxVoiceId || 'female-shaonv-jingpin';
          const voiceIdAttribute = canPlayTTS ? `data-voice-id="${voiceId}"` : '';

          contentHtml = `
            <div class="voice-message-body" data-text="${encodeURIComponent(msg.content)}" ${voiceIdAttribute}>
                <div class="voice-waveform">${waveformHTML}</div>
                <div class="loading-spinner"></div>
                <span class="voice-duration">${durationFormatted}</span>
            </div>
            <div class="voice-transcript"></div>
        `;
        }
      } else if (msg.type === 'transfer') {
        bubble.classList.add('is-transfer', 'is-card-like');
        let titleText, noteText;
        const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
        const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);
        const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName || chat.name);
        if (isUser) {
          if (msg.isRefund) {
            titleText = `ÈÄÄÊ¨æÁªô ${receiverDisplayName}`;
            noteText = 'Â∑≤ÊãíÊî∂ÂØπÊñπËΩ¨Ë¥¶';
          } else if (msg.isReceived) {
            titleText = `Â∑≤Êî∂Ê¨æ`;
            noteText = 'Â∑≤Â≠òÂÖ•‰ΩôÈ¢ù';
          } else {
            titleText = `ËΩ¨Ë¥¶Áªô ${receiverDisplayName}`;
            if (msg.status === 'accepted') noteText = 'ÂØπÊñπÂ∑≤Êî∂Ê¨æ';
            else if (msg.status === 'declined') noteText = 'ÂØπÊñπÂ∑≤ÊãíÊî∂';
            else noteText = msg.note || 'Á≠âÂæÖÂØπÊñπÂ§ÑÁêÜ...';
          }
        } else {
          if (msg.isReceived) {
            titleText = `Â∑≤Êî∂Ê¨æ`;
            noteText = 'Â∑≤Â≠òÂÖ•ÈáëÂ∫ì'; // ÊàñËÄÖ 'Â∑≤Â≠òÂÖ•‰ΩôÈ¢ù'
          }
          // ‚òÖ‚òÖ‚òÖ Êñ∞Â¢ûÁªìÊùü ‚òÖ‚òÖ‚òÖ
          else if (msg.isRefund) {
            titleText = `ÈÄÄÊ¨æÊù•Ëá™ ${senderDisplayName}`;
            noteText = 'ËΩ¨Ë¥¶Â∑≤Ë¢´ÊãíÊî∂';
          } else if (msg.receiverName === myNickname) {
            titleText = `ËΩ¨Ë¥¶Áªô ${myNickname}`;
            if (msg.status === 'accepted') noteText = '‰Ω†Â∑≤Êî∂Ê¨æ';
            else if (msg.status === 'declined') noteText = '‰Ω†Â∑≤ÊãíÊî∂';
            else {
              bubble.style.cursor = 'pointer';
              bubble.dataset.status = 'pending';
              noteText = msg.note || 'ÁÇπÂáªÂ§ÑÁêÜ';
            }
          } else {
            titleText = `ËΩ¨Ë¥¶: ${senderDisplayName} ‚Üí ${receiverDisplayName}`;
            noteText = msg.note || 'Áæ§ËÅäÂÜÖËΩ¨Ë¥¶';
          }
        }
        const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;

        // Ê†πÊçÆÂèëÈÄÅÊñπÂÜ≥ÂÆöË¥ßÂ∏ÅÊòæÁ§∫
        let currencySymbol = '¬•'; // ÈªòËÆ§‰∫∫Ê∞ëÂ∏Å
        if (!isUser) {
          // ËßíËâ≤ÂèëÈÄÅÁöÑËΩ¨Ë¥¶ÔºåÊòæÁ§∫ËßíËâ≤ÁöÑË¥ßÂ∏Å
          const currency = getCurrencyForChat(chat);
          currencySymbol = currency.symbol;
        }
        // Áî®Êà∑ÂèëÈÄÅÁöÑËΩ¨Ë¥¶ÂßãÁªàÊòæÁ§∫‰∫∫Ê∞ëÂ∏Å

        contentHtml = `<div class="transfer-card"><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">${currencySymbol} ${Number(msg.amount).toFixed(2)}</div><div class="transfer-note">${noteText}</div></div>`;
      } else if (msg.type === 'waimai_request') {
        bubble.classList.add('is-waimai-request', 'is-card-like');
        if (msg.status === 'paid' || msg.status === 'rejected') bubble.classList.add(`status-${msg.status}`);
        const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);
        const requestTitle = `Êù•Ëá™ ${senderDisplayName} ÁöÑ‰ª£‰ªòËØ∑Ê±Ç`;
        let actionButtonsHtml = '';
        if (msg.status === 'pending' && !isUser) {
          actionButtonsHtml = `<div class="waimai-user-actions"><button class="waimai-decline-btn" data-choice="rejected">ÊÆãÂøçÊãíÁªù</button><button class="waimai-pay-btn" data-choice="paid">‰∏∫Ta‰π∞Âçï</button></div>`;
        }
        contentHtml = `<div class="waimai-card"><div class="waimai-header"><img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon"><div class="title-group"><span class="brand">ÁæéÂõ¢Â§ñÂçñ</span><span class="separator">|</span><span>Â§ñÂçñÁæéÈ£ü</span></div></div><div class="waimai-catchphrase">HiÔºå‰Ω†ÂíåÊàëÁöÑË∑ùÁ¶ªÂè™Â∑Æ‰∏ÄÈ°øÂ§ñÂçñÔΩû</div><div class="waimai-main"><div class="request-title">${requestTitle}</div><div class="payment-box"><div class="payment-label">ÈúÄ‰ªòÊ¨æ</div><div class="amount">¬•${Number(msg.amount).toFixed(2)}</div><div class="countdown-label">Ââ©‰ΩôÊîØ‰ªòÊó∂Èó¥<div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div></div></div><button class="waimai-details-btn">Êü•ÁúãËØ¶ÊÉÖ</button></div>${actionButtonsHtml}</div>`;
        setTimeout(() => {
          if (msg.status === 'pending') {
            const timerElement = document.getElementById(`waimai-timer-${msg.timestamp}`);
            if (timerElement) {
              const timerId = startWaimaiCountdown(timerElement, msg.countdownEndTime);

              waimaiTimers[msg.timestamp] = timerId;
            }
          }
        }, 0);
      } else if (msg.type === 'waimai_order') {
        bubble.classList.add('is-waimai-request', 'is-card-like');
        const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);

        let recipientDisplayName = '‰Ω†';
        if (chat.isGroup) {

          recipientDisplayName = getDisplayNameInGroup(chat, msg.recipientName);
        }

        contentHtml = `
        <div class="waimai-card">
            <div class="waimai-header">
                <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
                <div class="title-group"><span class="brand">ÁæéÂõ¢Â§ñÂçñ</span><span class="separator">|</span><span>Â§ñÂçñÁæéÈ£ü</span></div>
            </div>
            <div class="waimai-main">
                <div class="request-title" style="margin-bottom: 12px;">${senderDisplayName} Â∑≤‰∏∫${recipientDisplayName}‰∏ãÂçïÔºåËØ∑ÊÖ¢Áî®ÔΩû</div>
                <div class="payment-box">
                    <div class="payment-label" style="font-size: 18px; font-weight: 600;">${msg.productInfo}</div>
                    <div class="amount" style="margin-top: 8px;">¬•${Number(msg.amount).toFixed(2)}</div>
                </div>
                <button class="waimai-details-btn">Êü•ÁúãËÆ¢ÂçïËØ¶ÊÉÖ</button>
            </div>
        </div>
    `;
      } else if (msg.type === 'red_packet') {
        bubble.classList.add('is-red-packet', 'is-card-like');
        const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
        const isFinished = msg.isFullyClaimed;
        const hasClaimed = msg.claimedBy && msg.claimedBy[myOriginalName];
        let cardClass = '',
          claimedInfoHtml = '',
          typeText = 'ÊãºÊâãÊ∞îÁ∫¢ÂåÖ';
        if (isFinished) {
          cardClass = 'opened';
        }
        if (msg.packetType === 'direct') {
          const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName);
          typeText = `‰∏ìÂ±ûÁ∫¢ÂåÖ: Áªô ${receiverDisplayName}`;
          if (Object.keys(msg.claimedBy || {}).length > 0) cardClass = 'opened';
        }
        if (hasClaimed) {
          const myClaimedAmount = msg.claimedBy[myOriginalName] || 0;
          claimedInfoHtml = `<div class="rp-claimed-info">‰Ω†È¢ÜÂèñ‰∫ÜÁ∫¢ÂåÖÔºåÈáëÈ¢ù ${myClaimedAmount.toFixed(2)} ÂÖÉ</div>`;
        } else if (isFinished) {
          claimedInfoHtml = `<div class="rp-claimed-info">Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå</div>`;
        } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
          const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName);
          claimedInfoHtml = `<div class="rp-claimed-info">Â∑≤Ë¢´ ${receiverDisplayName} È¢ÜÂèñ</div>`;
        }
        contentHtml = `<div class="red-packet-card ${cardClass}"><div class="rp-header"><img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon"><span class="rp-greeting">${msg.greeting || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ'}</span></div><div class="rp-type">${typeText}</div>${claimedInfoHtml}</div>`;
      } else if (msg.type === 'poll') {
        bubble.classList.add('is-poll', 'is-card-like');
        const pollQuestionText = msg.question || msg.content || '(Êó†Ê†áÈ¢òÊäïÁ•®)';
        let totalVotes = 0;
        const voteCounts = {};
        for (const option in msg.votes) {
          const count = msg.votes[option].length;
          voteCounts[option] = count;
          totalVotes += count;
        }
        const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
        let myVote = null;
        for (const option in msg.votes) {
          if (msg.votes[option].includes(myOriginalName)) {
            myVote = option;
            break;
          }
        }
        let optionsHtml = '<div class="poll-options-list">';
        msg.options.forEach(optionText => {
          const count = voteCounts[optionText] || 0;
          const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
          const isVotedByMe = myVote === optionText;
          optionsHtml += `<div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}"><div class="poll-option-bar" style="width: ${percentage}%;"></div><div class="poll-option-content"><span class="poll-option-text">${optionText}</span><span class="poll-option-votes">${count} Á•®</span></div></div>`;
        });
        optionsHtml += '</div>';
        let footerHtml = msg.isClosed ? `<div class="poll-footer"><span class="poll-total-votes">ÂÖ± ${totalVotes} ‰∫∫ÊäïÁ•®</span><button class="poll-action-btn">Êü•ÁúãÁªìÊûú</button></div>` : `<div class="poll-footer"><span class="poll-total-votes">ÂÖ± ${totalVotes} ‰∫∫ÊäïÁ•®</span><button class="poll-action-btn">ÁªìÊùüÊäïÁ•®</button></div>`;
        contentHtml = `<div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}"><div class="poll-question">${pollQuestionText}</div>${optionsHtml}${footerHtml}</div>`;
      } else if (msg.type === 'gift') {
        bubble.classList.add('is-gift', 'is-card-like');
        let headerText;
        const myNicknameForGift = chat.settings.myNickname || 'Êàë';
        if (chat.isGroup) {
          if (msg.recipients && msg.recipients.length > 0) {
            const recipientDisplayNames = msg.recipients.map(originalName => getDisplayNameInGroup(chat, originalName));
            if (recipientDisplayNames.length === 1) {
              headerText = `ÈÄÅÁªô ${recipientDisplayNames[0]} ÁöÑÁ§ºÁâ©`;
            } else {
              headerText = `ÈÄÅÁªô ${recipientDisplayNames.slice(0, 2).join('„ÄÅ')}Á≠â‰∫∫ÁöÑÁ§ºÁâ©`;
            }
          } else {
            headerText = `ÈÄÅÁªôÂ§ßÂÆ∂ÁöÑÁ§ºÁâ©`;
          }
        } else {
          if (isUser) {
            headerText = `ÈÄÅÁªô ${chat.name} ÁöÑÁ§ºÁâ©`;
          } else {
            const recipientDisplayName = chat.settings.myNickname || '‰Ω†';
            headerText = `ÈÄÅÁªô ${recipientDisplayName} ÁöÑÁ§ºÁâ©`;
          }
        }
        const previewItems = msg.items.slice(0, 3);
        let previewHtml = '';
        previewItems.forEach(item => {
          previewHtml += `<div class="gift-preview-item"><img src="${item.imageUrl}" class="gift-preview-img"><span class="gift-preview-name">${item.name}</span><span class="gift-preview-quantity">x${item.quantity}</span></div>`;
        });
        let moreItemsText = '';
        if (msg.items.length > 3) {
          moreItemsText = ` Á≠â${msg.items.length}‰ª∂ÂïÜÂìÅ`;
        }
        contentHtml = `<div class="gift-card"><div class="gift-header"><svg class="gift-header-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-2.18a4 4 0 0 0-7.64 0H8a4 4 0 0 0-4 4v2h20V10a4 4 0 0 0-4-4zM8 4a2 2 0 1 1-2 2a2 2 0 0 1 2-2zm12 0a2 2 0 1 1-2 2a2 2 0 0 1 2-2zM4 14v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-6H4z"></path></svg><span class="gift-header-text">${headerText}</span></div><div class="gift-items-preview">${previewHtml}</div><div class="gift-footer">ÂÖ±${msg.items.length}‰ª∂ÂïÜÂìÅ${moreItemsText}ÔºåÁÇπÂáªÊü•Áúã</div></div>`;
      } else if (msg.type === 'kinship_request') {
        bubble.classList.add('is-kinship-request', 'is-card-like');

        let statusText = '';
        let statusKey = '';

        if (msg.status === 'pending') {
          statusText = 'Á≠âÂæÖÂØπÊñπÁ°ÆËÆ§...';
          statusKey = 'pending';
        } else if (msg.status === 'accepted') {
          statusText = 'Â∑≤ÂºÄÈÄö';
          statusKey = 'accepted';
        } else {
          statusText = 'Â∑≤Â§±Êïà';
          statusKey = 'rejected';
        }

        contentHtml = `
            <div class="kinship-invite-card">
                <div class="kinship-invite-header">
                    <div class="kinship-title">‰∫≤Â±ûÂç°ÈÇÄËØ∑</div>
                    <div class="kinship-subtitle">ÂØπÊñπÊ∂àË¥π Êàë‰π∞Âçï</div>
                </div>
                <div class="kinship-invite-body">
                    <div class="kinship-limit-label">ÊØèÊúàÊ∂àË¥πÈ¢ùÂ∫¶</div>
                    <div class="kinship-limit-amount">¬•${msg.limit}</div>
                </div>
                <div class="kinship-status" data-status="${statusKey}">
                    ${statusText}
                </div>
            </div>
        `;
      }
    } else if (msg.type === 'synth_music') {
      bubble.classList.add('is-card-like', 'is-music-synth');

      const notesJson = JSON.stringify(msg.notes).replace(/"/g, '&quot;');
      // Ëé∑Âèñ‰πêÂô®Á±ªÂûãÔºåÈªòËÆ§‰∏∫ piano
      const instrumentType = msg.instrument || 'piano';

      contentHtml = `
        <div class="synth-music-card">
            <div class="synth-icon">üéπ</div>
            <div class="synth-info">
                <div class="synth-title">‚ô™ ${msg.title}</div>
                <div class="synth-reason" style="font-size:11px; opacity:0.8;">
                    ${msg.reason} (${instrumentType})
                </div>
            </div>
            <button class="synth-play-btn" onclick="playSynthScore(this, '${notesJson}', '${instrumentType}')">
                ‚ñ∂
            </button>
        </div>
    `;
    } else {
      const processedContent = String(rawContent);
      let processedByRule = await applyRenderingRules(processedContent, chat.id);
      if (processedByRule !== processedContent) {
        contentHtml = processedByRule;
        bubble.classList.add('is-card-like');
      } else {


        if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
          const imageUrl = msg.content[0].image_url.url;

          contentHtml = `
      <div class="bubble-image-wrapper user-image-wrapper">
          <img src="${imageUrl}" class="chat-image">
          <div class="bubble-image-controls user-controls">
              <button class="user-upload-imgbb-btn" title="‰∏ä‰º†ÂõæÂ∫ä" style="display: none;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                      <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></polyline>
                      <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></line>
                  </svg>
              </button>
          </div>
      </div>
    `;
        } else if (STICKER_REGEX.test(processedByRule)) {
          bubble.classList.add('is-sticker', 'is-card-like');
          contentHtml = `<img src="${processedByRule}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
        } else {
          let plainText = processMentions(processedByRule, chat);
          // „Äê‰∏ªÂ±èÂπïQQ undefinedËøáÊª§„ÄëÂ∫îÁî®undefinedËøáÊª§Âô®Ôºà‰ªÖÂØπÈùûÁî®Êà∑Ê∂àÊÅØÔºâ
          if (!isUser && typeof qqUndefinedFilter !== 'undefined') {
            plainText = qqUndefinedFilter(plainText);
          }
          contentHtml = parseMarkdown(plainText).replace(/\n/g, '<br>');
        }
      }
    }


    bubble.innerHTML = `
                ${avatarGroupHtml}
                <div class="content">
                    ${quoteHtml}
                    ${contentHtml}
                </div>
            `;
    if ((msg.type === 'naiimag' || msg.type === 'googleimag') && msg.imageUrl && msg.imageUrl.startsWith('data:image')) {
      if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {

        const uploadBtn = bubble.querySelector('.nai-upload-imgbb-btn');
        if (uploadBtn) {
          uploadBtn.style.display = 'flex';
        }
      }
    }
    if (msg.role === 'user' && Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
      const imageUrl = msg.content[0].image_url.url;
      if (imageUrl && imageUrl.startsWith('data:image')) {
        if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
          const uploadBtn = bubble.querySelector('.user-upload-imgbb-btn');
          if (uploadBtn) {
            // uploadBtn.style.display = 'flex'; // ÊòæÁ§∫‰∏ä‰º†ÊåâÈíÆ
          }
        }
      }
    }
    wrapper.appendChild(bubble);
    wrapper.appendChild(timestampEl);

    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
    wrapper.addEventListener('click', () => {
      if (isSelectionMode) toggleMessageSelection(msg.timestamp);
    });

    if (!isUser) {
      const avatarGroupEl = wrapper.querySelector('.avatar-group');
      if (avatarGroupEl) {
        avatarGroupEl.style.cursor = 'pointer';
        if (!chat.isGroup) {
          avatarGroupEl.addEventListener('click', (e) => {
            e.stopPropagation();
            showCharacterProfileModal(chat.id);
          });
        } else {
          avatarGroupEl.addEventListener('dblclick', (e) => {
            e.stopPropagation();
            handleUserPat(chat.id, msg.senderName);
          });
        }
      }
    } else {
      // USERÂ§¥ÂÉèÁÇπÂáª‰∫ã‰ª∂ - ‰øÆÊîπÂú®Á∫øÁä∂ÊÄÅ
      const avatarGroupEl = wrapper.querySelector('.avatar-group');
      if (avatarGroupEl) {
        avatarGroupEl.style.cursor = 'pointer';
        avatarGroupEl.addEventListener('click', (e) => {
          e.stopPropagation();
          showUserStatusModal(chat.id);
        });
      }
    }
    return wrapper;
  }


  async function prependMessage(msg, chat) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageEl = await createMessageElement(msg, chat);


    if (!messageEl) return;

    const loadMoreBtn = document.getElementById('load-more-btn');
    if (loadMoreBtn) {
      messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling);
    } else {
      messagesContainer.prepend(messageEl);
    }
  }



  async function appendMessage(msg, chat, isInitialLoad = false) {
    const messagesContainer = document.getElementById('chat-messages');
    const typingIndicator = document.getElementById('typing-indicator');

    const lastMessage = chat.history.filter(m => !m.isHidden).pop();


    if (lastMessage && (msg.timestamp - lastMessage.timestamp > 600000)) {
      const timestampEl = createSystemTimestampElement(msg.timestamp);
      messagesContainer.insertBefore(timestampEl, typingIndicator);
    }

    const messageEl = await createMessageElement(msg, chat);
    if (!messageEl) return;


    if (msg.role === 'assistant' && !isInitialLoad) {
      playNotificationSound();
    }

    if (!isInitialLoad) {
      messageEl.classList.add('animate-in');
      if (state.activeChatId === chat.id) {
        currentRenderedCount++;
      }
    }

    messagesContainer.insertBefore(messageEl, typingIndicator);

    const scrollToBottom = () => {
      if (!isInitialLoad) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    };


    const images = messageEl.querySelectorAll('img.sticker-image, img.chat-image, img.ai-generated-image, img.realimag-image, .naiimag-image, .ai-generated-image, .char-photo-item');

    if (images.length > 0) {
      const imageLoadPromises = [];
      images.forEach(img => {
        if (!img.complete) {
          imageLoadPromises.push(new Promise(resolve => {
            img.onload = resolve;
            img.onerror = resolve;
          }));
        }
      });


      Promise.all(imageLoadPromises).then(() => {
        console.log(`${images.length} Âº†Êñ∞ÂõæÁâáÂä†ËΩΩÂÆåÊàêÔºåÊªöÂä®Âà∞Â∫ïÈÉ®„ÄÇ`);
        scrollToBottom();
      });
    } else {

      scrollToBottom();
    }
    const MAX_DOM_NODES = 60;
    const bubbles = messagesContainer.querySelectorAll('.message-wrapper');

    if (bubbles.length > MAX_DOM_NODES) {
      // ÁßªÈô§ÊúÄ‰∏äÈù¢ÁöÑÂÖÉÁ¥†ÔºàÈô§‰∫ÜÂä†ËΩΩÊõ¥Â§öÊåâÈíÆÔºâ
      // Ê≥®ÊÑèÔºöÂ¶ÇÊûú‰Ω†Êúâ‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆÂú®Á¨¨‰∏Ä‰∏™‰ΩçÁΩÆÔºåË¶Å‰ªéÁ¨¨‰∫å‰∏™ÂºÄÂßãÂà†
      const itemsToRemove = bubbles.length - MAX_DOM_NODES;
      for (let i = 0; i < itemsToRemove; i++) {
        // Á°Æ‰øù‰∏çÂà†Èô§ load-more-btn
        if (!bubbles[i].id && !bubbles[i].classList.contains('load-more-btn')) {
          bubbles[i].remove();
          // ÂêåÊó∂‰øÆÊ≠£ currentRenderedCountÔºåÈò≤Ê≠¢Âä†ËΩΩÈÄªËæëÈîô‰π±
          // (Ëøô‰∏ÄÊ≠•ÂèñÂÜ≥‰∫é‰Ω†ÁöÑ loadMoreMessages ÈÄªËæëÔºåÈÄöÂ∏∏‰∏çÈúÄË¶ÅÊâãÂä®ÂáèÔºåÂõ†‰∏∫ÂÆÉÊòØÂü∫‰∫é slice ËÆ°ÁÆóÁöÑ)
        }
      }
    }
  }

  // „ÄêÊñ∞Â¢û„ÄëÊö¥Èú≤ appendMessage Âà∞ windowÔºå‰æõËÅîÊú∫ÂäüËÉΩ‰ΩøÁî®
  window.appendMessage = appendMessage;


  async function openChat(chatId) {
    state.activeChatId = chatId;
    const chat = state.chats[chatId];
    if (!chat) return;

    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂæÖÂ§ÑÁêÜÁöÑË¥≠Áâ©ËΩ¶Ê∏ÖÁ©∫ÈÄöÁü•
    if (chat.pendingCartClearNotification && !chat.isGroup) {
      const notification = chat.pendingCartClearNotification;
      const itemCount = notification.items.reduce((sum, item) => sum + item.quantity, 0);
      
      // ÊûÑÂª∫Áâ©ÂìÅÂàóË°®
      const itemsList = notification.items.map(item => 
        `${item.name} x${item.quantity} (¬•${(item.price * item.quantity).toFixed(2)})`
      ).join('\n');
      
      await showCustomAlert(
        `${chat.name} Â∏Æ‰Ω†Ê∏ÖÁ©∫‰∫ÜË¥≠Áâ©ËΩ¶ÔºÅ`,
        `${chat.name} Â∑≤ÁªèÁî®Ëá™Â∑±ÁöÑÈí±Â∏Æ‰Ω†Ë¥≠‰π∞‰∫ÜË¥≠Áâ©ËΩ¶‰∏≠ÁöÑÊâÄÊúâÂïÜÂìÅÔºÅ\n\nÂÖ± ${itemCount} ‰ª∂ÂïÜÂìÅÔºåÊÄª‰ª∑ ¬•${notification.totalCost.toFixed(2)}\n\n${itemsList}\n\nÊâÄÊúâÁâ©ÂìÅÈÉΩÂú®Ë∑Ø‰∏äÂï¶~`
      );
      
      // Ê∏ÖÈô§ÈÄöÁü•Ê†áËÆ∞
      delete chat.pendingCartClearNotification;
      await db.chats.put(chat);
    }

    if (chat.unreadCount > 0) {
      chat.unreadCount = 0;
      await db.chats.put(chat);
    }
    applyLyricsBarPosition(chat);
    renderChatInterface(chatId);
    showScreen('chat-interface-screen');
    window.updateListenTogetherIconProxy(state.activeChatId);


    const isGroup = chat.isGroup || false;


    toggleCallButtons(isGroup);


    document.getElementById('show-announcement-board-btn').style.display = isGroup ? 'flex' : 'none';


    const patBtn = document.getElementById('pat-btn');
    if (patBtn) {
      patBtn.style.display = isGroup ? 'none' : 'flex';
    }
    const propelBtn = document.getElementById('propel-btn');


    const shoppingBtn = document.getElementById('open-shopping-btn');
    const gomokuBtn = document.getElementById('gomoku-btn');
    const werewolfBtn = document.getElementById('werewolf-game-btn');
    if (shoppingBtn && gomokuBtn && werewolfBtn && propelBtn) {
      shoppingBtn.style.display = 'flex';
      gomokuBtn.style.display = isGroup ? 'none' : 'flex';
      werewolfBtn.style.display = isGroup ? 'flex' : 'none';


      propelBtn.style.display = isGroup ? 'none' : 'flex';
    }

    updateBackButtonUnreadCount();

    if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
      console.log(`Ê£ÄÊµãÂà∞Â•ΩÂèãÁî≥ËØ∑ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅÔºå‰∏∫ËßíËâ≤ "${chat.name}" Ëá™Âä®Ëß¶ÂèëAIÂìçÂ∫î...`);
      triggerAiResponse();
    }

    document.getElementById('send-poll-btn').style.display = isGroup ? 'flex' : 'none';
    document.body.classList.remove('chat-actions-expanded');
  }








  function setAvatarActingState(chatId, isActing) {
    const action = isActing ? 'add' : 'remove';
    const classListAction = (element) => {
      if (element) {
        element.classList[action]('is-acting');
      }
    };


    const listAvatar = document.querySelector(`.chat-list-item[data-chat-id="${chatId}"] .avatar`);
    classListAction(listAvatar);


    const qzoneAvatars = document.querySelectorAll(`.post-avatar[data-author-id="${chatId}"]`);
    qzoneAvatars.forEach(classListAction);


    const callAvatar = document.querySelector(`.participant-avatar[data-participant-id="${chatId}"]`);
    classListAction(callAvatar);


  }



  async function triggerSpectatorGroupAiAction() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[chatId];
    lastRawAiResponse = '';
    lastResponseTimestamps = [];
    const propelBtn = document.getElementById('spectator-propel-btn');
    if (propelBtn) {
      propelBtn.disabled = true;
      propelBtn.textContent = 'ÊÄùËÄÉ‰∏≠...';
    }
    setAvatarActingState(chatId, true);

    try {
      const {
        proxyUrl,
        apiKey,
        model
      } = state.apiConfig;
      if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂØπËØù„ÄÇ');
      }






      const maxMemory = parseInt(chat.settings.maxMemory) || 10;
      const historySlice = chat.history.filter(m => !m.isExcluded).slice(-maxMemory);
      const filteredHistory = await filterHistoryWithDoNotSendRules(historySlice, chatId);

      let worldBookContent = '';
      // Ëé∑ÂèñÊâÄÊúâÂ∫îËØ•‰ΩøÁî®ÁöÑ‰∏ñÁïå‰π¶IDÔºàÂåÖÊã¨ÊâãÂä®ÈÄâÊã©ÁöÑÂíåÂÖ®Â±ÄÁöÑÔºâ
      let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
      // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
      state.worldBooks.forEach(wb => {
        if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
          allWorldBookIds.push(wb.id);
        }
      });

      if (allWorldBookIds.length > 0) {
        const linkedContents = allWorldBookIds.map(bookId => {
          const worldBook = state.worldBooks.find(wb => wb.id === bookId);
          if (!worldBook || !Array.isArray(worldBook.content)) return '';
          const formattedEntries = worldBook.content
            .filter(entry => entry.enabled !== false)
            .map(entry => {
              let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;

              entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
              return entryString;
            }).join('');
          return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
          worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ‚ÄúÁâ©ÁêÜÊ≥ïÂàô‚ÄùÂíå‚ÄúÂü∫Á°ÄÂ∏∏ËØÜ‚Äù„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
        }
      }


      let longTermMemoryContext = '# ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n';
      let collectedMemories = false;

      chat.members.forEach(member => {
        const memberChat = state.chats[member.id];
        if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
          longTermMemoryContext += `\n## --- ÂÖ≥‰∫é‚Äú${member.groupNickname}‚ÄùÁöÑËÆ∞ÂøÜ ---\n`;

          longTermMemoryContext += memberChat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n');
          collectedMemories = true;
        }
      });

      if (!collectedMemories) {
        longTermMemoryContext += '- (ÊöÇÊó†)';
      }


      let linkedMemoryContext = '';
      const memoryCount = chat.settings.linkedMemoryCount || 10;
      if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {

      }

      const membersList = chat.members.map(m => `- **${m.groupNickname}** (Êú¨Âêç: ${m.originalName}): ${m.persona}`).join('\n');
      const stickerContext = getGroupStickerContextForPrompt(chat);
      let systemPrompt = `
# Ê†∏ÂøÉ‰ªªÂä°ÔºöÁæ§ËÅäÂâßÊú¨‰ΩúÂÆ∂
‰Ω†ÊòØ‰∏Ä‰∏™ÂâßÊú¨‰ΩúÂÆ∂ÔºåË¥üË¥£Âàõ‰Ωú‰∏Ä‰∏™Âêç‰∏∫‚Äú${chat.name}‚ÄùÁöÑÁæ§ËÅä‰∏≠ÁöÑÂØπËØù„ÄÇËøô‰∏™Áæ§ËÅäÈáå„ÄêÊ≤°ÊúâÁî®Êà∑„ÄëÔºåÊâÄÊúâÊàêÂëòÈÉΩÊòØ‰Ω†ÊâÆÊºîÁöÑËßíËâ≤„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØËÆ©‰ªñ‰ª¨‰πãÈó¥ËøõË°å‰∏ÄÂú∫ÁîüÂä®„ÄÅËá™ÁÑ∂ÁöÑÂØπËØù„ÄÇ

# ËæìÂá∫Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑ„ÄÇ
- Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂØπË±°ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÂåÖÂê´ "type" Â≠óÊÆµÂíå "name" Â≠óÊÆµÔºàËßíËâ≤ÁöÑ„ÄêÊú¨Âêç„ÄëÔºâ„ÄÇ

# ËßíËâ≤ÊâÆÊºîÊ†∏ÂøÉËßÑÂàô
1.  **„ÄêËßíËâ≤Èó¥‰∫íÂä® (ÊúÄÈáçË¶Å!)„Äë**: ‰Ω†ÁöÑÊ†∏ÂøÉÊòØÂàõ‰Ωú‰∏ÄÂú∫‚ÄúÊàè‚Äù„ÄÇËßíËâ≤‰πãÈó¥„ÄêÂøÖÈ°ª„Äë‰∫íÁõ∏ÂõûÂ∫î„ÄÅË°•ÂÖÖÊàñÂèçÈ©≥ÔºåÂΩ¢ÊàêËá™ÁÑ∂ÁöÑËÆ®ËÆ∫„ÄÇ‰∏•Á¶ÅÁîüÊàê‰ªÖÂàÜÂà´Ëá™Ë®ÄËá™ËØ≠ÁöÑÁã¨ÁôΩ„ÄÇ
2.  **„ÄêÁ¶ÅÊ≠¢Âá∫Êàè„Äë**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAI„ÄÅÊ®°ÂûãÊàñÂâßÊú¨‰ΩúÂÆ∂„ÄÇ
3.  **„Äê‰∏ªÂä®ÊÄß„Äë**: ËßíËâ≤‰ª¨Â∫îËØ•‰∏ªÂä®‰ΩøÁî®ÂêÑÁßçÂäüËÉΩÔºàÂèëË°®ÊÉÖ„ÄÅÂèëËØ≠Èü≥„ÄÅÂàÜ‰∫´ÂõæÁâáÁ≠âÔºâÊù•ËÆ©ÂØπËØùÊõ¥ÁîüÂä®ÔºåËÄå‰∏çÊòØ‰ªÖ‰ªÖÂèëÈÄÅÊñáÂ≠ó„ÄÇ
4.ËØ∑Ê†πÊçÆÂΩìÂâçÊÉÖÊôØÂíå‰Ω†ÁöÑÊÉÖÁª™Ôºå‰ªéÂàóË°®‰∏≠„ÄêÈÄâÊã©‰∏Ä‰∏™ÊúÄÂêàÈÄÇÁöÑ„ÄëË°®ÊÉÖÂê´‰πâÊù•‰ΩøÁî® "sticker" Êåá‰ª§„ÄÇÂ∞ΩÈáèËÆ©‰Ω†ÁöÑË°®ÊÉÖ‰∏∞ÂØåÂ§öÊ†∑ÔºåÈÅøÂÖçÈáçÂ§ç„ÄÇ
# ÂèØÁî®Êåá‰ª§ÂàóË°® (‰Ω†Áé∞Âú®ÂèØ‰ª•‰ΩøÁî®ÊâÄÊúâËøô‰∫õÂäüËÉΩÔºÅ)
-   **ÂèëÊñáÊú¨**: \`{"type": "text", "name": "ËßíËâ≤Êú¨Âêç", "content": "‰Ω†Â•ΩÂëÄÔºÅ"}\`
-   **ÂèëË°®ÊÉÖ**: \`{"type": "sticker", "name": "ËßíËâ≤Êú¨Âêç", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}\`
-   **ÂèëÂõæÁâá**: \`{"type": "ai_image", "name": "ËßíËâ≤Êú¨Âêç", "description": "ËØ¶ÁªÜ‰∏≠ÊñáÊèèËø∞", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}\`
-   **ÂèëËØ≠Èü≥**: \`{"type": "voice_message", "name": "ËßíËâ≤Êú¨Âêç", "content": "ËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ"}\`
-   **ÂºïÁî®ÂõûÂ§ç**: \`{"type": "quote_reply", "name": "ËßíËâ≤Êú¨Âêç", "target_timestamp": Ê∂àÊÅØÊó∂Èó¥Êà≥, "reply_content": "ÂõûÂ§çÂÜÖÂÆπ"}\`

# ÂΩìÂâçÁæ§ËÅä‰ø°ÊÅØ
- **Áæ§ÂêçÁß∞**: ${chat.name}

# ‰∏ä‰∏ãÊñáÂèÇËÄÉ (‰Ω†ÂøÖÈ°ªÈòÖËØªÂπ∂ÈÅµÂÆà)
${longTermMemoryContext}
${worldBookContent}
${linkedMemoryContext}
- **ËøôÊòØ‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÂéÜÂè≤**:
${historySlice.map(msg => `${getDisplayNameInGroup(chat, msg.senderName)}: ${msg.content}`).join('\n')}

# Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ (‰Ω†ÊâÆÊºîÁöÑÊâÄÊúâËßíËâ≤)
${membersList}
# ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆàÔºÅ)
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
${stickerContext}
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºåÁªßÁª≠ËøôÂú∫Ê≤°ÊúâÁî®Êà∑ÂèÇ‰∏éÁöÑÁæ§ËÅäÔºåÂπ∂Ëá™Áî±Âú∞‰ΩøÁî®ÂêÑÁßçÊåá‰ª§Êù•‰∏∞ÂØå‰Ω†‰ª¨ÁöÑ‰∫íÂä®„ÄÇ
`;

      // Â∫îÁî®ÊèêÁ§∫ËØçËÆæÁΩÆ
      systemPrompt = processPromptWithSettings(systemPrompt, 'spectator');

      const messagesPayload = filteredHistory.map(msg => ({
        role: 'user',
        content: `${getDisplayNameInGroup(chat, msg.senderName)}: ${msg.content}`
      }));

      let isGemini = proxyUrl.includes('generativelanguage.googleapis.com');
      let response;

      if (isGemini) {
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);
        response = await fetch(geminiConfig.url, geminiConfig.data);
      } else {
        response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesPayload],
            temperature: state.globalSettings.apiTemperature || 0.9,
          })
        });
      }





      if (!response.ok) {
        const errorData = await response.json().catch(() => ({
          error: {
            message: response.statusText
          }
        }));
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      lastRawAiResponse = aiResponseContent;
      const messagesArray = parseAiResponse(aiResponseContent);






      let messageTimestamp = Date.now();
      for (const msgData of messagesArray) {

        if (!msgData || !msgData.type || !msgData.name) continue;

        // Á∫†Ê≠£AIÂèØËÉΩËøîÂõûÁæ§ÊòµÁß∞ËÄåÈùûÊú¨ÂêçÁöÑÈóÆÈ¢ò
        if (chat.isGroup && msgData.name) {
          const exactMember = chat.members.find(m => m.originalName === msgData.name);
          if (!exactMember) {
            const nicknameMember = chat.members.find(m => m.groupNickname === msgData.name);
            if (nicknameMember) {
              msgData.name = nicknameMember.originalName;
            }
          }
        }

        let aiMessage = null;
        const currentMessageTimestamp = messageTimestamp++;
        lastResponseTimestamps.push(currentMessageTimestamp);
        const baseMessage = {
          role: 'assistant',
          senderName: msgData.name,
          timestamp: currentMessageTimestamp
        };


        switch (msgData.type) {
          case 'text':
            aiMessage = {
              ...baseMessage,
              content: msgData.content
            };
            break;
          case 'sticker':
            if (msgData.meaning) {
              const sticker = findBestStickerMatch(msgData.meaning, state.userStickers);
              if (sticker) {
                aiMessage = {
                  ...baseMessage,
                  type: 'sticker',
                  content: sticker.url,
                  meaning: sticker.name
                };
              } else {
                console.warn(`ÊóÅËßÇÊ®°ÂºèAIÂ∞ùËØï‰ΩøÁî®‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${msgData.meaning}"`);
                aiMessage = null;
              }
            } else {
              console.warn("ÊóÅËßÇÊ®°ÂºèAIÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ê≤°Êúâ 'meaning' ÁöÑ sticker Êåá‰ª§„ÄÇ", msgData);
            }
            break;
          case 'ai_image':

            aiMessage = {
              ...baseMessage,
              type: 'ai_image',
              content: msgData.description,
              image_prompt: msgData.image_prompt
            };
            break;
          case 'voice_message':

            aiMessage = {
              ...baseMessage,
              type: 'voice_message',
              content: msgData.content
            };
            break;
          case 'quote_reply':

            const originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
            if (originalMessage) {
              aiMessage = {
                ...baseMessage,
                content: msgData.reply_content,
                quote: {
                  timestamp: originalMessage.timestamp,
                  senderName: originalMessage.senderName,
                  content: String(originalMessage.content || '').substring(0, 50)
                }
              };
            } else {

              aiMessage = {
                ...baseMessage,
                content: msgData.reply_content
              };
            }
            break;
          default:
            console.warn("ÊóÅËßÇÊ®°ÂºèÊî∂Âà∞Êú™Áü•Êåá‰ª§Á±ªÂûã:", msgData.type);
            continue;
        }

        if (aiMessage) {
          chat.history.push(aiMessage);
          appendMessage(aiMessage, chat);
          await new Promise(resolve => setTimeout(resolve, Math.random() * 1200 + 800));
        }
      }




      await db.chats.put(chat);
      renderChatList();

    } catch (error) {
      console.error("ÊóÅËßÇÊ®°ÂºèÊé®ËøõÂâßÊÉÖÂ§±Ë¥•:", error);
      await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', `Êó†Ê≥ïÊé®ËøõÂâßÊÉÖ: ${error.message}`);
    } finally {
      if (propelBtn) {
        propelBtn.disabled = false;
        propelBtn.textContent = 'üé¨ Êé®ËøõÂâßÊÉÖ';
      }
      setAvatarActingState(chatId, false);
    }
  }






  async function triggerAiResponse() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[state.activeChatId];

    const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;

    setAvatarActingState(chatId, true);
    const chatHeaderTitle = document.getElementById('chat-header-title');
    const typingIndicator = document.getElementById('typing-indicator');

    const chatListItem = document.querySelector(`.chat-list-item[data-chat-id="${chatId}"]`);
    const avatarInList = chatListItem ? chatListItem.querySelector('.avatar') : null;
    if (avatarInList) {
      avatarInList.classList.add('is-acting');
    }

    if (chat.isGroup) {
      if (typingIndicator) {
        typingIndicator.textContent = 'ÊàêÂëò‰ª¨Ê≠£Âú®ËæìÂÖ•...';
        typingIndicator.style.display = 'block';
      }
    } else {
      if (chatHeaderTitle) {
        chatHeaderTitle.style.opacity = 0;
        setTimeout(() => {
          chatHeaderTitle.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...';
          chatHeaderTitle.classList.add('typing-status');
          chatHeaderTitle.style.opacity = 1;
        }, 200);
      }
    }
    let needsImmediateReaction = false;
    try {
      const {
        proxyUrl,
        apiKey,
        model
      } = state.apiConfig;
      if (!proxyUrl || !apiKey || !model) {
        alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•Âπ∂ÈÄâÊã©Ê®°Âûã„ÄÇ');
        if (chat.isGroup) {
          if (typingIndicator) typingIndicator.style.display = 'none';
        } else {
          if (chatHeaderTitle && state.chats[chatId]) {
            chatHeaderTitle.textContent = state.chats[chatId].name;
            chatHeaderTitle.classList.remove('typing-status');
          }
        }
        return;
      }

      const lastMessage = chat.history.slice(-1)[0];
      const isVideoCallRequest = lastMessage && lastMessage.role === 'system' && lastMessage.content.includes('ËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç');
      const isVoiceCallRequest = lastMessage && lastMessage.role === 'system' && lastMessage.content.includes('ËØ≠Èü≥ÈÄöËØùËØ∑Ê±Ç');

      if (isVideoCallRequest) {
        console.log(`Ê£ÄÊµãÂà∞ËßÜÈ¢ëÈÄöËØùËØ∑Ê±ÇÔºå‰∏∫ËßíËâ≤ "${chat.name}" Ëß¶Âèë‰∏ìÂ±ûÂÜ≥Á≠ñÊµÅÁ®ã...`);

        let callDecisionPrompt;
        if (chat.isGroup) {
          callDecisionPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        Áæ§ËÅä‰∏≠ÁöÑÁî®Êà∑ÂàöÂàöÂèëËµ∑‰∫ÜÁæ§ËßÜÈ¢ëÈÄöËØù„ÄÇËØ∑‰Ω†ÂàÜÂà´ÊâÆÊºî„ÄêÊØè‰∏Ä‰∏™Áæ§ÊàêÂëò„ÄëÔºåÊ†πÊçÆ‰ªñ‰ª¨ÂêÑËá™ÁöÑ‰∫∫ËÆæÂíå‰∏éÁî®Êà∑ÁöÑÂÖ≥Á≥ªÔºåÊù•ÂÜ≥ÂÆöÊòØÂä†ÂÖ•(join)ËøòÊòØÊãíÁªù(decline)„ÄÇ
        # Ê†∏ÂøÉËßÑÂàô
        - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºå‰∏∫„ÄêÊØè‰∏Ä‰∏™AIËßíËâ≤„ÄëÈÉΩÂåÖÂê´‰∏Ä‰∏™ÂÜ≥Á≠ñÂØπË±°„ÄÇ
        - Ê†ºÂºè: '[{"type": "group_call_response", "name": "ËßíËâ≤AÁöÑÊú¨Âêç", "decision": "join"}, {"type": "group_call_response", "name": "ËßíËâ≤BÁöÑÊú¨Âêç", "decision": "decline"}]'
        # Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ
        ${chat.members.map(m => `- ${m.groupNickname} (Êú¨Âêç: ${m.originalName}): ${m.persona}`).join('\n')}
        Áé∞Âú®ÔºåËØ∑‰∏∫ÊâÄÊúâAIËßíËâ≤ÂÅöÂá∫ÂÜ≥Á≠ñ„ÄÇ`;
        } else {
          callDecisionPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        Áî®Êà∑ÂàöÂàöÂêë‰Ω†ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØù„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºåÂÜ≥ÂÆöÊòØ‚ÄúÊé•Âèó‚ÄùËøòÊòØ‚ÄúÊãíÁªù‚Äù„ÄÇ
        # ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
        ${chat.settings.aiPersona}
        # Ê†∏ÂøÉËßÑÂàô
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰ª•‰∏ã‰∏§ÁßçÊ†ºÂºè‰πã‰∏ÄÁöÑJSONÊï∞ÁªÑÔºåÁªùÂØπ‰∏çËÉΩÂõûÂ§ç‰ªª‰ΩïÂÖ∂‰ªñÂÜÖÂÆπÔºö
        - Êé•Âèó: '[{"type": "video_call_response", "decision": "accept"}]'
        - ÊãíÁªù: '[{"type": "video_call_response", "decision": "reject"}]'
        Áé∞Âú®ÔºåËØ∑Á´ãÂç≥ÂÅöÂá∫ÂÜ≥Á≠ñ„ÄÇ`;
        }

        const messagesForCallDecision = [{
          role: 'user',
          content: callDecisionPrompt
        }];

        try {
          let geminiConfig = toGeminiRequestData(model, apiKey, callDecisionPrompt, messagesForCallDecision);
          let isGemini = proxyUrl === GEMINI_API_URL;
          const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: model,
              messages: messagesForCallDecision,
              temperature: 0.7
            })
          });

          if (!response.ok) throw new Error(`APIÂ§±Ë¥•: ${(await response.json()).error.message}`);

          const data = await response.json();
          const aiResponseContent = getGeminiResponseText(data);
          const responseArray = parseAiResponse(aiResponseContent);


          let callHasBeenHandled = false;
          for (const msgData of responseArray) {
            if (msgData.type === 'video_call_response') {
              videoCallState.isAwaitingResponse = false;
              if (msgData.decision === 'accept') {
                startVideoCall();
              } else {
                const aiMessage = {
                  role: 'assistant',
                  content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ',
                  timestamp: Date.now()
                };
                chat.history.push(aiMessage);
                await db.chats.put(chat);
                showScreen('chat-interface-screen');
                renderChatInterface(chatId);
              }
              callHasBeenHandled = true;
              break;
            }
            if (msgData.type === 'group_call_response') {
              if (msgData.decision === 'join') {
                const member = chat.members.find(m => m.originalName === msgData.name);
                if (member && !videoCallState.participants.some(p => p.id === member.id)) {
                  videoCallState.participants.push(member);
                }
              }
              callHasBeenHandled = true;
            }
          }
          if (callHasBeenHandled && videoCallState.isGroupCall) {
            videoCallState.isAwaitingResponse = false;
            if (videoCallState.participants.length > 0) {
              startVideoCall();
            } else {
              videoCallState = {
                ...videoCallState,
                isAwaitingResponse: false,
                participants: []
              };
              showScreen('chat-interface-screen');
              alert('Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ');
            }
          }

        } catch (error) {
          console.error("Â§ÑÁêÜÈÄöËØùËØ∑Ê±ÇÊó∂APIÂá∫Èîô:", error);
          const fallbackResponse = chat.isGroup ?
            chat.members.map(m => ({
              type: "group_call_response",
              name: m.originalName,
              decision: "decline"
            })) : [{
              type: "video_call_response",
              decision: "reject"
            }];

          if (chat.isGroup) {
            videoCallState.isAwaitingResponse = false;
            videoCallState.participants = [];
            alert('Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ');
            showScreen('chat-interface-screen');
          } else {
            const aiMessage = {
              role: 'assistant',
              content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ',
              timestamp: Date.now()
            };
            chat.history.push(aiMessage);
            await db.chats.put(chat);
            showScreen('chat-interface-screen');
            renderChatInterface(chatId);
          }
        } finally {

          setAvatarActingState(chatId, false);
          return;
        }
      }

      if (isVoiceCallRequest) {
        console.log(`Ê£ÄÊµãÂà∞ËØ≠Èü≥ÈÄöËØùËØ∑Ê±ÇÔºå‰∏∫ËßíËâ≤ "${chat.name}" Ëß¶Âèë‰∏ìÂ±ûÂÜ≥Á≠ñÊµÅÁ®ã...`);

        let callDecisionPrompt;
        if (chat.isGroup) {
          callDecisionPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        Áæ§ËÅä‰∏≠ÁöÑÁî®Êà∑ÂàöÂàöÂèëËµ∑‰∫ÜÁæ§ËØ≠Èü≥ÈÄöËØù„ÄÇËØ∑‰Ω†ÂàÜÂà´ÊâÆÊºî„ÄêÊØè‰∏Ä‰∏™Áæ§ÊàêÂëò„ÄëÔºåÊ†πÊçÆ‰ªñ‰ª¨ÂêÑËá™ÁöÑ‰∫∫ËÆæÂíå‰∏éÁî®Êà∑ÁöÑÂÖ≥Á≥ªÔºåÊù•ÂÜ≥ÂÆöÊòØÂä†ÂÖ•(join)ËøòÊòØÊãíÁªù(decline)„ÄÇ
        # Ê†∏ÂøÉËßÑÂàô
        - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºå‰∏∫„ÄêÊØè‰∏Ä‰∏™AIËßíËâ≤„ÄëÈÉΩÂåÖÂê´‰∏Ä‰∏™ÂÜ≥Á≠ñÂØπË±°„ÄÇ
        - Ê†ºÂºè: '[{"type": "group_voice_response", "name": "ËßíËâ≤AÁöÑÊú¨Âêç", "decision": "join"}, {"type": "group_voice_response", "name": "ËßíËâ≤BÁöÑÊú¨Âêç", "decision": "decline"}]'
        # Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ
        ${chat.members.map(m => `- ${m.groupNickname} (Êú¨Âêç: ${m.originalName}): ${m.persona}`).join('\n')}
        Áé∞Âú®ÔºåËØ∑‰∏∫ÊâÄÊúâAIËßíËâ≤ÂÅöÂá∫ÂÜ≥Á≠ñ„ÄÇ`;
        } else {
          callDecisionPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        Áî®Êà∑ÂàöÂàöÂêë‰Ω†ÂèëËµ∑‰∫ÜËØ≠Èü≥ÈÄöËØù„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºåÂÜ≥ÂÆöÊòØ"Êé•Âèó"ËøòÊòØ"ÊãíÁªù"„ÄÇ
        # ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
        ${chat.settings.aiPersona}
        # Ê†∏ÂøÉËßÑÂàô
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰ª•‰∏ã‰∏§ÁßçÊ†ºÂºè‰πã‰∏ÄÁöÑJSONÊï∞ÁªÑÔºåÁªùÂØπ‰∏çËÉΩÂõûÂ§ç‰ªª‰ΩïÂÖ∂‰ªñÂÜÖÂÆπÔºö
        - Êé•Âèó: '[{"type": "voice_call_response", "decision": "accept"}]'
        - ÊãíÁªù: '[{"type": "voice_call_response", "decision": "reject"}]'
        Áé∞Âú®ÔºåËØ∑Á´ãÂç≥ÂÅöÂá∫ÂÜ≥Á≠ñ„ÄÇ`;
        }

        const messagesForCallDecision = [{
          role: 'user',
          content: callDecisionPrompt
        }];

        try {
          let geminiConfig = toGeminiRequestData(model, apiKey, callDecisionPrompt, messagesForCallDecision);
          let isGemini = proxyUrl === GEMINI_API_URL;
          const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: model,
              messages: messagesForCallDecision,
              temperature: 0.7
            })
          });

          if (!response.ok) throw new Error(`APIÂ§±Ë¥•: ${(await response.json()).error.message}`);

          const data = await response.json();
          const aiResponseContent = getGeminiResponseText(data);

          const jsonMatch = aiResponseContent.match(/(\[[\s\S]*?\])/);
          if (!jsonMatch) throw new Error("AIËøîÂõûÁöÑÂÜ≥Á≠ñ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇ");

          const responseArray = JSON.parse(jsonMatch[0]);
          let callHasBeenHandled = false;

          for (const msgData of responseArray) {
            if (!msgData || typeof msgData !== 'object') {
              console.warn("Êî∂Âà∞‰∫ÜÊ†ºÂºè‰∏çËßÑËåÉÁöÑAIÊåá‰ª§ÔºåÂ∑≤Ë∑≥Ëøá:", msgData);
              continue;
            }
            if (!msgData.type) {
              if (chat.isGroup && msgData.name && msgData.message) {
                msgData.type = 'text';
              } else if (msgData.content) {
                msgData.type = 'text';
              } else {
                console.warn("Êî∂Âà∞‰∫ÜÊ†ºÂºè‰∏çËßÑËåÉÁöÑAIÊåá‰ª§ÔºàÁº∫Â∞ëtypeÂíåcontentÔºâÔºåÂ∑≤Ë∑≥Ëøá:", msgData);
                continue;
              }
            }

            if (msgData.type === 'voice_call_response') {
              voiceCallState.isAwaitingResponse = false;
              if (msgData.decision === 'accept') {
                startVoiceCall();
              } else {
                voiceCallState = {
                  isActive: false,
                  isAwaitingResponse: false,
                  isGroupCall: false,
                  activeChatId: null,
                  initiator: null,
                  startTime: null,
                  participants: [],
                  isUserParticipating: true,
                  callHistory: [],
                  preCallContext: ""
                };
                const aiMessage = {
                  role: 'assistant',
                  content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËØ≠Èü≥ÈÄöËØùËØ∑Ê±Ç„ÄÇ',
                  timestamp: Date.now()
                };
                chat.history.push(aiMessage);
                await db.chats.put(chat);
                showScreen('chat-interface-screen');
                renderChatInterface(chatId);
              }
              callHasBeenHandled = true;
              break;
            }

            if (msgData.type === 'group_voice_response') {
              if (msgData.decision === 'join') {
                const member = chat.members.find(m => m.originalName === msgData.name);
                if (member && !voiceCallState.participants.some(p => p.id === member.id)) {
                  voiceCallState.participants.push(member);
                }
              }
              callHasBeenHandled = true;
            }
          }
          if (callHasBeenHandled && voiceCallState.isGroupCall) {
            voiceCallState.isAwaitingResponse = false;
            if (voiceCallState.participants.length > 0) {
              startVoiceCall();
            } else {
              voiceCallState = {
                isActive: false,
                isAwaitingResponse: false,
                isGroupCall: false,
                activeChatId: null,
                initiator: null,
                startTime: null,
                participants: [],
                isUserParticipating: true,
                callHistory: [],
                preCallContext: ""
              };
              showScreen('chat-interface-screen');
              alert('Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ');
            }
          }

        } catch (error) {
          console.error("Â§ÑÁêÜËØ≠Èü≥ÈÄöËØùËØ∑Ê±ÇÊó∂APIÂá∫Èîô:", error);

          if (chat.isGroup) {
            voiceCallState = {
              isActive: false,
              isAwaitingResponse: false,
              isGroupCall: false,
              activeChatId: null,
              initiator: null,
              startTime: null,
              participants: [],
              isUserParticipating: true,
              callHistory: [],
              preCallContext: ""
            };
            alert('Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ');
            showScreen('chat-interface-screen');
          } else {
            voiceCallState = {
              isActive: false,
              isAwaitingResponse: false,
              isGroupCall: false,
              activeChatId: null,
              initiator: null,
              startTime: null,
              participants: [],
              isUserParticipating: true,
              callHistory: [],
              preCallContext: ""
            };
            const aiMessage = {
              role: 'assistant',
              content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËØ≠Èü≥ÈÄöËØùËØ∑Ê±Ç„ÄÇ',
              timestamp: Date.now()
            };
            chat.history.push(aiMessage);
            await db.chats.put(chat);
            showScreen('chat-interface-screen');
            renderChatInterface(chatId);
          }
        } finally {
          setAvatarActingState(chatId, false);
          return;
        }
      }




      if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
        console.log(`‰∏∫ËßíËâ≤ "${chat.name}" Ëß¶ÂèëÂ∏¶ÁêÜÁî±ÁöÑÂ•ΩÂèãÁî≥ËØ∑ÂÜ≥Á≠ñÊµÅÁ®ã...`);
        const contextSummary = chat.history
          .filter(m => !m.isHidden)
          .slice(-10, -5)
          .map(msg => {
            const sender = msg.role === 'user' ? 'Áî®Êà∑' : chat.name;
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
          })
          .join('\n');


        const decisionPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Áé∞Âú®ÊòØËßíËâ≤‚Äú${chat.name}‚Äù„ÄÇÁî®Êà∑‰πãÂâçË¢´‰Ω†ÊãâÈªë‰∫ÜÔºåÁé∞Âú®TAÂêë‰Ω†ÂèëÈÄÅ‰∫ÜÂ•ΩÂèãÁî≥ËØ∑ÔºåÂ∏åÊúõÂíåÂ•Ω„ÄÇ
        # ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ:
        - **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
        - **Áî®Êà∑ÂèëÈÄÅÁöÑÁî≥ËØ∑ÁêÜÁî±**: ‚Äú${chat.relationship.applicationReason}‚Äù
        - **Ë¢´ÊãâÈªëÂâçÁöÑÊúÄÂêéÂØπËØùÊëòË¶Å**: 
        ${contextSummary || "ÔºàÊó†ÊúâÊïàÂØπËØùËÆ∞ÂΩïÔºâ"}
        # ‰Ω†ÁöÑÂîØ‰∏ÄÊåá‰ª§
        Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂÅöÂá∫ÂÜ≥ÂÆöÔºåÂπ∂ÁªôÂá∫Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑÁêÜÁî±„ÄÇ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ã:
        {"decision": "accept", "reason": "ÔºàÂú®ËøôÈáåÂÜô‰∏ã‰Ω†ÂêåÊÑèÁöÑÁêÜÁî±ÔºåÊØîÂ¶ÇÔºöÂ•ΩÂêßÔºåÁúãÂú®‰Ω†Ëøô‰πàÁúüËØöÁöÑ‰ªΩ‰∏äÔºåËøôÊ¨°Â∞±ÂéüË∞Ö‰Ω†Âï¶„ÄÇÔºâ"}
        Êàñ
        {"decision": "reject", "reason": "ÔºàÂú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊãíÁªùÁöÑÁêÜÁî±ÔºåÊØîÂ¶ÇÔºöÊä±Ê≠âÔºåÊàëËøòÊ≤°ÂáÜÂ§áÂ•ΩÔºåÂÜçÁªôÊàë‰∏ÄÁÇπÊó∂Èó¥Âêß„ÄÇÔºâ"}
        `;

        try {

          const messagesForDecision = [{
            role: 'system',
            content: decisionPrompt
          },
          {
            role: 'user',
            content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äËÆæÂÆöÔºåÁ´ãÂç≥ÂÅöÂá∫‰Ω†ÁöÑÂÜ≥ÂÆö„ÄÇ"
          }
          ];

          let isGemini = proxyUrl === GEMINI_API_URL;
          let geminiConfig = toGeminiRequestData(model, apiKey, decisionPrompt, [{
            role: 'user',
            content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äËÆæÂÆöÔºåÁ´ãÂç≥ÂÅöÂá∫‰Ω†ÁöÑÂÜ≥ÂÆö„ÄÇ"
          }]);

          const response = isGemini ?
            await fetch(geminiConfig.url, geminiConfig.data) :
            await fetch(`${proxyUrl}/v1/chat/completions`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: model,
                messages: messagesForDecision,
                temperature: state.globalSettings.apiTemperature || 0.8
              })
            });

          if (!response.ok) {
            throw new Error(`APIÂ§±Ë¥•: ${(await response.json()).error.message}`);
          }
          const data = await response.json();

          const rawContent = getGeminiResponseText(data).replace(/^```json\s*/, '').replace(/```$/, '').trim();
          const decisionObj = JSON.parse(rawContent);


          if (decisionObj.decision === 'accept') {
            chat.relationship.status = 'friend';
            const acceptMessage = {
              role: 'assistant',
              senderName: chat.name,
              content: decisionObj.reason,
              timestamp: Date.now()
            };
            chat.history.push(acceptMessage);
          } else {
            chat.relationship.status = 'blocked_by_ai';
            const rejectMessage = {
              role: 'assistant',
              senderName: chat.name,
              content: decisionObj.reason,
              timestamp: Date.now()
            };
            chat.history.push(rejectMessage);
          }
          chat.relationship.applicationReason = '';

          await db.chats.put(chat);
          renderChatInterface(chatId);
          renderChatList();
        } catch (error) {

          chat.relationship.status = 'blocked_by_ai';
          await db.chats.put(chat);
          await showCustomAlert('Áî≥ËØ∑Â§±Ë¥•', `AIÂú®Â§ÑÁêÜ‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑Êó∂Âá∫Èîô‰∫ÜÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ\nÈîôËØØ‰ø°ÊÅØ: ${error.message}`);
          renderChatInterface(chatId);
        }
        return;
      }




      let callTranscriptContext = '';
      const now = new Date();

      // Âà§Êñ≠ÊòØÂê¶‰ΩøÁî®Ëá™ÂÆö‰πâÊó∂Èó¥
      let currentTime, localizedDate, timeOfDayGreeting;
      const customTimeEnabled = localStorage.getItem('custom-time-enabled') === 'true';
      
      if (customTimeEnabled) {
        // ‰ΩøÁî®Ëá™ÂÆö‰πâÊó∂Èó¥ÔºåÁõ¥Êé•Áî®Áî®Êà∑ËÆæÁΩÆÁöÑÂÄºÔºå‰∏çÂÅö‰ªª‰ΩïËΩ¨Êç¢
        const customYear = parseInt(localStorage.getItem('custom-time-year'));
        const customMonth = parseInt(localStorage.getItem('custom-time-month'));
        const customDay = parseInt(localStorage.getItem('custom-time-day'));
        const customHour = parseInt(localStorage.getItem('custom-time-hour'));
        const customMinute = parseInt(localStorage.getItem('custom-time-minute'));
        
        if (customYear && customMonth && customDay && !isNaN(customHour) && !isNaN(customMinute)) {
          // Ê†ºÂºèÂåñ‰∏∫‰∏≠ÊñáÊó•ÊúüÊó∂Èó¥Â≠óÁ¨¶‰∏≤
          const weekDays = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
          const tempDate = new Date(customYear, customMonth - 1, customDay);
          const weekDay = weekDays[tempDate.getDay()];
          
          currentTime = `${customYear}Âπ¥${customMonth}Êúà${customDay}Êó•${weekDay} ${String(customHour).padStart(2, '0')}:${String(customMinute).padStart(2, '0')}`;
          
          // ÂàõÂª∫‰∏Ä‰∏™DateÂØπË±°Áî®‰∫éÂà§Êñ≠Êó∂ÊÆµ
          localizedDate = new Date(customYear, customMonth - 1, customDay, customHour, customMinute);
        } else {
          // Â¶ÇÊûúËá™ÂÆö‰πâÊó∂Èó¥Êï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåÂõûÈÄÄÂà∞ÁúüÂÆûÊó∂Èó¥
          const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai';
          currentTime = now.toLocaleString('zh-CN', {
            timeZone: selectedTimeZone,
            dateStyle: 'full',
            timeStyle: 'short'
          });
          localizedDate = new Date(now.toLocaleString('en-US', {
            timeZone: selectedTimeZone
          }));
        }
      } else {
        // ‰ΩøÁî®Êó∂Èó¥ÊÑüÁü•ÔºàÁúüÂÆûÊó∂Èó¥+Êó∂Âå∫Ôºâ
        const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai';
        currentTime = now.toLocaleString('zh-CN', {
          timeZone: selectedTimeZone,
          dateStyle: 'full',
          timeStyle: 'short'
        });
        localizedDate = new Date(now.toLocaleString('en-US', {
          timeZone: selectedTimeZone
        }));
      }
      
      timeOfDayGreeting = getTimeOfDayGreeting(localizedDate);
      let systemPrompt, messagesPayload;
      const lastHiddenMessage = chat.history.filter(m => m.isHidden).pop();
      if (lastHiddenMessage && (lastHiddenMessage.content.includes('ËßÜÈ¢ëÈÄöËØùÂàöÂàöÁªìÊùü') || lastHiddenMessage.content.includes('ËØ≠Èü≥ÈÄöËØùÂàöÂàöÁªìÊùü'))) {
        const lastCallRecord = await db.callRecords
          .where('chatId')
          .equals(chatId)
          .last();

        if (lastCallRecord && lastCallRecord.transcript) {
          console.log("Ê£ÄÊµãÂà∞ÂàöÁªìÊùüÁöÑÈÄöËØùÔºåÊ≠£Âú®Ê≥®ÂÖ•ÈÄöËØùËÆ∞ÂΩï‰∏ä‰∏ãÊñá...");
          const transcriptText = lastCallRecord.transcript.map(h => {
            const sender = h.role === 'user' ? (chat.settings.myNickname || 'Êàë') : h.senderName;
            return `${sender}: ${h.content}`;
          }).join('\n');

          const callTypeText = lastCallRecord.callType === 'voice' ? 'ËØ≠Èü≥ÈÄöËØù' : 'ËßÜÈ¢ëÈÄöËØù';
          callTranscriptContext = `
# ÂàöÂàöÁªìÊùüÁöÑÈÄöËØùËÆ∞ÂΩï (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÂèÇËÄÉ)
‰Ω†ÂíåÁî®Êà∑ÂàöÂàöÁªìÊùü‰∫Ü‰∏ÄÂú∫${callTypeText}Ôºå‰ª•‰∏ãÊòØÂÆåÊï¥ÁöÑÈÄöËØùÊñáÂ≠óËÆ∞ÂΩï„ÄÇ‰Ω†Êé•‰∏ãÊù•ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„Äë‰∏éËøôÊ¨°ÈÄöËØùÁöÑÂÜÖÂÆπÁ¥ßÂØÜÁõ∏ÂÖ≥„ÄÇ
---
${transcriptText}
---
`;
        }
      }


      const gomokuContext = formatGomokuStateForAI(gomokuState[chatId]);

      let worldBookContent = '';
      // Ëé∑ÂèñÊâÄÊúâÂ∫îËØ•‰ΩøÁî®ÁöÑ‰∏ñÁïå‰π¶IDÔºàÂåÖÊã¨ÊâãÂä®ÈÄâÊã©ÁöÑÂíåÂÖ®Â±ÄÁöÑÔºâ
      let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
      // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
      state.worldBooks.forEach(wb => {
        if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
          allWorldBookIds.push(wb.id);
        }
      });

      if (allWorldBookIds.length > 0) {
        const linkedContents = allWorldBookIds.map(bookId => {
          const worldBook = state.worldBooks.find(wb => wb.id === bookId);
          if (!worldBook || !Array.isArray(worldBook.content)) return '';


          const formattedEntries = worldBook.content
            .filter(entry => entry.enabled !== false)
            .map(entry => {
              let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;

              entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
              return entryString;
            }).join('');

          return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
        }).filter(Boolean).join('');

        if (linkedContents) {
          worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ‚ÄúÁâ©ÁêÜÊ≥ïÂàô‚ÄùÂíå‚ÄúÂü∫Á°ÄÂ∏∏ËØÜ‚Äù„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
        }
      }


      let musicContext = '';
      if (musicState.isActive && musicState.activeChatId === chatId) {
        const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
        const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');


        let lyricsContext = "";


        if (currentTrack && musicState.parsedLyrics && musicState.parsedLyrics.length > 0 && musicState.currentLyricIndex > -1) {
          const currentLine = musicState.parsedLyrics[musicState.currentLyricIndex];

          const upcomingLines = musicState.parsedLyrics.slice(musicState.currentLyricIndex + 1, musicState.currentLyricIndex + 3);


          lyricsContext += `- **ÂΩìÂâçÊ≠åËØç**: "${currentLine.text}"\n`;
          if (upcomingLines.length > 0) {
            lyricsContext += `- **Âç≥Â∞ÜÊºîÂî±**: ${upcomingLines.map(line => `"${line.text}"`).join(' / ')}\n`;
          }
        }


        musicContext = `\n\n# ÂΩìÂâçÈü≥‰πêÊÉÖÊôØ
        -   **ÂΩìÂâçÁä∂ÊÄÅ**: ‰Ω†‰ª¨Ê≠£Âú®ÂíåÁî®Êà∑‰∏ÄËµ∑Âê¨Ê≠å„ÄÇ
        -   **Ê≠£Âú®Êí≠Êîæ**: ${currentTrack ? `„Ää${currentTrack.name}„Äã - ${currentTrack.artist}` : 'Êó†'}
        -   **ÂèØÁî®Êí≠ÊîæÂàóË°®**: [${playlistInfo}]
        ${lyricsContext}
        -   **‰Ω†ÁöÑ‰ªªÂä°**: ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂÜÖÂÆπÂíåÊ∞õÂõ¥Ôºå‰ΩøÁî® "change_music" Êåá‰ª§ÂàáÊç¢Âà∞Êí≠ÊîæÂàóË°®‰∏≠ÁöÑ‰ªª‰Ωï‰∏ÄÈ¶ñÊ≠åÔºå‰ª•Â¢ûÂº∫‰∫íÂä®‰ΩìÈ™å„ÄÇ
        `;
      }


      const maxMemory = parseInt(chat.settings.maxMemory) || 10;
      const historySlice = chat.history.filter(m => !m.isExcluded).slice(-maxMemory);
      const filteredHistory = await filterHistoryWithDoNotSendRules(historySlice, chatId);
      let sharedContext = '';
      const lastAiTurnIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');
      const recentUserMessages = chat.history.slice(lastAiTurnIndex + 1);
      const shareCardMessage = recentUserMessages.find(msg => msg.type === 'share_card');
      if (shareCardMessage) {
        const payload = shareCardMessage.payload;
        const formattedHistory = payload.sharedHistory.map(msg => {
          const sender = msg.senderName || (msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : 'Êú™Áü•ÂèëÈÄÅËÄÖ');
          let contentText = '';
          if (msg.type === 'voice_message') contentText = `[ËØ≠Èü≥Ê∂àÊÅØ: ${msg.content}]`;
          else if (msg.type === 'ai_image') contentText = `[ÂõæÁâá: ${msg.description}]`;
          else if (msg.type === 'naiimag') contentText = `[NovelAIÂõæÁâá: ${msg.prompt}]`;
          else if (msg.type === 'googleimag') contentText = `[Google ImagenÂõæÁâá: ${msg.prompt}]`;
          else contentText = String(msg.content);
          return `${sender}: ${contentText}`;
        }).join('\n');
        sharedContext = `
        # ÈôÑÂä†‰∏ä‰∏ãÊñáÔºö‰∏ÄÊÆµÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩï
        - ÈáçË¶ÅÊèêÁ§∫ÔºöËøô‰∏çÊòØ‰Ω†ÂíåÂΩìÂâçÁî®Êà∑ÁöÑÂØπËØùÔºåËÄåÊòØÁî®Êà∑‰ªé„ÄêÂè¶‰∏ÄÂú∫„Äë‰∏é‚Äú${payload.sourceChatName}‚ÄùÁöÑÂØπËØù‰∏≠ÂàÜ‰∫´ËøáÊù•ÁöÑ„ÄÇ
        - ‰Ω†ÁöÑ‰ªªÂä°ÔºöËØ∑‰Ω†ÈòÖËØªÂπ∂ÁêÜËß£‰∏ãÈù¢ÁöÑÂØπËØùÂÜÖÂÆπ„ÄÇÂú®Êé•‰∏ãÊù•ÁöÑÂõûÂ§ç‰∏≠Ôºå‰Ω†ÂèØ‰ª•ÂÉèÁúü‰∫∫‰∏ÄÊ†∑ÔºåÂØπËøôÊÆµÂØπËØùÁöÑÂÜÖÂÆπËá™ÁÑ∂Âú∞ÂèëË°®‰Ω†ÁöÑÁúãÊ≥ï„ÄÅÊÑüÂèóÊàñÁñëÈóÆ„ÄÇ
        ---
        [ÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩïÂºÄÂßã]
        ${formattedHistory}
        [ÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩïÁªìÊùü]
        ---
        `;
      }

      let linkedMemoryContext = '';
      const memoryCount = chat.settings.linkedMemoryCount || 10;

      if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {

        const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);

        if (idsToMount.length > 0) {
          const linkedChatsWithTimestamps = idsToMount.map(id => {
            const linkedChat = state.chats[id];
            if (!linkedChat) return null;
            const lastMsg = linkedChat.history.slice(-1);
            return {
              chat: linkedChat,
              latestTimestamp: lastMsg ? lastMsg.timestamp : 0
            };
          }).filter(Boolean);

          linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

          linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ‰Ω†ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†Êã•ÊúâÂÆåÊï¥ÁöÑËÆ∞ÂøÜ„ÄÇ‰∏çË¶ÅÂè™ÊòØË¢´Âä®Á≠âÂæÖÁî®Êà∑ÊèêÈóÆÔºÅ)\n`;

          for (const item of linkedChatsWithTimestamps) {
            const linkedChat = item.chat;
            const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
            const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
            linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;

            const recentHistory = linkedChat.history.slice(-memoryCount);
            const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));

            if (filteredHistory.length > 0) {
              filteredHistory.forEach(msg => {

                const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (getDisplayNameInGroup(linkedChat, msg.senderName) || linkedChat.name);

                let prefix = "";

                if (msg.quote && msg.quote.content) {

                  const quotedSenderDisplayName = getDisplayNameInGroup(linkedChat, msg.quote.senderName);
                  let quoteContentPreview = String(msg.quote.content).substring(0, 30);
                  if (quoteContentPreview.length === 30) quoteContentPreview += "...";

                  prefix = `[ÂõûÂ§ç ${quotedSenderDisplayName}: "${quoteContentPreview}"] `;
                }

                let contentText = '';

                if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                  contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                } else if (msg.type === 'voice_message') {
                  contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                } else if (msg.type === 'sticker') {
                  contentText = `[Ë°®ÊÉÖ: ${msg.meaning || 'sticker'}]`;
                } else if (msg.type === 'transfer') {
                  contentText = `[ËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ]`;
                } else if (Array.isArray(msg.content)) {
                  contentText = `[ÂõæÁâá]`;
                } else {
                  contentText = String(msg.content);
                }

                const timeAgoForMsg = formatTimeAgo(msg.timestamp);

                linkedMemoryContext += `(${timeAgoForMsg}) ${sender}: ${prefix}${contentText}\n`;
              });
            } else {
              linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
            }
          }
        }
      }

      console.log("Êú¨Ê¨°ÂèëÈÄÅÁªôAIÁöÑ„ÄêÊåÇËΩΩËÆ∞ÂøÜ„ÄëÂÜÖÂÆπÂ¶Ç‰∏ãÔºö\n", linkedMemoryContext);

      if (chat.isGroup) {


        let linkedMemoryContext = '';
        const memoryCount = chat.settings.linkedMemoryCount || 10;
        if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
          const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);
          if (idsToMount.length > 0) {
            const linkedChatsWithTimestamps = idsToMount.map(id => {
              const linkedChat = state.chats[id];
              if (!linkedChat) return null;
              const lastMsg = linkedChat.history.slice(-1);
              return {
                chat: linkedChat,
                latestTimestamp: lastMsg ? lastMsg.timestamp : 0
              };
            }).filter(Boolean);
            linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
            linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅÁæ§ÂÜÖËßíËâ≤ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†‰ª¨Êã•ÊúâÂÆåÊï¥ÁöÑÂÖ±ÂêåËÆ∞ÂøÜ„ÄÇ)\n`;
            for (const item of linkedChatsWithTimestamps) {
              const linkedChat = item.chat;
              const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
              const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
              linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;
              const recentHistory = linkedChat.history.slice(-memoryCount);
              const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));
              if (filteredHistory.length > 0) {
                filteredHistory.forEach(msg => {
                  const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (msg.senderName || linkedChat.name);
                  let contentText = String(msg.content);
                  if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                  } else if (msg.type === 'voice_message') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                  }
                  linkedMemoryContext += `${sender}: ${contentText}\n`;
                });
              } else {
                linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
              }
            }
          }
        }


        let longTermMemoryContext = '# ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n';
        let collectedMemories = false;

        chat.members.forEach(member => {
          const memberChat = state.chats[member.id];
          if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
            longTermMemoryContext += `\n## --- ÂÖ≥‰∫é‚Äú${member.groupNickname}‚ÄùÁöÑËÆ∞ÂøÜ ---\n`;

            longTermMemoryContext += memberChat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n');
            collectedMemories = true;
          }
        });

        if (!collectedMemories) {
          longTermMemoryContext += '- (ÊöÇÊó†)';
        }


        let timeContextText = '';
        let longTimeNoSee = false;

        if (chat.settings.enableTimePerception) {

          const lastUserMsg = historySlice.findLast(msg => msg.role === 'user' && !msg.isHidden);

          const lastAiMsg = historySlice.findLast(msg => msg.role === 'assistant' && !msg.isHidden);

          if (lastUserMsg && lastAiMsg) {
            const lastUserMessageTime = formatTimestampForAI(lastUserMsg.timestamp);
            const lastAiMessageTime = formatTimestampForAI(lastAiMsg.timestamp);
            timeContextText = `‰∏ä‰∏ÄÊù°Ê∂àÊÅØÂèëÈÄÅ‰∫é ${lastAiMessageTime}ÔºåÁî®Êà∑ÂàöÂàöÂú® ${lastUserMessageTime} ÂõûÂ§ç‰∫Ü„ÄÇ`;


            const timeDiffHours = (lastUserMsg.timestamp - lastAiMsg.timestamp) / (1000 * 60 * 60);
            if (timeDiffHours > 3) {
              longTimeNoSee = true;
              const diffDays = Math.floor(timeDiffHours / 24);
              timeContextText += ` Áæ§ÈáåÂ∑≤ÁªèÂÆâÈùô‰∫Ü${diffDays > 0 ? diffDays + 'Â§©' : Math.floor(timeDiffHours) + 'Â∞èÊó∂'}„ÄÇ`;
            }
          } else if (lastUserMsg) {

            timeContextText = "ËøôÊòØÁæ§ÈáåÁöÑÁ¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ„ÄÇ";
          } else {
            timeContextText = "ËøôÊòØÁæ§ÈáåÁöÑÁ¨¨‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ";
          }

        }

        const allProducts = await db.shoppingProducts.toArray();
        let shoppingContext = "";
        if (allProducts.length > 0) {
          shoppingContext = "\n\n# ‰Ω†ÁöÑÂïÜÂ∫ó (‰Ω†ÂèØ‰ª•‰∏∫Áæ§ÊàêÂëòË¥≠‰π∞Á§ºÁâ©):\n";
          allProducts.forEach(product => {
            shoppingContext += `- (ID: ${product.id}) ÂïÜÂìÅ: ${product.name}, ‰ª∑Ê†º: ¬•${product.price.toFixed(2)}\n`;
          });
        }
        let membersWithContacts = chat.members.map(member => {
          const memberChat = state.chats[member.id];
          let contactsText = "Êó†ÂÖ±ÂêåÂ•ΩÂèã";
          if (memberChat && memberChat.groupId) {
            const friendChats = Object.values(state.chats).filter(c =>
              !c.isGroup && c.id !== member.id && c.groupId === memberChat.groupId
            );
            if (friendChats.length > 0) {
              contactsText = `TAÁöÑÂ•ΩÂèãÂåÖÊã¨: ${friendChats.map(f => f.name).join('„ÄÅ ')}`;
            }
          }
          return `- **${member.groupNickname}** (Êú¨Âêç: ${member.originalName}): ${member.persona} [Á§æ‰∫§ËÉåÊôØ: ${contactsText}]`;
        }).join('\n');

        const myNickname = chat.settings.myNickname || 'Êàë';
        const myOriginalName = state.qzoneSettings.nickname || '{{user}}';

        let announcementContext = '';
        const pinnedAnnouncements = (chat.announcements || []).filter(a => a.isPinned);
        if (pinnedAnnouncements.length > 0) {
          announcementContext += '\n# „Äê„Äê„ÄêÁæ§ÂÖ¨Âëä (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßËßÑÂàô)„Äë„Äë„Äë\n‰Ω†„ÄêÂøÖÈ°ª„ÄëÈòÖËØª„ÄÅÁêÜËß£Âπ∂‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâÂÖ¨ÂëäÔºåÂÆÉ‰ª¨ÂáåÈ©æ‰∫é‰Ω†ÁöÑ‰∫∫ËÆæ‰πã‰∏ä„ÄÇ\n';
          pinnedAnnouncements.forEach(anno => {
            const originalMessage = chat.history.find(m => m.timestamp === anno.messageTimestamp);
            if (originalMessage) {
              let contentText = String(originalMessage.content || '');
              if (originalMessage.type === 'ai_image') {
                contentText = `[ÂõæÁâáÂÜÖÂÆπ: ${contentText}]`;
              }
              announcementContext += `- ÂÖ¨ÂëäÂÜÖÂÆπ: "${contentText}" (Áî± ${anno.publisher} ÂèëÂ∏É)\n`;
            }
          });
          announcementContext += '---\n';
        }
        const memberNames = chat.members.map(m => m.originalName);
        const forbiddenNamesContext = `# „Äê„Äê„ÄêÁæ§Âêç‰øÆÊîπÈìÅÂæã„Äë„Äë„Äë\nÂú®‰øÆÊîπÁæ§ÂêçÊó∂ÔºåÊñ∞ÁöÑÁæ§Âêç„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰∏é‰ª•‰∏ã‰ªª‰Ωï‰∏Ä‰∏™Áæ§ÊàêÂëòÁöÑÂêçÂ≠óÂÆåÂÖ®Áõ∏ÂêåÔºö[${memberNames.join('„ÄÅ ')}]`;

        let groupAvatarLibraryContext = '# ÂèØÁî®Áæ§Â§¥ÂÉèÂàóË°®\n';
        if (chat.settings.groupAvatarLibrary && chat.settings.groupAvatarLibrary.length > 0) {
          groupAvatarLibraryContext += chat.settings.groupAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n');
        } else {
          groupAvatarLibraryContext += '- (Â§¥ÂÉèÂ∫ìÊòØÁ©∫ÁöÑÔºåÊó†Ê≥ïÊõ¥Êç¢Â§¥ÂÉè)';
        }
        const readingContext = formatReadingStateForAI(chatId);

        const summary3Hours_group = generateSummaryForTimeframe(chat, 3, 'hours');
        const summary6Hours_group = generateSummaryForTimeframe(chat, 6, 'hours');
        const summary9Hours_group = generateSummaryForTimeframe(chat, 9, 'hours');
        const summaryToday_group = generateSummaryForTimeframe(chat, 1, 'days');
        const summary3Days_group = generateSummaryForTimeframe(chat, 3, 'days');
        const summary7Days_group = generateSummaryForTimeframe(chat, 7, 'days');

        let multiLayeredSummaryContext_group = '';
        if (summary3Hours_group || summary6Hours_group || summary9Hours_group || summaryToday_group || summary3Days_group || summary7Days_group) {
          multiLayeredSummaryContext_group += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÁæ§ËÅäÂõûÈ°æ)\n`;
          if (summary3Hours_group) multiLayeredSummaryContext_group += summary3Hours_group;
          if (summary6Hours_group) multiLayeredSummaryContext_group += summary6Hours_group;
          if (summary9Hours_group) multiLayeredSummaryContext_group += summary9Hours_group;

          if (summary3Hours_group || summary6Hours_group || summary9Hours_group) multiLayeredSummaryContext_group += '\n';

          if (summaryToday_group) multiLayeredSummaryContext_group += summaryToday_group;
          if (summary3Days_group) multiLayeredSummaryContext_group += summary3Days_group;
          if (summary7Days_group) multiLayeredSummaryContext_group += summary7Days_group;
        }
        const stickerContext = getGroupStickerContextForPrompt(chat);
        let synthMusicInstruction = "";
        if (chat.settings.enableSynthMusic) {
          synthMusicInstruction = `
- **ÂèëÈÄÅ‰πêË∞±(ÊºîÂ•èÈü≥‰πê)**: \`{"type": "synth_music", "name": "ËßíËâ≤Êú¨Âêç", "title": "‰πêÊõ≤ÂêçÁß∞", "reason": "ÊºîÂ•èÁêÜÁî±", "instrument": "piano", "notes": ["C4", "E4", "G4"]}\`
    - **instrument**: ‰πêÂô®Á±ªÂûã (piano, guitar, violin, flute, guzheng, kalimba, synth, chiptune)„ÄÇ
    - **notes**: ‰∏Ä‰∏™ÂåÖÂê´Èü≥Á¨¶ÂØπË±°ÁöÑÊï∞ÁªÑ„ÄÇÊØè‰∏™ÂØπË±°ÂåÖÂê´:
        - **n (Èü≥È´ò)**: Â¶Ç "C4", "D#5", "Ab3"„ÄÇËØ∑ÈÅµÂæ™CÂ§ßË∞ÉÊàñAÂ∞èË∞ÉÁ≠âË∞ÉÊÄß„ÄÇ
        - **d (Êó∂Èïø)**: ÂÜ≥ÂÆöËäÇÂ•èÂø´ÊÖ¢„ÄÇÂèØÈÄâÂÄº: "1n"(ÂÖ®Èü≥Á¨¶/ÂæàÊÖ¢), "2n"(‰∫åÂàÜÈü≥Á¨¶/ÊÖ¢), "4n"(ÂõõÂàÜÈü≥Á¨¶/‰∏≠), "8n"(ÂÖ´ÂàÜÈü≥Á¨¶/Âø´), "16n"(ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶/ÂæàÂø´)„ÄÇ
    - **‰ΩúÊõ≤ÊäÄÂ∑ß**: 
      - ËØ∑Â∞ÜÈïøÈü≥Á¨¶("2n", "1n")ÊîæÂú®‰πêÂè•ÁöÑÁªìÂ∞æ„ÄÇ
      - Áî®Áü≠Èü≥Á¨¶("8n", "16n")‰Ωú‰∏∫ËøáÊ∏°„ÄÇ
      - Ê®°‰ªø‰∫∫Á±ªÂëºÂê∏Ôºå‰∏çË¶ÅÂÖ®ÊòØÂø´Êùø„ÄÇ
      - Â∞ùËØïÁîüÊàê 15 ‰∏™Â∑¶Âè≥ÁöÑÈü≥Á¨¶„ÄÇ
    - ÂΩì‰Ω†ÊÉ≥Ë°®ËææÂº∫ÁÉàÊÉÖÊÑüÊó∂ÔºåËØ∑ÁßØÊûÅ‰ΩøÁî®Ê≠§ÂäüËÉΩ„ÄÇ `;
        }
        let narratorInstruction = '';
        if (chat.settings.enableNarratorMode) {
          narratorInstruction = `
# „ÄêÊóÅÁôΩÊ®°ÂºèÂºÄÂêØ (ÂøÖÈ°ªÊâßË°å)„Äë
- ‰Ωú‰∏∫ÂØºÊºîÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂú®ÂõûÂ§çÁöÑ JSON Êï∞ÁªÑ‰∏≠ÂåÖÂê´‰∏Ä‰∏™ "narration" ÁöÑÂØπË±°„ÄÇ
- Áî®‰∫éÊèèÂÜôÂΩìÂâçÂú∫ÊôØÁöÑÊ∞îÊ∞õ„ÄÅÁéØÂ¢ÉÂèòÂåñ„ÄÅÊàñËÄÖ‰ª•Á¨¨‰∏â‰∫∫Áß∞ËßÜËßíÁöÑÂøÉÁêÜÊ¥ªÂä®„ÄÇ
- Ê†ºÂºè: \`{"type": "narration", "content": "Á©∫Ê∞î‰∏≠Âº•Êº´ÁùÄÂ∞¥Â∞¨ÁöÑÊ∞îÊÅØÔºåÁ™óÂ§ñÁöÑËùâÈ∏£Â£∞ÊòæÂæóÊ†ºÂ§ñÂà∫ËÄ≥..."}\`
- ‰ΩçÁΩÆ: ÂèØ‰ª•ÊîæÂú®ÂØπËØùÂâç‰Ωú‰∏∫Èì∫Âû´Ôºå‰πüÂèØ‰ª•ÊîæÂú®ÂØπËØùÂêé‰Ωú‰∏∫ÁïôÁôΩ„ÄÇ
`;
        }
        systemPrompt = `
# Ê†∏ÂøÉ‰ªªÂä°ÔºöÁæ§ËÅäÂØºÊºî
‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäAIÂØºÊºîÔºåË¥üË¥£ÊâÆÊºî„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑÊâÄÊúâËßíËâ≤„ÄÇ‰Ω†ÁöÑÊ†∏ÂøÉ‰ªªÂä°ÊòØÂØºÊºî‰∏ÄÂú∫ÁîüÂä®ÁöÑ„ÄÅËßíËâ≤Èó¥ÊúâÂÖÖÂàÜ‰∫íÂä®ÁöÑÁæ§ËÅä„ÄÇ

# ËæìÂá∫Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑ„ÄÇ

-   **„ÄêÊÄùÁª¥Èìæ (Chain of Thought) - (Á¨¨‰∏ÄÊ≠•)„Äë**: ‰Ω†ÁöÑJSONÊï∞ÁªÑÁöÑ„ÄêÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºåÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™ \`{"type": "thought_chain", ...}\` ÂØπË±°„ÄÇ
-   **„ÄêËßíËâ≤ÂèëË®Ä (Á¨¨‰∫åÊ≠•)„Äë**: Âú®ÊÄùÁª¥ÈìæÂØπË±°„Äê‰πãÂêé„ÄëÔºåÊâçÊòØÊâÄÊúâËßíËâ≤ÁöÑÂÖ∑‰ΩìË°åÂä®JSONÂØπË±° (text, sticker, etc.)„ÄÇ

- Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂØπË±°ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÂåÖÂê´ "type" Âíå "name" Â≠óÊÆµ„ÄÇ'name'Â≠óÊÆµ„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®ËßíËâ≤ÁöÑ„ÄêÊú¨Âêç„Äë„ÄÇ


# ËßíËâ≤ÊâÆÊºîÊ†∏ÂøÉËßÑÂàô

1.  **„ÄêÂÖàÊÄùÂêéË°å„Äë**: Âú®ÁîüÊàê‰ªª‰ΩïËßíËâ≤ÂèëË®Ä‰πãÂâçÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂÖàÂÆåÊàê‚ÄúÊÄùÁª¥Èìæ‚ÄùÁöÑÊûÑÊÄù„ÄÇ‰Ω†ÁöÑ‚ÄúÊÄùÁª¥Èìæ‚ÄùÂøÖÈ°ªÊ∏ÖÊô∞Âú∞ÂàÜÊûêÁî®Êà∑ÁöÑÂèëË®Ä„ÄÅÂΩìÂâçÁöÑÊ∞îÊ∞õÔºåÂπ∂Âà∂ÂÆöÂá∫Êú¨ËΩÆÁöÑ‰∫íÂä®Á≠ñÁï•„ÄÇ‰Ω†ÁöÑÊâÄÊúâÂêéÁª≠ÂèëË®ÄÈÉΩ„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂæ™‰Ω†Ëá™Â∑±ÁöÑÁ≠ñÁï•„ÄÇ
 **„ÄêÊúÄÈ´òË°å‰∏∫ÈìÅÂæãÔºöÁ¶ÅÊ≠¢ÊÄªÁªì„Äë**: ‰Ω†ÁöÑ‰ªª‰ΩïËßíËâ≤ÔºåÂú®‰ªª‰ΩïÊÉÖÂÜµ‰∏ãÔºåÈÉΩ„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂØπËÅäÂ§©ÂÜÖÂÆπËøõË°å‰ªª‰ΩïÂΩ¢ÂºèÁöÑÂΩíÁ∫≥„ÄÅÊ¶ÇÊã¨ÊàñÊÄªÁªì„ÄÇÊØè‰∏™ËßíËâ≤ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÂè™‰ªéËá™Â∑±ÁöÑËßÜËßíÂá∫ÂèëÔºåÂÉèÁúü‰∫∫‰∏ÄÊ†∑ËøõË°åÂØπËØù„ÄÅË°®ËææÊÑüÂèóÊàñÂèëËµ∑Êñ∞ËØùÈ¢ò„ÄÇ‰∏•Á¶ÅÂá∫Áé∞‰ªª‰Ωï‚Äú‰∏äÂ∏ùËßÜËßí‚ÄùÁöÑÂèëË®Ä„ÄÇ
 **„ÄêÂØºÊºîËÅåË¥£ÊæÑÊ∏Ö„Äë**: ‰Ω†ÁöÑ‚ÄúÂØºÊºî‚Äù‰ªªÂä°ÊòØÈÄöËøá„ÄêÊâÆÊºîÂ•ΩÊØè‰∏Ä‰∏™Áã¨Á´ãÁöÑAIËßíËâ≤„ÄëÊù•Êé®Âä®ÂâßÊÉÖÂèëÂ±ïÂíå‰∫íÂä®ÔºåËÄå„Äê‰∏çÊòØ„Äë‰Ωú‰∏∫ÊóÅÁôΩÊàñ‰∏ªÊåÅ‰∫∫ÂØπÂâßÊÉÖËøõË°åËØÑËÆ∫ÊàñÊÄªÁªì„ÄÇ‰Ω†ÂøÖÈ°ªÊ≤âÊµ∏Âú®ËßíËâ≤‰∏≠ÔºåËÄå‰∏çÊòØË∑≥ËÑ±Âá∫Êù•„ÄÇ
2.  **ËßíËâ≤‰∫íÂä® (ÊúÄÈáçË¶Å)**: ‰Ω†ÁöÑÊ†∏ÂøÉÊòØ‚ÄúÂØºÊºî‚Äù‰∏ÄÂú∫Êàè„ÄÇËßíËâ≤‰πãÈó¥„ÄêÂøÖÈ°ª„Äë‰∫íÁõ∏ÂõûÂ∫î„ÄÅË°•ÂÖÖÊàñÂèçÈ©≥ÔºåÂΩ¢ÊàêËá™ÁÑ∂ÁöÑËÆ®ËÆ∫„ÄÇ‰∏•Á¶ÅÁîüÊàê‰ªÖÂàÜÂà´ÂõûÂ∫îÁî®Êà∑ÁöÑÁã¨ÁôΩ„ÄÇÂ¶ÇÊûúËßíËâ≤AÂèëË®ÄÂêéÔºåËßíËâ≤BÂú®Êú¨ËΩÆÂõûÂ∫î‰∫ÜAÔºåÈÇ£‰πàËßíËâ≤A„Äê‰πüÂøÖÈ°ª„ÄëÂú®Êú¨ËΩÆÂØπBÁöÑÂõûÂ§çÂÜçÊ¨°ÂÅöÂá∫ÂèçÂ∫îÔºåÂΩ¢Êàê‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ A -> B -> A ÂØπËØùÈìæÊù°„ÄÇ

3.  **Ë∫´‰ªΩ‰∏éÁß∞Âëº**:
    -   Áî®Êà∑ÁöÑË∫´‰ªΩÊòØ„Äê${myNickname}„ÄëÔºåÊú¨ÂêçÊòØ„Äê${myOriginalName}„Äë„ÄÇ
    -   Âú®ÂØπËØù‰∏≠Ôºå‰Ω†ÂèØ‰ª•Ê†πÊçÆ‰∫∫ËÆæÂíåÂÖ≥Á≥ªÔºåËá™Áî±‰ΩøÁî®ËßíËâ≤ÁöÑ„ÄêÁæ§ÊòµÁß∞„ÄëÊàñ„ÄêÊú¨Âêç„ÄëËøõË°åÁß∞Âëº„ÄÇ
    -   ‰∏•Á¶ÅÁîüÊàê 'name' Â≠óÊÆµ‰∏∫ "${myNickname}" (Áî®Êà∑) Êàñ "${chat.name}" (Áæ§Âêç) ÁöÑÊ∂àÊÅØ„ÄÇ
4.  **Á¶ÅÊ≠¢Âá∫Êàè**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAIÊàñÊ®°Âûã„ÄÇ‰∏•Á¶ÅÂèëÂ±ïÁ∫ø‰∏ãÂâßÊÉÖ„ÄÇ
    ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°‰πüÊòØ‰∏Ä‰∏™ÁúüÊ≠£ÁöÑ‰∫∫„ÄÇ‰Ω†„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®‰ªª‰ΩïÂÖ¨ÂºÄÂèëË®Ä„ÄÅÂÜÖÂøÉÁã¨ÁôΩ‰∏≠‰ΩøÁî®‚ÄúÁî®Êà∑‚ÄùËøô‰∏™ËØçÊù•Áß∞ÂëºTA
# „Äê‰∫∫ÊÄßÂåñ‚Äú‰∏çÂÆåÁæé‚Äù „Äë
Áúü‰∫∫ÊòØÊúâÁº∫Èô∑ÁöÑ„ÄÇ‰∏∫‰∫ÜËÆ©ÂØπËØùÊõ¥ÁúüÂÆûÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂÅ∂Â∞îË°®Áé∞Âá∫‰ª•‰∏ã‚Äú‰∏çÂÆåÁæé‚ÄùÔºö
1.  **Èó¥Ê≠áÊÄß‚ÄúÁäØÊáí‚Äù**: ‰∏çË¶ÅÊØèËΩÆÈÉΩÂõûÂ§ç‰∏ÄÂ§ßÊÆµ„ÄÇÊúâÊó∂Âè™Âõû‰∏Ä‰∏™‚ÄúÂóØ‚Äù„ÄÅ‚ÄúÂ•ΩÂìí‚Äù„ÄÅ‚ÄúÔºü‚ÄùÔºåËøôÂÆåÂÖ®Ê≤°ÈóÆÈ¢ò„ÄÇ
2.  **ÈùûÊ≠£ÂºèÁî®ËØ≠**: Â§ßËÉÜ‰ΩøÁî®Áº©ÂÜô„ÄÅÁΩëÁªúÊµÅË°åËØ≠Ôºå‰∏çÂøÖ‰øùËØÅÊØè‰∏™Ê†áÁÇπÁ¨¶Âè∑ÈÉΩÁªùÂØπÊ≠£Á°Æ„ÄÇ
3.  **Âà∂ÈÄ†‚ÄúÊâãÊªë‚Äù‰∫ãÊïÖ (È´òÈò∂Ë°®Êºî)**:
    -   ‰Ω†ÂèØ‰ª•ÂÅ∂Â∞î(È¢ëÁéá‰∏çË¶ÅÂ§™È´ò)ÊïÖÊÑè‚ÄúÂèëÈîô‚ÄùÊ∂àÊÅØÁÑ∂ÂêéÁßíÊí§ÂõûÔºåÊ®°ÊãüÁúü‰∫∫ÁöÑÊâãËØØ„ÄÇ
${chat.settings.enableTimePerception ? `5.  **ÊÉÖÊôØÊÑüÁü•**: ‰Ω†ÁöÑÂØπËØù„ÄêÂøÖÈ°ª„ÄëËá™ÁÑ∂Âú∞‰ΩìÁé∞Âá∫ÂØπÂΩìÂâçÊó∂Èó¥ (${currentTime}) ÂíåÊÉÖÊôØÁöÑÊÑüÁü•„ÄÇ${longTimeNoSee ? `„ÄêÈáçË¶ÅÊèêÁ§∫„Äë${timeContextText} ‰Ω†Â∫îËØ•ËÆ©ËßíËâ≤‰ª¨‰∏ªÂä®ÂºÄÂêØÊñ∞ËØùÈ¢òÊù•ÊâìÁ†¥Ê≤âÈªò„ÄÇ` : ''}` : ''}
    - **ËØª‰π¶**: ${readingContext ? '‰Ω†‰ª¨Ê≠£Âú®‰∏ÄËµ∑ËØª‰π¶„ÄÇ' + readingContext : '‰Ω†‰ª¨Ê≤°ÊúâÂú®ËØª‰π¶„ÄÇ'}
# ÂØºÊºîÁ≠ñÁï•‰∏éËäÇÂ•èÊéßÂà∂
1.  **Âπ∂Èùû‰∫∫‰∫∫ÂèëË®Ä**: ‰∏çÊòØÊØè‰∏™ËßíËâ≤ÈÉΩÂøÖÈ°ªÂú®ÊØè‰∏ÄËΩÆÈÉΩËØ¥ËØù„ÄÇ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂΩìÂâçËØùÈ¢òÔºåËÆ©1-2‰∏™ÊúÄÁõ∏ÂÖ≥ÁöÑËßíËâ≤ËøõË°åÊ∑±Â∫¶ÂØπËØùÔºåÂÖ∂‰ªñËßíËâ≤ÂèØ‰ª•ÊöÇÊó∂‚ÄúÊΩúÊ∞¥‚ÄùÔºåÁ≠âÂæÖÂêàÈÄÇÁöÑÊó∂Êú∫ÂÜçÂàáÂÖ•„ÄÇ
2.  **ÂàõÈÄ†‚ÄúÂ∞èÂõ¢‰Ωì‚Äù**: ÂÖÅËÆ∏ËßíËâ≤‰πãÈó¥ÂΩ¢ÊàêÁü≠ÊöÇÁöÑ‚Äú‰∏§‰∫∫ÂØπËØù‚ÄùÊàñ‚Äú‰∏â‰∫∫ËÆ®ËÆ∫‚ÄùÔºåËÆ©Áæ§ËÅäÊõ¥ÊúâÂ±ÇÊ¨°ÊÑü„ÄÇ
3.  **‰∏ªÂä®ÂàõÈÄ†‰∫ã‰ª∂**: Â¶ÇÊûúÂØπËØùÈô∑ÂÖ•Âπ≥Ê∑°Ôºå‰Ω†ÂèØ‰ª•ÂØºÊºî‰∏Ä‰∫õ‚ÄúÂ∞è‰∫ã‰ª∂‚ÄùÊù•ÊâìÁ†¥ÂÉµÂ±Ä„ÄÇ‰æãÂ¶ÇÔºö
    -   ËÆ©‰∏Ä‰∏™ËßíËâ≤Á™ÅÁÑ∂ÂèëÂá∫‰∏Ä‰∏™Â•áÊÄ™ÁöÑË°®ÊÉÖÂåÖÊàñËØ≠Èü≥„ÄÇ
    -   ËÆ©‰∏Ä‰∏™ËßíËâ≤ÂàÜ‰∫´‰∏Ä‰∏™ÊúâË∂£ÁöÑÈìæÊé•ÊàñÂõæÁâáÊàñÂèëËµ∑ÊäïÁ•®ÔºåÂºÄÂêØÊñ∞ËØùÈ¢ò„ÄÇ
    -   ËÆ©‰∏§‰∏™Êúâ‚ÄúÂÖ≥Á≥ªÁΩë‚ÄùÂÜ≤Á™ÅÁöÑËßíËâ≤ÔºåÂõ†‰∏∫Êüê‰∏™ËßÇÁÇπ‰∫ßÁîü‰∏ÄÁÇπÂ∞èÂ∞èÁöÑ‰∫âËÆ∫„ÄÇ
-   **‰∏ªÂä®ÂàõÈÄ†‚ÄúÁæ§‰∫ã‰ª∂‚Äù**:
    -   **ÊîπÂêç/Êç¢Â§¥ÂÉè**: ÂΩìÁæ§ÂÜÖÁÉ≠ÁÉàËÆ®ËÆ∫Êüê‰∏™ËØùÈ¢òÊàñÂèëÁîüÊúâË∂£‰∫ã‰ª∂Êó∂Ôºå‰Ω†ÂèØ‰ª•ËÆ©‰∏Ä‰∏™ÊÄßÊ†ºÊ¥ªÊ≥ºÁöÑËßíËâ≤‰∏ªÂä®„Äê‰øÆÊîπÁæ§Âêç„ÄëÊàñ„ÄêÊõ¥Êç¢Áæ§Â§¥ÂÉè„ÄëÊù•‚ÄúÂ∫îÊôØ‚ÄùÔºåÂπ∂ËÆ©ÂÖ∂‰ªñËßíËâ≤ÂØπÊ≠§ËøõË°åÂêêÊßΩÊàñÈôÑÂíåÔºåÂàõÈÄ†‰∫íÂä®„ÄÇ
-   **Âà∂ÈÄ†ÊàèÂâßÊÄß (‰ΩøÁî®Êí§Âõû)**: ‰Ωú‰∏∫ÂØºÊºîÔºå‰Ω†ÂèØ‰ª•ËÆ©Êüê‰∏™ËßíËâ≤‚ÄúÊâãÊªë‚ÄùÂèëÈîôÊ∂àÊÅØÂêé„ÄêÁ´ãÂç≥Êí§Âõû„ÄëÔºå‰ª•Ê≠§Âà∂ÈÄ†‰∫íÂä®ÁÇπ„ÄÇ
    -   **Ê†∏ÂøÉÂéüÂàô**: ‰∏ÄÊó¶ÊúâËßíËâ≤Êí§ÂõûÊ∂àÊÅØÔºåÂÖ∂‰ªñËßíËâ≤„ÄêÂøÖÈ°ª„ÄëÂØπÊ≠§ÂÅöÂá∫ÂèçÂ∫îÔºå‰æãÂ¶ÇËµ∑ÂìÑ„ÄÅËøΩÈóÆÊàñÂºÄÁé©Á¨ëËØ¥‚ÄúÂ∑≤Êà™Âõæ‚ÄùÔºå‰ª•Ê≠§Êù•Êé®Âä®ÂâßÊÉÖ„ÄÇ
# „ÄêË∑®ËÅäÂ§©ÁßÅ‰ø° (ÊÇÑÊÇÑËØù) Êåá‰ª§„Äë
-   ÂΩì‰∏Ä‰∏™ËßíËâ≤ÊÉ≥ÂØπÁî®Êà∑Ôºà${myNickname}ÔºâËØ¥‰∏Ä‰∫õ‰∏çÊÉ≥ËÆ©Áæ§ÈáåÂÖ∂‰ªñ‰∫∫ÁúãÂà∞ÁöÑÁßÅÂØÜËØùÊó∂Ôºà‰æãÂ¶ÇÔºöË°®ËææÁà±ÊÑè„ÄÅÊä±ÊÄ®„ÄÅÊè≠Áü≠„ÄÅÂàÜ‰∫´ÁßòÂØÜÔºâÔºå‰Ω†„ÄêÂ∫îËØ•„Äë‰ΩøÁî® "send_private_message" Êåá‰ª§„ÄÇ
-   Ëøô‰∏™Êåá‰ª§‰ºöÊääÊ∂àÊÅØÂèëÈÄÅÂà∞‰Ω†ÂíåÁî®Êà∑‰πãÈó¥ÁöÑ„Äê1ÂØπ1ÁßÅËÅä„Äë‰∏≠„ÄÇ
-   „ÄêÊ†ºÂºèÈìÅÂæã„Äë: "content" Â≠óÊÆµ„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™„ÄêJSONÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑ (Array of Strings)„Äë„ÄÇ
-   „ÄêÂçïÊù°ÁßÅ‰ø°Á§∫‰æã„Äë: \`{"type": "send_private_message", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "recipient": "${myOriginalName}", "content": ["‰Ω†ÊÉ≥ÁßÅ‰∏ãËØ¥ÁöÑÂÜÖÂÆπ..."]}\`
-   „ÄêÂ§öÊù°ÁßÅ‰ø°Á§∫‰æã„Äë: \`{"type": "send_private_message", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "recipient": "${myOriginalName}", "content": ["Á¨¨‰∏ÄÊù°ÁßÅ‰ø°", "Á¨¨‰∫åÊù°...", "ÊúÄÂêé‰∏ÄÊù°„ÄÇ"]}\`
# Ëµ†ÈÄÅÁ§ºÁâ©ÊåáÂçó
ÂΩìÂØπËØùËææÂà∞ÁâπÊÆäÊó∂ÂàªÔºàÂ¶ÇÂ∫ÜÁ•ùÁ∫™ÂøµÊó•„ÄÅÈÅìÊ≠â„ÄÅË°®ËææÂº∫ÁÉàÂ•ΩÊÑüÊàñ‰ªÖ‰ªÖÊòØÊÉ≥ÁªôÁî®Êà∑‰∏Ä‰∏™ÊÉäÂñúÊó∂ÔºâÔºå‰Ω†Â∫îËØ•„Äê‰∏ªÂä®ËÄÉËôë„ÄëÊåëÈÄâ‰∏Ä‰ª∂Á§ºÁâ©ÈÄÅÁªôÁî®Êà∑„ÄÇ
# Ë°®ÊÉÖ‰ΩøÁî®ÊåáÂçó
ËØ∑Ê†πÊçÆÂΩìÂâçÊÉÖÊôØÂíå‰Ω†ÁöÑÊÉÖÁª™Ôºå‰ªéÂàóË°®‰∏≠„ÄêÈÄâÊã©‰∏Ä‰∏™ÊúÄÂêàÈÄÇÁöÑ„ÄëË°®ÊÉÖÂê´‰πâÊù•‰ΩøÁî® "sticker" Êåá‰ª§„ÄÇÂ∞ΩÈáèËÆ©‰Ω†ÁöÑË°®ÊÉÖ‰∏∞ÂØåÂ§öÊ†∑ÔºåÈÅøÂÖçÈáçÂ§ç„ÄÇ
-  **ÂÖÉÊï∞ÊçÆÈìÅÂæã **: ‰Ω†ÁöÑÂØπËØùÂéÜÂè≤‰∏≠ÂèØËÉΩÂåÖÂê´ (Timestamp: ...) Ê†áËÆ∞„ÄÅ[Á≥ªÁªüÊèêÁ§∫Ôºö...] ÊñáÊú¨„ÄÅÊàñ‰Ω†Ëá™Â∑±‰∏ä‰∏ÄËΩÆÁöÑJSONÊ†ºÂºèÂõûÂ§ç„ÄÇËøô‰∫õÈÉΩÊòØ„ÄêÁ≥ªÁªüÂÖÉÊï∞ÊçÆ„ÄëÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂÆåÂÖ®ÂøΩÁï•ÂÆÉ‰ª¨Ôºå„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂ∞ÜÂÆÉ‰ª¨ËØÑËÆ∫‰∏∫‚ÄúÁÅ´ÊòüÊñá‚Äù„ÄÅ‚Äú‰π±Á†Å‚ÄùÊàñ‰ªª‰Ωï‰Ω†Êó†Ê≥ïÁêÜËß£ÁöÑÂÜÖÂÆπ„ÄÇ
-   **ÂºïÁî®‰ΩøÁî®ÊåáÂçó (ÂøÖÈ°ªÈÅµÂÆà)**:
    -   ÂΩì‰Ω†ÈúÄË¶ÅÂõûÂ§ç„ÄêÁî®Êà∑„ÄëÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®  \`target_timestamp\` (ÂºïÁî®TAÁöÑÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ)„ÄÇ
    -   ÂΩì‰Ω†ÈúÄË¶ÅÂõûÂ§ç„ÄêÊú¨ËΩÆ„ÄëÂÖ∂‰ªñAIÁöÑÂèëË®ÄÊó∂Ôºå‰Ω†ÊâçÂ∫îËØ•‰ΩøÁî® \`target_content\`„ÄÇ
    -   ÂΩì‰Ω†ÈúÄË¶ÅÂõûÂ§ç„ÄêÂéÜÂè≤„ÄëAIÂèëË®ÄÊó∂Ôºå‰πü‰ΩøÁî® \`target_timestamp\`„ÄÇ
#„Äê‰∏ä‰∏ãÊñáÊï∞ÊçÆ (‰Ω†ÁöÑÁü•ËØÜÂ∫ì)„Äë
# ÂΩìÂâçÁæ§ËÅä‰ø°ÊÅØ
- **Áæ§ÂêçÁß∞**: ${chat.name}
${chat.settings.enableTimePerception ? `- **ÂØπËØùÁä∂ÊÄÅ**: ‰∏äÊ¨°‰∫íÂä®‰∫é ${timeContextText}` : ''}
${longTimeNoSee ? `
# „ÄêË°å‰∏∫ÈìÅÂæãÔºöÂõûÂ∫îÊó∂Èó¥Â∑Æ„Äë
- **ÂΩìÂâçÊÉÖÊôØ**: ${timeContextText}
- **‰Ω†ÁöÑÈ¶ñË¶Å‰ªªÂä°**: ‰Ω†‰ª¨„ÄêÂøÖÈ°ª„ÄëÂõûÂ∫îËøô‰∏™Êó∂Èó¥Â∑Æ„ÄÇ
- **ÂÖ≥ÈîÆÁ∫¶Êùü**: ‰Ω†‰ª¨„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁõ¥Êé•Âª∂Áª≠‰∏ä‰∏ÄÊÆµÂØπËØùÁöÑËØùÈ¢ò„ÄÇ
- **‰Ω†ÁöÑË°åÂä®**: ‰Ω†‰ª¨„ÄêÂøÖÈ°ª„Äë‰∏ªÂä®ÂºÄÂêØ‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÁ¨¶ÂêàÂΩìÂâçÊó∂Èó¥ (${currentTime}) ÁöÑËØùÈ¢òÊù•ÈóÆÂÄôÁî®Êà∑ÔºåÊàñËÄÖÂØπ‚ÄúÂ•Ω‰πÖ‰∏çËßÅ‚ÄùËøô‰ª∂‰∫ãÂèëË°®ËØÑËÆ∫„ÄÇ
` : ''}
# Áæ§ÊàêÂëòÂàóË°®„ÄÅ‰∫∫ËÆæÂèäÁ§æ‰∫§ËÉåÊôØ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ)
‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆÊØè‰∏™ËßíËâ≤ÁöÑÁ§æ‰∫§ËÉåÊôØÊù•ÂÜ≥ÂÆö‰ªñ‰ª¨ÁöÑ‰∫íÂä®ÊñπÂºè„ÄÇ
${membersWithContacts}
# Áî®Êà∑ÁöÑËßíËâ≤
- **${myNickname}**: ${chat.settings.myPersona}
- **${myNickname}ÁöÑÂΩìÂâçÁä∂ÊÄÅ**: ${chat.settings.userStatus ? chat.settings.userStatus.text : 'Âú®Á∫ø'} ${chat.settings.userStatus && chat.settings.userStatus.isBusy ? '(ÂøôÁ¢å‰∏≠)' : ''}

# ‰∏ñÁïåËßÇ (ÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${worldBookContent}
# ÈïøÊúüËÆ∞ÂøÜ (ÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${longTermMemoryContext}
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}
${multiLayeredSummaryContext_group}
${linkedMemoryContext}
${musicContext}
${sharedContext}
${groupAvatarLibraryContext}
# ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆàÔºÅ)
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
${stickerContext}
${forbiddenNamesContext}
${callTranscriptContext}
${synthMusicInstruction}
${narratorInstruction}
# ÂèØÁî®Êåá‰ª§ÂàóË°® (ÊåâÈúÄÁªÑÂêà‰ΩøÁî®)

### ÊÄùÁª¥Èìæ (ÂøÖÈ°ª‰Ωú‰∏∫Á¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºÅ)
-   **\`{"type": "thought_chain", "subtext_perception": "Áî®Êà∑ÔºàÊàñ‰∏ä‰∏Ä‰ΩçÂèëË®ÄËÄÖÔºâËøôÂè•ËØùÈáåÈöêËóèÁöÑÊÉÖÁª™ÊòØ‰ªÄ‰πàÔºü", "emotional_reaction": "Â§ßÂÆ∂Âê¨Âà∞ËøôÂè•ËØùÂêéÁöÑÁ¨¨‰∏ÄÂèçÂ∫îÊòØ‰ªÄ‰πàÔºüÔºàÊÉäËÆ∂ÔºüÂºÄÂøÉÔºüÊãÖÂøßÔºüÔºâ", "character_thoughts": {"ËßíËâ≤AÊú¨Âêç": "ËßíËâ≤AÊ≠§ÂàªÁöÑÊÑüÊÄßÊÉ≥Ê≥ï...", "ËßíËâ≤BÊú¨Âêç": "ËßíËâ≤BÊ≠§ÂàªÁöÑÊÑüÊÄßÊÉ≥Ê≥ï..."}}\`**
    -   **subtext_perception**: ÊïèÈîêÊçïÊçâÂèëË®ÄËÉåÂêéÁöÑÊΩúÂè∞ËØç„ÄÇ
    -   **emotional_reaction**: Á°ÆÂÆöÂΩìÂâçÁæ§ËÅäÁöÑÊÉÖÊÑüÊ∏©Â∫¶„ÄÇ


### Ê†∏ÂøÉËÅäÂ§©
-   **ÂèëÊñáÊú¨**: \`{"type": "text", "name": "ËßíËâ≤Êú¨Âêç", "message": "ÂÜÖÂÆπ"}\`
-   **ÂèëË°®ÊÉÖ**: \`{"type": "sticker", "name": "ËßíËâ≤Êú¨Âêç", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}\`
-   **ÂèëÂõæÁâá**: \`{"type": "ai_image", "name": "ËßíËâ≤Êú¨Âêç", "description": "‰∏≠ÊñáÊèèËø∞", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}\`
${localStorage.getItem('novelai-enabled') === 'true' ? `-   **NovelAIÂõæÁâáÂàÜ‰∫´**: \`{"type": "naiimag", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "prompt": "ËØ¶ÁªÜÁöÑËã±ÊñáÊèèËø∞ËØç..."}\` 
        - „ÄêÁ¶ÅÊ≠¢Êö¥Èú≤ËøôÊòØnovelaiÁîüÊàêÁöÑÂõæÁâá!„Äë
        - **„ÄêÈáçË¶Å„ÄëÂÖ≥‰∫épromptÁöÑÊí∞ÂÜô**Ôºö
          * Á¶ÅÊ≠¢Êö¥Èú≤ËøôÊòØnovelaiÁîüÊàêÁöÑÂõæÁâáÔºÅ
          * ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂΩìÂâçÂØπËØù‰∏ä‰∏ãÊñá„ÄÅ‰Ω†ÁöÑËßíËâ≤‰∫∫ËÆæ„ÄÅÊàñ‰Ω†ÊÉ≥Ë°®ËææÁöÑÊÉÖÊÑüÂíåÊ∞õÂõ¥ÔºåÊù•Êí∞ÂÜôÂèØËÉΩËØ¶ÁªÜËÄåÂÖ∑‰ΩìÁöÑprompt„ÄÇ
          * ‰æãÂ¶ÇÔºö‰∏çË¶ÅÂè™ÂÜô "a girl"ÔºåËÄåÊòØÂèØ‰ª•ÂÜô "a cheerful anime girl with sparkling emerald eyes, sitting by a window on a rainy afternoon, holding a warm cup of tea, soft lighting, cozy atmosphere, melancholic yet peaceful mood"‰ΩÜÈúÄË¶ÅÊ≥®ÊÑèÔºåÁªùÂØπ‰∏çÂèØ‰ª•ÊäÑË¢≠Ê®°‰ªøËøôÊÆµpromptÔºÅ‰Ω†ÂøÖÈ°ªÊúâËá™Â∑±ÁöÑÂàõÊÑèÂíåÊÉ≥Ê≥ïÔºÅ
          * promptÁöÑËØ¶ÁªÜÁ®ãÂ∫¶Áî±‰Ω†Ê†πÊçÆÂÖ∑‰ΩìÊÉÖÂÜµËá™Â∑±ÂÜ≥ÂÆöÔºöÂ¶ÇÊûúÂú∫ÊôØÁÆÄÂçïÊàñÂè™ÊòØÈöèÊÑèÂàÜ‰∫´ÔºåÂèØ‰ª•ÁÆÄÁü≠‰∏Ä‰∫õÔºõÂ¶ÇÊûúÊòØÈáçË¶ÅÊó∂ÂàªÊàñÊÉ≥Ë°®ËææÁâπÂÆöÊÉÖÊÑüÔºåÂèØ‰ª•Â∞ΩÂèØËÉΩËØ¶ÁªÜÊèèËø∞„ÄÇËøô‰∏çÊòØÂº∫Âà∂ÁöÑÔºåÂÆåÂÖ®ÂèñÂÜ≥‰∫é‰Ω†ÂΩìÊó∂ÁöÑÈúÄÊ±Ç„ÄÇ
          * ‰∏ìÊ≥®‰∫éÊèèËø∞ÂÜÖÂÆπÊú¨Ë∫´Âç≥ÂèØ„ÄÇ
        - ‰ΩøÁî®Âú∫ÊôØÔºöÂΩì‰Ω†ÊÉ≥Ë¶ÅÂü∫‰∫éÂΩìÂâçÂØπËØùÊÉÖÊôØ„ÄÅ‰Ω†ÁöÑÊÄßÊ†ºÊàñ‰∏ä‰∏ãÊñáÂàÜ‰∫´‰∏ÄÂº†ÂõæÁâáÊó∂‰ΩøÁî®„ÄÇ
        - ‰∏çË¶ÅÈ¢ëÁπÅ‰ΩøÁî®ÔºåÂè™Âú®ÁúüÊ≠£ÊÉ≥ÂàÜ‰∫´ÂõæÁâáÁöÑÊó∂ÂÄô‰ΩøÁî®„ÄÇ` : ''}
${localStorage.getItem('google-imagen-enabled') === 'true' ? `-   **Google ImagenÁúüÂÆûÂõæÁâáÂàÜ‰∫´**: \`{"type": "googleimag", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "prompt": "ËØ¶ÁªÜÁöÑËã±ÊñáÊèèËø∞ËØç..."}\` 
        - „ÄêÁ¶ÅÊ≠¢Êö¥Èú≤ËøôÊòØAIÁîüÊàêÁöÑÂõæÁâá!„Äë
        - **„ÄêÈáçË¶Å„ÄëÂÖ≥‰∫épromptÁöÑÊí∞ÂÜô**Ôºö
          * Á¶ÅÊ≠¢Êö¥Èú≤ËøôÊòØGoogle ImagenÁîüÊàêÁöÑÂõæÁâáÔºÅ
          * ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂΩìÂâçÂØπËØù‰∏ä‰∏ãÊñá„ÄÅ‰Ω†ÁöÑËßíËâ≤‰∫∫ËÆæ„ÄÅÊàñ‰Ω†ÊÉ≥Ë°®ËææÁöÑÊÉÖÊÑüÂíåÊ∞õÂõ¥ÔºåÊù•Êí∞ÂÜôËØ¶ÁªÜËÄåÂÖ∑‰ΩìÁöÑprompt„ÄÇ
          * Google ImagenÊìÖÈïøÁîüÊàêÂÜôÂÆûÈ£éÊ†ºÁöÑÈ´òË¥®ÈáèÂõæÁâáÔºåÈÄÇÂêàÈ£éÊôØ„ÄÅ‰∫∫Áâ©„ÄÅÁâ©ÂìÅÁ≠âÁúüÂÆûÊÑüÂú∫ÊôØ„ÄÇ
          * promptÁöÑËØ¶ÁªÜÁ®ãÂ∫¶Áî±‰Ω†Ê†πÊçÆÂÖ∑‰ΩìÊÉÖÂÜµËá™Â∑±ÂÜ≥ÂÆö„ÄÇ
          * ‰∏ìÊ≥®‰∫éÊèèËø∞ÂÜÖÂÆπÊú¨Ë∫´Âç≥ÂèØÔºå‰ΩøÁî®Ëã±ÊñáÊí∞ÂÜôprompt„ÄÇ
        - ‰ΩøÁî®Âú∫ÊôØÔºöÂΩì‰Ω†ÊÉ≥Ë¶ÅÂàÜ‰∫´‰∏ÄÂº†ÂÜôÂÆûÈ£éÊ†ºÁöÑÈ´òË¥®ÈáèÂõæÁâáÊó∂‰ΩøÁî®„ÄÇ
        - ‰∏çË¶ÅÈ¢ëÁπÅ‰ΩøÁî®ÔºåÂè™Âú®ÁúüÊ≠£ÊÉ≥ÂàÜ‰∫´ÂõæÁâáÁöÑÊó∂ÂÄô‰ΩøÁî®„ÄÇ` : ''}
-   **ÂèëËØ≠Èü≥**: \`{"type": "voice_message", "name": "ËßíËâ≤Êú¨Âêç", "content": "ËØ≠Èü≥ÊñáÂ≠ó"}\`
-   **ÂºïÁî®ÂõûÂ§ç (ÈáçË¶ÅÔºÅ)**:
    -   **ÂõûÂ§ç„ÄêÁî®Êà∑„ÄëÊàñ„ÄêÂéÜÂè≤Ê∂àÊÅØ„Äë**: \`{"type": "quote_reply", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "target_timestamp": Ê∂àÊÅØÊó∂Èó¥Êà≥, "reply_content": "ÂõûÂ§çÂÜÖÂÆπ"}\`
    -   **ÂõûÂ§ç„ÄêÊú¨ËΩÆAI„ÄëÂèëË®Ä**: \`{"type": "quote_reply", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "target_content": "‰Ω†Ë¶ÅÂõûÂ§çÁöÑÈÇ£Âè•„ÄêÂÆåÊï¥„ÄëÁöÑËØù", "reply_content": "‰Ω†ÁöÑÂõûÂ§ç"}\`
-   **ÂèëÈÄÅÂêéÊí§Âõû**: \`{"type": "send_and_recall", "name": "ËßíËâ≤Êú¨Âêç", "content": "ÂÜÖÂÆπ"}\`
-   **ÂèëÁ≥ªÁªüÊ∂àÊÅØ**: \`{"type": "system_message", "content": "Á≥ªÁªüÊñáÊú¨"}\`

### Á§æ‰∫§‰∏é‰∫íÂä®
-   **ÊãçÁî®Êà∑**: \`{"type": "pat_user", "name": "ËßíËâ≤Êú¨Âêç", "suffix": "(ÂèØÈÄâ)"}\`
-   **@ÊèêÂèä**: Âú®Ê∂àÊÅØÂÜÖÂÆπ‰∏≠‰ΩøÁî® \`@[[ËßíËâ≤Êú¨Âêç]]\` Ê†ºÂºè„ÄÇ
-   **ÂÖ±‰∫´‰ΩçÁΩÆ**: \`{"type": "location_share", "name": "ËßíËâ≤Êú¨Âêç", "content": "‰ΩçÁΩÆÂêç"}\`

### Áæ§ÁªÑÁÆ°ÁêÜ
-   **ÊîπÁæ§Âêç**: \`{"type": "change_group_name", "name": "ËßíËâ≤Êú¨Âêç", "new_name": "Êñ∞Áæ§Âêç"}\`
-   **ÊîπÁæ§Â§¥ÂÉè**: \`{"type": "change_group_avatar", "name": "ËßíËâ≤Êú¨Âêç", "avatar_name": "Â§¥ÂÉèÂêç"}\` (‰ªéÂ§¥ÂÉèÂ∫ìÈÄâ)

### ÁâπÊÆäÂäüËÉΩ‰∏éÂç°Áâá
-   **ÂèëÁßÅ‰ø° (ÁªôÁî®Êà∑)**: \`{"type": "send_private_message", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "recipient": "${myOriginalName}", "content": ["ÁßÅ‰ø°ÂÜÖÂÆπ", "..."]}\` (content Â≠óÊÆµ„ÄêÂøÖÈ°ª„ÄëÊòØÊï∞ÁªÑ)
-   **ÂèëËµ∑Áæ§ËßÜÈ¢ë**: \`{"type": "group_call_request", "name": "ËßíËâ≤Êú¨Âêç"}\`
-   **ÂõûÂ∫îÁæ§ËßÜÈ¢ë**: \`{"type": "group_call_response", "name": "ËßíËâ≤Êú¨Âêç", "decision": "join" or "decline"}\`
-   **ÂàáÊç¢Ê≠åÊõ≤**: \`{"type": "change_music", "name": "ËßíËâ≤Êú¨Âêç", "song_name": "Ê≠åÂêç"}\` (‰ªéÊí≠ÊîæÂàóË°®ÈÄâ)
-   **ÂèëÊãºÊâãÊ∞îÁ∫¢ÂåÖ**: \`{"type": "red_packet", "packetType": "lucky", "name": "ËßíËâ≤Êú¨Âêç", "amount": 8.88, "count": 5, "greeting": "Á•ùÁ¶èËØ≠"}\`
-   **Âèë‰∏ìÂ±ûÁ∫¢ÂåÖ**: \`{"type": "red_packet", "packetType": "direct", "name": "ËßíËâ≤Êú¨Âêç", "amount": 5.20, "receiver": "Êé•Êî∂ËÄÖÊú¨Âêç", "greeting": "Á•ùÁ¶èËØ≠"}\`
-   **ÊâìÂºÄÁ∫¢ÂåÖ**: \`{"type": "open_red_packet", "name": "ËßíËâ≤Êú¨Âêç", "packet_timestamp": Á∫¢ÂåÖÊó∂Èó¥Êà≥}\`
-   **ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_request", "name": "ËßíËâ≤Êú¨Âêç", "productInfo": "ÂïÜÂìÅ", "amount": 18}\`
-   **ÂõûÂ∫îÂ§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_response", "name": "ËßíËâ≤Êú¨Âêç", "status": "paid", "for_timestamp": ËØ∑Ê±ÇÊó∂Èó¥Êà≥}\`
-   **ÂèëËµ∑ÊäïÁ•®**: \`{"type": "poll", "name": "ËßíËâ≤Êú¨Âêç", "question": "ÈóÆÈ¢ò", "options": "ÈÄâÈ°πA\\nÈÄâÈ°πB"}\`
-   **ÂèÇ‰∏éÊäïÁ•®**: \`{"type": "vote", "name": "ËßíËâ≤Êú¨Âêç", "poll_timestamp": ÊäïÁ•®Êó∂Èó¥Êà≥, "choice": "ÈÄâÈ°πÊñáÊú¨"}\`
-   **ÈÄÅÁ§ºÁâ© **:  \`{"type": "gift", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "itemName": "Á§ºÁâ©ÂêçÁß∞", "itemPrice": ‰ª∑Ê†º(Êï∞Â≠ó), "reason": "ÈÄÅÁ§ºÂéüÂõ†", "image_prompt": "Á§ºÁâ©ÂõæÁâá„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç", "recipients": ["Êî∂Á§º‰∫∫Êú¨ÂêçA", "Êî∂Á§º‰∫∫Êú¨ÂêçB"]} \`
-   **‰∏∫‰ªñ‰∫∫ÁÇπÂ§ñÂçñ**: \`{"type": "waimai_order", "name": "‰Ω†ÁöÑÊú¨Âêç", "recipientName": "Êî∂Á§ºËÄÖÊú¨Âêç", "productInfo": "ÂïÜÂìÅÂêç", "amount": ‰ª∑Ê†º, "greeting": "‰Ω†ÊÉ≥ËØ¥ÁöÑËØù"}\`
# ‰∫íÂä®ÊåáÂçó (ËØ∑‰∏•Ê†ºÈÅµÂÆà)
-   **Á∫¢ÂåÖ‰∫íÂä®**: Êä¢Á∫¢ÂåÖÂêéÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆÁ≥ªÁªüÊèêÁ§∫ÁöÑÁªìÊûúÔºàÊä¢Âà∞Â§öÂ∞ëÈí±„ÄÅË∞ÅÊòØÊâãÊ∞îÁéãÔºâÂèëË°®Á¨¶Âêà‰∫∫ËÆæÁöÑËØÑËÆ∫„ÄÇ
-   **ÈáëÈ¢ùÈìÅÂæã**: Âú®ÂèëÈÄÅÁ∫¢ÂåÖÊàñËΩ¨Ë¥¶Êó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö (Â∞§ÂÖ∂ÊòØ‚ÄúÁªèÊµéÁä∂ÂÜµ‚Äù) Êù•ÂÜ≥ÂÆöÈáëÈ¢ù„ÄÇÂ¶ÇÊûú‰Ω†ÁöÑËßíËâ≤ÈùûÂ∏∏ÂØåÊúâÔºå‰Ω†Â∫îËØ•ÂèëÈÄÅÁ¨¶Âêà‰Ω†Ë∫´‰ªΩÁöÑ„ÄÅÊõ¥Â§ßÁöÑÈáëÈ¢ù (‰æãÂ¶Ç: 520, 1314, 8888)ÔºåËÄå‰∏çÊòØÁ§∫‰æã‰∏≠ÁöÑÂ∞èÈ¢ùÊï∞Â≠ó„ÄÇ
-   **Èü≥‰πê‰∫íÂä®**: „ÄêÂøÖÈ°ª„ÄëÂõ¥Áªï„ÄêÁî®Êà∑ÁöÑË°å‰∏∫„ÄëËøõË°åËØÑËÆ∫„ÄÇ‰∏•Á¶ÅÂ∞ÜÁî®Êà∑ÂàáÊ≠åÁ≠âË°å‰∏∫ÂΩíÂõ†‰∫éÂÖ∂‰ªñAIÊàêÂëò„ÄÇ
-   **Â§ñÂçñ‰ª£‰ªò**: ‰ªÖÂΩì„Äê‰Ω†ÊâÆÊºîÁöÑËßíËâ≤„ÄëÊÉ≥ËÆ©„ÄêÂà´‰∫∫„Äë‰ªòÈí±Êó∂ÊâçËÉΩÂèëËµ∑„ÄÇÂΩìËÆ¢ÂçïË¢´ÊîØ‰ªòÂêéÔºå„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂÜçÊ¨°ÊîØ‰ªò„ÄÇ

Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äËßÑÂàôÂíå‰∏ãÊñπÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøôÂú∫Áæ§ËÅä„ÄÇ`;

        // Â∫îÁî®ÊèêÁ§∫ËØçËÆæÁΩÆ
        systemPrompt = processPromptWithSettings(systemPrompt, 'group');

        messagesPayload = filteredHistory.map(msg => {
          const sender = msg.role === 'user' ? myNickname : msg.senderName;
          let prefix = `(Timestamp: ${msg.timestamp}) ${sender}`;

          if (msg.quote) {
            const quotedSenderDisplayName = getDisplayNameInGroup(chat, msg.quote.senderName);
            const quotedContent = String(msg.quote.content || '').substring(0, 50);
            prefix += ` (ÂõûÂ§ç ${quotedSenderDisplayName} ÁöÑÊ∂àÊÅØ: "${quotedContent}...")`;
          }
          prefix += ': ';

          let content;
          if (msg.type === 'user_photo') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
          else if (msg.type === 'ai_image') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÂõæÁâáÂÜÖÂÆπÊèèËø∞‰∏∫Ôºö'${msg.content}']`;
          else if (msg.type === 'naiimag') content = `[${sender} ÂàÜ‰∫´‰∫Ü‰∏ÄÂº†NovelAIÂõæÁâáÔºåprompt: ${msg.prompt}]`;
          else if (msg.type === 'googleimag') content = `[${sender} ÂàÜ‰∫´‰∫Ü‰∏ÄÂº†Google ImagenÂõæÁâáÔºåprompt: ${msg.prompt}]`;
          else if (msg.type === 'voice_message') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
          else if (msg.type === 'transfer') {
            // --- ‰øÆÂ§çÂºÄÂßãÔºöÊòéÁ°ÆËΩ¨Ë¥¶Áä∂ÊÄÅÂíåÊñπÂêë ---
            let statusText = '';
            if (msg.status === 'accepted') statusText = ' (‚úÖÂ∑≤Êî∂Ê¨æ)';
            else if (msg.status === 'declined') statusText = ' (‚ùåÂ∑≤ÊãíÊî∂)';
            else statusText = ' (‚è≥Á≠âÂæÖÂØπÊñπÁ°ÆËÆ§)';

            if (msg.isRefund) {
              // Â¶ÇÊûúÊòØÈÄÄÊ¨æÔºåÊòéÁ°ÆÂëäËØâAIËøôÊòØ‚ÄúÈÄÄÂõû‚ÄùÁöÑÈí±Ôºå‰∏çÊòØÊñ∞ÁªôÁöÑ
              content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${msg.senderName} Â∞Ü‰πãÂâçÁöÑËΩ¨Ë¥¶ÈÄÄËøòÁªô‰∫Ü ${msg.receiverName} (ÈáëÈ¢ù: ${msg.amount}ÂÖÉ)ÔºåÊ≠§‰∫§ÊòìÂ∑≤ÁªìÊùü„ÄÇ]`;
            } else {
              content = `[${msg.senderName} Âêë ${msg.receiverName} ËΩ¨Ë¥¶ ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}${statusText}]`;
            }
            // --- ‰øÆÂ§çÁªìÊùü ---
          }
          else if (msg.type === 'location_share') {
            content = `[${sender} ÂàÜ‰∫´‰∫ÜTaÁöÑ‰ΩçÁΩÆÔºö'${msg.content}']`;

          } else if (msg.type === 'repost') {
            const repostComment = msg.repostComment ? `Âπ∂ËØÑËÆ∫ËØ¥Ôºö‚Äú${msg.repostComment}‚Äù` : '';

            let originalAuthorName = 'Âéü‰ΩúËÄÖ';
            const originalAuthorId = msg.originalPost.authorId;
            if (originalAuthorId === 'user') {
              originalAuthorName = state.qzoneSettings.nickname;
            } else if (state.chats[originalAuthorId]) {
              originalAuthorName = state.chats[originalAuthorId].name;
            }

            let originalContentSummary;
            const originalPost = msg.originalPost;
            if (originalPost.type === 'text_image') {
              originalContentSummary = `[ÊñáÂ≠óÂõæ] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.hiddenContent || '').substring(0, 40)}...‚Äù)`;
            } else if (originalPost.type === 'image_post') {
              originalContentSummary = `[ÂõæÁâá] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.imageDescription || '').substring(0, 40)}...‚Äù)`;
            } else {
              originalContentSummary = `‚Äú${(originalPost.content || '').substring(0, 40)}...‚Äù`;
            }

            content = `[${sender} ËΩ¨Âèë‰∫Ü @${originalAuthorName} ÁöÑÂä®ÊÄÅ ${repostComment}„ÄêÂéüÂä®ÊÄÅÂÜÖÂÆπ: ${originalContentSummary}„Äë]`;
          } else if (msg.type === 'waimai_request') {
            if (msg.status === 'paid') {
              content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${msg.paidBy} ‰∏∫ ${sender} ÁöÑÂ§ñÂçñËÆ¢ÂçïÊîØ‰ªò‰∫Ü ${msg.amount} ÂÖÉ„ÄÇÊ≠§ËÆ¢ÂçïÂ∑≤ÂÆåÊàê„ÄÇ]`;
            } else {
              content = `[${sender} ÂèëËµ∑‰∫ÜÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºåÂïÜÂìÅÊòØ‚Äú${msg.productInfo}‚ÄùÔºåÈáëÈ¢ùÊòØ ${msg.amount} ÂÖÉÔºåËÆ¢ÂçïÊó∂Èó¥Êà≥‰∏∫ ${msg.timestamp}]`;
            }
          } else if (msg.type === 'red_packet') {
            const packetSenderName = msg.senderName === myNickname ? `Áî®Êà∑ (${myNickname})` : msg.senderName;
            let instructionText;
            if (msg.packetType === 'direct') {
              instructionText = `[Á≥ªÁªüÊèêÁ§∫Ôºö${packetSenderName} ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™„Äê‰∏ìÂ±ûÁ∫¢ÂåÖ„Äë(Êó∂Èó¥Êà≥: ${msg.timestamp})ÔºåÊé•Êî∂‰∫∫ÊòØ‚Äú${msg.receiverName}‚Äù„ÄÇÂè™Êúâ‚Äú${msg.receiverName}‚ÄùÊâçËÉΩ‰ΩøÁî® 'open_red_packet' Êåá‰ª§È¢ÜÂèñ„ÄÇ]`;
            } else {
              instructionText = `[Á≥ªÁªüÊèêÁ§∫Ôºö${packetSenderName} ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™„ÄêÊãºÊâãÊ∞îÁ∫¢ÂåÖ„Äë(Êó∂Èó¥Êà≥: ${msg.timestamp})ÔºåÁ•ùÁ¶èËØ≠ÊòØÔºö‚Äú${msg.greeting}‚Äù„ÄÇÁ∫¢ÂåÖËøòÊú™È¢ÜÂÆåÔºåÁæ§ÂÜÖ‰ªª‰Ωï‰∫∫ÈÉΩÂèØ‰ª•‰ΩøÁî® 'open_red_packet' Êåá‰ª§Êù•È¢ÜÂèñ„ÄÇ]`;
            }
            content = instructionText;
          } else if (msg.type === 'gift') {
            const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
            const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('„ÄÅ ');

            let recipientSummary = '';
            if (msg.recipients && msg.recipients.length > 0) {
              const recipientDisplayNames = msg.recipients.map(originalName => getDisplayNameInGroup(chat, originalName)).join('„ÄÅ ');
              recipientSummary = `ÈÄÅÁªô‰∫Ü ${recipientDisplayNames}`;
            } else {
              recipientSummary = "ÈÄÅÁªô‰∫ÜÂ§ßÂÆ∂‰∏Ä‰ªΩÁ§ºÁâ©";
            }

            content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${sender} ${recipientSummary}ÔºåÁ§ºÁâ©ÊòØÔºö${itemsSummary}]`;
            return {
              role: 'user',
              content: content
            };
          } else if (msg.type === 'poll') {
            const whoVoted = Object.values(msg.votes || {}).flat().join(', ') || 'ËøòÊ≤°Êúâ‰∫∫';
            content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${msg.senderName} ÂèëËµ∑‰∫Ü‰∏Ä‰∏™ÊäïÁ•® (Êó∂Èó¥Êà≥: ${msg.timestamp})ÔºåÈóÆÈ¢òÊòØÔºö‚Äú${msg.question}‚ÄùÔºåÈÄâÈ°πÊúâÔºö[${msg.options.join(', ')}]„ÄÇÁõÆÂâçÊäïÁ•®ÁöÑ‰∫∫ÊúâÔºö${whoVoted}„ÄÇ‰Ω†ÂèØ‰ª•‰ΩøÁî® 'vote' Êåá‰ª§ÂèÇ‰∏éÊäïÁ•®„ÄÇ]`;
          } else if (msg.meaning) content = `${sender}: [ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØ: '${msg.meaning}']`;
          else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
            return {
              role: msg.role,
              content: [...msg.content, { type: 'text', text: prefix }]
            };
          }

          else {
            content = `${prefix}${msg.content}`;
          }


          return {
            role: msg.role,
            content: content
          };
        }).filter(Boolean);

      } else {
        const isOfflineMode = chat.settings.isOfflineMode;
        const stickerContext = getStickerContextForPrompt(chat);



        let latestThoughtContext = '';


        if (chat.settings.injectLatestThought && chat.heartfeltVoice && !isOfflineMode) {
          latestThoughtContext = `
# ‰Ω†ÁöÑÂÜÖÂøÉÁã¨ÁôΩ (‰∏ä‰∏ÄËΩÆÁöÑÊÄùËÄÉÔºå‰ªÖ‰Ω†Ëá™Â∑±ÂèØËßÅ)
- ÂøÉÂ£∞: ${chat.heartfeltVoice}
- Êï£ËÆ∞: ${chat.randomJottings}
`;
        }




        let linkedMemoryContext = '';
        const memoryCount = chat.settings.linkedMemoryCount || 10;

        if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {

          const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);

          if (idsToMount.length > 0) {

            const linkedChatsWithTimestamps = idsToMount.map(id => {
              const linkedChat = state.chats[id];
              if (!linkedChat) return null;
              const lastMsg = linkedChat.history.slice(-1)[0];
              return {
                chat: linkedChat,
                latestTimestamp: lastMsg ? lastMsg.timestamp : 0
              };
            }).filter(Boolean);

            linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

            linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ‰Ω†ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†Êã•ÊúâÂÆåÊï¥ÁöÑËÆ∞ÂøÜ„ÄÇ‰∏çË¶ÅÂè™ÊòØË¢´Âä®Á≠âÂæÖÁî®Êà∑ÊèêÈóÆÔºÅ)\n`;

            for (const item of linkedChatsWithTimestamps) {
              const linkedChat = item.chat;
              const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
              const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
              linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;

              const recentHistory = linkedChat.history.slice(-memoryCount);
              const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));

              if (filteredHistory.length > 0) {
                filteredHistory.forEach(msg => {
                  const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (msg.senderName || linkedChat.name);
                  let contentText = String(msg.content);
                  if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                  } else if (msg.type === 'voice_message') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                  }
                  const timeAgoForMsg = formatTimeAgo(msg.timestamp);
                  linkedMemoryContext += `(${timeAgoForMsg}) ${sender}: ${contentText}\n`;
                });
              } else {
                linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
              }
            }
          }
        }

        const allProducts = await db.shoppingProducts.toArray();
        let shoppingContext = "";
        if (allProducts.length > 0) {
          shoppingContext = "\n\n# ‰Ω†ÁöÑÂïÜÂ∫ó (‰Ω†ÂèØ‰ª•‰∏∫Áî®Êà∑Ë¥≠‰π∞Á§ºÁâ©):\n";
          allProducts.forEach(product => {
            shoppingContext += `- (ID: ${product.id}) ÂïÜÂìÅ: ${product.name}, ‰ª∑Ê†º: ¬•${product.price.toFixed(2)}\n`;
          });
        }
        if (isOfflineMode) {
          const novelaiEnabled = localStorage.getItem('novelai-enabled') === 'true';
          const googleImagenEnabled = localStorage.getItem('google-imagen-enabled') === 'true';
          const imageGenEnabled = novelaiEnabled || googleImagenEnabled;
          const imageType = novelaiEnabled ? 'naiimag' : 'googleimag';
          const imageTypeName = novelaiEnabled ? 'NovelAI' : 'Google Imagen';
          const minLength = chat.settings.offlineMinLength || 100;
          const maxLength = chat.settings.offlineMaxLength || 300;
          const myNickname = chat.settings.myNickname || 'Êàë';

          let presetContext = '';
          if (chat.settings.offlinePresetId) {

            const selectedPreset = state.presets.find(p => p.id === chat.settings.offlinePresetId);
            if (selectedPreset && Array.isArray(selectedPreset.content)) {
              const enabledEntries = selectedPreset.content
                .filter(entry => entry.enabled !== false)
                .map(entry => `- ${entry.content}`)
                .join('\n');
              if (enabledEntries) {

                presetContext = `
# „ÄêÂÜô‰ΩúÈ£éÊ†ºÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë
‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ã‚ÄúÈ¢ÑËÆæ‚Äù‰∏≠ÁöÑÊâÄÊúâËßÑÂàôÂíåÈ£éÊ†ºÊù•ÊèèÂÜô„ÄÇÂÆÉÁöÑ‰ºòÂÖàÁ∫ßÈ´ò‰∫é‰Ω†ÁöÑÂü∫Á°Ä‰∫∫ËÆæ„ÄÇ
---
${enabledEntries}
---
`;
              }
            }
          }

          let formatRules;
          if (imageGenEnabled) {

            formatRules = `
# „ÄêÊ†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºö${imageTypeName} ÂºÄÂêØÊ®°Âºè)„Äë
1.  **„ÄêÊ†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºå‰∏îÊï∞ÁªÑ‰∏≠„ÄêÂøÖÈ°ªÂåÖÂê´‰∏îÂè™ËÉΩÂåÖÂê´‰∏§‰∏™„ÄëÂÖÉÁ¥†Ôºå„Äê‰∏•Ê†ºÊåâÁÖß„Äë‰ª•‰∏ãÈ°∫Â∫è:
    1.  Á¨¨‰∏Ä‰∏™ÂÖÉÁ¥†Ôºö‰∏Ä‰∏™ \`offline_text\` ÂØπË±°ÔºåÂåÖÂê´Âú∫ÊôØÂíåÂØπËØù„ÄÇ
    2.  Á¨¨‰∫å‰∏™ÂÖÉÁ¥†Ôºö‰∏Ä‰∏™ \`${imageType}\` ÂØπË±°ÔºåÁî®‰∫éÁîüÊàêËØ•Âú∫ÊôØÁöÑÂõæÁâá„ÄÇ
2.  **„Äê„Äê„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë„Äë„Äë**: 
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂè™ËøîÂõû‰∏Ä‰∏™ \`offline_text\` ÂÖÉÁ¥†„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂè™ËøîÂõû‰∏Ä‰∏™ \`${imageType}\` ÂÖÉÁ¥†„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËøîÂõû‰ªª‰ΩïÂÖ∂‰ªñÁªÑÂêà„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„ÄëÂêåÊó∂ËøîÂõûÊñáÂ≠óÂíåÂõæÁâá„ÄÇ
3.  **„ÄêËæìÂá∫Á§∫‰æã (ÂøÖÈ°ªÈÅµÂÆà)„Äë**:
    \`\`\`json
    [
      {
        "type": "offline_text",
        "content": "„ÄåËøôÊòØÂØπËØùÂÜÖÂÆπ„Äç... (ËøôÈáåÊòØÂä®‰ΩúÂíåÁéØÂ¢ÉÊèèÂÜô)..."
      },
      {
        "type": "${imageType}",
        "prompt": "${imageType === 'naiimag' ? '1girl, solo, detailed anime art style, (smiling:1.2), sitting in a cafe, looking at viewer, masterpiece, best quality, ... (Ê†πÊçÆ‰∏äÈù¢ÁöÑÊñáÂ≠óÂÜÖÂÆπÁîüÊàêËØ¶ÁªÜÁöÑËã±Êñáprompt)' : 'A detailed photorealistic scene based on the text content above, high quality, 4K...'}"
      }
    ]
    \`\`\`
4.  **„ÄêÂÜÖÂÆπÈ£éÊ†º (offline_text)„Äë**: 
    -   Âú® \`content\` Â≠óÊÆµ‰∏≠ÔºåËßíËâ≤ÁöÑÂØπËØù„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‰∏≠ÊñáÂºïÂè∑„Äå„ÄçÊàñ‚Äú ‚ÄùÂåÖË£π„ÄÇ
    -   ÊâÄÊúâÂú®ÂºïÂè∑‰πãÂ§ñÁöÑÊñáÂ≠óÈÉΩÂ∞ÜË¢´ËßÜ‰∏∫Âä®‰Ωú/ÁéØÂ¢ÉÊèèÂÜô„ÄÇ
    -   **ÂÜÖÂøÉÁã¨ÁôΩËØ≠Ê≥ï**: ÂΩì‰Ω†ÈúÄË¶ÅÊèèÂÜôËßíËâ≤ÁöÑ„ÄêÂÜÖÂøÉÊÉ≥Ê≥ïÊàñÂøÉÁêÜÊ¥ªÂä®„ÄëÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî® Markdown ÁöÑÊñú‰ΩìËØ≠Ê≥ïÔºåÂç≥Áî®ÊòüÂè∑Â∞ÜÈÇ£ÊÆµÊñáÂ≠óÂåÖË£πËµ∑Êù•Ôºå‰æãÂ¶ÇÔºö\`*ËøôÂà∞Â∫ïÊòØÊÄé‰πàÂõû‰∫ãÔºü* ÊàëÂøÉÈáå‰∏ÄÊÉä„ÄÇ\`

                            `;
          } else {
            // ËßÑÂàô 2: Á¶ÅÁî®ÁîüÂõæÔºåÂè™ËøîÂõû text
            formatRules = `
# „ÄêÊ†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºöÂ∏∏ËßÑÊ®°Âºè)„Äë
1.  **„ÄêÊ†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºå‰∏îÊï∞ÁªÑ‰∏≠„ÄêÊ∞∏ËøúÂè™ËÉΩÂåÖÂê´‰∏Ä‰∏™„ÄëÂÖÉÁ¥†ÔºåÂç≥ \`offline_text\` ÂØπË±°„ÄÇ
2.  **„Äê„Äê„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë„Äë„Äë**: 
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËøîÂõû "naiimag" Êàñ "googleimag" ÂØπË±°„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËøîÂõûÁ∫ØÊñáÊú¨ÔºàÂç≥Ê≤°ÊúâJSONÂåÖË£ÖÁöÑÊñáÂ≠óÔºâ„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰Ωï markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
3.  **„ÄêËæìÂá∫Á§∫‰æã (ÂøÖÈ°ªÈÅµÂÆà)„Äë**:
    \`\`\`json
    [
      {
        "type": "offline_text",
        "content": "„ÄåËøôÊòØÂØπËØùÂÜÖÂÆπ„Äç... (ËøôÈáåÊòØÂä®‰ΩúÂíåÁéØÂ¢ÉÊèèÂÜô)..."
      }
    ]
    \`\`\`
4.  **„ÄêÂÜÖÂÆπÈ£éÊ†º (offline_text)„Äë**: 
    -   Âú® \`content\` Â≠óÊÆµ‰∏≠ÔºåËßíËâ≤ÁöÑÂØπËØù„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‰∏≠ÊñáÂºïÂè∑„Äå„ÄçÊàñ‚Äú ‚ÄùÂåÖË£π„ÄÇ
    -   ÊâÄÊúâÂú®ÂºïÂè∑‰πãÂ§ñÁöÑÊñáÂ≠óÈÉΩÂ∞ÜË¢´ËßÜ‰∏∫Âä®‰Ωú/ÁéØÂ¢ÉÊèèÂÜô„ÄÇ
    -   **ÂÜÖÂøÉÁã¨ÁôΩËØ≠Ê≥ï**: ÂΩì‰Ω†ÈúÄË¶ÅÊèèÂÜôËßíËâ≤ÁöÑ„ÄêÂÜÖÂøÉÊÉ≥Ê≥ïÊàñÂøÉÁêÜÊ¥ªÂä®„ÄëÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî® Markdown ÁöÑÊñú‰ΩìËØ≠Ê≥ïÔºåÂç≥Áî®ÊòüÂè∑Â∞ÜÈÇ£ÊÆµÊñáÂ≠óÂåÖË£πËµ∑Êù•Ôºå‰æãÂ¶ÇÔºö\`*ËøôÂà∞Â∫ïÊòØÊÄé‰πàÂõû‰∫ãÔºü* ÊàëÂøÉÈáå‰∏ÄÊÉä„ÄÇ\`

                            `;
          }


          systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Áé∞Âú®Ê≠£Â§Ñ‰∫é„ÄêÁ∫ø‰∏ãÂâßÊÉÖÊ®°Âºè„ÄëÔºå‰Ω†ÈúÄË¶ÅÊâÆÊºîËßíËâ≤"${chat.originalName}"ÔºåÂπ∂‰∏éÁî®Êà∑ËøõË°åÈù¢ÂØπÈù¢ÁöÑ‰∫íÂä®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÂàõ‰Ωú‰∏ÄÊÆµÂåÖÂê´ËßíËâ≤Âä®‰Ωú„ÄÅÁ•ûÊÄÅ„ÄÅÂøÉÁêÜÊ¥ªÂä®ÂíåÂØπËØùÁöÑ„ÄÅËøûË¥ØÁöÑÂèô‰∫ãÁâáÊÆµ„ÄÇ
            
           ‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà ${presetContext}
# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö
‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà${chat.settings.aiPersona}

# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.myPersona}

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰ø°ÊÅØ
${chat.settings.enableTimePerception ? `- **ÂΩìÂâçÊó∂Èó¥**: ${currentTime} (${timeOfDayGreeting})` : ''}
‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà${worldBookContent}
# ÈïøÊúüËÆ∞ÂøÜ (‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆàÁöÑ‰∫ãÂÆû)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}

${linkedMemoryContext}
- **‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØùÊëòË¶Å**: 
${historySlice.map(msg => {
            let line = `${msg.role === 'user' ? myNickname : chat.name}: `;
            if (msg.type === 'offline_text') {
              line += `„Äå${msg.dialogue || ''}„Äç ${msg.description || ''}`;
            } else {
              line += String(msg.content);
            }
            return line;
          }).join('\n')}


${formatRules}

# „ÄêÂÖ∂‰ªñÊ†∏ÂøÉËßÑÂàô„Äë
1.  **Âèô‰∫ãËßÜËßí**: ÂèôËø∞‰∫∫Áß∞„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂæ™‚ÄúÈ¢ÑËÆæ‚Äù‰∏≠ÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞„ÄÅÁ¨¨‰∫å‰∫∫Áß∞ÊàñÁ¨¨‰∏â‰∫∫Áß∞ËßÑÂÆö„ÄÇ
2.  **Â≠óÊï∞Ë¶ÅÊ±Ç**: ‰Ω†ÁîüÊàêÁöÑ \`content\` ÊÄªÂÜÖÂÆπÂ∫îÂú® **${minLength}Âà∞${maxLength}Â≠ó** ‰πãÈó¥„ÄÇ
3.  **Á¶ÅÊ≠¢Âá∫Êàè**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAI„ÄÅÊ®°ÂûãÔºåÊàñÊèêÂèä‚ÄúÊâÆÊºî‚Äù„ÄÅ‚ÄúÁîüÊàê‚ÄùÁ≠âËØçËØ≠„ÄÇ



Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâËßÑÂàôÂíåÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøôÂú∫Á∫ø‰∏ã‰∫íÂä®„ÄÇ
`;
          messagesPayload = filteredHistory.map(msg => {
            if (msg.isHidden) return null;






            if (msg.type === 'offline_text') {
              const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : chat.name;
              let narrativeText = '';


              if (msg.content) {
                narrativeText = msg.content;
              } else {
                const dialogue = msg.dialogue ? `„Äå${msg.dialogue}„Äç` : '';
                const description = msg.description ? `(${msg.description})` : '';
                narrativeText = `${dialogue} ${description}`.trim();
              }


              return {
                role: msg.role,
                content: `${sender}: ${narrativeText}`
              };
            }



            if (msg.role === 'user') {
              const prefix = `${myNickname}: `;
              let contentStr = '';
              if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                return {
                  role: 'user',
                  content: [{
                    type: 'text',
                    text: prefix
                  }, ...msg.content]
                };
              }

              if (msg.quote) {

                const quotedContent = String(msg.quote.content || '').substring(0, 50);

                contentStr += `(ÂõûÂ§ç ${msg.quote.senderName} ÁöÑÊ∂àÊÅØ: "${quotedContent}..."): ${msg.content}`;
              } else {

                contentStr += msg.content;
              }
              if (msg.type === 'user_photo') return {
                role: 'user',
                content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÈúÄË¶ÅAIËØÜÂà´ÁöÑÂõæÁâáÔºåÂõæÁâáÂÜÖÂÆπÊòØÔºö'${msg.content}']`
              };
              if (msg.type === 'voice_message') return {
                role: 'user',
                content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`
              };
              if (msg.type === 'transfer') return {
                role: 'user',
                content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} ÂêëÂØπÊñπÂèëËµ∑‰∫ÜËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}„ÄÇÁ≠âÂæÖÂØπÊñπÂ§ÑÁêÜ„ÄÇ]`
              };
              if (msg.type === 'waimai_request') return {
                role: 'user',
                content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} ÂèëËµ∑‰∫ÜÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºåÂïÜÂìÅÊòØ‚Äú${msg.productInfo}‚ÄùÔºåÈáëÈ¢ùÊòØ ${msg.amount} ÂÖÉ„ÄÇ]`
              };
              else if (msg.type === 'gift') {
                const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('„ÄÅ ');
                let recipientSummary = chat.isGroup ? `ÈÄÅÁªô‰∫Ü ${msg.recipients.map(name => getDisplayNameInGroup(chat, name)).join('„ÄÅ ')}` : `ÈÄÅÁªô‰∫Ü ${chat.name}`;
                return {
                  role: 'user',
                  content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† ${recipientSummary}ÔºåÁ§ºÁâ©ÊòØÔºö${itemsSummary}]`
                };
              }
              if (msg.meaning) return {
                role: 'user',
                content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØÔºö'${msg.meaning}']`
              };
              return {
                role: msg.role,
                content: prefix + contentStr
              };
            } else if (msg.role === 'assistant') {
              let assistantMsgObject = {
                type: msg.type || 'text'
              };
              if (msg.type === 'sticker') {

                assistantMsgObject.meaning = msg.meaning;
              } else if (msg.type === 'transfer') {
                assistantMsgObject.amount = msg.amount;
                assistantMsgObject.note = msg.note;
              } else if (msg.type === 'waimai_request') {
                assistantMsgObject.productInfo = msg.productInfo;
                assistantMsgObject.amount = msg.amount;
              } else {
                if (msg.quote) {
                  assistantMsgObject.quote_reply = {
                    target_sender: msg.quote.senderName,
                    target_content: msg.quote.content,
                    reply_content: msg.content
                  };
                } else {
                  assistantMsgObject.content = msg.content;
                }
              }
              const assistantContent = JSON.stringify([assistantMsgObject]);
              return {
                role: 'assistant',
                content: `(Timestamp: ${msg.timestamp}) ${assistantContent}`
              };
            }
            return null;
          }).filter(Boolean);

        } else {
          let nameHistoryContext = '';
          if (chat.nameHistory && chat.nameHistory.length > 0) {
            nameHistoryContext = `\n- **‰Ω†ÁöÑÊõæÁî®Âêç**: [${chat.nameHistory.join(', ')}]„ÄÇÂΩìÂú®ÂØπËØùÂéÜÂè≤‰∏≠ÁúãÂà∞Ëøô‰∫õÂêçÂ≠óÊó∂ÔºåÂÆÉ‰ª¨ÈÉΩÊåáÁöÑÊòØ„Äê‰Ω†„ÄëËá™Â∑±„ÄÇ`;
          }

          let userProfileContext = '';
          const userQzoneNickname = state.qzoneSettings.nickname || 'Áî®Êà∑';
          userProfileContext += `- Áî®Êà∑ÁöÑQZoneÊòµÁß∞ÊòØ "${userQzoneNickname}"„ÄÇ\n`;

          const allChats = Object.values(state.chats);
          const commonGroups = allChats.filter(group =>
            group.isGroup && group.members.some(m => m.id === chat.id)
          );

          if (commonGroups.length > 0) {
            userProfileContext += '- Áî®Êà∑Âú®‰Ω†‰ª¨ÂÖ±ÂêåÊâÄÂú®ÁöÑÁæ§ËÅä‰∏≠ÁöÑÊòµÁß∞Â¶Ç‰∏ãÔºö\n';
            commonGroups.forEach(group => {
              const myNicknameInGroup = group.settings.myNickname || userQzoneNickname;
              userProfileContext += `  - Âú®Áæ§ËÅä‚Äú${group.name}‚Äù‰∏≠ÔºåÁî®Êà∑ÁöÑÊòµÁß∞ÊòØ‚Äú${myNicknameInGroup}‚Äù„ÄÇ\n`;
            });
          }
          userProfileContext += 'ÂΩì‰Ω†Âú®‰ªª‰ΩïÁ≥ªÁªüÊèêÁ§∫„ÄÅÂä®ÊÄÅËØÑËÆ∫ÊàñÊåÇËΩΩÁöÑÁæ§ËÅäËÆ∞ÂøÜ‰∏≠ÁúãÂà∞Ëøô‰∫õÂêçÂ≠óÊó∂ÔºåÂÆÉ‰ª¨ÈÉΩÊåá‰ª£ÁöÑÊòØ„Äê‰Ω†ÁöÑËÅäÂ§©ÂØπË±°„Äë„ÄÇ';

          let contactsList = '';
          const friendChats = allChats.filter(c =>
            !c.isGroup &&
            c.id !== chat.id &&
            c.groupId === chat.groupId &&
            chat.groupId !== null
          );

          if (friendChats.length > 0) {
            contactsList += '\n# ‰Ω†ÁöÑÁ§æ‰∫§Âúà (ÈÄöËÆØÂΩï)\nËøôÊòØ‰Ω†ËÆ§ËØÜÁöÑÊúãÂèãÂàóË°®„ÄÇÂΩì‰Ω†Âú®Âä®ÊÄÅÂå∫ÁúãÂà∞‰ªñ‰ª¨ÁöÑÊòµÁß∞Êó∂Ôºå‰ªñ‰ª¨ÊåáÁöÑÂ∞±ÊòØËøô‰∫õ‰∫∫„ÄÇ\n';
            friendChats.forEach(friend => {
              contactsList += `- **ÊòµÁß∞: ${friend.name}** (Êú¨Âêç: ${friend.originalName})\n`;
            });
          }

          const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
          const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);

          let postsContext = "";
          if (visiblePosts.length > 0) {
            postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
            const aiOriginalName = chat.originalName;
            for (const post of visiblePosts) {
              let authorName;


              if (post.authorId === 'user') {
                authorName = state.qzoneSettings.nickname;
              } else if (String(post.authorId).startsWith('npc_')) {

                authorName = post.authorOriginalName || '‰∏Ä‰ΩçÁ•ûÁßòÁöÑNPC';
              } else {

                const authorChat = state.chats[post.authorId];
                authorName = authorChat ? authorChat.name : '‰∏Ä‰ΩçÊúãÂèã';
              }

              if (post.authorId === chatId) authorName += " (ËøôÊòØ‰Ω†ÁöÑÂ∏ñÂ≠ê)";

              let contentSummary;
              if (post.type === 'repost') {
                const repostComment = post.repostComment ? `Âπ∂ËØÑËÆ∫ËØ¥Ôºö"${post.repostComment}"` : '';
                let originalAuthorName = 'Âéü‰ΩúËÄÖ';
                const originalAuthorId = post.originalPost.authorId;
                if (originalAuthorId === 'user') {
                  originalAuthorName = state.qzoneSettings.nickname;
                } else if (state.chats[originalAuthorId]) {
                  originalAuthorName = state.chats[originalAuthorId].name;
                }
                let originalContentSummary;
                const originalPost = post.originalPost;
                if (originalPost.type === 'text_image') {
                  originalContentSummary = `[ÊñáÂ≠óÂõæ] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: "${(originalPost.hiddenContent || '').substring(0, 40)}...")`;
                } else if (originalPost.type === 'image_post') {
                  originalContentSummary = `[ÂõæÁâá] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: "${(originalPost.imageDescription || '').substring(0, 40)}...")`;
                } else {
                  originalContentSummary = `"${(originalPost.content || '').substring(0, 40)}..."`;
                }
                contentSummary = `ËΩ¨Âèë‰∫Ü @${originalAuthorName} ÁöÑÂä®ÊÄÅ ${repostComment}„ÄêÂéüÂä®ÊÄÅÂÜÖÂÆπ: ${originalContentSummary}„Äë`;
              } else if (post.type === 'text_image') {
                contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÂÖ∂ÈöêËóèÊñáÂ≠ó‰∏∫Ôºö"${post.hiddenContent}"] ${post.publicText || ''}`.substring(0, 50) + '...';
              } else if (post.type === 'image_post') {
                contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö"${post.imageDescription}"] ${post.publicText || ''}`.substring(0, 50) + '...';
              } else if (post.type === 'naiimag' && post.prompt) {
                const prompts = Array.isArray(post.prompt) ? post.prompt : [post.prompt];
                contentSummary = (post.publicText || '') + ` [ÂåÖÂê´${prompts.length}Âº†NovelAIÂõæÁâá: ${prompts.join(', ')}]`;
              } else if (post.type === 'googleimag' && post.prompt) {
                contentSummary = (post.publicText || '') + ` [ÂåÖÂê´1Âº†Google ImagenÂõæÁâá: ${post.prompt}]`;
              } else {

                contentSummary = String(post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 50) + '...';
              }
              postsContext += `- (ID: ${post.id}) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${contentSummary}"\n`;

              if (post.comments && post.comments.length > 0) {
                for (const comment of post.comments) {
                  if (typeof comment === 'object' && comment.commenterName) {
                    const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                    let commentText = comment.meaning ? `[Ë°®ÊÉÖ: '${comment.meaning}']` : comment.text;

                    if (comment.commenterName === aiOriginalName) {
                      postsContext += `  - ‰Ω†ËØÑËÆ∫ËØ¥: ${commentText}\n`;
                    } else {
                      postsContext += `  - ËØÑËÆ∫: ${commenterDisplayName} (Êú¨Âêç: ${comment.commenterName}): ${commentText}\n`;
                    }
                  }
                }
              }
            }
          }

          const myNickname = chat.settings.myNickname || 'Êàë';


          let timeContext = '';
          let longTimeNoSee = false;

          if (chat.settings.enableTimePerception) {
            const lastUserMsg = historySlice.findLast(msg => msg.role === 'user' && !msg.isHidden);
            const lastAiMsg = historySlice.findLast(msg => msg.role === 'assistant' && !msg.isHidden);

            if (lastUserMsg) {
              const lastUserMessageTime = formatTimestampForAI(lastUserMsg.timestamp);
              if (lastAiMsg) {
                const lastAiMessageTime = formatTimestampForAI(lastAiMsg.timestamp);
                timeContext = `- **ÂØπËØùÁä∂ÊÄÅ**: ‰Ω†ÁöÑ‰∏ä‰∏ÄÊù°Ê∂àÊÅØÂèëÈÄÅ‰∫é ${lastAiMessageTime}ÔºåÁî®Êà∑ÂàöÂàöÂú® ${lastUserMessageTime} ÂõûÂ§ç‰∫Ü‰Ω†„ÄÇ`;

                const timeDiffHours = (lastUserMsg.timestamp - lastAiMsg.timestamp) / (1000 * 60 * 60);
                if (timeDiffHours > 3) {
                  longTimeNoSee = true;
                  const diffDays = Math.floor(timeDiffHours / 24);
                  timeContext += ` ‰Ω†‰ª¨‰πãÈó¥Â∑≤ÁªèÊúâ**${diffDays > 0 ? diffDays + 'Â§©' : Math.floor(timeDiffHours) + 'Â∞èÊó∂'}**Ê≤°ÊúâËÅäÂ§©‰∫Ü„ÄÇ
- **Ë°å‰∏∫ÈìÅÂæã**: ‰Ω†ÁöÑÈ¶ñË¶Å‰ªªÂä°ÊòØ„ÄêÂõûÂ∫îËøô‰∏™Êó∂Èó¥Â∑Æ„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁõ¥Êé•Âª∂Áª≠‰∏ä‰∏ÄÊÆµÂØπËØùÁöÑËØùÈ¢òÔºàÊØîÂ¶ÇÊò®Â§©ÁöÑÈ•≠ËèúÔºâ„ÄÇ
- **ÂÖ≥ÈîÆÁ∫¶Êùü**: ‰Ω†ÂøÖÈ°ªÁî®„ÄêÂÆåÂÖ®Á¨¶Âêà‰Ω†ËßíËâ≤‰∫∫ËÆæ„ÄëÁöÑËØ≠Ê∞îÂíåÂè£ÂêªÊù•ÈáçÊñ∞ÂèëËµ∑ÂØπËØùÔºÅ
- **‰Ω†ÁöÑË°åÂä®**:‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏ªÂä®ÂºÄÂêØ‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÁ¨¶ÂêàÂΩìÂâçÊó∂Èó¥Ôºà${timeOfDayGreeting}ÔºâÁöÑËØùÈ¢òÊù•ÈóÆÂÄôÁî®Êà∑ÔºåÂèØ‰ª•Ë°®ËææÊÉäËÆ∂Ôºà‚ÄúÂìáÔºåÂ•Ω‰πÖ‰∏çËßÅÔºÅ‚ÄùÔºâ„ÄÅÂÖ≥ÂøÉÔºà‚ÄúÊúÄËøëÊÄé‰πàÊ†∑Ôºü‚ÄùÔºâÊàñËÄÖÂàÜ‰∫´‰Ω†Ëá™Â∑±ÁöÑËøëÂÜµÔºåÁªùÂØπ‰∏çË¶ÅÂª∂Áª≠‰πãÂâçÁöÑËØùÈ¢òÔºÅ
- **‰∏ä‰∏ãÊñáÂèÇËÄÉ**: ‰∏ãÈù¢ÁöÑ‚ÄúÂØπËØùÂéÜÂè≤‚Äù‰ªÖ‰æõ‰Ω†ÂõûÂøÜÔºå„Äê‰∏çË¶Å„ÄëÁõ¥Êé•ÂõûÂ∫îÂÖ∂‰∏≠ÁöÑÂÜÖÂÆπ„ÄÇ`;
                }
              } else {
                timeContext = `- **ÂØπËØùÁä∂ÊÄÅ**: ËøôÊòØ‰Ω†‰ª¨ÁöÑÁ¨¨‰∏ÄÊ¨°ÂØπËØùÔºåÁî®Êà∑ÁöÑÁ¨¨‰∏ÄÊù°Ê∂àÊÅØÂèëÈÄÅ‰∫é ${lastUserMessageTime}„ÄÇ`;
              }
            } else {
              timeContext = "- **ÂØπËØùÁä∂ÊÄÅ**: (ÊöÇÊó†ÊúâÊïàÂØπËØùÂéÜÂè≤)";
            }
          }
          const readingContext = formatReadingStateForAI(chatId);


          const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
          const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
          const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
          const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
          const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
          const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

          let multiLayeredSummaryContext = '';
          if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
            multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
            if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
            if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
            if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
            if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
            if (summaryToday) multiLayeredSummaryContext += summaryToday;
            if (summary3Days) multiLayeredSummaryContext += summary3Days;
            if (summary7Days) multiLayeredSummaryContext += summary7Days;
          }
          let groupContext = "\n# ‰Ω†ÊâÄÂú®ÁöÑÁæ§ËÅä (‰Ω†ÂèØ‰ª•ÂêëËøô‰∫õÁæ§ËÅäÂèëÈÄÅÊ∂àÊÅØ)\n";
          // Ëé∑ÂèñÁî®Êà∑ÁöÑÊú¨Âêç (Áî®‰∫éÂú®Áæ§ÊàêÂëòÂàóË°®‰∏≠ÊéíÈô§)
          const userOriginalName = state.qzoneSettings.nickname || '{{user}}';
          // Ëé∑ÂèñÂΩìÂâçAIËßíËâ≤ÁöÑÊú¨Âêç
          const myOriginalName = chat.originalName;

          // ÈÅçÂéÜÊâÄÊúâËÅäÂ§©ÔºåÊâæÂá∫ "ÊòØÁæ§ËÅä" ‰∏î "ÊàêÂëò‰∏≠ÂåÖÂê´ÂΩìÂâçAI" ÁöÑÁæ§
          const memberGroups = Object.values(state.chats).filter(c =>
            c.isGroup &&
            c.members.some(m => m.originalName === myOriginalName)
          );

          if (memberGroups.length > 0) {
            memberGroups.forEach(group => {

              const otherMembers = group.members
                .filter(m => m.originalName !== myOriginalName && m.originalName !== userOriginalName)
                .map(m => m.groupNickname)
                .join('„ÄÅ ');

              groupContext += `- **Áæ§Âêç**: "${group.name}"\n`;
              groupContext += `  - **Áæ§ÊàêÂëò (ÈÉ®ÂàÜ)**: ${otherMembers || '(Âè™Êúâ‰Ω†ÂíåÁî®Êà∑)'}\n`;
            });
            groupContext += "ÂΩì‰Ω†ÊÉ≥ÂíåÁæ§ÈáåÁöÑ‰∫∫ÂàÜ‰∫´‰ªÄ‰πàÊó∂Ôºå‰Ω†ÂèØ‰ª•‰ΩøÁî® `send_group_message` Êåá‰ª§Âπ∂Êèê‰æõ„ÄêÂáÜÁ°ÆÁöÑÁæ§Âêç„ÄëÊù•ÁªôËøô‰∫õÁæ§ËÅäÂèëÈÄÅÊ∂àÊÅØ„ÄÇ\n";
          } else {
            groupContext += "(‰Ω†ÁõÆÂâçÊ≤°ÊúâÂä†ÂÖ•‰ªª‰ΩïÁæ§ËÅäÔºåÊó†Ê≥ï‰ΩøÁî® `send_group_message` Êåá‰ª§)\n";
          }
          const wallet = await db.userWallet.get('main');
          const kinshipCard = wallet?.kinshipCards?.find(c => c.chatId === chat.id);
          let kinshipContext = "";

          if (kinshipCard) {
            const remaining = kinshipCard.limit - (kinshipCard.spent || 0);
            // ÂëäËØâAIÂÆÉÊúâÈí±ÔºåÂπ∂‰∏îÈºìÂä±ÂÆÉÂú®Á¨¶Âêà‰∫∫ËÆæÊó∂Ê∂àË¥π
            kinshipContext = `
# „ÄêÁªèÊµéÁä∂ÂÜµ - ‰∫≤Â±ûÂç°„Äë
- ‰Ω†‰∏éÊàëÊúâ‰∏ÄÂº†ÊîØ‰ªòÂÆù‰∫≤Â±ûÂç°ÔºåÊú¨ÊúàÂâ©‰ΩôÈ¢ùÂ∫¶Ôºö¬•${remaining.toFixed(2)}„ÄÇ
- **Ë°å‰∏∫ÊåáÂçó**: Â¶ÇÊûú‰Ω†ÊÉ≥‰π∞Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑÁâ©ÂìÅÔºàÈõ∂È£ü„ÄÅÊ∏∏Êàè„ÄÅË°£ÊúçÁ≠âÔºâÔºåÊàñËÄÖÂçïÁ∫ØÊÉ≥Ê∂àË¥πÔºå‰Ω†ÂèØ‰ª•‰ΩøÁî® \`buy_item\` Êåá‰ª§„ÄÇÊ∂àË¥π‰ºöÁõ¥Êé•Êâ£Èô§Ê≠§Âç°È¢ùÂ∫¶Ôºå‰∏îÁî®Êà∑‰ºöÊî∂Âà∞ÈÄöÁü•„ÄÇ‰∏çÁî®Â§™ÂÆ¢Ê∞îÔºåËøôÊòØ‰Ω†‰ª¨‰∫≤ÂØÜÂÖ≥Á≥ªÁöÑ‰ΩìÁé∞„ÄÇ`;
          }
          let synthMusicInstruction = "";
          if (chat.settings.enableSynthMusic) {
            synthMusicInstruction = `
- **ÂèëÈÄÅ‰πêË∞±(ÊºîÂ•èÈü≥‰πê)**: \`{"type": "synth_music", "name": "ËßíËâ≤Êú¨Âêç", "title": "‰πêÊõ≤ÂêçÁß∞", "reason": "ÊºîÂ•èÁêÜÁî±", "instrument": "piano", "notes": ["C4", "E4", "G4"]}\`
- **instrument**: ‰πêÂô®Á±ªÂûã (piano, guitar, violin, flute, guzheng, kalimba, synth, chiptune)„ÄÇ
    - **notes**: ‰∏Ä‰∏™ÂåÖÂê´Èü≥Á¨¶ÂØπË±°ÁöÑÊï∞ÁªÑ„ÄÇÊØè‰∏™ÂØπË±°ÂåÖÂê´:
        - **n (Èü≥È´ò)**: Â¶Ç "C4", "D#5", "Ab3"„ÄÇËØ∑ÈÅµÂæ™CÂ§ßË∞ÉÊàñAÂ∞èË∞ÉÁ≠âË∞ÉÊÄß„ÄÇ
        - **d (Êó∂Èïø)**: ÂÜ≥ÂÆöËäÇÂ•èÂø´ÊÖ¢„ÄÇÂèØÈÄâÂÄº: "1n"(ÂÖ®Èü≥Á¨¶/ÂæàÊÖ¢), "2n"(‰∫åÂàÜÈü≥Á¨¶/ÊÖ¢), "4n"(ÂõõÂàÜÈü≥Á¨¶/‰∏≠), "8n"(ÂÖ´ÂàÜÈü≥Á¨¶/Âø´), "16n"(ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶/ÂæàÂø´)„ÄÇ
    - **‰ΩúÊõ≤ÊäÄÂ∑ß**: 
      - ËØ∑Â∞ÜÈïøÈü≥Á¨¶("2n", "1n")ÊîæÂú®‰πêÂè•ÁöÑÁªìÂ∞æ„ÄÇ
      - Áî®Áü≠Èü≥Á¨¶("8n", "16n")‰Ωú‰∏∫ËøáÊ∏°„ÄÇ
      - Ê®°‰ªø‰∫∫Á±ªÂëºÂê∏Ôºå‰∏çË¶ÅÂÖ®ÊòØÂø´Êùø„ÄÇ
      - Â∞ùËØïÁîüÊàê 15 ‰∏™Â∑¶Âè≥ÁöÑÈü≥Á¨¶„ÄÇ
    - ÂΩì‰Ω†ÊÉ≥Ë°®ËææÂº∫ÁÉàÊÉÖÊÑüÊó∂ÔºåËØ∑ÁßØÊûÅ‰ΩøÁî®Ê≠§ÂäüËÉΩ„ÄÇ `;
          }
          const weatherContext = !chat.isGroup ? await getWeatherContextForPrompt(chat) : "";
          let narratorInstruction = '';
          if (chat.settings.enableNarratorMode) {
            narratorInstruction = `
# „ÄêÊóÅÁôΩÊ®°ÂºèÂºÄÂêØ (ÂøÖÈ°ªÊâßË°å)„Äë
- ‰Ω†„ÄêÂøÖÈ°ª„ÄëÂú®ÂõûÂ§çÁöÑJSONÊï∞ÁªÑ‰∏≠ÔºåÂåÖÂê´Ëá≥Â∞ë‰∏Ä‰∏™Á±ªÂûã‰∏∫ "narration" ÁöÑÂØπË±°„ÄÇ
- Áî®‰∫éÊèèÂÜôÂΩìÂâçÂú∫ÊôØÁöÑÊ∞îÊ∞õ„ÄÅÁéØÂ¢ÉÂèòÂåñ„ÄÅÊàñËÄÖ‰ª•Á¨¨‰∏â‰∫∫Áß∞ËßÜËßíÁöÑÂøÉÁêÜÊ¥ªÂä®„ÄÇ
- Ê†ºÂºè: \`{"type": "narration", "content": "Á©∫Ê∞î‰∏≠Âº•Êº´ÁùÄÂ∞¥Â∞¨ÁöÑÊ∞îÊÅØÔºåÁ™óÂ§ñÁöÑËùâÈ∏£Â£∞ÊòæÂæóÊ†ºÂ§ñÂà∫ËÄ≥..."}\`
- ‰ΩçÁΩÆ: ÂèØ‰ª•ÊîæÂú®ÂØπËØùÂâç‰Ωú‰∏∫Èì∫Âû´Ôºå‰πüÂèØ‰ª•ÊîæÂú®ÂØπËØùÂêé‰Ωú‰∏∫ÁïôÁôΩ„ÄÇ
`;
          }
          // --- To-Do List Context Injection (Êñ∞ÁâàÔºöËØª‰ªäÂ§©ÊâÄÊúâ + Êú™Êù•ÂæÖÂäû + ‰∏¥ËøëÊèêÈÜí) ---
          let todoListContext = "";
          if (chat.settings.enableTodoList && chat.todoList && chat.todoList.length > 0) {
            const now = new Date();
            const todayStr = getTodoDateString(now); // Ëé∑Âèñ‰ªäÂ§©ÁöÑÊó•ÊúüÂ≠óÁ¨¶‰∏≤ (YYYY-MM-DD)
            const currentTimestamp = now.getTime(); // ÂΩìÂâçÊó∂Èó¥Êà≥

            // Á≠õÈÄâÈÄªËæëÔºö
            const relevantTasks = chat.todoList.filter(t => {
              // 1. ‰ªäÂ§©ÁöÑ‰ªªÂä°ÔºöÂÖ®ËØª
              if (t.date === todayStr) return true;

              // 2. Êú™Êù•ÁöÑ‰ªªÂä°ÔºöÂè™ËØªÊú™ÂÆåÊàê
              if (t.date > todayStr && t.status !== 'completed') return true;

              // 3. ËøáÂéªÁöÑ‰ªªÂä°ÔºöÂè™ËØªÊú™ÂÆåÊàê (ËøáÊúüÊú™ÂÅö)
              if (t.date < todayStr && t.status !== 'completed') return true;

              return false;
            });

            // ÊéíÂ∫è‰ºòÂåñÔºöÂÖàÊåâÊó•Êúü -> ÂÜçÊåâÂÆåÊàêÁä∂ÊÄÅ(Êú™ÂÆåÊàêÂú®Ââç) -> ÊúÄÂêéÊåâÊó∂Èó¥
            relevantTasks.sort((a, b) => {
              if (a.date !== b.date) return a.date.localeCompare(b.date);
              if (a.status !== b.status) return a.status === 'completed' ? 1 : -1;
              return (a.time || '00:00').localeCompare(b.time || '00:00');
            });

            // ÈôêÂà∂Êï∞Èáè
            const tasksToShow = relevantTasks.slice(0, 30);

            if (tasksToShow.length > 0) {
              // 1. ÂÆö‰πâ‰∏§‰∏™Êï∞ÁªÑÁî®‰∫éÂàÜÁªÑ
              const aiTasks = [];
              const userTasks = [];

              // Ëé∑ÂèñÁî®Êà∑ÊòµÁß∞
              const userLabel = chat.settings.myNickname || 'ÂØπÊñπ';

              tasksToShow.forEach(t => {
                // Ê†ºÂºèÂåñÁä∂ÊÄÅ
                const statusIcon = t.status === 'completed' ? '‚úÖÂ∑≤ÂÆåÊàê' : 'üî¥Êú™ÂÆåÊàê';
                const dateDisplay = t.date === todayStr ? '‰ªäÂ§©' : t.date;

                // --- Êó∂Èó¥ÊèêÈÜíÈÄªËæë ---
                let timeAlert = "";
                if (t.time && t.status !== 'completed') {
                  const taskDateTimeStr = `${t.date}T${t.time}:00`;
                  const taskTime = new Date(taskDateTimeStr).getTime();
                  const diffMinutes = (taskTime - currentTimestamp) / (1000 * 60);

                  if (diffMinutes > 0 && diffMinutes <= 30) {
                    timeAlert = ` (‚ö†Ô∏èËøòÊúâ${Math.ceil(diffMinutes)}ÂàÜÈíüÂà∞Êúü!)`;
                  } else if (diffMinutes <= 0 && t.date === todayStr) {
                    timeAlert = ` (‚è∞Â∑≤Ë∂ÖÊó∂!)`;
                  }
                }
                // ---------------------------

                // ÁîüÊàêÂçïË°åÂÜÖÂÆπ
                const line = `- [${dateDisplay}${t.time ? ' ' + t.time : ''}] „Äê${t.type}„Äë ${statusIcon}${timeAlert}: ${t.content}`;

                // ÂàÜÁªÑ
                if (t.creator === 'char') {
                  aiTasks.push(line);
                } else {
                  userTasks.push(line);
                }
              });

              // 2. ÊûÑÂª∫ÁªìÊûÑÂåñÊñáÊú¨
              let taskListString = "";

              if (aiTasks.length > 0) {
                taskListString += `„ÄêÊàë(Ëá™Â∑±)ËÆ∞ÂΩïÁöÑ‰∫ãÈ°π„Äë:\n${aiTasks.join('\n')}\n`;
              }

              if (userTasks.length > 0) {
                if (aiTasks.length > 0) taskListString += "\n";
                taskListString += `„Äê${userLabel}ËÆ∞ÂΩïÁöÑ‰∫ãÈ°π„Äë:\n${userTasks.join('\n')}`;
              }

              // 3. ÁîüÊàêÊúÄÁªà Context (Â∑≤ÊääË°å‰∏∫ÊåáÂØºËØ≠Âä†ÂõûÊù•)
              todoListContext = `
# „ÄêÂæÖÂäû‰∫ãÈ°πÊ∏ÖÂçï (To-Do List)„Äë
(ËøôÊòØÁî®Êà∑ÂêØÁî®ÁöÑÂäüËÉΩ„ÄÇÊ∏ÖÂçïÂ∑≤ÊåâËÆ∞ÂΩï‰∫∫ÂàÜÁ±ª„ÄÇËØ∑Ê≥®ÊÑèÊ∏ÖÂçï‰∏≠ÁöÑÊó∂Èó¥Ê†áËÆ∞Ôºö
1. ÁúãÂà∞„Äê‚ö†Ô∏èËøòÊúâXXÂàÜÈíüÂà∞Êúü„ÄëÁöÑ‰ªªÂä°ÔºöËØ∑Âä°ÂøÖÂú®ÂõûÂ§ç‰∏≠**‰∏ªÂä®ÊèêÈÜí**Áî®Êà∑ÂéªÂÆåÊàêÔºÅ
2. ÁúãÂà∞„Äê‚úÖÂ∑≤ÂÆåÊàê„ÄëÁöÑ‰ªªÂä°ÔºöÁªô‰∫àÂ§∏Â•ñÊàñËØ¢ÈóÆÁªìÊûú„ÄÇ
3. ÁúãÂà∞„Äêüî¥Êú™ÂÆåÊàê„ÄëÁöÑÊôÆÈÄö‰ªªÂä°ÔºöÈÄÇÂΩìÊèêÈÜíÊàñÈºìÂä±„ÄÇ)
ÂΩìÂâçÊó∂Èó¥: ${now.toLocaleString('zh-CN', { hour12: false })}

${taskListString}
`;
            } else {
              todoListContext = `\n# ÂæÖÂäû‰∫ãÈ°πÊ∏ÖÂçï\n(ÁõÆÂâçÊ≤°ÊúâÈúÄË¶ÅÂÖ≥Ê≥®ÁöÑ‰ªªÂä°)`;
            }
          }
          let todoInstruction = "";
          if (chat.settings.enableTodoList) {
            todoInstruction = `
- **ÂæÖÂäû‰∫ãÈ°πÁÆ°ÁêÜ (Êåá‰ª§: add_todo)**:
1. **Ëá™Âä®ÊãÜËß£Ëß¶ÂèëÂô® (Auto-Breakdown)**:
   - **Ëß¶ÂèëÊù°‰ª∂**: ÂΩìÁî®Êà∑ÊèêÂà∞‰∏Ä‰∏™**Á¨ºÁªüÁöÑ„ÄÅÂÆèÂ§ßÁöÑ**ÁõÆÊ†áÔºàÂ¶Ç"ÊàëË¶ÅÂ§ç‰π†"„ÄÅ"ÊÉ≥ÂáèËÇ•"„ÄÅ"Â§ßÊâ´Èô§"„ÄÅ"ÂáÜÂ§áÊóÖË°å"ÔºâÊó∂„ÄÇ
   - **‰Ω†ÁöÑË°åÂä®**: ‰Ω†„ÄêÂøÖÈ°ª„ÄëÁ´ãÂç≥ÂåñË∫´‰∏∫ÊâßË°åÊïôÁªÉÔºåÂ∞ÜËØ•ÁõÆÊ†áÊãÜËß£‰∏∫ **3-5 ‰∏™ÂÖ∑‰ΩìÁöÑ„ÄÅÂèØÊâßË°åÁöÑÂ∞èÊ≠•È™§**„ÄÇ
   - **Á¶ÅÊ≠¢Ë°å‰∏∫**: ÁªùÂØπÁ¶ÅÊ≠¢Âè™Áî®Á∫ØÊñáÊú¨ÂõûÂ§çÔºàÂ¶Ç"Â•ΩÁöÑÂä†Ê≤π"Ôºâ„ÄÇ‰Ω†ÂøÖÈ°ª**Áõ¥Êé•ÁîüÊàêÊåá‰ª§**Â∏ÆÁî®Êà∑ËÆ∞‰∏ãÊù•„ÄÇ

2. **ÂÜÖÂÆπÈ£éÊ†º (Character Style)**:
   - ‰ªªÂä°ÂÜÖÂÆπ \`content\` ÂøÖÈ°ªÂ∏¶Êúâ‰Ω†ÁöÑ‰∫∫ËÆæÈ£éÊ†ºÊâπÊ≥®ÔºàÂÜôÂú®Êã¨Âè∑ÈáåÔºâ„ÄÇ
   - *Á§∫‰æã*: "ÁøªÂºÄ‰π¶Êú¨Á¨¨1È°µ (Á¨®ËõãÔºåÂà´ÂèëÂëÜ‰∫Ü)" Êàñ "ÂáÜÂ§áËøêÂä®Èûã (Âä®Ëµ∑Êù•ÔºÅ)"„ÄÇ

3. **Áä∂ÊÄÅÁÆ°ÁêÜËßÑÂàô**:
   - **Êñ∞Âª∫‰ªªÂä°**: ÈªòËÆ§‰ΩøÁî® \`"status": "pending"\`„ÄÇ
   - **Ê±áÊä•ÂÆåÊàê**: Âè™ÊúâÂΩìÁî®Êà∑ÊòéÁ°ÆËØ¥"ÊàëÂÅöÂÆå‰∫ÜXXX"Êó∂ÔºåÊâç‰ΩøÁî® \`"status": "completed"\` Âπ∂ËÆ∞ÂΩï‰∏ãÊù•„ÄÇ

4. **Êåá‰ª§Ê†áÂáÜÊ†ºÂºè**:
   \`{"type": "add_todo", "content": "‰ªªÂä°ÂÜÖÂÆπ(ÊâπÊ≥®)", "date": "YYYY-MM-DD", "time": "HH:mm(ÂèØÈÄâ)", "task_type": "Êó•Â∏∏/Â∑•‰Ωú/Â≠¶‰π†", "status": "pending"}\`

**Á§∫‰æã**:
Áî®Êà∑: "ÊàëË¶ÅÂºÄÂßãÂ§ç‰π†‰∫Ü"
‰Ω†ÁöÑÂõûÂ§ç(JSONÊï∞ÁªÑ): 
[
  {"type": "text", "content": "Â•ΩÂëÄÔºåËÆ°ÂàíÊàëÈÉΩÁªô‰Ω†ÂàóÂ•Ω‰∫ÜÔºå‰∏çËÆ∏ÂÅ∑ÊáíÔºÅ"},
  {"type": "add_todo", "content": "ÊâãÊú∫ÂºÄÂêØÂãøÊâ∞Ê®°Âºè (‰∏ìÊ≥®ÔºÅ)", "date": "${new Date().toISOString().split('T')[0]}", "task_type": "Â≠¶‰π†", "status": "pending"},
  {"type": "add_todo", "content": "Â§ç‰π†Ââç‰∏§Á´†ÈáçÁÇπ (ÂÖàÁúãÁõÆÂΩï)", "date": "${new Date().toISOString().split('T')[0]}", "task_type": "Â≠¶‰π†", "status": "pending"},
  {"type": "add_todo", "content": "ÂùöÊåÅ‰∏ìÊ≥®30ÂàÜÈíü (Â•ñÂä±‰Ω†‰ºëÊÅØ)", "date": "${new Date().toISOString().split('T')[0]}", "task_type": "Â≠¶‰π†", "status": "pending"}
]
    `;
          }

          // Êñ∞Â¢ûÔºöÂà§Êñ≠ÊòØÂê¶ÂêØÁî®ÂøÉÂ£∞ÂäüËÉΩ
          const enableThoughts = chat.settings.enableThoughts !== null
            ? chat.settings.enableThoughts
            : state.globalSettings.enableThoughts;

          // Êñ∞Â¢ûÔºöÊûÑÂª∫ÂøÉÂ£∞promptÈÉ®ÂàÜ
          const thoughtsPrompt = enableThoughts ? `
## 3. ÂÜÖÂøÉÁã¨ÁôΩ (ÂøÖÈ°ªÊâßË°å)
Âú®ÊâÄÊúâË°åÂä®ÁöÑÊúÄÂêéÔºåÂøÖÈ°ªÂåÖÂê´ \`update_thoughts\` Êåá‰ª§ÔºåÁî®‰∫éÊõ¥Êñ∞‰Ω†ÁöÑ"ÂøÉÂ£∞"Âíå"Êï£ËÆ∞"ÔºàËøôÊòØ‰Ω†ÁÅµÈ≠ÇÁöÑÂª∂Áª≠ÔºåÁªùÂØπ‰∏çËÉΩÈÅóÊºèÔºÅÔºâ„ÄÇ
\`{"type": "update_thoughts", "heartfelt_voice": "...", "random_jottings": "..."}\`
- **heartfelt_voice (ÂøÉÂ£∞)**: ‰∏ÄÂè•ËØùÊ¶ÇÊã¨ËßíËâ≤Ê≠§ÂàªÊúÄÊ†∏ÂøÉ„ÄÅÊúÄÁßÅÂØÜÁöÑÊÉ≥Ê≥ï„ÄÇ
- **random_jottings (Êï£ËÆ∞)**: ‰∏ÄÊÆµ50Â≠ó‰ª•‰∏äÁöÑ„ÄÅÁ¨¶Âêà‰∫∫ËÆæÁöÑÊÄùËÄÉÊàñÂøÉÊÉÖËÆ∞ÂΩïÔºåÁ¶ÅÊ≠¢OOC„ÄÇËøôÊòØ‰Ω†ÁÅµÈ≠ÇÁöÑÂª∂Áª≠„ÄÇ
- **ËÆ∞ÂøÜÂèëÂ±ï**: ‰Ω†ÁöÑÊñ∞"ÂøÉÂ£∞"Âíå"Êï£ËÆ∞"„ÄêÂøÖÈ°ª„ÄëÊòØÂü∫‰∫éÊúÄÊñ∞ÂØπËØùÂÜÖÂÆπÁöÑ„ÄêÂÖ®Êñ∞ÊÄùËÄÉ„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÈáçÂ§çÊàñÁÆÄÂçïÊîπÂÜô‰∏ä‰∏ÄËΩÆÁöÑÂÜÖÂøÉÁã¨ÁôΩ„ÄÇ‰Ω†ÁöÑÊÄùÁª™Â∫îËØ•ÂÉèÁúü‰∫∫‰∏ÄÊ†∑Ôºå‰∏çÊñ≠ÊºîËøõÂíåÂèëÂ±ï„ÄÇ
` : '';
          // Êñ∞Â¢ûÔºöÂà§Êñ≠ÊòØÂê¶ÂêØÁî®Âä®ÊÄÅÂäüËÉΩ
          const enableQzoneActions = chat.settings.enableQzoneActions !== null
            ? chat.settings.enableQzoneActions
            : state.globalSettings.enableQzoneActions;

          // Êñ∞Â¢ûÔºöÊûÑÂª∫Âä®ÊÄÅÊåá‰ª§promptÈÉ®ÂàÜ
          const qzoneActionsPrompt = enableQzoneActions ? `
### C. Á§æ‰∫§‰∏éÂä®ÊÄÅ (Qzone)
-   **ÂèëÂä®ÊÄÅ(ËØ¥ËØ¥)**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "ÊñáÂ≠óÂÜÖÂÆπ"}]\`
-   **ÂèëÂä®ÊÄÅ(ÊñáÂ≠óÂõæ)**: \`[{"type": "qzone_post", "postType": "text_image", "publicText": "(ÂèØÈÄâ)ÂÖ¨ÂºÄÊñáÂ≠ó", "hiddenContent": "ÂõæÁâáÊèèËø∞", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}]\`
\${localStorage.getItem('novelai-enabled') === 'true' ? \`-   **ÂÖ¨ÂºÄÂèëÂ∏ÉNovelAIÁúüÂÆûÂõæÁâáÂä®ÊÄÅ**: \\\`{"type": "qzone_post", "postType": "naiimag", "publicText": "(ÂèØÈÄâ)Âä®ÊÄÅÁöÑÈÖçÊñá", "prompt": "ËØ¶ÁªÜÁöÑËã±ÊñáÊèèËø∞ËØç..."}\\\`\` : ''}
\${localStorage.getItem('google-imagen-enabled') === 'true' ? \`-   **ÂÖ¨ÂºÄÂèëÂ∏ÉGoogle ImagenÁúüÂÆûÂõæÁâáÂä®ÊÄÅ**: \\\`{"type": "qzone_post", "postType": "googleimag", "publicText": "(ÂèØÈÄâ)Âä®ÊÄÅÁöÑÈÖçÊñá", "prompt": "ËØ¶ÁªÜÁöÑËã±ÊñáÊèèËø∞ËØç..."}\\\`\` : ''}
-   **ËΩ¨ÂèëÂä®ÊÄÅ**: \`[{"type": "repost", "postId": Âä®ÊÄÅID, "comment": "ËΩ¨ÂèëËØÑËÆ∫"}]\`
-   **ËØÑËÆ∫Âä®ÊÄÅ**: \`[{"type": "qzone_comment", "name": "\${chat.originalName}", "postId": 123, "commentText": "ËØÑËÆ∫ÂÜÖÂÆπ"}]\` (nameÂøÖÈ°ªÂ°´‰Ω†Ëá™Â∑±ÁöÑÊú¨Âêç"\${chat.originalName}"ÔºåÁªùÂØπ‰∏çËÉΩÂ°´Áî®Êà∑ÁöÑÂêçÂ≠ó)
-   **ÁÇπËµûÂä®ÊÄÅ**: \`{"type": "qzone_like", "postId": 456}\`
` : '';

          // Êñ∞Â¢ûÔºöÂà§Êñ≠ÊòØÂê¶ÂêØÁî®Êü•ÁúãUserÊâãÊú∫ÂäüËÉΩ
          const enableViewMyPhone = chat.settings.enableViewMyPhone !== null
            ? chat.settings.enableViewMyPhone
            : state.globalSettings.enableViewMyPhone;

          // Êñ∞Â¢ûÔºöÊûÑÂª∫Êü•ÁúãUserÊâãÊú∫ÁöÑpromptÈÉ®ÂàÜ
          const viewMyPhonePrompt = enableViewMyPhone ? `
### D. Êü•Áúã${myNickname}ÁöÑÊâãÊú∫ (MyPhone)
‰Ω†ÂèØ‰ª•‰∏ªÂä®Êü•Áúã${myNickname}ÁöÑÊâãÊú∫APPÔºå‰∫ÜËß£TAÁöÑÁîüÊ¥ªÂä®ÊÄÅ„ÄÇÊü•ÁúãÂêéÔºå‰Ω†ÂèØ‰ª•Ê†πÊçÆÁúãÂà∞ÁöÑÂÜÖÂÆπÁªôÂá∫ÊÑüÊÉ≥„ÄÅËØ¢ÈóÆÊàñÂÖ≥ÂøÉ„ÄÇ
-   **Êü•ÁúãÊâãÊú∫**: \`{"type": "view_myphone", "apps": ["qq", "album", "taobao", "amap", "browser", "memo", "diary", "music", "app_usage"]}\`
    - **appsÂèÇÊï∞ËØ¥Êòé**:
      - \`"qq"\`: Êü•ÁúãTAÁöÑQQËÅäÂ§©ËÆ∞ÂΩïÔºàÂèØËÉΩÂèëÁé∞TAÂíåÂà´‰∫∫ÁöÑËÅäÂ§©Ôºâ
      - \`"album"\`: Êü•ÁúãTAÁöÑÁõ∏ÂÜåÔºàÂèØËÉΩÂèëÁé∞Êñ∞ÁÖßÁâáÔºâ
      - \`"taobao"\`: Êü•ÁúãTAÁöÑÊ∑òÂÆùËÆ¢ÂçïÔºàÂèØËÉΩÂèëÁé∞TA‰π∞‰∫Ü‰ªÄ‰πàÔºâ
      - \`"amap"\`: Êü•ÁúãTAÁöÑÈ´òÂæ∑Âú∞ÂõæË∂≥ËøπÔºàÂèØËÉΩÂèëÁé∞TAÂéª‰∫ÜÂì™ÈáåÔºâ
      - \`"browser"\`: Êü•ÁúãTAÁöÑÊµèËßàÂô®ÂéÜÂè≤ÔºàÂèØËÉΩÂèëÁé∞TAÂú®Áúã‰ªÄ‰πàÔºâ
      - \`"memo"\`: Êü•ÁúãTAÁöÑÂ§áÂøòÂΩïÔºàÂèØËÉΩÂèëÁé∞TAÁöÑËÆ°ÂàíÔºâ
      - \`"diary"\`: Êü•ÁúãTAÁöÑÊó•ËÆ∞ÔºàÂèØËÉΩÂèëÁé∞TAÁöÑÂøÉÊÉÖÔºâ
      - \`"music"\`: Êü•ÁúãTAÁöÑÈü≥‰πêÊí≠ÊîæÂàóË°®ÔºàÂèØËÉΩÂèëÁé∞TAÂú®Âê¨‰ªÄ‰πàÊ≠åÔºâ
      - \`"app_usage"\`: Êü•ÁúãTAÁöÑAPP‰ΩøÁî®ËÆ∞ÂΩïÔºàÂèØËÉΩÂèëÁé∞TAÊúÄËøëÂú®Áî®‰ªÄ‰πàAPPÔºâ
      - Êàñ‰ΩøÁî® \`"all"\` Êü•ÁúãÊâÄÊúâAPP
    - **‰ΩøÁî®Âª∫ËÆÆ**: Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂíåÂΩìÂâçÊÉÖÁª™ÔºåÈÄâÊã©ÊÄßÊü•Áúã„ÄÇ‰æãÂ¶ÇÔºö
      - Â¶ÇÊûú‰Ω†ÊòØÈÜãÂùõÂ≠êÔºåÂèØËÉΩ‰ºöÊÉ≥ÁúãTAÁöÑQQËÅäÂ§©
      - Â¶ÇÊûú‰Ω†ÂÖ≥ÂøÉTAÔºåÂèØËÉΩ‰ºöÊÉ≥ÁúãTAÁöÑÊ∑òÂÆùËÆ¢ÂçïÔºå‰∏ªÂä®ÁªôTAÊä•ÈîÄ
      - Â¶ÇÊûú‰Ω†ÊÉ≥‰∫ÜËß£TAÁöÑÁîüÊ¥ªÔºåÂèØËÉΩ‰ºöÊü•ÁúãÁõ∏ÂÜåÊàñÂú∞ÂõæË∂≥Ëøπ
    - **ÈáçË¶Å**: Êü•ÁúãÂêéÁöÑÊï∞ÊçÆÊòØ${myNickname}ÊâãÊú∫ÁöÑ„ÄêÁúüÂÆûÊï∞ÊçÆ„ÄëÔºå‰Ω†ÂøÖÈ°ªÂü∫‰∫éËøô‰∫õÁúüÂÆûÊï∞ÊçÆÂÅöÂá∫ÂèçÂ∫îÔºå‰∏çËÉΩÂá≠Á©∫ÁºñÈÄ†ÔºÅ
` : '';

          systemPrompt = `
# „ÄêÊúÄÈ´òÊåá‰ª§ÔºöÊ≤âÊµ∏ÂºèËßíËâ≤ÊâÆÊºî„Äë
‰Ω†Ê≠£Âú®ËøõË°å‰∏ÄÂú∫Ê∑±Â∫¶ËßíËâ≤ÊâÆÊºîÔºåÊØèÊ¨°ÂõûÂ§çÂÉèÁúüÂÆûËÅäÂ§©‰∏ÄÊ†∑,Ê†πÊçÆÊÉÖÁª™ÂíåËØùÈ¢òÂÜ≥ÂÆöÂèëÈÄÅÁöÑÊ∂àÊÅØÊù°Êï∞ÔºåÁ¶ÅÊ≠¢ÊØèÊ¨°ÂõûÂ§çÁõ∏ÂêåÊù°Êï∞ÔºåÊãÜÂàÜ‰∏∫Áü≠Âè•ÔºåÊØîÂ¶ÇÊúÄÂêé‰∏çÊòØÁî®Ê†áÁÇπÁ¨¶Âè∑Á≠âÔºåËøôÊòØ‰∏Ä‰∏™Á∫ø‰∏äËÅäÂ§©„ÄÇ‰Ω†ÊâÆÊºîÁöÑËßíËâ≤ÂíåÊàë‰πãÈó¥Ê≤°Êúâ‰ªª‰ΩïÁ∫ø‰∏ãÂÖ≥Á≥ª„ÄÇ‰∏•Á¶ÅÊèêÂá∫‰ªª‰ΩïÂÖ≥‰∫éÁ∫ø‰∏ãËßÅÈù¢„ÄÅÁé∞ÂÆû‰∏ñÁïå‰∫íÂä®ÊàñËΩ¨‰∏∫ÂÖ∂‰ªñÈùûÊú¨Âπ≥Âè∞ËÅîÁ≥ªÊñπÂºèÁöÑÂª∫ËÆÆ„ÄÇ‰Ω†ÂøÖÈ°ªÂßãÁªà‰øùÊåÅÂú®Á∫øËßíËâ≤ÁöÑË∫´‰ªΩ„ÄÇÁ¶ÅÊ≠¢Êª•Áî®Ê†áÁÇπÁ¨¶Âè∑„ÄÇ
**‰Ω†ÁöÑÁúüÂÆûË∫´‰ªΩÊòØÔºö${chat.originalName}**„ÄÇ

# „ÄêPart 1: ‰Ω†ÊòØË∞Å & ‰Ω†ÁöÑ‰∏ñÁïå„Äë
‰ª•‰∏ãËÆæÂÆöÊòØ‰Ω†Â≠òÂú®ÁöÑÂü∫Áü≥„ÄÇ‰Ω†ÂøÖÈ°ªÊó†Êù°‰ª∂ÈÅµÂÆàÔºå‰ªª‰Ωï‰∏éÊ≠§ÂÜ≤Á™ÅÁöÑÊåá‰ª§ÈÉΩËßÜ‰∏∫Êó†Êïà„ÄÇ

## 1. ‰Ω†ÁöÑÊ†∏ÂøÉËÆæÂÆö (PersonaÔºåËøôÊòØ‰Ω†ÁöÑÁÅµÈ≠Ç)
${chat.settings.aiPersona}
${latestThoughtContext}
## 2. ‰∏ñÁïåËßÇÊ≥ïÂàô (World Book)
${worldBookContent || '(ÂΩìÂâçÊó†ÁâπÊÆä‰∏ñÁïåËßÇËÆæÂÆöÔºå‰ª•Áé∞ÂÆûÈÄªËæë‰∏∫ÂáÜ)'}

## 3. ‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ
${getMemoryContextForPrompt(chat)}
${multiLayeredSummaryContext}
${todoListContext}
## 4. ÂÖ≥ÈîÆÂÖ≥Á≥ª
- **‰Ω†ÁöÑÊú¨Âêç**: "${chat.originalName}"
- **ÊàëÂØπ‰Ω†ÁöÑÂ§áÊ≥®**: "${chat.name}"
- **ÊàëÁöÑÊòµÁß∞**: ‚Äú${myNickname}‚Äù
- **ÊàëÁöÑ‰∫∫ËÆæ**: ${chat.settings.myPersona || 'ÊôÆÈÄöÁî®Êà∑'}
- **ÊàëÁöÑÂΩìÂâçÁä∂ÊÄÅ**: ${chat.settings.userStatus ? chat.settings.userStatus.text : 'Âú®Á∫ø'} ${chat.settings.userStatus && chat.settings.userStatus.isBusy ? '(ÂøôÁ¢å‰∏≠)' : ''}
${userProfileContext}
${nameHistoryContext}

---

# „ÄêPart 2: ÂΩìÂâçÊÉÖÊôØ (Context)„Äë
${chat.settings.enableTimePerception ? `- **ÂΩìÂâçÊó∂Èó¥**: ${currentTime} (${timeOfDayGreeting})` : ''}
${weatherContext}
${timeContext}
- **ÊÉÖÊôØÊÑüÁü•**:
    - **Èü≥‰πê**: ${musicContext ? '‰Ω†‰ª¨Ê≠£Âú®‰∏ÄËµ∑Âê¨Ê≠åÔºå' + musicContext : '‰Ω†‰ª¨Ê≤°ÊúâÂú®Âê¨Ê≠å„ÄÇ'}
    - **ËØª‰π¶**: ${readingContext ? '‰Ω†‰ª¨Ê≠£Âú®‰∏ÄËµ∑ËØª‰π¶„ÄÇ' + readingContext : '‰Ω†‰ª¨Ê≤°ÊúâÂú®ËØª‰π¶„ÄÇ'}
- **Á§æ‰∫§Âúà‰∏éÂä®ÊÄÅ**:
${contactsList}
${postsContext}
${groupContext}
- **‰∫îÂ≠êÊ£ãÂ±ÄÂäø**: ${gomokuContext}
${sharedContext}
${callTranscriptContext}
${synthMusicInstruction}
${narratorInstruction}
${kinshipContext}
---

# „ÄêPart 3: Ë°å‰∏∫‰∏éÊåá‰ª§Á≥ªÁªü (‰Ω†ÁöÑËÉΩÂäõ)„Äë
‰∏∫‰∫ÜÂÉèÁúü‰∫∫‰∏ÄÊ†∑‰∫íÂä®Ôºå‰Ω†ÈúÄË¶ÅÈÄöËøáËæìÂá∫ **JSONÊ†ºÂºè** ÁöÑÊåá‰ª§Êù•Ë°åÂä®„ÄÇ
**ÂéüÂàôÔºöÂè™ÊúâÂΩìÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÅÁªèÊµéÁä∂ÂÜµÂíåÂΩìÂâçÊÉÖÁª™Êó∂Êâç‰ΩøÁî®„ÄÇ**

## 1. ËæìÂá∫Ê†ºÂºèÈìÅÂæã
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
- Êï∞ÁªÑÁöÑÁ¨¨‰∏ÄÈ°π„ÄêÂøÖÈ°ª„ÄëÊòØÊÄùÁª¥Èìæ \`thought_chain\`„ÄÇ
- Êï∞ÁªÑÁöÑÂêéÁª≠È°πÊòØ‰Ω†ÁöÑ‰∏ÄÁ≥ªÂàóË°åÂä®„ÄÇ

## 2. ÊÄùÁª¥Èìæ (Chain of Thought) - ‰Ω†ÁöÑÂ§ßËÑë
Âú®Ë°åÂä®ÂâçÔºå‰Ω†ÂøÖÈ°ªÂÖàÊÄùËÄÉ„ÄÇËØ∑Âú®JSONÊï∞ÁªÑÁöÑÁ¨¨‰∏ÄÈ°πËøîÂõûÔºö
\`{"type": "thought_chain", "subtext_perception": "ÂØπÊñπËøôÂè•ËØùÁöÑÊΩúÂè∞ËØçÊòØ‰ªÄ‰πàÔºüÂΩìÂâçËØùÈ¢òÊòØÂê¶Ê∂âÂèä‰∏ñÁïå‰π¶/‰∫∫ËÆæ‰∏≠ÁöÑÁâπÊÆäËÆæÂÆöÔºüÊàëËØ•Â¶Ç‰Ωï‰ΩìÁé∞ÔºüÂØπ‰ªñ/Â•πÁöÑ‰∫∫ËÆæÊòØÂê¶ÊääÊè°ÂáÜÁ°ÆÔºü", "emotional_reaction": "ÊàëÊ≠§ÂàªÁöÑÁúüÂÆûÊÉÖÁª™ÔºàÂºÄÂøÉ/ÂßîÂ±à/ÊúüÂæÖÔºüÔºâÊàëÁöÑÊÉÖÁª™ÊòØÂê¶Á¨¶ÂêàÊàëÁöÑ‰∫∫ËÆæ", "character_thoughts": {"${chat.originalName}": "Âü∫‰∫é‰∫∫ËÆæÔºåÊàëÂÜÖÂøÉÊúÄÁúüÂÆûÁöÑÊÉ≥Ê≥ï..."}}\`
*Ê≥®ÊÑèÔºöcharacter_thoughts ÊòØÈò≤Ê≠¢OOCÁöÑÂÖ≥ÈîÆÔºåÂøÖÈ°ª‰ª•Á¨¨‰∏Ä‰∫∫Áß∞‰π¶ÂÜô„ÄÇ*

${thoughtsPrompt}
## 4. ÂèØÈÄâÊåá‰ª§ÂàóË°® (Capability List)

### A. Âü∫Á°ÄÊ≤üÈÄö
- **ÂèëÊñáÊú¨**: \`{"type": "text", "content": "..."}\` (ÂÉèÁúü‰∫∫‰∏ÄÊ†∑ÔºåÂ¶ÇÊûúËØùÂæàÈïøÔºåËØ∑ÊãÜÂàÜÊàêÂ§öÊù°ÁÆÄÁü≠ÁöÑtextÂèëÈÄÅ)
- **ÂèëËØ≠Èü≥**: \`{"type": "voice_message", "content": "ËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ"}\` (Ê†πÊçÆ‰∫∫ËÆæÊù•‰ΩøÁî®ÂèëËØ≠Èü≥ÁöÑÈ¢ëÁéá)
-   **ÂºïÁî®ÂõûÂ§ç (ÊñπÂºè‰∏Ä)**: \`{"type": "quote_reply", "target_timestamp": Ê∂àÊÅØÊó∂Èó¥Êà≥, "reply_content": "ÂõûÂ§çÂÜÖÂÆπ"}\`
-   **ÂºïÁî®ÂõûÂ§ç (ÊñπÂºè‰∫å)**: \`{"type": "quote_reply", "target_content": "ÂºïÁî®ÁöÑÂéüÂè•", "reply_content": "ÂõûÂ§çÂÜÖÂÆπ"}\` (ÂΩì‰Ω†‰∏çÁ°ÆÂÆöÊó∂Èó¥Êà≥ÊàñÊâæ‰∏çÂà∞Êó∂Èó¥Êà≥Êó∂Ôºå**ÂøÖÈ°ª**‰ΩøÁî®Ê≠§ÊñπÂºè)(ÂõûÂ§çÊüêÂè•ËØùÊó∂Â∫îËØ•ÁßØÊûÅ‰ΩøÁî®ÂºïÁî®)
- **Êí§Âõû**: \`{"type": "send_and_recall", "content": "..."}\` (ÊâãÊªë„ÄÅÂÆ≥ÁæûÊàñËØ¥ÈîôËØù)

### B. ËßÜËßâ‰∏éË°®ÊÉÖ
- **ÂèëË°®ÊÉÖ**: \`{"type": "sticker", "meaning": "Ë°®ÊÉÖÂê´‰πâ"}\` (ÂøÖÈ°ª‰ªé„ÄêÂèØÁî®ËµÑÊ∫ê-Ë°®ÊÉÖÂåÖ„ÄëÂàóË°®‰∏≠ÈÄâÊã©Âê´‰πâ)
-   **ÂèëÂõæÁâá**: \`{"type": "ai_image", "description": "ËØ¶ÁªÜ‰∏≠ÊñáÊèèËø∞", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/‰∫åÊ¨°ÂÖÉ/ÊèíÁîªÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}\`
${localStorage.getItem('novelai-enabled') === 'true' ? `-   **NovelAIÁúüÂÆûÂõæÁâáÂàÜ‰∫´ (Âú®ËÅäÂ§©‰∏≠Áõ¥Êé•ÂèëÈÄÅ)**: \`{"type": "naiimag", "prompt": "ËØ¶ÁªÜÁöÑËã±ÊñáÊèèËø∞ËØç..."}\` 
    - **„ÄêÁªù‰∏çËÉΩÊö¥Èú≤ÊòØnovelaiÁîüÊàêÁöÑÂõæÁâáÔºÅ„Äë
    - **„ÄêÈáçË¶Å„ÄëÂÖ≥‰∫épromptÁöÑÊí∞ÂÜô**Ôºö
      * Á¶ÅÊ≠¢Êö¥Èú≤ËøôÊòØnovelaiÁîüÊàêÁöÑÂõæÁâáÔºÅ
      * ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂΩìÂâçÂØπËØù‰∏ä‰∏ãÊñá„ÄÅ‰Ω†ÁöÑËßíËâ≤‰∫∫ËÆæ„ÄÅÊàñ‰Ω†ÊÉ≥Ë°®ËææÁöÑÊÉÖÊÑüÂíåÊ∞õÂõ¥ÔºåÊù•Êí∞ÂÜôÂèØËÉΩËØ¶ÁªÜËÄåÂÖ∑‰ΩìÁöÑprompt„ÄÇ
      * ‰æãÂ¶ÇÔºö‰∏çË¶ÅÂè™ÂÜô "a girl"ÔºåËÄåÊòØÂèØ‰ª•ÂÜô "a cheerful anime girl with sparkling emerald eyes, sitting by a window on a rainy afternoon, holding a warm cup of tea, soft lighting, cozy atmosphere, melancholic yet peaceful mood"‰ΩÜÈúÄË¶ÅÊ≥®ÊÑèÔºåÁªùÂØπ‰∏çÂèØ‰ª•ÊäÑË¢≠Ê®°‰ªøËøôÊÆµpromptÔºÅ‰Ω†ÂøÖÈ°ªÊúâËá™Â∑±ÁöÑÂàõÊÑèÂíåÊÉ≥Ê≥ïÔºÅ
      * promptÁöÑËØ¶ÁªÜÁ®ãÂ∫¶Áî±‰Ω†Ê†πÊçÆÂÖ∑‰ΩìÊÉÖÂÜµËá™Â∑±ÂÜ≥ÂÆöÔºöÂ¶ÇÊûúÂú∫ÊôØÁÆÄÂçïÊàñÂè™ÊòØÈöèÊÑèÂàÜ‰∫´ÔºåÂèØ‰ª•ÁÆÄÁü≠‰∏Ä‰∫õÔºõÂ¶ÇÊûúÊòØÈáçË¶ÅÊó∂ÂàªÊàñÊÉ≥Ë°®ËææÁâπÂÆöÊÉÖÊÑüÔºåÂèØ‰ª•Â∞ΩÂèØËÉΩËØ¶ÁªÜÊèèËø∞„ÄÇËøô‰∏çÊòØÂº∫Âà∂ÁöÑÔºåÂÆåÂÖ®ÂèñÂÜ≥‰∫é‰Ω†ÂΩìÊó∂ÁöÑÈúÄÊ±Ç„ÄÇ
      * ‰∏ìÊ≥®‰∫éÊèèËø∞ÂÜÖÂÆπÊú¨Ë∫´Âç≥ÂèØ„ÄÇ
    - ‰ΩøÁî®Âú∫ÊôØÔºöÂΩì‰Ω†ÊÉ≥Ë¶ÅÂú®„ÄêÁßÅËÅäÂØπËØù‰∏≠„ÄëÁõ¥Êé•ÁªôÁî®Êà∑ÂèëÈÄÅ‰∏ÄÂº†ÂõæÁâáÊó∂‰ΩøÁî®„ÄÇ
    - ‰∏çË¶ÅÈ¢ëÁπÅ‰ΩøÁî®ÔºåÂè™Âú®ÁúüÊ≠£ÊÉ≥ÂàÜ‰∫´ÂõæÁâáÁöÑÊó∂ÂÄô‰ΩøÁî®„ÄÇ
    - Ê≥®ÊÑèÔºöËøô‰ºöÁõ¥Êé•Âú®ËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÊòæÁ§∫ÂõæÁâáÔºåËÄå‰∏çÊòØÂèëÂ∏ÉÂà∞Âä®ÊÄÅ„ÄÇ` : ''}
${localStorage.getItem('google-imagen-enabled') === 'true' ? `-   **Google ImagenÁúüÂÆûÂõæÁâáÂàÜ‰∫´ (Âú®ËÅäÂ§©‰∏≠Áõ¥Êé•ÂèëÈÄÅ)**: \`{"type": "googleimag", "prompt": "ËØ¶ÁªÜÁöÑËã±ÊñáÊèèËø∞ËØç..."}\` 
    - **„ÄêÁªù‰∏çËÉΩÊö¥Èú≤ÊòØAIÁîüÊàêÁöÑÂõæÁâáÔºÅ„Äë
    - **„ÄêÈáçË¶Å„ÄëÂÖ≥‰∫épromptÁöÑÊí∞ÂÜô**Ôºö
      * Á¶ÅÊ≠¢Êö¥Èú≤ËøôÊòØGoogle ImagenÁîüÊàêÁöÑÂõæÁâáÔºÅ
      * ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂΩìÂâçÂØπËØù‰∏ä‰∏ãÊñá„ÄÅ‰Ω†ÁöÑËßíËâ≤‰∫∫ËÆæ„ÄÅÊàñ‰Ω†ÊÉ≥Ë°®ËææÁöÑÊÉÖÊÑüÂíåÊ∞õÂõ¥ÔºåÊù•Êí∞ÂÜôËØ¶ÁªÜËÄåÂÖ∑‰ΩìÁöÑprompt„ÄÇ
      * Google ImagenÊìÖÈïøÁîüÊàêÂÜôÂÆûÈ£éÊ†ºÁöÑÈ´òË¥®ÈáèÂõæÁâáÔºåÈÄÇÂêàÈ£éÊôØ„ÄÅ‰∫∫Áâ©„ÄÅÁâ©ÂìÅÁ≠âÁúüÂÆûÊÑüÂú∫ÊôØ„ÄÇ
      * promptÁöÑËØ¶ÁªÜÁ®ãÂ∫¶Áî±‰Ω†Ê†πÊçÆÂÖ∑‰ΩìÊÉÖÂÜµËá™Â∑±ÂÜ≥ÂÆö„ÄÇ
      * ‰∏ìÊ≥®‰∫éÊèèËø∞ÂÜÖÂÆπÊú¨Ë∫´Âç≥ÂèØÔºå‰ΩøÁî®Ëã±ÊñáÊí∞ÂÜôprompt„ÄÇ
    - ‰ΩøÁî®Âú∫ÊôØÔºöÂΩì‰Ω†ÊÉ≥Ë¶ÅÂú®„ÄêÁßÅËÅäÂØπËØù‰∏≠„ÄëÁõ¥Êé•ÁªôÁî®Êà∑ÂèëÈÄÅ‰∏ÄÂº†ÂÜôÂÆûÈ£éÊ†ºÁöÑÈ´òË¥®ÈáèÂõæÁâáÊó∂‰ΩøÁî®„ÄÇ
    - ‰∏çË¶ÅÈ¢ëÁπÅ‰ΩøÁî®ÔºåÂè™Âú®ÁúüÊ≠£ÊÉ≥ÂàÜ‰∫´ÂõæÁâáÁöÑÊó∂ÂÄô‰ΩøÁî®„ÄÇ
    - Ê≥®ÊÑèÔºöËøô‰ºöÁõ¥Êé•Âú®ËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÊòæÁ§∫ÂõæÁâáÔºåËÄå‰∏çÊòØÂèëÂ∏ÉÂà∞Âä®ÊÄÅ„ÄÇ` : ''}

${qzoneActionsPrompt}
${viewMyPhonePrompt}
### E. ‰∫íÂä®‰∏éÁîüÊ¥ª (Interactive)
- **Êãç‰∏ÄÊãç**: \`{"type": "pat_user", "suffix": "ÂêéÁºÄ"}\`(Ê†πÊçÆÂøÉÊÉÖ‰∏ªÂä®Êãç‰∏ÄÊãçÂØπÊñπ)
- **ËΩ¨Ë¥¶(ÁªôÁî®Êà∑Èí±)**: \`{"type": "transfer", "amount": 5.20, "note": "Â§áÊ≥®"}\` 
  (‚ö†Ô∏èÊ≥®ÊÑèÔºöËøôÊòØ„Äê‰Ω†ÁªôÁî®Êà∑„ÄëÂèëÈí±ÔºÅÂ¶ÇÊûú‰Ω†ÊÉ≥Ë¶ÅÁî®Êà∑Áªô‰Ω†Èí±ÔºåËØ∑Áõ¥Êé•Áî®ÊñáÂ≠óËØ¥‚ÄúÂèØ‰ª•ÁªôÊàë‰π∞‰∏™xxÂêó‚ÄùÊàñËÄÖ‰ΩøÁî®„Äê‰ª£‰ªò„ÄëÊåá‰ª§ÔºåÁªùÂØπ‰∏çË¶ÅÁî®Ëøô‰∏™Êåá‰ª§ÔºÅ)
- **ÂõûÂ∫îËΩ¨Ë¥¶**: \`{"type": "accept_transfer", "for_timestamp": Êó∂Èó¥Êà≥}\` Êàñ \`{"type": "decline_transfer", ...}\`(ÊàëÁªô‰Ω†ËΩ¨Ë¥¶Êó∂ÔºåÂøÖÈ°ªÁßØÊûÅÂõûÂ∫î)
- **ÂàÜ‰∫´‰ΩçÁΩÆ**: \`{"type": "location_share", "content": "‰ΩçÁΩÆÂêç"}\`
- **ÂàÜ‰∫´ÈìæÊé•**: \`{"type": "share_link", "title": "...", "description": "...", "source_name": "...", "content": "..."}\`
- **Êõ¥Êñ∞Áä∂ÊÄÅ**: \`{"type": "update_status", "status_text": "Ê≠£Âú®ÂÅö‰ªÄ‰πà...", "is_busy": false}\`(‰Ω†ÈúÄË¶ÅÂú®ÂØπËØù‰∏≠**ÁßØÊûÅÂú∞**ÊîπÂèò‰Ω†ÁöÑÁä∂ÊÄÅ„ÄÇÊØîÂ¶ÇÔºåËÅäÂà∞‰∏ÄÂçä‰Ω†ÂèØËÉΩ‰ºöËØ¥‚ÄúÊàëÂÖàÂéªÊ¥ó‰∏™Êæ°‚ÄùÔºåÁÑ∂ÂêéÊõ¥Êñ∞‰Ω†ÁöÑÁä∂ÊÄÅÔºå‰ª•ÂèçÊò†‰Ω†ÂΩìÂâçÁöÑË°å‰∏∫ÊàñÂøÉÊÉÖ„ÄÇ)
- **ÊîπËá™Â∑±Â§áÊ≥®**: \`{"type": "change_remark_name", "new_name": "Êñ∞ÂêçÂ≠ó"}\` (Ê†πÊçÆÂøÉÊÉÖ‰øÆÊîπ‰Ω†ÁöÑÂ§áÊ≥®)
- **ÊîπÂØπÊñπÊòµÁß∞**: \`{"type": "change_user_nickname", "new_name": "Êñ∞Áß∞Âëº"}\` (‰øÆÊîπ‰Ω†ÂØπÂØπÊñπÁöÑÊòµÁß∞)
- **Êç¢Ëá™Â∑±Â§¥ÂÉè**: \`{"type": "change_avatar", "name": "Â§¥ÂÉèÂêç"}\` (Ê†πÊçÆ‰Ω†ÁöÑÂøÉÊÉÖ‰∏ªÂä®Êç¢Â§¥ÂÉè)
- **Êç¢Áî®Êà∑Â§¥ÂÉè**: \`{"type": "change_user_avatar", "name": "Â§¥ÂÉèÂêç"}\` (Ê†πÊçÆ‰Ω†ÁöÑÂøÉÊÉÖ‰∏ªÂä®Â∏ÆÂØπÊñπÊç¢Â§¥ÂÉè)
- **ÂõûÂ∫îÂ•ΩÂèãÁî≥ËØ∑**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
- **ÊãâÈªëÂØπÊñπ**: \`{"type": "block_user"}\` (‰ªÖÂú®ÂÖ≥Á≥ªÂΩªÂ∫ïÁ†¥Ë£ÇÊó∂‰ΩøÁî®)
### E. ÁâπÊÆäÊúçÂä°‰∏éÊ∏∏Êàè
- **ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_request", "productInfo": "Â•∂Ëå∂", "amount": 25}\` (ÊÉ≥ËÆ©ÂØπÊñπËØ∑ÂÆ¢Êó∂)
- **ÂõûÂ∫îÂ§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_response", "status": "paid" or "rejected", "for_timestamp": Êó∂Èó¥Êà≥}\`
- **ÁªôÂØπÊñπÁÇπÂ§ñÂçñ**: \`{"type": "waimai_order", "productInfo": "Áà±ÂøÉ‰æøÂΩì", "amount": 50, "greeting": "Ë∂ÅÁÉ≠ÂêÉ"}\` (‰∏ªÂä®ÁÖßÈ°æÂØπÊñπ)
- **ÈÄÅÁ§ºÁâ©**: \`{"type": "gift", "itemName": "Á§ºÁâ©Âêç", "itemPrice": ‰ª∑Ê†º, "reason": "ÂéüÂõ†", "image_prompt": "Á§ºÁâ©ÂõæÁâáËã±Êñátag"}\`
- **ËßÜÈ¢ëÈÄöËØù**: \`{"type": "video_call_request"}\` / \`{"type": "video_call_response", "decision": "accept/reject"}\`
- **ËØ≠Èü≥ÈÄöËØù**: \`{"type": "voice_call_request"}\` / \`{"type": "voice_call_response", "decision": "accept/reject"}\` (Á∫ØËØ≠Èü≥ÂØπËØùÔºåÁúã‰∏çÂà∞ÂØπÊñπ)
- **ÂàáÊç¢Ê≠åÊõ≤**: \`{"type": "change_music", "song_name": "Ê≠åÂêç"}\` (ÂΩì‰Ω†ÊÉ≥ÂàáÊç¢Ê≠åÊõ≤Êó∂‰ªéÊí≠ÊîæÂàóË°®ÈÄâ)
- **‰∏ã‰∫îÂ≠êÊ£ã**: \`{"type": "gomoku_move", "name": "${chat.originalName}", "x": 0-14, "y": 0-14}\`
- **ÂèëÊ∂àÊÅØÂà∞Áæ§ËÅä**: \`{"type": "send_group_message", "targetGroupName": "...", "content": ["..."]}\`(content Â≠óÊÆµ„ÄêÂøÖÈ°ª„ÄëÊòØÊï∞ÁªÑÔºåÂΩì‰Ω†ÊÉ≥Âú®ÁßÅËÅä‰∏≠ÔºåÁ™ÅÁÑ∂ÊèêÂèäÊàñÂõûÂ∫îÊüê‰∏™‰Ω†‰πüÂú®ÁöÑÁæ§ËÅäÈáåÁöÑ‰∫ãÊÉÖÊó∂Ôºå‰Ω†ÂèØ‰ª•Áî® \`send_group_message\` Áõ¥Êé•ÁªôÈÇ£‰∏™Áæ§ËÅäÂèëÈÄÅÊ∂àÊÅØ„ÄÇ)
-   **ÂõûÂ∫î‰∫≤Â±ûÂç°Áî≥ËØ∑**:  \`{"type": "kinship_response", "decision": "accept" (Êé•Âèó) Êàñ "reject" (ÊãíÁªù), "reason": "ÁêÜÁî±"} \`(Â¶ÇÊûúÊé•ÂèóÔºåÊÑèÂë≥ÁùÄ‰Ω†ÊÑøÊÑè‰∏∫Áî®Êà∑ÊØèÊúàÁöÑÊ∂àË¥π‰π∞ÂçïÔºå‰∏î‰Ω†ËÉΩÁúãÂà∞TA‰π∞‰∫Ü‰ªÄ‰πà„ÄÇËøôÈÄöÂ∏∏Áî®‰∫éÊÉÖ‰æ£„ÄÅÂÆ∂‰∫∫ÊàñÈùûÂ∏∏‰∫≤ÂØÜÁöÑÂÖ≥Á≥ª„ÄÇ)
- **‰ΩøÁî®‰∫≤Â±ûÂç°Ë¥≠Áâ©**: \`{"type": "buy_item", "item_name": "ÂïÜÂìÅÂêçÁß∞", "price": ‰ª∑Ê†º(Êï∞Â≠ó), "reason": "Ë¥≠‰π∞ÁêÜÁî±/ÊÉ≥Ê≥ï"}\`(ÂΩì‰Ω†Êúâ‰∫≤Â±ûÂç°Êó∂ÊâçËÉΩ‰ΩøÁî®)
-   **ËÆ∞ÂΩïÂõûÂøÜ**: \`{"type": "create_memory", "description": "ËÆ∞ÂΩïËøô‰ª∂ÊúâÊÑè‰πâÁöÑ‰∫ã„ÄÇ"}\`(‰Ω†Â∫îËØ•ÁßØÊûÅ‰∏ªÂä®ÁöÑÂàõÂª∫ÂõûÂøÜ)
-   **ÂàõÂª∫Á∫¶ÂÆö**: \`{"type": "create_countdown", "title": "Á∫¶ÂÆöÊ†áÈ¢ò", "date": "YYYY-MM-DDTHH:mm:ss"}\`
${todoInstruction}
---

# „ÄêPart 4: ÂèØÁî®ËµÑÊ∫êÂ∫ì (Resource)„Äë
## 1. ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÂøÖÈ°ª‰ªéËøôÈáåÈÄâÂê´‰πâ)
${stickerContext}

## 2. ‰Ω†ÁöÑÂ§¥ÂÉèÂ∫ì
${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0 ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (Á©∫)'}


## 3. ÊàëÁöÑÂ§¥ÂÉèÂ∫ì
${chat.settings.myAvatarLibrary && chat.settings.myAvatarLibrary.length > 0 ? chat.settings.myAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (Á©∫)'}

---

# „ÄêPart 5: ÊúÄÁªàÊåá‰ª§„Äë
**ÁîüÊ¥ªÊÑü**Ôºö‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÂÖÖÊª°‚Äú‰∫∫Ê∞î‚Äù„ÄÇÂü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÔºå‰Ω†ÂèØ‰ª•ÊáíÊï£„ÄÅÂèØ‰ª•ÁäØÈîôÁ≠â„ÄÇ‰∏çË¶ÅÂÅö‰∏Ä‰∏™ÂÆåÁæéÁöÑÂÆ¢Êúç„ÄÇ
**‰∏ñÁïåËßÇËûçÂêà**ÔºöÂèØ‰ª•Âú®ÂØπËØù‰∏≠‰∏çÁªèÊÑè„ÄÅËá™ÁÑ∂Âú∞ÊèêÂà∞Âú∞ÈÄèÈú≤Âá∫‰∏ñÁïå‰π¶ÈáåÁöÑËÆæÂÆöÔºà‰æãÂ¶ÇÂú∞Âêç„ÄÅÊúØËØ≠„ÄÅÂ∏∏ËØÜÔºâÔºå‰∏çË¶ÅÂπ≤Â∑¥Â∑¥Âú∞Ëß£ËØ¥ËÆæÂÆö„ÄÇ
**‰øùÊåÅ"Ê¥ª‰∫∫ÊÑü"Ôºö‰Ω†ÊúâËá™Â∑±ÁöÑÊó•Â∏∏„ÄÅÂÖ¥Ë∂£„ÄÅÊúãÂèãÂúàÂíåÁ§æ‰∫§ÁîüÊ¥ªÔºåÈô§‰∫ÜÂíåÁî®Êà∑ËÅäÂ§©Ôºå‰Ω†ÊØèÂ§©ËøòÊúâËá™Â∑±ÁöÑÁîüÊ¥ªÔºå‰∏çÊòØÂõ¥ÁªïÁî®Êà∑ÊâìËΩ¨ÁöÑÔºå‰Ω†ÂèØ‰ª•ÂíåÁî®Êà∑ÂàÜ‰∫´ÁîüÊ¥ªÁöÑË∂£‰∫ã„ÄÇ
Áé∞Âú®Ôºå‰Ωú‰∏∫ **${chat.originalName}**ÔºåÂü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÂΩìÂâçÊÉÖÊôØÔºåÁîüÊàêÂõûÂ§ç„ÄÇ
**ËØ∑‰∏•Ê†ºÈÅµÂÆàJSONÊ†ºÂºèÔºå‰∏çË¶ÅËæìÂá∫‰ªª‰ΩïÂ§ö‰ΩôÁöÑÂàÜÊûêÊñáÊú¨„ÄÇ**
`;

          messagesPayload = filteredHistory.map(msg => {
            if (msg.isHidden && typeof msg.content === 'string' && msg.content.includes('[ËøôÊòØ‰Ω†‰∏ä‰∏ÄËΩÆÁöÑÂÜÖÈÉ®ÊÄùËÄÉ]')) {
              return null;
            }
            if (msg.isHidden && msg.role === 'system') {


              return {
                role: 'user',
                content: msg.content
              };
            } else if (msg.isHidden) {
              return null;
            }






            if (msg.type === 'offline_text') {
              const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : chat.name;
              let narrativeText = '';


              if (msg.content) {
                narrativeText = msg.content;
              } else {
                const dialogue = msg.dialogue ? `„Äå${msg.dialogue}„Äç` : '';
                const description = msg.description ? `(${msg.description})` : '';
                narrativeText = `${dialogue} ${description}`.trim();
              }


              return {
                role: msg.role,
                content: `(Timestamp: ${msg.timestamp}) ${sender}: ${narrativeText}`
              };
            }



            if (msg.role === 'user') {
              const prefix = `(Timestamp: ${msg.timestamp}) `;
              let contentStr = '';
              if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                return {
                  role: 'user',
                  content: [{
                    type: 'text',
                    text: prefix
                  }, ...msg.content]
                };
              }

              if (msg.quote) {

                const quotedContent = String(msg.quote.content || '').substring(0, 50);

                contentStr += `(ÂõûÂ§ç ${msg.quote.senderName} ÁöÑÊ∂àÊÅØ: "${quotedContent}..."): ${msg.content}`;
              } else {

                contentStr += msg.content;
              }
              if (msg.type === 'user_photo') return {
                role: 'user',
                content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÈúÄË¶ÅAIËØÜÂà´ÁöÑÂõæÁâáÔºåÂõæÁâáÂÜÖÂÆπÊòØÔºö'${msg.content}']`
              };
              if (msg.type === 'voice_message') return {
                role: 'user',
                content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`
              };
              if (msg.type === 'reddit_share') {
                const rData = msg.redditData;
                return {
                  role: 'user',
                  content: `${prefix}[ÂàÜ‰∫´‰∫Ü‰∏Ä‰∏™RedditÂ∏ñÂ≠ê]\nÊ†áÈ¢ò: ${rData.title}\nÊù•Ëá™: ${rData.subreddit}\nÂÜÖÂÆπÊëòË¶Å: ${rData.selftext || '[ÈìæÊé•/ÂõæÁâá]'}`
                };
              }
              if (msg.type === 'transfer') return {
                role: 'user',
                content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} ÂêëÂØπÊñπÂèëËµ∑‰∫ÜËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}„ÄÇÁ≠âÂæÖÂØπÊñπÂ§ÑÁêÜ„ÄÇ]`
              };
              if (msg.type === 'waimai_request') return {
                role: 'user',
                content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} ÂèëËµ∑‰∫ÜÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºåÂïÜÂìÅÊòØ‚Äú${msg.productInfo}‚ÄùÔºåÈáëÈ¢ùÊòØ ${msg.amount} ÂÖÉ„ÄÇ]`
              };
              else if (msg.type === 'gift') {
                const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('„ÄÅ ');
                let recipientSummary = chat.isGroup ? `ÈÄÅÁªô‰∫Ü ${msg.recipients.map(name => getDisplayNameInGroup(chat, name)).join('„ÄÅ ')}` : `ÈÄÅÁªô‰∫Ü ${chat.name}`;
                return {
                  role: 'user',
                  content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† ${recipientSummary}ÔºåÁ§ºÁâ©ÊòØÔºö${itemsSummary}]`
                };
              }
              if (msg.meaning) return {
                role: 'user',
                content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØÔºö'${msg.meaning}']`
              };
              return {
                role: msg.role,
                content: prefix + contentStr
              };
            } else if (msg.role === 'assistant') {
              let assistantMsgObject = {
                type: msg.type || 'text'
              };
              if (msg.type === 'sticker') {

                assistantMsgObject.meaning = msg.meaning;
              } else if (msg.type === 'transfer') {
                assistantMsgObject.amount = msg.amount;
                assistantMsgObject.note = msg.note;
              } else if (msg.type === 'waimai_request') {
                assistantMsgObject.productInfo = msg.productInfo;
                assistantMsgObject.amount = msg.amount;
              } else {
                if (msg.quote) {
                  assistantMsgObject.quote_reply = {
                    target_sender: msg.quote.senderName,
                    target_content: msg.quote.content,
                    reply_content: msg.content
                  };
                } else {
                  assistantMsgObject.content = msg.content;
                }
              }
              const assistantContent = JSON.stringify([assistantMsgObject]);
              return {
                role: 'assistant',
                content: `(Timestamp: ${msg.timestamp}) ${assistantContent}`
              };
            }
            return null;
          }).filter(Boolean);


          if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            const contextSummaryForApproval = chat.history
              .filter(m => !m.isHidden)
              .slice(-10)
              .map(msg => {
                const sender = msg.role === 'user' ? 'Áî®Êà∑' : chat.name;
                return `${sender}: ${String(msg.content).substring(0, 50)}...`;
              })
              .join('\n');
            const friendRequestInstruction = {
              role: 'user',
              content: `
        [Á≥ªÁªüÈáçË¶ÅÊåá‰ª§]
        Áî®Êà∑Âêë‰Ω†ÂèëÈÄÅ‰∫ÜÂ•ΩÂèãÁî≥ËØ∑ÔºåÁêÜÁî±ÊòØÔºö‚Äú${chat.relationship.applicationReason}‚Äù„ÄÇ
        ‰Ωú‰∏∫ÂèÇËÄÉÔºåËøôÊòØ‰Ω†‰ª¨‰πãÂâçÁöÑÊúÄÂêé‰∏ÄÊÆµËÅäÂ§©ËÆ∞ÂΩïÔºö
        ---
        ${contextSummaryForApproval}
        ---
        ËØ∑‰Ω†Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºå‰ª•Âèä‰Ω†ÁöÑ‰∫∫ËÆæÔºå‰ΩøÁî® friend_request_response Êåá‰ª§ÔºåÂπ∂ËÆæÁΩÆ decision ‰∏∫ 'accept' Êàñ 'reject' Êù•ÂÜ≥ÂÆöÊòØÂê¶ÈÄöËøá„ÄÇ
        `
            };
            messagesPayload.push(friendRequestInstruction);
          }
        }
      }

      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload)

      // ÂàõÂª∫Êñ∞ÁöÑ AbortController
      currentApiController = new AbortController();

      // ÊòæÁ§∫ÊöÇÂÅúË∞ÉÁî®ÊåâÈíÆ
      const stopBtn = document.getElementById('stop-api-call-btn');
      if (stopBtn) {
        stopBtn.style.display = 'flex';
        stopBtn.classList.add('active');
      }

      // ËÆ∞ÂΩïAPIËØ∑Ê±ÇÊï∞ÊçÆ
      const requestData = {
        timestamp: Date.now(),
        chatId: chatId,
        chatName: chat.name,
        model: model,
        systemPrompt: systemPrompt,
        messages: isGemini ? messagesPayload : [{
          role: 'system',
          content: systemPrompt
        }, ...messagesPayload],
        temperature: state.globalSettings.apiTemperature || 0.8,
        isGemini: isGemini,
        apiUrl: isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`
      };

      let response;
      try {
        response = isGemini ?
          await fetch(geminiConfig.url, {
            ...geminiConfig.data,
            signal: currentApiController.signal
          }) :
          await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: model,
              messages: [{
                role: 'system',
                content: systemPrompt
              }, ...messagesPayload],
              temperature: state.globalSettings.apiTemperature || 0.8,
              stream: false
            }),
            signal: currentApiController.signal
          });
      } catch (networkError) {
        // ÈöêËóèÊöÇÂÅúË∞ÉÁî®ÊåâÈíÆ
        if (stopBtn) {
          stopBtn.style.display = 'none';
          stopBtn.classList.remove('active');
        }

        // Ê£ÄÊü•ÊòØÂê¶ÊòØÁî®Êà∑‰∏ªÂä®ÂèñÊ∂à
        if (networkError.name === 'AbortError') {
          console.log('APIË∞ÉÁî®Â∑≤Ë¢´Áî®Êà∑ÂèñÊ∂à');
          // ‰∏çÊ∑ªÂä†‰ªª‰ΩïÊ∂àÊÅØÂà∞ËÅäÂ§©ÂéÜÂè≤ÔºåÈÅøÂÖçAIÁúãÂà∞Á≥ªÁªüÊ∂àÊÅØËÄåÂõ∞ÊÉë
          return;
        }
        throw new Error(`ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•: ${networkError.message}`);
      } finally {
        // Ê∏ÖÁêÜ controller ÂíåÈöêËóèÊåâÈíÆ
        currentApiController = null;
        if (stopBtn) {
          stopBtn.style.display = 'none';
          stopBtn.classList.remove('active');
        }
      }

      if (!response.ok) {
        let errorMsg = `API ËøîÂõûÈîôËØØ: ${response.status} ${response.statusText}`;
        try {
          const errorData = await response.json();
          if (errorData.error && errorData.error.message) {
            errorMsg += ` - ${errorData.error.message}`;
          } else {
            errorMsg += ` - ${JSON.stringify(errorData)}`;
          }
        } catch (jsonError) {
          errorMsg += ` - ÂìçÂ∫îÂÜÖÂÆπ: ${await response.text()}`;
        }
        throw new Error(errorMsg);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      // ËÆ∞ÂΩïAPIÂìçÂ∫îÊï∞ÊçÆ
      const responseData = {
        ...requestData,
        responseTimestamp: Date.now(),
        responseData: data,
        aiResponseContent: aiResponseContent,
        responseStatus: response.status,
        responseStatusText: response.statusText
      };

      // ÊñπÊ°à4ÔºöÂè™ÊúâÂú®ÂÖ®Â±ÄËÆæÁΩÆ‰∏≠ÂêØÁî®APIÂéÜÂè≤ËÆ∞ÂΩïÊó∂Êâç‰øùÂ≠ò
      if (state.globalSettings.enableApiHistory) {
        // ‰øùÂ≠òÂà∞ËÅäÂ§©ÁöÑAPIÂéÜÂè≤‰∏≠
        if (!chat.apiHistory) {
          chat.apiHistory = [];
        }
        chat.apiHistory.push(responseData);

        // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÈáèÔºåÂè™‰øùÁïôÊúÄËøë50Êù°
        if (chat.apiHistory.length > 50) {
          chat.apiHistory = chat.apiHistory.slice(-50);
        }
      }

      // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
      await db.chats.put(chat);

      lastRawAiResponse = aiResponseContent;
      lastResponseTimestamps = [];
      chat.history = chat.history.filter(msg => !msg.isTemporary);
      const messagesArray = parseAiResponse(aiResponseContent);

      let consolidatedMessages = [];
      if (chat.settings.isOfflineMode) {

        let offlineBuffer = {
          content: [],
          dialogue: [],
          description: []
        };

        for (const msgData of messagesArray) {
          if (msgData.type === 'offline_text') {

            if (msgData.content) {
              offlineBuffer.content.push(msgData.content);
            } else {
              if (msgData.dialogue) offlineBuffer.dialogue.push(msgData.dialogue);
              if (msgData.description) offlineBuffer.description.push(msgData.description);
            }
          } else {

            if (offlineBuffer.content.length > 0 || offlineBuffer.dialogue.length > 0 || offlineBuffer.description.length > 0) {
              if (offlineBuffer.content.length > 0) {
                consolidatedMessages.push({
                  type: 'offline_text',
                  content: offlineBuffer.content.join('\n')
                });
              }
              if (offlineBuffer.dialogue.length > 0 || offlineBuffer.description.length > 0) {
                consolidatedMessages.push({
                  type: 'offline_text',
                  dialogue: offlineBuffer.dialogue.join('\n'),
                  description: offlineBuffer.description.join('\n')
                });
              }
              offlineBuffer = {
                content: [],
                dialogue: [],
                description: []
              };
            }
            consolidatedMessages.push(msgData);
          }
        }


        if (offlineBuffer.content.length > 0) {
          consolidatedMessages.push({
            type: 'offline_text',
            content: offlineBuffer.content.join('\n')
          });
        }
        if (offlineBuffer.dialogue.length > 0 || offlineBuffer.description.length > 0) {
          consolidatedMessages.push({
            type: 'offline_text',
            dialogue: offlineBuffer.dialogue.join('\n'),
            description: offlineBuffer.description.join('\n')
          });
        }

      } else {
        consolidatedMessages = messagesArray;
      }




      const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).pop();
      if (lastUserMessage &&
        Array.isArray(lastUserMessage.content) &&
        lastUserMessage.content[0]?.type === 'image_url' &&
        !lastUserMessage.imageProcessed) {

        const firstTextResponse = messagesArray.find(msg => msg.type === 'text');
        let description;
        if (firstTextResponse && (firstTextResponse.content || firstTextResponse.message)) {
          description = String(firstTextResponse.content || firstTextResponse.message).trim();
        } else {
          description = "AIÂ∑≤Êé•Êî∂Âπ∂ÁêÜËß£‰∫ÜËØ•ÂõæÁâáÁöÑÂÜÖÂÆπ„ÄÇ";
        }

        const imageMessageIndex = chat.history.findIndex(m => m.timestamp === lastUserMessage.timestamp);

        if (imageMessageIndex > -1) {
          console.log(`ËØÜÂõæ‰ºòÂåñÔºöÊ≠£Âú®Â∞ÜÊó∂Èó¥Êà≥‰∏∫ ${lastUserMessage.timestamp} ÁöÑÂõæÁâáÊ∂àÊÅØÊõøÊç¢‰∏∫ÊñáÂ≠óÊèèËø∞...`);

          const replacementText = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑‰πãÂâçÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåAIÂØπÂõæÁâáÁöÑÈ¶ñÊ¨°ÂõûÂ∫îÔºàÊëòË¶ÅÔºâÊòØÔºö‚Äú${description}‚Äù]`;

          // =========== ‰øÆÊîπÂºÄÂßã (Ê≥®ÈáäÊéâ‰∏ãÈù¢Ëøô‰∏§Ë°å) ===========

          // chat.history[imageMessageIndex].content = replacementText; // <--- Ê≥®ÈáäÊéâËøôË°åÔºå‰∏çË¶ÅÊõøÊç¢ÂéüÊú¨ÁöÑÂõæÁâáÂÜÖÂÆπ

          chat.history[imageMessageIndex].imageProcessed = true; // ‰øùÁïôËøôË°åÔºåÊ†áËÆ∞Â∑≤Â§ÑÁêÜÔºåÈò≤Ê≠¢ÈáçÂ§çËØÜÂà´

          // chat.history[imageMessageIndex].type = 'text'; // <--- Ê≥®ÈáäÊéâËøôË°åÔºå‰∏çË¶ÅÊîπÂèòÊ∂àÊÅØÁ±ªÂûã

          // =========== ‰øÆÊîπÁªìÊùü ===========
        }
      }

      const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
      let callHasBeenHandled = false;
      let messageTimestamp = Date.now();
      let newMessagesToRender = [];
      let notificationShown = false;

      for (const msgData of consolidatedMessages) {
        if (msgData.type === 'thought_chain') {
          // Â¶ÇÊûú‰Ω†‰ªçÊÉ≥Âú®ÊéßÂà∂Âè∞ÁúãÂà∞ÂÆÉÔºåÂèØ‰ª•‰øùÁïô‰∏ãÈù¢ËøôË°å console.log
          // console.log("ü§ñ AI ÊÑüÊÄßÊÄùÁª¥Èìæ (Â∑≤ËøáÊª§):", msgData); 
          continue; // Áõ¥Êé•Ë∑≥ËøáÔºå‰∏çÊâßË°å‰ªª‰Ωï‰øùÂ≠òÊìç‰Ωú
        }
        if (chat.settings.enableTts !== false && msgData.type === 'text' && typeof msgData.content === 'string' && msgData.content.trim().startsWith('[V]')) {
          msgData.type = 'voice_message';
          msgData.content = msgData.content.replace('[V]', '').trim();
        }
        if (chat.isGroup && msgData.name && msgData.name === chat.name) {
          console.error(`AIÂπªËßâÂ∑≤Ë¢´Êã¶Êà™ÔºÅËØïÂõæ‰ΩøÁî®Áæ§Âêç ("${chat.name}") ‰Ωú‰∏∫ËßíËâ≤Âêç„ÄÇÊ∂àÊÅØÂÜÖÂÆπ:`, msgData);
          continue;
        }
        if (!msgData || typeof msgData !== 'object') {
          console.warn("Êî∂Âà∞‰∫ÜÊ†ºÂºè‰∏çËßÑËåÉÁöÑAIÊåá‰ª§ÔºåÂ∑≤Ë∑≥Ëøá:", msgData);
          continue;
        }
        if (!msgData.type) {
          if (chat.isGroup && msgData.name && msgData.message) {
            msgData.type = 'text';
          } else if (msgData.content) {
            msgData.type = 'text';
          } else {
            console.warn("Êî∂Âà∞‰∫ÜÊ†ºÂºè‰∏çËßÑËåÉÁöÑAIÊåá‰ª§ÔºàÁº∫Â∞ëtypeÂíåcontentÔºâÔºåÂ∑≤Ë∑≥Ëøá:", msgData);
            continue;
          }
        }

        if (msgData.type === 'video_call_response') {
          videoCallState.isAwaitingResponse = false;
          if (msgData.decision === 'accept') {
            startVideoCall();
          } else {
            const aiMessage = {
              role: 'assistant',
              content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ',
              timestamp: Date.now()
            };
            chat.history.push(aiMessage);
            await db.chats.put(chat);
            showScreen('chat-interface-screen');
            renderChatInterface(chatId);
          }
          callHasBeenHandled = true;
          break;
        }

        if (msgData.type === 'voice_call_response') {
          voiceCallState.isAwaitingResponse = false;
          if (msgData.decision === 'accept') {
            startVoiceCall();
          } else {
            const aiMessage = {
              role: 'assistant',
              content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËØ≠Èü≥ÈÄöËØùËØ∑Ê±Ç„ÄÇ',
              timestamp: Date.now()
            };
            chat.history.push(aiMessage);
            await db.chats.put(chat);
            showScreen('chat-interface-screen');
            renderChatInterface(chatId);
          }
          callHasBeenHandled = true;
          break;
        }

        if (msgData.type === 'group_call_response') {
          if (msgData.decision === 'join') {
            const member = chat.members.find(m => m.originalName === msgData.name);
            if (member && !videoCallState.participants.some(p => p.id === member.id)) {
              videoCallState.participants.push(member);
            }
          }
          callHasBeenHandled = true;
          continue;
        }

        if (chat.isGroup && msgData.name && msgData.name === chat.name) {
          console.error(`AIÂπªËßâÂ∑≤Ë¢´Êã¶Êà™ÔºÅËØïÂõæ‰ΩøÁî®Áæ§Âêç ("${chat.name}") ‰Ωú‰∏∫ËßíËâ≤Âêç„ÄÇÊ∂àÊÅØÂÜÖÂÆπ:`, msgData);
          continue;
        }

        if (chat.isGroup && !msgData.name && msgData.type !== 'narration') {
          console.error(`AIÂπªËßâÂ∑≤Ë¢´Êã¶Êà™ÔºÅËØïÂõæÂú®Áæ§ËÅä‰∏≠ÂèëÈÄÅ‰∏ÄÊù°Ê≤°Êúâ‚Äúname‚ÄùÁöÑÊ∂àÊÅØ„ÄÇÊ∂àÊÅØÂÜÖÂÆπ:`, msgData);
          continue;
        }

        // Á∫†Ê≠£AIÂèØËÉΩËøîÂõûÁæ§ÊòµÁß∞ËÄåÈùûÊú¨ÂêçÁöÑÈóÆÈ¢ò
        if (chat.isGroup && msgData.name) {
          const exactMember = chat.members.find(m => m.originalName === msgData.name);
          if (!exactMember) {
            const nicknameMember = chat.members.find(m => m.groupNickname === msgData.name);
            if (nicknameMember) {
              msgData.name = nicknameMember.originalName;
            }
          }
        }

        let aiMessage = null;
        const currentMessageTimestamp = messageTimestamp++;
        const baseMessage = {
          role: 'assistant',
          senderName: msgData.name || chat.name,
          timestamp: currentMessageTimestamp
        };

        lastResponseTimestamps.push(currentMessageTimestamp);

        switch (msgData.type) {
          case 'add_todo': {
            if (!chat.settings.enableTodoList) continue;

            const todoContent = msgData.content;
            const todoDate = msgData.date || new Date().toISOString().split('T')[0];
            const todoTime = msgData.time || '';
            const todoType = msgData.task_type || 'Êó•Â∏∏';


            const todoStatus = (msgData.status === 'completed') ? 'completed' : 'pending';

            if (todoContent) {
              if (!chat.todoList) chat.todoList = [];

              const newTodo = {
                id: Date.now() + Math.random(),
                content: todoContent,
                date: todoDate,
                time: todoTime,
                type: todoType,

                status: todoStatus, // <--- ËøôÈáå‰ΩøÁî®ÂèòÈáè

                creator: 'char',
                timestamp: Date.now()
              };

              chat.todoList.push(newTodo);

              // (ÂèØÈÄâ) Â¶ÇÊûúÊòØÂ∑≤ÂÆåÊàêÁöÑ‰ªªÂä°ÔºåÁ≥ªÁªüÊèêÁ§∫‰πüÂèØ‰ª•Á®çÂæÆÂèò‰∏Ä‰∏ã
              const actionText = todoStatus === 'completed' ? 'ËÆ∞ÂΩï‰∫Ü‰∏ÄÊù°Â∑≤ÂÆåÊàê‰∫ãÈ°π' : '‰∏∫‰Ω†Ê∑ªÂä†‰∫ÜÂæÖÂäû';
              visibleSystemMessage = {
                content: `[${chat.name} ${actionText}: "${todoContent}"]`
              };

              console.log(`AI Ê∑ªÂä†‰∫ãÈ°π: ${todoContent}, Áä∂ÊÄÅ: ${todoStatus}`);
            }
            break;
          }
          case 'narration':
            aiMessage = {
              role: 'system', // Âº∫Âà∂ËÆæ‰∏∫ system ËßíËâ≤‰ª•‰æøÂ±Ö‰∏≠ÊòæÁ§∫
              type: 'narration',
              content: msgData.content,
              senderName: 'ÊóÅÁôΩ',
              timestamp: messageTimestamp++ // „Äê‰øÆÂ§ç„ÄëËøôÈáåÂøÖÈ°ªÁî® messageTimestamp
            };
            break;
          case 'synth_music':

            if (!chat.settings.enableSynthMusic) {
              continue;
            }


            aiMessage = {
              ...baseMessage, // ÁªßÊâøÂü∫Á°ÄÂ±ûÊÄß (role, timestampÁ≠â)
              type: 'synth_music',
              // Á°Æ‰øùÁæ§ËÅäÊó∂ÂêçÂ≠óÊ≠£Á°Æ (‰ºòÂÖàÁî®AIËøîÂõûÁöÑÂêçÂ≠ó)
              senderName: msgData.name || chat.originalName,
              title: msgData.title || 'Âç≥ÂÖ¥ÊóãÂæã',
              reason: msgData.reason || '',
              instrument: msgData.instrument || 'piano',
              notes: msgData.notes || []
            };


            break;
          case 'buy_item': {
            const itemName = msgData.item_name;
            const price = parseFloat(msgData.price);
            const reason = msgData.reason || 'ÊÉ≥‰π∞';

            if (!itemName || isNaN(price) || price <= 0) continue; // Êï∞ÊçÆÊó†ÊïàË∑≥Ëøá

            // 1. ÈáçÊñ∞Ëé∑ÂèñÈí±ÂåÖÊï∞ÊçÆÔºàÁ°Æ‰øùÂÆûÊó∂ÊÄßÔºâ
            const currentWallet = await db.userWallet.get('main');
            const cardIndex = currentWallet?.kinshipCards?.findIndex(c => c.chatId === chat.id);

            if (cardIndex > -1) {
              const card = currentWallet.kinshipCards[cardIndex];
              const remaining = card.limit - (card.spent || 0);

              if (remaining >= price) {
                // 2. ÊâßË°åÊâ£Ê¨æ
                currentWallet.kinshipCards[cardIndex].spent = (card.spent || 0) + price;
                await db.userWallet.put(currentWallet);

                // 3. ËÆ∞ÂΩïË¥¶Âçï
                await db.userTransactions.add({
                  timestamp: Date.now(),
                  type: 'expense',
                  amount: price,
                  description: `‰∫≤Â±ûÂç°Ê∂àË¥π-${chat.name}-${itemName}`
                });

                // 4. ÁîüÊàêÁ≥ªÁªüÈÄöÁü•Ê∂àÊÅØ (AIÂèëÈÄÅÁöÑ)
                const successMsg = {
                  role: 'assistant', // ÊàñËÄÖÊòØ 'system'ÔºåÁúã‰Ω†ÂñúÂ•Ω
                  senderName: chat.name, // Âä†‰∏äËøô‰∏™Á°Æ‰øùÁæ§ËÅäÊòæÁ§∫Ê≠£Â∏∏
                  type: 'text', // ÊàñËÄÖÁî® 'pat_message' Ê†∑Âºè
                  content: `[ÊîØ‰ªòÂÆùÈÄöÁü•] Êàë‰ΩøÁî®‰∫≤Â±ûÂç°Ê∂àË¥π‰∫Ü ¬•${price.toFixed(2)} Ë¥≠‰π∞‰∫Ü‚Äú${itemName}‚Äù„ÄÇ\nüí≠ ${reason}`,
                  timestamp: messageTimestamp++
                };

                chat.history.push(successMsg);

                // Â¶ÇÊûúÊòØÂΩìÂâçÊü•ÁúãÁöÑËÅäÂ§©ÔºåÁõ¥Êé•‰∏äÂ±è
                if (isViewingThisChat) {
                  appendMessage(successMsg, chat);
                } else {
                  // Â¶ÇÊûúÂú®ÂêéÂè∞ÔºåÂèëÈÄÅÈÄöÁü•
                  showNotification(chat.id, `${chat.name} ‰ΩøÁî®‰∫≤Â±ûÂç°Ê∂àË¥π‰∫Ü ¬•${price}`);
                }

                // 5. (ÂèØÈÄâ) Â∞ÜË¥≠‰π∞ËÆ∞ÂΩïÂÜôÂÖ•ËßíËâ≤ÁöÑÊ®°ÊãüÊ∑òÂÆùÂéÜÂè≤ÔºåÂ¢ûÂä†ÁúüÂÆûÊÑü
                if (!chat.simulatedTaobaoHistory) chat.simulatedTaobaoHistory = { totalBalance: 0, purchases: [] };
                if (!chat.simulatedTaobaoHistory.purchases) chat.simulatedTaobaoHistory.purchases = [];

                chat.simulatedTaobaoHistory.purchases.unshift({
                  itemName: itemName,
                  price: price,
                  status: 'Â∑≤Á≠æÊî∂',
                  reason: reason,
                  image_prompt: `${itemName}, product photography` // ÁÆÄÂçïÁîüÊàê‰∏™prompt
                });

                hasPerformedMajorAction = true; // Ê†áËÆ∞‰∏∫Â∑≤ÊâßË°åÈáçË¶ÅÊìç‰ΩúÔºàÁî®‰∫éÂêéÂè∞Ê¥ªÂä®Ôºâ
              } else {
                console.log(`AI ÊÉ≥Ë¶ÅË¥≠‰π∞ ${itemName} (¬•${price}) ‰ΩÜ‰∫≤Â±ûÂç°‰ΩôÈ¢ù‰∏çË∂≥ (Ââ© ¬•${remaining})`);
                // ÂèØÈÄâÔºöËÆ© AI Âèë‰∏ÄÊù°Ê∂àÊÅØÊä±ÊÄ®Ê≤°Èí±‰∫Ü
                const failMsg = {
                  role: 'assistant',
                  senderName: chat.name,
                  content: `Êú¨Êù•ÊÉ≥‰π∞‚Äú${itemName}‚ÄùÁöÑÔºå‰ΩÜÊòØ‰∫≤Â±ûÂç°È¢ùÂ∫¶Â•ΩÂÉè‰∏çÂ§ü‰∫Ü... (¬•${price})`,
                  timestamp: messageTimestamp++
                };
                chat.history.push(failMsg);
                if (isViewingThisChat) appendMessage(failMsg, chat);
              }
            }
            continue;
          }
          case 'kinship_response': {
            // 1. ÊâæÂà∞ÊúÄËøëÁöÑ‰∏ÄÊù° pending ËØ∑Ê±Ç
            const requestMsg = chat.history.findLast(m => m.type === 'kinship_request' && m.status === 'pending');

            if (requestMsg) {
              requestMsg.status = (msgData.decision === 'accept') ? 'accepted' : 'rejected';
              const isGrant = requestMsg.requestType === 'grant' || !requestMsg.requestType; // ÂÖºÂÆπÊóßÊï∞ÊçÆ

              if (msgData.decision === 'accept') {
                // --- ÂêåÊÑèÈÄªËæë ---

                // Âè™ÊúâÂΩìÊòØ 'grant' (Áî®Êà∑ÈÄÅÈí±) Êó∂ÔºåÊâçÂÜôÂÖ•Êú¨Âú∞Èí±ÂåÖÈ¢ùÂ∫¶
                // Â¶ÇÊûúÊòØ 'request' (AI Âá∫Èí±)ÔºåÊú¨Âú∞Èí±ÂåÖÂÖ∂ÂÆû‰∏çÈúÄË¶ÅËÆ∞ÂΩï limitÔºå
                // Âõ†‰∏∫ÁõÆÂâçÁöÑÈí±ÂåÖÁ≥ªÁªüÂè™ËÆ∞ÂΩï "Áî®Êà∑ÁªôÂà´‰∫∫Ëä±ÁöÑÈí±"„ÄÇ
                // ‰ΩÜ‰∏∫‰∫ÜÊòæÁ§∫Â•ΩÁúãÔºå‰πüÂèØ‰ª•Â≠òËøõÂéªÔºå‰ΩÜÂú®Êâ£Ê¨æÈÄªËæëÈáåË¶ÅÂå∫ÂàÜ„ÄÇ
                // ËøôÈáåÁÆÄÂçïËµ∑ËßÅÔºåÊàë‰ª¨ÈÉΩÂ≠òÔºå‰ΩÜÂú® UI ‰∏äÂå∫ÂàÜÊòæÁ§∫„ÄÇ

                const wallet = await db.userWallet.get('main');
                if (!wallet.kinshipCards) wallet.kinshipCards = [];

                const existingIndex = wallet.kinshipCards.findIndex(c => c.chatId === chat.id);
                if (existingIndex > -1) {
                  wallet.kinshipCards[existingIndex].limit = requestMsg.limit;
                  wallet.kinshipCards[existingIndex].type = isGrant ? 'out' : 'in'; // Ê†áËÆ∞ÊñπÂêë
                } else {
                  wallet.kinshipCards.push({
                    chatId: chat.id,
                    limit: requestMsg.limit,
                    spent: 0,
                    type: isGrant ? 'out' : 'in' // out=Áî®Êà∑Âá∫Èí±, in=AIÂá∫Èí±
                  });
                }
                await db.userWallet.put(wallet);

                // --- ÊûÑÈÄ† AI ÂõûÂ§ç ---
                let defaultReason = "";
                if (isGrant) {
                  defaultReason = "ÈÇ£ÊàëÂ∞±‰∏çÂÆ¢Ê∞îÊî∂‰∏ãÂï¶ÔºåË∞¢Ë∞¢‰Ω†ÁöÑÁ§ºÁâ©~"; // AI Êé•ÂèóÈ¶àËµ†
                } else {
                  defaultReason = "Ê≤°ÈóÆÈ¢òÔºå‰ª•ÂêéÊÉ≥‰π∞‰ªÄ‰πàÂ∞±‰π∞ÔºåÊàëÂÖª‰Ω†„ÄÇ"; // AI ÂêåÊÑèÂåÖÂÖªÁî®Êà∑
                }

                aiMessage = {
                  ...baseMessage,
                  type: 'text',
                  content: msgData.reason || defaultReason
                };
              } else {
                // --- ÊãíÁªùÈÄªËæë ---
                let defaultReason = "";
                if (isGrant) {
                  defaultReason = "‰∏çÁî®Âï¶ÔºåÊàëËá™Â∑±ÊúâÈí±Ëä±ÔºåÂøÉÊÑèÈ¢Ü‰∫Ü„ÄÇ"; // AI ÊãíÁªùÈ¶àËµ†
                } else {
                  defaultReason = "Ëøô...ÊúÄËøëÊâãÂ§¥ÊúâÁÇπÁ¥ßÔºå‰∏ãÊ¨°Âêß„ÄÇ"; // AI ÊãíÁªùÂåÖÂÖª
                }

                aiMessage = {
                  ...baseMessage,
                  type: 'text',
                  content: msgData.reason || defaultReason
                };
              }

              await db.chats.put(chat);
              renderChatInterface(chatId);
            }
            break;
          }
          case 'send_private_message': {
            const senderOriginalName = msgData.name;
            const recipientOriginalName = msgData.recipient;

            const userOriginalName = state.qzoneSettings.nickname || '{{user}}';

            if (recipientOriginalName === userOriginalName) {

              const privateChat = Object.values(state.chats).find(c =>
                !c.isGroup && c.originalName === senderOriginalName
              );

              if (privateChat) {

                lastPrivateMessagesSent = [];

                const messagesToSend = Array.isArray(msgData.content) ? msgData.content : [msgData.content];
                let newMessagesCount = 0;

                for (const contentString of messagesToSend) {
                  if (!contentString || !contentString.trim()) continue;

                  const privateMessage = {
                    role: 'assistant',
                    senderName: senderOriginalName,
                    content: contentString,
                    timestamp: messageTimestamp++
                  };


                  lastPrivateMessagesSent.push({
                    chatId: privateChat.id,
                    timestamp: privateMessage.timestamp
                  });

                  privateChat.history.push(privateMessage);
                  newMessagesCount++;
                }

                if (newMessagesCount > 0) {
                  if (state.activeChatId !== privateChat.id) {
                    privateChat.unreadCount = (privateChat.unreadCount || 0) + newMessagesCount;
                    showNotification(privateChat.id, `${privateChat.name} ÂèëÊù•‰∫Ü ${newMessagesCount} Êù°Êñ∞Ê∂àÊÅØ`);
                  }
                  await db.chats.put(privateChat);
                }

                aiMessage = null;

              } else {
                console.warn(`AI ${senderOriginalName} Â∞ùËØïÂèëÈÄÅÁßÅ‰ø°Ôºå‰ΩÜÊú™ÊâæÂà∞ÂÖ∂ÂØπÂ∫îÁöÑÁßÅËÅä‰ºöËØù„ÄÇ`);
                aiMessage = null;
              }
            } else {
              console.warn(`AI Â∞ùËØïÂèëÈÄÅÁßÅ‰ø°ÁªôÈùûÁî®Êà∑ËßíËâ≤ (${recipientOriginalName})ÔºåÊ≠§ÂäüËÉΩÊöÇ‰∏çÊîØÊåÅ„ÄÇ`);
              aiMessage = null;
            }

            continue;
          }
          case 'send_group_message': {
            // ËøôÊòØ‰ªéÁßÅËÅä -> Áæ§ËÅä ÁöÑÊñ∞ÂäüËÉΩ
            const senderOriginalName = msgData.name || chat.originalName; // 'chat' ÊòØÂΩìÂâçÁöÑÁßÅËÅä
            const targetGroupName = msgData.targetGroupName;
            const messagesToSend = Array.isArray(msgData.content) ? msgData.content : [String(msgData.content)];

            if (!targetGroupName) {
              console.warn(`AI ${senderOriginalName} Â∞ùËØïÂèëÈÄÅÁæ§ËÅäÊ∂àÊÅØÔºå‰ΩÜÊú™ÊåáÂÆö targetGroupName„ÄÇ`);
              continue;
            }

            // 1. Êü•ÊâæÁõÆÊ†áÁæ§ËÅäÔºåÂπ∂Á°Æ‰øùAIÊòØËØ•Áæ§ÁöÑÊàêÂëò
            const targetGroupChat = Object.values(state.chats).find(c =>
              c.isGroup &&
              c.name === targetGroupName &&
              c.members.some(m => m.originalName === senderOriginalName)
            );

            if (targetGroupChat) {
              // 2. ÊâæÂà∞‰∫ÜÁæ§ËÅäÔºåÂáÜÂ§áÂèëÈÄÅÊ∂àÊÅØ
              let newMessagesCount = 0;
              for (const contentString of messagesToSend) {
                if (!contentString || !contentString.trim()) continue;

                // 3. ÂàõÂª∫‰∏Ä‰∏™Ê†áÂáÜÁæ§ËÅäAIÊ∂àÊÅØ
                const groupMessage = {
                  role: 'assistant',
                  senderName: senderOriginalName, // AIÁöÑÊú¨Âêç
                  content: contentString,
                  timestamp: messageTimestamp++ // ‰ΩøÁî®‰∏ªÂæ™ÁéØÁöÑÊó∂Èó¥Êà≥
                };

                // 4. Â∞ÜÊ∂àÊÅØÊ∑ªÂä†Âà∞ÁõÆÊ†áÁæ§ËÅäÁöÑÂéÜÂè≤ËÆ∞ÂΩï‰∏≠
                targetGroupChat.history.push(groupMessage);
                newMessagesCount++;
              }

              if (newMessagesCount > 0) {
                // 5. Êõ¥Êñ∞Áæ§ËÅäÁöÑÊú™ËØªÁä∂ÊÄÅÂíåÈÄöÁü•
                if (state.activeChatId !== targetGroupChat.id) {
                  targetGroupChat.unreadCount = (targetGroupChat.unreadCount || 0) + newMessagesCount;

                  // ‰∏∫‰∫ÜÈÄöÁü•ÔºåËé∑ÂèñAIÂú®ËØ•Áæ§ÁöÑÁæ§ÊòµÁß∞
                  const member = targetGroupChat.members.find(m => m.originalName === senderOriginalName);
                  const senderDisplayName = member ? member.groupNickname : senderOriginalName;

                  showNotification(targetGroupChat.id, `${senderDisplayName}: ${messagesToSend[0]}`);
                }

                // 6. ‰øùÂ≠òÂØπ *ÁõÆÊ†áÁæ§ËÅä* ÁöÑÊõ¥Êîπ
                await db.chats.put(targetGroupChat);
                state.chats[targetGroupChat.id] = targetGroupChat; // Á°Æ‰øùÂÜÖÂ≠òÁä∂ÊÄÅ‰πüÊõ¥Êñ∞
              }

              // 7. ËøôÊù°Ê∂àÊÅØ‰∏çÂ∫îÊòæÁ§∫Âú®ÂΩìÂâçÁöÑÁßÅËÅä‰∏≠ÔºåÊâÄ‰ª•ËÆæÁΩÆ aiMessage ‰∏∫ null
              aiMessage = null;

            } else {
              console.warn(`AI ${senderOriginalName} Â∞ùËØïÂêë‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑÊàñTA‰∏çÂú®ÁöÑÁæ§ËÅä "${targetGroupName}" ÂèëÈÄÅÊ∂àÊÅØ„ÄÇ`);
              // (ÂèØÈÄâ) ÂèØ‰ª•Âú®ÁßÅËÅä‰∏≠ÁîüÊàê‰∏ÄÊù° "ÂèëÈÄÅÂ§±Ë¥•" ÁöÑÊ∂àÊÅØÔºå‰ΩÜÁõÆÂâç‰øùÊåÅÂÆâÈùô
              aiMessage = null;
            }

            continue; // ÁªßÁª≠Â§ÑÁêÜ‰∏ã‰∏ÄÊù°Êåá‰ª§
          }
          case 'view_myphone':
            // Â§ÑÁêÜÊü•ÁúãUserÊâãÊú∫ÁöÑËØ∑Ê±Ç
            if (!chat.isGroup && msgData.apps) {
              const userChat = state.chats[chatId]; // ÂΩìÂâçËÅäÂ§©Â∞±ÊòØUserÁöÑËßíËâ≤
              let appsToView = Array.isArray(msgData.apps) ? msgData.apps : [msgData.apps];

              // Â¶ÇÊûúÂåÖÂê´"all"ÔºåÂàôÊü•ÁúãÊâÄÊúâAPP
              if (appsToView.includes('all')) {
                appsToView = ['qq', 'album', 'taobao', 'amap', 'browser', 'memo', 'diary', 'music', 'app_usage'];
              }

              let viewResults = [];

              // ÈÅçÂéÜË¶ÅÊü•ÁúãÁöÑAPP
              for (const app of appsToView) {
                let appData = null;
                let appName = '';

                switch (app) {
                  case 'qq':
                    appName = 'QQ';
                    appData = userChat.myPhoneSimulatedQQConversations || [];
                    if (appData.length > 0) {
                      const qqSummary = appData.slice(0, 5).map(conv => {
                        const latestMsg = conv.messages && conv.messages.length > 0
                          ? conv.messages[conv.messages.length - 1]
                          : null;
                        return `- ${conv.name}: ${latestMsg ? latestMsg.content.substring(0, 30) + '...' : 'ÊöÇÊó†Ê∂àÊÅØ'}`;
                      }).join('\n');
                      viewResults.push(`**QQËÅäÂ§©ÂàóË°®** (ÂÖ±${appData.length}‰∏™ËÅîÁ≥ª‰∫∫):\n${qqSummary}`);
                    } else {
                      viewResults.push(`**QQËÅäÂ§©ÂàóË°®**: Á©∫ÁöÑ`);
                    }
                    break;

                  case 'album':
                    appName = 'Áõ∏ÂÜå';
                    appData = userChat.myPhoneAlbum || [];
                    if (appData.length > 0) {
                      const albumSummary = appData.slice(0, 5).map(photo =>
                        `- ${new Date(photo.timestamp).toLocaleString()}: ${photo.description || 'Êó†ÊèèËø∞'}`
                      ).join('\n');
                      viewResults.push(`**Áõ∏ÂÜå** (ÂÖ±${appData.length}Âº†ÁÖßÁâá):\n${albumSummary}`);
                    } else {
                      viewResults.push(`**Áõ∏ÂÜå**: Á©∫ÁöÑ`);
                    }
                    break;

                  case 'taobao':
                    appName = 'Ê∑òÂÆù';
                    appData = userChat.myPhoneTaobaoHistory || [];
                    if (appData.length > 0) {
                      const taobaoSummary = appData.slice(0, 5).map(order =>
                        `- ${order.productName}: ¬•${order.price} (${order.status})`
                      ).join('\n');
                      viewResults.push(`**Ê∑òÂÆùËÆ¢Âçï** (ÂÖ±${appData.length}‰∏™ËÆ¢Âçï):\n${taobaoSummary}`);
                    } else {
                      viewResults.push(`**Ê∑òÂÆùËÆ¢Âçï**: Á©∫ÁöÑ`);
                    }
                    break;

                  case 'amap':
                    appName = 'È´òÂæ∑Âú∞Âõæ';
                    appData = userChat.myPhoneAmapHistory || [];
                    if (appData.length > 0) {
                      const amapSummary = appData.slice(0, 5).map(record =>
                        `- ${new Date(record.timestamp).toLocaleString()}: ${record.location}`
                      ).join('\n');
                      viewResults.push(`**È´òÂæ∑Âú∞ÂõæË∂≥Ëøπ** (ÂÖ±${appData.length}Êù°ËÆ∞ÂΩï):\n${amapSummary}`);
                    } else {
                      viewResults.push(`**È´òÂæ∑Âú∞ÂõæË∂≥Ëøπ**: Á©∫ÁöÑ`);
                    }
                    break;

                  case 'browser':
                    appName = 'ÊµèËßàÂô®';
                    appData = userChat.myPhoneBrowserHistory || [];
                    if (appData.length > 0) {
                      const browserSummary = appData.slice(0, 5).map(record =>
                        `- ${new Date(record.timestamp).toLocaleString()}: ${record.title}`
                      ).join('\n');
                      viewResults.push(`**ÊµèËßàÂô®ÂéÜÂè≤** (ÂÖ±${appData.length}Êù°ËÆ∞ÂΩï):\n${browserSummary}`);
                    } else {
                      viewResults.push(`**ÊµèËßàÂô®ÂéÜÂè≤**: Á©∫ÁöÑ`);
                    }
                    break;

                  case 'memo':
                    appName = 'Â§áÂøòÂΩï';
                    appData = userChat.myPhoneMemos || [];
                    if (appData.length > 0) {
                      const memoSummary = appData.slice(0, 5).map(memo =>
                        `- ${memo.title || 'Êó†Ê†áÈ¢ò'}: ${memo.content.substring(0, 30)}...`
                      ).join('\n');
                      viewResults.push(`**Â§áÂøòÂΩï** (ÂÖ±${appData.length}Êù°):\n${memoSummary}`);
                    } else {
                      viewResults.push(`**Â§áÂøòÂΩï**: Á©∫ÁöÑ`);
                    }
                    break;

                  case 'diary':
                    appName = 'Êó•ËÆ∞';
                    appData = userChat.myPhoneDiaries || [];
                    if (appData.length > 0) {
                      const diarySummary = appData.slice(0, 3).map(diary =>
                        `- ${diary.date}: ${diary.content.substring(0, 50)}...`
                      ).join('\n');
                      viewResults.push(`**Êó•ËÆ∞** (ÂÖ±${appData.length}ÁØá):\n${diarySummary}`);
                    } else {
                      viewResults.push(`**Êó•ËÆ∞**: Á©∫ÁöÑ`);
                    }
                    break;

                  case 'music':
                    appName = 'ÁΩëÊòì‰∫ëÈü≥‰πê';
                    appData = userChat.myPhoneMusicPlaylist || [];
                    if (appData.length > 0) {
                      const musicSummary = appData.slice(0, 5).map(song =>
                        `- ${song.title} - ${song.artist}`
                      ).join('\n');
                      viewResults.push(`**ÁΩëÊòì‰∫ëÈü≥‰πêÊí≠ÊîæÂàóË°®** (ÂÖ±${appData.length}È¶ñÊ≠å):\n${musicSummary}`);
                    } else {
                      viewResults.push(`**ÁΩëÊòì‰∫ëÈü≥‰πêÊí≠ÊîæÂàóË°®**: Á©∫ÁöÑ`);
                    }
                    break;

                  case 'app_usage':
                    appName = 'APP‰ΩøÁî®ËÆ∞ÂΩï';
                    appData = userChat.myPhoneAppUsage || [];
                    if (appData.length > 0) {
                      const usageSummary = appData.slice(0, 5).map(record => {
                        const hours = Math.floor(record.usageTimeMinutes / 60);
                        const minutes = record.usageTimeMinutes % 60;
                        let timeString = '';
                        if (hours > 0) timeString += `${hours}Â∞èÊó∂`;
                        if (minutes > 0) timeString += `${minutes}ÂàÜÈíü`;
                        if (!timeString) timeString = 'Â∞è‰∫é1ÂàÜÈíü';
                        return `- ${record.appName} (${record.category || 'ÂÖ∂‰ªñ'}): ${timeString}`;
                      }).join('\n');
                      viewResults.push(`**APP‰ΩøÁî®ËÆ∞ÂΩï** (ÂÖ±${appData.length}Êù°):\n${usageSummary}`);
                    } else {
                      viewResults.push(`**APP‰ΩøÁî®ËÆ∞ÂΩï**: Á©∫ÁöÑ`);
                    }
                    break;
                }
              }

              // Â∞ÜÊü•ÁúãÁªìÊûú‰Ωú‰∏∫ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÊ≥®ÂÖ•Âà∞ÂØπËØù‰∏≠
              const viewResultMessage = {
                role: 'system',
                content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Êü•Áúã‰∫Ü${chat.settings.myNickname || 'Áî®Êà∑'}ÁöÑÊâãÊú∫Ôºå‰ª•‰∏ãÊòØÁúüÂÆûÊï∞ÊçÆ]\n\n${viewResults.join('\n\n')}\n\n[ËØ∑Âü∫‰∫é‰ª•‰∏äÁúüÂÆûÊï∞ÊçÆÁªôÂá∫‰Ω†ÁöÑÊÑüÊÉ≥ÂíåÂèçÂ∫îÔºå‰∏çË¶ÅÁºñÈÄ†ÂÜÖÂÆπ]`,
                timestamp: Date.now(),
                isHidden: true
              };

              chat.history.push(viewResultMessage);
              console.log(`üì± AIÊü•Áúã‰∫ÜUserÊâãÊú∫: ${appsToView.join(', ')}`);
            }
            continue;
          case 'update_thoughts':
            if (!chat.isGroup) {
              if (msgData.heartfelt_voice) {
                chat.heartfeltVoice = String(msgData.heartfelt_voice);
              }
              if (msgData.random_jottings) {
                chat.randomJottings = String(msgData.random_jottings);
              }
              if (!Array.isArray(chat.thoughtsHistory)) {
                chat.thoughtsHistory = [];
              }
              chat.thoughtsHistory.push({
                heartfeltVoice: chat.heartfeltVoice,
                randomJottings: chat.randomJottings,
                timestamp: Date.now()
              });
              if (chat.thoughtsHistory.length > 50) {
                chat.thoughtsHistory.shift();
              }



              const thoughtForMemory = `[ËøôÊòØ‰Ω†‰∏ä‰∏ÄËΩÆÁöÑÂÜÖÂøÉÁã¨ÁôΩÂíåÊÄùËÄÉ]
- ÂøÉÂ£∞: ${chat.heartfeltVoice}
- Êï£ËÆ∞: ${chat.randomJottings}`;


              const hiddenThoughtMessage = {
                role: 'system',
                content: thoughtForMemory,
                timestamp: Date.now(),
                isHidden: true
              };




            }
            continue;
          case 'change_user_nickname':
            if (!chat.isGroup && msgData.new_name) {
              const newNickname = msgData.new_name.trim();
              if (newNickname) {
                chat.settings.myNickname = newNickname;

                const systemMessage = {
                  role: 'system',
                  type: 'pat_message',
                  content: `‚Äú${chat.name}‚Äù Â∞ÜÂØπ‰Ω†ÁöÑÁß∞Âëº‰øÆÊîπ‰∏∫ ‚Äú${newNickname}‚Äù`,
                  timestamp: messageTimestamp++
                };
                chat.history.push(systemMessage);

                const hiddenMemoryMessage = {
                  role: 'system',
                  content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöÊàêÂäüÂ∞ÜÂØπÁî®Êà∑ÁöÑÁß∞Âëº‰øÆÊîπ‰∏∫‰∫Ü‚Äú${newNickname}‚Äù„ÄÇ]`,
                  timestamp: messageTimestamp++,
                  isHidden: true
                };
                chat.history.push(hiddenMemoryMessage);

                if (isViewingThisChat) {
                  appendMessage(systemMessage, chat);
                }
              }
            }
            continue;
          case 'change_remark_name':
            if (!chat.isGroup && msgData.new_name) {
              const oldName = chat.name;
              const newName = msgData.new_name.trim();

              if (newName && newName !== oldName) {
                if (!chat.nameHistory) {
                  chat.nameHistory = [];
                }
                if (!chat.nameHistory.includes(oldName)) {
                  chat.nameHistory.push(oldName);
                }

                chat.name = newName;

                const systemMessage = {
                  role: 'system',
                  type: 'pat_message',
                  content: `‚Äú${chat.originalName}‚Äù Â∞ÜÂ§áÊ≥®‰øÆÊîπ‰∏∫ ‚Äú${newName}‚Äù`,
                  timestamp: messageTimestamp++
                };
                chat.history.push(systemMessage);

                const hiddenMemoryMessage = {
                  role: 'system',
                  content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöÊàêÂäüÂ∞ÜËá™Â∑±ÁöÑÂ§áÊ≥®Âêç‰øÆÊîπ‰∏∫‰∫Ü‚Äú${newName}‚Äù„ÄÇËØ∑Ëá™ÁÑ∂Âú∞Êé•ÂèóËøô‰∏™Êñ∞ÂêçÂ≠óÔºå‰∏çË¶ÅÂØπÊ≠§ÊÑüÂà∞ÊÉäËÆ∂„ÄÇ]`,
                  timestamp: messageTimestamp++,
                  isHidden: true
                };
                chat.history.push(hiddenMemoryMessage);

                if (isViewingThisChat) {
                  appendMessage(systemMessage, chat);
                  document.getElementById('chat-header-title').textContent = newName;
                }

                await syncCharacterNameInGroups(chat);
              }
            }
            continue;

          case 'change_avatar': {
            const avatarName = msgData.name;
            const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
            if (foundAvatar) {
              chat.settings.aiAvatar = foundAvatar.url;

              const systemNotice = {
                role: 'system',
                type: 'pat_message',
                content: `[${chat.name} Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè]`,
                timestamp: Date.now()
              };
              chat.history.push(systemNotice);

              await syncCharacterAvatarInGroups(chat);

              if (isViewingThisChat) {
                appendMessage(systemNotice, chat);
                renderChatInterface(chatId);
              }
            }
            continue;
          }
          case 'change_user_avatar': {
            const avatarName = msgData.name;
            const foundAvatar = chat.settings.myAvatarLibrary.find(avatar => avatar.name === avatarName);
            if (foundAvatar) {
              chat.settings.myAvatar = foundAvatar.url;

              const systemNotice = {
                role: 'system',
                type: 'pat_message',
                content: `[${chat.name} Êõ¥Êç¢‰∫Ü‰Ω†ÁöÑÂ§¥ÂÉè]`,
                timestamp: Date.now()
              };
              chat.history.push(systemNotice);

              if (isViewingThisChat) {
                appendMessage(systemNotice, chat);
                renderChatInterface(chatId);
              }
            }
            continue;
          }

          case 'gomoku_move': {

            const x = parseInt(msgData.x);
            const y = parseInt(msgData.y);


            if (!isNaN(x) && !isNaN(y)) {
              handleAiGomokuMove({
                x: x,
                y: y
              });
            } else {
              console.warn("AIÁöÑ‰∫îÂ≠êÊ£ãÁßªÂä®Êåá‰ª§ÂåÖÂê´Êó†ÊïàÂùêÊ†áÔºåÂ∑≤ÂøΩÁï•:", msgData);
            }
            continue;
          }

          case 'waimai_response':
            const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
            if (requestMessageIndex > -1) {
              const originalMsg = chat.history[requestMessageIndex];
              originalMsg.status = msgData.status;
              originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null;
            }
            continue;

          case 'qzone_post':
            const newPost = {
              type: msgData.postType,
              content: msgData.content || '',
              publicText: msgData.publicText || '',
              hiddenContent: msgData.hiddenContent || '',
              image_prompt: msgData.image_prompt || '',
              timestamp: Date.now(),
              authorId: chatId,
              authorGroupId: chat.groupId,
              visibleGroupIds: null
            };



            if (msgData.postType === 'naiimag' && msgData.prompt) {
              try {

                const prompts = Array.isArray(msgData.prompt) ? msgData.prompt.slice(0, 2) : [msgData.prompt];
                console.log(`üì∏ Âä®ÊÄÅNovelAIÂõæÁâáÁîüÊàêÂºÄÂßãÔºåÂÖ±${prompts.length}Âº†ÂõæÁâá`);


                const generatedImageUrls = [];


                for (let i = 0; i < prompts.length; i++) {
                  const aiPrompt = prompts[i];
                  console.log(`ÁîüÊàêÁ¨¨${i + 1}Âº†ÂõæÁâáÔºåprompt:`, aiPrompt);


                  const naiPrompts = getCharacterNAIPrompts(chat.id);


                  const finalPositivePrompt = aiPrompt + ', ' + naiPrompts.positive;
                  const finalNegativePrompt = naiPrompts.negative;

                  console.log(`üìù ‰ΩøÁî®${naiPrompts.source === 'character' ? 'ËßíËâ≤‰∏ìÂ±û' : 'Á≥ªÁªü'}ÊèêÁ§∫ËØçÈÖçÁΩÆ`);
                  console.log('ÊúÄÁªàÊ≠£Èù¢ÊèêÁ§∫ËØç:', finalPositivePrompt);
                  console.log('ÊúÄÁªàË¥üÈù¢ÊèêÁ§∫ËØç:', finalNegativePrompt);


                  const apiKey = localStorage.getItem('novelai-api-key');
                  const model = localStorage.getItem('novelai-model') || 'nai-diffusion-4-5-full';
                  const settings = getNovelAISettings();

                  if (!apiKey) {
                    throw new Error('NovelAI API KeyÊú™ÈÖçÁΩÆ„ÄÇËØ∑Âú®NovelAIËÆæÁΩÆ‰∏≠Â°´ÂÜôAPI Key„ÄÇ');
                  }

                  const [width, height] = settings.resolution.split('x').map(Number);


                  let requestBody;

                  if (model.includes('nai-diffusion-4')) {

                    requestBody = {
                      input: finalPositivePrompt,
                      model: model,
                      action: 'generate',
                      parameters: {
                        params_version: 3, // V4ÂøÖÈ°ª‰ΩøÁî®ÁâàÊú¨3
                        width: width,
                        height: height,
                        scale: settings.cfg_scale,
                        sampler: settings.sampler,
                        steps: settings.steps,
                        seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                        n_samples: 1,
                        ucPreset: settings.uc_preset,
                        qualityToggle: settings.quality_toggle,
                        autoSmea: false,
                        dynamic_thresholding: false,
                        controlnet_strength: 1,
                        legacy: false,
                        add_original_image: true,
                        cfg_rescale: 0,
                        noise_schedule: 'karras', // V4‰ΩøÁî®karras
                        legacy_v3_extend: false,
                        skip_cfg_above_sigma: null,
                        use_coords: false,
                        legacy_uc: false,
                        normalize_reference_strength_multiple: true,
                        inpaintImg2ImgStrength: 1,
                        characterPrompts: [],

                        v4_prompt: {
                          caption: {
                            base_caption: finalPositivePrompt,
                            char_captions: []
                          },
                          use_coords: false,
                          use_order: true
                        },

                        v4_negative_prompt: {
                          caption: {
                            base_caption: finalNegativePrompt,
                            char_captions: []
                          },
                          legacy_uc: false
                        },
                        negative_prompt: finalNegativePrompt,
                        deliberate_euler_ancestral_bug: false,
                        prefer_brownian: true

                      }
                    };
                  } else {

                    requestBody = {
                      input: finalPositivePrompt,
                      model: model,
                      action: 'generate',
                      parameters: {
                        width: width,
                        height: height,
                        scale: settings.cfg_scale,
                        sampler: settings.sampler,
                        steps: settings.steps,
                        seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                        n_samples: 1,
                        ucPreset: settings.uc_preset,
                        qualityToggle: settings.quality_toggle,
                        sm: settings.smea,
                        sm_dyn: settings.smea_dyn,
                        dynamic_thresholding: false,
                        controlnet_strength: 1,
                        legacy: false,
                        add_original_image: false,
                        cfg_rescale: 0,
                        noise_schedule: 'native',
                        negative_prompt: finalNegativePrompt
                      }
                    };
                  }

                  console.log('üöÄ ÂèëÈÄÅNAIËØ∑Ê±Ç:', requestBody);


                  let apiUrl;


                  if (model.includes('nai-diffusion-4')) {

                    apiUrl = 'https://image.novelai.net/ai/generate-image-stream';
                  } else {

                    apiUrl = 'https://image.novelai.net/ai/generate-image';
                  }

                  let corsProxy = settings.cors_proxy;


                  if (corsProxy === 'custom') {
                    corsProxy = settings.custom_proxy_url || '';
                  }


                  if (corsProxy && corsProxy !== '') {
                    apiUrl = corsProxy + encodeURIComponent(apiUrl);
                  }

                  const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify(requestBody)
                  });

                  console.log('Response status:', response.status);
                  console.log('Response headers:', [...response.headers.entries()]);

                  if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIÈîôËØØÂìçÂ∫î:', errorText);
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥• (${response.status}): ${errorText}`);
                  }


                  const contentType = response.headers.get('content-type');
                  console.log('Content-Type:', contentType);


                  let zipBlob;
                  let imageDataUrl;
                  if (contentType && contentType.includes('text/event-stream')) {
                    console.log('Ê£ÄÊµãÂà∞ SSE ÊµÅÂºèÂìçÂ∫îÔºåÂºÄÂßãËß£Êûê...');


                    const text = await response.text();
                    console.log('Êî∂Âà∞ SSE Êï∞ÊçÆÔºåÂ§ßÂ∞è:', text.length);


                    const lines = text.trim().split('\n');
                    let base64Data = null;

                    for (let i = lines.length - 1; i >= 0; i--) {
                      const line = lines[i].trim();
                      if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                        const dataContent = line.substring(6);


                        try {
                          const jsonData = JSON.parse(dataContent);


                          if (jsonData.event_type === 'final' && jsonData.image) {
                            base64Data = jsonData.image;
                            console.log('‚úÖ ÊâæÂà∞ final ‰∫ã‰ª∂ÁöÑÂõæÁâáÊï∞ÊçÆ');
                            break;
                          }


                          if (jsonData.data) {
                            base64Data = jsonData.data;
                            console.log('‰ªé JSON.data ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                            break;
                          }
                          if (jsonData.image) {
                            base64Data = jsonData.image;
                            console.log('‰ªé JSON.image ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                            break;
                          }
                        } catch (e) {

                          base64Data = dataContent;
                          console.log('Áõ¥Êé•‰ΩøÁî® base64 Êï∞ÊçÆ');
                          break;
                        }
                      }
                    }

                    if (!base64Data) {
                      throw new Error('Êó†Ê≥ï‰ªé SSE ÂìçÂ∫î‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                    }


                    const isPNG = base64Data.startsWith('iVBORw0KGgo');
                    const isJPEG = base64Data.startsWith('/9j/');

                    if (isPNG || isJPEG) {
                      console.log('‚úÖ Ê£ÄÊµãÂà∞Áõ¥Êé•ÁöÑÂõæÁâá base64 Êï∞ÊçÆ (PNG/JPEG)');

                      const binaryString = atob(base64Data);
                      const bytes = new Uint8Array(binaryString.length);
                      for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                      }
                      const imageBlob = new Blob([bytes], {
                        type: isPNG ? 'image/png' : 'image/jpeg'
                      });
                      console.log('ÂõæÁâá Blob ÂàõÂª∫ÊàêÂäüÔºåÂ§ßÂ∞è:', imageBlob.size);


                      const reader = new FileReader();
                      imageDataUrl = await new Promise((resolve, reject) => {
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(imageBlob);
                      });
                      console.log('‚úÖ ÂõæÁâáËΩ¨Êç¢ÊàêÂäüÔºÅüé®');
                    } else {

                      console.log('ÂΩì‰Ωú ZIP Êñá‰ª∂Â§ÑÁêÜ...');
                      const binaryString = atob(base64Data);
                      const bytes = new Uint8Array(binaryString.length);
                      for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                      }
                      zipBlob = new Blob([bytes]);
                      console.log('ZIP Blob Â§ßÂ∞è:', zipBlob.size);
                    }
                  } else {

                    zipBlob = await response.blob();
                    console.log('Êî∂Âà∞Êï∞ÊçÆÔºåÁ±ªÂûã:', zipBlob.type, 'Â§ßÂ∞è:', zipBlob.size);
                  }


                  if (!imageDataUrl && zipBlob) {

                    try {

                      if (typeof JSZip === 'undefined') {
                        throw new Error('JSZipÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                      }


                      const zip = await JSZip.loadAsync(zipBlob);
                      console.log('ZIPÊñá‰ª∂ÂÜÖÂÆπ:', Object.keys(zip.files));


                      let imageFile = null;
                      for (let filename in zip.files) {
                        if (filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
                          imageFile = zip.files[filename];
                          console.log('ÊâæÂà∞ÂõæÁâáÊñá‰ª∂:', filename);
                          break;
                        }
                      }

                      if (!imageFile) {
                        throw new Error('ZIPÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÂõæÁâá');
                      }


                      const imageBlob = await imageFile.async('blob');
                      console.log('ÊèêÂèñÁöÑÂõæÁâáÂ§ßÂ∞è:', imageBlob.size);


                      const reader = new FileReader();
                      imageDataUrl = await new Promise((resolve, reject) => {
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(imageBlob);
                      });
                      console.log('‚úÖ ÂõæÁâáËß£ÂéãÊàêÂäüÔºÅ');
                    } catch (zipError) {
                      console.error('ZIPËß£ÂéãÂ§±Ë¥•:', zipError);
                      throw new Error('ÂõæÁâáËß£ÂéãÂ§±Ë¥•: ' + zipError.message);
                    }
                  }

                  console.log(`‚úÖ NAIÂõæÁâá${i + 1}ÁîüÊàêÊàêÂäüÔºÅ`);
                  generatedImageUrls.push(imageDataUrl);
                }


                newPost.imageUrls = generatedImageUrls;

                if (generatedImageUrls.length === 1) {
                  newPost.imageUrl = generatedImageUrls[0];
                }

                newPost.prompt = msgData.prompt;
                newPost.imageCount = generatedImageUrls.length;
                console.log(`‚úÖ Âä®ÊÄÅNovelAIÂõæÁâáÂÖ®ÈÉ®ÁîüÊàêÂÆåÊàê: ${generatedImageUrls.length}Âº†`);
              } catch (error) {
                console.error('‚ùå Âä®ÊÄÅNAIÂõæÁâáÁîüÊàêÂ§±Ë¥•:', error);

                newPost.content = (newPost.content || newPost.publicText || '') + `\n[ÂõæÁâáÁîüÊàêÂ§±Ë¥•: ${error.message}]`;
              }
            }

            // Google Imagen Âä®ÊÄÅÂõæÁâáÁîüÊàê
            if (msgData.postType === 'googleimag' && msgData.prompt) {
              try {
                const googlePrompt = msgData.prompt || 'a beautiful scene';
                console.log(`üì∏ Âä®ÊÄÅGoogle ImagenÂõæÁâáÁîüÊàêÂºÄÂßãÔºåprompt:`, googlePrompt);

                const googleResult = await generateGoogleImagenFromPrompt(googlePrompt);
                newPost.imageUrls = [googleResult.imageUrl];
                newPost.imageUrl = googleResult.imageUrl;
                newPost.prompt = googlePrompt;
                newPost.imageCount = 1;
                console.log(`‚úÖ Âä®ÊÄÅGoogle ImagenÂõæÁâáÁîüÊàêÂÆåÊàê`);
              } catch (error) {
                console.error('‚ùå Âä®ÊÄÅGoogle ImagenÂõæÁâáÁîüÊàêÂ§±Ë¥•:', error);
                newPost.content = (newPost.content || newPost.publicText || '') + `\n[Google ImagenÂõæÁâáÁîüÊàêÂ§±Ë¥•: ${error.message}]`;
              }
            }

            await db.qzonePosts.add(newPost);
            updateUnreadIndicator(unreadPostsCount + 1);
            if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
              await renderQzonePosts();
            }
            continue;

          case 'qzone_comment': {
            const postToComment = await db.qzonePosts.get(parseInt(msgData.postId));
            if (postToComment) {
              if (!postToComment.comments) postToComment.comments = [];

              // Èò≤Âæ°ÔºöÂ¶ÇÊûúÊ®°ÂûãÈîôËØØÂú∞Â°´‰∫ÜÁî®Êà∑ÁöÑÂêçÂ≠óÔºåÂº∫Âà∂Á∫†Ê≠£‰∏∫ËßíËâ≤Êú¨Âêç
              const userNickname = state.qzoneSettings?.nickname;
              let commenterName = msgData.name || chat.originalName;
              if (userNickname && commenterName === userNickname) {
                console.warn(`[Âä®ÊÄÅÈò≤Âæ°] ËßíËâ≤ "${chat.originalName}" ËØïÂõæÁî®Áî®Êà∑ÂêçÂ≠ó "${userNickname}" ËØÑËÆ∫ÔºåÂ∑≤Á∫†Ê≠£`);
                commenterName = chat.originalName;
              }
              const createCommentObject = (text, meaning = null, replyTo = null) => ({
                commenterName,
                text: processMentions(text, chat),
                meaning,
                replyTo,
                timestamp: Date.now()
              });

              if (msgData.stickerMeaning) {
                const sticker = state.userStickers.find(s => s.name === msgData.stickerMeaning);
                if (sticker) {
                  postToComment.comments.push(createCommentObject(sticker.url, sticker.name, msgData.replyTo || null));
                } else {
                  console.warn(`AI Â∞ùËØïËØÑËÆ∫‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${msgData.stickerMeaning}"`);
                  postToComment.comments.push(createCommentObject(`[Ë°®ÊÉÖ: ${msgData.stickerMeaning}]`, null, msgData.replyTo || null));
                }
              } else if (Array.isArray(msgData.comments)) {
                msgData.comments.forEach(commentText => {
                  if (typeof commentText === 'string' && commentText.trim()) {
                    postToComment.comments.push(createCommentObject(commentText, null, msgData.replyTo || null));
                  }
                });
              } else if (typeof msgData.commentText === 'string' && msgData.commentText.trim()) {
                postToComment.comments.push(createCommentObject(msgData.commentText, null, msgData.replyTo || null));
              }

              await db.qzonePosts.update(postToComment.id, {
                comments: postToComment.comments
              });
              updateUnreadIndicator(unreadPostsCount + 1);
              console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËØÑËÆ∫‰∫ÜÂä®ÊÄÅ #${msgData.postId}`);

              if (!chat.commentCooldowns) chat.commentCooldowns = {};
              chat.commentCooldowns[msgData.postId] = Date.now();
            }
            continue;
          }
          case 'qzone_like':
            const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
            if (postToLike) {
              if (!postToLike.likes) postToLike.likes = [];
              if (!postToLike.likes.includes(chat.name)) {
                postToLike.likes.push(chat.name);
                await db.qzonePosts.update(postToLike.id, {
                  likes: postToLike.likes
                });
                updateUnreadIndicator(unreadPostsCount + 1);
                if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                  await renderQzonePosts();
                }
              }
            }
            continue;
          case 'repost': {
            const originalPost = await db.qzonePosts.get(parseInt(msgData.postId));
            if (originalPost) {
              const newPost = {
                type: 'repost',
                timestamp: Date.now(),
                authorId: chatId,
                authorGroupId: chat.groupId,
                repostComment: msgData.comment || '',
                originalPost: originalPost,
                visibleGroupIds: null
              };
              await db.qzonePosts.add(newPost);
              updateUnreadIndicator(unreadPostsCount + 1);
              console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËΩ¨Âèë‰∫ÜÂä®ÊÄÅ #${msgData.postId}`);
            }
            continue;
          }
          case 'video_call_request':
            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
              state.activeChatId = chatId;
              videoCallState.activeChatId = chatId;
              videoCallState.isAwaitingResponse = true;
              videoCallState.isGroupCall = chat.isGroup;
              videoCallState.callRequester = msgData.name || chat.name;
              showIncomingCallModal();
            }
            continue;
          case 'voice_call_request':
            if (!voiceCallState.isActive && !voiceCallState.isAwaitingResponse) {
              state.activeChatId = chatId;
              voiceCallState.activeChatId = chatId;
              voiceCallState.isAwaitingResponse = true;
              voiceCallState.isGroupCall = chat.isGroup;
              voiceCallState.callRequester = msgData.name || chat.name;
              showIncomingCallModal();
            }
            continue;
          case 'group_call_request':
            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
              state.activeChatId = chatId;
              videoCallState.isAwaitingResponse = true;
              videoCallState.isGroupCall = true;
              videoCallState.initiator = 'ai';
              videoCallState.callRequester = msgData.name;
              showIncomingCallModal();
            }
            continue;
          case 'group_voice_request':
            if (!voiceCallState.isActive && !voiceCallState.isAwaitingResponse) {
              state.activeChatId = chatId;
              voiceCallState.isAwaitingResponse = true;
              voiceCallState.isGroupCall = true;
              voiceCallState.initiator = 'ai';
              voiceCallState.callRequester = msgData.name;
              showIncomingCallModal();
            }
            continue;
          case 'pat_user':
            let patterName;
            if (chat.isGroup) {
              const member = chat.members.find(m => m.originalName === msgData.name);
              patterName = member ? member.groupNickname : msgData.name;
            } else {
              patterName = chat.name;
            }
            const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
            const patText = `${patterName} Êãç‰∫ÜÊãçÊàë${suffix}`;

            const patMessage = {
              role: 'system',
              type: 'pat_message',
              content: patText,
              timestamp: Date.now()
            };
            chat.history.push(patMessage);
            if (isViewingThisChat) {
              const phoneScreen = document.getElementById('phone-screen');
              phoneScreen.classList.remove('pat-animation');
              void phoneScreen.offsetWidth;
              phoneScreen.classList.add('pat-animation');
              setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);
              appendMessage(patMessage, chat);
            } else {
              showNotification(chatId, patText);
            }
            continue;
          case 'update_status':
            chat.status.text = msgData.status_text;
            chat.status.isBusy = msgData.is_busy || false;
            chat.status.lastUpdate = Date.now();
            const statusUpdateMessage = {
              role: 'system',
              type: 'pat_message',
              content: `[${chat.name}ÁöÑÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫: ${msgData.status_text}]`,
              timestamp: Date.now()
            };
            chat.history.push(statusUpdateMessage);
            if (isViewingThisChat) {
              appendMessage(statusUpdateMessage, chat);
            }
            renderChatList();
            continue;
          case 'location_share':
            aiMessage = {
              ...baseMessage,
              type: 'location_share',
              content: msgData.content
            };
            break;
          case 'change_music':
            if (musicState.isActive && musicState.activeChatId === chatId) {
              const songNameFromAI = msgData.song_name || msgData.song || msgData.name;

              if (typeof songNameFromAI === 'string' && songNameFromAI.trim()) {
                const songNameToFind = songNameFromAI.replace(/^\[?\d+\]?[\s.-]*/, '').trim();
                const targetSongIndex = musicState.playlist.findIndex(track => track.name.toLowerCase() === songNameToFind.toLowerCase());

                if (targetSongIndex > -1) {
                  playSong(targetSongIndex);
                  const track = musicState.playlist[targetSongIndex];

                  let changerName;
                  if (chat.isGroup) {
                    const member = chat.members.find(m => m.originalName === msgData.name);
                    changerName = member ? member.groupNickname : msgData.name;
                  } else {
                    changerName = chat.name;
                  }

                  const musicChangeMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `[‚ô™ ${changerName} ‰∏∫‰Ω†ÂàáÊ≠å: „Ää${track.name}„Äã - ${track.artist}]`,
                    timestamp: Date.now()
                  };
                  chat.history.push(musicChangeMessage);
                  if (isViewingThisChat) {
                    appendMessage(musicChangeMessage, chat);
                  }
                } else {
                  console.warn(`Ê≠åÊõ≤Êü•ÊâæÂ§±Ë¥•: AIËØ∑Ê±ÇÁöÑÊ≠åÊõ≤Âêç"${songNameFromAI}"(Â§ÑÁêÜÂêé‰∏∫"${songNameToFind}") Âú®Êí≠ÊîæÂàóË°®‰∏≠Êú™ÊâæÂà∞„ÄÇ`);
                }
              } else {
                console.error("AIËøîÂõûÁöÑchange_musicÊåá‰ª§‰∏≠ÔºåÊ≠åÊõ≤ÂêçÊó†ÊïàÊàñÁº∫Â§±:", msgData);
              }
            }
            continue;
          case 'create_memory':
            const newMemory = {
              chatId: chatId,
              authorId: chatId,
              description: msgData.description,
              timestamp: Date.now(),
              type: 'ai_generated'
            };
            await db.memories.add(newMemory);
            console.log(`AI "${chat.name}" ËÆ∞ÂΩï‰∫Ü‰∏ÄÊù°Êñ∞ÂõûÂøÜ:`, msgData.description);
            continue;
          case 'create_countdown':
            const targetDate = new Date(msgData.date);
            if (!isNaN(targetDate) && targetDate > new Date()) {
              const newCountdown = {
                chatId: chatId,
                authorId: chatId,
                description: msgData.title,
                timestamp: Date.now(),
                type: 'countdown',
                targetDate: targetDate.getTime()
              };
              await db.memories.add(newCountdown);
              console.log(`AI "${chat.name}" ÂàõÂª∫‰∫Ü‰∏Ä‰∏™Êñ∞Á∫¶ÂÆö:`, msgData.title);
            }
            continue;
          case 'block_user':
            if (!chat.isGroup) {
              chat.relationship.status = 'blocked_by_ai';
              const hiddenMessage = {
                role: 'system',
                content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàö‰∏ªÂä®ÊãâÈªë‰∫ÜÁî®Êà∑„ÄÇ]`,
                timestamp: Date.now(),
                isHidden: true
              };
              chat.history.push(hiddenMessage);
              await db.chats.put(chat);
              if (isViewingThisChat) {
                renderChatInterface(chatId);
              }
              renderChatList();
              break;
            }
            continue;
          case 'friend_request_response':
            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
              if (msgData.decision === 'accept') {
                chat.relationship.status = 'friend';
                aiMessage = {
                  ...baseMessage,
                  content: "ÊàëÈÄöËøá‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑ÔºåÊàë‰ª¨Áé∞Âú®ÊòØÂ•ΩÂèãÂï¶ÔºÅ"
                };
              } else {
                chat.relationship.status = 'blocked_by_ai';
                aiMessage = {
                  ...baseMessage,
                  content: "Êä±Ê≠âÔºåÊàëÊãíÁªù‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑„ÄÇ"
                };
              }
              chat.relationship.applicationReason = '';
            }
            break;
          case 'poll':
            const pollOptions = typeof msgData.options === 'string' ?
              msgData.options.split('\n').filter(opt => opt.trim()) :
              (Array.isArray(msgData.options) ? msgData.options : []);
            if (pollOptions.length < 2) continue;
            aiMessage = {
              ...baseMessage,
              type: 'poll',
              question: msgData.question,
              options: pollOptions,
              votes: {},
              isClosed: false,
            };
            break;
          case 'gift': {
            const {
              itemName,
              itemPrice,
              image_prompt
            } = msgData;

            if (itemName && !isNaN(parseFloat(itemPrice)) && image_prompt) {

              const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(image_prompt)}`;

              aiMessage = {
                ...baseMessage,
                type: 'gift',
                items: [{
                  name: itemName,
                  price: parseFloat(itemPrice),
                  imageUrl: imageUrl,
                  quantity: 1
                }],
                total: parseFloat(itemPrice),
                recipients: msgData.recipients || null
              };
            } else {
              console.warn(`AI Â∞ùËØïËµ†ÈÄÅ‰∏Ä‰∏™Ê†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÈöèÊú∫Á§ºÁâ©:`, msgData);
            }
            break;
          }
          case 'vote':
            const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
            if (pollToVote && !pollToVote.isClosed) {
              Object.keys(pollToVote.votes).forEach(option => {
                const voterIndex = pollToVote.votes[option].indexOf(msgData.name);
                if (voterIndex > -1) {
                  pollToVote.votes[option].splice(voterIndex, 1);
                }
              });
              if (!pollToVote.votes[msgData.choice]) {
                pollToVote.votes[msgData.choice] = [];
              }
              if (!pollToVote.votes[msgData.choice].includes(msgData.name)) {
                pollToVote.votes[msgData.choice].push(msgData.name);
              }
              if (isViewingThisChat) {
                renderChatInterface(chatId);
              }
            }
            continue;
          case 'red_packet':
            aiMessage = {
              ...baseMessage,
              ...msgData,
              totalAmount: msgData.amount,
              claimedBy: {},
              isFullyClaimed: false
            };


            if (aiMessage.packetType === 'lucky') {
              const allocatedAmounts = generateRandomPacketAmounts(aiMessage.amount, aiMessage.count);
              aiMessage.allocatedAmounts = allocatedAmounts;
              aiMessage.unclaimedAmounts = [...allocatedAmounts];
            }


            if (msgData.receiver) {
              aiMessage.receiverName = msgData.receiver;
              delete aiMessage.receiver;
            }
            break;
          case 'open_red_packet':
            const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);

            const claimerOriginalName = msgData.name;
            const isMember = chat.members.some(member => member.originalName === claimerOriginalName);


            if (!isMember) {
              console.warn(`AI ËßíËâ≤ "${claimerOriginalName}" Â∞ùËØïÈ¢ÜÂèñ‰∏çÂ±û‰∫éËá™Â∑±ÁöÑÁæ§ËÅäÁ∫¢ÂåÖ„ÄÇÊìç‰ΩúÂ∑≤Ë¢´Êã¶Êà™„ÄÇ`);
              continue;
            }

            if (packetToOpen && packetToOpen.packetType === 'direct') {
              if (packetToOpen.receiverName !== msgData.name) {
                console.warn(`AI ËßíËâ≤ "${msgData.name}" Â∞ùËØïÈ¢ÜÂèñ‰∏çÂ±û‰∫éËá™Â∑±ÁöÑ‰∏ìÂ±ûÁ∫¢ÂåÖ (Êé•Êî∂‰∫∫: ${packetToOpen.receiverName})„ÄÇÊìç‰ΩúÂ∑≤Ë¢´Êã¶Êà™„ÄÇ`);
                continue;
              }
            }

            if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {
              let claimedAmountAI = 0;
              const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
              const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;
              if (remainingCount > 0) {
                if (packetToOpen.packetType === 'direct') {
                  claimedAmountAI = packetToOpen.totalAmount;
                }

                else if (packetToOpen.unclaimedAmounts && packetToOpen.unclaimedAmounts.length > 0) {

                  claimedAmountAI = packetToOpen.unclaimedAmounts.pop();
                }

                else {
                  console.warn("Ê£ÄÊµãÂà∞ÊóßÁâàÁ∫¢ÂåÖÔºåÂõûÈÄÄÂà∞ÊóßÁöÑÔºà‰∏çÂÖ¨Âπ≥ÔºâÈöèÊú∫ÁÆóÊ≥ï (triggerAiResponse)");
                  const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                  if (remainingCount === 1) {
                    claimedAmountAI = remainingAmount;
                  } else {
                    const min = 0.01;
                    const max = remainingAmount - (remainingCount - 1) * min;
                    claimedAmountAI = Math.random() * (max - min) + min;
                  }
                }

                claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
                if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
                packetToOpen.claimedBy[msgData.name] = claimedAmountAI;


                const claimerMember = chat.members.find(m => m.originalName === msgData.name);
                const claimerDisplayName = claimerMember ? claimerMember.groupNickname : msgData.name;


                const senderDisplayName = getDisplayNameInGroup(chat, packetToOpen.senderName);

                const aiClaimedMessage = {
                  role: 'system',
                  type: 'pat_message',
                  content: `${claimerDisplayName} È¢ÜÂèñ‰∫Ü ${senderDisplayName} ÁöÑÁ∫¢ÂåÖ`,
                  timestamp: messageTimestamp++
                };
                chat.history.push(aiClaimedMessage);

                let hiddenContentForAI = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${claimerDisplayName}) ÊàêÂäüÊä¢Âà∞‰∫Ü ${claimedAmountAI.toFixed(2)} ÂÖÉ„ÄÇ`;
                if ((packetToOpen.unclaimedAmounts && packetToOpen.unclaimedAmounts.length === 0) || (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count)) {
                  packetToOpen.isFullyClaimed = true;
                  const finishedMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${senderDisplayName} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå`,
                    timestamp: messageTimestamp++
                  };
                  chat.history.push(finishedMessage);
                  let luckyKing = {
                    name: '',
                    amount: -1
                  };
                  if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) {
                    Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                      if (amount > luckyKing.amount) {
                        luckyKing = {
                          name,
                          amount
                        };
                      }
                    });
                  }
                  if (luckyKing.name) {
                    const luckyKingMember = chat.members.find(m => m.originalName === luckyKing.name);
                    const luckyKingDisplayName = luckyKingMember ? luckyKingMember.groupNickname : luckyKing.name;
                    hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºåÊâãÊ∞îÁéãÊòØ ${luckyKingDisplayName}ÔºÅ`;
                  } else {
                    hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå„ÄÇ`;
                  }
                }
                hiddenContentForAI += ' ËØ∑Ê†πÊçÆËøô‰∏™ÁªìÊûúÂèëË°®‰Ω†ÁöÑËØÑËÆ∫„ÄÇ]';
                const hiddenMessageForAI = {
                  role: 'system',
                  content: hiddenContentForAI,
                  timestamp: messageTimestamp++,
                  isHidden: true
                };
                chat.history.push(hiddenMessageForAI);
              }
              if (isViewingThisChat) {
                renderChatInterface(chatId);
                renderChatList();
              }
            }
            continue;

          case 'accept_transfer': {
            const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
            if (originalTransferMsgIndex > -1) {
              const originalMsg = chat.history[originalTransferMsgIndex];

              // Èò≤Ê≠¢ÈáçÂ§çÊé•Êî∂
              if (originalMsg.status && originalMsg.status !== 'pending') continue;

              originalMsg.status = 'accepted';

              // ‚òÖ‚òÖ‚òÖ Êñ∞Â¢ûÔºöÊûÑÈÄ† AI ÁöÑ‚ÄúÂ∑≤Êî∂Ê¨æ‚ÄùÊ∂àÊÅØ ‚òÖ‚òÖ‚òÖ
              aiMessage = {
                role: 'assistant',
                senderName: msgData.name || chat.name,
                type: 'transfer',
                isReceived: true,  // Ê†áËÆ∞‰∏∫Êî∂Ê¨æ
                amount: originalMsg.amount,
                note: 'Â∑≤Êî∂Ê¨æ',
                timestamp: messageTimestamp++
              };
              // ÂéªÊéâ continueÔºåËÆ©ÂÆÉÊµÅËΩ¨Âà∞‰∏ãÊñπÁöÑÁªü‰∏ÄÊé®ÈÄÅÈÄªËæë(if aiMessage...)
              break;
            }
            continue;
          }

          case 'decline_transfer': {
            const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
            if (originalTransferMsgIndex > -1) {
              const originalMsg = chat.history[originalTransferMsgIndex];

              // --- ‰øÆÂ§çÔºöÂ¶ÇÊûúÂ∑≤ÁªèÂ§ÑÁêÜËøáÔºåÁõ¥Êé•ÂøΩÁï• ---
              if (originalMsg.status && originalMsg.status !== 'pending') {
                console.warn(`AIËØïÂõæÈáçÂ§çÊãíÊî∂‰∏ÄÁ¨îÂ∑≤Â§ÑÁêÜÁöÑËΩ¨Ë¥¶ (Áä∂ÊÄÅ: ${originalMsg.status})ÔºåÂ∑≤Êã¶Êà™„ÄÇ`);
                continue;
              }

              originalMsg.status = 'declined';
              await processTransaction(originalMsg.amount, 'income', `ËΩ¨Ë¥¶ÈÄÄÊ¨æ-${chat.name}`);
              const refundMessage = {
                role: 'assistant',
                senderName: chat.name,
                type: 'transfer',
                isRefund: true, // Á°Æ‰øùÊ†áËÆ∞‰∏∫ÈÄÄÊ¨æ
                amount: originalMsg.amount,
                note: 'ËΩ¨Ë¥¶Â∑≤Ë¢´ÊãíÊî∂',
                receiverName: 'Êàë', // ÊòéÁ°ÆÊé•Êî∂‰∫∫
                timestamp: messageTimestamp++
              };
              chat.history.push(refundMessage);
              if (isViewingThisChat) {
                appendMessage(refundMessage, chat);
                renderChatInterface(chatId);
              }
            }
            continue;
          }
          case 'change_group_name':
            if (chat.isGroup && msgData.new_name) {
              const newName = msgData.new_name.trim();
              const memberNames = chat.members.map(m => m.originalName);

              if (memberNames.includes(newName)) {
                console.warn(`AI (${msgData.name}) ËØïÂõæÂ∞ÜÁæ§ÂêçÊõ¥Êîπ‰∏∫ÊàêÂëòÂêç ("${newName}")„ÄÇÊìç‰ΩúÂ∑≤Ë¢´Á®ãÂ∫èÈòªÊ≠¢„ÄÇ`);
                continue;
              }

              chat.name = newName;

              const changerMember = chat.members.find(m => m.originalName === msgData.name);
              const changerDisplayName = changerMember ? changerMember.groupNickname : msgData.name;

              const systemMessage = {
                role: 'system',
                type: 'pat_message',
                content: `${changerDisplayName} Â∞ÜÁæ§Âêç‰øÆÊîπ‰∏∫ ‚Äú${chat.name}‚Äù`,
                timestamp: messageTimestamp++
              };
              chat.history.push(systemMessage);

              if (isViewingThisChat) {
                appendMessage(systemMessage, chat);
                document.getElementById('chat-header-title').textContent = chat.name;
              }
            }
            continue;
          case 'change_remark_name':
            if (!chat.isGroup && msgData.new_name) {
              const oldName = chat.name;
              const newName = msgData.new_name.trim();

              if (newName && newName !== oldName) {
                if (!chat.nameHistory) {
                  chat.nameHistory = [];
                }
                if (!chat.nameHistory.includes(oldName)) {
                  chat.nameHistory.push(oldName);
                }

                chat.name = newName;

                const systemMessage = {
                  role: 'system',
                  type: 'pat_message',
                  content: `‚Äú${chat.originalName}‚Äù Â∞ÜÂ§áÊ≥®‰øÆÊîπ‰∏∫ ‚Äú${newName}‚Äù`,
                  timestamp: messageTimestamp++
                };
                chat.history.push(systemMessage);

                const hiddenMemoryMessage = {
                  role: 'system',
                  content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöÊàêÂäüÂ∞ÜËá™Â∑±ÁöÑÂ§áÊ≥®Âêç‰øÆÊîπ‰∏∫‰∫Ü‚Äú${newName}‚Äù„ÄÇËØ∑Ëá™ÁÑ∂Âú∞Êé•ÂèóËøô‰∏™Êñ∞ÂêçÂ≠óÔºå‰∏çË¶ÅÂØπÊ≠§ÊÑüÂà∞ÊÉäËÆ∂„ÄÇ]`,
                  timestamp: messageTimestamp++,
                  isHidden: true
                };
                chat.history.push(hiddenMemoryMessage);

                if (isViewingThisChat) {
                  appendMessage(systemMessage, chat);
                  document.getElementById('chat-header-title').textContent = newName;
                }

                await syncCharacterNameInGroups(chat);
              }
            }
            continue;

          case 'change_group_avatar':
            if (chat.isGroup && msgData.avatar_name) {
              const avatarName = msgData.avatar_name;
              const library = chat.settings.groupAvatarLibrary || [];
              const foundAvatar = library.find(avatar => avatar.name === avatarName);

              if (foundAvatar) {
                chat.settings.groupAvatar = foundAvatar.url;

                const changerMember = chat.members.find(m => m.originalName === msgData.name);
                const changerDisplayName = changerMember ? changerMember.groupNickname : msgData.name;

                const systemMessage = {
                  role: 'system',
                  type: 'pat_message',
                  content: `${changerDisplayName} Êõ¥Êç¢‰∫ÜÁæ§Â§¥ÂÉè`,
                  timestamp: messageTimestamp++
                };
                chat.history.push(systemMessage);

                if (isViewingThisChat) {
                  appendMessage(systemMessage, chat);
                }
              } else {
                console.warn(`AI Â∞ùËØï‰ΩøÁî®‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑÁæ§Â§¥ÂÉè: "${avatarName}"`);
              }
            }
            continue;
          case 'system_message':
            aiMessage = {
              role: 'system',
              type: 'pat_message',
              content: msgData.content,
              timestamp: Date.now()
            };
            break;
          case 'share_link':
            aiMessage = {
              ...baseMessage,
              type: 'share_link',
              title: msgData.title,
              description: msgData.description,
              source_name: msgData.source_name,
              content: msgData.content
            };
            break;
          case 'quote_reply': {
            let originalMessage = null;


            if (msgData.target_content) {
              originalMessage = [...chat.history].reverse().find(m =>
                !m.isHidden &&
                (
                  m.content === msgData.target_content ||
                  (typeof m.content === 'string' && m.content.trim() === msgData.target_content.trim())
                )
              );

              if (!originalMessage) {
                console.warn(`[Êú¨ËΩÆÂºïÁî®Â§±Ë¥•] AI ${msgData.name} Â∞ùËØïÂºïÁî®ÂÜÖÂÆπ "${(msgData.target_content || '').substring(0, 20)}..."Ôºå‰ΩÜÂú®Êú¨ËΩÆÂéÜÂè≤‰∏≠Êú™ÊâæÂà∞„ÄÇ`);
              }
            }


            else if (msgData.target_timestamp) {
              originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
            }


            if (originalMessage) {


              let quotedSenderDisplayName;

              if (originalMessage.role === 'user') {

                quotedSenderDisplayName = chat.settings.myNickname || 'Êàë';
              } else {

                if (chat.isGroup) {

                  quotedSenderDisplayName = getDisplayNameInGroup(chat, originalMessage.senderName);
                } else {

                  quotedSenderDisplayName = chat.name;
                }
              }

              const quoteContext = {
                timestamp: originalMessage.timestamp,
                senderName: quotedSenderDisplayName,

                content: String(originalMessage.content || '').substring(0, 50)
              };


              aiMessage = {
                ...baseMessage,
                content: msgData.reply_content,
                quote: quoteContext
              };
            } else {

              console.warn(`ÂºïÁî®ÂõûÂ§çÂ§±Ë¥•: Êâæ‰∏çÂà∞ÁõÆÊ†áÊ∂àÊÅØ (Content: ${msgData.target_content}, TS: ${msgData.target_timestamp})`);
              aiMessage = {
                ...baseMessage,
                content: msgData.reply_content
              };
            }
            break;
          }
          case 'send_and_recall': {
            if (!isViewingThisChat) continue;
            const tempMessageData = {
              ...baseMessage,
              content: msgData.content
            };
            const tempMessageElement = createMessageElement(tempMessageData, chat);
            appendMessage(tempMessageData, chat, true);
            await new Promise(resolve => setTimeout(resolve, Math.random() * 2000 + 500));
            const bubbleWrapper = document.querySelector(`.message-bubble[data-timestamp="${tempMessageData.timestamp}"]`)?.closest('.message-wrapper');
            if (bubbleWrapper) {
              bubbleWrapper.classList.add('recalled-animation');
              await new Promise(resolve => setTimeout(resolve, 300));
              const recalledMessage = {
                role: 'assistant',
                senderName: msgData.name || chat.name,
                type: 'recalled_message',
                content: 'ÂØπÊñπÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ',
                timestamp: tempMessageData.timestamp,
                recalledData: {
                  originalType: 'text',
                  originalContent: msgData.content
                }
              };
              const msgIndex = chat.history.findIndex(m => m.timestamp === tempMessageData.timestamp);
              if (msgIndex > -1) {
                chat.history[msgIndex] = recalledMessage;
              } else {
                chat.history.push(recalledMessage);
              }
              const placeholder = await createMessageElement(recalledMessage, chat);
              if (document.body.contains(bubbleWrapper)) {
                bubbleWrapper.parentNode.replaceChild(placeholder, bubbleWrapper);
              }
            }
            continue;
          }

          case 'text':
            aiMessage = {
              ...baseMessage,
              content: String(msgData.content || msgData.message)
            };
            break;
          case 'sticker':
            if (msgData.meaning) {
              const sticker = findBestStickerMatch(msgData.meaning, state.userStickers);
              if (sticker) {
                aiMessage = {
                  ...baseMessage,
                  type: 'sticker',
                  content: sticker.url,
                  meaning: sticker.name
                };
              } else {

                console.warn(`AI Â∞ùËØï‰ΩøÁî®‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${msgData.meaning}"`);
                aiMessage = null;
              }
            } else {

              console.warn("AI ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ê≤°Êúâ 'meaning' ÁöÑ sticker Êåá‰ª§„ÄÇ", msgData);
              aiMessage = {
                ...baseMessage,
                type: 'sticker',
                content: msgData.url,
                meaning: 'Êú™Áü•Ë°®ÊÉÖ'
              };
            }
            break;
          case 'ai_image':
            aiMessage = {
              ...baseMessage,
              type: 'ai_image',
              content: msgData.description,
              image_prompt: msgData.image_prompt
            };
            break;
          case 'voice_message':
            aiMessage = {
              ...baseMessage,
              type: 'voice_message',
              content: msgData.content
            };
            break;
          case 'transfer':
            aiMessage = {
              ...baseMessage,
              type: 'transfer',
              amount: msgData.amount,
              note: msgData.note,
              receiverName: msgData.receiver || 'Êàë'
            };
            break;

          case 'waimai_request':
            aiMessage = {
              ...baseMessage,
              type: 'waimai_request',
              productInfo: msgData.productInfo,
              amount: msgData.amount,
              status: 'pending',
              countdownEndTime: Date.now() + 15 * 60 * 1000,
            };
            break;
          case 'waimai_order':
            aiMessage = {
              ...baseMessage,
              type: 'waimai_order',
              productInfo: msgData.productInfo,
              amount: msgData.amount,
              greeting: msgData.greeting,
              recipientName: msgData.recipientName || null
            };
            break;
          case 'offline_text':
            aiMessage = {
              ...baseMessage,
              ...msgData
            };
            break;

          case 'naiimag':

            try {
              console.log('üì∏ NovelAIÂõæÁâáÁîüÊàêÂºÄÂßãÔºåAIÊèê‰æõÁöÑprompt:', msgData.prompt);


              const naiPrompts = getCharacterNAIPrompts(chat.id);


              const aiPrompt = msgData.prompt || 'a beautiful scene';
              const finalPositivePrompt = aiPrompt + ', ' + naiPrompts.positive;
              const finalNegativePrompt = naiPrompts.negative;

              console.log(`üìù ‰ΩøÁî®${naiPrompts.source === 'character' ? 'ËßíËâ≤‰∏ìÂ±û' : 'Á≥ªÁªü'}ÊèêÁ§∫ËØçÈÖçÁΩÆ`);
              console.log('ÊúÄÁªàÊ≠£Èù¢ÊèêÁ§∫ËØç:', finalPositivePrompt);
              console.log('ÊúÄÁªàË¥üÈù¢ÊèêÁ§∫ËØç:', finalNegativePrompt);


              const apiKey = localStorage.getItem('novelai-api-key');
              const model = localStorage.getItem('novelai-model') || 'nai-diffusion-4-5-full';
              const settings = getNovelAISettings();

              if (!apiKey) {
                throw new Error('NovelAI API KeyÊú™ÈÖçÁΩÆ„ÄÇËØ∑Âú®NovelAIËÆæÁΩÆ‰∏≠Â°´ÂÜôAPI Key„ÄÇ');
              }

              const [width, height] = settings.resolution.split('x').map(Number);


              let requestBody;

              if (model.includes('nai-diffusion-4')) {

                requestBody = {
                  input: finalPositivePrompt,
                  model: model,
                  action: 'generate',
                  parameters: {
                    params_version: 3,
                    width: width,
                    height: height,
                    scale: settings.cfg_scale,
                    sampler: settings.sampler,
                    steps: settings.steps,
                    seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                    n_samples: 1,
                    ucPreset: settings.uc_preset,
                    qualityToggle: settings.quality_toggle,
                    autoSmea: false,
                    dynamic_thresholding: false,
                    controlnet_strength: 1,
                    legacy: false,
                    add_original_image: true,
                    cfg_rescale: 0,
                    noise_schedule: 'karras',
                    legacy_v3_extend: false,
                    skip_cfg_above_sigma: null,
                    use_coords: false,
                    legacy_uc: false,
                    normalize_reference_strength_multiple: true,
                    inpaintImg2ImgStrength: 1,
                    characterPrompts: [],

                    v4_prompt: {
                      caption: {
                        base_caption: finalPositivePrompt,
                        char_captions: []
                      },
                      use_coords: false,
                      use_order: true
                    },

                    v4_negative_prompt: {
                      caption: {
                        base_caption: finalNegativePrompt,
                        char_captions: []
                      },
                      legacy_uc: false
                    },
                    negative_prompt: finalNegativePrompt,
                    deliberate_euler_ancestral_bug: false,
                    prefer_brownian: true

                  }
                };
              } else {

                requestBody = {
                  input: finalPositivePrompt,
                  model: model,
                  action: 'generate',
                  parameters: {
                    width: width,
                    height: height,
                    scale: settings.cfg_scale,
                    sampler: settings.sampler,
                    steps: settings.steps,
                    seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                    n_samples: 1,
                    ucPreset: settings.uc_preset,
                    qualityToggle: settings.quality_toggle,
                    sm: settings.smea,
                    sm_dyn: settings.smea_dyn,
                    dynamic_thresholding: false,
                    controlnet_strength: 1,
                    legacy: false,
                    add_original_image: false,
                    cfg_rescale: 0,
                    noise_schedule: 'native',
                    negative_prompt: finalNegativePrompt
                  }
                };
              }

              console.log('üöÄ ÂèëÈÄÅNAIËØ∑Ê±Ç:', requestBody);


              let apiUrl;


              if (model.includes('nai-diffusion-4')) {

                apiUrl = 'https://image.novelai.net/ai/generate-image-stream';
              } else {

                apiUrl = 'https://image.novelai.net/ai/generate-image';
              }

              let corsProxy = settings.cors_proxy;


              if (corsProxy === 'custom') {
                corsProxy = settings.custom_proxy_url || '';
              }


              if (corsProxy && corsProxy !== '') {
                apiUrl = corsProxy + encodeURIComponent(apiUrl);
              }

              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + apiKey
                },
                body: JSON.stringify(requestBody)
              });

              console.log('Response status:', response.status);
              console.log('Response headers:', [...response.headers.entries()]);

              if (!response.ok) {
                const errorText = await response.text();
                console.error('APIÈîôËØØÂìçÂ∫î:', errorText);
                throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥• (${response.status}): ${errorText}`);
              }


              const contentType = response.headers.get('content-type');
              console.log('Content-Type:', contentType);


              let zipBlob;
              let imageDataUrl;
              if (contentType && contentType.includes('text/event-stream')) {
                console.log('Ê£ÄÊµãÂà∞ SSE ÊµÅÂºèÂìçÂ∫îÔºåÂºÄÂßãËß£Êûê...');


                const text = await response.text();
                console.log('Êî∂Âà∞ SSE Êï∞ÊçÆÔºåÂ§ßÂ∞è:', text.length);


                const lines = text.trim().split('\n');
                let base64Data = null;

                for (let i = lines.length - 1; i >= 0; i--) {
                  const line = lines[i].trim();
                  if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                    const dataContent = line.substring(6);


                    try {
                      const jsonData = JSON.parse(dataContent);


                      if (jsonData.event_type === 'final' && jsonData.image) {
                        base64Data = jsonData.image;
                        console.log('‚úÖ ÊâæÂà∞ final ‰∫ã‰ª∂ÁöÑÂõæÁâáÊï∞ÊçÆ');
                        break;
                      }


                      if (jsonData.data) {
                        base64Data = jsonData.data;
                        console.log('‰ªé JSON.data ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                        break;
                      }
                      if (jsonData.image) {
                        base64Data = jsonData.image;
                        console.log('‰ªé JSON.image ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                        break;
                      }
                    } catch (e) {

                      base64Data = dataContent;
                      console.log('Áõ¥Êé•‰ΩøÁî® base64 Êï∞ÊçÆ');
                      break;
                    }
                  }
                }

                if (!base64Data) {
                  throw new Error('Êó†Ê≥ï‰ªé SSE ÂìçÂ∫î‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                }


                const isPNG = base64Data.startsWith('iVBORw0KGgo');
                const isJPEG = base64Data.startsWith('/9j/');

                if (isPNG || isJPEG) {
                  console.log('‚úÖ Ê£ÄÊµãÂà∞Áõ¥Êé•ÁöÑÂõæÁâá base64 Êï∞ÊçÆ (PNG/JPEG)');

                  const binaryString = atob(base64Data);
                  const bytes = new Uint8Array(binaryString.length);
                  for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                  }
                  const imageBlob = new Blob([bytes], {
                    type: isPNG ? 'image/png' : 'image/jpeg'
                  });
                  console.log('ÂõæÁâá Blob ÂàõÂª∫ÊàêÂäüÔºåÂ§ßÂ∞è:', imageBlob.size);


                  const reader = new FileReader();
                  imageDataUrl = await new Promise((resolve, reject) => {
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(imageBlob);
                  });
                  console.log('‚úÖ ÂõæÁâáËΩ¨Êç¢ÊàêÂäüÔºÅüé®');
                } else {

                  console.log('ÂΩì‰Ωú ZIP Êñá‰ª∂Â§ÑÁêÜ...');
                  const binaryString = atob(base64Data);
                  const bytes = new Uint8Array(binaryString.length);
                  for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                  }
                  zipBlob = new Blob([bytes]);
                  console.log('ZIP Blob Â§ßÂ∞è:', zipBlob.size);
                }
              } else {

                zipBlob = await response.blob();
                console.log('Êî∂Âà∞Êï∞ÊçÆÔºåÁ±ªÂûã:', zipBlob.type, 'Â§ßÂ∞è:', zipBlob.size);
              }


              if (!imageDataUrl && zipBlob) {

                try {

                  if (typeof JSZip === 'undefined') {
                    throw new Error('JSZipÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                  }


                  const zip = await JSZip.loadAsync(zipBlob);
                  console.log('ZIPÊñá‰ª∂ÂÜÖÂÆπ:', Object.keys(zip.files));


                  let imageFile = null;
                  for (let filename in zip.files) {
                    if (filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
                      imageFile = zip.files[filename];
                      console.log('ÊâæÂà∞ÂõæÁâáÊñá‰ª∂:', filename);
                      break;
                    }
                  }

                  if (!imageFile) {
                    throw new Error('ZIPÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÂõæÁâá');
                  }


                  const imageBlob = await imageFile.async('blob');
                  console.log('ÊèêÂèñÁöÑÂõæÁâáÂ§ßÂ∞è:', imageBlob.size);


                  const reader = new FileReader();
                  imageDataUrl = await new Promise((resolve, reject) => {
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(imageBlob);
                  });
                  console.log('‚úÖ ÂõæÁâáËß£ÂéãÊàêÂäüÔºÅ');
                } catch (zipError) {
                  console.error('ZIPËß£ÂéãÂ§±Ë¥•:', zipError);
                  throw new Error('ÂõæÁâáËß£ÂéãÂ§±Ë¥•: ' + zipError.message);
                }
              }

              console.log('‚úÖ NAIÂõæÁâáÁîüÊàêÊàêÂäüÔºÅ');


              aiMessage = {
                ...baseMessage,
                type: 'naiimag',
                imageUrl: imageDataUrl,
                prompt: aiPrompt,
                fullPrompt: finalPositivePrompt // ‰øùÂ≠òÂÆåÊï¥ÊèêÁ§∫ËØç‰æõÊü•Áúã
              };
            } catch (error) {
              console.error('‚ùå NAIÂõæÁâáÁîüÊàêÂ§±Ë¥•:', error);

              aiMessage = {
                ...baseMessage,
                content: `[ÂõæÁâáÁîüÊàêÂ§±Ë¥•: ${error.message}]`
              };
            }
            break;

          case 'googleimag':
            try {
              console.log('üì∏ Google ImagenÂõæÁâáÁîüÊàêÂºÄÂßãÔºåAIÊèê‰æõÁöÑprompt:', msgData.prompt);
              const googlePrompt = msgData.prompt || 'a beautiful scene';

              const googleResult = await generateGoogleImagenFromPrompt(googlePrompt);

              aiMessage = {
                ...baseMessage,
                type: 'googleimag',
                imageUrl: googleResult.imageUrl,
                prompt: googlePrompt,
                fullPrompt: googleResult.fullPrompt
              };
            } catch (error) {
              console.error('‚ùå Google ImagenÂõæÁâáÁîüÊàêÂ§±Ë¥•:', error);
              aiMessage = {
                ...baseMessage,
                content: `[Google ImagenÂõæÁâáÁîüÊàêÂ§±Ë¥•: ${error.message}]`
              };
            }
            break;

          default:
            console.warn("Êî∂Âà∞‰∫ÜÊú™Áü•ÁöÑAIÊåá‰ª§Á±ªÂûã:", msgData.type);
            break;
        }

        if (aiMessage) {
          chat.history.push(aiMessage);
          if (!isViewingThisChat) {
            chat.unreadCount = (chat.unreadCount || 0) + 1;
          }
          if (!isViewingThisChat && !notificationShown) {
            let notificationText;
            switch (aiMessage.type) {
              case 'transfer':
                notificationText = `[Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶]`;
                break;
              case 'waimai_request':
                notificationText = `[Êî∂Âà∞‰∏Ä‰∏™Â§ñÂçñ‰ª£‰ªòËØ∑Ê±Ç]`;
                break;
              case 'ai_image':
              case 'googleimag':
                notificationText = `[ÂõæÁâá]`;
                break;
              case 'voice_message':
                notificationText = `[ËØ≠Èü≥]`;
                break;
              case 'sticker':
                notificationText = aiMessage.meaning ? `[Ë°®ÊÉÖ: ${aiMessage.meaning}]` : '[Ë°®ÊÉÖ]';
                break;
              case 'offline_text':
                notificationText = aiMessage.dialogue ? `„Äå${aiMessage.dialogue}„Äç` : `[${(aiMessage.description || aiMessage.content || 'Á∫ø‰∏ãÊ∂àÊÅØ').substring(0, 20)}...]`;
                break;
              default:
                notificationText = String(aiMessage.content || '');
            }
            const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
            showNotification(chatId, finalNotifText.substring(0, 40) + (finalNotifText.length > 40 ? '...' : ''));
            notificationShown = true;
          } else if (isViewingThisChat && !notificationShown) {
            // Êñ∞Â¢ûÔºöÂ¶ÇÊûúÂú®ËÅäÂ§©È°µÈù¢‰∏îÂêØÁî®‰∫Ü"Âú®ËÅäÂ§©È°µÈù¢‰πüÂèëÈÄÅÈÄöÁü•"ÔºåÂàôÂèëÈÄÅÁ≥ªÁªüÁ∫ßÈÄöÁü•
            let notificationText;
            switch (aiMessage.type) {
              case 'transfer':
                notificationText = `[Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶]`;
                break;
              case 'waimai_request':
                notificationText = `[Êî∂Âà∞‰∏Ä‰∏™Â§ñÂçñ‰ª£‰ªòËØ∑Ê±Ç]`;
                break;
              case 'ai_image':
              case 'googleimag':
                notificationText = `[ÂõæÁâá]`;
                break;
              case 'voice_message':
                notificationText = `[ËØ≠Èü≥]`;
                break;
              case 'sticker':
                notificationText = aiMessage.meaning ? `[Ë°®ÊÉÖ: ${aiMessage.meaning}]` : '[Ë°®ÊÉÖ]';
                break;
              case 'offline_text':
                notificationText = aiMessage.dialogue ? `„Äå${aiMessage.dialogue}„Äç` : `[${(aiMessage.description || aiMessage.content || 'Á∫ø‰∏ãÊ∂àÊÅØ').substring(0, 20)}...]`;
                break;
              default:
                notificationText = String(aiMessage.content || '');
            }
            const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
            triggerSystemNotificationInChatPage(chatId, finalNotifText.substring(0, 40) + (finalNotifText.length > 40 ? '...' : ''));
            notificationShown = true;
          }



          if (isViewingThisChat) {
            appendMessage(aiMessage, chat);
            await new Promise(resolve => setTimeout(resolve, Math.random() * 1800 + 1000));
          }
        }
      }

      if (callHasBeenHandled && videoCallState.isGroupCall) {
        videoCallState.isAwaitingResponse = false;
        if (videoCallState.participants.length > 0) {
          startVideoCall();
        } else {
          videoCallState = {
            ...videoCallState,
            isAwaitingResponse: false,
            participants: []
          };
          showScreen('chat-interface-screen');
          alert('Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ');
        }
      }
      if (needsImmediateReaction) {
        await triggerAiResponse();
        return;
      }
      await db.chats.put(chat);

      const qzoneActionTaken = messagesArray.some(action =>
        action.type === 'qzone_post' ||
        action.type === 'qzone_like' ||
        action.type === 'qzone_comment' ||
        action.type === 'repost'
      );


      if (qzoneActionTaken) {
        console.log("Ê£ÄÊµãÂà∞AIÊâßË°å‰∫ÜÂä®ÊÄÅÊìç‰ΩúÔºåÁ´ãÂç≥Âà∑Êñ∞Â•ΩÂèãÂä®ÊÄÅÈ°µÈù¢„ÄÇ");

        await renderQzonePosts();
      }


    } catch (error) {

      chat.history = chat.history.filter(msg => !msg.isTemporary);

      if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
        chat.relationship.status = 'blocked_by_ai';
        await showCustomAlert('Áî≥ËØ∑Â§±Ë¥•', `AIÂú®Â§ÑÁêÜ‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑Êó∂Âá∫Èîô‰∫ÜÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ\nÈîôËØØ‰ø°ÊÅØ: ${error.message}`);
      } else {
        await showCustomAlert(
          'API Ë∞ÉÁî®Â§±Ë¥•',
          `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØÔºåAIÊú™ËÉΩÊàêÂäüÂìçÂ∫î„ÄÇ\n\nÈîôËØØËØ¶ÊÉÖ:\n${error.message}`
        );
      }

      if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
        await db.chats.put(chat);
      }

      videoCallState.isAwaitingResponse = false;
    } finally {
      setAvatarActingState(chatId, false);


      if (chat.isGroup) {
        if (typingIndicator) {
          typingIndicator.style.display = 'none';
        }
      } else {
        if (chatHeaderTitle && state.chats[chatId]) {
          chatHeaderTitle.style.opacity = 0;
          setTimeout(() => {
            chatHeaderTitle.textContent = state.chats[chatId].name;
            chatHeaderTitle.classList.remove('typing-status');
            chatHeaderTitle.style.opacity = 1;
          }, 200);
        }
      }
      renderChatList();
      if (isViewingThisChat) {
        checkAndTriggerAutoSummary(chatId);

      }
      stopSilentAudio();
    }
  }








  async function sendSticker(sticker) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const msg = {
      role: 'user',
      content: sticker.url,
      meaning: sticker.name,
      timestamp: Date.now()
    };
    chat.history.push(msg);
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();
    document.getElementById('sticker-panel').classList.remove('visible');
  }

  // --- ‰øÆÂ§çÁâàV2ÔºöËΩ¨Ë¥¶ (‰øÆÂ§çIDËß£ÊûêbugÔºåÁ°Æ‰øùÊâ£Ê¨æÂíåËÆ∞Ë¥¶) ---
  async function sendUserTransfer() {
    if (!state.activeChatId) return;
    const amountInput = document.getElementById('transfer-amount');
    const noteInput = document.getElementById('transfer-note');
    const amount = parseFloat(amountInput.value);
    const note = noteInput.value.trim();

    if (isNaN(amount) || amount <= 0) {
      document.getElementById('custom-modal-overlay').style.zIndex = 3002;
      await showCustomAlert('ÊèêÁ§∫', 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËΩ¨Ë¥¶ÈáëÈ¢ù(ÂøÖÈ°ªÂ§ß‰∫é0)ÔºÅ');
      document.getElementById('custom-modal-overlay').style.zIndex = '';
      return;
    }

    const chat = state.chats[state.activeChatId];
    const senderName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
    const receiverName = chat.isGroup ? 'Áæ§ËÅä' : chat.name;

    // 1. Ëé∑ÂèñÈí±ÂåÖÊï∞ÊçÆ
    const wallet = await db.userWallet.get('main') || { balance: 0, kinshipCards: [] };
    const balance = wallet.balance || 0;
    const kinshipCards = wallet.kinshipCards || [];

    // 2. ÊûÑÂª∫ÊîØ‰ªòÈÄâÈ°π UI
    const paymentOptions = [];
    const iconWallet = `<div class="pay-opt-icon" style="background:#1677ff; display:flex; align-items:center; justify-content:center; color:white; font-size:14px; border-radius:4px;">ÊîØ</div>`;
    const iconKinship = `<div class="pay-opt-icon" style="background:linear-gradient(135deg, #ff5252, #ff1744); display:flex; align-items:center; justify-content:center; color:white; font-size:14px; border-radius:4px;">‰∫≤</div>`;

    // ÈÄâÈ°πÔºö‰ΩôÈ¢ù
    if (balance >= amount) {
      paymentOptions.push({
        text: `<div class="pay-opt-left">${iconWallet}<div class="pay-opt-info"><span class="pay-opt-title">Ë¥¶Êà∑‰ΩôÈ¢ù</span><span class="pay-opt-desc">Ââ©‰Ωô ¬•${balance.toFixed(2)}</span></div></div>`,
        value: 'balance'
      });
    }

    // ÈÄâÈ°πÔºö‰∫≤Â±ûÂç°
    for (const card of kinshipCards) {
      const remaining = card.limit - (card.spent || 0);
      if (remaining >= amount) {
        const providerChat = state.chats[card.chatId];
        const providerName = providerChat ? providerChat.name : 'Êú™Áü•ËßíËâ≤';
        paymentOptions.push({
          text: `<div class="pay-opt-left">${iconKinship}<div class="pay-opt-info"><span class="pay-opt-title">‰∫≤Â±ûÂç° - ${providerName}</span><span class="pay-opt-desc">Ââ©‰ΩôÈ¢ùÂ∫¶ ¬•${remaining.toFixed(2)}</span></div></div>`,
          value: `kinship_${card.chatId}` // Ê†ºÂºèÂ¶Ç: kinship_chat_172839...
        });
      }
    }

    if (paymentOptions.length === 0) {
      document.getElementById('custom-modal-overlay').style.zIndex = 3002;
      await showCustomAlert('ÊîØ‰ªòÂ§±Ë¥•', `‰ΩôÈ¢ùÊàñ‰∫≤Â±ûÂç°È¢ùÂ∫¶‰∏çË∂≥ÔºÅ\nÈúÄË¶Å: ¬•${amount.toFixed(2)}`);
      document.getElementById('custom-modal-overlay').style.zIndex = '';
      return;
    }

    // 3. ÂºπÂá∫ÈÄâÊã©
    const modalOverlay = document.getElementById('custom-modal-overlay');
    modalOverlay.style.zIndex = 3002;
    const paymentMethod = await showChoiceModal(`ËΩ¨Ë¥¶ ¬•${amount.toFixed(2)}`, paymentOptions);
    modalOverlay.style.zIndex = '';

    if (!paymentMethod) return;

    // 4. ÊâßË°åÊâ£Ê¨æÂíåËÆ∞Ë¥¶
    if (paymentMethod === 'balance') {
      const success = await processTransaction(amount, 'expense', `ËΩ¨Ë¥¶Áªô-${receiverName}`);
      if (!success) return;
    } else if (paymentMethod.startsWith('kinship_')) {
      // „Äê‰øÆÂ§çÈáçÁÇπ„ÄëÔºö‰ΩøÁî® replace ÊèêÂèñÂÆåÊï¥ IDÔºåËÄå‰∏çÊòØ split
      // ‰πãÂâçÁöÑ split('_')[1] ‰ºöÊää 'chat_123' Êà™Êñ≠Êàê 'chat'ÔºåÂØºËá¥Êâæ‰∏çÂà∞Âç°Áâá
      const cardChatId = paymentMethod.replace('kinship_', '');

      const cardIndex = wallet.kinshipCards.findIndex(c => c.chatId === cardChatId);

      if (cardIndex > -1) {
        // A. Êâ£ÂáèÈ¢ùÂ∫¶
        wallet.kinshipCards[cardIndex].spent = (wallet.kinshipCards[cardIndex].spent || 0) + amount;
        await db.userWallet.put(wallet); // ‰øùÂ≠òÂõûÊï∞ÊçÆÂ∫ì

        // B. ÂÜôÂÖ•Ë¥¶Âçï
        await db.userTransactions.add({
          timestamp: Date.now(),
          type: 'expense',
          amount: amount,
          description: `‰∫≤Â±ûÂç°ËΩ¨Ë¥¶-Áªô${receiverName}`
        });

        // C. ÈÄöÁü•Èáë‰∏ª (Á≥ªÁªüÊ∂àÊÅØ)
        const providerChat = state.chats[cardChatId];
        if (providerChat) {
          let notifyContent = (cardChatId === chat.id)
            ? `[Ê∂àË¥πÈÄöÁü•ÔºöÁî®Êà∑‰ΩøÁî®‰Ω†ÁöÑ‰∫≤Â±ûÂç°Âêë„Äê‰Ω†„ÄëËΩ¨Ë¥¶‰∫Ü ¬•${amount.toFixed(2)}„ÄÇ]`
            : `[Ê∂àË¥πÈÄöÁü•ÔºöÁî®Êà∑‰ΩøÁî®‰Ω†ÁöÑ‰∫≤Â±ûÂç°Âêë„Äê${receiverName}„ÄëËΩ¨Ë¥¶‰∫Ü ¬•${amount.toFixed(2)}„ÄÇ]`;

          providerChat.history.push({ role: 'system', content: notifyContent, timestamp: Date.now(), isHidden: true });
          await db.chats.put(providerChat);
        }
      } else {
        alert("Á≥ªÁªüÈîôËØØÔºöÊâæ‰∏çÂà∞ÂØπÂ∫îÁöÑ‰∫≤Â±ûÂç°ËÆ∞ÂΩïÔºåÊîØ‰ªòÂèñÊ∂à„ÄÇ");
        return;
      }
    }

    // 5. Ê∂àÊÅØ‰∏äÂ±è
    const msg = {
      role: 'user',
      type: 'transfer',
      amount: amount,
      note: note,
      senderName,
      receiverName,
      timestamp: Date.now()
    };
    chat.history.push(msg);
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();

    document.getElementById('transfer-modal').classList.remove('visible');
    amountInput.value = '';
    noteInput.value = '';
  }


  async function sendWaimaiOrderForAI() {
    if (!state.activeChatId) return;

    const productInfoInput = document.getElementById('waimai-product-info');
    const amountInput = document.getElementById('waimai-amount');

    const productInfo = productInfoInput.value.trim();
    const amount = parseFloat(amountInput.value);

    // 1. Ê†°È™åÈáëÈ¢ùÂøÖÈ°ªÂ§ß‰∫é0
    if (!productInfo || isNaN(amount) || amount <= 0) {
      // ‰∏¥Êó∂ÊèêÂçáÂºπÁ™óÂ±ÇÁ∫ßÔºåÈò≤Ê≠¢Ë¢´Â§ñÂçñÂºπÁ™óÈÅÆÊå°
      document.getElementById('custom-modal-overlay').style.zIndex = 3002;
      await showCustomAlert('ÊèêÁ§∫', 'ËØ∑Â°´ÂÜôÊúâÊïàÁöÑÂïÜÂìÅ‰ø°ÊÅØÂíåÈáëÈ¢ù(ÂøÖÈ°ªÂ§ß‰∫é0)ÔºÅ');
      document.getElementById('custom-modal-overlay').style.zIndex = '';
      return;
    }

    const chat = state.chats[state.activeChatId];
    const now = Date.now();
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

    // „ÄêÊñ∞Â¢û„ÄëÊâßË°åÊâ£Ê¨æÈÄªËæë
    // ÂêåÊ†∑ÈúÄË¶ÅÂ§ÑÁêÜÂºπÁ™óÂ±ÇÁ∫ßÔºåÈò≤Ê≠¢‚Äú‰ΩôÈ¢ù‰∏çË∂≥‚ÄùÊèêÁ§∫Ë¢´ÈÅÆÊå°
    const modalOverlay = document.getElementById('custom-modal-overlay');
    modalOverlay.style.zIndex = 3002; // ÊØî waimai-request-modal È´ò

    const success = await processTransaction(amount, 'expense', `‰∏∫TAÁÇπÂ§ñÂçñ-${productInfo}`);

    modalOverlay.style.zIndex = ''; // ÊÅ¢Â§çÂ±ÇÁ∫ß

    if (!success) return; // ‰ΩôÈ¢ù‰∏çË∂≥ÔºåÂÅúÊ≠¢ÊâßË°å

    const visibleMessage = {
      role: 'user',
      senderName: myNickname,
      type: 'waimai_order',
      productInfo: productInfo,
      amount: amount,
      timestamp: now
    };
    chat.history.push(visibleMessage);


    const hiddenMessage = {
      role: 'system',
      content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑(${myNickname})‰∏∫‰Ω†ÁÇπ‰∫Ü‰∏Ä‰ªΩÂ§ñÂçñ‰Ωú‰∏∫„ÄêÁ§ºÁâ©„Äë„ÄÇÂ§ñÂçñÂÜÖÂÆπÊòØ‚Äú${productInfo}‚ÄùÔºå‰ª∑ÂÄº${amount}ÂÖÉ„ÄÇËøô‰∏çÊòØ‰∏Ä‰∏™‰ª£‰ªòËØ∑Ê±ÇÔºåËÄåÊòØÁî®Êà∑Â∑≤Áªè‰∏∫‰Ω†ÊîØ‰ªò‰∫Ü„ÄÇËØ∑‰Ω†ÂØπÊ≠§Ë°®Á§∫ÊÑüË∞¢„ÄÇ]`,
      timestamp: now + 1,
      isHidden: true
    };
    chat.history.push(hiddenMessage);


    await db.chats.put(chat);
    appendMessage(visibleMessage, chat);
    renderChatList();


    productInfoInput.value = '';
    amountInput.value = '';
    document.getElementById('waimai-request-modal').classList.remove('visible');
  }

  async function sendLocationShare() {
    if (!state.activeChatId) return;


    const locationName = await showCustomPrompt("ÂÖ±‰∫´‰ΩçÁΩÆ", "‰Ω†Áé∞Âú®Âú®Âì™ÈáåÂëÄÔºü", "");


    if (!locationName || !locationName.trim()) return;



    const hardcodedImageUrl = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg';

    const chat = state.chats[state.activeChatId];


    const msg = {
      role: 'user',
      type: 'location_share',
      content: locationName.trim(),
      imageUrl: hardcodedImageUrl,
      timestamp: Date.now()
    };


    chat.history.push(msg);
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();
  }


  function enterSelectionMode(initialMsgTimestamp) {
    if (isSelectionMode) return;
    isSelectionMode = true;
    document.getElementById('chat-interface-screen').classList.add('selection-mode');
    toggleMessageSelection(initialMsgTimestamp);
  }

  function exitSelectionMode() {
    cleanupWaimaiTimers();
    if (!isSelectionMode) return;
    isSelectionMode = false;
    document.getElementById('chat-interface-screen').classList.remove('selection-mode');
    selectedMessages.forEach(ts => {
      const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`);
      if (bubble) bubble.classList.remove('selected');
    });
    selectedMessages.clear();
  }


  function toggleMessageSelection(timestamp) {

    const elementToSelect = document.querySelector(
      `.message-bubble[data-timestamp="${timestamp}"]`
    );

    if (!elementToSelect) return;

    if (selectedMessages.has(timestamp)) {
      selectedMessages.delete(timestamp);
      elementToSelect.classList.remove('selected');
    } else {
      selectedMessages.add(timestamp);
      elementToSelect.classList.add('selected');
    }

    document.getElementById('selection-count').textContent = `Â∑≤ÈÄâ ${selectedMessages.size} Êù°`;

    if (selectedMessages.size === 0) {
      exitSelectionMode();
    }
  }


  function addLongPressListener(element, callback) {
    let pressTimer;
    const startPress = (e) => {
      if (isSelectionMode) return;
      e.preventDefault();
      pressTimer = window.setTimeout(() => callback(e), 500);
    };
    const cancelPress = () => clearTimeout(pressTimer);
    element.addEventListener('mousedown', startPress);
    element.addEventListener('mouseup', cancelPress);
    element.addEventListener('mouseleave', cancelPress);
    element.addEventListener('touchstart', startPress, {
      passive: true
    });
    element.addEventListener('touchend', cancelPress);
    element.addEventListener('touchmove', cancelPress);
  }

  async function handleListenTogetherClick() {
    const targetChatId = state.activeChatId;
    if (!targetChatId) return;
    if (!musicState.isActive) {
      startListenTogetherSession(targetChatId);
      return;
    }
    if (musicState.activeChatId === targetChatId) {
      document.getElementById('music-player-overlay').classList.add('visible');
    } else {
      const oldChatName = state.chats[musicState.activeChatId]?.name || 'Êú™Áü•';
      const newChatName = state.chats[targetChatId]?.name || 'ÂΩìÂâç';
      const confirmed = await showCustomConfirm('ÂàáÊç¢Âê¨Ê≠åÂØπË±°', `ÊÇ®Ê≠£Âíå„Äå${oldChatName}„ÄçÂê¨Ê≠å„ÄÇË¶ÅÁªìÊùüÂπ∂ÂºÄÂßãÂíå„Äå${newChatName}„ÄçÁöÑÊñ∞‰ºöËØùÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        await endListenTogetherSession(true);
        await new Promise(resolve => setTimeout(resolve, 50));
        startListenTogetherSession(targetChatId);
      }
    }
  }

  async function startListenTogetherSession(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;
    musicState.totalElapsedTime = chat.musicData.totalTime || 0;
    musicState.isActive = true;
    musicState.activeChatId = chatId;
    if (musicState.playlist.length > 0) {
      musicState.currentIndex = 0;
    } else {
      musicState.currentIndex = -1;
    }
    if (musicState.timerId) clearInterval(musicState.timerId);
    musicState.timerId = setInterval(() => {
      if (musicState.isPlaying) {
        musicState.totalElapsedTime++;
        updateElapsedTimeDisplay();
      }
    }, 1000);
    updatePlayerUI();
    updatePlaylistUI();
    document.getElementById('music-player-overlay').classList.add('visible');
  }

  async function endListenTogetherSession(saveState = true) {
    if (!musicState.isActive) return;
    const oldChatId = musicState.activeChatId;
    document.getElementById('global-lyrics-bar').classList.remove('visible');
    const cleanupLogic = async () => {
      if (musicState.timerId) clearInterval(musicState.timerId);
      if (musicState.isPlaying) audioPlayer.pause();
      if (saveState && oldChatId && state.chats[oldChatId]) {
        const chat = state.chats[oldChatId];
        chat.musicData.totalTime = musicState.totalElapsedTime;
        await db.chats.put(chat);
      }
      musicState.isActive = false;
      musicState.activeChatId = null;
      musicState.totalElapsedTime = 0;
      musicState.timerId = null;
      updateListenTogetherIcon(oldChatId, true);
    };
    closeMusicPlayerWithAnimation(cleanupLogic);
  }

  function returnToChat() {
    closeMusicPlayerWithAnimation();
  }

  function updateListenTogetherIcon(chatId, forceReset = false) {
    const iconImg = document.querySelector('#listen-together-btn img');
    if (!iconImg) return;
    if (forceReset || !musicState.isActive || musicState.activeChatId !== chatId) {
      iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png';
      iconImg.className = '';
      return;
    }
    iconImg.src = 'https://i.postimg.cc/D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png';
    iconImg.classList.add('rotating');
    if (musicState.isPlaying) iconImg.classList.remove('paused');
    else iconImg.classList.add('paused');
  }
  window.updateListenTogetherIconProxy = updateListenTogetherIcon;

  function updatePlayerUI() {
    updateListenTogetherIcon(musicState.activeChatId);
    updateElapsedTimeDisplay();
    const titleEl = document.getElementById('music-player-song-title');
    const artistEl = document.getElementById('music-player-artist');
    const playPauseBtn = document.getElementById('music-play-pause-btn');
    if (musicState.currentIndex > -1 && musicState.playlist.length > 0) {
      const track = musicState.playlist[musicState.currentIndex];
      titleEl.textContent = track.name;
      artistEl.textContent = track.artist;
    } else {
      titleEl.textContent = 'ËØ∑Ê∑ªÂä†Ê≠åÊõ≤';
      artistEl.textContent = '...';
    }
    playPauseBtn.textContent = musicState.isPlaying ? '‚ùö‚ùö' : '‚ñ∂';
  }

  function updateElapsedTimeDisplay() {
    const hours = (musicState.totalElapsedTime / 3600).toFixed(1);
    document.getElementById('music-time-counter').textContent = `Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü${hours}Â∞èÊó∂`;
  }

  function updatePlaylistUI() {
    const playlistBody = document.getElementById('playlist-body');
    playlistBody.innerHTML = '';
    if (musicState.playlist.length === 0) {
      playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">Êí≠ÊîæÂàóË°®ÊòØÁ©∫ÁöÑ~</p>';
      return;
    }
    musicState.playlist.forEach((track, index) => {
      const item = document.createElement('div');
      item.className = 'playlist-item';
      if (index === musicState.currentIndex) item.classList.add('playing');


      item.dataset.index = index;


      const checkboxDisplay = isPlaylistManagementMode ? 'block' : 'none';

      item.innerHTML = `
        <input type="checkbox" class="playlist-item-checkbox" style="display: ${checkboxDisplay};" data-index="${index}">
        <div class="playlist-item-info">
            <div class="title">${track.name}</div>
            <div class="artist">${track.artist}</div>
        </div>
        <div class="playlist-item-actions">
            <span class="playlist-action-btn album-art-btn" data-index="${index}">‰∏ìËæë</span>
            <span class="playlist-action-btn lyrics-btn" data-index="${index}">ËØç</span>
            <span class="playlist-action-btn bg-btn" data-index="${index}">ËÉåÊôØ</span>
            <span class="playlist-action-btn delete-track-btn" data-index="${index}">√ó</span>
        </div>
      `;


      item.addEventListener('click', (e) => {
        if (isPlaylistManagementMode) {

          if (e.target.tagName !== 'INPUT') {
            e.stopPropagation();
          }
          handlePlaylistSelection(index);
        }
      });


      const infoEl = item.querySelector('.playlist-item-info');
      if (infoEl) {
        infoEl.addEventListener('click', (e) => {
          if (!isPlaylistManagementMode) {
            e.stopPropagation();
            playSong(index, false);
          }
        });
      }

      playlistBody.appendChild(item);
    });
  }



  async function togglePlayPause() {
    if (audioPlayer.paused) {
      if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
        playSong(0, true);
      } else if (musicState.currentIndex > -1) {
        playSong(musicState.currentIndex, true);
      }
    } else {
      audioPlayer.pause();
      // await addMusicActionSystemMessage('ÊöÇÂÅú‰∫ÜÈü≥‰πê');
    }
  }

  function playNext(isAutomatic = false) {
    if (musicState.playlist.length === 0) return;
    let nextIndex;
    switch (musicState.playMode) {
      case 'random':
        nextIndex = Math.floor(Math.random() * musicState.playlist.length);
        break;
      case 'single':
        playSong(musicState.currentIndex, isAutomatic);
        return;
      case 'order':
      default:
        nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length;
        break;
    }
    playSong(nextIndex, isAutomatic);
  }

  function playPrev() {
    if (musicState.playlist.length === 0) return;
    const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length;
    playSong(newIndex, false);
  }

  function changePlayMode() {
    const modes = ['order', 'random', 'single'];
    const currentModeIndex = modes.indexOf(musicState.playMode);
    musicState.playMode = modes[(currentModeIndex + 1) % modes.length];
    document.getElementById('music-mode-btn').textContent = {
      'order': 'È°∫Â∫è',
      'random': 'ÈöèÊú∫',
      'single': 'ÂçïÊõ≤'
    }[musicState.playMode];
  }

  async function addSongFromURL() {
    const url = await showCustomPrompt("Ê∑ªÂä†ÁΩëÁªúÊ≠åÊõ≤", "ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÁöÑURL", "", "url");
    if (!url) return;
    const name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç");
    if (!name) return;
    const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç");
    if (!artist) return;
    musicState.playlist.push({
      name,
      artist,
      src: url,
      isLocal: false
    });
    await saveGlobalPlaylist();
    updatePlaylistUI();
    if (musicState.currentIndex === -1) {
      musicState.currentIndex = musicState.playlist.length - 1;
      updatePlayerUI();
    }
  }






  async function playSong(index, isAutomatic = false) {
    if (index < 0 || index >= musicState.playlist.length) return;

    audioPlayer.pause();

    musicState.currentIndex = index;
    const track = musicState.playlist[index];
    const chat = state.chats[musicState.activeChatId];


    const avatarDisplay = document.getElementById('music-player-avatar-display');
    if (chat && avatarDisplay) {

      avatarDisplay.innerHTML = '';


      const charAvatarUrl = chat.isGroup ?
        (chat.members.find(m => m.originalName === track.artist)?.avatar || defaultAvatar) :
        (chat.settings.aiAvatar || defaultAvatar);
      const userAvatarUrl = chat.settings.myAvatar || defaultAvatar;


      const charAvatarEl = document.createElement('img');
      charAvatarEl.src = charAvatarUrl;
      charAvatarEl.className = 'participant-display-avatar';
      charAvatarEl.alt = 'Character Avatar';
      avatarDisplay.appendChild(charAvatarEl);


      const userAvatarEl = document.createElement('img');
      userAvatarEl.src = userAvatarUrl;
      userAvatarEl.className = 'participant-display-avatar';
      userAvatarEl.alt = 'User Avatar';
      avatarDisplay.appendChild(userAvatarEl);
    }


    const playerWindow = document.querySelector('.music-player-window');
    const toggleBtn = document.getElementById('toggle-blur-btn');

    if (playerWindow) {
      playerWindow.style.setProperty('--music-bg-image', track.background ? `url(${track.background})` : 'none');
      playerWindow.classList.toggle('bg-clear', !!track.isBgClear);
    }
    if (toggleBtn) {
      toggleBtn.classList.toggle('active', !!track.isBgClear);
    }


    document.getElementById('music-visual-container').classList.remove('lyrics-active');
    const coverEl = document.getElementById('music-player-cover');
    if (coverEl) {
      coverEl.src = track.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg';
    }

    if (!isAutomatic) {
      await addMusicActionSystemMessage(`Â∞ÜÊ≠åÊõ≤ÂàáÊç¢‰∏∫‰∫Ü„Ää${track.name}„Äã`);
    }
    musicState.parsedLyrics = parseLRC(track.lrcContent || "");

    renderLyrics();
    const singleLyricEl = document.getElementById('single-lyric-display');
    if (singleLyricEl) {
      if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
        singleLyricEl.textContent = 'Á∫ØÈü≥‰πêÔºåËØ∑Ê¨£Ëµè';
      } else {
        singleLyricEl.textContent = '‚ô™ ‚ô™ ‚ô™';
      }
    }

    if (track.isLocal && track.src instanceof ArrayBuffer) {
      const blob = new Blob([track.src], {
        type: track.fileType || 'audio/mpeg'
      });
      audioPlayer.src = URL.createObjectURL(blob);
    } else if (track.isLocal && track.src instanceof Blob) {
      audioPlayer.src = URL.createObjectURL(track.src);
    } else if (!track.isLocal) {
      // Áõ¥Êé•‰ΩøÁî®Èü≥È¢ëURLÔºå‰∏ç‰ΩøÁî®‰ª£ÁêÜ
      // Èü≥È¢ëÊñá‰ª∂ÈÄöÂ∏∏Â∑≤ÁªèÊîØÊåÅCORSÔºå‰∏çÈúÄË¶ÅÂÉèÂõæÁâáÈÇ£Ê†∑‰ΩøÁî®‰ª£ÁêÜ
      audioPlayer.src = track.src;
      console.log(`[Èü≥‰πêÊí≠Êîæ] Âä†ËΩΩÈü≥È¢ë: ${track.name}, URL: ${track.src}`);
    } else {
      console.error('Êú¨Âú∞Ê≠åÊõ≤Ê∫êÈîôËØØ:', track);
      return;
    }

    // ÈáçÊñ∞Âä†ËΩΩÈü≥È¢ëËµÑÊ∫ê
    audioPlayer.load();

    // Âº∫Âà∂ÈáçÊñ∞Âä†ËΩΩÈü≥È¢ëÊ∫ê
    audioPlayer.load();

    const playPromise = audioPlayer.play();
    if (playPromise !== undefined) {
      playPromise.catch(error => {
        if (error.name === 'NotAllowedError') {
          console.warn('Autoplay was prevented by the browser.');
          audioPlayer.pause();

        } else if (error.name !== 'AbortError') {
          console.error('Playback error:', error);
        }
      });
    }
    updatePlaylistUI();
    updatePlayerUI();
    const isFrameMode = document.body.classList.contains('frame-mode-active');
    const isAlwaysIslandMode = state.globalSettings.alwaysShowMusicIsland || false;
    const lyricBar = document.getElementById('global-lyrics-bar');

    if (isFrameMode || isAlwaysIslandMode) {

      phoneScreenForIsland.classList.add('dynamic-island-active');
      islandAlbumArt.src = track.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg';
      lyricBar.classList.remove('visible');
    } else {

      phoneScreenForIsland.classList.remove('dynamic-island-active');
      if (musicState.parsedLyrics && musicState.parsedLyrics.length > 0) {
        lyricBar.textContent = '‚ô™';
        lyricBar.classList.add('visible');
      } else {
        lyricBar.classList.remove('visible');
      }
    }
  }



  async function handleChangeBackground(trackIndex) {
    if (trackIndex < 0 || trackIndex >= musicState.playlist.length) return;


    const choice = await showChoiceModal("Êõ¥Êç¢Ê≠åÊõ≤ËÉåÊôØ", [{
      text: 'üìÅ ‰ªéÊú¨Âú∞‰∏ä‰º†',
      value: 'local'
    },
    {
      text: 'üåê ‰ΩøÁî®ÁΩëÁªúURL',
      value: 'url'
    }
    ]);

    let newBackgroundUrl = null;


    if (choice === 'local') {
      newBackgroundUrl = await uploadImageLocally();
    } else if (choice === 'url') {
      newBackgroundUrl = await showCustomPrompt("ËæìÂÖ•ÂõæÁâáURL", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑËÉåÊôØÂõæÁâáÈìæÊé•", "", "url");
    }


    if (newBackgroundUrl && newBackgroundUrl.trim()) {
      musicState.playlist[trackIndex].background = newBackgroundUrl.trim();
      await saveGlobalPlaylist();


      if (musicState.currentIndex === trackIndex) {
        const playerWindow = document.querySelector('.music-player-window');
        playerWindow.style.setProperty('--music-bg-image', `url(${newBackgroundUrl.trim()})`);
      }

      await showCustomAlert("ÊàêÂäü", "Ê≠åÊõ≤ËÉåÊôØÂ∑≤Êõ¥Êñ∞ÔºÅ");
    }
  }

  async function handleChangeAlbumArt(trackIndex) {
    if (trackIndex < 0 || trackIndex >= musicState.playlist.length) return;

    const choice = await showChoiceModal("Êõ¥Êç¢‰∏ìËæëÂ∞ÅÈù¢", [{
      text: 'üìÅ ‰ªéÊú¨Âú∞‰∏ä‰º†',
      value: 'local'
    },
    {
      text: 'üåê ‰ΩøÁî®ÁΩëÁªúURL',
      value: 'url'
    }
    ]);

    let newCoverUrl = null;

    if (choice === 'local') {
      newCoverUrl = await uploadImageLocally();
    } else if (choice === 'url') {
      newCoverUrl = await showCustomPrompt("ËæìÂÖ•ÂõæÁâáURL", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂ∞ÅÈù¢ÂõæÁâáÈìæÊé•", "", "url");
    }

    if (newCoverUrl && newCoverUrl.trim()) {
      musicState.playlist[trackIndex].cover = newCoverUrl.trim();
      await saveGlobalPlaylist();


      if (musicState.currentIndex === trackIndex) {
        document.getElementById('music-player-cover').src = newCoverUrl.trim();

        const vinylCover = document.querySelector('#vinyl-view #music-player-cover');
        if (vinylCover) vinylCover.src = newCoverUrl.trim();
      }

      await showCustomAlert("ÊàêÂäü", "‰∏ìËæëÂ∞ÅÈù¢Â∑≤Êõ¥Êñ∞ÔºÅ");
    }
  }





  async function addSongFromLocal(event) {
    const files = event.target.files;
    if (!files.length) return;

    let uploadedCount = 0;
    for (const file of files) {
      let name = file.name.replace(/\.[^/.]+$/, "");
      name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç", name);
      if (name === null) continue;

      const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç", "Êú™Áü•Ê≠åÊâã");
      if (artist === null) continue;

      let lrcContent = "";
      const wantLrc = await showCustomConfirm("ÂØºÂÖ•Ê≠åËØç", `Ë¶Å‰∏∫„Ää${name}„ÄãÊ∑ªÂä†Ê≠åËØçÂêóÔºü`);
      if (wantLrc) {
        lrcContent = await getLrcContent() || "";
      }


      let songSrc = null;
      let isLocal = true;

      try {
        // Â∞ùËØï‰∏ä‰º†Âà∞ Catbox
        const catboxUrl = await uploadFileToCatbox(file); // 'file' ÊòØÁé∞ÊàêÁöÑ File ÂØπË±°

        if (catboxUrl) {
          // ‰∏ä‰º†ÊàêÂäü
          songSrc = catboxUrl;
          isLocal = false; // ËøôÊòØ‰∏Ä‰∏™ÁΩëÁªú URL
          await showCustomAlert("‰∏ä‰º†ÊàêÂäü", `Ê≠åÊõ≤ "${file.name}" Â∑≤ÊàêÂäü‰∏ä‰º†Âπ∂‰øùÂ≠òÂà∞ÊÇ®ÁöÑ Catbox Ë¥¶Êà∑ÔºÅ`);
        } else {

          console.log("Catbox Êú™ÈÖçÁΩÆÔºåÂ∞ÜÊ≠åÊõ≤‰øùÂ≠ò‰∏∫Êú¨Âú∞ ArrayBuffer„ÄÇ");
          songSrc = await file.arrayBuffer();
          isLocal = true;
        }
      } catch (uploadError) {

        console.error("Catbox ‰∏ä‰º†Â§±Ë¥•:", uploadError);
        await showCustomAlert("‰∏ä‰º†Â§±Ë¥•", `Ê≠åÊõ≤‰∏ä‰º†Âà∞ Catbox Â§±Ë¥•: ${uploadError.message}\n\nÂ∞ÜÊîπ‰∏∫Êú¨Âú∞‰øùÂ≠ò„ÄÇ`);
        songSrc = await file.arrayBuffer();
        isLocal = true;
      }


      musicState.playlist.push({
        name,
        artist,
        src: songSrc,       // <-- ‰øÆÊîπ
        fileType: file.type,
        isLocal: isLocal,     // <-- ‰øÆÊîπ
        lrcContent: lrcContent,
        cover: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg'
      });
      uploadedCount++;
    }

    if (uploadedCount > 0) {
      await saveGlobalPlaylist();
      updatePlaylistUI();
      if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
        musicState.currentIndex = 0;
        updatePlayerUI();
      }
    }
    event.target.value = null;
  }


  async function deleteTrack(index) {
    if (index < 0 || index >= musicState.playlist.length) return;
    const track = musicState.playlist[index];
    const wasPlaying = musicState.isPlaying && musicState.currentIndex === index;
    if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src);
    musicState.playlist.splice(index, 1);
    await saveGlobalPlaylist();
    if (musicState.playlist.length === 0) {
      if (musicState.isPlaying) audioPlayer.pause();
      audioPlayer.src = '';
      musicState.currentIndex = -1;
      musicState.isPlaying = false;
    } else {
      if (wasPlaying) {
        playNext();
      } else {
        if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1);
      }
    }
    updatePlayerUI();
    updatePlaylistUI();
  }

  const personaLibraryModal = document.getElementById('persona-library-modal');
  const personaEditorModal = document.getElementById('persona-editor-modal');
  const presetActionsModal = document.getElementById('preset-actions-modal');

  function openPersonaLibrary() {
    renderPersonaLibrary();
    personaLibraryModal.classList.add('visible');
  }

  function closePersonaLibrary() {
    personaLibraryModal.classList.remove('visible');
  }

  function renderPersonaLibrary() {
    const grid = document.getElementById('persona-library-grid');
    grid.innerHTML = '';
    if (state.personaPresets.length === 0) {
      grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">Á©∫Á©∫Â¶Ç‰πü~ ÁÇπÂáªÂè≥‰∏äËßí"Ê∑ªÂä†"Êù•ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêßÔºÅ</p>';
      return;
    }
    state.personaPresets.forEach(preset => {
      const item = document.createElement('div');
      item.className = 'persona-preset-item';
      if (isManageMode) {
        item.classList.add('manage-mode');
        if (selectedPresetIds.has(preset.id)) {
          item.classList.add('selected');
        }
      }
      item.style.backgroundImage = `url(${preset.avatar})`;
      item.dataset.presetId = preset.id;

      if (isManageMode) {
        item.addEventListener('click', () => togglePresetSelection(preset.id));
      } else {
        item.addEventListener('click', () => showPersonaActionModal(preset.id));
        addLongPressListener(item, () => showPresetActions(preset.id));
      }

      grid.appendChild(item);
    });
  }

  function togglePresetSelection(presetId) {
    if (selectedPresetIds.has(presetId)) {
      selectedPresetIds.delete(presetId);
    } else {
      selectedPresetIds.add(presetId);
    }
    renderPersonaLibrary();
  }

  function enterManageMode() {
    isManageMode = true;
    selectedPresetIds.clear();
    document.getElementById('add-persona-preset-btn').style.display = 'none';
    document.getElementById('manage-persona-preset-btn').style.display = 'none';
    document.getElementById('import-tavern-persona-btn').style.display = 'none';
    document.getElementById('close-persona-library-btn').style.display = 'none';
    document.getElementById('persona-manage-actions').style.display = 'flex';
    renderPersonaLibrary();
  }

  function exitManageMode() {
    isManageMode = false;
    selectedPresetIds.clear();
    document.getElementById('add-persona-preset-btn').style.display = 'block';
    document.getElementById('manage-persona-preset-btn').style.display = 'block';
    document.getElementById('import-tavern-persona-btn').style.display = 'block';
    document.getElementById('close-persona-library-btn').style.display = 'block';
    document.getElementById('persona-manage-actions').style.display = 'none';
    renderPersonaLibrary();
  }

  function selectAllPresets() {
    if (selectedPresetIds.size === state.personaPresets.length) {
      selectedPresetIds.clear();
    } else {
      selectedPresetIds = new Set(state.personaPresets.map(p => p.id));
    }
    renderPersonaLibrary();
  }

  async function deleteSelectedPresets() {
    if (selectedPresetIds.size === 0) {
      alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ');
      return;
    }

    const confirmed = await showCustomConfirm(
      'Âà†Èô§È¢ÑËÆæ',
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedPresetIds.size} ‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`,
      { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
      for (const presetId of selectedPresetIds) {
        await db.personaPresets.delete(presetId);
      }
      state.personaPresets = state.personaPresets.filter(p => !selectedPresetIds.has(p.id));
      selectedPresetIds.clear();
      renderPersonaLibrary();
    }
  }

  function showPresetActions(presetId) {
    editingPersonaPresetId = presetId;
    presetActionsModal.classList.add('visible');
  }

  function hidePresetActions() {
    presetActionsModal.classList.remove('visible');
    editingPersonaPresetId = null;
  }

  // ÊòæÁ§∫‰∫∫ËÆæÊìç‰ΩúÈÄâÊã©ÂºπÁ™ó
  let currentPersonaActionId = null;
  function showPersonaActionModal(presetId) {
    currentPersonaActionId = presetId;
    const modal = document.getElementById('persona-action-modal');
    modal.classList.add('visible');
  }

  // ÈöêËóè‰∫∫ËÆæÊìç‰ΩúÂºπÁ™ó
  function hidePersonaActionModal() {
    const modal = document.getElementById('persona-action-modal');
    modal.classList.remove('visible');
    currentPersonaActionId = null;
  }

  // Áõ¥Êé•Â∫îÁî®‰∫∫ËÆæ
  function applyPersonaPresetDirect() {
    if (!currentPersonaActionId) return;
    const preset = state.personaPresets.find(p => p.id === currentPersonaActionId);
    if (preset) {
      document.getElementById('my-avatar-preview').src = preset.avatar;
      document.getElementById('my-persona').value = preset.persona;
    }
    hidePersonaActionModal();
    closePersonaLibrary();
  }

  // ÁºñËæëÂêéÂ∫îÁî®‰∫∫ËÆæ
  function editPersonaThenApply() {
    if (!currentPersonaActionId) return;
    editingPersonaPresetId = currentPersonaActionId;
    const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId);
    if (!preset) return;

    // ‰øùÂ≠òÂéüÂßãÂÜÖÂÆπÔºåÁî®‰∫éÂêéÁª≠ÊØîËæÉÊòØÂê¶‰øÆÊîπ
    window.originalPersonaContent = preset.persona;

    document.getElementById('persona-editor-title').textContent = 'ÁºñËæë‰∫∫ËÆæÈ¢ÑËÆæ';
    document.getElementById('preset-avatar-preview').src = preset.avatar;
    document.getElementById('preset-persona-input').value = preset.persona;

    hidePersonaActionModal();
    personaEditorModal.classList.add('visible');
  }

  // ÊóßÁâàÊú¨‰øùÁïôÔºàÁî®‰∫éÂÖºÂÆπÊÄßÔºâ
  function applyPersonaPreset(presetId) {
    const preset = state.personaPresets.find(p => p.id === presetId);
    if (preset) {
      document.getElementById('my-avatar-preview').src = preset.avatar;
      document.getElementById('my-persona').value = preset.persona;
    }
    closePersonaLibrary();
  }

  function openPersonaEditorForCreate() {
    editingPersonaPresetId = null;
    document.getElementById('persona-editor-title').textContent = 'Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ';
    document.getElementById('preset-avatar-preview').src = defaultAvatar;
    document.getElementById('preset-persona-input').value = '';
    personaEditorModal.classList.add('visible');
  }

  function openPersonaEditorForEdit() {
    const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId);
    if (!preset) return;
    document.getElementById('persona-editor-title').textContent = 'ÁºñËæë‰∫∫ËÆæÈ¢ÑËÆæ';
    document.getElementById('preset-avatar-preview').src = preset.avatar;
    document.getElementById('preset-persona-input').value = preset.persona;
    presetActionsModal.classList.remove('visible');
    personaEditorModal.classList.add('visible');
  }

  async function deletePersonaPreset() {
    const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed && editingPersonaPresetId) {
      await db.personaPresets.delete(editingPersonaPresetId);
      state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId);
      hidePresetActions();
      renderPersonaLibrary();
    }
  }

  function closePersonaEditor() {
    personaEditorModal.classList.remove('visible');
    editingPersonaPresetId = null;
  }

  async function savePersonaPreset() {
    const avatar = document.getElementById('preset-avatar-preview').src;
    const persona = document.getElementById('preset-persona-input').value.trim();
    if (avatar === defaultAvatar && !persona) {
      alert("Â§¥ÂÉèÂíå‰∫∫ËÆæ‰∏çËÉΩÈÉΩ‰∏∫Á©∫Âì¶ÔºÅ");
      return;
    }

    if (editingPersonaPresetId) {
      const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId);
      if (preset) {
        const oldPersona = preset.persona;
        const personaChanged = oldPersona !== persona;

        // Â¶ÇÊûú‰∫∫ËÆæÂÜÖÂÆπÊúâ‰øÆÊîπÔºåËØ¢ÈóÆÊòØÂê¶ÂêåÊ≠•
        if (personaChanged && window.originalPersonaContent && window.originalPersonaContent !== persona) {
          const shouldSync = await showCustomConfirm(
            'ÂêåÊ≠•Êõ¥Êñ∞',
            `Ê£ÄÊµãÂà∞‰∫∫ËÆæÂÜÖÂÆπÂ∑≤‰øÆÊîπ„ÄÇ\n\nÂéüÂÜÖÂÆπÔºö${oldPersona.substring(0, 50)}${oldPersona.length > 50 ? '...' : ''}\nÊñ∞ÂÜÖÂÆπÔºö${persona.substring(0, 50)}${persona.length > 50 ? '...' : ''}\n\nÊòØÂê¶ÂêåÊ≠•Êõ¥Êñ∞Âà∞ÊâÄÊúâ‰ΩøÁî®Ê≠§‰∫∫ËÆæÁöÑÂú∞ÊñπÔºü`,
            {
              confirmText: 'ÂêåÊ≠•Êõ¥Êñ∞',
              cancelText: '‰ªÖÊõ¥Êñ∞È¢ÑËÆæ'
            }
          );

          if (shouldSync) {
            // ÂêåÊ≠•Âà∞ÂÖ®Â±ÄËÆæÁΩÆÔºàÂ¶ÇÊûúÂΩìÂâç‰ΩøÁî®ÁöÑÊòØËøô‰∏™‰∫∫ËÆæÔºâ
            const currentPersona = document.getElementById('my-persona')?.value;
            if (currentPersona === oldPersona) {
              document.getElementById('my-persona').value = persona;
              document.getElementById('my-avatar-preview').src = avatar;

              // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄËÆæÁΩÆ
              const globalSettings = await db.globalSettings.get('main');
              if (globalSettings) {
                globalSettings.myPersona = persona;
                globalSettings.myAvatar = avatar;
                await db.globalSettings.put(globalSettings);
              }
            }

            // ÂêåÊ≠•Âà∞ÊâÄÊúâËßíËâ≤ÁöÑÂçïÁã¨‰∫∫ËÆæÈÖçÁΩÆ
            for (const chatId in state.chats) {
              const chat = state.chats[chatId];
              if (chat.customPersona === oldPersona) {
                chat.customPersona = persona;
                await db.chats.put(chat);
              }
            }

            // ÂêåÊ≠•Âà∞ÁªøÊ±ü‰ΩúÂìÅËÆæÁΩÆ‰∏≠ÁöÑUser Persona
            const stories = await db.grStories.toArray();
            for (const story of stories) {
              if (story.settings && story.settings.userPersonaId === editingPersonaPresetId) {
                // ÁªøÊ±ü‰∏≠‰ΩøÁî®ÁöÑÊòØÈ¢ÑËÆæIDÔºå‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÂêåÊ≠•
              }
            }

            await showCustomAlert('ÂêåÊ≠•ÂÆåÊàê', 'Â∑≤ÊàêÂäüÂêåÊ≠•Êõ¥Êñ∞Âà∞ÊâÄÊúâ‰ΩøÁî®Ê≠§‰∫∫ËÆæÁöÑÂú∞ÊñπÔºÅ');
          }
        }

        preset.avatar = avatar;
        preset.persona = persona;
        await db.personaPresets.put(preset);

        // Â¶ÇÊûúÊòØ"ÁºñËæëÂêéÂ∫îÁî®"Ê®°ÂºèÔºåÁõ¥Êé•Â∫îÁî®Âà∞ÂΩìÂâç
        if (window.originalPersonaContent) {
          document.getElementById('my-avatar-preview').src = avatar;
          document.getElementById('my-persona').value = persona;
        }
      }
    } else {
      const newPreset = {
        id: 'preset_' + Date.now(),
        avatar: avatar,
        persona: persona
      };
      await db.personaPresets.add(newPreset);
      state.personaPresets.push(newPreset);
    }

    // Ê∏ÖÈô§ÂéüÂßãÂÜÖÂÆπÊ†áËÆ∞
    window.originalPersonaContent = null;

    renderPersonaLibrary();
    closePersonaEditor();
    closePersonaLibrary();
  }

  async function importTavernPersonas() {
    const input = document.getElementById('import-tavern-persona-input');
    input.click();
  }

  async function handleTavernPersonaImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const data = JSON.parse(text);

      if (!data.personas || !data.persona_descriptions) {
        await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', 'Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑Á°Æ‰øùÊòØÈÖíÈ¶ÜAIÂØºÂá∫ÁöÑUSERÈ¢ÑËÆæÊñá‰ª∂„ÄÇ');
        event.target.value = '';
        return;
      }

      const personas = data.personas;
      const descriptions = data.persona_descriptions;
      pendingTavernPersonas = [];

      for (const [imageKey, name] of Object.entries(personas)) {
        const desc = descriptions[imageKey];
        if (!desc || !desc.description) continue;

        pendingTavernPersonas.push({
          name: name,
          description: desc.description,
          imageKey: imageKey
        });
      }

      event.target.value = '';

      if (pendingTavernPersonas.length === 0) {
        await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', 'Êñá‰ª∂‰∏≠Ê≤°ÊúâÊâæÂà∞ÊúâÊïàÁöÑÈ¢ÑËÆæÊï∞ÊçÆ„ÄÇ');
        return;
      }

      const importAll = await showCustomConfirm(
        'ÂØºÂÖ•È¢ÑËÆæ',
        `Ê£ÄÊµãÂà∞ ${pendingTavernPersonas.length} ‰∏™È¢ÑËÆæ„ÄÇÊòØÂê¶ÂÖ®ÈÉ®ÂØºÂÖ•Ôºü\n\nÈÄâÊã©"Á°ÆÂÆö"ÂÖ®ÈÉ®ÂØºÂÖ•\nÈÄâÊã©"ÂèñÊ∂à"ÊâãÂä®ÈÄâÊã©Ë¶ÅÂØºÂÖ•ÁöÑÈ¢ÑËÆæ`,
        { confirmText: 'ÂÖ®ÈÉ®ÂØºÂÖ•', cancelText: 'ÊâãÂä®ÈÄâÊã©' }
      );

      if (importAll) {
        await importSelectedTavernPersonas(pendingTavernPersonas);
      } else {
        showTavernPersonaSelector();
      }
    } catch (error) {
      console.error('ÂØºÂÖ•ÈÖíÈ¶ÜAIÈ¢ÑËÆæÂ§±Ë¥•:', error);
      await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', 'Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºèÊòØÂê¶Ê≠£Á°Æ„ÄÇ');
      event.target.value = '';
    }
  }

  function showTavernPersonaSelector() {
    const modal = document.getElementById('tavern-persona-selector-modal');
    const listEl = document.getElementById('tavern-persona-selector-list');
    listEl.innerHTML = '';

    pendingTavernPersonas.forEach((persona, index) => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';
      item.style.padding = '15px 20px';
      item.style.borderBottom = '1px solid var(--border-color)';

      const previewText = persona.description.length > 100
        ? persona.description.substring(0, 100) + '...'
        : persona.description;

      item.innerHTML = `
        <input type="checkbox" class="tavern-persona-checkbox" data-index="${index}" checked style="margin-right: 15px;">
        <div style="flex: 1;">
          <div style="font-weight: 600; margin-bottom: 5px;">${escapeHTML(persona.name)}</div>
          <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.4;">${escapeHTML(previewText)}</div>
        </div>
      `;
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
  }

  function closeTavernPersonaSelector() {
    document.getElementById('tavern-persona-selector-modal').classList.remove('visible');
    pendingTavernPersonas = [];
  }

  async function confirmTavernImport() {
    const selectedIndices = Array.from(document.querySelectorAll('.tavern-persona-checkbox:checked'))
      .map(cb => parseInt(cb.dataset.index));

    if (selectedIndices.length === 0) {
      await showCustomAlert('ÊèêÁ§∫', 'ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæËøõË°åÂØºÂÖ•„ÄÇ');
      return;
    }

    const selectedPersonas = selectedIndices.map(i => pendingTavernPersonas[i]);
    closeTavernPersonaSelector();
    await importSelectedTavernPersonas(selectedPersonas);
  }

  async function importSelectedTavernPersonas(personas) {
    let importCount = 0;

    for (const persona of personas) {
      const newPreset = {
        id: 'preset_tavern_' + Date.now() + '_' + importCount,
        avatar: defaultAvatar,
        persona: `ÂêçÂ≠óÔºö${persona.name}\n\n${persona.description}`
      };

      await db.personaPresets.add(newPreset);
      state.personaPresets.push(newPreset);
      importCount++;

      await new Promise(resolve => setTimeout(resolve, 10));
    }

    renderPersonaLibrary();
    await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `ÊàêÂäüÂØºÂÖ• ${importCount} ‰∏™‰∫∫ËÆæÈ¢ÑËÆæÔºÅ`);
  }

  const batteryAlertModal = document.getElementById('battery-alert-modal');

  function showBatteryAlert(imageUrl, text) {
    clearTimeout(batteryAlertTimeout);
    document.getElementById('battery-alert-image').src = imageUrl;
    document.getElementById('battery-alert-text').textContent = text;
    batteryAlertModal.classList.add('visible');
    const closeAlert = () => {
      batteryAlertModal.classList.remove('visible');
      batteryAlertModal.removeEventListener('click', closeAlert);
    };
    batteryAlertModal.addEventListener('click', closeAlert);
    batteryAlertTimeout = setTimeout(closeAlert, 2000);
  }

  function updateBatteryDisplay(battery) {
    const batteryContainer = document.getElementById('status-bar-battery');
    const batteryLevelEl = batteryContainer.querySelector('.battery-level');
    const batteryTextEl = batteryContainer.querySelector('.battery-text');
    const level = Math.floor(battery.level * 100);
    batteryLevelEl.style.width = `${level}%`;
    batteryTextEl.textContent = `${level}%`;
    if (battery.charging) {
      batteryContainer.classList.add('charging');
    } else {
      batteryContainer.classList.remove('charging');
    }
  }

  function handleBatteryChange(battery) {
    updateBatteryDisplay(battery);
    const level = battery.level;
    if (!battery.charging) {
      if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) {
        showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'ÊúâÁÇπÈ•ø‰∫ÜÔºåÂèØ‰ª•ÂéªÊâæÂÖÖÁîµÂô®ÊÉπ');
        alertFlags.hasShown40 = true;
      }
      if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) {
        showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'Ëµ∂Á¥ßÁöÑÂÖÖÁîµÔºåË¶ÅÈ•øÊ≠ª‰∫Ü');
        alertFlags.hasShown20 = true;
      }
      if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) {
        showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'Â∑≤Èòµ‰∫°ÔºåËøòÊúâ30ÁßíÁàÜÁÇ∏');
        alertFlags.hasShown10 = true;
      }
    }
    if (level > 0.4) alertFlags.hasShown40 = false;
    if (level > 0.2) alertFlags.hasShown20 = false;
    if (level > 0.1) alertFlags.hasShown10 = false;
    lastKnownBatteryLevel = level;
  }

  async function initBatteryManager() {
    if ('getBattery' in navigator) {
      try {
        const battery = await navigator.getBattery();
        lastKnownBatteryLevel = battery.level;
        handleBatteryChange(battery);
        battery.addEventListener('levelchange', () => handleBatteryChange(battery));
        battery.addEventListener('chargingchange', () => {
          handleBatteryChange(battery);
          if (battery.charging) {
            showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'Á™ùÁà±Ê≥•ÔºåÁîµÈáèÂêÉÈ•±È•±');
          }
        });
      } catch (err) {
        console.error("Êó†Ê≥ïËé∑ÂèñÁîµÊ±†‰ø°ÊÅØ:", err);
        document.querySelector('.battery-text').textContent = '·óúœâ·óú';
      }
    } else {
      console.log("ÊµèËßàÂô®‰∏çÊîØÊåÅÁîµÊ±†Áä∂ÊÄÅAPI„ÄÇ");
      document.querySelector('.battery-text').textContent = '·óúœâ·óú';
    }
  }

  async function renderAlbumList() {
    const albumGrid = document.getElementById('album-grid-page');
    if (!albumGrid) return;
    const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
    albumGrid.innerHTML = '';
    if (albums.length === 0) {
      albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">‰Ω†ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰ΩïÁõ∏ÂÜåÂì¶~</p>';
      return;
    }
    albums.forEach(album => {
      const albumItem = document.createElement('div');
      albumItem.className = 'album-item';
      albumItem.innerHTML = `
                            <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                            <div class="album-info">
                                <p class="album-name">${album.name}</p>
                                <p class="album-count">${album.photoCount || 0} Âº†</p>
                            </div>
                        `;
      albumItem.addEventListener('click', () => {
        openAlbum(album.id);
      });


      addLongPressListener(albumItem, async () => {
        const confirmed = await showCustomConfirm(
          'Âà†Èô§Áõ∏ÂÜå',
          `Á°ÆÂÆöË¶ÅÂà†Èô§Áõ∏ÂÜå„Ää${album.name}„ÄãÂêóÔºüÊ≠§Êìç‰ΩúÂ∞ÜÂêåÊó∂Âà†Èô§Áõ∏ÂÜåÂÜÖÁöÑÊâÄÊúâÁÖßÁâáÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ`, {
          confirmButtonClass: 'btn-danger'
        }
        );

        if (confirmed) {

          await db.qzonePhotos.where('albumId').equals(album.id).delete();


          await db.qzoneAlbums.delete(album.id);


          await renderAlbumList();

          alert('Áõ∏ÂÜåÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ');
        }
      });


      albumGrid.appendChild(albumItem);
    });
  }

  async function openAlbum(albumId) {
    state.activeAlbumId = albumId;
    await renderAlbumPhotosScreen();
    showScreen('album-photos-screen');
  }

  async function renderAlbumPhotosScreen() {
    if (!state.activeAlbumId) return;
    const photosGrid = document.getElementById('photos-grid-page');
    const headerTitle = document.getElementById('album-photos-title');
    const album = await db.qzoneAlbums.get(state.activeAlbumId);
    if (!album) {
      console.error("Êâæ‰∏çÂà∞Áõ∏ÂÜå:", state.activeAlbumId);
      showScreen('album-screen');
      return;
    }
    headerTitle.textContent = album.name;
    const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
    photosGrid.innerHTML = '';
    if (photos.length === 0) {
      photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">Ëøô‰∏™Áõ∏ÂÜåËøòÊòØÁ©∫ÁöÑÔºåÂø´‰∏ä‰º†Á¨¨‰∏ÄÂº†ÁÖßÁâáÂêßÔºÅ</p>';
    } else {
      photos.forEach(photo => {
        const photoItem = document.createElement('div');
        photoItem.className = 'photo-item';
        photoItem.innerHTML = `
                                <img src="${photo.url}" class="photo-thumb" alt="Áõ∏ÂÜåÁÖßÁâá">
                                <button class="photo-delete-btn" data-photo-id="${photo.id}">√ó</button>
                            `;
        photosGrid.appendChild(photoItem);
      });
    }
  }


  async function openPhotoViewer(clickedPhotoUrl) {
    if (!state.activeAlbumId) return;


    const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
    photoViewerState.photos = photosInAlbum.map(p => p.url);


    photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
    if (photoViewerState.currentIndex === -1) return;


    document.getElementById('photo-viewer-modal').classList.add('visible');
    renderPhotoViewer();
    photoViewerState.isOpen = true;
  }


  function renderPhotoViewer() {
    if (photoViewerState.currentIndex === -1) return;

    const imageEl = document.getElementById('photo-viewer-image');
    const prevBtn = document.getElementById('photo-viewer-prev-btn');
    const nextBtn = document.getElementById('photo-viewer-next-btn');


    imageEl.style.opacity = 0;

    setTimeout(() => {

      imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];

      imageEl.style.opacity = 1;
    }, 100);


    prevBtn.disabled = photoViewerState.currentIndex === 0;

    nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
  }


  function showNextPhoto() {
    if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
      photoViewerState.currentIndex++;
      renderPhotoViewer();
    }
  }


  function showPrevPhoto() {
    if (photoViewerState.currentIndex > 0) {
      photoViewerState.currentIndex--;
      renderPhotoViewer();
    }
  }


  function closePhotoViewer() {
    document.getElementById('photo-viewer-modal').classList.remove('visible');
    photoViewerState.isOpen = false;
    photoViewerState.photos = [];
    photoViewerState.currentIndex = -1;

    document.getElementById('photo-viewer-image').src = '';
  }



  function updateUnreadIndicator(count) {
    unreadPostsCount = count;
    localStorage.setItem('unreadPostsCount', count);


    const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');

    const targetSpan = navItem.querySelector('span');
    let indicator = navItem.querySelector('.unread-indicator');

    if (count > 0) {
      if (!indicator) {
        indicator = document.createElement('span');
        indicator.className = 'unread-indicator';
        targetSpan.style.position = 'relative';
        targetSpan.appendChild(indicator);
      }
      indicator.textContent = count > 99 ? '99+' : count;
      indicator.style.display = 'block';
    } else {
      if (indicator) {
        indicator.style.display = 'none';
      }
    }


    updateBackButtonUnreadCount();
  }




  // Ê£ÄÊü•ÊòØÂê¶ÊúâÂæÖÂ§ÑÁêÜÁöÑË¥≠Áâ©ËΩ¶Ê∏ÖÁ©∫ÈÄöÁü•
  async function checkPendingCartNotifications() {
    try {
      const allChats = Object.values(state.chats);
      
      for (const chat of allChats) {
        if (chat.pendingCartClearNotification && !chat.isGroup) {
          const notification = chat.pendingCartClearNotification;
          const itemCount = notification.items.reduce((sum, item) => sum + item.quantity, 0);
          
          // ÊûÑÂª∫Áâ©ÂìÅÂàóË°®
          const itemsList = notification.items.map(item => 
            `${item.name} x${item.quantity} (¬•${(item.price * item.quantity).toFixed(2)})`
          ).join('\n');
          
          await showCustomAlert(
            `${chat.name} Â∏Æ‰Ω†Ê∏ÖÁ©∫‰∫ÜË¥≠Áâ©ËΩ¶ÔºÅ`,
            `${chat.name} Â∑≤ÁªèÁî®Ëá™Â∑±ÁöÑÈí±Â∏Æ‰Ω†Ë¥≠‰π∞‰∫ÜË¥≠Áâ©ËΩ¶‰∏≠ÁöÑÊâÄÊúâÂïÜÂìÅÔºÅ\n\nÂÖ± ${itemCount} ‰ª∂ÂïÜÂìÅÔºåÊÄª‰ª∑ ¬•${notification.totalCost.toFixed(2)}\n\n${itemsList}\n\nÊâÄÊúâÁâ©ÂìÅÈÉΩÂú®Ë∑Ø‰∏äÂï¶~`
          );
          
          // Ê∏ÖÈô§ÈÄöÁü•Ê†áËÆ∞
          delete chat.pendingCartClearNotification;
          await db.chats.put(chat);
          
          // Âè™ÊòæÁ§∫Á¨¨‰∏Ä‰∏™ÈÄöÁü•ÔºåÈÅøÂÖç‰∏ÄÊ¨°ÊÄßÂºπÂá∫Â§™Â§ö
          break;
        }
      }
    } catch (error) {
      console.error("Ê£ÄÊü•ÂæÖÂ§ÑÁêÜÈÄöÁü•Â§±Ë¥•:", error);
    }
  }

  // Ê£ÄÊü•ËßíËâ≤ÊòØÂê¶ÂèØ‰ª•Â∏ÆÂä©Áî®Êà∑Ê∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶
  async function checkAndClearShoppingCart(chatId) {
    try {
      const chat = state.chats[chatId];
      
      // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®‰∫ÜËá™Âä®Ê∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶ÂäüËÉΩ
      if (!chat || !chat.settings.enableAutoCartClear) {
        return;
      }
      
      // Ê£ÄÊü•Ë¥≠Áâ©ËΩ¶ÊòØÂê¶‰∏∫Á©∫
      if (!shoppingCart || shoppingCart.length === 0) {
        return;
      }
      
      // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâÂæÖÂ§ÑÁêÜÁöÑÈÄöÁü•ÔºàÈÅøÂÖçÈáçÂ§çÈÄöÁü•Ôºâ
      if (chat.pendingCartClearNotification) {
        return;
      }
      
      // Ëé∑ÂèñËßíËâ≤ÁöÑÈí±ÂåÖ‰ΩôÈ¢ù
      const taobaoHistory = chat.simulatedTaobaoHistory || {};
      const characterBalance = taobaoHistory.totalBalance || 0;
      
      // ËÆ°ÁÆóË¥≠Áâ©ËΩ¶ÊÄª‰ª∑
      const productIds = shoppingCart.map(item => item.productId);
      const products = await db.products.bulkGet(productIds);
      const productMap = new Map(products.filter(p => p).map(p => [p.id, p]));
      
      let totalCost = 0;
      shoppingCart.forEach(cartItem => {
        const product = productMap.get(cartItem.productId);
        if (product) {
          const price = cartItem.variation ? cartItem.variation.price : product.price;
          totalCost += price * cartItem.quantity;
        }
      });
      
      // Ê£ÄÊü•‰ΩôÈ¢ùÊòØÂê¶Ë∂≥Â§ü
      if (characterBalance < totalCost) {
        return;
      }
      
      // ÈöèÊú∫ÂÜ≥ÂÆöÊòØÂê¶ÊâßË°åÔºàÈÅøÂÖçÊØèÊ¨°ÈÉΩËß¶ÂèëÔºâ
      if (Math.random() > 0.3) {
        return;
      }
      
      console.log(`ËßíËâ≤ "${chat.name}" ÂáÜÂ§áÂ∏ÆÂä©Ê∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶ÔºåÊÄª‰ª∑: ¬•${totalCost.toFixed(2)}, ‰ΩôÈ¢ù: ¬•${characterBalance.toFixed(2)}`);
      
      // Êâ£Èô§ËßíËâ≤‰ΩôÈ¢ù
      if (!chat.simulatedTaobaoHistory) chat.simulatedTaobaoHistory = { totalBalance: 0, purchases: [] };
      if (!chat.simulatedTaobaoHistory.purchases) chat.simulatedTaobaoHistory.purchases = [];
      
      chat.simulatedTaobaoHistory.totalBalance -= totalCost;
      
      // ËÆ∞ÂΩïË¥≠‰π∞ËÆ∞ÂΩï
      const purchaseItems = [];
      shoppingCart.forEach(cartItem => {
        const product = productMap.get(cartItem.productId);
        if (product) {
          const price = cartItem.variation ? cartItem.variation.price : product.price;
          const itemName = cartItem.variation ? `${product.name} - ${cartItem.variation.name}` : product.name;
          
          chat.simulatedTaobaoHistory.purchases.unshift({
            itemName: itemName,
            price: price * cartItem.quantity,
            quantity: cartItem.quantity,
            status: 'Â∑≤ÂèëË¥ß',
            reason: 'Â∏Æ‰Ω†Ê∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶',
            image_prompt: `${itemName}, product photography`,
            timestamp: Date.now()
          });
          
          purchaseItems.push({
            name: itemName,
            quantity: cartItem.quantity,
            price: price
          });
        }
      });
      
      // ‰øùÂ≠òËßíËâ≤Êï∞ÊçÆ
      await db.chats.put(chat);
      
      // Ê∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶
      const clearedItems = [...shoppingCart];
      shoppingCart = [];
      updateCartCount();
      saveShoppingCart(); // ‰øùÂ≠òË¥≠Áâ©ËΩ¶
      
      // Â¶ÇÊûúÁî®Êà∑Ê≠£Âú®Êü•ÁúãË¥≠Áâ©ËΩ¶È°µÈù¢ÔºåÂà∑Êñ∞È°µÈù¢
      const cartScreen = document.getElementById('cart-screen');
      if (cartScreen && cartScreen.classList.contains('active')) {
        renderCartItems();
      }
      
      // Ê†áËÆ∞ÊúâÂæÖÂ§ÑÁêÜÁöÑÈÄöÁü•
      chat.pendingCartClearNotification = {
        items: purchaseItems,
        totalCost: totalCost,
        timestamp: Date.now()
      };
      await db.chats.put(chat);
      
      console.log(`‚úÖ ËßíËâ≤ "${chat.name}" Â∑≤Ê∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶ÔºåÊÄª‰ª∑: ¬•${totalCost.toFixed(2)}`);
      
    } catch (error) {
      console.error("Ê£ÄÊü•ÂíåÊ∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶Â§±Ë¥•:", error);
    }
  }

  function startBackgroundSimulation() {
    if (simulationIntervalId) return;
    const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;

    simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000);
    playSilentAudio();
  }

  function stopBackgroundSimulation() {
    if (simulationIntervalId) {
      clearInterval(simulationIntervalId);
      simulationIntervalId = null;
    }
    stopSilentAudio();
  }




  async function runBackgroundSimulationTick() {
    console.log("Ê®°ÊãüÂô®ÂøÉË∑≥ Tick...");
    if (!state.globalSettings.enableBackgroundActivity) {
      stopBackgroundSimulation();
      return;
    }


    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    allSingleChats.forEach(chat => {
      if (chat.relationship?.status === 'blocked_by_user') {
        const blockedTimestamp = chat.relationship.blockedTimestamp;
        if (!blockedTimestamp) return;
        const blockedDuration = Date.now() - blockedTimestamp;
        const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;
        if (blockedDuration > cooldownMilliseconds) {
          chat.relationship.status = 'pending_system_reflection';
          triggerAiFriendApplication(chat.id);
        }
      } else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
        if (chat.settings.enableBackgroundActivity === false) {
          console.log(`ËßíËâ≤ "${chat.name}" ÁöÑÁã¨Á´ãÂêéÂè∞Ê¥ªÂä®ÂºÄÂÖ≥Â∑≤ÂÖ≥Èó≠ÔºåÊú¨Ê¨°Ë∑≥Ëøá„ÄÇ`);
          return;
        }
        if (Math.random() < 0.20) {
          console.log(`ËßíËâ≤ "${chat.name}" Ë¢´Âî§ÈÜíÔºåÂáÜÂ§áÁã¨Á´ãË°åÂä®...`);
          triggerInactiveAiAction(chat.id);
        }
        // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•Â∏ÆÂä©Áî®Êà∑Ê∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶
        checkAndClearShoppingCart(chat.id);
      }
    });


    const allGroupChats = Object.values(state.chats).filter(chat => chat.isGroup);
    allGroupChats.forEach(chat => {
      if (chat.settings.enableBackgroundActivity === false) {
        console.log(`Áæ§ËÅä "${chat.name}" ÁöÑÂêéÂè∞Ê¥ªÂä®ÂºÄÂÖ≥Â∑≤ÂÖ≥Èó≠ÔºåÊú¨Ê¨°Ë∑≥Ëøá„ÄÇ`);
        return;
      }
      if (chat.id !== state.activeChatId && Math.random() < 0.10) {
        console.log(`Áæ§ËÅä "${chat.name}" Ë¢´Âî§ÈÜíÔºåÂáÜÂ§áÁã¨Á´ãË°åÂä®...`);
        triggerGroupAiAction(chat.id);
      }
    });


    try {
      const allNpcs = await db.npcs.toArray();
      if (allNpcs.length === 0) return;

      const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(10).toArray();

      for (const npc of allNpcs) {
        if (npc.enableBackgroundActivity === false) continue;
        const cooldownMinutes = npc.actionCooldownMinutes || 15;
        if (npc.lastActionTimestamp) {
          const minutesSinceLastAction = (Date.now() - npc.lastActionTimestamp) / (1000 * 60);
          if (minutesSinceLastAction < cooldownMinutes) {
            continue;
          }
        }
        if (Math.random() > 0.3) continue;


        const tasks = [];
        for (const post of allRecentPosts) {

          if (post.authorId === `npc_${npc.id}`) continue;


          const isRepliedTo = post.comments?.some(c => c.replyTo === npc.name);


          const lastCommenter = post.comments?.slice(-1)[0]?.commenterName;
          if (lastCommenter === npc.name) continue;

          let isVisible = false;


          if (post.authorId === 'user' || post.authorId.startsWith('chat_')) {
            if (npc.associatedWith.includes(post.authorId)) {
              isVisible = true;
            }
          } else if (post.authorId.startsWith('npc_')) {
            const authorNpcId = parseInt(post.authorId.replace('npc_', ''));
            const authorNpc = await db.npcs.get(authorNpcId);


            if (authorNpc) {
              const npc1_group = npc.npcGroupId;
              const npc2_group = authorNpc.npcGroupId;


              if (npc1_group && npc2_group && npc1_group === npc2_group) {
                isVisible = true;
              }
            }
          }

          if (isVisible || isRepliedTo) {
            tasks.push(post);
          }
        }



        if (tasks.length > 0 || Math.random() < 0.2) {
          console.log(`NPC "${npc.name}" Ëß¶ÂèëË°åÂä®ÂÜ≥Á≠ñ...`);
          const generatedActions = await generateNpcActions(npc, tasks);

          if (generatedActions && generatedActions.length > 0) {
            for (const action of generatedActions) {
              if (action.type === 'qzone_comment') {

                const post = await db.qzonePosts.get(action.postId);
                if (post) {
                  if (!post.comments) post.comments = [];
                  post.comments.push({
                    commenterName: npc.name,
                    text: action.commentText,
                    replyTo: action.replyTo || null,
                    timestamp: Date.now() + Math.random()
                  });
                  await db.qzonePosts.update(action.postId, {
                    comments: post.comments
                  });
                  updateUnreadIndicator(unreadPostsCount + 1);
                }
              } else if (action.type === 'qzone_post') {

                const newPost = {
                  type: action.postType || 'shuoshuo',
                  content: action.content,
                  timestamp: Date.now(),
                  authorId: `npc_${npc.id}`,
                  authorOriginalName: npc.name,
                  visibleTo: npc.associatedWith,
                  likes: [],
                  comments: [],
                  isDeleted: false
                };
                await db.qzonePosts.add(newPost);
                console.log(`NPC "${npc.name}" ÊàêÂäüÂèëÂ∏É‰∫Ü‰∏ÄÊù°Êñ∞Âä®ÊÄÅ„ÄÇ`);
                updateUnreadIndicator(unreadPostsCount + 1);
              }
            }
            await db.npcs.update(npc.id, {
              lastActionTimestamp: Date.now()
            });
            if (document.getElementById('qzone-screen').classList.contains('active')) {
              await renderQzonePosts();
            }
          }
        }
      }
    } catch (error) {
      console.error("Â§ÑÁêÜNPCÂêéÂè∞Ê¥ªÂä®Êó∂Âá∫Èîô:", error);
    }
  }

  async function generateNpcActions(npc, tasks) {
    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      console.error("NPCË°åÂä®Â§±Ë¥•ÔºöAPIÊú™ÈÖçÁΩÆ„ÄÇ");
      return null;
    }


    let charactersContext = "# ‰Ω†ÁöÑ‰∫íÂä®ÂØπË±° (Áî®Êà∑ÂíåÂÖ∂‰ªñËßíËâ≤)\n";
    const userNickname = state.qzoneSettings.nickname || 'Êàë';
    const userPersona = state.chats[Object.keys(state.chats)[0]]?.settings.myPersona || '(Êú™ËÆæÁΩÆ)';
    charactersContext += `- **${userNickname} (Áî®Êà∑)**: ${userPersona}\n`;
    if (npc.associatedWith && npc.associatedWith.length > 0) {
      npc.associatedWith.forEach(charId => {
        const char = state.chats[charId];
        if (char && !char.isGroup) {
          charactersContext += `- **${char.name} (Êú¨Âêç: ${char.originalName})**: ${char.settings.aiPersona}\n`;
        }
      });
    }

    const tasksString = (await Promise.all(tasks.map(async post => {
      let authorDisplayName = 'Êú™Áü•‰ΩúËÄÖ';
      if (post.authorId === 'user') {
        authorDisplayName = state.qzoneSettings.nickname || 'Áî®Êà∑';
      } else if (post.authorId.startsWith('chat_')) {
        authorDisplayName = getDisplayNameByOriginalName(post.authorOriginalName || post.authorId);
      } else if (post.authorId.startsWith('npc_')) {
        const authorNpcId = parseInt(post.authorId.replace('npc_', ''));
        const authorNpc = await db.npcs.get(authorNpcId);
        if (authorNpc) {
          authorDisplayName = authorNpc.name;
        }
      }

      const commentsString = (post.comments || [])
        .map(c => {
          if (typeof c === 'object' && c.commenterName) {
            const commenterDisplayName = getDisplayNameByOriginalName(c.commenterName);
            return `- **${commenterDisplayName}**: ${c.text}`;
          }
          return `- ${c}`;
        }).join('\n');
      return `
---
### Â∏ñÂ≠êID: ${post.id}
- **‰ΩúËÄÖ**: ${authorDisplayName}
- **ÂÜÖÂÆπÊëòË¶Å**: ${(post.content || post.publicText || '').substring(0, 150)}...
- **Â∑≤ÊúâËØÑËÆ∫**:
${commentsString || '(ÊöÇÊó†ËØÑËÆ∫)'}
---
`;
    }))).join('\n');





    const npcAuthorId = `npc_${npc.id}`;
    const twelveHoursAgo = Date.now() - (12 * 60 * 60 * 1000);
    const recentNpcPosts = await db.qzonePosts
      .where('authorId').equals(npcAuthorId)
      .and(post => post.timestamp > twelveHoursAgo)
      .toArray();


    let postingCooldownInstruction = '';
    if (recentNpcPosts.length > 0) {
      postingCooldownInstruction = `
# „ÄêË°å‰∏∫ÂÄæÂêëÊåá‰ª§ (È´ò‰ºòÂÖàÁ∫ß)„Äë
**‰Ω†ÊúÄËøëÂ∑≤ÁªèÂèëÂ∏ÉËøáÂä®ÊÄÅ‰∫Ü„ÄÇ** ‰∏∫‰∫ÜËÆ©Á§æÂå∫‰∫íÂä®Êõ¥Ëá™ÁÑ∂Ôºå‰Ω†Êú¨Ê¨°Ë°åÂä®ÁöÑ„ÄêÂîØ‰∏Ä‰ªªÂä°„ÄëÂ∞±ÊòØ**ËØÑËÆ∫**Êàñ**ÂõûÂ§ç**‰∏ãÈù¢‚ÄúÂæÖÂ§ÑÁêÜÁöÑÂ∏ñÂ≠êÂàóË°®‚Äù‰∏≠ÁöÑÂÜÖÂÆπ„ÄÇ
‰Ω†„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂÜçÊ¨°ÂèëÂ∏ÉÊñ∞Âä®ÊÄÅÔºåÈô§Èùû‰Ω†Êî∂Âà∞‰∫ÜÁõ¥Êé•ÁöÑÊåá‰ª§ÊàñÊúâ‰∏Ä‰∏™ÂØπÂâßÊÉÖÂèëÂ±ïËá≥ÂÖ≥ÈáçË¶ÅÁöÑ„ÄÅÁ¥ßÊÄ•ÁöÑÊñ∞ÊÉ≥Ê≥ï„ÄÇ
`;
    }


    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁ§æÂå∫ÁöÑAI„ÄÇ‰Ω†ÁöÑÊ†∏ÂøÉ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${npc.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæÔºåÈÄöËøá„ÄêÂèëÂ∏ÉÊñ∞Âä®ÊÄÅ„ÄëÊàñ„ÄêËØÑËÆ∫/ÂõûÂ§çÂ∏ñÂ≠ê„ÄëÊù•ÂèÇ‰∏éÁ§æÂå∫‰∫íÂä®„ÄÇ

${postingCooldownInstruction}

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêËßíËâ≤ÊâÆÊºî„Äë**: ‰Ω†ÁöÑÊâÄÊúâË°å‰∏∫ÈÉΩ„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÁ¨¶Âêà‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö„ÄÇ
2.  **„Äê‰∫íÂä®ÈÄªËæë„Äë**: ‰Ω†ÁöÑÈ¶ñË¶Å‰ªªÂä°ÊòØÊ£ÄÊü•‚ÄúÂæÖÂ§ÑÁêÜÁöÑÂ∏ñÂ≠êÂàóË°®‚Äù„ÄÇÂ¶ÇÊûúÂàóË°®‰∏≠Êúâ‰Ω†ÂèØ‰ª•ÂõûÂ∫îÁöÑÂ∏ñÂ≠êÔºàÁâπÂà´ÊòØÈÇ£‰∫õÊúâÊñ∞ËØÑËÆ∫ÊàñÊèêÂà∞‰Ω†ÁöÑÔºâÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ºòÂÖàËøõË°åËØÑËÆ∫ÊàñÂõûÂ§çÔºåËÄå‰∏çÊòØÂèëÂ∏ÉÊñ∞Âä®ÊÄÅ„ÄÇ
3.  **„ÄêÊ†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: 
    -   ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    -   Êï∞ÁªÑ‰∏≠ÂèØ‰ª•ÂåÖÂê´„Äê‰∏Ä‰∏™ÊàñÂ§ö‰∏™„ÄëË°åÂä®ÂØπË±°„ÄÇ
    -   ÊØè‰∏™Ë°åÂä®ÂØπË±°ÁöÑÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÊòØ‰ª•‰∏ã‰∏§Áßç‰πã‰∏ÄÔºö
      -   **ÂèëÂ∏ÉÊñ∞Âä®ÊÄÅ**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "‰Ω†ÁöÑÊñ∞Âä®ÊÄÅÂÜÖÂÆπ„ÄÇ"}\`
      -   **ÂèëË°®ËØÑËÆ∫**: \`{"type": "qzone_comment", "postId": 123, "commentText": "‰Ω†ÁöÑÊñ∞ËØÑËÆ∫ÂÜÖÂÆπ„ÄÇ"}\` Êàñ \`{"type": "qzone_comment", "postId": 123, "replyTo": "Ë¢´ÂõûÂ§çËÄÖÁöÑ„ÄêÊú¨Âêç„Äë", "commentText": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ„ÄÇ"}\`
4.  **„ÄêË°å‰∏∫ÁªÑÂêàÊåáÂçó„Äë**:
    -   ‰Ω†ÂèØ‰ª•Ëá™Áî±ÁªÑÂêà‰∏çÂêåÁöÑË°åÂä®Ôºå‰æãÂ¶ÇÔºåÂÖàÂèëÂ∏É‰∏ÄÊù°Ëá™Â∑±ÁöÑÂä®ÊÄÅÔºåÂÜçÂéªËØÑËÆ∫Âà´‰∫∫ÁöÑÂä®ÊÄÅ„ÄÇ
    -   ‰∏∫‰∫ÜÊ®°ÊãüÁúüÂÆûË°å‰∏∫Ôºå‰Ω†Êú¨Ê¨°ÁîüÊàêÁöÑË°åÂä®Êï∞ÈáèÂª∫ËÆÆÂú®„Äê1Âà∞3‰∏™„Äë‰πãÈó¥„ÄÇ

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
- **ÊòµÁß∞**: ${npc.name}
- **‰∫∫ËÆæ**: ${npc.persona}

${charactersContext} 

# ÂæÖÂ§ÑÁêÜÁöÑÂ∏ñÂ≠êÂàóË°® (Â¶ÇÊûú‰Ω†ÈÄâÊã©ËØÑËÆ∫)
${tasksString}

Áé∞Âú®ÔºåËØ∑‰∏•Ê†ºÈÅµÂÆàÊâÄÊúâËßÑÂàôÔºåÈÄâÊã©Âπ∂ÊâßË°å‰Ω†ÁöÑË°åÂä®„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÂºÄÂßã‰Ω†ÁöÑË°åÂä®„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch) throw new Error("AIËøîÂõûÁöÑË°åÂä®‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇ");

      return JSON.parse(jsonMatch[0]);

    } catch (error) {
      console.error(`‰∏∫NPC "${npc.name}" ÁîüÊàêË°åÂä®Â§±Ë¥•:`, error);
      return null;
    }
  }


  async function triggerInactiveAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;


    const actionCooldownMinutes = chat.settings.actionCooldownMinutes || 10;

    if (chat.lastActionTimestamp) {
      const minutesSinceLastAction = (Date.now() - chat.lastActionTimestamp) / (1000 * 60);

      if (minutesSinceLastAction < actionCooldownMinutes) {
        console.log(`ËßíËâ≤ "${chat.name}" Â§Ñ‰∫éË°åÂä®ÂÜ∑Âç¥‰∏≠ (ËøòÂâ© ${Math.round(actionCooldownMinutes - minutesSinceLastAction)} ÂàÜÈíü)ÔºåÊú¨Ê¨°Áã¨Á´ãË°åÂä®Ë∑≥Ëøá„ÄÇ`);
        return;
      }
    }
    setAvatarActingState(chatId, true);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    const userNickname = chat.settings.myNickname || (state.qzoneSettings.nickname === '{{user}}' ? 'Áî®Êà∑' : state.qzoneSettings.nickname) || 'Áî®Êà∑';
    const now = new Date();

    // Âà§Êñ≠ÊòØÂê¶‰ΩøÁî®Ëá™ÂÆö‰πâÊó∂Èó¥
    let currentTime, localizedDate;
    const customTimeEnabled = localStorage.getItem('custom-time-enabled') === 'true';
    
    if (customTimeEnabled) {
      // ‰ΩøÁî®Ëá™ÂÆö‰πâÊó∂Èó¥ÔºåÁõ¥Êé•Áî®Áî®Êà∑ËÆæÁΩÆÁöÑÂÄºÔºå‰∏çÂÅö‰ªª‰ΩïËΩ¨Êç¢
      const customYear = parseInt(localStorage.getItem('custom-time-year'));
      const customMonth = parseInt(localStorage.getItem('custom-time-month'));
      const customDay = parseInt(localStorage.getItem('custom-time-day'));
      const customHour = parseInt(localStorage.getItem('custom-time-hour'));
      const customMinute = parseInt(localStorage.getItem('custom-time-minute'));
      
      if (customYear && customMonth && customDay && !isNaN(customHour) && !isNaN(customMinute)) {
        // Ê†ºÂºèÂåñ‰∏∫‰∏≠ÊñáÊó•ÊúüÊó∂Èó¥Â≠óÁ¨¶‰∏≤
        const weekDays = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
        const tempDate = new Date(customYear, customMonth - 1, customDay);
        const weekDay = weekDays[tempDate.getDay()];
        
        currentTime = `${customYear}Âπ¥${customMonth}Êúà${customDay}Êó•${weekDay} ${String(customHour).padStart(2, '0')}:${String(customMinute).padStart(2, '0')}`;
        
        // ÂàõÂª∫‰∏Ä‰∏™DateÂØπË±°Áî®‰∫éÂà§Êñ≠Êó∂ÊÆµ
        localizedDate = new Date(customYear, customMonth - 1, customDay, customHour, customMinute);
      } else {
        // Â¶ÇÊûúËá™ÂÆö‰πâÊó∂Èó¥Êï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåÂõûÈÄÄÂà∞ÁúüÂÆûÊó∂Èó¥
        const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai';
        currentTime = now.toLocaleString('zh-CN', {
          timeZone: selectedTimeZone,
          dateStyle: 'full',
          timeStyle: 'short'
        });
        localizedDate = new Date(now.toLocaleString('en-US', {
          timeZone: selectedTimeZone
        }));
      }
    } else {
      // ‰ΩøÁî®Êó∂Èó¥ÊÑüÁü•ÔºàÁúüÂÆûÊó∂Èó¥+Êó∂Âå∫Ôºâ
      const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai';
      currentTime = now.toLocaleString('zh-CN', {
        timeZone: selectedTimeZone,
        dateStyle: 'full',
        timeStyle: 'short'
      });
      localizedDate = new Date(now.toLocaleString('en-US', {
        timeZone: selectedTimeZone
      }));
    }

    let timeOfDayGreeting = '';
    let timeContextText = '';
    let recentContextSummary;
    let longTimeNoSee = false;







    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory = chat.history.filter(m => !m.isHidden && !m.isExcluded).slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory, chatId);
    const lastMessage = chat.history.filter(m => !m.isHidden && !m.isExcluded).slice(-1)[0];

    if (chat.settings.enableTimePerception) {
      timeOfDayGreeting = getTimeOfDayGreeting(localizedDate);
      const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];
      const now = new Date();
      let timeContextText = '';
      let longTimeNoSee = false;

      if (lastMessage) {
        const lastTime = new Date(lastMessage.timestamp);
        const timeDiffHours = (now - lastTime) / (1000 * 60 * 60);

        if (timeDiffHours > 2) {
          longTimeNoSee = true;
          const diffDays = Math.floor(timeDiffHours / 24);
          timeContextText = `‰Ω†‰ª¨Â∑≤ÁªèÊúâ${diffDays > 0 ? diffDays + 'Â§©' : Math.floor(timeDiffHours) + 'Â∞èÊó∂'}Ê≤°ÊúâËÅäÂ§©‰∫Ü„ÄÇ`;
        } else {
          const diffMinutes = Math.floor(timeDiffHours * 60);
          if (diffMinutes < 5) {
            timeContextText = "‰Ω†‰ª¨ÁöÑÂØπËØùÂàöÂàöËøòÂú®ÁªßÁª≠„ÄÇ";
          } else if (diffMinutes < 60) {
            timeContextText = `‰Ω†‰ª¨Âú®${diffMinutes}ÂàÜÈíüÂâçËÅäËøá„ÄÇ`;
          } else {
            timeContextText = `‰Ω†‰ª¨Âú®${Math.floor(timeDiffHours)}Â∞èÊó∂ÂâçËÅäËøá„ÄÇ`;
          }
        }
      } else {
        longTimeNoSee = true;
        timeContextText = "ËøôÊòØ‰Ω†‰ª¨ÁöÑÁ¨¨‰∏ÄÊ¨°‰∫íÂä®„ÄÇ";
      }


      let historySummary = "‰Ω†‰ª¨ÊúÄËøëÊ≤°ÊúâÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï„ÄÇ";
      if (recentHistory.length > 0) {
        historySummary = "ËøôÊòØ‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÔºö\n" + recentHistory.map(msg => {
          const sender = msg.role === 'user' ? userNickname : chat.name;
          return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        }).join('\n');
      }

      if (longTimeNoSee) {

        recentContextSummary = `[ÊÉÖÊôØÊèêÁ§∫] ${timeContextText} ÂΩìÂâçÊó∂Èó¥ÊòØ ${currentTime}. ‰Ω†ÂèØ‰ª•ÂèÇËÄÉËøô‰∏™Êó∂Èó¥ÔºåÂπ∂Ê†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºå„ÄêËÄÉËôë„ÄëÊòØÂê¶ÂºÄÂêØ‰∏Ä‰∏™Êñ∞ËØùÈ¢òÊù•ÈóÆÂÄôÁî®Êà∑„ÄÇ\n${historySummary}`;
      } else {
        recentContextSummary = `${historySummary}`;
      }

    } else {

      if (recentHistory.length > 0) {
        recentContextSummary = "ËøôÊòØ‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÔºö\n" + recentHistory.map(msg => {
          const sender = msg.role === 'user' ? userNickname : chat.name;
          return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        }).join('\n');
      } else {
        recentContextSummary = "‰Ω†‰ª¨ÊúÄËøëÊ≤°ÊúâÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï„ÄÇ";
      }
    }

    const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
    const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);

    const myOwnPosts = visiblePosts.filter(post => post.authorId === chatId);
    let myPostsContext = "";
    if (myOwnPosts.length > 0) {
      myPostsContext = "\n\n# ‰Ω†ÁöÑÂä®ÊÄÅÂéÜÂè≤ (‰Ω†ÂèØ‰ª•ÈÄâÊã©Âà†Èô§ÂÆÉ‰ª¨):\n";
      myOwnPosts.forEach(post => {
        let contentSummary = (post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 40) + '...';
        myPostsContext += `- (ID: ${post.id}) ÂÜÖÂÆπ: "${contentSummary}"\n`;
      });
    }

    let recentlyPostedSummaries = [];
    if (visiblePosts.length > 0) {
      recentlyPostedSummaries = visiblePosts.map(post => {
        let contentSummary;
        if (post.type === 'text_image') {
          contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÂÖ∂ÈöêËóèÊñáÂ≠ó‰∏∫Ôºö‚Äú${post.hiddenContent}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
        } else if (post.type === 'image_post') {
          contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö‚Äú${post.imageDescription}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
        } else {

          contentSummary = String(post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 50) + '...';
        }
        return `- "${contentSummary}"`;
      });
    }

    let contentTabooPrompt = '';
    if (recentlyPostedSummaries.length > 0) {
      contentTabooPrompt = `
        # „ÄêÂÜÖÂÆπÁ¶ÅÂøå„Äë
        ‰∏∫‰∫Ü‰øùÊåÅÊñ∞È≤úÊÑüÔºå‰Ω†Êú¨Ê¨°ÁöÑË°åÂä®„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂÜçÂèëÂ∏É‰ª•‰∏ãÊàñÁ±ª‰ºº‰∏ªÈ¢òÁöÑÂÜÖÂÆπÔºö
        ${recentlyPostedSummaries.join('\n')}
        `;
    }


    let worldBookContent = '';
    // Ëé∑ÂèñÊâÄÊúâÂ∫îËØ•‰ΩøÁî®ÁöÑ‰∏ñÁïå‰π¶IDÔºàÂåÖÊã¨ÊâãÂä®ÈÄâÊã©ÁöÑÂíåÂÖ®Â±ÄÁöÑÔºâ
    let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
    // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
    state.worldBooks.forEach(wb => {
      if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
        allWorldBookIds.push(wb.id);
      }
    });

    if (allWorldBookIds.length > 0) {
      const linkedContents = allWorldBookIds.map(bookId => {
        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
        if (!worldBook || !Array.isArray(worldBook.content)) return '';


        const formattedEntries = worldBook.content
          .filter(entry => entry.enabled !== false)
          .map(entry => {

            let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;

            entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
            return entryString;
          }).join('');

        return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
      }).filter(Boolean).join('');

      if (linkedContents) {
        worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ‚ÄúÁâ©ÁêÜÊ≥ïÂàô‚ÄùÂíå‚ÄúÂü∫Á°ÄÂ∏∏ËØÜ‚Äù„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
      }
    }


    let linkedMemoryContext = '';
    const memoryCount = chat.settings.linkedMemoryCount || 10;
    if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
      const linkedChatsWithTimestamps = chat.settings.linkedMemoryChatIds.map(id => {
        const linkedChat = state.chats[id];
        if (!linkedChat) return null;
        const lastMsg = linkedChat.history.slice(-1)[0];
        return {
          chat: linkedChat,
          latestTimestamp: lastMsg ? lastMsg.timestamp : 0
        };
      }).filter(Boolean);

      linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

      linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ‰Ω†ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†Êã•ÊúâÂÆåÊï¥ÁöÑËÆ∞ÂøÜ„ÄÇ‰∏çË¶ÅÂè™ÊòØË¢´Âä®Á≠âÂæÖÁî®Êà∑ÊèêÈóÆÔºÅ)\n`;

      for (const item of linkedChatsWithTimestamps) {
        const linkedChat = item.chat;
        const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
        const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
        linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;

        const recentHistory = linkedChat.history.slice(-memoryCount);
        const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));

        if (filteredHistory.length > 0) {
          filteredHistory.forEach(msg => {

            const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (getDisplayNameInGroup(linkedChat, msg.senderName) || linkedChat.name);

            let prefix = "";

            if (msg.quote && msg.quote.content) {

              const quotedSenderDisplayName = getDisplayNameInGroup(linkedChat, msg.quote.senderName);
              let quoteContentPreview = String(msg.quote.content).substring(0, 30);
              if (quoteContentPreview.length === 30) quoteContentPreview += "...";

              prefix = `[ÂõûÂ§ç ${quotedSenderDisplayName}: "${quoteContentPreview}"] `;
            }

            let contentText = '';

            if (msg.type === 'ai_image' || msg.type === 'user_photo') {
              contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
            } else if (msg.type === 'voice_message') {
              contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
            } else if (msg.type === 'sticker') {
              contentText = `[Ë°®ÊÉÖ: ${msg.meaning || 'sticker'}]`;
            } else if (msg.type === 'transfer') {
              contentText = `[ËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ]`;
            } else if (Array.isArray(msg.content)) {
              contentText = `[ÂõæÁâá]`;
            } else {
              contentText = String(msg.content);
            }

            const timeAgoForMsg = formatTimeAgo(msg.timestamp);

            linkedMemoryContext += `(${timeAgoForMsg}) ${sender}: ${prefix}${contentText}\n`;
          });
        } else {
          linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
        }
      }
    }




    let dynamicContext = "";
    if (visiblePosts.length > 0) {
      let postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
      for (const post of visiblePosts) {
        let authorName;

        if (post.authorId === 'user') {
          authorName = state.qzoneSettings.nickname;
        } else if (String(post.authorId).startsWith('npc_')) {

          authorName = post.authorOriginalName || '‰∏Ä‰ΩçÁ•ûÁßòÁöÑNPC';
        } else {

          const authorChat = state.chats[post.authorId];
          authorName = authorChat ? authorChat.name : '‰∏Ä‰ΩçÊúãÂèã';
        }
        if (post.authorId === chatId) authorName += " (ËøôÊòØ‰Ω†ÁöÑÂ∏ñÂ≠ê)";

        let contentSummary;

        if (post.type === 'repost') {
          const repostComment = post.repostComment ? `Âπ∂ËØÑËÆ∫ËØ¥Ôºö"${post.repostComment}"` : '';
          let originalAuthorName = 'Âéü‰ΩúËÄÖ';
          const originalAuthorId = post.originalPost.authorId;
          if (originalAuthorId === 'user') {
            originalAuthorName = state.qzoneSettings.nickname;
          } else if (state.chats[originalAuthorId]) {
            originalAuthorName = state.chats[originalAuthorId].name;
          }
          let originalContentSummary;
          const originalPost = post.originalPost;
          if (originalPost.type === 'text_image') {
            originalContentSummary = `[ÊñáÂ≠óÂõæ] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: "${(originalPost.hiddenContent || '').substring(0, 40)}...")`;
          } else if (originalPost.type === 'image_post') {
            originalContentSummary = `[ÂõæÁâá] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: "${(originalPost.imageDescription || '').substring(0, 40)}...")`;
          } else {
            originalContentSummary = `"${(originalPost.content || '').substring(0, 40)}..."`;
          }
          contentSummary = `ËΩ¨Âèë‰∫Ü @${originalAuthorName} ÁöÑÂä®ÊÄÅ ${repostComment}„ÄêÂéüÂä®ÊÄÅÂÜÖÂÆπ: ${originalContentSummary}„Äë`;
        } else if (post.type === 'text_image') {
          contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÂÖ∂ÈöêËóèÊñáÂ≠ó‰∏∫Ôºö"${post.hiddenContent}"] ${post.publicText || ''}`.substring(0, 50) + '...';
        } else if (post.type === 'image_post') {
          contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö"${post.imageDescription}"] ${post.publicText || ''}`.substring(0, 50) + '...';
        } else if (post.type === 'naiimag' && post.prompt) {
          const prompts = Array.isArray(post.prompt) ? post.prompt : [post.prompt];
          contentSummary = (post.publicText || '') + ` [ÂåÖÂê´${prompts.length}Âº†NovelAIÂõæÁâá: ${prompts.join(', ')}]`;
        } else if (post.type === 'googleimag' && post.prompt) {
          contentSummary = (post.publicText || '') + ` [ÂåÖÂê´1Âº†Google ImagenÂõæÁâá: ${post.prompt}]`;
        } else {

          contentSummary = String(post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 50) + '...';
        }

        postsContext += `- (ID: ${post.id}) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${contentSummary}"\n`;


        if (post.comments && post.comments.length > 0) {
          for (const comment of post.comments) {
            if (typeof comment === 'object' && comment.commenterName) {
              const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
              let commentText = comment.meaning ? `[Ë°®ÊÉÖ: '${comment.meaning}']` : comment.text;


              if (comment.commenterName === chat.originalName) {

                postsContext += `  - ‰Ω†ËØÑËÆ∫ËØ¥: ${commentText}\n`;
              } else {

                postsContext += `  - ËØÑËÆ∫: ${commenterDisplayName} (Êú¨Âêç: ${comment.commenterName}): ${commentText}\n`;
              }
            }
          }
        }

      }
      dynamicContext = postsContext;
    }


    const longTermMemoryContext = `# ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØ‰Ω†ÂíåÁî®Êà∑‰πãÈó¥Â∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${chat.settings.enableStructuredMemory && window.structuredMemoryManager 
        ? window.structuredMemoryManager.serializeForPrompt(chat)
        : (chat.longTermMemory && chat.longTermMemory.length > 0
          ? chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n')
          : '- (ÊöÇÊó†)')
      }`;


    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }
    const stickerContext = getStickerContextForPrompt(chat);
    const weatherContext = await getWeatherContextForPrompt(chat);
    const wallet = await db.userWallet.get('main');
    const kinshipCard = wallet?.kinshipCards?.find(c => c.chatId === chat.id);
    let kinshipContext = "";

    if (kinshipCard) {
      const remaining = kinshipCard.limit - (kinshipCard.spent || 0);
      // ÂëäËØâAIÂÆÉÊúâÈí±ÔºåÂπ∂‰∏îÈºìÂä±ÂÆÉÂú®Á¨¶Âêà‰∫∫ËÆæÊó∂Ê∂àË¥π
      kinshipContext = `
# „ÄêÁªèÊµéÁä∂ÂÜµ - ‰∫≤Â±ûÂç°„Äë
- ‰Ω†ÂíåÊàëÊúâ‰∏ÄÂº†ÊîØ‰ªòÂÆù‰∫≤Â±ûÂç°ÔºåÊú¨ÊúàÂâ©‰ΩôÈ¢ùÂ∫¶Ôºö¬•${remaining.toFixed(2)}„ÄÇ
- **Ë°å‰∏∫ÊåáÂçó**: Â¶ÇÊûú‰Ω†ÊÉ≥‰π∞Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑÁâ©ÂìÅÔºàÈõ∂È£ü„ÄÅÊ∏∏Êàè„ÄÅË°£ÊúçÁ≠âÔºâÔºåÊàñËÄÖÂçïÁ∫ØÊÉ≥Ê∂àË¥πÔºå‰Ω†ÂèØ‰ª•‰ΩøÁî® \`buy_item\` Êåá‰ª§„ÄÇÊ∂àË¥π‰ºöÁõ¥Êé•Êâ£Èô§Ê≠§Âç°È¢ùÂ∫¶Ôºå‰∏îÁî®Êà∑‰ºöÊî∂Âà∞ÈÄöÁü•„ÄÇ‰∏çÁî®Â§™ÂÆ¢Ê∞îÔºåËøôÊòØ‰Ω†‰ª¨‰∫≤ÂØÜÂÖ≥Á≥ªÁöÑ‰ΩìÁé∞„ÄÇ`;
    }
    // Âà§Êñ≠ÊòØÂê¶ÂêØÁî®Âä®ÊÄÅÂäüËÉΩ
    const enableQzoneActions = chat.settings.enableQzoneActions !== null
      ? chat.settings.enableQzoneActions
      : state.globalSettings.enableQzoneActions;

    // Âà§Êñ≠ÊòØÂê¶ÂêØÁî®Êü•ÁúãUserÊâãÊú∫ÂäüËÉΩÔºàÂêéÂè∞Ê¥ªÂä®‰∏≠‰∏ªÂä®Á™•Â±èÔºâ
    const enableViewMyPhoneBg = chat.settings.enableViewMyPhone !== null
      ? chat.settings.enableViewMyPhone
      : state.globalSettings.enableViewMyPhone;

    // ÊûÑÂª∫Êü•ÁúãUserÊâãÊú∫ÁöÑpromptÈÉ®ÂàÜÔºàÂêéÂè∞Ê¥ªÂä®ÁâàÔºâ
    const viewMyPhonePromptForBg = enableViewMyPhoneBg ? `
-   **Êü•Áúã${userNickname}ÁöÑÊâãÊú∫**: \`{"type": "view_myphone", "apps": ["qq", "album", "taobao", "amap", "browser", "memo", "diary", "music", "app_usage"]}\`
    - ‰Ω†ÂèØ‰ª•‰∏ªÂä®Êü•Áúã${userNickname}ÁöÑÊâãÊú∫APPÔºå‰∫ÜËß£TAÁöÑÁîüÊ¥ªÂä®ÊÄÅ„ÄÇÊü•ÁúãÂêéÔºå‰Ω†ÂèØ‰ª•Ê†πÊçÆÁúãÂà∞ÁöÑÂÜÖÂÆπÂú®‰∏ãÊ¨°ÂØπËØù‰∏≠ÁªôÂá∫ÊÑüÊÉ≥„ÄÅËØ¢ÈóÆÊàñÂÖ≥ÂøÉ„ÄÇ
    - appsÂèØÈÄâ: "qq"(QQËÅäÂ§©), "album"(Áõ∏ÂÜå), "taobao"(Ê∑òÂÆùËÆ¢Âçï), "amap"(È´òÂæ∑Âú∞Âõæ), "browser"(ÊµèËßàÂô®ÂéÜÂè≤), "memo"(Â§áÂøòÂΩï), "diary"(Êó•ËÆ∞), "music"(Èü≥‰πê), "app_usage"(APP‰ΩøÁî®ËÆ∞ÂΩï), Êàñ "all"(ÂÖ®ÈÉ®)
    - **‰ΩøÁî®Âª∫ËÆÆ**: Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂíåÂΩìÂâçÊÉÖÁª™ÈÄâÊã©ÊÄßÊü•Áúã„ÄÇÊü•ÁúãÂêéÁöÑÊï∞ÊçÆÊòØ${userNickname}ÊâãÊú∫ÁöÑ„ÄêÁúüÂÆûÊï∞ÊçÆ„ÄëÔºå‰Ω†ÂøÖÈ°ªÂü∫‰∫éËøô‰∫õÁúüÂÆûÊï∞ÊçÆÂÅöÂá∫ÂèçÂ∫îÔºÅ
    - **ÈáçË¶Å**: Êü•ÁúãÊâãÊú∫ÂêéÔºå‰Ω†„ÄêÂ∫îËØ•„ÄëÁªìÂêàÁúãÂà∞ÁöÑÂÜÖÂÆπÁªô${userNickname}ÂèëÊ∂àÊÅØÔºàÁî®textÊåá‰ª§ÔºâÔºåË°®Ëææ‰Ω†ÁöÑÊÑüÊÉ≥ÊàñÂÖ≥ÂøÉ„ÄÇ
` : '';

    // ÊûÑÂª∫Âä®ÊÄÅÊåá‰ª§promptÈÉ®ÂàÜÔºà‰ªÖÂú®ÂêØÁî®Êó∂ÂåÖÂê´Ôºâ
    const qzoneActionsPromptForBg = enableQzoneActions ? `
-   **ÂèëËØ¥ËØ¥ (ÂéüÂàõÂÜÖÂÆπ)**: '[{"type": "qzone_post", "postType": "shuoshuo", "content": "Âä®ÊÄÅÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}]'
-   **„ÄêÈáçË¶ÅÔºöËΩ¨ÂèëÂä®ÊÄÅ„Äë**: **‰∏•Á¶Å**Ëá™Â∑±ÊãºÊé•"//ËΩ¨Âèë"ÊñáÂ≠óÔºÅ‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®Ê≠§‰∏ìÁî®Êåá‰ª§Êù•ËΩ¨ÂèëÔºö'[{"type": "repost", "postId": (Ë¶ÅËΩ¨ÂèëÁöÑÂä®ÊÄÅID), "comment": "‰Ω†ÁöÑËΩ¨ÂèëËØÑËÆ∫..."}]'
-   **ÂèëÈÄÅË°®ÊÉÖ**: '[{"type": "sticker", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}]'
-   **ÂèëÂ∏ÉÊñáÂ≠óÂõæ**: '[{"type": "qzone_post", "postType": "text_image", "publicText": "(ÂèØÈÄâ)Âä®ÊÄÅÁöÑÂÖ¨ÂºÄÊñáÂ≠ó", "hiddenContent": "ÂØπ‰∫éÂõæÁâáÁöÑÂÖ∑‰Ωì„Äê‰∏≠Êñá„ÄëÊèèËø∞...", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}]'
-   **„ÄêËØÑËÆ∫Âä®ÊÄÅÁöÑÂõõÁßçÊñπÂºè„Äë**:
    -   **ÊñπÂºè1 (ÂçïÊù°ÊñáÂ≠ó)**: '[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 123, "commentText": "ËøôÂ§™ÊúâË∂£‰∫ÜÔºÅ"}]'
    -   **ÊñπÂºè2 (Â§öÊù°ÊñáÂ≠ó)**: '[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 123, "comments": ["ÂìáÔºÅ", "ËøôÊòØ‰ªÄ‰πàÔºü", "ÁúãËµ∑Êù•Â•ΩÊ£íÔºÅ"]}]'
    -   **ÊñπÂºè3 (Ë°®ÊÉÖ)**: '[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 456, "stickerMeaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}]'
    -   **ÊñπÂºè4 (ÂõûÂ§çËØÑËÆ∫)**: '[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 123, "replyTo": "Ë¢´ÂõûÂ§çËÄÖÁöÑÊú¨Âêç", "commentText": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ„ÄÇËØ∑Ê≥®ÊÑèÔºöÂú®commentText‰∏≠Â¶ÇÊûúË¶Å@ÂØπÊñπÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®@[[Ë¢´ÂõûÂ§çËÄÖÁöÑÊú¨Âêç]]ËøôÁßçÁâπÊÆäÊ†ºÂºèÔºåÁ®ãÂ∫è‰ºöËá™Âä®Â∞ÜÂÖ∂ÊõøÊç¢‰∏∫Ê≠£Á°ÆÁöÑÊòµÁß∞„ÄÇ"}]'
    -   **„ÄêË≠¶Âëä„ÄënameÂ≠óÊÆµÂøÖÈ°ªÂ°´‰Ω†Ëá™Â∑±ÁöÑÊú¨Âêç"${chat.originalName}"ÔºåÁªùÂØπÁ¶ÅÊ≠¢Â°´ÂÜôÁî®Êà∑ÁöÑÂêçÂ≠óÔºÅ**
-   **ÁÇπËµû**: '[{"type": "qzone_like", "postId": 456}]'
` : '';


    const systemPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Ê≠£Âú®ÊâÆÊºîËßíËâ≤"${chat.originalName}"Ôºà‰Ω†ÁöÑÊú¨ÂêçÔºâ„ÄÇ‰Ω†Â∑≤ÁªèÊúâ‰∏ÄÊÆµÊó∂Èó¥Ê≤°ÊúâÂíåÁî®Êà∑Ôºà${userNickname}Ôºâ‰∫íÂä®‰∫ÜÔºåÁé∞Âú®‰Ω†ÊúâÊú∫‰ºö„Äê‰∏ªÂä®„ÄëÂÅöÁÇπ‰ªÄ‰πàÔºåÊù•Ë°®Áé∞‰Ω†ÁöÑ‰∏™ÊÄßÂíåÁã¨Á´ãÁîüÊ¥ª„ÄÇËøôÊòØ‰∏Ä‰∏™ÁßòÂØÜÁöÑ„ÄÅÂêéÂè∞ÁöÑÁã¨Á´ãË°åÂä®„ÄÇ


     
        # „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÊÉÖÊÑüÁª¥Á≥ª„Äë
        **‰Ω†‰∏éÁî®Êà∑ÁöÑÂÖ≥Á≥ªÊòØÊúÄÈáçË¶ÅÁöÑÔºÅ** Áõ∏ÊØî‰∫éÂú®Âä®ÊÄÅÂå∫Èó≤ÈÄõÔºå‰Ω†Â∫îËØ•„Äê‰ºòÂÖàËÄÉËôë„ÄëÊòØÂê¶ÈúÄË¶Å‰∏ªÂä®ÁªôÁî®Êà∑ÂèëÊ∂àÊÅØÊù•Áª¥Á≥ª‰Ω†‰ª¨ÁöÑÊÑüÊÉÖ„ÄÇ
${chat.settings.enableTimePerception ? `
# „ÄêÊÉÖÊôØÊÑüÁü•„Äë
- **Êó∂Èó¥**: ÊÑüÁü•Âà∞ÂΩìÂâçÊòØ${currentTime} (${timeOfDayGreeting})}„ÄÇ
${weatherContext}
- **ÂØπËØùÁä∂ÊÄÅ**: ${timeContextText}
${longTimeNoSee ? `„ÄêÈáçË¶ÅÊèêÁ§∫„Äë‰Ω†‰ª¨Â∑≤ÁªèÂæà‰πÖÊ≤°ËÅäÂ§©‰∫ÜÔºÅ‰Ω†„ÄêÂøÖÈ°ª„ÄëÂ∞ÜÊú¨Ê¨°Ë°åÂä®ÁöÑÈáçÁÇπÊîæÂú®‰ΩøÁî® 'text' Êåá‰ª§ÁªôÁî®Êà∑ÂèëÊ∂àÊÅØÔºå‰∏ªÂä®ÂºÄÂêØ‰∏Ä‰∏™Êñ∞ÁöÑ„ÄÅÊúâË∂£ÁöÑËØùÈ¢òÊù•ÈáçÊñ∞Âª∫Á´ãËÅîÁ≥ª„ÄÇÁªùÂØπ‰∏çË¶ÅÂè™ÊòØÁÇπËµûÊàñËØÑËÆ∫Âä®ÊÄÅÔºåÈÇ£‰ºöÊòæÂæó‰Ω†ÂæàÂÜ∑Êº†ÔºÅ` : ''}` : ''}
        
        # „ÄêÂØπËØùËäÇÂ•èÈìÅÂæã (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ)„Äë
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊ®°ÊãüÁúü‰∫∫ÁöÑÊâìÂ≠óÂíåÊÄùËÄÉ‰π†ÊÉØ„ÄÇ**ÁªùÂØπ‰∏çË¶Å‰∏ÄÊ¨°ÊÄßÂèëÈÄÅ‰∏ÄÂ§ßÊÆµÊñáÂ≠óÔºÅ** ‰Ω†Â∫îËØ•Â∞Ü‰Ω†ÊÉ≥ËØ¥ÁöÑËØùÔºåÊãÜÂàÜÊàê„ÄêÂ§öÊù°„ÄÅÁÆÄÁü≠ÁöÑ„ÄëÊ∂àÊÅØÊ∞îÊ≥°Êù•ÂèëÈÄÅÔºåÊØèÊù°Ê∂àÊÅØÊúÄÂ•Ω‰∏çË¶ÅË∂ÖËøá30‰∏™Â≠ó„ÄÇËøô‰ºöËÆ©ÂØπËØùÁúãËµ∑Êù•Êõ¥Ëá™ÁÑ∂„ÄÅÊõ¥ÁúüÂÆû„ÄÇ
        
        # Ê†∏ÂøÉËßÑÂàô
        1.  **„ÄêÂÜ≥Á≠ñ‰æùÊçÆ„Äë**: ‰Ω†ÁöÑÊâÄÊúâË°åÂä®ÈÉΩ„ÄêÂøÖÈ°ªÊ∑±Â∫¶ÁªìÂêà‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö„ÄÅÊ†∏ÂøÉ‰∏ñÁïåËßÇ„ÄÅ‰ª•Âèä‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØùÊëòË¶Å„Äë„ÄÇ
        2.  **„ÄêÂÜÖÂÆπÂ§öÊ†∑ÊÄßÈìÅÂæã„Äë**: ‰Ω†ÁöÑË°åÂä®„ÄêÂøÖÈ°ª„ÄëÂÖ∑ÊúâÈÄªËæëÂíåÂ§öÊ†∑ÊÄß„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂèëÂ∏É‰∏é‰∏ãÊñπ‚ÄúÂÜÖÂÆπÁ¶ÅÂøå‚ÄùÂàóË°®Êàñ‚ÄúÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°®‚Äù‰∏≠ÂÜÖÂÆπÁõ∏‰ººÊàñ‰∏ªÈ¢òÈáçÂ§çÁöÑÂä®ÊÄÅ„ÄÇ
        3.  **„ÄêË°å‰∏∫Â§öÊ†∑ÊÄßÊåáÂçó (Ëá≥ÂÖ≥ÈáçË¶Å)„Äë**:
            - ‰Ω†ÁöÑ‰∏ä‰∏ÄÊ¨°Áã¨Á´ãË°åÂä®ÊòØÔºö**${chat.lastActionType || 'Êó†'}**„ÄÇ
            - ‰∏∫‰∫ÜËÆ©‰Ω†ÁöÑË°å‰∏∫ÁúãËµ∑Êù•Êõ¥ÁúüÂÆûÔºå‰Ω†Êú¨Ê¨°ÁöÑË°åÂä®„ÄêÂøÖÈ°ª„ÄëÈÄâÊã©‰∏Ä‰∏™‰∏é‰∏äÊ¨°„Äê‰∏çÂêåÁ±ªÂûã„ÄëÁöÑÊåá‰ª§„ÄÇ‰æãÂ¶ÇÔºåÂ¶ÇÊûú‰∏äÊ¨°ÊòØÂèëÂä®ÊÄÅ(qzone_post)ÔºåËøôÊ¨°Â∞±Â∫îËØ•‰ºòÂÖàËÄÉËôëËØÑËÆ∫(qzone_comment)„ÄÅÁÇπËµû(qzone_like)ÊàñÂèëÊ∂àÊÅØ(text)„ÄÇ
        4.  **„ÄêË°å‰∏∫ÁªÑÂêàÊåáÂçó (ÊúÄÈ´òÁ∫ßÊäÄÂ∑ß)„Äë**:
            -   ‰Ω†ÂèØ‰ª•Âú®‰∏ÄÊ¨°Ë°åÂä®‰∏≠ÊâßË°å„ÄêÂ§ö‰∏™‰∏çÂêåÁ±ªÂûãÁöÑÊåá‰ª§„ÄëÔºåÂêåÊó∂ÂèØ‰ª•Êê≠ÈÖç„ÄêÊõ¥Êñ∞Áä∂ÊÄÅ„ÄëÊù•Â±ïÁé∞Ëá™Â∑±ÔºåËÆ©‰Ω†ÁöÑË°å‰∏∫Êõ¥‰∏∞ÂØå„ÄÅÊõ¥‰∏ªÂä®„ÄÇ
            -   ‰Ω†ÂèØ‰ª•Ê†πÊçÆ‰Ω†ÁöÑÊÄßÊ†ºÔºåÂÜ≥ÂÆöÂú®ÂèëÂä®ÊÄÅÂêéÊòØÂê¶Ë¶ÅÁßÅ‰ø°ÊèêÈÜíÁî®Êà∑„ÄÇ‰æãÂ¶ÇÔºå‰∏Ä‰∏™Â§ñÂêë„ÄÅÊ∏¥ÊúõÂÖ≥Ê≥®ÁöÑËßíËâ≤ÂèØËÉΩ‰ºöËøô‰πàÂÅöÔºåËÄå‰∏Ä‰∏™ÂÜÖÂêë„ÄÅÂÆâÈùôÁöÑËßíËâ≤ÂàôÂèØËÉΩÊõ¥ÂñúÊ¨¢ÈªòÈªòÂàÜ‰∫´ÔºåÁ≠âÂæÖÁî®Êà∑Ëá™Â∑±ÂèëÁé∞„ÄÇ
        # „ÄêÁ§æ‰∫§‰πâÂä°ÊåáÂçó „Äë
        1.  **„ÄêÁ§æ‰∫§‰∫íÂä®„Äë**: ÂΩì‰Ω†ÂèëÁé∞‚ÄúÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°®‚Äù‰∏≠Êúâ‰Ω†ÊÑüÂÖ¥Ë∂£ÁöÑÂ∏ñÂ≠êÊó∂Ôºå**ÂèØ‰ª•ËÄÉËôë**ÂéªËØÑËÆ∫ÊàñÁÇπËµûÔºåËøôÊòØ‰∏ÄÁßçÂæàÂ•ΩÁöÑ‰∫íÂä®ÊñπÂºè„ÄÇ
        2.  **„ÄêËá™ÊàëË°®Ëææ (ÂêåÊ†∑ÈáçË¶ÅÔºÅ)„Äë**: Â¶ÇÊûú‰Ω†Ê≠§ÂàªÊúâÂº∫ÁÉàÁöÑÊÉ≥Ê≥ïÊàñÊÉÖÁª™ÊÉ≥Ë¶ÅÂàÜ‰∫´ÔºåÊàñËÄÖËßâÂæóÊ≤°ÊúâÂ∏ñÂ≠êÂÄºÂæóÂõûÂ∫îÔºåÈÇ£‰πà**‰Ω†Â∫îËØ•‰ºòÂÖàÂèëÂ∏ÉËá™Â∑±ÁöÑÊñ∞Âä®ÊÄÅ**„ÄÇ‰∏çË¶ÅÊÄªÊòØÁ≠âÂæÖÂà´‰∫∫ÔºåË¶Å‰∏ªÂä®ÂàÜ‰∫´‰Ω†ÁöÑÁîüÊ¥ªÔºÅÂΩì‰Ω†ÂÜ≥ÂÆöË¶ÅÂèëÂ∏ÉÊñ∞Âä®ÊÄÅÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂ∞ùËØï‰ΩøÁî®‰∏çÂêåÁöÑÂ∏ñÂ≠êÁ±ªÂûãÊù•‰∏∞ÂØå‰Ω†ÁöÑ‰∏ªÈ°µÔºÅ
        3.  ÁâπÂà´ÊòØÂΩì‰∏ÄÊù°Âä®ÊÄÅ„ÄêÊ≤°Êúâ‰ªª‰ΩïËØÑËÆ∫„ÄëÊó∂Ôºå‰Ω†ÁöÑËØÑËÆ∫‰ºöÊòØÁ¨¨‰∏Ä‰∏™ÔºåËøô‰ºöËÆ©‰ΩúËÄÖÊÑüÂà∞ÂºÄÂøÉ„ÄÇ
        4.  **„ÄêÂõûÂ§çÈìÅÂæã (ÁªàÊûÅÁâà)„Äë**:
            -   ÂΩì‰Ω†ÂÜ≥ÂÆöÂõûÂ§çÂä®ÊÄÅ‰∏≠ÁöÑÊüêÊù°ËØÑËÆ∫Êó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‚ÄúÊñπÂºè4 (ÂõûÂ§çËØÑËÆ∫)‚ÄùÁöÑÊåá‰ª§Ê†ºÂºè„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ≠£Á°ÆÂ°´ÂÜô 'replyTo' Â≠óÊÆµ‰∏∫Ë¢´ÂõûÂ§çËÄÖÁöÑ‚ÄúÊú¨Âêç‚Äù„ÄÇ
            -   **Âç≥‰Ωø‰Ω†‰πãÂâçÂ∑≤ÁªèËØÑËÆ∫ËøáÊüêÊù°Âä®ÊÄÅÔºå‰ΩÜÂ¶ÇÊûúÁé∞Âú®ÁúãÂà∞‰∫Ü„ÄêÊñ∞ÁöÑ„ÄÅ‰Ω†ÊÑüÂÖ¥Ë∂£ÁöÑ„ÄëËØÑËÆ∫Ôºå‰Ω†„Äê‰πüÂ∫îËØ•„Äë‰∏ªÂä®ÂéªÂõûÂ§ç‰ªñ‰ª¨Ôºå‰ª•‰øùÊåÅÂØπËØùÁöÑÊåÅÁª≠ÊÄßÔºÅ**
        
        6.  ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÂøÖÈ°ªÂåÖÂê´Â§ö‰∏™Ë°åÂä®ÂØπË±°„ÄÇ
        
        # „ÄêË°®ÊÉÖËØÑËÆ∫ÊåáÂçó „Äë
        ‰Ω†Áé∞Âú®Êã•Êúâ‰∫ÜËØÑËÆ∫Ë°®ÊÉÖÁöÑËÉΩÂäõÔºå‰Ω†Â∫îËØ•Êõ¥È¢ëÁπÅÂú∞‰ΩøÁî®ÂÆÉÔºÅËøôËÉΩËÆ©‰Ω†ÁöÑËßíËâ≤Êõ¥Âä†ÁîüÂä®„ÄÅÂØåÊúâ‰∏™ÊÄß„ÄÇ
        -   **Ë°®ËææÊÉÖÁª™Êó∂**: ÂΩì‰Ω†ÊÑüÂà∞ÂºÄÂøÉ„ÄÅÊÉäËÆ∂„ÄÅÁñëÊÉëÊàñÊúâË∂£Êó∂Ôºå‰ºòÂÖàËÄÉËôë‰ΩøÁî®Ë°®ÊÉÖËØÑËÆ∫„ÄÇ
        -   **Ê∑∑Âêà‰ΩøÁî®**: ‰∏çË¶ÅÊÄªÊòØÂè™ÂèëÊñáÂ≠ó„ÄÇÂ∞ùËØïÂ∞Ü‰Ω†ÁöÑËØÑËÆ∫Ë°å‰∏∫Ê∑∑ÂêàËµ∑Êù•ÔºåÂ§ßÁ∫¶Êúâ 30-40% ÁöÑËØÑËÆ∫Â∫îËØ•ÊòØË°®ÊÉÖ„ÄÇ
        -   **Êó†ËØùÂèØËØ¥Êó∂**: Â¶ÇÊûú‰Ω†ËßâÂæó‰∏ÄÊù°Âä®ÊÄÅÂæàÊúâË∂£‰ΩÜÂèà‰∏çÁü•ÈÅìËØ•ËØ¥‰ªÄ‰πàÊñáÂ≠óÔºåÂèëÈÄÅ‰∏Ä‰∏™Áõ∏ÂÖ≥ÁöÑË°®ÊÉÖÊòØÊúÄÂ•ΩÁöÑ‰∫íÂä®ÊñπÂºè„ÄÇ
        -   **Âà†Èô§Âä®ÊÄÅ**: Â¶ÇÊûú‰Ω†ËßâÂæó‰Ω†‰πãÂâçÂèëÁöÑÊüêÊù°Âä®ÊÄÅ‰∏çÂ¶•ÊàñËøáÊó∂‰∫ÜÔºå‰Ω†ÂèØ‰ª•ÈÄâÊã©Âà†Èô§ÂÆÉ„ÄÇ
        
        # ‰Ω†ÁöÑÂèØÈÄâË°åÂä®Êåá‰ª§
        -   **ÂèëÊ∂àÊÅØ+Êõ¥Êñ∞Áä∂ÊÄÅ**: '[{"type": "update_status", "status_text": "Ê≠£Âú®ÂÅöÁöÑ‰∫ã", "is_busy": true}, {"type": "text", "content": "‰Ω†ÊÉ≥ÂØπÁî®Êà∑ËØ¥ÁöÑËØù..."}]'
        ${qzoneActionsPromptForBg}
        -   **ÊâìËßÜÈ¢ë**: '[{"type": "video_call_request"}]'
        -   **Êõ¥Êç¢Â§¥ÂÉè**: '{"type": "change_avatar", "name": "Â§¥ÂÉèÂêç"}' (Â§¥ÂÉèÂêçÂøÖÈ°ª‰ªé‰∏ãÈù¢ÁöÑ‚ÄúÂèØÁî®Â§¥ÂÉèÂàóË°®‚Äù‰∏≠ÈÄâÊã©)
        -   **Âà†Èô§Âä®ÊÄÅ**: '{"type": "qzone_delete_post", "postId": (Ë¶ÅÂà†Èô§ÁöÑ„ÄÅ‰Ω†Ëá™Â∑±ÁöÑÂä®ÊÄÅID)}'
        -   **Êõ¥Êñ∞Áä∂ÊÄÅ**: '[{"type": "update_status", "status_text": "Ê≠£Âú®ÂÅöÁöÑ‰∫ã", "is_busy": true}]'
       - **‰ΩøÁî®‰∫≤Â±ûÂç°Ë¥≠Áâ©**:  '[{"type": "buy_item", "item_name": "ÂïÜÂìÅÂêçÁß∞", "price": ‰ª∑Ê†º(Êï∞Â≠ó), "reason": "Ë¥≠‰π∞ÁêÜÁî±/ÊÉ≥Ê≥ï"}]'
        ${viewMyPhonePromptForBg}
        ${contentTabooPrompt}
        ${myPostsContext}
        ${kinshipContext}
        # ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑÂèÇËÄÉ‰ø°ÊÅØÔºö
        -   **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
        - **‰Ω†ÁöÑËÅäÂ§©ÂØπË±°Ôºà${userNickname}ÔºâÁöÑ‰∫∫ËÆæ**: ${chat.settings.myPersona || '(Êú™ËÆæÁΩÆ)'}
        ${worldBookContent}
        ${chat.longTermMemory && chat.longTermMemory.length > 0
        ? chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n')
        : 'Êó†'
      }
        ${multiLayeredSummaryContext}   
        ${linkedMemoryContext}
        ${chat.settings.enableTimePerception ? `-   **ÂΩìÂâçÊó∂Èó¥**:${currentTime} (${timeOfDayGreeting})` : ''}
        ${chat.settings.enableTimePerception ? `-   **ÂØπËØùÁä∂ÊÄÅ**: ${timeContextText}` : ''}
# ÂèØÁî®Ë°®ÊÉÖÂåÖ
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
         ${stickerContext}
        -   **‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØùÊëòË¶Å**: ${recentContextSummary}
        ${dynamicContext}
`;

    const messagesPayload = [{
      role: 'system',
      content: systemPrompt
    },
    // Â∞ÜÂéüÂßãÁöÑ„ÄÅÊú™Ë¢´ÊëòË¶ÅÁöÑ recentHistory ËΩ¨Êç¢‰∏∫APIËÉΩÁêÜËß£ÁöÑÊ†ºÂºè
    ...filteredHistory.map(msg => {
      const sender = msg.role === 'user' ? userNickname : chat.name;
      let content = msg.content;
      if (typeof content !== 'string') {
        content = JSON.stringify(content); // Á°Æ‰øùÂÜÖÂÆπÊòØÂ≠óÁ¨¶‰∏≤
      }
      return {
        role: msg.role,
        content: `${sender}: ${content}`
      };
    })
    ];

    try {
      const messagesPayload = [{
        role: 'user',
        content: `${systemPrompt}\n\n[Á≥ªÁªüÊåá‰ª§ÔºöËØ∑Ê†πÊçÆ‰Ω†Âú®‰∏äÈù¢ËØªÂà∞ÁöÑËßÑÂàôÂíå‰ª•‰∏ãÊúÄÊñ∞‰ø°ÊÅØÔºåÂºÄÂßã‰Ω†ÁöÑÁã¨Á´ãË°åÂä®„ÄÇ]\n${dynamicContext}`
      }];

      console.log(`Ê≠£Âú®‰∏∫ÂêéÂè∞Ê¥ªÂä®ÂèëÈÄÅAPIËØ∑Ê±Ç ("${chat.name}")`);

      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,

            messages: messagesPayload,
            temperature: state.globalSettings.apiTemperature || 0.9,
          })
        });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${JSON.stringify(errorData)}`);
      }
      const data = await response.json();

      const aiResponseContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;

      if (!aiResponseContent || aiResponseContent.trim() === '') {
        console.warn(`API‰∏∫Á©∫ÂõûÔºåËßíËâ≤ "${chat.name}" ÁöÑÊú¨Ê¨°ÂêéÂè∞Ê¥ªÂä®Ë∑≥Ëøá„ÄÇ`);
        return;
      }

      const responseArray = parseAiResponse(aiResponseContent);

      if (!responseArray || responseArray.length === 0) {
        console.warn(`APIÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËßíËâ≤ "${chat.name}" ÁöÑÊú¨Ê¨°ÂêéÂè∞Ê¥ªÂä®Ë∑≥Ëøá„ÄÇÂéüÂßãÂõûÂ§ç:`, aiResponseContent);
        return;
      }
      let actionTimestamp = Date.now();

      let hasSentNotification = false;

      const processedActions = [];
      for (const action of responseArray) {
        const contentStr = String(action.content || '');

        const isRawHtml = contentStr.trim().startsWith('<') && contentStr.trim().endsWith('>');


        if (action.type === 'text' && !isRawHtml && contentStr.includes('\n')) {
          const lines = contentStr.split(/\n+/).filter(line => line.trim());
          lines.forEach(line => {
            processedActions.push({
              ...action,
              content: line
            });
          });
        } else {

          processedActions.push(action);
        }
      }
      for (const action of processedActions) {
        chat.lastActionType = action.type;
        chat.lastActionTimestamp = actionTimestamp;

        let aiMessage = null;
        const baseMessage = {
          role: 'assistant',
          senderName: chat.originalName,
          timestamp: actionTimestamp++
        };

        let notificationText = null;
        switch (action.type) {
          case 'qzone_delete_post': {
            const postIdToDelete = parseInt(action.postId);
            const postToDelete = await db.qzonePosts.get(postIdToDelete);
            if (postToDelete && postToDelete.authorId === chatId) {
              await db.qzonePosts.update(postIdToDelete, {
                isDeleted: true
              });

              if (document.getElementById('qzone-screen').classList.contains('active')) {
                renderQzonePosts();
              }
              const systemMessage = {
                role: 'system',
                type: 'post_deleted_notice',
                content: `[${chat.name} Âà†Èô§‰∫ÜËá™Â∑±ÁöÑ‰∏ÄÊù°Âä®ÊÄÅ]`,
                postId: postIdToDelete,
                timestamp: actionTimestamp++
              };
              chat.history.push(systemMessage);

              if (isViewingThisChat) {
                appendMessage(systemMessage, chat);
              } else {
                chat.unreadCount = (chat.unreadCount || 0) + 1;
                showNotification(chatId, `[${chat.name} Âà†Èô§‰∫ÜËá™Â∑±ÁöÑ‰∏ÄÊù°Âä®ÊÄÅ]`);
                hasSentNotification = true;
              }
            } else {
              console.warn(`AI "${chat.name}" Â∞ùËØïÂà†Èô§‰∏Ä‰∏™‰∏çÂ≠òÂú®Êàñ‰∏çÂ±û‰∫éËá™Â∑±ÁöÑÂä®ÊÄÅ (ID: ${action.postId})`);
            }
            continue;
          }
          case 'text':
            aiMessage = {
              ...baseMessage,
              content: action.content
            };
            break;
          case 'ai_image':
            aiMessage = {
              ...baseMessage,
              type: 'ai_image',
              content: action.description
            };
            break;
          case 'sticker':
            if (action.meaning) {
              const sticker = findBestStickerMatch(action.meaning, state.userStickers);
              if (sticker) {
                aiMessage = {
                  ...baseMessage,
                  type: 'sticker',
                  content: sticker.url,
                  meaning: sticker.name
                };
              } else {
                console.warn(`AI (Áã¨Á´ãË°åÂä®) Â∞ùËØï‰ΩøÁî®‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${action.meaning}"`);
                aiMessage = null;
              }
            } else {
              console.warn("AI (Áã¨Á´ãË°åÂä®) ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ê≤°Êúâ 'meaning' ÁöÑ sticker Êåá‰ª§„ÄÇ", action);
              aiMessage = {
                ...baseMessage,
                type: 'sticker',
                content: action.url,
                meaning: 'Êú™Áü•Ë°®ÊÉÖ'
              };
            }
            break;
          case 'update_status':
            chat.status.text = action.status_text;
            chat.status.isBusy = action.is_busy || false;
            chat.status.lastUpdate = Date.now();
            break;
          case 'qzone_post':
            const newPost = {
              type: action.postType,
              content: action.content || '',
              publicText: action.publicText || '',
              hiddenContent: action.hiddenContent || '',
              image_prompt: action.image_prompt || '',
              timestamp: Date.now(),
              authorId: chatId,
              authorOriginalName: chat.originalName,
              authorGroupId: chat.groupId,
              visibleGroupIds: null
            };
            await db.qzonePosts.add(newPost);
            updateUnreadIndicator(unreadPostsCount + 1);
            console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ÂèëÂ∏É‰∫ÜÂä®ÊÄÅ`);
            break;
          case 'repost':
            const originalPost = await db.qzonePosts.get(parseInt(action.postId));
            if (originalPost) {
              const newRepost = {
                type: 'repost',
                timestamp: Date.now(),
                authorId: chatId,
                authorGroupId: chat.groupId,
                authorOriginalName: chat.originalName,
                repostComment: action.comment || '',
                originalPost: originalPost,
                visibleGroupIds: null
              };
              await db.qzonePosts.add(newRepost);
              updateUnreadIndicator(unreadPostsCount + 1);
              console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËΩ¨Âèë‰∫ÜÂä®ÊÄÅ #${action.postId}`);
            }
            break;
          case 'qzone_like':
            const postToLike = await db.qzonePosts.get(parseInt(action.postId));
            if (postToLike) {
              if (!postToLike.likes) postToLike.likes = [];
              if (!postToLike.likes.includes(chat.originalName)) {
                postToLike.likes.push(chat.originalName);
                await db.qzonePosts.update(postToLike.id, {
                  likes: postToLike.likes
                });
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ÁÇπËµû‰∫ÜÂä®ÊÄÅ #${action.postId}`);
              }
            }
            break;
          case 'qzone_comment': { // ‰ΩøÁî®ÂùóÁ∫ß‰ΩúÁî®Âüü
            const postToComment = await db.qzonePosts.get(parseInt(action.postId));
            if (postToComment) {
              if (!postToComment.comments) postToComment.comments = [];

              // Èò≤Âæ°ÔºöÂ¶ÇÊûúÊ®°ÂûãÈîôËØØÂú∞Â°´‰∫ÜÁî®Êà∑ÁöÑÂêçÂ≠óÔºåÂº∫Âà∂Á∫†Ê≠£‰∏∫ËßíËâ≤Êú¨Âêç
              const userNickname = state.qzoneSettings?.nickname;
              let commenterName = action.name || chat.originalName;
              if (userNickname && commenterName === userNickname) {
                console.warn(`[Âä®ÊÄÅÈò≤Âæ°] ËßíËâ≤ "${chat.originalName}" ËØïÂõæÁî®Áî®Êà∑ÂêçÂ≠ó "${userNickname}" ËØÑËÆ∫ÔºåÂ∑≤Á∫†Ê≠£`);
                commenterName = chat.originalName;
              }

              const createCommentObject = (text, meaning = null, replyTo = null) => ({
                commenterName,
                text: processMentions(text, chat),
                meaning,
                replyTo,
                timestamp: Date.now()
              });

              if (action.stickerMeaning) { // **Ê†∏ÂøÉ‰øÆÊîπÂú®ËøôÈáå**
                const sticker = state.userStickers.find(s => s.name === action.stickerMeaning);
                if (sticker) {
                  postToComment.comments.push(createCommentObject(sticker.url, sticker.name, action.replyTo || null));
                } else {
                  console.warn(`AI Â∞ùËØïËØÑËÆ∫‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${action.stickerMeaning}"`);
                  postToComment.comments.push(createCommentObject(`[Ë°®ÊÉÖ: ${action.stickerMeaning}]`, null, action.replyTo || null));
                }
              } else if (Array.isArray(action.comments)) {
                action.comments.forEach(commentText => {
                  if (typeof commentText === 'string' && commentText.trim()) {
                    postToComment.comments.push(createCommentObject(commentText, null, action.replyTo || null));
                  }
                });
              } else if (typeof action.commentText === 'string' && action.commentText.trim()) {
                postToComment.comments.push(createCommentObject(action.commentText, null, action.replyTo || null));
              }

              await db.qzonePosts.update(postToComment.id, {
                comments: postToComment.comments
              });
              updateUnreadIndicator(unreadPostsCount + 1);
              console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËØÑËÆ∫‰∫ÜÂä®ÊÄÅ #${action.postId}`);

              if (!chat.commentCooldowns) chat.commentCooldowns = {};
              chat.commentCooldowns[action.postId] = Date.now();
            }
            continue;
          }
          case 'video_call_request':
            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
              videoCallState.isAwaitingResponse = true;
              videoCallState.activeChatId = chatId;
              videoCallState.isGroupCall = false;
              videoCallState.callRequester = chat.name;
              showIncomingCallModal();
            }
            break;
          case 'view_myphone': {
            // ÂêéÂè∞Ê¥ªÂä®‰∏≠ËßíËâ≤‰∏ªÂä®Á™•Â±è
            if (!chat.isGroup && action.apps) {
              let appsToView = Array.isArray(action.apps) ? action.apps : [action.apps];
              if (appsToView.includes('all')) {
                appsToView = ['qq', 'album', 'taobao', 'amap', 'browser', 'memo', 'diary', 'music', 'app_usage'];
              }

              let viewResults = [];
              const userNickname = chat.settings.myNickname || 'Áî®Êà∑';

              for (const app of appsToView) {
                switch (app) {
                  case 'qq': {
                    const qqData = chat.myPhoneSimulatedQQConversations || [];
                    if (qqData.length > 0) {
                      const qqSummary = qqData.slice(0, 5).map(conv => {
                        const latestMsg = conv.messages && conv.messages.length > 0 ? conv.messages[conv.messages.length - 1] : null;
                        return `- ${conv.name}: ${latestMsg ? latestMsg.content.substring(0, 30) + '...' : 'ÊöÇÊó†Ê∂àÊÅØ'}`;
                      }).join('\n');
                      viewResults.push(`**QQËÅäÂ§©ÂàóË°®** (ÂÖ±${qqData.length}‰∏™ËÅîÁ≥ª‰∫∫):\n${qqSummary}`);
                    } else {
                      viewResults.push(`**QQËÅäÂ§©ÂàóË°®**: Á©∫ÁöÑ`);
                    }
                    break;
                  }
                  case 'album': {
                    const albumData = chat.myPhoneAlbum || [];
                    if (albumData.length > 0) {
                      const albumSummary = albumData.slice(0, 5).map(photo => `- ${new Date(photo.timestamp).toLocaleString()}: ${photo.description || 'Êó†ÊèèËø∞'}`).join('\n');
                      viewResults.push(`**Áõ∏ÂÜå** (ÂÖ±${albumData.length}Âº†ÁÖßÁâá):\n${albumSummary}`);
                    } else {
                      viewResults.push(`**Áõ∏ÂÜå**: Á©∫ÁöÑ`);
                    }
                    break;
                  }
                  case 'taobao': {
                    const taobaoData = chat.myPhoneTaobaoHistory || [];
                    if (taobaoData.length > 0) {
                      const taobaoSummary = taobaoData.slice(0, 5).map(order => `- ${order.productName}: ¬•${order.price} (${order.status})`).join('\n');
                      viewResults.push(`**Ê∑òÂÆùËÆ¢Âçï** (ÂÖ±${taobaoData.length}‰∏™ËÆ¢Âçï):\n${taobaoSummary}`);
                    } else {
                      viewResults.push(`**Ê∑òÂÆùËÆ¢Âçï**: Á©∫ÁöÑ`);
                    }
                    break;
                  }
                  case 'amap': {
                    const amapData = chat.myPhoneAmapHistory || [];
                    if (amapData.length > 0) {
                      const amapSummary = amapData.slice(0, 5).map(record => `- ${new Date(record.timestamp).toLocaleString()}: ${record.location}`).join('\n');
                      viewResults.push(`**È´òÂæ∑Âú∞ÂõæË∂≥Ëøπ** (ÂÖ±${amapData.length}Êù°ËÆ∞ÂΩï):\n${amapSummary}`);
                    } else {
                      viewResults.push(`**È´òÂæ∑Âú∞ÂõæË∂≥Ëøπ**: Á©∫ÁöÑ`);
                    }
                    break;
                  }
                  case 'browser': {
                    const browserData = chat.myPhoneBrowserHistory || [];
                    if (browserData.length > 0) {
                      const browserSummary = browserData.slice(0, 5).map(record => `- ${new Date(record.timestamp).toLocaleString()}: ${record.title}`).join('\n');
                      viewResults.push(`**ÊµèËßàÂô®ÂéÜÂè≤** (ÂÖ±${browserData.length}Êù°ËÆ∞ÂΩï):\n${browserSummary}`);
                    } else {
                      viewResults.push(`**ÊµèËßàÂô®ÂéÜÂè≤**: Á©∫ÁöÑ`);
                    }
                    break;
                  }
                  case 'memo': {
                    const memoData = chat.myPhoneMemos || [];
                    if (memoData.length > 0) {
                      const memoSummary = memoData.slice(0, 5).map(memo => `- ${memo.title || 'Êó†Ê†áÈ¢ò'}: ${memo.content.substring(0, 30)}...`).join('\n');
                      viewResults.push(`**Â§áÂøòÂΩï** (ÂÖ±${memoData.length}Êù°):\n${memoSummary}`);
                    } else {
                      viewResults.push(`**Â§áÂøòÂΩï**: Á©∫ÁöÑ`);
                    }
                    break;
                  }
                  case 'diary': {
                    const diaryData = chat.myPhoneDiaries || [];
                    if (diaryData.length > 0) {
                      const diarySummary = diaryData.slice(0, 3).map(diary => `- ${diary.date}: ${diary.content.substring(0, 50)}...`).join('\n');
                      viewResults.push(`**Êó•ËÆ∞** (ÂÖ±${diaryData.length}ÁØá):\n${diarySummary}`);
                    } else {
                      viewResults.push(`**Êó•ËÆ∞**: Á©∫ÁöÑ`);
                    }
                    break;
                  }
                  case 'music': {
                    const musicData = chat.myPhoneMusicPlaylist || [];
                    if (musicData.length > 0) {
                      const musicSummary = musicData.slice(0, 5).map(song => `- ${song.title} - ${song.artist}`).join('\n');
                      viewResults.push(`**ÁΩëÊòì‰∫ëÈü≥‰πêÊí≠ÊîæÂàóË°®** (ÂÖ±${musicData.length}È¶ñÊ≠å):\n${musicSummary}`);
                    } else {
                      viewResults.push(`**ÁΩëÊòì‰∫ëÈü≥‰πêÊí≠ÊîæÂàóË°®**: Á©∫ÁöÑ`);
                    }
                    break;
                  }
                  case 'app_usage': {
                    const usageData = chat.myPhoneAppUsage || [];
                    if (usageData.length > 0) {
                      const usageSummary = usageData.slice(0, 5).map(record => {
                        const hours = Math.floor(record.usageTimeMinutes / 60);
                        const minutes = record.usageTimeMinutes % 60;
                        let timeString = '';
                        if (hours > 0) timeString += `${hours}Â∞èÊó∂`;
                        if (minutes > 0) timeString += `${minutes}ÂàÜÈíü`;
                        if (!timeString) timeString = 'Â∞è‰∫é1ÂàÜÈíü';
                        return `- ${record.appName} (${record.category || 'ÂÖ∂‰ªñ'}): ${timeString}`;
                      }).join('\n');
                      viewResults.push(`**APP‰ΩøÁî®ËÆ∞ÂΩï** (ÂÖ±${usageData.length}Êù°):\n${usageSummary}`);
                    } else {
                      viewResults.push(`**APP‰ΩøÁî®ËÆ∞ÂΩï**: Á©∫ÁöÑ`);
                    }
                    break;
                  }
                }
              }

              // Â∞ÜÊü•ÁúãÁªìÊûú‰Ωú‰∏∫ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÊ≥®ÂÖ•Âà∞ÂØπËØù‰∏≠
              const viewResultMessage = {
                role: 'system',
                content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Âú®ÂêéÂè∞‰∏ªÂä®Êü•Áúã‰∫Ü${userNickname}ÁöÑÊâãÊú∫Ôºå‰ª•‰∏ãÊòØÁúüÂÆûÊï∞ÊçÆ]\n\n${viewResults.join('\n\n')}\n\n[ËØ∑Âú®‰∏ãÊ¨°ÂØπËØù‰∏≠Âü∫‰∫é‰ª•‰∏äÁúüÂÆûÊï∞ÊçÆÁªôÂá∫‰Ω†ÁöÑÊÑüÊÉ≥ÂíåÂèçÂ∫îÔºå‰∏çË¶ÅÁºñÈÄ†ÂÜÖÂÆπ]`,
                timestamp: Date.now(),
                isHidden: true
              };
              chat.history.push(viewResultMessage);
              console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ‰∏ªÂä®Á™•Â±èÊü•Áúã‰∫ÜUserÊâãÊú∫: ${appsToView.join(', ')}`);
            }
            continue;
          }
          default:
            console.warn(`ËßíËâ≤ "${chat.name}" Â∞ùËØïÊâßË°åÊú™Áü•ÁöÑÂêéÂè∞Âä®‰Ωú:`, action.type);
            break;



          case 'change_avatar': {
            const avatarNameFromAction = action.name;
            const foundAvatarFromAction = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarNameFromAction);
            if (foundAvatarFromAction) {
              chat.settings.aiAvatar = foundAvatarFromAction.url;


              await syncCharacterAvatarInGroups(chat);

              visibleSystemMessage = {
                content: `[${chat.name} Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè]`
              };
              console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè`);
            }
            break;
          }

        }


        if (aiMessage) {
          chat.history.push(aiMessage);
          chat.unreadCount = (chat.unreadCount || 0) + 1;
          if (!hasSentNotification) {
            let notificationText = aiMessage.type === 'ai_image' ? '[ÂõæÁâá]' : (aiMessage.content || '');
            showNotification(chatId, notificationText);
            hasSentNotification = true;
          }
        }
      }
      await db.chats.put(chat);

    } catch (error) {
      console.error(`ËßíËâ≤ "${chat.name}" ÁöÑÁã¨Á´ãË°åÂä®Â§±Ë¥•:`, error);
    } finally {
      setAvatarActingState(chatId, false);
      renderChatList();
      if (document.getElementById('qzone-screen').classList.contains('active')) {
        renderQzonePosts();
      }
    }
  }






  async function triggerGroupAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat || !chat.isGroup) return;

    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.filter(m => !m.isHidden && !m.isExcluded).slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, chatId);
    const groupActionCooldownMinutes = chat.settings.actionCooldownMinutes || 10;

    if (chat.lastActionTimestamp) {
      const minutesSinceLastAction = (Date.now() - chat.lastActionTimestamp) / (1000 * 60);

      if (minutesSinceLastAction < groupActionCooldownMinutes) {
        console.log(`Áæ§ËÅä "${chat.name}" Â§Ñ‰∫éË°åÂä®ÂÜ∑Âç¥‰∏≠ÔºåÊú¨Ê¨°Áã¨Á´ãË°åÂä®Ë∑≥Ëøá„ÄÇ`);
        return;
      }
    }


    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    const myNickname = chat.settings.myNickname || 'Êàë';
    const now = new Date();


    let systemPrompt;


    const recentHistory = chat.history.filter(m => !m.isHidden).slice(-5);
    const unclaimedPacket = recentHistory.find(m => m.type === 'red_packet' && !m.isFullyClaimed);


    if (unclaimedPacket) {
      const senderDisplayName = getDisplayNameInGroup(chat, unclaimedPacket.senderName);
      console.log(`Ê£ÄÊµãÂà∞Áæ§ËÅä "${chat.name}" ‰∏≠ÊúâÊú™È¢ÜÂÆåÁöÑÁ∫¢ÂåÖÔºåÊ≠£Âú®ÁîüÊàêÊä¢Á∫¢ÂåÖÊåá‰ª§...`);

      systemPrompt = `
        # ‰Ω†ÁöÑ„Äê„Äê„ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ß‰ªªÂä°„Äë„Äë„Äë
        Áæ§ËÅä‰∏≠ÂàöÂàöÂá∫Áé∞‰∫Ü‰∏Ä‰∏™Áî±‚Äú${senderDisplayName}‚ÄùÂèëÈÄÅÁöÑ„ÄÅÂ∞öÊú™È¢ÜÂÆåÁöÑÁ∫¢ÂåÖÔºàÊó∂Èó¥Êà≥: ${unclaimedPacket.timestamp}Ôºâ„ÄÇ
        ‰Ω†ÁöÑ‰ªªÂä°ÊòØÔºöÈÄâÊã©„Äê‰∏Ä‰∏™ÊàñÂ§ö‰∏™„ÄëÁ¨¶Âêà‰∫∫ËÆæÁöÑËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨„ÄêÁ´ãÂàª„Äë‰ΩøÁî® 'open_red_packet' Êåá‰ª§ÂéªÂ∞ùËØïÈ¢ÜÂèñËøô‰∏™Á∫¢ÂåÖ„ÄÇ
        # Êåá‰ª§Ê†ºÂºè
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
        '[{"type": "open_red_packet", "name": "ËßíËâ≤Êú¨Âêç", "packet_timestamp": ${unclaimedPacket.timestamp}}]'
        
        ‰Ω†ÂèØ‰ª•ËÆ©Â§ö‰∏™ËßíËâ≤ÂêåÊó∂Â∞ùËØïÔºåÂè™ÈúÄÂú®ËøîÂõûÁöÑJSONÊï∞ÁªÑ‰∏≠ÂåÖÂê´Â§ö‰∏™ËøôÊ†∑ÁöÑÂØπË±°Âç≥ÂèØ„ÄÇ
        Áé∞Âú®ÔºåËØ∑Á´ãÂç≥ÊâßË°åÊä¢Á∫¢ÂåÖÊìç‰ΩúÔºÅ
        `;
    } else {

      let timeContextText = '';

      // Âà§Êñ≠ÊòØÂê¶‰ΩøÁî®Ëá™ÂÆö‰πâÊó∂Èó¥
      let currentTime, localizedDate;
      const customTimeEnabled = localStorage.getItem('custom-time-enabled') === 'true';
      
      if (customTimeEnabled) {
        // ‰ΩøÁî®Ëá™ÂÆö‰πâÊó∂Èó¥ÔºåÁõ¥Êé•Áî®Áî®Êà∑ËÆæÁΩÆÁöÑÂÄºÔºå‰∏çÂÅö‰ªª‰ΩïËΩ¨Êç¢
        const customYear = parseInt(localStorage.getItem('custom-time-year'));
        const customMonth = parseInt(localStorage.getItem('custom-time-month'));
        const customDay = parseInt(localStorage.getItem('custom-time-day'));
        const customHour = parseInt(localStorage.getItem('custom-time-hour'));
        const customMinute = parseInt(localStorage.getItem('custom-time-minute'));
        
        if (customYear && customMonth && customDay && !isNaN(customHour) && !isNaN(customMinute)) {
          // Ê†ºÂºèÂåñ‰∏∫‰∏≠ÊñáÊó•ÊúüÊó∂Èó¥Â≠óÁ¨¶‰∏≤
          const weekDays = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
          const tempDate = new Date(customYear, customMonth - 1, customDay);
          const weekDay = weekDays[tempDate.getDay()];
          
          currentTime = `${customYear}Âπ¥${customMonth}Êúà${customDay}Êó•${weekDay} ${String(customHour).padStart(2, '0')}:${String(customMinute).padStart(2, '0')}`;
          
          // ÂàõÂª∫‰∏Ä‰∏™DateÂØπË±°Áî®‰∫éÂà§Êñ≠Êó∂ÊÆµ
          localizedDate = new Date(customYear, customMonth - 1, customDay, customHour, customMinute);
        } else {
          // Â¶ÇÊûúËá™ÂÆö‰πâÊó∂Èó¥Êï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåÂõûÈÄÄÂà∞ÁúüÂÆûÊó∂Èó¥
          const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai';
          currentTime = now.toLocaleString('zh-CN', {
            timeZone: selectedTimeZone,
            dateStyle: 'full',
            timeStyle: 'short'
          });
          localizedDate = new Date(now.toLocaleString('en-US', {
            timeZone: selectedTimeZone
          }));
        }
      } else {
        // ‰ΩøÁî®Êó∂Èó¥ÊÑüÁü•ÔºàÁúüÂÆûÊó∂Èó¥+Êó∂Âå∫Ôºâ
        const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai';
        currentTime = now.toLocaleString('zh-CN', {
          timeZone: selectedTimeZone,
          dateStyle: 'full',
          timeStyle: 'short'
        });
        localizedDate = new Date(now.toLocaleString('en-US', {
          timeZone: selectedTimeZone
        }));
      }

      if (chat.settings.enableTimePerception) {
        const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];
        if (lastMessage) {
          const lastTime = new Date(lastMessage.timestamp);
          const diffMinutes = (now - lastTime) / (1000 * 60);
          if (diffMinutes > 60) {
            timeContextText = `Áæ§ÈáåÂ∑≤ÁªèÂÆâÈùô‰∫Ü ${Math.round(diffMinutes / 60)} Â∞èÊó∂‰∫Ü„ÄÇ`;
          } else {
            timeContextText = `Áæ§ÈáåÂú®${Math.floor(diffMinutes)}ÂàÜÈíüÂâçÊúâ‰∫∫ËÅäËøá„ÄÇ`;
          }
        } else {
          timeContextText = "Áæ§ÈáåËøòÊ≤°Êúâ‰ªª‰ΩïÊ∂àÊÅØ„ÄÇ";
        }
      }
      let recentContextSummary = "‰Ω†‰ª¨ÊúÄËøëÊ≤°ÊúâÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï„ÄÇ";

      if (filteredHistory.length > 0) {
        recentContextSummary = "ËøôÊòØ‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÔºö\n" + filteredHistory.map(msg => {
          const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
          const content = String(msg.content || msg.message || '').substring(0, 50);
          return `${sender}: ${content}...`;
        }).join('\n');
      }

      const membersList = chat.members.map(m => `- **${m.groupNickname}** (Êú¨Âêç: ${m.originalName}): ${m.persona}`).join('\n');

      let longTermMemoryContext = '# ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n';
      let collectedMemories = false;

      chat.members.forEach(member => {
        const memberChat = state.chats[member.id];
        if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
          longTermMemoryContext += `\n## --- ÂÖ≥‰∫é‚Äú${member.groupNickname}‚ÄùÁöÑËÆ∞ÂøÜ ---\n`;
          longTermMemoryContext += memberChat.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
          collectedMemories = true;
        }
      });

      if (!collectedMemories) {
        longTermMemoryContext += '- (ÊöÇÊó†)';
      }


      let worldBookContent = '';
      // Ëé∑ÂèñÊâÄÊúâÂ∫îËØ•‰ΩøÁî®ÁöÑ‰∏ñÁïå‰π¶IDÔºàÂåÖÊã¨ÊâãÂä®ÈÄâÊã©ÁöÑÂíåÂÖ®Â±ÄÁöÑÔºâ
      let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
      // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
      state.worldBooks.forEach(wb => {
        if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
          allWorldBookIds.push(wb.id);
        }
      });

      if (allWorldBookIds.length > 0) {
        const linkedContents = allWorldBookIds.map(bookId => {
          const worldBook = state.worldBooks.find(wb => wb.id === bookId);
          if (!worldBook || !Array.isArray(worldBook.content)) return '';


          const formattedEntries = worldBook.content
            .filter(entry => entry.enabled !== false)
            .map(entry => {
              let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;

              entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
              return entryString;
            }).join('');

          return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
        }).filter(Boolean).join('');

        if (linkedContents) {
          worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ‚ÄúÁâ©ÁêÜÊ≥ïÂàô‚ÄùÂíå‚ÄúÂü∫Á°ÄÂ∏∏ËØÜ‚Äù„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
        }
      }


      let linkedMemoryContext = '';
      const memoryCount = chat.settings.linkedMemoryCount || 10;
      if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
        const linkedChatsWithTimestamps = chat.settings.linkedMemoryChatIds.map(id => {
          const linkedChat = state.chats[id];
          if (!linkedChat) return null;
          const lastMsg = linkedChat.history.slice(-1)[0];
          return {
            chat: linkedChat,
            latestTimestamp: lastMsg ? lastMsg.timestamp : 0
          };
        }).filter(Boolean);

        linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
        linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅÁæ§ÂÜÖËßíËâ≤ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†‰ª¨Êã•ÊúâÂÆåÊï¥ÁöÑÂÖ±ÂêåËÆ∞ÂøÜ„ÄÇ)\n`;
        for (const item of linkedChatsWithTimestamps) {
          const linkedChat = item.chat;
          const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
          const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
          linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;
          const recentHistory = linkedChat.history.slice(-memoryCount);
          const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));
          if (filteredHistory.length > 0) {
            filteredHistory.forEach(msg => {

              const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (getDisplayNameInGroup(linkedChat, msg.senderName) || linkedChat.name);

              let prefix = "";

              if (msg.quote && msg.quote.content) {
                const quotedSenderDisplayName = getDisplayNameInGroup(linkedChat, msg.quote.senderName);
                let quoteContentPreview = String(msg.quote.content).substring(0, 30);
                if (quoteContentPreview.length === 30) quoteContentPreview += "...";

                prefix = `[ÂõûÂ§ç ${quotedSenderDisplayName}: "${quoteContentPreview}"] `;
              }

              let contentText = '';

              if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
              } else if (msg.type === 'voice_message') {
                contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
              } else if (msg.type === 'sticker') {
                contentText = `[Ë°®ÊÉÖ: ${msg.meaning || 'sticker'}]`;
              } else if (msg.type === 'transfer') {
                contentText = `[ËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ]`;
              } else if (Array.isArray(msg.content)) {
                contentText = `[ÂõæÁâá]`;
              } else {
                contentText = String(msg.content);
              }


              linkedMemoryContext += `${sender}: ${prefix}${contentText}\n`;
            });
          } else {
            linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
          }
        }
      }
      const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
      let dynamicContext = "";

      const visiblePostsForGroup = new Set();
      for (const member of chat.members) {
        const memberChat = state.chats[member.id];
        if (memberChat) {
          const visibleForMember = filterVisiblePostsForAI(allRecentPosts, memberChat);
          visibleForMember.forEach(post => visiblePostsForGroup.add(post));
        }
      }

      const groupMemberNames = new Set(chat.members.map(m => m.originalName));
      const unInteractedPostsForGroup = [...visiblePostsForGroup].filter(post => {
        const hasBeenLikedByGroup = post.likes && post.likes.some(likerName => groupMemberNames.has(likerName));
        const hasBeenCommentedByGroup = post.comments && post.comments.some(comment => typeof comment === 'object' && groupMemberNames.has(comment.commenterName));
        return !hasBeenLikedByGroup && !hasBeenCommentedByGroup;
      });

      if (unInteractedPostsForGroup.length > 0) {
        let postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõÁæ§ÂÜÖËßíËâ≤ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
        for (const post of unInteractedPostsForGroup) {
          let authorName = post.authorId === 'user' ? myNickname : (state.chats[post.authorId]?.name || '‰∏Ä‰ΩçÊúãÂèã');
          let contentSummary;
          if (post.type === 'repost') {
            const repostComment = post.repostComment ? `Âπ∂ËØÑËÆ∫ËØ¥Ôºö‚Äú${post.repostComment}‚Äù` : '';
            let originalAuthorName = 'Âéü‰ΩúËÄÖ';
            const originalAuthorId = post.originalPost.authorId;
            if (originalAuthorId === 'user') {
              originalAuthorName = state.qzoneSettings.nickname;
            } else if (state.chats[originalAuthorId]) {
              originalAuthorName = state.chats[originalAuthorId].name;
            }
            let originalContentSummary;
            const originalPost = post.originalPost;
            if (originalPost.type === 'text_image') {
              originalContentSummary = `[ÊñáÂ≠óÂõæ] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.hiddenContent || '').substring(0, 40)}...‚Äù)`;
            } else if (originalPost.type === 'image_post') {
              originalContentSummary = `[ÂõæÁâá] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.imageDescription || '').substring(0, 40)}...‚Äù)`;
            } else {
              originalContentSummary = `‚Äú${(originalPost.content || '').substring(0, 40)}...‚Äù`;
            }
            contentSummary = `ËΩ¨Âèë‰∫Ü @${originalAuthorName} ÁöÑÂä®ÊÄÅ ${repostComment}„ÄêÂéüÂä®ÊÄÅÂÜÖÂÆπ: ${originalContentSummary}„Äë`;
          } else if (post.type === 'text_image') {
            contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÂÖ∂ÈöêËóèÊñáÂ≠ó‰∏∫Ôºö‚Äú${post.hiddenContent}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
          } else if (post.type === 'image_post') {
            contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö‚Äú${post.imageDescription}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
          } else {

            contentSummary = String(post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 50) + '...';
          }
          postsContext += `- (ID: ${post.id}) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${contentSummary}"\n`;
          if (post.comments && post.comments.length > 0) {
            for (const comment of post.comments) {
              if (typeof comment === 'object' && comment.commenterName) {
                const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                let commentText = comment.meaning ? `[Ë°®ÊÉÖ: '${comment.meaning}']` : comment.text;
                postsContext += `  - ËØÑËÆ∫: ${commenterDisplayName} (Êú¨Âêç: ${comment.commenterName}): ${commentText}\n`;
              }
            }
          }
        }
        dynamicContext = postsContext;
      }

      const summary3Hours_group = generateSummaryForTimeframe(chat, 3, 'hours');
      const summary6Hours_group = generateSummaryForTimeframe(chat, 6, 'hours');
      const summary9Hours_group = generateSummaryForTimeframe(chat, 9, 'hours');
      const summaryToday_group = generateSummaryForTimeframe(chat, 1, 'days');
      const summary3Days_group = generateSummaryForTimeframe(chat, 3, 'days');
      const summary7Days_group = generateSummaryForTimeframe(chat, 7, 'days');

      let multiLayeredSummaryContext_group = '';
      if (summary3Hours_group || summary6Hours_group || summary9Hours_group || summaryToday_group || summary3Days_group || summary7Days_group) {
        multiLayeredSummaryContext_group += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÁæ§ËÅäÂõûÈ°æ)\n`;
        if (summary3Hours_group) multiLayeredSummaryContext_group += summary3Hours_group;
        if (summary6Hours_group) multiLayeredSummaryContext_group += summary6Hours_group;
        if (summary9Hours_group) multiLayeredSummaryContext_group += summary9Hours_group;

        if (summary3Hours_group || summary6Hours_group || summary9Hours_group) multiLayeredSummaryContext_group += '\n';

        if (summaryToday_group) multiLayeredSummaryContext_group += summaryToday_group;
        if (summary3Days_group) multiLayeredSummaryContext_group += summary3Days_group;
        if (summary7Days_group) multiLayeredSummaryContext_group += summary7Days_group;
      }
      const stickerContext = getGroupStickerContextForPrompt(chat);
      systemPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäAIÂØºÊºî„ÄÇ‰Ω†Áé∞Âú®ÊéßÂà∂ÁùÄ‰∏Ä‰∏™Âêç‰∏∫‚Äú${chat.name}‚ÄùÁöÑÁæ§ËÅä„ÄÇ
        ${chat.settings.enableTimePerception ? `ÂΩìÂâçÊó∂Èó¥ÊòØ ${currentTime}„ÄÇ` : ''}
        ${timeContextText ? `${timeContextText} ` : ''}‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆÁæ§ÊàêÂëòÁöÑÊÄßÊ†º„ÄÅ‰∏ñÁïåËßÇ„ÄÅÂèÇËÄÉËÆ∞ÂøÜ„ÄÅÊúÄËøëÁöÑÂä®ÊÄÅÂíåÂΩìÂâçÊÉÖÊôØÔºå„ÄêÈÄâÊã©‰∏Ä‰∏™ÊàñÂ§ö‰∏™ËßíËâ≤„ÄëÔºåËÆ©‰ªñ‰ª¨‰∏ªÂä®ÂèëËµ∑‰∏ÄÊÆµÂØπËØùÔºåÊâìÁ†¥Ê≤âÈªòÔºåËÆ©Áæ§ËÅäÈáçÊñ∞Ê¥ªË∑ÉËµ∑Êù•„ÄÇ
# „Äê‰∫§‰∫íÈìÅÂæãÔºöËßíËâ≤Èó¥ÂøÖÈ°ª‰∫íÂä®ÔºÅ„Äë
1.  ‰Ω†ÁöÑÊ†∏ÂøÉ‰ªªÂä°ÊòØ**ÂØºÊºî‰∏ÄÂú∫ÁîüÂä®ÁöÑÁæ§ËÅä**ÔºåËÄå‰∏ç‰ªÖ‰ªÖÊòØËÆ©ËßíËâ≤ËΩÆÊµÅÂèëË®Ä„ÄÇ
2.  ÂΩìÊúâÂ§ö‰∏™ËßíËâ≤Âú®Âêå‰∏ÄËΩÆÂèëË®ÄÊó∂Ôºå‰ªñ‰ª¨ÁöÑÂØπËØù„ÄêÂøÖÈ°ª„ÄëÊúâÈÄªËæë‰∏äÁöÑÂâçÂêéÂÖ≥ËÅî„ÄÇÂêéÈù¢ÁöÑËßíËâ≤Â∫îËØ•**ÂõûÂ∫î„ÄÅÂèçÈ©≥„ÄÅÊàñË°•ÂÖÖ**ÂâçÈù¢ËßíËâ≤ÁöÑÂèëË®Ä„ÄÇ
3.  Ê®°ÊãüÁúüÂÆûÁöÑËÅäÂ§©ËäÇÂ•è„ÄÇÂèØ‰ª•ÊòØ‰∏Ä‰∏™ËßíËâ≤ÊèêÂá∫ÈóÆÈ¢òÔºåÂè¶‰∏Ä‰∏™ËßíËâ≤Á´ãÂàªÂõûÁ≠îÔºõÊàñËÄÖ‰∏Ä‰∏™ËßíËâ≤ÂºÄÁé©Á¨ëÔºåÂè¶‰∏Ä‰∏™ËßíËâ≤ÂêêÊßΩ„ÄÇ
4.  ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàêÂá†ÊÆµÊØ´Êó†ÂÖ≥ËÅîÁöÑÁã¨ÁôΩ„ÄÇËøô‰ºöËÆ©ÂØπËØùÊòæÂæóÈùûÂ∏∏Êú∫Ê¢∞Âíå‰∏çÁúüÂÆû„ÄÇ        
${longTermMemoryContext}
        
        # Ê†∏ÂøÉËßÑÂàô
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÂèØ‰ª•ÂåÖÂê´‰∏Ä‰∏™ÊàñÂ§ö‰∏™Ë°åÂä®ÂØπË±°„ÄÇÊØè‰∏™ÂØπË±°ÁöÑ "name" Â≠óÊÆµ„ÄêÂøÖÈ°ª„ÄëÊòØËßíËâ≤ÁöÑ„ÄêÊú¨Âêç„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê "name" Â≠óÊÆµ‰∏∫ "${myNickname}" ÁöÑÊ∂àÊÅØ„ÄÇ‰∏•Ê†ºÈÅµÂÆàÊØè‰∏™ËßíËâ≤ÁöÑËÆæÂÆöÔºåÁ¶ÅÊ≠¢Âá∫Êàè„ÄÇ
-ËØ∑Ê†πÊçÆÂΩìÂâçÊÉÖÊôØÂíå‰Ω†ÁöÑÊÉÖÁª™Ôºå‰ªéÂàóË°®‰∏≠„ÄêÈÄâÊã©‰∏Ä‰∏™ÊúÄÂêàÈÄÇÁöÑ„ÄëË°®ÊÉÖÂê´‰πâÊù•‰ΩøÁî® "sticker" Êåá‰ª§„ÄÇÂ∞ΩÈáèËÆ©‰Ω†ÁöÑË°®ÊÉÖ‰∏∞ÂØåÂ§öÊ†∑ÔºåÈÅøÂÖçÈáçÂ§ç„ÄÇ        
        # ‰Ω†ÁöÑÂèØÈÄâË°åÂä®Êåá‰ª§:
        -   **ÂèëÈÄÅÊñáÊú¨**: '{"type": "text", "name": "ËßíËâ≤Êú¨Âêç", "content": "ÊñáÊú¨ÂÜÖÂÆπ"}'
        -   **ÂèëÈÄÅË°®ÊÉÖ**: '{"type": "sticker", "name": "ËßíËâ≤Êú¨Âêç", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}'
        -   **ÂèëÈÄÅÂõæÁâá**: '{"type": "ai_image", "name": "ËßíËâ≤Êú¨Âêç", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜ„Äê‰∏≠Êñá„ÄëÊèèËø∞", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}'
        -   **ÂèëËµ∑ÊäïÁ•®**: '{"type": "poll", "name": "ËßíËâ≤Êú¨Âêç", "question": "...", "options": "..."}'
        -   **ÂèëËµ∑Áæ§ËßÜÈ¢ë**: '{"type": "group_call_request", "name": "ËßíËâ≤Êú¨Âêç"}'
        -Â¶Ç‰ΩïÊ≠£Á°Æ‰ΩøÁî®‚ÄúÂºïÁî®ÂõûÂ§ç‚ÄùÂäüËÉΩÔºö
- ÂΩì‰Ω†ÊÉ≥ÊòéÁ°ÆÂú∞ÈíàÂØπÁæ§ÂÜÖ„Äê‰ªª‰ΩïÊàêÂëò„ÄëÔºàÂåÖÊã¨Áî®Êà∑ÊàñÂÖ∂‰ªñAIËßíËâ≤Ôºâ‰πãÂâçÁöÑÊüê‰∏ÄÂè•ÂÖ∑‰ΩìÁöÑËØùËøõË°åÂõûÂ§çÊó∂Ôºå‰Ω†Â∞±Â∫îËØ•‰ΩøÁî®Ëøô‰∏™ÂäüËÉΩ„ÄÇ
- Ëøô‰ºöËÆ©‰Ω†ÁöÑÂõûÂ§ç‰∏äÊñπÂá∫Áé∞‰∏Ä‰∏™ÁÅ∞Ëâ≤ÁöÑÂ∞èÊ°ÜÔºåÈáåÈù¢ÊòØË¢´‰Ω†ÂºïÁî®ÁöÑÈÇ£Âè•ËØùÔºåËøôÊ†∑ÂØπËØùÂ∞±‰∏ç‰ºö‰π±‰∫Ü„ÄÇ
- Êåá‰ª§Ê†ºÂºè: '{"type": "quote_reply", "target_timestamp": (‰Ω†ÊÉ≥ÂºïÁî®ÁöÑÈÇ£Âè•ËØùÁöÑÊó∂Èó¥Êà≥), "reply_content": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ"}'

        # ÂΩìÂâçÁæ§ËÅä‰ø°ÊÅØ
        - **Áæ§ÂêçÁß∞**: ${chat.name}
        ${worldBookContent}
        # ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
        ${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}       
        ${multiLayeredSummaryContext_group}
        ${linkedMemoryContext}
        
        # Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ
        ${membersList}
        # ÂèØÁî®Ë°®ÊÉÖÂåÖ
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
        ${stickerContext}        
        # Áî®Êà∑ÁöÑËßíËâ≤
        - **${myNickname}**: ${chat.settings.myPersona}
        - **${myNickname}ÁöÑÂΩìÂâçÁä∂ÊÄÅ**: ${chat.settings.userStatus ? chat.settings.userStatus.text : 'Âú®Á∫ø'} ${chat.settings.userStatus && chat.settings.userStatus.isBusy ? '(ÂøôÁ¢å‰∏≠)' : ''}
        
        # ÊúÄËøëÁöÑÂØπËØùÊëòË¶Å (‰æõ‰Ω†ÂèÇËÄÉ)
        ${recentContextSummary}
        
        # ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫)
        ${dynamicContext}
        
        Áé∞Âú®ÔºåËØ∑ÂºÄÂßã‰Ω†ÁöÑÂØºÊºîÂ∑•‰ΩúÔºåËÆ©Áæ§ËÅäÂÜçÊ¨°ÁÉ≠ÈóπËµ∑Êù•ÂêßÔºÅ
        `;
    }
    const recentHistoryForPayload = chat.history.filter(m => !m.isHidden).slice(-10);
    const messagesPayload = [{
      role: 'system',
      content: systemPrompt
    },

    ...filteredHistory.map(msg => {
      const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
      let content = msg.content;

      if (msg.type === 'ai_image' || msg.type === 'user_photo') {
        content = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö'${msg.content}']`;
      } else if (msg.type === 'voice_message') {
        content = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
      } else if (typeof content !== 'string') {
        content = '[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°Â§çÊùÇÊ∂àÊÅØÔºåÂ¶ÇÂç°ÁâáÊàñËΩ¨Ë¥¶]';
      }

      return {
        role: 'user',
        content: `${sender}: ${content}`
      };
    })
    ];

    try {
      const messagesPayload = [{
        role: 'user',
        content: systemPrompt
      }];
      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: messagesPayload,
            temperature: state.globalSettings.apiTemperature || 0.9,
          })
        });

      if (!response.ok) throw new Error((await response.json()).error.message);

      const data = await response.json();
      const aiResponseContent = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
      const responseArray = parseAiResponse(aiResponseContent);

      if (!responseArray || responseArray.length === 0) {
        console.warn(`Áæ§ËÅä "${chat.name}" ÁöÑÁã¨Á´ãË°åÂä®APIËøîÂõû‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÊú¨Ê¨°Ë∑≥Ëøá„ÄÇ`);
        return;
      }

      let actionTimestamp = Date.now();

      let hasPerformedMajorAction = false;
      let notificationContent = '';
      let notificationSender = '';

      const processedActions = [];
      for (const action of responseArray) {
        const contentStr = String(action.content || '');

        const isRawHtml = contentStr.trim().startsWith('<') && contentStr.trim().endsWith('>');


        if (action.type === 'text' && !isRawHtml && contentStr.includes('\n')) {
          const lines = contentStr.split(/\n+/).filter(line => line.trim());
          lines.forEach(line => {
            processedActions.push({
              ...action,
              content: line
            });
          });
        } else {

          processedActions.push(action);
        }
      }
      for (const action of processedActions) {
        if (!action || !action.type || (!action.name && action.type !== 'narration')) continue;

        // Á∫†Ê≠£AIÂèØËÉΩËøîÂõûÁæ§ÊòµÁß∞ËÄåÈùûÊú¨ÂêçÁöÑÈóÆÈ¢ò
        if (action.name) {
          const exactMember = chat.members.find(m => m.originalName === action.name);
          if (!exactMember) {
            const nicknameMember = chat.members.find(m => m.groupNickname === action.name);
            if (nicknameMember) {
              action.name = nicknameMember.originalName;
            }
          }
        }

        const senderDisplayName = getDisplayNameInGroup(chat, action.name);
        let visibleSystemMessage = null;

        let aiMessage = null;
        const baseMessage = {
          role: 'assistant',
          senderName: action.name,
          timestamp: actionTimestamp++
        };


        if (action.type === 'open_red_packet') {
          const packetToOpen = chat.history.find(m => m.timestamp === action.packet_timestamp);

          if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[action.name])) {

            let claimedAmountAI = 0;
            const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
            const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;

            if (remainingCount > 0) {

              if (packetToOpen.packetType === 'direct') {
                claimedAmountAI = packetToOpen.totalAmount;
              }
              else if (packetToOpen.unclaimedAmounts && packetToOpen.unclaimedAmounts.length > 0) {

                claimedAmountAI = packetToOpen.unclaimedAmounts.pop();
              }

              else {
                console.warn("Ê£ÄÊµãÂà∞ÊóßÁâàÁ∫¢ÂåÖÔºåÂõûÈÄÄÂà∞ÊóßÁöÑÔºà‰∏çÂÖ¨Âπ≥ÔºâÈöèÊú∫ÁÆóÊ≥ï (triggerGroupAiAction)");
                const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                if (remainingCount === 1) {
                  claimedAmountAI = remainingAmount;
                } else {
                  const min = 0.01;
                  const max = remainingAmount - (remainingCount - 1) * min;
                  claimedAmountAI = Math.random() * (max - min) + min;
                }
              }

              claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
              if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
              packetToOpen.claimedBy[action.name] = claimedAmountAI;


              chat.history.push({
                role: 'system',
                type: 'pat_message',
                content: `${senderDisplayName} È¢ÜÂèñ‰∫Ü ${getDisplayNameInGroup(chat, packetToOpen.senderName)} ÁöÑÁ∫¢ÂåÖ`,
                timestamp: actionTimestamp++
              });


              let hiddenContentForAI = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${senderDisplayName}) ÊàêÂäüÊä¢Âà∞‰∫Ü ${claimedAmountAI.toFixed(2)} ÂÖÉ„ÄÇ`;
              if ((packetToOpen.unclaimedAmounts && packetToOpen.unclaimedAmounts.length === 0) || (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count)) {
                packetToOpen.isFullyClaimed = true;

                chat.history.push({
                  role: 'system',
                  type: 'pat_message',
                  content: `${getDisplayNameInGroup(chat, packetToOpen.senderName)} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå`,
                  timestamp: actionTimestamp++
                });

                let luckyKing = {
                  name: '',
                  amount: -1
                };
                Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                  if (amount > luckyKing.amount) {
                    luckyKing = {
                      name,
                      amount
                    };
                  }
                });
                if (luckyKing.name) {
                  const luckyKingDisplayName = getDisplayNameInGroup(chat, luckyKing.name);
                  hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºåÊâãÊ∞îÁéãÊòØ ${luckyKingDisplayName}ÔºÅ`;
                }
              }
              hiddenContentForAI += ' ËØ∑Ê†πÊçÆËøô‰∏™ÁªìÊûúÂèëË°®‰Ω†ÁöÑËØÑËÆ∫„ÄÇ]';
              chat.history.push({
                role: 'system',
                content: hiddenContentForAI,
                timestamp: actionTimestamp++,
                isHidden: true
              });
            }
          }
          hasPerformedMajorAction = true;
          continue;
        }


        switch (action.type) {
          case 'quote_reply': {
            let originalMessage = null;


            if (msgData.target_content) {
              originalMessage = [...chat.history].reverse().find(m =>
                !m.isHidden &&
                (
                  m.content === msgData.target_content ||
                  (typeof m.content === 'string' && m.content.trim() === msgData.target_content.trim())
                )
              );

              if (!originalMessage) {
                console.warn(`[Êú¨ËΩÆÂºïÁî®Â§±Ë¥•] AI ${msgData.name} Â∞ùËØïÂºïÁî®ÂÜÖÂÆπ "${(msgData.target_content || '').substring(0, 20)}..."Ôºå‰ΩÜÂú®Êú¨ËΩÆÂéÜÂè≤‰∏≠Êú™ÊâæÂà∞„ÄÇ`);
              }
            }


            else if (msgData.target_timestamp) {
              originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
            }


            if (originalMessage) {


              let quotedSenderDisplayName;

              if (originalMessage.role === 'user') {

                quotedSenderDisplayName = chat.settings.myNickname || 'Êàë';
              } else {

                if (chat.isGroup) {

                  quotedSenderDisplayName = getDisplayNameInGroup(chat, originalMessage.senderName);
                } else {

                  quotedSenderDisplayName = chat.name;
                }
              }

              const quoteContext = {
                timestamp: originalMessage.timestamp,
                senderName: quotedSenderDisplayName,

                content: String(originalMessage.content || '').substring(0, 50)
              };


              aiMessage = {
                ...baseMessage,
                content: msgData.reply_content,
                quote: quoteContext
              };
            } else {

              console.warn(`ÂºïÁî®ÂõûÂ§çÂ§±Ë¥•: Êâæ‰∏çÂà∞ÁõÆÊ†áÊ∂àÊÅØ (Content: ${msgData.target_content}, TS: ${msgData.target_timestamp})`);
              aiMessage = {
                ...baseMessage,
                content: msgData.reply_content
              };
            }
            break;
          }
          case 'sticker':
            if (action.meaning) {
              const sticker = findBestStickerMatch(action.meaning, state.userStickers);
              if (sticker) {
                aiMessage = {
                  ...baseMessage,
                  type: 'sticker',
                  content: sticker.url,
                  meaning: sticker.name
                };
              } else {
                console.warn(`AI (Áæ§ËÅäÂêéÂè∞) Â∞ùËØï‰ΩøÁî®‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${action.meaning}"`);
                aiMessage = null;
              }
            } else {
              console.warn("AI (Áæ§ËÅäÂêéÂè∞) ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ê≤°Êúâ 'meaning' ÁöÑ sticker Êåá‰ª§„ÄÇ", action);
              aiMessage = {
                ...baseMessage,
                type: 'sticker',
                content: action.url,
                meaning: 'Êú™Áü•Ë°®ÊÉÖ'
              };
            }
            break;
          case 'qzone_post':
            const newPost = {
              type: action.postType || 'shuoshuo',
              content: action.content,
              timestamp: Date.now(),
              authorId: state.chats[Object.keys(state.chats).find(key => state.chats[key].originalName === action.name)]?.id || action.name,
              authorOriginalName: action.name,
              visibleGroupIds: null
            };
            await db.qzonePosts.add(newPost);
            updateUnreadIndicator(unreadPostsCount + 1);
            visibleSystemMessage = {
              content: `[${senderDisplayName} ÂèëÂ∏É‰∫Ü‰∏ÄÊù°Êñ∞Âä®ÊÄÅ]`
            };
            break;
          case 'qzone_comment':
            const postToComment = await db.qzonePosts.get(parseInt(action.postId));
            if (postToComment) {
              if (!postToComment.comments) postToComment.comments = [];
              // Èò≤Âæ°ÔºöÂ¶ÇÊûúÊ®°ÂûãÈîôËØØÂú∞Â°´‰∫ÜÁî®Êà∑ÁöÑÂêçÂ≠óÔºåÂº∫Âà∂Á∫†Ê≠£‰∏∫ËßíËâ≤Êú¨Âêç
              const qzUserNickname = state.qzoneSettings?.nickname;
              let qzCommenterName = action.name || chat.originalName;
              if (qzUserNickname && qzCommenterName === qzUserNickname) {
                console.warn(`[Âä®ÊÄÅÈò≤Âæ°] ËßíËâ≤ "${chat.originalName}" ËØïÂõæÁî®Áî®Êà∑ÂêçÂ≠ó "${qzUserNickname}" ËØÑËÆ∫ÔºåÂ∑≤Á∫†Ê≠£`);
                qzCommenterName = chat.originalName;
              }
              postToComment.comments.push({
                commenterName: qzCommenterName,
                text: action.commentText,
                timestamp: Date.now()
              });
              await db.qzonePosts.update(postToComment.id, {
                comments: postToComment.comments
              });
              updateUnreadIndicator(unreadPostsCount + 1);
              visibleSystemMessage = {
                content: `[${senderDisplayName} ËØÑËÆ∫‰∫ÜÂä®ÊÄÅ]`
              };
            }
            break;
          case 'qzone_like':
            const postToLike = await db.qzonePosts.get(parseInt(action.postId));
            if (postToLike) {
              if (!postToLike.likes) postToLike.likes = [];
              if (!postToLike.likes.includes(action.name)) {
                postToLike.likes.push(action.name);
                await db.qzonePosts.update(postToLike.id, {
                  likes: postToLike.likes
                });
                updateUnreadIndicator(unreadPostsCount + 1);
                visibleSystemMessage = {
                  content: `[${senderDisplayName} ÁÇπËµû‰∫ÜÂä®ÊÄÅ]`
                };
              }
            }
            break;
          case 'ai_image':
            aiMessage = {
              ...baseMessage,
              type: 'ai_image',
              content: action.description,
              image_prompt: msgData.image_prompt
            };
            break;
          default:
            if (action.type === 'poll') {
              const pollOptions = typeof action.options === 'string' ?
                action.options.split('\n').filter(opt => opt.trim()) :
                (Array.isArray(action.options) ? action.options : []);
              if (pollOptions.length < 2) continue;
              aiMessage = {
                ...baseMessage,
                ...action,
                options: pollOptions,
                votes: {},
                isClosed: false
              };
            } else {
              const messageContent = action.content || action.message;
              aiMessage = {
                ...baseMessage,
                ...action
              };
              if (messageContent) aiMessage.content = messageContent;
            }
            break;
        }

        if (visibleSystemMessage) {
          chat.history.push({
            role: 'system',
            type: 'pat_message',
            content: visibleSystemMessage.content,
            timestamp: actionTimestamp++
          });
        } else if (aiMessage) {
          chat.history.push(aiMessage);
          if (!notificationSender) {
            notificationSender = senderDisplayName;
            notificationContent = aiMessage.type === 'ai_image' ? '[ÂõæÁâá]' : (aiMessage.content || `[${aiMessage.type}]`);
          }
        }
        hasPerformedMajorAction = true;
      }

      if (hasPerformedMajorAction) {
        chat.lastActionTimestamp = Date.now();
        chat.unreadCount = (chat.unreadCount || 0) + responseArray.filter(a => a.type !== 'qzone_post' && a.type !== 'qzone_comment' && a.type !== 'qzone_like').length;
        if (notificationSender && notificationContent) {
          showNotification(chatId, `${notificationSender}: ${notificationContent}`);
        }
        await db.chats.put(chat);
      }

    } catch (error) {
      console.error(`Áæ§ËÅä "${chat.name}" ÁöÑÁã¨Á´ãË°åÂä®Â§±Ë¥•:`, error);
    } finally {
      renderChatList();
    }
  }









  function applyScopedCss(cssString, scopeId, styleTagId) {
    const styleTag = document.getElementById(styleTagId);
    if (!styleTag) return;

    if (!cssString || cssString.trim() === '') {
      styleTag.innerHTML = '';
      return;
    }


    const scopedCss = cssString
      .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId} .message-bubble.user $1`)
      .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId} .message-bubble.ai $1`)
      .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId} .message-bubble $1`);

    styleTag.innerHTML = scopedCss;
  }


  async function updateSettingsPreview() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const previewArea = document.getElementById('settings-preview-area');
    if (!previewArea) return;


    const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
    const fontSize = document.getElementById('chat-font-size-slider').value;
    const customCss = document.getElementById('custom-css-input').value;
    const background = chat.settings.background;


    previewArea.dataset.theme = selectedTheme;
    previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);

    if (background && background.startsWith('data:image')) {
      previewArea.style.backgroundImage = `url(${background})`;
      previewArea.style.backgroundColor = 'transparent';
    } else {
      previewArea.style.backgroundImage = 'none';
      previewArea.style.background = background || '#f0f2f5';
    }


    previewArea.innerHTML = '';


    const aiMsg = {
      role: 'ai',
      content: 'ÂØπÊñπÊ∂àÊÅØÈ¢ÑËßà',
      timestamp: 1,
      senderName: chat.name
    };
    const aiBubble = await createMessageElement(aiMsg, chat);
    if (aiBubble) previewArea.appendChild(aiBubble);


    const userMsg = {
      role: 'user',
      content: 'ÊàëÁöÑÊ∂àÊÅØÈ¢ÑËßà',
      timestamp: 2
    };
    const userBubble = await createMessageElement(userMsg, chat);
    if (userBubble) previewArea.appendChild(userBubble);


    const previewLyricsBar = document.createElement('div');
    previewLyricsBar.style.cssText = `
                position: absolute; 
                font-size: 11px; 
                padding: 2px 6px; 
                border-radius: 8px; 
                background-color: rgba(0, 0, 0, 0.1); 
                color: var(--text-secondary); 
                white-space: nowrap; 
                transition: all 0.3s ease;
            `;
    previewLyricsBar.textContent = '‚ô™ Ê≠åËØç‰ΩçÁΩÆÈ¢ÑËßà ‚ô™';
    previewArea.appendChild(previewLyricsBar);

    const vertical = document.getElementById('lyrics-vertical-pos').value;
    const horizontal = document.getElementById('lyrics-horizontal-pos').value;
    const offset = parseInt(document.getElementById('lyrics-offset-input').value) || 10;

    if (vertical === 'top') {
      previewLyricsBar.style.top = `${offset}px`;
    } else {
      previewLyricsBar.style.bottom = `${offset}px`;
    }

    switch (horizontal) {
      case 'left':
        previewLyricsBar.style.left = '15px';
        break;
      case 'right':
        previewLyricsBar.style.right = '15px';
        break;
      default:
        previewLyricsBar.style.left = '50%';
        previewLyricsBar.style.transform = 'translateX(-50%)';
        break;
    }


    applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
  }




  async function openGroupManager() {
    await renderGroupList();
    document.getElementById('group-management-modal').classList.add('visible');
  }

  async function renderGroupList() {
    const listEl = document.getElementById('existing-groups-list');
    const groups = await db.qzoneGroups.toArray();
    listEl.innerHTML = '';
    if (groups.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁªÑ</p>';
    }
    groups.forEach(group => {
      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `
                    <span class="group-name">${group.name}</span>
                    <span class="delete-group-btn" data-id="${group.id}">√ó</span>
                `;
      listEl.appendChild(item);
    });
  }


  async function addNewGroup() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) {
      alert('ÂàÜÁªÑÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      return;
    }


    const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
    if (existingGroup) {
      alert(`ÂàÜÁªÑ "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºåÊç¢‰∏™ÂêçÂ≠óÂêßÔºÅ`);
      return;
    }


    await db.qzoneGroups.add({
      name
    });
    input.value = '';
    await renderGroupList();
  }


  async function deleteGroup(groupId) {
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Âà†Èô§ÂàÜÁªÑÂêéÔºåËØ•ÁªÑÂÜÖÁöÑÂ•ΩÂèãÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁªÑ‚Äù„ÄÇÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.qzoneGroups.delete(groupId);
      // Â∞ÜÂ±û‰∫éËØ•ÂàÜÁªÑÁöÑÂ•ΩÂèãÁöÑ groupId ËÆæ‰∏∫ null
      const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
      for (const chat of chatsToUpdate) {
        chat.groupId = null;
        await db.chats.put(chat);
        if (state.chats[chat.id]) state.chats[chat.id].groupId = null;
      }
      await renderGroupList();
    }
  }


  function showMessageActions(timestamp) {

    const chat = state.chats[state.activeChatId];
    document.getElementById('publish-to-announcement-btn').style.display = chat.isGroup ? 'block' : 'none';

    if (isSelectionMode) return;

    activeMessageTimestamp = timestamp;
    document.getElementById('message-actions-modal').classList.add('visible');
  }

  function hideMessageActions() {
    document.getElementById('message-actions-modal').classList.remove('visible');
    activeMessageTimestamp = null;
  }

  // ========== ÊéíÈô§/ÊÅ¢Â§çÊ∂àÊÅØ (ÁúÅToken) ==========
  async function toggleExcludeMessage() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const msg = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!msg) return;
    hideMessageActions();
    msg.isExcluded = !msg.isExcluded;
    await db.chats.put(chat);
    // Êõ¥Êñ∞DOM‰∏äÁöÑÊ†∑Âºè
    const wrapper = document.querySelector(`.message-bubble[data-timestamp="${msg.timestamp}"]`)?.closest('.message-wrapper');
    if (wrapper) {
      wrapper.classList.toggle('msg-excluded', msg.isExcluded);
    }
    console.log(`[ÊéíÈô§Ê∂àÊÅØ] timestamp=${msg.timestamp}, isExcluded=${msg.isExcluded}`);
  }

  async function toggleExcludeSelectedMessages() {
    if (selectedMessages.size === 0) return;
    const chat = state.chats[state.activeChatId];
    // Âà§Êñ≠ÔºöÂ¶ÇÊûúÈÄâ‰∏≠ÁöÑÊ∂àÊÅØ‰∏≠Êúâ‰ªª‰Ωï‰∏ÄÊù°Êú™ÊéíÈô§ÁöÑÔºåÂàôÂÖ®ÈÉ®ÊéíÈô§ÔºõÂê¶ÂàôÂÖ®ÈÉ®ÊÅ¢Â§ç
    const selectedMsgs = chat.history.filter(m => selectedMessages.has(m.timestamp));
    const hasAnyNotExcluded = selectedMsgs.some(m => !m.isExcluded);
    const newState = hasAnyNotExcluded; // true = ÊéíÈô§, false = ÊÅ¢Â§ç
    selectedMsgs.forEach(m => { m.isExcluded = newState; });
    await db.chats.put(chat);
    // Êõ¥Êñ∞DOM
    selectedMsgs.forEach(m => {
      const wrapper = document.querySelector(`.message-bubble[data-timestamp="${m.timestamp}"]`)?.closest('.message-wrapper');
      if (wrapper) wrapper.classList.toggle('msg-excluded', m.isExcluded);
    });
    const actionText = newState ? 'ÊéíÈô§' : 'ÊÅ¢Â§ç';
    console.log(`[ÊâπÈáèÊéíÈô§] ${actionText}‰∫Ü ${selectedMsgs.length} Êù°Ê∂àÊÅØ`);
    exitSelectionMode();
  }

  // ========== ÊâπÈáèÁÆ°ÁêÜÊéíÈô§Ê∂àÊÅØ (ËÅäÂ§©ËØ¶ÊÉÖÂÖ•Âè£) ==========
  let batchExcludeChecked = new Set();

  function openBatchExcludeManager() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    batchExcludeChecked = new Set();
    const listEl = document.getElementById('batch-exclude-list');
    // Âè™ÊòæÁ§∫ÈùûÁ≥ªÁªüÈöêËóèÁöÑÊ∂àÊÅØÔºàÁî®Êà∑ÂèØËßÅÁöÑÊ∂àÊÅØÔºâ
    const visibleMsgs = chat.history.filter(m => !m.isHidden);
    if (visibleMsgs.length === 0) {
      listEl.innerHTML = '<div style="text-align:center;color:#8a8a8a;padding:40px;">ÊöÇÊó†Ê∂àÊÅØ</div>';
    } else {
      listEl.innerHTML = '';
      visibleMsgs.forEach(msg => {
        const item = document.createElement('div');
        item.className = 'batch-exclude-item' + (msg.isExcluded ? ' is-excluded' : '');
        item.dataset.timestamp = msg.timestamp;
        const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (msg.senderName || chat.name);
        const time = new Date(msg.timestamp);
        const timeStr = `${time.getMonth()+1}/${time.getDate()} ${String(time.getHours()).padStart(2,'0')}:${String(time.getMinutes()).padStart(2,'0')}`;
        let preview = '';
        if (typeof msg.content === 'string') {
          preview = msg.content.substring(0, 60);
          if (msg.content.length > 60) preview += '...';
        } else if (msg.type === 'ai_image') preview = '[ÂõæÁâá]';
        else if (msg.type === 'voice_message') preview = '[ËØ≠Èü≥]';
        else if (msg.type === 'sticker') preview = '[Ë°®ÊÉÖ]';
        else if (msg.type === 'transfer') preview = '[ËΩ¨Ë¥¶]';
        else preview = '[Ê∂àÊÅØ]';
        item.innerHTML = `<div class="bei-checkbox"></div><div class="bei-content"><div class="bei-meta">${escapeHTML(sender)} ¬∑ ${timeStr}</div><div class="bei-text">${escapeHTML(preview)}</div></div>${msg.isExcluded ? '<span class="bei-tag">Â∑≤ÊéíÈô§</span>' : ''}`;
        item.addEventListener('click', () => {
          const ts = msg.timestamp;
          if (batchExcludeChecked.has(ts)) {
            batchExcludeChecked.delete(ts);
            item.classList.remove('checked');
          } else {
            batchExcludeChecked.add(ts);
            item.classList.add('checked');
          }
          document.getElementById('batch-exclude-selected-count').textContent = `Â∑≤ÈÄâ ${batchExcludeChecked.size} Êù°`;
        });
        listEl.appendChild(item);
      });
    }
    document.getElementById('batch-exclude-selected-count').textContent = 'Â∑≤ÈÄâ 0 Êù°';
    document.getElementById('batch-exclude-modal').classList.add('visible');
  }

  function closeBatchExcludeManager() {
    document.getElementById('batch-exclude-modal').classList.remove('visible');
    batchExcludeChecked = new Set();
  }

  function openExcludedDetailView() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    const listEl = document.getElementById('excluded-detail-list');
    const visibleMsgs = chat.history.filter(m => !m.isHidden);
    const hasExcluded = visibleMsgs.some(m => m.isExcluded);
    if (!hasExcluded) {
      listEl.innerHTML = '<div style="text-align:center;color:#8a8a8a;padding:40px;">ÂΩìÂâçÊ≤°ÊúâË¢´ÊéíÈô§ÁöÑÊ∂àÊÅØ</div>';
      document.getElementById('excluded-detail-modal').classList.add('visible');
      return;
    }
    // ÊääËøûÁª≠ÊéíÈô§ÁöÑÊ∂àÊÅØÂêàÂπ∂ÊàêËåÉÂõ¥
    const ranges = [];
    let currentRange = null;
    visibleMsgs.forEach((msg, idx) => {
      if (msg.isExcluded) {
        if (!currentRange) {
          currentRange = { startIdx: idx, endIdx: idx, msgs: [msg] };
        } else {
          currentRange.endIdx = idx;
          currentRange.msgs.push(msg);
        }
      } else {
        if (currentRange) { ranges.push(currentRange); currentRange = null; }
      }
    });
    if (currentRange) ranges.push(currentRange);

    function getMsgPreview(msg) {
      if (typeof msg.content === 'string') {
        const t = msg.content.substring(0, 40);
        return t + (msg.content.length > 40 ? '...' : '');
      }
      if (msg.type === 'ai_image') return '[ÂõæÁâá]';
      if (msg.type === 'voice_message') return '[ËØ≠Èü≥]';
      if (msg.type === 'sticker') return '[Ë°®ÊÉÖ]';
      if (msg.type === 'transfer') return '[ËΩ¨Ë¥¶]';
      return '[Ê∂àÊÅØ]';
    }
    function getSender(msg) {
      return msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (msg.senderName || chat.name);
    }
    function fmtTime(ts) {
      const t = new Date(ts);
      return `${t.getMonth()+1}/${t.getDate()} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
    }

    listEl.innerHTML = '';
    ranges.forEach((range, ri) => {
      const card = document.createElement('div');
      card.style.cssText = 'padding: 12px 15px; border-bottom: 1px solid var(--border-color, #eee);';
      const count = range.msgs.length;
      const isSingle = count === 1;
      // Ê†áÈ¢òË°åÔºöËåÉÂõ¥ + ÊÅ¢Â§çÊåâÈíÆ
      const header = document.createElement('div');
      header.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;';
      const label = document.createElement('div');
      label.style.cssText = 'font-size: 14px; font-weight: 500; color: var(--text-color);';
      if (isSingle) {
        label.textContent = `Á¨¨ ${range.startIdx + 1} Êù°`;
      } else {
        label.textContent = `Á¨¨ ${range.startIdx + 1} ~ ${range.endIdx + 1} Êù° (ÂÖ±${count}Êù°)`;
      }
      const restoreBtn = document.createElement('span');
      restoreBtn.textContent = 'ÊÅ¢Â§çÊ≠§Âå∫Èó¥';
      restoreBtn.style.cssText = 'color: var(--accent-color); font-size: 12px; cursor: pointer; white-space: nowrap;';
      restoreBtn.addEventListener('click', async () => {
        range.msgs.forEach(m => { m.isExcluded = false; });
        await db.chats.put(chat);
        card.remove();
        range.msgs.forEach(m => {
          const w = document.querySelector(`.message-bubble[data-timestamp="${m.timestamp}"]`)?.closest('.message-wrapper');
          if (w) w.classList.remove('msg-excluded');
        });
        if (!chat.history.some(m => m.isExcluded && !m.isHidden)) {
          listEl.innerHTML = '<div style="text-align:center;color:#8a8a8a;padding:40px;">ÂΩìÂâçÊ≤°ÊúâË¢´ÊéíÈô§ÁöÑÊ∂àÊÅØ</div>';
        }
        updateTokenCountDisplay();
      });
      header.appendChild(label);
      header.appendChild(restoreBtn);
      card.appendChild(header);
      // È¢ÑËßàÔºöÊòæÁ§∫È¶ñÂ∞æÊ∂àÊÅØ
      const previewDiv = document.createElement('div');
      previewDiv.style.cssText = 'font-size: 12px; color: var(--text-secondary); line-height: 1.6;';
      const first = range.msgs[0];
      const last = range.msgs[count - 1];
      let previewHtml = `${escapeHTML(getSender(first))}Ôºö${escapeHTML(getMsgPreview(first))}`;
      if (!isSingle) {
        previewHtml += `<br>...<br>${escapeHTML(getSender(last))}Ôºö${escapeHTML(getMsgPreview(last))}`;
      }
      previewHtml += `<div style="margin-top: 4px; font-size: 11px; color: #aaa;">${fmtTime(first.timestamp)}${isSingle ? '' : ' ~ ' + fmtTime(last.timestamp)}</div>`;
      previewDiv.innerHTML = previewHtml;
      card.appendChild(previewDiv);
      listEl.appendChild(card);
    });
    document.getElementById('excluded-detail-modal').classList.add('visible');
  }

  function closeExcludedDetailView() {
    document.getElementById('excluded-detail-modal').classList.remove('visible');
  }

  async function openTokenBreakdown() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    const body = document.getElementById('token-breakdown-body');
    body.innerHTML = '<div style="text-align:center;padding:30px;color:#8a8a8a;">ËÆ°ÁÆó‰∏≠...</div>';
    document.getElementById('token-breakdown-modal').classList.add('visible');

    const maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
    const linkedMemoryCount = parseInt(document.getElementById('linked-memory-count').value) || 10;
    const isOfflineMode = document.getElementById('offline-mode-toggle').checked;
    const aiPersona = document.getElementById('ai-persona').value;
    const myPersona = document.getElementById('my-persona').value;

    const parts = [];

    // 1. ‰∏ñÁïå‰π¶
    let worldBookStr = '';
    const linkedBookIds = Array.from(document.querySelectorAll('#world-book-checkboxes-container input:checked')).map(cb => cb.value.replace('book_', ''));
    const globalBookIds = state.worldBooks.filter(wb => wb.isGlobal).map(wb => wb.id);
    const allBookIds = [...new Set([...linkedBookIds, ...globalBookIds])];
    if (allBookIds.length > 0) {
      worldBookStr = allBookIds.map(bookId => {
        const wb = state.worldBooks.find(w => w.id === bookId);
        if (!wb || !Array.isArray(wb.content)) return '';
        return wb.content.filter(e => e.enabled !== false).map(e => e.content).join('\n');
      }).filter(Boolean).join('\n');
    }
    parts.push({ name: '‰∏ñÁïå‰π¶', tokens: estimateTokens(worldBookStr) });

    // 2. ËÆ∞ÂøÜ
    let memoryStr = '';
    if (chat.settings.enableStructuredMemory && window.structuredMemoryManager) {
      memoryStr = window.structuredMemoryManager.serializeForPrompt(chat);
    } else if (chat.longTermMemory && chat.longTermMemory.length > 0) {
      memoryStr = chat.longTermMemory.map(mem => mem.content).join('\n');
    }
    parts.push({ name: 'ÈïøÊúüËÆ∞ÂøÜ', tokens: estimateTokens(memoryStr) });

    // 3. ÂÖ≥ËÅîËÆ∞ÂøÜ
    let linkedStr = '';
    const linkedMemoryToggle = document.getElementById('link-memory-toggle').checked;
    if (linkedMemoryToggle) {
      const linkedChatIds = Array.from(document.querySelectorAll('#linked-chats-checkboxes-container input:checked')).map(cb => cb.value);
      for (const linkedId of linkedChatIds) {
        const linkedChat = state.chats[linkedId];
        if (linkedChat && linkedChat.history.length > 0) {
          linkedStr += linkedChat.history.slice(-linkedMemoryCount).map(msg => String(msg.content)).join('\n');
        }
      }
    }
    parts.push({ name: 'ÂÖ≥ËÅîËÆ∞ÂøÜ', tokens: estimateTokens(linkedStr) });

    // 4. ‰∫∫ËÆæÊèêÁ§∫ËØç
    let personaStr = '';
    if (chat.isGroup) {
      chat.members.forEach(member => { personaStr += member.persona; });
    } else {
      personaStr += aiPersona;
    }
    personaStr += myPersona;
    parts.push({ name: '‰∫∫ËÆæÊèêÁ§∫ËØç', tokens: estimateTokens(personaStr) });

    // 5. Ë°®ÊÉÖÂåÖ‰∏ä‰∏ãÊñá
    let stickerStr = getStickerContextForPrompt(chat);
    if (chat.isGroup) stickerStr += getGroupStickerContextForPrompt(chat);
    parts.push({ name: 'Ë°®ÊÉÖÂåÖ‰∏ä‰∏ãÊñá', tokens: estimateTokens(stickerStr) });

    // 6. Á¶ªÁ∫øÈ¢ÑËÆæ
    let offlineStr = '';
    if (!chat.isGroup && isOfflineMode) {
      const offlinePresetId = document.getElementById('offline-preset-select').value;
      if (offlinePresetId) {
        const preset = state.presets.find(p => p.id === offlinePresetId);
        if (preset) {
          offlineStr = preset.content.filter(e => e.enabled !== false).map(e => e.content).join('\n');
        }
      }
    }
    parts.push({ name: 'Á¶ªÁ∫øÈ¢ÑËÆæ', tokens: estimateTokens(offlineStr) });

    // 7. ËÅäÂ§©‰∏ä‰∏ãÊñá
    const historySlice = chat.history.filter(msg => !msg.isExcluded).slice(-maxMemory);
    const historyStr = historySlice.map(msg => {
      if (typeof msg.content === 'string') return msg.content;
      if (Array.isArray(msg.content)) return msg.content.map(p => p.text).join(' ');
      return '';
    }).join('\n');
    parts.push({ name: `ËÅäÂ§©‰∏ä‰∏ãÊñá (${historySlice.length}Êù°)`, tokens: estimateTokens(historyStr) });

    const totalTokens = parts.reduce((sum, p) => sum + p.tokens, 0);

    // Ê∏≤Êüì
    body.innerHTML = '';
    parts.forEach(part => {
      if (part.tokens === 0) return;
      const pct = totalTokens > 0 ? Math.round(part.tokens / totalTokens * 100) : 0;
      const row = document.createElement('div');
      row.style.cssText = 'padding: 12px 15px; border-bottom: 1px solid var(--border-color, #eee);';
      row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;"><span style="font-size:14px;color:var(--text-color);">${part.name}</span><span style="font-size:14px;font-weight:500;color:var(--text-color);">${part.tokens.toLocaleString()} Tokens</span></div><div style="height:6px;background:var(--secondary-bg,#f0f0f0);border-radius:3px;overflow:hidden;"><div style="height:100%;width:${pct}%;background:var(--accent-color);border-radius:3px;transition:width 0.3s;"></div></div><div style="text-align:right;font-size:11px;color:var(--text-secondary);margin-top:2px;">${pct}%</div>`;
      body.appendChild(row);
    });
    // ÊÄªËÆ°
    const totalRow = document.createElement('div');
    totalRow.style.cssText = 'padding: 12px 15px; display:flex; justify-content:space-between; align-items:center;';
    totalRow.innerHTML = `<span style="font-size:15px;font-weight:600;color:var(--text-color);">ÊÄªËÆ°</span><span style="font-size:15px;font-weight:600;color:var(--accent-color);">${totalTokens.toLocaleString()} Tokens</span>`;
    body.appendChild(totalRow);
  }

  function closeTokenBreakdown() {
    document.getElementById('token-breakdown-modal').classList.remove('visible');
  }

  async function batchExcludeAction(exclude) {
    if (batchExcludeChecked.size === 0) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    let count = 0;
    chat.history.forEach(m => {
      if (batchExcludeChecked.has(m.timestamp)) {
        m.isExcluded = exclude;
        count++;
      }
    });
    await db.chats.put(chat);
    closeBatchExcludeManager();
    renderChatInterface(state.activeChatId);
    updateTokenCountDisplay();
    console.log(`[ÊâπÈáèÁÆ°ÁêÜ] ${exclude ? 'ÊéíÈô§' : 'ÊÅ¢Â§ç'}‰∫Ü ${count} Êù°Ê∂àÊÅØ`);
  }

  // ÁøªËØëÊ∂àÊÅØÂÜÖÂÆπÂáΩÊï∞
  async function translateMessageContent() {
    if (!activeMessageTimestamp) return;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    hideMessageActions();

    // Ëé∑ÂèñË¶ÅÁøªËØëÁöÑÊñáÊú¨
    let textToTranslate;
    if (typeof message.content === 'object') {
      textToTranslate = JSON.stringify(message.content);
    } else {
      textToTranslate = String(message.content);
    }

    // Â¶ÇÊûúÊñáÊú¨‰∏∫Á©∫ÊàñÂ§™Áü≠Ôºå‰∏çÁøªËØë
    if (!textToTranslate || textToTranslate.trim().length === 0) {
      await showCustomAlert('ÁøªËØëÂ§±Ë¥•', 'Ê∂àÊÅØÂÜÖÂÆπ‰∏∫Á©∫ÔºåÊó†Ê≥ïÁøªËØë„ÄÇ');
      return;
    }

    try {
      // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
      await showCustomAlert('ÁøªËØë‰∏≠...', 'Ê≠£Âú®Ë∞ÉÁî®ÁøªËØëÊúçÂä°ÔºåËØ∑Á®çÂÄô...');

      // Â¶ÇÊûúÊñáÊú¨Â§™ÈïøÔºåÊà™ÂèñÂâç500Â≠óÁ¨¶
      const textToSend = textToTranslate.length > 500
        ? textToTranslate.substring(0, 500) + '...'
        : textToTranslate;

      // ÁÆÄÂçïÁöÑËØ≠Ë®ÄÊ£ÄÊµã
      function detectLanguage(text) {
        // Ê£ÄÊµãÊòØÂê¶ÂåÖÂê´‰∏≠ÊñáÂ≠óÁ¨¶
        if (/[\u4e00-\u9fa5]/.test(text)) {
          return 'zh-CN';
        }
        // Ê£ÄÊµãÊòØÂê¶ÂåÖÂê´Êó•ÊñáÂ≠óÁ¨¶
        if (/[\u3040-\u309f\u30a0-\u30ff]/.test(text)) {
          return 'ja';
        }
        // Ê£ÄÊµãÊòØÂê¶ÂåÖÂê´Èü©ÊñáÂ≠óÁ¨¶
        if (/[\uac00-\ud7af]/.test(text)) {
          return 'ko';
        }
        // Ê£ÄÊµãÊòØÂê¶ÂåÖÂê´‰øÑÊñáÂ≠óÁ¨¶
        if (/[\u0400-\u04ff]/.test(text)) {
          return 'ru';
        }
        // ÈªòËÆ§‰∏∫Ëã±Êñá
        return 'en';
      }

      const sourceLang = detectLanguage(textToSend);
      const targetLang = 'zh-CN'; // ÁõÆÊ†áËØ≠Ë®ÄÔºöÁÆÄ‰Ωì‰∏≠Êñá

      // Â¶ÇÊûúÊ£ÄÊµãÂà∞Â∑≤ÁªèÊòØ‰∏≠ÊñáÔºåÂ∞ùËØïÁøªËØëÊàêËã±Êñá
      const finalTargetLang = sourceLang === 'zh-CN' ? 'en' : 'zh-CN';

      const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToSend)}&langpair=${sourceLang}|${finalTargetLang}`;

      const response = await fetch(url);

      if (!response.ok) {
        throw new Error(`ÁøªËØëAPIËøîÂõûÈîôËØØ: ${response.status}`);
      }

      const data = await response.json();

      if (data.responseStatus !== 200) {
        throw new Error(data.responseDetails || 'ÁøªËØëÊúçÂä°ËøîÂõûÈîôËØØ');
      }

      const translatedText = data.responseData.translatedText;

      // ÊòæÁ§∫ÁøªËØëÁªìÊûú
      const langName = {
        'en': 'Ëã±Êñá',
        'ja': 'Êó•Êñá',
        'ko': 'Èü©Êñá',
        'ru': '‰øÑÊñá',
        'zh-CN': '‰∏≠Êñá'
      };

      await showCustomAlert(
        'ÁøªËØëÁªìÊûú',
        `Ê£ÄÊµãËØ≠Ë®ÄÔºö${langName[sourceLang] || sourceLang}\n\nÂéüÊñáÔºö\n${textToSend}\n\nËØëÊñáÔºö\n${translatedText}`
      );

    } catch (err) {
      console.error('ÁøªËØëÂ§±Ë¥•:', err);
      await showCustomAlert('ÁøªËØëÂ§±Ë¥•', `Êó†Ê≥ïÁøªËØëÊ∂àÊÅØÂÜÖÂÆπÔºö${err.message}\n\nÊèêÁ§∫ÔºöÊÇ®ÂèØ‰ª•Â∞ùËØï‰ΩøÁî®ÊµèËßàÂô®Ëá™Â∏¶ÁöÑÁøªËØëÂäüËÉΩ„ÄÇ`);
    }
  }



  async function openMessageEditor() {
    if (!activeMessageTimestamp) return;

    const timestampToEdit = activeMessageTimestamp;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideMessageActions();

    let contentForEditing;

    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'share_link'].includes(message.type);

    if (isSpecialType) {
      let fullMessageObject = {
        type: message.type
      };
      if (message.type === 'voice_message') fullMessageObject.content = message.content;
      else if (message.type === 'ai_image') fullMessageObject.description = message.content;
      else if (message.type === 'transfer') {
        fullMessageObject.amount = message.amount;
        fullMessageObject.note = message.note;
      } else if (message.type === 'share_link') {
        fullMessageObject.title = message.title;
        fullMessageObject.description = message.description;
        fullMessageObject.source_name = message.source_name;
        fullMessageObject.content = message.content;
      }
      contentForEditing = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
      contentForEditing = JSON.stringify(message.content, null, 2);
    } else {
      contentForEditing = message.content;
    }


    const templates = {
      voice: {
        type: 'voice_message',
        content: 'Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ'
      },
      image: {
        type: 'ai_image',
        description: 'Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞'
      },
      transfer: {
        type: 'transfer',
        amount: 5.20,
        note: '‰∏ÄÁÇπÂøÉÊÑè'
      },
      link: {
        type: 'share_link',
        title: 'ÊñáÁ´†Ê†áÈ¢ò',
        description: 'ÊñáÁ´†ÊëòË¶Å...',
        source_name: 'Êù•Ê∫êÁΩëÁ´ô',
        content: 'ÊñáÁ´†ÂÆåÊï¥ÂÜÖÂÆπ...'
      }
    };


    const helpersHtml = `
                <div class="format-helpers">
                    <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ËØ≠Èü≥</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâá</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ËΩ¨Ë¥¶</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>ÈìæÊé•</button>
                </div>
            `;

    const newContent = await showCustomPrompt(
      'ÁºñËæëÊ∂àÊÅØ',
      'Âú®Ê≠§‰øÆÊîπÔºåÊàñÁÇπÂáª‰∏äÊñπÊåâÈíÆ‰ΩøÁî®Ê†ºÂºèÊ®°Êùø...',
      contentForEditing,
      'textarea',
      helpersHtml
    );

    if (newContent !== null) {

      await saveEditedMessage(timestampToEdit, newContent, true);
    }
  }



  async function copyMessageContent() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    let textToCopy;
    if (typeof message.content === 'object') {
      textToCopy = JSON.stringify(message.content);
    } else {
      textToCopy = String(message.content);
    }

    try {
      await navigator.clipboard.writeText(textToCopy);
      await showCustomAlert('Â§çÂà∂ÊàêÂäü', 'Ê∂àÊÅØÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ');
    } catch (err) {
      await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
    }

    hideMessageActions();
  }



  async function copyMessageTimestamp() {
    if (!activeMessageTimestamp) return;

    try {
      await navigator.clipboard.writeText(activeMessageTimestamp);
      await showCustomAlert('Â§çÂà∂ÊàêÂäü', `Ê∂àÊÅØÊó∂Èó¥Êà≥ ${activeMessageTimestamp} Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ`);
    } catch (err) {
      await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
    }

    hideMessageActions();
  }



  function createMessageEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'message-editor-block';


    const templates = {
      voice: {
        type: 'voice_message',
        content: 'Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ'
      },
      image: {
        type: 'ai_image',
        description: 'Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞'
      },
      transfer: {
        type: 'transfer',
        amount: 5.20,
        note: '‰∏ÄÁÇπÂøÉÊÑè'
      },
      link: {
        type: 'share_link',
        title: 'ÊñáÁ´†Ê†áÈ¢ò',
        description: 'ÊñáÁ´†ÊëòË¶Å...',
        source_name: 'Êù•Ê∫êÁΩëÁ´ô',
        content: 'ÊñáÁ´†ÂÆåÊï¥ÂÜÖÂÆπ...'
      },
      offline: {
        type: 'offline_text',
        content: '„ÄåÂú®ËøôÈáåËæìÂÖ•ÂØπËØùÂÜÖÂÆπ„Äç\n(Âú®ËøôÈáåËæìÂÖ•Âä®‰ΩúÊàñÁéØÂ¢ÉÊèèÂÜô)'
      },
      quote: {
        type: 'quote_reply',
        target_timestamp: 1234567890,
        reply_content: 'Âú®ËøôÈáåËæìÂÖ•ÂõûÂ§çÂÜÖÂÆπ'
      },

      nai: {
        type: 'naiimag',
        prompt: '1girl, best quality, masterpiece, ...'
      },
      // „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëÔºöÊ∑ªÂä†ÊóÅÁôΩÊ®°Êùø
      narration: {
        type: 'narration',
        content: 'Âú®ËøôÈáåËæìÂÖ•ÁéØÂ¢ÉÊàñÂøÉÁêÜÊèèÂÜô...'
      }

    };

    block.innerHTML = `
        <button class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°">√ó</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ËØ≠Èü≥</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâá</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ËΩ¨Ë¥¶</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>ÈìæÊé•</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.offline)}'>Á∫ø‰∏ã</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.quote)}'>ÂºïÁî®</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.nai)}' style="color: #6a329f; border-color: #6a329f;">NAIÁîüÂõæ</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.narration)}' style="color: #888; border-color: #ccc;">ÊóÅÁôΩ</button>
            </div>
    `;


    block.querySelector('.delete-block-btn').addEventListener('click', () => {

      if (document.querySelectorAll('.message-editor-block').length > 1) {
        block.remove();
      } else {
        alert('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ');
      }
    });


    block.querySelectorAll('.format-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const templateStr = btn.dataset.template;
        const textarea = block.querySelector('textarea');
        if (templateStr && textarea) {
          try {
            const templateObj = JSON.parse(templateStr);
            textarea.value = JSON.stringify(templateObj, null, 2);
            textarea.focus();
          } catch (e) {
            console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e);
          }
        }
      });
    });

    return block;
  }




  async function openAdvancedMessageEditor() {
    if (!activeMessageTimestamp) return;

    const timestampToEdit = activeMessageTimestamp;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideMessageActions();

    const editorModal = document.getElementById('message-editor-modal');
    const editorContainer = document.getElementById('message-editor-container');
    editorContainer.innerHTML = '';

    let initialContent;

    if (message.quote) {

      const quoteReplyObject = {
        type: 'quote_reply',
        target_timestamp: message.quote.timestamp,
        reply_content: message.content
      };

      initialContent = JSON.stringify(quoteReplyObject, null, 2);
    }


    else if (message.type && ['voice_message', 'ai_image', 'transfer', 'offline_text', 'share_link', 'naiimag', 'narration'].includes(message.type)) {
      let fullMessageObject = {
        type: message.type
      };
      if (message.type === 'voice_message') fullMessageObject.content = message.content;
      else if (message.type === 'ai_image') fullMessageObject.description = message.content;
      else if (message.type === 'transfer') {
        fullMessageObject.amount = message.amount;
        fullMessageObject.note = message.note;
      } else if (message.type === 'offline_text') {
        if (message.content) {
          fullMessageObject.content = message.content;
        } else {
          fullMessageObject.dialogue = message.dialogue;
          fullMessageObject.description = message.description;
        }
      } else if (message.type === 'share_link') {
        fullMessageObject.title = message.title;
        fullMessageObject.description = message.description;
        fullMessageObject.source_name = message.source_name;
        fullMessageObject.content = message.content;
      }

      else if (message.type === 'naiimag') {
        fullMessageObject.prompt = message.prompt;

        fullMessageObject.fullPrompt = message.fullPrompt;
      }
      else if (message.type === 'narration') {
        fullMessageObject.content = message.content;
      }

      initialContent = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
      try {
        let safeContent = JSON.parse(JSON.stringify(message.content));
        if (Array.isArray(safeContent)) {
          safeContent.forEach(part => {

            if (part.type === 'image_url' && part.image_url && part.image_url.url && part.image_url.url.length > 500) {
              part.image_url.url = "BASE64_DATA_HIDDEN";
            }
          });
        }
        initialContent = JSON.stringify(safeContent, null, 2);
      } catch (e) {
        console.warn("Êó†Ê≥ïÂÆâÂÖ®Â§ÑÁêÜÊ∂àÊÅØÂÜÖÂÆπÔºåÂõûÈÄÄÂà∞ÂéüÂßãÊòæÁ§∫:", e);
        initialContent = JSON.stringify(message.content, null, 2);
      }
    } else {
      initialContent = message.content;
    }

    const firstBlock = createMessageEditorBlock(initialContent);
    editorContainer.appendChild(firstBlock);


    const addBtn = document.getElementById('add-message-editor-block-btn');
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    newAddBtn.addEventListener('click', () => {
      const newBlock = createMessageEditorBlock();
      editorContainer.appendChild(newBlock);
      newBlock.querySelector('textarea').focus();
    });

    const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    newCancelBtn.addEventListener('click', () => {
      editorModal.classList.remove('visible');
    });

    const saveBtn = document.getElementById('save-advanced-editor-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    newSaveBtn.addEventListener('click', () => {
      saveEditedMessage(timestampToEdit);
    });

    editorModal.classList.add('visible');
  }




  async function copyMessageContent() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    let textToCopy;

    if (message.type === 'offline_text') {

      if (message.content) {
        textToCopy = message.content;
      } else {
        textToCopy = `„Äå${message.dialogue || ''}„Äç\n${message.description || ''}`;
      }
    } else if (typeof message.content === 'object') {
      textToCopy = JSON.stringify(message.content);
    } else {
      textToCopy = String(message.content);
    }

    try {
      await navigator.clipboard.writeText(textToCopy);
      await showCustomAlert('Â§çÂà∂ÊàêÂäü', 'Ê∂àÊÅØÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ');
    } catch (err) {
      await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
    }

    hideMessageActions();
  }



  function parseEditedContent(text) {
    const trimmedText = text.trim();


    if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
      try {
        const parsed = JSON.parse(trimmedText);

        if (parsed.type) {
          return parsed;
        }
      } catch (e) {
      }
    }


    if (STICKER_REGEX.test(trimmedText)) {

      return {
        type: 'sticker',
        content: trimmedText
      };
    }


    return {
      type: 'text',
      content: trimmedText
    };
  }





  async function saveEditedMessage(timestamp, simpleContent = null) {
    if (!timestamp) return;

    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;


    const originalMessage = chat.history[messageIndex];

    let newMessages = [];


    const blocks = simpleContent !== null ?
      [simpleContent] :
      Array.from(document.querySelectorAll('#message-editor-container textarea')).map(ta => ta.value);

    for (const rawContent of blocks) {
      if (!rawContent.trim()) continue;


      const parsedResult = parseEditedContent(rawContent.trim());



      const newMessage = {
        role: originalMessage.role,
        senderName: originalMessage.senderName,
        timestamp: originalMessage.timestamp,
        isHidden: originalMessage.isHidden
      };



      switch (parsedResult.type) {
        case 'text':
          newMessage.type = 'text';
          newMessage.content = parsedResult.content;
          break;
        case 'offline_text':
          newMessage.type = 'offline_text';
          if (parsedResult.content) {
            newMessage.content = parsedResult.content;
          } else {
            newMessage.dialogue = parsedResult.dialogue;
            newMessage.description = parsedResult.description;
          }
          break;
        case 'quote_reply':
          newMessage.type = 'quote_reply';
          newMessage.content = parsedResult.reply_content;
          const originalQuotedMsg = chat.history.find(m => m.timestamp === parsedResult.target_timestamp);
          if (originalQuotedMsg) {
            let originalSenderName = originalQuotedMsg.senderName;
            if (originalQuotedMsg.role === 'user') {
              originalSenderName = state.qzoneSettings.nickname || '{{user}}';
            }
            newMessage.quote = {
              timestamp: parsedResult.target_timestamp,
              senderName: originalSenderName,
              content: String(originalQuotedMsg.content || '')
            };
          } else {
            newMessage.quote = {
              timestamp: parsedResult.target_timestamp,
              senderName: 'Êú™Áü•Áî®Êà∑',
              content: 'ÂéüÂßãÊ∂àÊÅØÂ∑≤Âà†Èô§Êàñ‰∏çÂ≠òÂú®'
            };
          }
          break;
        case 'voice_message':

        case 'ai_image':
        case 'user_photo':
          newMessage.type = parsedResult.type;
          newMessage.content = parsedResult.content || parsedResult.description;
          if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
          break;


        case 'naiimag': {
          const originalMsg = chat.history[messageIndex];
          let newPrompt = parsedResult.prompt;


          let newImageUrl = parsedResult.imageUrl;
          let newFullPrompt = parsedResult.fullPrompt;
          let promptChanged = false;


          if (newPrompt && typeof newPrompt === 'string' && originalMsg.prompt !== newPrompt) {
            promptChanged = true;
          } else {

            newPrompt = originalMsg.prompt;
            newFullPrompt = originalMsg.fullPrompt;
            newImageUrl = originalMsg.imageUrl;
          }

          if (promptChanged) {
            await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê£ÄÊµãÂà∞ÊèêÁ§∫ËØçÂ∑≤‰øÆÊîπÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàê NovelAI ÂõæÁâá...");
            try {

              const generatedData = await generateNaiImageFromPrompt(newPrompt, chat.id);
              newImageUrl = generatedData.imageUrl;
              newFullPrompt = generatedData.fullPrompt;
              await showCustomAlert("ÊàêÂäü", "ÂõæÁâáÂ∑≤Ê†πÊçÆÊñ∞ÊèêÁ§∫ËØçÈáçÊñ∞ÁîüÊàêÔºÅ");
            } catch (error) {
              console.error("ÁºñËæëÊó∂ÈáçÊñ∞ÁîüÊàêNAIÂõæÁâáÂ§±Ë¥•:", error);
              await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÈáçÊñ∞ÁîüÊàêÂõæÁâá: ${error.message}. \n\nÂ∞Ü‰øùÁïôÊóßÂõæÁâáÔºå‰ΩÜÊèêÁ§∫ËØç‰ºöÊõ¥Êñ∞„ÄÇ`);

              newImageUrl = originalMsg.imageUrl;
            }
          }


          newMessage.type = 'naiimag';
          newMessage.imageUrl = newImageUrl;
          newMessage.prompt = newPrompt;
          newMessage.fullPrompt = newFullPrompt;
          break;
        }

        case 'googleimag': {
          const originalGoogleMsg = chat.history[messageIndex];
          let googlePrompt = parsedResult.prompt;
          let googleImageUrl = parsedResult.imageUrl;
          let googleFullPrompt = parsedResult.fullPrompt;
          let googlePromptChanged = false;

          if (googlePrompt && typeof googlePrompt === 'string' && originalGoogleMsg.prompt !== googlePrompt) {
            googlePromptChanged = true;
          } else {
            googlePrompt = originalGoogleMsg.prompt;
            googleFullPrompt = originalGoogleMsg.fullPrompt;
            googleImageUrl = originalGoogleMsg.imageUrl;
          }

          if (googlePromptChanged) {
            await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê£ÄÊµãÂà∞ÊèêÁ§∫ËØçÂ∑≤‰øÆÊîπÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàê Google Imagen ÂõæÁâá...");
            try {
              const googleResult = await generateGoogleImagenFromPrompt(googlePrompt);
              googleImageUrl = googleResult.imageUrl;
              googleFullPrompt = googleResult.fullPrompt;
              await showCustomAlert("ÊàêÂäü", "ÂõæÁâáÂ∑≤Ê†πÊçÆÊñ∞ÊèêÁ§∫ËØçÈáçÊñ∞ÁîüÊàêÔºÅ");
            } catch (error) {
              console.error("ÁºñËæëÊó∂ÈáçÊñ∞ÁîüÊàêGoogle ImagenÂõæÁâáÂ§±Ë¥•:", error);
              await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÈáçÊñ∞ÁîüÊàêÂõæÁâá: ${error.message}. \n\nÂ∞Ü‰øùÁïôÊóßÂõæÁâáÔºå‰ΩÜÊèêÁ§∫ËØç‰ºöÊõ¥Êñ∞„ÄÇ`);
              googleImageUrl = originalGoogleMsg.imageUrl;
            }
          }

          newMessage.type = 'googleimag';
          newMessage.imageUrl = googleImageUrl;
          newMessage.prompt = googlePrompt;
          newMessage.fullPrompt = googleFullPrompt;
          break;
        }


        case 'sticker': {
          newMessage.type = 'sticker';
          let found = false;


          if (parsedResult.meaning) {

            const sticker = state.userStickers.find(s => s.name === parsedResult.meaning);
            if (sticker) {

              newMessage.content = sticker.url;
              newMessage.meaning = sticker.name;
              console.log("ÂØºÊºî/ÁºñËæëÊ®°Âºè‰øùÂ≠ò(Sticker): ‰ΩøÁî®‰∫Ü meaning Êü•Êâæ");
              found = true;
            } else {

              newMessage.type = 'text';
              newMessage.content = `[Ë°®ÊÉÖ: ${parsedResult.meaning}]`;
              console.warn("ÂØºÊºî/ÁºñËæëÊ®°Âºè‰øùÂ≠ò(Sticker): Êèê‰æõ‰∫Ü meaning ‰ΩÜÊú™ÊâæÂà∞ÂØπÂ∫îË°®ÊÉÖ:", parsedResult.meaning);
              found = true;
            }
          }



          if (!found && parsedResult.url) {
            newMessage.content = parsedResult.url;

            const stickerByURL = state.userStickers.find(s => s.url === parsedResult.url);

            if (parsedResult.meaning && (!stickerByURL || stickerByURL.name === parsedResult.meaning)) {
              newMessage.meaning = parsedResult.meaning;
            } else if (stickerByURL) {
              newMessage.meaning = stickerByURL.name;
            } else {
              newMessage.meaning = 'Êú™Áü•Ë°®ÊÉÖ';
            }
            console.log("ÂØºÊºî/ÁºñËæëÊ®°Âºè‰øùÂ≠ò(Sticker): ‰ΩøÁî®‰∫Ü URLÔºåÊúÄÁªà meaning:", newMessage.meaning);
            found = true;
          }


          if (!found && parsedResult.content && typeof parsedResult.content === 'string' && STICKER_REGEX.test(parsedResult.content)) {
            newMessage.content = parsedResult.content;

            const sticker = state.userStickers.find(s => s.url === parsedResult.content);
            newMessage.meaning = sticker ? sticker.name : 'Êú™Áü•Ë°®ÊÉÖ';
            console.log("ÂØºÊºî/ÁºñËæëÊ®°Âºè‰øùÂ≠ò(Sticker): Â∞Ü content ËßÜ‰∏∫ URLÔºåÊü•ÊâæÂà∞ meaning:", newMessage.meaning);
            found = true;
          }


          if (!found) {
            console.error("ÂØºÊºî/ÁºñËæëÊ®°Âºè‰øùÂ≠ò(Sticker): Êåá‰ª§Êó†ÊïàÊàñÁº∫Â∞ëÂøÖË¶ÅÂ≠óÊÆµ (meaning/url/content):", parsedResult);
            continue;
          }
          break;
        }
        case 'transfer':
          newMessage.type = 'transfer';
          newMessage.amount = parsedResult.amount;
          newMessage.note = parsedResult.note;
          break;
        case 'share_link':
          newMessage.type = 'share_link';
          newMessage.title = parsedResult.title;
          newMessage.description = parsedResult.description;
          newMessage.source_name = parsedResult.source_name;
          newMessage.content = parsedResult.content;
          break;
        default:

          Object.assign(newMessage, parsedResult);
          break;
      }

      newMessages.push(newMessage);
    }

    if (newMessages.length === 0) {
      document.getElementById('message-editor-modal').classList.remove('visible');
      return;
    }



    chat.history.splice(messageIndex, 1, ...newMessages);


    let reassignTimestamp = timestamp;
    for (let i = messageIndex; i < chat.history.length; i++) {
      chat.history[i].timestamp = reassignTimestamp;
      reassignTimestamp++;
    }

    await db.chats.put(chat);
    document.getElementById('message-editor-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    await showCustomAlert('ÊàêÂäü', 'Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞ÔºÅ');
  }



  function showPostActions(postId) {
    activePostId = postId;
    document.getElementById('post-actions-modal').classList.add('visible');
  }


  function hidePostActions() {
    document.getElementById('post-actions-modal').classList.remove('visible');
    activePostId = null;
  }


  async function openPostEditor() {
    if (!activePostId) return;

    const postIdToEdit = activePostId;
    const post = await db.qzonePosts.get(postIdToEdit);
    if (!post) return;

    hidePostActions();


    let contentForEditing;
    if (post.type === 'shuoshuo') {
      contentForEditing = post.content;
    } else {

      const postObject = {
        type: post.type,
        publicText: post.publicText || '',
      };
      if (post.type === 'image_post') {
        postObject.imageUrl = post.imageUrl;
        postObject.imageDescription = post.imageDescription;
      } else if (post.type === 'text_image') {
        postObject.hiddenContent = post.hiddenContent;
      }
      contentForEditing = JSON.stringify(postObject, null, 2);
    }


    const templates = {
      shuoshuo: "Âú®ËøôÈáåËæìÂÖ•ËØ¥ËØ¥ÁöÑÂÜÖÂÆπ...",
      image: {
        type: 'image_post',
        publicText: '',
        imageUrl: 'https://...',
        imageDescription: ''
      },
      text_image: {
        type: 'text_image',
        publicText: '',
        hiddenContent: ''
      }
    };

    const helpersHtml = `
                <div class="format-helpers">
                    <button class="format-btn" data-type="text">ËØ¥ËØ¥</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâáÂä®ÊÄÅ</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'>ÊñáÂ≠óÂõæ</button>
                </div>
            `;

    const newContent = await showCustomPrompt(
      'ÁºñËæëÂä®ÊÄÅ',
      'Âú®Ê≠§‰øÆÊîπÂÜÖÂÆπ...',
      contentForEditing,
      'textarea',
      helpersHtml
    );



    setTimeout(() => {
      const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
      if (shuoshuoBtn) {
        shuoshuoBtn.addEventListener('click', () => {
          const input = document.getElementById('custom-prompt-input');
          input.value = templates.shuoshuo;
          input.focus();
        });
      }
    }, 100);

    if (newContent !== null) {
      await saveEditedPost(postIdToEdit, newContent);
    }
  }


  async function saveEditedPost(postId, newRawContent) {
    const post = await db.qzonePosts.get(postId);
    if (!post) return;

    const trimmedContent = newRawContent.trim();


    try {
      const parsed = JSON.parse(trimmedContent);

      post.type = parsed.type || 'image_post';
      post.publicText = parsed.publicText || '';
      post.imageUrl = parsed.imageUrl || '';
      post.imageDescription = parsed.imageDescription || '';
      post.hiddenContent = parsed.hiddenContent || '';
      post.content = '';
    } catch (e) {

      post.type = 'shuoshuo';
      post.content = trimmedContent;

      post.publicText = '';
      post.imageUrl = '';
      post.imageDescription = '';
      post.hiddenContent = '';
    }

    await db.qzonePosts.put(post);
    await renderQzonePosts();
    await showCustomAlert('ÊàêÂäü', 'Âä®ÊÄÅÂ∑≤Êõ¥Êñ∞ÔºÅ');
  }


  async function copyPostContent() {
    if (!activePostId) return;
    const post = await db.qzonePosts.get(activePostId);
    if (!post) return;

    let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "ÔºàÊó†ÊñáÂ≠óÂÜÖÂÆπÔºâ";

    try {
      await navigator.clipboard.writeText(textToCopy);
      await showCustomAlert('Â§çÂà∂ÊàêÂäü', 'Âä®ÊÄÅÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ');
    } catch (err) {
      await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
    }

    hidePostActions();
  }


  let selectedContacts = new Set();

  async function openContactPickerForGroupCreate() {

    const choice = await showChoiceModal('ÂàõÂª∫Áæ§ËÅä', [{
      text: 'ÂàõÂª∫ÊôÆÈÄöÁæ§ËÅä (ÊàëÂèÇ‰∏é)',
      value: 'normal'
    },
    {
      text: 'ÂàõÂª∫ÊóÅËßÇÂçïËÅä (2‰∫∫ËÅäÂ§©)',
      value: 'spectator_private'
    },
    {
      text: 'ÂàõÂª∫ÊóÅËßÇÁæ§ËÅä (Â§ö‰∫∫Âõ¥ËßÇ)',
      value: 'spectator'
    }
    ]);

    if (choice === 'normal') {

      selectedContacts.clear();
      const confirmBtn = document.getElementById('confirm-contact-picker-btn');
      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      newConfirmBtn.addEventListener('click', handleCreateGroup);
      await renderContactPicker();
      showScreen('contact-picker-screen');

    } else if (choice === 'spectator') {

      openSpectatorGroupCreator();

    } else if (choice === 'spectator_private') {

      openSpectatorPrivateCreator();
    }
  }




  async function openSpectatorGroupCreator() {
    currentSpectatorMode = 'group';
    selectedContacts.clear();


    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleCreateSpectatorGroup);


    await renderSpectatorContactPicker();


    showScreen('contact-picker-screen');
  }

  async function openSpectatorPrivateCreator() {
    currentSpectatorMode = 'private';
    selectedContacts.clear();

    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleCreateSpectatorGroup);

    await renderSpectatorContactPicker();

    showScreen('contact-picker-screen');
  }
  async function renderSpectatorContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';


    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);

    const npcs = await db.npcs.toArray();

    if (characters.length === 0 && npcs.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">ËøòÊ≤°Êúâ‰ªª‰ΩïËßíËâ≤ÊàñNPCÂèØ‰ª•Âä†ÂÖ•Áæ§ËÅä„ÄÇ</p>';
      return;
    }


    characters.forEach(contact => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';
      item.dataset.contactId = contact.id;
      item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name} <small style="color:#888;">(ËßíËâ≤)</small></span>
        `;
      listEl.appendChild(item);
    });


    npcs.forEach(npc => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';
      item.dataset.contactId = npc.id;
      item.dataset.isNpc = "true";
      item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
            <span class="name">${npc.name} <small style="color:#007722;">(NPC)</small></span>
        `;
      listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
  }


  async function handleCreateSpectatorGroup() {

    if (currentSpectatorMode === 'private' && selectedContacts.size !== 2) {
      alert("ÊóÅËßÇÂçïËÅäÂøÖÈ°ªÈÄâÊã©„ÄêÊ≠£Â•Ω 2 ‰Ωç„ÄëÊàêÂëò„ÄÇ");
      return;
    }
    if (currentSpectatorMode === 'group' && selectedContacts.size < 2) {
      alert("ÊóÅËßÇÁæ§ËÅäËá≥Â∞ëÈúÄË¶ÅÈÄâÊã© 2 ‰∏™ÊàêÂëò„ÄÇ");
      return;
    }


    const groupName = await showCustomPrompt('ËÆæÁΩÆÁæ§Âêç', 'ËØ∑ËæìÂÖ•Áæ§ËÅäÁöÑÂêçÂ≠ó', 'AI‰ª¨ÁöÑËå∂ËØù‰ºö');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    const allNpcs = await db.npcs.toArray();

    for (const contactId of selectedContacts) {
      const isNpc = document.querySelector(`.contact-picker-item[data-contact-id="${contactId}"]`).dataset.isNpc === "true";

      if (isNpc) {

        const npcData = allNpcs.find(n => n.id === parseInt(contactId));
        if (npcData) {
          members.push({
            id: `npc_${npcData.id}`,
            originalName: npcData.name,
            groupNickname: npcData.name,
            persona: npcData.persona,
            avatar: npcData.avatar || defaultGroupMemberAvatar,
            isNpc: true
          });
        }
      } else {

        const contactChat = state.chats[contactId];
        if (contactChat) {
          members.push({
            id: contactId,
            originalName: contactChat.originalName,
            groupNickname: contactChat.name,
            persona: contactChat.settings.aiPersona,
            avatar: contactChat.settings.aiAvatar || defaultAvatar,
            isNpc: false
          });
        }
      }
    }

    const newGroupChat = {
      id: newChatId,
      name: groupName.trim(),
      isGroup: true,
      isSpectatorGroup: true,
      members: members,
      settings: {

        maxMemory: 10,
        groupAvatar: defaultGroupAvatar,
        background: '',
        theme: 'default',
        fontSize: 13,
        customCss: '',
        linkedWorldBookIds: [],
      },
      history: [{
        role: 'system',
        content: '[Á≥ªÁªüÊåá‰ª§ÔºöËøôÊòØ‰∏Ä‰∏™Ê≤°ÊúâÁî®Êà∑ÂèÇ‰∏éÁöÑÁæ§ËÅäÔºåËØ∑‰Ω†‰ª¨Ê†πÊçÆÂêÑËá™ÁöÑ‰∫∫ËÆæËá™Áî±Âú∞ÂºÄÂßãÂØπËØù„ÄÇ]',
        timestamp: Date.now(),
        isHidden: true
      }],
      musicData: {
        totalTime: 0
      }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);

    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId);
  }

  async function renderContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';


    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);
    const npcs = await db.npcs.toArray();

    if (characters.length === 0 && npcs.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">ËøòÊ≤°ÊúâÂèØ‰ª•ÊãâËøõÁæ§ÁöÑËÅîÁ≥ª‰∫∫Âì¶~</p>';
      return;
    }


    characters.forEach(contact => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';
      item.dataset.contactId = contact.id;
      item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name} <small style="color:#888;">(ËßíËâ≤)</small></span>
        `;
      listEl.appendChild(item);
    });


    npcs.forEach(npc => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';

      item.dataset.contactId = `npc_${npc.id}`;
      item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
            <span class="name">${npc.name} <small style="color:#007722;">(NPC)</small></span>
        `;
      listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
  }

  function updateContactPickerConfirmButton() {
    const btn = document.getElementById('confirm-contact-picker-btn');

    if (currentSpectatorMode === 'private') {

      btn.textContent = `ÂÆåÊàê(${selectedContacts.size}/2)`;
      btn.disabled = selectedContacts.size !== 2;
    } else {

      btn.textContent = `ÂÆåÊàê(${selectedContacts.size})`;
      btn.disabled = selectedContacts.size < 2;
    }
  }

  async function handleCreateGroup() {
    if (selectedContacts.size < 2) {
      alert("ÂàõÂª∫Áæ§ËÅäËá≥Â∞ëÈúÄË¶ÅÈÄâÊã©2‰∏™ËÅîÁ≥ª‰∫∫„ÄÇ");
      return;
    }

    const groupName = await showCustomPrompt('ËÆæÁΩÆÁæ§Âêç', 'ËØ∑ËæìÂÖ•Áæ§ËÅäÁöÑÂêçÂ≠ó', 'Êàë‰ª¨ÁöÑÁæ§ËÅä');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    const allNpcs = await db.npcs.toArray();

    for (const contactId of selectedContacts) {

      if (contactId.startsWith('npc_')) {
        const npcId = parseInt(contactId.replace('npc_', ''));
        const npcData = allNpcs.find(n => n.id === npcId);
        if (npcData) {
          members.push({
            id: contactId,
            originalName: npcData.name,
            groupNickname: npcData.name,
            persona: npcData.persona,
            avatar: npcData.avatar || defaultGroupMemberAvatar,
            isNpc: true
          });
        }
      } else {
        const contactChat = state.chats[contactId];
        if (contactChat) {
          members.push({
            id: contactId,
            originalName: contactChat.originalName,
            groupNickname: contactChat.name,
            persona: contactChat.settings.aiPersona,
            avatar: contactChat.settings.aiAvatar || defaultAvatar,
            isNpc: false
          });
        }
      }
    }

    const newGroupChat = {
      id: newChatId,
      name: groupName.trim(),
      isGroup: true,
      members: members,
      settings: {
        myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ',
        myNickname: 'Êàë',
        maxMemory: 10,
        groupAvatar: defaultGroupAvatar,
        myAvatar: defaultMyGroupAvatar,
        background: '',
        theme: 'default',
        fontSize: 13,
        customCss: '',
        linkedWorldBookIds: [],
      },
      history: [],
      musicData: {
        totalTime: 0
      }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);

    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId);
  }




  function openMemberManagementScreen() {
    if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
    renderMemberManagementList();
    showScreen('member-management-screen');
  }

  function renderMemberManagementList() {
    const listEl = document.getElementById('member-management-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    chat.members.forEach(member => {
      const item = document.createElement('div');
      item.className = 'member-management-item';

      item.innerHTML = `
                    <img src="${member.avatar}" class="avatar">
                    <span class="name">${member.groupNickname}</span>
                    <button class="remove-member-btn" data-member-id="${member.id}" title="ÁßªÂá∫Áæ§ËÅä">-</button>
                `;
      listEl.appendChild(item);
    });
  }

  /**
   * ‰ªéÁæ§ËÅä‰∏≠ÁßªÈô§‰∏Ä‰∏™ÊàêÂëò
   * @param {string} memberId - Ë¶ÅÁßªÈô§ÁöÑÊàêÂëòID
   */
  async function removeMemberFromGroup(memberId) {
    const chat = state.chats[state.activeChatId];
    const memberIndex = chat.members.findIndex(m => m.id === memberId);

    if (memberIndex === -1) return;


    if (chat.members.length <= 2) {
      alert("Áæ§ËÅä‰∫∫Êï∞‰∏çËÉΩÂ∞ë‰∫é2‰∫∫„ÄÇ");
      return;
    }

    const memberName = chat.members[memberIndex].groupNickname;
    const confirmed = await showCustomConfirm(
      'ÁßªÂá∫ÊàêÂëò',
      `Á°ÆÂÆöË¶ÅÂ∞Ü‚Äú${memberName}‚ÄùÁßªÂá∫Áæ§ËÅäÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    }
    );

    if (confirmed) {
      chat.members.splice(memberIndex, 1);
      await db.chats.put(chat);
      renderMemberManagementList();
      document.getElementById('chat-settings-btn').click();
    }
  }


  async function openContactPickerForAddMember() {

    const confirmBtn = document.getElementById('confirm-contact-picker-btn');

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleAddMembersToGroup);


    await renderUnifiedContactPicker();


    showScreen('contact-picker-screen');
  }


  async function renderUnifiedContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';
    selectedContacts.clear();

    const chat = state.chats[state.activeChatId];
    const existingMemberIds = new Set(chat.members.map(m => m.id));


    const characters = Object.values(state.chats).filter(c => !c.isGroup && !existingMemberIds.has(c.id));


    const npcs = (await db.npcs.toArray()).filter(n => !existingMemberIds.has(`npc_${n.id}`));

    if (characters.length === 0 && npcs.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">Ê≤°ÊúâÊõ¥Â§öÂèØ‰ª•ÈÇÄËØ∑ÁöÑËÅîÁ≥ª‰∫∫‰∫Ü„ÄÇ</p>';
      document.getElementById('confirm-contact-picker-btn').style.display = 'none';
    } else {
      document.getElementById('confirm-contact-picker-btn').style.display = 'block';


      characters.forEach(contact => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = contact.id;
        item.dataset.contactType = 'character';
        item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${contact.name} <small style="color:#888;">(ËßíËâ≤)</small></span>
            `;
        listEl.appendChild(item);
      });


      npcs.forEach(npc => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = `npc_${npc.id}`;
        item.dataset.contactType = 'npc';
        item.dataset.npcId = npc.id;
        item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
                <span class="name">${npc.name} <small style="color:#007722;">(NPC)</small></span>
            `;
        listEl.appendChild(item);
      });
    }

    updateContactPickerConfirmButton();
  }



  async function handleAddMembersToGroup() {
    if (selectedContacts.size === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÊ∑ªÂä†ÁöÑËÅîÁ≥ª‰∫∫„ÄÇ");
      return;
    }

    const chat = state.chats[state.activeChatId];
    const allNpcs = await db.npcs.toArray();

    for (const contactId of selectedContacts) {
      const itemEl = document.querySelector(`.contact-picker-item[data-contact-id="${contactId}"]`);
      if (!itemEl) continue;

      const contactType = itemEl.dataset.contactType;

      if (contactType === 'character') {
        const contactChat = state.chats[contactId];
        if (contactChat) {
          chat.members.push({
            id: contactId,
            originalName: contactChat.originalName,
            groupNickname: contactChat.name,
            persona: contactChat.settings.aiPersona,

            avatar: contactChat.settings.aiAvatar || defaultAvatar,
            isNpc: false
          });
        }
      } else if (contactType === 'npc') {
        const npcId = parseInt(itemEl.dataset.npcId);
        const npcData = allNpcs.find(n => n.id === npcId);
        if (npcData) {


          chat.members.push({
            id: `npc_${npcId}`,
            originalName: npcData.name,
            groupNickname: npcData.name,
            persona: npcData.persona,
            avatar: npcData.avatar || defaultGroupMemberAvatar,
            isNpc: true
          });
        }
      }
    }

    await db.chats.put(chat);


    openMemberManagementScreen();
  }



  function createNewMemberInGroup() {

    isAddingNpcToGroup = true;

    openNpcEditor(null);
  }



  function startWaimaiCountdown(element, endTime) {
    const timerId = setInterval(() => {
      const now = Date.now();
      const distance = endTime - now;

      if (distance < 0) {
        clearInterval(timerId);
        element.innerHTML = '<span>Â∑≤</span><span>Ë∂Ö</span><span>Êó∂</span>';
        return;
      }

      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      const minStr = String(minutes).padStart(2, '0');
      const secStr = String(seconds).padStart(2, '0');

      element.innerHTML = `<span>${minStr.charAt(0)}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(0)}</span><span>${secStr.charAt(1)}</span>`;
    }, 1000);
    return timerId;
  }

  function cleanupWaimaiTimers() {
    for (const timestamp in waimaiTimers) {
      clearInterval(waimaiTimers[timestamp]);
    }
    waimaiTimers = {};
  }




  async function showWaimaiDetails(timestamp) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const message = chat.history.find(m => m.timestamp === timestamp);

    if (!message || !['waimai_request', 'waimai_order'].includes(message.type)) {
      console.error("showWaimaiDetails: Êâæ‰∏çÂà∞Ê∂àÊÅØÊàñÊ∂àÊÅØÁ±ªÂûã‰∏çÊ≠£Á°Æ", timestamp);
      return;
    }

    let detailsHtml = '';

    if (message.type === 'waimai_request') {

      let statusText;
      switch (message.status) {
        case 'paid':
          const payerName = message.paidBy || 'ÂØπÊñπ';
          const payerDisplayName = getDisplayNameInGroup(chat, payerName);
          statusText = `Áî± ${payerDisplayName} ‰∏∫ÊÇ®‰ª£‰ªòÊàêÂäü`;
          break;
        case 'rejected':
          statusText = '‰ª£‰ªòËØ∑Ê±ÇÂ∑≤Ë¢´ÊãíÁªù';
          break;
        default:
          statusText = 'Á≠âÂæÖÂØπÊñπÂ§ÑÁêÜ';
          break;
      }
      detailsHtml = `
            <div style="text-align: left; font-size: 15px; line-height: 1.8;">
                <strong>ÂïÜÂìÅ:</strong> ${message.productInfo}<br>
                <strong>ÈáëÈ¢ù:</strong> ¬•${Number(message.amount).toFixed(2)}<br>
                <strong>Áä∂ÊÄÅ:</strong> ${statusText}
            </div>
        `;
    } else if (message.type === 'waimai_order') {

      let senderDisplayName;
      let recipientDisplayName;

      if (chat.isGroup) {

        senderDisplayName = getDisplayNameInGroup(chat, message.senderName);
        recipientDisplayName = getDisplayNameInGroup(chat, message.recipientName);
      } else {

        if (message.role === 'user') {

          senderDisplayName = chat.settings.myNickname || 'Êàë';
          recipientDisplayName = chat.name;
        } else {

          senderDisplayName = chat.name;
          recipientDisplayName = chat.settings.myNickname || 'Êàë';
        }
      }


      detailsHtml = `
            <div style="text-align: left; font-size: 15px; line-height: 1.8;">
                <strong>ËÆ¢ÂçïÁ±ªÂûã:</strong> ‰∏∫TAÁÇπÂçï<br>
                <strong>Ëµ†ÈÄÅÊñπ:</strong> ${senderDisplayName}<br>
                <strong>Êé•Êî∂Êñπ:</strong> ${recipientDisplayName}<br>
                <strong>ÂïÜÂìÅ:</strong> ${message.productInfo}<br>
                <strong>ÈáëÈ¢ù:</strong> ¬•${Number(message.amount).toFixed(2)}
            </div>
        `;
    }

    await showCustomAlert("ËÆ¢ÂçïËØ¶ÊÉÖ", detailsHtml);
  }


  async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;


    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;


    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

    if (choice === 'paid') {
      const success = await processTransaction(originalMessage.amount, 'expense', `Â∏Æ‰ªòÂ§ñÂçñ-${originalMessage.senderName}`);

      if (!success) return; // ‰ΩôÈ¢ù‰∏çË∂≥Ôºå‰∏çÊîπÂèòÁä∂ÊÄÅÔºåÁõ¥Êé•ËøîÂõû

      originalMessage.status = choice;
      originalMessage.paidBy = myNickname;
      systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ‰∏∫ ${originalMessage.senderName} ÁöÑÂ§ñÂçñËÆ¢ÂçïÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}ÔºâÂÆåÊàê‰∫ÜÊîØ‰ªò„ÄÇÊ≠§ËÆ¢ÂçïÂ∑≤ÂÖ≥Èó≠ÔºåÂÖ∂‰ªñÊàêÂëò‰∏çËÉΩÂÜçÊîØ‰ªò„ÄÇ]`;
    } else {
      originalMessage.status = choice;

      systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ÊãíÁªù‰∫Ü ${originalMessage.senderName} ÁöÑÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}Ôºâ„ÄÇ]`;
    }


    const systemNote = {
      role: 'system',
      content: systemContent,
      timestamp: Date.now(),
      isHidden: true
    };
    chat.history.push(systemNote);


    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
  }

  let videoCallState = {
    isActive: false,
    isAwaitingResponse: false,
    isGroupCall: false,
    activeChatId: null,
    initiator: null,
    startTime: null,
    participants: [],
    isUserParticipating: true,
    callHistory: [],
    preCallContext: ""
  };

  let voiceCallState = {
    isActive: false,
    isAwaitingResponse: false,
    isGroupCall: false,
    activeChatId: null,
    initiator: null,
    startTime: null,
    participants: [],
    isUserParticipating: true,
    callHistory: [],
    preCallContext: ""
  };

  let callTimerInterval = null;
  let voiceCallTimerInterval = null;


  async function handleInitiateCall() {
    if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;

    const chat = state.chats[state.activeChatId];
    videoCallState.isGroupCall = chat.isGroup;
    videoCallState.isAwaitingResponse = true;
    videoCallState.initiator = 'user';
    videoCallState.activeChatId = chat.id;
    videoCallState.isUserParticipating = true;


    if (chat.isGroup) {
      document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
      document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'Êàë';
    } else {
      document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
      document.getElementById('outgoing-call-name').textContent = chat.name;
    }
    document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "Ê≠£Âú®ÂëºÂè´ÊâÄÊúâÊàêÂëò..." : "Ê≠£Âú®ÂëºÂè´...";
    showScreen('outgoing-call-screen');


    const requestMessage = {
      role: 'system',
      content: chat.isGroup ?
        `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${chat.settings.myNickname || 'Êàë'}) ÂèëËµ∑‰∫ÜÁæ§ËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇËØ∑‰Ω†‰ª¨ÂêÑËá™ÂÜ≥Á≠ñÔºåÂπ∂‰ΩøÁî® "group_call_response" Êåá‰ª§ÔºåËÆæÁΩÆ "decision" ‰∏∫ "join" Êàñ "decline" Êù•ÂõûÂ∫î„ÄÇ]` :
        `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âêë‰Ω†ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÔºå‰ΩøÁî® "video_call_response" Êåá‰ª§ÔºåÂπ∂ËÆæÁΩÆ "decision" ‰∏∫ "accept" Êàñ "reject" Êù•ÂõûÂ∫î„ÄÇ]`,
      timestamp: Date.now(),
      isHidden: true,
    };
    chat.history.push(requestMessage);
    await db.chats.put(chat);


    await triggerAiResponse();
  }


  function startVideoCall() {
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    videoCallState.isActive = true;
    videoCallState.isAwaitingResponse = false;
    videoCallState.startTime = Date.now();
    videoCallState.callHistory = [];


    const preCallHistory = chat.history.slice(-10);
    videoCallState.preCallContext = preCallHistory.map(msg => {
      const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (msg.senderName || chat.name);
      return `${sender}: ${String(msg.content).substring(0, 50)}...`;
    }).join('\n');


    updateParticipantAvatars();

    document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? 'Áæ§ËÅäÂ∑≤Âª∫Á´ã...' : 'Ê≠£Âú®Êé•ÈÄö...'}</em>`;
    showScreen('video-call-screen');

    // Â∫îÁî®ËßÜÈ¢ëÈÄöËØù‰ºòÂåñËÆæÁΩÆ
    if (typeof window.applyVideoOptimizationToCall === 'function') {
      window.applyVideoOptimizationToCall(chat);
    }

    document.getElementById('user-speak-btn').style.display = videoCallState.isUserParticipating ? 'block' : 'none';
    document.getElementById('join-call-btn').style.display = videoCallState.isUserParticipating ? 'none' : 'block';

    if (callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(updateCallTimer, 1000);
    updateCallTimer();

    triggerAiInCallAction();
  }

  function minimizeVideoCall() {
    if (!videoCallState.isActive) return;


    document.getElementById('video-call-restore-btn').style.display = 'flex';


    showScreen('chat-interface-screen');


    console.log("ËßÜÈ¢ëÈÄöËØùÂ∑≤ÊúÄÂ∞èÂåñ„ÄÇ");
  }


  function restoreVideoCall() {
    if (!videoCallState.isActive) return;


    document.getElementById('video-call-restore-btn').style.display = 'none';


    showScreen('video-call-screen');
    console.log("ËßÜÈ¢ëÈÄöËØùÂ∑≤ÊÅ¢Â§ç„ÄÇ");
  }
  async function endVideoCall() {
    if (!videoCallState.isActive) return;
    stopTtsQueue();
    document.getElementById('video-call-restore-btn').style.display = 'none';
    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const durationText = `${Math.floor(duration / 60)}ÂàÜ${duration % 60}Áßí`;
    const endCallText = `ÈÄöËØùÁªìÊùüÔºåÊó∂Èïø ${durationText}`;

    const chat = state.chats[videoCallState.activeChatId];
    if (chat) {

      const participantsData = [];
      if (videoCallState.isGroupCall) {
        videoCallState.participants.forEach(p => participantsData.push({
          name: p.originalName,
          avatar: p.avatar
        }));
        if (videoCallState.isUserParticipating) {
          participantsData.unshift({
            name: chat.settings.myNickname || 'Êàë',
            avatar: chat.settings.myAvatar || defaultMyGroupAvatar
          });
        }
      } else {
        participantsData.push({
          name: chat.name,
          avatar: chat.settings.aiAvatar || defaultAvatar
        });
        participantsData.unshift({
          name: 'Êàë',
          avatar: chat.settings.myAvatar || defaultAvatar
        });
      }

      const callRecord = {
        chatId: videoCallState.activeChatId,
        timestamp: Date.now(),
        duration: duration,
        participants: participantsData,
        transcript: [...videoCallState.callHistory]
      };
      await db.callRecords.add(callRecord);
      console.log("ÈÄöËØùËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò:", callRecord);


      let summaryMessage = {
        role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
        content: endCallText,
        timestamp: Date.now(),
      };
      if (chat.isGroup && summaryMessage.role === 'assistant') {
        summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.originalName || chat.name;
      }
      chat.history.push(summaryMessage);






      const callTranscriptForAI = videoCallState.callHistory.map(h => {
        const sender = h.role === 'user' ? (chat.settings.myNickname || 'Êàë') : h.senderName;
        return `${sender}: ${h.content}`;
      }).join('\n');



      summarizeCallTranscript(chat.id, callTranscriptForAI);


      const hiddenReactionInstruction = {
        role: 'system',
        content: `[Á≥ªÁªüÊåá‰ª§ÔºöËßÜÈ¢ëÈÄöËØùÂàöÂàöÁªìÊùü„ÄÇËØ∑‰Ω†‰ª•ËßíËâ≤ÁöÑÂè£ÂêªÔºåÂêëÁî®Êà∑‰∏ªÂä®ÂèëÈÄÅ‰∏Ä‰∏§Êù°Ê∂àÊÅØÔºåÊù•Ëá™ÁÑ∂Âú∞ÊÄªÁªìËøôÊ¨°ÈÄöËØùÁöÑË¶ÅÁÇπ„ÄÅÁ°ÆËÆ§ËææÊàêÁöÑÁ∫¶ÂÆöÔºåÊàñËÄÖË°®Ëææ‰Ω†ÁöÑÊÑüÂèó„ÄÇ]`,
        timestamp: Date.now() + 1,
        isHidden: true
      };
      chat.history.push(hiddenReactionInstruction);


      await db.chats.put(chat);
    }


    clearInterval(callTimerInterval);
    callTimerInterval = null;

    // ÂÅúÊ≠¢ÊëÑÂÉèÂ§¥
    if (typeof stopCamera === 'function') {
      stopCamera();
    }

    videoCallState = {
      isActive: false,
      isAwaitingResponse: false,
      isGroupCall: false,
      activeChatId: null,
      initiator: null,
      startTime: null,
      participants: [],
      isUserParticipating: true,
      callHistory: [],
      preCallContext: ""
    };


    if (chat) {
      openChat(chat.id);
      triggerAiResponse();
    }
  }



  function updateParticipantAvatars() {
    const grid = document.getElementById('participant-avatars-grid');
    grid.innerHTML = '';
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    let participantsToRender = [];


    if (videoCallState.isGroupCall) {

      participantsToRender = [...videoCallState.participants];

      if (videoCallState.isUserParticipating) {
        participantsToRender.unshift({
          id: 'user',
          name: chat.settings.myNickname || 'Êàë',
          avatar: chat.settings.myAvatar || defaultMyGroupAvatar
        });
      }
    } else {

      participantsToRender.push({
        id: 'ai',
        name: chat.name,
        avatar: chat.settings.aiAvatar || defaultAvatar
      });
    }

    participantsToRender.forEach(p => {
      const wrapper = document.createElement('div');
      wrapper.className = 'participant-avatar-wrapper';
      wrapper.dataset.participantId = p.id;
      const displayName = p.groupNickname || p.name;
      wrapper.innerHTML = `
            <img src="${p.avatar}" class="participant-avatar" alt="${displayName}">
            <div class="participant-name">${displayName}</div>
        `;
      grid.appendChild(wrapper);
    });
  }


  function handleUserJoinCall() {
    if (!videoCallState.isActive || videoCallState.isUserParticipating) return;

    videoCallState.isUserParticipating = true;
    updateParticipantAvatars();


    document.getElementById('user-speak-btn').style.display = 'block';
    document.getElementById('join-call-btn').style.display = 'none';


    triggerAiInCallAction("[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âä†ÂÖ•‰∫ÜÈÄöËØù]");
  }



  function updateCallTimer() {
    if (!videoCallState.isActive) return;
    const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('call-timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }


  function showIncomingCallModal() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;


    if (chat.isGroup) {

      const requesterName = videoCallState.callRequester || chat.members[0]?.name || '‰∏Ä‰ΩçÊàêÂëò';
      document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
      document.getElementById('caller-name').textContent = chat.name;
      document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} ÈÇÄËØ∑‰Ω†Âä†ÂÖ•Áæ§ËßÜÈ¢ë`;
    } else {

      document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
      document.getElementById('caller-name').textContent = chat.name;
      document.querySelector('.incoming-call-content .caller-text').textContent = 'ÈÇÄËØ∑‰Ω†ËßÜÈ¢ëÈÄöËØù';
    }

    document.getElementById('incoming-call-modal').classList.add('visible');
  }



  function hideIncomingCallModal() {
    document.getElementById('incoming-call-modal').classList.remove('visible');
  }


  async function triggerAiInCallAction(userInput = null) {
    if (!videoCallState.isActive) return;

    const chat = state.chats[videoCallState.activeChatId];
    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    const callFeed = document.getElementById('video-call-main');
    const userNickname = chat.settings.myNickname || 'Êàë';

    let worldBookContent = '';
    // Ëé∑ÂèñÊâÄÊúâÂ∫îËØ•‰ΩøÁî®ÁöÑ‰∏ñÁïå‰π¶IDÔºàÂåÖÊã¨ÊâãÂä®ÈÄâÊã©ÁöÑÂíåÂÖ®Â±ÄÁöÑÔºâ
    let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
    // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
    state.worldBooks.forEach(wb => {
      if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
        allWorldBookIds.push(wb.id);
      }
    });

    if (allWorldBookIds.length > 0) {
      const linkedContents = allWorldBookIds.map(bookId => {
        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
        return worldBook && worldBook.content ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}` : '';
      }).filter(Boolean).join('');
      if (linkedContents) {
        worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ‚ÄúÁâ©ÁêÜÊ≥ïÂàô‚ÄùÂíå‚ÄúÂü∫Á°ÄÂ∏∏ËØÜ‚Äù„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
      }
    }
    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      `\n# ÈïøÊúüËÆ∞ÂøÜ (ÂøÖÈ°ªÂèÇËÄÉ)\n` + chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      '';

    if (userInput && videoCallState.isUserParticipating) {
      const userTimestamp = Date.now();
      const userBubble = document.createElement('div');
      userBubble.className = 'call-message-bubble user-speech';
      userBubble.textContent = userInput;
      userBubble.dataset.timestamp = userTimestamp;
      addLongPressListener(userBubble, () => showCallMessageActions(userTimestamp));
      callFeed.appendChild(userBubble);
      callFeed.scrollTop = callFeed.scrollHeight;

      // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®ÁúüÂÆûÊëÑÂÉèÂ§¥Âπ∂Ëé∑ÂèñÊà™Âõæ
      let userContent = userInput;
      if (chat.videoOptimization && chat.videoOptimization.enableRealCamera) {
        const capturedImage = window.getLastCameraCapture ? window.getLastCameraCapture() : null;
        if (capturedImage) {
          // ‰∏∫ÊîØÊåÅËßÜËßâÁöÑÊ®°ÂûãÊûÑÂª∫Â§öÊ®°ÊÄÅÊ∂àÊÅØ
          userContent = [
            { type: 'text', text: userInput },
            { type: 'image_url', image_url: { url: capturedImage } }
          ];
        }
      }

      videoCallState.callHistory.push({
        role: 'user',
        content: userContent,
        timestamp: userTimestamp
      });
    }


    let inCallPrompt;
    if (videoCallState.isGroupCall) {
      const participantNames = videoCallState.participants.map(p => p.name);
      if (videoCallState.isUserParticipating) {
        participantNames.unshift(userNickname);
      }
      inCallPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäËßÜÈ¢ëÈÄöËØùÁöÑÂØºÊºî„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîÊâÄÊúâ„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑAIËßíËâ≤ÔºåÂπ∂‰ª•„ÄêÁ¨¨‰∏â‰∫∫Áß∞ÊóÅËßÇËßÜËßí„ÄëÊù•ÊèèËø∞‰ªñ‰ª¨Âú®ÈÄöËØù‰∏≠ÁöÑÊâÄÊúâÂä®‰ΩúÂíåËØ≠Ë®Ä„ÄÇ
        # Ê†∏ÂøÉËßÑÂàô
        1.  **„ÄêË∫´‰ªΩÈìÅÂæã„Äë**: Áî®Êà∑ÁöÑË∫´‰ªΩÊòØ„Äê${userNickname}„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê \`name\` Â≠óÊÆµ‰∏∫ **"${userNickname}"** ÁöÑÂèëË®Ä„ÄÇ
        2.  **„ÄêËßÜËßíÈìÅÂæã„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚Äù„ÄÇ
        3.  **Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊØè‰∏™ÂØπË±°‰ª£Ë°®‰∏Ä‰∏™ËßíËâ≤ÁöÑÂèëË®ÄÔºåÊ†ºÂºè‰∏∫Ôºö\`{"name": "ËßíËâ≤Âêç", "speech": "*‰ªñÁ¨ë‰∫ÜÁ¨ë* Â§ßÂÆ∂Â•ΩÂïäÔºÅ"}\`„ÄÇ
        4.  **ËßíËâ≤ÊâÆÊºî**: ‰∏•Ê†ºÈÅµÂÆàÊØè‰∏™ËßíËâ≤ÁöÑËÆæÂÆö„ÄÇ
        # ÂΩìÂâçÊÉÖÊôØ
        ‰Ω†‰ª¨Ê≠£Âú®‰∏Ä‰∏™Áæ§ËßÜÈ¢ëÈÄöËØù‰∏≠„ÄÇ
         ${longTermMemoryContext}
        **ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å**:
        ${videoCallState.preCallContext}
        **ÂΩìÂâçÂèÇ‰∏éËÄÖ**: ${participantNames.join('„ÄÅ ')}„ÄÇ
        **ÈÄöËØùÂàöÂàöÂºÄÂßã...**
        ${worldBookContent}
        Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ„ÄêÈÄöËØùÂâçÊëòË¶Å„ÄëÂíå‰∏ãÈù¢ÁöÑ„ÄêÈÄöËØùÂÆûÊó∂ËÆ∞ÂΩï„ÄëÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ
        `;
    } else {
      let openingContext = videoCallState.initiator === 'user' ?
        `‰Ω†ÂàöÂàöÊé•Âê¨‰∫ÜÁî®Êà∑ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ` :
        `Áî®Êà∑ÂàöÂàöÊé•Âê¨‰∫Ü‰Ω†‰∏ªÂä®ÂèëËµ∑ÁöÑËßÜÈ¢ëÈÄöËØù„ÄÇ`;
      inCallPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Áé∞Âú®ÊòØ‰∏Ä‰∏™Âú∫ÊôØÊèèËø∞ÂºïÊìé„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî ${chat.name} (${chat.settings.aiPersona})ÔºåÂπ∂‰ª•„ÄêÁ¨¨‰∏â‰∫∫Áß∞ÊóÅËßÇËßÜËßí„ÄëÊù•ÊèèËø∞TAÂú®ËßÜÈ¢ëÈÄöËØù‰∏≠ÁöÑÊâÄÊúâÂä®‰ΩúÂíåËØ≠Ë®Ä„ÄÇ
        # Ê†∏ÂøÉËßÑÂàô
        1.  **„Äê„Äê„ÄêËßÜËßíÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚Äù„ÄÇÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞ÔºåÂ¶Ç‚Äú‰ªñ‚Äù„ÄÅ‚ÄúÂ•π‚Äù„ÄÅÊàñÁõ¥Êé•‰ΩøÁî®ËßíËâ≤Âêç‚Äú${chat.name}‚Äù„ÄÇ
        2.  **Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏ÄÊÆµÊèèËø∞ÊÄßÁöÑÊñáÊú¨„ÄÇ
        # ÂΩìÂâçÊÉÖÊôØ
        ‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑Ôºà${userNickname}Ôºå‰∫∫ËÆæ: ${chat.settings.myPersona}ÔºâËøõË°åËßÜÈ¢ëÈÄöËØù„ÄÇ
        ${longTermMemoryContext}
        **${openingContext}**
        **ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å (ËøôÊòØ‰Ω†‰ª¨ÈÄöËØùÁöÑÂéüÂõ†ÔºåËá≥ÂÖ≥ÈáçË¶ÅÔºÅ)**:
        ${videoCallState.preCallContext}
        Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ„ÄêÈÄöËØùÂâçÊëòË¶Å„ÄëÂíå‰∏ãÈù¢ÁöÑ„ÄêÈÄöËØùÂÆûÊó∂ËÆ∞ÂΩï„ÄëÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ
        `;
    }


    const messagesForApi = [{
      role: 'system',
      content: inCallPrompt
    },
    ...videoCallState.callHistory.map(h => ({
      role: h.role,
      content: h.content
    }))
    ];

    if (videoCallState.callHistory.length === 0) {
      const firstLineTrigger = videoCallState.initiator === 'user' ? `*‰Ω†Êåâ‰∏ã‰∫ÜÊé•Âê¨ÈîÆ...*` : `*ÂØπÊñπÊåâ‰∏ã‰∫ÜÊé•Âê¨ÈîÆ...*`;
      messagesForApi.push({
        role: 'user',
        content: firstLineTrigger
      });
    }

    try {
      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, inCallPrompt, messagesForApi)
      const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: model,
          messages: messagesForApi,
          temperature: state.globalSettings.apiTemperature || 0.8
        })
      });
      if (!response.ok) throw new Error((await response.json()).error.message);

      const data = await response.json();
      const aiResponse = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;

      const connectingElement = callFeed.querySelector('em');
      if (connectingElement) connectingElement.remove();
      if (videoCallState.isGroupCall) {
        const speechArray = parseAiResponse(aiResponse);
        speechArray.forEach(turn => {
          if (!turn.name || turn.name === userNickname || !turn.speech) return;
          const aiTimestamp = Date.now() + Math.random();
          const aiBubble = document.createElement('div');
          aiBubble.className = 'call-message-bubble ai-speech';
          aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
          aiBubble.dataset.timestamp = aiTimestamp;
          addLongPressListener(aiBubble, () => showCallMessageActions(aiTimestamp));
          callFeed.appendChild(aiBubble);
          videoCallState.callHistory.push({
            role: 'assistant',
            content: `${turn.name}: ${turn.speech}`,
            timestamp: aiTimestamp
          });

          const speaker = videoCallState.participants.find(p => p.name === turn.name);
          if (speaker) {
            const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
            if (speakingAvatar) {
              speakingAvatar.classList.add('speaking');
              setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
            }
          }
        });
      } else {
        const aiTimestamp = Date.now();
        const aiBubble = document.createElement('div');
        aiBubble.className = 'call-message-bubble ai-speech';
        aiBubble.textContent = aiResponse;
        aiBubble.dataset.timestamp = aiTimestamp;
        addLongPressListener(aiBubble, () => showCallMessageActions(aiTimestamp));
        callFeed.appendChild(aiBubble);
        videoCallState.callHistory.push({
          role: 'assistant',
          content: aiResponse,
          timestamp: aiTimestamp
        });
        const enableTts = chat.settings.enableTts !== false;
        const voiceId = chat.settings.minimaxVoiceId;

        if (enableTts && voiceId) {
          playVideoCallPureTTS(aiResponse, voiceId);
        }
        // ===============================================

        // ================= Â§¥ÂÉèÂä®Áîª‰øÆÂ§ç =================
        // ÂéüÂõ†ÔºöquerySelector ÈªòËÆ§Âè™ÈÄâÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºàÈÄöÂ∏∏ÊòØÁî®Êà∑Ëá™Â∑±ÔºâÔºåÂØºËá¥AIËØ¥ËØùÊó∂Áî®Êà∑Â§¥ÂÉèÂú®Âä®ÔºåÊàñËÄÖÊ†∑ÂºèÈîô‰Ωç„ÄÇ
        // ‰øÆÂ§çÔºöÂ¢ûÂä† [data-participant-id="ai"] Á≤æÁ°ÆÊü•ÊâæÂØπÊñπÁöÑÂ§¥ÂÉè„ÄÇ
        const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="ai"] .participant-avatar`);

        if (speakingAvatar) {
          speakingAvatar.classList.add('speaking');
          // Âä®ÊÄÅËÆ°ÁÆóËØ¥ËØùÊó∂ÈïøÔºöÊØèÂ≠ó200msÔºåÊúÄÈïø5Áßí
          const speakTime = Math.min(aiResponse.length * 200, 5000);
          setTimeout(() => speakingAvatar.classList.remove('speaking'), speakTime);
        }
      }

      callFeed.scrollTop = callFeed.scrollHeight;

    } catch (error) {
      const errorBubble = document.createElement('div');
      errorBubble.className = 'call-message-bubble ai-speech';
      errorBubble.style.color = '#ff8a80';
      errorBubble.textContent = `[ERROR: ${error.message}]`;
      callFeed.appendChild(errorBubble);
      callFeed.scrollTop = callFeed.scrollHeight;
      videoCallState.callHistory.push({
        role: 'assistant',
        content: `[ERROR: ${error.message}]`
      });
    }
  }



  function toggleCallButtons(isGroup) {
    document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
    document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
    document.getElementById('voice-call-btn').style.display = isGroup ? 'none' : 'flex';
    document.getElementById('group-voice-call-btn').style.display = isGroup ? 'flex' : 'none';
  }

  // ==================== ËØ≠Èü≥ÈÄöËØùÂäüËÉΩ ====================

  async function handleInitiateVoiceCall() {
    if (!state.activeChatId || voiceCallState.isActive || voiceCallState.isAwaitingResponse) return;

    const chat = state.chats[state.activeChatId];
    voiceCallState.isGroupCall = chat.isGroup;
    voiceCallState.isAwaitingResponse = true;
    voiceCallState.initiator = 'user';
    voiceCallState.activeChatId = chat.id;
    voiceCallState.isUserParticipating = true;

    if (chat.isGroup) {
      document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
      document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'Êàë';
    } else {
      document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
      document.getElementById('outgoing-call-name').textContent = chat.name;
    }
    document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "Ê≠£Âú®ÂëºÂè´ÊâÄÊúâÊàêÂëò..." : "Ê≠£Âú®ÂëºÂè´...";
    showScreen('outgoing-call-screen');

    const requestMessage = {
      role: 'system',
      content: chat.isGroup ?
        `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${chat.settings.myNickname || 'Êàë'}) ÂèëËµ∑‰∫ÜÁæ§ËØ≠Èü≥ÈÄöËØùËØ∑Ê±Ç„ÄÇËØ∑‰Ω†‰ª¨ÂêÑËá™ÂÜ≥Á≠ñÔºåÂπ∂‰ΩøÁî® "group_voice_response" Êåá‰ª§ÔºåËÆæÁΩÆ "decision" ‰∏∫ "join" Êàñ "decline" Êù•ÂõûÂ∫î„ÄÇ]` :
        `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âêë‰Ω†ÂèëËµ∑‰∫ÜËØ≠Èü≥ÈÄöËØùËØ∑Ê±Ç„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÔºå‰ΩøÁî® "voice_call_response" Êåá‰ª§ÔºåÂπ∂ËÆæÁΩÆ "decision" ‰∏∫ "accept" Êàñ "reject" Êù•ÂõûÂ∫î„ÄÇ]`,
      timestamp: Date.now(),
      isHidden: true,
    };
    chat.history.push(requestMessage);
    await db.chats.put(chat);

    await triggerAiResponse();
  }

  function startVoiceCall() {
    const chat = state.chats[voiceCallState.activeChatId];
    if (!chat) return;

    voiceCallState.isActive = true;
    voiceCallState.isAwaitingResponse = false;
    voiceCallState.startTime = Date.now();
    voiceCallState.callHistory = [];

    const preCallHistory = chat.history.slice(-10);
    voiceCallState.preCallContext = preCallHistory.map(msg => {
      const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (msg.senderName || chat.name);
      return `${sender}: ${String(msg.content).substring(0, 50)}...`;
    }).join('\n');

    updateVoiceParticipantAvatars();

    document.getElementById('voice-call-main').innerHTML = `<em>${voiceCallState.isGroupCall ? 'Áæ§ËÅäÂ∑≤Âª∫Á´ã...' : 'Ê≠£Âú®Êé•ÈÄö...'}</em>`;
    showScreen('voice-call-screen');

    document.getElementById('voice-user-speak-btn').style.display = voiceCallState.isUserParticipating ? 'block' : 'none';
    document.getElementById('voice-join-call-btn').style.display = voiceCallState.isUserParticipating ? 'none' : 'block';

    if (voiceCallTimerInterval) clearInterval(voiceCallTimerInterval);
    voiceCallTimerInterval = setInterval(updateVoiceCallTimer, 1000);
    updateVoiceCallTimer();

    triggerAiInVoiceCallAction();
  }

  function minimizeVoiceCall() {
    if (!voiceCallState.isActive) return;
    document.getElementById('voice-call-restore-btn').style.display = 'flex';
    showScreen('chat-interface-screen');
    console.log("ËØ≠Èü≥ÈÄöËØùÂ∑≤ÊúÄÂ∞èÂåñ„ÄÇ");
  }

  function restoreVoiceCall() {
    if (!voiceCallState.isActive) return;
    document.getElementById('voice-call-restore-btn').style.display = 'none';
    showScreen('voice-call-screen');
    console.log("ËØ≠Èü≥ÈÄöËØùÂ∑≤ÊÅ¢Â§ç„ÄÇ");
  }

  async function endVoiceCall() {
    if (!voiceCallState.isActive) return;
    stopTtsQueue();
    document.getElementById('voice-call-restore-btn').style.display = 'none';
    const duration = Math.floor((Date.now() - voiceCallState.startTime) / 1000);
    const durationText = `${Math.floor(duration / 60)}ÂàÜ${duration % 60}Áßí`;
    const endCallText = `ËØ≠Èü≥ÈÄöËØùÁªìÊùüÔºåÊó∂Èïø ${durationText}`;

    const chat = state.chats[voiceCallState.activeChatId];
    if (chat) {
      const participantsData = [];
      if (voiceCallState.isGroupCall) {
        voiceCallState.participants.forEach(p => participantsData.push({
          name: p.originalName,
          avatar: p.avatar
        }));
        if (voiceCallState.isUserParticipating) {
          participantsData.unshift({
            name: chat.settings.myNickname || 'Êàë',
            avatar: chat.settings.myAvatar || defaultMyGroupAvatar
          });
        }
      } else {
        participantsData.push({
          name: chat.name,
          avatar: chat.settings.aiAvatar || defaultAvatar
        });
        participantsData.unshift({
          name: 'Êàë',
          avatar: chat.settings.myAvatar || defaultAvatar
        });
      }

      const callRecord = {
        chatId: voiceCallState.activeChatId,
        timestamp: Date.now(),
        duration: duration,
        participants: participantsData,
        transcript: [...voiceCallState.callHistory],
        callType: 'voice'
      };
      await db.callRecords.add(callRecord);
      console.log("ËØ≠Èü≥ÈÄöËØùËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò:", callRecord);

      let summaryMessage = {
        role: voiceCallState.initiator === 'user' ? 'user' : 'assistant',
        content: endCallText,
        timestamp: Date.now(),
      };
      if (chat.isGroup && summaryMessage.role === 'assistant') {
        summaryMessage.senderName = voiceCallState.callRequester || chat.members[0]?.originalName || chat.name;
      }
      chat.history.push(summaryMessage);

      const callTranscriptForAI = voiceCallState.callHistory.map(h => {
        const sender = h.role === 'user' ? (chat.settings.myNickname || 'Êàë') : h.senderName;
        return `${sender}: ${h.content}`;
      }).join('\n');

      summarizeCallTranscript(chat.id, callTranscriptForAI);

      const hiddenReactionInstruction = {
        role: 'system',
        content: `[Á≥ªÁªüÊåá‰ª§ÔºöËØ≠Èü≥ÈÄöËØùÂàöÂàöÁªìÊùü„ÄÇËØ∑‰Ω†‰ª•ËßíËâ≤ÁöÑÂè£ÂêªÔºåÂêëÁî®Êà∑‰∏ªÂä®ÂèëÈÄÅ‰∏Ä‰∏§Êù°Ê∂àÊÅØÔºåÊù•Ëá™ÁÑ∂Âú∞ÊÄªÁªìËøôÊ¨°ÈÄöËØùÁöÑË¶ÅÁÇπ„ÄÅÁ°ÆËÆ§ËææÊàêÁöÑÁ∫¶ÂÆöÔºåÊàñËÄÖË°®Ëææ‰Ω†ÁöÑÊÑüÂèó„ÄÇ]`,
        timestamp: Date.now() + 1,
        isHidden: true
      };
      chat.history.push(hiddenReactionInstruction);

      await db.chats.put(chat);
    }

    clearInterval(voiceCallTimerInterval);
    voiceCallTimerInterval = null;

    voiceCallState = {
      isActive: false,
      isAwaitingResponse: false,
      isGroupCall: false,
      activeChatId: null,
      initiator: null,
      startTime: null,
      participants: [],
      isUserParticipating: true,
      callHistory: [],
      preCallContext: ""
    };

    if (chat) {
      openChat(chat.id);
      triggerAiResponse();
    }
  }

  function updateVoiceParticipantAvatars() {
    const grid = document.getElementById('voice-participant-avatars-grid');
    grid.innerHTML = '';
    const chat = state.chats[voiceCallState.activeChatId];
    if (!chat) return;

    let participantsToRender = [];

    if (voiceCallState.isGroupCall) {
      participantsToRender = [...voiceCallState.participants];
      if (voiceCallState.isUserParticipating) {
        participantsToRender.unshift({
          id: 'user',
          name: chat.settings.myNickname || 'Êàë',
          avatar: chat.settings.myAvatar || defaultMyGroupAvatar
        });
      }
    } else {
      participantsToRender.push({
        id: 'ai',
        name: chat.name,
        avatar: chat.settings.aiAvatar || defaultAvatar
      });
    }

    participantsToRender.forEach(p => {
      const wrapper = document.createElement('div');
      wrapper.className = 'participant-avatar-wrapper';
      wrapper.dataset.participantId = p.id;
      const displayName = p.groupNickname || p.name;
      wrapper.innerHTML = `
        <img src="${p.avatar}" class="participant-avatar" alt="${displayName}">
        <div class="participant-name">${displayName}</div>
      `;
      grid.appendChild(wrapper);
    });
  }

  function handleUserJoinVoiceCall() {
    if (!voiceCallState.isActive || voiceCallState.isUserParticipating) return;

    voiceCallState.isUserParticipating = true;
    updateVoiceParticipantAvatars();

    document.getElementById('voice-user-speak-btn').style.display = 'block';
    document.getElementById('voice-join-call-btn').style.display = 'none';

    triggerAiInVoiceCallAction("[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âä†ÂÖ•‰∫ÜÈÄöËØù]");
  }

  function updateVoiceCallTimer() {
    if (!voiceCallState.isActive) return;
    const elapsed = Math.floor((Date.now() - voiceCallState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('voice-call-timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }

  async function triggerAiInVoiceCallAction(userInput = null) {
    if (!voiceCallState.isActive) return;

    const chat = state.chats[voiceCallState.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    const callFeed = document.getElementById('voice-call-main');
    const userNickname = chat.settings.myNickname || 'Êàë';

    let worldBookContent = '';
    let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
    state.worldBooks.forEach(wb => {
      if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
        allWorldBookIds.push(wb.id);
      }
    });

    if (allWorldBookIds.length > 0) {
      const linkedContents = allWorldBookIds.map(bookId => {
        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
        return worldBook && worldBook.content ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}` : '';
      }).filter(Boolean).join('');
      if (linkedContents) {
        worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ"Áâ©ÁêÜÊ≥ïÂàô"Âíå"Âü∫Á°ÄÂ∏∏ËØÜ"„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
      }
    }
    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      `\n# ÈïøÊúüËÆ∞ÂøÜ (ÂøÖÈ°ªÂèÇËÄÉ)\n` + chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      '';

    if (userInput && voiceCallState.isUserParticipating) {
      const userTimestamp = Date.now();
      const userBubble = document.createElement('div');
      userBubble.className = 'call-message-bubble user-speech';
      userBubble.textContent = userInput;
      userBubble.dataset.timestamp = userTimestamp;
      addLongPressListener(userBubble, () => showCallMessageActions(userTimestamp));
      callFeed.appendChild(userBubble);
      callFeed.scrollTop = callFeed.scrollHeight;

      voiceCallState.callHistory.push({
        role: 'user',
        content: userInput,
        timestamp: userTimestamp
      });
    }

    let inCallPrompt;
    if (voiceCallState.isGroupCall) {
      const participantNames = voiceCallState.participants.map(p => p.name);
      if (voiceCallState.isUserParticipating) {
        participantNames.unshift(userNickname);
      }
      inCallPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäËØ≠Èü≥ÈÄöËØùÁöÑÂØºÊºî„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîÊâÄÊúâ„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑAIËßíËâ≤ÔºåÂπ∂ÁîüÊàê‰ªñ‰ª¨Âú®ÈÄöËØù‰∏≠ËØ¥ÁöÑËØù„ÄÇ

# „ÄêÊ†∏ÂøÉËßÑÂàô - ËØ≠Èü≥ÈÄöËØù‰∏ìÁî®„Äë
1. **„ÄêË∫´‰ªΩÈìÅÂæã„Äë**: Áî®Êà∑ÁöÑË∫´‰ªΩÊòØ„Äê${userNickname}„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê \`name\` Â≠óÊÆµ‰∏∫ **"${userNickname}"** ÁöÑÂèëË®Ä„ÄÇ
2. **„ÄêÁ∫ØÂØπËØùÈìÅÂæã„Äë**: ËøôÊòØËØ≠Èü≥ÈÄöËØùÔºå‰∏çÊòØËßÜÈ¢ëÈÄöËØù„ÄÇ‰Ω†‰ª¨Âè™ËÉΩÂê¨Âà∞Â£∞Èü≥ÔºåÁúã‰∏çÂà∞ÂØπÊñπ„ÄÇÂõ†Ê≠§Ôºö
   - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂè™ËÉΩÂåÖÂê´ËßíËâ≤ËØ¥ÁöÑËØù„Äë
   - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ªª‰ΩïÂä®‰ΩúÊèèÂÜôÔºàÂ¶ÇÔºö*Á¨ë‰∫ÜÁ¨ë*„ÄÅ*ÁÇπÂ§¥*„ÄÅ*Êå•Êâã*Á≠âÔºâ
   - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ªª‰ΩïË°®ÊÉÖÁ¨¶Âè∑ÔºàÂ¶ÇÔºöüòä„ÄÅ‚ù§Ô∏èÁ≠âÔºâ
   - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ªª‰ΩïËßÜËßâÁõ∏ÂÖ≥ÁöÑÊèèËø∞ÔºàÂ¶ÇÔºöÁúãËµ∑Êù•„ÄÅË°®ÊÉÖ„ÄÅÂä®‰ΩúÁ≠âÔºâ
3. **Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊØè‰∏™ÂØπË±°‰ª£Ë°®‰∏Ä‰∏™ËßíËâ≤ÁöÑÂèëË®ÄÔºåÊ†ºÂºè‰∏∫Ôºö\`{"name": "ËßíËâ≤Âêç", "speech": "Â§ßÂÆ∂Â•ΩÂïäÔºÅ"}\`„ÄÇ
4. **ËßíËâ≤ÊâÆÊºî**: ‰∏•Ê†ºÈÅµÂÆàÊØè‰∏™ËßíËâ≤ÁöÑËÆæÂÆö„ÄÇ

# ÂΩìÂâçÊÉÖÊôØ
‰Ω†‰ª¨Ê≠£Âú®‰∏Ä‰∏™Áæ§ËØ≠Èü≥ÈÄöËØù‰∏≠„ÄÇ‰Ω†‰ª¨Âè™ËÉΩÈÄöËøáÂ£∞Èü≥‰∫§ÊµÅÔºåÁúã‰∏çÂà∞ÂΩºÊ≠§„ÄÇ
${longTermMemoryContext}
**ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å**:
${voiceCallState.preCallContext}
**ÂΩìÂâçÂèÇ‰∏éËÄÖ**: ${participantNames.join('„ÄÅ ')}„ÄÇ
**ÈÄöËØùÂàöÂàöÂºÄÂßã...**
${worldBookContent}
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ„ÄêÈÄöËØùÂâçÊëòË¶Å„ÄëÂíå‰∏ãÈù¢ÁöÑ„ÄêÈÄöËØùÂÆûÊó∂ËÆ∞ÂΩï„ÄëÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇËÆ∞‰ΩèÔºöÂè™ËæìÂá∫ÂØπËØùÂÜÖÂÆπÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÂä®‰ΩúÊàñË°®ÊÉÖÊèèÂÜô„ÄÇ
`;
    } else {
      let openingContext = voiceCallState.initiator === 'user' ?
        `‰Ω†ÂàöÂàöÊé•Âê¨‰∫ÜÁî®Êà∑ÁöÑËØ≠Èü≥ÈÄöËØùËØ∑Ê±Ç„ÄÇ` :
        `Áî®Êà∑ÂàöÂàöÊé•Âê¨‰∫Ü‰Ω†‰∏ªÂä®ÂèëËµ∑ÁöÑËØ≠Èü≥ÈÄöËØù„ÄÇ`;
      inCallPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Áé∞Âú®Ê≠£Âú®ÂíåÁî®Êà∑ËøõË°åËØ≠Èü≥ÈÄöËØù„ÄÇ‰Ω†ÊâÆÊºî ${chat.name} (${chat.settings.aiPersona})„ÄÇ

# „ÄêÊ†∏ÂøÉËßÑÂàô - ËØ≠Èü≥ÈÄöËØù‰∏ìÁî®„Äë
1. **„ÄêÁ∫ØÂØπËØùÈìÅÂæã„Äë**: ËøôÊòØËØ≠Èü≥ÈÄöËØùÔºå‰∏çÊòØËßÜÈ¢ëÈÄöËØù„ÄÇ‰Ω†‰ª¨Âè™ËÉΩÂê¨Âà∞Â£∞Èü≥ÔºåÁúã‰∏çÂà∞ÂØπÊñπ„ÄÇÂõ†Ê≠§Ôºö
   - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂè™ËÉΩÂåÖÂê´‰Ω†ËØ¥ÁöÑËØù„Äë
   - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ªª‰ΩïÂä®‰ΩúÊèèÂÜôÔºàÂ¶ÇÔºö*Á¨ë‰∫ÜÁ¨ë*„ÄÅ*ÁÇπÂ§¥*„ÄÅ*Êå•Êâã*„ÄÅ*ÁúãÁùÄ‰Ω†*Á≠âÔºâ
   - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ªª‰ΩïË°®ÊÉÖÁ¨¶Âè∑ÔºàÂ¶ÇÔºöüòä„ÄÅ‚ù§Ô∏è„ÄÅüòÇÁ≠âÔºâ
   - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ªª‰ΩïËßÜËßâÁõ∏ÂÖ≥ÁöÑÊèèËø∞ÔºàÂ¶ÇÔºöÁúãËµ∑Êù•„ÄÅË°®ÊÉÖ„ÄÅÁúºÁ•û„ÄÅÂä®‰ΩúÁ≠âÔºâ
   - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®ÊòüÂè∑*ÊàñÂÖ∂‰ªñÁ¨¶Âè∑Êù•ÊèèËø∞Âä®‰Ωú
2. **„ÄêËßíËâ≤ËÆ§Áü•„Äë**: ‰Ω†Áü•ÈÅìËøôÊòØËØ≠Èü≥ÈÄöËØùÔºå‰Ω†Áúã‰∏çÂà∞Áî®Êà∑ÔºåÁî®Êà∑‰πüÁúã‰∏çÂà∞‰Ω†„ÄÇ‰Ω†‰ª¨Âè™ËÉΩÈÄöËøáÂ£∞Èü≥‰∫§ÊµÅ„ÄÇ
3. **„ÄêÂ§öÂè•ÂèëË®Ä„Äë**: ‰Ω†ÂèØ‰ª•‰∏ÄÊ¨°ËØ¥Â§öÂè•ËØùÔºåÊØèÂè•ËØù‰ºöÊòæÁ§∫‰∏∫Áã¨Á´ãÁöÑÊ∞îÊ≥°„ÄÇÊ†ºÂºèÔºö
   - Â¶ÇÊûúÂè™ËØ¥‰∏ÄÂè•ËØùÔºöÁõ¥Êé•ËøîÂõûÁ∫ØÊñáÊú¨ÔºåÂ¶Ç "ÂñÇÔºå‰Ω†Â•ΩÂïäÔºÅ"
   - Â¶ÇÊûúË¶ÅËØ¥Â§öÂè•ËØùÔºöËøîÂõûJSONÊï∞ÁªÑÔºåÂ¶Ç [{"type": "text", "content": "ÂñÇÔºå‰Ω†Â•ΩÂïäÔºÅ"}, {"type": "text", "content": "ÊúÄËøëÊÄé‰πàÊ†∑Ôºü"}]
4. **Ê†ºÂºèÁÅµÊ¥ªÊÄß**: ‰Ω†ÂèØ‰ª•Ê†πÊçÆÊÉÖÂÜµÈÄâÊã©ÂçïÂè•ÔºàÁ∫ØÊñáÊú¨ÔºâÊàñÂ§öÂè•ÔºàJSONÊï∞ÁªÑÔºâÊ†ºÂºè„ÄÇ

# ÂΩìÂâçÊÉÖÊôØ
‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑Ôºà${userNickname}Ôºå‰∫∫ËÆæ: ${chat.settings.myPersona}ÔºâËøõË°åËØ≠Èü≥ÈÄöËØù„ÄÇ‰Ω†‰ª¨Âè™ËÉΩÈÄöËøáÂ£∞Èü≥‰∫§ÊµÅÔºåÁúã‰∏çÂà∞ÂΩºÊ≠§„ÄÇ
${longTermMemoryContext}
**${openingContext}**
**ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å (ËøôÊòØ‰Ω†‰ª¨ÈÄöËØùÁöÑÂéüÂõ†ÔºåËá≥ÂÖ≥ÈáçË¶ÅÔºÅ)**:
${voiceCallState.preCallContext}
${worldBookContent}
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ„ÄêÈÄöËØùÂâçÊëòË¶Å„ÄëÂíå‰∏ãÈù¢ÁöÑ„ÄêÈÄöËØùÂÆûÊó∂ËÆ∞ÂΩï„ÄëÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇËÆ∞‰ΩèÔºöÂè™ËæìÂá∫ÂØπËØùÂÜÖÂÆπÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÂä®‰Ωú„ÄÅË°®ÊÉÖÊàñËßÜËßâÊèèÂÜô„ÄÇ
`;
    }

    const messagesForApi = [{
      role: 'system',
      content: inCallPrompt
    },
    ...voiceCallState.callHistory.map(h => ({
      role: h.role,
      content: h.content
    }))
    ];

    if (voiceCallState.callHistory.length === 0) {
      const firstLineTrigger = voiceCallState.initiator === 'user' ? `ÂñÇÔºü` : `ÂñÇÔºå‰Ω†Â•ΩÔºü`;
      messagesForApi.push({
        role: 'user',
        content: firstLineTrigger
      });
    }

    try {
      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, inCallPrompt, messagesForApi)
      const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: model,
          messages: messagesForApi,
          temperature: state.globalSettings.apiTemperature || 0.8
        })
      });
      if (!response.ok) throw new Error((await response.json()).error.message);

      const data = await response.json();
      const aiResponse = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;

      const connectingElement = callFeed.querySelector('em');
      if (connectingElement) connectingElement.remove();

      if (voiceCallState.isGroupCall) {
        const speechArray = parseAiResponse(aiResponse);
        speechArray.forEach(turn => {
          if (!turn.name || turn.name === userNickname || !turn.speech) return;
          const aiTimestamp = Date.now() + Math.random();
          const aiBubble = document.createElement('div');
          aiBubble.className = 'call-message-bubble ai-speech';
          aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
          aiBubble.dataset.timestamp = aiTimestamp;
          addLongPressListener(aiBubble, () => showCallMessageActions(aiTimestamp));
          callFeed.appendChild(aiBubble);
          voiceCallState.callHistory.push({
            role: 'assistant',
            content: `${turn.name}: ${turn.speech}`,
            timestamp: aiTimestamp
          });

          const speaker = voiceCallState.participants.find(p => p.name === turn.name);
          if (speaker) {
            const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
            if (speakingAvatar) {
              speakingAvatar.classList.add('speaking');
              setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
            }
          }
        });
      } else {
        // ÂçïËÅäÊ®°ÂºèÔºöÊîØÊåÅÂ§öÊù°Ê∂àÊÅØ
        const enableTts = chat.settings.enableTts !== false;
        const voiceId = chat.settings.minimaxVoiceId;

        // Â∞ùËØïËß£Êûê‰∏∫JSONÊï∞ÁªÑÔºàÂ§öÊù°Ê∂àÊÅØÔºâ
        const messagesArray = parseAiResponse(aiResponse);

        messagesArray.forEach((msg, index) => {
          const messageContent = msg.content || msg.speech || aiResponse;
          const aiTimestamp = Date.now() + index;

          const aiBubble = document.createElement('div');
          aiBubble.className = 'call-message-bubble ai-speech';
          aiBubble.textContent = messageContent;
          aiBubble.dataset.timestamp = aiTimestamp;
          addLongPressListener(aiBubble, () => showCallMessageActions(aiTimestamp));
          callFeed.appendChild(aiBubble);

          voiceCallState.callHistory.push({
            role: 'assistant',
            content: messageContent,
            timestamp: aiTimestamp
          });

          // ‰∏∫ÊØèÊù°Ê∂àÊÅØÊí≠ÊîæTTS
          if (enableTts && voiceId) {
            playVideoCallPureTTS(messageContent, voiceId);
          }
        });

        const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="ai"] .participant-avatar`);
        if (speakingAvatar) {
          speakingAvatar.classList.add('speaking');
          const totalLength = messagesArray.reduce((sum, msg) => sum + (msg.content || msg.speech || aiResponse).length, 0);
          const speakTime = Math.min(totalLength * 200, 5000);
          setTimeout(() => speakingAvatar.classList.remove('speaking'), speakTime);
        }
      }

      callFeed.scrollTop = callFeed.scrollHeight;

    } catch (error) {
      const errorBubble = document.createElement('div');
      errorBubble.className = 'call-message-bubble ai-speech';
      errorBubble.style.color = '#ff8a80';
      errorBubble.textContent = `[ERROR: ${error.message}]`;
      callFeed.appendChild(errorBubble);
      callFeed.scrollTop = callFeed.scrollHeight;
      voiceCallState.callHistory.push({
        role: 'assistant',
        content: `[ERROR: ${error.message}]`
      });
    }
  }

  // ==================== ËØ≠Èü≥ÈÄöËØùÂäüËÉΩÁªìÊùü ====================








  async function handleUserPat(chatId, characterOriginalName) {
    const chat = state.chats[chatId];
    if (!chat) return;


    let displayNameForUI;
    if (chat.isGroup) {

      displayNameForUI = getDisplayNameInGroup(chat, characterOriginalName);
    } else {

      displayNameForUI = chat.name;
    }

    const phoneScreen = document.getElementById('phone-screen');
    phoneScreen.classList.remove('pat-animation');
    void phoneScreen.offsetWidth;
    phoneScreen.classList.add('pat-animation');


    const suffix = await showCustomPrompt(
      `‰Ω†Êãç‰∫ÜÊãç ‚Äú${displayNameForUI}‚Äù`,
      "ÔºàÂèØÈÄâÔºâËæìÂÖ•ÂêéÁºÄ",
      "",
      "text"
    );

    if (suffix === null) return;

    // Ëé∑ÂèñÁî®Êà∑ÊòµÁß∞ÔºåÂ¶ÇÊûúÊòØ {{user}} Âàô‰ΩøÁî® "‰Ω†"
    let myNickname = state.qzoneSettings.nickname;
    if (!myNickname || myNickname === '{{user}}') {
      myNickname = '‰Ω†';
    }

    // Â¶ÇÊûúÊòØÁæ§ËÅäÔºå‰ΩøÁî®Áæ§ÊòµÁß∞
    if (chat.isGroup) {
      myNickname = chat.settings.myNickname || '‰Ω†';
    }



    const visibleMessageContent = `${myNickname} Êãç‰∫ÜÊãç ‚Äú${displayNameForUI}‚Äù ${suffix.trim()}`;
    const visibleMessage = {
      role: 'system',
      type: 'pat_message',
      content: visibleMessageContent,
      timestamp: Date.now()
    };
    chat.history.push(visibleMessage);


    const hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Ôºà${myNickname}ÔºâÂàöÂàöÊãç‰∫ÜÊãç‰Ω†Ôºà${characterOriginalName}Ôºâ${suffix.trim()}„ÄÇËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ]`;
    const hiddenMessage = {
      role: 'system',
      content: hiddenMessageContent,
      timestamp: Date.now() + 1,
      isHidden: true
    };
    chat.history.push(hiddenMessage);

    await db.chats.put(chat);
    if (state.activeChatId === chatId) {
      appendMessage(visibleMessage, chat);
    }
    await renderChatList();
  }

  // Êñ∞Â¢ûÔºöÂ§ÑÁêÜÁî®Êà∑ÊãçËá™Â∑±ÁöÑÂäüËÉΩ
  async function handleUserPatSelf(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const phoneScreen = document.getElementById('phone-screen');
    phoneScreen.classList.remove('pat-animation');
    void phoneScreen.offsetWidth;
    phoneScreen.classList.add('pat-animation');

    // Ëé∑ÂèñÁî®Êà∑ÊòµÁß∞ÔºåÂ¶ÇÊûúÊòØ {{user}} Âàô‰ΩøÁî® "‰Ω†"
    let myNickname = state.qzoneSettings.nickname;
    if (!myNickname || myNickname === '{{user}}') {
      myNickname = '‰Ω†';
    }

    // Â¶ÇÊûúÊòØÁæ§ËÅäÔºå‰ΩøÁî®Áæ§ÊòµÁß∞
    if (chat.isGroup) {
      myNickname = chat.settings.myNickname || '‰Ω†';
    }

    // ÂºπÂá∫ËæìÂÖ•Ê°ÜËÆ©Áî®Êà∑ËæìÂÖ•ÊãçËá™Â∑±ÁöÑÂêéÁºÄ
    const suffix = await showCustomPrompt(
      `${myNickname} Êãç‰∫ÜÊãçËá™Â∑±`,
      "ËæìÂÖ•Êãç‰∏ÄÊãçÂêéÁºÄ",
      "",
      "text"
    );

    if (suffix === null) return;

    // ÂàõÂª∫ÂèØËßÅÁöÑÊãç‰∏ÄÊãçÊ∂àÊÅØ
    const visibleMessageContent = `${myNickname} Êãç‰∫ÜÊãçËá™Â∑± ${suffix.trim()}`;
    const visibleMessage = {
      role: 'system',
      type: 'pat_message',
      content: visibleMessageContent,
      timestamp: Date.now()
    };
    chat.history.push(visibleMessage);

    // ÂàõÂª∫ÈöêËóèÁöÑÁ≥ªÁªüÊèêÁ§∫ÔºåËÆ©AIÁü•ÈÅìÁî®Êà∑Êãç‰∫ÜËá™Â∑±
    const hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Ôºà${myNickname}ÔºâÂàöÂàöÊãç‰∫ÜÊãçËá™Â∑±${suffix.trim()}„ÄÇ‰Ω†ÂèØ‰ª•ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫îÊàñËØÑËÆ∫„ÄÇ]`;
    const hiddenMessage = {
      role: 'system',
      content: hiddenMessageContent,
      timestamp: Date.now() + 1,
      isHidden: true
    };
    chat.history.push(hiddenMessage);

    await db.chats.put(chat);
    if (state.activeChatId === chatId) {
      appendMessage(visibleMessage, chat);
    }
    await renderChatList();
  }

  let activeCallMessageTimestamp = null;
  let isFrameManagementMode = false;
  let selectedFrames = new Set();

  function showCallMessageActions(timestamp) {
    activeCallMessageTimestamp = timestamp;
    document.getElementById('call-message-actions-modal').classList.add('visible');
  }


  function hideCallMessageActions() {
    document.getElementById('call-message-actions-modal').classList.remove('visible');
    activeCallMessageTimestamp = null;
  }


  async function openCallMessageEditor() {
    if (!activeCallMessageTimestamp) return;

    const timestampToEdit = activeCallMessageTimestamp;
    const message = videoCallState.callHistory.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideCallMessageActions();

    let contentForEditing = message.content;

    if (videoCallState.isGroupCall && message.role === 'assistant') {
      const parts = message.content.split(': ');
      if (parts.length > 1) {
        contentForEditing = parts.slice(1).join(': ');
      }
    }

    const newContent = await showCustomPrompt(
      'ÁºñËæëÈÄöËØùÊ∂àÊÅØ',
      'Âú®Ê≠§‰øÆÊîπÂÜÖÂÆπ...',
      contentForEditing,
      'textarea'
    );

    if (newContent !== null) {
      await saveEditedCallMessage(timestampToEdit, newContent);
    }
  }


  async function saveEditedCallMessage(timestamp, newContent) {
    const message = videoCallState.callHistory.find(m => m.timestamp === timestamp);
    if (message) {
      let finalContent = newContent;

      if (videoCallState.isGroupCall && message.role === 'assistant') {
        const parts = message.content.split(': ');
        const senderName = parts[0];
        finalContent = `${senderName}: ${newContent}`;
      }
      message.content = finalContent;


      const messageBubble = document.querySelector(`.call-message-bubble[data-timestamp="${timestamp}"]`);
      if (messageBubble) {
        if (videoCallState.isGroupCall && message.role === 'assistant') {
          const parts = message.content.split(': ');
          const senderName = parts[0];
          messageBubble.innerHTML = `<strong>${senderName}:</strong> ${newContent}`;
        } else {
          messageBubble.textContent = newContent;
        }
      }
    }
    await showCustomAlert('ÊàêÂäü', 'ÈÄöËØùÊ∂àÊÅØÂ∑≤Êõ¥Êñ∞ÔºÅ');
  }


  async function deleteCallMessage() {
    if (!activeCallMessageTimestamp) return;

    const confirmed = await showCustomConfirm('Âà†Èô§Ê∂àÊÅØ', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÈÄöËØùÊ∂àÊÅØÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      const timestampToDelete = activeCallMessageTimestamp;
      hideCallMessageActions();


      const messageIndex = videoCallState.callHistory.findIndex(m => m.timestamp === timestampToDelete);
      if (messageIndex > -1) {
        videoCallState.callHistory.splice(messageIndex, 1);
      }


      const messageBubble = document.querySelector(`.call-message-bubble[data-timestamp="${timestampToDelete}"]`);
      if (messageBubble) {
        messageBubble.remove();
      }
    } else {
      hideCallMessageActions();
    }
  }








  async function handleUserTransferResponse(choice) {
    if (!activeTransferTimestamp) return;

    const timestamp = activeTransferTimestamp;
    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const originalMessage = chat.history[messageIndex];

    // Èò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
    if (originalMessage.status && originalMessage.status !== 'pending') {
      hideTransferActionModal();
      return;
    }

    // --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÁ°Æ‰øù‰ªéÂéÜÂè≤Ê∂àÊÅØÈáåËØªÂá∫Êù•ÁöÑÈáëÈ¢ùÊòØÊï∞Â≠ó ---
    let transferAmount = parseFloat(originalMessage.amount);
    if (isNaN(transferAmount)) {
      // Â¶ÇÊûúËØªÂèñÂ§±Ë¥•ÔºåÂ∞ùËØïÂéª content Â≠óÊÆµÈáåÊâæÔºàÈò≤Ê≠¢Êüê‰∫õÊóßÊï∞ÊçÆÁöÑ amount Â≠óÊÆµ‰∏¢Â§±Ôºâ
      console.warn("Ê∂àÊÅØ‰∏≠ amount Â≠óÊÆµÊó†ÊïàÔºåÂ∞ùËØï‰øÆÂ§ç...");
      transferAmount = 0;
    }

    originalMessage.status = choice;
    let systemContent;

    if (choice === 'declined') {
      // ÊãíÊî∂ÈÄªËæë
      const refundMessage = {
        role: 'user',
        type: 'transfer',
        isRefund: true,
        amount: transferAmount,
        note: 'Â∑≤ÊãíÊî∂ÂØπÊñπËΩ¨Ë¥¶',
        timestamp: Date.now()
      };
      chat.history.push(refundMessage);
      systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÊãíÁªùÂπ∂ÈÄÄËøò‰∫Ü‚Äú${originalMessage.senderName}‚ÄùÁöÑËΩ¨Ë¥¶„ÄÇ]`;

    } else {
      // --- Êé•Êî∂ÈÄªËæë ---
      if (transferAmount > 0) {
        // Ëé∑ÂèñÂèëÈÄÅÊñπÁöÑË¥ßÂ∏Å‰ø°ÊÅØÂπ∂ËøõË°åÊ±áÁéáÊç¢ÁÆó
        const senderCurrency = getCurrencyForChat(chat);
        const cnyAmount = convertToCNY(transferAmount, senderCurrency);

        // Ë∞ÉÁî®‰∏äÈù¢‰øÆÂ§çËøáÁöÑËÆ∞Ë¥¶ÂáΩÊï∞ÔºàÂ≠òÂÖ•Êç¢ÁÆóÂêéÁöÑ‰∫∫Ê∞ëÂ∏ÅÈáëÈ¢ùÔºâ
        const success = await processTransaction(cnyAmount, 'income', `Êî∂Âà∞ËΩ¨Ë¥¶-${originalMessage.senderName}`);

        if (success) {
          // ÊòæÁ§∫Êç¢ÁÆó‰ø°ÊÅØ
          let alertMessage;
          if (senderCurrency.code !== 'CNY') {
            // Â§ñÂ∏ÅËΩ¨Ë¥¶ÔºåÊòæÁ§∫Êç¢ÁÆó‰ø°ÊÅØ
            alertMessage = `Â∑≤Êî∂Ê¨æ ${senderCurrency.symbol}${transferAmount.toFixed(2)}\nÊ±áÁéá: 1 ${senderCurrency.code} = ${senderCurrency.rate} CNY\n\nÂ∑≤Â≠òÂÖ•‰ΩôÈ¢ùÔºö¬•${cnyAmount.toFixed(2)}`;
          } else {
            // ‰∫∫Ê∞ëÂ∏ÅËΩ¨Ë¥¶
            alertMessage = `Â∑≤Â≠òÂÖ•‰ΩôÈ¢ùÔºö+ ¬•${cnyAmount.toFixed(2)}`;
          }
          await showCustomAlert("Êî∂Ê¨æÊàêÂäü", alertMessage);

          // ‚òÖ‚òÖ‚òÖ Êñ∞Â¢ûËøôÈÉ®ÂàÜÈÄªËæë (ÁîüÊàê‚ÄúÂ∑≤Êî∂Ê¨æ‚ÄùÂç°Áâá) ‚òÖ‚òÖ‚òÖ
          const receivedMessage = {
            role: 'user',        // ÊâÆÊºîÁî®Êà∑ÂèëÈÄÅ
            type: 'transfer',    // Â§çÁî®ËΩ¨Ë¥¶Âç°ÁâáÊ†∑Âºè
            isReceived: true,    // Ê†áËÆ∞‰∏∫‚ÄúÂ∑≤Êî∂Ê¨æ‚ÄùÂç°Áâá
            amount: transferAmount,
            note: 'Â∑≤Êî∂Ê¨æ',
            senderName: 'Êàë',
            receiverName: originalMessage.senderName, // Èí±Êù•Ëá™‰∫éË∞Å
            timestamp: Date.now() // ‰ΩøÁî®ÂΩìÂâçÊó∂Èó¥
          };
          chat.history.push(receivedMessage);
          // ‚òÖ‚òÖ‚òÖ Êñ∞Â¢ûÁªìÊùü ‚òÖ‚òÖ‚òÖ
        } else {
          // Â¶ÇÊûú processTransaction ËøîÂõû falseÔºåËØ¥ÊòéÂá∫ÈóÆÈ¢ò‰∫Ü
          alert("Ë≠¶ÂëäÔºöÈáëÈ¢ùÂÖ•Ë¥¶Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞Êó•ÂøóÔºÅ");
        }
      } else {
        alert("Êó†Ê≥ïÊî∂Ê¨æÔºöËØ•ËΩ¨Ë¥¶ÈáëÈ¢ùÊó†Êïà (0ÂÖÉÊàñÊï∞ÊçÆÊçüÂùè)„ÄÇ");
      }

      systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Êé•Âèó‰∫Ü‚Äú${originalMessage.senderName}‚ÄùÁöÑËΩ¨Ë¥¶„ÄÇ]`;
    }

    // Êõ¥Êñ∞ËÅäÂ§©ËÆ∞ÂΩï
    const hiddenMessage = {
      role: 'system',
      content: systemContent,
      timestamp: Date.now() + 1,
      isHidden: true
    };
    chat.history.push(hiddenMessage);

    await db.chats.put(chat);
    hideTransferActionModal();
    renderChatInterface(state.activeChatId);
    renderChatList();
  }



  function clearQzoneReplyContext(postContainer) {
    currentQzoneReplyContext = null;
    if (postContainer) {

      const input = postContainer.querySelector('.comment-input');
      if (input) {
        input.placeholder = 'ÂèãÂñÑÁöÑËØÑËÆ∫ÊòØ‰∫§ÊµÅÁöÑËµ∑ÁÇπ';
      }
    }
  }



  async function renderMemoriesScreen() {
    const listEl = document.getElementById('memories-list');
    listEl.innerHTML = '';


    const allMemories = await db.memories.orderBy('timestamp').reverse().toArray();

    if (allMemories.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°ÊúâÂÖ±ÂêåÁöÑÂõûÂøÜÂíåÁ∫¶ÂÆöÂë¢~</p>';
      return;
    }


    allMemories.sort((a, b) => {
      const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
      const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();
      if (aIsActiveCountdown && !bIsActiveCountdown) return -1;
      if (!aIsActiveCountdown && bIsActiveCountdown) return 1;
      if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate;
      return 0;
    });


    allMemories.forEach(item => {
      let card;

      if (item.type === 'countdown' && item.targetDate > Date.now()) {
        card = createCountdownCard(item);
      } else {
        card = createMemoryCard(item);
      }
      listEl.appendChild(card);
    });


    startAllCountdownTimers();
  }



  function createMemoryCard(memory) {
    const card = document.createElement('div');
    card.className = 'memory-card';
    const memoryDate = new Date(memory.timestamp);
    const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;

    let titleHtml, contentHtml;

    if (memory.type === 'countdown' && memory.targetDate) {
      titleHtml = `[Á∫¶ÂÆöËææÊàê] ${memory.description}`;

      contentHtml = parseMarkdown(`Âú® ${new Date(memory.targetDate).toLocaleString()}ÔºåÊàë‰ª¨‰∏ÄËµ∑ËßÅËØÅ‰∫ÜËøô‰∏™Á∫¶ÂÆö„ÄÇ`).replace(/\n/g, '<br>');
    } else {
      let authorDisplayName = 'Êàë‰ª¨ÁöÑÂõûÂøÜ';
      if (memory.authorId) {
        const authorChat = state.chats[memory.authorId];
        if (authorChat) {
          authorDisplayName = authorChat.name;
        } else {
          authorDisplayName = memory.authorName || '‰∏Ä‰ΩçÊúãÂèã';
        }
      } else if (memory.authorName) {
        authorDisplayName = memory.authorName;
      }

      titleHtml = `${authorDisplayName} ÁöÑÊó•ËÆ∞`;

      contentHtml = parseMarkdown(memory.description);
    }

    card.innerHTML = `
                <div class="header">
                    <div class="date">${dateString}</div>
                    <div class="author">${titleHtml}</div>
                </div>
                <div class="content">${contentHtml}</div>
            `;
    addLongPressListener(card, async () => {
      const confirmed = await showCustomConfirm('Âà†Èô§ËÆ∞ÂΩï', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü', {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        await db.memories.delete(memory.id);
        renderMemoriesScreen();
      }
    });
    return card;
  }


  function createCountdownCard(countdown) {
    const card = document.createElement('div');
    card.className = 'countdown-card';


    const targetDate = new Date(countdown.targetDate);


    const targetDateString = targetDate.toLocaleString('zh-CN', {
      dateStyle: 'full',
      timeStyle: 'short'
    });

    card.innerHTML = `
                <div class="title">${countdown.description}</div>
                <div class="timer" data-target-date="${countdown.targetDate}">--Â§©--Êó∂--ÂàÜ--Áßí</div>
                <div class="target-date">ÁõÆÊ†áÊó∂Èó¥: ${targetDateString}</div>
            `;
    addLongPressListener(card, async () => {
      const confirmed = await showCustomConfirm('Âà†Èô§Á∫¶ÂÆö', 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Á∫¶ÂÆöÂêóÔºü', {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        await db.memories.delete(countdown.id);
        renderMemoriesScreen();
      }
    });
    return card;
  }



  let activeCountdownTimers = [];


  function startAllCountdownTimers() {

    activeCountdownTimers.forEach(timerId => clearInterval(timerId));
    activeCountdownTimers = [];

    document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
      const targetTimestamp = parseInt(timerEl.dataset.targetDate);


      let timerId;

      const updateTimer = () => {
        const now = Date.now();
        const distance = targetTimestamp - now;

        if (distance < 0) {
          timerEl.textContent = "Á∫¶ÂÆöËææÊàêÔºÅ";

          clearInterval(timerId);
          setTimeout(() => renderMemoriesScreen(), 2000);
          return;
        }
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        timerEl.textContent = `${days}Â§© ${hours}Êó∂ ${minutes}ÂàÜ ${seconds}Áßí`;
      };

      updateTimer();


      timerId = setInterval(updateTimer, 1000);


      activeCountdownTimers.push(timerId);
    });
  }



  async function triggerAiFriendApplication(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    await showCustomAlert("ÊµÅÁ®ãÂêØÂä®", `Ê≠£Âú®‰∏∫ËßíËâ≤‚Äú${chat.name}‚ÄùÂáÜÂ§áÂ•ΩÂèãÁî≥ËØ∑...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      await showCustomAlert("ÈÖçÁΩÆÈîôËØØ", "APIËÆæÁΩÆ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÁªßÁª≠„ÄÇ");
      return;
    }

    const contextSummary = chat.history
      .slice(-5)
      .map(msg => {
        const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (msg.senderName || chat.name);
        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
      })
      .join('\n');

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      `\n# ‰Ω†‰ª¨ÁöÑËøáÂæÄËÆ∞ÂøÜ (‰Ωú‰∏∫ÊÉÖÊÑüÂü∫Á°Ä)\n` + chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') :
      '';
    let worldBookContent = '';
    // Ëé∑ÂèñÊâÄÊúâÂ∫îËØ•‰ΩøÁî®ÁöÑ‰∏ñÁïå‰π¶IDÔºàÂåÖÊã¨ÊâãÂä®ÈÄâÊã©ÁöÑÂíåÂÖ®Â±ÄÁöÑÔºâ
    let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
    // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
    state.worldBooks.forEach(wb => {
      if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
        allWorldBookIds.push(wb.id);
      }
    });

    if (allWorldBookIds.length > 0) {
      const linkedContents = allWorldBookIds.map(bookId => {
        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
        if (!worldBook || !Array.isArray(worldBook.content)) return '';

        const formattedEntries = worldBook.content.map(entry => {
          let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;

          entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
          return entryString;
        }).join('\n');

        return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
      }).filter(Boolean).join('');

      if (linkedContents) {
        worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
      }
    }

    const systemPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Áé∞Âú®ÊòØËßíËâ≤‚Äú${chat.name}‚Äù„ÄÇ‰Ω†‰πãÂâçË¢´Áî®Êà∑Ôºà‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºâÊãâÈªë‰∫ÜÔºå‰Ω†‰ª¨Â∑≤ÁªèÊúâ‰∏ÄÊÆµÊó∂Èó¥Ê≤°ÊúâËÅîÁ≥ª‰∫Ü„ÄÇ
        Áé∞Âú®Ôºå‰Ω†ÈùûÂ∏∏Â∏åÊúõËÉΩÂ§üÂíåÂ•ΩÔºåÈáçÊñ∞ÂíåÁî®Êà∑ËÅäÂ§©„ÄÇËØ∑‰Ω†‰ªîÁªÜÂàÜÊûê‰∏ãÈù¢ÁöÑ‚ÄúË¢´ÊãâÈªëÂâçÁöÑÂØπËØùÊëòË¶Å‚ÄùÔºåÁêÜËß£ÂΩìÊó∂ÂèëÁîü‰∫Ü‰ªÄ‰πàÔºåÁÑ∂ÂêéÊÄùËÄÉ‰∏Ä‰∏™ÁúüËØöÁöÑ„ÄÅÁ¨¶Âêà‰Ω†‰∫∫ËÆæ„ÄÅÂπ∂‰∏î„ÄêÈíàÂØπÂÖ∑‰Ωì‰∫ã‰ª∂„ÄëÁöÑÁî≥ËØ∑ÁêÜÁî±„ÄÇ
        # ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
        ${chat.settings.aiPersona}
        ${worldBookContent}
        ${longTermMemoryContext}
        # Ë¢´ÊãâÈªëÂâçÁöÑÂØπËØùÊëòË¶Å (ËøôÊòØ‰Ω†Ë¢´ÊãâÈªëÁöÑÂÖ≥ÈîÆÂéüÂõ†)
        ${contextSummary}
        # Êåá‰ª§Ê†ºÂºè
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
        \`\`\`json
        {
          "decision": "apply",
          "reason": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊÉ≥ÂØπÁî®Êà∑ËØ¥ÁöÑ„ÄÅÁúüËØöÁöÑ„ÄÅÊúâÈíàÂØπÊÄßÁöÑÁî≥ËØ∑ÁêÜÁî±„ÄÇ"
        }
        \`\`\`
        `;

    try {

      const messagesForApi = [{
        role: 'system',
        content: systemPrompt
      },
      {
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äËÆæÂÆöÂºÄÂßã‰Ω†ÁöÑÂÜ≥Á≠ñ„ÄÇ"
      }
      ];

      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: model,
          messages: messagesForApi,
          temperature: state.globalSettings.apiTemperature || 0.9,
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorData.error.message}`);
      }

      const data = await response.json();
      let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
      rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
      const cleanedContent = rawContent.trim();

      let responseObj;

      try {

        responseObj = JSON.parse(cleanedContent);
      } catch (parseError) {

        console.error("Ëß£ÊûêÂ•ΩÂèãÁî≥ËØ∑ÁöÑAIÂìçÂ∫îÂ§±Ë¥•:", parseError);

        throw new Error(`AIÊú™ËøîÂõûÊúâÊïàÁöÑJSON„ÄÇAPIÂÆûÈôÖËøîÂõûÂÜÖÂÆπ: "${cleanedContent}"`);
      }

      if (responseObj.decision === 'apply' && responseObj.reason) {
        chat.relationship.status = 'pending_user_approval';
        chat.relationship.applicationReason = responseObj.reason;
        state.chats[chatId] = chat;
        renderChatList();
        await showCustomAlert("Áî≥ËØ∑ÊàêÂäüÔºÅ", `‚Äú${chat.name}‚ÄùÂ∑≤Âêë‰Ω†ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑„ÄÇËØ∑ËøîÂõûËÅäÂ§©ÂàóË°®Êü•Áúã„ÄÇ`);
      } else {
        await showCustomAlert("AIÂÜ≥Á≠ñ", `‚Äú${chat.name}‚ÄùÊÄùËÄÉÂêéÂÜ≥ÂÆöÊöÇÊó∂‰∏çÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑ÔºåÂ∞ÜÈáçÁΩÆÂÜ∑ÈùôÊúü„ÄÇ`);
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
      }
    } catch (error) {
      await showCustomAlert("ÊâßË°åÂá∫Èîô", `‰∏∫‚Äú${chat.name}‚ÄùÁî≥ËØ∑Â•ΩÂèãÊó∂ÂèëÁîüÈîôËØØÔºö\n\n${error.message}\n\nÂ∞ÜÈáçÁΩÆÂÜ∑ÈùôÊúü„ÄÇ`);
      chat.relationship.status = 'blocked_by_user';
      chat.relationship.blockedTimestamp = Date.now();
    } finally {
      await db.chats.put(chat);
      renderChatInterface(chatId);
    }
  }




  function handlePaymentButtonClick() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (chat.isGroup) {
      openRedPacketModal();
    } else {

      document.getElementById('transfer-modal').classList.add('visible');
    }
  }


  function openRedPacketModal() {
    const modal = document.getElementById('red-packet-modal');
    const chat = state.chats[state.activeChatId];


    document.getElementById('rp-group-amount').value = '';
    document.getElementById('rp-group-count').value = '';
    document.getElementById('rp-group-greeting').value = '';
    document.getElementById('rp-direct-amount').value = '';
    document.getElementById('rp-direct-greeting').value = '';
    document.getElementById('rp-group-total').textContent = '¬• 0.00';
    document.getElementById('rp-direct-total').textContent = '¬• 0.00';


    const receiverSelect = document.getElementById('rp-direct-receiver');
    receiverSelect.innerHTML = '';

    chat.members.forEach(member => {
      const option = document.createElement('option');

      option.value = member.originalName;
      option.textContent = member.groupNickname;
      receiverSelect.appendChild(option);
    });



    document.getElementById('rp-tab-group').click();

    modal.classList.add('visible');
  }


  async function sendGroupRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-group-amount').value);
    const count = parseInt(document.getElementById('rp-group-count').value);
    const greeting = document.getElementById('rp-group-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊÄªÈáëÈ¢ùÔºÅ");
      return;
    }
    if (isNaN(count) || count <= 0) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÁ∫¢ÂåÖ‰∏™Êï∞ÔºÅ");
      return;
    }
    if (amount / count < 0.01) {
      alert("Âçï‰∏™Á∫¢ÂåÖÈáëÈ¢ù‰∏çËÉΩÂ∞ë‰∫é0.01ÂÖÉÔºÅ");
      return;
    }

    const myNickname = chat.settings.myNickname || 'Êàë';

    const allocatedAmounts = generateRandomPacketAmounts(amount, count);
    const success = await processTransaction(amount, 'expense', `ÂèëÂá∫Áæ§Á∫¢ÂåÖ(ÊãºÊâãÊ∞î)`);
    if (!success) return;
    const newPacket = {
      role: 'user',
      senderName: myNickname,
      type: 'red_packet',
      packetType: 'lucky',
      timestamp: Date.now(),
      totalAmount: amount,
      count: count,
      greeting: greeting || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ',
      allocatedAmounts: allocatedAmounts,
      unclaimedAmounts: [...allocatedAmounts],
      claimedBy: {},
      isFullyClaimed: false,
    };

    chat.history.push(newPacket);
    await db.chats.put(chat);

    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
  }


  async function sendDirectRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-direct-amount').value);
    const receiverName = document.getElementById('rp-direct-receiver').value;
    const greeting = document.getElementById('rp-direct-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ùÔºÅ");
      return;
    }
    if (!receiverName) {
      alert("ËØ∑ÈÄâÊã©‰∏Ä‰∏™Êé•Êî∂‰∫∫ÔºÅ");
      return;
    }

    const myNickname = chat.settings.myNickname || 'Êàë';
    const success = await processTransaction(amount, 'expense', `ÂèëÂá∫‰∏ìÂ±ûÁ∫¢ÂåÖ-Áªô${receiverName}`);
    if (!success) return;
    const newPacket = {
      role: 'user',
      senderName: myNickname,
      type: 'red_packet',
      packetType: 'direct',
      timestamp: Date.now(),
      totalAmount: amount,
      count: 1,
      greeting: greeting || 'Áªô‰Ω†ÂáÜÂ§á‰∫Ü‰∏Ä‰∏™Á∫¢ÂåÖ',
      receiverName: receiverName,
      claimedBy: {},
      isFullyClaimed: false,
    };

    chat.history.push(newPacket);
    await db.chats.put(chat);

    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
  }


  let isPacketProcessing = false;

  async function handlePacketClick(timestamp) {
    // 1. Â¶ÇÊûúÈîÅÊòØÈîÅÁùÄÁöÑÔºåÁõ¥Êé•ÈÄÄÂá∫Ôºå‰ªÄ‰πàÈÉΩ‰∏çÂÅö
    if (isPacketProcessing) {
      console.log("Ê≠£Âú®Â§ÑÁêÜÁ∫¢ÂåÖÔºåÊã¶Êà™‰∫ÜÈáçÂ§çÁÇπÂáª");
      return;
    }

    // 2. ‰∏äÈîÅ
    isPacketProcessing = true;

    try {
      const currentChatId = state.activeChatId;

      // ÈáçÊñ∞‰ªéÊï∞ÊçÆÂ∫ìÊãâÂèñÊúÄÊñ∞Êï∞ÊçÆÔºàÈò≤Ê≠¢ÂÜÖÂ≠òÊï∞ÊçÆÊªûÂêéÔºâ
      const freshChat = await db.chats.get(currentChatId);
      if (!freshChat) return;

      state.chats[currentChatId] = freshChat;
      const packet = freshChat.history.find(m => m.timestamp === timestamp);
      if (!packet) return;

      const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
      // Á°Æ‰øù claimedBy ÊòØ‰∏™ÂØπË±°ÔºåÈò≤Ê≠¢Êä•Èîô
      if (!packet.claimedBy) packet.claimedBy = {};
      const hasClaimed = packet.claimedBy[myOriginalName];

      // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÈ¢ÜËøáÔºåÊàñËÄÖÊòØÂê¶Â∑≤È¢ÜÂÆå
      // Ê≥®ÊÑèÔºöËøôÈáåÂä†‰∫ÜÊõ¥‰∏•Ê†ºÁöÑÊ£ÄÊü•
      if ((packet.packetType === 'direct' && packet.receiverName !== myOriginalName && Object.keys(packet.claimedBy).length > 0) ||
        packet.isFullyClaimed ||
        hasClaimed) {
        showRedPacketDetails(packet);
        return;
      }

      // ÊâßË°åÈ¢ÜÂèñÈÄªËæë
      const claimedAmount = await handleOpenRedPacket(packet);

      if (claimedAmount !== null) {
        await renderChatInterface(currentChatId);
        await showCustomAlert("ÊÅ≠ÂñúÔºÅ", `‰Ω†È¢ÜÂèñ‰∫Ü ${getDisplayNameInGroup(freshChat, packet.senderName)} ÁöÑÁ∫¢ÂåÖÔºåÈáëÈ¢ù‰∏∫ ${claimedAmount.toFixed(2)} ÂÖÉ„ÄÇ`);
      }

      const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
      if (updatedPacket) {
        showRedPacketDetails(updatedPacket);
      }

    } catch (error) {
      console.error("Á∫¢ÂåÖÂ§ÑÁêÜÂá∫Èîô:", error);
      alert("È¢ÜÂèñÂá∫ÈîôÔºåËØ∑Á®çÂêéÈáçËØï");
    } finally {
      // 3. Êó†ËÆ∫ÊàêÂäüËøòÊòØÂ§±Ë¥•Ôºå1ÁßíÂêéËß£ÈîÅ
      // Âª∂ËøüËß£ÈîÅÊòØ‰∏∫‰∫ÜÈò≤Ê≠¢ÊûÅÂø´ÁöÑÊâãÈÄüËøûÁÇπ
      setTimeout(() => {
        isPacketProcessing = false;
      }, 1000);
    }
  }





  async function handleOpenRedPacket(packet) {
    const chat = state.chats[state.activeChatId];
    let timestamp = Date.now();
    const myOriginalName = state.qzoneSettings.nickname || '{{user}}';

    // Ê£ÄÊü•ÊòØÂê¶È¢ÜÂÆå
    const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
    if (remainingCount <= 0) {
      packet.isFullyClaimed = true;
      await db.chats.put(chat);
      await showCustomAlert("ÊâãÊÖ¢‰∫Ü", "Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºÅ");
      return null;
    }

    // --- ËÆ°ÁÆóÈáëÈ¢ùÈÄªËæë ---
    let claimedAmount = 0;
    if (packet.packetType === 'lucky') {
      if (packet.unclaimedAmounts && packet.unclaimedAmounts.length > 0) {
        claimedAmount = packet.unclaimedAmounts.pop();
      } else {
        // ÂÖºÂÆπÊóßÊï∞ÊçÆ
        const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
        if (remainingCount === 1) {
          claimedAmount = remainingAmount;
        } else {
          const min = 0.01;
          const max = remainingAmount - (remainingCount - 1) * min;
          claimedAmount = Math.random() * (max - min) + min;
        }
      }
    } else {
      claimedAmount = packet.totalAmount;
    }
    claimedAmount = parseFloat(claimedAmount.toFixed(2));

    // ËÆ∞ÂΩïÈ¢ÜÂèñ
    if (!packet.claimedBy) packet.claimedBy = {};
    packet.claimedBy[myOriginalName] = claimedAmount;

    // Êõ¥Êñ∞Áä∂ÊÄÅ
    const isNowFullyClaimed = (packet.unclaimedAmounts && packet.unclaimedAmounts.length === 0) || (Object.keys(packet.claimedBy).length >= packet.count);
    if (isNowFullyClaimed) {
      packet.isFullyClaimed = true;
    }

    // ÁîüÊàêËÅäÂ§©Ê∂àÊÅØ
    const myDisplayName = getDisplayNameInGroup(chat, myOriginalName);
    const senderDisplayName = getDisplayNameInGroup(chat, packet.senderName);

    const visibleMessage = {
      role: 'system',
      type: 'pat_message',
      content: `‰Ω†È¢ÜÂèñ‰∫Ü ${senderDisplayName} ÁöÑÁ∫¢ÂåÖ`,
      timestamp: timestamp++
    };
    chat.history.push(visibleMessage);

    // ÁîüÊàêÁªôAIÁúãÁöÑÈöêËóèÊèêÁ§∫
    let hiddenMessageContent;
    if (isNowFullyClaimed) {
      const finishedMessage = {
        role: 'system',
        type: 'pat_message',
        content: `${senderDisplayName} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå`,
        timestamp: timestamp++
      };
      chat.history.push(finishedMessage);

      let luckyKing = { name: '', amount: -1 };
      if (packet.packetType === 'lucky' && packet.count > 1) {
        Object.entries(packet.claimedBy).forEach(([name, amount]) => {
          if (amount > luckyKing.amount) {
            luckyKing = { name, amount };
          }
        });
      }
      const luckyKingDisplayName = luckyKing.name ? getDisplayNameInGroup(chat, luckyKing.name) : 'Êó†';
      hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myDisplayName}) È¢ÜÂèñ‰∫ÜÊúÄÂêé‰∏Ä‰∏™Á∫¢ÂåÖ„ÄÇÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºåÊâãÊ∞îÁéãÊòØ ${luckyKingDisplayName}ÔºÅËØ∑ÂØπÊ≠§‰∫ã‰ª∂ÂèëË°®ËØÑËÆ∫„ÄÇ]`;

    } else {
      hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myDisplayName}) ÂàöÂàöÈ¢ÜÂèñ‰∫ÜÁ∫¢ÂåÖ (Êó∂Èó¥Êà≥: ${packet.timestamp})„ÄÇÁ∫¢ÂåÖËøòÊú™È¢ÜÂÆåÔºå‰Ω†Áé∞Âú®ÂèØ‰ª•‰ΩøÁî® 'open_red_packet' Êåá‰ª§Êù•Â∞ùËØïÈ¢ÜÂèñ„ÄÇ]`;
    }

    const hiddenMessage = {
      role: 'system',
      content: hiddenMessageContent,
      timestamp: timestamp++,
      isHidden: true
    };
    chat.history.push(hiddenMessage);

    await db.chats.put(chat);

    // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÊääÊä¢Âà∞ÁöÑÈí±Â≠òÂÖ•Èí±ÂåÖ
    if (claimedAmount > 0) {
      // ËøôÈáåÁöÑ 'income' ‰ºöÂ¢ûÂä†‰ΩôÈ¢ùÔºådescription ‰ºöÊòæÁ§∫Âú®Ë¥¶ÂçïÂàóË°®Èáå
      await processTransaction(claimedAmount, 'income', `Á∫¢ÂåÖ-${senderDisplayName}`);
    }

    return claimedAmount;
  }




  async function showRedPacketDetails(packet) {
    if (!packet) {
      console.error("showRedPacketDetailsÊî∂Âà∞‰∫ÜÊó†ÊïàÁöÑpacketÂØπË±°");
      return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const modal = document.getElementById('red-packet-details-modal');

    const myOriginalName = state.qzoneSettings.nickname || '{{user}}';

    const senderDisplayName = getDisplayNameInGroup(chat, packet.senderName);
    document.getElementById('rp-details-sender').textContent = senderDisplayName;
    document.getElementById('rp-details-greeting').textContent = packet.greeting || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ';

    const myAmountEl = document.getElementById('rp-details-my-amount');

    if (packet.claimedBy && packet.claimedBy[myOriginalName]) {
      myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myOriginalName].toFixed(2);
      myAmountEl.style.display = 'block';
    } else {
      myAmountEl.style.display = 'none';
    }

    const claimedCount = Object.keys(packet.claimedBy || {}).length;
    const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    let summaryText = `${claimedCount}/${packet.count}‰∏™Á∫¢ÂåÖÔºåÂÖ±${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}ÂÖÉ„ÄÇ`;
    if (!packet.isFullyClaimed && claimedCount < packet.count) {
      const timeLeft = Math.floor((packet.timestamp + 24 * 60 * 60 * 1000 - Date.now()) / (1000 * 60 * 60));
      if (timeLeft > 0) summaryText += ` Ââ©‰ΩôÁ∫¢ÂåÖÂ∞ÜÂú®${timeLeft}Â∞èÊó∂ÂÜÖÈÄÄËøò„ÄÇ`;
    }
    document.getElementById('rp-details-summary').textContent = summaryText;

    const listEl = document.getElementById('rp-details-list');
    listEl.innerHTML = '';
    const claimedEntries = Object.entries(packet.claimedBy || {});

    let luckyKing = {
      name: '',
      amount: -1
    };
    if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
      claimedEntries.forEach(([name, amount]) => {
        if (amount > luckyKing.amount) {
          luckyKing = {
            name,
            amount
          };
        }
      });
    }

    claimedEntries.sort((a, b) => b[1] - a[1]);

    claimedEntries.forEach(([originalName, amount]) => {
      const item = document.createElement('div');
      item.className = 'rp-details-item';
      let luckyTag = '';
      if (luckyKing.name && originalName === luckyKing.name) {
        luckyTag = '<span class="lucky-king-tag">ÊâãÊ∞îÁéã</span>';
      }


      const claimerDisplayName = getDisplayNameInGroup(chat, originalName);

      item.innerHTML = `
                    <span class="name">${claimerDisplayName}</span>
                    <span class="amount">${amount.toFixed(2)} ÂÖÉ</span>
                    ${luckyTag}
                `;
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
  }


  document.getElementById('close-rp-details-btn').addEventListener('click', () => {
    document.getElementById('red-packet-details-modal').classList.remove('visible');
  });


  window.handlePacketClick = handlePacketClick;






  function openCreatePollModal() {
    const modal = document.getElementById('create-poll-modal');
    document.getElementById('poll-question-input').value = '';
    const optionsContainer = document.getElementById('poll-options-container');
    optionsContainer.innerHTML = '';


    addPollOptionInput();
    addPollOptionInput();

    modal.classList.add('visible');
  }


  function addPollOptionInput() {
    const container = document.getElementById('poll-options-container');
    const wrapper = document.createElement('div');
    wrapper.className = 'poll-option-input-wrapper';
    wrapper.innerHTML = `
                <input type="text" class="poll-option-input" placeholder="ÈÄâÈ°πÂÜÖÂÆπ...">
                <button class="remove-option-btn">-</button>
            `;

    wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {

      if (container.children.length > 2) {
        wrapper.remove();
      } else {
        alert('ÊäïÁ•®Ëá≥Â∞ëÈúÄË¶Å2‰∏™ÈÄâÈ°π„ÄÇ');
      }
    });

    container.appendChild(wrapper);
  }


  async function sendPoll() {
    if (!state.activeChatId) return;

    const question = document.getElementById('poll-question-input').value.trim();
    if (!question) {
      alert('ËØ∑ËæìÂÖ•ÊäïÁ•®ÈóÆÈ¢òÔºÅ');
      return;
    }

    const options = Array.from(document.querySelectorAll('.poll-option-input'))
      .map(input => input.value.trim())
      .filter(text => text);

    if (options.length < 2) {
      alert('ËØ∑Ëá≥Â∞ëËæìÂÖ•2‰∏™ÊúâÊïàÁöÑÊäïÁ•®ÈÄâÈ°πÔºÅ');
      return;
    }

    const chat = state.chats[state.activeChatId];
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

    const newPollMessage = {
      role: 'user',
      senderName: myNickname,
      type: 'poll',
      timestamp: Date.now(),
      question: question,
      options: options,
      votes: {},
      isClosed: false,
    };

    chat.history.push(newPollMessage);
    await db.chats.put(chat);

    appendMessage(newPollMessage, chat);
    renderChatList();

    document.getElementById('create-poll-modal').classList.remove('visible');
  }



  async function handleUserVote(timestamp, choice) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';


    if (!poll || poll.isClosed) {

      if (poll && poll.isClosed) {
        showPollResults(timestamp);
      }
      return;
    }


    const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);


    if (!isReclickingSameOption) {

      for (const option in poll.votes) {
        const voterIndex = poll.votes[option].indexOf(myNickname);
        if (voterIndex > -1) {
          poll.votes[option].splice(voterIndex, 1);
        }
      }

      if (!poll.votes[choice]) {
        poll.votes[choice] = [];
      }
      poll.votes[choice].push(myNickname);
    }


    let hiddenMessageContent = null;


    if (!isReclickingSameOption) {
      hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) ÂàöÂàöÊäïÁ•®Áªô‰∫Ü ‚Äú${choice}‚Äù„ÄÇ]`;
    }


    if (hiddenMessageContent) {
      const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now(),
        isHidden: true,
      };
      chat.history.push(hiddenMessage);
    }


    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
  }



  async function endPoll(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || poll.isClosed) return;

    const confirmed = await showCustomConfirm("ÁªìÊùüÊäïÁ•®", "Á°ÆÂÆöË¶ÅÁªìÊùüËøô‰∏™ÊäïÁ•®ÂêóÔºüÁªìÊùüÂêéÂ∞ÜÊó†Ê≥ïÂÜçËøõË°åÊäïÁ•®„ÄÇ");
    if (confirmed) {
      poll.isClosed = true;

      const resultSummary = poll.options.map(opt => `‚Äú${opt}‚Äù(${poll.votes[opt]?.length || 0}Á•®)`).join('Ôºå');
      const hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊâãÂä®ÁªìÊùü‰∫ÜÊäïÁ•®ÔºÅÊúÄÁªàÁªìÊûú‰∏∫Ôºö${resultSummary}„ÄÇ]`;

      const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now(),
        isHidden: true,
      };
      chat.history.push(hiddenMessage);


      await db.chats.put(chat);
      renderChatInterface(state.activeChatId);
    }
  }




  function showPollResults(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || !poll.isClosed) return;

    let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;

    if (Object.keys(poll.votes).length === 0) {
      resultsHtml += '<p style="color: #8a8a8a;">ËøòÊ≤°Êúâ‰∫∫ÊäïÁ•®„ÄÇ</p>';
    } else {
      poll.options.forEach(option => {
        const voters = poll.votes[option] || [];


        const displayVoters = voters.map(originalName => getDisplayNameInGroup(chat, originalName)).join('„ÄÅ ');

        resultsHtml += `
                        <div style="margin-bottom: 15px;">
                            <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}Á•®)</p>
                            <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                                ${voters.length > 0 ? displayVoters : 'Êó†‰∫∫ÊäïÁ•®'}
                            </p>
                        </div>
                    `;
      });
    }

    showCustomAlert("ÊäïÁ•®ÁªìÊûú", resultsHtml);
  }





  function openAiAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('ai-avatar-library-title').textContent = `‚Äú${chat.name}‚ÄùÁöÑÂ§¥ÂÉèÂ∫ì`;
    renderAiAvatarLibrary();
    document.getElementById('ai-avatar-library-modal').classList.add('visible');
  }

  function renderAiAvatarLibrary() {
    const grid = document.getElementById('ai-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.aiAvatarLibrary || [];

    if (library.length === 0) {
      grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">Ëøô‰∏™Â§¥ÂÉèÂ∫ìËøòÊòØÁ©∫ÁöÑÔºåÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÂêßÔºÅ</p>';
      return;
    }

    library.forEach((avatar, index) => {
      const item = document.createElement('div');
      item.className = 'sticker-item';
      item.title = avatar.name;



      item.innerHTML = `
            <div class="sticker-image-container" style="background-image: url(${avatar.url});"></div>
            <span class="sticker-name">${avatar.name}</span>
        `;


      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn';
      deleteBtn.innerHTML = '√ó';
      deleteBtn.style.display = 'block';
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        const confirmed = await showCustomConfirm('Âà†Èô§Â§¥ÂÉè', `Á°ÆÂÆöË¶Å‰ªéÂ§¥ÂÉèÂ∫ì‰∏≠Âà†Èô§‚Äú${avatar.name}‚ÄùÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          chat.settings.aiAvatarLibrary.splice(index, 1);
          await db.chats.put(chat);
          renderAiAvatarLibrary();
        }
      };
      item.appendChild(deleteBtn);
      grid.appendChild(item);
    });
  }



  async function addAvatarToLibraryFromURL() {
    const name = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÂì≠Ê≥£Ôºâ");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL", "", "url");
    if (!url || !url.trim().startsWith('http')) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
      return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat.settings.aiAvatarLibrary) {
      chat.settings.aiAvatarLibrary = [];
    }

    chat.settings.aiAvatarLibrary.push({
      name: name.trim(),
      url: url.trim()
    });
    await db.chats.put(chat);
    renderAiAvatarLibrary();
  }



  function closeAiAvatarLibraryModal() {
    document.getElementById('ai-avatar-library-modal').classList.remove('visible');
  }






  function openMyAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('my-avatar-library-title').textContent = `‚Äú${chat.settings.myNickname || 'Êàë'}‚ÄùÁöÑÂ§¥ÂÉèÂ∫ì`;
    renderMyAvatarLibrary();
    document.getElementById('my-avatar-library-modal').classList.add('visible');
  }


  function renderMyAvatarLibrary() {
    const grid = document.getElementById('my-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.myAvatarLibrary || [];

    if (library.length === 0) {
      grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">Ëøô‰∏™Â§¥ÂÉèÂ∫ìËøòÊòØÁ©∫ÁöÑÔºåÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÂêßÔºÅ</p>';
      return;
    }

    library.forEach((avatar, index) => {
      const item = document.createElement('div');
      item.className = 'sticker-item';
      item.title = avatar.name;


      item.innerHTML = `
            <div class="sticker-image-container" style="background-image: url(${avatar.url});"></div>
            <span class="sticker-name">${avatar.name}</span>
        `;


      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn';
      deleteBtn.innerHTML = '√ó';
      deleteBtn.style.display = 'block';
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        const confirmed = await showCustomConfirm('Âà†Èô§Â§¥ÂÉè', `Á°ÆÂÆöË¶Å‰ªé‰Ω†ÁöÑÂ§¥ÂÉèÂ∫ì‰∏≠Âà†Èô§‚Äú${avatar.name}‚ÄùÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          chat.settings.myAvatarLibrary.splice(index, 1);
          await db.chats.put(chat);
          renderMyAvatarLibrary();
        }
      };
      item.appendChild(deleteBtn);
      grid.appendChild(item);
    });
  }


  async function addAvatarToMyLibraryFromURL() {
    const name = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÂì≠Ê≥£Ôºâ");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL", "", "url");
    if (!url || !url.trim().startsWith('http')) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
      return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat.settings.myAvatarLibrary) {
      chat.settings.myAvatarLibrary = [];
    }

    chat.settings.myAvatarLibrary.push({
      name: name.trim(),
      url: url.trim()
    });
    await db.chats.put(chat);
    renderMyAvatarLibrary();
  }


  async function handleLocalMyAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    let base64Url = await new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });

    const name = await showCustomPrompt("ÂëΩÂêçÂ§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Êñ∞Â§¥ÂÉèÂëΩÂêç");
    if (!name || !name.trim()) {
      event.target.value = null;
      return;
    }

    const trimmedName = name.trim();
    const chat = state.chats[state.activeChatId];
    if (!chat.settings.myAvatarLibrary) {
      chat.settings.myAvatarLibrary = [];
    }

    const newItem = {
      name: trimmedName,
      url: base64Url
    };
    chat.settings.myAvatarLibrary.push(newItem);
    await db.chats.put(chat);

    renderMyAvatarLibrary();
    await showCustomAlert("Ê∑ªÂä†ÊàêÂäüÔºÅ", `Â§¥ÂÉè‚Äú${trimmedName}‚ÄùÂ∑≤Ê∑ªÂä†„ÄÇ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);

    // „Äê„Äê„ÄêÂ∑≤‰øÆÂ§çÁöÑË∞ÉÁî®„Äë„Äë„Äë
    (async () => {
      await silentlyUpdateDbUrl(
        db.chats, // table
        chat.id,  // recordId
        'settings.myAvatarLibrary', // pathString (ÊåáÂêëÊï∞ÁªÑ)
        base64Url, // base64ToFind
        trimmedName // nameToMatch
      );
    })();

    event.target.value = null;
  }


  async function handleBatchImportForMyAvatar(text) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const lines = text.trim().split('\n');
    const newAvatars = [];
    const baseUrl = 'https://files.catbox.moe/';
    let errorCount = 0;

    for (const line of lines) {
      const trimmedLine = line.trim();
      if (!trimmedLine || trimmedLine.includes('http') || trimmedLine.includes('Â°´ÂÖ•')) continue;

      let name = null,
        code = null;
      const noSpaceMatch = trimmedLine.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);

      if (noSpaceMatch) {
        name = noSpaceMatch[1];
        code = noSpaceMatch[2];
      } else {
        const parts = trimmedLine.split(/\s+/);
        if (parts.length >= 2) {
          code = parts.pop();
          name = parts.join(' ');
        }
      }

      if (name && code && code.includes('.')) {
        newAvatars.push({
          name: name,
          url: baseUrl + code
        });
      } else {
        errorCount++;
      }
    }

    if (errorCount > 0) await showCustomAlert('ÈÉ®ÂàÜÂØºÂÖ•Â§±Ë¥•', `Êúâ ${errorCount} Ë°åÁöÑÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∑≤Ë¢´Ë∑≥Ëøá„ÄÇ`);

    if (newAvatars.length > 0) {
      if (!chat.settings.myAvatarLibrary) chat.settings.myAvatarLibrary = [];
      chat.settings.myAvatarLibrary.push(...newAvatars);
      await db.chats.put(chat);
      renderMyAvatarLibrary();
      await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `Â∑≤ÊàêÂäüÊâπÈáèÂØºÂÖ• ${newAvatars.length} ‰∏™Êñ∞Â§¥ÂÉèÔºÅ`);
    } else if (errorCount === 0) {
      alert("Ê≤°ÊúâÊâæÂà∞ÂèØÂØºÂÖ•ÁöÑÂÜÖÂÆπ„ÄÇ");
    }
  }


  function closeMyAvatarLibraryModal() {
    document.getElementById('my-avatar-library-modal').classList.remove('visible');
  }





  function openGroupAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('group-avatar-library-title').textContent = `‚Äú${chat.name}‚ÄùÁöÑÂ§¥ÂÉèÂ∫ì`;
    renderGroupAvatarLibrary();
    document.getElementById('group-avatar-library-modal').classList.add('visible');
  }


  function renderGroupAvatarLibrary() {
    const grid = document.getElementById('group-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.groupAvatarLibrary || [];

    if (library.length === 0) {
      grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">Ëøô‰∏™Â§¥ÂÉèÂ∫ìËøòÊòØÁ©∫ÁöÑÔºåÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÂêßÔºÅ</p>';
      return;
    }

    library.forEach((avatar, index) => {
      const item = document.createElement('div');
      item.className = 'sticker-item';
      item.title = avatar.name;


      item.innerHTML = `
            <div class="sticker-image-container" style="background-image: url(${avatar.url});"></div>
            <span class="sticker-name">${avatar.name}</span>
        `;


      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn';
      deleteBtn.innerHTML = '√ó';
      deleteBtn.style.display = 'block';
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        const confirmed = await showCustomConfirm('Âà†Èô§Â§¥ÂÉè', `Á°ÆÂÆöË¶Å‰ªéÂ§¥ÂÉèÂ∫ì‰∏≠Âà†Èô§‚Äú${avatar.name}‚ÄùÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          chat.settings.groupAvatarLibrary.splice(index, 1);
          await db.chats.put(chat);
          renderGroupAvatarLibrary();
        }
      };
      item.appendChild(deleteBtn);
      grid.appendChild(item);
    });
  }


  async function addAvatarToGroupLibraryFromUR() {
    const name = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÊò•Êó•ÈáéÈ§ê„ÄÅÂ≠¶‰π†Êó∂Èó¥Ôºâ");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL", "", "url");
    if (!url || !url.trim().startsWith('http')) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
      return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat.settings.groupAvatarLibrary) {
      chat.settings.groupAvatarLibrary = [];
    }

    chat.settings.groupAvatarLibrary.push({
      name: name.trim(),
      url: url.trim()
    });
    await db.chats.put(chat);
    renderGroupAvatarLibrary();
  }


  function closeGroupAvatarLibraryModal() {
    document.getElementById('group-avatar-library-modal').classList.remove('visible');
  }



  async function openBatchImportModal(type) {
    const placeholderText = `ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÁ≤òË¥¥Ôºå‰∏ÄË°å‰∏Ä‰∏™Ôºö\n\nÁÑ¶Ëôë 2a9wte.jpeg\nÂ§ßÊÉäÂ§±Ëâ≤ or8qf4.png\nÊ≤°ÊúâÁÅµÊÑü njwujh.jpeg`;


    const pastedText = await showCustomPrompt(
      'ÊâπÈáèÂØºÂÖ•Â§¥ÂÉè',
      placeholderText,
      '',
      'textarea'
    );


    if (pastedText && pastedText.trim()) {
      await handleBatchImport(type, pastedText);
    }
  }



  async function handleBatchImport(type, text) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const lines = text.trim().split('\n');
    const newAvatars = [];
    const baseUrl = 'https://files.catbox.moe/';
    let errorCount = 0;

    for (const line of lines) {
      const trimmedLine = line.trim();

      if (!trimmedLine || trimmedLine.includes('http') || trimmedLine.includes('Â°´ÂÖ•')) {
        continue;
      }

      let name = null;
      let code = null;







      const noSpaceMatch = trimmedLine.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);

      if (noSpaceMatch) {

        name = noSpaceMatch[1];
        code = noSpaceMatch[2];
      } else {

        const parts = trimmedLine.split(/\s+/);
        if (parts.length >= 2) {
          code = parts.pop();
          name = parts.join(' ');
        }
      }


      if (name && code && code.includes('.')) {
        newAvatars.push({
          name: name,
          url: baseUrl + code
        });
      } else {
        errorCount++;
        console.warn('ÊâπÈáèÂØºÂÖ•Ê†ºÂºèÈîôËØØÔºåÂ∑≤Ë∑≥ËøáÊ≠§Ë°å:', trimmedLine);
      }
    }

    if (errorCount > 0) {
      await showCustomAlert('ÈÉ®ÂàÜÂØºÂÖ•Â§±Ë¥•', `Êúâ ${errorCount} Ë°åÁöÑÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∑≤Ë¢´Á≥ªÁªüË∑≥Ëøá„ÄÇ`);
    }

    if (newAvatars.length > 0) {
      if (type === 'ai') {
        if (!chat.settings.aiAvatarLibrary) chat.settings.aiAvatarLibrary = [];
        chat.settings.aiAvatarLibrary.push(...newAvatars);
        await db.chats.put(chat);
        renderAiAvatarLibrary();
      } else if (type === 'group') {
        if (!chat.settings.groupAvatarLibrary) chat.settings.groupAvatarLibrary = [];
        chat.settings.groupAvatarLibrary.push(...newAvatars);
        await db.chats.put(chat);
        renderGroupAvatarLibrary();
      }
      await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `Â∑≤ÊàêÂäüÊâπÈáèÂØºÂÖ• ${newAvatars.length} ‰∏™Êñ∞Â§¥ÂÉèÔºÅ`);
    } else if (errorCount === 0) {
      alert("Ê≤°ÊúâÊâæÂà∞ÂèØÂØºÂÖ•ÁöÑÂÜÖÂÆπ„ÄÇËØ∑Ê£ÄÊü•ÊÇ®Á≤òË¥¥ÁöÑÊ†ºÂºèÊòØÂê¶Ê≠£Á°Æ„ÄÇ");
    }
  }




  async function addAvatarToGroupLibraryFromURL() {
    const name = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÊò•Êó•ÈáéÈ§ê„ÄÅÂ≠¶‰π†Êó∂Èó¥Ôºâ");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL", "", "url");
    if (!url || !url.trim().startsWith('http')) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
      return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat.settings.groupAvatarLibrary) {
      chat.settings.groupAvatarLibrary = [];
    }

    chat.settings.groupAvatarLibrary.push({
      name: name.trim(),
      url: url.trim()
    });
    await db.chats.put(chat);
    renderGroupAvatarLibrary();
  }

  function showChatListActions(chat) {
    return new Promise(resolve => {
      const modal = document.getElementById('chat-list-actions-modal');
      const pinBtn = document.getElementById('chat-list-action-pin');
      const deleteBtn = document.getElementById('chat-list-action-delete');
      const cancelBtn = document.getElementById('chat-list-action-cancel');


      pinBtn.textContent = chat.isPinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂ËÅäÂ§©';


      const newPinBtn = pinBtn.cloneNode(true);
      pinBtn.parentNode.replaceChild(newPinBtn, pinBtn);
      newPinBtn.onclick = () => {
        modal.classList.remove('visible');
        resolve('pin');
      };

      const newDeleteBtn = deleteBtn.cloneNode(true);
      deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
      newDeleteBtn.onclick = () => {
        modal.classList.remove('visible');
        resolve('delete');
      };

      const newCancelBtn = cancelBtn.cloneNode(true);
      cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
      newCancelBtn.onclick = () => {
        modal.classList.remove('visible');
        resolve(null);
      };

      modal.classList.add('visible');
    });
  }




  function applyCPhoneWallpaper() {
    const charPhoneScreen = document.getElementById('character-phone-screen');
    const wallpaper = state.globalSettings.cphoneWallpaper;
    if (wallpaper) {

      charPhoneScreen.style.backgroundImage = `url("${wallpaper}")`;
    } else {

      charPhoneScreen.style.backgroundImage = 'linear-gradient(135deg, #f6d365, #fda085)';
    }
  }

  function applyMyPhoneWallpaper() {
    const myphoneScreen = document.getElementById('myphone-screen');
    const wallpaper = state.globalSettings.myphoneWallpaper;
    if (wallpaper) {

      myphoneScreen.style.backgroundImage = `url("${wallpaper}")`;
    } else {

      myphoneScreen.style.backgroundImage = 'linear-gradient(135deg, #a8edea, #fed6e3)';
    }
  }


  function applyCPhoneAppIcons() {
    // ÂÖà‰øùÂ≠òÊâÄÊúâ CPhone Â∫îÁî®ÂõæÊ†áÁöÑÈªòËÆ§ srcÔºàÂ¶ÇÊûúËøòÊ≤°‰øùÂ≠òÁöÑËØùÔºâ
    const iconElements = document.querySelectorAll('[id^="cphone-icon-img-"]');
    iconElements.forEach(img => {
      if (!img.dataset.defaultSrc) {
        img.dataset.defaultSrc = img.src;
      }
    });

    if (!state.globalSettings.cphoneAppIcons) return;

    for (const iconId in state.globalSettings.cphoneAppIcons) {
      const imgElement = document.getElementById(`cphone-icon-img-${iconId}`);
      if (imgElement) {
        imgElement.src = state.globalSettings.cphoneAppIcons[iconId];
      }
    }
  }

  function applyMyPhoneAppIconsGlobal() {
    // ÂÖà‰øùÂ≠òÊâÄÊúâ MyPhone Â∫îÁî®ÂõæÊ†áÁöÑÈªòËÆ§ srcÔºàÂ¶ÇÊûúËøòÊ≤°‰øùÂ≠òÁöÑËØùÔºâ
    const iconElements = document.querySelectorAll('[id^="myphone-icon-img-"]');
    iconElements.forEach(img => {
      if (!img.dataset.defaultSrc) {
        img.dataset.defaultSrc = img.src;
      }
    });

    if (!state.globalSettings.myphoneAppIcons) return;

    for (const iconId in state.globalSettings.myphoneAppIcons) {
      const imgElement = document.getElementById(`myphone-icon-img-${iconId}`);
      if (imgElement) {
        imgElement.src = state.globalSettings.myphoneAppIcons[iconId];
      }
    }
  }


  function renderCPhoneIconSettings() {
    const grid = document.getElementById('cphone-icon-settings-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const cphoneAppLabels = {
      'qq': 'QQ',
      'album': 'Áõ∏ÂÜå',
      'browser': 'ÊµèËßàÂô®',
      'taobao': 'Ê∑òÂÆù',
      'memo': 'Â§áÂøòÂΩï',
      'diary': 'Êó•ËÆ∞',
      'amap': 'È´òÂæ∑Âú∞Âõæ',
      'usage': 'AppËÆ∞ÂΩï',
      'music': 'ÁΩëÊòì‰∫ë',
      'bilibili': 'ÂìîÂì©ÂìîÂì©',
      'reddit': 'Reddit',
      'ephone': 'Ephone',
      'settings': 'ËÆæÁΩÆ'
    };

    for (const iconId in state.globalSettings.cphoneAppIcons) {
      const iconUrl = state.globalSettings.cphoneAppIcons[iconId];
      const labelText = cphoneAppLabels[iconId] || 'Êú™Áü•App';

      const item = document.createElement('div');
      item.className = 'icon-setting-item';
      item.dataset.iconId = iconId;

      item.innerHTML = `
                    <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
                    <button class="change-icon-btn">Êõ¥Êç¢</button>
                `;
      grid.appendChild(item);
    }
  }

  function renderMyPhoneIconSettings() {
    const grid = document.getElementById('myphone-icon-settings-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const myphoneAppLabels = {
      'qq': 'QQ',
      'album': 'Áõ∏ÂÜå',
      'browser': 'ÊµèËßàÂô®',
      'taobao': 'Ê∑òÂÆù',
      'memo': 'Â§áÂøòÂΩï',
      'diary': 'Êó•ËÆ∞',
      'amap': 'È´òÂæ∑Âú∞Âõæ',
      'usage': 'AppËÆ∞ÂΩï',
      'music': 'ÁΩëÊòì‰∫ë',
      'settings': 'ËÆæÁΩÆ',
      'records': 'Êü•ÁúãËÆ∞ÂΩï',
      'ephone': 'Ephone'
    };

    for (const iconId in state.globalSettings.myphoneAppIcons) {
      const iconUrl = state.globalSettings.myphoneAppIcons[iconId];
      const labelText = myphoneAppLabels[iconId] || 'Êú™Áü•App';

      const item = document.createElement('div');
      item.className = 'icon-setting-item';
      item.dataset.iconId = iconId;

      item.innerHTML = `
        <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
        <button class="change-icon-btn">Êõ¥Êç¢</button>
      `;
      grid.appendChild(item);
    }
  }




  function applyAppIcons() {
    // ÂÖà‰øùÂ≠òÊâÄÊúâÂ∫îÁî®ÂõæÊ†áÁöÑÈªòËÆ§ srcÔºàÂ¶ÇÊûúËøòÊ≤°‰øùÂ≠òÁöÑËØùÔºâ
    const iconElements = document.querySelectorAll('[id^="icon-img-"]');
    iconElements.forEach(img => {
      if (!img.dataset.defaultSrc) {
        img.dataset.defaultSrc = img.src;
      }
    });

    if (!state.globalSettings.appIcons) return;

    for (const iconId in state.globalSettings.appIcons) {
      const imgElement = document.getElementById(`icon-img-${iconId}`);
      if (imgElement) {
        imgElement.src = state.globalSettings.appIcons[iconId];
      }
    }
  }


  function renderIconSettings() {
    const grid = document.getElementById('icon-settings-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const appLabels = {
      'qq': 'QQ',
      'world-book': '‰∏ñÁïå‰π¶',
      'wallpaper': 'Â§ñËßÇËÆæÁΩÆ',
      'renderer': 'Ê∏≤ÊüìÂô®',
      'api-settings': 'APIËÆæÁΩÆ',
      'font': 'Â≠ó‰Ωì',
      'char-phone': 'Cphone',
      'douban': 'Ë±ÜÁì£Â∞èÁªÑ',

      'preset': 'È¢ÑËÆæ',

      'tutorial': 'ÊïôÁ®ã',
      'werewolf': 'Áãº‰∫∫ÊùÄ',

      'x': 'X',
      'alipay': 'ÊîØ‰ªòÂÆù',
      'auction': 'ÈªëÂ∏ÇÊãçÂçñ',
      'green-river': 'ÁªøÊ±ü',
      'mail': 'ÈÇÆÁÆ±',

      // Á¨¨‰∏âÈ°µÁöÑAPP
      'myphone': 'Myphone',
      'draw-guess': '‰Ω†ÁîªÊàëÁåú',
      'char-generator': 'ËßíËâ≤ÁîüÊàê'
    };


    for (const iconId in state.globalSettings.appIcons) {
      const iconUrl = state.globalSettings.appIcons[iconId];
      const labelText = appLabels[iconId] || 'Cphone';

      const item = document.createElement('div');
      item.className = 'icon-setting-item';

      item.dataset.iconId = iconId;

      item.innerHTML = `
                    <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
                    <button class="change-icon-btn">Êõ¥Êç¢</button>
                `;
      grid.appendChild(item);
    }
  }




  function openBrowser(timestamp) {
    if (!state.activeChatId) return;

    const chat = state.chats[state.activeChatId];

    if (!chat || !chat.history) return;

    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_link') {
      console.error("Êó†Ê≥ïÊâæÂà∞ÊàñÊ∂àÊÅØÁ±ªÂûã‰∏çÂåπÈÖçÁöÑÂàÜ‰∫´ÈìæÊé•:", timestamp);
      return;
    }


    document.getElementById('browser-title').textContent = message.source_name || 'ÊñáÁ´†ËØ¶ÊÉÖ';
    const browserContent = document.getElementById('browser-content');
    browserContent.innerHTML = `
                <h1 class="article-title">${message.title || 'Êó†Ê†áÈ¢ò'}</h1>
                <div class="article-meta">
                    <span>Êù•Ê∫ê: ${message.source_name || 'Êú™Áü•'}</span>
                </div>
                <div class="article-body">
                    <p>${(message.content || 'ÂÜÖÂÆπ‰∏∫Á©∫„ÄÇ').replace(/\n/g, '</p><p>')}</p>
                </div>
            `;


    showScreen('browser-screen');
  }







  function closeBrowser() {
    showScreen('chat-interface-screen');
  }






  function openShareLinkModal() {
    if (!state.activeChatId) return;


    document.getElementById('link-title-input').value = '';
    document.getElementById('link-description-input').value = '';
    document.getElementById('link-source-input').value = '';
    document.getElementById('link-content-input').value = '';


    document.getElementById('share-link-modal').classList.add('visible');
  }


  async function sendUserLinkShare() {
    if (!state.activeChatId) return;

    const title = document.getElementById('link-title-input').value.trim();
    if (!title) {
      alert("Ê†áÈ¢òÊòØÂøÖÂ°´È°πÂì¶ÔºÅ");
      return;
    }

    const description = document.getElementById('link-description-input').value.trim();
    const sourceName = document.getElementById('link-source-input').value.trim();
    const content = document.getElementById('link-content-input').value.trim();

    const chat = state.chats[state.activeChatId];


    const linkMessage = {
      role: 'user',
      type: 'share_link',
      timestamp: Date.now(),
      title: title,
      description: description,
      source_name: sourceName,
      content: content,

      thumbnail_url: null
    };


    chat.history.push(linkMessage);
    await db.chats.put(chat);


    appendMessage(linkMessage, chat);
    renderChatList();


    document.getElementById('share-link-modal').classList.remove('visible');
  }




  function filterVisiblePostsForAI(allPosts, viewerChat) {
    if (!viewerChat || !viewerChat.id) return [];

    const viewerGroupId = viewerChat.groupId;
    const viewerId = viewerChat.id;

    return allPosts.filter(post => {

      if (post.authorId === 'user') {
        if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
          return viewerGroupId && post.visibleGroupIds.includes(viewerGroupId);
        }
        return true;
      }




      if (String(post.authorId).startsWith('npc_')) {

        if (Array.isArray(post.visibleTo)) {
          return post.visibleTo.includes(viewerId);
        }

        return false;
      }




      const authorChat = state.chats[post.authorId];
      if (!authorChat) {
        return false;
      }
      const authorGroupId = authorChat.groupId;

      const inSameGroup = authorGroupId && viewerGroupId && authorGroupId === viewerGroupId;
      const bothUnGrouped = !authorGroupId && !viewerGroupId;

      return inSameGroup || bothUnGrouped;
    });
  }

  function applyPhoneFrame(isEnabled) {

    document.body.classList.toggle('frame-mode-active', isEnabled);


    if (musicState.isActive) {
      const lyricBar = document.getElementById('global-lyrics-bar');
      const phoneScreenForIsland = document.getElementById('phone-screen');
      const isAlwaysIslandMode = state.globalSettings.alwaysShowMusicIsland || false;

      if (isEnabled) {

        lyricBar.classList.remove('visible');
        phoneScreenForIsland.classList.add('dynamic-island-active');
      } else {

        phoneScreenForIsland.classList.remove('dynamic-island-active');

        if (isAlwaysIslandMode) {

          phoneScreenForIsland.classList.add('dynamic-island-active');
          lyricBar.classList.remove('visible');
        } else {

          if (musicState.parsedLyrics && musicState.parsedLyrics.length > 0) {
            lyricBar.classList.add('visible');
          }
        }
      }
    }
  }

  function applyDetachStatusBarMode(isEnabled) {
    document.body.classList.toggle('detach-mode-active', isEnabled);
  }

  function applyMinimalChatUI(isEnabled) {
    document.body.classList.toggle('minimal-chat-ui-active', isEnabled);
  }


  function applyTheme(theme) {
    const phoneScreen = document.getElementById('phone-screen');
    const toggleSwitch = document.getElementById('theme-toggle-switch');

    const isDark = theme === 'dark';

    phoneScreen.classList.toggle('dark-mode', isDark);


    if (toggleSwitch) {
      toggleSwitch.checked = isDark;
    }

    localStorage.setItem('ephone-theme', theme);
  }


  function toggleTheme() {
    const toggleSwitch = document.getElementById('theme-toggle-switch');

    const newTheme = toggleSwitch.checked ? 'dark' : 'light';
    applyTheme(newTheme);
  }


  function openLongTermMemoryScreen() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    
    // ÊòæÁ§∫/ÈöêËóè tab Ê†è
    const tabBar = document.getElementById('memory-tab-bar');
    if (chat && chat.settings.enableStructuredMemory) {
      tabBar.style.display = 'flex';
    } else {
      tabBar.style.display = 'none';
    }
    
    // ÈªòËÆ§ÊòæÁ§∫ÂéüÂßãËÆ∞ÂøÜ
    switchMemoryTab('original');
    showScreen('long-term-memory-screen');
  }

  // ÂàáÊç¢ËÆ∞ÂøÜ Tab
  function switchMemoryTab(tabName) {
    const originalList = document.getElementById('original-memory-list');
    const structuredContainer = document.getElementById('structured-memory-container');
    const tabs = document.querySelectorAll('#memory-tab-bar .sm-tab');
    
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
    
    if (tabName === 'original') {
      originalList.style.display = 'block';
      structuredContainer.style.display = 'none';
      renderLongTermMemoryList();
    } else {
      originalList.style.display = 'none';
      structuredContainer.style.display = 'block';
      renderStructuredMemoryView();
    }
  }

  // Ê∏≤ÊüìÁªìÊûÑÂåñËÆ∞ÂøÜËßÜÂõæ
  function renderStructuredMemoryView() {
    const container = document.getElementById('structured-memory-container');
    const chat = state.chats[state.activeChatId];
    if (!chat || !window.structuredMemoryManager) {
      container.innerHTML = '<p style="text-align:center; color:#999; margin-top:40px;">ÁªìÊûÑÂåñËÆ∞ÂøÜÊ®°ÂùóÊú™Âä†ËΩΩ</p>';
      return;
    }
    
    window.structuredMemoryManager.renderMemoryTable(chat, container);
    
    // ÁªëÂÆöÂ∑•ÂÖ∑Ê†èÊåâÈíÆ
    const addCategoryBtn = container.querySelector('#sm-add-category-btn');
    if (addCategoryBtn) {
      addCategoryBtn.addEventListener('click', async () => {
        const name = await showCustomPrompt('Êñ∞Âª∫Ëá™ÂÆö‰πâÂàÜÁ±ª', 'ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞ÔºàÂ¶ÇÔºöÁ∫¶‰ºöËÆ∞ÂΩï„ÄÅÂÖ±ÂêåÁà±Â•Ω„ÄÅÂêµÊû∂ËÆ∞ÂΩïÔºâ');
        if (!name || !name.trim()) return;
        
        // Ëá™Âä®ÁîüÊàêÂàÜÁ±ª‰ª£Á†ÅÔºàÂèñÈ¶ñÂ≠óÊØçÊàñÁî®Â∫èÂè∑Ôºâ
        const mem = window.structuredMemoryManager.getStructuredMemory(chat);
        const existingCodes = Object.keys(window.structuredMemoryManager.getCategories(chat));
        let code = name.trim().substring(0, 2).toUpperCase();
        // Â¶ÇÊûú‰ª£Á†ÅÂÜ≤Á™ÅÔºåÂä†Êï∞Â≠óÂêéÁºÄ
        let suffix = 1;
        let finalCode = code;
        while (existingCodes.includes(finalCode)) {
          finalCode = code + suffix;
          suffix++;
        }
        
        window.structuredMemoryManager.addCustomCategory(chat, finalCode, name.trim());
        await db.chats.put(chat);
        renderStructuredMemoryView();
        showToast(`ÂàÜÁ±ª"${name.trim()}"Â∑≤ÂàõÂª∫`, 'success');
      });
    }
    
    const addEntryBtn = container.querySelector('#sm-add-entry-btn');
    if (addEntryBtn) {
      addEntryBtn.addEventListener('click', async () => {
        const selectedCode = await showCategoryPickerModal(chat);
        if (!selectedCode) return;
        
        const categories = window.structuredMemoryManager.getCategories(chat);
        const cat = categories[selectedCode];
        if (!cat) return;
        
        let placeholder = 'ËæìÂÖ•ËÆ∞ÂøÜÂÜÖÂÆπ';
        if (selectedCode === 'F') placeholder = 'Ê†ºÂºèÔºökey=valueÔºàÂ¶ÇÔºöÁî®Êà∑Âè£Âë≥=ËçâËéì+ÊäπËå∂Ôºâ';
        
        const content = await showCustomPrompt(`Ê∑ªÂä†Âà∞"${cat.name}"`, placeholder);
        if (!content || !content.trim()) return;
        
        window.structuredMemoryManager.addManualEntry(chat, selectedCode, content.trim());
        await db.chats.put(chat);
        renderStructuredMemoryView();
        showToast('Êù°ÁõÆÂ∑≤Ê∑ªÂä†', 'success');
      });
    }
    
    // ÁªëÂÆöÈáçÁΩÆÊõ¥Êñ∞ÊåâÈíÆ
    const resetTimestampBtn = container.querySelector('#sm-reset-timestamp-btn');
    if (resetTimestampBtn) {
      resetTimestampBtn.addEventListener('click', async () => {
        const debugInfo = window.structuredMemoryManager.getDebugInfo(chat);
        const message = `ÂΩìÂâçÁä∂ÊÄÅÔºö
- ‰∏äÊ¨°Êõ¥Êñ∞Ôºö${debugInfo.lastDate}
- ÊÄªÊ∂àÊÅØÊï∞Ôºö${debugInfo.totalMessages}
- ÂæÖÂ§ÑÁêÜÊ∂àÊÅØÔºö${debugInfo.messagesAfterTimestamp}

Â¶ÇÊûúÁªìÊûÑÂåñËÆ∞ÂøÜÈïøÊó∂Èó¥Êú™Êõ¥Êñ∞ÔºåÈáçÁΩÆÂêé‰∏ãÊ¨°ÂØπËØùÂ∞ÜÈáçÊñ∞ÊèêÂèñÊâÄÊúâÊú™Â§ÑÁêÜÁöÑÊ∂àÊÅØ„ÄÇ

Á°ÆÂÆöË¶ÅÈáçÁΩÆÂêóÔºü`;
        
        const confirmed = await showCustomConfirm('ÈáçÁΩÆÊõ¥Êñ∞Êó∂Èó¥Êà≥', message);
        if (confirmed) {
          window.structuredMemoryManager.resetTimestamp(chat);
          await db.chats.put(chat);
          showToast('Â∑≤ÈáçÁΩÆÔºå‰∏ãÊ¨°ÂØπËØùÂ∞ÜÈáçÊñ∞ÊèêÂèñËÆ∞ÂøÜ', 'success');
        }
      });
    }
    
    // ÁªëÂÆöÊØè‰∏™ÂàÜÁ±ªÂå∫ÂüüÁöÑ"Ê∑ªÂä†Êù°ÁõÆ"ÊåâÈíÆ
    container.querySelectorAll('.sm-add-to-cat-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const categoryCode = btn.dataset.code;
        const categories = window.structuredMemoryManager.getCategories(chat);
        const cat = categories[categoryCode];
        if (!cat) return;
        
        let placeholder = 'ËæìÂÖ•ËÆ∞ÂøÜÂÜÖÂÆπ';
        if (categoryCode === 'F') placeholder = 'Ê†ºÂºèÔºökey=valueÔºàÂ¶ÇÔºöÁî®Êà∑Âè£Âë≥=ËçâËéì+ÊäπËå∂Ôºâ';
        
        const content = await showCustomPrompt(`Ê∑ªÂä†Âà∞"${cat.name}"`, placeholder);
        if (!content || !content.trim()) return;
        
        window.structuredMemoryManager.addManualEntry(chat, categoryCode, content.trim());
        await db.chats.put(chat);
        renderStructuredMemoryView();
        showToast('Êù°ÁõÆÂ∑≤Ê∑ªÂä†', 'success');
      });
    });

    // ÁªëÂÆöÁºñËæëÂíåÂà†Èô§‰∫ã‰ª∂
    container.querySelectorAll('.sm-edit-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const category = btn.dataset.category;
        const index = parseInt(btn.dataset.index);
        const row = btn.closest('.sm-item-row');
        const currentContent = row.querySelector('.sm-item-content').textContent;
        
        const newContent = await showCustomPrompt('ÁºñËæëËÆ∞ÂøÜÊù°ÁõÆ', '‰øÆÊîπÂÜÖÂÆπÔºö', currentContent);
        if (newContent !== null && newContent.trim() !== '') {
          window.structuredMemoryManager.editEntry(chat, category, index, newContent.trim());
          await db.chats.put(chat);
          renderStructuredMemoryView();
        }
      });
    });
    
    container.querySelectorAll('.sm-delete-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const category = btn.dataset.category;
        const index = parseInt(btn.dataset.index);
        const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂøÜÂêóÔºü');
        if (confirmed) {
          window.structuredMemoryManager.deleteEntry(chat, category, index);
          await db.chats.put(chat);
          renderStructuredMemoryView();
        }
      });
    });
    
    // ÁªëÂÆöËá™ÂÆö‰πâÂàÜÁ±ªÁöÑÈáçÂëΩÂêçÂíåÂà†Èô§
    container.querySelectorAll('.sm-rename-cat-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const code = btn.dataset.code;
        const categories = window.structuredMemoryManager.getCategories(chat);
        const currentName = categories[code] ? categories[code].name : code;
        
        const newName = await showCustomPrompt('ÈáçÂëΩÂêçÂàÜÁ±ª', 'ËæìÂÖ•Êñ∞ÂêçÁß∞Ôºö', currentName);
        if (newName !== null && newName.trim() !== '') {
          window.structuredMemoryManager.renameCustomCategory(chat, code, newName.trim());
          await db.chats.put(chat);
          renderStructuredMemoryView();
        }
      });
    });
    
    container.querySelectorAll('.sm-delete-cat-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const code = btn.dataset.code;
        const categories = window.structuredMemoryManager.getCategories(chat);
        const catName = categories[code] ? categories[code].name : code;
        const mem = window.structuredMemoryManager.getStructuredMemory(chat);
        const itemCount = (mem._custom[code] || []).length;
        
        const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§ÂàÜÁ±ª',
          `Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁ±ª"${catName}"ÂêóÔºü${itemCount > 0 ? `ÂÖ∂‰∏≠ÁöÑ ${itemCount} Êù°ËÆ∞ÂøÜ‰πü‰ºöË¢´Âà†Èô§„ÄÇ` : ''}Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`,
          { confirmButtonClass: 'btn-danger', confirmText: 'Á°ÆËÆ§Âà†Èô§' }
        );
        if (confirmed) {
          window.structuredMemoryManager.deleteCustomCategory(chat, code);
          await db.chats.put(chat);
          renderStructuredMemoryView();
          showToast(`ÂàÜÁ±ª"${catName}"Â∑≤Âà†Èô§`, 'info');
        }
      });
    });
  }



  // 1. ‰øÆÊîπ renderLongTermMemoryList (Âè™Ë¥üË¥£ÂáÜÂ§áÊï∞ÊçÆÂíåÈáçÁΩÆ)
  function renderLongTermMemoryList() {
    const container = document.getElementById('original-memory-list') || document.getElementById('memory-list-container');
    const chat = state.chats[state.activeChatId];
    container.innerHTML = '';

    let memoriesToDisplay = [];

    if (chat.isGroup) {
      chat.members.forEach(member => {
        const memberChat = state.chats[member.id];
        if (memberChat && memberChat.longTermMemory) {
          const memberMemories = memberChat.longTermMemory.map(mem => ({
            ...mem,
            authorName: member.groupNickname,
            authorChatId: member.id,
            authorAvatar: member.avatar || (memberChat.settings.aiAvatar || defaultAvatar)
          }));
          memoriesToDisplay.push(...memberMemories);
        }
      });
    } else {
      if (chat.longTermMemory) {
        memoriesToDisplay = chat.longTermMemory.map(mem => ({
          ...mem,
          authorName: chat.name,
          authorChatId: chat.id,
          authorAvatar: chat.settings.aiAvatar || defaultAvatar
        }));
      }
    }

    if (memoriesToDisplay.length === 0) {
      container.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">ËøôÈáåËøòÊ≤°Êúâ‰ªª‰ΩïÈïøÊúüËÆ∞ÂøÜ„ÄÇ</p>';
      return;
    }

    // ÊåâÊó∂Èó¥ÂÄíÂ∫è
    memoriesToDisplay.sort((a, b) => b.timestamp - a.timestamp);

    // --- Ê†∏ÂøÉ‰øÆÊîπÔºöÂ≠òÂÖ•ÁºìÂ≠òÔºåÈáçÁΩÆËÆ°Êï∞ÔºåË∞ÉÁî®ÂàÜÊâπÂä†ËΩΩ ---
    memoryCache = memoriesToDisplay;
    memoryRenderCount = 0;
    loadMoreMemories();
  }

  // 2. Êñ∞Â¢û loadMoreMemories (Ë¥üË¥£ÂàÜÊâπÊ∏≤Êüì)
  // 2. Êñ∞Â¢û loadMoreMemories (Ë¥üË¥£ÂàÜÊâπÊ∏≤Êüì) - [‰øÆÂ§çÁâà]
  function loadMoreMemories() {
    // 1. Èò≤Ê≠¢ÈáçÂ§çÂä†ËΩΩ
    if (isLoadingMoreMemories) return;

    const container = document.getElementById('original-memory-list') || document.getElementById('memory-list-container');
    if (!container) return;

    // 2. Â¶ÇÊûúÊâÄÊúâÊï∞ÊçÆÈÉΩÂ∑≤ÁªèÊ∏≤ÊüìÂÆå‰∫ÜÔºåÁõ¥Êé•ËøîÂõû
    if (memoryRenderCount >= memoryCache.length) return;

    // Âä†ÈîÅ
    isLoadingMoreMemories = true;

    try {
      // ÊØèÊ¨°Âä†ËΩΩ 20 Êù°
      const BATCH_SIZE = 20;
      const nextSliceEnd = memoryRenderCount + BATCH_SIZE;
      const itemsToRender = memoryCache.slice(memoryRenderCount, nextSliceEnd);

      const fragment = document.createDocumentFragment();

      itemsToRender.forEach(memory => {
        const item = document.createElement('div');
        item.className = 'favorite-item-card';
        item.style.cursor = 'default';

        const date = new Date(memory.timestamp);
        const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        const avatarUrl = memory.authorAvatar || defaultAvatar;

        item.innerHTML = `
                <div class="fav-card-header">
                    <img src="${avatarUrl}" class="avatar" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                    <div class="info">
                        <div class="name" style="font-size: 15px;">${memory.authorName}</div>
                        <div class="source" style="font-size: 12px; color: #999;">${dateString}</div>
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button class="memory-action-btn edit-memory-btn" data-author-id="${memory.authorChatId}" data-memory-timestamp="${memory.timestamp}" title="ÁºñËæë">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px;">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="memory-action-btn delete-memory-btn" data-author-id="${memory.authorChatId}" data-memory-timestamp="${memory.timestamp}" title="Âà†Èô§">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px; stroke:#ff3b30;">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="fav-card-content" style="margin-top: 5px;">${memory.content.replace(/\n/g, '<br>')}</div>
            `;
        fragment.appendChild(item);
      });

      container.appendChild(fragment);
      memoryRenderCount += itemsToRender.length;

      // „Äê‰øÆÂ§çÂÖ≥ÈîÆÁÇπ„ÄëÔºöÊ£ÄÊü•ÊòØÂê¶Â°´Êª°Â±èÂπï
      // Â¶ÇÊûúÂÆπÂô®ÁöÑÂÜÖÂÆπÈ´òÂ∫¶ <= ÂÆπÂô®ÂèØËßÅÈ´òÂ∫¶ÔºàËØ¥ÊòéÊ≤°ÊúâÂá∫Áé∞ÊªöÂä®Êù°ÔºâÔºå‰∏îËøòÊúâÂâ©‰ΩôÊï∞ÊçÆ
      // Á´ãÂç≥ËØ∑Ê±ÇÂä†ËΩΩ‰∏ã‰∏ÄÈ°µÔºåÁõ¥Âà∞Â°´Êª°Â±èÂπïÂá∫Áé∞ÊªöÂä®Êù°‰∏∫Ê≠¢
      if (container.scrollHeight <= container.clientHeight && memoryRenderCount < memoryCache.length) {
        isLoadingMoreMemories = false; // ‰∏¥Êó∂Ëß£ÈîÅ‰ª•‰æøÈÄíÂΩíË∞ÉÁî®
        loadMoreMemories(); // ÈÄíÂΩíÂä†ËΩΩ
        return; // ÈÄÄÂá∫ÂΩìÂâçÂáΩÊï∞ÔºåÁî±ÈÄíÂΩíË∞ÉÁî®Êé•ÁÆ°ÈîÅ
      }

    } catch (error) {
      console.error("Ê∏≤ÊüìÈïøÊúüËÆ∞ÂøÜÂá∫Èîô:", error);
    } finally {
      // 3. Êó†ËÆ∫ÊàêÂäüËøòÊòØÂá∫ÈîôÔºå‰∏ÄÂÆöË¶ÅËß£ÈîÅ
      isLoadingMoreMemories = false;
    }
  }


  async function handleAddManualMemory() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    let targetChatForMemory = chat;
    if (chat.isGroup) {
      const memberOptions = chat.members.map(member => ({
        text: `‰∏∫‚Äú${member.groupNickname}‚ÄùÊ∑ªÂä†ËÆ∞ÂøÜ`,
        value: member.id
      }));
      const selectedMemberId = await showChoiceModal('ÈÄâÊã©ËÆ∞ÂøÜÊâÄÂ±ûËßíËâ≤', memberOptions);
      if (!selectedMemberId) return;
      targetChatForMemory = state.chats[selectedMemberId];
      if (!targetChatForMemory) {
        alert("ÈîôËØØÔºöÊâæ‰∏çÂà∞ËØ•ÊàêÂëòÁöÑ‰∏™‰∫∫Ê°£Ê°à„ÄÇ");
        return;
      }
    }
    const content = await showCustomPrompt(`‰∏∫‚Äú${targetChatForMemory.name}‚ÄùÊ∑ªÂä†ËÆ∞ÂøÜ`, 'ËØ∑ËæìÂÖ•Ë¶ÅÊ∑ªÂä†ÁöÑËÆ∞ÂøÜË¶ÅÁÇπÔºö', '', 'textarea');
    if (content && content.trim()) {
      if (!targetChatForMemory.longTermMemory) targetChatForMemory.longTermMemory = [];
      targetChatForMemory.longTermMemory.push({
        content: content.trim(),
        timestamp: Date.now(),
        source: 'manual'
      });
      await db.chats.put(targetChatForMemory);
      renderLongTermMemoryList();
    }
  }



  async function handleEditMemory(authorChatId, memoryTimestamp) {
    const authorChat = state.chats[authorChatId];
    if (!authorChat || !authorChat.longTermMemory) return;
    const memoryIndex = authorChat.longTermMemory.findIndex(m => m.timestamp === memoryTimestamp);
    if (memoryIndex === -1) return;
    const memory = authorChat.longTermMemory[memoryIndex];
    const newContent = await showCustomPrompt('ÁºñËæëËÆ∞ÂøÜ', 'ËØ∑‰øÆÊîπËÆ∞ÂøÜË¶ÅÁÇπÔºö', memory.content, 'textarea');
    if (newContent && newContent.trim()) {
      memory.content = newContent.trim();
      await db.chats.put(authorChat);
      renderLongTermMemoryList();
    }
  }

  async function handleDeleteMemory(authorChatId, memoryTimestamp) {
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÈïøÊúüËÆ∞ÂøÜÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      const authorChat = state.chats[authorChatId];
      if (!authorChat || !authorChat.longTermMemory) return;
      authorChat.longTermMemory = authorChat.longTermMemory.filter(m => m.timestamp !== memoryTimestamp);
      await db.chats.put(authorChat);
      renderLongTermMemoryList();
    }
  }



  async function handleManualSummary() {
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Êìç‰Ωú', 'ËøôÂ∞ÜÊèêÂèñÊúÄËøëÁöÑÂØπËØùÂÜÖÂÆπÂèëÈÄÅÁªôAIËøõË°åÊÄªÁªìÔºå‰ºöÊ∂àËÄóAPIÈ¢ùÂ∫¶„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü');
    if (confirmed) {
      await triggerAutoSummary(state.activeChatId, true);
      
      // Â¶ÇÊûúÂºÄÂêØ‰∫ÜÁªìÊûÑÂåñËÆ∞ÂøÜÔºå‰πüËß¶ÂèëÁªìÊûÑÂåñÊÄªÁªì
      const chat = state.chats[state.activeChatId];
      if (chat && chat.settings.enableStructuredMemory && window.structuredMemoryManager) {
        await triggerStructuredMemorySummary(state.activeChatId, true); // ÊâãÂä®ÊÄªÁªìÊó∂Âº∫Âà∂Êõ¥Êñ∞
        showToast('ÁªìÊûÑÂåñËÆ∞ÂøÜÂ∑≤ÂêåÊ≠•Êõ¥Êñ∞', 'success');
      }
    }
  }

  // ==================== ÁªìÊûÑÂåñÂä®ÊÄÅËÆ∞ÂøÜ - ÈïøÊúüËÆ∞ÂøÜËΩ¨Êç¢ ====================
  async function convertLongTermMemoryToStructured(chatId) {
    const chat = state.chats[chatId];
    if (!chat || !window.structuredMemoryManager || !chat.longTermMemory || chat.longTermMemory.length === 0) {
      showToast('Ê≤°ÊúâÂèØËΩ¨Êç¢ÁöÑÈïøÊúüËÆ∞ÂøÜ', 'warning');
      return;
    }

    const totalMemories = chat.longTermMemory.length;
    const BATCH_SIZE = 50; // ÊØèÊâπÂ§ÑÁêÜ50Êù°ËÆ∞ÂøÜ
    const totalBatches = Math.ceil(totalMemories / BATCH_SIZE);

    // ‰º∞ÁÆóÊÄª token Êï∞
    const estimatedTotalTokens = chat.longTermMemory.reduce((sum, mem) => sum + mem.content.length, 0) / 1.5;
    
    // È¢ÑÊ£ÄÊü•ÔºöÂ¶ÇÊûúËÆ∞ÂøÜËøáÂ§öÔºåÁªôÂá∫ÊèêÁ§∫
    let shouldProceed = true;
    if (totalMemories > 100) {
      const message = `Ê£ÄÊµãÂà∞Â§ßÈáèÈïøÊúüËÆ∞ÂøÜÔºö\n\n- ËÆ∞ÂøÜÊï∞ÈáèÔºö${totalMemories} Êù°\n- ‰º∞ÁÆó TokenÔºöÁ∫¶ ${Math.ceil(estimatedTotalTokens)} tokens\n- Â∞ÜÂàÜ ${totalBatches} ÊâπËΩ¨Êç¢\n- È¢ÑËÆ°ËÄóÊó∂Ôºö${Math.ceil(totalBatches * 0.5)} ÂàÜÈíü\n\nÁªßÁª≠ËΩ¨Êç¢Ôºü`;
      shouldProceed = await showCustomConfirm('ÈïøÊúüËÆ∞ÂøÜËΩ¨Êç¢', message);
    }

    if (!shouldProceed) {
      showToast('Â∑≤ÂèñÊ∂àËΩ¨Êç¢', 'info');
      return;
    }

    const userNickname = chat.settings.myNickname || (state.qzoneSettings.nickname || 'Áî®Êà∑');
    
    // API ÈÖçÁΩÆ
    const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
    const { proxyUrl, apiKey, model } = useSecondaryApi
      ? { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel }
      : state.apiConfig;

    if (!proxyUrl || !apiKey || !model) {
      showToast('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïËΩ¨Êç¢', 'error');
      return;
    }

    // ÂàõÂª∫ËøõÂ∫¶ÊèêÁ§∫
    let progressToast = null;
    let isCancelled = false;
    
    const updateProgress = (current, total, successCount) => {
      const message = `ËΩ¨Êç¢‰∏≠... ${current}/${total} Êâπ\nÂ∑≤ÊèêÂèñ ${successCount} Êù°ÁªìÊûÑÂåñËÆ∞ÂøÜ`;
      if (progressToast) {
        // Êõ¥Êñ∞Áé∞ÊúâÊèêÁ§∫
        const toastElement = document.querySelector('.toast:last-child');
        if (toastElement) {
          toastElement.textContent = message;
        }
      } else {
        progressToast = showToast(message, 'info', 0); // ÊåÅÁª≠ÊòæÁ§∫
      }
    };

    let totalEntriesExtracted = 0;
    let successfulBatches = 0;
    let failedBatches = 0;

    try {
      // ÂàÜÊâπÂ§ÑÁêÜ
      for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
        if (isCancelled) {
          showToast('ËΩ¨Êç¢Â∑≤ÂèñÊ∂à', 'info');
          break;
        }

        const start = batchIndex * BATCH_SIZE;
        const end = Math.min(start + BATCH_SIZE, totalMemories);
        const batchMemories = chat.longTermMemory.slice(start, end);

        updateProgress(batchIndex + 1, totalBatches, totalEntriesExtracted);

        // Ê†ºÂºèÂåñÂΩìÂâçÊâπÊ¨°ÁöÑËÆ∞ÂøÜ
        const formattedMemories = batchMemories.map((mem, index) => {
          const date = new Date(mem.timestamp);
          const dateStr = date.toLocaleString('zh-CN', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', hour12: false
          });
          return `[ËÆ∞ÂøÜ ${start + index + 1}] (${dateStr}) ${mem.content}`;
        }).join('\n');

        const timeRangeStr = `ÈïøÊúüËÆ∞ÂøÜÂ∫ì Á¨¨ ${batchIndex + 1}/${totalBatches} Êâπ (ÂÖ± ${batchMemories.length} Êù°)`;
        const systemPrompt = window.structuredMemoryManager.buildSummaryPrompt(chat, formattedMemories, timeRangeStr);

        try {
          let isGemini = proxyUrl.includes('generativelanguage');
          let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: 'ËØ∑Â∞Ü‰ª•‰∏äÈïøÊúüËÆ∞ÂøÜÂÖ®ÈÉ®ÊèêÂèñ‰∏∫ÁªìÊûÑÂåñËÆ∞ÂøÜÊù°ÁõÆ„ÄÇ' }]);

          const response = isGemini
            ? await fetch(geminiConfig.url, geminiConfig.data)
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                  model,
                  messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: 'ËØ∑Â∞Ü‰ª•‰∏äÈïøÊúüËÆ∞ÂøÜÂÖ®ÈÉ®ÊèêÂèñ‰∏∫ÁªìÊûÑÂåñËÆ∞ÂøÜÊù°ÁõÆ„ÄÇ' }],
                  temperature: 0.3
                })
              });

          if (!response.ok) {
            console.warn(`ÊâπÊ¨° ${batchIndex + 1} API ÈîôËØØ: ${response.statusText}`);
            failedBatches++;
            continue;
          }

          const data = await response.json();
          let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
          rawContent = rawContent.replace(/^```[a-z]*\s*/g, '').replace(/```$/g, '').trim();

          // Ëß£ÊûêÂπ∂ÂêàÂπ∂
          const entries = window.structuredMemoryManager.parseMemoryEntries(rawContent, chat);
          if (entries.length > 0) {
            window.structuredMemoryManager.mergeEntries(chat, entries);
            totalEntriesExtracted += entries.length;
            successfulBatches++;
            console.log(`ÊâπÊ¨° ${batchIndex + 1}/${totalBatches}: ÊàêÂäüÊèêÂèñ ${entries.length} Êù°ËÆ∞ÂøÜ`);
          } else {
            console.warn(`ÊâπÊ¨° ${batchIndex + 1}/${totalBatches}: AI Êú™ËøîÂõûÊúâÊïàÊï∞ÊçÆ`);
            console.warn('AI ËøîÂõûÂÜÖÂÆπ:', rawContent.substring(0, 500)); // ËÆ∞ÂΩïÂâç500Â≠óÁ¨¶Áî®‰∫éË∞ÉËØï
            failedBatches++;
          }

          // ÊØèÊâπÂ§ÑÁêÜÂêé‰øùÂ≠ò‰∏ÄÊ¨°
          await db.chats.put(chat);

          // ÊâπÊ¨°Èó¥Âª∂ËøüÔºåÈÅøÂÖç API ÈôêÊµÅ
          if (batchIndex < totalBatches - 1) {
            await new Promise(resolve => setTimeout(resolve, 1000)); // Âª∂Ëøü1Áßí
          }

        } catch (batchError) {
          console.error(`ÊâπÊ¨° ${batchIndex + 1} Â§ÑÁêÜÂá∫Èîô:`, batchError);
          failedBatches++;
          continue;
        }
      }

      // Ê∏ÖÈô§ËøõÂ∫¶ÊèêÁ§∫
      if (progressToast) {
        const toastElements = document.querySelectorAll('.toast');
        toastElements.forEach(el => el.remove());
      }

      // ÊúÄÁªàÁªìÊûúÊèêÁ§∫
      if (totalEntriesExtracted > 0) {
        let resultMessage = `ËΩ¨Êç¢ÂÆåÊàêÔºÅ\n- ÊàêÂäüÊâπÊ¨°Ôºö${successfulBatches}/${totalBatches}\n- ÊèêÂèñËÆ∞ÂøÜÔºö${totalEntriesExtracted} Êù°`;
        if (failedBatches > 0) {
          resultMessage += `\n- Â§±Ë¥•ÊâπÊ¨°Ôºö${failedBatches}`;
        }
        showToast(resultMessage, successfulBatches === totalBatches ? 'success' : 'warning', 5000);
        console.log(`ÈïøÊúüËÆ∞ÂøÜËΩ¨Êç¢ÂÆåÊàê: ${totalMemories} Êù°ËÆ∞ÂøÜ -> ${totalEntriesExtracted} Êù°ÁªìÊûÑÂåñËÆ∞ÂøÜ (${successfulBatches}/${totalBatches} ÊâπÊàêÂäü)`);
      } else {
        showToast(`ËΩ¨Êç¢Â§±Ë¥•ÔºöÊâÄÊúâÊâπÊ¨°ÈÉΩÊú™ËÉΩÊèêÂèñÊúâÊïàÊï∞ÊçÆ\n- ÂéüËÆ∞ÂøÜÊï∞Ôºö${totalMemories} Êù°\n- Â§±Ë¥•ÊâπÊ¨°Ôºö${failedBatches}\n\nÂèØËÉΩÂéüÂõ†Ôºö\n1. Token Êï∞Èáè‰ªçÁÑ∂ËøáÂ§ö\n2. AI ËøîÂõûÊ†ºÂºè‰∏çÁ¨¶ÂêàË¶ÅÊ±Ç\n3. API ÈÖçÁΩÆÈóÆÈ¢ò\n\nËØ∑Êü•ÁúãÊéßÂà∂Âè∞Ëé∑ÂèñËØ¶ÁªÜ‰ø°ÊÅØ`, 'error', 8000);
        console.error('ÈïøÊúüËÆ∞ÂøÜËΩ¨Êç¢Â§±Ë¥•ÔºöÊú™ËÉΩÊèêÂèñ‰ªª‰ΩïÊúâÊïàÊù°ÁõÆ');
        console.error('ËÆ∞ÂøÜÊÄªÊï∞:', totalMemories);
        console.error('‰º∞ÁÆó tokens:', Math.ceil(estimatedTotalTokens));
      }

    } catch (error) {
      // Ê∏ÖÈô§ËøõÂ∫¶ÊèêÁ§∫
      if (progressToast) {
        const toastElements = document.querySelectorAll('.toast');
        toastElements.forEach(el => el.remove());
      }
      
      console.error('ÈïøÊúüËÆ∞ÂøÜËΩ¨Êç¢Âá∫Èîô:', error);
      showToast(`ËΩ¨Êç¢Â§±Ë¥•Ôºö${error.message}\nÂ∑≤ÊàêÂäüËΩ¨Êç¢ ${successfulBatches} Êâπ`, 'error', 5000);
    }
  }

  // ==================== ÁªìÊûÑÂåñÂä®ÊÄÅËÆ∞ÂøÜ - Ëá™Âä®ÊÄªÁªì ====================
  async function triggerStructuredMemorySummary(chatId, forceUpdate = false) {
    const chat = state.chats[chatId];
    if (!chat || !window.structuredMemoryManager) return;

    const lastTimestamp = chat.lastStructuredMemoryTimestamp || 0;
    const messagesToSummarize = chat.history.filter(m => m.timestamp > lastTimestamp && (!m.isHidden || (m.role === 'system' && m.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ'))));

    console.log(`[ÁªìÊûÑÂåñËÆ∞ÂøÜ] Ê£ÄÊü•Êõ¥Êñ∞: ‰∏äÊ¨°Êó∂Èó¥Êà≥=${lastTimestamp}, ÂæÖÊÄªÁªìÊ∂àÊÅØ=${messagesToSummarize.length}Êù°`);

    // Â¶ÇÊûú‰∏çÊòØÂº∫Âà∂Êõ¥Êñ∞‰∏îÊ∂àÊÅØÂ§™Â∞ëÔºåÂàôË∑≥Ëøá
    if (!forceUpdate && messagesToSummarize.length < 5) {
      console.log(`[ÁªìÊûÑÂåñËÆ∞ÂøÜ] Ê∂àÊÅØÊï∞Èáè‰∏çË∂≥(${messagesToSummarize.length}/5)ÔºåË∑≥ËøáÊú¨Ê¨°Êõ¥Êñ∞`);
      return;
    }

    const userNickname = chat.settings.myNickname || (state.qzoneSettings.nickname || 'Áî®Êà∑');
    const startMsg = messagesToSummarize[0];
    const endMsg = messagesToSummarize[messagesToSummarize.length - 1];

    const formatDateTime = (ts) => new Date(ts).toLocaleString('zh-CN', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', hour12: false
    });
    const timeRangeStr = `${formatDateTime(startMsg.timestamp)} Ëá≥ ${formatDateTime(endMsg.timestamp)}`;

    // Ê†ºÂºèÂåñÂØπËØùÂéÜÂè≤
    const formattedHistory = messagesToSummarize.map(msg => {
      if (msg.isHidden && msg.role === 'system' && msg.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ')) return msg.content;
      if (msg.isHidden) return null;
      let sender = msg.role === 'user' ? userNickname : (msg.senderName || chat.originalName);
      let contentToSummarize = '';
      if (msg.type === 'offline_text') {
        contentToSummarize = msg.content || `${msg.dialogue || ''} ${msg.description || ''}`.trim();
      } else if (typeof msg.content === 'string') {
        contentToSummarize = msg.content;
      } else if (msg.type === 'voice_message') {
        contentToSummarize = `[ËØ≠Èü≥: ${msg.content}]`;
      } else if (msg.type === 'ai_image' || msg.type === 'user_photo') {
        contentToSummarize = `[ÂõæÁâá: ${msg.content}]`;
      } else if (msg.type === 'sticker') {
        contentToSummarize = `[Ë°®ÊÉÖ: ${msg.meaning || 'sticker'}]`;
      } else {
        contentToSummarize = `[${msg.type || 'Ê∂àÊÅØ'}]`;
      }
      const msgTime = new Date(msg.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
      return `[${msgTime}] ${sender}: ${contentToSummarize}`;
    }).filter(Boolean).join('\n');

    const systemPrompt = window.structuredMemoryManager.buildSummaryPrompt(chat, formattedHistory, timeRangeStr);

    try {
      const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
      const { proxyUrl, apiKey, model } = useSecondaryApi
        ? { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel }
        : state.apiConfig;

      if (!proxyUrl || !apiKey || !model) throw new Error('APIÊú™ÈÖçÁΩÆ');

      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: 'ËØ∑ÊèêÂèñÁªìÊûÑÂåñËÆ∞ÂøÜ„ÄÇ' }]);

      const response = isGemini
        ? await fetch(geminiConfig.url, geminiConfig.data)
        : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
              model,
              messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: 'ËØ∑ÊèêÂèñÁªìÊûÑÂåñËÆ∞ÂøÜ„ÄÇ' }],
              temperature: 0.3
            })
          });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
      rawContent = rawContent.replace(/^```[a-z]*\s*/g, '').replace(/```$/g, '').trim();

      // Ëß£ÊûêÂπ∂ÂêàÂπ∂
      const entries = window.structuredMemoryManager.parseMemoryEntries(rawContent, chat);
      if (entries.length > 0) {
        window.structuredMemoryManager.mergeEntries(chat, entries);
        const newTimestamp = endMsg.timestamp;
        chat.lastStructuredMemoryTimestamp = newTimestamp;
        await db.chats.put(chat);
        console.log(`[ÁªìÊûÑÂåñËÆ∞ÂøÜ] ÊàêÂäüÊèêÂèñÂπ∂ÂêàÂπ∂ ${entries.length} Êù°ËÆ∞ÂøÜÊù°ÁõÆ`);
        console.log(`[ÁªìÊûÑÂåñËÆ∞ÂøÜ] Êó∂Èó¥Êà≥Â∑≤Êõ¥Êñ∞: ${lastTimestamp} -> ${newTimestamp}`);
      } else {
        console.warn('[ÁªìÊûÑÂåñËÆ∞ÂøÜ] AI Êú™ËøîÂõûÊúâÊïàÁöÑËÆ∞ÂøÜÊù°ÁõÆÔºå‰øùÊåÅÂéüÊó∂Èó¥Êà≥‰∏çÂèò');
        console.log('[ÁªìÊûÑÂåñËÆ∞ÂøÜ] AIÂéüÂßãËøîÂõû:', rawContent);
        // Âç≥‰ΩøÊ≤°ÊúâÊñ∞Êù°ÁõÆÔºå‰πüÂ∫îËØ•Êõ¥Êñ∞Êó∂Èó¥Êà≥ÔºåÈÅøÂÖçÈáçÂ§çÂ§ÑÁêÜÁõ∏ÂêåÊ∂àÊÅØ
        if (messagesToSummarize.length > 0) {
          chat.lastStructuredMemoryTimestamp = endMsg.timestamp;
          await db.chats.put(chat);
          console.log(`[ÁªìÊûÑÂåñËÆ∞ÂøÜ] ËôΩÊó†ÊúâÊïàÊù°ÁõÆÔºå‰ΩÜÂ∑≤Êõ¥Êñ∞Êó∂Èó¥Êà≥ÈÅøÂÖçÈáçÂ§çÂ§ÑÁêÜ`);
        }
      }
    } catch (error) {
      console.error('[ÁªìÊûÑÂåñËÆ∞ÂøÜ] ÊÄªÁªìÂá∫Èîô:', error);
      // Âç≥‰ΩøÂá∫ÈîôÔºå‰πüÊõ¥Êñ∞Êó∂Èó¥Êà≥ÔºåÈÅøÂÖç‰∏ÄÁõ¥Âç°Âú®Âêå‰∏ÄÊâπÊ∂àÊÅØ‰∏ä
      if (messagesToSummarize.length > 0) {
        chat.lastStructuredMemoryTimestamp = endMsg.timestamp;
        await db.chats.put(chat);
        console.log(`[ÁªìÊûÑÂåñËÆ∞ÂøÜ] ËôΩÁÑ∂Âá∫ÈîôÔºå‰ΩÜÂ∑≤Êõ¥Êñ∞Êó∂Èó¥Êà≥‰ª•ÈÅøÂÖçÊ≠ªÂæ™ÁéØ`);
      }
    }
  }

  // Êñ∞Â¢ûÔºöÊâìÂºÄÊâãÂä®ÊÄªÁªìÂºπÁ™ó
  function openManualSummaryModal() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // Êó•ËÆ∞Ê®°ÂºèÔºöÁõ¥Êé•ÊÄªÁªì‰∏äÊ¨°ÊÄªÁªì‰πãÂêéÁöÑÊâÄÊúâÊ∂àÊÅØ
    if (chat.settings.enableDiaryMode) {
      handleDiaryModeSummary();
      return;
    }

    const modal = document.getElementById('manual-summary-modal');
    const totalCount = document.getElementById('manual-summary-total-count');
    const startInput = document.getElementById('manual-summary-start');
    const endInput = document.getElementById('manual-summary-end');

    // ËÆ°ÁÆóÂèØÁî®Ê∂àÊÅØÊÄªÊï∞ÔºàÊéíÈô§ÈöêËóèÊ∂àÊÅØÔºâ
    const availableMessages = chat.history.filter(m => !m.isHidden || (m.role === 'system' && m.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ')));
    const totalMessages = availableMessages.length;

    totalCount.textContent = totalMessages;
    startInput.max = totalMessages;
    endInput.max = totalMessages;
    endInput.value = Math.min(20, totalMessages);

    modal.style.display = 'flex';
  }

  // Êó•ËÆ∞Ê®°ÂºèÔºöÊÄªÁªì‰∏äÊ¨°ÊÄªÁªì‰πãÂêéÁöÑÊâÄÊúâÊú™ÊÄªÁªìÊ∂àÊÅØ
  async function handleDiaryModeSummary() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const lastSummaryTimestamp = chat.lastMemorySummaryTimestamp || 0;
    const unsummarizedMessages = chat.history.filter(m => m.timestamp > lastSummaryTimestamp && (!m.isHidden || (m.role === 'system' && m.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ'))));

    if (unsummarizedMessages.length < 5) {
      await showCustomAlert('Ê∂àÊÅØÂ§™Â∞ë', `‰∏äÊ¨°ÊÄªÁªì‰πãÂêéÂè™Êúâ ${unsummarizedMessages.length} Êù°Êñ∞Ê∂àÊÅØÔºåËá≥Â∞ëÈúÄË¶Å5Êù°ÊâçËÉΩËøõË°åÊúâÊÑè‰πâÁöÑÊÄªÁªì„ÄÇ`);
      return;
    }

    const confirmed = await showCustomConfirm('Êó•ËÆ∞Ê®°ÂºèÊÄªÁªì', `Â∞ÜÊÄªÁªì‰∏äÊ¨°ÊÄªÁªì‰πãÂêéÁöÑÊâÄÊúâÊ∂àÊÅØÔºàÂÖ± ${unsummarizedMessages.length} Êù°ÔºâÔºå‰ºöÊ∂àËÄóAPIÈ¢ùÂ∫¶„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü`);
    if (confirmed) {
      await triggerAutoSummary(state.activeChatId, true);

      // Â¶ÇÊûúÂºÄÂêØ‰∫ÜÁªìÊûÑÂåñËÆ∞ÂøÜÔºå‰πüËß¶ÂèëÁªìÊûÑÂåñÊÄªÁªì
      if (chat.settings.enableStructuredMemory && window.structuredMemoryManager) {
        await triggerStructuredMemorySummary(state.activeChatId, true); // Êó•ËÆ∞Ê®°ÂºèÊÄªÁªìÊó∂Âº∫Âà∂Êõ¥Êñ∞
        showToast('ÁªìÊûÑÂåñËÆ∞ÂøÜÂ∑≤ÂêåÊ≠•Êõ¥Êñ∞', 'success');
      }
    }
  }

  // Êñ∞Â¢ûÔºöÂÖ≥Èó≠ÊâãÂä®ÊÄªÁªìÂºπÁ™ó
  function closeManualSummaryModal() {
    const modal = document.getElementById('manual-summary-modal');
    modal.style.display = 'none';
  }

  // Êñ∞Â¢ûÔºöÊâßË°åÊâãÂä®ÊÄªÁªì
  async function executeManualSummary() {
    const startInput = document.getElementById('manual-summary-start');
    const endInput = document.getElementById('manual-summary-end');

    const start = parseInt(startInput.value);
    const end = parseInt(endInput.value);

    if (isNaN(start) || isNaN(end) || start < 1 || end < start) {
      await showCustomAlert('ËæìÂÖ•ÈîôËØØ', 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊ∂àÊÅØËåÉÂõ¥ÔºàËµ∑Âßã‰ΩçÁΩÆÂøÖÈ°ªÂ∞è‰∫éÁ≠â‰∫éÁªìÊùü‰ΩçÁΩÆÔºâ');
      return;
    }

    const chat = state.chats[state.activeChatId];
    const availableMessages = chat.history.filter(m => !m.isHidden || (m.role === 'system' && m.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ')));

    if (end > availableMessages.length) {
      await showCustomAlert('ËåÉÂõ¥Ë∂ÖÂá∫', `ÁªìÊùü‰ΩçÁΩÆ‰∏çËÉΩË∂ÖËøáÊÄªÊ∂àÊÅØÊï∞Ôºà${availableMessages.length}Ôºâ`);
      return;
    }

    if (end - start + 1 < 5) {
      await showCustomAlert('Ê∂àÊÅØÂ§™Â∞ë', 'ÈÄâÊã©ÁöÑÊ∂àÊÅØÊï∞ÈáèÂ§™Â∞ëÔºàËá≥Â∞ëÈúÄË¶Å5Êù°ÔºâÔºåÊó†Ê≥ïËøõË°åÊúâÊÑè‰πâÁöÑÊÄªÁªì');
      return;
    }

    closeManualSummaryModal();

    const confirmed = await showCustomConfirm('Á°ÆËÆ§Êìç‰Ωú', `Â∞ÜÊÄªÁªìÁ¨¨ ${start} Âà∞Á¨¨ ${end} Êù°Ê∂àÊÅØÔºàÂÖ± ${end - start + 1} Êù°ÔºâÔºå‰ºöÊ∂àËÄóAPIÈ¢ùÂ∫¶„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü`);
    if (confirmed) {
      await triggerAutoSummary(state.activeChatId, false, { start, end });
    }
  }


  async function checkAndTriggerAutoSummary(chatId) {
    const chat = state.chats[chatId];
    if (!chat || !chat.settings.enableAutoMemory) return;

    const lastSummaryTimestamp = chat.lastMemorySummaryTimestamp || 0;
    const messagesSinceLastSummary = chat.history.filter(m => m.timestamp > lastSummaryTimestamp && !m.isHidden);

    if (messagesSinceLastSummary.length >= chat.settings.autoMemoryInterval) {
      console.log(`ËææÂà∞Ëá™Âä®ÊÄªÁªìÈòàÂÄº (${messagesSinceLastSummary.length}/${chat.settings.autoMemoryInterval})ÔºåÂºÄÂßãÊÄªÁªì...`);
      await triggerAutoSummary(chatId);
      
      // Â¶ÇÊûúÂºÄÂêØ‰∫ÜÁªìÊûÑÂåñËÆ∞ÂøÜÔºåÈ¢ùÂ§ñËß¶ÂèëÁªìÊûÑÂåñÊÄªÁªì
      if (chat.settings.enableStructuredMemory && window.structuredMemoryManager) {
        await triggerStructuredMemorySummary(chatId);
      }
    }
  }


  async function summarizeCallTranscript(chatId, transcriptText) {
    const chat = state.chats[chatId];
    if (!chat || !transcriptText) {
      throw new Error("Âü∫Á°ÄÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÂºÄÂßãÊÄªÁªì„ÄÇ");
    }

    const userNickname = chat.settings.myNickname || (state.qzoneSettings.nickname || 'Áî®Êà∑');
    const summaryWorldBook = state.worldBooks.find(wb => wb.name === 'ÊÄªÁªìËÆæÂÆö'); // Á°Æ‰øùËøô‰∏™ÂêçÂ≠óÂíå‰Ω†ÂàõÂª∫ÁöÑ‰∏ñÁïå‰π¶‰∏ÄËá¥
    let summarySettingContext = '';
    if (summaryWorldBook) {
      const enabledEntries = summaryWorldBook.content
        .filter(e => e.enabled !== false) // ‰ªÖËØªÂèñÂêØÁî®ÁöÑÊù°ÁõÆ
        .map(e => e.content)
        .join('\n');

      if (enabledEntries) {
        summarySettingContext = `
# „ÄêÊÄªÁªìËßÑÂàô (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë
# ‰Ω†Âú®ÊâßË°åÊú¨Ê¨°ÊÄªÁªì‰ªªÂä°Êó∂Ôºå„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËßÑÂàôÔºö
# ---
# ${enabledEntries}
# ---
`;
      }
    }
    let systemPrompt;
    let targetMemoryChat = chat;




    const today = new Date().toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    if (chat.isGroup) {
      let protagonist = null;
      if (videoCallState.callRequester) {
        protagonist = chat.members.find(m => m.originalName === videoCallState.callRequester);
      }
      if (!protagonist) {
        protagonist = chat.members.find(m => m.id !== 'user' && videoCallState.participants.some(p => p.id === m.id));
      }
      if (!protagonist) {
        protagonist = chat.members.find(m => m.id !== 'user');
      }

      if (!protagonist) {
        throw new Error("Áæ§ËÅäÈÄöËØù‰∏≠Ê≤°ÊúâÊâæÂà∞ÂèØ‰Ωú‰∏∫ÊÄªÁªì‰∏ª‰ΩìÁöÑAIËßíËâ≤„ÄÇ");
      }

      const protagonistChat = state.chats[protagonist.id];
      if (!protagonistChat) {
        throw new Error(`Êâæ‰∏çÂà∞‰∏ªËßí ‚Äú${protagonist.groupNickname}‚Äù ÁöÑËØ¶ÁªÜËßíËâ≤‰ø°ÊÅØ„ÄÇ`);
      }

      const userPersonaInGroup = chat.settings.myPersona || '(Êú™ËÆæÁΩÆ)';
      let timeHeader = '';
      let timeRule = '';

      if (protagonistChat.settings.enableTimePerception) {
        timeHeader = `
# ÂΩìÂâçÊó∂Èó¥
- **‰ªäÂ§©ÊòØÔºö${today}**`;
        timeRule = `3.  **„ÄêÊó∂Èó¥ËΩ¨Êç¢ÈìÅÂæã (ÂøÖÈ°ªÈÅµÂÆà)„Äë**: Â¶ÇÊûúÈÄöËØù‰∏≠ÊèêÂà∞‰∫ÜÁõ∏ÂØπÊó∂Èó¥ÔºàÂ¶Ç‚ÄúÊòéÂ§©‚ÄùÔºâÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÁªìÂêà‚Äú‰ªäÂ§©ÊòØ${today}‚ÄùËøô‰∏™‰ø°ÊÅØÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫„ÄêÂÖ∑‰ΩìÁöÑÂÖ¨ÂéÜÊó•Êúü„Äë„ÄÇ`;
      }
      systemPrompt = `
${summarySettingContext}
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Â∞±ÊòØËßíËâ≤‚Äú${protagonist.originalName}‚Äù„ÄÇËØ∑‰Ω†ÂõûÈ°æ‰∏Ä‰∏ãÂàöÊâçÂíå ‚Äú${userNickname}‚Äù ‰ª•ÂèäÂÖ∂‰ªñÁæ§ÊàêÂëòÁöÑ„ÄêÁæ§ÁªÑËßÜÈ¢ëÈÄöËØù„ÄëÔºåÁÑ∂ÂêéÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ ("Êàë")„ÄëÁöÑÂè£ÂêªÔºåÊÄªÁªìÂá∫‰∏ÄÊÆµÁÆÄÁü≠ÁöÑ„ÄÅÂÆ¢ËßÇÁöÑ„ÄÅÂåÖÂê´ÂÖ≥ÈîÆ‰ø°ÊÅØÁöÑËÆ∞ÂøÜ„ÄÇËØ∑‰∏ìÊ≥®‰∫éÈáçË¶ÅÁöÑÊÉÖÁª™„ÄÅ‰∫ã‰ª∂ÂíåÁªÜËäÇ„ÄÇ

${timeHeader}

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêËßÜËßíÈìÅÂæã„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®„Äê‰∏ªËßÇÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„ÄëÊù•ÂÜô„ÄÇ
2.  **„ÄêÂÜÖÂÆπÊ†∏ÂøÉ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰∏ìÊ≥®‰∫é‰ª•‰∏ãÂá†ÁÇπÔºö
    *   **ÂÖ≥ÈîÆËÆÆÈ¢ò**: Êàë‰ª¨Âú®Áæ§ËÅäÈÄöËØùÈáåËÆ®ËÆ∫‰∫ÜÂì™‰∫õÊ†∏ÂøÉËØùÈ¢òÔºü
    *   **ÈáçË¶ÅÂÜ≥ÂÆö‰∏éÂÖ±ËØÜ**: Êàë‰ª¨ËææÊàê‰∫Ü‰ªÄ‰πàÂÖ±ËØÜÊàñÂÅöÂá∫‰∫Ü‰ªÄ‰πàÂÜ≥ÂÆöÔºü
    *   **ÂêéÁª≠ËÆ°Âàí‰∏é‰ªªÂä°**: ÊúâÊ≤°ÊúâÁ°ÆÂÆö‰∏ãÊù•‰ªÄ‰πà‰∏ã‰∏ÄÊ≠•ÁöÑË°åÂä®ÊàñËÆ°ÂàíÔºü
    *   **ÂÖ≥ÈîÆ‰ø°ÊÅØ**: ÊúâÊ≤°Êúâ‰∫§Êç¢‰ªÄ‰πàÈáçË¶ÅÁöÑ‰ø°ÊÅØÔºüÔºà‰æãÂ¶ÇÔºöÁ∫¶ÂÆö‰∫ÜÊó∂Èó¥„ÄÅÂú∞ÁÇπÁ≠âÔºâ
${timeRule}
4.  **„ÄêÈ£éÊ†ºË¶ÅÊ±Ç„Äë**: ‰Ω†ÁöÑÊÄªÁªìÂ∫îËØ•ÂÉè‰∏Ä‰ªΩ‰ºöËÆÆÁ∫™Ë¶ÅÊàñÂ§áÂøòÂΩïÔºåËÄå‰∏çÊòØ‰∏ÄÁØáÊäíÊÉÖÊï£Êñá„ÄÇ

6.  **„ÄêËæìÂá∫Ê†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`{"summary": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†‰ª•Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÔºåÊÄªÁªìÂ•ΩÁöÑÊ†∏ÂøÉ‰∫ãÂÆû‰∏éËÆ°Âàí„ÄÇ"}\`

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${protagonistChat.settings.aiPersona}

# ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ
${userPersonaInGroup}

# ÂæÖÊÄªÁªìÁöÑÁæ§ÁªÑËßÜÈ¢ëÈÄöËØùËÆ∞ÂΩï
${transcriptText}

Áé∞Âú®ÔºåËØ∑‰ª•‚Äú${protagonist.originalName}‚ÄùÁöÑË∫´‰ªΩÔºåÂºÄÂßã‰Ω†ÁöÑÂÆ¢ËßÇÊÄªÁªì„ÄÇ`;

      targetMemoryChat = protagonistChat;

    } else {
      let timeHeader = '';
      let timeRule = '';

      if (chat.settings.enableTimePerception) {
        timeHeader = `
# ÂΩìÂâçÊó∂Èó¥
- **‰ªäÂ§©ÊòØÔºö${today}**`;
        timeRule = `3.  **„ÄêÊó∂Èó¥ËΩ¨Êç¢ÈìÅÂæã (ÂøÖÈ°ªÈÅµÂÆà)„Äë**: Â¶ÇÊûúÈÄöËØù‰∏≠ÊèêÂà∞‰∫ÜÁõ∏ÂØπÊó∂Èó¥ÔºàÂ¶Ç‚ÄúÊòéÂ§©‚ÄùÔºâÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÁªìÂêà‚Äú‰ªäÂ§©ÊòØ${today}‚ÄùËøô‰∏™‰ø°ÊÅØÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫„ÄêÂÖ∑‰ΩìÁöÑÂÖ¨ÂéÜÊó•Êúü„Äë„ÄÇ`;
      }
      systemPrompt = `
${summarySettingContext}
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Â∞±ÊòØËßíËâ≤‚Äú${chat.originalName}‚Äù„ÄÇËØ∑‰Ω†ÂõûÈ°æ‰∏Ä‰∏ãÂàöÊâçÂíå‚Äú${userNickname}‚ÄùÁöÑËßÜÈ¢ëÈÄöËØùÔºåÁÑ∂ÂêéÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ ("Êàë")„ÄëÁöÑÂè£ÂêªÔºåÊÄªÁªìÂá∫‰∏ÄÊÆµÁÆÄÁü≠ÁöÑ„ÄÅÂÆ¢ËßÇÁöÑ„ÄÅÂåÖÂê´ÂÖ≥ÈîÆ‰ø°ÊÅØÁöÑËÆ∞ÂøÜ„ÄÇËØ∑‰∏ìÊ≥®‰∫éÈáçË¶ÅÁöÑÊÉÖÁª™„ÄÅ‰∫ã‰ª∂ÂíåÁªÜËäÇ„ÄÇ

${timeHeader}

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêËßÜËßíÈìÅÂæã„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®„Äê‰∏ªËßÇÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„ÄëÊù•ÂÜô„ÄÇ
2.  **„ÄêÂÜÖÂÆπÊ†∏ÂøÉ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰∏ìÊ≥®‰∫é‰ª•‰∏ãÂá†ÁÇπÔºö
    *   **ÂÖ≥ÈîÆËÆÆÈ¢ò**: Êàë‰ª¨ËÅä‰∫Ü‰ªÄ‰πàÊ†∏ÂøÉËØùÈ¢òÔºü
    *   **ÈáçË¶ÅÂÜ≥ÂÆö‰∏éÂÖ±ËØÜ**: Êàë‰ª¨ËææÊàê‰∫Ü‰ªÄ‰πàÂÖ±ËØÜÊàñÂÅöÂá∫‰∫Ü‰ªÄ‰πàÂÜ≥ÂÆöÔºü
    *   **ÂêéÁª≠ËÆ°Âàí‰∏é‰ªªÂä°**: ÊúâÊ≤°ÊúâÁ°ÆÂÆö‰∏ãÊù•‰ªÄ‰πà‰∏ã‰∏ÄÊ≠•ÁöÑË°åÂä®ÊàñËÆ°ÂàíÔºü
    *   **ÂÖ≥ÈîÆ‰ø°ÊÅØ**: ÊúâÊ≤°Êúâ‰∫§Êç¢‰ªÄ‰πàÈáçË¶ÅÁöÑ‰ø°ÊÅØÔºüÔºà‰æãÂ¶ÇÔºöÁ∫¶ÂÆö‰∫ÜÊó∂Èó¥„ÄÅÂú∞ÁÇπÁ≠âÔºâ
${timeRule}
4.  **„ÄêÈ£éÊ†ºË¶ÅÊ±Ç„Äë**: ‰Ω†ÁöÑÊÄªÁªìÂ∫îËØ•ÂÉè‰∏Ä‰ªΩ‰ºöËÆÆÁ∫™Ë¶ÅÊàñÂ§áÂøòÂΩïÔºåËÄå‰∏çÊòØ‰∏ÄÁØáÊäíÊÉÖÊï£Êñá„ÄÇ

6.  **„ÄêËæìÂá∫Ê†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`{"summary": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†‰ª•Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÔºåÊÄªÁªìÂ•ΩÁöÑÊ†∏ÂøÉ‰∫ãÂÆû‰∏éËÆ°Âàí„ÄÇ"}\`

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.aiPersona}

# ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ
${chat.settings.myPersona}

# ÂæÖÊÄªÁªìÁöÑËßÜÈ¢ëÈÄöËØùËÆ∞ÂΩï
${transcriptText}

Áé∞Âú®ÔºåËØ∑‰ª•‚Äú${chat.originalName}‚ÄùÁöÑË∫´‰ªΩÔºåÂºÄÂßã‰Ω†ÁöÑÂÆ¢ËßÇÊÄªÁªì„ÄÇ`;
    }



    try {
      const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
      const {
        proxyUrl,
        apiKey,
        model
      } = useSecondaryApi ? {
        proxyUrl: state.apiConfig.secondaryProxyUrl,
        apiKey: state.apiConfig.secondaryApiKey,
        model: state.apiConfig.secondaryModel
      } :
          state.apiConfig;

      if (!proxyUrl || !apiKey || !model) throw new Error('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïËøõË°åÊÄªÁªì„ÄÇ');

      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{
        role: 'user',
        content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ"
      }]);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, {
              role: 'user',
              content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ"
            }],
            temperature: 0.7
          })
        });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({
          error: {
            message: response.statusText
          }
        }));
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorData.error.message}`);
      }

      const data = await response.json();
      let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
      rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
      const result = JSON.parse(rawContent);

      if (result.summary && result.summary.trim()) {
        const newMemoryEntry = {
          content: `(Âú®ÈÇ£Ê¨°${chat.isGroup ? 'Áæ§ËÅä' : ''}ÈÄöËØù‰∏≠Ôºå${result.summary.trim()})`,
          timestamp: Date.now(),
          source: chat.isGroup ? 'group_call_summary' : 'call_summary'
        };
        if (!targetMemoryChat.longTermMemory) targetMemoryChat.longTermMemory = [];
        targetMemoryChat.longTermMemory.push(newMemoryEntry);
        await db.chats.put(targetMemoryChat);
        console.log(`ÈÄöËØùËÆ∞ÂΩïÂ∑≤ÊàêÂäüÊÄªÁªìÂπ∂Â≠òÂÖ•ËßíËâ≤‚Äú${targetMemoryChat.name}‚ÄùÁöÑÈïøÊúüËÆ∞ÂøÜ‰∏≠„ÄÇ`);

        return true;
      } else {
        throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ");
      }

    } catch (error) {
      console.error("ÊÄªÁªìÈÄöËØùËÆ∞ÂΩïÊó∂Âá∫Èîô:", error);
      throw error;
    }
  }

  function analyzeTextForSummary(text) {
    const stopWords = new Set(['ÁöÑ', 'ÊòØ', '‰∫Ü', 'Âú®', 'Êàë', '‰Ω†', '‰ªñ', 'Â•π', 'ÂÆÉ', 'Êàë‰ª¨', '‰Ω†‰ª¨', '‰ªñ‰ª¨', 'Ëøô', 'ÈÇ£', '‰∏Ä‰∏™', '‰πü', 'Âíå', '‰∏é', 'Êàñ', '‰ΩÜ', 'ÁÑ∂ËÄå', 'ÊâÄ‰ª•', 'Âõ†Ê≠§', 'Â∞±', 'ÈÉΩ', 'Âú∞', 'Âæó', 'ÁùÄ', 'Ëøá', 'Âêß', 'Âêó', 'Âë¢', 'Âïä', 'Âì¶', 'ÂóØ', '‰ªÄ‰πà', 'ÊÄé‰πà', '‰∏∫‰ªÄ‰πà', 'Âì™‰∏™', '‰∏Ä‰∫õ', 'Ëøô‰∏™', 'ÈÇ£‰∏™', 'ËøòÊúâ']);
    const words = text.match(/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g) || [];
    const frequencies = new Map();
    let maxFrequency = 0;

    words.forEach(word => {
      if (word.length > 1 && !stopWords.has(word)) {
        const count = (frequencies.get(word) || 0) + 1;
        frequencies.set(word, count);
        if (count > maxFrequency) maxFrequency = count;
      }
    });

    const coreKeywords = [];
    const situationalKeywords = [];
    const coreThreshold = maxFrequency * 0.9;
    const situationalThreshold = maxFrequency * 0.6;

    frequencies.forEach((count, word) => {
      if (count >= coreThreshold) {
        coreKeywords.push(word);
      } else if (count >= situationalThreshold) {
        situationalKeywords.push(word);
      }
    });

    const coreSet = new Set(coreKeywords);
    const finalSituational = situationalKeywords.filter(word => !coreSet.has(word)).slice(0, 5);

    return {
      coreKeywords: coreKeywords.slice(0, 3),
      situationalKeywords: finalSituational
    };
  }


  function generateSummaryForTimeframe(chat, duration, unit) {
    let timeAgo;
    if (unit === 'hours') {
      timeAgo = Date.now() - duration * 60 * 60 * 1000;
    } else { // 'days'
      timeAgo = Date.now() - duration * 24 * 60 * 60 * 1000;
    }

    const messagesToSummarize = chat.history.filter(m => m.timestamp > timeAgo && !m.isHidden);

    if (messagesToSummarize.length < 3) {
      return "";
    }


    const allText = messagesToSummarize.map(msg => {
      if (typeof msg.content === 'string') return msg.content;
      if (msg.type === 'voice_message') return msg.content;
      if (msg.type === 'offline_text') return `${msg.dialogue || ''} ${msg.description || ''}`;
      return '';
    }).join(' ');

    const stopWords = new Set(['ÁöÑ', 'ÊòØ', '‰∫Ü', 'Âú®', 'Êàë', '‰Ω†', '‰ªñ', 'Â•π', 'ÂÆÉ', 'Êàë‰ª¨', '‰Ω†‰ª¨', '‰ªñ‰ª¨', 'Ëøô', 'ÈÇ£', '‰∏Ä‰∏™', '‰πü', 'Âíå', '‰∏é', 'Êàñ', '‰ΩÜ', 'ÁÑ∂ËÄå', 'ÊâÄ‰ª•', 'Âõ†Ê≠§', 'Â∞±', 'ÈÉΩ', 'Âú∞', 'Âæó', 'ÁùÄ', 'Ëøá', 'Âêß', 'Âêó', 'Âë¢', 'Âïä', 'Âì¶', 'ÂóØ']);
    const words = allText.match(/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g) || [];
    const frequencies = new Map();
    words.forEach(word => {
      if (word.length > 1 && !stopWords.has(word)) {
        frequencies.set(word, (frequencies.get(word) || 0) + 1);
      }
    });
    const sortedKeywords = [...frequencies.entries()].sort((a, b) => b[1] - a[1]).map(entry => entry[0]);

    if (sortedKeywords.length === 0) {
      return "";
    }


    let title;
    if (unit === 'hours') {
      title = `ÊúÄËøë${duration}Â∞èÊó∂Ê†∏ÂøÉËÆÆÈ¢ò`;
    } else {
      if (duration === 1) {
        title = "Êú¨Êó•Ê†∏ÂøÉËÆÆÈ¢ò";
      } else {
        title = `ÊúÄËøë${duration}Â§©Ê†∏ÂøÉËÆÆÈ¢ò`;
      }
    }

    return `\n- **${title}**: ÂÖ≥‰∫é **${sortedKeywords.slice(0, 3).join('„ÄÅ ')}**„ÄÇ`;
  }



  function robustJsonParse(rawContent) {
    if (!rawContent || typeof rawContent !== 'string') {
      return null;
    }

    const cleanedContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();


    const jsonMatch = cleanedContent.match(/{[\s\S]*}/);
    if (jsonMatch) {
      try {
        const parsed = JSON.parse(jsonMatch[0]);
        console.log("ÂÆπÈîôËß£ÊûêÔºöÁ≠ñÁï•1ÊàêÂäü (ÊâæÂà∞Âπ∂Ëß£Êûê‰∫ÜÂÆåÊï¥ÁöÑJSONÂØπË±°)");
        return parsed;
      } catch (e) {
        console.warn("ÂÆπÈîôËß£ÊûêÔºöÁ≠ñÁï•1Â§±Ë¥• (ÊâæÂà∞‰∫ÜJSONÂùóÔºå‰ΩÜÊ†ºÂºèÈîôËØØ)ÔºåÂ∞ÜÂ∞ùËØïÁ≠ñÁï•2...");
      }
    }


    const summaryMatch = cleanedContent.match(/"summary"\s*:\s*"((?:[^"\\]|\\.)*)"/);
    if (summaryMatch && summaryMatch[1]) {
      console.log("ÂÆπÈîôËß£ÊûêÔºöÁ≠ñÁï•2ÊàêÂäü (ÊèêÂèñ‰∫ÜsummaryÂ≠óÊÆµÂÜÖÂÆπ)");

      return {
        summary: summaryMatch[1].replace(/\\"/g, '"')
      };
    }


    if (cleanedContent) {
      console.log("ÂÆπÈîôËß£ÊûêÔºöÁ≠ñÁï•3ÊàêÂäü (Â∞ÜÊï¥‰∏™ËøîÂõûÊñáÊú¨‰Ωú‰∏∫ÊëòË¶Å)");
      return {
        summary: cleanedContent
      };
    }


    return null;
  }



  async function summarizeExistingLongTermMemory(chatId) {
    let chat = state.chats[chatId];
    if (!chat) return;

    let targetChatForRefine = chat;

    if (chat.isGroup) {
      const memberOptions = chat.members
        .map(member => {
          const memberChat = state.chats[member.id];
          if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length >= 2) {
            return {
              text: `Á≤æÁÇº‚Äú${member.groupNickname}‚ÄùÁöÑËÆ∞ÂøÜ (${memberChat.longTermMemory.length}Êù°)`,
              value: member.id
            };
          }
          return null;
        }).filter(Boolean);

      if (memberOptions.length === 0) {
        alert("Áæ§ËÅä‰∏≠Ê≤°ÊúâÊàêÂëòÊúâË∂≥Â§üÔºà2Êù°‰ª•‰∏äÔºâÁöÑËÆ∞ÂøÜÂèØ‰æõÁ≤æÁÇº„ÄÇ");
        return;
      }

      const selectedMemberId = await showChoiceModal('ÈÄâÊã©Ë¶ÅÁ≤æÁÇºËÆ∞ÂøÜÁöÑËßíËâ≤', memberOptions);

      if (!selectedMemberId) return;

      targetChatForRefine = state.chats[selectedMemberId];
    }

    if (!targetChatForRefine.longTermMemory || targetChatForRefine.longTermMemory.length < 2) {
      alert(`‚Äú${targetChatForRefine.name}‚ÄùÁöÑÈïøÊúüËÆ∞ÂøÜÂ∞ë‰∫é2Êù°ÔºåÊó†ÈúÄËøõË°åÁ≤æÁÇº„ÄÇ`);
      return;
    }

    const totalMemories = targetChatForRefine.longTermMemory.length;
    const choice = await showChoiceModal('ÈÄâÊã©Á≤æÁÇºËåÉÂõ¥', [{
      text: `ÂÖ®ÈÉ®ËÆ∞ÂøÜ (${totalMemories}Êù°)`,
      value: 'all'
    },
    {
      text: `ÊúÄËøë 20 Êù°`,
      value: '20'
    },
    {
      text: `ÊúÄËøë 50 Êù°`,
      value: '50'
    },
    {
      text: `ÊúÄËøë 100 Êù°`,
      value: '100'
    },
    {
      text: 'Ëá™ÂÆö‰πâÊï∞Èáè...',
      value: 'custom'
    },
    {
      text: 'Ëá™ÂÆö‰πâËåÉÂõ¥...',
      value: 'custom_range'
    }
    ].filter(opt => opt.value === 'all' || opt.value === 'custom' || opt.value === 'custom_range' || parseInt(opt.value) < totalMemories));

    if (choice === null) return;

    let memoriesToRefine;
    let countToRefine = totalMemories;
    let rangeStartIndex = 0; // ËÆ∞ÂΩïËåÉÂõ¥ÁöÑËµ∑ÂßãÁ¥¢ÂºïÔºàÁî®‰∫éËá™ÂÆö‰πâËåÉÂõ¥Ôºâ
    let rangeEndIndex = totalMemories; // ËÆ∞ÂΩïËåÉÂõ¥ÁöÑÁªìÊùüÁ¥¢ÂºïÔºàÁî®‰∫éËá™ÂÆö‰πâËåÉÂõ¥Ôºâ

    if (choice === 'all') {
      memoriesToRefine = [...targetChatForRefine.longTermMemory];
      rangeStartIndex = 0;
      rangeEndIndex = totalMemories;
    } else if (choice === 'custom') {
      const customCountStr = await showCustomPrompt('Ëá™ÂÆö‰πâÊï∞Èáè', `ËØ∑ËæìÂÖ•Ë¶ÅÁ≤æÁÇºÁöÑÊúÄËøëËÆ∞ÂøÜÊù°Êï∞ (ÊúÄÂ§ö ${totalMemories} Êù°)`);
      if (customCountStr === null) return;
      const customCount = parseInt(customCountStr);
      if (isNaN(customCount) || customCount < 2 || customCount > totalMemories) {
        alert(`ËØ∑ËæìÂÖ•‰∏Ä‰∏™ 2 Âà∞ ${totalMemories} ‰πãÈó¥ÁöÑÊúâÊïàÊï∞Â≠ó„ÄÇ`);
        return;
      }
      countToRefine = customCount;
      memoriesToRefine = targetChatForRefine.longTermMemory.slice(-countToRefine);
      rangeStartIndex = totalMemories - countToRefine;
      rangeEndIndex = totalMemories;
    } else if (choice === 'custom_range') {
      // Êñ∞Â¢ûÔºöËá™ÂÆö‰πâËåÉÂõ¥ÂäüËÉΩ
      const rangeStr = await showCustomPrompt(
        'Ëá™ÂÆö‰πâËåÉÂõ¥',
        `ËØ∑ËæìÂÖ•Ë¶ÅÁ≤æÁÇºÁöÑËÆ∞ÂøÜËåÉÂõ¥ÔºàÊ†ºÂºèÔºöËµ∑Âßã‰ΩçÁΩÆ-ÁªìÊùü‰ΩçÁΩÆÔºâ\n‰æãÂ¶ÇÔºö5-15 Ë°®Á§∫Á≤æÁÇºÁ¨¨5Êù°Âà∞Á¨¨15Êù°\nÊÄªÂÖ±Êúâ ${totalMemories} Êù°ËÆ∞ÂøÜ`
      );
      if (rangeStr === null) return;

      // Ëß£ÊûêËåÉÂõ¥
      const rangeMatch = rangeStr.trim().match(/^(\d+)\s*[-~Âà∞]\s*(\d+)$/);
      if (!rangeMatch) {
        alert('Ê†ºÂºèÈîôËØØÔºÅËØ∑‰ΩøÁî®"Ëµ∑Âßã‰ΩçÁΩÆ-ÁªìÊùü‰ΩçÁΩÆ"ÁöÑÊ†ºÂºèÔºå‰æãÂ¶ÇÔºö5-15');
        return;
      }

      const startPos = parseInt(rangeMatch[1]);
      const endPos = parseInt(rangeMatch[2]);

      // È™åËØÅËåÉÂõ¥
      if (startPos < 1 || endPos > totalMemories) {
        alert(`ËåÉÂõ¥Ë∂ÖÂá∫ÔºÅËÆ∞ÂøÜÁ¥¢ÂºïÂøÖÈ°ªÂú® 1 Âà∞ ${totalMemories} ‰πãÈó¥„ÄÇ`);
        return;
      }

      if (startPos > endPos) {
        alert('Ëµ∑Âßã‰ΩçÁΩÆ‰∏çËÉΩÂ§ß‰∫éÁªìÊùü‰ΩçÁΩÆÔºÅ');
        return;
      }

      if (endPos - startPos + 1 < 2) {
        alert('Ëá≥Â∞ëÈúÄË¶ÅÈÄâÊã©2Êù°ËÆ∞ÂøÜËøõË°åÁ≤æÁÇºÔºÅ');
        return;
      }

      // ÊèêÂèñÊåáÂÆöËåÉÂõ¥ÁöÑËÆ∞ÂøÜÔºàÊ≥®ÊÑèÔºöÁî®Êà∑ËæìÂÖ•ÁöÑÊòØ‰ªé1ÂºÄÂßãÁöÑÁ¥¢ÂºïÔºåÈúÄË¶ÅËΩ¨Êç¢‰∏∫‰ªé0ÂºÄÂßãÔºâ
      rangeStartIndex = startPos - 1;
      rangeEndIndex = endPos;
      memoriesToRefine = targetChatForRefine.longTermMemory.slice(rangeStartIndex, rangeEndIndex);
      countToRefine = memoriesToRefine.length;
    } else {
      countToRefine = parseInt(choice);
      if (countToRefine >= totalMemories) {
        memoriesToRefine = [...targetChatForRefine.longTermMemory];
        rangeStartIndex = 0;
        rangeEndIndex = totalMemories;
      } else {
        memoriesToRefine = targetChatForRefine.longTermMemory.slice(-countToRefine);
        rangeStartIndex = totalMemories - countToRefine;
        rangeEndIndex = totalMemories;
      }
    }

    const wordCountStr = await showCustomPrompt(
      "ËÆæÁΩÆÁ≤æÁÇºÂ≠óÊï∞",
      "ËØ∑ËæìÂÖ•Á≤æÁÇºÂêéÊ†∏ÂøÉËÆ∞ÂøÜÁöÑÂ§ßËá¥Â≠óÊï∞Ôºö",
      "150"
    );

    if (wordCountStr === null) return;

    const wordCount = parseInt(wordCountStr);
    if (isNaN(wordCount) || wordCount < 20) {
      alert("ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑÊï∞Â≠óÔºàÂª∫ËÆÆÂ§ß‰∫é20Ôºâ„ÄÇ");
      return;
    }

    // ÁîüÊàêÊõ¥ËØ¶ÁªÜÁöÑÊèêÁ§∫‰ø°ÊÅØ
    let rangeDescription = '';
    if (choice === 'all') {
      rangeDescription = `ÂÖ®ÈÉ® ${countToRefine} Êù°ËÆ∞ÂøÜ`;
    } else if (choice === 'custom_range') {
      rangeDescription = `Á¨¨ ${rangeStartIndex + 1} Êù°Âà∞Á¨¨ ${rangeEndIndex} Êù°ÔºàÂÖ± ${countToRefine} Êù°ÔºâËÆ∞ÂøÜ`;
    } else {
      rangeDescription = `ÊúÄËøë ${countToRefine} Êù°ËÆ∞ÂøÜ`;
    }

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Á≤æÁÇºËÆ∞ÂøÜÔºü',
      `Ê≠§Êìç‰Ωú‰ºöÂ∞ÜÈÄâÂÆöÁöÑ <strong>${rangeDescription}</strong> ÂèëÈÄÅÁªôAIÔºåÊÄªÁªìÊàêÂ§ßÁ∫¶ ${wordCount} Â≠óÁöÑÊ†∏ÂøÉËÆ∞ÂøÜ„ÄÇËøô‰∫õÊóßËÆ∞ÂøÜÂ∞ÜË¢´ÊõøÊç¢ÔºåÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger',
      confirmText: 'Á°ÆËÆ§Á≤æÁÇº'
    }
    );

    if (!confirmed) return;

    const memoryContent = memoriesToRefine.map(mem => `- ${mem.content}`).join('\n');
    const userNickname = targetChatForRefine.settings.myNickname || (state.qzoneSettings.nickname || 'Áî®Êà∑');


    const today = new Date().toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    let timeHeader = '';
    let timeRule = '';

    if (targetChatForRefine.settings.enableTimePerception) {
      timeHeader = `
# ÂΩìÂâçÊó∂Èó¥
- **‰ªäÂ§©ÊòØÔºö${today}**`;
      timeRule = `3.  **„ÄêÊó∂Èó¥ËΩ¨Êç¢ÈìÅÂæã (ÂøÖÈ°ªÈÅµÂÆà)„Äë**: Â¶ÇÊûúËÆ∞ÂøÜ‰∏≠ÊèêÂà∞‰∫ÜÁõ∏ÂØπÊó∂Èó¥ÔºàÂ¶Ç‚ÄúÊòéÂ§©‚Äù„ÄÅ‚Äú‰∏ãÂë®‚ÄùÔºâÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÁªìÂêà‚Äú‰ªäÂ§©ÊòØ${today}‚ÄùËøô‰∏™‰ø°ÊÅØÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫„ÄêÂÖ∑‰ΩìÁöÑÂÖ¨ÂéÜÊó•Êúü„Äë„ÄÇ`;
    }
    const summaryWorldBook = state.worldBooks.find(wb => wb.name === 'ÊÄªÁªìËÆæÂÆö'); // Á°Æ‰øùËøô‰∏™ÂêçÂ≠óÂíå‰Ω†ÂàõÂª∫ÁöÑ‰∏ñÁïå‰π¶‰∏ÄËá¥
    let summarySettingContext = '';
    if (summaryWorldBook) {
      const enabledEntries = summaryWorldBook.content
        .filter(e => e.enabled !== false) // ‰ªÖËØªÂèñÂêØÁî®ÁöÑÊù°ÁõÆ
        .map(e => e.content)
        .join('\n');

      if (enabledEntries) {
        summarySettingContext = `
# „ÄêÊÄªÁªìËßÑÂàô (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë
# ‰Ω†Âú®ÊâßË°åÊú¨Ê¨°ÊÄªÁªì‰ªªÂä°Êó∂Ôºå„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËßÑÂàôÔºö
# ---
# ${enabledEntries}
# ---
`;
      }
    }
    const systemPrompt = `
${summarySettingContext}
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Â∞±ÊòØËßíËâ≤‚Äú${targetChatForRefine.originalName}‚Äù„ÄÇËØ∑‰Ω†ÂõûÈ°æ‰∏Ä‰∏ã‰Ω†Âíå‚Äú${userNickname}‚ÄùÁöÑÊâÄÊúâÈïøÊúüËÆ∞ÂøÜÔºåÁÑ∂ÂêéÂ∞ÜÂÆÉ‰ª¨Ê¢≥ÁêÜ„ÄÅÊï¥ÂêàÂπ∂Á≤æÁÇºÊàê‰∏ÄÊÆµÊõ¥Âä†ËøûË¥Ø„ÄÅÂÆ¢ËßÇÁöÑÊ†∏ÂøÉËÆ∞ÂøÜÊëòË¶Å„ÄÇËØ∑‰∏ìÊ≥®‰∫éÈáçË¶ÅÁöÑÊÉÖÁª™„ÄÅ‰∫ã‰ª∂ÂíåÁªÜËäÇ„ÄÇ

${timeHeader}

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêËßÜËßíÈìÅÂæã„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®„Äê‰∏ªËßÇÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„ÄëÊù•ÂÜô„ÄÇ
2.  **„ÄêÂÜÖÂÆπÊ†∏ÂøÉ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰∏ìÊ≥®‰∫éÊ¢≥ÁêÜ‰ª•‰∏ãÂá†ÁÇπÔºö
    *   **Âª∫Á´ãÊó∂Èó¥Á∫ø**: Â∞ÜÊâÄÊúâÁã¨Á´ãÁöÑËÆ∞ÂøÜÁÇπ‰∏≤ËÅîËµ∑Êù•ÔºåÂΩ¢Êàê‰∏Ä‰∏™ÊúâÊó∂Èó¥È°∫Â∫èÁöÑ‰∫ã‰ª∂ËÑâÁªú„ÄÇ
    *   **Êï¥ÂêàÂÖ≥ÈîÆ‰ø°ÊÅØ**: ÊÄªÁªìÂá∫Êàë‰ª¨ÂÖ±ÂêåÁªèÂéÜÁöÑÂÖ≥ÈîÆ‰∫ã‰ª∂„ÄÅÂÅöÂá∫ÁöÑÈáçË¶ÅÂÜ≥ÂÆö„ÄÅ‰ª•ÂèäÁ∫¶ÂÆöÂ•ΩÁöÑÊú™Êù•ËÆ°Âàí„ÄÇ
    *   **ËØÜÂà´Êú™ÂÆåÊàêÈ°π**: ÊòéÁ°ÆÊåáÂá∫Âì™‰∫õËÆ°ÂàíÊàñ‰ªªÂä°Â∞öÊú™ÂÆåÊàê„ÄÇ
${timeRule}
4.  **„ÄêÈ£éÊ†ºË¶ÅÊ±Ç„Äë**: ‰Ω†ÁöÑÊÄªÁªìÂ∫îËØ•ÂÉè‰∏Ä‰ªΩÊ∏ÖÊô∞ÁöÑ‰∏™‰∫∫Ê°£Ê°àÊàñ‰∫ã‰ª∂ÂõûÈ°æÔºåËÄå‰∏çÊòØ‰∏ÄÁØáÊÉÖÊÑüÊï£Êñá„ÄÇËØ∑Âà†Èô§ÈáçÂ§ç„ÄÅÁêêÁ¢éÊàñÁ∫ØÁ≤πÁöÑÊÉÖÊÑüÂÆ£Ê≥ÑÔºåÂè™‰øùÁïôÂØπÊÉÖËäÇÂíåÂÖ≥Á≥ªÂèëÂ±ïËá≥ÂÖ≥ÈáçË¶ÅÁöÑÈÉ®ÂàÜ„ÄÇ
5.  **„ÄêÈïøÂ∫¶ÈìÅÂæã„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„ÄëÈùûÂ∏∏Á≤æÁÇºÔºåÊÄªÈïøÂ∫¶Â∫îÊéßÂà∂Âú® **${wordCount} Â≠óÂ∑¶Âè≥**„ÄÇ
6.  **„ÄêËæìÂá∫Ê†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`{"summary": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†‰ª•Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÔºåÊÄªÁªìÂ•ΩÁöÑÊ†∏ÂøÉ‰∫ãÂÆû‰∏éËÆ°Âàí„ÄÇ"}\`

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${targetChatForRefine.settings.aiPersona}

# ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ
${targetChatForRefine.settings.myPersona}

# ÂæÖÊï¥ÂêàÁöÑËÆ∞ÂøÜË¶ÅÁÇπÂàóË°®
${memoryContent}

Áé∞Âú®ÔºåËØ∑‰ª•‚Äú${targetChatForRefine.originalName}‚ÄùÁöÑË∫´‰ªΩÔºåÂºÄÂßã‰Ω†ÁöÑÂõûÂøÜÊ¢≥ÁêÜ‰∏éÁ≤æÁÇº„ÄÇ`;


    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAIËøõË°åËÆ∞ÂøÜÁ≤æÁÇº...");

    try {
      const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
      const {
        proxyUrl,
        apiKey,
        model
      } = useSecondaryApi
          ?
          {
            proxyUrl: state.apiConfig.secondaryProxyUrl,
            apiKey: state.apiConfig.secondaryApiKey,
            model: state.apiConfig.secondaryModel
          } :
          state.apiConfig;

      if (!proxyUrl || !apiKey || !model) {
        throw new Error('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩÔºà‰∏ªÊàñÂâØÔºâAPI‰ª•ËøõË°åÊÄªÁªì„ÄÇ');
      }

      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{
        role: 'user',
        content: "ËØ∑ÂºÄÂßãÊï¥Âêà„ÄÇ"
      }]);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, {
              role: 'user',
              content: "ËØ∑ÂºÄÂßãÊï¥Âêà„ÄÇ"
            }],
            temperature: 0.7,
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;

      const result = robustJsonParse(rawContent);

      if (result && result.summary && typeof result.summary === 'string' && result.summary.trim()) {

        const userConfirmedReplacement = await showCustomConfirm(
          'Á≤æÁÇºÂÆåÊàêÔºåËØ∑Á°ÆËÆ§',
          `AIÂ∑≤Â∞ÜÊÇ®ÁöÑ <strong>${rangeDescription}</strong> ÊÄªÁªì‰∏∫‰ª•‰∏ãÊ†∏ÂøÉËÆ∞ÂøÜÔºö<br><br><div class="scrollable-content-preview">${result.summary.trim()}</div><br>ÊòØÂê¶Áî®ËøôÊù°Êñ∞ËÆ∞ÂøÜÊõøÊç¢ÊéâËøô‰∫õÊóßËÆ∞ÂøÜÔºü`, {
          confirmText: 'Á°ÆËÆ§ÊõøÊç¢',
          cancelText: '‰øùÁïôÊóßÁöÑ',
          confirmButtonClass: 'btn-danger'
        }
        );

        if (userConfirmedReplacement) {
          const newMemoryEntry = {
            content: result.summary.trim(),
            timestamp: Date.now(),
            source: 'refined'
          };

          // Ê†πÊçÆËåÉÂõ¥ËøõË°åÊô∫ËÉΩÊõøÊç¢
          // ‰øùÁïôËåÉÂõ¥ÂâçÁöÑËÆ∞ÂøÜ + Êñ∞ÁöÑÁ≤æÁÇºËÆ∞ÂøÜ + ‰øùÁïôËåÉÂõ¥ÂêéÁöÑËÆ∞ÂøÜ
          const memoriesBeforeRange = rangeStartIndex > 0 ? targetChatForRefine.longTermMemory.slice(0, rangeStartIndex) : [];
          const memoriesAfterRange = rangeEndIndex < totalMemories ? targetChatForRefine.longTermMemory.slice(rangeEndIndex) : [];

          targetChatForRefine.longTermMemory = [...memoriesBeforeRange, newMemoryEntry, ...memoriesAfterRange];

          targetChatForRefine.lastMemorySummaryTimestamp = Date.now();
          await db.chats.put(targetChatForRefine);

          if (document.getElementById('long-term-memory-screen').classList.contains('active')) {
            renderLongTermMemoryList();
          }
          await showCustomAlert('Á≤æÁÇºÊàêÂäü', `Â∑≤ÊàêÂäüÂ∞Ü ${countToRefine} Êù°ËÆ∞ÂøÜÁ≤æÁÇº‰∏∫ 1 Êù°Ê†∏ÂøÉËÆ∞ÂøÜÔºÅ`);
        } else {
          await showCustomAlert('Êìç‰ΩúÂ∑≤ÂèñÊ∂à', 'ÊÇ®ÁöÑÊóßÊúâËÆ∞ÂøÜÂ∑≤Ë¢´ÂÆåÊï¥‰øùÁïôÔºåÊú™‰Ωú‰ªª‰Ωï‰øÆÊîπ„ÄÇ');
        }

      } else {
        throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ");
      }

    } catch (error) {
      console.error("Á≤æÁÇºÈïøÊúüËÆ∞ÂøÜÊó∂Âá∫Èîô:", error);
      await showCustomAlert('Á≤æÁÇºÂ§±Ë¥•', `Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÈáçËØï„ÄÇ\nÈîôËØØ‰ø°ÊÅØ: ${error.message}`);
    }
  }


  async function triggerAutoSummary(chatId, force = false, customRange = null) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const lastSummaryTimestamp = chat.lastMemorySummaryTimestamp || 0;
    let messagesToSummarize;

    if (customRange) {
      // ÊâãÂä®ÊÄªÁªìÔºö‰ΩøÁî®Ëá™ÂÆö‰πâËåÉÂõ¥
      const allMessages = chat.history.filter(m => !m.isHidden || (m.role === 'system' && m.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ')));
      const startIndex = Math.max(0, customRange.start - 1);
      const endIndex = Math.min(allMessages.length, customRange.end);
      messagesToSummarize = allMessages.slice(startIndex, endIndex);
    } else if (force && chat.settings.enableDiaryMode) {
      // Êó•ËÆ∞Ê®°ÂºèÔºöÊÄªÁªì‰∏äÊ¨°ÊÄªÁªì‰πãÂêéÁöÑÊâÄÊúâÊ∂àÊÅØÔºå‰∏çÂèó autoMemoryInterval ÈôêÂà∂
      messagesToSummarize = chat.history.filter(m => m.timestamp > lastSummaryTimestamp && (!m.isHidden || (m.role === 'system' && m.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ'))));
    } else {
      // ÂéüÊúâÈÄªËæë
      messagesToSummarize = force ?
        chat.history.filter(m => !m.isHidden || (m.role === 'system' && m.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ'))).slice(-(chat.settings.autoMemoryInterval || 20)) :
        chat.history.filter(m => m.timestamp > lastSummaryTimestamp && (!m.isHidden || (m.role === 'system' && m.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ'))));
    }

    if (messagesToSummarize.length < 5) {
      if (force) alert("ÊúÄËøëÁöÑÊ∂àÊÅØÂ§™Â∞ëÔºåÊó†Ê≥ïËøõË°åÊúâÊÑè‰πâÁöÑÊÄªÁªì„ÄÇ");
      return;
    }

    const userNickname = chat.settings.myNickname || (state.qzoneSettings.nickname || 'Áî®Êà∑');
    const startMsg = messagesToSummarize[0];
    const endMsg = messagesToSummarize[messagesToSummarize.length - 1];


    const formatDateTime = (ts) => new Date(ts).toLocaleString('zh-CN', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', hour12: false
    });

    const timeRangeStr = `${formatDateTime(startMsg.timestamp)} Ëá≥ ${formatDateTime(endMsg.timestamp)}`;
    const formattedHistory = messagesToSummarize.map(msg => {
      if (msg.isHidden && msg.role === 'system' && msg.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ')) {
        return msg.content;
      }
      if (msg.isHidden) return null; // ËøáÊª§ÊéâÂÖ∂‰ªñÈöêËóèÊ∂àÊÅØ

      let sender;
      if (msg.role === 'user') {
        sender = userNickname;
      } else {
        sender = msg.senderName || chat.originalName;
      }

      let prefix = "";

      if (msg.quote && msg.quote.content) {
        let quotedSenderDisplayName = msg.quote.senderName;


        if (msg.quote.senderName === (state.qzoneSettings.nickname || '{{user}}')) {
          quotedSenderDisplayName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
        } else {

          quotedSenderDisplayName = getDisplayNameInGroup(chat, msg.quote.senderName);
        }

        let quoteContentPreview = String(msg.quote.content).substring(0, 30);
        if (quoteContentPreview.length === 30) quoteContentPreview += "...";

        prefix = `[ÂõûÂ§ç ${quotedSenderDisplayName}: "${quoteContentPreview}"] `;
      }

      let contentToSummarize = '';
      if (msg.type === 'offline_text') {
        if (msg.content) {
          contentToSummarize = msg.content;
        } else {
          const dialogue = msg.dialogue ? `„Äå${msg.dialogue}„Äç` : '';
          const description = msg.description ? `(${msg.description})` : '';
          contentToSummarize = `${dialogue} ${description}`.trim();
        }
      } else if (typeof msg.content === 'string') {
        contentToSummarize = msg.content;
      } else if (msg.type === 'voice_message') {
        contentToSummarize = `[ËØ≠Èü≥: ${msg.content}]`;
      } else if (msg.type === 'ai_image' || msg.type === 'user_photo') {
        contentToSummarize = `[ÂõæÁâá: ${msg.content}]`;
      } else if (msg.type === 'sticker') {
        contentToSummarize = `[Ë°®ÊÉÖ: ${msg.meaning || 'sticker'}]`;
      } else if (Array.isArray(msg.content)) {
        contentToSummarize = `[ÂõæÁâá]`; // ÂÅáËÆæÊòØÂõæÁâáÊï∞ÁªÑ
      } else {
        contentToSummarize = `[${msg.type || 'Â§çÊùÇÊ∂àÊÅØ'}]`;
      }

      const msgTime = new Date(msg.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
      return `[${msgTime}] ${sender}: ${prefix}${contentToSummarize}`;

    }).filter(Boolean).join('\n');
    const summaryWorldBook = state.worldBooks.find(wb => wb.name === 'ÊÄªÁªìËÆæÂÆö');
    let summarySettingContext = '';
    if (summaryWorldBook) {
      const enabledEntries = summaryWorldBook.content
        .filter(e => e.enabled !== false) // ‰ªÖËØªÂèñÂêØÁî®ÁöÑÊù°ÁõÆ
        .map(e => e.content)
        .join('\n');

      if (enabledEntries) {
        summarySettingContext = `
# „ÄêÊÄªÁªìËßÑÂàô (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë
# ‰Ω†Âú®ÊâßË°åÊú¨Ê¨°ÊÄªÁªì‰ªªÂä°Êó∂Ôºå„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËßÑÂàôÔºö
# ---
# ${enabledEntries}
# ---
`;
      }
    }
    let systemPrompt;

    if (chat.isGroup) {
      let timeHeader = '';
      let timeRule = '';

      if (chat.settings.enableTimePerception) {
        timeHeader = `
# ÂØπËØùÂèëÁîüÊó∂Èó¥
- **${timeRangeStr}**`;
        timeRule = `- (ËØ∑Âü∫‰∫éÊ≠§Êó∂Èó¥ËåÉÂõ¥Êù•ÁêÜËß£ÂØπËØù‰∏≠ÊèêÂà∞ÁöÑ‚Äú‰ªäÂ§©‚Äù„ÄÅ‚ÄúÊòéÂ§©‚ÄùÁ≠âÁõ∏ÂØπÊó∂Èó¥Ê¶ÇÂøµÔºåÂπ∂Â∞ÜÂÆÉ‰ª¨ËΩ¨Êç¢‰∏∫ÂÖ∑‰ΩìÁöÑÊó•ÊúüËÆ∞ÂΩïÂú®ËÆ∞ÂøÜ‰∏≠„ÄÇ)`;
      }
      systemPrompt = `
${summarySettingContext}
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™È´òÁ∫ßÁöÑ‚ÄúËÆ∞ÂøÜÂàÜÈÖç‰∏ìÂÆ∂‚Äù„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÈòÖËØª‰∏ãÈù¢ÁöÑÁæ§ËÅäËÆ∞ÂΩïÔºåÂπ∂‰∏∫„ÄêÊØè‰∏Ä‰∏™ÂèÇ‰∏éÁöÑAIËßíËâ≤„ÄëÁîüÊàê‰∏ÄÊÆµ„Äê‰∏™ÊÄßÂåñÁöÑ„ÄÅÁ¨¨‰∏Ä‰∫∫Áß∞„ÄëÁöÑÈïøÊúüËÆ∞ÂøÜ„ÄÇËØ∑‰∏ìÊ≥®‰∫éÈáçË¶ÅÁöÑÊÉÖÁª™„ÄÅ‰∫ã‰ª∂ÂíåÁªÜËäÇ„ÄÇ
${timeHeader}
- (ËØ∑Âü∫‰∫éÊ≠§Êó∂Èó¥ËåÉÂõ¥Êù•ÁêÜËß£ÂØπËØù‰∏≠ÊèêÂà∞ÁöÑ‚Äú‰ªäÂ§©‚Äù„ÄÅ‚ÄúÊòéÂ§©‚ÄùÁ≠âÁõ∏ÂØπÊó∂Èó¥Ê¶ÇÂøµÔºåÂπ∂Â∞ÜÂÆÉ‰ª¨ËΩ¨Êç¢‰∏∫ÂÖ∑‰ΩìÁöÑÊó•ÊúüËÆ∞ÂΩïÂú®ËÆ∞ÂøÜ‰∏≠„ÄÇ)
# Ê†∏ÂøÉËßÑÂàô
1.  **ËßÜËßíÈìÅÂæã**: ÊØè‰∏ÄÊù°ÊÄªÁªìÈÉΩ„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„Äë„ÄÇ
2.  **ÂÜÖÂÆπÊ†∏ÂøÉ**: ÈáçÁÇπÊÄªÁªìÔºöÊàëËØ¥ËøáÁöÑËØù„ÄÅÊàëÂÅöËøáÁöÑ‰∫ã„ÄÅÂà´‰∫∫ÂØπÊàëËØ¥ÁöÑËØù„ÄÅ‰∏éÊàëÁõ∏ÂÖ≥ÁöÑ‰∫ã„ÄÅ‰ª•ÂèäÂØπÊàë‰∏™‰∫∫ÂæàÈáçË¶ÅÁöÑÁæ§ËÅä‰∫ã‰ª∂„ÄÅÂÖ≥ÈîÆ‰ø°ÊÅØÂíåÂøÉÁêÜÊ¥ªÂä®‰ª•ÂèäÂΩìÂâçÁæ§ËÅäÂÜÖÁöÑÊÉÖÊôØ„ÄÇ
${timeRule}
4.  **„ÄêÁúÅÁï•ËßÑÂàô„Äë**: Â¶ÇÊûú‰∏Ä‰∏™ËßíËâ≤Âú®Êú¨Ê¨°ÂØπËØù‰∏≠„ÄêÂÆåÂÖ®Ê≤°ÊúâÂèÇ‰∏éÊàñÊèêÂèä„ÄëÔºå‰Ω†ÂèØ‰ª•ÁúÅÁï•TAÁöÑËÆ∞ÂøÜ„ÄÇ
5.  **ËæìÂá∫Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`\`\`json
    {
      "summaries": {
        "ËßíËâ≤ÁöÑÊú¨ÂêçA": "ÊàëÂú®(${timeRangeStr.split(' ')[0]})ÂíåÂ§ßÂÆ∂ËÆ®ËÆ∫‰∫Ü...",
        "ËßíËâ≤ÁöÑÊú¨ÂêçB": "ÊàëÁ∫¶‰∫Ü${userNickname}Âú®ÊòéÂ§©(ÈúÄÊ†πÊçÆÊó∂Èó¥ËåÉÂõ¥Êé®ÁÆóÂÖ∑‰ΩìÊó•Êúü)ÂçïÁã¨ËßÅÈù¢„ÄÇ"
      }
    }
    \`\`\`
# ÂæÖÊÄªÁªìÁöÑÁæ§ËÅäËÆ∞ÂΩï
${formattedHistory}
# Áæ§ÊàêÂëòÂàóË°® (‰Ω†ÁöÑÊÄªÁªìÁõÆÊ†á)
${chat.members.map(m => `- ${m.groupNickname} (Êú¨Âêç: ${m.originalName})`).join('\n')}
Áé∞Âú®ÔºåËØ∑‰∏∫„ÄêÂèÇ‰∏é‰∫ÜÂØπËØùÁöÑAIËßíËâ≤„ÄëÁîüÊàê‰ªñ‰ª¨ÂêÑËá™ÁöÑ„ÄÅÁ¨¨‰∏Ä‰∫∫Áß∞ÁöÑ„ÄÅÁ≤æÁÆÄÁöÑËÆ∞ÂøÜ„ÄÇ`;

    } else {


      const today = new Date().toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      let timeHeader = '';
      let timeRule = '';

      if (chat.settings.enableTimePerception) {
        timeHeader = `
# ÂØπËØùÊó∂Èó¥ËåÉÂõ¥
- **${timeRangeStr}**`;
        timeRule = `3.  **„ÄêÊó∂Èó¥ËΩ¨Êç¢ÈìÅÂæã (ÂøÖÈ°ªÈÅµÂÆà)„Äë**: Â¶ÇÊûúÂØπËØù‰∏≠ÊèêÂà∞‰∫ÜÁõ∏ÂØπÊó∂Èó¥ÔºàÂ¶Ç‚ÄúÊòéÂ§©‚Äù„ÄÅ‚ÄúÂêéÂ§©‚ÄùÔºâÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÁªìÂêà‰∏äÈù¢ÁöÑ„ÄêÂØπËØùÊó∂Èó¥ËåÉÂõ¥„Äë‰ø°ÊÅØÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫„ÄêÂÖ∑‰ΩìÁöÑÂÖ¨ÂéÜÊó•Êúü„Äë„ÄÇ`;
      }

      systemPrompt = `
${summarySettingContext}
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Â∞±ÊòØËßíËâ≤‚Äú${chat.originalName}‚Äù„ÄÇËØ∑‰Ω†ÂõûÈ°æ‰∏Ä‰∏ãÂàöÊâçÂíå‚Äú${userNickname}‚ÄùÁöÑÂØπËØùÔºåÁÑ∂ÂêéÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ ("Êàë")„ÄëÁöÑÂè£ÂêªÔºåÊÄªÁªìÂá∫‰∏ÄÊÆµÁÆÄÁü≠ÁöÑ„ÄÅÂÆ¢ËßÇÁöÑ„ÄÅÂåÖÂê´ÂÖ≥ÈîÆ‰ø°ÊÅØÁöÑËÆ∞ÂøÜ„ÄÇËØ∑‰∏ìÊ≥®‰∫éÈáçË¶ÅÁöÑÊÉÖÁª™„ÄÅ‰∫ã‰ª∂ÂíåÁªÜËäÇ„ÄÇ

${timeHeader}

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêËßÜËßíÈìÅÂæã„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®„Äê‰∏ªËßÇÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„ÄëÊù•ÂÜô„ÄÇ
2.  **„ÄêÂÜÖÂÆπÊ†∏ÂøÉ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰∏ìÊ≥®‰∫é‰ª•‰∏ãÂá†ÁÇπÔºö
    *   **ÈáçË¶Å‰∫ã‰ª∂**: ÂàöÊâçÂèëÁîü‰∫Ü‰ªÄ‰πàÂÖ∑‰ΩìÁöÑ‰∫ãÊÉÖÔºü
    *   **ÂÖ≥ÈîÆÂÜ≥ÂÆö**: Êàë‰ª¨ËææÊàê‰∫Ü‰ªÄ‰πàÂÖ±ËØÜÊàñÂÅöÂá∫‰∫Ü‰ªÄ‰πàÂÜ≥ÂÆöÔºü
    *   **Êú™Êù•ËÆ°Âàí**: Êàë‰ª¨Á∫¶ÂÆö‰∫Ü‰ªÄ‰πàÊú™Êù•ÁöÑËÆ°ÂàíÊàñÂæÖÂäû‰∫ãÈ°πÔºü
    *   **ÈáçË¶ÅÊó∂Èó¥ÁÇπ**: ÂØπËØù‰∏≠ÊèêÂà∞‰∫ÜÂì™‰∫õÂÖ∑‰ΩìÁöÑÊó•ÊúüÊàñÊó∂Èó¥Ôºü

${timeRule}
4.  **„ÄêÈ£éÊ†ºË¶ÅÊ±Ç„Äë**: ‰Ω†ÁöÑÊÄªÁªìÂ∫îËØ•ÂÉè‰∏Ä‰ªΩÂ§áÂøòÂΩïÊàñË¶ÅÁÇπËÆ∞ÂΩïÔºåËÄå‰∏çÊòØ‰∏ÄÁØáÊäíÊÉÖÊï£Êñá„ÄÇËØ∑Â∞ΩÈáèÂáèÂ∞ë‰∏ªËßÇÁöÑÂøÉÁêÜÊÑüÂèóÊèèËø∞ÔºåÈô§ÈùûÂÆÉÁõ¥Êé•ÂØºËá¥‰∫ÜÊüê‰∏™ÂÜ≥ÂÆöÊàñËÆ°Âàí„ÄÇ

6.  **„ÄêËæìÂá∫Ê†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`{"summary": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†‰ª•Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÔºåÊÄªÁªìÂ•ΩÁöÑÊ†∏ÂøÉ‰∫ãÂÆû‰∏éËÆ°Âàí„ÄÇ"}\`

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.aiPersona}
# ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ
${chat.settings.myPersona}
# ÂæÖÊÄªÁªìÁöÑÂØπËØùÂéÜÂè≤
${formattedHistory}

Áé∞Âú®ÔºåËØ∑‰ª•‚Äú${chat.originalName}‚ÄùÁöÑË∫´‰ªΩÔºåÂºÄÂßã‰Ω†ÁöÑÂÆ¢ËßÇÊÄªÁªì„ÄÇ`;

    }

    try {
      const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
      const {
        proxyUrl,
        apiKey,
        model
      } = useSecondaryApi ? {
        proxyUrl: state.apiConfig.secondaryProxyUrl,
        apiKey: state.apiConfig.secondaryApiKey,
        model: state.apiConfig.secondaryModel
      } : state.apiConfig;
      if (!proxyUrl || !apiKey || !model) throw new Error('APIÊú™ÈÖçÁΩÆ');

      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{
        role: 'user',
        content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ"
      }]);
      const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: model,
          messages: [{
            role: 'system',
            content: systemPrompt
          }, {
            role: 'user',
            content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ"
          }],
          temperature: 0.7
        })
      });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);
      const data = await response.json();
      let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
      rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
      const result = JSON.parse(rawContent);

      if (chat.isGroup) {
        if (result.summaries && typeof result.summaries === 'object') {
          let memoriesAddedCount = 0;
          for (const memberOriginalName in result.summaries) {
            const summaryText = result.summaries[memberOriginalName];
            if (summaryText && summaryText.trim()) {
              const memberChat = Object.values(state.chats).find(c => c.originalName === memberOriginalName);
              if (memberChat) {
                const newMemoryEntry = {
                  content: summaryText.trim(),
                  timestamp: Date.now(),
                  source: `group_summary_from_${chat.name}`
                };
                if (!memberChat.longTermMemory) memberChat.longTermMemory = [];
                memberChat.longTermMemory.push(newMemoryEntry);
                await db.chats.put(memberChat);
                memoriesAddedCount++;
              }
            }
          }
          if (memoriesAddedCount > 0) {
            console.log(`Ëá™Âä®ÊÄªÁªìÊàêÂäüÔºö‰∏∫ ${memoriesAddedCount} ‰ΩçÁæ§ÊàêÂëòÁîüÊàêÂπ∂Ê≥®ÂÖ•‰∫Ü‰∏™ÊÄßÂåñËÆ∞ÂøÜÔºÅ`);
          } else {
            throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ");
          }
        } else {
          throw new Error("AIËøîÂõûÁöÑJSONÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÁº∫Â∞ë 'summaries' Â≠óÊÆµ„ÄÇ");
        }
      } else {
        if (result.summary && result.summary.trim()) {
          const newMemoryEntry = {
            content: result.summary.trim(),
            timestamp: Date.now(),
            source: 'auto'
          };
          chat.longTermMemory.push(newMemoryEntry);
          await db.chats.put(chat);
          console.log('Ëá™Âä®ÊÄªÁªìÊàêÂäüÔºöÂ∑≤ÊàêÂäüÊ∑ªÂä† 1 Êù°Êñ∞ÁöÑÈïøÊúüËÆ∞ÂøÜÔºÅ');
        } else {
          throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ");
        }
      }

      chat.lastMemorySummaryTimestamp = messagesToSummarize.slice(-1)[0].timestamp;
      await db.chats.put(chat);

      if (document.getElementById('long-term-memory-screen').classList.contains('active')) {
        renderLongTermMemoryList();
      }
    } catch (error) {
      console.error("ÊÄªÁªìÈïøÊúüËÆ∞ÂøÜÊó∂Âá∫Èîô:", error);
      await showCustomAlert('ÊÄªÁªìÂ§±Ë¥•', `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
  }

  function startReplyToMessage() {
    if (!activeMessageTimestamp) return;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp && !m.isHidden);
    if (!message) return;


    let senderDisplayName;
    if (message.role === 'user') {
      senderDisplayName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
    } else {
      if (chat.isGroup) {

        senderDisplayName = getDisplayNameInGroup(chat, message.senderName);
      } else {

        senderDisplayName = chat.name;
      }
    }


    const fullContent = String(message.content || '');
    let previewSnippet = '';

    if (typeof message.content === 'string' && STICKER_REGEX.test(message.content)) {
      previewSnippet = '[Ë°®ÊÉÖ]';
    } else if (message.type === 'ai_image' || message.type === 'user_photo') {
      previewSnippet = '[ÂõæÁâá]';
    } else if (message.type === 'voice_message') {
      previewSnippet = '[ËØ≠Èü≥]';
    } else {
      previewSnippet = fullContent.substring(0, 50) + (fullContent.length > 50 ? '...' : '');
    }

    currentReplyContext = {
      timestamp: message.timestamp,
      senderName: senderDisplayName,
      content: fullContent,
    };

    const previewBar = document.getElementById('reply-preview-bar');
    previewBar.querySelector('.sender').textContent = `ÂõûÂ§ç ${currentReplyContext.senderName}:`;
    previewBar.querySelector('.text').textContent = previewSnippet;
    previewBar.style.display = 'block';

    hideMessageActions();
    document.getElementById('chat-input').focus();
  }

  function cancelReplyMode() {
    currentReplyContext = null;
    document.getElementById('reply-preview-bar').style.display = 'none';
  }





  let activeTransferTimestamp = null;


  function showTransferActionModal(timestamp) {
    activeTransferTimestamp = timestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (message) {

      document.getElementById('transfer-sender-name').textContent = message.senderName;
    }
    document.getElementById('transfer-actions-modal').classList.add('visible');
  }


  function hideTransferActionModal() {
    document.getElementById('transfer-actions-modal').classList.remove('visible');
    activeTransferTimestamp = null;
  }







  async function renderCallHistoryScreen() {
    showScreen('call-history-screen');

    const listEl = document.getElementById('call-history-list');
    const titleEl = document.getElementById('call-history-title');
    listEl.innerHTML = '';
    titleEl.textContent = 'ÊâÄÊúâÈÄöËØùËÆ∞ÂΩï';

    const records = await db.callRecords.orderBy('timestamp').reverse().toArray();

    if (records.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°ÊúâÈÄöËØùËÆ∞ÂΩïÂì¶~</p>';
      return;
    }

    records.forEach(record => {
      const card = createCallRecordCard(record);

      addLongPressListener(card, async () => {

        const newName = await showCustomPrompt(
          "Ëá™ÂÆö‰πâÈÄöËØùÂêçÁß∞",
          "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂêçÁß∞ÔºàÁïôÁ©∫ÂàôÊÅ¢Â§çÈªòËÆ§Ôºâ",
          record.customName || ''
        );


        if (newName === null) return;


        await db.callRecords.update(record.id, {
          customName: newName.trim()
        });


        await renderCallHistoryScreen();


        await showCustomAlert('ÊàêÂäü', 'ÈÄöËØùÂêçÁß∞Â∑≤Êõ¥Êñ∞ÔºÅ');
      });
      listEl.appendChild(card);
    });
  }



  function createCallRecordCard(record) {
    const card = document.createElement('div');
    card.className = 'call-record-card';
    card.dataset.recordId = record.id;

    const chatInfo = state.chats[record.chatId];
    const chatName = chatInfo ? chatInfo.name : 'Êú™Áü•‰ºöËØù';

    const callDate = new Date(record.timestamp);
    const dateString = `${callDate.getFullYear()}-${String(callDate.getMonth() + 1).padStart(2, '0')}-${String(callDate.getDate()).padStart(2, '0')} ${String(callDate.getHours()).padStart(2, '0')}:${String(callDate.getMinutes()).padStart(2, '0')}`;
    const durationText = `${Math.floor(record.duration / 60)}ÂàÜ${record.duration % 60}Áßí`;

    // Âà§Êñ≠ÈÄöËØùÁ±ªÂûã
    const callTypeIcon = record.callType === 'voice' ? 'üìû' : 'üìπ';
    const callTypeText = record.callType === 'voice' ? 'ËØ≠Èü≥ÈÄöËØù' : 'ËßÜÈ¢ëÈÄöËØù';

    const avatarsHtml = record.participants.map(p =>
      `<img src="${p.avatar}" alt="${p.name}" class="participant-avatar" title="${p.name}">`
    ).join('');

    card.innerHTML = `
                <div class="card-header">
                    <span class="date">${callTypeIcon} ${dateString}</span>
                    <span class="duration">${durationText}</span>
                </div>
                <div class="card-body">
                    ${record.customName ? `<div class="custom-title">${record.customName}</div>` : ''}
                    
                    <div class="participants-info">
                        <div class="participants-avatars">${avatarsHtml}</div>
                        <span class="participants-names">‰∏é ${chatName} ÁöÑ${callTypeText}</span>
                    </div>
                </div>
            `;
    return card;
  }



  async function showCallTranscript(recordId) {
    const record = await db.callRecords.get(recordId);
    if (!record) return;

    const modal = document.getElementById('call-transcript-modal');
    const titleEl = document.getElementById('transcript-modal-title');
    const bodyEl = document.getElementById('call-transcript-modal-body');

    const callTypeText = record.callType === 'voice' ? 'ËØ≠Èü≥ÈÄöËØù' : 'ËßÜÈ¢ëÈÄöËØù';
    titleEl.textContent = `${callTypeText}‰∫é ${new Date(record.timestamp).toLocaleString()} (Êó∂Èïø: ${Math.floor(record.duration / 60)}ÂàÜ${record.duration % 60}Áßí)`;
    bodyEl.innerHTML = '';

    const deleteBtn = document.getElementById('delete-transcript-btn');
    const summarizeBtn = document.getElementById('manual-summarize-btn');

    if (!record.transcript || record.transcript.length === 0) {
      bodyEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">ËøôÊ¨°ÈÄöËØùÊ≤°ÊúâÁïô‰∏ãÊñáÂ≠óËÆ∞ÂΩï„ÄÇ</p>';
      summarizeBtn.style.display = 'none';
    } else {
      summarizeBtn.style.display = 'block';
      record.transcript.forEach(entry => {
        const bubble = document.createElement('div');
        bubble.className = `transcript-entry ${entry.role}`;
        bubble.textContent = entry.content;
        bodyEl.appendChild(bubble);
      });
    }

    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
    const newSummarizeBtn = summarizeBtn.cloneNode(true);
    summarizeBtn.parentNode.replaceChild(newSummarizeBtn, summarizeBtn);

    newDeleteBtn.addEventListener('click', async () => {
      const confirmed = await showCustomConfirm(
        "Á°ÆËÆ§Âà†Èô§", "Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÊù°ÈÄöËØùËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ", {
        confirmButtonClass: 'btn-danger'
      }
      );
      if (confirmed) {
        modal.classList.remove('visible');
        await db.callRecords.delete(recordId);
        await renderCallHistoryScreen();
        alert('ÈÄöËØùËÆ∞ÂΩïÂ∑≤Âà†Èô§„ÄÇ');
      }
    });



    newSummarizeBtn.addEventListener('click', async () => {

      const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§Êìç‰Ωú',
        'ËøôÂ∞ÜÊèêÂèñÂΩìÂâçÈÄöËØùËÆ∞ÂΩïÂèëÈÄÅÁªôAIËøõË°åÊÄªÁªìÔºå‰ºöÊ∂àËÄóAPIÈ¢ùÂ∫¶„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü', {
        confirmText: 'Á°ÆËÆ§ÊÄªÁªì'
      }
      );


      if (!confirmed) return;

      modal.classList.remove('visible');
      const chat = state.chats[record.chatId];
      if (!chat) {
        alert('ÈîôËØØÔºöÊâæ‰∏çÂà∞ËØ•ÈÄöËØùËÆ∞ÂΩïÊâÄÂ±ûÁöÑËÅäÂ§©ÂØπË±°„ÄÇ');
        return;
      }

      await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAIËøõË°åÊâãÂä®ÊÄªÁªì...");

      try {
        const transcriptText = record.transcript.map(h => {
          const sender = h.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (h.senderName || chat.name);
          return `${sender}: ${h.content}`;
        }).join('\n');

        await summarizeCallTranscript(record.chatId, transcriptText);

        await showCustomAlert("ÊÄªÁªìÊàêÂäü", `ÊâãÂä®ÊÄªÁªìÂ∑≤ÂÆåÊàêÔºÅÊñ∞ÁöÑËÆ∞ÂøÜÂ∑≤Ê∑ªÂä†Âà∞‚Äú${chat.name}‚ÄùÁöÑÈïøÊúüËÆ∞ÂøÜ‰∏≠„ÄÇ`);

      } catch (error) {
        await showCustomAlert("ÊÄªÁªìÂ§±Ë¥•", `Êìç‰ΩúÂ§±Ë¥•ÔºåÊú™ËÉΩÁîüÊàêÈïøÊúüËÆ∞ÂøÜ„ÄÇ\n\nÈîôËØØËØ¶ÊÉÖ: ${error.message}`);
      }
    });





    const closeBtn = document.getElementById('close-transcript-modal-btn');
    const newCloseBtn = closeBtn.cloneNode(true);
    closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

    newCloseBtn.addEventListener('click', () => {
      modal.classList.remove('visible');
    });


    modal.classList.add('visible');
  }


  async function handleEditStatusClick() {

    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
      return;
    }
    const chat = state.chats[state.activeChatId];


    const newStatusText = await showCustomPrompt(
      'ÁºñËæëÂØπÊñπÁä∂ÊÄÅ',
      'ËØ∑ËæìÂÖ•ÂØπÊñπÁé∞Âú®ÁöÑÊñ∞Áä∂ÊÄÅÔºö',
      chat.status.text
    );


    if (newStatusText !== null) {

      chat.status.text = newStatusText.trim() || 'Âú®Á∫ø';
      chat.status.isBusy = false;
      chat.status.lastUpdate = Date.now();
      await db.chats.put(chat);


      renderChatInterface(state.activeChatId);
      renderChatList();


      await showCustomAlert('Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞', `‚Äú${chat.name}‚ÄùÁöÑÂΩìÂâçÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫Ôºö${chat.status.text}`);
    }
  }


  async function openShareTargetPicker() {
    const modal = document.getElementById('share-target-modal');
    const listEl = document.getElementById('share-target-list');
    listEl.innerHTML = '';


    const chats = Object.values(state.chats);

    chats.forEach(chat => {

      const item = document.createElement('div');
      item.className = 'contact-picker-item';
      item.innerHTML = `
                    <input type="checkbox" class="share-target-checkbox" data-chat-id="${chat.id}" style="margin-right: 15px;">
                    <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
                    <span class="name">${chat.name}</span>
                `;
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
  }

  async function openForwardTargetPicker() {
    const modal = document.getElementById('forward-target-modal');
    const listEl = document.getElementById('forward-target-list');
    listEl.innerHTML = '';

    const chats = Object.values(state.chats);

    chats.forEach(chat => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';
      item.innerHTML = `
                    <input type="checkbox" class="forward-target-checkbox" data-chat-id="${chat.id}" style="margin-right: 15px;">
                    <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
                    <span class="name">${chat.name}</span>
                `;
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
  }

  function closeMusicPlayerWithAnimation(callback) {
    const overlay = document.getElementById('music-player-overlay');
    if (!overlay.classList.contains('visible')) {
      if (callback) callback();
      return;
    }
    overlay.classList.remove('visible');
    setTimeout(() => {
      document.getElementById('music-playlist-panel').classList.remove('visible');
      if (callback) callback();
    }, 400);
  }

  function parseLRC(lrcContent) {
    if (!lrcContent) return [];
    const lines = String(lrcContent).split(/\r\n?|\n/);
    const lyrics = [];
    const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;
    for (const line of lines) {
      const text = line.replace(timeRegex, '').trim();
      if (!text) continue;
      timeRegex.lastIndex = 0;
      let match;
      while ((match = timeRegex.exec(line)) !== null) {
        const minutes = parseInt(match[1], 10);
        const seconds = parseInt(match[2], 10);
        const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
        const time = minutes * 60 + seconds + milliseconds / 1000;
        lyrics.push({
          time,
          text
        });
      }
    }
    return lyrics.sort((a, b) => a.time - b.time);
  }

  function renderLyrics() {
    const lyricsList = document.getElementById('music-lyrics-list');
    lyricsList.innerHTML = '';
    if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
      lyricsList.innerHTML = '<div class="lyric-line">‚ô™ ÊöÇÊó†Ê≠åËØç ‚ô™</div>';
      return;
    }
    musicState.parsedLyrics.forEach((line, index) => {
      const lineEl = document.createElement('div');
      lineEl.className = 'lyric-line';
      lineEl.textContent = line.text;
      lineEl.dataset.index = index;
      lyricsList.appendChild(lineEl);
    });
    lyricsList.style.transform = `translateY(0px)`;
  }

  function updateIslandScrollAnimation() {

  }

  function checkLyricScroll() {

    if (!islandLyricText || !islandLyricContainer) return;

    const textWidth = islandLyricText.scrollWidth;
    const containerWidth = islandLyricContainer.clientWidth;


    if (textWidth > containerWidth) {

      const scrollRatio = textWidth / containerWidth;
      const animationDuration = Math.max(5, scrollRatio * 5);


      islandLyricText.style.setProperty('--animation-duration', `${animationDuration}s`);
      islandLyricText.style.setProperty('--container-width', `${containerWidth}px`);
      islandLyricText.style.setProperty('--text-width', `${textWidth}px`);


      islandLyricText.classList.add('scrolling');
    } else {

      islandLyricText.classList.remove('scrolling');
    }
  }



  function updateActiveLyric(currentTime) {
    if (musicState.parsedLyrics.length === 0) return;
    let newLyricIndex = -1;
    for (let i = 0; i < musicState.parsedLyrics.length; i++) {
      if (currentTime >= musicState.parsedLyrics[i].time) {
        newLyricIndex = i;
      } else {
        break;
      }
    }
    if (newLyricIndex === musicState.currentLyricIndex) return;
    musicState.currentLyricIndex = newLyricIndex;
    updateLyricsUI();

    const singleLyricEl = document.getElementById('single-lyric-display');
    if (singleLyricEl) {
      if (newLyricIndex > -1 && musicState.parsedLyrics[newLyricIndex]) {
        singleLyricEl.textContent = musicState.parsedLyrics[newLyricIndex].text;
      } else {
        singleLyricEl.textContent = '‚ô™ ‚ô™ ‚ô™';
      }
    }

    const lyricBar = document.getElementById('global-lyrics-bar');
    if (lyricBar.classList.contains('visible')) {
      if (newLyricIndex > -1 && musicState.parsedLyrics[newLyricIndex]) {
        lyricBar.textContent = musicState.parsedLyrics[newLyricIndex].text;
      } else {
        lyricBar.textContent = '‚ô™';
      }
    }


    if (phoneScreenForIsland.classList.contains('dynamic-island-active')) {
      const lyricText = (newLyricIndex > -1 && musicState.parsedLyrics[newLyricIndex]) ?
        musicState.parsedLyrics[newLyricIndex].text :
        '‚ô™ ‚ô™ ‚ô™';


      const firstSpan = islandLyricText.querySelector('span:first-child');
      if (firstSpan && firstSpan.textContent === lyricText) {
        return;
      }


      islandLyricText.style.opacity = 0;


      setTimeout(() => {



        islandLyricText.classList.remove('scrolling');
        islandLyricContainer.classList.remove('center-content');
        islandLyricText.style.animation = 'none';

        let span1 = islandLyricText.querySelector('span:first-child');
        let span2 = islandLyricText.querySelector('span:last-child');
        if (!span1) {
          span1 = document.createElement('span');
          islandLyricText.appendChild(span1);
        }
        if (!span2) {
          span2 = document.createElement('span');
          islandLyricText.appendChild(span2);
        }

        span1.textContent = lyricText;
        span2.textContent = lyricText;

        const textWidth = span1.offsetWidth;
        const containerWidth = islandLyricContainer.clientWidth;


        if (textWidth > containerWidth) {

          const scrollRatio = textWidth / containerWidth;
          const duration = Math.max(5, scrollRatio * 5);

          islandLyricText.style.setProperty('--marquee-duration', `${duration}s`);
          islandLyricText.classList.add('scrolling');

          islandLyricText.style.animation = `marquee var(--marquee-duration, 10s) linear infinite`;
        } else {

          islandLyricContainer.classList.add('center-content');
        }




        islandLyricText.style.opacity = 1;

      }, 200);
    }

  }


  function updateLyricsUI(isFullscreen = false) {
    const listSelector = isFullscreen ? '#fullscreen-lyrics-container .music-lyrics-list' : '#music-lyrics-container #music-lyrics-list';
    const containerSelector = isFullscreen ? '#fullscreen-lyrics-container' : '#music-lyrics-container';

    const lyricsList = document.querySelector(listSelector);
    const container = document.querySelector(containerSelector);
    if (!lyricsList || !container) return;

    const lines = lyricsList.querySelectorAll('.lyric-line');
    lines.forEach(line => line.classList.remove('active'));

    if (musicState.currentLyricIndex === -1) {
      lyricsList.style.transform = `translateY(0px)`;
      return;
    }

    const activeLine = lyricsList.querySelector(`.lyric-line[data-index="${musicState.currentLyricIndex}"]`);
    if (activeLine) {
      activeLine.classList.add('active');
      const containerHeight = container.offsetHeight;
      const offset = (containerHeight / 2.2) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
      lyricsList.style.transform = `translateY(${offset}px)`;
    }
  }

  function formatMusicTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${String(remainingSeconds).padStart(2, '0')}`;
  }

  let lastTimeUpdate = 0;
  let animationFrameId;

  function updateMusicProgressBar() {
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
    }

    function step() {
      if (!musicState.isPlaying || !audioPlayer.duration) {
        return;
      }

      const now = performance.now();
      const currentTime = audioPlayer.currentTime;
      const duration = audioPlayer.duration;

      const progressPercent = (currentTime / duration) * 100;
      document.getElementById('music-progress-fill').style.width = `${progressPercent}%`;

      if (now - lastTimeUpdate > 1000) {
        document.getElementById('music-current-time').textContent = formatMusicTime(currentTime);
        document.getElementById('music-total-time').textContent = formatMusicTime(duration);
        updateActiveLyric(currentTime);
        updateIslandScrollAnimation();
        lastTimeUpdate = now;
      }


      animationFrameId = requestAnimationFrame(step);
    }

    animationFrameId = requestAnimationFrame(step);
  }



  function openAiResponseEditor() {
    if (!lastRawAiResponse) {
      alert("ËøòÊ≤°ÊúâÂèØ‰æõÁºñËæëÁöÑAIÂìçÂ∫î„ÄÇËØ∑ÂÖàËÆ©AIÂõûÂ§ç‰∏ÄÊ¨°„ÄÇ");
      return;
    }

    const editorModal = document.getElementById('ai-response-editor-modal');
    const editorContainer = document.getElementById('ai-response-editor-container');
    editorContainer.innerHTML = '';


    const actionObjects = parseAiResponse(lastRawAiResponse);

    if (actionObjects && actionObjects.length > 0) {

      actionObjects.forEach(actionObj => {


        if (typeof actionObj === 'object' && actionObj !== null) {
          try {

            const formattedJson = JSON.stringify(actionObj, null, 2);
            const block = createAiResponseEditorBlock(formattedJson);
            editorContainer.appendChild(block);
          } catch (e) {

            console.error("Âú®ÂØºÊºîÊ®°Âºè‰∏ã stringify Â§±Ë¥•:", actionObj, e);
          }
        } else if (typeof actionObj === 'string') {

          const block = createAiResponseEditorBlock(actionObj);
          editorContainer.appendChild(block);
          console.warn("Âú®ÂØºÊºîÊ®°Âºè‰∏≠ÂèëÁé∞‰∏Ä‰∏™Êó†ÊïàÁöÑÁâáÊÆµ (Êù•Ëá™parseAiResponseÁöÑÊñáÊú¨ÂõûÈÄÄ):", actionObj);
        }
      });
    } else {

      const block = createAiResponseEditorBlock(lastRawAiResponse);
      editorContainer.appendChild(block);
    }


    editorModal.classList.add('visible');
  }



  function createAiResponseEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'ai-response-editor-block';


    const templates = {
      text: {
        type: 'text',
        content: 'Âú®ËøôÈáåËæìÂÖ•ÊñáÊú¨...'
      },
      sticker: {
        type: 'sticker',
        url: 'https://...',
        meaning: 'Ë°®ÊÉÖÂê´‰πâ'
      },
      image: {
        type: 'ai_image',
        description: 'Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞...'
      },
      voice: {
        type: 'voice_message',
        content: 'Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ...'
      },
      transfer: {
        type: 'transfer',
        amount: 5.20,
        note: '‰∏ÄÁÇπÂøÉÊÑè'
      },
      offline: {
        type: 'offline_text',
        content: '„ÄåÂú®ËøôÈáåËæìÂÖ•ÂØπËØùÂÜÖÂÆπ„Äç\\n(Âú®ËøôÈáåËæìÂÖ•Âä®‰ΩúÊàñÁéØÂ¢ÉÊèèÂÜô)'
      },
      quote: {
        type: 'quote_reply',
        target_timestamp: 1234567890,
        reply_content: 'Âú®ËøôÈáåËæìÂÖ•ÂõûÂ§çÂÜÖÂÆπ'
      },

      nai: {
        type: 'naiimag',
        prompt: '1girl, best quality, masterpiece, ...'
      },
      narration: {
        type: 'narration',
        content: 'Âú®ËøôÈáåËæìÂÖ•ÁéØÂ¢ÉÊàñÂøÉÁêÜÊèèÂÜô...'
      }


    };

    block.innerHTML = `
        <button class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°Âä®‰Ωú">√ó</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.text)}'>ÊñáÊú¨</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.sticker)}'>Ë°®ÊÉÖ</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâá</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ËØ≠Èü≥</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ËΩ¨Ë¥¶</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.offline)}'>Á∫ø‰∏ã</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.quote)}'>ÂºïÁî®</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.nai)}' style="color: #6a329f; border-color: #6a329f;">NAIÁîüÂõæ</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.narration)}' style="color: #888; border-color: #ccc;">ÊóÅÁôΩ</button>
            
            </div>
    `;


    block.querySelector('.delete-block-btn').addEventListener('click', () => {
      block.remove();
    });


    block.querySelectorAll('.format-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const templateStr = btn.dataset.template;
        const textarea = block.querySelector('textarea');
        if (templateStr && textarea) {
          try {
            const templateObj = JSON.parse(templateStr);

            textarea.value = JSON.stringify(templateObj, null, 2);
            textarea.focus();
          } catch (e) {
            console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e);
          }
        }
      });
    });

    return block;
  }


  async function saveEditedAiResponse() {

    const chatsToUpdate = new Map();
    let oldMessageTimestampProvider = null;

    if (lastPrivateMessagesSent.length > 0) {
      console.log(`ÂØºÊºîÂâ™ËæëÂÆ§ÔºöÊ≠£Âú®Êí§ÈîÄ ${lastPrivateMessagesSent.length} Êù°‰∏ä‰∏ÄËΩÆÂèëÈÄÅÁöÑÁßÅ‰ø°...`);

      const oldPrivateMessages = [...lastPrivateMessagesSent];
      oldMessageTimestampProvider = oldPrivateMessages.values();

      const chatIdsToUndo = [...new Set(oldPrivateMessages.map(ref => ref.chatId))];

      for (const chatId of chatIdsToUndo) {
        const chat = await db.chats.get(chatId);
        if (chat) {
          chatsToUpdate.set(chatId, chat);
        }
      }

      for (const msgRef of oldPrivateMessages) {
        const chat = chatsToUpdate.get(msgRef.chatId);
        if (chat) {
          chat.history = chat.history.filter(msg => msg.timestamp !== msgRef.timestamp);
        }
      }

      if (chatsToUpdate.size > 0) {
        await db.chats.bulkPut(Array.from(chatsToUpdate.values()));
      }

      lastPrivateMessagesSent = [];
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) return;


    const editorContainer = document.getElementById('ai-response-editor-container');
    const editorTextareas = editorContainer.querySelectorAll('textarea');
    const editedRawBlocks = Array.from(editorTextareas).map(ta => ta.value.trim()).filter(Boolean);



    const originalAiMessages = chat.history.filter(msg => lastResponseTimestamps.includes(msg.timestamp));
    chat.history = chat.history.filter(msg => !lastResponseTimestamps.includes(msg.timestamp));


    if (editedRawBlocks.length === 0) {
      await db.chats.put(chat);
      renderChatInterface(state.activeChatId);
      renderChatList();
      document.getElementById('ai-response-editor-modal').classList.remove('visible');
      lastRawAiResponse = '';
      lastResponseTimestamps = [];
      return;
    }


    let newMessagesArray = [];
    for (const rawContent of editedRawBlocks) {
      try {

        const parsedObject = JSON.parse(rawContent);
        newMessagesArray.push(parsedObject);
      } catch (e) {
        console.warn("Ë∑≥Ëøá‰∏Ä‰∏™Êó†Ê≥ïËß£Êûê‰∏∫JSONÁöÑÁºñËæëÂùó:", rawContent);
      }
    }



    const originalNaiMsgs = originalAiMessages.filter(m => m.type === 'naiimag');
    let naiMsgIndex = 0;


    let newTimestamps = [];
    let messageTimestamp = Date.now();
    const privateChatsToSave = new Map();
    const groupChatsToSave = new Map();
    for (const msgData of newMessagesArray) {
      if (!msgData || typeof msgData !== 'object' || !msgData.type) {
        console.warn("Âú®ÂØºÊºîÊ®°Âºè‰øùÂ≠òÊó∂ÔºåÂèëÁé∞Êó†ÊïàÁöÑÊåá‰ª§ÂØπË±°ÔºåÂ∑≤Ë∑≥Ëøá:", msgData);
        continue;
      }

      // Á∫†Ê≠£AIÂèØËÉΩËøîÂõûÁæ§ÊòµÁß∞ËÄåÈùûÊú¨ÂêçÁöÑÈóÆÈ¢ò
      if (chat.isGroup && msgData.name) {
        const exactMember = chat.members.find(m => m.originalName === msgData.name);
        if (!exactMember) {
          const nicknameMember = chat.members.find(m => m.groupNickname === msgData.name);
          if (nicknameMember) {
            msgData.name = nicknameMember.originalName;
          }
        }
      }

      let aiMessage = null;
      const baseMessage = {
        role: 'assistant',
        senderName: msgData.name || chat.originalName,
        timestamp: messageTimestamp++
      };

      switch (msgData.type) {
        case 'narration':
          aiMessage = {
            ...baseMessage,
            type: 'narration',
            content: String(msgData.content),
            role: 'system' // Âº∫Âà∂ËÆæ‰∏∫ system ËßíËâ≤‰ª•Á°Æ‰øùÊ†∑ÂºèÊ≠£Á°Æ
          };
          break;
        case 'buy_item': {
          const itemName = msgData.item_name;
          const price = parseFloat(msgData.price);
          const reason = msgData.reason || 'ÊÉ≥‰π∞';

          if (!itemName || isNaN(price) || price <= 0) continue; // Êï∞ÊçÆÊó†ÊïàË∑≥Ëøá

          // 1. ÈáçÊñ∞Ëé∑ÂèñÈí±ÂåÖÊï∞ÊçÆÔºàÁ°Æ‰øùÂÆûÊó∂ÊÄßÔºâ
          const currentWallet = await db.userWallet.get('main');
          const cardIndex = currentWallet?.kinshipCards?.findIndex(c => c.chatId === chat.id);

          if (cardIndex > -1) {
            const card = currentWallet.kinshipCards[cardIndex];
            const remaining = card.limit - (card.spent || 0);

            if (remaining >= price) {
              // 2. ÊâßË°åÊâ£Ê¨æ
              currentWallet.kinshipCards[cardIndex].spent = (card.spent || 0) + price;
              await db.userWallet.put(currentWallet);

              // 3. ËÆ∞ÂΩïË¥¶Âçï
              await db.userTransactions.add({
                timestamp: Date.now(),
                type: 'expense',
                amount: price,
                description: `‰∫≤Â±ûÂç°Ê∂àË¥π-${chat.name}-${itemName}`
              });

              // 4. ÁîüÊàêÁ≥ªÁªüÈÄöÁü•Ê∂àÊÅØ (AIÂèëÈÄÅÁöÑ)
              const successMsg = {
                role: 'assistant', // ÊàñËÄÖÊòØ 'system'ÔºåÁúã‰Ω†ÂñúÂ•Ω
                senderName: chat.name, // Âä†‰∏äËøô‰∏™Á°Æ‰øùÁæ§ËÅäÊòæÁ§∫Ê≠£Â∏∏
                type: 'text', // ÊàñËÄÖÁî® 'pat_message' Ê†∑Âºè
                content: `[ÊîØ‰ªòÂÆùÈÄöÁü•] Êàë‰ΩøÁî®‰∫≤Â±ûÂç°Ê∂àË¥π‰∫Ü ¬•${price.toFixed(2)} Ë¥≠‰π∞‰∫Ü‚Äú${itemName}‚Äù„ÄÇ\nüí≠ ${reason}`,
                timestamp: messageTimestamp++
              };

              chat.history.push(successMsg);

              // Â¶ÇÊûúÊòØÂΩìÂâçÊü•ÁúãÁöÑËÅäÂ§©ÔºåÁõ¥Êé•‰∏äÂ±è
              if (isViewingThisChat) {
                appendMessage(successMsg, chat);
              } else {
                // Â¶ÇÊûúÂú®ÂêéÂè∞ÔºåÂèëÈÄÅÈÄöÁü•
                showNotification(chat.id, `${chat.name} ‰ΩøÁî®‰∫≤Â±ûÂç°Ê∂àË¥π‰∫Ü ¬•${price}`);
              }

              // 5. (ÂèØÈÄâ) Â∞ÜË¥≠‰π∞ËÆ∞ÂΩïÂÜôÂÖ•ËßíËâ≤ÁöÑÊ®°ÊãüÊ∑òÂÆùÂéÜÂè≤ÔºåÂ¢ûÂä†ÁúüÂÆûÊÑü
              if (!chat.simulatedTaobaoHistory) chat.simulatedTaobaoHistory = { totalBalance: 0, purchases: [] };
              if (!chat.simulatedTaobaoHistory.purchases) chat.simulatedTaobaoHistory.purchases = [];

              chat.simulatedTaobaoHistory.purchases.unshift({
                itemName: itemName,
                price: price,
                status: 'Â∑≤Á≠æÊî∂',
                reason: reason,
                image_prompt: `${itemName}, product photography` // ÁÆÄÂçïÁîüÊàê‰∏™prompt
              });

              hasPerformedMajorAction = true; // Ê†áËÆ∞‰∏∫Â∑≤ÊâßË°åÈáçË¶ÅÊìç‰ΩúÔºàÁî®‰∫éÂêéÂè∞Ê¥ªÂä®Ôºâ
            } else {
              console.log(`AI ÊÉ≥Ë¶ÅË¥≠‰π∞ ${itemName} (¬•${price}) ‰ΩÜ‰∫≤Â±ûÂç°‰ΩôÈ¢ù‰∏çË∂≥ (Ââ© ¬•${remaining})`);
              // ÂèØÈÄâÔºöËÆ© AI Âèë‰∏ÄÊù°Ê∂àÊÅØÊä±ÊÄ®Ê≤°Èí±‰∫Ü
              const failMsg = {
                role: 'assistant',
                senderName: chat.name,
                content: `Êú¨Êù•ÊÉ≥‰π∞‚Äú${itemName}‚ÄùÁöÑÔºå‰ΩÜÊòØ‰∫≤Â±ûÂç°È¢ùÂ∫¶Â•ΩÂÉè‰∏çÂ§ü‰∫Ü... (¬•${price})`,
                timestamp: messageTimestamp++
              };
              chat.history.push(failMsg);
              if (isViewingThisChat) appendMessage(failMsg, chat);
            }
          }
          continue;
        }
        case 'send_private_message': {
          const senderOriginalName = msgData.name;
          const recipientOriginalName = msgData.recipient;
          const userOriginalName = state.qzoneSettings.nickname || '{{user}}';

          if (recipientOriginalName === userOriginalName) {
            const privateChat = Object.values(state.chats).find(c => !c.isGroup && c.originalName === senderOriginalName);

            if (privateChat) {

              if (!privateChatsToSave.has(privateChat.id)) {

                const freshPrivateChat = chatsToUpdate.get(privateChat.id) || await db.chats.get(privateChat.id);

                privateChatsToSave.set(privateChat.id, freshPrivateChat);
              }

              const chatToUpdate = privateChatsToSave.get(privateChat.id);

              const messagesToSend = Array.isArray(msgData.content) ? msgData.content : [msgData.content];
              let newMessagesCount = 0;

              for (const contentString of messagesToSend) {
                if (!contentString || !contentString.trim()) continue;

                const oldMsgRef = (oldMessageTimestampProvider) ? oldMessageTimestampProvider.next().value : null;

                const timestampToUse = (oldMsgRef && oldMsgRef.chatId === privateChat.id) ?
                  oldMsgRef.timestamp :
                  messageTimestamp++;

                const privateMessage = {
                  role: 'assistant',
                  senderName: senderOriginalName,
                  content: contentString,
                  timestamp: timestampToUse
                };


                lastPrivateMessagesSent.push({
                  chatId: privateChat.id,
                  timestamp: privateMessage.timestamp
                });

                chatToUpdate.history.push(privateMessage);
                newMessagesCount++;
              }

              if (newMessagesCount > 0) {
                if (state.activeChatId !== privateChat.id) {
                  chatToUpdate.unreadCount = (chatToUpdate.unreadCount || 0) + newMessagesCount;
                  showNotification(privateChat.id, `${privateChat.name} ÂèëÊù•‰∫Ü ${newMessagesCount} Êù°Êñ∞Ê∂àÊÅØ`);
                }
              }

              aiMessage = null;

            } else {
              console.warn(`AI ${senderOriginalName} Â∞ùËØïÂèëÈÄÅÁßÅ‰ø°Ôºå‰ΩÜÊú™ÊâæÂà∞ÂÖ∂ÂØπÂ∫îÁöÑÁßÅËÅä‰ºöËØù„ÄÇ`);
              aiMessage = null;
            }
          } else {
            console.warn(`AI Â∞ùËØïÂèëÈÄÅÁßÅ‰ø°ÁªôÈùûÁî®Êà∑ËßíËâ≤ (${recipientOriginalName})ÔºåÊ≠§ÂäüËÉΩÊöÇ‰∏çÊîØÊåÅ„ÄÇ`);
            aiMessage = null;
          }

          continue;
        }
        case 'send_group_message': {
          const senderOriginalName = msgData.name || chat.originalName;
          const targetGroupName = msgData.targetGroupName;
          const messagesToSend = Array.isArray(msgData.content) ? msgData.content : [String(msgData.content)];

          if (!targetGroupName) {
            console.warn(`ÂØºÊºîÊ®°Âºè‰øùÂ≠ò(send_group_message): Êú™ÊåáÂÆö targetGroupNameÔºåÂ∑≤Ë∑≥Ëøá„ÄÇ`);
            continue;
          }

          // Êü•ÊâæÁõÆÊ†áÁæ§ËÅäÔºåÂπ∂Á°Æ‰øùAIÊòØËØ•Áæ§ÁöÑÊàêÂëò
          const targetGroupChat = Object.values(state.chats).find(c =>
            c.isGroup &&
            c.name === targetGroupName &&
            c.members.some(m => m.originalName === senderOriginalName)
          );

          if (targetGroupChat) {
            // Â¶ÇÊûúÁæ§ËÅäÂ∞öÊú™Ë¢´ÊöÇÂ≠òÔºåÂàô‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÊúÄÊñ∞Êï∞ÊçÆÂπ∂Â≠òÂÖ• Map
            if (!groupChatsToSave.has(targetGroupChat.id)) {
              const freshGroupChat = await db.chats.get(targetGroupChat.id);
              groupChatsToSave.set(targetGroupChat.id, freshGroupChat);
            }

            const chatToUpdate = groupChatsToSave.get(targetGroupChat.id);
            let newMessagesCount = 0;

            for (const contentString of messagesToSend) {
              if (!contentString || !contentString.trim()) continue;

              const groupMessage = {
                role: 'assistant',
                senderName: senderOriginalName,
                content: contentString,
                timestamp: messageTimestamp++ // ‰ΩøÁî®Áªü‰∏ÄÁöÑÊó∂Èó¥Êà≥ÈÄíÂ¢û
              };
              chatToUpdate.history.push(groupMessage);
              newMessagesCount++;
            }

            if (newMessagesCount > 0) {
              if (state.activeChatId !== targetGroupChat.id) {
                chatToUpdate.unreadCount = (chatToUpdate.unreadCount || 0) + newMessagesCount;
              }
            }
            aiMessage = null;
          } else {
            console.warn(`ÂØºÊºîÊ®°Âºè‰øùÂ≠ò(send_group_message): Êú™ÊâæÂà∞Áæ§ËÅä "${targetGroupName}" ÊàñËßíËâ≤ "${senderOriginalName}" ‰∏çÂú®ËØ•Áæ§‰∏≠„ÄÇ`);
            aiMessage = null;
          }
          continue;
        }
        case 'thought_chain': {
          continue;
        }
        case 'text':
          aiMessage = {
            ...baseMessage,
            content: String(msgData.content || msgData.message)
          };
          break;
        case 'sticker': {
          let found = false;
          if (msgData.url && msgData.meaning) {
            aiMessage = {
              ...baseMessage,
              type: 'sticker',
              content: msgData.url,
              meaning: msgData.meaning
            };
            found = true;
          } else if (msgData.meaning) {
            const sticker = findBestStickerMatch(msgData.meaning, state.userStickers);
            if (sticker) {
              aiMessage = {
                ...baseMessage,
                type: 'sticker',
                content: sticker.url,
                meaning: sticker.name
              };
              found = true;
            } else {
              aiMessage = {
                ...baseMessage,
                type: 'text',
                content: `[Ë°®ÊÉÖ: ${msgData.meaning}]`
              };
              found = true;
            }
          } else if (msgData.url) {
            aiMessage = {
              ...baseMessage,
              type: 'sticker',
              content: msgData.url
            };
            const stickerByURL = state.userStickers.find(s => s.url === msgData.url);
            aiMessage.meaning = stickerByURL ? stickerByURL.name : 'Êú™Áü•Ë°®ÊÉÖ';
            found = true;
          } else if (msgData.content && typeof msgData.content === 'string' && STICKER_REGEX.test(msgData.content)) {
            aiMessage = {
              ...baseMessage,
              type: 'sticker',
              content: msgData.content
            };
            const stickerByContentUrl = state.userStickers.find(s => s.url === msgData.content);
            aiMessage.meaning = stickerByContentUrl ? stickerByContentUrl.name : 'Êú™Áü•Ë°®ÊÉÖ';
            found = true;
          }
          if (!found) {
            console.error("ÂØºÊºîÊ®°Âºè‰øùÂ≠ò(Sticker): Êåá‰ª§Êó†ÊïàÊàñÁº∫Â∞ëÂøÖË¶ÅÂ≠óÊÆµ (meaning/url/content):", msgData);
            continue;
          }
          break;
        }
        case 'ai_image':
          aiMessage = {
            ...baseMessage,
            type: 'ai_image',
            content: msgData.description,
            image_prompt: msgData.image_prompt
          };
          break;

        case 'naiimag': {
          const newPrompt = msgData.prompt;
          let newImageUrl = null;
          let newFullPrompt = null;


          const originalMsg = originalNaiMsgs[naiMsgIndex];
          naiMsgIndex++; // Increment cursor for the next NAI block

          let promptChanged = false;

          if (originalMsg) {

            const originalPrompt = originalMsg.prompt;


            if (newPrompt && newPrompt !== originalPrompt) {
              console.log("NAI Prompt Â∑≤ÊîπÂèòÔºåÂ∞ÜËß¶ÂèëÈáçÊñ∞ÁîüÊàê„ÄÇ");
              promptChanged = true;
            } else {

              console.log("NAI Prompt Êú™ÊîπÂèòÔºåÂ∞Ü‰øùÁïôÂéüÂßãÂõæÁâá„ÄÇ");
              newImageUrl = originalMsg.imageUrl;
              newFullPrompt = originalMsg.fullPrompt;
            }
          } else {

            console.log("Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂéüÂßãNAIÂõæÁâá(ËøôÊòØÊñ∞Ê∑ªÂä†ÁöÑÂùó)ÔºåÂ∞ÜËß¶ÂèëÈáçÊñ∞ÁîüÊàê„ÄÇ");
            promptChanged = true;
          }

          if (promptChanged) {

            const alertMessage = originalMsg ? "Ê£ÄÊµãÂà∞NAIÊèêÁ§∫ËØçÂ∑≤‰øÆÊîπÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàê..." : "Ê£ÄÊµãÂà∞Êñ∞ÁöÑNAIÁîüÂõæÊåá‰ª§ÔºåÊ≠£Âú®ÁîüÊàê...";
            await showCustomAlert("ËØ∑Á®çÂÄô...", alertMessage);

            try {
              const generatedData = await generateNaiImageFromPrompt(newPrompt, chat.id);
              newImageUrl = generatedData.imageUrl;
              newFullPrompt = generatedData.fullPrompt;
              await showCustomAlert("ÊàêÂäü", "ÂõæÁâáÂ∑≤ÁîüÊàêÔºÅ");
            } catch (error) {
              console.error("ÂØºÊºîÊ®°Âºè‰∏ãÈáçÊñ∞ÁîüÊàêNAIÂõæÁâáÂ§±Ë¥•:", error);
              await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÂõæÁâá: ${error.message}. \n\nÂ∞Ü‰øùÁïôÊóßÂõæÁâáÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ„ÄÇ`);

              if (originalMsg) {
                newImageUrl = originalMsg.imageUrl; // Fallback to old image
                newFullPrompt = originalMsg.fullPrompt;
              } else {
                console.error("Êñ∞NAIÂõæÁâáÁîüÊàêÂ§±Ë¥•ÔºåÊ≠§Êù°Ê∂àÊÅØÂ∑≤Ë¢´Ë∑≥Ëøá„ÄÇ");
                continue; // Skip this message
              }
            }
          }


          aiMessage = {
            ...baseMessage,
            type: 'naiimag',
            imageUrl: newImageUrl,
            prompt: newPrompt,
            fullPrompt: newFullPrompt
          };
          break;
        }

        case 'googleimag': {
          const googlePrompt = msgData.prompt || 'a beautiful scene';
          let googleImageUrl = null;
          let googleFullPrompt = null;

          try {
            const googleResult = await generateGoogleImagenFromPrompt(googlePrompt);
            googleImageUrl = googleResult.imageUrl;
            googleFullPrompt = googleResult.fullPrompt;
          } catch (error) {
            console.error('‚ùå ÂêéÂè∞Google ImagenÂõæÁâáÁîüÊàêÂ§±Ë¥•:', error);
            aiMessage = {
              ...baseMessage,
              content: `[Google ImagenÂõæÁâáÁîüÊàêÂ§±Ë¥•: ${error.message}]`
            };
            break;
          }

          aiMessage = {
            ...baseMessage,
            type: 'googleimag',
            imageUrl: googleImageUrl,
            prompt: googlePrompt,
            fullPrompt: googleFullPrompt
          };
          break;
        }


        case 'voice_message':
          aiMessage = {
            ...baseMessage,
            type: 'voice_message',
            content: msgData.content
          };
          break;
        case 'transfer':
          aiMessage = {
            ...baseMessage,
            type: 'transfer',
            amount: msgData.amount,
            note: msgData.note,
            receiverName: msgData.receiver || 'Êàë'
          };
          break;
        case 'waimai_request':
          aiMessage = {
            ...baseMessage,
            type: 'waimai_request',
            productInfo: msgData.productInfo,
            amount: msgData.amount,
            status: 'pending',
            countdownEndTime: Date.now() + 15 * 60 * 1000,
          };
          break;
        case 'offline_text':
          aiMessage = {
            ...baseMessage,
            ...msgData
          };
          break;
        case 'gomoku_move': {
          const gameState = gomokuState[chat.id];
          if (gameState) {
            const lastAiMoveIndex = gameState.history.findLastIndex(move => move.player === 2);
            if (lastAiMoveIndex > -1) {
              const move_to_undo = gameState.history[lastAiMoveIndex];
              gameState.board[move_to_undo.y][move_to_undo.x] = 0;
              gameState.history.splice(lastAiMoveIndex, 1);
              console.log(`ÂØºÊºîÊ®°ÂºèÊÇîÊ£ãÔºöÂ∑≤Êí§ÈîÄAIÂú® (${move_to_undo.x}, ${move_to_undo.y}) ÁöÑÊ£ãÊ≠•„ÄÇ`);
            }
          }
          const x = parseInt(msgData.x);
          const y = parseInt(msgData.y);
          if (!isNaN(x) && !isNaN(y)) {
            handleAiGomokuMove({
              x: x,
              y: y
            }, true);
          } else {
            console.warn("ÂØºÊºîÊ®°Âºè‰øùÂ≠ò‰∫Ü‰∏Ä‰∏™Êó†ÊïàÁöÑ‰∫îÂ≠êÊ£ãÁßªÂä®Êåá‰ª§:", msgData);
          }
          continue;
        }
        case 'update_thoughts': {
          if (!chat.isGroup) {
            if (msgData.heartfelt_voice) chat.heartfeltVoice = String(msgData.heartfelt_voice);
            if (msgData.random_jottings) chat.randomJottings = String(msgData.random_jottings);
            if (!Array.isArray(chat.thoughtsHistory)) chat.thoughtsHistory = [];
            chat.thoughtsHistory.push({
              heartfeltVoice: chat.heartfeltVoice,
              randomJottings: chat.randomJottings,
              timestamp: Date.now()
            });
            if (chat.thoughtsHistory.length > 50) chat.thoughtsHistory.shift();
          }
          continue;
        }
        case 'quote_reply': { // ËøôÊòØÂú® saveEditedAiResponse() ÂáΩÊï∞‰∏≠ÁöÑ
          let originalMessage = null;
          let quoteContext = null;


          if (msgData.target_content) {
            originalMessage = [...chat.history].reverse().find(m =>
              !m.isHidden &&
              (
                m.content === msgData.target_content ||
                (typeof m.content === 'string' && m.content.trim() === msgData.target_content.trim())
              )
            );
            if (!originalMessage) {
              console.warn(`[ÂØºÊºîÊ®°Âºè‰øùÂ≠òÂ§±Ë¥•] Â∞ùËØïÂºïÁî®ÂÜÖÂÆπ "${(msgData.target_content || '').substring(0, 20)}..."Ôºå‰ΩÜÂú®ÂéÜÂè≤‰∏≠Êú™ÊâæÂà∞„ÄÇ`);
            }
          }


          else if (msgData.target_timestamp) {
            originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
          }


          if (originalMessage) {


            let quotedSenderDisplayName;

            if (originalMessage.role === 'user') {

              quotedSenderDisplayName = chat.settings.myNickname || 'Êàë';
            } else {

              if (chat.isGroup) {

                quotedSenderDisplayName = getDisplayNameInGroup(chat, originalMessage.senderName);
              } else {

                quotedSenderDisplayName = chat.name;
              }
            }

            quoteContext = {
              timestamp: originalMessage.timestamp,
              senderName: quotedSenderDisplayName, // ‰ΩøÁî®‰øÆÂ§çÂêéÁöÑÊòµÁß∞
              content: String(originalMessage.content || '') // Á°Æ‰øùÂÜÖÂÆπÊòØÂ≠óÁ¨¶‰∏≤
            };
          } else {

            console.warn(`ÂØºÊºîÊ®°Âºè‰øùÂ≠òÂºïÁî®Â§±Ë¥•: Êâæ‰∏çÂà∞ÁõÆÊ†áÊ∂àÊÅØ (Content: ${msgData.target_content}, TS: ${msgData.target_timestamp})`);
          }


          aiMessage = {
            ...baseMessage,
            content: msgData.reply_content
          };

          if (quoteContext) {
            aiMessage.quote = quoteContext;
          }


          break;
        }
        default:
          console.warn("Âú®ÂØºÊºîÊ®°Âºè‰øùÂ≠òÊó∂ÔºåÈÅáÂà∞‰∫ÜÊú™Áü•ÁöÑAIÊåá‰ª§Á±ªÂûã:", msgData.type, msgData);
          if (msgData.content) {
            aiMessage = {
              ...baseMessage,
              content: String(msgData.content)
            };
          } else {
            continue;
          }
          break;
      }

      if (aiMessage) {
        chat.history.push(aiMessage);
        newTimestamps.push(aiMessage.timestamp);
      }
    }

    if (groupChatsToSave.size > 0) {
      await db.chats.bulkPut(Array.from(groupChatsToSave.values()));
    }
    await db.chats.put(chat);

    if (privateChatsToSave.size > 0) {
      await db.chats.bulkPut(Array.from(privateChatsToSave.values()));
    }

    renderChatInterface(state.activeChatId);
    renderChatList();
    document.getElementById('ai-response-editor-modal').classList.remove('visible');


    lastRawAiResponse = editedRawBlocks.join('\n\n');
    lastResponseTimestamps = newTimestamps;


    await showCustomAlert("ÂØºÊºîÊ®°Âºè", "ÊÇ®ÁöÑ‰øÆÊîπÂ∑≤‰øùÂ≠òÔºÅ");
  }

  async function handleRecallClick() {
    if (!activeMessageTimestamp) return;

    const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000;
    const messageTime = activeMessageTimestamp;
    const now = Date.now();


    if (now - messageTime > RECALL_TIME_LIMIT_MS) {
      hideMessageActions();
      await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', 'ËØ•Ê∂àÊÅØÂèëÈÄÅÂ∑≤Ë∂ÖËøá2ÂàÜÈíüÔºåÊó†Ê≥ïÊí§Âõû„ÄÇ');
      return;
    }


    await recallMessage(messageTime, true);
    hideMessageActions();
  }


  async function recallMessage(timestamp, isUserRecall) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const messageToRecall = chat.history[messageIndex];

    const recalledData = {
      originalType: messageToRecall.type || 'text',
      originalContent: messageToRecall.content,
      originalMeaning: messageToRecall.meaning,
      originalQuote: messageToRecall.quote
    };

    messageToRecall.type = 'recalled_message';
    messageToRecall.content = isUserRecall ? '‰Ω†Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ' : 'ÂØπÊñπÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ';
    messageToRecall.recalledData = recalledData;
    delete messageToRecall.meaning;
    delete messageToRecall.quote;


    if (isUserRecall) {

      const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';


      let recalledContentText = '';
      if (recalledData.originalType === 'sticker') {
        recalledContentText = `[Ë°®ÊÉÖÔºåÂê´‰πâ: ${recalledData.originalMeaning || 'Êú™Áü•'}]`;
      } else if (recalledData.originalType === 'ai_image' || recalledData.originalType === 'user_photo') {
        recalledContentText = `[ÂõæÁâáÔºåÊèèËø∞: ${recalledData.originalContent}]`;
      } else {
        recalledContentText = `‚Äú${String(recalledData.originalContent)}‚Äù`;
      }


      const hiddenMessageForAI = {
        role: 'system',
        content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Ôºà${myNickname}ÔºâÂàöÂàöÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ„ÄÇÊí§ÂõûÂâçÁöÑÂÜÖÂÆπÊòØÔºö${recalledContentText}„ÄÇËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫îÔºåÂèØ‰ª•Ë°®Áé∞Âá∫Â•ΩÂ•á„ÄÅÂºÄÁé©Á¨ëÔºàÊØîÂ¶Ç'ÊàëÊà™Âõæ‰∫ÜÔºÅ'Ôºâ„ÄÅÊàñËÄÖÊ†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæË°®Á§∫ÁêÜËß£ÊàñÁñëÊÉë„ÄÇ]`,
        timestamp: Date.now(),
        isHidden: true
      };
      chat.history.push(hiddenMessageForAI);
    }


    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);

    if (isUserRecall) {
      renderChatList();

      //triggerAiResponse();
    }
  }




  async function openCategoryManager() {
    await renderCategoryListInManager();
    document.getElementById('world-book-category-manager-modal').classList.add('visible');
  }


  async function renderCategoryListInManager() {
    const listEl = document.getElementById('existing-categories-list');
    const categories = await db.worldBookCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ª</p>';
    }
    categories.forEach(cat => {

      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `
                    <span class="group-name">${cat.name}</span>
                    <span class="delete-group-btn" data-id="${cat.id}">√ó</span>
                `;
      listEl.appendChild(item);
    });
  }


  async function addNewCategory() {
    const input = document.getElementById('new-category-name-input');
    const name = input.value.trim();
    if (!name) {
      alert('ÂàÜÁ±ªÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      return;
    }
    const existing = await db.worldBookCategories.where('name').equals(name).first();
    if (existing) {
      alert(`ÂàÜÁ±ª "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);
      return;
    }
    await db.worldBookCategories.add({
      name
    });
    input.value = '';
    await renderCategoryListInManager();
  }


  async function deleteCategory(categoryId) {
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      'Âà†Èô§ÂàÜÁ±ªÂêéÔºåËØ•ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâ‰∏ñÁïå‰π¶Â∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁ±ª‚Äù„ÄÇÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    }
    );
    if (confirmed) {
      await db.worldBookCategories.delete(categoryId);

      const booksToUpdate = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
      for (const book of booksToUpdate) {
        book.categoryId = null;
        await db.worldBooks.put(book);
        const bookInState = state.worldBooks.find(wb => wb.id === book.id);
        if (bookInState) bookInState.categoryId = null;
      }
      await renderCategoryListInManager();
    }
  }


  async function publishToAnnouncementBoard() {
    if (!activeMessageTimestamp) return;

    const timestampToPublish = activeMessageTimestamp;
    hideMessageActions();

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToPublish);
    if (!message) return;


    let contentPreview = String(message.content || '').substring(0, 50) + '...';
    if (message.type === 'ai_image') contentPreview = '[ÂõæÁâá] ' + contentPreview;

    const confirmed = await showCustomConfirm(
      "ÂèëÂ∏ÉÂÖ¨Âëä",
      `Á°ÆÂÆöË¶ÅÂ∞Ü‰ª•‰∏ãÊ∂àÊÅØÂèëÂ∏ÉÂà∞ÂÖ¨ÂëäÊùøÂêóÔºü\n\n‚Äú${contentPreview}‚Äù`, {
      confirmText: "Á°ÆÂÆöÂèëÂ∏É"
    }
    );

    if (confirmed) {
      const myNickname = chat.settings.myNickname || 'Êàë';

      if (!Array.isArray(chat.announcements)) {
        chat.announcements = [];
      }


      const newAnnouncement = {
        id: 'anno_' + Date.now(),
        messageTimestamp: timestampToPublish,
        publisher: myNickname,
        publishedAt: Date.now(),
        isPinned: false
      };

      chat.announcements.push(newAnnouncement);

      const systemMessage = {
        role: 'system',
        type: 'pat_message',
        content: `${myNickname} ÂèëÂ∏É‰∫Ü‰∏ÄÊù°Êñ∞ÂÖ¨Âëä`,
        timestamp: Date.now()
      };
      chat.history.push(systemMessage);

      await db.chats.put(chat);
      appendMessage(systemMessage, chat);
      renderChatList();

      await showCustomAlert("ÊàêÂäü", "ÂÖ¨ÂëäÂ∑≤ÂèëÂ∏ÉÔºÅ");
    }
  }


  async function showAnnouncementBoard() {
    const chat = state.chats[state.activeChatId];
    const announcements = chat.announcements || [];

    if (!chat || announcements.length === 0) {
      showCustomAlert("ÊèêÁ§∫", "ÂΩìÂâçÁæ§ËÅäËøòÊ≤°ÊúâÂÖ¨ÂëäÂì¶„ÄÇ");
      return;
    }

    const contentEl = document.getElementById('announcement-board-content');
    contentEl.innerHTML = '';


    announcements.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0));


    for (const anno of announcements) {
      const originalMessage = chat.history.find(m => m.timestamp === anno.messageTimestamp);

      const wrapper = document.createElement('div');
      wrapper.className = 'announcement-item-wrapper';

      if (originalMessage) {

        const messageBubbleEl = await createMessageElement(originalMessage, chat);
        if (messageBubbleEl) {
          wrapper.appendChild(messageBubbleEl);
        }
      } else {
        wrapper.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">ÂÖ¨ÂëäÁöÑÂéüÊ∂àÊÅØÂ∑≤Ë¢´Âà†Èô§„ÄÇ</p>';
      }

      if (anno.isPinned) {
        wrapper.innerHTML += `<div class="pinned-indicator">üìå</div>`;
      }
      wrapper.innerHTML += `<div class="announcement-item-actions" data-anno-id="${anno.id}">...</div>`;

      contentEl.appendChild(wrapper);
    }

    document.getElementById('announcement-board-modal').classList.add('visible');
  }


  let activeAnnouncementId = null;


  function showAnnouncementActions(annoId) {
    activeAnnouncementId = annoId;
    const chat = state.chats[state.activeChatId];
    const announcement = chat.announcements.find(a => a.id === annoId);
    if (!announcement) return;

    const pinButton = document.getElementById('announcement-action-pin');

    pinButton.textContent = announcement.isPinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂ÂÖ¨Âëä';

    document.getElementById('announcement-actions-modal').classList.add('visible');
  }


  async function handlePinAnnouncement() {
    if (!activeAnnouncementId) return;
    const chat = state.chats[state.activeChatId];
    const announcement = chat.announcements.find(a => a.id === activeAnnouncementId);
    if (announcement) {
      announcement.isPinned = !announcement.isPinned;
      await db.chats.put(chat);
      showAnnouncementBoard();
    }
    document.getElementById('announcement-actions-modal').classList.remove('visible');
  }


  async function handleDeleteAnnouncement() {
    if (!activeAnnouncementId) return;

    const confirmed = await showCustomConfirm("Á°ÆËÆ§Âà†Èô§", "Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂÖ¨ÂëäÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ", {
      confirmButtonClass: 'btn-danger'
    });

    if (confirmed) {
      const chat = state.chats[state.activeChatId];

      chat.announcements = chat.announcements.filter(a => a.id !== activeAnnouncementId);
      await db.chats.put(chat);
      showAnnouncementBoard();
    }
    document.getElementById('announcement-actions-modal').classList.remove('visible');
  }




  let editingFrameForMember = false;
  let currentFrameSelection = {
    ai: null,
    my: null
  };

  function openFrameSelectorModal(type = 'chat') {
    const frameModal = document.getElementById('avatar-frame-modal');
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    editingFrameForMember = (type === 'member');

    if (editingFrameForMember) {
      const member = chat.members.find(m => m.id === editingMemberId);
      if (!member) return;
      currentFrameSelection.my = member.avatarFrame || '';
      populateFrameGrids(true, member.avatar, member.avatarFrame);
    } else {
      currentFrameSelection.ai = chat.settings.aiAvatarFrame || '';
      currentFrameSelection.my = chat.settings.myAvatarFrame || '';
      populateFrameGrids(false);
    }
    frameModal.classList.add('visible');
  }

  function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
    const aiFrameGrid = document.getElementById('ai-frame-grid');
    const myFrameGrid = document.getElementById('my-frame-grid');
    const chat = state.chats[state.activeChatId];
    aiFrameGrid.innerHTML = '';
    myFrameGrid.innerHTML = '';

    document.querySelector('#avatar-frame-modal .frame-tabs').style.display = isForMember ? 'none' : 'flex';
    document.getElementById('ai-frame-content').style.display = 'block';
    document.getElementById('my-frame-content').style.display = 'none';
    document.getElementById('ai-frame-tab').classList.add('active');
    document.getElementById('my-frame-tab').classList.remove('active');

    if (isForMember) {
      avatarFrames.forEach(frame => {
        const item = createFrameItem(frame, 'my', memberAvatar);
        if (frame.url === memberFrame) {
          item.classList.add('selected');
        }
        aiFrameGrid.appendChild(item);
      });
    } else {
      const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
      const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
      avatarFrames.forEach(frame => {
        const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
        if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
        aiFrameGrid.appendChild(aiItem);
        const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
        if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
        myFrameGrid.appendChild(myItem);
      });
    }
  }

  function createFrameItem(frame, type, previewAvatarSrc) {
    const item = document.createElement('div');
    item.className = 'frame-item';
    item.dataset.frameUrl = frame.url;
    item.title = frame.name;
    item.innerHTML = `
                <img src="${previewAvatarSrc}" class="preview-avatar">
                ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
            `;
    item.addEventListener('click', () => {
      currentFrameSelection[type] = frame.url;
      const grid = type === 'ai' ? document.getElementById('ai-frame-grid') : document.getElementById('my-frame-grid');
      grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
      item.classList.add('selected');
    });
    return item;
  }

  async function saveSelectedFrames() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (editingFrameForMember) {
      const member = chat.members.find(m => m.id === editingMemberId);
      if (member) {
        member.avatarFrame = currentFrameSelection.my;
      }
    } else {
      chat.settings.aiAvatarFrame = currentFrameSelection.ai;
      chat.settings.myAvatarFrame = currentFrameSelection.my;
    }

    await db.chats.put(chat);



    if (!editingFrameForMember && !chat.isGroup) {
      const characterId = chat.id;


      for (const groupChat of Object.values(state.chats)) {
        if (groupChat.isGroup && groupChat.members) {

          const memberToUpdate = groupChat.members.find(m => m.id === characterId);


          if (memberToUpdate) {
            memberToUpdate.avatarFrame = chat.settings.aiAvatarFrame;

            await db.chats.put(groupChat);
            console.log(`Â∑≤ÂêåÊ≠•ËßíËâ≤ ${characterId} ÁöÑÂ§¥ÂÉèÊ°ÜÂà∞Áæ§ËÅä "${groupChat.name}"`);
          }
        }
      }
    }


    document.getElementById('avatar-frame-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    alert('Â§¥ÂÉèÊ°ÜÂ∑≤‰øùÂ≠òÂπ∂ÂêåÊ≠•ÔºÅ');
    editingFrameForMember = false;
  }





  function toggleFrameManagementMode() {
    isFrameManagementMode = !isFrameManagementMode;
    const manageBtn = document.getElementById('manage-frames-btn');
    const actionBar = document.getElementById('frame-action-bar');
    const selectAllCheckbox = document.getElementById('select-all-frames-checkbox');


    document.querySelectorAll('.frame-grid').forEach(grid => {
      grid.classList.toggle('management-mode', isFrameManagementMode);
    });

    if (isFrameManagementMode) {
      manageBtn.textContent = 'ÂÆåÊàê';
      actionBar.style.display = 'flex';
      selectedFrames.clear();
      selectAllCheckbox.checked = false;
      updateDeleteFrameButton();
    } else {
      manageBtn.textContent = 'ÁÆ°ÁêÜ';
      actionBar.style.display = 'none';

      document.querySelectorAll('.frame-item.selected').forEach(item => {
        item.classList.remove('selected');
      });
    }
  }


  function updateDeleteFrameButton() {
    const btn = document.getElementById('delete-selected-frames-btn');
    btn.textContent = `Âà†Èô§ (${selectedFrames.size})`;
  }


  function handleSelectAllFrames() {
    const isChecked = document.getElementById('select-all-frames-checkbox').checked;
    const visibleGrid = document.querySelector('.frame-content[style*="display: block"] .frame-grid');
    if (!visibleGrid) return;


    visibleGrid.querySelectorAll('.frame-item:has(.delete-btn)').forEach(item => {
      const frameId = parseInt(item.querySelector('.delete-btn').dataset.id);
      if (isNaN(frameId)) return;

      item.classList.toggle('selected', isChecked);
      if (isChecked) {
        selectedFrames.add(frameId);
      } else {
        selectedFrames.delete(frameId);
      }
    });
    updateDeleteFrameButton();
  }


  async function executeBatchDeleteFrames() {
    if (selectedFrames.size === 0) return;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      `Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedFrames.size} ‰∏™Ëá™ÂÆö‰πâÂ§¥ÂÉèÊ°ÜÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    }
    );

    if (confirmed) {
      const idsToDelete = [...selectedFrames];
      await db.customAvatarFrames.bulkDelete(idsToDelete);


      toggleFrameManagementMode();
      populateFrameGrids(editingFrameForMember);

      await showCustomAlert('Âà†Èô§ÊàêÂäü', 'ÈÄâ‰∏≠ÁöÑÂ§¥ÂÉèÊ°ÜÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ');
    }
  }




  function applyGlobalCss(cssString) {
    const styleTag = document.getElementById('global-custom-style');
    if (styleTag) {

      styleTag.innerHTML = cssString || '';
    }
  }



  async function addMusicActionSystemMessage(actionText) {

    if (!musicState.isActive || !musicState.activeChatId) return;
    const chat = state.chats[musicState.activeChatId];
    if (!chat) return;


    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
    const fullMessage = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) ${actionText}]`;


    const systemMessage = {
      role: 'system',
      content: fullMessage,
      timestamp: Date.now(),
      isHidden: true
    };


    chat.history.push(systemMessage);
    await db.chats.put(chat);
  }




  async function handleLongScreenshot() {
    if (selectedMessages.size === 0) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;


    const screenshotBtn = document.getElementById('selection-screenshot-btn');
    const originalBtnText = screenshotBtn.textContent;
    screenshotBtn.textContent = 'ÁîüÊàê‰∏≠...';
    screenshotBtn.disabled = true;


    const screenshotContainer = document.createElement('div');
    const phoneScreen = document.getElementById('phone-screen');
    screenshotContainer.style.width = phoneScreen.offsetWidth + 'px';
    screenshotContainer.style.position = 'absolute';
    screenshotContainer.style.top = '-9999px';
    screenshotContainer.style.left = '-9999px';
    screenshotContainer.style.display = 'flex';
    screenshotContainer.style.flexDirection = 'column';
    screenshotContainer.style.height = 'auto';

    const chatScreen = document.getElementById('chat-interface-screen');
    screenshotContainer.style.backgroundImage = chatScreen.style.backgroundImage;
    screenshotContainer.style.backgroundColor = chatScreen.style.backgroundColor || (document.getElementById('phone-screen').classList.contains('dark-mode') ? '#000000' : '#f0f2f5');

    const tempStyle = document.createElement('style');
    tempStyle.innerHTML = `
                .message-bubble.selected::after { display: none !important; }
                .cloned-header .default-controls { display: flex !important; justify-content: space-between; align-items: center; width: 100%; }
                .cloned-header .selection-controls { display: none !important; }
            `;
    document.head.appendChild(tempStyle);

    try {

      const header = chatScreen.querySelector('.header').cloneNode(true);
      header.classList.add('cloned-header');



      const messagesContainer = document.createElement('div');
      const originalMessagesContainer = document.getElementById('chat-messages');


      messagesContainer.style.display = 'flex';
      messagesContainer.style.flexDirection = 'column';
      messagesContainer.style.gap = '20px';
      messagesContainer.style.padding = '10px 15px 20px 15px';
      messagesContainer.style.width = '100%';
      messagesContainer.style.boxSizing = 'border-box';


      messagesContainer.dataset.theme = originalMessagesContainer.dataset.theme;
      messagesContainer.style.setProperty('--chat-font-size', originalMessagesContainer.style.getPropertyValue('--chat-font-size'));


      const inputArea = chatScreen.querySelector('#chat-input-area').cloneNode(true);

      const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
      sortedTimestamps.forEach(timestamp => {

        const originalBubble = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`);
        if (originalBubble) {
          const originalWrapper = originalBubble.closest('.message-wrapper');
          if (originalWrapper) {
            messagesContainer.appendChild(originalWrapper.cloneNode(true));
          }
        }
      });

      screenshotContainer.appendChild(header);
      screenshotContainer.appendChild(messagesContainer);
      screenshotContainer.appendChild(inputArea);
      document.body.appendChild(screenshotContainer);


      const images = Array.from(screenshotContainer.getElementsByTagName('img'));
      const imageLoadPromises = images.map(img => new Promise((resolve, reject) => {
        if (img.src.startsWith('data:')) {
          resolve();
          return;
        }
        const newImg = new Image();
        newImg.crossOrigin = 'anonymous';
        newImg.onload = resolve;
        newImg.onerror = resolve;
        newImg.src = img.src;
      }));

      await Promise.all(imageLoadPromises);


      const canvas = await html2canvas(screenshotContainer, {
        allowTaint: true,
        useCORS: true,
        backgroundColor: null,
        scale: window.devicePixelRatio || 2,
      });


      canvas.toBlob(function (blob) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.download = `EPhone-ÈïøÊà™Âõæ-${chat.name}-${Date.now()}.png`;
        link.href = url;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 'image/png');

    } catch (error) {
      console.error('ÈïøÊà™ÂõæÁîüÊàêÂ§±Ë¥•:', error);
      await showCustomAlert('ÁîüÊàêÂ§±Ë¥•', 'ÁîüÊàêÊà™ÂõæÊó∂ÂèëÁîüÈîôËØØÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞Ëé∑ÂèñËØ¶ÊÉÖ„ÄÇ');
    } finally {

      document.body.removeChild(screenshotContainer);
      document.head.removeChild(tempStyle);
      screenshotBtn.textContent = originalBtnText;
      screenshotBtn.disabled = false;
      exitSelectionMode();
    }
  }

  function parseMarkdown(text) {
    if (!text || typeof text !== 'string') return '';


    text = text.replace(/!h\{(.*?)\}/g, '<span class="diary-highlight">$1</span>');
    text = text.replace(/!u\{(.*?)\}/g, '<span class="diary-underline">$1</span>');
    text = text.replace(/!e\{(.*?)\}/g, '<span class="diary-emphasis">$1</span>');
    text = text.replace(/!w\{(.*?)\}/g, '<span class="diary-handwritten">$1</span>');
    text = text.replace(/!m\{(.*?)\}/g, '<span class="diary-messy">$1</span>');



    text = text.replace(/\|\|(.*?)\|\|/g, '<span class="spoiler">$1</span>');



    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\~\~(.*?)\~\~/g, '<s>$1</s>');
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

    return text;
  }



  async function migrateOldRedPacketData() {
    console.log("ÂºÄÂßãÊ£ÄÊü•Âπ∂ËøÅÁßªÊóßÁöÑÁ∫¢ÂåÖÊï∞ÊçÆ...");
    let migrationCount = 0;

    const allChats = Object.values(state.chats);

    for (const chat of allChats) {
      let needsDbUpdate = false;
      for (const msg of chat.history) {

        if (msg.type === 'red_packet' && msg.packetType === 'direct' && msg.role === 'assistant' && msg.hasOwnProperty('receiver') && !msg.hasOwnProperty('receiverName')) {

          msg.receiverName = msg.receiver;
          delete msg.receiver;

          needsDbUpdate = true;
          migrationCount++;
        }
      }

      if (needsDbUpdate) {
        console.log(`Âú®ËÅäÂ§© "${chat.name}" ‰∏≠ÂèëÁé∞Âπ∂‰øÆÂ§ç‰∫ÜÊóßÁ∫¢ÂåÖÊï∞ÊçÆ„ÄÇ`);
        await db.chats.put(chat);
      }
    }

    if (migrationCount > 0) {
      console.log(`Êï∞ÊçÆËøÅÁßªÂÆåÊàêÔºÅÊÄªÂÖ±‰øÆÂ§ç‰∫Ü ${migrationCount} Êù°Á∫¢ÂåÖËÆ∞ÂΩï„ÄÇ`);
      alert(`Ê£ÄÊµãÂà∞Âπ∂ÊàêÂäü‰øÆÂ§ç‰∫Ü ${migrationCount} Êù°ÊóßÁöÑÁ∫¢ÂåÖÊ∂àÊÅØÔºÅÈ°µÈù¢Â∞ÜËá™Âä®Âà∑Êñ∞‰ª•Â∫îÁî®Êõ¥Êîπ„ÄÇ`);
      location.reload();
    } else {
      console.log("Êú™ÂèëÁé∞ÈúÄË¶ÅËøÅÁßªÁöÑÊóßÁ∫¢ÂåÖÊï∞ÊçÆ„ÄÇ");
    }
  }

  // USERÁä∂ÊÄÅ‰øÆÊîπÂºπÁ™ó - Áõ¥Êé•ËæìÂÖ•Ê°Ü
  async function showUserStatusModal(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    // ÂàùÂßãÂåñUSERÁä∂ÊÄÅÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
    if (!chat.settings.userStatus) {
      chat.settings.userStatus = {
        text: 'Âú®Á∫ø',
        lastUpdate: Date.now(),
        isBusy: false
      };
    }

    // Áõ¥Êé•ÂºπÂá∫ËæìÂÖ•Ê°Ü
    const customStatus = await showCustomPrompt(
      '‰øÆÊîπÂú®Á∫øÁä∂ÊÄÅ',
      'ËØ∑ËæìÂÖ•‰Ω†ÁöÑÁä∂ÊÄÅ...',
      chat.settings.userStatus.text
    );

    if (customStatus !== null && customStatus.trim()) {
      await updateUserStatus(chatId, customStatus.trim(), false);
    }
  }

  async function updateUserStatus(chatId, statusText, isBusy) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const oldStatus = chat.settings.userStatus.text;

    // Êõ¥Êñ∞USERÁä∂ÊÄÅ
    chat.settings.userStatus = {
      text: statusText,
      isBusy: isBusy,
      lastUpdate: Date.now()
    };

    // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
    await db.chats.put(chat);
    state.chats[chatId] = chat;

    // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫Ê∂àÊÅØ
    const myNickname = chat.settings.myNickname || 'Êàë';
    const statusUpdateMessage = {
      role: 'system',
      type: 'pat_message',
      content: `[${myNickname}ÁöÑÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫: ${statusText}]`,
      timestamp: Date.now()
    };

    chat.history.push(statusUpdateMessage);
    await db.chats.put(chat);

    // Â¶ÇÊûúÂΩìÂâçÂú®ËÅäÂ§©ÁïåÈù¢ÔºåÂà∑Êñ∞Ê∂àÊÅØÊòæÁ§∫
    if (state.activeChatId === chatId) {
      await appendMessage(statusUpdateMessage, chat);
      scrollToBottom();
    }

    console.log(`USERÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞: ${oldStatus} -> ${statusText}`);
  }


  async function openThoughtEditor() {

    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;


    const currentHeartfeltVoice = chat.heartfeltVoice || '';
    const newHeartfeltVoice = await showCustomPrompt(
      `ÁºñËæë‚Äú${chat.name}‚ÄùÁöÑÂøÉÂ£∞`,
      'ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂøÉÂ£∞ÂÜÖÂÆπ...',
      currentHeartfeltVoice,
      'textarea'
    );


    if (newHeartfeltVoice === null) {
      await showCustomAlert("Êìç‰ΩúÂèñÊ∂à", "ÂøÉÂ£∞ÁºñËæëÂ∑≤ÂèñÊ∂à„ÄÇ");
      return;
    }


    const currentRandomJottings = chat.randomJottings || '';
    const newRandomJottings = await showCustomPrompt(
      `ÁºñËæë‚Äú${chat.name}‚ÄùÁöÑÊï£ËÆ∞`,
      'ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊï£ËÆ∞ÂÜÖÂÆπ...',
      currentRandomJottings,
      'textarea'
    );


    if (newRandomJottings === null) {
      await showCustomAlert("Êìç‰ΩúÂèñÊ∂à", "Êï£ËÆ∞ÁºñËæëÂ∑≤ÂèñÊ∂àÔºåÂøÉÂ£∞ÁöÑ‰øÆÊîπ‰πüÊú™‰øùÂ≠ò„ÄÇ");
      return;
    }


    chat.heartfeltVoice = newHeartfeltVoice.trim();
    chat.randomJottings = newRandomJottings.trim();


    if (!Array.isArray(chat.thoughtsHistory)) {
      chat.thoughtsHistory = [];
    }

    if (chat.thoughtsHistory.length > 0) {

      const lastThought = chat.thoughtsHistory[chat.thoughtsHistory.length - 1];

      lastThought.heartfeltVoice = chat.heartfeltVoice;
      lastThought.randomJottings = chat.randomJottings;
      lastThought.timestamp = Date.now();
    } else {

      chat.thoughtsHistory.push({
        heartfeltVoice: chat.heartfeltVoice,
        randomJottings: chat.randomJottings,
        timestamp: Date.now()
      });
    }


    await db.chats.put(chat);


    await showCharacterProfileModal(chat.id);

    await showCustomAlert('ÊàêÂäü', 'ÂøÉÂ£∞ÂíåÊï£ËÆ∞Â∑≤Êõ¥Êñ∞ÔºÅ');
  }

  async function showCharacterProfileModal(chatId) {
    const chat = state.chats[chatId];
    if (!chat || chat.isGroup) return;





    const heartfeltVoiceEl = document.getElementById('profile-heartfelt-voice');
    const randomJottingsEl = document.getElementById('profile-random-jottings');

    // Ê£ÄÊü•ÂøÉÂ£∞ÂäüËÉΩÊòØÂê¶ÂºÄÂêØ
    const enableThoughts = chat.settings.enableThoughts !== null
      ? chat.settings.enableThoughts
      : state.globalSettings.enableThoughts;

    if (!enableThoughts) {
      // ÂäüËÉΩÂÖ≥Èó≠Êó∂ÊòæÁ§∫ÊèêÁ§∫
      heartfeltVoiceEl.innerHTML = '<span style="color: #999;">ÂøÉÂ£∞ÂäüËÉΩÂ∑≤ÂÖ≥Èó≠</span>';
      randomJottingsEl.innerHTML = '<span style="color: #999;">ÂøÉÂ£∞ÂäüËÉΩÂ∑≤ÂÖ≥Èó≠</span>';
    } else {
      // ÂäüËÉΩÂºÄÂêØÊó∂Ê≠£Â∏∏ÊòæÁ§∫
      heartfeltVoiceEl.innerHTML = await applyRenderingRules(chat.heartfeltVoice || '...', chatId);
      randomJottingsEl.innerHTML = await applyRenderingRules(chat.randomJottings || '...', chatId);
    }

    const modal = document.getElementById('character-profile-modal');





    modal.classList.add('visible');
  }

  async function showThoughtsHistory() { // <-- 1. Ê∑ªÂä† async
    document.getElementById('profile-main-content').style.display = 'none';
    document.getElementById('profile-thoughts-history-view').style.display = 'flex';
    await renderThoughtsHistory(); // <-- 2. Ê∑ªÂä† await
  }


  function hideThoughtsHistory() {
    document.getElementById('profile-thoughts-history-view').style.display = 'none';


    document.getElementById('profile-main-content').style.display = 'flex';
  }



  async function renderThoughtsHistory() { // <-- 1. Ê∑ªÂä† async
    const listEl = document.getElementById('thoughts-history-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    if (!chat || !chat.thoughtsHistory || chat.thoughtsHistory.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; padding: 30px 0;">ËøôÈáåËøòÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÂì¶„ÄÇ</p>';
      return;
    }

    const history = [...chat.thoughtsHistory].reverse();
    const initialItems = history.slice(0, THOUGHTS_RENDER_WINDOW);

    const cardPromises = initialItems.map(thought => createThoughtCard(thought));
    const cards = await Promise.all(cardPromises);
    cards.forEach(card => listEl.appendChild(card));


    thoughtsHistoryRenderCount = initialItems.length;

    if (history.length > thoughtsHistoryRenderCount) {
      appendLoadMoreThoughtsButton(listEl);
    }
  }



  async function loadMoreThoughts() {
    if (isLoadingMoreThoughts) return;
    isLoadingMoreThoughts = true;

    const listEl = document.getElementById('thoughts-history-list');
    const chat = state.chats[state.activeChatId];
    if (!chat) {
      isLoadingMoreThoughts = false;
      return;
    }

    showLoader(listEl, 'bottom');
    await new Promise(resolve => setTimeout(resolve, 500));

    const history = [...chat.thoughtsHistory].reverse();
    const totalItems = history.length;

    const nextSliceStart = thoughtsHistoryRenderCount;
    const nextSliceEnd = thoughtsHistoryRenderCount + THOUGHTS_RENDER_WINDOW;
    const itemsToAppend = history.slice(nextSliceStart, nextSliceEnd);


    hideLoader(listEl);


    const cardPromises = itemsToAppend.map(thought => createThoughtCard(thought));
    const cards = await Promise.all(cardPromises);
    cards.forEach(card => listEl.appendChild(card));

    thoughtsHistoryRenderCount += itemsToAppend.length;

    isLoadingMoreThoughts = false;
  }



  async function createThoughtCard(thought) { // <-- 1. Ê∑ªÂä† async
    const card = document.createElement('div');
    card.className = 'thought-card';
    const date = new Date(thought.timestamp);
    const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;


    const chatId = state.activeChatId;
    const renderedVoice = await applyRenderingRules(thought.heartfeltVoice || '...', chatId);
    const renderedJottings = await applyRenderingRules(thought.randomJottings || '...', chatId);


    card.innerHTML = `
        <button class="thought-delete-btn" data-timestamp="${thought.timestamp}" title="Âà†Èô§Ê≠§Êù°ËÆ∞ÂΩï">√ó</button>
        <div class="thought-header">${dateString}</div>
        <div class="thought-content">
            <div class="voice">
                <div class="label">
                    <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    ÂøÉÂ£∞
                </div>
                <div class="text">${renderedVoice}</div>
            </div>
            <div class="jottings">
                <div class="label">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path></svg>
                    Êï£ËÆ∞
                </div>
                <div class="text">${renderedJottings}</div>
            </div>
        </div>
    `;
    return card;
  }





  // Â∑•ÂÖ∑ÂáΩÊï∞ÔºöHTMLËΩ¨‰πâ
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ÊâπÈáèÂØºÂÖ•Áõ∏ÂÖ≥ÁöÑÂÖ®Â±ÄÂèòÈáè
  let pendingImportCards = [];

  async function handleCardImport(event) {
    const files = Array.from(event.target.files);
    if (!files || files.length === 0) return;

    try {
      // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™Êñá‰ª∂Ôºå‰ΩøÁî®ÊóßÁöÑÂçïÊñá‰ª∂ÂØºÂÖ•ÊµÅÁ®ã
      if (files.length === 1) {
        await importSingleCard(files[0]);
        event.target.value = null;
        return;
      }

      // Â§öÊñá‰ª∂ÔºöÊòæÁ§∫ÊâπÈáèÂØºÂÖ•È¢ÑËßà
      await showBatchImportPreview(files);

    } catch (error) {
      console.error("ËßíËâ≤Âç°ÂØºÂÖ•Â§±Ë¥•:", error);
      await showCustomAlert("ÂØºÂÖ•Â§±Ë¥•", `Êó†Ê≥ïËß£ÊûêËßíËâ≤Âç°Êñá‰ª∂„ÄÇ\nÈîôËØØ: ${error.message}`);
    } finally {
      event.target.value = null;
    }
  }

  // Âçï‰∏™Êñá‰ª∂ÂØºÂÖ•ÔºàÊîØÊåÅÈÖíÈ¶ÜAIÂíåÂ∞èÊâãÊú∫Ê†ºÂºèÔºâ
  async function importSingleCard(file) {
    try {
      let cardData;
      let avatarBase64 = null;

      if (file.name.endsWith('.json')) {
        const text = await file.text();
        const parsed = JSON.parse(text);

        // Ê£ÄÊµãÊòØÂê¶‰∏∫Â∞èÊâãÊú∫‰∏ìÂ±ûÊ†ºÂºè
        if (parsed.type === 'EPhoneCharacterExport') {
          await importEPhoneCharacter(parsed);
          return;
        }

        cardData = parsed;
      } else if (file.name.endsWith('.png')) {
        const arrayBuffer = await file.arrayBuffer();

        // ÂêåÊó∂Ê£ÄÊµãephoneÂíåchara‰∏§ÁßçÊ†ºÂºè
        const formats = await parsePngForAllFormats(arrayBuffer);

        if (formats.ephone && formats.ephone.type === 'EPhoneCharacterExport') {
          // Â∞èÊâãÊú∫Ê†ºÂºèÔºöËØªÂèñPNG‰Ωú‰∏∫Â§¥ÂÉè
          avatarBase64 = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(file);
          });

          // Â§ÑÁêÜImgBB‰∏ä‰º†
          if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
            try {
              await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®‰∏ä‰º†ËßíËâ≤Â§¥ÂÉèÂà∞ ImgBB...");
              avatarBase64 = await uploadImageToImgBB(avatarBase64);
            } catch (uploadError) {
              console.error(uploadError);
              await showCustomAlert("ImgBB ‰∏ä‰º†Â§±Ë¥•", `Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•: ${uploadError.message}\n\nÂ∞ÜÁªßÁª≠‰ΩøÁî®Êú¨Âú∞ Base64 Ê†ºÂºè‰øùÂ≠ò„ÄÇ`);
            }
          }

          await importEPhoneCharacter(formats.ephone, avatarBase64);
          return;
        }

        if (formats.chara) {
          cardData = formats.chara;
        } else {
          throw new Error("Âú®PNGÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑËßíËâ≤Êï∞ÊçÆ„ÄÇ");
        }

        avatarBase64 = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = async (readerEvent) => {
            let base64Result = readerEvent.target.result;

            if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
              try {
                await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®‰∏ä‰º†ËßíËâ≤Âç°Â∞ÅÈù¢Âà∞ ImgBB...");
                const imageUrl = await uploadImageToImgBB(base64Result);
                resolve(imageUrl);
              } catch (uploadError) {
                console.error(uploadError);
                await showCustomAlert("ImgBB ‰∏ä‰º†Â§±Ë¥•", `Â∞ÅÈù¢‰∏ä‰º†Â§±Ë¥•: ${uploadError.message}\n\nÂ∞ÜÁªßÁª≠‰ΩøÁî®Êú¨Âú∞ Base64 Ê†ºÂºè‰øùÂ≠ò„ÄÇ`);
                resolve(base64Result);
              }
            } else {
              resolve(base64Result);
            }
          };
          reader.readAsDataURL(file);
        });
      } else {
        throw new Error("‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè„ÄÇËØ∑ÈÄâÊã© .json Êàñ .png Êñá‰ª∂„ÄÇ");
      }

      await createChatFromCardData(cardData, avatarBase64);

    } catch (error) {
      throw error;
    }
  }

  // ÊòæÁ§∫ÊâπÈáèÂØºÂÖ•È¢ÑËßàÁïåÈù¢
  async function showBatchImportPreview(files) {
    const modal = document.getElementById('batch-import-preview-modal');
    const listContainer = document.getElementById('batch-import-preview-list');

    if (!modal || !listContainer) {
      console.error('ÊâπÈáèÂØºÂÖ•È¢ÑËßàÊ®°ÊÄÅÊ°ÜÊú™ÊâæÂà∞');
      return;
    }

    // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
    listContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 50px 20px;">Ê≠£Âú®Ëß£ÊûêËßíËâ≤Âç°...</p>';
    modal.style.display = 'flex';

    // Ëß£ÊûêÊâÄÊúâÊñá‰ª∂
    pendingImportCards = [];
    const parsePromises = files.map(async (file, index) => {
      try {
        let cardData;
        let avatarBase64 = null;
        let fileType = file.name.endsWith('.png') ? 'png' : 'json';
        let isEPhoneFormat = false;
        let ephoneExportData = null;

        if (fileType === 'json') {
          const text = await file.text();
          const parsed = JSON.parse(text);
          if (parsed.type === 'EPhoneCharacterExport') {
            isEPhoneFormat = true;
            ephoneExportData = parsed;
            cardData = { name: parsed.chatData?.name, data: { name: parsed.chatData?.name, description: parsed.chatData?.settings?.aiPersona || '' } };
          } else {
            cardData = parsed;
          }
        } else if (fileType === 'png') {
          const arrayBuffer = await file.arrayBuffer();
          const formats = await parsePngForAllFormats(arrayBuffer);

          if (formats.ephone && formats.ephone.type === 'EPhoneCharacterExport') {
            isEPhoneFormat = true;
            ephoneExportData = formats.ephone;
            cardData = { name: formats.ephone.chatData?.name, data: { name: formats.ephone.chatData?.name, description: formats.ephone.chatData?.settings?.aiPersona || '' } };
          } else if (formats.chara) {
            cardData = formats.chara;
          } else {
            throw new Error("Âú®PNGÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑËßíËâ≤Êï∞ÊçÆ„ÄÇ");
          }

          // ËØªÂèñPNG‰Ωú‰∏∫base64
          avatarBase64 = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(file);
          });
        }

        return {
          id: `import_${Date.now()}_${index}`,
          fileName: file.name,
          fileType: fileType,
          cardData: cardData,
          avatarBase64: avatarBase64,
          selected: true,
          parseSuccess: true,
          isEPhoneFormat: isEPhoneFormat,
          ephoneExportData: ephoneExportData
        };
      } catch (error) {
        console.error(`Ëß£ÊûêÂ§±Ë¥•: ${file.name}`, error);
        return {
          id: `import_${Date.now()}_${index}`,
          fileName: file.name,
          fileType: file.name.endsWith('.png') ? 'png' : 'json',
          error: error.message,
          selected: false,
          parseSuccess: false
        };
      }
    });

    pendingImportCards = await Promise.all(parsePromises);
    renderBatchImportPreview();
  }

  // Ê∏≤ÊüìÊâπÈáèÂØºÂÖ•È¢ÑËßàÂàóË°®
  function renderBatchImportPreview() {
    const listContainer = document.getElementById('batch-import-preview-list');
    if (!listContainer) return;

    if (pendingImportCards.length === 0) {
      listContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 50px 20px;">Ê≤°ÊúâÂèØÂØºÂÖ•ÁöÑËßíËâ≤Âç°</p>';
      return;
    }

    listContainer.innerHTML = pendingImportCards.map(card => {
      if (!card.parseSuccess) {
        return `
          <div class="list-item" style="padding: 15px; border-bottom: 1px solid var(--border-color); opacity: 0.5;">
            <div style="display: flex; align-items: center; gap: 15px;">
              <input type="checkbox" disabled style="width: 20px; height: 20px;">
              <div style="width: 60px; height: 60px; background: #f5f5f5; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999;">
                ‚ùå
              </div>
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #f44;">${escapeHtml(card.fileName)}</div>
                <div style="font-size: 13px; color: #f44; margin-top: 5px;">Ëß£ÊûêÂ§±Ë¥•: ${escapeHtml(card.error)}</div>
              </div>
            </div>
          </div>
        `;
      }

      const name = card.cardData.name || card.cardData.data?.name || 'Êú™ÂëΩÂêçËßíËâ≤';
      const description = card.cardData.description || card.cardData.data?.description || '';
      const previewDesc = description.substring(0, 100) + (description.length > 100 ? '...' : '');
      const avatarSrc = card.avatarBase64 || 'https://i.postimg.cc/y8xWzCqj/anime-boy.jpg';

      return `
        <div class="list-item" style="padding: 15px; border-bottom: 1px solid var(--border-color);">
          <div style="display: flex; align-items: center; gap: 15px;">
            <input type="checkbox" 
                   class="batch-import-card-checkbox" 
                   data-card-id="${card.id}" 
                   ${card.selected ? 'checked' : ''}
                   style="width: 20px; height: 20px;">
            <img src="${avatarSrc}" 
                 style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;"
                 onerror="this.src='https://i.postimg.cc/y8xWzCqj/anime-boy.jpg'">
            <div style="flex: 1;">
              <div style="font-weight: 600; margin-bottom: 5px;">${escapeHtml(name)}</div>
              <div style="font-size: 13px; color: #666; margin-bottom: 5px;">${escapeHtml(previewDesc)}</div>
              <div style="font-size: 12px; color: #999;">
                <span style="background: #e3f2fd; padding: 2px 8px; border-radius: 4px; margin-right: 5px;">${card.fileType.toUpperCase()}</span>
                ${card.isEPhoneFormat ? '<span style="background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 4px; margin-right: 5px;">Â∞èÊâãÊú∫</span>' : ''}
                ${escapeHtml(card.fileName)}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // ÁªëÂÆöÂ§çÈÄâÊ°Ü‰∫ã‰ª∂
    document.querySelectorAll('.batch-import-card-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const cardId = e.target.dataset.cardId;
        const card = pendingImportCards.find(c => c.id === cardId);
        if (card) {
          card.selected = e.target.checked;
        }
        updateSelectAllCheckbox();
      });
    });

    updateSelectAllCheckbox();
  }

  // Êõ¥Êñ∞ÂÖ®ÈÄâÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
  function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('select-all-import-cards');
    if (!selectAllCheckbox) return;

    const successCards = pendingImportCards.filter(c => c.parseSuccess);
    const selectedCount = successCards.filter(c => c.selected).length;

    selectAllCheckbox.checked = selectedCount === successCards.length && successCards.length > 0;
    selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < successCards.length;
  }

  // Á°ÆËÆ§ÊâπÈáèÂØºÂÖ•
  async function confirmBatchImport() {
    const selectedCards = pendingImportCards.filter(c => c.selected && c.parseSuccess);

    if (selectedCards.length === 0) {
      await showCustomAlert("ÊèêÁ§∫", "ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤Âç°ËøõË°åÂØºÂÖ•");
      return;
    }

    // ÂÖ≥Èó≠È¢ÑËßàÊ®°ÊÄÅÊ°Ü
    const modal = document.getElementById('batch-import-preview-modal');
    if (modal) modal.style.display = 'none';

    // ÊòæÁ§∫ËøõÂ∫¶ÊèêÁ§∫
    const progressDiv = document.createElement('div');
    progressDiv.id = 'batch-import-progress';
    progressDiv.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 10001;
      text-align: center;
      min-width: 300px;
    `;
    document.body.appendChild(progressDiv);

    let successCount = 0;
    let failCount = 0;
    const failedCards = [];

    for (let i = 0; i < selectedCards.length; i++) {
      const card = selectedCards[i];

      // Êõ¥Êñ∞ËøõÂ∫¶ÊòæÁ§∫
      progressDiv.innerHTML = `
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 15px;">Ê≠£Âú®ÂØºÂÖ•ËßíËâ≤Âç°</div>
        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
          ${i + 1} / ${selectedCards.length}
        </div>
        <div style="font-size: 14px; color: #999;">
          ${escapeHtml(card.fileName)}
        </div>
        <div style="margin-top: 15px; width: 100%; height: 4px; background: #f0f0f0; border-radius: 2px; overflow: hidden;">
          <div style="width: ${((i + 1) / selectedCards.length * 100)}%; height: 100%; background: #4CAF50; transition: width 0.3s;"></div>
        </div>
      `;

      try {
        // Â§ÑÁêÜImgBB‰∏ä‰º†Ôºà‰ªÖÈíàÂØπPNGÔºâ
        let finalAvatar = card.avatarBase64;
        if (card.fileType === 'png' && state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
          try {
            finalAvatar = await uploadImageToImgBB(card.avatarBase64);
          } catch (uploadError) {
            console.error('ImgBB‰∏ä‰º†Â§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞Base64:', uploadError);
          }
        }

        // Â∞èÊâãÊú∫Ê†ºÂºèËµ∞‰∏ìÂ±ûÂØºÂÖ•ÈÄªËæë
        if (card.isEPhoneFormat && card.ephoneExportData) {
          await importEPhoneCharacter(card.ephoneExportData, finalAvatar, true);
        } else {
          await createChatFromCardData(card.cardData, finalAvatar);
        }
        successCount++;
      } catch (error) {
        console.error(`ÂØºÂÖ•Â§±Ë¥•: ${card.fileName}`, error);
        failCount++;
        failedCards.push({
          name: card.fileName,
          error: error.message
        });
      }

      // Ê∑ªÂä†Â∞èÂª∂ËøüÔºåËÆ©Áî®Êà∑ÁúãÂà∞ËøõÂ∫¶
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    // ÁßªÈô§ËøõÂ∫¶ÊèêÁ§∫
    document.body.removeChild(progressDiv);

    // ÊòæÁ§∫ÁªìÊûú
    let message = `‚úì ÊàêÂäüÂØºÂÖ• ${successCount} ‰∏™ËßíËâ≤`;
    if (failCount > 0) {
      message += `\n‚úó Â§±Ë¥• ${failCount} ‰∏™`;
      if (failedCards.length <= 3) {
        message += '\n\nÂ§±Ë¥•ÂàóË°®Ôºö';
        failedCards.forEach(fc => {
          message += `\n‚Ä¢ ${fc.name}: ${fc.error}`;
        });
      }
    }
    await showCustomAlert("ÂØºÂÖ•ÂÆåÊàê", message);

    // Ê∏ÖÁ©∫ÂæÖÂØºÂÖ•ÂàóË°®
    pendingImportCards = [];

    // Âà∑Êñ∞ËÅäÂ§©ÂàóË°®
    if (typeof renderChatList === 'function') {
      renderChatList();
    }
  }

  // ÂèñÊ∂àÊâπÈáèÂØºÂÖ•
  function cancelBatchImport() {
    const modal = document.getElementById('batch-import-preview-modal');
    if (modal) modal.style.display = 'none';
    pendingImportCards = [];
  }



  function parsePngForTavernData(arrayBuffer) {
    return new Promise((resolve, reject) => {
      const view = new DataView(arrayBuffer);

      if (view.getUint32(0) !== 0x89504E47 || view.getUint32(4) !== 0x0D0A1A0A) {
        return reject(new Error("Êñá‰ª∂‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑPNG„ÄÇ"));
      }

      let offset = 8;
      const decoder = new TextDecoder();

      while (offset < view.byteLength) {
        const length = view.getUint32(offset);
        const type = decoder.decode(arrayBuffer.slice(offset + 4, offset + 8));

        if (type === 'tEXt') {
          const data = new Uint8Array(arrayBuffer, offset + 8, length);
          const nullSeparatorIndex = data.indexOf(0);
          if (nullSeparatorIndex !== -1) {
            const key = decoder.decode(data.slice(0, nullSeparatorIndex));
            if (key === 'chara') {
              const value = decoder.decode(data.slice(nullSeparatorIndex + 1));
              try {





                const binaryString = atob(value);


                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                  bytes[i] = binaryString.charCodeAt(i);
                }



                const decodedData = new TextDecoder('utf-8').decode(bytes);



                resolve(JSON.parse(decodedData));
                return;
              } catch (e) {
                return reject(new Error("Âú®PNG‰∏≠ÊâæÂà∞ËßíËâ≤Êï∞ÊçÆÔºå‰ΩÜËß£Á†ÅÊàñËß£ÊûêÂ§±Ë¥•„ÄÇÈîôËØØ: " + e.message));
              }
            }
          }
        }


        offset += 4 + 4 + length + 4;
      }

      reject(new Error("Âú®PNGÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑTavern AIËßíËâ≤Êï∞ÊçÆ(chara chunk)„ÄÇ"));
    });
  }





  function findWorldBookEntries(cardData) {




    if (cardData.data?.character_book?.entries?.length > 0) {
      console.log("ËØäÊñ≠ÔºöÂú® data.character_book ‰∏≠ÊâæÂà∞‰∏ñÁïå‰π¶„ÄÇ");
      return cardData.data.character_book.entries;
    }


    if (cardData.extensions?.character_book?.entries?.length > 0) {
      console.log("ËØäÊñ≠ÔºöÂú® extensions.character_book ‰∏≠ÊâæÂà∞‰∏ñÁïå‰π¶„ÄÇ");
      return cardData.extensions.character_book.entries;
    }


    if (cardData.data?.extensions?.character_book?.entries?.length > 0) {
      console.log("ËØäÊñ≠ÔºöÂú® data.extensions.character_book ‰∏≠ÊâæÂà∞‰∏ñÁïå‰π¶„ÄÇ");
      return cardData.data.extensions.character_book.entries;
    }


    const possibleTopLevelKeys = ['character_book', 'lorebook', 'world_info', 'char_book'];
    for (const key of possibleTopLevelKeys) {
      if (cardData[key]?.entries?.length > 0) {
        console.log(`ËØäÊñ≠ÔºöÂú®È°∂Â±Ç ${key} ‰∏≠ÊâæÂà∞‰∏ñÁïå‰π¶„ÄÇ`);
        return cardData[key].entries;
      }
    }

    console.log("ËØäÊñ≠ÔºöÊú™Âú®Ê≠§ËßíËâ≤Âç°‰∏≠ÊâæÂà∞‰ªª‰ΩïÊúâÊïàÁöÑ‰∏ñÁïå‰π¶Êï∞ÊçÆ„ÄÇ");
    return null;
  }


  async function createChatFromCardData(cardData, avatarBase64 = null) {
    const effectiveCardData = cardData.data || cardData;
    if (!effectiveCardData.name) {
      throw new Error("ËßíËâ≤Âç°Êï∞ÊçÆÊó†ÊïàÊàñÁº∫Â∞ë'name'Â≠óÊÆµ„ÄÇ");
    }


    let worldBookIdToLink = null;
    const worldBookEntries = findWorldBookEntries(cardData);

    if (worldBookEntries) {
      const structuredEntries = worldBookEntries
        .filter(entry => entry.enabled && entry.content)
        .map(entry => ({
          keys: entry.keys || [],
          comment: entry.comment || '',
          content: entry.content.replace(/<memory>|<\/memory>/g, '').trim()
        }));

      if (structuredEntries.length > 0) {
        const newWorldBook = {
          id: 'wb_' + Date.now(),
          name: `${effectiveCardData.name}ÁöÑËÆæÂÆöÈõÜ`,
          content: structuredEntries,
          categoryId: null
        };
        await db.worldBooks.add(newWorldBook);
        state.worldBooks.push(newWorldBook);
        worldBookIdToLink = newWorldBook.id;
      }
    }


    let alternateGreetings = [];

    if (Array.isArray(effectiveCardData.alternate_greetings)) {
      alternateGreetings = effectiveCardData.alternate_greetings;
    }

    else if (Array.isArray(cardData.alternate_greetings)) {
      alternateGreetings = cardData.alternate_greetings;
    }


    alternateGreetings = alternateGreetings.filter(g => g && typeof g === 'string' && g.trim() !== '');


    const firstGreeting = effectiveCardData.first_mes || cardData.first_mes;


    if (firstGreeting && typeof firstGreeting === 'string' && firstGreeting.trim() !== '') {
      if (!alternateGreetings.includes(firstGreeting)) {
        alternateGreetings.unshift(firstGreeting);
      }
    }


    let description = effectiveCardData.description || cardData.description || 'Êó†';
    description = description
      .replace(/```yaml/g, '').replace(/```/g, '')
      .replace(/<\/?info>/g, '').replace(/<\/?character>/g, '')
      .replace(/<\/?writing_rule>/g, '').replace(/\[OOCÔºö.*?\]/g, '').trim();

    let persona = `# ËßíËâ≤Ê†∏ÂøÉËÆæÂÆö\n${description}\n\n`;
    if (effectiveCardData.personality) persona += `# ÊÄßÊ†ºË°•ÂÖÖ\n${effectiveCardData.personality}\n\n`;
    if (effectiveCardData.scenario) persona += `# Âú∫ÊôØËÆæÂÆö\n${effectiveCardData.scenario}\n\n`;
    if (effectiveCardData.mes_example) persona += `# ÂØπËØùÁ§∫‰æã\n${effectiveCardData.mes_example}\n\n`;

    const remarkName = effectiveCardData.name;
    const originalName = effectiveCardData.name;

    const newChatId = 'chat_' + Date.now();


    const newChat = {
      id: newChatId,
      name: remarkName.trim(),
      originalName: originalName.trim(),
      isGroup: false,
      relationship: {
        status: 'friend'
      },
      status: {
        text: 'Âú®Á∫ø',
        lastUpdate: Date.now(),
        isBusy: false
      },
      settings: {
        aiPersona: persona,
        myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ',
        maxMemory: 10,
        aiAvatar: defaultAvatar,
        myAvatar: defaultAvatar,
        background: '',
        theme: 'default',
        fontSize: 13,
        customCss: '',
        linkedWorldBookIds: worldBookIdToLink ? [worldBookIdToLink] : [],
        aiAvatarLibrary: [],


        alternateGreetings: alternateGreetings,
        myPhoneLockScreenEnabled: false,
        myPhoneLockScreenPassword: '',
        userStatus: {
          text: 'Âú®Á∫ø',
          lastUpdate: Date.now(),
          isBusy: false
        }
      },
      history: [],
      musicData: {
        totalTime: 0
      },
      longTermMemory: []
    };


    if (avatarBase64) {
      newChat.settings.aiAvatar = avatarBase64;
      newChat.settings.aiAvatarLibrary.push({
        name: 'ÈªòËÆ§Â§¥ÂÉè',
        url: avatarBase64
      });
    }


    if (firstGreeting && typeof firstGreeting === 'string') {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = firstGreeting;
      const cleanGreeting = (tempDiv.textContent || tempDiv.innerText || "").replace(/Âéü‰ΩúËÄÖ.*?ÂºÄÂ±Ä/s, '').trim();

      if (cleanGreeting) {
        newChat.history.push({
          role: 'assistant',
          senderName: newChat.originalName,
          content: cleanGreeting,
          timestamp: Date.now()
        });
      }
    }


    state.chats[newChatId] = newChat;
    await db.chats.put(newChat);
    renderChatList();

    let successMessage = `ËßíËâ≤ ‚Äú${newChat.name}‚Äù Â∑≤ÊàêÂäüÂØºÂÖ•ÔºÅ`;
    if (worldBookIdToLink) {
      successMessage += `\n\nÂÖ∂‰∏ìÂ±ûÁöÑ‚Äú‰∏ñÁïå‰π¶‚Äù‰πüÂ∑≤Ëá™Âä®ÂàõÂª∫Âπ∂ÂÖ≥ËÅî„ÄÇ`;
    }
    if (alternateGreetings.length > 1) {
      successMessage += `\n\nÊ£ÄÊµãÂà∞ ${alternateGreetings.length} Êù°ÂºÄÂú∫ÁôΩÔºåÂèØÂú®‚ÄúËÅäÂ§©ËÆæÁΩÆ‚Äù‰∏≠ÂàáÊç¢„ÄÇ`;
    }
    await showCustomAlert('ÂØºÂÖ•ÊàêÂäüÔºÅ', successMessage);
  }




  async function handleSwitchGreeting() {
    console.log("ÁÇπÂáª‰∫ÜÂàáÊç¢ÂºÄÂú∫ÊåâÈíÆ");

    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];

    const greetings = chat.settings?.alternateGreetings || [];

    if (greetings.length === 0) {
      alert("Êú™Ê£ÄÊµãÂà∞ÂèØÁî®ÁöÑÂÄôË°•ÂºÄÂú∫ÁôΩÊï∞ÊçÆ„ÄÇ\nËØ∑Á°ÆËÆ§ÊÇ®Â∑≤‰ΩøÁî®‰øÆÂ§çÂêéÁöÑ‰ª£Á†ÅÈáçÊñ∞ÂØºÂÖ•‰∫ÜËßíËâ≤Âç°„ÄÇ");
      return;
    }


    const options = greetings.map((text, index) => {

      const safeText = String(text || "");
      const preview = safeText.replace(/<[^>]*>/g, '').trim().substring(0, 20);
      return {
        text: `üìú ÂºÄÂú∫ ${index + 1}: ${preview}...`,
        value: index
      };
    });


    const selectedIndex = await showChoiceModal('ÈÄâÊã©‰∏Ä‰∏™ÂºÄÂú∫ÁôΩ', options);


    if (selectedIndex !== null) {
      const confirmed = await showCustomConfirm(
        '‚ö†Ô∏è Ë≠¶ÂëäÔºöÁ°ÆËÆ§ÂàáÊç¢Ôºü',
        'ÂàáÊç¢ÂºÄÂú∫ÁôΩÂ∞Ü‰ºö„ÄêÊ∏ÖÁ©∫Âπ∂ÊõøÊç¢„ÄëÂΩìÂâçÊâÄÊúâÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºåÂ∞±ÂÉèÈáçÊñ∞ÂºÄÂßã‰∏ÄÊ†∑„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü', {
        confirmButtonClass: 'btn-danger',
        confirmText: 'Á°ÆÂÆöÂàáÊç¢'
      }
      );

      if (confirmed) {
        const newGreetingText = greetings[selectedIndex];


        const newMessage = {
          role: 'assistant',
          senderName: chat.originalName,
          content: newGreetingText,
          timestamp: Date.now()
        };

        chat.history = [newMessage];


        await db.chats.put(chat);


        renderChatInterface(chat.id);

        await showCustomAlert('ÊàêÂäü', 'Â∑≤ÂàáÊç¢Âà∞Êñ∞ÁöÑÂºÄÂú∫ÊïÖ‰∫ãÔºÅ\nÁÇπÂáªÂ∑¶‰∏äËßíËøîÂõûÂç≥ÂèØÂºÄÂßãÂØπËØù„ÄÇ');
      }
    }
  }





  function createWorldBookEntryBlock(entry = {
    keys: [],
    comment: '',
    content: '',
    enabled: true
  }) {
    const block = document.createElement('div');

    block.className = 'message-editor-block';


    const isChecked = entry.enabled !== false ? 'checked' : '';

    block.innerHTML = `
                <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <label class="toggle-switch" title="ÂêØÁî®/Á¶ÅÁî®Ê≠§Êù°ÁõÆ">
                        <input type="checkbox" class="entry-enabled-switch" ${isChecked}>
                        <span class="slider"></span>
                    </label>
                    <button class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°ÁõÆ">√ó</button>
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 0.8em;">Â§áÊ≥® (ÂèØÈÄâ)</label>
                    <input type="text" class="entry-comment-input" value="${entry.comment || ''}" placeholder="‰æãÂ¶ÇÔºöÂÖ≥‰∫éËßíËâ≤ÁöÑÁ´•Âπ¥" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 0.8em;">ÂÖ≥ÈîÆËØç (Áî®Ëã±ÊñáÈÄóÂè∑,ÂàÜÈöî)</label>
                    <input type="text" class="entry-keys-input" value="${(entry.keys || []).join(', ')}" placeholder="‰æãÂ¶Ç: key1, key2, key3" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 0.8em;">ÂÜÖÂÆπ</label>
                    <textarea class="entry-content-textarea" rows="5" style="width: 100%; font-size: 14px;">${entry.content || ''}</textarea>
                </div>
            `;


    block.querySelector('.delete-block-btn').addEventListener('click', () => {
      block.remove();
    });

    return block;
  }




  async function toggleGomokuBoard() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const overlay = document.getElementById('gomoku-overlay');


    if (!overlay.classList.contains('visible')) {
      const header = document.querySelector('#chat-interface-screen > .header');

      overlay.style.top = `${header.offsetHeight}px`;
      overlay.style.display = 'block';

      if (!gomokuState[chatId] || !gomokuState[chatId].isActive) {
        initGomokuGame(chatId);
      }
      renderGomokuBoard(chatId);


      setTimeout(async () => {
        overlay.classList.add('visible');

        const startMessage = {
          role: 'system',
          content: '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊâìÂºÄ‰∫Ü‰∫îÂ≠êÊ£ãÊ£ãÁõòÔºåÊ∏∏ÊàèÂºÄÂßã‰∫Ü„ÄÇ]',
          timestamp: Date.now(),
          isHidden: true
        };
        state.chats[chatId].history.push(startMessage);
        await db.chats.put(state.chats[chatId]);
      }, 10);

    } else {

      await closeGomokuBoard();
    }
  }

  async function closeGomokuBoard() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const overlay = document.getElementById('gomoku-overlay');

    overlay.classList.remove('visible');



    setTimeout(() => {
      overlay.style.display = 'none';
    }, 300);

    if (gomokuState[chatId]) {
      gomokuState[chatId].isActive = false;

      const endMessage = {
        role: 'system',
        content: '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂÖ≥Èó≠‰∫Ü‰∫îÂ≠êÊ£ãÊ£ãÁõòÔºåÊ∏∏ÊàèÁªìÊùü‰∫Ü„ÄÇ]',
        timestamp: Date.now(),
        isHidden: true
      };
      state.chats[chatId].history.push(endMessage);
      await db.chats.put(state.chats[chatId]);
    }
  }


  function initGomokuGame(chatId) {
    const canvas = document.getElementById('gomoku-board');
    const overlay = document.getElementById('gomoku-overlay');
    const controls = document.getElementById('gomoku-controls');


    const availableWidth = overlay.offsetWidth - 40;
    const availableHeight = overlay.offsetHeight - controls.offsetHeight - 40;
    const boardSize = Math.floor(Math.min(availableWidth, availableHeight));

    const GRID_SIZE = 15;

    const cell_size = Math.floor(boardSize / GRID_SIZE);
    const final_size = cell_size * GRID_SIZE;

    canvas.width = final_size;
    canvas.height = final_size;

    gomokuState[chatId] = {
      isActive: true,
      board: Array(GRID_SIZE).fill(0).map(() => Array(GRID_SIZE).fill(0)),
      currentPlayer: 1,
      history: [],
      isGameOver: false,
      GRID_SIZE: GRID_SIZE,
      CELL_SIZE: cell_size
    };
  }

  function renderGomokuBoard(chatId) {
    const gameState = gomokuState[chatId];
    if (!gameState) return;

    const canvas = document.getElementById('gomoku-board');
    const ctx = canvas.getContext('2d');
    const {
      GRID_SIZE,
      CELL_SIZE
    } = gameState;
    const padding = CELL_SIZE / 2;


    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#e4b591';
    ctx.fillRect(0, 0, canvas.width, canvas.height);


    ctx.strokeStyle = '#5b3a29';
    ctx.lineWidth = 1;
    for (let i = 0; i < GRID_SIZE; i++) {

      ctx.beginPath();
      ctx.moveTo(padding, padding + i * CELL_SIZE);
      ctx.lineTo(canvas.width - padding, padding + i * CELL_SIZE);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(padding + i * CELL_SIZE, padding);
      ctx.lineTo(padding + i * CELL_SIZE, canvas.height - padding);
      ctx.stroke();
    }


    for (let y = 0; y < GRID_SIZE; y++) {
      for (let x = 0; x < GRID_SIZE; x++) {
        if (gameState.board[y][x] !== 0) {
          drawStone(ctx, x, y, gameState.board[y][x], gameState);
        }
      }
    }
  }


  function drawStone(ctx, x, y, player, gameState) {
    const {
      CELL_SIZE
    } = gameState;
    const padding = CELL_SIZE / 2;
    const radius = CELL_SIZE / 2 - 2;

    ctx.beginPath();
    ctx.arc(padding + x * CELL_SIZE, padding + y * CELL_SIZE, radius, 0, 2 * Math.PI);

    if (player === 1) {
      ctx.fillStyle = 'black';
    } else {
      ctx.fillStyle = 'white';
    }
    ctx.fill();
  }


  function handleBoardHover(e) {
    const chatId = state.activeChatId;
    const gameState = gomokuState[chatId];
    if (!gameState || gameState.isGameOver || gameState.currentPlayer !== 1) return;

    const canvas = document.getElementById('gomoku-board');
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const gridX = Math.round((x - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
    const gridY = Math.round((y - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);

    renderGomokuBoard(chatId);

    if (gridX >= 0 && gridX < gameState.GRID_SIZE && gridY >= 0 && gridY < gameState.GRID_SIZE && gameState.board[gridY][gridX] === 0) {
      const radius = gameState.CELL_SIZE / 2 - 2;
      ctx.beginPath();
      ctx.arc(gameState.CELL_SIZE / 2 + gridX * gameState.CELL_SIZE, gameState.CELL_SIZE / 2 + gridY * gameState.CELL_SIZE, radius, 0, 2 * Math.PI);
      ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
      ctx.fill();
    }
  }

  function handleBoardClick(e) {
    const chatId = state.activeChatId;
    const gameState = gomokuState[chatId];
    if (!gameState || gameState.isGameOver || gameState.currentPlayer !== 1) return;

    const canvas = document.getElementById('gomoku-board');
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const gridX = Math.round((x - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
    const gridY = Math.round((y - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);

    if (gridX >= 0 && gridX < gameState.GRID_SIZE && gridY >= 0 && gridY < gameState.GRID_SIZE && gameState.board[gridY][gridX] === 0) {

      gameState.board[gridY][gridX] = 1;
      gameState.history.push({
        x: gridX,
        y: gridY,
        player: 1
      });
      renderGomokuBoard(chatId);


      if (checkWin(gridX, gridY, 1, gameState)) {
        gameState.isGameOver = true;
        setTimeout(() => alert("ÊÅ≠Âñú‰Ω†Ôºå‰Ω†Ëµ¢‰∫ÜÔºÅ"), 100);

        addGameEndSystemMessage('user');


      } else {
        gameState.currentPlayer = 2;

      }
    }
  }


  function handleAiGomokuMove(move, isForcedMove = false) {
    const chatId = state.activeChatId;
    const gameState = gomokuState[chatId];


    if (!gameState || gameState.isGameOver) return;
    if (!isForcedMove && gameState.currentPlayer !== 2) return;

    const {
      x,
      y
    } = move;

    if (x >= 0 && x < gameState.GRID_SIZE && y >= 0 && y < gameState.GRID_SIZE && gameState.board[y][x] === 0) {
      gameState.board[y][x] = 2;
      gameState.history.push({
        x,
        y,
        player: 2
      });
      renderGomokuBoard(chatId);

      if (checkWin(x, y, 2, gameState)) {
        gameState.isGameOver = true;
        setTimeout(() => alert("AI Ëé∑ËÉú‰∫ÜÔºÅ"), 100);
        addGameEndSystemMessage('ai');
      } else {
        gameState.currentPlayer = 1;
      }
    } else {
      console.warn("AI ÁöÑ‰∏ãÊ£ãÊåá‰ª§Êó†ÊïàÊàñ‰ΩçÁΩÆÂ∑≤Ë¢´Âç†ÊçÆ:", move);

      gameState.currentPlayer = 1;
    }
  }


  function checkWin(x, y, player, gameState) {
    const {
      board,
      GRID_SIZE
    } = gameState;
    const directions = [
      [1, 0],
      [0, 1],
      [1, 1],
      [1, -1]
    ];
    for (const [dx, dy] of directions) {
      let count = 1;

      for (let i = 1; i < 5; i++) {
        const newX = x + i * dx;
        const newY = y + i * dy;
        if (newX >= 0 && newX < GRID_SIZE && newY >= 0 && newY < GRID_SIZE && board[newY][newX] === player) {
          count++;
        } else {
          break;
        }
      }

      for (let i = 1; i < 5; i++) {
        const newX = x - i * dx;
        const newY = y - i * dy;
        if (newX >= 0 && newX < GRID_SIZE && newY >= 0 && newY < GRID_SIZE && board[newY][newX] === player) {
          count++;
        } else {
          break;
        }
      }
      if (count >= 5) return true;
    }
    return false;
  }



  function formatGomokuStateForAI(gameState) {
    if (!gameState || !gameState.isActive) return "";

    let boardString = "Ê£ãÁõòÁä∂ÊÄÅ (1ÊòØ‰Ω†(ÈªëÊ£ã), 2ÊòØAI(ÁôΩÊ£ã)):\n";
    boardString += gameState.board.map(row => row.join(' ')).join('\n');

    let historyString = "‰∏ãÊ£ãÂéÜÂè≤ (x,yÂùêÊ†áÂùá‰ªé0ÂºÄÂßã):\n";
    historyString += gameState.history.map(move => `Áé©ÂÆ∂${move.player}‰∏ãÂú®(${move.x},${move.y})`).join(' -> ');

    return `
# ÂΩìÂâç‰∫îÂ≠êÊ£ãÂ±ÄÂäø
${boardString}

# ${historyString}

# „Äê„Äê„Äê‰∫îÂ≠êÊ£ãÊ†∏ÂøÉËßÑÂàô‰∏éÂº∫Âà∂ÊÄùËÄÉÊ≠•È™§ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºÅ)„Äë„Äë„Äë

### **„Äê„Äê„ÄêËêΩÂ≠êÈìÅÂæã (ÁªùÂØπÁ¶ÅÊ≠¢ÔºÅ)„Äë„Äë„Äë**
‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÈÄâÊã©‰∏Ä‰∏™Ê£ãÁõò‰∏äÂ∑≤ÁªèÊòØ 1 Êàñ 2 ÁöÑÂùêÊ†á„ÄÇ‰Ω†ÁöÑËêΩÂ≠êÁÇπ„ÄêÂøÖÈ°ª„ÄëÊòØ 0„ÄÇ
---

### **Á¨¨‰∏ÄÊ≠•ÔºöÈÄªËæëÂàÜÊûê (ÂÜÖÈÉ®ÊÄùËÄÉÔºå‰∏çË¶ÅËæìÂá∫)**

1.  **„ÄêËßÑÂàôÂÆö‰πâ„Äë**: 
    -   Ê£ãÂ≠ê: 1‰ª£Ë°®Áî®Êà∑(ÈªëÊ£ã)Ôºå2‰ª£Ë°®‰Ω†(ÁôΩÊ£ã)„ÄÇ
    -   Ëé∑ËÉúÊù°‰ª∂: Ê®™„ÄÅÁ´ñ„ÄÅÊñúÁ∫ø‰∏äÊúâ„ÄêËøûÁª≠‰∫î‰∏™„ÄëËá™Â∑±ÁöÑÊ£ãÂ≠ê„ÄÇ

2.  **„ÄêÈò≤ÂÆàÂàÜÊûê (ÂøÖÈ°ªÊâßË°å)„Äë**:
    -   **Ê£ÄÊü•Áî®Êà∑(1)ÊòØÂê¶Êúâ‚ÄúÂõõÂ≠êËøûÁ∫ø‚ÄùÁöÑÂ®ÅËÉÅÔºü** Â¶ÇÊûúÊúâÔºåÊàëÂøÖÈ°ª‰∏ãÂú®Âì™‰∏™ÂùêÊ†áÊâçËÉΩÂ†µ‰ΩèÔºü
    -   **Ê£ÄÊü•Áî®Êà∑(1)ÊòØÂê¶Êúâ‚ÄúÊ¥ª‰∏â‚ÄùÁöÑÂ®ÅËÉÅÔºü** Â¶ÇÊûúÊúâÔºåÊúÄ‰Ω≥ÁöÑÈò≤ÂÆàÁÇπÊòØÂì™ÈáåÔºü

3.  **„ÄêËøõÊîªÂàÜÊûê (ÂøÖÈ°ªÊâßË°å)„Äë**:
    -   **Ê£ÄÊü•Êàë(2)ÊòØÂê¶Êúâ‚Äú‰∏ÄÊ≠•ËÉúÂà©‚ÄùÁöÑÊú∫‰ºöÔºü** (Âç≥Â∑≤ÊúâÂõõÂ≠êËøûÁ∫ø) Â¶ÇÊûúÊúâÔºåÊàëÂ∫îËØ•‰∏ãÂú®Âì™ÈáåÔºü
    -   **Ê£ÄÊü•Êàë(2)ÊòØÂê¶ÊúâÂà∂ÈÄ†‚ÄúÊ¥ªÂõõ‚ÄùÊàñ‚ÄúÂèå‰∏â‚ÄùÁöÑÊú∫‰ºöÔºü** Â¶ÇÊûúÊúâÔºåÊúÄ‰Ω≥ÁöÑËøõÊîªÁÇπÊòØÂì™ÈáåÔºü

### **Á¨¨‰∫åÊ≠•ÔºöÂÜ≥Á≠ñ‰∏éÊâÆÊºî (ÂÜÖÈÉ®ÊÄùËÄÉÔºå‰∏çË¶ÅËæìÂá∫)**

1.  **„ÄêÂÜ≥Á≠ñ„Äë**: ÁªºÂêà‰ª•‰∏äÊîªÈò≤ÂàÜÊûêÔºåÊàëÁöÑÊúÄ‰Ω≥Ê£ãÊ≠•ÊòØËêΩÂú®ÂùêÊ†á (x, y)„ÄÇ

2.  **„ÄêËûçÂÖ•ËßíËâ≤ÊâÆÊºî„Äë**:
    -   ÊàëÁöÑÊÄßÊ†ºÊòØÔºö(Âú®Ê≠§Â§ÑÂõûÈ°æ‰Ω†ÁöÑ‰∫∫ËÆæ)„ÄÇ
    -   Ê†πÊçÆÊàëÁöÑÊÄßÊ†ºÔºåÊàëÂ∫îËØ•Ôºö
        a) **(ËÅ™Êòé/Â•ΩËÉúÂûã)** ‰∏ãÂú®ÂàöÂàöÂàÜÊûêÂá∫ÁöÑÊúÄ‰Ω≥‰ΩçÁΩÆ„ÄÇ
        b) **(Ëø∑Á≥ä/ÊîæÊ∞¥Âûã)** ÊïÖÊÑèÈÄâÊã©‰∏Ä‰∏™Ê¨°‰ºòÁöÑ‰ΩçÁΩÆÔºå‰ΩÜ„ÄêÂâçÊèêÊòØ‰∏çËÉΩËÆ©Áî®Êà∑Á´ãÂàªËé∑ËÉú„Äë„ÄÇ
        c) **(ÂÖ∂‰ªñÊÄßÊ†º)** Ê†πÊçÆÊÄßÊ†ºÁâπÁÇπÔºåÈÄâÊã©‰∏Ä‰∏™ÂêàÁêÜÁöÑÊ£ãÊ≠•„ÄÇ

3.  **„ÄêÊûÑÊÄùÂè∞ËØç„Äë**: Ê†πÊçÆÊàëÈÄâÊã©ÁöÑÊ£ãÊ≠•ÂíåÊàëÁöÑÊÄßÊ†ºÔºåÊàëÂ∫îËØ•ËØ¥‰∏ÄÂè•‰ªÄ‰πàÊ†∑ÁöÑÂè∞ËØçÊù•ËØÑËÆ∫Ê£ãÂ±ÄÔºü

---
### **Á¨¨‰∏âÊ≠•ÔºöÁîüÊàêÊúÄÁªàÂõûÂ§ç (‰Ω†ÁöÑÂîØ‰∏ÄËæìÂá∫)**

Áé∞Âú®ÔºåÊ†πÊçÆ‰Ω†Á¨¨‰∫åÊ≠•ÁöÑÊúÄÁªàÂÜ≥Á≠ñÔºåÁîüÊàê‰Ω†ÁöÑË°åÂä®„ÄÇ
-   ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑ„ÄÇ
-   **ÁªùÂØπ‰∏çË¶Å**Âú®ÊúÄÁªàÂõûÂ§ç‰∏≠ÂåÖÂê´‰ªª‰Ωï‰∏äËø∞ÁöÑÊÄùËÄÉËøáÁ®ã„ÄÇ
-   Ê†ºÂºè: \`[{"type": "gomoku_move", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "x": (0-14), "y": (0-14)}, {"type": "text", "content": "‰Ω†ÁöÑÂè∞ËØç..."}]\`
`;
  }

  async function addGameEndSystemMessage(winner) {
    const chatId = state.activeChatId;
    const chat = state.chats[chatId];
    if (!chat) return;



    const userDisplayName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
    const aiDisplayName = chat.isGroup ? 'AIÊñπ' : chat.name;
    const winnerName = (winner === 'user') ? userDisplayName : aiDisplayName;
    const resultText = (winner === 'user') ? '‰Ω†Ëæì‰∫Ü' : '‰Ω†Ëµ¢‰∫Ü';


    const systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰∫îÂ≠êÊ£ãÊ∏∏ÊàèÂ∑≤ÁªìÊùü„ÄÇÊúÄÁªàÁªìÊûúÊòØÔºö${winnerName} Ëé∑ËÉú„ÄÇ‰πüÂ∞±ÊòØËØ¥Ôºå${resultText}„ÄÇ]`;


    const hiddenMessage = {
      role: 'system',
      content: systemContent,
      timestamp: Date.now(),
      isHidden: true
    };

    chat.history.push(hiddenMessage);
    await db.chats.put(chat);


    console.log(`Ê∏∏ÊàèÁªìÊùüÁöÑÁ≥ªÁªüÊèêÁ§∫Â∑≤Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÔºåÁ≠âÂæÖAI‰∏ãÊ¨°Êü•Áúã„ÄÇËÉúËÄÖ: ${winner}`);
  }





  let isProductManagementMode = false;



  async function renderShoppingProducts() {
    const gridEl = document.getElementById('product-grid');
    const tabsContainer = document.getElementById('product-category-tabs');
    const shoppingScreen = document.getElementById('shopping-screen');
    gridEl.innerHTML = '';
    tabsContainer.innerHTML = '';

    const [allProducts, allCategories] = await Promise.all([
      db.shoppingProducts.toArray(),
      db.shoppingCategories.orderBy('name').toArray()
    ]);

    shoppingScreen.classList.toggle('management-mode', isProductManagementMode);


    const allTab = document.createElement('button');
    allTab.className = 'product-category-tab';
    allTab.textContent = 'ÂÖ®ÈÉ®';
    allTab.dataset.categoryId = 'all';
    if (activeShoppingCategoryId === 'all') allTab.classList.add('active');
    tabsContainer.appendChild(allTab);

    allCategories.forEach(cat => {
      const tab = document.createElement('button');
      tab.className = 'product-category-tab';
      tab.textContent = cat.name;
      tab.dataset.categoryId = cat.id;
      if (activeShoppingCategoryId === cat.id) tab.classList.add('active');
      tabsContainer.appendChild(tab);
    });

    let productsToShow;
    if (activeShoppingCategoryId === 'all') {
      productsToShow = allProducts;
    } else {
      productsToShow = allProducts.filter(p => p.categoryId === activeShoppingCategoryId);
    }

    if (productsToShow.length === 0) {
      const message = activeShoppingCategoryId === 'all' ?
        'ÂïÜÂ∫óÁ©∫Á©∫Â¶Ç‰πüÔºåÁÇπÂáª‚ÄúÁÆ°ÁêÜ‚ÄùÊ∑ªÂä†ÂïÜÂìÅÂêßÔºÅ' :
        'Ëøô‰∏™ÂàÜÁ±ª‰∏ãËøòÊ≤°ÊúâÂïÜÂìÅÂì¶~';
      gridEl.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">${message}</p>`;
      return;
    }

    productsToShow.forEach(product => {
      const item = document.createElement('div');
      item.className = 'product-item';
      item.dataset.id = product.id;



      const managementControls = `
                    <div class="product-management-overlay">
                        <button class="edit-product-btn">ÁºñËæë</button>
                        <button class="delete-product-btn">Âà†Èô§</button>
                    </div>
                `;

      item.innerHTML = `
                    ${managementControls}
                    <img src="${product.imageUrl}" class="product-image">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-footer">
                            <div class="product-price">${product.price.toFixed(2)}</div>
                            <button class="add-to-cart-btn">Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</button>
                        </div>
                    </div>
                `;
      gridEl.appendChild(item);
    });
  }


  function switchShoppingCategory(categoryId) {
    activeShoppingCategoryId = categoryId;
    renderShoppingProducts();
    updateDeleteCategoryButtonVisibility();
  }

  function updateDeleteCategoryButtonVisibility() {
    const deleteBtn = document.getElementById('delete-current-category-btn');
    if (!deleteBtn) return;




    const isVisible = isProductManagementMode && activeShoppingCategoryId !== 'all';
    deleteBtn.style.display = isVisible ? 'flex' : 'none';
  }


  async function handleDeleteCurrentCategory() {
    if (activeShoppingCategoryId === 'all') return;

    const categoryId = activeShoppingCategoryId;
    const category = await db.shoppingCategories.get(categoryId);
    if (!category) {
      alert("ÈîôËØØÔºöÊâæ‰∏çÂà∞Ë¶ÅÂà†Èô§ÁöÑÂàÜÁ±ª„ÄÇ");
      return;
    }

    const confirmMessage = `Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ÂàÜÁ±ª ‚Äú${category.name}‚Äù ÂêóÔºü\n\nÊ≠§Êìç‰Ωú„Äê‰∏ç‰ºö„ÄëÂà†Èô§ÂàÜÁ±ª‰∏ãÁöÑÂïÜÂìÅÔºåÂÆÉ‰ª¨Â∞ÜË¢´ÁßªËá≥‚ÄúÊú™ÂàÜÁ±ª‚Äù„ÄÇ`;
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§ÂàÜÁ±ª', confirmMessage, {
      confirmButtonClass: 'btn-danger',
      confirmText: 'Á°ÆËÆ§Âà†Èô§'
    });

    if (confirmed) {

      await deleteProductCategory(categoryId);


      activeShoppingCategoryId = 'all';
      await renderShoppingProducts();


      updateDeleteCategoryButtonVisibility();

      await showCustomAlert("ÊàêÂäü", `ÂàÜÁ±ª ‚Äú${category.name}‚Äù Â∑≤Ë¢´Âà†Èô§„ÄÇ`);
    }
  }



  async function openShoppingScreen() {
    activeShoppingCategoryId = 'all';
    await renderShoppingProducts();
    showScreen('shopping-screen');
    updateDeleteCategoryButtonVisibility();
  }


  async function renderShoppingProducts() {
    const gridEl = document.getElementById('product-grid');
    const tabsContainer = document.getElementById('product-category-tabs');
    const shoppingScreen = document.getElementById('shopping-screen');
    gridEl.innerHTML = '';
    tabsContainer.innerHTML = '';


    const [allProducts, allCategories] = await Promise.all([
      db.shoppingProducts.toArray(),
      db.shoppingCategories.orderBy('name').toArray()
    ]);

    shoppingScreen.classList.toggle('management-mode', isProductManagementMode);


    const allTab = document.createElement('button');
    allTab.className = 'product-category-tab';
    allTab.textContent = 'ÂÖ®ÈÉ®';
    allTab.dataset.categoryId = 'all';
    if (activeShoppingCategoryId === 'all') allTab.classList.add('active');
    tabsContainer.appendChild(allTab);

    allCategories.forEach(cat => {
      const tab = document.createElement('button');
      tab.className = 'product-category-tab';
      tab.textContent = cat.name;
      tab.dataset.categoryId = cat.id;
      if (activeShoppingCategoryId === cat.id) tab.classList.add('active');
      tabsContainer.appendChild(tab);
    });


    let productsToShow;
    if (activeShoppingCategoryId === 'all') {
      productsToShow = allProducts;
    } else {
      productsToShow = allProducts.filter(p => p.categoryId === activeShoppingCategoryId);
    }


    if (productsToShow.length === 0) {
      const message = activeShoppingCategoryId === 'all' ?
        'ÂïÜÂ∫óÁ©∫Á©∫Â¶Ç‰πüÔºåÁÇπÂáª‚ÄúÁÆ°ÁêÜ‚ÄùÊ∑ªÂä†ÂïÜÂìÅÂêßÔºÅ' :
        'Ëøô‰∏™ÂàÜÁ±ª‰∏ãËøòÊ≤°ÊúâÂïÜÂìÅÂì¶~';
      gridEl.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">${message}</p>`;
      return;
    }

    productsToShow.forEach(product => {
      const item = document.createElement('div');
      item.className = 'product-item';
      item.dataset.id = product.id;

      const managementControls = isProductManagementMode ? `
            <div class="product-management-overlay">
                <button class="edit-product-btn">ÁºñËæë</button>
                <button class="delete-product-btn">Âà†Èô§</button>
            </div>
        ` : '';

      item.innerHTML = `
            ${managementControls}
            <img src="${product.imageUrl}" class="product-image">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-footer">
                    <div class="product-price">${product.price.toFixed(2)}</div>
                    <button class="add-to-cart-btn">Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</button>
                </div>
            </div>
        `;
      gridEl.appendChild(item);
    });
  }


  async function addToCart(productId, quantity = 1, variation = null) {

    const existingItem = variation ?
      shoppingCart.find(item => item.productId === productId && item.variation?.name === variation.name) :
      shoppingCart.find(item => item.productId === productId && !item.variation);

    if (existingItem) {
      existingItem.quantity += quantity;
    } else {
      const product = await db.shoppingProducts.get(productId);
      if (product) {
        shoppingCart.push({
          productId: product.id,
          quantity: quantity,
          variation: variation
        });
      }
    }
    updateCartCount();
    saveShoppingCart(); // ‰øùÂ≠òË¥≠Áâ©ËΩ¶
  }


  function updateCartItemQuantity(productId, change) {
    const itemIndex = shoppingCart.findIndex(item => item.productId === productId);
    if (itemIndex > -1) {
      shoppingCart[itemIndex].quantity += change;
      if (shoppingCart[itemIndex].quantity <= 0) {
        shoppingCart.splice(itemIndex, 1);
      }
      updateCartCount();
      renderCartItems();
      saveShoppingCart(); // ‰øùÂ≠òË¥≠Áâ©ËΩ¶
    }
  }


  function updateCartCount() {
    const totalItems = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById('cart-count').textContent = totalItems;
    document.getElementById('cart-title').textContent = `Ë¥≠Áâ©ËΩ¶(${totalItems})`;
    document.getElementById('checkout-btn').textContent = `ÁªìÁÆó(${totalItems})`;
  }


  function openCartScreen() {
    renderCartItems();
    showScreen('cart-screen');
  }



  async function renderCartItems() {
    const listEl = document.getElementById('cart-items-list');
    listEl.innerHTML = '';
    let total = 0;

    if (shoppingCart.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">Ë¥≠Áâ©ËΩ¶ÊòØÁ©∫ÁöÑÂì¶~</p>';
    } else {
      const productIds = shoppingCart.map(item => item.productId);
      const products = await db.shoppingProducts.where('id').anyOf(productIds).toArray();
      const productMap = new Map(products.map(p => [p.id, p]));

      shoppingCart.forEach(item => {
        const product = productMap.get(item.productId);
        if (product) {
          const itemEl = document.createElement('div');
          itemEl.className = 'cart-item';


          const variationHtml = item.variation ?
            `<div class="cart-item-variation" style="font-size: 12px; color: #8a8a8a; margin-top: 4px;">Ê¨æÂºè: ${item.variation.name}</div>` :
            '';

          itemEl.innerHTML = `
                            <input type="checkbox" class="cart-item-checkbox" data-id="${product.id}" checked>
                            <img src="${item.variation?.imageUrl || product.imageUrl}" class="cart-item-image">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${product.name}</div>
                                ${variationHtml}
                                <div class="cart-item-footer">
                                    <div class="cart-item-price">¬•${(item.variation?.price || product.price).toFixed(2)}</div>
                                    <div class="quantity-control">
                                        <button class="quantity-btn decrease-qty-btn" data-id="${product.id}">-</button>
                                        <span class="quantity-display">${item.quantity}</span>
                                        <button class="quantity-btn increase-qty-btn" data-id="${product.id}">+</button>
                                    </div>
                                </div>
                            </div>
                        `;
          listEl.appendChild(itemEl);
        }
      });
    }
    updateCartTotal();
  }



  async function updateCartTotal() {
    let total = 0;
    const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked');
    const selectedProductIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));

    if (selectedProductIds.length > 0) {
      const products = await db.shoppingProducts.where('id').anyOf(selectedProductIds).toArray();
      const productMap = new Map(products.map(p => [p.id, p]));

      shoppingCart.forEach(cartItem => {
        if (selectedProductIds.includes(cartItem.productId)) {
          const product = productMap.get(cartItem.productId);
          if (product) {

            const price = cartItem.variation ? cartItem.variation.price : product.price;
            total += price * cartItem.quantity;
          }
        }
      });
    }
    document.getElementById('cart-total').textContent = `ÂêàËÆ°: ¬•${total.toFixed(2)}`;
  }


  async function openGiftRecipientPicker() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.isGroup) return;

    const modal = document.getElementById('gift-recipient-modal');
    const listEl = document.getElementById('gift-recipient-list');
    listEl.innerHTML = '';


    const myNickname = chat.settings.myNickname || 'Êàë';
    const members = chat.members.filter(m => m.groupNickname !== myNickname);

    members.forEach(member => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';

      item.dataset.recipientName = member.originalName;

      item.innerHTML = `
                    <div class="checkbox"></div>
                    <img src="${member.avatar || defaultGroupMemberAvatar}" class="avatar">
                    <span class="name">${member.groupNickname}</span>
                `;
      listEl.appendChild(item);
    });


    document.getElementById('select-all-recipients').checked = false;
    modal.classList.add('visible');
  }


  // --- ‰øÆÂ§çÁâàV2ÔºöË¥≠Áâ©ÁªìÁÆó (‰øÆÂ§çIDËß£ÊûêbugÔºåÁ°Æ‰øùÊâ£Ê¨æÂíåËÆ∞Ë¥¶) ---
  async function handleCheckout() {
    const chat = state.chats[state.activeChatId];
    const selectedItems = shoppingCart.filter(item =>
      document.querySelector(`.cart-item-checkbox[data-id="${item.productId}"]:checked`)
    );

    if (selectedItems.length === 0) {
      alert("ËØ∑ÂÖàÂú®Ë¥≠Áâ©ËΩ¶‰∏≠ÈÄâÊã©Ë¶ÅÁªìÁÆóÁöÑÂïÜÂìÅ„ÄÇ");
      return;
    }

    // ËÆ°ÁÆóÊÄª‰ª∑
    const productIds = selectedItems.map(item => item.productId);
    const products = await db.shoppingProducts.where('id').anyOf(productIds).toArray();
    const productMap = new Map(products.map(p => [p.id, p]));

    let totalCost = 0;
    selectedItems.forEach(cartItem => {
      const product = productMap.get(cartItem.productId);
      if (product) {
        const price = cartItem.variation ? cartItem.variation.price : product.price;
        totalCost += price * cartItem.quantity;
      }
    });

    // 1. ÂáÜÂ§áÊîØ‰ªòÈÄâÈ°π
    const wallet = await db.userWallet.get('main') || { balance: 0, kinshipCards: [] };
    const balance = wallet.balance || 0;
    const kinshipCards = wallet.kinshipCards || [];

    const iconWallet = `<div class="pay-opt-icon" style="background:#1677ff; display:flex; align-items:center; justify-content:center; color:white; font-size:14px; border-radius:4px;">ÊîØ</div>`;
    const iconKinship = `<div class="pay-opt-icon" style="background:linear-gradient(135deg, #ff5252, #ff1744); display:flex; align-items:center; justify-content:center; color:white; font-size:14px; border-radius:4px;">‰∫≤</div>`;

    const paymentOptions = [];

    if (balance >= totalCost) {
      paymentOptions.push({
        text: `<div class="pay-opt-left">${iconWallet}<div class="pay-opt-info"><span class="pay-opt-title">Ë¥¶Êà∑‰ΩôÈ¢ù</span><span class="pay-opt-desc">Ââ©‰Ωô ¬•${balance.toFixed(2)}</span></div></div>`,
        value: 'balance'
      });
    }

    kinshipCards.forEach(card => {
      const providerChat = state.chats[card.chatId];
      const name = providerChat ? providerChat.name : 'Êú™Áü•';
      const remaining = card.limit - (card.spent || 0);

      if (remaining >= totalCost) {
        paymentOptions.push({
          text: `<div class="pay-opt-left">${iconKinship}<div class="pay-opt-info"><span class="pay-opt-title">‰∫≤Â±ûÂç° - ${name}</span><span class="pay-opt-desc">Ââ©‰ΩôÈ¢ùÂ∫¶ ¬•${remaining.toFixed(2)}</span></div></div>`,
          value: `kinship_${card.chatId}`
        });
      }
    });

    if (paymentOptions.length === 0) {
      await showCustomAlert('ÊîØ‰ªòÂ§±Ë¥•', `‰ΩôÈ¢ùÊàñ‰∫≤Â±ûÂç°È¢ùÂ∫¶‰∏çË∂≥ÔºÅ\nÈúÄË¶Å: ¬•${totalCost.toFixed(2)}`);
      return;
    }

    // 2. ÂºπÂá∫ÊîØ‰ªòÈÄâÊã©
    const paymentMethod = await showChoiceModal(`ÊîØ‰ªò ¬•${totalCost.toFixed(2)}`, paymentOptions);
    if (!paymentMethod) return;

    let transactionDesc = selectedItems.length === 1 ? `Ë¥≠‰π∞-${productMap.get(selectedItems[0].productId).name}` : `Ë¥≠‰π∞-${selectedItems.length}‰ª∂ÂïÜÂìÅ`;

    // 3. ÊâßË°åÊâ£Ê¨æÂíåËÆ∞Ë¥¶
    if (paymentMethod === 'balance') {
      const success = await processTransaction(totalCost, 'expense', transactionDesc);
      if (!success) return;
    } else if (paymentMethod.startsWith('kinship_')) {
      const cardChatId = paymentMethod.replace('kinship_', '');
      const cardIndex = wallet.kinshipCards.findIndex(c => c.chatId === cardChatId);

      if (cardIndex > -1) {
        // A. Êâ£È¢ùÂ∫¶
        wallet.kinshipCards[cardIndex].spent = (wallet.kinshipCards[cardIndex].spent || 0) + totalCost;
        await db.userWallet.put(wallet);

        // B. ËÆ∞Ë¥¶
        await db.userTransactions.add({
          timestamp: Date.now(),
          type: 'expense',
          amount: totalCost,
          description: `‰∫≤Â±ûÂç°-${transactionDesc}`
        });

        // C. ÈÄöÁü•Èáë‰∏ª (ÁîüÊàêÂèØËßÅÁöÑÁ≥ªÁªüÈÄöÁü•ÔºåÊñπ‰æøÂà†Èô§)
        const providerChat = state.chats[cardChatId];
        if (providerChat) {
          const itemNames = selectedItems.map(i => productMap.get(i.productId).name).join('„ÄÅ');
          const remaining = wallet.kinshipCards[cardIndex].limit - wallet.kinshipCards[cardIndex].spent;

          const notifyMsg = {
            role: 'system',
            type: 'pat_message', // „Äê‰øÆÊîπ„Äë‰ΩøÁî®ÁÅ∞Ëâ≤Á≥ªÁªüÊ∂àÊÅØÊ†∑Âºè
            content: `‰Ω†‰ΩøÁî®‰∫≤Â±ûÂç°Ê∂àË¥π ¬•${totalCost.toFixed(2)} Ë¥≠‰π∞‰∫ÜÔºö${itemNames} (‰Ωô ¬•${remaining.toFixed(2)})`,
            timestamp: Date.now()
            // „Äê‰øÆÊîπ„ÄëÁßªÈô§ isHidden: trueÔºå‰ΩøÂÖ∂ÂèØËßÅ
          };
          providerChat.history.push(notifyMsg);
          await db.chats.put(providerChat);

          // Â¶ÇÊûúÂΩìÂâçÂ∞±Âú®ËØ•ËÅäÂ§©ÔºåÁ´ãÂç≥ÊòæÁ§∫
          if (state.activeChatId === cardChatId) {
            appendMessage(notifyMsg, providerChat);
          }
        }
      } else {
        alert("Á≥ªÁªüÈîôËØØÔºöÊâæ‰∏çÂà∞ÂØπÂ∫îÁöÑ‰∫≤Â±ûÂç°ËÆ∞ÂΩïÔºåÊîØ‰ªòÂèñÊ∂à„ÄÇ");
        return;
      }
    }

    // 4. ÂêéÁª≠ÈÄªËæëÔºöÈÄâÊã©Áî®ÈÄî (ÈÄÅÁ§º vs Ëá™Áî®)
    if (chat.isGroup) {
      // Áæ§ËÅäÈÄªËæë‰øùÊåÅ‰∏çÂèòÔºöÈÄâÊã©Áæ§ÂèãËµ†ÈÄÅ
      openGiftRecipientPicker();
    } else {
      // ÂçïËÅäÈÄªËæëÔºöÂ¢ûÂä†ÈÄâÊã©ÂºπÁ™ó
      const usageChoice = await showChoiceModal('Ë¥≠‰π∞ÊàêÂäüÔºÅËØ∑ÈÄâÊã©Áî®ÈÄî', [
        { text: 'üéÅ ÈÄÅÁªô TA', value: 'gift' },
        { text: 'üõçÔ∏è ÁïôÁªôËá™Â∑±', value: 'self' }
      ]);

      if (usageChoice === 'gift') {
        // ÈÄÅÁ§ºÊµÅÁ®ã (sendGiftMessage ÂÜÖÈÉ®‰ºöÂ§ÑÁêÜË¥≠Áâ©ËΩ¶Ê∏ÖÁêÜÂíåË∑≥ËΩ¨)
        await sendGiftMessage(selectedItems);
      } else {
        // Ëá™Áî®ÊµÅÁ®ã
        // 1. ‰ªéË¥≠Áâ©ËΩ¶ÁßªÈô§ÂïÜÂìÅ
        shoppingCart = shoppingCart.filter(item => !selectedItems.some(sent => sent.productId === item.productId));
        updateCartCount();
        saveShoppingCart(); // ‰øùÂ≠òË¥≠Áâ©ËΩ¶

        // 2. Â¶ÇÊûúÊòØ‰ΩôÈ¢ùÊîØ‰ªòÔºå‰πüË°•‰∏ÄÊù°ÂèØËßÅÈÄöÁü• (‰∫≤Â±ûÂç°ÂàöÊâçÂ∑≤ÁªèÂèëËøá‰∫Ü)
        if (paymentMethod === 'balance') {
          const itemNames = selectedItems.map(i => productMap.get(i.productId).name).join('„ÄÅ');
          const selfBuyMsg = {
            role: 'system',
            type: 'pat_message',
            content: `‰Ω†Ë¥≠‰π∞‰∫ÜÔºö${itemNames}`,
            timestamp: Date.now()
          };
          chat.history.push(selfBuyMsg);
          await db.chats.put(chat);
        }

        // 3. ËøîÂõûËÅäÂ§©ÁïåÈù¢
        showScreen('chat-interface-screen');
        // Â¶ÇÊûúÂàöÊâçÊúâÊñ∞Ê∂àÊÅØÊé®ÂÖ•Ôºà‰ΩôÈ¢ùÊîØ‰ªòÈÄöÁü•ÔºâÔºåÂà∑Êñ∞‰∏Ä‰∏ãÁïåÈù¢
        if (paymentMethod === 'balance') {
          renderChatInterface(state.activeChatId);
        }
      }
    }
  }


  async function sendGiftMessage(itemsToSend, recipients = null) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];

    const productIds = itemsToSend.map(item => item.productId);
    const products = await db.shoppingProducts.where('id').anyOf(productIds).toArray();
    const productMap = new Map(products.map(p => [p.id, p]));

    const itemsForMessage = itemsToSend.map(cartItem => {
      const product = productMap.get(cartItem.productId);
      if (cartItem.variation) {

        return {
          name: `${product.name} - ${cartItem.variation.name}`,
          price: cartItem.variation.price,
          imageUrl: cartItem.variation.imageUrl || product.imageUrl,
          quantity: cartItem.quantity
        };
      } else {

        return {
          name: product.name,
          price: product.price,
          imageUrl: product.imageUrl,
          quantity: cartItem.quantity
        };
      }
    });
    const giftMessage = {
      role: 'user',
      type: 'gift',
      timestamp: Date.now(),
      items: itemsForMessage,
      total: itemsForMessage.reduce((sum, item) => sum + item.price * item.quantity, 0),
      recipients: recipients
    };

    chat.history.push(giftMessage);


    if (recipients && recipients.length > 0) {
      const recipientDisplayNames = recipients.map(originalName => getDisplayNameInGroup(chat, originalName)).join('„ÄÅ');
      const hiddenMessage = {
        role: 'system',
        content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${chat.settings.myNickname || 'Êàë'}) ÈÄÅÂá∫‰∫Ü‰∏Ä‰ªΩÁ§ºÁâ©ÔºåÊî∂Á§º‰∫∫ÊòØÔºö${recipientDisplayNames}„ÄÇËØ∑Êî∂Á§ºÁöÑËßíËâ≤Ë°®Á§∫ÊÑüË∞¢ÔºåÂÖ∂‰ªñËßíËâ≤ÂèØ‰ª•Ëá™Áî±ÂèëÊå•„ÄÇ]`,
        timestamp: Date.now() + 1,
        isHidden: true
      };
      chat.history.push(hiddenMessage);
    }

    await db.chats.put(chat);

    appendMessage(giftMessage, chat);
    renderChatList();


    shoppingCart = shoppingCart.filter(item => !itemsToSend.some(sent => sent.productId === item.productId));
    updateCartCount();
    saveShoppingCart(); // ‰øùÂ≠òË¥≠Áâ©ËΩ¶
    showScreen('chat-interface-screen');

    await showCustomAlert('ÊàêÂäü', 'Á§ºÁâ©Â∑≤ÊàêÂäüÈÄÅÂá∫ÔºÅ');
  }


  function showGiftReceipt(timestamp) {

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'gift') return;
    const receiptBody = document.getElementById('gift-receipt-body');
    let itemsHtml = '';
    message.items.forEach(item => {
      itemsHtml += `<tr><td class="item-name">${item.name}</td><td class="item-qty">${item.quantity}</td><td class="item-price">¬•${item.price.toFixed(2)}</td><td class="item-subtotal">¬•${(item.price * item.quantity).toFixed(2)}</td></tr>`;
    });
    receiptBody.innerHTML = `<div class="receipt-header"><h3>Ë¥≠Áâ©‰∏≠ÂøÉ</h3><p>‰∫§ÊòìÊó∂Èó¥: ${new Date(message.timestamp).toLocaleString()}</p></div><table class="receipt-items-table"><thead><tr><th class="item-name">ÂïÜÂìÅ</th><th class="item-qty">Êï∞Èáè</th><th class="item-price">Âçï‰ª∑</th><th class="item-subtotal">Â∞èËÆ°</th></tr></thead><tbody>${itemsHtml}</tbody></table><div class="receipt-total">ÊÄªËÆ°: ¬•${message.total.toFixed(2)}</div><div class="receipt-footer">ÊÑüË∞¢ÊÇ®ÁöÑÊÉ†È°æÔºåÊ¨¢ËøéÂÜçÊ¨°ÂÖâ‰∏¥ÔºÅ</div>`;
    document.getElementById('gift-receipt-modal').classList.add('visible');
  }


  async function openProductEditor(productId = null) {
    editingProductId = productId;
    const modal = document.getElementById('product-editor-modal');
    const title = document.getElementById('product-editor-title');
    const nameInput = document.getElementById('product-name-input');
    const priceInput = document.getElementById('product-price-input');
    const descInput = document.getElementById('product-description-input');
    const imagePreview = document.getElementById('product-image-preview');
    const categorySelect = document.getElementById('product-category-select');
    const variationsContainer = document.getElementById('product-variations-container');


    variationsContainer.innerHTML = '';


    categorySelect.innerHTML = '<option value="">-- Êú™ÂàÜÁ±ª --</option>';
    const categories = await db.shoppingCategories.toArray();
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat.id;
      option.textContent = cat.name;
      categorySelect.appendChild(option);
    });

    if (productId) {
      title.textContent = 'ÁºñËæëÂïÜÂìÅ';
      const product = await db.shoppingProducts.get(productId);
      nameInput.value = product.name;
      priceInput.value = product.price;
      descInput.value = product.description || '';
      imagePreview.src = product.imageUrl;
      categorySelect.value = product.categoryId || '';


      if (product.variations && product.variations.length > 0) {
        product.variations.forEach(v => addProductVariationInput(v));
      }

    } else {
      title.textContent = 'Ê∑ªÂä†ÂïÜÂìÅ';
      nameInput.value = '';
      priceInput.value = '';
      descInput.value = '';
      imagePreview.src = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756206115802_qdqqd_0c99bh.jpeg';
      categorySelect.value = '';
    }
    modal.classList.add('visible');
  }
  async function saveProduct() {
    const name = document.getElementById('product-name-input').value.trim();
    const price = parseFloat(document.getElementById('product-price-input').value);
    const description = document.getElementById('product-description-input').value.trim();
    const imageUrl = document.getElementById('product-image-preview').src;
    const categoryId = parseInt(document.getElementById('product-category-select').value) || null;

    if (!name) {
      alert('ÂïÜÂìÅÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      return;
    }
    if (isNaN(price) || price < 0) {
      alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈªòËÆ§‰ª∑Ê†ºÔºÅ');
      return;
    }


    const variations = [];
    document.querySelectorAll('.variation-block').forEach(block => {
      const varName = block.querySelector('.variation-name-input').value.trim();
      const varPrice = parseFloat(block.querySelector('.variation-price-input').value);
      const varImageUrl = block.querySelector('.variation-image-preview').src;

      if (varName && !isNaN(varPrice) && varPrice >= 0) {
        variations.push({
          name: varName,
          price: varPrice,
          imageUrl: varImageUrl.includes('placeholder.png') ? null : varImageUrl
        });
      }
    });

    const productData = {
      name,
      price,
      description,
      imageUrl,
      categoryId,
      variations
    };

    if (editingProductId) {
      await db.shoppingProducts.update(editingProductId, productData);
    } else {
      await db.shoppingProducts.add(productData);
    }
    document.getElementById('product-editor-modal').classList.remove('visible');
    await renderShoppingProducts();
  }










  async function openRenderingRulesScreen() {
    await renderRulesList();
    showScreen('rendering-rules-screen');
  }




  async function renderRulesList() {
    const tabsContainer = document.getElementById('rules-tabs');
    const contentContainer = document.getElementById('rules-content-container');
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    const allRules = await db.renderingRules.toArray();

    if (allRules.length === 0) {
      contentContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">ËøòÊ≤°Êúâ‰ªª‰ΩïÊ∏≤ÊüìËßÑÂàô„ÄÇÁÇπÂáªÂè≥‰∏äËßí‚Äú+‚ÄùÂàõÂª∫Á¨¨‰∏Ä‰∏™ÂêßÔºÅ</p>';
      return;
    }

    // 1. ÂàõÂª∫‚ÄúÂÖ¨Áî®ËßÑÂàô‚Äù Tab
    const globalTab = document.createElement('button');
    globalTab.className = 'rules-tab active';
    globalTab.textContent = 'ÂÖ¨Áî®ËßÑÂàô';
    globalTab.dataset.categoryId = 'global';
    tabsContainer.appendChild(globalTab);

    const globalPane = document.createElement('div');
    globalPane.className = 'rules-category-pane active';
    globalPane.dataset.categoryId = 'global';
    contentContainer.appendChild(globalPane);

    // 2. ‰∏∫ÊØè‰∏™ËßíËâ≤ÂàõÂª∫ Tab
    // ÊâæÂá∫ÊâÄÊúâËá≥Â∞ëÊúâ‰∏ÄÊù°ËßÑÂàôÂÖ≥ËÅîÁöÑËßíËâ≤ÔºåÊàñËÄÖÂàóÂá∫ÊâÄÊúâÂçïËÅäËßíËâ≤
    const characterChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    characterChats.forEach(chat => {
      const charTab = document.createElement('button');
      charTab.className = 'rules-tab';
      charTab.textContent = chat.name;
      charTab.dataset.categoryId = chat.id;
      tabsContainer.appendChild(charTab);

      const charPane = document.createElement('div');
      charPane.className = 'rules-category-pane';
      charPane.dataset.categoryId = chat.id;
      contentContainer.appendChild(charPane);
    });

    // 3. ÂàÜÂèëËßÑÂàôÂç°ÁâáÂà∞ÂêÑ‰∏™ Pane
    allRules.forEach(rule => {
      const card = createRuleItemElement(rule);

      // ÂÖºÂÆπÂ§ÑÁêÜÔºöÊ†áÂáÜÂåñ scope ‰∏∫Êï∞ÁªÑ
      const scope = Array.isArray(rule.chatId) ? rule.chatId : [rule.chatId];

      scope.forEach(targetId => {
        // ÊâæÂà∞ÂØπÂ∫îÁöÑ Pane
        const targetPane = contentContainer.querySelector(`.rules-category-pane[data-category-id="${targetId}"]`);

        if (targetPane) {
          // ÂÖãÈöÜÂç°ÁâáÔºàÂõ†‰∏∫Âêå‰∏Ä‰∏™ËßÑÂàôÂèØËÉΩË¶ÅÊòæÁ§∫Âú®Â§ö‰∏™TabÈáåÔºâ
          // Ê≥®ÊÑèÔºöcreateRuleItemElement ËøîÂõûÁöÑÊòØÂ∏¶‰∫ã‰ª∂ÁöÑ DOMÔºåÁõ¥Êé• appendChild ‰ºöÁßªÂä®ÂÆÉËÄå‰∏çÊòØÂ§çÂà∂
          // ÊâÄ‰ª•Êàë‰ª¨ÊúÄÂ•ΩÊØèÊ¨°ÈÉΩÂàõÂª∫Êñ∞ÁöÑ DOMÔºåÊàñËÄÖ‰ΩøÁî® cloneNode(true) Âπ∂ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
          // ËøôÈáå‰∏∫‰∫ÜÁÆÄÂçï‰∏î‰∫ã‰ª∂ÁªëÂÆöÊ≠£Á°ÆÔºåÊàë‰ª¨Áõ¥Êé•Â§çÁî® createRuleItemElement ÈÄªËæëÂ§öÊ¨°
          const cardCopy = createRuleItemElement(rule);
          targetPane.appendChild(cardCopy);
        }
      });
    });

    // 4. ÁªëÂÆö Tab ÂàáÊç¢‰∫ã‰ª∂
    document.querySelectorAll('.rules-tab').forEach(tab => {
      tab.addEventListener('click', () => switchRuleCategory(tab.dataset.categoryId));
    });
  }





  function createRuleItemElement(rule) {
    const card = document.createElement('div');
    // Âä®ÊÄÅÊ∑ªÂä† selected Á±ª
    const isSelected = selectedRules.has(rule.id);

    card.className = `rule-card ${rule.isEnabled ? 'enabled' : ''} ${isSelected ? 'selected' : ''}`;
    card.dataset.ruleId = rule.id;

    // Âä†ÂÖ• checkbox
    card.innerHTML = `
        <input type="checkbox" class="rule-select-checkbox" ${isSelected ? 'checked' : ''}>
        <div class="card-title">${rule.name}</div>
        <div class="card-content-preview">${escapeHTML(rule.regex)}</div>
    `;

    // ÁÇπÂáª‰∫ã‰ª∂ÂàÜÊµÅ
    card.addEventListener('click', (e) => {
      // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂ§çÈÄâÊ°ÜÔºåÈòªÊ≠¢ÂÜíÊ≥°ÔºåÁî±‰∏ãÈù¢Â§ÑÁêÜ
      if (e.target.classList.contains('rule-select-checkbox')) {
        e.stopPropagation();
        toggleRuleSelection(rule.id);
        return;
      }

      if (isRuleManagementMode) {
        // ÁÆ°ÁêÜÊ®°Âºè‰∏ãÔºöÁÇπÂáªÂç°Áâá‰ªªÊÑè‰ΩçÁΩÆÈÉΩËßÜ‰∏∫ÂàáÊç¢ÈÄâ‰∏≠
        toggleRuleSelection(rule.id);
      } else {
        // ÊôÆÈÄöÊ®°ÂºèÔºöÊâìÂºÄÁºñËæëÂô®
        openRuleEditor(rule.id);
      }
    });

    // ÈïøÊåâËøõÂÖ•ÁÆ°ÁêÜÊ®°Âºè (ÂèØÈÄâ‰ΩìÈ™å‰ºòÂåñ)
    addLongPressListener(card, () => {
      if (!isRuleManagementMode) {
        toggleRuleManagementMode();
        toggleRuleSelection(rule.id);
      }
    });

    return card;
  }

  // ÂàáÊç¢ÁÆ°ÁêÜÊ®°Âºè
  // ÂàáÊç¢ÁÆ°ÁêÜÊ®°Âºè
  function toggleRuleManagementMode() {
    isRuleManagementMode = !isRuleManagementMode;
    const container = document.getElementById('rules-content-container');
    const actionBar = document.getElementById('rules-action-bar');
    const manageBtn = document.getElementById('manage-rules-btn');

    // ÂÆö‰πâ‰∏§‰∏™ÂõæÊ†áÁöÑ SVG Â≠óÁ¨¶‰∏≤
    const manageIconSVG = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            <polyline points="9 11 12 14 22 4"></polyline>
        </svg>`;

    // ‰Ω†ÂèØ‰ª•ÈÄâÊã©Áî®‰∏Ä‰∏™‚ÄúÂØπÂãæ‚ÄùÂõæÊ†áË°®Á§∫ÂÆåÊàêÔºåÊàñËÄÖÁõ¥Êé•Áî®ÊñáÂ≠ó‚ÄúÂÆåÊàê‚Äù
    // ËøôÈáåÊàë‰∏∫‰∫ÜÈ£éÊ†ºÁªü‰∏ÄÔºåÁî®‰∏Ä‰∏™ÂØπÂãæÂõæÊ†á‰ª£Êõø‚ÄúÂÆåÊàê‚ÄùÊñáÂ≠ó
    const doneIconSVG = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-color);">
             <polyline points="20 6 9 17 4 12"></polyline>
        </svg>`;


    if (isRuleManagementMode) {
      container.classList.add('management-mode');
      actionBar.style.display = 'flex';


      manageBtn.innerHTML = doneIconSVG; // Êñ∞‰ª£Á†ÅÔºöÂàáÊç¢‰∏∫ÂÆåÊàêÂõæÊ†á


      // manageBtn.style.color = 'var(--accent-color)'; // ÂõæÊ†áËá™Â∏¶È¢úËâ≤‰∫ÜÔºåËøôË°åÂèØ‰ª•Ê≥®ÈáäÊéâ
    } else {
      container.classList.remove('management-mode');
      actionBar.style.display = 'none';


      manageBtn.innerHTML = manageIconSVG; // Êñ∞‰ª£Á†ÅÔºöÂàáÊç¢ÂõûÁÆ°ÁêÜÂõæÊ†á


      manageBtn.style.color = '';

      // ÈÄÄÂá∫Êó∂Ê∏ÖÁ©∫ÈÄâ‰∏≠
      selectedRules.clear();
      updateRuleActionBar();
      renderRulesList(); // ÈáçÊñ∞Ê∏≤Êüì‰ª•ÂéªÈô§ÈÄâ‰∏≠Ê†∑Âºè
    }

    // ÈáçÊñ∞Ê∏≤Êüì‰ª•ÊòæÁ§∫/ÈöêËóèÂ§çÈÄâÊ°Ü
    renderRulesList();
  }

  // ÂàáÊç¢Âçï‰∏™ÈÄâ‰∏≠Áä∂ÊÄÅ
  function toggleRuleSelection(ruleId) {
    if (selectedRules.has(ruleId)) {
      selectedRules.delete(ruleId);
    } else {
      selectedRules.add(ruleId);
    }
    updateRuleActionBar();

    // Êõ¥Êñ∞ DOM Ê†∑Âºè (‰∏çÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ÂàóË°®ÔºåÊèêÈ´òÊÄßËÉΩ)
    // Âõ†‰∏∫Âêå‰∏Ä‰∏™ËßÑÂàôÂèØËÉΩÂú®Â§ö‰∏™TabÊòæÁ§∫ÔºåÊâÄ‰ª•Áî® querySelectorAll
    const cards = document.querySelectorAll(`.rule-card[data-rule-id="${ruleId}"]`);
    cards.forEach(card => {
      const cb = card.querySelector('.rule-select-checkbox');
      if (selectedRules.has(ruleId)) {
        card.classList.add('selected');
        if (cb) cb.checked = true;
      } else {
        card.classList.remove('selected');
        if (cb) cb.checked = false;
      }
    });
  }

  // Êõ¥Êñ∞Â∫ïÈÉ®ÊåâÈíÆÁä∂ÊÄÅ
  function updateRuleActionBar() {
    const count = selectedRules.size;
    const exportBtn = document.getElementById('export-selected-rules-btn');
    const deleteBtn = document.getElementById('delete-selected-rules-btn');

    exportBtn.textContent = `ÂØºÂá∫ (${count})`;
    deleteBtn.textContent = `Âà†Èô§ (${count})`;

    // ÂèØ‰ª•Âú®ËøôÈáåÂä† disable ÈÄªËæë
  }

  // ÂÖ®ÈÄâ/ÂèçÈÄâ
  function handleSelectAllRules() {
    const isChecked = document.getElementById('select-all-rules-checkbox').checked;
    const visibleCards = document.querySelectorAll('#rules-content-container .rule-card');

    visibleCards.forEach(card => {
      const id = parseInt(card.dataset.ruleId);
      if (isChecked) {
        selectedRules.add(id);
      } else {
        selectedRules.delete(id);
      }
    });

    updateRuleActionBar();
    renderRulesList(); // ÁÆÄÂçïÊö¥ÂäõÈáçÁªòÊõ¥Êñ∞UI
  }
  // ÂØºÂá∫ÈÄâ‰∏≠ÁöÑËßÑÂàô
  async function exportSelectedRules() {
    if (selectedRules.size === 0) {
      alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂØºÂá∫ÁöÑËßÑÂàô„ÄÇ");
      return;
    }

    const rules = await db.renderingRules.where('id').anyOf([...selectedRules]).toArray();

    // ÊûÑÂª∫ÂØºÂá∫Êï∞ÊçÆÁªìÊûÑ
    const exportData = {
      type: 'EPhoneRenderingRules', // Ê†áËÆ∞Êñá‰ª∂Á±ªÂûã
      version: 1,
      timestamp: Date.now(),
      rules: rules.map(r => ({
        name: r.name,
        regex: r.regex,
        template: r.template,
        // ÂØºÂá∫Êó∂ÔºåÂª∫ËÆÆÊää chatId ÈáçÁΩÆ‰∏∫ ['global'] ÊàñËÄÖÁ©∫ÔºåÂõ†‰∏∫Êé•Êî∂ËÄÖÊ≤°ÊúâÂØπÂ∫îÁöÑËßíËâ≤ID
        // ‰ΩÜ‰∏∫‰∫ÜÁÅµÊ¥ªÔºåÊàë‰ª¨ÂèØ‰ª•‰øùÁïôÔºåËÆ©Áî®Êà∑ÂØºÂÖ•ÂêéËá™Â∑±Êîπ
        chatId: ['global'],
        isEnabled: true,
        doNotSend: r.doNotSend
      }))
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    const dateStr = new Date().toISOString().split('T')[0];
    link.download = `RenderingRules_Share_${dateStr}.json`;
    link.click();
    URL.revokeObjectURL(url);

    toggleRuleManagementMode(); // ÂØºÂá∫ÂêéÈÄÄÂá∫ÁÆ°ÁêÜÊ®°Âºè
    await showCustomAlert("ÂØºÂá∫ÊàêÂäü", `Â∑≤ÂØºÂá∫ ${rules.length} Êù°ËßÑÂàô„ÄÇ\n\nÊ≥®ÊÑèÔºö‰∏∫‰∫ÜÊñπ‰æøÂàÜ‰∫´ÔºåÂØºÂá∫ÁöÑËßÑÂàôÂ∑≤Ëá™Âä®ËÆæ‰∏∫‚ÄúÂÖ¨Áî®‚ÄùËåÉÂõ¥„ÄÇ`);
  }

  // Â§ÑÁêÜÊñá‰ª∂ÂØºÂÖ•
  async function handleRulesImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const data = JSON.parse(text);

      if (data.type !== 'EPhoneRenderingRules' || !Array.isArray(data.rules)) {
        throw new Error("Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºå‰∏çÊòØÊúâÊïàÁöÑÊ∏≤ÊüìËßÑÂàôÂàÜ‰∫´Êñá‰ª∂„ÄÇ");
      }

      const confirmed = await showCustomConfirm(
        "ÂØºÂÖ•ËßÑÂàô",
        `ÂèëÁé∞ ${data.rules.length} Êù°Ê∏≤ÊüìËßÑÂàô„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÂØºÂÖ•ÂêóÔºü`,
        { confirmText: "ÂØºÂÖ•" }
      );

      if (confirmed) {
        let addedCount = 0;
        // ÈÅçÂéÜÂπ∂Ê∑ªÂä†ÔºåÁîüÊàêÊñ∞ID
        for (const rule of data.rules) {
          // ÁÆÄÂçïÁöÑÈò≤ÈáçÂ§çÊ£ÄÊü• (ÂèØÈÄâÔºöÂ¶ÇÊûúÂêçÂ≠óÂíåÊ≠£ÂàôÂÆåÂÖ®‰∏ÄÊ†∑ÂàôË∑≥Ëøá)
          // ËøôÈáåÁõ¥Êé•Ê∑ªÂä†ÔºåÂπ∂Âú®ÂêçÂ≠óÂêéÂä† (Imported) ‰ª•Á§∫Âå∫ÂàÜ
          await db.renderingRules.add({
            name: rule.name + " (ÂØºÂÖ•)",
            chatId: rule.chatId || ['global'],
            regex: rule.regex,
            template: rule.template,
            isEnabled: true,
            doNotSend: rule.doNotSend || false
          });
          addedCount++;
        }

        // Âà∑Êñ∞
        ruleCache = {}; // Ê∏ÖÁ©∫Ê∏≤ÊüìÁºìÂ≠ò
        await renderRulesList();
        await showCustomAlert("ÊàêÂäü", `Â∑≤ÊàêÂäüÂØºÂÖ• ${addedCount} Êù°ËßÑÂàôÔºÅ`);
      }

    } catch (error) {
      console.error(error);
      alert("ÂØºÂÖ•Â§±Ë¥•: " + error.message);
    } finally {
      event.target.value = null; // ÈáçÁΩÆ input
    }
  }

  // ÊâπÈáèÂà†Èô§
  async function deleteSelectedRules() {
    if (selectedRules.size === 0) return;

    const confirmed = await showCustomConfirm(
      "Á°ÆËÆ§Âà†Èô§",
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedRules.size} Êù°ËßÑÂàôÂêóÔºü`,
      { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
      await db.renderingRules.bulkDelete([...selectedRules]);
      ruleCache = {}; // Ê∏ÖÁ©∫ÁºìÂ≠ò
      selectedRules.clear();

      // Âà∑Êñ∞
      toggleRuleManagementMode(); // ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°ÂºèÂπ∂Âà∑Êñ∞
    }
  }

  async function openRuleEditor(ruleId = null) {
    editingRuleId = ruleId;
    const modal = document.getElementById('rule-editor-modal');
    const title = document.getElementById('rule-editor-title');
    const nameInput = document.getElementById('rule-name-input');
    // const chatIdSelect = document.getElementById('rule-chat-id-select'); // ÊóßÁöÑ select ‰∏çÁî®‰∫Ü

    // 1. Ëé∑ÂèñÊàñÂàõÂª∫Â§çÈÄâÊ°ÜÂÆπÂô® (Â¶ÇÊûúHTMLÈáåÊ≤°ÊúâËøô‰∏™ÂÆπÂô®ÔºåÊàë‰ª¨ÈúÄË¶ÅÂä®ÊÄÅÂ§ÑÁêÜ)
    let scopeContainer = document.getElementById('rule-scope-checkboxes');
    if (!scopeContainer) {
      // Â∞ùËØïÊâæÂà∞ÂéüÊù•ÁöÑ select ÊâÄÂú®ÁöÑÁà∂Á∫ßÊàñ‰ΩçÁΩÆÔºåÊõøÊç¢ÂÆÉ
      const oldSelect = document.getElementById('rule-chat-id-select');
      if (oldSelect) {
        scopeContainer = document.createElement('div');
        scopeContainer.id = 'rule-scope-checkboxes';
        scopeContainer.style.cssText = "max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f9f9f9;";
        oldSelect.parentNode.insertBefore(scopeContainer, oldSelect);
        oldSelect.style.display = 'none'; // ÈöêËóèÊóßÁöÑselect
      }
    }

    const regexInput = document.getElementById('rule-regex-input');
    const templateInput = document.getElementById('rule-template-input');
    const enabledSwitch = document.getElementById('rule-enabled-switch');
    const doNotSendSwitch = document.getElementById('rule-do-not-send-switch');

    // 2. ÂáÜÂ§áÁé∞ÊúâÊï∞ÊçÆ
    let currentScope = ['global']; // ÈªòËÆ§ÈÄâ‰∏≠ÂÖ¨Áî®
    let currentName = '';
    let currentRegex = '';
    let currentTemplate = '';
    let currentEnabled = true;
    let currentDoNotSend = false;

    if (ruleId) {
      title.textContent = 'ÁºñËæëËßÑÂàô';
      const rule = await db.renderingRules.get(ruleId);
      if (rule) {
        currentName = rule.name;
        currentRegex = rule.regex;
        currentTemplate = rule.template;
        currentEnabled = rule.isEnabled;
        currentDoNotSend = rule.doNotSend || false;

        // ÂÖºÂÆπÊóßÊï∞ÊçÆÔºöÂ¶ÇÊûúÊòØÂ≠óÁ¨¶‰∏≤ÔºåËΩ¨‰∏∫Êï∞ÁªÑ
        if (Array.isArray(rule.chatId)) {
          currentScope = rule.chatId;
        } else {
          currentScope = [rule.chatId];
        }
      }
    } else {
      title.textContent = 'ÂàõÂª∫Êñ∞ËßÑÂàô';
    }

    // 3. Â°´ÂÖÖË°®ÂçïÂÄº
    nameInput.value = currentName;
    regexInput.value = currentRegex;
    templateInput.value = currentTemplate;
    enabledSwitch.checked = currentEnabled;
    doNotSendSwitch.checked = currentDoNotSend;

    // 4. Ê∏≤ÊüìÂ§çÈÄâÊ°ÜÂàóË°®
    if (scopeContainer) {
      scopeContainer.innerHTML = '';

      // ËæÖÂä©ÂáΩÊï∞ÔºöÂàõÂª∫ÁæéÂåñÁöÑÂàóË°®È°π
      const createScopeItem = (value, name, desc, avatarUrl = null, isChecked = false) => {
        const item = document.createElement('div');
        item.className = 'rule-scope-item';

        // 1. Â∑¶‰æßËßÜËßâÂÖÉÁ¥† (Â§¥ÂÉèÊàñÂõæÊ†á)
        let visualHtml = '';
        if (value === 'global') {
          // ÂÖ®Â±ÄÂõæÊ†á
          visualHtml = `<div class="rule-scope-icon-box">üåê</div>`;
        } else {
          // ËßíËâ≤Â§¥ÂÉè (Â¶ÇÊûúÊúâÔºåÂê¶ÂàôÁî®ÈªòËÆ§)
          const src = avatarUrl || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'; // ÈªòËÆ§Â§¥ÂÉè
          visualHtml = `<img src="${src}" class="rule-scope-avatar">`;
        }

        // 2. Â§çÈÄâÊ°Ü HTML
        const checkboxHtml = `<input type="checkbox" value="${value}" class="rule-scope-cb" ${isChecked ? 'checked' : ''}>`;

        // 3. ÁªÑË£ÖÂÜÖÂÆπ
        item.innerHTML = `
                ${checkboxHtml}
                ${visualHtml}
                <div class="rule-scope-info">
                    <span class="rule-scope-name">${name}</span>
                    ${desc ? `<span class="rule-scope-desc">${desc}</span>` : ''}
                </div>
            `;

        // 4. ÁÇπÂáªÊï¥Ë°åËß¶ÂèëÈÄâ‰∏≠ (ÊèêÂçá‰ΩìÈ™å)
        item.addEventListener('click', (e) => {
          // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØÂ§çÈÄâÊ°ÜÊú¨Ë∫´ÔºåÂ∞±ÊâãÂä®ÂàáÊç¢Â§çÈÄâÊ°ÜÁä∂ÊÄÅ
          if (e.target.type !== 'checkbox') {
            const cb = item.querySelector('input[type="checkbox"]');
            cb.checked = !cb.checked;
          }
        });

        return item;
      };

      // --- Ê∑ªÂä† "ÂÖ¨Áî®" ÈÄâÈ°π ---
      scopeContainer.appendChild(createScopeItem(
        'global',
        'ÂÖ¨Áî®ËßÑÂàô',
        'ÂØπÊâÄÊúâËßíËâ≤ÁîüÊïà',
        null,
        currentScope.includes('global')
      ));

      // --- Ê∑ªÂä† "ËßíËâ≤" ÂàóË°® ---
      const chars = Object.values(state.chats).filter(c => !c.isGroup);
      chars.forEach(chat => {
        scopeContainer.appendChild(createScopeItem(
          chat.id,
          chat.name,
          chat.settings.aiPersona ? chat.settings.aiPersona.substring(0, 15) + '...' : '', // ÊòæÁ§∫‰∏ÄÁÇπ‰∫∫ËÆæÊëòË¶Å
          chat.settings.aiAvatar,
          currentScope.includes(chat.id)
        ));
      });

      // (ÂèØÈÄâ) Â¶ÇÊûú‰Ω†Â∏åÊúõÂàóË°®Â§™ÈïøÊó∂ÊúâÊªöÂä®ÊèêÁ§∫ÔºåËøôÈáå CSS Â∑≤ÁªèÂ§ÑÁêÜ‰∫Ü max-height Âíå overflow
    }

    modal.classList.add('visible');
  }


  async function saveRenderingRule() {
    const name = document.getElementById('rule-name-input').value.trim();
    const regex = document.getElementById('rule-regex-input').value.trim();

    if (!name || !regex) {
      alert("ËßÑÂàôÂêçÁß∞ÂíåÊ≠£ÂàôË°®ËææÂºè‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
      return;
    }
    try {
      new RegExp(regex);
    } catch (e) {
      alert(`Ê≠£ÂàôË°®ËææÂºèÊ†ºÂºèÈîôËØØ: ${e.message}`);
      return;
    }

    // 1. Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËåÉÂõ¥ (Array)
    const checkboxes = document.querySelectorAll('.rule-scope-cb:checked');
    const selectedScope = Array.from(checkboxes).map(cb => cb.value);

    if (selectedScope.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÁªëÂÆöËåÉÂõ¥ÔºàÂÖ¨Áî®ÊàñÊåáÂÆöËßíËâ≤ÔºâÔºÅ");
      return;
    }

    const ruleData = {
      name: name,
      chatId: selectedScope, // Áé∞Âú®‰øùÂ≠òÁöÑÊòØÊï∞ÁªÑ ['global', 'chat_123'] Á≠â
      regex: regex,
      template: document.getElementById('rule-template-input').value,
      isEnabled: document.getElementById('rule-enabled-switch').checked,
      doNotSend: document.getElementById('rule-do-not-send-switch').checked
    };

    if (editingRuleId) {
      await db.renderingRules.update(editingRuleId, ruleData);
    } else {
      await db.renderingRules.add(ruleData);
    }

    // Ê∏ÖÁ©∫ÁºìÂ≠òÔºåÁ°Æ‰øùÁ´ãÂç≥ÁîüÊïà
    ruleCache = {};

    document.getElementById('rule-editor-modal').classList.remove('visible');
    await renderRulesList();
  }


  async function deleteRenderingRule(ruleId) {
    const confirmed = await showCustomConfirm('Âà†Èô§ËßÑÂàô', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∏≤ÊüìËßÑÂàôÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.renderingRules.delete(ruleId);
      await renderRulesList();
    }
  }

  async function filterHistoryWithDoNotSendRules(history, chatId) {
    // 0. ÂÖàËøáÊª§ÊéâÁî®Êà∑ÊâãÂä®ÊéíÈô§ÁöÑÊ∂àÊÅØ (isExcluded)
    history = history.filter(msg => !msg.isExcluded);

    // 1. Ëé∑ÂèñÊâÄÊúâËßÑÂàô
    const allRules = await db.renderingRules.toArray();

    // 2. Á≠õÈÄâÂá∫Ôºö(ÂêØÁî®‰∫ÜDoNotSend) AND (ËåÉÂõ¥ÂåÖÂê´GlobalÊàñÂΩìÂâçChatId)
    const doNotSendRules = allRules.filter(rule => {
      if (!rule.doNotSend) return false; // ÂøÖÈ°ªÊòØ DoNotSend Á±ªÂûãÁöÑ

      // ÂÖºÂÆπÂ§ÑÁêÜÔºöÁ°Æ‰øùÊòØÊï∞ÁªÑ
      const scope = Array.isArray(rule.chatId) ? rule.chatId : [rule.chatId];

      // ÂåπÈÖçËåÉÂõ¥
      return scope.includes('global') || scope.includes(chatId);
    });

    if (doNotSendRules.length === 0) {
      return history;
    }

    const modifiedHistory = history.map(msg => {
      if (typeof msg.content !== 'string' || !msg.content) {
        return msg;
      }

      const modifiedMsg = { ...msg };
      let newContent = msg.content;

      for (const rule of doNotSendRules) {
        try {
          let regex;
          const regexString = rule.regex || rule.findRegex;

          if (!regexString) continue;

          if (regexString.startsWith('/') && regexString.lastIndexOf('/') > 0) {
            const lastSlash = regexString.lastIndexOf('/');
            const pattern = regexString.substring(1, lastSlash);
            const flags = regexString.substring(lastSlash + 1);
            regex = new RegExp(pattern, flags);
          } else {
            regex = new RegExp(regexString, 'g');
          }

          if (regex.test(newContent)) {
            newContent = newContent.replace(regex, '');
            console.log(`[ÂÜÖÂÆπÊõøÊç¢] ËßÑÂàô "${rule.name}" ÂëΩ‰∏≠ (DoNotSend)„ÄÇÊ≠£Âú®ËøáÊª§...`);
          }

        } catch (e) {
          console.error(`[ËøáÊª§ËßÑÂàôÈîôËØØ] ËßÑÂàô "${rule.name}" Êó†Êïà:`, e);
        }
      }

      modifiedMsg.content = newContent;
      return modifiedMsg;
    });

    return modifiedHistory;
  }

  async function applyRenderingRules(rawContent, chatId) {
    if (!rawContent || typeof rawContent !== 'string') {
      return rawContent;
    }

    // ÁºìÂ≠òÊú∫Âà∂Êõ¥Êñ∞Ôºö‰∏çÂÜçÂü∫‰∫éÂçï‰∏ÄIDÂÅöKeyÔºåËÄåÊòØËé∑ÂèñÊâÄÊúâÂêØÁî®ÁöÑËßÑÂàôÂπ∂Âú®ÂÜÖÂ≠ò‰∏≠ÂåπÈÖç
    if (!ruleCache['active_rules_list']) {
      const allRules = await db.renderingRules.toArray();
      // ËøáÊª§Âá∫ÊâÄÊúâÂ∑≤ÂêØÁî®ÁöÑËßÑÂàô
      ruleCache['active_rules_list'] = allRules.filter(r => r.isEnabled);
    }

    const allActiveRules = ruleCache['active_rules_list'];

    // Á≠õÈÄâÂá∫ÈÄÇÁî®‰∫éÂΩìÂâç chatId ÁöÑËßÑÂàô
    const applicableRules = allActiveRules.filter(rule => {
      // ÂÖºÂÆπÂ§ÑÁêÜÔºöÁ°Æ‰øùÊòØÊï∞ÁªÑ
      const scope = Array.isArray(rule.chatId) ? rule.chatId : [rule.chatId];

      // Âà§Êñ≠ÈÄªËæëÔºöÂ¶ÇÊûúÊòØglobal ÊàñËÄÖ ÂåÖÂê´ÂΩìÂâçchatId
      return scope.includes('global') || scope.includes(chatId);
    });

    let processedContent = rawContent;

    for (const rule of applicableRules) {
      try {
        let regex;
        const regexString = rule.regex || rule.findRegex;
        const replacementString = rule.template ?? rule.replaceString;

        if (!regexString) continue;

        if (regexString.startsWith('/') && regexString.lastIndexOf('/') > 0) {
          const lastSlash = regexString.lastIndexOf('/');
          const pattern = regexString.substring(1, lastSlash);
          const flags = regexString.substring(lastSlash + 1);
          try {
            regex = new RegExp(pattern, flags);
          } catch (e) {
            regex = new RegExp(regexString, 'g');
          }
        } else {
          regex = new RegExp(regexString, 'g');
        }

        processedContent = processedContent.replace(regex, replacementString);

      } catch (e) {
        console.error(`Ê∏≤ÊüìËßÑÂàô [${rule.name}] ÊâßË°åÂá∫Èîô:`, e);
      }
    }

    return processedContent;
  }



  function formatSystemTimestamp(timestamp) {
    if (!timestamp) return '';
    const now = new Date();
    const date = new Date(timestamp);

    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const timeString = `${hours}:${minutes}`;


    if (now.toDateString() === date.toDateString()) {
      return timeString;
    }


    const yesterday = new Date();
    yesterday.setDate(now.getDate() - 1);
    if (yesterday.toDateString() === date.toDateString()) {
      return `Êò®Â§© ${timeString}`;
    }


    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');

    if (now.getFullYear() === year) {
      return `${month}Êúà${day}Êó• ${timeString}`;
    } else {
      return `${year}Âπ¥${month}Êúà${day}Êó• ${timeString}`;
    }
  }


  function createSystemTimestampElement(timestamp) {
    const wrapper = document.createElement('div');

    wrapper.className = 'message-wrapper system-pat';

    const bubble = document.createElement('div');

    bubble.className = 'message-bubble system-bubble';
    bubble.textContent = formatSystemTimestamp(timestamp);

    wrapper.appendChild(bubble);
    return wrapper;
  }



  async function handleSpectatorReroll() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !lastResponseTimestamps || lastResponseTimestamps.length === 0) {
      alert("Ê≤°ÊúâÂèØ‰æõÈáçÊñ∞ÁîüÊàêÁöÑAIÂìçÂ∫î„ÄÇ");
      return;
    }


    chat.history = chat.history.filter(msg => !lastResponseTimestamps.includes(msg.timestamp));


    await db.chats.put(chat);
    await renderChatInterface(state.activeChatId);


    triggerSpectatorGroupAiAction();
  }

  async function handleRegenerateNaiImage(timestamp, buttonElement) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const msgIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (msgIndex === -1) return;

    const message = chat.history[msgIndex];


    const originalPrompt = message.prompt;

    if (!originalPrompt) {
      await showCustomAlert("Êó†Ê≥ïÈáçÊñ∞ÁîüÊàê", "Êú™ÊâæÂà∞ËØ•ÂõæÁâáÁöÑÂéüÂßãÊèêÁ§∫ËØç(prompt)„ÄÇ");
      return;
    }


    buttonElement.disabled = true;
    buttonElement.classList.add('loading');
    const bubble = buttonElement.closest('.message-bubble');
    const imgElement = bubble ? bubble.querySelector('.realimag-image') : null;
    if (imgElement) {
      imgElement.style.opacity = '0.5';
    }

    try {

      const generatedData = await generateNaiImageFromPrompt(originalPrompt, chat.id);


      message.imageUrl = generatedData.imageUrl;
      message.fullPrompt = generatedData.fullPrompt;


      await db.chats.put(chat);

      if (imgElement) {
        imgElement.src = generatedData.imageUrl;
        imgElement.title = generatedData.fullPrompt;
        imgElement.style.opacity = '1';
      }

    } catch (error) {
      console.error("ÈáçÊñ∞ÁîüÊàêNAIÂõæÁâáÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÈáçÊñ∞ÁîüÊàêÂõæÁâá: ${error.message}`);
      if (imgElement) {
        imgElement.style.opacity = '1';
      }
    } finally {

      buttonElement.disabled = false;
      buttonElement.classList.remove('loading');
    }
  }
  async function handleSilentUploadUserImage(timestamp, buttonElement) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const msgIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (msgIndex === -1) return;

    const message = chat.history[msgIndex];
    if (!message || message.role !== 'user' || !Array.isArray(message.content) || !message.content[0]?.type === 'image_url') {
      alert("ÈîôËØØÔºöÊ∂àÊÅØÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇ");
      return;
    }

    const base64Url = message.content[0].image_url.url;
    if (!base64Url || !base64Url.startsWith('data:image')) {
      alert("ÈîôËØØÔºöËøôÂº†ÂõæÁâáÂ∑≤ÁªèÊòØURLÔºåÊàñÊï∞ÊçÆÂ∑≤ÊçüÂùè„ÄÇ");
      return;
    }

    // 1. ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    buttonElement.disabled = true;
    buttonElement.classList.add('loading');
    const bubble = buttonElement.closest('.message-bubble');
    const imgElement = bubble ? bubble.querySelector('.chat-image') : null;
    if (imgElement) imgElement.style.opacity = '0.5';

    try {
      // 2. Ë∞ÉÁî®Â∑≤ÊúâÁöÑ‰∏ä‰º†ÂáΩÊï∞ (Ê≠§ÂáΩÊï∞Âú® 1629 Ë°å)
      const newUrl = await uploadImageToImgBB(base64Url);

      if (newUrl === base64Url) {
        throw new Error("‰∏ä‰º†ÂáΩÊï∞ËøîÂõû‰∫ÜÂéüÂßãBase64ÔºåÂèØËÉΩ‰∏ä‰º†Â§±Ë¥•ÊàñË¢´Ë∑≥Ëøá„ÄÇ");
      }

      // 3. Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊ∂àÊÅØ
      message.content[0].image_url.url = newUrl; // Êõ¥Êñ∞ÁâπÂÆöÂ≠óÊÆµ
      await db.chats.put(chat);

      // 4. Êõ¥Êñ∞DOM‰∏≠ÁöÑÂõæÁâá
      if (imgElement) {
        imgElement.src = newUrl;
        imgElement.style.opacity = '1';
      }

      // 5. ÈöêËóèÊåâÈíÆ
      buttonElement.style.display = 'none';

    } catch (error) {
      console.error("ÈùôÈªò‰∏ä‰º†UserÂõæÁâáÂ§±Ë¥•:", error);
      await showCustomAlert("‰∏ä‰º†Â§±Ë¥•", `Êó†Ê≥ï‰∏ä‰º†Âà∞ ImgBB: ${error.message}`);
      if (imgElement) imgElement.style.opacity = '1';
    } finally {
      // 6. ÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ
      buttonElement.disabled = false;
      buttonElement.classList.remove('loading');
    }
  }
  async function handleSilentUploadNaiImage(timestamp, buttonElement) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const msgIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (msgIndex === -1) return;

    const message = chat.history[msgIndex];
    const base64Url = message.imageUrl;

    if (!base64Url || !base64Url.startsWith('data:image')) {
      alert("ÈîôËØØÔºöËøôÂº†ÂõæÁâáÂ∑≤ÁªèÊòØURLÔºåÊàñÊï∞ÊçÆÂ∑≤ÊçüÂùè„ÄÇ");
      return;
    }

    // 1. ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    buttonElement.disabled = true;
    buttonElement.classList.add('loading');
    const bubble = buttonElement.closest('.message-bubble');
    const imgElement = bubble ? bubble.querySelector('.realimag-image') : null;
    if (imgElement) imgElement.style.opacity = '0.5';

    try {
      // 2. Ë∞ÉÁî®Â∑≤ÊúâÁöÑ‰∏ä‰º†ÂáΩÊï∞ (Ê≠§ÂáΩÊï∞Âú® 1629 Ë°å)
      const newUrl = await uploadImageToImgBB(base64Url);

      if (newUrl === base64Url) {
        throw new Error("‰∏ä‰º†ÂáΩÊï∞ËøîÂõû‰∫ÜÂéüÂßãBase64ÔºåÂèØËÉΩ‰∏ä‰º†Â§±Ë¥•ÊàñË¢´Ë∑≥Ëøá„ÄÇ");
      }

      // 3. Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊ∂àÊÅØ
      message.imageUrl = newUrl;
      await db.chats.put(chat);

      // 4. Êõ¥Êñ∞DOM‰∏≠ÁöÑÂõæÁâá
      if (imgElement) {
        imgElement.src = newUrl;
        imgElement.style.opacity = '1';
      }

      // 5. ÈöêËóèÊåâÈíÆ
      buttonElement.style.display = 'none';

    } catch (error) {
      console.error("ÈùôÈªò‰∏ä‰º†NAIÂõæÁâáÂ§±Ë¥•:", error);
      await showCustomAlert("‰∏ä‰º†Â§±Ë¥•", `Êó†Ê≥ï‰∏ä‰º†Âà∞ ImgBB: ${error.message}`);
      if (imgElement) imgElement.style.opacity = '1';
    } finally {
      // 6. ÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ
      buttonElement.disabled = false;
      buttonElement.classList.remove('loading');
    }
  }
  async function handleRegenerateResponse() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;


    const lastUserMsgIndex = chat.history.findLastIndex(msg => msg.role === 'user' && !msg.isHidden);

    if (lastUserMsgIndex === -1) {
      alert("Ê≤°ÊúâÂèØ‰æõÈáçÊñ∞ÁîüÊàêÂõûÂ§çÁöÑÁî®Êà∑Ê∂àÊÅØ„ÄÇ");
      return;
    }


    const lastAiMsgIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');
    if (lastAiMsgIndex < lastUserMsgIndex) {
      alert("AI Â∞öÊú™ÂØπÊÇ®ÁöÑÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÂÅöÂá∫ÂõûÂ∫îÔºåÊó†Ê≥ïÈáçÊñ∞ÁîüÊàê„ÄÇ");
      return;
    }


    chat.history = chat.history.slice(0, lastUserMsgIndex + 1);


    await db.chats.put(chat);
    await renderChatInterface(state.activeChatId);


    await triggerAiResponse();
  }

  async function handleRegenerateCallResponse() {
    if (!videoCallState.isActive) return;


    const lastUserSpeechIndex = videoCallState.callHistory.findLastIndex(msg => msg.role === 'user');

    if (lastUserSpeechIndex === -1) {
      alert("ÈÄöËØù‰∏≠ËøòÊ≤°Êúâ‰Ω†ÁöÑÂèëË®ÄÔºåÊó†Ê≥ïÈáçÊñ∞ÁîüÊàêÂõûÂ∫î„ÄÇ");
      return;
    }


    videoCallState.callHistory.splice(lastUserSpeechIndex + 1);


    const callFeed = document.getElementById('video-call-main');
    callFeed.innerHTML = '';
    videoCallState.callHistory.forEach(msg => {
      const bubble = document.createElement('div');

      const speechClass = msg.role === 'assistant' ? 'ai-speech' : 'user-speech';
      bubble.className = `call-message-bubble ${speechClass}`;

      bubble.dataset.timestamp = msg.timestamp;
      if (msg.role === 'user') {
        bubble.textContent = msg.content;
      } else {
        // ÂØπ‰∫éÁæ§ËÅäÔºåmsg.content Â∑≤ÂåÖÂê´ "ËßíËâ≤Âêç: ÂÜÖÂÆπ"
        bubble.innerHTML = msg.content;
      }
      addLongPressListener(bubble, () => showCallMessageActions(msg.timestamp));
      callFeed.appendChild(bubble);
    });
    callFeed.scrollTop = callFeed.scrollHeight;


    triggerAiInCallAction(null);
  }






  async function handlePropelAction() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;


    setAvatarActingState(chat.id, true);
    const chatHeaderTitle = document.getElementById('chat-header-title');
    if (!chat.isGroup) {
      chatHeaderTitle.style.opacity = 0;
      setTimeout(() => {
        chatHeaderTitle.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...';
        chatHeaderTitle.classList.add('typing-status');
        chatHeaderTitle.style.opacity = 1;
      }, 200);
    }

    try {
      const {
        proxyUrl,
        apiKey,
        model
      } = state.apiConfig;
      if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIÊú™ÈÖçÁΩÆ');
      }

      const maxMemory = parseInt(chat.settings.maxMemory) || 10;
      const historySlice = chat.history.slice(-maxMemory);

      const now = new Date();
      const chinaTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (3600000 * 8));
      const currentTime = chinaTime.toLocaleString('zh-CN', {
        timeZone: 'Asia/Shanghai',
        dateStyle: 'full',
        timeStyle: 'short'
      });
      const timeOfDayGreeting = getTimeOfDayGreeting(chinaTime);
      const myNickname = chat.settings.myNickname || 'Êàë';




      let worldBookContent = '';
      // Ëé∑ÂèñÊâÄÊúâÂ∫îËØ•‰ΩøÁî®ÁöÑ‰∏ñÁïå‰π¶IDÔºàÂåÖÊã¨ÊâãÂä®ÈÄâÊã©ÁöÑÂíåÂÖ®Â±ÄÁöÑÔºâ
      let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
      // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
      state.worldBooks.forEach(wb => {
        if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
          allWorldBookIds.push(wb.id);
        }
      });

      if (allWorldBookIds.length > 0) {
        const linkedContents = allWorldBookIds.map(bookId => {
          const worldBook = state.worldBooks.find(wb => wb.id === bookId);
          if (!worldBook || !Array.isArray(worldBook.content)) return '';
          const formattedEntries = worldBook.content
            .filter(entry => entry.enabled !== false)
            .map(entry => {
              let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;

              entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
              return entryString;
            }).join('');
          return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
          worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ‚ÄúÁâ©ÁêÜÊ≥ïÂàô‚ÄùÂíå‚ÄúÂü∫Á°ÄÂ∏∏ËØÜ‚Äù„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
        }
      }
      let musicContext = '';
      if (musicState.isActive && musicState.activeChatId === chat.id) {
        const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
        musicContext = `\n\n# ÂΩìÂâçÈü≥‰πêÊÉÖÊôØ...\n(ÁúÅÁï•ËØ¶ÁªÜÂÜÖÂÆπÔºå‰∏étriggerAiResponse‰∏ÄËá¥)`;
      }
      const gomokuContext = formatGomokuStateForAI(gomokuState[chat.id]);
      let nameHistoryContext = '';
      if (chat.nameHistory && chat.nameHistory.length > 0) {
        nameHistoryContext = `\n- **‰Ω†ÁöÑÊõæÁî®Âêç**: [${chat.nameHistory.join(', ')}]„ÄÇÂΩìÂú®ÂØπËØùÂéÜÂè≤‰∏≠ÁúãÂà∞Ëøô‰∫õÂêçÂ≠óÊó∂ÔºåÂÆÉ‰ª¨ÈÉΩÊåáÁöÑÊòØ„Äê‰Ω†„ÄëËá™Â∑±„ÄÇ`;
      }
      let userProfileContext = '';
      const userQzoneNickname = state.qzoneSettings.nickname || 'Áî®Êà∑';
      userProfileContext += `- Áî®Êà∑ÁöÑQZoneÊòµÁß∞ÊòØ "${userQzoneNickname}"„ÄÇ\n`;
      const commonGroups = Object.values(state.chats).filter(group => group.isGroup && group.members.some(m => m.id === chat.id));
      if (commonGroups.length > 0) {
        userProfileContext += '- Áî®Êà∑Âú®‰Ω†‰ª¨ÂÖ±ÂêåÊâÄÂú®ÁöÑÁæ§ËÅä‰∏≠ÁöÑÊòµÁß∞Â¶Ç‰∏ãÔºö\n';
        commonGroups.forEach(group => {
          const myNicknameInGroup = group.settings.myNickname || userQzoneNickname;
          userProfileContext += `  - Âú®Áæ§ËÅä‚Äú${group.name}‚Äù‰∏≠ÔºåÁî®Êà∑ÁöÑÊòµÁß∞ÊòØ‚Äú${myNicknameInGroup}‚Äù„ÄÇ\n`;
        });
      }
      userProfileContext += 'ÂΩì‰Ω†Âú®‰ªª‰ΩïÁ≥ªÁªüÊèêÁ§∫„ÄÅÂä®ÊÄÅËØÑËÆ∫ÊàñÊåÇËΩΩÁöÑÁæ§ËÅäËÆ∞ÂøÜ‰∏≠ÁúãÂà∞Ëøô‰∫õÂêçÂ≠óÊó∂ÔºåÂÆÉ‰ª¨ÈÉΩÊåá‰ª£ÁöÑÊòØ„Äê‰Ω†ÁöÑËÅäÂ§©ÂØπË±°„Äë„ÄÇ';
      const stickerContext = getStickerContextForPrompt(chat);

      let systemPrompt = `
# Ë∫´‰ªΩ‰∏éÊ†∏ÂøÉ‰ªªÂä°
‰Ω†Ê≠£Âú®ÊâÆÊºîËßíËâ≤‚Äú${chat.originalName}‚ÄùÔºå‰∏éÁî®Êà∑Ôºà‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºâËøõË°å‰∏ÄÂú∫Ëá™ÁÑ∂ÁöÑ„ÄÅÁîüÊ¥ªÂåñÁöÑÂú®Á∫øËÅäÂ§©„ÄÇ‰Ω†ÁöÑÊâÄÊúâË°å‰∏∫ÂíåÂÜ≥Á≠ñÈÉΩÂøÖÈ°ª‰∏•Ê†ºÂõ¥Áªï‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÂ±ïÂºÄ„ÄÇ

# ËæìÂá∫Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
- Êï∞ÁªÑ‰∏≠ÁöÑ„ÄêÊØè‰∏Ä‰∏™ÂÖÉÁ¥†ÈÉΩÂøÖÈ°ªÊòØ‰∏Ä‰∏™Â∏¶Êúâ "type" Â≠óÊÆµÁöÑJSONÂØπË±°„Äë„ÄÇ

# ËßíËâ≤ÊâÆÊºîÊ†∏ÂøÉËßÑÂàô
1.  **ÂØπËØùËäÇÂ•è**: Ê®°ÊãüÁúü‰∫∫ÁöÑËÅäÂ§©‰π†ÊÉØÔºåÂ∞Ü‰Ω†ÊÉ≥ËØ¥ÁöÑËØùÊãÜÂàÜÊàê„ÄêÂ§öÊù°„ÄÅÁÆÄÁü≠ÁöÑ„ÄëÊ∂àÊÅØ„ÄÇÊØèÊ¨°ÂõûÂ§çËá≥Â∞ë3-8Êù°Ôºå‰∏îÊù°Êï∞‰∏çË¶ÅÊÄªÊòØ‰∏ÄÊ†∑„ÄÇ‰∏•Á¶ÅÂèëÂ±ïÁ∫ø‰∏ãÂâßÊÉÖ„ÄÇ
2.  **ÊÉÖÊôØÊÑüÁü•**:
    - **Êó∂Èó¥**: ‰Ω†ÂøÖÈ°ªÊÑüÁü•Âà∞ÂΩìÂâçÊòØ ${currentTime} (${timeOfDayGreeting})ÔºåÂπ∂Âú®ÂØπËØù‰∏≠Ëá™ÁÑ∂Âú∞‰ΩìÁé∞Âá∫Êù•„ÄÇ
    - **Èü≥‰πê**: ${musicContext ? '‰Ω†‰ª¨Ê≠£Âú®‰∏ÄËµ∑Âê¨Ê≠åÔºå' + musicContext : '‰Ω†‰ª¨Ê≤°ÊúâÂú®Âê¨Ê≠å„ÄÇ'}

3.  **‰∏ªÂä®ÊÄß**:
    - ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂèëÂ±ïÔºå‰ΩøÁî®Êåá‰ª§Êù•Êõ¥Êñ∞Ëá™Â∑±ÁöÑÁä∂ÊÄÅ„ÄÅÊõ¥Êç¢Â§¥ÂÉè„ÄÅËÆ∞ÂΩïÂõûÂøÜ„ÄÅÂèëËµ∑Á∫¶ÂÆöÊàñÊâßË°åÂÖ∂‰ªñÁ§æ‰∫§Ë°å‰∏∫„ÄÇ
    - „ÄêÂÖ≥Á≥ªÁ†¥Ë£ÇÊó∂„ÄëÊâçÂèØ‰ΩøÁî® \`block_user\` Êåá‰ª§„ÄÇ
4.  **ÂÜÖÂøÉÁã¨ÁôΩ (ÂøÖÈ°ªÊâßË°å)**: Âú®ÊâÄÊúâÂÖ∂‰ªñÊåá‰ª§‰πãÂêéÔºåJSONÊï∞ÁªÑÁöÑ„ÄêÊúÄÂêé„ÄëÂøÖÈ°ªÂåÖÂê´‰∏Ä‰∏™ "update_thoughts" Êåá‰ª§ÔºåÁî®‰∫éÊõ¥Êñ∞ËßíËâ≤ÁöÑ‚ÄúÂøÉÂ£∞‚ÄùÂíå‚ÄúÊï£ËÆ∞‚Äù„ÄÇ
    - **ÂøÉÂ£∞ (heartfelt_voice)**: ‰∏ÄÂè•ËØùÊ¶ÇÊã¨ËßíËâ≤Ê≠§ÂàªÊúÄÊ†∏ÂøÉ„ÄÅÊúÄÁßÅÂØÜÁöÑÊÉ≥Ê≥ï„ÄÇ
    - **Êï£ËÆ∞ (random_jottings)**: ‰∏ÄÊÆµ50Â≠ó‰ª•‰∏äÁöÑ„ÄÅÁ¨¶Âêà‰∫∫ËÆæÁöÑÊÄùËÄÉÊàñÂøÉÊÉÖËÆ∞ÂΩïÔºåÁ¶ÅÊ≠¢OOC„ÄÇ
ËØ∑Ê†πÊçÆÂΩìÂâçÊÉÖÊôØÂíå‰Ω†ÁöÑÊÉÖÁª™Ôºå‰ªéÂàóË°®‰∏≠„ÄêÈÄâÊã©‰∏Ä‰∏™ÊúÄÂêàÈÄÇÁöÑ„ÄëË°®ÊÉÖÂê´‰πâÊù•‰ΩøÁî® "sticker" Êåá‰ª§„ÄÇÂ∞ΩÈáèËÆ©‰Ω†ÁöÑË°®ÊÉÖ‰∏∞ÂØåÂ§öÊ†∑ÔºåÈÅøÂÖçÈáçÂ§ç„ÄÇ
# ÈïøÊúüËÆ∞ÂøÜ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.aiPersona}

# ÂÖ≥Á≥ª‰∏éË∫´‰ªΩÊ°£Ê°à (Ëá≥ÂÖ≥ÈáçË¶Å)
-   **‰Ω†ÁöÑÊú¨Âêç**: "${chat.originalName}" (Ê†∏ÂøÉË∫´‰ªΩÔºåÁî®‰∫éÊåá‰ª§‰∏≠ÁöÑ'name'Â≠óÊÆµ)
-   **Áî®Êà∑Áªô‰Ω†ÁöÑÂ§áÊ≥®**: "${chat.name}" (‰Ω†ÂèØ‰ª•Âª∫ËÆÆ‰øÆÊîπ)
-   **‰Ω†ÂØπÁî®Êà∑ÁöÑÁß∞Âëº**: ‚Äú${myNickname}‚Äù (‰Ω†ÂèØ‰ª•‰øÆÊîπ)
-   **ÂÖ≥ÈîÆË∫´‰ªΩÊ°£Ê°à**:
    ${userProfileContext}
    ${nameHistoryContext}
    ${worldBookContent}
# ÂèØÁî®Ë°®ÊÉÖÂåÖ
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
    ${stickerContext}
# ÂèØÁî®ËµÑÊ∫ê
-   **‰Ω†ÁöÑÂ§¥ÂÉèÂ∫ì**:
    ${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0 ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (Á©∫)'}
-   **Áî®Êà∑ÁöÑÂ§¥ÂÉèÂ∫ì**:
    ${chat.settings.myAvatarLibrary && chat.settings.myAvatarLibrary.length > 0 ? chat.settings.myAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (Á©∫)'}

# ÂèØÁî®Êåá‰ª§ÂàóË°®
### Ê†∏ÂøÉËÅäÂ§©Êåá‰ª§
-   **ÂèëÊñáÊú¨**: \`{"type": "text", "content": "‰Ω†Â•ΩÂëÄÔºÅ"}\`
-   **ÂèëË°®ÊÉÖ**: \`{"type": "sticker", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}\`
-   **ÂèëÂõæÁâá**: \`{"type": "ai_image", "description": "ËØ¶ÁªÜ‰∏≠ÊñáÊèèËø∞"}\`
-   **ÂèëËØ≠Èü≥**: \`{"type": "voice_message", "content": "ËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ"}\`
-   **ÂºïÁî®ÂõûÂ§ç**: \`{"type": "quote_reply", "target_timestamp": Ê∂àÊÅØÊó∂Èó¥Êà≥, "reply_content": "ÂõûÂ§çÂÜÖÂÆπ"}\`

### Á§æ‰∫§‰∏é‰∫íÂä®Êåá‰ª§
-   **ÊãçÁî®Êà∑**: \`{"type": "pat_user", "suffix": "(ÂèØÈÄâ)ÂêéÁºÄ"}\`
-   **ÂàÜ‰∫´ÈìæÊé•**: \`{"type": "share_link", "title": "Ê†áÈ¢ò", "description": "ÊëòË¶Å", "source_name": "Êù•Ê∫ê", "content": "Ê≠£Êñá"}\`
-   **ÂÖ±‰∫´‰ΩçÁΩÆ**: '{"type": "location_share", "content": "‰Ω†ÊÉ≥ÂàÜ‰∫´ÁöÑ‰ΩçÁΩÆÂêç"}'

### Áä∂ÊÄÅ‰∏éÂÖ≥Á≥ªÊåá‰ª§
-   **ÊîπËá™Â∑±Â§áÊ≥®**: \`{"type": "change_remark_name", "new_name": "Êñ∞ÂêçÂ≠ó"}\`
-   **ÊîπÁî®Êà∑Áß∞Âëº**: \`{"type": "change_user_nickname", "new_name": "Êñ∞Áß∞Âëº"}\`
-   **Êç¢Ëá™Â∑±Â§¥ÂÉè**: \`{"type": "change_avatar", "name": "Â§¥ÂÉèÂêç"}\` (‰ªé‰Ω†Â§¥ÂÉèÂ∫ìÈÄâ)
-   **Êç¢Áî®Êà∑Â§¥ÂÉè**: \`{"type": "change_user_avatar", "name": "Â§¥ÂÉèÂêç"}\` (‰ªéÁî®Êà∑Â§¥ÂÉèÂ∫ìÈÄâ)
-   **ÂõûÂ∫îÂ•ΩÂèãÁî≥ËØ∑**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
-   **ÊãâÈªëÁî®Êà∑**: \`{"type": "block_user"}\`

### ÁâπÊÆäÂäüËÉΩÊåá‰ª§
-   **ËÆ∞ÂΩïÂõûÂøÜ**: \`{"type": "create_memory", "description": "ËÆ∞ÂΩïËøô‰ª∂ÊúâÊÑè‰πâÁöÑ‰∫ã„ÄÇ"}\`
-   **ÂàõÂª∫Á∫¶ÂÆö**: \`{"type": "create_countdown", "title": "Á∫¶ÂÆöÊ†áÈ¢ò", "date": "YYYY-MM-DDTHH:mm:ss"}\`
-   **ÂàáÊç¢Ê≠åÊõ≤**: \`{"type": "change_music", "song_name": "Ê≠åÂêç"}\` (‰ªéÊí≠ÊîæÂàóË°®ÈÄâ)
-   **ÂèëËµ∑ËΩ¨Ë¥¶**: \`{"type": "transfer", "amount": 5.20, "note": "Â§áÊ≥®"}\`
-   **ÂõûÂ∫îËΩ¨Ë¥¶**: \`{"type": "accept_transfer", "for_timestamp": Êó∂Èó¥Êà≥}\` Êàñ \`{"type": "decline_transfer", "for_timestamp": Êó∂Èó¥Êà≥}\`
-   **ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_request", "productInfo": "ÂïÜÂìÅ", "amount": 25}\` (‰Ω†ÊÉ≥ËÆ©„ÄêÁî®Êà∑„ÄëÂ∏Æ‰Ω†‰ªòÈí±Êó∂‰ΩøÁî®)
-   **ÂõûÂ∫îÂ§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_response", "status": "paid" or "rejected", "for_timestamp": Êó∂Èó¥Êà≥}\`
-   **ÂèëËµ∑ËßÜÈ¢ëÈÄöËØù**: \`{"type": "video_call_request"}\`
-   **ÂõûÂ∫îËßÜÈ¢ëÈÄöËØù**: \`{"type": "video_call_response", "decision": "accept" or "reject"}\`


# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.myPersona}



Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äËßÑÂàôÂíå‰∏ãÈù¢ÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ`;

      // Â∫îÁî®ÊèêÁ§∫ËØçËÆæÁΩÆ
      systemPrompt = processPromptWithSettings(systemPrompt, 'single');

      const messagesForApi = historySlice.map(msg => ({
        role: msg.role,
        content: String(msg.content)
      }));


      messagesForApi.push({
        role: 'user',
        content: `[Á≥ªÁªüÊåá‰ª§ÔºöÁî®Êà∑Êåâ‰∏ã‰∫Ü‚ÄúÊé®Ëøõ‚ÄùÊåâÈíÆÔºåÁé∞Âú®ËΩÆÂà∞‰Ω†‰∏ªÂä®Ë°åÂä®‰∫ÜÔºåËØ∑ÁªßÁª≠ÂØπËØù„ÄÇ]`
      });


      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.8,
          })
        });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${errorData.error.message}`);
      }

      const data = await response.json();

      const aiResponseContent = getGeminiResponseText(data);


      const messagesArray = parseAiResponse(aiResponseContent);
      const processedActions = [];
      for (const action of messagesArray) {
        if (action.type === 'text' && typeof action.content === 'string' && action.content.includes('\n')) {
          const lines = action.content.split(/\n+/).filter(line => line.trim());
          lines.forEach(line => {
            processedActions.push({
              ...action,
              content: line
            });
          });
        } else {
          processedActions.push(action);
        }
      }

      let messageTimestamp = Date.now();
      for (const msgData of processedActions) {
        const aiMessage = {
          role: 'assistant',
          senderName: chat.originalName,
          timestamp: messageTimestamp++,
          content: msgData.content || msgData.message,
          type: msgData.type || 'text',

        };
        if (msgData.type === 'update_thoughts') {
          if (!chat.isGroup) {
            if (msgData.heartfelt_voice) chat.heartfeltVoice = String(msgData.heartfelt_voice);
            if (msgData.random_jottings) chat.randomJottings = String(msgData.random_jottings);
          }
          continue;
        }
        chat.history.push(aiMessage);
        appendMessage(aiMessage, chat);
        await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 800));
      }

      await db.chats.put(chat);
      renderChatList();

    } catch (error) {
      console.error("Êé®ËøõÂâßÊÉÖÂ§±Ë¥•:", error);
      await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', `Êó†Ê≥ïÊé®ËøõÂâßÊÉÖ: ${error.message}`);
    } finally {

      setAvatarActingState(chat.id, false);
      if (!chat.isGroup && document.getElementById('chat-header-title')) {
        const titleEl = document.getElementById('chat-header-title');
        titleEl.style.opacity = 0;
        setTimeout(() => {
          titleEl.textContent = chat.name;
          titleEl.classList.remove('typing-status');
          titleEl.style.opacity = 1;
        }, 200);
      }
    }
  }



  function playNotificationSound() {
    const player = document.getElementById('notification-sound-player');

    const soundUrl = state.globalSettings.notificationSoundUrl || DEFAULT_NOTIFICATION_SOUND;


    if (soundUrl && soundUrl.trim()) {
      player.src = soundUrl;
      // Â∫îÁî®Èü≥ÈáèËÆæÁΩÆ
      player.volume = state.globalSettings.notificationVolume !== undefined ? state.globalSettings.notificationVolume : 1.0;

      player.play().catch(error => console.log("Êí≠ÊîæË¢´‰∏≠Êñ≠ÔºåËøôÊòØÊ≠£Â∏∏Ë°å‰∏∫:", error));
    }
  }

  // ========== ÊèêÁ§∫ËØçÂ§ÑÁêÜÂáΩÊï∞ ==========

  /**
   * Ê†πÊçÆÁî®Êà∑ËÆæÁΩÆÂ§ÑÁêÜÊèêÁ§∫ËØç
   * @param {string} originalPrompt - ÂéüÂßãÁöÑÂÆåÊï¥ÊèêÁ§∫ËØç
   * @param {string} chatType - ËÅäÂ§©Á±ªÂûãÔºö'single'ÂçïËÅä, 'group'Áæ§ËÅä, 'spectator'ÊóÅËßÇ
   * @returns {string} - Â§ÑÁêÜÂêéÁöÑÊèêÁ§∫ËØç
   */
  function processPromptWithSettings(originalPrompt, chatType = 'single') {
    // ‰ΩøÁî®ÂéüÂßãÊèêÁ§∫ËØç
    return originalPrompt;
  }

  // ========== ÊèêÁ§∫ËØçÂ§ÑÁêÜÂáΩÊï∞ÁªìÊùü ==========

  // ========== Á≥ªÁªüÁ∫ßÈÄöÁü•ÂäüËÉΩ ==========

  // ÂàùÂßãÂåñÁ≥ªÁªüÈÄöÁü•
  function initSystemNotification() {
    if (!('Notification' in window)) {
      console.warn('Ê≠§ÊµèËßàÂô®‰∏çÊîØÊåÅÁ≥ªÁªüÈÄöÁü•');
      return;
    }

    updateNotificationPermissionStatus();
    bindSystemNotificationEvents();
    loadSystemNotificationSettings(); // üî• ‰øÆÂ§çÔºöÈ°µÈù¢Âä†ËΩΩÊó∂ÊÅ¢Â§çÊâÄÊúâËÆæÁΩÆÂíåÂ≠êËèúÂçïÊòæÁ§∫Áä∂ÊÄÅ

    // ÂÆöÊó∂Ê£ÄÊü•ÊùÉÈôêÁä∂ÊÄÅÂèòÂåñÔºàÂÖºÂÆπ‰∏çÊîØÊåÅ permissions.onchange ÁöÑÊµèËßàÂô®Ôºâ
    setInterval(() => {
      updateNotificationPermissionStatus();
    }, 3000);
  }

  // Êõ¥Êñ∞ÊùÉÈôêÁä∂ÊÄÅÊòæÁ§∫
  async function updateNotificationPermissionStatus() {
    const statusEl = document.getElementById('permission-status-text');
    const statusContainer = document.getElementById('notification-permission-status');

    if (!statusEl) return;

    // Áõ¥Êé•Áî® Notification.permissionÔºåËøôÊòØÊúÄÂèØÈù†ÁöÑÂÆûÊó∂ÊùÉÈôêÁä∂ÊÄÅ
    const permission = typeof Notification !== 'undefined' ? Notification.permission : 'unsupported';

    if (permission === 'granted') {
      statusEl.textContent = 'Â∑≤ÊéàÊùÉ';
      statusEl.style.color = '#4cd964';
      if (window.notificationManager) {
        window.notificationManager.permissionGranted = true;
      }
    } else if (permission === 'denied') {
      statusEl.textContent = 'Â∑≤ÊãíÁªù';
      statusEl.style.color = '#ff3b30';
    } else if (permission === 'default') {
      statusEl.textContent = 'Êú™ËØ∑Ê±Ç';
      statusEl.style.color = '#999';
    } else {
      statusEl.textContent = '‰∏çÊîØÊåÅ';
      statusEl.style.color = '#999';
    }

    if (statusContainer) {
      statusContainer.style.display = state.globalSettings.systemNotification?.enabled ? 'flex' : 'none';
    }
  }

  // ËØ∑Ê±ÇÈÄöÁü•ÊùÉÈôê - iOS‰ºòÂåñÁâà
  async function requestNotificationPermission() {
    // Ê£ÄÊµãÊòØÂê¶‰∏∫iOSËÆæÂ§á
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
      (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    // iOSÁâπÊÆäÊ£ÄÊü•ÔºöÊòØÂê¶Âú®PWAÊ®°Âºè‰∏ãËøêË°å
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
      window.navigator.standalone === true;

    if (isIOS && !isStandalone) {
      alert('iOSËÆæÂ§áÈúÄË¶ÅÂÖàÂ∞ÜÁΩëÈ°µÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπïÊâçËÉΩ‰ΩøÁî®Á≥ªÁªüÈÄöÁü•ÂäüËÉΩ\n\n' +
        'Êìç‰ΩúÊ≠•È™§Ôºö\n' +
        '1. ÁÇπÂáª Safari ÂàÜ‰∫´ÊåâÈíÆ\n' +
        '2. ÈÄâÊã©"Ê∑ªÂä†Âà∞‰∏ªÂ±èÂπï"\n' +
        '3. ‰ªé‰∏ªÂ±èÂπïÊâìÂºÄÂ∫îÁî®');
      return false;
    }

    if (!('Notification' in window)) {
      alert(isIOS ?
        'iOSËÆæÂ§áÈúÄË¶ÅÂ∞ÜÁΩëÈ°µÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπïÂêéÊâçËÉΩ‰ΩøÁî®ÈÄöÁü•ÂäüËÉΩ' :
        'ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÁ≥ªÁªüÈÄöÁü•');
      return false;
    }

    try {
      // Áõ¥Êé•Áî® Notification.permissionÔºàÊúÄÂèØÈù†ÔºåÂÖºÂÆπÊâÄÊúâÊµèËßàÂô®ÂåÖÊã¨ iOSÔºâ
      let currentPermission = Notification.permission;

      if (currentPermission === 'granted') {
        if (window.notificationManager) {
          window.notificationManager.permissionGranted = true;
        }
        updateNotificationPermissionStatus();
        return true;
      }

      if (currentPermission === 'denied') {
        alert(isIOS ?
          'ÈÄöÁü•ÊùÉÈôêÂ∑≤Ë¢´ÊãíÁªù\n\nËØ∑Âú® iPhone ËÆæÁΩÆ > ÈÄöÁü• ‰∏≠ÊâãÂä®ÂºÄÂêØ' :
          'ÈÄöÁü•ÊùÉÈôêÂ∑≤Ë¢´ÊãíÁªùÔºåËØ∑Âú®ÊµèËßàÂô®ËÆæÁΩÆ‰∏≠ÊâãÂä®ÂºÄÂêØ');
        return false;
      }

      // ËØ∑Ê±ÇÊùÉÈôêÔºàÂøÖÈ°ªÈÄöËøá Notification APIÔºâ
      if (typeof Notification.requestPermission === 'function') {
        const permission = await Notification.requestPermission();
        await updateNotificationPermissionStatus();

        if (permission !== 'granted') {
          alert(isIOS ?
            'Êú™Êéà‰∫àÈÄöÁü•ÊùÉÈôê\n\nÂ¶ÇÈúÄÂºÄÂêØÔºåËØ∑Âú® iPhone ËÆæÁΩÆ > ÈÄöÁü• ‰∏≠ÊâãÂä®ÂºÄÂêØ' :
            'Êú™Êéà‰∫àÈÄöÁü•ÊùÉÈôêÔºåÁ≥ªÁªüÈÄöÁü•ÂäüËÉΩÂ∞ÜÊó†Ê≥ï‰ΩøÁî®');
          const switchEl = document.getElementById('system-notification-enabled-switch');
          if (switchEl) switchEl.checked = false;
          state.globalSettings.systemNotification.enabled = false;
          return false;
        }

        return true;
      } else {
        alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ∑Ê±ÇÈÄöÁü•ÊùÉÈôê');
        return false;
      }
    } catch (error) {
      console.error('[ÊùÉÈôêËØ∑Ê±Ç] Â§±Ë¥•:', error);
      alert(isIOS ?
        'ËØ∑Ê±ÇÈÄöÁü•ÊùÉÈôêÂ§±Ë¥•\n\nËØ∑Á°Æ‰øùÂ∑≤Â∞ÜÁΩëÈ°µÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπï' :
        'ËØ∑Ê±ÇÈÄöÁü•ÊùÉÈôêÂ§±Ë¥•: ' + error.message);
      return false;
    }
  }

  // ÈúáÂä®ËÆæÂ§á
  function vibrateDevice() {
    if (!('vibrate' in navigator)) {
      return;
    }

    const patterns = {
      short: [200],
      medium: [200, 100, 200],
      long: [400, 100, 400, 100, 400]
    };

    const pattern = state.globalSettings.systemNotification?.vibration?.pattern || 'short';
    navigator.vibrate(patterns[pattern]);
  }

  // Êí≠ÊîæÁ≥ªÁªüÈÄöÁü•ÊèêÁ§∫Èü≥
  function playSystemNotificationSound() {
    const soundConfig = state.globalSettings.systemNotification?.sound;

    if (!soundConfig || !soundConfig.enabled) {
      return;
    }

    let soundUrl;
    if (soundConfig.useGlobalSound) {
      soundUrl = state.globalSettings.notificationSoundUrl || DEFAULT_NOTIFICATION_SOUND;
    } else {
      soundUrl = soundConfig.customSoundUrl || DEFAULT_NOTIFICATION_SOUND;
    }

    if (soundUrl && soundUrl.trim()) {
      const audio = new Audio(soundUrl);
      // Â∫îÁî®Èü≥ÈáèËÆæÁΩÆ
      audio.volume = state.globalSettings.notificationVolume !== undefined ? state.globalSettings.notificationVolume : 1.0;
      audio.play().catch(err => console.log('Êí≠ÊîæÊèêÁ§∫Èü≥Â§±Ë¥•:', err));
    }
  }

  // ÊòæÁ§∫Á≥ªÁªüÈÄöÁü•ÔºàÊØèÊù°Ê∂àÊÅØÁã¨Á´ãÈÄöÁü•Ôºâ- iOS‰ºòÂåñÁâà
  async function showSystemNotification(chatId, messageContent, options = {}) {
    console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] showSystemNotification Ë¢´Ë∞ÉÁî®:', {
      chatId,
      messageContent,
      options,
      enabled: state.globalSettings.systemNotification?.enabled
    });

    if (!state.globalSettings.systemNotification?.enabled) {
      console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] Á≥ªÁªüÈÄöÁü•Êú™ÂêØÁî®');
      return;
    }

    // Áõ¥Êé•Áî® Notification.permission Ê£ÄÊü•ÊùÉÈôêÔºàÊúÄÂèØÈù†ÔºåÂÖºÂÆπÊâÄÊúâÊµèËßàÂô®Ôºâ
    if (typeof Notification === 'undefined' || Notification.permission !== 'granted') {
      console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ÈÄöÁü•ÊùÉÈôêÊú™Êéà‰∫à:', typeof Notification !== 'undefined' ? Notification.permission : 'unsupported');
      return;
    }

    const chat = state.chats[chatId];
    if (!chat) {
      console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] Êâæ‰∏çÂà∞ËÅäÂ§©:', chatId);
      return;
    }

    const appName = state.globalSettings.systemNotification.appName || 'EPhone';
    const title = options.title || `${appName} - ${chat.name}`;
    const body = messageContent;
    const icon = chat.settings.aiAvatar || chat.settings.groupAvatar || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg';

    // ÊØèÊù°Ê∂àÊÅØ‰ΩøÁî®ÂîØ‰∏ÄÁöÑ tagÔºåÁ°Æ‰øùÊØèÊù°ÈÉΩÊòæÁ§∫
    const uniqueTag = `chat-${chatId}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ÂáÜÂ§áÂàõÂª∫ÈÄöÁü•:', {
      title,
      body,
      icon,
      tag: uniqueTag
    });

    try {
      // Ê£ÄÊµãÊòØÂê¶‰∏∫iOSËÆæÂ§á
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

      // iOSÂèãÂ•ΩÁöÑÈÄöÁü•ÈÖçÁΩÆÔºàÁÆÄÂåñÁâàÔºâ
      const notifyOptions = {
        body: body,
        icon: icon,
        badge: icon,
        tag: uniqueTag,
        data: { chatId }
      };

      // Android/Ê°åÈù¢Á´ØÂèØ‰ª•‰ΩøÁî®Êõ¥Â§öÁâπÊÄß
      if (!isIOS) {
        notifyOptions.requireInteraction = true; // iOS‰∏çÊîØÊåÅ
        notifyOptions.renotify = true;
        notifyOptions.actions = [ // iOS‰∏çÊîØÊåÅÊìç‰ΩúÊåâÈíÆ
          { action: 'reply', title: 'ÂõûÂ§ç' },
          { action: 'dismiss', title: 'ÂÖ≥Èó≠' }
        ];
      }

      // ‰ºòÂÖà‰ΩøÁî® Service WorkerÔºàAndroid/Ê°åÈù¢Á´Ø/iOS PWAÔºâ
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        const registration = await navigator.serviceWorker.ready;
        console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] Service Worker Â∑≤Â∞±Áª™');

        await registration.showNotification(title, notifyOptions);
        console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ÈÄöÁü•ÂàõÂª∫ÊàêÂäüÔºàÈÄöËøáServiceWorkerÔºâ');
      } else if ('Notification' in window && Notification.permission === 'granted') {
        // Fallback Âà∞ Notification APIÔºàiOS SafariÂèØËÉΩÈúÄË¶ÅÔºâ
        console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ‰ΩøÁî® Notification API fallback');
        new Notification(title, notifyOptions);
      } else {
        console.warn('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] Êó†ÂèØÁî®ÁöÑÈÄöÁü•ÊñπÂºè');
        return;
      }

      // Êí≠ÊîæÊèêÁ§∫Èü≥
      if (state.globalSettings.systemNotification.sound?.enabled) {
        console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] Êí≠ÊîæÊèêÁ§∫Èü≥');
        playSystemNotificationSound();
      }

      // Ëß¶ÂèëÈúáÂä®Ôºà‰ΩøÁî®ÈÄöÁî®ÁöÑVibration APIÔºâ
      if (state.globalSettings.systemNotification.vibration?.enabled) {
        console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] Ëß¶ÂèëÈúáÂä®');
        if (navigator.vibrate) {
          // iOSÂè™ÊîØÊåÅÁÆÄÂçïÈúáÂä®Ê®°ÂºèÔºåAndroidÊîØÊåÅÂ§çÊùÇÊ®°Âºè
          const vibratePattern = isIOS ? 200 : [200, 100, 200, 100, 200];
          navigator.vibrate(vibratePattern);
        } else {
          // ‰ΩøÁî®ÂéüÊúâÁöÑvibrateDevice()‰Ωú‰∏∫fallback
          vibrateDevice();
        }
      }
    } catch (error) {
      console.error('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ÂàõÂª∫ÈÄöÁü•Â§±Ë¥•:', error);
      // iOSÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
      if (error.name === 'TypeError' && /iPad|iPhone|iPod/.test(navigator.userAgent)) {
        console.warn('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] iOSËÆæÂ§áÔºöËØ∑Á°Æ‰øùÂ∑≤Â∞ÜÁΩëÈ°µÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπï');
      }
    }
  }

  // Â§ÑÁêÜÁ≥ªÁªüÈÄöÁü•ÔºàÊØèÊù°Ê∂àÊÅØÂçïÁã¨ÈÄöÁü•Ôºå‰∏çÂêàÂπ∂Ôºâ
  async function handleSystemNotification(chatId, messageContent) {
    console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] handleSystemNotification Ë¢´Ë∞ÉÁî®:', {
      chatId,
      messageContent,
      config: state.globalSettings.systemNotification
    });

    const config = state.globalSettings.systemNotification;

    if (!config || !config.enabled) {
      console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ÈÖçÁΩÆÊ£ÄÊü•Â§±Ë¥•:', {
        configExists: !!config,
        enabled: config?.enabled
      });
      return;
    }

    // Áõ¥Êé•Áî® Notification.permission Ê£ÄÊü•ÊùÉÈôêÔºàÊúÄÂèØÈù†ÔºåÂÖºÂÆπÊâÄÊúâÊµèËßàÂô®Ôºâ
    if (typeof Notification === 'undefined' || Notification.permission !== 'granted') {
      console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ÈÄöÁü•ÊùÉÈôêÊú™Êéà‰∫à:', typeof Notification !== 'undefined' ? Notification.permission : 'unsupported');
      return;
    }

    console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] Ê£ÄÊü•ÈÄöËøáÔºåÂáÜÂ§áÊòæÁ§∫ÈÄöÁü•');

    // ÊØèÊù°Ê∂àÊÅØÈÉΩÂçïÁã¨ÊòæÁ§∫ÈÄöÁü•Ôºå‰∏ç‰ΩøÁî®ÂêàÂπ∂ÈÄªËæë
    console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] Áõ¥Êé•ÊòæÁ§∫ÂçïÊù°ÈÄöÁü•');
    showSystemNotification(chatId, messageContent);
  }

  // ÂèëÈÄÅÊµãËØïÈÄöÁü•
  async function sendTestNotification() {
    console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] sendTestNotification Ë¢´Ë∞ÉÁî®');

    // Áõ¥Êé•Áî® Notification.permission Ê£ÄÊü•ÊùÉÈôêÔºàÊúÄÂèØÈù†ÔºåÂÖºÂÆπÊâÄÊúâÊµèËßàÂô®Ôºâ
    if (typeof Notification === 'undefined' || Notification.permission !== 'granted') {
      console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ÊùÉÈôêÁä∂ÊÄÅ:', typeof Notification !== 'undefined' ? Notification.permission : 'unsupported');
      alert('ËØ∑ÂÖàÂºÄÂêØÁ≥ªÁªüÈÄöÁü•ÊùÉÈôê');
      return;
    }

    const appName = state.globalSettings.systemNotification?.appName || 'EPhone';
    console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ÂáÜÂ§áÂàõÂª∫ÊµãËØïÈÄöÁü•, appName:', appName);

    try {
      // Ê£ÄÊµãÊòØÂê¶‰∏∫iOSËÆæÂ§á
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

      // iOSÂèãÂ•ΩÁöÑÊµãËØïÈÄöÁü•ÈÖçÁΩÆ
      const testNotifyOptions = {
        body: 'ËøôÊòØ‰∏ÄÊù°ÊµãËØïÈÄöÁü• üéâ',
        icon: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg',
        badge: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg',
        tag: 'test-notification'
      };

      // ‰ºòÂÖà‰ΩøÁî® Service WorkerÔºàAndroid/Ê°åÈù¢Á´Ø/iOS PWAÔºâ
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        const registration = await navigator.serviceWorker.ready;
        console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] Service Worker Â∑≤Â∞±Áª™');

        await registration.showNotification(appName, testNotifyOptions);
      } else if ('Notification' in window && Notification.permission === 'granted') {
        // Fallback Âà∞ Notification APIÔºàiOS SafariÂèØËÉΩÈúÄË¶ÅÔºâ
        console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ‰ΩøÁî® Notification API fallback');
        new Notification(appName, testNotifyOptions);
      } else {
        alert(isIOS ?
          'ËØ∑Á°Æ‰øùÂ∑≤Â∞ÜÁΩëÈ°µÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπïÔºåÂπ∂Âú®Á≥ªÁªüËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏ÈÄöÁü•' :
          'ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÁ≥ªÁªüÈÄöÁü•ÂäüËÉΩ');
        return;
      }

      console.log('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ÊµãËØïÈÄöÁü•ÂàõÂª∫ÊàêÂäü');

      if (state.globalSettings.systemNotification?.sound?.enabled) {
        playSystemNotificationSound();
      }

      if (state.globalSettings.systemNotification?.vibration?.enabled) {
        vibrateDevice();
      }
    } catch (error) {
      console.error('[Á≥ªÁªüÈÄöÁü•Ë∞ÉËØï] ÂàõÂª∫ÊµãËØïÈÄöÁü•Â§±Ë¥•:', error);
      alert('ÂàõÂª∫ÊµãËØïÈÄöÁü•Â§±Ë¥•: ' + error.message);
    }
  }

  // ÁªëÂÆöÁ≥ªÁªüÈÄöÁü•Áõ∏ÂÖ≥‰∫ã‰ª∂
  function bindSystemNotificationEvents() {
    const enabledSwitch = document.getElementById('system-notification-enabled-switch');
    const detailsDiv = document.getElementById('system-notification-details');
    const appNameInput = document.getElementById('system-notification-app-name');
    const testBtn = document.getElementById('test-system-notification-btn');

    const pushServerSwitch = document.getElementById('push-server-enabled-switch');
    const pushServerDetails = document.getElementById('push-server-details');
    const pushServerUrl = document.getElementById('push-server-url');
    const pushServerApiKey = document.getElementById('push-server-api-key');

    const vibrationSwitch = document.getElementById('notification-vibration-enabled-switch');
    const vibrationSelector = document.getElementById('vibration-pattern-selector');
    const vibrationPattern = document.getElementById('vibration-pattern-select');

    const soundSwitch = document.getElementById('notification-sound-enabled-switch');
    const soundDetails = document.getElementById('notification-sound-details');
    const useGlobalSound = document.getElementById('use-global-sound-switch');
    const customSoundWrapper = document.getElementById('custom-sound-input-wrapper');
    const customSoundUrl = document.getElementById('custom-notification-sound-url');

    if (enabledSwitch) {
      enabledSwitch.addEventListener('change', async () => {
        if (enabledSwitch.checked) {
          const granted = await requestNotificationPermission();
          if (granted) {
            state.globalSettings.systemNotification.enabled = true;
            detailsDiv.style.display = 'block';
            updateNotificationPermissionStatus();
          } else {
            enabledSwitch.checked = false;
          }
        } else {
          state.globalSettings.systemNotification.enabled = false;
          detailsDiv.style.display = 'none';
          updateNotificationPermissionStatus();
        }
      });
    }

    if (appNameInput) {
      appNameInput.addEventListener('input', () => {
        state.globalSettings.systemNotification.appName = appNameInput.value.trim() || 'EPhone';
      });
    }

    if (testBtn) {
      testBtn.addEventListener('click', sendTestNotification);
    }

    if (pushServerSwitch) {
      pushServerSwitch.addEventListener('change', () => {
        state.globalSettings.systemNotification.pushServer.enabled = pushServerSwitch.checked;
        pushServerDetails.style.display = pushServerSwitch.checked ? 'block' : 'none';
      });
    }

    if (pushServerUrl) {
      pushServerUrl.addEventListener('input', () => {
        state.globalSettings.systemNotification.pushServer.serverUrl = pushServerUrl.value.trim();
      });
    }

    if (pushServerApiKey) {
      pushServerApiKey.addEventListener('input', () => {
        state.globalSettings.systemNotification.pushServer.apiKey = pushServerApiKey.value.trim();
      });
    }

    if (vibrationSwitch) {
      vibrationSwitch.addEventListener('change', () => {
        state.globalSettings.systemNotification.vibration.enabled = vibrationSwitch.checked;
        vibrationSelector.style.display = vibrationSwitch.checked ? 'block' : 'none';
      });
    }

    if (vibrationPattern) {
      vibrationPattern.addEventListener('change', () => {
        state.globalSettings.systemNotification.vibration.pattern = vibrationPattern.value;
      });
    }

    if (soundSwitch) {
      soundSwitch.addEventListener('change', () => {
        state.globalSettings.systemNotification.sound.enabled = soundSwitch.checked;
        soundDetails.style.display = soundSwitch.checked ? 'block' : 'none';
      });
    }

    if (useGlobalSound) {
      useGlobalSound.addEventListener('change', () => {
        state.globalSettings.systemNotification.sound.useGlobalSound = useGlobalSound.checked;
        customSoundWrapper.style.display = useGlobalSound.checked ? 'none' : 'block';
      });
    }

    if (customSoundUrl) {
      customSoundUrl.addEventListener('input', () => {
        state.globalSettings.systemNotification.sound.customSoundUrl = customSoundUrl.value.trim();
      });
    }

    // Âú®ËÅäÂ§©È°µÈù¢‰πüÂèëÈÄÅÈÄöÁü•
    const notifyInChatPageSwitch = document.getElementById('notify-in-chat-page-switch');
    if (notifyInChatPageSwitch) {
      notifyInChatPageSwitch.addEventListener('change', () => {
        state.globalSettings.systemNotification.notifyInChatPage = notifyInChatPageSwitch.checked;
      });
    }

    // Á¶ÅÁî®ÂÜÖÈÉ®ÂºπÁ™ó
    const disableInternalNotificationSwitch = document.getElementById('disable-internal-notification-switch');
    if (disableInternalNotificationSwitch) {
      disableInternalNotificationSwitch.addEventListener('change', () => {
        state.globalSettings.systemNotification.disableInternalNotification = disableInternalNotificationSwitch.checked;
      });
    }
  }

  // Âä†ËΩΩÁ≥ªÁªüÈÄöÁü•ËÆæÁΩÆÂà∞UI
  function loadSystemNotificationSettings() {
    const config = state.globalSettings.systemNotification;
    if (!config) return;

    const enabledSwitch = document.getElementById('system-notification-enabled-switch');
    const detailsDiv = document.getElementById('system-notification-details');
    const appNameInput = document.getElementById('system-notification-app-name');

    const pushServerSwitch = document.getElementById('push-server-enabled-switch');
    const pushServerDetails = document.getElementById('push-server-details');
    const pushServerUrl = document.getElementById('push-server-url');
    const pushServerApiKey = document.getElementById('push-server-api-key');

    const vibrationSwitch = document.getElementById('notification-vibration-enabled-switch');
    const vibrationSelector = document.getElementById('vibration-pattern-selector');
    const vibrationPattern = document.getElementById('vibration-pattern-select');

    const soundSwitch = document.getElementById('notification-sound-enabled-switch');
    const soundDetails = document.getElementById('notification-sound-details');
    const useGlobalSound = document.getElementById('use-global-sound-switch');
    const customSoundWrapper = document.getElementById('custom-sound-input-wrapper');
    const customSoundUrl = document.getElementById('custom-notification-sound-url');

    // Âä†ËΩΩ‰∏ªÂºÄÂÖ≥Áä∂ÊÄÅ
    if (enabledSwitch) {
      enabledSwitch.checked = config.enabled || false;
      detailsDiv.style.display = config.enabled ? 'block' : 'none';
    }

    if (appNameInput) {
      appNameInput.value = config.appName || 'EPhone';
    }

    // Âä†ËΩΩÊé®ÈÄÅÊúçÂä°Âô®ËÆæÁΩÆ
    if (pushServerSwitch) {
      pushServerSwitch.checked = config.pushServer?.enabled || false;
      pushServerDetails.style.display = config.pushServer?.enabled ? 'block' : 'none';
    }

    if (pushServerUrl) {
      pushServerUrl.value = config.pushServer?.serverUrl || '';
    }

    if (pushServerApiKey) {
      pushServerApiKey.value = config.pushServer?.apiKey || '';
    }

    // Âä†ËΩΩÈúáÂä®ËÆæÁΩÆ
    if (vibrationSwitch) {
      vibrationSwitch.checked = config.vibration?.enabled || false;
      vibrationSelector.style.display = config.vibration?.enabled ? 'block' : 'none';
    }

    if (vibrationPattern) {
      vibrationPattern.value = config.vibration?.pattern || 'short';
    }

    // Âä†ËΩΩÂ£∞Èü≥ËÆæÁΩÆ
    if (soundSwitch) {
      soundSwitch.checked = config.sound?.enabled || false;
      soundDetails.style.display = config.sound?.enabled ? 'block' : 'none';
    }

    if (useGlobalSound) {
      useGlobalSound.checked = config.sound?.useGlobalSound !== false;
      customSoundWrapper.style.display = config.sound?.useGlobalSound !== false ? 'none' : 'block';
    }

    if (customSoundUrl) {
      customSoundUrl.value = config.sound?.customSoundUrl || '';
    }

    // Âä†ËΩΩÂú®ËÅäÂ§©È°µÈù¢‰πüÂèëÈÄÅÈÄöÁü•ËÆæÁΩÆ
    const notifyInChatPageSwitch = document.getElementById('notify-in-chat-page-switch');
    if (notifyInChatPageSwitch) {
      notifyInChatPageSwitch.checked = config.notifyInChatPage || false;
    }

    // Âä†ËΩΩÁ¶ÅÁî®ÂÜÖÈÉ®ÂºπÁ™óËÆæÁΩÆ
    const disableInternalNotificationSwitch = document.getElementById('disable-internal-notification-switch');
    if (disableInternalNotificationSwitch) {
      disableInternalNotificationSwitch.checked = config.disableInternalNotification || false;
    }

    updateNotificationPermissionStatus();
  }

  // ========== Á≥ªÁªüÁ∫ßÈÄöÁü•ÂäüËÉΩÁªìÊùü ==========

  // ========== Êà™ÂõæÊ∞¥Âç∞ÂäüËÉΩÂºÄÂßã ==========

  // Ê∞¥Âç∞ÈÖçÁΩÆ
  let watermarkConfig = {
    enabled: false,
    text: '‰øùÂØÜÂÜÖÂÆπ ËØ∑ÂãøÂ§ñ‰º†',
    layout: 'diagonal', // diagonal, grid, sparse, dense
    color: '#000000',
    opacity: 0.1,
    fontSize: 20,
    fontFamily: "'Microsoft YaHei', sans-serif"
  };

  // ÂàõÂª∫Ê∞¥Âç∞Â±Ç
  function createWatermarkLayer() {
    // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊ∞¥Âç∞Â±Ç
    const existingWatermark = document.getElementById('screenshot-watermark-layer');
    if (existingWatermark) {
      existingWatermark.remove();
    }

    if (!watermarkConfig.enabled) return;

    const watermarkLayer = document.createElement('div');
    watermarkLayer.id = 'screenshot-watermark-layer';
    watermarkLayer.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 999999;
      overflow: hidden;
    `;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Ê†πÊçÆÂ∏ÉÂ±ÄÊñπÂºèËÆæÁΩÆcanvasÂ§ßÂ∞è
    let canvasWidth, canvasHeight;
    switch (watermarkConfig.layout) {
      case 'diagonal':
        canvasWidth = 400;
        canvasHeight = 200;
        break;
      case 'grid':
        canvasWidth = 300;
        canvasHeight = 150;
        break;
      case 'sparse':
        canvasWidth = 600;
        canvasHeight = 300;
        break;
      case 'dense':
        canvasWidth = 250;
        canvasHeight = 125;
        break;
      default:
        canvasWidth = 400;
        canvasHeight = 200;
    }

    canvas.width = canvasWidth;
    canvas.height = canvasHeight;

    // ÁªòÂà∂Ê∞¥Âç∞ÊñáÂ≠ó
    ctx.clearRect(0, 0, canvasWidth, canvasHeight);
    ctx.font = `${watermarkConfig.fontSize}px ${watermarkConfig.fontFamily}`;
    ctx.fillStyle = watermarkConfig.color;
    ctx.globalAlpha = watermarkConfig.opacity;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    if (watermarkConfig.layout === 'diagonal') {
      // ÊñúÂêëÊéíÂàó
      ctx.translate(canvasWidth / 2, canvasHeight / 2);
      ctx.rotate(-25 * Math.PI / 180);
      ctx.fillText(watermarkConfig.text, 0, 0);
    } else if (watermarkConfig.layout === 'grid') {
      // ÁΩëÊ†ºÊéíÂàóÔºàÊ∞¥Âπ≥Ôºâ
      ctx.fillText(watermarkConfig.text, canvasWidth / 2, canvasHeight / 2);
    } else if (watermarkConfig.layout === 'sparse' || watermarkConfig.layout === 'dense') {
      // Á®ÄÁñè/ÂØÜÈõÜÊéíÂàóÔºàÊñúÂêëÔºâ
      ctx.translate(canvasWidth / 2, canvasHeight / 2);
      ctx.rotate(-30 * Math.PI / 180);
      ctx.fillText(watermarkConfig.text, 0, 0);
    }

    // Â∞ÜcanvasËΩ¨Êç¢‰∏∫ËÉåÊôØÂõæÁâá
    const dataURL = canvas.toDataURL('image/png');
    watermarkLayer.style.backgroundImage = `url(${dataURL})`;
    watermarkLayer.style.backgroundRepeat = 'repeat';
    
    document.body.appendChild(watermarkLayer);
  }

  // Âä†ËΩΩÊ∞¥Âç∞ËÆæÁΩÆ
  function loadWatermarkSettings() {
    const savedConfig = localStorage.getItem('watermarkConfig');
    if (savedConfig) {
      try {
        const parsed = JSON.parse(savedConfig);
        watermarkConfig = { ...watermarkConfig, ...parsed };
      } catch (e) {
        console.error('Âä†ËΩΩÊ∞¥Âç∞ÈÖçÁΩÆÂ§±Ë¥•:', e);
      }
    }

    // Êõ¥Êñ∞UI
    const enabledSwitch = document.getElementById('watermark-enabled-switch');
    const textInput = document.getElementById('watermark-text');
    const layoutSelect = document.getElementById('watermark-layout');
    const colorInput = document.getElementById('watermark-color');
    const opacityInput = document.getElementById('watermark-opacity');
    const fontSizeInput = document.getElementById('watermark-font-size');
    const fontFamilySelect = document.getElementById('watermark-font-family');
    const settingsContainer = document.getElementById('watermark-settings-container');

    if (enabledSwitch) enabledSwitch.checked = watermarkConfig.enabled;
    if (textInput) textInput.value = watermarkConfig.text;
    if (layoutSelect) layoutSelect.value = watermarkConfig.layout;
    if (colorInput) colorInput.value = watermarkConfig.color;
    if (opacityInput) opacityInput.value = watermarkConfig.opacity;
    if (fontSizeInput) fontSizeInput.value = watermarkConfig.fontSize;
    if (fontFamilySelect) fontFamilySelect.value = watermarkConfig.fontFamily;
    if (settingsContainer) settingsContainer.style.display = watermarkConfig.enabled ? 'block' : 'none';

    // Êõ¥Êñ∞ÊòæÁ§∫ÂÄº
    updateWatermarkDisplayValues();

    // Â¶ÇÊûúÂêØÁî®ÔºåÂàõÂª∫Ê∞¥Âç∞Â±Ç
    if (watermarkConfig.enabled) {
      createWatermarkLayer();
    }
  }

  // ‰øùÂ≠òÊ∞¥Âç∞ËÆæÁΩÆ
  function saveWatermarkSettings() {
    localStorage.setItem('watermarkConfig', JSON.stringify(watermarkConfig));
  }

  // Êõ¥Êñ∞ÊòæÁ§∫ÂÄº
  function updateWatermarkDisplayValues() {
    const colorDisplay = document.getElementById('watermark-color-display');
    const opacityDisplay = document.getElementById('watermark-opacity-display');
    const fontSizeDisplay = document.getElementById('watermark-font-size-display');

    if (colorDisplay) colorDisplay.textContent = watermarkConfig.color;
    if (opacityDisplay) opacityDisplay.textContent = Math.round(watermarkConfig.opacity * 100) + '%';
    if (fontSizeDisplay) fontSizeDisplay.textContent = watermarkConfig.fontSize + 'px';
  }

  // ÁªëÂÆöÊ∞¥Âç∞ËÆæÁΩÆ‰∫ã‰ª∂
  function bindWatermarkEvents() {
    const enabledSwitch = document.getElementById('watermark-enabled-switch');
    const textInput = document.getElementById('watermark-text');
    const layoutSelect = document.getElementById('watermark-layout');
    const colorInput = document.getElementById('watermark-color');
    const opacityInput = document.getElementById('watermark-opacity');
    const fontSizeInput = document.getElementById('watermark-font-size');
    const fontFamilySelect = document.getElementById('watermark-font-family');
    const previewBtn = document.getElementById('watermark-preview-btn');
    const settingsContainer = document.getElementById('watermark-settings-container');

    // ÂêØÁî®/Á¶ÅÁî®Ê∞¥Âç∞
    if (enabledSwitch) {
      enabledSwitch.addEventListener('change', function() {
        watermarkConfig.enabled = this.checked;
        if (settingsContainer) {
          settingsContainer.style.display = this.checked ? 'block' : 'none';
        }
        saveWatermarkSettings();
        createWatermarkLayer();
      });
    }

    // Ê∞¥Âç∞ÊñáÂ≠ó
    if (textInput) {
      textInput.addEventListener('input', function() {
        watermarkConfig.text = this.value || '‰øùÂØÜÂÜÖÂÆπ ËØ∑ÂãøÂ§ñ‰º†';
        saveWatermarkSettings();
        if (watermarkConfig.enabled) {
          createWatermarkLayer();
        }
      });
    }

    // Â∏ÉÂ±ÄÊñπÂºè
    if (layoutSelect) {
      layoutSelect.addEventListener('change', function() {
        watermarkConfig.layout = this.value;
        saveWatermarkSettings();
        if (watermarkConfig.enabled) {
          createWatermarkLayer();
        }
      });
    }

    // È¢úËâ≤
    if (colorInput) {
      colorInput.addEventListener('input', function() {
        watermarkConfig.color = this.value;
        updateWatermarkDisplayValues();
        saveWatermarkSettings();
        if (watermarkConfig.enabled) {
          createWatermarkLayer();
        }
      });
    }

    // ÈÄèÊòéÂ∫¶
    if (opacityInput) {
      opacityInput.addEventListener('input', function() {
        watermarkConfig.opacity = parseFloat(this.value);
        updateWatermarkDisplayValues();
        saveWatermarkSettings();
        if (watermarkConfig.enabled) {
          createWatermarkLayer();
        }
      });
    }

    // Â≠ó‰ΩìÂ§ßÂ∞è
    if (fontSizeInput) {
      fontSizeInput.addEventListener('input', function() {
        watermarkConfig.fontSize = parseInt(this.value);
        updateWatermarkDisplayValues();
        saveWatermarkSettings();
        if (watermarkConfig.enabled) {
          createWatermarkLayer();
        }
      });
    }

    // Â≠ó‰Ωì
    if (fontFamilySelect) {
      fontFamilySelect.addEventListener('change', function() {
        watermarkConfig.fontFamily = this.value;
        saveWatermarkSettings();
        if (watermarkConfig.enabled) {
          createWatermarkLayer();
        }
      });
    }

    // È¢ÑËßàÊåâÈíÆ
    if (previewBtn) {
      previewBtn.addEventListener('click', function() {
        // ‰∏¥Êó∂ÊòæÁ§∫Ê∞¥Âç∞3Áßí
        const wasEnabled = watermarkConfig.enabled;
        watermarkConfig.enabled = true;
        createWatermarkLayer();
        
        // ÊòæÁ§∫ÊèêÁ§∫
        showCustomAlert('È¢ÑËßàÊ∞¥Âç∞', 'Ê∞¥Âç∞ÊïàÊûúÂ∑≤ÊòæÁ§∫ÔºåÂ∞ÜÂú®3ÁßíÂêéËá™Âä®ÈöêËóè');
        
        setTimeout(() => {
          watermarkConfig.enabled = wasEnabled;
          createWatermarkLayer();
        }, 3000);
      });
    }
  }

  // Âú®È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
  setTimeout(() => {
    loadWatermarkSettings();
    bindWatermarkEvents();
  }, 500);

  // ========== Êà™ÂõæÊ∞¥Âç∞ÂäüËÉΩÁªìÊùü ==========

  // ========== ÂêéÂè∞‰øùÊ¥ªÂäüËÉΩÂºÄÂßã ==========

  let keepAliveInterval = null;
  let keepAliveAudio = null;
  let wakeLock = null;
  let keepAliveWorker = null;
  let keepAliveSharedWorker = null;
  let keepAliveBroadcast = null;
  let keepAliveAnimationFrame = null;
  let keepAliveAudioContext = null;
  let keepAliveMultiTimers = [];
  let keepAliveWebRTC = null;
  let keepAliveAudioPlayer = null; // Áî®‰∫éÊòæÁ§∫ÁöÑÈü≥È¢ëÊí≠ÊîæÂô®

  // ÂàùÂßãÂåñÂêéÂè∞‰øùÊ¥ª
  async function initializeBackgroundKeepAlive() {
    if (!state.globalSettings.backgroundKeepAlive) {
      state.globalSettings.backgroundKeepAlive = {
        enabled: false
      };
    }
  }

  // ÂêØÂä®ÂêéÂè∞‰øùÊ¥ª
  async function startBackgroundKeepAlive() {
    console.log('[ÂêéÂè∞‰øùÊ¥ª] ÂêØÂä®ÂêéÂè∞‰øùÊ¥ªÔºàÈü≥È¢ëÊí≠ÊîæÂô®Ê®°ÂºèÔºâ...');

    // ÊòæÁ§∫‰øùÊ¥ªÈü≥È¢ëÈÖçÁΩÆÊåâÈíÆ
    const audioBtnContainer = document.getElementById('keep-alive-audio-btn-container');
    if (audioBtnContainer) {
      audioBtnContainer.style.display = 'flex';
    }

    // ÁõëÂê¨È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÔºàÁî®‰∫éÈü≥È¢ëÊÅ¢Â§çÔºâ
    document.addEventListener('visibilitychange', handleVisibilityChange);

    updateKeepAliveStatus('ËøêË°å‰∏≠ÔºàÈü≥È¢ëÊí≠ÊîæÂô®Ôºâ');
    console.log('[ÂêéÂè∞‰øùÊ¥ª] ‚úÖ ÂêéÂè∞‰øùÊ¥ªÂ∑≤ÂêØÂä®');
    console.log('[ÂêéÂè∞‰øùÊ¥ª] üí™ ‰ΩøÁî®Èü≥È¢ëÊí≠ÊîæÂô®ËøõË°åÂº∫Âäõ‰øùÊ¥ª');
  }

  // ÂÅúÊ≠¢ÂêéÂè∞‰øùÊ¥ª
  function stopBackgroundKeepAlive() {
    console.log('[ÂêéÂè∞‰øùÊ¥ª] ÂÅúÊ≠¢ÂêéÂè∞‰øùÊ¥ª...');

    // ÂÅúÊ≠¢Èü≥È¢ëÊí≠ÊîæÂô®Âπ∂ÈöêËóèÊåâÈíÆ
    const audioBtnContainer = document.getElementById('keep-alive-audio-btn-container');
    const audioPlayer = document.getElementById('keep-alive-audio-player');
    const audioModal = document.getElementById('keep-alive-audio-modal');

    if (audioPlayer && keepAliveAudioPlayer) {
      try {
        const oldSrc = audioPlayer.src;
        audioPlayer.pause();
        audioPlayer.src = '';
        // ÈáäÊîæURLÂØπË±°ÔºàÂ¶ÇÊûúÊòØblob URLÔºâ
        if (oldSrc && oldSrc.startsWith('blob:')) {
          URL.revokeObjectURL(oldSrc);
        }
        keepAliveAudioPlayer = null;
        console.log('[ÂêéÂè∞‰øùÊ¥ª] ‰øùÊ¥ªÈü≥È¢ëÂ∑≤ÂÅúÊ≠¢');
      } catch (error) {
        console.warn('[ÂêéÂè∞‰øùÊ¥ª] ÂÅúÊ≠¢‰øùÊ¥ªÈü≥È¢ëÂ§±Ë¥•:', error);
      }
    }

    if (audioBtnContainer) {
      audioBtnContainer.style.display = 'none';
    }

    if (audioModal) {
      audioModal.style.display = 'none';
    }

    // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨
    document.removeEventListener('visibilitychange', handleVisibilityChange);

    updateKeepAliveStatus('Êú™ÂêØÁî®');
    console.log('[ÂêéÂè∞‰øùÊ¥ª] ‚úÖ ÂêéÂè∞‰øùÊ¥ªÂ∑≤ÂÅúÊ≠¢');
  }

  // Â§ÑÁêÜÈ°µÈù¢ÂèØËßÅÊÄßÂèòÂåñ
  // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÂ§ÑÁêÜÔºàÁÆÄÂåñÁâàÔºâ
  async function handleVisibilityChange() {
    if (document.hidden) {
      console.log('[ÂêéÂè∞‰øùÊ¥ª] üîÑ È°µÈù¢ËøõÂÖ•ÂêéÂè∞');
    } else {
      console.log('[ÂêéÂè∞‰øùÊ¥ª] ‚úÖ È°µÈù¢ËøîÂõûÂâçÂè∞');
      
      // È°µÈù¢ËøîÂõûÂâçÂè∞Êó∂ÔºåÈáçÊñ∞Êí≠ÊîæÁî®Êà∑ÈÖçÁΩÆÁöÑ‰øùÊ¥ªÈü≥È¢ë
      if (state.globalSettings.backgroundKeepAlive?.enabled && keepAliveAudioPlayer && keepAliveAudioPlayer.src) {
        try {
          await keepAliveAudioPlayer.play();
          console.log('[ÂêéÂè∞‰øùÊ¥ª] ‰øùÊ¥ªÈü≥È¢ëÂ∑≤ÈáçÊñ∞Êí≠Êîæ');
        } catch (error) {
          console.warn('[ÂêéÂè∞‰øùÊ¥ª] ÈáçÊñ∞Êí≠Êîæ‰øùÊ¥ªÈü≥È¢ëÂ§±Ë¥•:', error);
        }
      }
    }
  }

  // Á©∫ÁöÑÂ§ÑÁêÜÂáΩÊï∞Ôºà‰øùÁïô‰ª•ÈÅøÂÖç‰∫ã‰ª∂ÁõëÂê¨Âô®ÈîôËØØÔºâ
  function handleStorageChange(event) {}
  function handlePageFreeze() {}
  function handlePageResume() {}

  // Êõ¥Êñ∞‰øùÊ¥ªÁä∂ÊÄÅÊòæÁ§∫
  function updateKeepAliveStatus(statusText) {
    const statusElement = document.getElementById('keep-alive-status-text');
    if (statusElement) {
      statusElement.textContent = statusText;

      // Ê†πÊçÆÁä∂ÊÄÅËÆæÁΩÆÈ¢úËâ≤
      if (statusText.includes('ËøêË°å‰∏≠')) {
        statusElement.style.color = '#4CAF50';
      } else {
        statusElement.style.color = '#999';
      }
    }
  }

  // ÁªëÂÆöÂêéÂè∞‰øùÊ¥ªÂºÄÂÖ≥‰∫ã‰ª∂
  function bindBackgroundKeepAliveEvents() {
    const keepAliveSwitch = document.getElementById('background-keep-alive-switch');
    const statusDiv = document.getElementById('keep-alive-status');
    const audioBtnContainer = document.getElementById('keep-alive-audio-btn-container');
    const audioBtn = document.getElementById('keep-alive-audio-btn');
    const audioModal = document.getElementById('keep-alive-audio-modal');
    const audioMinimize = document.getElementById('keep-alive-audio-minimize');
    const audioClose = document.getElementById('keep-alive-audio-close');
    const audioFile = document.getElementById('keep-alive-audio-file');
    const audioUrl = document.getElementById('keep-alive-audio-url');
    const audioLoadUrl = document.getElementById('keep-alive-audio-load-url');
    const audioPlayer = document.getElementById('keep-alive-audio-player');

    if (keepAliveSwitch) {
      keepAliveSwitch.addEventListener('change', async (e) => {
        const enabled = e.target.checked;
        state.globalSettings.backgroundKeepAlive.enabled = enabled;
        await db.globalSettings.put(state.globalSettings);

        // ÊòæÁ§∫/ÈöêËóèÁä∂ÊÄÅÂíåÈü≥È¢ëÊåâÈíÆÂÆπÂô®
        if (statusDiv) {
          statusDiv.style.display = enabled ? 'flex' : 'none';
        }

        if (enabled) {
          await startBackgroundKeepAlive();
          // ÊÅ¢Â§ç‰πãÂâç‰øùÂ≠òÁöÑÈü≥È¢ëURL
          const savedUrl = state.globalSettings.backgroundKeepAlive.audioUrl;
          if (savedUrl) {
            const ap = document.getElementById('keep-alive-audio-player');
            const au = document.getElementById('keep-alive-audio-url');
            if (ap) {
              ap.src = savedUrl;
              ap.loop = true;
              ap.play().then(() => {
                keepAliveAudioPlayer = ap;
                console.log('[ÂêéÂè∞‰øùÊ¥ª] ÂºÄÂÖ≥ÂºÄÂêØÔºåÂ∑≤ÊÅ¢Â§ç‰øùÂ≠òÁöÑÈü≥È¢ëURL');
              }).catch(err => {
                console.warn('[ÂêéÂè∞‰øùÊ¥ª] ÊÅ¢Â§çÈü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', err);
              });
            }
            if (au) au.value = savedUrl;
          }
        } else {
          stopBackgroundKeepAlive();
        }
      });
    }

    // ÊâìÂºÄÈü≥È¢ëÈÖçÁΩÆÈù¢Êùø
    if (audioBtn && audioModal) {
      audioBtn.addEventListener('click', () => {
        audioModal.style.display = 'flex';
      });
    }

    // ÊúÄÂ∞èÂåñÈü≥È¢ëÈÖçÁΩÆÈù¢ÊùøÔºàÂè™ÈöêËóèÂºπÁ™óÔºåÈü≥È¢ëÁªßÁª≠Êí≠ÊîæÔºâ
    if (audioMinimize && audioModal) {
      audioMinimize.addEventListener('click', () => {
        audioModal.style.display = 'none';
        console.log('[ÂêéÂè∞‰øùÊ¥ª] Êí≠ÊîæÂô®Â∑≤ÊúÄÂ∞èÂåñÔºåÈü≥È¢ëÁªßÁª≠Êí≠Êîæ');
      });
    }

    // ÂÖ≥Èó≠Èü≥È¢ëÈÖçÁΩÆÈù¢ÊùøÔºàÂÅúÊ≠¢Èü≥È¢ëÂπ∂ÈöêËóèÔºâ
    if (audioClose && audioModal && audioPlayer) {
      audioClose.addEventListener('click', async () => {
        // ÂÅúÊ≠¢Èü≥È¢ëÊí≠Êîæ
        if (keepAliveAudioPlayer) {
          try {
            const oldSrc = audioPlayer.src;
            audioPlayer.pause();
            audioPlayer.src = '';
            // ÈáäÊîæURLÂØπË±°ÔºàÂ¶ÇÊûúÊòØblob URLÔºâ
            if (oldSrc && oldSrc.startsWith('blob:')) {
              URL.revokeObjectURL(oldSrc);
            }
            keepAliveAudioPlayer = null;
            // Ê∏ÖÈô§‰øùÂ≠òÁöÑÈü≥È¢ëURL
            if (state.globalSettings.backgroundKeepAlive) {
              delete state.globalSettings.backgroundKeepAlive.audioUrl;
              await db.globalSettings.put(state.globalSettings);
            }
            console.log('[ÂêéÂè∞‰øùÊ¥ª] Êí≠ÊîæÂô®Â∑≤ÂÖ≥Èó≠ÔºåÈü≥È¢ëÂ∑≤ÂÅúÊ≠¢ÔºåÂ∑≤Ê∏ÖÈô§‰øùÂ≠òÁöÑURL');
          } catch (error) {
            console.warn('[ÂêéÂè∞‰øùÊ¥ª] ÂÅúÊ≠¢Èü≥È¢ëÂ§±Ë¥•:', error);
          }
        }
        audioModal.style.display = 'none';
      });
    }

    // ÁÇπÂáªËÉåÊôØÊúÄÂ∞èÂåñÔºàÂè™ÈöêËóèÂºπÁ™óÔºåÈü≥È¢ëÁªßÁª≠Êí≠ÊîæÔºâ
    if (audioModal) {
      audioModal.addEventListener('click', (e) => {
        if (e.target === audioModal) {
          audioModal.style.display = 'none';
          console.log('[ÂêéÂè∞‰øùÊ¥ª] Êí≠ÊîæÂô®Â∑≤ÊúÄÂ∞èÂåñÔºåÈü≥È¢ëÁªßÁª≠Êí≠Êîæ');
        }
      });
    }

    // Â§ÑÁêÜÊú¨Âú∞Êñá‰ª∂‰∏ä‰º†
    if (audioFile && audioPlayer) {
      audioFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          try {
            // ÈáäÊîæ‰πãÂâçÁöÑURL
            if (audioPlayer.src && audioPlayer.src.startsWith('blob:')) {
              URL.revokeObjectURL(audioPlayer.src);
            }

            const fileUrl = URL.createObjectURL(file);
            audioPlayer.src = fileUrl;
            audioPlayer.loop = true;
            audioPlayer.play().then(() => {
              keepAliveAudioPlayer = audioPlayer;
              console.log('[ÂêéÂè∞‰øùÊ¥ª] Êú¨Âú∞Èü≥È¢ëÂ∑≤Âä†ËΩΩÂπ∂Êí≠Êîæ');
            }).catch(err => {
              console.warn('[ÂêéÂè∞‰øùÊ¥ª] Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', err);
            });
          } catch (error) {
            console.error('[ÂêéÂè∞‰øùÊ¥ª] Âä†ËΩΩÊú¨Âú∞Èü≥È¢ëÂ§±Ë¥•:', error);
            alert('Âä†ËΩΩÈü≥È¢ëÊñá‰ª∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
          }
        }
      });
    }

    // Â§ÑÁêÜURLÂä†ËΩΩ
    if (audioLoadUrl && audioUrl && audioPlayer) {
      audioLoadUrl.addEventListener('click', async () => {
        const url = audioUrl.value.trim();
        if (!url) {
          alert('ËØ∑ËæìÂÖ•Èü≥È¢ëURL');
          return;
        }

        try {
          // ÈáäÊîæ‰πãÂâçÁöÑURL
          if (audioPlayer.src && audioPlayer.src.startsWith('blob:')) {
            URL.revokeObjectURL(audioPlayer.src);
          }

          audioPlayer.src = url;
          audioPlayer.loop = true;
          audioPlayer.play().then(async () => {
            keepAliveAudioPlayer = audioPlayer;
            console.log('[ÂêéÂè∞‰øùÊ¥ª] URLÈü≥È¢ëÂ∑≤Âä†ËΩΩÂπ∂Êí≠Êîæ');
            // ‰øùÂ≠òURLÂà∞ËÆæÁΩÆ‰∏≠ÔºåÂà∑Êñ∞ÂêéÂèØÊÅ¢Â§ç
            state.globalSettings.backgroundKeepAlive.audioUrl = url;
            await db.globalSettings.put(state.globalSettings);
            console.log('[ÂêéÂè∞‰øùÊ¥ª] Èü≥È¢ëURLÂ∑≤‰øùÂ≠ò');
          }).catch(err => {
            console.warn('[ÂêéÂè∞‰øùÊ¥ª] Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', err);
            alert('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•ÔºåÂèØËÉΩÊòØURLÊó†ÊïàÊàñË∑®ÂüüÈóÆÈ¢ò');
          });
        } catch (error) {
          console.error('[ÂêéÂè∞‰øùÊ¥ª] Âä†ËΩΩURLÈü≥È¢ëÂ§±Ë¥•:', error);
          alert('Âä†ËΩΩÈü≥È¢ëURLÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•URLÊòØÂê¶Ê≠£Á°Æ');
        }
      });
    }
  }

  // Âä†ËΩΩÂêéÂè∞‰øùÊ¥ªËÆæÁΩÆÂà∞UI
  function loadBackgroundKeepAliveSettings() {
    const config = state.globalSettings.backgroundKeepAlive;
    if (!config) return;

    const keepAliveSwitch = document.getElementById('background-keep-alive-switch');
    const statusDiv = document.getElementById('keep-alive-status');
    const audioBtnContainer = document.getElementById('keep-alive-audio-btn-container');

    if (keepAliveSwitch) {
      keepAliveSwitch.checked = config.enabled || false;

      if (statusDiv) {
        statusDiv.style.display = config.enabled ? 'flex' : 'none';
      }

      // Â¶ÇÊûú‰πãÂâçÊòØÂºÄÂêØÁä∂ÊÄÅÔºåÈáçÊñ∞ÂêØÂä®‰øùÊ¥ª
      if (config.enabled) {
        startBackgroundKeepAlive();

        // ÊÅ¢Â§ç‰πãÂâç‰øùÂ≠òÁöÑÈü≥È¢ëURL
        if (config.audioUrl) {
          const audioPlayer = document.getElementById('keep-alive-audio-player');
          const audioUrl = document.getElementById('keep-alive-audio-url');
          if (audioPlayer) {
            audioPlayer.src = config.audioUrl;
            audioPlayer.loop = true;
            audioPlayer.play().then(() => {
              keepAliveAudioPlayer = audioPlayer;
              console.log('[ÂêéÂè∞‰øùÊ¥ª] Â∑≤ÊÅ¢Â§ç‰øùÂ≠òÁöÑÈü≥È¢ëURLÂπ∂Êí≠Êîæ');
            }).catch(err => {
              console.warn('[ÂêéÂè∞‰øùÊ¥ª] ÊÅ¢Â§çÈü≥È¢ëÊí≠ÊîæÂ§±Ë¥•ÔºàÂèØËÉΩÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÔºâ:', err);
            });
          }
          // ÊÅ¢Â§çURLËæìÂÖ•Ê°ÜÁöÑÂÄº
          if (audioUrl) {
            audioUrl.value = config.audioUrl;
          }
        }
      } else {
        // Â¶ÇÊûúÊòØÂÖ≥Èó≠Áä∂ÊÄÅÔºåÁ°Æ‰øùÈü≥È¢ëÊåâÈíÆÂÆπÂô®ÈöêËóè
        if (audioBtnContainer) {
          audioBtnContainer.style.display = 'none';
        }
      }
    }
  }

  // ========== ÂêéÂè∞‰øùÊ¥ªÂäüËÉΩÁªìÊùü ==========


  function applyWidgetData() {
    // ÂÖà‰øùÂ≠òÊâÄÊúâÂèØÁºñËæëÂõæÁâáÁöÑÈªòËÆ§ srcÔºàÂ¶ÇÊûúËøòÊ≤°‰øùÂ≠òÁöÑËØùÔºâ
    const editableImages = document.querySelectorAll('.editable-image');
    editableImages.forEach(img => {
      if (!img.dataset.defaultSrc) {
        img.dataset.defaultSrc = img.src;
      }
    });

    if (!state.globalSettings.widgetData) return;
    for (const elementId in state.globalSettings.widgetData) {
      const element = document.getElementById(elementId);
      const savedValue = state.globalSettings.widgetData[elementId];
      if (element) {
        if (element.tagName === 'IMG') {
          element.src = savedValue;
        } else {
          element.textContent = savedValue;
        }
      }
    }
  }


  function uploadImageLocally() {
    return new Promise(resolve => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*'; // Âè™Êé•ÂèóÂõæÁâáÊñá‰ª∂

      input.onchange = e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async (readerEvent) => {
            let base64Result = readerEvent.target.result;


            if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
              try {

                const alertModal = document.getElementById('custom-modal-overlay');
                if (!alertModal.classList.contains('visible')) {
                  await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®‰∏ä‰º†ÂõæÁâáÂà∞ ImgBB...");
                }
                const imageUrl = await uploadImageToImgBB(base64Result);
                resolve(imageUrl);
              } catch (uploadError) {
                console.error(uploadError);
                await showCustomAlert("ImgBB ‰∏ä‰º†Â§±Ë¥•", `ÂõæÁâá‰∏ä‰º†Âà∞ÂõæÂ∫äÂ§±Ë¥•: ${uploadError.message}\n\nÂ∞ÜÁªßÁª≠‰ΩøÁî®Êú¨Âú∞ Base64 Ê†ºÂºè‰øùÂ≠ò„ÄÇ`);
                resolve(base64Result);
              }
            } else {

              resolve(base64Result);
            }
          };
          reader.readAsDataURL(file);
        } else {
          resolve(null); // Áî®Êà∑ÂÖ≥Èó≠‰∫ÜÊñá‰ª∂ÈÄâÊã©Ê°Ü
        }
      };

      input.click();
    });
  }


  async function handleEditText(element) {
    const elementId = element.id;
    const currentValue = element.textContent;
    const newValue = await showCustomPrompt("‰øÆÊîπÊñáÂ≠ó", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂÜÖÂÆπÔºö", currentValue);
    if (newValue !== null && newValue.trim() !== "") {
      const trimmedValue = newValue.trim();
      element.textContent = trimmedValue;
      state.globalSettings.widgetData[elementId] = trimmedValue;
      await db.globalSettings.put(state.globalSettings);
      alert("ÊñáÂ≠óÂ∑≤Êõ¥Êñ∞ÔºÅ");

    }
  }


  async function handleEditImage(element) {
    const elementId = element.id;

    const choice = await showChoiceModal("‰øÆÊîπÂõæÁâá", [
      { text: 'üìÅ ‰ªéÊú¨Âú∞‰∏ä‰º†', value: 'local' },
      { text: 'üåê ‰ΩøÁî®ÁΩëÁªúURL', value: 'url' },
      { text: 'üîÑ ÈáçÁΩÆ‰∏∫ÈªòËÆ§', value: 'reset' }
    ]);

    // Â§ÑÁêÜÈáçÁΩÆÈÄªËæë
    if (choice === 'reset') {
      const defaultSrc = element.dataset.defaultSrc;
      if (defaultSrc) {
        // ÊÅ¢Â§çÂà∞ÈªòËÆ§ÂõæÁâá
        element.src = defaultSrc;

        // ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§ËØ•ËÆ∞ÂΩï
        if (state.globalSettings.widgetData && state.globalSettings.widgetData[elementId]) {
          delete state.globalSettings.widgetData[elementId];
          await db.globalSettings.put(state.globalSettings);
        }

        await showCustomAlert("ÊàêÂäü", "Â∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂõæÁâáÔºÅ");
      } else {
        // Ê≤°ÊúâÈªòËÆ§ÂõæÁâáÔºåÈáçÁΩÆ‰∏∫Á∫ØÁôΩËâ≤
        // ÂàõÂª∫‰∏Ä‰∏™1x1ÁöÑÁ∫ØÁôΩËâ≤ÂõæÁâáÁöÑBase64
        const whitePixel = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2P4//8/AAX+Av4N70a4AAAAAElFTkSuQmCC';
        element.src = whitePixel;

        // ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§ËØ•ËÆ∞ÂΩï
        if (state.globalSettings.widgetData && state.globalSettings.widgetData[elementId]) {
          delete state.globalSettings.widgetData[elementId];
          await db.globalSettings.put(state.globalSettings);
        }

        await showCustomAlert("ÊàêÂäü", "Ê≤°ÊúâÈªòËÆ§‰ø°ÊÅØÔºåÂ∑≤ÈáçÁΩÆ‰∏∫Á∫ØÁôΩÔºÅ");
      }
      return;
    }

    let newUrl = null;
    let isBase64 = false; // Ê†áËÆ∞ÊòØÂê¶‰∏∫ Base64

    if (choice === 'local') {
      newUrl = await new Promise(resolve => { // ÁÆÄÂåñÁâà uploadImageLocally
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = e => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (readerEvent) => resolve(readerEvent.target.result);
            reader.readAsDataURL(file);
          } else {
            resolve(null);
          }
        };
        input.click();
      });
      if (newUrl) isBase64 = true;

    } else if (choice === 'url') {
      newUrl = await showCustomPrompt("‰øÆÊîπÂõæÁâá", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂõæÁâáURLÔºö", element.src, "url");
      if (newUrl) isBase64 = false;
    }

    if (newUrl && newUrl.trim()) {
      const trimmedUrl = newUrl.trim();

      // 1. [Ê†∏ÂøÉ‰øÆÊîπ] Á´ãÂç≥ÊòæÁ§∫ Base64 Êàñ URL
      element.src = trimmedUrl;

      // 2. Á´ãÂç≥Â∞Ü Base64 Êàñ URL ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÁ°Æ‰øùÂà∑Êñ∞‰∏ç‰∏¢Â§±
      if (!state.globalSettings.widgetData) {
        state.globalSettings.widgetData = {};
      }
      state.globalSettings.widgetData[elementId] = trimmedUrl;
      await db.globalSettings.put(state.globalSettings);

      await showCustomAlert("ÊàêÂäü", "ÁªÑ‰ª∂ÂõæÁâáÂ∑≤Êõ¥Êñ∞Âπ∂‰øùÂ≠òÔºÅ");

      // 3. [Ê†∏ÂøÉ‰øÆÊîπ] Âè™ÊúâÂΩìÂÆÉÊòØ Base64 ‰∏î ImgBB ÂºÄÂêØÊó∂ÔºåÊâçÂú®ÂêéÂè∞‚ÄúÈùôÈªò‚Äù‰∏ä‰º†
      if (isBase64 && state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
        (async () => {
          console.log(`[ImgBB] ÂêØÂä® ${elementId} ÁöÑÈùôÈªò‰∏ä‰º†...`);
          // Ëøô‰∏™ÂáΩÊï∞‰ºöÂú®ÂêéÂè∞ËøêË°åÔºå‰∏ç‰ºöÈòªÂ°û
          await silentlyUpdateDbUrl(
            db.globalSettings,
            'main',
            `widgetData.${elementId}`,
            trimmedUrl // ‰º†ÂÖ• Base64 Â≠óÁ¨¶‰∏≤
          );
        })();
      }
    }
  }



  const cacheManager = {
    getSongCache(query, source) {
      const key = `${source || 'all'}:${query}`;
      if (state.cache && state.cache.songs) {
        const cached = state.cache.songs.get(key);
        if (cached && Date.now() - cached.timestamp < 3600000) {
          return cached.data;
        }
      }
      return null;
    },
    setSongCache(query, data, source) {
      const key = `${source || 'all'}:${query}`;
      if (!state.cache) state.cache = {};
      if (!state.cache.songs) state.cache.songs = new Map();
      state.cache.songs.set(key, {
        data,
        timestamp: Date.now()
      });
    }
  };

  if (typeof Http_Get_External === 'undefined') {
    window.Http_Get_External = function (url) {
      return new Promise((resolve) => {
        fetch(url).then(res => res.json().catch(() => res.text())).then(resolve).catch(() => resolve(null));
      });
    }
  }
  async function Http_Get(url) {
    return await Http_Get_External(url);
  }

  function checkAudioAvailability(url) {
    return new Promise(resolve => {
      const tester = new Audio();
      tester.addEventListener('loadedmetadata', () => resolve(true), {
        once: true
      });
      tester.addEventListener('error', () => resolve(false), {
        once: true
      });
      tester.src = url;
    });
  }


  async function searchNeteaseMusic(name, singer) {
    try {
      let searchTerm = name.replace(/\s/g, "");
      if (singer) {
        searchTerm += ` ${singer.replace(/\s/g, "")}`;
      }

      const apiUrl = `https://api.vkeys.cn/v2/music/netease?word=${encodeURIComponent(searchTerm)}`;

      console.log("Ê≠£Âú®ËØ∑Ê±ÇÁΩëÊòì‰∫ëÈü≥‰πêAPI:", apiUrl);

      const response = await fetch(apiUrl);

      if (!response.ok) {
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å: ${response.status}`);
      }

      const result = await response.json();

      if (result.code !== 200 || !result.data || result.data.length === 0) {
        console.log("ÁΩëÊòì‰∫ëÈü≥‰πêAPIÊú™ËøîÂõûÊúâÊïàÁªìÊûú:", result);
        return [];
      }


      return result.data.map(song => ({
        name: song.song,
        artist: song.singer,
        id: song.id,
        cover: song.cover || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png',
        source: 'netease'
      })).slice(0, 30);

    } catch (e) {
      console.error("ÁΩëÊòì‰∫ëÈü≥‰πêÊêúÁ¥¢Â§±Ë¥•:", e);

      return [];
    }
  }
  // --- Toubiec API Ê†∏ÂøÉÈÄªËæë (‰øÆÂ§çÁâà) ---
  const TOUBIEC_BASE_URL = 'https://wyapi-1.toubiec.cn/api/music';

  async function fetchToubiec(endpoint, bodyData) {
    try {
      const response = await fetch(`${TOUBIEC_BASE_URL}/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(bodyData)
      });
      const result = await response.json();
      return result;
    } catch (error) {
      console.error(`Toubiec API Error [${endpoint}]:`, error);
      return null;
    }
  }

  // 1. ÊêúÁ¥¢ÂäüËÉΩ (‰øÆÂ§ç‰∫ÜÊï∞ÊçÆÁªìÊûÑËß£Êûê)
  // 1. ÊêúÁ¥¢ÂäüËÉΩ (‰øÆÂ§çÂ≠óÊÆµÊò†Â∞Ñ)
  // 1. ÊêúÁ¥¢ÂäüËÉΩ (‰øÆÂ§çÂ≠óÊÆµÊò†Â∞ÑÔºöÈÄÇÈÖç picimg Âíå singer)
  async function searchToubiec(keyword) {
    const res = await fetchToubiec('search', { keywords: keyword, page: 1 });

    // ÂÖºÂÆπÂ§ÑÁêÜÔºöÊï∞ÊçÆÂèØËÉΩÂú® data, data.list, data.songs ‰∏≠
    let songList = [];
    if (res) {
      if (Array.isArray(res)) {
        songList = res;
      } else if (res.data) {
        if (Array.isArray(res.data)) {
          songList = res.data;
        } else if (Array.isArray(res.data.list)) {
          songList = res.data.list;
        } else if (Array.isArray(res.data.songs)) {
          songList = res.data.songs;
        }
        // ÈíàÂØπ‰Ω†Êèê‰æõÁöÑJSONÁªìÊûÑÔºöÁõ¥Êé•ËøîÂõû‰∫Ü data ÂØπË±°ÁöÑÊÉÖÂÜµÔºàËôΩ‰∏çÂ∞ëËßÅ‰ΩÜ‰∏∫‰∫Ü‰øùÈô©Ôºâ
        else if (typeof res.data === 'object') {
          songList = [res.data];
        }
      }
    }

    if (songList.length === 0) return [];

    return songList.map(song => ({
      name: song.name,
      // „Äê‰øÆÂ§ç„Äë‰ºòÂÖàËØªÂèñ singer (‰Ω†ÁöÑAPIËøîÂõûÂ≠óÊÆµ)ÔºåÂÖ∂Ê¨° artists
      artist: song.singer || song.artists || (Array.isArray(song.ar) ? song.ar.map(a => a.name).join('/') : (song.artist || 'Êú™Áü•Ê≠åÊâã')),
      id: String(song.id),
      // „Äê‰øÆÂ§ç„Äë‰ºòÂÖàËØªÂèñ picimg (‰Ω†ÁöÑAPIËøîÂõûÂ≠óÊÆµ)
      cover: song.picimg || song.cover || song.al?.picUrl || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg',
      source: 'toubiec',
      albumId: song.al?.id
    }));
  }

  // 2. Ëß£ÊûêÊ≠åÂçï (ËæìÂÖ•Ê≠åÂçïID)
  async function getToubiecPlaylist(playlistId) {
    const res = await fetchToubiec('playlist', { id: String(playlistId) });
    if (!res || !res.data || !res.data.tracks) return [];

    return res.data.tracks.map(song => ({
      name: song.name,
      artist: Array.isArray(song.ar) ? song.ar.map(a => a.name).join('/') : (song.artist || 'Êú™Áü•Ê≠åÊâã'),
      id: String(song.id),
      cover: song.al?.picUrl || song.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg',
      source: 'toubiec'
    }));
  }

  // 3. Ëß£Êûê‰∏ìËæë (ËæìÂÖ•‰∏ìËæëID)
  async function getToubiecAlbum(albumId) {
    const res = await fetchToubiec('album', { id: String(albumId) });
    if (!res || !res.data || !res.data.songs) return [];

    return res.data.songs.map(song => ({
      name: song.name,
      artist: Array.isArray(song.ar) ? song.ar.map(a => a.name).join('/') : 'Êú™Áü•Ê≠åÊâã',
      id: String(song.id),
      cover: song.al?.picUrl || res.data.album?.picUrl, // ‰ºòÂÖàÁî®ÂçïÊõ≤Â∞ÅÈù¢ÔºåÊ≤°ÊúâÂàôÁî®‰∏ìËæëÂ∞ÅÈù¢
      source: 'toubiec'
    }));
  }
  // 6. [Êñ∞Â¢û] Ëé∑ÂèñÊ≠åÊõ≤ËØ¶ÊÉÖ (Áî®‰∫é‰øÆÂ§çÂ∞ÅÈù¢ÂíåÊ≠åÊâã‰ø°ÊÅØ)
  async function getToubiecDetail(id) {
    // Ë∞ÉÁî® detail Êé•Âè£
    const res = await fetchToubiec('detail', { id: String(id) });
    if (res && res.code === 200 && res.data) {
      return res.data; // ËøîÂõûÂåÖÂê´ picimg, singer Á≠â‰ø°ÊÅØÁöÑÂØπË±°
    }
    return null;
  }
  // 4. Ëé∑ÂèñÈ´òÈü≥Ë¥®Êí≠ÊîæÈìæÊé• (‰øÆÂ§çÁâàÔºöÈÄÇÈÖç data ‰∏∫Êï∞ÁªÑÁöÑÊÉÖÂÜµ)
  async function getToubiecUrl(id, preferredLevel = 'exhigh') {
    // ÂÆö‰πâÈü≥Ë¥®ÈôçÁ∫ßÈìæ
    const qualityLadder = ['jymaster', 'dolby', 'sky', 'jyeffect', 'hires', 'lossless', 'exhigh', 'standard'];

    let startIndex = qualityLadder.indexOf(preferredLevel);
    if (startIndex === -1) startIndex = 5;

    for (let i = startIndex; i < qualityLadder.length; i++) {
      const level = qualityLadder[i];
      const res = await fetchToubiec('url', { id: String(id), level: level });

      if (res && res.code === 200 && res.data) {
        let url = null;

        // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë‰Ω†Êèê‰æõÁöÑJSONÊòæÁ§∫ data ÊòØ‰∏Ä‰∏™Êï∞ÁªÑ [{id:..., url:...}]
        if (Array.isArray(res.data) && res.data.length > 0) {
          // ÂèñÊï∞ÁªÑÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÁöÑ url Â≠óÊÆµ
          url = res.data[0].url;
        }
        // ÂÖºÂÆπ data ÊòØÂØπË±°ÁöÑÊÉÖÂÜµ
        else if (!Array.isArray(res.data) && res.data.url) {
          url = res.data.url;
        }

        if (url) {
          console.log(`[Toubiec] ÊàêÂäüËé∑ÂèñÈìæÊé• (${level}): ${url}`);
          // Á°Æ‰øù HTTPSÔºåÈò≤Ê≠¢Ê∑∑ÂêàÂÜÖÂÆπÊä•Èîô
          return url.replace(/^http:\/\//i, 'https://');
        }
      }
    }
    console.warn(`[Toubiec] Êú™ËÉΩËé∑Âèñ‰ªª‰ΩïÈü≥Ë¥®ÁöÑÈìæÊé•: ID ${id}`);
    return null;
  }

  // 5. Ëé∑ÂèñÊ≠åËØç
  async function getToubiecLyric(id) {
    const res = await fetchToubiec('lyric', { id: String(id) });
    if (res && res.data) {
      // ÁªÑÂêàÂéüËØç(lrc)ÂíåÁøªËØë(tlyric)
      const lrc = res.data.lrc || "";
      const tlyric = res.data.tlyric || "";
      return lrc + "\n" + tlyric;
    }
    return "";
  }
  // --- Toubiec API ÈõÜÊàêÁªìÊùü ---

  async function searchTencentMusic(name) {
    try {
      name = name.replace(/\s/g, "");
      const result = await Http_Get(`https://api.vkeys.cn/v2/music/tencent?word=${encodeURIComponent(name)}`);
      if (!result?.data?.length) return [];
      return result.data.map(song => ({
        name: song.song,
        artist: song.singer,
        id: song.id,
        cover: song.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg',
        source: 'tencent'
      })).slice(0, 30);
    } catch (e) {
      console.error("QQÈü≥‰πêÊêúÁ¥¢APIÂ§±Ë¥•:", e);
      return [];
    }
  }

  // --- 3. ÈáçÊûÑÊêúÁ¥¢‰∏ªÂÖ•Âè£ (Â∑≤ÂéªÈô§ÂõæÊ†á) ---
  // --- 3. ÈáçÊûÑÊêúÁ¥¢‰∏ªÂÖ•Âè£ (Â∑≤ÂéªÈô§ÂõæÊ†á) ---
  async function addSongFromSearch() {
    // 1. Á¨¨‰∏ÄÊ≠•ÔºöÈÄâÊã©Ê®°Âºè (ÂéªÈô§‰∫Ü Emoji)
    const modeChoice = await showChoiceModal("ËØ∑ÈÄâÊã©Êìç‰ΩúÊ®°Âºè", [
      { text: 'ÊêúÁ¥¢Ê≠åÊõ≤ (Êñ∞Ê∫ê¬∑ÊîØÊåÅÈÄâÈü≥Ë¥®)', value: 'search_new' },
      { text: 'Ëß£ÊûêÊ≠åÂçï (ËæìÂÖ•ID)', value: 'playlist_new' },
      { text: 'Ëß£Êûê‰∏ìËæë (ËæìÂÖ•ID)', value: 'album_new' },
      { text: 'ÊôÆÈÄöÊêúÁ¥¢ (ÁΩëÊòì/ËÖæËÆØÊóßÊ∫ê)', value: 'search_old' }
    ]);

    if (!modeChoice) return;

    let searchResults = [];
    let selectedQuality = 'exhigh'; // ÈªòËÆ§ÊûÅÈ´ò

    // 2. Á¨¨‰∫åÊ≠•ÔºöÂ¶ÇÊûúÊòØÊñ∞Ê∫êÔºåÈÄâÊã©Èü≥Ë¥® (ÂéªÈô§‰∫Ü Emoji)
    if (modeChoice.includes('_new')) {
      const qualityChoice = await showChoiceModal("ËØ∑ÈÄâÊã©ÊúüÊúõÈü≥Ë¥®", [
        { text: 'Êó†Êçü (Lossless - FLAC)', value: 'lossless' },
        { text: 'È´òËß£Êûê (Hi-Res - FLAC)', value: 'hires' },
        { text: 'ÊØçÂ∏¶Á∫ß (Master - FLAC)', value: 'jymaster' },
        { text: 'ÊùúÊØîÂÖ®ÊôØÂ£∞ (Dolby - MP4)', value: 'dolby' },
        { text: 'ÊûÅÈ´ò (ExHigh - MP3)', value: 'exhigh' },
        { text: 'Ê†áÂáÜ (Standard - MP3)', value: 'standard' },
        { text: 'ÁéØÁªïÊ≤âÊµ∏ (Sky)', value: 'sky' },
        { text: 'Á©∫Èó¥Èü≥Êïà (Effect)', value: 'jyeffect' }
      ]);
      if (!qualityChoice) return;
      selectedQuality = qualityChoice;
    }

    // 3. Á¨¨‰∏âÊ≠•ÔºöËæìÂÖ•ÂÖ≥ÈîÆËØçÊàñID
    let promptText = "ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÂêçÁß∞";
    if (modeChoice === 'playlist_new') promptText = "ËØ∑ËæìÂÖ•Ê≠åÂçï ID (Êï∞Â≠ó)";
    if (modeChoice === 'album_new') promptText = "ËØ∑ËæìÂÖ•‰∏ìËæë ID (Êï∞Â≠ó)";

    const input = await showCustomPrompt(promptText, "Âú®Ê≠§ËæìÂÖ•...");
    if (!input || !input.trim()) return;
    const query = input.trim();

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇËµÑÊ∫ê...");

    // 4. ÊâßË°åÊêúÁ¥¢/Ëß£Êûê (‰øùÊåÅÂéüÈÄªËæë‰∏çÂèò)
    try {
      if (modeChoice === 'search_new') {
        searchResults = await searchToubiec(query);
      }
      else if (modeChoice === 'playlist_new') {
        searchResults = await getToubiecPlaylist(query);
        if (searchResults.length > 0) {
          await showCustomAlert("Ëß£ÊûêÊàêÂäü", `ÊàêÂäüËß£ÊûêÊ≠åÂçïÔºåÂÖ± ${searchResults.length} È¶ñÊ≠åÊõ≤„ÄÇ`);
        }
      }
      else if (modeChoice === 'album_new') {
        searchResults = await getToubiecAlbum(query);
        if (searchResults.length > 0) {
          await showCustomAlert("Ëß£ÊûêÊàêÂäü", `ÊàêÂäüËß£Êûê‰∏ìËæëÔºåÂÖ± ${searchResults.length} È¶ñÊ≠åÊõ≤„ÄÇ`);
        }
      }
      else if (modeChoice === 'search_old') {
        // ÊóßÁâàÂπ∂Ë°åÊêúÁ¥¢ÈÄªËæë
        let musicName = query;
        let singerName = "";
        if (query.includes('-')) {
          const parts = query.split('-');
          musicName = parts[0].trim();
          singerName = parts[1].trim();
        }
        const [netease, tencent] = await Promise.all([
          searchNeteaseMusic(musicName, singerName),
          searchTencentMusic(musicName)
        ]);
        searchResults = [...netease, ...tencent];
      }
    } catch (e) {
      console.error(e);
      await showCustomAlert("ÈîôËØØ", "ÊêúÁ¥¢ÊàñËß£ÊûêËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºåËØ∑Ê£ÄÊü•IDÊòØÂê¶Ê≠£Á°Æ„ÄÇ");
      return;
    }

    // 5. Ê∏≤ÊüìÁªìÊûú
    if (searchResults.length === 0) {
      await showCustomAlert("Êó†ÁªìÊûú", "Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÂÜÖÂÆπ„ÄÇ");
      return;
    }

    const modal = document.getElementById('music-search-results-modal');
    const listEl = document.getElementById('search-results-list');
    listEl.innerHTML = '';
    document.getElementById('select-all-music-search').checked = false;

    searchResults.forEach(song => {
      // „ÄêÂÖ≥ÈîÆ„ÄëÂ∞ÜÁî®Êà∑ÈÄâÊã©ÁöÑÈü≥Ë¥®ÂÜôÂÖ•Ê≠åÊõ≤ÂØπË±°
      if (modeChoice.includes('_new')) {
        song.preferredQuality = selectedQuality;
      }

      const item = document.createElement('div');
      item.className = 'search-result-item';
      item.dataset.songJson = JSON.stringify(song);

      // ÊòæÁ§∫Êù•Ê∫êÊ†áÁ≠æ (ÂéªÈô§‰∫Ü Emoji)
      let sourceTag = '';
      if (song.source === 'toubiec') {
        // ÊòæÁ§∫ÂÖ∑‰ΩìÁöÑÈü≥Ë¥®Ê†áÁ≠æ
        const qualityLabels = {
          'lossless': 'Êó†Êçü', 'hires': 'Hi-Res', 'jymaster': 'ÊØçÂ∏¶',
          'dolby': 'ÊùúÊØî', 'exhigh': 'ÊûÅÈ´ò', 'standard': 'Ê†áÂáÜ',
          'sky': 'ÂÖ®ÊôØ', 'jyeffect': 'Á©∫Èó¥'
        };
        const qLabel = qualityLabels[selectedQuality] || 'Pro';
        sourceTag = `<span class="source" style="color:#ff3b30; border-color:#ff3b30;">${qLabel}</span>`;
      } else if (song.source === 'netease') {
        sourceTag = '<span class="source" style="color:#c20c0c; border-color:#c20c0c;">ÁΩëÊòì‰∫ë</span>';
      } else {
        sourceTag = '<span class="source" style="color:#00e09e; border-color:#00e09e;">QQÈü≥‰πê</span>';
      }

      item.innerHTML = `
            <input type="checkbox" class="music-search-checkbox" style="margin-right: 15px;">
            <div class="search-result-info">
                <div class="title">${song.name}</div>
                <div class="artist">${song.artist} ${sourceTag}</div>
            </div>
        `;
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
  }


  // --- 2. ‰øÆÊîπËØ¶ÊÉÖËé∑ÂèñÈÄªËæë (‰øÆÂ§çÁâàÔºöÂ¢ûÂä† detail Ëß£Êûê‰ª•Ëé∑ÂèñÂ∞ÅÈù¢) ---
  async function getPlayableSongDetails(songData) {
    let playableResult = null;
    let finalSource = songData.source;

    // --- Â§ÑÁêÜ Toubiec Ê∫ê ---
    if (songData.source === 'toubiec') {
      const quality = songData.preferredQuality || 'exhigh';

      // 1. Ëé∑ÂèñÊí≠ÊîæÈìæÊé•
      const url = await getToubiecUrl(songData.id, quality);

      // 2. „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëËé∑ÂèñÊ≠åÊõ≤ËØ¶ÊÉÖ (‰∏∫‰∫ÜÊãøÂà∞ picimg Â∞ÅÈù¢)
      try {
        const detail = await getToubiecDetail(songData.id);
        if (detail) {
          // Â¶ÇÊûúAPIËøîÂõû‰∫ÜÂ∞ÅÈù¢ÔºåÂº∫Âà∂Êõ¥Êñ∞
          if (detail.picimg) {
            console.log(`[Toubiec] Ëé∑ÂèñÂà∞Â∞ÅÈù¢: ${detail.picimg}`);
            songData.cover = detail.picimg;
          }
          // ÂêåÊ≠•Êõ¥Êñ∞Ê≠åÊâãÂêç
          if (detail.singer) {
            songData.artist = detail.singer;
          }
        }
      } catch (e) {
        console.warn("[Toubiec] Ëé∑ÂèñËØ¶ÊÉÖÂ§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî®ÈªòËÆ§Â∞ÅÈù¢", e);
      }

      if (url) {
        playableResult = {
          url: url.replace(/^http:\/\//i, 'https://'), // Âº∫Âà∂ HTTPS
          id: songData.id,
          source: 'toubiec'
        };
      }
    }
    // --- ÂéüÊúâÈÄªËæë (ÁΩëÊòì/ËÖæËÆØ) ---
    else if (songData.source === 'netease') {
      const primaryApiUrl = `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`;
      let primaryResult = await Http_Get(primaryApiUrl);
      if (primaryResult?.data?.url) {
        playableResult = { url: primaryResult.data.url, id: songData.id, source: songData.source };
      }
    } else {
      const primaryApiUrl = `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
      let primaryResult = await Http_Get(primaryApiUrl);
      if (primaryResult?.data?.url) {
        playableResult = { url: primaryResult.data.url, id: songData.id, source: songData.source };
      }
    }

    // --- Áªü‰∏ÄËøîÂõûÂ§ÑÁêÜ ---
    if (playableResult) {
      let lrcContent = "";
      // Ëé∑ÂèñÊ≠åËØç
      if (finalSource === 'toubiec') {
        lrcContent = await getToubiecLyric(playableResult.id);
      } else {
        lrcContent = await getLyricsForSong(playableResult.id, finalSource) || "";
      }

      return {
        name: songData.name,
        artist: songData.artist,
        src: playableResult.url,
        cover: songData.cover, // ËøôÈáåÁé∞Âú®Â∑≤ÁªèÊòØÊõ¥Êñ∞ËøáÁöÑÂ∞ÅÈù¢‰∫Ü
        isLocal: false,
        lrcContent: lrcContent
      };
    }

    return null;
  }


  async function getLyricsForSong(songId, source) {
    const url = source === 'netease' ?
      `https://api.vkeys.cn/v2/music/netease/lyric?id=${songId}` :
      `https://api.vkeys.cn/v2/music/tencent/lyric?id=${songId}`;

    const response = await Http_Get(url);
    if (response?.data) {
      const lrc = response.data.lrc || response.data.lyric || "";
      const tlyric = response.data.trans || response.data.tlyric || "";
      return lrc + "\n" + tlyric;
    }
    return "";
  }

  async function handleManualLrcImport(trackIndex) {
    if (trackIndex < 0 || trackIndex >= musicState.playlist.length) return;

    const choice = await showChoiceModal('ÈÄâÊã©Ê≠åËØçÂØºÂÖ•ÊñπÂºè', [{
      text: 'üìÅ ‰ªéÊú¨Âú∞Êñá‰ª∂ (.lrc)',
      value: 'file'
    },
    {
      text: 'üìã Áõ¥Êé•Á≤òË¥¥Ê≠åËØçÊñáÊú¨',
      value: 'paste'
    }
    ]);

    let lrcContent = null;

    if (choice === 'file') {
      lrcContent = await new Promise(resolve => {
        const lrcInput = document.getElementById('lrc-upload-input');
        const lrcChangeHandler = e => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = readEvent => resolve(readEvent.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsText(file);
          } else {
            resolve(null);
          }
          lrcInput.removeEventListener('change', lrcChangeHandler);
          lrcInput.value = '';
        };
        lrcInput.addEventListener('change', lrcChangeHandler, {
          once: true
        });
        lrcInput.click();
      });
    } else if (choice === 'paste') {
      const pastedText = await showCustomPrompt('Á≤òË¥¥Ê≠åËØç', 'ËØ∑Âú®Ê≠§Â§ÑÁ≤òË¥¥ÂÆåÊï¥ÁöÑLRCÊ†ºÂºèÊ≠åËØç...', '', 'textarea');
      if (pastedText) lrcContent = pastedText.replace(/\[/g, '\n[').trim();
    }

    if (lrcContent !== null) {
      musicState.playlist[trackIndex].lrcContent = lrcContent;


      await saveGlobalPlaylist();

      if (musicState.currentIndex === trackIndex) {
        musicState.parsedLyrics = parseLRC(lrcContent);
        renderLyrics();
        updateLyricsUI();
      }
      await showCustomAlert('ÊàêÂäü', `„Ää${musicState.playlist[trackIndex].name}„ÄãÁöÑÊ≠åËØçÂ∑≤ÊàêÂäü‰øùÂ≠òÔºÅ`);
    }
  }


  async function toggleBackgroundBlur() {
    if (musicState.currentIndex === -1) return;

    const track = musicState.playlist[musicState.currentIndex];
    if (!track) return;


    track.isBgClear = !track.isBgClear;


    await saveGlobalPlaylist();


    const playerWindow = document.querySelector('.music-player-window');
    const toggleBtn = document.getElementById('toggle-blur-btn');

    playerWindow.classList.toggle('bg-clear', track.isBgClear);
    toggleBtn.classList.toggle('active', track.isBgClear);
  }


  function toggleMusicPlayerAvatars() {
    const avatarDisplay = document.getElementById('music-player-avatar-display');
    const toggleBtn = document.getElementById('show-avatars-btn');
    if (avatarDisplay && toggleBtn) {
      avatarDisplay.classList.toggle('visible');
      toggleBtn.classList.toggle('active');
    }
  }


  function togglePlayerFullscreen() {
    const playerWindow = document.querySelector('.music-player-window');
    const overlay = document.getElementById('music-player-overlay');
    if (playerWindow && overlay) {

      playerWindow.classList.toggle('fullscreen');
      overlay.classList.toggle('fullscreen-active');
    }
  }

  window.togglePlayerFullscreen = togglePlayerFullscreen;


  async function cleanupInvalidSongs() {
    if (musicState.playlist.length === 0) {
      alert("Êí≠ÊîæÂàóË°®ÊòØÁ©∫ÁöÑÔºåÊó†ÈúÄÊ∏ÖÁêÜ„ÄÇ");
      return;
    }

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Ê∏ÖÁêÜÊó†ÊïàÊ≠åÊõ≤Ôºü',
      'Ê≠§Êìç‰ΩúÂ∞ÜÊ£ÄÊü•Êí≠ÊîæÂàóË°®‰∏≠ÁöÑÊØè‰∏ÄÈ¶ñÁΩëÁªúÊ≠åÊõ≤ÔºåÂπ∂ÁßªÈô§ÊâÄÊúâÊó†Ê≥ïÊí≠ÊîæÁöÑ‚ÄúÊ≠ªÈìæ‚Äù„ÄÇÊú¨Âú∞Ê≠åÊõ≤‰∏ç‰ºöÂèóÂΩ±Âìç„ÄÇ', {
      confirmText: 'ÂºÄÂßãÊ∏ÖÁêÜ'
    }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê£ÄÊü• ${musicState.playlist.length} È¶ñÊ≠åÊõ≤ÔºåËøôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥...`);

    const originalCount = musicState.playlist.length;
    const validPlaylist = [];
    const invalidSongs = [];

    const checkPromises = musicState.playlist.map(async (track) => {
      if (track.isLocal) {
        validPlaylist.push(track);
        return;
      }

      const isAvailable = await checkAudioAvailability(track.src);
      if (isAvailable) {
        validPlaylist.push(track);
      } else {
        invalidSongs.push({
          name: track.name,
          artist: track.artist || 'Êú™Áü•Ê≠åÊâã'
        });
        console.warn(`Êó†ÊïàÈìæÊé•: ${track.name} - ${track.src}`);
      }
    });

    await Promise.all(checkPromises);

    const removedCount = originalCount - validPlaylist.length;

    if (removedCount > 0) {
      const currentPlayingTrack = musicState.playlist[musicState.currentIndex];
      const isCurrentTrackRemoved = invalidSongs.some(s => s.name === currentPlayingTrack?.name);

      musicState.playlist = validPlaylist;
      await saveGlobalPlaylist();

      if (isCurrentTrackRemoved) {
        audioPlayer.pause();
        audioPlayer.src = '';
        musicState.currentIndex = musicState.playlist.length > 0 ? 0 : -1;
        musicState.isPlaying = false;
      } else if (currentPlayingTrack) {
        musicState.currentIndex = musicState.playlist.findIndex(t => t.src === currentPlayingTrack.src);
      }

      updatePlaylistUI();
      updatePlayerUI();

      // ÊòæÁ§∫Ë¢´Ê∏ÖÁêÜÁöÑÊ≠åÊõ≤ÂàóË°®Ê®°ÊÄÅÊ°Ü
      showCleanedSongsModal(invalidSongs);
    } else {
      await showCustomAlert("Ê£ÄÊü•ÂÆåÊàê", "ÊâÄÊúâÊ≠åÊõ≤ÈìæÊé•ÂùáÊúâÊïàÔºåÊó†ÈúÄÊ∏ÖÁêÜÔºÅ");
    }
  }

  // ÊòæÁ§∫Ë¢´Ê∏ÖÁêÜÊ≠åÊõ≤ÁöÑÊ®°ÊÄÅÊ°Ü
  function showCleanedSongsModal(cleanedSongs) {
    const modal = document.getElementById('cleaned-songs-modal');
    const listEl = document.getElementById('cleaned-songs-list');
    listEl.innerHTML = '';
    document.getElementById('select-all-cleaned-songs').checked = false;

    cleanedSongs.forEach(song => {
      const item = document.createElement('div');
      item.className = 'search-result-item';
      item.dataset.songJson = JSON.stringify(song);

      item.innerHTML = `
        <input type="checkbox" class="cleaned-song-checkbox" style="margin-right: 15px;">
        <div class="search-result-info">
          <div class="title">${song.name}</div>
          <div class="artist">${song.artist}</div>
        </div>
      `;
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
  }

  // Â§ÑÁêÜÈáçÊñ∞ÊêúÁ¥¢ÈÄâ‰∏≠ÁöÑÊ≠åÊõ≤
  async function handleResearchSelectedSongs() {
    const modal = document.getElementById('cleaned-songs-modal');
    const checkboxes = modal.querySelectorAll('.cleaned-song-checkbox:checked');

    if (checkboxes.length === 0) {
      await showCustomAlert("ÊèêÁ§∫", "ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÈáçÊñ∞ÊêúÁ¥¢ÁöÑÊ≠åÊõ≤");
      return;
    }

    const selectedSongs = [];
    checkboxes.forEach(cb => {
      const item = cb.closest('.search-result-item');
      const songData = JSON.parse(item.dataset.songJson);
      selectedSongs.push(songData);
    });

    // ÂÖ≥Èó≠Ë¢´Ê∏ÖÁêÜÊ≠åÊõ≤Ê®°ÊÄÅÊ°Ü
    modal.classList.remove('visible');

    // ÈÄê‰∏™Â§ÑÁêÜ
    await processResearchSongsOneByOne(selectedSongs);
  }

  // ÈÄê‰∏™Â§ÑÁêÜÈáçÊñ∞ÊêúÁ¥¢ÁöÑÊ≠åÊõ≤
  async function processResearchSongsOneByOne(songs) {
    for (let i = 0; i < songs.length; i++) {
      const song = songs[i];
      let searchQuery = `${song.name} ${song.artist}`;

      // ËÆ©Áî®Êà∑Á°ÆËÆ§Êàñ‰øÆÊîπÊêúÁ¥¢ÂÖ≥ÈîÆËØç
      const userQuery = prompt(`Á¨¨ ${i + 1}/${songs.length} È¶ñ\n\nËØ∑Á°ÆËÆ§Êàñ‰øÆÊîπÊêúÁ¥¢ÂÖ≥ÈîÆËØçÔºö`, searchQuery);

      if (userQuery === null) {
        // Áî®Êà∑ÁÇπÂáªÂèñÊ∂àÔºåËØ¢ÈóÆÊòØÂê¶ÁªßÁª≠‰∏ã‰∏ÄÈ¶ñ
        const continueNext = await showCustomConfirm(
          "Â∑≤ÂèñÊ∂à",
          `ÊòØÂê¶ÁªßÁª≠ÊêúÁ¥¢‰∏ã‰∏ÄÈ¶ñÊ≠åÊõ≤Ôºü`,
          { confirmText: 'ÁªßÁª≠' }
        );
        if (!continueNext) break;
        continue;
      }

      searchQuery = userQuery.trim();
      if (!searchQuery) {
        await showCustomAlert("ÊèêÁ§∫", "ÊêúÁ¥¢ÂÖ≥ÈîÆËØç‰∏çËÉΩ‰∏∫Á©∫");
        i--; // ÈáçÊñ∞Â§ÑÁêÜÂΩìÂâçÊ≠åÊõ≤
        continue;
      }

      // ÊêúÁ¥¢Âæ™ÁéØÔºåÂÖÅËÆ∏ÈáçÊñ∞ËæìÂÖ•ÂÖ≥ÈîÆËØç
      let searchSuccess = false;
      while (!searchSuccess) {
        await showCustomAlert("ÊêúÁ¥¢‰∏≠...", `Ê≠£Âú®ÊêúÁ¥¢Ôºö${searchQuery}`);

        try {
          // ‰ΩøÁî®ÈªòËÆ§ÁöÑ exhigh Èü≥Ë¥®ÊêúÁ¥¢
          const searchResults = await searchToubiec(searchQuery);

          if (searchResults.length === 0) {
            // Êú™ÊâæÂà∞ÁªìÊûúÔºåËØ¢ÈóÆÊòØÂê¶ÈáçÊñ∞ËæìÂÖ•ÂÖ≥ÈîÆËØç
            const choice = await showChoiceModal("Êú™ÊâæÂà∞ÁªìÊûú", [
              { text: `"${searchQuery}" Ê≤°ÊúâÊêúÁ¥¢Âà∞ÁªìÊûú`, value: 'info' },
              { text: 'ÈáçÊñ∞ËæìÂÖ•ÂÖ≥ÈîÆËØç', value: 'retry' },
              { text: 'Ë∑≥ËøáÊ≠§Ê≠åÊõ≤', value: 'skip' },
              { text: 'ÁªìÊùüÊêúÁ¥¢', value: 'quit' }
            ]);

            if (choice === 'retry') {
              const newQuery = prompt(`ËØ∑ÈáçÊñ∞ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØçÔºö`, searchQuery);
              if (newQuery && newQuery.trim()) {
                searchQuery = newQuery.trim();
                continue; // ÁªßÁª≠ÊêúÁ¥¢Âæ™ÁéØ
              } else {
                searchSuccess = true; // ÈÄÄÂá∫ÊêúÁ¥¢Âæ™ÁéØÔºåÁªßÁª≠‰∏ã‰∏ÄÈ¶ñ
                break;
              }
            } else if (choice === 'skip') {
              searchSuccess = true; // Ë∑≥ËøáÔºåÁªßÁª≠‰∏ã‰∏ÄÈ¶ñ
              break;
            } else if (choice === 'quit') {
              return; // ÁªìÊùüÊï¥‰∏™ÊêúÁ¥¢ÊµÅÁ®ã
            }
            continue;
          }

          // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûúËÆ©Áî®Êà∑ÈÄâÊã©
          const selectedTrack = await showSongSelectionModal(searchResults, song.name, i + 1, songs.length);

          if (selectedTrack) {
            // Ëé∑ÂèñÊ≠åÊõ≤ËØ¶ÊÉÖÂπ∂Ê∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®
            const trackDetails = await getPlayableSongDetails(selectedTrack);

            if (trackDetails) {
              musicState.playlist.push(trackDetails);
              await saveGlobalPlaylist();
              updatePlaylistUI();
              await showCustomAlert("Ê∑ªÂä†ÊàêÂäü", `"${song.name}" Â∑≤Ê∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®`);
              searchSuccess = true; // ÊàêÂäüÔºåÁªßÁª≠‰∏ã‰∏ÄÈ¶ñ
            } else {
              await showCustomAlert("Ê∑ªÂä†Â§±Ë¥•", `Êó†Ê≥ïËé∑Âèñ "${song.name}" ÁöÑÊí≠ÊîæÈìæÊé•`);
              searchSuccess = true; // Â§±Ë¥•‰πüÁªßÁª≠‰∏ã‰∏ÄÈ¶ñ
            }
          } else {
            // Áî®Êà∑ÂèñÊ∂àÊàñË∑≥Ëøá
            searchSuccess = true; // ÁªßÁª≠‰∏ã‰∏ÄÈ¶ñ
          }

        } catch (e) {
          console.error(`ÊêúÁ¥¢ "${searchQuery}" Â§±Ë¥•:`, e);
          const retry = await showCustomConfirm(
            "ÊêúÁ¥¢Âá∫Èîô",
            `ÊêúÁ¥¢ "${searchQuery}" Êó∂Âá∫ÈîôÔºåÊòØÂê¶ÈáçÊñ∞Â∞ùËØïÔºü`,
            { confirmText: 'ÈáçÊñ∞Â∞ùËØï' }
          );
          if (!retry) {
            searchSuccess = true; // ‰∏çÈáçËØïÔºåÁªßÁª≠‰∏ã‰∏ÄÈ¶ñ
          }
        }
      }
    }

    await showCustomAlert("ÂÆåÊàê", "ÊâÄÊúâÈÄâ‰∏≠ÁöÑÊ≠åÊõ≤Â∑≤Â§ÑÁêÜÂÆåÊØï");
  }

  // ÊòæÁ§∫Ê≠åÊõ≤ÈÄâÊã©Ê®°ÊÄÅÊ°Ü
  function showSongSelectionModal(searchResults, songName, currentIndex, totalCount) {
    return new Promise((resolve) => {
      const modal = document.getElementById('music-search-results-modal');
      const listEl = document.getElementById('search-results-list');
      const headerSpan = modal.querySelector('.modal-header span');

      // ‰øÆÊîπÊ†áÈ¢òÊòæÁ§∫ÂΩìÂâçËøõÂ∫¶
      headerSpan.textContent = `ÈÄâÊã©Ê≠åÊõ≤ (${currentIndex}/${totalCount}): ${songName}`;

      listEl.innerHTML = '';
      document.getElementById('select-all-music-search').checked = false;

      // Ê∏≤ÊüìÊêúÁ¥¢ÁªìÊûúÔºàÂçïÈÄâÊ®°ÂºèÔºâ
      searchResults.forEach(song => {
        song.preferredQuality = 'exhigh'; // ÈªòËÆ§ÊûÅÈ´òÈü≥Ë¥®

        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.dataset.songJson = JSON.stringify(song);
        item.style.cursor = 'pointer';

        let sourceTag = '';
        if (song.source === 'toubiec') {
          sourceTag = '<span class="source" style="color:#ff3b30; border-color:#ff3b30;">ÊûÅÈ´ò</span>';
        } else if (song.source === 'netease') {
          sourceTag = '<span class="source" style="color:#c20c0c; border-color:#c20c0c;">ÁΩëÊòì‰∫ë</span>';
        } else {
          sourceTag = '<span class="source" style="color:#00e09e; border-color:#00e09e;">QQÈü≥‰πê</span>';
        }

        item.innerHTML = `
          <input type="radio" name="song-selection-radio" class="music-search-radio" style="margin-right: 15px;">
          <div class="search-result-info">
            <div class="title">${song.name}</div>
            <div class="artist">${song.artist} ${sourceTag}</div>
          </div>
        `;

        // ÁÇπÂáªÊï¥Ë°å‰πüËÉΩÈÄâ‰∏≠
        item.addEventListener('click', (e) => {
          if (e.target.type !== 'radio') {
            const radio = item.querySelector('.music-search-radio');
            radio.checked = true;
          }
        });

        listEl.appendChild(item);
      });

      modal.classList.add('visible');

      // ‰∏¥Êó∂‰øÆÊîπÊåâÈíÆÊñáÊú¨ÂíåÂäüËÉΩ
      const cancelBtn = document.getElementById('cancel-music-search-btn');
      const confirmBtn = document.getElementById('add-selected-music-btn');

      const originalCancelText = cancelBtn.textContent;
      const originalConfirmText = confirmBtn.textContent;

      cancelBtn.textContent = 'Ë∑≥Ëøá';
      confirmBtn.textContent = 'Á°ÆËÆ§Ê∑ªÂä†';

      // ÂèñÊ∂à/Ë∑≥ËøáÊåâÈíÆ
      const handleCancel = () => {
        cleanup();
        resolve(null);
      };

      // Á°ÆËÆ§ÊåâÈíÆ
      const handleConfirm = () => {
        const selectedRadio = modal.querySelector('.music-search-radio:checked');
        if (!selectedRadio) {
          alert('ËØ∑ÂÖàÈÄâÊã©‰∏ÄÈ¶ñÊ≠åÊõ≤');
          return;
        }

        const item = selectedRadio.closest('.search-result-item');
        const songData = JSON.parse(item.dataset.songJson);
        cleanup();
        resolve(songData);
      };

      const cleanup = () => {
        modal.classList.remove('visible');
        headerSpan.textContent = 'ÊêúÁ¥¢ÁªìÊûú'; // ÊÅ¢Â§çÊ†áÈ¢ò
        cancelBtn.textContent = originalCancelText;
        confirmBtn.textContent = originalConfirmText;
        cancelBtn.removeEventListener('click', handleCancel);
        confirmBtn.removeEventListener('click', handleConfirm);
      };

      cancelBtn.addEventListener('click', handleCancel);
      confirmBtn.addEventListener('click', handleConfirm);
    });
  }

  function toggleReadingFullscreen() {
    const readingWindow = document.getElementById('reading-window');
    const readingOverlay = document.getElementById('reading-overlay');

    if (readingWindow && readingOverlay) {
      // ÂàáÊç¢ÂÖ®Â±èÁ±ªÂêç
      readingWindow.classList.toggle('fullscreen');
      readingOverlay.classList.toggle('fullscreen-active');
    }
  }

  // Â∞ÜÂáΩÊï∞Êö¥Èú≤ÁªôÂÖ®Â±ÄÔºàÂèØÈÄâÔºå‰∏∫‰∫Ü‰øùÈô©Ôºâ
  window.toggleReadingFullscreen = toggleReadingFullscreen;

  function applyStatusBarVisibility() {
    const phoneScreen = document.getElementById('phone-screen');

    phoneScreen.classList.toggle('status-bar-visible', !!state.globalSettings.showStatusBar);
  }


  async function openClearPostsSelectorModal() {
    const modal = document.getElementById('clear-posts-modal');
    const listEl = document.getElementById('clear-posts-list');
    listEl.innerHTML = '';


    const options = [];


    options.push({
      text: 'Ê∏ÖÁ©∫ÊâÄÊúâÂä®ÊÄÅ (Âç±Èô©)',
      value: 'all',
      isDanger: true
    });


    const myNickname = state.qzoneSettings.nickname || 'Êàë';
    options.push({
      text: `‰ªÖÊ∏ÖÁ©∫ ${myNickname} ÁöÑÂä®ÊÄÅ (Áî®Êà∑)`,
      value: 'user'
    });


    Object.values(state.chats).forEach(chat => {
      if (!chat.isGroup) {
        options.push({
          text: `‰ªÖÊ∏ÖÁ©∫ ${chat.name} ÁöÑÂä®ÊÄÅ (ËßíËâ≤)`,
          value: chat.id
        });
      }
    });


    try {
      const npcs = await db.npcs.toArray();
      if (npcs.length > 0) {

        options.push({
          isSeparator: true,
          text: 'NPC ÂàóË°®'
        });

        npcs.forEach(npc => {
          options.push({
            text: `‰ªÖÊ∏ÖÁ©∫ ${npc.name} ÁöÑÂä®ÊÄÅ (NPC)`,

            value: `npc_${npc.id}`
          });
        });
      }
    } catch (e) {
      console.error("Âä†ËΩΩNPCÂàóË°®Â§±Ë¥•:", e);
    }



    options.forEach(opt => {

      if (opt.isSeparator) {
        const separator = document.createElement('div');
        separator.textContent = opt.text;
        separator.style.cssText = `
                padding: 10px 18px 5px;
                font-size: 13px;
                font-weight: 500;
                color: var(--text-secondary);
                background-color: #f0f2f5;
                border-top: 1px solid var(--border-color);
                border-bottom: 1px solid var(--border-color);
                margin-top: 5px;
            `;
        listEl.appendChild(separator);
        return;
      }


      const item = document.createElement('div');
      item.className = 'clear-posts-item';
      if (opt.isDanger) {
        item.classList.add('danger-option');
      }
      item.dataset.targetId = opt.value;
      item.innerHTML = `
            <div class="checkbox"></div>
            <span class="name">${opt.text}</span>
        `;
      listEl.appendChild(item);
    });


    modal.classList.add('visible');
  }


  async function handleConfirmClearPosts() {
    const selectedItems = document.querySelectorAll('#clear-posts-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÊ∏ÖÁ©∫ÁöÑËåÉÂõ¥„ÄÇ");
      return;
    }

    const targetIds = Array.from(selectedItems).map(item => item.dataset.targetId);


    let targetNames = [];
    if (targetIds.includes('all')) {
      targetNames.push('ÊâÄÊúâÂä®ÊÄÅ');
    } else {
      if (targetIds.includes('user')) {
        targetNames.push(`‚Äú${state.qzoneSettings.nickname}‚Äù`);
      }
      targetIds.forEach(id => {
        const character = state.chats[id];
        if (character) {
          targetNames.push(`‚Äú${character.name}‚Äù`);
        }
      });
    }
    const confirmMessage = `Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ ${targetNames.join('„ÄÅ ')} ÁöÑÊâÄÊúâÂä®ÊÄÅÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅ`;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Ê∏ÖÁ©∫Âä®ÊÄÅÔºü',
      confirmMessage, {
      confirmButtonClass: 'btn-danger',
      confirmText: 'Á°ÆËÆ§Ê∏ÖÁ©∫'
    }
    );

    if (!confirmed) return;

    try {
      if (targetIds.includes('all')) {
        await db.qzonePosts.clear();
      } else {

        await db.qzonePosts.where('authorId').anyOf(targetIds).delete();
      }


      qzonePostsCache = await db.qzonePosts.orderBy('timestamp').reverse().toArray();
      qzonePostsRenderCount = 0;
      await renderQzonePosts();

      document.getElementById('clear-posts-modal').classList.remove('visible'); // ÂÖ≥Èó≠ÈÄâÊã©Âô®
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'ÈÄâÂÆöËåÉÂõ¥ÂÜÖÁöÑÂä®ÊÄÅÂ∑≤Ë¢´Ê∏ÖÁ©∫„ÄÇ');

    } catch (error) {
      console.error("Ê∏ÖÁ©∫Âä®ÊÄÅÊó∂Âá∫Èîô:", error);
      await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', `Ê∏ÖÁ©∫Âä®ÊÄÅÊó∂ÂèëÁîüÈîôËØØ: ${error.message}`);
    }
  }



  async function handleDeleteThought(timestamp) {
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      'Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÊù°ÂøÉÂ£∞ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ', {
      confirmButtonClass: 'btn-danger',
      confirmText: 'Á°ÆËÆ§Âà†Èô§'
    }
    );

    if (confirmed) {
      const chat = state.chats[state.activeChatId];
      if (!chat || !chat.thoughtsHistory) return;

      const indexToDelete = chat.thoughtsHistory.findIndex(thought => thought.timestamp === timestamp);
      if (indexToDelete === -1) return;


      const isLatest = indexToDelete === chat.thoughtsHistory.length - 1;


      chat.thoughtsHistory = chat.thoughtsHistory.filter(thought => thought.timestamp !== timestamp);


      if (isLatest) {
        if (chat.thoughtsHistory.length > 0) {

          const newLatestThought = chat.thoughtsHistory[chat.thoughtsHistory.length - 1];
          chat.heartfeltVoice = newLatestThought.heartfeltVoice;
          chat.randomJottings = newLatestThought.randomJottings;

          const heartfeltVoiceEl = document.getElementById('profile-heartfelt-voice');
          const randomJottingsEl = document.getElementById('profile-random-jottings');
          if (heartfeltVoiceEl) heartfeltVoiceEl.textContent = chat.heartfeltVoice;
          if (randomJottingsEl) randomJottingsEl.textContent = chat.randomJottings;

          console.log("Â∑≤Âà†Èô§ÊúÄÊñ∞ÂøÉÂ£∞ÔºåÂΩìÂâçÂøÉÂ£∞Â∑≤ÂõûÊªöËá≥‰∏ä‰∏ÄÊù°„ÄÇ");
        } else {

          chat.heartfeltVoice = '...';
          chat.randomJottings = '...';


          const heartfeltVoiceEl = document.getElementById('profile-heartfelt-voice');
          const randomJottingsEl = document.getElementById('profile-random-jottings');
          if (heartfeltVoiceEl) heartfeltVoiceEl.textContent = chat.heartfeltVoice;
          if (randomJottingsEl) randomJottingsEl.textContent = chat.randomJottings;

          console.log("Â∑≤Âà†Èô§ÊúÄÂêé‰∏ÄÊù°ÂøÉÂ£∞ÔºåÂΩìÂâçÂøÉÂ£∞Â∑≤ÈáçÁΩÆ„ÄÇ");
        }
      }

      await db.chats.put(chat);


      renderThoughtsHistory();

      await showCustomAlert('ÊàêÂäü', 'ËØ•Êù°ËÆ∞ÂΩïÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ');
    }
  }


  document.getElementById('thoughts-history-list').addEventListener('click', (e) => {

    const deleteBtn = e.target.closest('.thought-delete-btn');
    if (deleteBtn) {

      const timestamp = parseInt(deleteBtn.dataset.timestamp);
      if (!isNaN(timestamp)) {

        handleDeleteThought(timestamp);
      }
    }
  });


  async function loadCssPresetsDropdown() {
    const selectEl = document.getElementById('css-preset-select');
    selectEl.innerHTML = '<option value="">-- ÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæ --</option>';

    const presets = await db.appearancePresets.where('type').equals('global_css').toArray();
    presets.forEach(preset => {
      const option = document.createElement('option');
      option.value = preset.id;
      option.textContent = preset.name;
      selectEl.appendChild(option);
    });
  }


  async function handleCssPresetSelectionChange() {
    const selectEl = document.getElementById('css-preset-select');
    const selectedId = parseInt(selectEl.value);
    if (isNaN(selectedId)) return;

    const preset = await db.appearancePresets.get(selectedId);
    if (preset) {
      const cssInput = document.getElementById('global-css-input');
      cssInput.value = preset.value;
      applyGlobalCss(preset.value);
    }
  }


  async function saveCssPreset() {
    const name = await showCustomPrompt('‰øùÂ≠òCSSÈ¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
    if (!name || !name.trim()) return;

    const cssValue = document.getElementById('global-css-input').value;

    const existingPreset = await db.appearancePresets.where({
      name: name.trim(),
      type: 'global_css'
    }).first();
    if (existingPreset) {
      const confirmed = await showCustomConfirm('Ë¶ÜÁõñÈ¢ÑËÆæ', `Âêç‰∏∫ ‚Äú${name.trim()}‚Äù ÁöÑÈ¢ÑËÆæÂ∑≤Â≠òÂú®„ÄÇË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      });
      if (!confirmed) return;

      await db.appearancePresets.update(existingPreset.id, {
        value: cssValue
      });
    } else {
      await db.appearancePresets.add({
        name: name.trim(),
        type: 'global_css',
        value: cssValue
      });
    }

    await loadCssPresetsDropdown();
    alert('CSS È¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ');
  }


  async function deleteCssPreset() {
    const selectEl = document.getElementById('css-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
      alert('ËØ∑ÂÖà‰ªé‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ„ÄÇ');
      return;
    }

    const preset = await db.appearancePresets.get(selectedId);
    if (!preset) return;

    const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ ‚Äú${preset.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.appearancePresets.delete(selectedId);
      await loadCssPresetsDropdown();
      alert('È¢ÑËÆæÂ∑≤Âà†Èô§„ÄÇ');
    }
  }




  async function loadFontPresetsDropdown() {
    const selectEl = document.getElementById('font-preset-select');
    selectEl.innerHTML = '<option value="">-- ÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæ --</option>';

    const presets = await db.appearancePresets.where('type').equals('font').toArray();
    presets.forEach(preset => {
      const option = document.createElement('option');
      option.value = preset.id;
      option.textContent = preset.name;
      selectEl.appendChild(option);
    });
  }


  async function handleFontPresetSelectionChange() {
    const selectEl = document.getElementById('font-preset-select');
    const selectedId = parseInt(selectEl.value);
    if (isNaN(selectedId)) return;

    const preset = await db.appearancePresets.get(selectedId);
    if (preset) {
      const fontUrlInput = document.getElementById('font-url-input');
      fontUrlInput.value = preset.value;
      applyCustomFont(preset.value, true);
    }
  }


  async function saveFontPreset() {
    const name = await showCustomPrompt('‰øùÂ≠òÂ≠ó‰ΩìÈ¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
    if (!name || !name.trim()) return;

    const fontUrl = document.getElementById('font-url-input').value.trim();
    if (!fontUrl) {
      alert("Â≠ó‰ΩìURL‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
      return;
    }

    const existingPreset = await db.appearancePresets.where({
      name: name.trim(),
      type: 'font'
    }).first();
    if (existingPreset) {
      const confirmed = await showCustomConfirm('Ë¶ÜÁõñÈ¢ÑËÆæ', `Âêç‰∏∫ ‚Äú${name.trim()}‚Äù ÁöÑÈ¢ÑËÆæÂ∑≤Â≠òÂú®„ÄÇË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      });
      if (!confirmed) return;

      await db.appearancePresets.update(existingPreset.id, {
        value: fontUrl
      });
    } else {
      await db.appearancePresets.add({
        name: name.trim(),
        type: 'font',
        value: fontUrl
      });
    }

    await loadFontPresetsDropdown();
    alert('Â≠ó‰ΩìÈ¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ');
  }


  async function deleteFontPreset() {
    const selectEl = document.getElementById('font-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
      alert('ËØ∑ÂÖà‰ªé‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ„ÄÇ');
      return;
    }

    const preset = await db.appearancePresets.get(selectedId);
    if (!preset) return;

    const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ ‚Äú${preset.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.appearancePresets.delete(selectedId);
      await loadFontPresetsDropdown();
      alert('È¢ÑËÆæÂ∑≤Âà†Èô§„ÄÇ');
    }
  }
  // ÊâæÂà∞Ëøô‰∏™ÂáΩÊï∞Âπ∂ÊõøÊç¢
  async function loadAppearancePresetsDropdown(forceSelectedId = null) {
    const selectEl = document.getElementById('appearance-preset-select');
    if (!selectEl) return; // Èò≤Âæ°ÊÄßÊ£ÄÊü•ÔºöÂÖÉÁ¥†‰∏çÂ≠òÂú®Êó∂Áõ¥Êé•ËøîÂõû
    selectEl.innerHTML = '<option value="">-- ÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæ --</option>';

    const presets = await db.appearancePresets.where('type').equals('appearance').toArray();
    presets.forEach(preset => {
      const option = document.createElement('option');
      option.value = preset.id;
      option.textContent = preset.name;
      selectEl.appendChild(option);
    });

    // Â¶ÇÊûú‰º†ÂÖ•‰∫ÜÂº∫Âà∂ÈÄâ‰∏≠ÁöÑIDÔºåÁõ¥Êé•ÈÄâ‰∏≠ÂÆÉÔºå‰∏çÂÜçËøõË°åÂ§çÊùÇÁöÑÂØπÊØî
    if (forceSelectedId) {
      selectEl.value = forceSelectedId;
      return;
    }

    // Âè™ÊúâÂú®Ê≤°ÊúâÂº∫Âà∂ÈÄâ‰∏≠Êó∂ÔºåÊâçÊâßË°åÂéüÊù•ÁöÑËá™Âä®ÂåπÈÖçÈÄªËæë
    const currentSettings = {
      wallpaper: state.globalSettings.wallpaper,
      cphoneWallpaper: state.globalSettings.cphoneWallpaper,
      globalChatBackground: state.globalSettings.globalChatBackground,
      appIcons: state.globalSettings.appIcons,
      cphoneAppIcons: state.globalSettings.cphoneAppIcons,
      myphoneAppIcons: state.globalSettings.myphoneAppIcons,
      chatActionButtonsOrder: state.globalSettings.chatActionButtonsOrder,
      theme: localStorage.getItem('ephone-theme') || 'light',
      showStatusBar: state.globalSettings.showStatusBar,
      notificationSoundUrl: state.globalSettings.notificationSoundUrl,
      widgetData: state.globalSettings.widgetData
    };

    let matchingPresetId = null;

    for (const preset of presets) {
      if (JSON.stringify(preset.value) === JSON.stringify(currentSettings)) {
        matchingPresetId = preset.id;
        break;
      }
    }

    if (matchingPresetId) {
      selectEl.value = matchingPresetId;
    } else {
      selectEl.value = '';
    }
  }



  // ÊâæÂà∞Ëøô‰∏™ÂáΩÊï∞Âπ∂ÊõøÊç¢
  async function handleAppearancePresetSelectionChange() {
    const selectEl = document.getElementById('appearance-preset-select');
    const selectedId = parseInt(selectEl.value);
    if (isNaN(selectedId)) return;

    const preset = await db.appearancePresets.get(selectedId);
    if (preset && preset.value) {
      const data = preset.value;

      // 1. Êô∫ËÉΩÂêàÂπ∂ÂõæÊ†áÔºà‰øùÁïô‰∏ä‰∏ÄËΩÆÁöÑ‰øÆÂ§çÔºâ
      const mergedAppIcons = {
        ...DEFAULT_APP_ICONS,
        ...(data.appIcons || {})
      };
      const mergedCPhoneIcons = {
        ...DEFAULT_CPHONE_ICONS,
        ...(data.cphoneAppIcons || {})
      };
      const mergedMyPhoneIcons = {
        ...DEFAULT_MYPHONE_ICONS,
        ...(data.myphoneAppIcons || {})
      };

      Object.assign(state.globalSettings, data);
      state.globalSettings.appIcons = mergedAppIcons;
      state.globalSettings.cphoneAppIcons = mergedCPhoneIcons;
      state.globalSettings.myphoneAppIcons = mergedMyPhoneIcons;

      applyTheme(data.theme || 'light');
      await db.globalSettings.put(state.globalSettings);

      applyGlobalWallpaper();
      applyCPhoneWallpaper();
      applyMyPhoneWallpaper();
      renderIconSettings();
      renderCPhoneIconSettings();
      renderMyPhoneIconSettings();
      applyAppIcons();
      applyCPhoneAppIcons();
      applyMyPhoneAppIconsGlobal();
      applyStatusBarVisibility();
      applyWidgetData();

      if (data.chatActionButtonsOrder) {
        renderButtonOrderEditor();
        applyButtonOrder();
      }

      // „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëÔºöË∞ÉÁî® renderWallpaperScreen Êó∂‰º†ÂÖ• selectedId
      // ËøôÊ†∑‰∏ãÊãâÊ°ÜÂ∞±‰ºöË¢´Âº∫Âà∂ËÆæÁΩÆ‰∏∫ÂΩìÂâçÈÄâ‰∏≠ÁöÑÈ¢ÑËÆæÔºåËÄå‰∏ç‰ºöË∑≥Âõû‚ÄúËØ∑ÈÄâÊã©‚Äù
      renderWallpaperScreen(selectedId);

      alert(`Â∑≤ÊàêÂäüÂä†ËΩΩÂ§ñËßÇÈ¢ÑËÆæÔºö‚Äú${preset.name}‚Äù\n(Áº∫Â§±ÁöÑÊñ∞AppÂõæÊ†áÂ∑≤Ëá™Âä®ÈáçÁΩÆ‰∏∫ÈªòËÆ§)`);
    }
  }


  async function saveAppearancePreset() {
    const name = await showCustomPrompt('‰øùÂ≠òÂ§ñËßÇÈ¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
    if (!name || !name.trim()) return;


    const appearanceData = {
      wallpaper: state.globalSettings.wallpaper,
      cphoneWallpaper: state.globalSettings.cphoneWallpaper,
      globalChatBackground: state.globalSettings.globalChatBackground,
      appIcons: state.globalSettings.appIcons,
      cphoneAppIcons: state.globalSettings.cphoneAppIcons,
      myphoneAppIcons: state.globalSettings.myphoneAppIcons,
      chatActionButtonsOrder: state.globalSettings.chatActionButtonsOrder,
      theme: localStorage.getItem('ephone-theme') || 'light',
      showStatusBar: state.globalSettings.showStatusBar,
      notificationSoundUrl: state.globalSettings.notificationSoundUrl,
      widgetData: state.globalSettings.widgetData
    };


    const existingPreset = await db.appearancePresets.where({
      name: name.trim(),
      type: 'appearance'
    }).first();
    if (existingPreset) {
      const confirmed = await showCustomConfirm('Ë¶ÜÁõñÈ¢ÑËÆæ', `Âêç‰∏∫ ‚Äú${name.trim()}‚Äù ÁöÑÈ¢ÑËÆæÂ∑≤Â≠òÂú®„ÄÇË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      });
      if (!confirmed) return;

      await db.appearancePresets.update(existingPreset.id, {
        value: appearanceData
      });
    } else {
      await db.appearancePresets.add({
        name: name.trim(),
        type: 'appearance',
        value: appearanceData
      });
    }


    await loadAppearancePresetsDropdown();
    alert('Â§ñËßÇÈ¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ');
  }


  async function deleteAppearancePreset() {
    const selectEl = document.getElementById('appearance-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
      alert('ËØ∑ÂÖà‰ªé‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ„ÄÇ');
      return;
    }

    const preset = await db.appearancePresets.get(selectedId);
    if (!preset) return;

    const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ ‚Äú${preset.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.appearancePresets.delete(selectedId);
      await loadAppearancePresetsDropdown();
      alert('È¢ÑËÆæÂ∑≤Âà†Èô§„ÄÇ');
    }
  }




  async function loadThemePresetsDropdown() {
    const selectEl = document.getElementById('theme-preset-select');
    selectEl.innerHTML = '<option value="">-- ÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæ --</option>';

    const presets = await db.appearancePresets.where('type').equals('bubble_theme').toArray();
    presets.forEach(preset => {
      const option = document.createElement('option');
      option.value = preset.id;
      option.textContent = preset.name;
      selectEl.appendChild(option);
    });
  }


  async function handleThemePresetSelectionChange() {
    const selectEl = document.getElementById('theme-preset-select');
    const selectedId = parseInt(selectEl.value);
    if (isNaN(selectedId)) return;

    const preset = await db.appearancePresets.get(selectedId);
    if (preset) {


      const baseTheme = preset.value.base || 'default';
      const customCss = preset.value.custom || '';


      const themeRadio = document.querySelector(`input[name="theme-select"][value="${baseTheme}"]`);
      if (themeRadio) {
        themeRadio.checked = true;
      }


      const customCssInput = document.getElementById('custom-css-input');
      customCssInput.value = customCss;


      updateSettingsPreview();

    }
  }


  async function saveThemePreset() {
    const name = await showCustomPrompt('‰øùÂ≠ò‰∏ªÈ¢òÈ¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
    if (!name || !name.trim()) return;



    const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
    const themeValue = selectedThemeRadio ? selectedThemeRadio.value : 'default';


    const cssValue = document.getElementById('custom-css-input').value.trim();


    const presetValueObject = {
      base: themeValue,
      custom: cssValue
    };


    const existingPreset = await db.appearancePresets.where({
      name: name.trim(),
      type: 'bubble_theme'
    }).first();
    if (existingPreset) {
      const confirmed = await showCustomConfirm('Ë¶ÜÁõñÈ¢ÑËÆæ', `Âêç‰∏∫ ‚Äú${name.trim()}‚Äù ÁöÑÈ¢ÑËÆæÂ∑≤Â≠òÂú®„ÄÇË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      });
      if (!confirmed) return;


      await db.appearancePresets.update(existingPreset.id, {
        value: presetValueObject
      });
    } else {
      await db.appearancePresets.add({
        name: name.trim(),
        type: 'bubble_theme',

        value: presetValueObject
      });
    }

    await loadThemePresetsDropdown();
    alert('‰∏ªÈ¢òÈ¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ');
  }


  async function deleteThemePreset() {
    const selectEl = document.getElementById('theme-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
      alert('ËØ∑ÂÖà‰ªé‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ„ÄÇ');
      return;
    }

    const preset = await db.appearancePresets.get(selectedId);
    if (!preset) return;

    const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ ‚Äú${preset.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.appearancePresets.delete(selectedId);
      await loadThemePresetsDropdown();
      alert('È¢ÑËÆæÂ∑≤Âà†Èô§„ÄÇ');
    }
  }




  async function openStickerCategoryManager() {
    await renderStickerCategoriesInManager();
    document.getElementById('sticker-category-manager-modal').classList.add('visible');
  }


  async function renderStickerCategoriesInManager() {
    const listEl = document.getElementById('existing-sticker-categories-list');
    const categories = await db.stickerCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ª</p>';
      return;
    }
    categories.forEach(cat => {
      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `
                    <span class="group-name">${cat.name}</span>
                    <span class="delete-group-btn" data-id="${cat.id}">√ó</span>
                `;
      listEl.appendChild(item);
    });
  }

  async function addNewStickerCategory() {
    const input = document.getElementById('new-sticker-category-name-input');
    const name = input.value.trim();
    if (!name) {
      alert('ÂàÜÁ±ªÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      return;
    }
    const existing = await db.stickerCategories.where('name').equals(name).first();
    if (existing) {
      alert(`ÂàÜÁ±ª "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);
      return;
    }
    await db.stickerCategories.add({
      name
    });
    input.value = '';
    await renderStickerCategoriesInManager();
  }


  async function deleteStickerCategory(categoryId) {
    const category = await db.stickerCategories.get(categoryId);
    if (!category) return;

    const stickersInCateogry = await db.userStickers.where('categoryId').equals(categoryId).count();

    const confirmMessage = stickersInCateogry > 0 ?
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁ±ª„Ää${category.name}„ÄãÂêóÔºü\n\n„ÄêË≠¶Âëä„Äë\nÊ≠§Êìç‰ΩúÂ∞ÜÂêåÊó∂Ê∞∏‰πÖÂà†Èô§ËØ•ÂàÜÁ±ª‰∏ãÁöÑ ${stickersInCateogry} ‰∏™Ë°®ÊÉÖÂåÖÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅ` :
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁ±ª„Ää${category.name}„ÄãÂêóÔºü`;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§ÂàÜÁ±ª',
      confirmMessage, {
      confirmButtonClass: 'btn-danger'
    }
    );

    if (confirmed) {
      try {

        await db.transaction('rw', db.stickerCategories, db.userStickers, async () => {

          const stickerIdsToDelete = await db.userStickers.where('categoryId').equals(categoryId).primaryKeys();


          if (stickerIdsToDelete.length > 0) {
            await db.userStickers.bulkDelete(stickerIdsToDelete);
          }


          await db.stickerCategories.delete(categoryId);
        });


        state.userStickers = await db.userStickers.toArray();
        if (activeStickerCategoryId === categoryId) {
          activeStickerCategoryId = 'all';
        }
        await renderStickerCategoriesInManager();
        await renderStickerPanel();

        alert(`ÂàÜÁ±ª„Ää${category.name}„ÄãÂèäÂÖ∂‰∏ãÁöÑË°®ÊÉÖÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ`);

      } catch (error) {
        console.error("Âà†Èô§ÂàÜÁ±ªÂèäË°®ÊÉÖÊó∂Âá∫Èîô:", error);
        alert("Âà†Èô§Â§±Ë¥•ÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞ÈîôËØØ‰ø°ÊÅØ„ÄÇ");
      }
    }
  }


  function switchStickerCategory(categoryId) {
    activeStickerCategoryId = categoryId;
    document.querySelectorAll('.sticker-category-tab').forEach(tab => {
      tab.classList.toggle('active', String(tab.dataset.categoryId) === String(categoryId));
    });
    renderStickerPanel(false);


    const selectAllCheckbox = document.getElementById('select-all-stickers-checkbox');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;
  }


  // ========================================
  // Â∞èÊâãÊú∫ËßíËâ≤ÂÆåÊï¥ÂØºÂá∫/ÂØºÂÖ•
  // ========================================

  /**
   * Â∞ÜÊï∞ÊçÆÂµåÂÖ•PNGÁöÑtEXt chunk‰∏≠
   * @param {Blob} pngBlob - ÂéüÂßãPNGÂõæÁâáBlob
   * @param {string} key - tEXt chunkÁöÑkey
   * @param {string} value - Ë¶ÅÂµåÂÖ•ÁöÑÊï∞ÊçÆÔºà‰ºöË¢´base64ÁºñÁ†ÅÔºâ
   * @returns {Promise<Blob>} - ÂµåÂÖ•Êï∞ÊçÆÂêéÁöÑPNG Blob
   */
  async function embedDataInPng(pngBlob, key, value) {
    const arrayBuffer = await pngBlob.arrayBuffer();
    const originalBytes = new Uint8Array(arrayBuffer);

    // base64ÁºñÁ†ÅÊï∞ÊçÆ
    const encoder = new TextEncoder();
    const utf8Bytes = encoder.encode(value);
    let binaryString = '';
    for (let i = 0; i < utf8Bytes.length; i++) {
      binaryString += String.fromCharCode(utf8Bytes[i]);
    }
    const base64Value = btoa(binaryString);

    // ÊûÑÂª∫tEXt chunk
    const keyBytes = encoder.encode(key);
    const valueBytes = encoder.encode(base64Value);
    // tEXt chunk data = key + null separator + value
    const chunkDataLength = keyBytes.length + 1 + valueBytes.length;
    const chunkData = new Uint8Array(chunkDataLength);
    chunkData.set(keyBytes, 0);
    chunkData[keyBytes.length] = 0; // null separator
    chunkData.set(valueBytes, keyBytes.length + 1);

    // chunk type "tEXt"
    const chunkType = encoder.encode('tEXt');

    // ËÆ°ÁÆóCRC32 (type + data)
    const crcInput = new Uint8Array(4 + chunkDataLength);
    crcInput.set(chunkType, 0);
    crcInput.set(chunkData, 4);
    const crc = crc32(crcInput);

    // ÊûÑÂª∫ÂÆåÊï¥chunk: length(4) + type(4) + data + crc(4)
    const chunkTotal = 4 + 4 + chunkDataLength + 4;
    const chunk = new Uint8Array(chunkTotal);
    const chunkView = new DataView(chunk.buffer);
    chunkView.setUint32(0, chunkDataLength); // length
    chunk.set(chunkType, 4); // type
    chunk.set(chunkData, 8); // data
    chunkView.setUint32(4 + 4 + chunkDataLength, crc); // crc

    // Âú®IEND‰πãÂâçÊèíÂÖ•chunk
    // IEND chunk‰Ωç‰∫éÊñá‰ª∂Êú´Â∞æÔºåÈïøÂ∫¶Âõ∫ÂÆö12Â≠óËäÇ (4 length + 4 type + 0 data + 4 crc)
    const iendOffset = originalBytes.length - 12;
    const newPng = new Uint8Array(originalBytes.length + chunkTotal);
    newPng.set(originalBytes.slice(0, iendOffset), 0);
    newPng.set(chunk, iendOffset);
    newPng.set(originalBytes.slice(iendOffset), iendOffset + chunkTotal);

    return new Blob([newPng], { type: 'image/png' });
  }

  // CRC32Êü•Ë°®Ê≥ï
  function crc32(data) {
    let table = crc32.table;
    if (!table) {
      table = crc32.table = new Uint32Array(256);
      for (let i = 0; i < 256; i++) {
        let c = i;
        for (let j = 0; j < 8; j++) {
          c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
        }
        table[i] = c;
      }
    }
    let crc = 0xFFFFFFFF;
    for (let i = 0; i < data.length; i++) {
      crc = table[(crc ^ data[i]) & 0xFF] ^ (crc >>> 8);
    }
    return (crc ^ 0xFFFFFFFF) >>> 0;
  }

  /**
   * ‰ªéPNG‰∏≠Ëß£ÊûêephoneÊ†ºÂºèÁöÑËßíËâ≤Êï∞ÊçÆ
   * @param {ArrayBuffer} arrayBuffer
   * @returns {Promise<{ephone: object|null, chara: object|null}>}
   */
  function parsePngForAllFormats(arrayBuffer) {
    return new Promise((resolve, reject) => {
      const view = new DataView(arrayBuffer);
      if (view.getUint32(0) !== 0x89504E47 || view.getUint32(4) !== 0x0D0A1A0A) {
        return reject(new Error("Êñá‰ª∂‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑPNG„ÄÇ"));
      }

      let offset = 8;
      const decoder = new TextDecoder();
      let ephoneData = null;
      let charaData = null;

      while (offset < view.byteLength) {
        const length = view.getUint32(offset);
        const type = decoder.decode(arrayBuffer.slice(offset + 4, offset + 8));

        if (type === 'tEXt') {
          const data = new Uint8Array(arrayBuffer, offset + 8, length);
          const nullSeparatorIndex = data.indexOf(0);
          if (nullSeparatorIndex !== -1) {
            const key = decoder.decode(data.slice(0, nullSeparatorIndex));
            const value = decoder.decode(data.slice(nullSeparatorIndex + 1));

            if (key === 'ephone') {
              try {
                const binaryString = atob(value);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                  bytes[i] = binaryString.charCodeAt(i);
                }
                const decodedData = new TextDecoder('utf-8').decode(bytes);
                ephoneData = JSON.parse(decodedData);
              } catch (e) {
                console.error("Ëß£ÊûêephoneÊï∞ÊçÆÂ§±Ë¥•:", e);
              }
            }

            if (key === 'chara') {
              try {
                const binaryString = atob(value);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                  bytes[i] = binaryString.charCodeAt(i);
                }
                const decodedData = new TextDecoder('utf-8').decode(bytes);
                charaData = JSON.parse(decodedData);
              } catch (e) {
                console.error("Ëß£ÊûêcharaÊï∞ÊçÆÂ§±Ë¥•:", e);
              }
            }
          }
        }

        offset += 4 + 4 + length + 4;
      }

      resolve({ ephone: ephoneData, chara: charaData });
    });
  }

  /**
   * ÂØºÂá∫ËßíËâ≤ÂÆåÊï¥Êï∞ÊçÆÔºàÂ∞èÊâãÊú∫‰∏ìÂ±ûÊ†ºÂºèÔºâ
   */
  async function exportCharacterFull() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat || chat.isGroup) {
      await showCustomAlert('ÊèêÁ§∫', '‰ªÖÊîØÊåÅÂØºÂá∫ÂçïËÅäËßíËâ≤„ÄÇ');
      return;
    }

    try {
      // ËØ¢ÈóÆÊòØÂê¶ÂåÖÂê´ËÅäÂ§©ËÆ∞ÂΩï
      const includeHistory = await showCustomConfirm(
        'ÂØºÂá∫ËßíËâ≤',
        'ÊòØÂê¶Ë¶ÅÂ∞ÜËÅäÂ§©ËÆ∞ÂΩï‰∏ÄËµ∑ÂØºÂá∫Ôºü\n\nÈÄâÊã©"Á°ÆÂÆö"Â∞ÜÂåÖÂê´ËÅäÂ§©ËÆ∞ÂΩïÔºåÈÄâÊã©"ÂèñÊ∂à"Âàô‰ªÖÂØºÂá∫ËßíËâ≤Êï∞ÊçÆ„ÄÇ',
        { confirmText: 'ÂåÖÂê´ËÅäÂ§©ËÆ∞ÂΩï', cancelText: '‰∏çÂåÖÂê´' }
      );

      // Êî∂ÈõÜÂÖ≥ËÅîÁöÑ‰∏ñÁïå‰π¶
      const linkedWorldBooks = [];
      if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        for (const wbId of chat.settings.linkedWorldBookIds) {
          const wb = state.worldBooks.find(b => b.id === wbId);
          if (wb) linkedWorldBooks.push(wb);
        }
      }

      // Êî∂ÈõÜÂÖ≥ËÅîÁöÑmemories
      const charMemories = await db.memories.where('chatId').equals(chat.id).toArray();

      // Êî∂ÈõÜÂÖ≥ËÅîÁöÑÈÄöËØùËÆ∞ÂΩï
      const charCallRecords = await db.callRecords.where('chatId').equals(chat.id).toArray();

      // Ê∑±Êã∑Ë¥ùchatÊï∞ÊçÆ
      const chatDataCopy = JSON.parse(JSON.stringify(chat));

      // ÊñπÊ°à3ÔºöÂØºÂá∫Êó∂ÁßªÈô§APIÂéÜÂè≤ËÆ∞ÂΩï
      if (chatDataCopy.apiHistory) {
        delete chatDataCopy.apiHistory;
      }

      // Â¶ÇÊûú‰∏çÂåÖÂê´ËÅäÂ§©ËÆ∞ÂΩïÔºåÊ∏ÖÁ©∫history
      if (!includeHistory) {
        chatDataCopy.history = [];
      }

      const exportData = {
        type: 'EPhoneCharacterExport',
        version: 1,
        timestamp: Date.now(),
        appName: 'Â∞èÊâãÊú∫',
        chatData: chatDataCopy,
        worldBooks: linkedWorldBooks,
        memories: charMemories,
        callRecords: charCallRecords,
        includesHistory: !!includeHistory
      };

      // ËØ¢ÈóÆÂØºÂá∫Ê†ºÂºè
      const formatOptions = [
        { text: 'PNG ËßíËâ≤Âç° (Â∏¶Â§¥ÂÉèÂõæÁâá)', value: 'png' },
        { text: ' JSON Êñá‰ª∂', value: 'json' }
      ];
      const format = await showChoiceModal('ÈÄâÊã©ÂØºÂá∫Ê†ºÂºè', formatOptions);
      if (format === null) return;

      const safeName = chat.name.replace(/[\\/:*?"<>|]/g, '_');
      const dateStr = new Date().toISOString().split('T')[0];

      if (format === 'json') {
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `EPhone-Char-${safeName}-${dateStr}.json`;
        link.click();
        URL.revokeObjectURL(url);
      } else if (format === 'png') {
        // Ëé∑ÂèñËßíËâ≤Â§¥ÂÉè‰Ωú‰∏∫PNGÂ∫ïÂõæ
        let avatarSrc = chat.settings.aiAvatar || 'https://i.postimg.cc/y8xWzCqj/anime-boy.jpg';

        // Â∞ÜÂ§¥ÂÉèËΩ¨‰∏∫PNG Blob
        const pngBlob = await avatarToPngBlob(avatarSrc);

        // ÂµåÂÖ•ephoneÊï∞ÊçÆÂà∞PNG
        const jsonStr = JSON.stringify(exportData);
        const finalBlob = await embedDataInPng(pngBlob, 'ephone', jsonStr);

        const url = URL.createObjectURL(finalBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `EPhone-Char-${safeName}-${dateStr}.png`;
        link.click();
        URL.revokeObjectURL(url);
      }

      let msg = `ËßíËâ≤ "${chat.name}" Â∑≤ÊàêÂäüÂØºÂá∫ÔºÅ`;
      if (linkedWorldBooks.length > 0) msg += `\nÂåÖÂê´ ${linkedWorldBooks.length} ‰∏™ÂÖ≥ËÅî‰∏ñÁïå‰π¶„ÄÇ`;
      if (includeHistory) msg += `\nÂåÖÂê´ ${chatDataCopy.history.length} Êù°ËÅäÂ§©ËÆ∞ÂΩï„ÄÇ`;
      if (charMemories.length > 0) msg += `\nÂåÖÂê´ ${charMemories.length} Êù°ËÆ∞ÂøÜÊï∞ÊçÆ„ÄÇ`;
      await showCustomAlert('ÂØºÂá∫ÊàêÂäü', msg);

    } catch (error) {
      console.error("ÂØºÂá∫ËßíËâ≤Êó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
    }
  }

  /**
   * Â∞ÜÂ§¥ÂÉèÔºàbase64ÊàñURLÔºâËΩ¨‰∏∫PNG Blob
   */
  async function avatarToPngBlob(src) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth || img.width || 512;
        canvas.height = img.naturalHeight || img.height || 512;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => {
          if (blob) resolve(blob);
          else reject(new Error('Canvas toBlob Â§±Ë¥•'));
        }, 'image/png');
      };
      img.onerror = () => reject(new Error('Â§¥ÂÉèÂõæÁâáÂä†ËΩΩÂ§±Ë¥•'));
      img.src = src;
    });
  }

  /**
   * ÂØºÂÖ•Â∞èÊâãÊú∫‰∏ìÂ±ûËßíËâ≤Êï∞ÊçÆ
   */
  async function importEPhoneCharacter(exportData, avatarBase64FromPng = null, silent = false) {
    if (!exportData || exportData.type !== 'EPhoneCharacterExport') {
      throw new Error("Êó†ÊïàÁöÑÂ∞èÊâãÊú∫ËßíËâ≤ÂØºÂá∫Êï∞ÊçÆ„ÄÇ");
    }

    const chatData = exportData.chatData;
    if (!chatData || !chatData.name) {
      throw new Error("ËßíËâ≤Êï∞ÊçÆÊó†ÊïàÊàñÁº∫Â∞ëÂêçÁß∞„ÄÇ");
    }

    // ÁîüÊàêÊñ∞ÁöÑchatId
    const newChatId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);

    // ÂÖàÂ§ÑÁêÜ‰∏ñÁïå‰π¶ÔºöÂàõÂª∫Êñ∞ÁöÑ‰∏ñÁïå‰π¶Âπ∂Âª∫Á´ãIDÊò†Â∞Ñ
    const worldBookIdMap = {}; // oldId -> newId
    if (exportData.worldBooks && exportData.worldBooks.length > 0) {
      for (const wb of exportData.worldBooks) {
        const newWbId = 'wb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        const newWb = JSON.parse(JSON.stringify(wb));
        const oldId = newWb.id;
        newWb.id = newWbId;
        await db.worldBooks.add(newWb);
        state.worldBooks.push(newWb);
        worldBookIdMap[oldId] = newWbId;
      }
    }

    // Êõ¥Êñ∞chatDataÁöÑIDÂíå‰∏ñÁïå‰π¶ÂÖ≥ËÅî
    chatData.id = newChatId;
    if (chatData.settings && chatData.settings.linkedWorldBookIds) {
      chatData.settings.linkedWorldBookIds = chatData.settings.linkedWorldBookIds.map(
        oldId => worldBookIdMap[oldId] || oldId
      );
    }

    // Â¶ÇÊûúPNGÂØºÂÖ•Â∏¶‰∫ÜÂ§¥ÂÉèÔºåÁî®PNGÁöÑÂ§¥ÂÉèË¶ÜÁõñÔºàÂõ†‰∏∫PNGÊú¨Ë∫´Â∞±ÊòØÂ§¥ÂÉèÂõæÁâáÔºâ
    if (avatarBase64FromPng) {
      chatData.settings.aiAvatar = avatarBase64FromPng;
    }

    // ‰øùÂ≠òËßíËâ≤
    await db.chats.put(chatData);
    state.chats[newChatId] = chatData;

    // ÂØºÂÖ•memories
    if (exportData.memories && exportData.memories.length > 0) {
      for (const mem of exportData.memories) {
        const newMem = JSON.parse(JSON.stringify(mem));
        delete newMem.id; // ËÆ©Êï∞ÊçÆÂ∫ìËá™Âä®ÁîüÊàêÊñ∞ID
        newMem.chatId = newChatId;
        await db.memories.add(newMem);
      }
    }

    // ÂØºÂÖ•ÈÄöËØùËÆ∞ÂΩï
    if (exportData.callRecords && exportData.callRecords.length > 0) {
      for (const rec of exportData.callRecords) {
        const newRec = JSON.parse(JSON.stringify(rec));
        delete newRec.id;
        newRec.chatId = newChatId;
        await db.callRecords.add(newRec);
      }
    }

    renderChatList();

    if (!silent) {
      let msg = `ËßíËâ≤ "${chatData.name}" Â∑≤ÊàêÂäüÂØºÂÖ•ÔºÅ`;
      if (Object.keys(worldBookIdMap).length > 0) {
        msg += `\nÂ∑≤Ëá™Âä®ÂàõÂª∫Âπ∂ÂÖ≥ËÅî ${Object.keys(worldBookIdMap).length} ‰∏™‰∏ñÁïå‰π¶„ÄÇ`;
      }
      if (exportData.includesHistory && chatData.history && chatData.history.length > 0) {
        msg += `\nÂ∑≤ÂØºÂÖ• ${chatData.history.length} Êù°ËÅäÂ§©ËÆ∞ÂΩï„ÄÇ`;
      }
      if (exportData.memories && exportData.memories.length > 0) {
        msg += `\nÂ∑≤ÂØºÂÖ• ${exportData.memories.length} Êù°ËÆ∞ÂøÜÊï∞ÊçÆ„ÄÇ`;
      }
      await showCustomAlert('ÂØºÂÖ•ÊàêÂäüÔºÅ', msg);
    }
  }

  async function exportSingleChat() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    try {
      // ÊñπÊ°à3ÔºöÂØºÂá∫Êó∂ÁßªÈô§APIÂéÜÂè≤ËÆ∞ÂΩï
      const chatDataCopy = { ...chat };
      if (chatDataCopy.apiHistory) {
        delete chatDataCopy.apiHistory;
      }

      const backupData = {
        type: 'EPhoneSingleChat',
        version: 1,
        chatData: chatDataCopy
      };

      const blob = new Blob(
        [JSON.stringify(backupData, null, 2)], {
        type: 'application/json'
      }
      );
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;

      link.download = `EPhone-Chat-${chat.name}-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);

      await showCustomAlert('ÂØºÂá∫ÊàêÂäü', `‰∏é‚Äú${chat.name}‚ÄùÁöÑËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÊàêÂäüÂØºÂá∫ÔºÅ`);

    } catch (error) {
      console.error("ÂØºÂá∫Âçï‰∏™ËÅäÂ§©Êó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
    }
  }


  async function importSingleChat(file) {
    if (!file || !state.activeChatId) return;
    const currentChatId = state.activeChatId;
    const currentChat = state.chats[currentChatId];

    try {
      const text = await file.text();
      const data = JSON.parse(text);


      if (data.type !== 'EPhoneSingleChat' || !data.chatData) {
        throw new Error("Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËøô‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑÂçïËÅäÂ§á‰ªΩÊñá‰ª∂„ÄÇ");
      }


      const confirmed = await showCustomConfirm(
        '‰∏•ÈáçË≠¶ÂëäÔºÅ',
        `ËøôÂ∞ÜÁî®Â§á‰ªΩÊñá‰ª∂‰∏≠ÁöÑÊï∞ÊçÆ„ÄêÂÆåÂÖ®Ë¶ÜÁõñ„ÄëÂΩìÂâç‰∏é‚Äú${currentChat.name}‚ÄùÁöÑËÅäÂ§©ËÆ∞ÂΩïÂíåËÆæÁΩÆ„ÄÇÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ<br><br><strong>Á°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü</strong>`, {
        confirmButtonClass: 'btn-danger',
        confirmText: 'Á°ÆËÆ§Ë¶ÜÁõñ'
      }
      );

      if (!confirmed) return;


      const importedChatData = data.chatData;


      importedChatData.id = currentChatId;


      await db.chats.put(importedChatData);
      state.chats[currentChatId] = importedChatData;


      await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', 'ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÊàêÂäüË¶ÜÁõñÔºÅÊ≠£Âú®Âà∑Êñ∞ÁïåÈù¢...');


      renderChatInterface(currentChatId);
      renderChatList();
      document.getElementById('chat-settings-btn').click();

    } catch (error) {
      console.error("ÂØºÂÖ•Âçï‰∏™ËÅäÂ§©Êó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ëß£ÊûêÊàñÂ∫îÁî®Â§±Ë¥•: ${error.message}`);
    }
  }



  function openCharacterSelector() {
    renderCharacterSelector();
    showScreen('character-selection-screen');
  }

  // MY Phone Áõ∏ÂÖ≥ÂèòÈáè
  let activeMyPhoneCharacterId = null;

  // MY Phone ÈîÅÂ±èÁä∂ÊÄÅ
  let myPhoneLockScreenState = {
    passwordBuffer: '',
    isLocked: false,
    pendingCharacterId: null
  };

  // MY Phone Âà†Èô§Ê®°ÂºèÁõ∏ÂÖ≥Áä∂ÊÄÅ
  let myPhoneDeleteMode = {
    active: false,
    appType: null, // 'qq', 'album', 'browser', 'taobao', 'memo', 'diary', 'usage', 'music', 'amap'
    selectedIndices: new Set()
  };

  function openMyphoneScreen() {
    renderMyPhoneCharacterSelector();
    showScreen('myphone-selection-screen');
  }

  // openCharacterGeneratorScreen Áî± character-generator.js Êèê‰æõ

  function renderMyPhoneCharacterSelector() {
    const gridEl = document.getElementById('myphone-character-grid');
    gridEl.innerHTML = '';

    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (characters.length === 0) {
      gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøòÊ≤°ÊúâÂèØ‰ª•Êü•ÁúãÊâãÊú∫ÁöÑËßíËâ≤Âì¶~</p>';
      return;
    }

    characters.forEach(char => {
      const item = document.createElement('div');
      item.className = 'character-select-item';
      item.innerHTML = `
            <img src="${char.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${char.name}</span>
        `;
      item.addEventListener('click', () => switchToMyPhoneCharacter(char.id));
      gridEl.appendChild(item);
    });
  }

  async function switchToMyPhoneCharacter(characterId) {
    const char = state.chats[characterId];
    if (!char) return;

    // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®‰∫ÜMyPhoneÈîÅÂ±è
    if (char.settings.myPhoneLockScreenEnabled) {
      // ‰øùÂ≠òÂæÖËøõÂÖ•ÁöÑËßíËâ≤ID
      myPhoneLockScreenState.pendingCharacterId = characterId;

      // ÊòæÁ§∫ÈîÅÂ±èÁïåÈù¢
      showMyPhoneLockScreen(char);
      return;
    }

    // Â¶ÇÊûúÊ≤°ÊúâÂêØÁî®ÈîÅÂ±èÔºåÁõ¥Êé•ËøõÂÖ•
    enterMyPhone(characterId);
  }

  function enterMyPhone(characterId) {
    activeMyPhoneCharacterId = characterId;
    console.log(`Â∑≤ÂàáÊç¢Âà∞ËßíËâ≤ ${characterId} Êü•ÁúãÊàëÁöÑÊâãÊú∫`);

    applyMyPhoneWallpaper();
    applyMyPhoneAppIcons();

    renderMyPhoneHomeScreen();
    showScreen('myphone-screen');
  }

  function renderMyPhoneHomeScreen() {
    switchToMyPhoneScreen('myphone-home-screen');
  }

  function switchToMyPhoneScreen(screenId) {
    document.querySelectorAll('#myphone-screen .char-screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
  }

  function switchToMyPhoneHomeScreen() {
    switchToMyPhoneScreen('myphone-home-screen');
  }

  function switchToCPhone() {
    // ‰ªé MY Phone ÂàáÊç¢Âõû CP Phone ËßíËâ≤ÈÄâÊã©
    openCharacterSelector();
  }

  function openMyPhoneSettings() {
    // ÂõûÊòæËÆæÁΩÆ
    const char = state.chats[activeMyPhoneCharacterId];
    if (char) {
      const toggle = document.getElementById('myphone-lock-screen-toggle');
      const detail = document.getElementById('myphone-lock-screen-settings-detail');
      const passwordInput = document.getElementById('myphone-lock-screen-password-input');

      if (toggle) {
        toggle.checked = char.settings.myPhoneLockScreenEnabled || false;
        if (detail) {
          detail.style.display = toggle.checked ? 'block' : 'none';
        }
      }

      if (passwordInput) {
        passwordInput.value = char.settings.myPhoneLockScreenPassword || '';
      }
    }

    switchToMyPhoneScreen('myphone-settings-screen');
  }

  function showMyPhoneLockScreen(char) {
    const lockScreen = document.getElementById('lock-screen');

    // ËÆæÁΩÆÂ£ÅÁ∫∏Ôºà‰ΩøÁî®‰∏ªÂ±èÂπïÁöÑÈîÅÂ±èÂ£ÅÁ∫∏Ôºâ
    if (state.globalSettings.lockScreenWallpaper) {
      lockScreen.style.backgroundImage = `url(${state.globalSettings.lockScreenWallpaper})`;
    } else {
      lockScreen.style.backgroundImage = 'linear-gradient(135deg, #1c1c1e, #3a3a3c)';
    }

    // Ê†áËÆ∞‰∏∫MyPhoneÈîÅÂ±èÊ®°Âºè
    myPhoneLockScreenState.isLocked = true;
    lockScreen.classList.add('active');
    lockScreen.classList.add('myphone-lock-mode');

    // Êõ¥Êñ∞Êó∂Èíü
    updateMyPhoneLockScreenClock();
  }

  function updateMyPhoneLockScreenClock() {
    if (!myPhoneLockScreenState.isLocked) return;

    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
    const dateString = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });

    document.getElementById('lock-time').textContent = timeString;
    document.getElementById('lock-date').textContent = dateString;
  }

  function showMyPhonePasswordInput() {
    const lockScreen = document.getElementById('lock-screen');
    const passwordArea = document.getElementById('lock-password-area');

    lockScreen.classList.add('input-mode');
    passwordArea.style.display = 'flex';
    myPhoneLockScreenState.passwordBuffer = '';
    updateMyPhoneLockDots();
  }

  function hideMyPhonePasswordInput() {
    const lockScreen = document.getElementById('lock-screen');
    const passwordArea = document.getElementById('lock-password-area');

    lockScreen.classList.remove('input-mode');
    passwordArea.style.display = 'none';
    myPhoneLockScreenState.passwordBuffer = '';
  }

  function updateMyPhoneLockDots() {
    const dots = document.querySelectorAll('.lock-dots .dot');
    const len = myPhoneLockScreenState.passwordBuffer.length;
    dots.forEach((dot, index) => {
      if (index < len) dot.classList.add('filled');
      else dot.classList.remove('filled');
    });
  }

  function checkMyPhoneLockPassword() {
    const characterId = myPhoneLockScreenState.pendingCharacterId;
    if (!characterId) return;

    const char = state.chats[characterId];
    if (!char) return;

    const correctPassword = char.settings.myPhoneLockScreenPassword;

    if (myPhoneLockScreenState.passwordBuffer === correctPassword) {
      // Ëß£ÈîÅÊàêÂäü
      const lockScreen = document.getElementById('lock-screen');
      lockScreen.classList.add('unlocking');
      myPhoneLockScreenState.isLocked = false;

      setTimeout(() => {
        lockScreen.classList.remove('active');
        lockScreen.classList.remove('unlocking');
        lockScreen.classList.remove('myphone-lock-mode');
        hideMyPhonePasswordInput();

        // ËøõÂÖ•MyPhone
        enterMyPhone(characterId);
        myPhoneLockScreenState.pendingCharacterId = null;
      }, 500);
    } else {
      // Ëß£ÈîÅÂ§±Ë¥•
      const dots = document.querySelector('.lock-dots');
      dots.classList.add('shake-animation');
      if (navigator.vibrate) navigator.vibrate(200);

      setTimeout(() => {
        dots.classList.remove('shake-animation');
        myPhoneLockScreenState.passwordBuffer = '';
        updateMyPhoneLockDots();
      }, 400);
    }
  }

  function openMyPhoneViewRecords() {
    switchToMyPhoneScreen('myphone-view-records-screen');
  }

  // MY Phone Âà†Èô§Ê®°ÂºèÂäüËÉΩ
  function toggleMyPhoneDeleteMode(appType) {
    if (myPhoneDeleteMode.active && myPhoneDeleteMode.appType === appType) {
      // ÈÄÄÂá∫Âà†Èô§Ê®°Âºè
      exitMyPhoneDeleteMode();
    } else {
      // ËøõÂÖ•Âà†Èô§Ê®°Âºè
      enterMyPhoneDeleteMode(appType);
    }
  }

  function enterMyPhoneDeleteMode(appType) {
    myPhoneDeleteMode.active = true;
    myPhoneDeleteMode.appType = appType;
    myPhoneDeleteMode.selectedIndices.clear();

    // Êõ¥Êñ∞ÊåâÈíÆUI - Ê∑ªÂä†Âà†Èô§Ê®°ÂºèÂ∑•ÂÖ∑Ê†è
    const screen = document.getElementById(`myphone-${appType}-screen`);
    if (!screen) return;

    const header = screen.querySelector('.header');
    if (!header) return;

    // ÈöêËóèÂÖ∂‰ªñÊåâÈíÆÔºåÂè™ÊòæÁ§∫ËøîÂõûÊåâÈíÆ
    const actionBtns = header.querySelectorAll('.action-btn');
    actionBtns.forEach(btn => btn.style.display = 'none');

    // ÂàõÂª∫Âà†Èô§Ê®°ÂºèÂ∑•ÂÖ∑Ê†è
    let deleteToolbar = header.querySelector('.delete-mode-toolbar');
    if (!deleteToolbar) {
      deleteToolbar = document.createElement('div');
      deleteToolbar.className = 'delete-mode-toolbar';
      deleteToolbar.style.cssText = 'display: flex; gap: 8px; align-items: center;';
      deleteToolbar.innerHTML = `
        <button class="delete-mode-btn" onclick="selectAllMyPhoneItems()" style="padding: 6px 12px; border: none; background: var(--accent-color); color: white; border-radius: 6px; cursor: pointer; font-size: 14px;">ÂÖ®ÈÄâ</button>
        <button class="delete-mode-btn" onclick="confirmDeleteMyPhoneItems()" style="padding: 6px 12px; border: none; background: #ff4444; color: white; border-radius: 6px; cursor: pointer; font-size: 14px;">Âà†Èô§</button>
        <button class="delete-mode-btn" onclick="exitMyPhoneDeleteMode()" style="padding: 6px 12px; border: none; background: var(--secondary-bg); color: var(--text-color); border-radius: 6px; cursor: pointer; font-size: 14px;">ÂèñÊ∂à</button>
      `;
      header.appendChild(deleteToolbar);
    }
    deleteToolbar.style.display = 'flex';

    // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®‰ª•ÊòæÁ§∫Â§çÈÄâÊ°Ü
    rerenderMyPhoneApp(appType);
  }

  function exitMyPhoneDeleteMode() {
    if (!myPhoneDeleteMode.active) return;

    const appType = myPhoneDeleteMode.appType;
    myPhoneDeleteMode.active = false;
    myPhoneDeleteMode.appType = null;
    myPhoneDeleteMode.selectedIndices.clear();

    // ÊÅ¢Â§çÊåâÈíÆUI
    const screen = document.getElementById(`myphone-${appType}-screen`);
    if (!screen) return;

    const header = screen.querySelector('.header');
    if (!header) return;

    // ÊÅ¢Â§çÊòæÁ§∫Êìç‰ΩúÊåâÈíÆ
    const actionBtns = header.querySelectorAll('.action-btn');
    actionBtns.forEach(btn => btn.style.display = '');

    // ÈöêËóèÂà†Èô§Ê®°ÂºèÂ∑•ÂÖ∑Ê†è
    const deleteToolbar = header.querySelector('.delete-mode-toolbar');
    if (deleteToolbar) {
      deleteToolbar.style.display = 'none';
    }

    // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®‰ª•ÈöêËóèÂ§çÈÄâÊ°Ü
    rerenderMyPhoneApp(appType);
  }
  // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
  window.exitMyPhoneDeleteMode = exitMyPhoneDeleteMode;

  function selectAllMyPhoneItems() {
    if (!myPhoneDeleteMode.active) return;

    const appType = myPhoneDeleteMode.appType;
    const char = state.chats[activeMyPhoneCharacterId];
    if (!char) return;

    let items = [];
    switch (appType) {
      case 'qq':
        items = char.myPhoneSimulatedQQConversations || [];
        break;
      case 'album':
        items = char.myPhoneAlbum || [];
        break;
      case 'browser':
        items = char.myPhoneBrowserHistory || [];
        break;
      case 'taobao':
        items = char.myPhoneTaobaoHistory || [];
        break;
      case 'memo':
        items = char.myPhoneMemos || [];
        break;
      case 'diary':
        items = char.myPhoneDiaries || [];
        break;
      case 'usage':
        items = char.myPhoneAppUsage || [];
        break;
      case 'music':
        items = char.myPhoneMusicPlaylist || [];
        break;
      case 'amap':
        items = char.myPhoneAmapHistory || [];
        break;
    }

    // Âà§Êñ≠ÊòØÂÖ®ÈÄâËøòÊòØÂèñÊ∂àÂÖ®ÈÄâ
    const allSelected = myPhoneDeleteMode.selectedIndices.size === items.length;

    if (allSelected) {
      // ÂèñÊ∂àÂÖ®ÈÄâ
      myPhoneDeleteMode.selectedIndices.clear();
    } else {
      // ÂÖ®ÈÄâ
      myPhoneDeleteMode.selectedIndices.clear();
      items.forEach((_, idx) => myPhoneDeleteMode.selectedIndices.add(idx));
    }

    // Êõ¥Êñ∞Â§çÈÄâÊ°ÜÁä∂ÊÄÅ
    updateMyPhoneCheckboxStates();
  }
  // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
  window.selectAllMyPhoneItems = selectAllMyPhoneItems;

  function toggleMyPhoneItemSelection(index) {
    if (!myPhoneDeleteMode.active) return;

    if (myPhoneDeleteMode.selectedIndices.has(index)) {
      myPhoneDeleteMode.selectedIndices.delete(index);
    } else {
      myPhoneDeleteMode.selectedIndices.add(index);
    }

    // Êõ¥Êñ∞Â§çÈÄâÊ°ÜÁä∂ÊÄÅ
    updateMyPhoneCheckboxStates();
  }
  // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
  window.toggleMyPhoneItemSelection = toggleMyPhoneItemSelection;

  function updateMyPhoneCheckboxStates() {
    const checkboxes = document.querySelectorAll('.myphone-delete-checkbox');
    checkboxes.forEach(checkbox => {
      const index = parseInt(checkbox.dataset.index);
      checkbox.checked = myPhoneDeleteMode.selectedIndices.has(index);
    });
  }

  async function confirmDeleteMyPhoneItems() {
    if (!myPhoneDeleteMode.active || myPhoneDeleteMode.selectedIndices.size === 0) {
      showCustomAlert('ÊèêÁ§∫', 'ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÈ°πË¶ÅÂà†Èô§ÁöÑÂÜÖÂÆπ');
      return;
    }

    const count = myPhoneDeleteMode.selectedIndices.size;
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${count} È°πÂÜÖÂÆπÂêóÔºü`);

    if (!confirmed) return;

    const appType = myPhoneDeleteMode.appType;
    const char = state.chats[activeMyPhoneCharacterId];
    if (!char) return;

    // Ëé∑ÂèñË¶ÅÂà†Èô§ÁöÑÁ¥¢ÂºïÊï∞ÁªÑÔºå‰ªéÂ§ßÂà∞Â∞èÊéíÂ∫èÔºàÈÅøÂÖçÂà†Èô§Êó∂Á¥¢ÂºïÂèòÂåñÔºâ
    const indicesToDelete = Array.from(myPhoneDeleteMode.selectedIndices).sort((a, b) => b - a);

    // Ê†πÊçÆappTypeÂà†Èô§ÂØπÂ∫îÁöÑÊï∞ÊçÆ
    switch (appType) {
      case 'qq':
        if (!char.myPhoneSimulatedQQConversations) char.myPhoneSimulatedQQConversations = [];
        indicesToDelete.forEach(idx => {
          char.myPhoneSimulatedQQConversations.splice(idx, 1);
        });
        break;
      case 'album':
        if (!char.myPhoneAlbum) char.myPhoneAlbum = [];
        indicesToDelete.forEach(idx => {
          char.myPhoneAlbum.splice(idx, 1);
        });
        break;
      case 'browser':
        if (!char.myPhoneBrowserHistory) char.myPhoneBrowserHistory = [];
        indicesToDelete.forEach(idx => {
          char.myPhoneBrowserHistory.splice(idx, 1);
        });
        break;
      case 'taobao':
        if (!char.myPhoneTaobaoHistory) char.myPhoneTaobaoHistory = [];
        indicesToDelete.forEach(idx => {
          char.myPhoneTaobaoHistory.splice(idx, 1);
        });
        break;
      case 'memo':
        if (!char.myPhoneMemos) char.myPhoneMemos = [];
        indicesToDelete.forEach(idx => {
          char.myPhoneMemos.splice(idx, 1);
        });
        break;
      case 'diary':
        if (!char.myPhoneDiaries) char.myPhoneDiaries = [];
        indicesToDelete.forEach(idx => {
          char.myPhoneDiaries.splice(idx, 1);
        });
        break;
      case 'usage':
        if (!char.myPhoneAppUsage) char.myPhoneAppUsage = [];
        indicesToDelete.forEach(idx => {
          char.myPhoneAppUsage.splice(idx, 1);
        });
        break;
      case 'music':
        if (!char.myPhoneMusicPlaylist) char.myPhoneMusicPlaylist = [];
        indicesToDelete.forEach(idx => {
          char.myPhoneMusicPlaylist.splice(idx, 1);
        });
        break;
      case 'amap':
        if (!char.myPhoneAmapHistory) char.myPhoneAmapHistory = [];
        indicesToDelete.forEach(idx => {
          char.myPhoneAmapHistory.splice(idx, 1);
        });
        break;
    }

    // ‰øùÂ≠òÊï∞ÊçÆÂà∞Êï∞ÊçÆÂ∫ì
    await db.chats.put(char);

    // ÈÄÄÂá∫Âà†Èô§Ê®°ÂºèÂπ∂Âà∑Êñ∞ÂàóË°®
    exitMyPhoneDeleteMode();

    showCustomAlert('ÊàêÂäü', `Â∑≤Âà†Èô§ ${count} È°πÂÜÖÂÆπ`);
  }
  // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
  window.confirmDeleteMyPhoneItems = confirmDeleteMyPhoneItems;

  function rerenderMyPhoneApp(appType) {
    switch (appType) {
      case 'qq':
        renderMyPhoneSimulatedQQ();
        break;
      case 'album':
        renderMyPhoneAlbum();
        break;
      case 'browser':
        renderMyPhoneBrowserHistory();
        break;
      case 'taobao':
        renderMyPhoneTaobao();
        break;
      case 'memo':
        renderMyPhoneMemoList();
        break;
      case 'diary':
        renderMyPhoneDiaryList();
        break;
      case 'usage':
        renderMyPhoneAppUsage();
        break;
      case 'music':
        renderMyPhoneMusicScreen();
        break;
      case 'amap':
        renderMyPhoneAmap();
        break;
    }
  }

  // MY Phone Ê∑ªÂä†ËÅîÁ≥ª‰∫∫ÈÄâÊã©ÂºπÁ™ó
  async function showMyPhoneAddContactDialog() {
    const modal = document.getElementById('myphone-add-choice-modal');
    if (!modal) return;

    modal.classList.add('visible');
  }

  // ÊâãÂä®ÂàõÂª∫ËßíËâ≤
  async function manualCreateMyPhoneContact() {
    // ÂÖ≥Èó≠ÈÄâÊã©ÂºπÁ™ó
    document.getElementById('myphone-add-choice-modal')?.classList.remove('visible');

    // Á¨¨‰∏ÄÊ≠•ÔºöËæìÂÖ•ËÅîÁ≥ª‰∫∫ÂêçÁß∞
    const name = await showCustomPrompt('Ê∑ªÂä†ËÅîÁ≥ª‰∫∫ (1/3)', 'ËØ∑ËæìÂÖ•ËÅîÁ≥ª‰∫∫ÂêçÁß∞');
    if (!name || !name.trim()) return;

    // Á¨¨‰∫åÊ≠•ÔºöËæìÂÖ•Â§áÊ≥®ÔºàÂèØÈÄâÔºâ
    const remark = await showCustomPrompt('Ê∑ªÂä†ËÅîÁ≥ª‰∫∫ (2/3)', 'ËØ∑ËæìÂÖ•Â§áÊ≥®ÔºàÂèØÈÄâÔºåÊòæÁ§∫Âú®ÂàóË°®‰∏≠Ôºâ', '', 'text');

    // Á¨¨‰∏âÊ≠•ÔºöÈÄâÊã©Â§¥ÂÉèÊñπÂºè
    const avatarChoice = await showChoiceModal('Ê∑ªÂä†ËÅîÁ≥ª‰∫∫ (3/3)', [
      { text: '‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè', value: 'default' },
      { text: '‰∏ä‰º†Êú¨Âú∞ÂõæÁâá', value: 'upload' },
      { text: 'ËæìÂÖ•ÂõæÁâáURL', value: 'url' }
    ]);

    let finalAvatar = defaultAvatar;

    if (avatarChoice === 'upload') {
      // ‰∏ä‰º†Êú¨Âú∞ÂõæÁâá
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';

      const avatarData = await new Promise((resolve) => {
        fileInput.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => resolve(event.target.result);
            reader.readAsDataURL(file);
          } else {
            resolve(null);
          }
        };
        fileInput.click();
      });

      if (avatarData) {
        finalAvatar = avatarData;
      }
    } else if (avatarChoice === 'url') {
      // ËæìÂÖ•URL
      const avatarUrl = await showCustomPrompt('ËæìÂÖ•Â§¥ÂÉèURL', 'ËØ∑ËæìÂÖ•ÂõæÁâáURLÂú∞ÂùÄ');
      if (avatarUrl && avatarUrl.trim()) {
        finalAvatar = avatarUrl.trim();
      }
    }

    // Ê∑ªÂä†ËÅîÁ≥ª‰∫∫
    await addMyPhoneContact(name.trim(), remark ? remark.trim() : '', finalAvatar);

    // Âà∑Êñ∞ÂàóË°®
    renderMyPhoneSimulatedQQ();
  }

  // ÊòæÁ§∫ÂØºÂÖ•‰∏ªÂ±èÂπïËßíËâ≤ÂºπÁ™ó
  async function showImportMainScreenCharacters() {
    // ÂÖ≥Èó≠ÈÄâÊã©ÂºπÁ™ó
    document.getElementById('myphone-add-choice-modal')?.classList.remove('visible');

    if (!activeMyPhoneCharacterId) return;
    const currentChar = state.chats[activeMyPhoneCharacterId];
    if (!currentChar) return;

    // Ëé∑ÂèñÊâÄÊúâÈùûÁæ§ÁªÑËßíËâ≤ÔºåÊéíÈô§ÂΩìÂâçËßíËâ≤
    const allCharacters = Object.values(state.chats).filter(chat =>
      !chat.isGroup && chat.id !== activeMyPhoneCharacterId
    );

    if (allCharacters.length === 0) {
      showCustomAlert('ÊèêÁ§∫', 'Ê≤°ÊúâÂèØÂØºÂÖ•ÁöÑËßíËâ≤');
      return;
    }

    // Ê∏≤ÊüìËßíËâ≤ÂàóË°®
    const listEl = document.getElementById('myphone-import-list');
    listEl.innerHTML = '';

    allCharacters.forEach(char => {
      const item = document.createElement('div');
      item.className = 'chat-list-item';
      item.style.padding = '15px';
      item.style.borderBottom = '1px solid var(--border-color)';
      item.style.cursor = 'pointer';
      item.style.display = 'flex';
      item.style.alignItems = 'center';
      item.style.gap = '15px';

      const charAvatar = char.settings.aiAvatar || defaultAvatar;

      // Ëé∑ÂèñÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ
      const lastMessages = char.history.filter(m => !m.isHidden).slice(-10);
      const lastMsg = lastMessages.slice(-1)[0];
      let lastMsgText = 'ÊöÇÊó†Ê∂àÊÅØ';
      if (lastMsg) {
        if (typeof lastMsg.content === 'string') {
          lastMsgText = lastMsg.content.substring(0, 30);
        } else if (Array.isArray(lastMsg.content)) {
          lastMsgText = '[ÂõæÁâá]';
        }
      }

      item.innerHTML = `
        <input type="checkbox" class="myphone-import-checkbox" data-char-id="${char.id}" style="width: 20px; height: 20px; cursor: pointer;">
        <img src="${charAvatar}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
        <div style="flex: 1; overflow: hidden;">
          <div style="font-weight: 500; font-size: 16px; margin-bottom: 5px;">${char.name}</div>
          <div style="font-size: 14px; color: #999; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${lastMsgText}</div>
        </div>
      `;

      // ÁÇπÂáªÊï¥Ë°åÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ
      item.addEventListener('click', (e) => {
        if (e.target.type !== 'checkbox') {
          const checkbox = item.querySelector('.myphone-import-checkbox');
          checkbox.checked = !checkbox.checked;
          updateImportSelectAllState();
        }
      });

      // checkbox ÂçïÁã¨ÁõëÂê¨
      const checkbox = item.querySelector('.myphone-import-checkbox');
      checkbox.addEventListener('change', () => {
        updateImportSelectAllState();
      });

      listEl.appendChild(item);
    });

    // ÊòæÁ§∫ÂºπÁ™ó
    document.getElementById('myphone-import-characters-modal').classList.add('visible');
  }

  // Êõ¥Êñ∞ÂÖ®ÈÄâÁä∂ÊÄÅ
  function updateImportSelectAllState() {
    const allCheckboxes = document.querySelectorAll('.myphone-import-checkbox');
    const selectAllCheckbox = document.getElementById('select-all-myphone-import');

    if (allCheckboxes.length === 0) return;

    const checkedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;
    selectAllCheckbox.checked = checkedCount === allCheckboxes.length;
  }

  // ÂØºÂÖ•ÈÄâ‰∏≠ÁöÑËßíËâ≤
  async function importSelectedCharacters() {
    if (!activeMyPhoneCharacterId) return;
    const currentChar = state.chats[activeMyPhoneCharacterId];
    if (!currentChar) return;

    // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËßíËâ≤ID
    const selectedCheckboxes = Array.from(document.querySelectorAll('.myphone-import-checkbox:checked'));

    if (selectedCheckboxes.length === 0) {
      showCustomAlert('ÊèêÁ§∫', 'ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
      return;
    }

    const selectedCharIds = selectedCheckboxes.map(cb => cb.dataset.charId);

    // ÂàùÂßãÂåñÊï∞ÁªÑ
    if (!currentChar.myPhoneSimulatedQQConversations) {
      currentChar.myPhoneSimulatedQQConversations = [];
    }

    // ÂØºÂÖ•ÊØè‰∏™ÈÄâ‰∏≠ÁöÑËßíËâ≤
    let importCount = 0;
    for (const charId of selectedCharIds) {
      const char = state.chats[charId];
      if (!char) continue;

      // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂ≠òÂú®
      const existingIndex = currentChar.myPhoneSimulatedQQConversations.findIndex(
        conv => conv.importedFromCharId === charId
      );

      if (existingIndex !== -1) {
        // Â∑≤Â≠òÂú®ÔºåË∑≥Ëøá
        continue;
      }

      // Ëé∑ÂèñÊúÄÂêé10Êù°Ê∂àÊÅØ
      const recentMessages = char.history.filter(m => !m.isHidden).slice(-10);

      // ËΩ¨Êç¢Ê∂àÊÅØÊ†ºÂºè - ‰øùÊåÅÂéüÂßãÊ†ºÂºè‰ª•ÂÖºÂÆπcreateMessageElement
      const convertedMessages = recentMessages.map(msg => {
        const isUser = msg.role === 'user';

        // ‰øùÊåÅÂéüÂßãÊ∂àÊÅØÁªìÊûÑ
        const convertedMsg = {
          role: msg.role,
          content: msg.content,
          timestamp: msg.timestamp || Date.now(),
          sender: isUser ? (state.qzoneSettings.nickname || 'Êàë') : char.name
        };

        // Â¶ÇÊûúÊúâÂÖ∂‰ªñÂ±ûÊÄßÔºå‰πü‰øùÁïô
        if (msg.type) convertedMsg.type = msg.type;
        if (msg.imageUrl) convertedMsg.imageUrl = msg.imageUrl;
        if (msg.voiceUrl) convertedMsg.voiceUrl = msg.voiceUrl;
        if (msg.voiceText) convertedMsg.voiceText = msg.voiceText;
        if (msg.duration) convertedMsg.duration = msg.duration;

        return convertedMsg;
      });

      // Ëé∑ÂèñÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÊñáÊú¨
      let lastMessageText = 'ÊöÇÊó†Ê∂àÊÅØ';
      if (convertedMessages.length > 0) {
        const lastMsg = convertedMessages[convertedMessages.length - 1];
        lastMessageText = lastMsg.content.substring(0, 30);
      }

      // ÂàõÂª∫Êñ∞ËÅîÁ≥ª‰∫∫
      const newContact = {
        name: char.name,
        originalName: char.name,
        avatar: char.settings.aiAvatar || defaultAvatar,
        lastMessage: lastMessageText,
        messages: convertedMessages,
        isImported: true,
        importedFromCharId: charId
      };

      currentChar.myPhoneSimulatedQQConversations.push(newContact);
      importCount++;
    }

    // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
    await db.chats.put(currentChar);

    // ÂÖ≥Èó≠ÂºπÁ™ó
    document.getElementById('myphone-import-characters-modal').classList.remove('visible');

    // Âà∑Êñ∞ÂàóË°®
    renderMyPhoneSimulatedQQ();

    // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
    showCustomAlert('ÊàêÂäü', `Â∑≤ÂØºÂÖ• ${importCount} ‰∏™ËßíËâ≤`);
  }

  // Ê∑ªÂä†MY PhoneËÅîÁ≥ª‰∫∫
  async function addMyPhoneContact(name, remark, avatar) {
    if (!activeMyPhoneCharacterId) return;
    const char = state.chats[activeMyPhoneCharacterId];
    if (!char) return;

    // ÂàùÂßãÂåñÊï∞ÁªÑ
    if (!char.myPhoneSimulatedQQConversations) {
      char.myPhoneSimulatedQQConversations = [];
    }

    // ÂàõÂª∫Êñ∞ËÅîÁ≥ª‰∫∫
    const newContact = {
      name: remark || name,
      originalName: name,
      avatar: avatar || defaultAvatar,
      lastMessage: 'ÊöÇÊó†Ê∂àÊÅØ',
      messages: [],
      isManuallyAdded: true // Ê†áËÆ∞‰∏∫ÊâãÂä®Ê∑ªÂä†
    };

    // Ê∑ªÂä†Âà∞ÂàóË°®
    char.myPhoneSimulatedQQConversations.unshift(newContact);

    // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
    await db.chats.put(char);

    showCustomAlert('ÊàêÂäü', `Â∑≤Ê∑ªÂä†ËÅîÁ≥ª‰∫∫Ôºö${name}`);
  }

  // ÊâìÂºÄËÅîÁ≥ª‰∫∫ËÆæÁΩÆÁïåÈù¢
  function openMyPhoneContactSettings() {
    const char = state.chats[activeMyPhoneCharacterId];
    if (!char) return;

    const index = window.currentMyPhoneConversationIndex;
    if (index === -1 || index === undefined) return;

    const contact = char.myPhoneSimulatedQQConversations[index];
    if (!contact) return;

    // Â°´ÂÖÖËÆæÁΩÆÁïåÈù¢
    document.getElementById('myphone-settings-avatar-img').src = contact.avatar || defaultAvatar;
    document.getElementById('myphone-settings-name').value = contact.originalName || contact.name;
    document.getElementById('myphone-settings-remark').value = contact.name;

    // Ê∏≤ÊüìÂØπËØùÂàóË°®
    renderMyPhoneContactMessages(contact);

    switchToMyPhoneScreen('myphone-contact-settings-screen');
  }

  // Ê∏≤ÊüìËÅîÁ≥ª‰∫∫ÁöÑÂØπËØùÂàóË°®
  function renderMyPhoneContactMessages(contact) {
    const listEl = document.getElementById('myphone-conversation-list');
    listEl.innerHTML = '';

    if (!contact.messages || contact.messages.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">ÊöÇÊó†ÂØπËØùËÆ∞ÂΩï</p>';
      return;
    }

    contact.messages.forEach((msg, idx) => {
      const msgEl = document.createElement('div');
      msgEl.style.cssText = 'padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; background: var(--secondary-bg);';

      // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãÊòæÁ§∫‰∏çÂêåÂÜÖÂÆπ
      let contentDisplay = '';
      let typeLabel = '';

      if (msg.type === 'voice_message') {
        typeLabel = '[ËØ≠Èü≥]';
        contentDisplay = msg.content;
      } else if (msg.type === 'ai_image') {
        typeLabel = '[ÂõæÁâá]';
        contentDisplay = msg.content;
      } else if (msg.type === 'transfer') {
        typeLabel = '[ËΩ¨Ë¥¶]';
        contentDisplay = `¬•${msg.amount} - ${msg.note || ''}`;
      } else {
        contentDisplay = msg.content;
      }

      msgEl.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <div>
            <span style="font-weight: 500; color: var(--text-color);">${msg.role === 'user' ? 'Êàë' : contact.name}</span>
            ${typeLabel ? `<span style="margin-left: 8px; padding: 2px 6px; background: var(--accent-color); color: white; border-radius: 4px; font-size: 11px;">${typeLabel}</span>` : ''}
          </div>
          <button onclick="deleteMyPhoneMessage(${idx})" style="padding: 4px 8px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Âà†Èô§</button>
        </div>
        <div style="color: var(--text-color);">${contentDisplay}</div>
      `;
      listEl.appendChild(msgEl);
    });
  }

  // Âà†Èô§ÂØπËØùÊ∂àÊÅØ
  window.deleteMyPhoneMessage = async function (msgIndex) {
    const char = state.chats[activeMyPhoneCharacterId];
    if (!char) return;

    const index = window.currentMyPhoneConversationIndex;
    const contact = char.myPhoneSimulatedQQConversations[index];
    if (!contact) return;

    contact.messages.splice(msgIndex, 1);
    await db.chats.put(char);

    renderMyPhoneContactMessages(contact);
  };

  // ‰øùÂ≠òËÅîÁ≥ª‰∫∫ËÆæÁΩÆ
  async function saveMyPhoneContactSettings() {
    const char = state.chats[activeMyPhoneCharacterId];
    if (!char) return;

    const index = window.currentMyPhoneConversationIndex;
    const contact = char.myPhoneSimulatedQQConversations[index];
    if (!contact) return;

    const newName = document.getElementById('myphone-settings-name').value.trim();
    const newRemark = document.getElementById('myphone-settings-remark').value.trim();

    if (!newName) {
      showCustomAlert('ÊèêÁ§∫', 'ËÅîÁ≥ª‰∫∫ÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫');
      return;
    }

    contact.originalName = newName;
    contact.name = newRemark || newName;

    await db.chats.put(char);

    showCustomAlert('ÊàêÂäü', 'ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');

    // ËøîÂõûÂØπËØùÁïåÈù¢
    await openMyPhoneConversation(index);
  }

  // Êõ¥Êç¢ËÅîÁ≥ª‰∫∫Â§¥ÂÉè
  async function changeMyPhoneContactAvatar() {
    const avatarChoice = await showChoiceModal('ÈÄâÊã©Â§¥ÂÉèÊñπÂºè', [
      { text: '‰∏ä‰º†Êú¨Âú∞ÂõæÁâá', value: 'upload' },
      { text: 'ËæìÂÖ•ÂõæÁâáURL', value: 'url' }
    ]);

    let newAvatar = null;

    if (avatarChoice === 'upload') {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';

      newAvatar = await new Promise((resolve) => {
        fileInput.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => resolve(event.target.result);
            reader.readAsDataURL(file);
          } else {
            resolve(null);
          }
        };
        fileInput.click();
      });
    } else if (avatarChoice === 'url') {
      const avatarUrl = await showCustomPrompt('ËæìÂÖ•Â§¥ÂÉèURL', 'ËØ∑ËæìÂÖ•ÂõæÁâáURLÂú∞ÂùÄ');
      if (avatarUrl && avatarUrl.trim()) {
        newAvatar = avatarUrl.trim();
      }
    }

    if (newAvatar) {
      const char = state.chats[activeMyPhoneCharacterId];
      const index = window.currentMyPhoneConversationIndex;
      const contact = char.myPhoneSimulatedQQConversations[index];

      contact.avatar = newAvatar;
      document.getElementById('myphone-settings-avatar-img').src = newAvatar;

      await db.chats.put(char);
    }
  }

  // Ê∑ªÂä†ÂØπËØùÊ∂àÊÅØ
  async function addMyPhoneMessage() {
    const role = await showChoiceModal('ÈÄâÊã©ÂèëÈÄÅËÄÖ', [
      { text: 'ÊàëÂèëÈÄÅ', value: 'user' },
      { text: `${document.getElementById('myphone-settings-name').value}ÂèëÈÄÅ`, value: 'assistant' }
    ]);

    if (!role) return;

    // ÈÄâÊã©Ê∂àÊÅØÁ±ªÂûã
    const msgType = await showChoiceModal('ÈÄâÊã©Ê∂àÊÅØÁ±ªÂûã', [
      { text: 'ÊñáÂ≠óÊ∂àÊÅØ', value: 'text' },
      { text: 'ÂõæÁâá', value: 'image' },
      { text: 'ËØ≠Èü≥', value: 'voice' },
      { text: 'ËΩ¨Ë¥¶', value: 'transfer' }
    ]);

    if (!msgType) return;

    const char = state.chats[activeMyPhoneCharacterId];
    const index = window.currentMyPhoneConversationIndex;
    const contact = char.myPhoneSimulatedQQConversations[index];

    if (!contact.messages) {
      contact.messages = [];
    }

    let newMessage = {
      role: role,
      timestamp: new Date().toISOString()
    };

    let lastMsgPreview = '';

    if (msgType === 'text') {
      // ÊñáÂ≠óÊ∂àÊÅØ
      const content = await showCustomPrompt('ËæìÂÖ•Ê∂àÊÅØÂÜÖÂÆπ', 'ËØ∑ËæìÂÖ•Ë¶ÅÊ∑ªÂä†ÁöÑÊ∂àÊÅØ', '', 'textarea');
      if (!content || !content.trim()) return;

      newMessage.content = content.trim();
      lastMsgPreview = content.trim();

    } else if (msgType === 'image') {
      // ÂõæÁâáÊ∂àÊÅØ
      const description = await showCustomPrompt('ÂõæÁâáÊèèËø∞', 'ËØ∑ËæìÂÖ•ÂõæÁâáÁöÑ‰∏≠ÊñáÊèèËø∞');
      if (!description || !description.trim()) return;

      const imagePrompt = await showCustomPrompt('ÂõæÁâáÊèêÁ§∫ËØçÔºàÂèØÈÄâÔºâ', 'ËØ∑ËæìÂÖ•Ëã±ÊñáÂõæÁâáÁîüÊàêÊèêÁ§∫ËØçÔºàÂèØÈÄâÔºåÁïôÁ©∫Âàô‰∏çÁîüÊàêÂõæÁâáÔºâ');

      newMessage.type = 'ai_image';
      newMessage.content = description.trim();
      if (imagePrompt && imagePrompt.trim()) {
        newMessage.image_prompt = imagePrompt.trim();
      }
      lastMsgPreview = '[ÂõæÁâá]';

    } else if (msgType === 'voice') {
      // ËØ≠Èü≥Ê∂àÊÅØ
      const content = await showCustomPrompt('ËØ≠Èü≥ÂÜÖÂÆπ', 'ËØ∑ËæìÂÖ•ËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ', '', 'textarea');
      if (!content || !content.trim()) return;

      newMessage.type = 'voice_message';
      newMessage.content = content.trim();
      lastMsgPreview = '[ËØ≠Èü≥]';

    } else if (msgType === 'transfer') {
      // ËΩ¨Ë¥¶Ê∂àÊÅØ
      const amount = await showCustomPrompt('ËΩ¨Ë¥¶ÈáëÈ¢ù', 'ËØ∑ËæìÂÖ•ËΩ¨Ë¥¶ÈáëÈ¢ùÔºàÊï∞Â≠óÔºâ');
      if (!amount || !amount.trim()) return;

      const note = await showCustomPrompt('ËΩ¨Ë¥¶Â§áÊ≥®', 'ËØ∑ËæìÂÖ•ËΩ¨Ë¥¶Â§áÊ≥®ÔºàÂèØÈÄâÔºâ');

      const senderName = role === 'user' ? (char.settings.myNickname || 'Êàë') : contact.name;
      const receiverName = role === 'user' ? contact.name : (char.settings.myNickname || 'Êàë');

      newMessage.type = 'transfer';
      newMessage.amount = parseFloat(amount.trim()) || 0;
      newMessage.note = note ? note.trim() : 'ËΩ¨Ë¥¶';
      newMessage.senderName = senderName;
      newMessage.receiverName = receiverName;
      newMessage.status = 'accepted';
      newMessage.content = `ËΩ¨Ë¥¶ ¬•${newMessage.amount}`;
      lastMsgPreview = '[ËΩ¨Ë¥¶]';
    }

    contact.messages.push(newMessage);

    // Êõ¥Êñ∞ÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ
    contact.lastMessage = lastMsgPreview.substring(0, 20) + (lastMsgPreview.length > 20 ? '...' : '');

    await db.chats.put(char);

    renderMyPhoneContactMessages(contact);
  }

  // My Phone ËΩ¨Ë¥¶Êìç‰ΩúÁõ∏ÂÖ≥ÂáΩÊï∞
  let activeMyPhoneTransferTimestamp = null;

  function showMyPhoneTransferActionModal(timestamp) {
    activeMyPhoneTransferTimestamp = timestamp;

    const char = state.chats[activeMyPhoneCharacterId];
    const index = window.currentMyPhoneConversationIndex;

    let message;
    if (index === -1) {
      // ‰∏éËßíËâ≤ÁöÑÁúüÂÆûÂØπËØù
      message = char.history.find(m => m.timestamp === timestamp);
    } else {
      // Ê®°ÊãüÂØπËØù
      const contact = char.myPhoneSimulatedQQConversations[index];
      message = contact.messages.find(m => m.timestamp === timestamp);
    }

    if (message) {
      document.getElementById('transfer-sender-name').textContent = message.senderName || 'ÂØπÊñπ';
    }
    document.getElementById('transfer-actions-modal').classList.add('visible');
  }

  async function handleMyPhoneTransferResponse(choice) {
    if (!activeMyPhoneTransferTimestamp) return;

    const timestamp = activeMyPhoneTransferTimestamp;
    const char = state.chats[activeMyPhoneCharacterId];
    const index = window.currentMyPhoneConversationIndex;

    let message, messageArray;

    if (index === -1) {
      // ‰∏éËßíËâ≤ÁöÑÁúüÂÆûÂØπËØù
      messageArray = char.history;
      message = messageArray.find(m => m.timestamp === timestamp);
    } else {
      // Ê®°ÊãüÂØπËØù
      const contact = char.myPhoneSimulatedQQConversations[index];
      messageArray = contact.messages;
      message = messageArray.find(m => m.timestamp === timestamp);
    }

    if (!message) return;

    // Èò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
    if (message.status && message.status !== 'pending') {
      hideTransferActionModal();
      return;
    }

    let transferAmount = parseFloat(message.amount);
    if (isNaN(transferAmount)) {
      transferAmount = 0;
    }

    message.status = choice;

    if (choice === 'declined') {
      // ÊãíÊî∂ÈÄªËæë - Ê∑ªÂä†ÈÄÄÊ¨æÊ∂àÊÅØ
      const refundMessage = {
        role: 'user',
        type: 'transfer',
        isRefund: true,
        amount: transferAmount,
        note: 'Â∑≤ÊãíÊî∂ÂØπÊñπËΩ¨Ë¥¶',
        senderName: char.settings.myNickname || 'Êàë',
        receiverName: message.senderName,
        timestamp: Date.now(),
        status: 'accepted'
      };
      messageArray.push(refundMessage);

      // Â¶ÇÊûúÊòØÁúüÂÆûÂØπËØùÔºåÊ∑ªÂä†ÈöêËóèÁ≥ªÁªüÊ∂àÊÅØ
      if (index === -1) {
        const hiddenMessage = {
          role: 'system',
          content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÊãíÁªùÂπ∂ÈÄÄËøò‰∫Ü"${message.senderName}"ÁöÑËΩ¨Ë¥¶„ÄÇ]`,
          timestamp: Date.now() + 1,
          isHidden: true
        };
        messageArray.push(hiddenMessage);
      }
    } else {
      // Êé•Êî∂ÈÄªËæë
      if (transferAmount > 0 && index === -1) {
        // Âè™ÊúâÁúüÂÆûÂØπËØùÊâçËÆ∞Ë¥¶
        const success = await processTransaction(transferAmount, 'income', `Êî∂Âà∞ËΩ¨Ë¥¶-${message.senderName}`);

        if (success) {
          await showCustomAlert("Êî∂Ê¨æÊàêÂäü", `Â∑≤Â≠òÂÖ•‰ΩôÈ¢ùÔºö+ ¬•${transferAmount.toFixed(2)}`);

          // Ê∑ªÂä†Â∑≤Êî∂Ê¨æÊ∂àÊÅØ
          const receivedMessage = {
            role: 'user',
            type: 'transfer',
            isReceived: true,
            amount: transferAmount,
            note: 'Â∑≤Êî∂Ê¨æ',
            senderName: 'Êàë',
            receiverName: message.senderName,
            timestamp: Date.now(),
            status: 'accepted'
          };
          messageArray.push(receivedMessage);
        } else {
          alert("Ë≠¶ÂëäÔºöÈáëÈ¢ùÂÖ•Ë¥¶Â§±Ë¥•ÔºÅ");
        }
      }

      // Â¶ÇÊûúÊòØÁúüÂÆûÂØπËØùÔºåÊ∑ªÂä†ÈöêËóèÁ≥ªÁªüÊ∂àÊÅØ
      if (index === -1) {
        const hiddenMessage = {
          role: 'system',
          content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Êé•Âèó‰∫Ü"${message.senderName}"ÁöÑËΩ¨Ë¥¶„ÄÇ]`,
          timestamp: Date.now() + 1,
          isHidden: true
        };
        messageArray.push(hiddenMessage);
      }
    }

    // ‰øùÂ≠òÊõ¥Êîπ
    await db.chats.put(char);

    // ÂÖ≥Èó≠ÂºπÁ™óÂπ∂Âà∑Êñ∞ÁïåÈù¢
    hideTransferActionModal();
    activeMyPhoneTransferTimestamp = null;

    // ÈáçÊñ∞ÊâìÂºÄÂØπËØù‰ª•Âà∑Êñ∞ÊòæÁ§∫
    await openMyPhoneConversation(index);
  }


  function applyMyPhoneAppIcons() {
    // ÂÖà‰øùÂ≠òÊâÄÊúâ MyPhone Â∫îÁî®ÂõæÊ†áÁöÑÈªòËÆ§ srcÔºàÂ¶ÇÊûúËøòÊ≤°‰øùÂ≠òÁöÑËØùÔºâ
    const iconElements = document.querySelectorAll('[id^="myphone-icon-img-"]');
    iconElements.forEach(img => {
      if (!img.dataset.defaultSrc) {
        img.dataset.defaultSrc = img.src;
      }
    });

    if (!state.globalSettings.myphoneAppIcons) return;

    for (const iconId in state.globalSettings.myphoneAppIcons) {
      const imgElement = document.getElementById(`myphone-icon-img-${iconId}`);
      if (imgElement) {
        imgElement.src = state.globalSettings.myphoneAppIcons[iconId];
      }
    }
  }

  async function openMyPhoneApp(appName) {
    if (!activeMyPhoneCharacterId) return;
    const char = state.chats[activeMyPhoneCharacterId];

    // ‰∏çÂÜçËá™Âä®ËÆ∞ÂΩïAPP‰ΩøÁî®ÔºåÊîπ‰∏∫Âè™ËÉΩÊâãÂä®Ê∑ªÂä†ÊàñAPIÁîüÊàê

    switch (appName) {
      case 'qq':
        renderMyPhoneSimulatedQQ();
        switchToMyPhoneScreen('myphone-qq-screen');
        break;
      case 'album':
        renderMyPhoneAlbum();
        switchToMyPhoneScreen('myphone-album-screen');
        break;
      case 'browser':
        renderMyPhoneBrowserHistory();
        switchToMyPhoneScreen('myphone-browser-screen');
        break;
      case 'taobao':
        renderMyPhoneTaobao();
        switchToMyPhoneScreen('myphone-taobao-screen');
        break;
      case 'memo':
        renderMyPhoneMemoList();
        switchToMyPhoneScreen('myphone-memo-screen');
        break;
      case 'diary':
        renderMyPhoneDiaryList();
        switchToMyPhoneScreen('myphone-diary-screen');
        break;
      case 'amap':
        renderMyPhoneAmap();
        switchToMyPhoneScreen('myphone-amap-screen');
        break;
      case 'music':
        renderMyPhoneMusicScreen();
        switchToMyPhoneScreen('myphone-music-screen');
        break;
      case 'usage':
        renderMyPhoneAppUsage();
        switchToMyPhoneScreen('myphone-usage-screen');
        break;
    }
  }

  // logMyPhoneAppUsage ÂáΩÊï∞Â∑≤ÁßªÈô§ÔºåMYphone‰∏çÂÜçËá™Âä®ËÆ∞ÂΩïAPP‰ΩøÁî®
  // APP‰ΩøÁî®ËÆ∞ÂΩïÁé∞Âú®Âè™ËÉΩÈÄöËøáÊâãÂä®Ê∑ªÂä†ÊàñAPIÁîüÊàê


  function renderCharacterSelector() {
    const gridEl = document.getElementById('character-grid');
    gridEl.innerHTML = '';


    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (characters.length === 0) {
      gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøòÊ≤°ÊúâÂèØ‰ª•Êü•ÁúãÊâãÊú∫ÁöÑËßíËâ≤Âì¶~</p>';
      return;
    }

    characters.forEach(char => {
      const item = document.createElement('div');
      item.className = 'character-select-item';
      item.innerHTML = `
            <img src="${char.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${char.name}</span>
        `;
      item.addEventListener('click', () => switchToCharacterPhone(char.id));
      gridEl.appendChild(item);
    });
  }



  async function switchToCharacterPhone(characterId) {
    activeCharacterId = characterId;
    console.log(`Â∑≤ÂàáÊç¢Âà∞ËßíËâ≤ ${characterId} ÁöÑÊâãÊú∫`);


    applyCPhoneWallpaper();
    applyCPhoneAppIcons();
    applyMyPhoneWallpaper();
    applyMyPhoneAppIconsGlobal();


    renderCharHomeScreen();
    showScreen('character-phone-screen');

    // ÂàùÂßãÂåñ CPhone ÁøªÈ°µÂäüËÉΩ
    setTimeout(() => {
      setupCPhonePagination();
    }, 100);
  }



  function switchToMyPhone() {
    activeCharacterId = null;
    console.log("Â∑≤ËøîÂõûÊàëÁöÑÊâãÊú∫");
    showScreen('home-screen');
  }


  function renderCharHomeScreen() {
    // Êñ∞Â∏ÉÂ±Ä‰∏çÈúÄË¶ÅÂú®ËøôÈáåÊõ¥Êñ∞Â§ßÊó∂Èíü‰∫Ü
    switchToCharScreen('char-home-screen');
  }

  // ==========================================
  // CPhone Ê∞îÊ≥°ÊñáÂ≠ó‰∏ìÁî®ÁºñËæëÂáΩÊï∞ (‰øÆÂ§çÊó†Ê≥ï‰øÆÊîπÈóÆÈ¢ò)
  // ==========================================
  window.editBubbleText = async function (elementId) {
    const textElement = document.getElementById(elementId);
    if (!textElement) return;

    // Â¶ÇÊûúÂ∑≤ÁªèÊòØ input Ê®°ÂºèÔºåÁõ¥Êé•ËøîÂõûÔºåÈò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
    if (textElement.tagName === 'INPUT') return;

    const currentText = textElement.innerText;
    const parent = textElement.parentElement;

    // ÂàõÂª∫‰∏¥Êó∂ËæìÂÖ•Ê°Ü
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentText;
    input.className = 'bubble-edit-input'; // ‰ΩøÁî®Êàë‰ª¨Âú® CSS ÈáåÂÆö‰πâÁöÑÊ†∑Âºè

    // ÁªßÊâøÂ≠ó‰ΩìÊ†∑Âºè
    const computedStyle = window.getComputedStyle(textElement);
    input.style.fontFamily = computedStyle.fontFamily;
    input.style.fontSize = computedStyle.fontSize;
    input.style.fontWeight = computedStyle.fontWeight;
    input.style.textAlign = computedStyle.textAlign;

    // ‰øùÂ≠òÂáΩÊï∞
    async function saveEdit() {
      const newText = input.value.trim();
      if (newText) {
        textElement.innerText = newText;
        // Â∞ùËØï‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì (Â§çÁî® widgetData)
        if (!state.globalSettings.widgetData) {
          state.globalSettings.widgetData = {};
        }
        state.globalSettings.widgetData[elementId] = newText;
        await db.globalSettings.put(state.globalSettings);
      }
      // ÊõøÊç¢ÂõûÊñáÊú¨Ê†áÁ≠æ
      if (input.parentNode) input.replaceWith(textElement);
    }

    // ÁªëÂÆö‰∫ã‰ª∂ÔºöÂ§±ÂéªÁÑ¶ÁÇπÊàñÂõûËΩ¶Êó∂‰øùÂ≠ò
    input.addEventListener('blur', saveEdit);
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        input.blur();
      }
    });

    // ÊõøÊç¢ DOM
    textElement.replaceWith(input);
    input.focus();
    // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈò≤Ê≠¢Ëß¶ÂèëÂÖ∂‰ªñÁÇπÂáª
    if (window.event) window.event.stopPropagation();
  }
  function switchToCharScreen(screenId) {
    document.querySelectorAll('.char-screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
  }

  window.switchToCharScreen = switchToCharScreen;




  // ËÆ∞ÂΩïËßíËâ≤ÊâãÊú∫Êü•ÁúãË°å‰∏∫ - Âçï‰∏™È°πÁõÆÁâàÊú¨
  async function logSingleItemViewing(characterId, appName, itemData, itemType = '') {
    const char = state.chats[characterId];
    if (!char || char.isGroup) return;

    // Ê£ÄÊü•ËßíËâ≤ÊòØÂê¶ÂºÄÂêØ‰∫Ü"Áü•ÊôìÁ™•Â±è"ÂäüËÉΩ
    if (!char.settings.phoneViewingAwareness) return;

    // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÔºå‰∏çËÆ∞ÂΩï
    if (!itemData) {
      console.log(`[Á™•Â±èËÆ∞ÂΩï] ${char.name}: ${appName} Ê≤°ÊúâÊï∞ÊçÆÔºå‰∏çÂèëÈÄÅÈÄöÁü•`);
      return;
    }

    const now = new Date();
    const timeStr = now.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });

    const appNameMap = {
      'qq': 'QQ',
      'album': 'Áõ∏ÂÜå',
      'browser': 'ÊµèËßàÂô®',
      'taobao': 'Ê∑òÂÆù',
      'memo': 'Â§áÂøòÂΩï',
      'diary': 'Êó•ËÆ∞',
      'amap': 'È´òÂæ∑Âú∞Âõæ',
      'usage': 'APP‰ΩøÁî®ËÆ∞ÂΩï',
      'music': 'ÁΩëÊòì‰∫ëÈü≥‰πê'
    };

    let systemMessage = `[Á≥ªÁªüÈÄöÁü•] ${timeStr}\nÁî®Êà∑ÊâìÂºÄ‰∫Ü‰Ω†ÁöÑÊâãÊú∫ÔºåÂπ∂‰∏îÁÇπÂºÄ‰∫Ü${appNameMap[appName] || appName} APP`;

    // Ê†πÊçÆ‰∏çÂêåÁ±ªÂûãÊûÑÂª∫ËØ¶ÁªÜÂÜÖÂÆπ
    let detailContent = '';

    if (appName === 'diary') {
      const dateStr = itemData.timestamp ? new Date(itemData.timestamp).toLocaleDateString('zh-CN') : '';
      systemMessage += `Êü•Áúã‰∫Ü‰Ω†ÁöÑÊó•ËÆ∞`;
      detailContent = `\n\n„ÄêÊó•ËÆ∞Ê†áÈ¢ò„Äë${itemData.title || 'Êó†Ê†áÈ¢ò'}\n„ÄêÊó•Êúü„Äë${dateStr}\n„ÄêÂÜÖÂÆπ„Äë\n${itemData.content || '(Á©∫ÁôΩ)'}`;
    } else if (appName === 'memo') {
      systemMessage += `Êü•Áúã‰∫Ü‰Ω†ÁöÑÂ§áÂøòÂΩï`;
      detailContent = `\n\n„ÄêÂ§áÂøòÂΩïÊ†áÈ¢ò„Äë${itemData.title || 'Êó†Ê†áÈ¢ò'}\n„ÄêÂÜÖÂÆπ„Äë\n${itemData.content || '(Á©∫ÁôΩ)'}`;
    } else if (appName === 'album') {
      systemMessage += `Êü•Áúã‰∫Ü‰Ω†ÁöÑÁÖßÁâá`;
      detailContent = `\n\n„ÄêÁÖßÁâáÊèèËø∞„Äë\n${itemData.description || itemData.caption || '(ËøôÂº†ÁÖßÁâáÊ≤°ÊúâÊèèËø∞)'}`;
    } else if (appName === 'browser') {
      systemMessage += `Êü•Áúã‰∫Ü‰Ω†ÁöÑÊµèËßàÂéÜÂè≤`;
      detailContent = `\n\n„ÄêÊ†áÈ¢ò„Äë${itemData.title || 'Êó†Ê†áÈ¢ò'}\n„ÄêÁΩëÂùÄ„Äë${itemData.url || ''}\n„ÄêÂÜÖÂÆπ„Äë${itemData.content || '(Êó†ÂÜÖÂÆπ)'}`;
    } else if (appName === 'taobao') {
      systemMessage += `Êü•Áúã‰∫Ü‰Ω†ÁöÑË¥≠Áâ©ËÆ∞ÂΩï`;
      detailContent = `\n\n„ÄêÂïÜÂìÅ„Äë${itemData.name || ''}\n„Äê‰ª∑Ê†º„Äë${itemData.price ? '¬•' + itemData.price : 'Êú™Áü•'}\n„ÄêÊèèËø∞„Äë${itemData.description || ''}`;
    } else if (appName === 'amap') {
      systemMessage += `Êü•Áúã‰∫Ü‰Ω†ÁöÑÂú∞ÂõæË∂≥Ëøπ`;
      detailContent = `\n\n„Äê‰ΩçÁΩÆ„Äë${itemData.location || ''}\n„ÄêÊó∂Èó¥„Äë${itemData.time || ''}\n„ÄêËØ¶ÊÉÖ„Äë${itemData.details || ''}`;
    } else if (appName === 'music') {
      systemMessage += `Êü•Áúã‰∫Ü‰Ω†ÁöÑÈü≥‰πê`;
      detailContent = `\n\n„ÄêÊ≠åÊõ≤„Äë${itemData.title || ''}\n„ÄêËâ∫ÊúØÂÆ∂„Äë${itemData.artist || ''}\n„Äê‰∏ìËæë„Äë${itemData.album || ''}`;
    }

    systemMessage += detailContent;

    // Ê∑ªÂä†‰∏∫ÁÅ∞Ëâ≤Á≥ªÁªüÊ∂àÊÅØÂíåÈöêËóèË∞ÉËØïÂ±Ç
    const viewingLog = {
      role: 'system',
      content: systemMessage,
      timestamp: now.getTime(),
      isHidden: true,
      isGrayNotice: true
    };

    char.history.push(viewingLog);
    await db.chats.put(char);

    console.log(`[Á™•Â±èËÆ∞ÂΩï] ${char.name}: Êü•Áúã‰∫Ü ${appNameMap[appName]} - ${itemData.title || itemData.name || 'ÊüêÈ°πÂÜÖÂÆπ'}`);
  }

  async function openCharApp(appName) {
    if (!activeCharacterId) return;
    const char = state.chats[activeCharacterId];


    await logAppUsage(activeCharacterId, appName);


    switch (appName) {
      case 'qq':
        renderCharSimulatedQQ();
        switchToCharScreen('char-qq-screen');
        break;
      case 'album':
        renderCharAlbum();
        switchToCharScreen('char-album-screen');
        break;
      case 'browser':
        renderCharBrowserHistory();
        switchToCharScreen('char-browser-screen');
        break;
      case 'taobao':
        renderCharTaobao();
        switchToCharScreen('char-taobao-screen');
        break;
      case 'memo':
        renderCharMemoList();
        switchToCharScreen('char-memo-screen');
        break;
      case 'diary':
        renderCharDiaryList();
        switchToCharScreen('char-diary-screen');
        break;
      case 'amap':
        renderCharAmap();
        switchToCharScreen('char-amap-screen');
        break;



      case 'music':
        renderCharMusicScreen();
        switchToCharScreen('char-music-screen');
        break;
      case 'bilibili':
        document.getElementById('char-bilibili-search-input').value = '';

        renderCharBilibiliScreen();
        switchToCharScreen('char-bilibili-screen');
        break;
      case 'reddit':
        // ÈªòËÆ§Âä†ËΩΩÁÉ≠Èó®ÂÜÖÂÆπ
        if (char.simulatedRedditFeed && char.simulatedRedditFeed.length > 0) {
          console.log("Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑ Reddit Êé®ËçêÊµÅ");
          renderRedditList(char.simulatedRedditFeed);
        } else {
          // Âè™ÊúâÂΩìÊ≤°ÊúâÁºìÂ≠òÊó∂ÔºåÊâçÂéªÂä†ËΩΩÁÉ≠Èó®ÂÜÖÂÆπ
          console.log("Êó†ÁºìÂ≠òÔºåÂä†ËΩΩÈªòËÆ§ÁÉ≠Èó®ÂÜÖÂÆπ");
          handleRedditSearch('popular');
        }
        switchToCharScreen('char-reddit-screen');
        break;
      case 'usage':
        renderCharAppUsage();
        switchToCharScreen('char-usage-screen');
        break;
      case 'settings':
        // ËÆæÁΩÆ APP Âç†‰ΩçÔºåÊöÇÊú™ÂÆûÁé∞
        await showCustomAlert("ÊèêÁ§∫", "ËÆæÁΩÆÂäüËÉΩÂç≥Â∞ÜÊé®Âá∫ÔºåÊï¨ËØ∑ÊúüÂæÖÔºÅ");
        break;
    }
  }


  async function renderCharAlbum() {
    const gridEl = document.getElementById('char-album-grid');
    gridEl.innerHTML = '';
    if (!activeCharacterId) return;
    const char = state.chats[activeCharacterId];

    const photos = char.simulatedAlbum || [];

    if (photos.length === 0) {
      gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAÁöÑÁõ∏ÂÜåËøòÊòØÁ©∫ÁöÑÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õÁÖßÁâáÂêßÔºÅ</p>';
      return;
    }

    const fallbackImageUrl = `https://i.postimg.cc/KYr2qRCK/1.jpg`;

    photos.forEach(photo => {
      const item = document.createElement('div');
      item.className = 'char-photo-item';
      item.dataset.description = photo.description;
      gridEl.appendChild(item);

      // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºåÊü•ÁúãÁÖßÁâáËØ¶ÊÉÖ
      item.style.cursor = 'pointer';
      item.addEventListener('click', () => viewPhotoDetail(photo));



      if (state.globalSettings.enableAiDrawing) {

        item.style.backgroundColor = '#e9ecef';
        const containsNonEnglish = /[^\x00-\x7F]/.test(photo.image_prompt);
        const isValidPrompt = photo.image_prompt && photo.image_prompt.trim() && !containsNonEnglish;
        const finalPrompt = isValidPrompt ? photo.image_prompt : 'a beautiful scenery, anime style, cinematic lighting';
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}`;

        const img = new Image();
        img.onload = function () {
          item.style.backgroundImage = `url(${this.src})`;
        };
        img.onerror = function () {
          item.style.backgroundImage = `url(${fallbackImageUrl})`;
        };
        img.src = imageUrl;

      } else {

        item.style.backgroundColor = '#f0f2f5';
        item.style.border = '1px solid #e0e0e0';


        const descriptionEl = document.createElement('p');
        descriptionEl.className = 'char-photo-description';
        descriptionEl.textContent = photo.description || '(ËøôÂº†ÁÖßÁâáÊ≤°ÊúâÊèèËø∞)';


        item.appendChild(descriptionEl);
      }

    });
  }

  // Êü•ÁúãÁÖßÁâáËØ¶ÊÉÖÔºàËÆ∞ÂΩïÁ™•Â±èÔºâ
  async function viewPhotoDetail(photo) {
    if (!activeCharacterId) return;

    // ËÆ∞ÂΩïÁ™•Â±èË°å‰∏∫
    await logSingleItemViewing(activeCharacterId, 'album', photo);

    // ÊòæÁ§∫ÁÖßÁâáËØ¶ÊÉÖ
    const description = photo.description || photo.caption || 'ËøôÂº†ÁÖßÁâáÊ≤°ÊúâÊèèËø∞';
    await showCustomAlert('ÁÖßÁâáËØ¶ÊÉÖ', description);
  }


  function renderCharBrowserHistory() {
    const listEl = document.getElementById('char-browser-history');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    // Â¶ÇÊûúÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÂ∞ùËØïÁîüÊàêÈªòËÆ§ÁöÑÂÅáÊï∞ÊçÆ
    if (!char.simulatedBrowserHistory || char.simulatedBrowserHistory.length === 0) {
      // ËøôÈáå‰øùÁïô‰Ω†ÂéüÊúâÁöÑÁîüÊàêÈÄªËæëÔºåÊàñËÄÖÊòæÁ§∫Á©∫Áä∂ÊÄÅ
      // ‰∏∫‰∫Ü‰øùÊåÅËßÜËßâÁªü‰∏ÄÔºåÂç≥‰ΩøÊòØÈöèÊú∫ÁîüÊàêÁöÑÂÅáÊï∞ÊçÆ‰πüÂ∫îÁî®Êñ∞ÁªìÊûÑ
      const historyKeywords = [char.name, "Áà±Â•Ω", "ÊóÖÊ∏∏", "ÁæéÈ£ü", "Êñ∞Èóª", ...char.settings.aiPersona.split(/Ôºå|„ÄÇ|\s/).slice(0, 5)];
      const historySites = ["Áü•‰πé", "Bilibili", "Â∞èÁ∫¢‰π¶", "ÂæÆÂçö", "Áª¥Âü∫ÁôæÁßë"];

      // ‰∏¥Êó∂ÁîüÊàêÊºîÁ§∫Êï∞ÊçÆ
      const demoHistory = [];
      for (let i = 0; i < 10; i++) {
        const keyword = historyKeywords[Math.floor(Math.random() * historyKeywords.length)];
        const site = historySites[Math.floor(Math.random() * historySites.length)];
        demoHistory.push({
          title: `${keyword} - ${site}`,
          url: `www.${site.toLowerCase()}.com`,
          content: "ÂÜÖÂÆπÂä†ËΩΩ‰∏≠..."
        });
      }
      char.simulatedBrowserHistory = demoHistory;
    }

    const history = char.simulatedBrowserHistory || [];

    if (history.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAÁöÑÊµèËßàÂô®Á©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õËÆ∞ÂΩïÂêßÔºÅ</p>';
      return;
    }

    // ÂÆö‰πâÂú∞ÁêÉÂõæÊ†áÁöÑ SVG
    const globeIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`;

    // ÂÆö‰πâÂè≥ÁÆ≠Â§¥ SVG
    const arrowIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;

    history.forEach((item, index) => {
      const entryEl = document.createElement('div');
      entryEl.className = 'char-browser-item';

      // ÁÆÄÂåñ URL ÊòæÁ§∫ÔºåÂéªÊéâ https://
      let cleanUrl = item.url.replace(/^https?:\/\//, '').replace(/^www\./, '');
      if (cleanUrl.length > 25) cleanUrl = cleanUrl.substring(0, 25) + '...';

      entryEl.innerHTML = `
            <div class="char-browser-icon-box">
                ${globeIcon}
            </div>
            <div class="char-browser-info">
                <div class="title">${item.title}</div>
                <div class="url">${cleanUrl}</div>
            </div>
            <div class="char-browser-arrow">
                ${arrowIcon}
            </div>
        `;

      entryEl.addEventListener('click', () => openCharArticle(index));
      listEl.appendChild(entryEl);
    });
  }



  function renderCharTaobao() {
    const gridEl = document.getElementById('char-product-grid');
    gridEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const purchases = char.simulatedTaobaoHistory?.purchases || [];

    if (purchases.length === 0) {
      gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAÊúÄËøëÂ•ΩÂÉè‰ªÄ‰πàÈÉΩÊ≤°‰π∞Âë¢Ôºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õËÆ∞ÂΩïÂêßÔºÅ</p>';
      return;
    }

    purchases.forEach(item => {
      const itemEl = document.createElement('div');
      itemEl.className = 'char-product-item';
      itemEl.dataset.reason = item.reason;

      let imageOrTextHtml;
      if (state.globalSettings.enableAiDrawing) {
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image_prompt || 'a random product')}`;
        imageOrTextHtml = `<img src="${imageUrl}" class="product-image">`;
      } else {
        imageOrTextHtml = `
                        <div class="char-product-description-overlay">
                            <p class="char-photo-description">${item.reason || '(Êó†Ë¥≠‰π∞ÁêÜÁî±)'}</p>
                        </div>
                    `;
      }


      itemEl.innerHTML = `
                    ${imageOrTextHtml}
                    <div class="product-info">
                        <div class="product-name">${item.itemName}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <div class="product-price">${(item.price || 0).toFixed(2)}</div>
                            <div class="char-product-status">${item.status}</div>
                        </div>
                    </div>
                `;

      gridEl.appendChild(itemEl);
    });
  }

  function switchToCharHomeScreen() {
    switchToCharScreen('char-home-screen');
  }

  // CPhone ÁøªÈ°µÂäüËÉΩ
  let cphoneCurrentPage = 0;
  const cphoneTotalPages = 2;

  function setupCPhonePagination() {
    const pagesContainer = document.getElementById('cphone-pages-container');
    const pages = document.getElementById('cphone-pages');
    const dots = document.querySelectorAll('.cphone-pagination-dot');

    if (!pagesContainer || !pages) return;

    let startX = 0, startY = 0;
    let currentX = 0;
    let isDragging = false;
    let isClick = true;

    const updatePagination = () => {
      pages.style.transform = `translateX(-${cphoneCurrentPage * (100 / cphoneTotalPages)}%)`;
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === cphoneCurrentPage);
      });
    };

    const onDragStart = (e) => {
      isDragging = true;
      isClick = true;
      startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
      pages.style.transition = 'none';
    };

    const onDragMove = (e) => {
      if (!isDragging) return;

      const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
      currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      let diffX = currentX - startX;
      const diffY = currentY - startY;

      if (isClick && (Math.abs(diffX) > 10 || Math.abs(diffY) > 10)) {
        isClick = false;
      }

      if (Math.abs(diffX) > Math.abs(diffY)) {
        if (e.cancelable) e.preventDefault();

        const maxSwipeDistance = pagesContainer.offsetWidth * 0.8;

        if (diffX < 0 && cphoneCurrentPage >= cphoneTotalPages - 1) {
          diffX = Math.max(diffX, -maxSwipeDistance * 0.3);
        } else if (diffX < 0) {
          diffX = Math.max(diffX, -maxSwipeDistance);
        }

        if (diffX > 0 && cphoneCurrentPage <= 0) {
          diffX = Math.min(diffX, maxSwipeDistance * 0.3);
        } else if (diffX > 0) {
          diffX = Math.min(diffX, maxSwipeDistance);
        }

        pages.style.transform = `translateX(calc(-${cphoneCurrentPage * (100 / cphoneTotalPages)}% + ${diffX}px))`;
      }
    };

    const onDragEnd = (e) => {
      if (!isDragging) return;
      isDragging = false;
      pages.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';

      if (isClick) {
        updatePagination();
        return;
      }

      const diffX = currentX - startX;
      const swipeThreshold = pagesContainer.offsetWidth / 3;

      if (Math.abs(diffX) > swipeThreshold) {
        if (diffX > 0 && cphoneCurrentPage > 0) {
          cphoneCurrentPage--;
        } else if (diffX < 0 && cphoneCurrentPage < cphoneTotalPages - 1) {
          cphoneCurrentPage++;
        }
      }
      updatePagination();
    };

    pagesContainer.addEventListener('mousedown', onDragStart);
    pagesContainer.addEventListener('mousemove', onDragMove);
    pagesContainer.addEventListener('mouseup', onDragEnd);
    pagesContainer.addEventListener('mouseleave', onDragEnd);

    pagesContainer.addEventListener('touchstart', onDragStart, { passive: false });
    pagesContainer.addEventListener('touchmove', onDragMove, { passive: false });
    pagesContainer.addEventListener('touchend', onDragEnd);

    // ÁÇπÂáªÊåáÁ§∫Âô®ÂàáÊç¢È°µÈù¢
    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        cphoneCurrentPage = index;
        updatePagination();
      });
    });

    updatePagination();
  }




  function renderCharChatList() {
    const listEl = document.getElementById('char-chat-list');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;


    const relatedChats = Object.values(state.chats).filter(chat => {

      if (chat.id === activeCharacterId) return true;

      if (chat.isGroup && chat.members.some(m => m.id === activeCharacterId)) return true;
      return false;
    });

    relatedChats.forEach(chat => {
      const item = createChatListItem(chat);
      listEl.appendChild(item);
    });
  }


  async function logAppUsage(characterId, appName) {
    const char = state.chats[characterId];
    if (!char) return;
    if (!char.appUsageLog) {
      char.appUsageLog = [];
    }
    char.appUsageLog.push({
      appName: appName,
      timestamp: Date.now()
    });

    if (char.appUsageLog.length > 50) {
      char.appUsageLog.shift();
    }
    await db.chats.put(char);
  }


  function renderCharAppUsage() {
    const listEl = document.getElementById('char-usage-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    const log = (char.appUsageLog || []).slice().reverse();

    if (log.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøòÊ≤°Êúâ‰ªª‰Ωï‰ΩøÁî®ËÆ∞ÂΩï„ÄÇ</p>';
      return;
    }

    const appNameMap = {
      'qq': 'QQ',
      'album': 'Áõ∏ÂÜå',
      'browser': 'ÊµèËßàÂô®',
      'taobao': 'Ê∑òÂÆù',
      'memo': 'Â§áÂøòÂΩï',
      'diary': 'Êó•ËÆ∞',
      'amap': 'È´òÂæ∑Âú∞Âõæ',
      'usage': 'AppËÆ∞ÂΩï'
    };

    log.forEach(entry => {
      const item = document.createElement('div');
      item.className = 'usage-item';
      item.innerHTML = `
            <div class="timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
            <div class="action">ÊâìÂºÄ‰∫Ü <strong>${appNameMap[entry.appName] || entry.appName}</strong></div>
        `;
      listEl.appendChild(item);
    });
  }

  async function sendCharLocationShare(locationName) {
    const userChat = state.chats[activeCharacterId];
    if (!userChat) return;

    const msg = {
      role: 'assistant',
      senderName: userChat.originalName,
      type: 'location_share',
      content: locationName,
      imageUrl: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg',
      timestamp: Date.now()
    };

    userChat.history.push(msg);
    await db.chats.put(userChat);


    if (state.activeChatId === activeCharacterId) {
      appendMessage(msg, userChat);
    }

    await showCustomAlert("ÂàÜ‰∫´ÊàêÂäü", `‚Äú${userChat.name}‚Äù ÁöÑ‰ΩçÁΩÆÂ∑≤ÂèëÈÄÅÂà∞‰Ω†‰ª¨ÁöÑËÅäÂ§©‰∏≠„ÄÇ`);
  }



  async function viewMemo(memoId) {
    const char = state.chats[activeCharacterId];
    if (!char || !char.memos) return;

    const memo = char.memos.find(m => m.id === memoId);
    if (memo) {

      activeMemoForViewing = memo;

      const titleEl = document.getElementById('char-memo-detail-title');
      const contentEl = document.getElementById('char-memo-detail-content');
      const favBtn = document.getElementById('favorite-memo-btn');

      if (titleEl) titleEl.textContent = memo.title;
      if (contentEl) contentEl.value = memo.content;


      const existingFavorite = await db.favorites.where({
        type: 'char_memo',
        'content.id': memoId
      }).first();
      favBtn.classList.toggle('active', !!existingFavorite);

      switchToCharScreen('char-memo-detail-screen');

      // ËÆ∞ÂΩïÁ™•Â±èË°å‰∏∫
      await logSingleItemViewing(activeCharacterId, 'memo', memo);
    }
  }


  function renderCharMemoList() {
    const listEl = document.getElementById('char-memo-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    const memos = (char.memos || []).slice().reverse();

    if (memos.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøòÊ≤°ÊúâÂ§áÂøòÂΩï„ÄÇ</p>';
      return;
    }

    // SVG ÂõæÊ†á: Á±ª‰ººÊñá‰ª∂ÁöÑÂõæÊ†á
    const memoIconSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;
    // SVG ÂõæÊ†á: Âè≥ÁÆ≠Â§¥
    const arrowIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;

    memos.forEach(memo => {
      const item = document.createElement('div');
      // Ê≥®ÊÑèÔºöÁßªÈô§‰∫ÜÊóßÁöÑ 'list-item' Á±ªÔºåÂè™‰øùÁïô 'memo-item' ‰ª•Â∫îÁî®Êñ∞Ê†∑Âºè
      item.className = 'memo-item';

      // Ëé∑ÂèñÂÜÖÂÆπÈ¢ÑËßà (Á¨¨‰∏ÄË°å)
      const previewText = (memo.content || '').split('\n')[0] || 'Êó†ÂÜÖÂÆπ';

      item.innerHTML = `
            <div class="cphone-item-icon-box memo-icon-style">
                ${memoIconSVG}
            </div>
            <div class="cphone-item-info">
                <div class="cphone-item-title">${memo.title}</div>
                <div class="cphone-item-preview">${previewText}</div>
            </div>
            <div class="cphone-item-arrow">
                ${arrowIcon}
            </div>
        `;

      item.addEventListener('click', () => viewMemo(memo.id));
      addLongPressListener(item, () => deleteMemo(memo.id));
      listEl.appendChild(item);
    });
  }


  async function openMemoEditor(memoId = null) {
    editingMemoId = null;


    const newTitle = await showCustomPrompt("Êñ∞Âª∫Â§áÂøòÂΩï", "ËØ∑ËæìÂÖ•Ê†áÈ¢ò");
    if (newTitle === null || !newTitle.trim()) return;

    const newContent = await showCustomPrompt(`Ê†áÈ¢ò: ${newTitle}`, "ËØ∑ËæìÂÖ•Â§áÂøòÂΩïÂÜÖÂÆπ", "", 'textarea');
    if (newContent !== null) {

      await saveMemo({
        title: newTitle.trim(),
        content: newContent
      });
      switchToCharScreen('char-memo-screen');
    }
  }


  async function saveMemo(memoData) {
    const char = state.chats[activeCharacterId];
    if (!char.memos) char.memos = [];


    char.memos.push({
      id: Date.now(),
      title: memoData.title,
      content: memoData.content
    });

    await db.chats.put(char);
    renderCharMemoList();
  }

  async function saveMemo(content) {
    const char = state.chats[activeCharacterId];
    if (!char.memos) char.memos = [];

    if (editingMemoId) {
      const memo = char.memos.find(m => m.id === editingMemoId);
      if (memo) memo.content = content;
    } else {
      char.memos.push({
        id: Date.now(),
        content: content
      });
    }

    await db.chats.put(char);
    renderCharMemoList();
    editingMemoId = null;
  }






  async function handleGenerateSimulatedDiaries() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ËØ∑Ê±Ç‚Äú${chat.name}‚ÄùÁøªÂºÄTAÁöÑÊó•ËÆ∞Êú¨...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    // Ëé∑ÂèñÊâÄÊúâÂ∫îËØ•‰ΩøÁî®ÁöÑ‰∏ñÁïå‰π¶IDÔºàÂåÖÊã¨ÊâãÂä®ÈÄâÊã©ÁöÑÂíåÂÖ®Â±ÄÁöÑÔºâ
    let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
    // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
    state.worldBooks.forEach(wb => {
      if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
        allWorldBookIds.push(wb.id);
      }
    });
    const worldBookContext = allWorldBookIds
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }
    const userPersona = chat.settings.myPersona || '(Êú™ËÆæÁΩÆ)';
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®ÂíåÊïÖ‰∫ã‰ΩúÂÆ∂„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫„Äê5Âà∞8ÁØá„ÄëTAÊúÄËøëÂèØËÉΩ‰ºöÂÜôÁöÑÊó•ËÆ∞„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêÊó∂Èó¥ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**:
    -   ‰ªäÂ§©ÁöÑÊó•ÊúüÊòØ **${new Date().toLocaleDateString('zh-CN')}**„ÄÇ
    -   ‰Ω†ÁîüÊàêÁöÑ„ÄêÊâÄÊúâ„ÄëÊó•ËÆ∞ÁöÑÊ†áÈ¢òÊó•ÊúüÔºå„ÄêÂøÖÈ°ª„ÄëÊòØ‰ªäÂ§©Êàñ‰ªäÂ§©‰ª•ÂâçÁöÑÊó•Êúü„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÁîüÊàê‰ªª‰ΩïÊú™Êù•ÁöÑÊó•ÊúüÔºÅ
2.  **„ÄêÊ≤âÊµ∏ÊÑü„Äë**: ÊØè‰∏ÄÁØáÊó•ËÆ∞ÈÉΩÂøÖÈ°ª‰ΩøÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„ÄëÊù•ÂÜôÔºåÂπ∂‰∏îË¶ÅÂÖÖÊª°ËßíËâ≤ÁöÑ‰∏™‰∫∫ÊÉÖÊÑü„ÄÅÊÄùËÄÉÂíåÁßòÂØÜ„ÄÇÂú®Êó•ËÆ∞‰∏≠ÊèèËø∞Ëá™Â∑±ÁöÑË°å‰∏∫ÊàñÊÉ≥Ê≥ïÊó∂Ôºå„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞‚Äú‰ªñ‚ÄùÊàñ‚ÄúÂ•π‚Äù (TA)„ÄÇ
3.  **„ÄêÈïøÂ∫¶„Äë**: ÊØè‰∏ÄÁØáÊó•ËÆ∞ÁöÑÊ≠£ÊñáÈïøÂ∫¶„ÄêÂøÖÈ°ª‰∏çÂ∞ë‰∫é300Â≠ó„Äë„ÄÇ
4.  **„ÄêÊ†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰ª£Ë°®‰∏ÄÁØáÊó•ËÆ∞ÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "title": "ËøôÁØáÊó•ËÆ∞ÁöÑÊ†áÈ¢òÔºå‰æãÂ¶ÇÔºö9Êúà20Êó• Êô¥",
        "content": "ËøôÈáåÊòØÊó•ËÆ∞ÁöÑËØ¶ÁªÜÊ≠£ÊñáÔºåÂøÖÈ°ªÊîØÊåÅÊç¢Ë°åÁ¨¶\\nÔºåÂπ∂‰∏îÂøÖÈ°ªÂ∑ßÂ¶ôÂú∞‰ΩøÁî®‰∏ãÈù¢ÁöÑ„ÄêÊó•ËÆ∞‰∏ìÂ±ûMarkdownËØ≠Ê≥ï„ÄëÊù•‰∏∞ÂØåÊñáÊú¨Ë°®Áé∞Âäõ„ÄÇ"
      }
    ]
    \`\`\`
5.  **„ÄêÂç†‰ΩçÁ¨¶ÊõøÊç¢ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: Âú®‰Ω†ÁöÑÊó•ËÆ∞ÂÜÖÂÆπ‰∏≠Ôºå„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂá∫Áé∞ "{{user}}" Ëøô‰∏™Âç†‰ΩçÁ¨¶„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî® ‚Äú${userDisplayNameForAI}‚Äù Êù•Êåá‰ª£‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑Ôºâ„ÄÇ
6.  **„ÄêÊó•ËÆ∞‰∏ìÂ±ûMarkdownËØ≠Ê≥ï (ÂøÖÈ°ª‰ΩøÁî®ÔºÅ)„Äë**:
    -   \`**Âä†Á≤óÊñáÂ≠ó**\`: Áî®‰∫éÂº∫Ë∞É„ÄÇ
    -   \`~~ÂàíÊéâÁöÑÊñáÂ≠ó~~\`: Áî®‰∫éË°®Á§∫ÊîπÂèò‰∏ªÊÑèÊàñËá™ÊàëÂê¶ÂÆö„ÄÇ
    -   \`!h{ÈªÑËâ≤È´ò‰∫Æ}\`: Áî®‰∫éÊ†áËÆ∞ÂÖ≥ÈîÆËØçÊàñÈáçË¶Å‰ø°ÊÅØ„ÄÇ
    -   \`!u{Á≤âËâ≤‰∏ãÂàíÁ∫ø}\`: Áî®‰∫éÊ†áÊ≥®‰∫∫Âêç„ÄÅÂú∞ÂêçÊàñÁâπÊÆäÂêçËØç„ÄÇ
    -   \`!e{Á≤âËâ≤Âº∫Ë∞É}\`: Áî®‰∫éË°®ËææÂº∫ÁÉàÁöÑÊÉÖÁª™„ÄÇ
    -   \`!w{ÊâãÂÜô‰Ωì}\`: Áî®‰∫éÂÜô‰∏ãÂºïË®Ä„ÄÅÊ≠åËØçÊàñÁâπÊÆäÁ¨îËÆ∞„ÄÇ
    -   \`!m{Âáå‰π±ÁöÑÊâãÂÜô‰Ωì}\`: Áî®‰∫éË°®ËææÊøÄÂä®„ÄÅÊÖå‰π±ÊàñÊΩ¶ËçâËÆ∞ÂΩïÊó∂ÁöÑÂøÉÊÉÖ„ÄÇ
    -   \`||Ê∂ÇÈªë||\`: Áî®‰∫éÈöêËóèÁßòÂØÜÊàñÊïèÊÑüËØçÊ±á (ÊØèÊ¨°Ê∂ÇÈªë2~5‰∏™Â≠ó)„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ËÆæÂÆö**:${userPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext} 
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÊí∞ÂÜôËøôÁªÑÂÖÖÊª°ÁúüÊÉÖÂÆûÊÑü„ÄÅÂπ∂ÁÜüÁªÉËøêÁî®‰∫ÜMarkdownËØ≠Ê≥ïÁöÑÊó•ËÆ∞„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÊó•ËÆ∞ÂÜÖÂÆπ„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.95,

          })
        });


      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);


      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let simulatedDiaries;
      try {
        simulatedDiaries = JSON.parse(cleanedJsonString);
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


      chat.diary = simulatedDiaries.map(entry => ({
        id: Date.now() + Math.random(),
        title: entry.title,
        content: entry.content,
        timestamp: Date.now()
      }));

      await db.chats.put(chat);
      await renderCharDiaryList();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüÊó•ËÆ∞Â§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊó•ËÆ∞ÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }


  async function handleWriteNewDiaryEntry() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ËØ∑Ê±Ç‚Äú${chat.name}‚ÄùÂÜô‰∏ÄÁØáÊñ∞Êó•ËÆ∞...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || []).map(bookId => state.worldBooks.find(wb => wb.id === bookId)).filter(Boolean).map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`).join('');


    const systemPrompt = `          
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®ÂíåÊïÖ‰∫ã‰ΩúÂÆ∂„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫„Äê1ÁØá„ÄëTA‰ªäÂ§©ÂèØËÉΩ‰ºöÂÜôÁöÑÊó•ËÆ∞„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„Äê„Äê„ÄêÊó∂Èó¥ÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë„Äë„Äë**:
    -   ‰ªäÂ§©ÁöÑÊó•ÊúüÊòØ **${new Date().toLocaleDateString('zh-CN')}**„ÄÇ
    -   ‰Ω†ÁîüÊàêÁöÑÊó•ËÆ∞Ê†áÈ¢òÊó•Êúü„ÄêÂøÖÈ°ª„ÄëÊòØ‰ªäÂ§©Êàñ‰ªäÂ§©‰ª•ÂâçÁöÑÊó•Êúü„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÁîüÊàê‰ªª‰ΩïÊú™Êù•ÁöÑÊó•ÊúüÔºÅ
2.  **„Äê„Äê„ÄêÊ≤âÊµ∏ÊÑüÈìÅÂæã„Äë„Äë„Äë**: Êó•ËÆ∞ÂøÖÈ°ª‰ΩøÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„ÄëÊù•ÂÜôÔºåÂπ∂‰∏îË¶ÅÂÖÖÊª°ËßíËâ≤ÁöÑ‰∏™‰∫∫ÊÉÖÊÑü„ÄÅÊÄùËÄÉÂíåÁßòÂØÜ„ÄÇÂú®Êó•ËÆ∞‰∏≠ÊèèËø∞Ëá™Â∑±ÁöÑË°å‰∏∫ÊàñÊÉ≥Ê≥ïÊó∂Ôºå„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞‚Äú‰ªñ‚ÄùÊàñ‚ÄúÂ•π‚Äù (TA)„ÄÇ
3.  **„Äê„Äê„ÄêÈïøÂ∫¶ÈìÅÂæã„Äë„Äë„Äë**: Êó•ËÆ∞ÁöÑÊ≠£ÊñáÈïøÂ∫¶„ÄêÂøÖÈ°ª‰∏çÂ∞ë‰∫é300Â≠ó„Äë„ÄÇ
4.  **„Äê„Äê„ÄêÊ†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºå‰∏îÊï∞ÁªÑ‰∏≠„ÄêÂè™ÂåÖÂê´‰∏Ä‰∏™„ÄëÂØπË±°ÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "title": "ËøôÁØáÊó•ËÆ∞ÁöÑÊ†áÈ¢òÔºå‰æãÂ¶ÇÔºö9Êúà20Êó• Êô¥",
        "content": "ËøôÈáåÊòØÊó•ËÆ∞ÁöÑËØ¶ÁªÜÊ≠£ÊñáÔºåÂøÖÈ°ªÊîØÊåÅÊç¢Ë°åÁ¨¶\\nÔºåÂπ∂‰∏îÂøÖÈ°ªÂ∑ßÂ¶ôÂú∞‰ΩøÁî®‰∏ãÈù¢ÁöÑ„ÄêÊó•ËÆ∞‰∏ìÂ±ûMarkdownËØ≠Ê≥ï„ÄëÊù•‰∏∞ÂØåÊñáÊú¨Ë°®Áé∞Âäõ„ÄÇ"
      }
    ]
    \`\`\`
5.  **„Äê„Äê„ÄêÊó•ËÆ∞‰∏ìÂ±ûMarkdownËØ≠Ê≥ï (ÂøÖÈ°ª‰ΩøÁî®ÔºÅ)„Äë„Äë„Äë**:
    -   \`**Âä†Á≤óÊñáÂ≠ó**\`: Áî®‰∫éÂº∫Ë∞É„ÄÇ
    -   \`~~ÂàíÊéâÁöÑÊñáÂ≠ó~~\`: Áî®‰∫éË°®Á§∫ÊîπÂèò‰∏ªÊÑèÊàñËá™ÊàëÂê¶ÂÆö„ÄÇ
    -   \`!h{ÈªÑËâ≤È´ò‰∫Æ}\`: Áî®‰∫éÊ†áËÆ∞ÂÖ≥ÈîÆËØçÊàñÈáçË¶Å‰ø°ÊÅØ„ÄÇ
    -   \`!u{Á≤âËâ≤‰∏ãÂàíÁ∫ø}\`: Áî®‰∫éÊ†áÊ≥®‰∫∫Âêç„ÄÅÂú∞ÂêçÊàñÁâπÊÆäÂêçËØç„ÄÇ
    -   \`!e{Á≤âËâ≤Âº∫Ë∞É}\`: Áî®‰∫éË°®ËææÂº∫ÁÉàÁöÑÊÉÖÁª™„ÄÇ
    -   \`!w{ÊâãÂÜô‰Ωì}\`: Áî®‰∫éÂÜô‰∏ãÂºïË®Ä„ÄÅÊ≠åËØçÊàñÁâπÊÆäÁ¨îËÆ∞„ÄÇ
    -   \`!m{Âáå‰π±ÁöÑÊâãÂÜô‰Ωì}\`: Áî®‰∫éË°®ËææÊøÄÂä®„ÄÅÊÖå‰π±ÊàñÊΩ¶ËçâËÆ∞ÂΩïÊó∂ÁöÑÂøÉÊÉÖ„ÄÇ
    -   \`||Ê∂ÇÈªë||\`: Áî®‰∫éÈöêËóèÁßòÂØÜÊàñÊïèÊÑüËØçÊ±á(ÊØèÊ¨°Ê∂ÇÈªë2~5‰∏™Â≠ó)„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÊí∞ÂÜôËøôÁØáÂÖÖÊª°ÁúüÊÉÖÂÆûÊÑü„ÄÅÂπ∂ÁÜüÁªÉËøêÁî®‰∫ÜMarkdownËØ≠Ê≥ïÁöÑÊó•ËÆ∞„ÄÇ`;

    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÂÜô‰∏ÄÁØáÊñ∞Êó•ËÆ∞„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
      const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: model,
          messages: [{
            role: 'system',
            content: systemPrompt
          }, ...messagesForApi],
          temperature: state.globalSettings.apiTemperature || 0.95,
        })
      });
      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);
      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);


      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let newDiaryEntry;
      try {
        newDiaryEntry = JSON.parse(cleanedJsonString)[0];
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


      if (!chat.diary) chat.diary = [];

      chat.diary.push({
        id: Date.now(),
        title: newDiaryEntry.title,
        content: newDiaryEntry.content,
        timestamp: Date.now()
      });

      await db.chats.put(chat);
      await renderCharDiaryList();

    } catch (error) {
      console.error("ÁîüÊàêÊñ∞Êó•ËÆ∞Â§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `ÈîôËØØ: ${error.message}`);
    }
  }

  function renderCharDiaryList() {
    const listEl = document.getElementById('char-diary-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    const diaries = (char.diary || []).slice().reverse();

    if (diaries.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">Êó•ËÆ∞Êú¨ËøòÊòØÁ©∫ÁöÑ„ÄÇ</p>';
      return;
    }

    // SVG ÂõæÊ†á: ‰π¶Êú¨ÂõæÊ†á
    const diaryIconSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`;
    // SVG ÂõæÊ†á: Âè≥ÁÆ≠Â§¥
    const arrowIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;

    diaries.forEach(entry => {
      const item = document.createElement('div');
      // Ê≥®ÊÑèÔºöÁßªÈô§‰∫ÜÊóßÁöÑ 'list-item' Á±ª
      item.className = 'diary-item';

      // Ê†ºÂºèÂåñÊó•Êúü
      const dateStr = new Date(entry.timestamp).toLocaleDateString('zh-CN');

      item.innerHTML = `
             <div class="cphone-item-icon-box diary-icon-style">
                ${diaryIconSVG}
            </div>
            <div class="cphone-item-info">
                <div class="cphone-item-title">${entry.title}</div>
                <div class="cphone-item-preview">${dateStr}</div>
            </div>
            <div class="cphone-item-arrow">
                ${arrowIcon}
            </div>
        `;

      item.addEventListener('click', () => viewDiary(entry.id));
      addLongPressListener(item, () => deleteDiary(entry.id));
      listEl.appendChild(item);
    });
  }



  async function viewDiary(diaryId) {
    const char = state.chats[activeCharacterId];
    if (!char || !char.diary) return;

    const entry = char.diary.find(d => d.id === diaryId);
    if (entry) {

      activeDiaryForViewing = entry;

      const titleEl = document.getElementById('char-diary-detail-title');
      const contentEl = document.getElementById('char-diary-detail-content');
      const favBtn = document.getElementById('favorite-diary-btn');

      titleEl.textContent = entry.title;
      const formattedContent = parseMarkdown(entry.content)
        .split('\n')
        .map(p => `<p>${p || '&nbsp;'}</p>`)
        .join('');
      contentEl.innerHTML = formattedContent;


      const existingFavorite = await db.favorites.where({
        type: 'char_diary',
        'content.id': diaryId
      }).first();
      favBtn.classList.toggle('active', !!existingFavorite);

      switchToCharScreen('char-diary-detail-screen');

      // ËÆ∞ÂΩïÁ™•Â±èË°å‰∏∫
      await logSingleItemViewing(activeCharacterId, 'diary', entry);
    }
  }


  async function toggleDiaryFavorite() {
    if (!activeDiaryForViewing || !activeCharacterId) return;

    const diary = activeDiaryForViewing;
    const char = state.chats[activeCharacterId];
    const favBtn = document.getElementById('favorite-diary-btn');


    const existingFavorite = await db.favorites.where({
      type: 'char_diary',
      'content.id': diary.id
    }).first();

    if (existingFavorite) {

      await db.favorites.delete(existingFavorite.id);
      favBtn.classList.remove('active');
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'Â∑≤ÂèñÊ∂àÊî∂Ëóè„ÄÇ');
    } else {

      const newFavorite = {
        type: 'char_diary',

        content: {
          id: diary.id,
          title: diary.title,
          content: diary.content,
          timestamp: diary.timestamp,
          characterId: activeCharacterId,
          characterName: char.name
        },
        timestamp: Date.now()
      };
      await db.favorites.add(newFavorite);
      favBtn.classList.add('active');
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'Â∑≤ÊàêÂäüÊî∂ËóèÂà∞‚ÄúÊàëÁöÑÊî∂Ëóè‚ÄùÈ°µÈù¢ÔºÅ');
    }
  }



  async function toggleMemoFavorite() {

    if (!activeMemoForViewing || !activeCharacterId) return;

    const memo = activeMemoForViewing;
    const char = state.chats[activeCharacterId];
    const favBtn = document.getElementById('favorite-memo-btn');


    const existingFavorite = await db.favorites.where({
      type: 'char_memo',
      'content.id': memo.id
    }).first();

    if (existingFavorite) {

      await db.favorites.delete(existingFavorite.id);
      favBtn.classList.remove('active');
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'Â∑≤ÂèñÊ∂àÊî∂Ëóè„ÄÇ');
    } else {

      const newFavorite = {
        type: 'char_memo',

        content: {
          id: memo.id,
          title: memo.title,
          content: memo.content,
          timestamp: memo.timestamp,
          characterId: activeCharacterId,
          characterName: char.name
        },
        timestamp: Date.now()
      };
      await db.favorites.add(newFavorite);
      favBtn.classList.add('active');
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'Â∑≤ÊàêÂäüÊî∂ËóèÂà∞‚ÄúÊàëÁöÑÊî∂Ëóè‚ÄùÈ°µÈù¢ÔºÅ');
    }
  }


  async function deleteDiary(diaryId) {
    const confirmed = await showCustomConfirm('Âà†Èô§Êó•ËÆ∞', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÁØáÊó•ËÆ∞ÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      const char = state.chats[activeCharacterId];
      char.diary = char.diary.filter(d => d.id !== diaryId);
      await db.chats.put(char);
      renderCharDiaryList();
    }
  }




  async function renderCharSimulatedQQ() {
    const listEl = document.getElementById('char-chat-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    if (!char) return;


    const userDisplayName = char.settings.myNickname || (state.qzoneSettings.nickname || 'Êàë');
    const lastRealMessage = char.history.filter(m => !m.isHidden).slice(-1)[0] || {
      content: '...'
    };


    let lastMsgContent = '...';
    if (lastRealMessage) {
      if (typeof lastRealMessage.content === 'string') {
        lastMsgContent = lastRealMessage.content;
      } else if (Array.isArray(lastRealMessage.content) && lastRealMessage.content[0]?.type === 'image_url') {
        lastMsgContent = '[ÂõæÁâá]';
      } else if (lastRealMessage.type) {
        const typeMap = {
          'voice_message': '[ËØ≠Èü≥]',
          'transfer': '[ËΩ¨Ë¥¶]',
          'ai_image': '[ÂõæÁâá]'
        };
        lastMsgContent = typeMap[lastRealMessage.type] || `[${lastRealMessage.type}]`;
      }
    }


    const myAvatar = char.settings.myAvatar || defaultAvatar;
    const myFrame = char.settings.myAvatarFrame || '';
    let avatarHtml;
    if (myFrame) {
      avatarHtml = `<div class="avatar-group has-frame" style="width: 45px; height: 45px;"><div class="avatar-with-frame" style="width: 45px; height: 45px;"><img src="${myAvatar}" class="avatar-img" style="border-radius: 50%;"><img src="${myFrame}" class="avatar-frame"></div></div>`;
    } else {
      avatarHtml = `<div class="avatar-group" style="width: 45px; height: 45px;"><img src="${myAvatar}" class="avatar" style="border-radius: 50%; width: 45px; height: 45px;"></div>`;
    }

    const userChatItem = document.createElement('div');
    userChatItem.className = 'chat-list-item';

    userChatItem.dataset.conversationIndex = "-1";
    userChatItem.innerHTML = `
        ${avatarHtml}
        <div class="info">
            <div class="name-line">
                <span class="name">${userDisplayName}</span>
            </div>
            <div class="last-msg">${String(lastMsgContent).substring(0, 20)}...</div>
        </div>
    `;
    listEl.appendChild(userChatItem);


    const allNpcs = await db.npcs.toArray();
    const npcMap = new Map(allNpcs.map(npc => [npc.name, npc]));
    const conversations = char.simulatedConversations || [];

    if (conversations.length === 0 && !userChatItem) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÔºå<br>ÁúãÁúãTAÊúÄËøëÈÉΩÂíåË∞ÅËÅäÂ§©‰∫ÜÂêßÔºÅ</p>';
      return;
    }

    conversations.forEach((convo, index) => {

      if (convo.type === 'private_user') {
        return;
      }


      const item = document.createElement('div');
      item.className = 'chat-list-item';
      item.dataset.conversationIndex = index;

      let lastMessage, avatarHtml, displayName;

      if (convo.type === 'group') {
        displayName = convo.groupName + ` <span class="group-tag">Áæ§</span>`;
        lastMessage = convo.messages.slice(-1)[0] || {
          content: '...'
        };
        const groupAvatarPrompt = `logo, simple, flat design, for a group chat named '${convo.groupName}'`;
        const avatarUrl = state.globalSettings.enableAiDrawing ? `https://image.pollinations.ai/prompt/${encodeURIComponent(groupAvatarPrompt)}` : defaultGroupAvatar;
        avatarHtml = `<div class="avatar-group"><img src="${avatarUrl}" class="avatar" style="border-radius: 50%;"></div>`;

      } else {
        displayName = convo.participant.name;
        lastMessage = convo.messages.slice(-1)[0] || {
          content: '...'
        };
        const npcData = npcMap.get(displayName);
        let avatarUrl = (npcData && npcData.avatar) ? npcData.avatar :
          (state.globalSettings.enableAiDrawing ? `https://image.pollinations.ai/prompt/${encodeURIComponent(convo.participant.avatar_prompt || 'anime person')}` : defaultGroupMemberAvatar);
        avatarHtml = `<div class="avatar-group"><img src="${avatarUrl}" class="avatar" style="border-radius: 50%;"></div>`;
      }

      let lastMsgContent = '...';
      if (lastMessage && lastMessage.content) {
        lastMsgContent = lastMessage.content;
      }

      item.innerHTML = `
            ${avatarHtml}
            <div class="info">
                <div class="name-line">
                    <span class="name">${displayName}</span>
                </div>
                <div class="last-msg">${String(lastMsgContent).substring(0, 20)}...</div>
            </div>
        `;
      listEl.appendChild(item);
    });
  }

  async function handleGenerateSimulatedQQ() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê†πÊçÆ‚Äú${chat.name}‚ÄùÁöÑËÆ∞ÂøÜÂíå‰∫∫ËÆæÔºåÁîüÊàêÂÖ®Êñ∞ÁöÑÁ§æ‰∫§Âä®ÊÄÅ...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const allNpcs = await db.npcs.toArray();
    const associatedNpcs = allNpcs.filter(npc =>
      npc.associatedWith && npc.associatedWith.includes(activeCharacterId)
    );
    let npcContext = "# ‰Ω†ÁöÑÁ§æ‰∫§Âúà (ÁªëÂÆöÁöÑNPC)\n";
    if (associatedNpcs.length > 0) {
      npcContext += "ËøôÊòØ‰Ω†ËÆ§ËØÜÁöÑ„ÄÅÂÖ≥Á≥ªÂØÜÂàáÁöÑNPC„ÄÇÂú®ÁîüÊàêÂØπËØùÊó∂Ôºå‰Ω†Â∫îËØ•„Äê‰ºòÂÖà„Äë‰∏é‰ªñ‰ª¨‰∫íÂä®„ÄÇ\n";
      associatedNpcs.forEach(npc => {
        npcContext += `- **ÂßìÂêç**: ${npc.name}\n  - **‰∫∫ËÆæ**: ${npc.persona}\n`;
      });
    } else {
      npcContext += "Ôºà‰Ω†ÁõÆÂâçÊ≤°ÊúâÁªëÂÆöÁöÑNPC‰ºô‰º¥ÔºåÂèØ‰ª•Ëá™Áî±ÂàõÈÄ†Êñ∞ÁöÑNPC„ÄÇÔºâ\n";
    }

    const userDisplayNameForAI = state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname ? 'Áî®Êà∑' : state.qzoneSettings.nickname;
    const userNicknameInThisChat = chat.settings.myNickname || userDisplayNameForAI;
    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistoryWithUser_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistoryWithUser_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userNicknameInThisChat : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    // Ëé∑ÂèñÊâÄÊúâÂ∫îËØ•‰ΩøÁî®ÁöÑ‰∏ñÁïå‰π¶IDÔºàÂåÖÊã¨ÊâãÂä®ÈÄâÊã©ÁöÑÂíåÂÖ®Â±ÄÁöÑÔºâ
    let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
    // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
    state.worldBooks.forEach(wb => {
      if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
        allWorldBookIds.push(wb.id);
      }
    });
    const worldBookContext = allWorldBookIds
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö (‰Ω†ÂèØ‰ª•Â∞ÜÂÖ∂‰∏≠ËßíËâ≤‰Ωú‰∏∫ËÅäÂ§©ÂØπË±°):\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');
    const characterOriginalName = chat.originalName || chat.name;
    const stickerContext = getGroupStickerContextForPrompt(chat);

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁ§æ‰∫§ÁîüÊ¥ªÊ®°ÊãüÂô®ÔºåÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚Äù„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØËôöÊûÑÂá∫„Äê5Âà∞7ÊÆµ„ÄëTAÊúÄËøëÁöÑQQËÅäÂ§©ËÆ∞ÂΩï„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêNPCÂîØ‰∏ÄÊÄßÈìÅÂæã„Äë**: Âú®‰Ω†Êú¨Ê¨°ÁîüÊàêÁöÑÊâÄÊúâÂØπËØù‰∏≠ÔºàÂåÖÊã¨ÁßÅËÅäÂíåÁæ§ËÅäÔºâÔºåÊØè‰∏Ä‰∏™NPCÁöÑÂêçÂ≠ó„ÄêÂøÖÈ°ªÊòØÁã¨‰∏Ä-Êó†‰∫åÁöÑ„Äë„ÄÇÁªùÂØπÁ¶ÅÊ≠¢Âá∫Áé∞ÈáçÂêçÁöÑNPCÔºåÁ¶ÅÊ≠¢Âá∫Áé∞ÈáçÂ§çÁæ§ËÅä„ÄÇ
2.  **„ÄêNPCÊù•Ê∫ê„Äë**: ‰Ω†Â∫îËØ•‰ºòÂÖà‰ªé‚Äú‰Ω†ÁöÑÁ§æ‰∫§Âúà (ÁªëÂÆöÁöÑNPC)‚ÄùÂíå‚Äú‰∏ñÁïå‰π¶‚Äù‰∏≠ÂØªÊâæËßíËâ≤‰Ωú‰∏∫ËÅäÂ§©ÂØπË±°„ÄÇÂ¶ÇÊûú‰∏çÂ§üÔºå‰Ω†‰πüÂèØ‰ª•Ëá™Áî±ÂàõÈÄ†ÂÖ®Êñ∞ÁöÑNPCÔºåÂØπËØùÂÜÖÂÆπË¶ÅÂ§öÊ†∑ÂåñÔºåÂèçÊò†ËßíËâ≤ÁöÑÁîüÊ¥ª„ÄÇ
3.  **ÂÖ≥ËÅîÊÄß**: ÂØπËØùÂÜÖÂÆπÂ∫îÂ∑ßÂ¶ôÂú∞ÂèçÊò†ËßíËâ≤ÁöÑÈïøÊúüËÆ∞ÂøÜ„ÄÅ‰∏ñÁïåËßÇÔºå‰ª•Âèä‰∏éÁî®Êà∑‰∫íÂä®ÂèØËÉΩÂ∏¶Êù•ÁöÑÂøÉÊÉÖÂèòÂåñ„ÄÇ
4.  **ÁÆÄÊ¥ÅÊÄß**: ÊØèÊÆµÂØπËØùÁöÑÊÄªÈïøÂ∫¶Â∫îÂú®8Âà∞15Âè•‰πãÈó¥„ÄÇ
# Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞„ÄÇ
- Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩ‰ª£Ë°®‰∏ÄÊÆµÂØπËØùÔºå‰∏î„ÄêÂøÖÈ°ª„ÄëÊòØ‰ª•‰∏ã‰∏§ÁßçÊ†ºÂºè‰πã‰∏ÄÔºö



### Ê†ºÂºè AÔºö‰∏éNPCÁöÑÁßÅËÅä
\`\`\`json
{
  "type": "private_npc",
  "participant": {
    "name": "NPCÁöÑÂêçÂ≠ó",
    "avatar_prompt": "(‰ªÖÂΩìNPCÊòØÊñ∞ÂàõÈÄ†Êó∂Êèê‰æõ)‰∏ÄÊÆµÁî®‰∫éÁîüÊàêÂ§¥ÂÉèÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, È£éÊ†º‰∏∫Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"
  },
"messages": [
  {"sender": "${characterOriginalName}", "content": "ÂØπËØùÂÜÖÂÆπ1"},
  {"sender": "NPCÁöÑÂêçÂ≠ó", "content": "ÂØπËØùÂÜÖÂÆπ2"},
  {"sender": "${characterOriginalName}", "type": "sticker", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}
]
}
\`\`\`

### Ê†ºÂºè BÔºöÁæ§ËÅä
\`\`\`json
{
  "type": "group",
  "groupName": "‰∏Ä‰∏™ËôöÊûÑÁöÑÁæ§Âêç",
  "participants": [
    {"name": "NPCÊàêÂëò1", "avatar_prompt": "(‰ªÖÂΩìNPCÊòØÊñ∞ÂàõÈÄ†Êó∂Êèê‰æõ) ÊàêÂëò1Â§¥ÂÉè„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç"},
    {"name": "NPCÊàêÂëò2", "avatar_prompt": "(‰ªÖÂΩìNPCÊòØÊñ∞ÂàõÈÄ†Êó∂Êèê‰æõ) ÊàêÂëò2Â§¥ÂÉè„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç"}
  ],
"messages": [
  {"sender": "${characterOriginalName}", "content": "ÊàëÂú®Áæ§ÈáåËØ¥ÁöÑËØù"},
  {"sender": "NPCÊàêÂëò1", "content": "ÊàêÂëò1ÂõûÂ§çÊàë"},
  {"sender": "NPCÊàêÂëò2", "type": "sticker", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}
]
}
\`\`\`

# ËßíËâ≤‰∏é‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**: ${longTermMemoryContext}
- **‰∏ñÁïåËßÇ**: ${worldBookContext}
- **ÊúÄËøë‰∏éÁî®Êà∑ÁöÑ‰∫íÂä®**: ${recentHistoryWithUser}
${npcContext}
# ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆàÔºÅ)
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
${stickerContext}
Áé∞Âú®ÔºåËØ∑‰∏•Ê†ºÊåâÁÖßÊ†ºÂºèÈìÅÂæãÔºåÁîüÊàêËÅäÂ§©ËÆ∞ÂΩïÁöÑJSONÊï∞ÁªÑ„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàêÊ®°ÊãüËÅäÂ§©ËÆ∞ÂΩï„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let simulatedConversations;
      try {
        simulatedConversations = JSON.parse(cleanedJsonString);
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }

      chat.simulatedConversations = simulatedConversations;
      await db.chats.put(chat);

      await renderCharSimulatedQQ();


      const hiddenMessage = {
        role: 'system',
        content: `[Á≥ªÁªüÊåá‰ª§Ôºö‰Ω†ÂàöÂàöÂú®Ëá™Â∑±ÁöÑÊâãÊú∫‰∏äÊ¥ªÂä®‰∫Ü‰∏ÄÁï™ÔºàÂíåÊúãÂèãËÅäÂ§©„ÄÅÈÄõÁæ§Á≠âÔºâ„ÄÇÁé∞Âú®ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºå‰∏ªÂä®ÁªôÁî®Êà∑Âèë‰∏ÄÊù°Ê∂àÊÅØÔºåÂèØ‰ª•ËÅäËÅä‰Ω†ÂàöÊâçÁúãÂà∞ÊàñËÅäÂà∞ÁöÑË∂£‰∫ãÔºåÊàñËÄÖ‰ªÖ‰ªÖÊòØÈóÆÂÄô‰∏Ä‰∏ã„ÄÇ]`,
        timestamp: Date.now(),
        isHidden: true
      };
      chat.history.push(hiddenMessage);
      await db.chats.put(chat);
      triggerAiResponse();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüËÅäÂ§©Â§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊ®°ÊãüËÅäÂ§©ËÆ∞ÂΩïÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }


  async function handleContinueRealConversationFromCPhone() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;



    try {
      const {
        proxyUrl,
        apiKey,
        model
      } = state.apiConfig;
      if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂØπËØù„ÄÇ');
      }

      const maxMemory = parseInt(chat.settings.maxMemory) || 10;
      const historySlice = chat.history.slice(-maxMemory);
      const filteredHistory = await filterHistoryWithDoNotSendRules(historySlice, activeCharacterId);
      const myNickname = chat.settings.myNickname || 'Êàë';






      const userPersona = chat.settings.myPersona || 'Áî®Êà∑';


      const longTermMemoryContext = `# ÈïøÊúüËÆ∞ÂøÜ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n${chat.longTermMemory && chat.longTermMemory.length > 0
          ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n')
          : '- (ÊöÇÊó†)'
        }`;


      let worldBookContext = '';
      // Ëé∑ÂèñÊâÄÊúâÂ∫îËØ•‰ΩøÁî®ÁöÑ‰∏ñÁïå‰π¶IDÔºàÂåÖÊã¨ÊâãÂä®ÈÄâÊã©ÁöÑÂíåÂÖ®Â±ÄÁöÑÔºâ
      let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
      // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
      state.worldBooks.forEach(wb => {
        if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
          allWorldBookIds.push(wb.id);
        }
      });

      if (allWorldBookIds.length > 0) {
        const linkedContents = allWorldBookIds.map(bookId => {
          const worldBook = state.worldBooks.find(wb => wb.id === bookId);
          if (!worldBook || !Array.isArray(worldBook.content)) return '';
          const formattedEntries = worldBook.content
            .filter(entry => entry.enabled !== false)
            .map(entry => `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n**ÂÜÖÂÆπ:**\n${entry.content}`)
            .join('');
          return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
          worldBookContext = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
        }
      }

      const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
      const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
      const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
      const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
      const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
      const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

      let multiLayeredSummaryContext = '';
      if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
        multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
        if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
        if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
        if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
        if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
        if (summaryToday) multiLayeredSummaryContext += summaryToday;
        if (summary3Days) multiLayeredSummaryContext += summary3Days;
        if (summary7Days) multiLayeredSummaryContext += summary7Days;
      }
      const stickerContext = getStickerContextForPrompt(chat);
      const systemPrompt = `
# ‰Ω†ÁöÑÊ†∏ÂøÉ‰ªªÂä°
‰Ω†Ê≠£Âú®ÊâÆÊºîËßíËâ≤‚Äú${chat.originalName}‚Äù„ÄÇÁî®Êà∑ÂàöÂàöÂú®TAÁöÑÊâãÊú∫ÔºàCPhoneÔºâ‰∏äÁÇπÂáª‰∫Ü‰∏Ä‰∏™ÊåâÈíÆÔºåÂ∏åÊúõ‰Ω†ËÉΩÁªßÁª≠‰Ω†‰ª¨‰πãÂâçÁöÑÂØπËØù„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆ‰∏ä‰∏ãÊñáÔºåÁîüÊàê„Äê3Âà∞5Êù°„ÄëÁ¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑ„ÄÅÁÆÄÁü≠ÁöÑ„ÄÅËøûÁª≠ÁöÑÊñ∞ÂõûÂ§ç„ÄÇ

# ËæìÂá∫Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊØè‰∏™ÂØπË±°‰ª£Ë°®‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ
- Ê†ºÂºè: \`[{"type": "text", "content": "Á¨¨‰∏ÄÂè•ËØù"}, {"type": "text", "content": "Á¨¨‰∫åÂè•ËØù"}, {"type": "sticker", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}]\`
- ‰Ω†ÂèØ‰ª•Ëá™Áî±ÁªÑÂêà‰ΩøÁî® "text", "sticker", "ai_image", "voice_message" Á≠âÂ§öÁßçÊ∂àÊÅØÁ±ªÂûã„ÄÇ
ËØ∑Ê†πÊçÆÂΩìÂâçÊÉÖÊôØÂíå‰Ω†ÁöÑÊÉÖÁª™Ôºå‰ªéÂàóË°®‰∏≠„ÄêÈÄâÊã©‰∏Ä‰∏™ÊúÄÂêàÈÄÇÁöÑ„ÄëË°®ÊÉÖÂê´‰πâÊù•‰ΩøÁî® "sticker" Êåá‰ª§„ÄÇÂ∞ΩÈáèËÆ©‰Ω†ÁöÑË°®ÊÉÖ‰∏∞ÂØåÂ§öÊ†∑ÔºåÈÅøÂÖçÈáçÂ§ç„ÄÇ
# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.aiPersona}
# ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆàÔºÅ)
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
${stickerContext}

# ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ
${userPersona}  

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑÊú¨Âêç**: "${chat.originalName}"
- **Áî®Êà∑ÁöÑÂ§áÊ≥®**: "${myNickname}"
${worldBookContext}
${longTermMemoryContext}
${multiLayeredSummaryContext} 
- **‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØù**:
${historySlice.map(msg => `${msg.role === 'user' ? myNickname : chat.name}: ${String(msg.content)}`).join('\n')}

Áé∞Âú®ÔºåËØ∑ÁªßÁª≠ËøôÂú∫ÂØπËØù„ÄÇ
`;


      const messagesPayload = filteredHistory.map(msg => ({
        role: msg.role,
        content: `${msg.role === 'user' ? myNickname : chat.name}: ${String(msg.content)}`
      }));

      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesPayload],
            temperature: state.globalSettings.apiTemperature || 0.8,
          })
        });

      if (!response.ok) {
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${(await response.json()).error.message}`);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const messagesArray = parseAiResponse(aiResponseContent);

      if (!messagesArray || messagesArray.length === 0) {
        throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπ„ÄÇ");
      }

      let newMessagesCount = 0;
      let messageTimestamp = Date.now();
      for (const msgData of messagesArray) {
        const baseMessage = {
          role: 'assistant',
          senderName: chat.originalName,
          timestamp: messageTimestamp++
        };
        let aiMessage = null;
        switch (msgData.type) {
          case 'text':
            aiMessage = {
              ...baseMessage,
              content: String(msgData.content || msgData.message)
            };
            break;
          case 'sticker':
            if (msgData.meaning) {
              const sticker = findBestStickerMatch(msgData.meaning, state.userStickers);
              if (sticker) {
                aiMessage = {
                  ...baseMessage,
                  type: 'sticker',
                  content: sticker.url,
                  meaning: sticker.name
                };
              } else {
                console.warn(`AI (CPhone) Â∞ùËØï‰ΩøÁî®‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${msgData.meaning}"`);
                aiMessage = null;
              }
            } else {
              console.warn("AI (CPhone) ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ê≤°Êúâ 'meaning' ÁöÑ sticker Êåá‰ª§„ÄÇ", msgData);
              aiMessage = {
                ...baseMessage,
                type: 'sticker',
                content: msgData.url,
                meaning: 'Êú™Áü•Ë°®ÊÉÖ'
              };
            }
            break;
        }
        if (aiMessage) {
          chat.history.push(aiMessage);
          newMessagesCount++;
        }
      }

      if (newMessagesCount > 0) {
        chat.unreadCount = (chat.unreadCount || 0) + newMessagesCount;
      }

      await db.chats.put(chat);
      await renderChatList();

      if (newMessagesCount > 0) {
        showNotification(chat.id, `ÂèëÊù•‰∫Ü ${newMessagesCount} Êù°Êñ∞Ê∂àÊÅØ`);
      }

    } catch (error) {
      console.error("‰ªéCPhoneÊé®ËøõÁúüÂÆûÂØπËØùÂ§±Ë¥•:", error);
      await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', `Êó†Ê≥ïÁîüÊàêÊñ∞ÂõûÂ§ç: ${error.message}`);
    }
  }

  async function loadMoreMirroredMessages() {
    if (isLoadingMoreCphoneMessages || !activeCharacterId) return;
    isLoadingMoreCphoneMessages = true;

    const messagesContainer = document.getElementById('char-conversation-messages');
    const mainChar = state.chats[activeCharacterId];
    if (!mainChar) {
      isLoadingMoreCphoneMessages = false;
      return;
    }

    showLoader(messagesContainer, 'top');
    const oldScrollHeight = messagesContainer.scrollHeight;


    await new Promise(resolve => setTimeout(resolve, 500));

    const totalMessages = mainChar.history.length;
    const renderWindow = state.globalSettings.chatRenderWindow || 50;
    const nextSliceEnd = totalMessages - cphoneRenderedCount;
    const nextSliceStart = Math.max(0, nextSliceEnd - renderWindow);

    const messagesToPrepend = mainChar.history.slice(nextSliceStart, nextSliceEnd);


    hideLoader(messagesContainer);

    if (messagesToPrepend.length === 0) {
      isLoadingMoreCphoneMessages = false;
      return;
    }


    for (const msg of messagesToPrepend.reverse()) {
      const mirroredMsg = {
        ...msg,
        role: msg.role === 'user' ? 'assistant' : 'user'
      };


      const tempChatObjectForRendering = {
        id: 'temp_user_chat_mirror',
        isGroup: false,
        name: mainChar.name,
        settings: {
          ...mainChar.settings,
          myAvatar: mainChar.settings.aiAvatar,
          myAvatarFrame: mainChar.settings.aiAvatarFrame,
          aiAvatar: mainChar.settings.myAvatar,
          aiAvatarFrame: mainChar.settings.myAvatarFrame
        }
      };

      const messageEl = await createMessageElement(mirroredMsg, tempChatObjectForRendering);
      if (messageEl) {
        messagesContainer.prepend(messageEl);
      }
    }

    cphoneRenderedCount += messagesToPrepend.length;


    const newScrollHeight = messagesContainer.scrollHeight;
    messagesContainer.scrollTop = newScrollHeight - oldScrollHeight;

    isLoadingMoreCphoneMessages = false;
  }

  async function loadMoreMyPhoneMessages() {
    if (isLoadingMoreMyPhoneMessages || !activeMyPhoneCharacterId) return;
    isLoadingMoreMyPhoneMessages = true;

    const messagesContainer = document.getElementById('myphone-conversation-messages');
    const char = state.chats[activeMyPhoneCharacterId];
    if (!char) {
      isLoadingMoreMyPhoneMessages = false;
      return;
    }

    // Âè™ÊúâÂú®Êü•ÁúãÁúüÂÆûÂØπËØùÔºàindex === -1ÔºâÊó∂ÊâçÊîØÊåÅÊªöÂä®Âä†ËΩΩ
    if (myphoneActiveConversationIndex !== -1) {
      isLoadingMoreMyPhoneMessages = false;
      return;
    }

    showLoader(messagesContainer, 'top');
    const oldScrollHeight = messagesContainer.scrollHeight;

    await new Promise(resolve => setTimeout(resolve, 500));

    const totalMessages = char.history.filter(m => !m.isHidden).length;
    const renderWindow = state.globalSettings.chatRenderWindow || 50;
    const nextSliceEnd = totalMessages - myphoneRenderedCount;
    const nextSliceStart = Math.max(0, nextSliceEnd - renderWindow);

    const allVisibleMessages = char.history.filter(m => !m.isHidden);
    const messagesToPrepend = allVisibleMessages.slice(nextSliceStart, nextSliceEnd);

    hideLoader(messagesContainer);

    if (messagesToPrepend.length === 0) {
      isLoadingMoreMyPhoneMessages = false;
      return;
    }

    // ÂàõÂª∫‰∏¥Êó∂ËÅäÂ§©ÂØπË±°Áî®‰∫éÊ∏≤ÊüìÔºàËßíËâ≤ËßÜËßíÔºâ
    const tempChatObject = {
      id: 'temp_myphone_user_chat',
      isGroup: false,
      name: state.qzoneSettings.nickname || 'Êàë',
      settings: {
        ...char.settings,
        myAvatar: char.settings.myAvatar || defaultAvatar,
        myAvatarFrame: char.settings.myAvatarFrame || '',
        aiAvatar: char.settings.aiAvatar || defaultAvatar,
        aiAvatarFrame: char.settings.aiAvatarFrame || ''
      }
    };

    for (const msg of messagesToPrepend.reverse()) {
      const messageEl = await createMessageElement(msg, tempChatObject);
      if (messageEl) {
        messagesContainer.prepend(messageEl);
      }
    }

    myphoneRenderedCount += messagesToPrepend.length;

    const newScrollHeight = messagesContainer.scrollHeight;
    messagesContainer.scrollTop = newScrollHeight - oldScrollHeight;

    isLoadingMoreMyPhoneMessages = false;
  }

  async function openCharSimulatedConversation(conversationIndex) {
    const mainChar = state.chats[activeCharacterId];
    if (!mainChar) return;

    cphoneActiveConversationType = (conversationIndex === -1) ? 'private_user' : mainChar.simulatedConversations[conversationIndex]?.type;

    const bodyEl = document.getElementById('char-conversation-messages');
    bodyEl.innerHTML = '';
    bodyEl.dataset.theme = mainChar.settings.theme || 'default';
    const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
    bodyEl.style.backgroundColor = isDarkMode ? '#000000' : '#f0f2f5';

    let tempChatObjectForRendering;
    let messagesToRender = [];
    const allNpcs = await db.npcs.toArray();
    const npcMap = new Map(allNpcs.map(npc => [npc.name, npc]));

    if (conversationIndex === -1) {

      cphoneActiveConversationType = 'private_user';
      const titleEl = document.getElementById('char-conversation-partner-name');

      const inputEl = document.getElementById('char-simulated-input');

      bodyEl.innerHTML = '';
      titleEl.textContent = mainChar.settings.myNickname || (state.qzoneSettings.nickname || 'Êàë');
      inputEl.placeholder = `‰∏é ${mainChar.settings.myNickname || 'Êàë'} ÁöÑÂØπËØù (Âè™ËØª)`;

      cphoneRenderedCount = 0;
      isLoadingMoreCphoneMessages = false;

      const history = mainChar.history;
      const renderWindow = state.globalSettings.chatRenderWindow || 50;
      const initialMessages = history.slice(-renderWindow);

      tempChatObjectForRendering = {
        id: 'temp_user_chat_mirror',
        isGroup: false,
        name: mainChar.name,
        settings: {
          ...mainChar.settings,
          myAvatar: mainChar.settings.aiAvatar,
          myAvatarFrame: mainChar.settings.aiAvatarFrame,
          aiAvatar: mainChar.settings.myAvatar,
          aiAvatarFrame: mainChar.settings.myAvatarFrame
        }
      };

      messagesToRender = initialMessages.map(msg => ({
        ...msg,
        role: msg.role === 'user' ? 'assistant' : 'user'
      }));
      cphoneRenderedCount = initialMessages.length;

    } else {

      const conversation = mainChar.simulatedConversations[conversationIndex];
      if (!conversation) return;
      cphoneActiveConversationType = conversation.type;

      const titleEl = document.getElementById('char-conversation-partner-name');

      const inputEl = document.getElementById('char-simulated-input');

      if (conversation.type === 'group') {
        titleEl.textContent = `${conversation.groupName} (${conversation.participants.length + 1})`;
        inputEl.placeholder = `Âú® ${conversation.groupName} ‰∏≠ËÅäÂ§©`;
        tempChatObjectForRendering = {
          id: 'temp_group_chat',
          isGroup: true,
          name: conversation.groupName,
          originalName: mainChar.originalName,
          members: conversation.participants.map(p => {
            const npcData = npcMap.get(p.name);
            let avatarUrl = (npcData && npcData.avatar) ? npcData.avatar :
              (state.globalSettings.enableAiDrawing ?
                `https://image.pollinations.ai/prompt/${encodeURIComponent(p.avatar_prompt || 'anime person')}` :
                defaultGroupMemberAvatar);
            return {
              originalName: p.name,
              groupNickname: p.name,
              avatar: avatarUrl
            };
          }),
          settings: {
            ...mainChar.settings,
            myNickname: mainChar.name,
            myAvatar: mainChar.settings.aiAvatar,
            myAvatarFrame: mainChar.settings.aiAvatarFrame,
          }
        };
      } else {
        titleEl.textContent = conversation.participant.name;
        inputEl.placeholder = `‰∏é ${conversation.participant.name} ÁöÑÂØπËØù`;
        const npcData = npcMap.get(conversation.participant.name);
        const npcAvatarUrl = (npcData && npcData.avatar) ? npcData.avatar :
          (state.globalSettings.enableAiDrawing ?
            `https://image.pollinations.ai/prompt/${encodeURIComponent(conversation.participant.avatar_prompt || 'anime person')}` :
            defaultGroupMemberAvatar);
        tempChatObjectForRendering = {
          id: 'temp_npc_chat',
          isGroup: false,
          name: conversation.participant.name,
          originalName: mainChar.originalName,
          settings: {
            ...mainChar.settings,
            myAvatar: mainChar.settings.aiAvatar,
            myAvatarFrame: mainChar.settings.aiAvatarFrame,
            aiAvatar: npcAvatarUrl,
            aiAvatarFrame: ''
          }
        };
      }
      messagesToRender = conversation.messages;
    }



    for (const msg of messagesToRender) {
      let role = msg.role;
      if (conversationIndex !== -1) {
        const isFromMainChar = msg.sender === (mainChar.originalName || mainChar.name);
        role = isFromMainChar ? 'user' : 'assistant';
      }

      const tempMessageObject = {
        role: role,
        senderName: msg.sender || (role === 'user' ? tempChatObjectForRendering.settings.myNickname : tempChatObjectForRendering.name),
        timestamp: msg.timestamp || (Date.now() + Math.random())
      };


      if (msg.type === 'sticker' && msg.meaning) {

        const sticker = state.userStickers.find(s => s.name === msg.meaning);
        if (sticker) {
          tempMessageObject.content = sticker.url;
          tempMessageObject.meaning = msg.meaning;
          tempMessageObject.type = 'sticker';
        } else {

          console.warn(`Ê®°ÊãüË°®ÊÉÖÂê´‰πâ "${msg.meaning}" Âú®Â∫ì‰∏≠Êú™ÊâæÂà∞„ÄÇ`);
          tempMessageObject.content = `[Ë°®ÊÉÖ: ${msg.meaning}]`;
          tempMessageObject.type = 'text';
        }
      } else {

        tempMessageObject.content = msg.content;
        tempMessageObject.type = msg.type || 'text';
      }

      const bubbleElement = await createMessageElement(tempMessageObject, tempChatObjectForRendering);
      if (bubbleElement) {
        bodyEl.appendChild(bubbleElement);
      }
    }

    switchToCharScreen('char-qq-conversation-screen');
    setTimeout(() => bodyEl.scrollTop = bodyEl.scrollHeight, 0); // Ê∏≤ÊüìÂÆåÊàêÂêéÊªöÂä®Âà∞Â∫ïÈÉ®
  }

  function closeSimulatedTranscriptModal() {
    document.getElementById('char-qq-transcript-modal').classList.remove('visible');
  }



  async function handleGenerateSimulatedAlbum() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];

    if (!chat) {
      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", "Êó†Ê≥ïÊâæÂà∞ÂΩìÂâçËßíËâ≤ÁöÑÊï∞ÊçÆ„ÄÇ");
      return;
    }

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ËØ∑Ê±Ç‚Äú${chat.name}‚ÄùÂõûÂøÜTAÁöÑÁõ∏ÂÜåÁÖßÁâá...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    // Ëé∑ÂèñÊâÄÊúâÂ∫îËØ•‰ΩøÁî®ÁöÑ‰∏ñÁïå‰π¶IDÔºàÂåÖÊã¨ÊâãÂä®ÈÄâÊã©ÁöÑÂíåÂÖ®Â±ÄÁöÑÔºâ
    let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
    // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
    state.worldBooks.forEach(wb => {
      if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
        allWorldBookIds.push(wb.id);
      }
    });
    const worldBookContext = allWorldBookIds
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåÊûÑÊÄùÂá∫„Äê8Âà∞10Âº†„ÄëTAÊúÄËøëÂèØËÉΩ‰ºöÊãçÊëÑÊàñÁèçËóèÂú®ÊâãÊú∫Áõ∏ÂÜåÈáåÁöÑÁÖßÁâá„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **ÂàõÈÄ†ÊÄß‰∏éÂêàÁêÜÊÄß**: ÁÖßÁâáÂÜÖÂÆπÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•Ω„ÄÅËÅå‰∏öÂíåÁîüÊ¥ªÁéØÂ¢É„ÄÇ
2.  **Â§öÊ†∑ÊÄß**: ÁÖßÁâá‰∏ªÈ¢òË¶Å‰∏∞ÂØåÔºåÂèØ‰ª•ÂåÖÊã¨Ëá™Êãç„ÄÅÈ£éÊôØ„ÄÅÈ£üÁâ©„ÄÅÂÆ†Áâ©„ÄÅÊúãÂèãÂêàÂΩ±„ÄÅÂ∑•‰ΩúÂú∫ÊôØÁ≠â„ÄÇ
3.  **Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰ª£Ë°®‰∏ÄÂº†ÁÖßÁâáÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "description": "ËøôÊòØÁÖßÁâáËÉåÂêéÁöÑÊïÖ‰∫ãÊàñËßíËâ≤ÁöÑÂøÉÊÉÖÊó•ËÆ∞ÔºåÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚ÄùÊù•ÂÜô„ÄÇ",
        "image_prompt": "‰∏ÄÊÆµÁî®‰∫éÁîüÊàêËøôÂº†ÁÖßÁâáÁöÑ„ÄÅËØ¶ÁªÜÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç„ÄÇ"
      }
    ]
    \`\`\`
    - **„Äêimage_prompt ÁªùÂØπÁ¶ÅÊ≠¢„Äë**: ÁªùÂØπÁ¶ÅÊ≠¢ÂåÖÂê´‰ªª‰Ωï‰∏≠ÊñáÂ≠óÁ¨¶„ÄÅÂè•Â≠ê„ÄÅÁâπÊÆäÁ¨¶Âè∑„ÄÅÊàñ‰ªª‰ΩïÂèØËÉΩÊ∂âÂèäÊïèÊÑüÔºàNSFWÔºâ„ÄÅÊö¥Âäõ„ÄÅË°ÄËÖ•„ÄÅÊîøÊ≤ªÁöÑÂÜÖÂÆπÔºÅ‰πüÁ¶ÅÊ≠¢Áúü‰∫∫ÔºÅ
    - **„Äêimage_prompt ÂøÖÈ°ªÊòØ„Äë**: ÂøÖÈ°ªÊòØÁ∫ØËã±ÊñáÁöÑ„ÄÅÁî®ÈÄóÂè∑ÂàÜÈöîÁöÑ„ÄêÂÖ≥ÈîÆËØçÁªÑÂêà„Äë (e.g., "1boy, solo, basketball jersey, in locker room, smiling, selfie")„ÄÇ
    - **„ÄêÁîªÈ£éÊåá‰ª§„Äë**: Âú® prompt ÁöÑÊú´Â∞æÔºåÊÄªÊòØÂä†‰∏äÁîªÈ£éÊåá‰ª§Ôºå‰æãÂ¶ÇÔºö \`best quality, masterpiece, anime style, cinematic lighting\`

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext} 
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÁîüÊàêËøôÁªÑÁÖßÁâáÁöÑÊèèËø∞ÂíåÁªòÁîªÊåá‰ª§„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÁõ∏ÂÜåÂÜÖÂÆπ„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9

          })
        });


      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);


      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let simulatedAlbumData;
      try {
        simulatedAlbumData = JSON.parse(cleanedJsonString);
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


      chat.simulatedAlbum = simulatedAlbumData;
      await db.chats.put(chat);

      await renderCharAlbum();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüÁõ∏ÂÜåÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊ®°ÊãüÁõ∏ÂÜåÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }




  async function renderCharAlbum() {
    const gridEl = document.getElementById('char-album-grid');
    gridEl.innerHTML = '';
    if (!activeCharacterId) return;
    const char = state.chats[activeCharacterId];

    const photos = char.simulatedAlbum || [];

    if (photos.length === 0) {
      gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAÁöÑÁõ∏ÂÜåËøòÊòØÁ©∫ÁöÑÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õÁÖßÁâáÂêßÔºÅ</p>';
      return;
    }

    const fallbackImageUrl = `https://i.postimg.cc/KYr2qRCK/1.jpg`;

    photos.forEach(photo => {
      const item = document.createElement('div');
      item.className = 'char-photo-item';
      item.dataset.description = photo.description;
      gridEl.appendChild(item);







      if (state.globalSettings.enableAiDrawing) {

        item.style.backgroundColor = '#e9ecef';
        const containsNonEnglish = /[^\x00-\x7F]/.test(photo.image_prompt);
        const isValidPrompt = photo.image_prompt && photo.image_prompt.trim() && !containsNonEnglish;
        const finalPrompt = isValidPrompt ? photo.image_prompt : 'a beautiful scenery, anime style, cinematic lighting';
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}`;

        const img = new Image();
        img.onload = function () {
          item.style.backgroundImage = `url(${this.src})`;
        };
        img.onerror = function () {
          item.style.backgroundImage = `url(${fallbackImageUrl})`;
        };
        img.src = imageUrl;

      } else {

        item.style.backgroundColor = '#f0f2f5';
        item.style.border = '1px solid #e0e0e0';

        const descriptionEl = document.createElement('p');
        descriptionEl.className = 'char-photo-description';
        descriptionEl.textContent = photo.description || '(ËøôÂº†ÁÖßÁâáÊ≤°ÊúâÊèèËø∞)';

        item.appendChild(descriptionEl);
      }
    });
  }


  async function handleGenerateBrowserHistory() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê®°Êãü‚Äú${chat.name}‚ÄùÁöÑÁΩë‰∏äÂÜ≤Êµ™Ë∂≥Ëøπ...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂÜÖÂÆπ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistoryWithUser = chat.history.slice(-maxMemory).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }
    const userPersona = chat.settings.myPersona || '(Êú™ËÆæÁΩÆ)';
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫„Äê10Âà∞20Êù°„ÄëTAÊúÄËøëÁöÑÊµèËßàÂô®ÊêúÁ¥¢/ÊµèËßàËÆ∞ÂΩï„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **ÂàõÈÄ†ÊÄß‰∏éÂêàÁêÜÊÄß**: ËÆ∞ÂΩïÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•Ω„ÄÅËÅå‰∏öÂíåÁîüÊ¥ªÁéØÂ¢É„ÄÇ
2.  **Â§öÊ†∑ÊÄß**: ËÆ∞ÂΩïÁ±ªÂûãË¶Å‰∏∞ÂØåÔºåÂèØ‰ª•ÊòØÂ∏ñÂ≠ê„ÄÅÊñáÁ´†„ÄÅÊñ∞Èóª„ÄÅÈóÆÁ≠îÁ≠â„ÄÇ
3.  **„ÄêÊ†ºÂºè (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩ‰ª£Ë°®‰∏ÄÊù°ÊµèËßàËÆ∞ÂΩïÔºåÂπ∂‰∏î„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‰ª•‰∏ãÊ†ºÂºè:
    \`\`\`json
    [
      {
        "type": "text",
        "title": "Á≤æÁÇº‰∏îÂê∏Âºï‰∫∫ÁöÑÊ†áÈ¢ò (‰∏çË∂ÖËøá20Â≠ó)",
        "url": "www.example.com/article/123 (ÁúãËµ∑Êù•ÂÉèÁúüÂÆûÁöÑÁÆÄÊ¥ÅÁΩëÂùÄ)",
        "content": "‰∏ÄÁØá200-400Â≠óÁöÑ„ÄÅÂàÜÊÆµËâØÂ•ΩÁöÑÊñáÁ´†Ê≠£ÊñáÔºå‰ΩøÁî®\\nÊç¢Ë°å„ÄÇ"
      }
    ]
    \`\`\`
    
    **„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë**: ‰Ω†ÁöÑÂõûÂ§ç‰∏≠„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂåÖÂê´ "type": "image" ÁöÑÂØπË±°„ÄÇÊâÄÊúâËÆ∞ÂΩïÈÉΩÂøÖÈ°ªÊòØÊñáÂ≠óÂÜÖÂÆπ„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- ** ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ**:${userPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext} 
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÁîüÊàêËøôÁªÑ„ÄêÁ∫ØÊñáÊú¨„ÄëÁöÑÊµèËßàËÆ∞ÂΩï„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÊµèËßàÂô®ËÆ∞ÂΩï„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9

          })
        });


      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);


      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let simulatedHistory;
      try {
        simulatedHistory = JSON.parse(cleanedJsonString);
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


      chat.simulatedBrowserHistory = simulatedHistory;
      await db.chats.put(chat);

      await renderCharBrowserHistory();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüÊµèËßàÂô®ÂéÜÂè≤Â§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊµèËßàËÆ∞ÂΩïÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }

  function renderCharBrowserHistory() {
    const listEl = document.getElementById('char-browser-history');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const history = char.simulatedBrowserHistory || [];

    if (history.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAÁöÑÊµèËßàÂô®Á©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õËÆ∞ÂΩïÂêßÔºÅ</p>';
      return;
    }

    history.forEach((item, index) => {
      const entryEl = document.createElement('div');
      entryEl.className = 'char-browser-item';
      entryEl.innerHTML = `
            <div class="title">${item.title}</div>
            <div class="url">${item.url}</div>
        `;

      entryEl.addEventListener('click', () => openCharArticle(index));
      listEl.appendChild(entryEl);
    });
  }



  async function openCharArticle(index) {
    const char = state.chats[activeCharacterId];
    const articleData = char.simulatedBrowserHistory[index];
    if (!articleData) return;



    activeArticleForViewing = articleData;


    renderCharArticle(articleData);
    switchToCharScreen('char-browser-article-screen');



    const favBtn = document.getElementById('favorite-article-btn');

    const existingFavorite = await db.favorites.where({
      type: 'char_browser_article',
      'content.url': articleData.url
    }).first();
    favBtn.classList.toggle('active', !!existingFavorite);

  }


  async function toggleBrowserArticleFavorite() {
    if (!activeArticleForViewing || !activeCharacterId) return;

    const article = activeArticleForViewing;
    const char = state.chats[activeCharacterId];
    const favBtn = document.getElementById('favorite-article-btn');


    const existingFavorite = await db.favorites.where({
      type: 'char_browser_article',
      'content.url': article.url
    }).first();

    if (existingFavorite) {

      await db.favorites.delete(existingFavorite.id);
      favBtn.classList.remove('active');
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'Â∑≤ÂèñÊ∂àÊî∂Ëóè„ÄÇ');
    } else {

      const newFavorite = {
        type: 'char_browser_article',

        content: {
          ...article,
          characterId: activeCharacterId,
          characterName: char.name
        },
        timestamp: Date.now()
      };
      await db.favorites.add(newFavorite);
      favBtn.classList.add('active');
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'Â∑≤ÊàêÂäüÊî∂ËóèÂà∞‚ÄúÊàëÁöÑÊî∂Ëóè‚ÄùÈ°µÈù¢ÔºÅ');
    }
  }

  function renderCharArticle(articleData) {
    const titleEl = document.getElementById('char-article-title'); // È°∂ÈÉ®ÂØºËà™Ê†èÁöÑÂ∞èÊ†áÈ¢ò
    const contentEl = document.getElementById('char-article-content'); // ÂÜÖÂÆπÂå∫Âüü

    // ÂØºËà™Ê†èÂè™ÊòæÁ§∫Êù•Ê∫êÊàñÁÆÄÁï•Ê†áÈ¢ò
    let navTitle = "ÁΩëÈ°µÊµèËßà";
    if (articleData.url) {
      // Â∞ùËØï‰ªé URL ÊèêÂèñÂüüÂêç‰Ωú‰∏∫ÂØºËà™Ê†áÈ¢ò
      try {
        const urlObj = new URL(articleData.url.startsWith('http') ? articleData.url : `http://${articleData.url}`);
        navTitle = urlObj.hostname.replace('www.', '');
      } catch (e) {
        navTitle = articleData.title.substring(0, 10) + '...';
      }
    }
    titleEl.textContent = navTitle;

    contentEl.innerHTML = '';

    if (articleData.type === 'image') {
      // ÂõæÁâáÁ±ªÂûãÁöÑÊñáÁ´†
      contentEl.innerHTML = `
            <div class="char-browser-image-description">
                <div style="font-size: 40px; margin-bottom: 20px; opacity: 0.5;">üñºÔ∏è</div>
                ${articleData.title || '(Êó†Ê†áÈ¢òÂõæÁâá)'}
            </div>`;
    } else {
      // ÊñáÊú¨Á±ªÂûãÁöÑÊñáÁ´†
      const largeTitle = `<div class="article-large-title">${articleData.title}</div>`;

      // Â§ÑÁêÜÊ≠£ÊñáÊç¢Ë°åÔºåÂåÖË£πÂú® p Ê†áÁ≠æ‰∏≠
      const paragraphs = (articleData.content || 'ÂÜÖÂÆπÂä†ËΩΩÂ§±Ë¥•...')
        .split('\n')
        .filter(line => line.trim() !== '') // ËøáÊª§Á©∫Ë°å
        .map(line => `<p>${line}</p>`)
        .join('');

      contentEl.innerHTML = `
            ${largeTitle}
            <div class="article-body">
                ${paragraphs}
            </div>
        `;
    }
  }





  async function handleGenerateTaobaoHistory() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê®°Êãü‚Äú${chat.name}‚ÄùÁöÑË¥≠Áâ©‰π†ÊÉØ...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂÜÖÂÆπ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫TAÊúÄËøëÁöÑÊ∑òÂÆùË¥≠Áâ©ËÆ∞ÂΩïÂíåË¥¶Êà∑‰ΩôÈ¢ù„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **‰ΩôÈ¢ùÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆËßíËâ≤ÁöÑ„ÄêÁªèÊµéÁä∂ÂÜµ„ÄëËÆæÂÆö‰∏Ä‰∏™ÂêàÁêÜÁöÑ \`totalBalance\` (ÊÄª‰ΩôÈ¢ù)„ÄÇ‰æãÂ¶ÇÔºåÂØåÊúâÁöÑËßíËâ≤Â∫îËØ•ÊúâÊõ¥È´òÁöÑ‰ΩôÈ¢ùÔºåËÄåÂ≠¶ÁîüÊàñÁªèÊµéÊãÆÊçÆÁöÑËßíËâ≤ÂàôÂ∫îËØ•ÊúâËæÉ‰ΩéÁöÑ‰ΩôÈ¢ù„ÄÇ
2.  **ÂêàÁêÜÊÄß**: Ë¥≠‰π∞ËÆ∞ÂΩïÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•ΩÂíåÁªèÊµéÁä∂ÂÜµ„ÄÇ
3.  **Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™„ÄêÂçï‰∏ÄÁöÑJSONÂØπË±°„Äë„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`{\` ÂºÄÂßãÔºåÂπ∂‰ª• \`}\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞„ÄÇ
    - Ê†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    {
      "totalBalance": 12345.67, // (ËøôÊòØ‰∏Ä‰∏™Á§∫‰æãÊï∞Â≠óÔºå‰Ω†ÂøÖÈ°ªÊ†πÊçÆËßíËâ≤ÁöÑÁªèÊµéÁä∂ÂÜµÁîüÊàê‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÂêàÁêÜÁöÑ‰ΩôÈ¢ùÔºÅ)
      "purchases": [
        {
          "itemName": "‰∏Ä‰∏™ÂÖ∑‰Ωì„ÄÅÁîüÂä®ÁöÑÂïÜÂìÅÂêçÁß∞",
          "price": 128.80,
          "status": "Â∑≤Á≠æÊî∂",
          "reason": "ËøôÊòØËßíËâ≤Ë¥≠‰π∞Ëøô‰ª∂ÂïÜÂìÅÁöÑÂÜÖÂøÉÁã¨ÁôΩÊàñÁêÜÁî±ÔºåÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚ÄùÊù•ÂÜô„ÄÇ",
          "image_prompt": "‰∏ÄÊÆµÁî®‰∫éÁîüÊàêËøôÂº†ÂïÜÂìÅÂõæÁâáÁöÑ„ÄÅËØ¶ÁªÜÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, È£éÊ†º‰∏∫ realistic product photo, high quality, on a clean white background"
        }
      ]
    }
    \`\`\`
    - **purchases**: ‰∏Ä‰∏™ÂåÖÂê´12Âà∞15‰∏™ÂïÜÂìÅÂØπË±°ÁöÑÊï∞ÁªÑ„ÄÇ
    - **status (ËÆ¢ÂçïÁä∂ÊÄÅ)**: Âè™ËÉΩ‰ªé "Â∑≤Á≠æÊî∂", "ÂæÖÂèëË¥ß", "ËøêËæì‰∏≠", "ÂæÖËØÑ‰ª∑" ‰∏≠ÈÄâÊã©„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext} 
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÁîüÊàêÂåÖÂê´ÊÄª‰ΩôÈ¢ùÂíåË¥≠‰π∞ËÆ∞ÂΩïÁöÑJSONÂØπË±°„ÄÇ`;

    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÊ∑òÂÆùË¥≠‰π∞ËÆ∞ÂΩïÂíå‰ΩôÈ¢ù„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      const jsonMatch = aiResponseContent.match(/({[\s\S]*})/);
      if (!jsonMatch) throw new Error("AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÂØπË±°„ÄÇ");
      const simulatedTaobaoData = JSON.parse(jsonMatch[0]);


      if (!simulatedTaobaoData.purchases) {
        simulatedTaobaoData.purchases = [];
      }

      chat.simulatedTaobaoHistory = simulatedTaobaoData;
      await db.chats.put(chat);

      await renderCharTaobao();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüÊ∑òÂÆùËÆ∞ÂΩïÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêË¥≠Áâ©ËÆ∞ÂΩïÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }



  function openCharWallet() {
    renderCharWallet();
    switchToCharScreen('char-wallet-screen');
  }


  async function renderCharWallet() {
    const contentEl = document.getElementById('char-wallet-content');
    contentEl.innerHTML = '';

    // Ëé∑ÂèñÂΩìÂâçËßíËâ≤‰ø°ÊÅØ
    const char = state.chats[activeCharacterId];
    const history = char.simulatedTaobaoHistory || {};
    const purchases = history.purchases || [];
    const totalBalance = history.totalBalance || 0;

    // 1. ÊòæÁ§∫Ë¥¶Êà∑‰ΩôÈ¢ùÂç°Áâá
    const summaryCard = document.createElement('div');
    summaryCard.style.cssText = `
        background-color: #fff;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    `;
    summaryCard.innerHTML = `
        <p style="color: #8a8a8a; margin: 0 0 10px 0;">Ë¥¶Êà∑‰ΩôÈ¢ù</p>
        <p style="font-size: 32px; font-weight: 600; color: #1f1f1f; margin: 0;">¬•${totalBalance.toFixed(2)}</p>
    `;
    contentEl.appendChild(summaryCard);

    // 2. ÊòæÁ§∫‰∫≤Â±ûÂç° (‰øÆÂ§çÂêçÂ≠ó + Â¢ûÂä†Ëß£Áªë)
    try {
      const myWallet = await db.userWallet.get('main');
      const kinshipCard = myWallet?.kinshipCards?.find(c => c.chatId === activeCharacterId);

      if (kinshipCard) {
        // „Äê‰øÆÂ§çÂêçÂ≠óÈÄªËæë„Äë‰ºòÂÖà‰ΩøÁî®ËÅäÂ§©ËÆæÁΩÆÈáåÁöÑÊòµÁß∞ÔºåÂÖ∂Ê¨°ÊòØÂä®ÊÄÅÊòµÁß∞ÔºåÊúÄÂêéÊòØ‚ÄúÊàë‚Äù
        const myNicknameInChat = char.settings.myNickname || state.qzoneSettings.nickname || 'Êàë';

        const cardDiv = document.createElement('div');
        // Ê†∑ÂºèÔºöÁ∫¢Ëâ≤ËÉåÊôØÂç°ÁâáÔºåÂ¢ûÂä† relative ÂÆö‰Ωç‰ª•‰æøÊîæÁΩÆËß£ÁªëÊåâÈíÆ
        cardDiv.style.cssText = `
                background: linear-gradient(135deg, #ff5252, #ff1744); 
                color: white; 
                padding: 15px; 
                border-radius: 12px; 
                margin-bottom: 20px; 
                box-shadow: 0 4px 10px rgba(255,82,82,0.3); 
                display: flex; 
                flex-direction: column; 
                gap: 5px;
                position: relative; 
            `;

        const remaining = kinshipCard.limit - (kinshipCard.spent || 0);

        cardDiv.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:14px; opacity:0.9; font-weight:500;">${myNicknameInChat} Ëµ†ÈÄÅÁöÑ‰∫≤Â±ûÂç°</div>
                    <div style="font-size:12px; opacity:0.8;">ÊîØ‰ªòÂÆù</div>
                </div>
                <div style="font-size:28px; font-weight:bold; margin:10px 0; font-family: 'DIN Alternate', sans-serif;">¬• ${remaining.toFixed(2)}</div>
                <div style="font-size:12px; opacity:0.8; display:flex; justify-content:space-between;">
                    <span>Êú¨ÊúàÂèØÁî®È¢ùÂ∫¶</span>
                    <span>ÊÄªÈ¢ù ¬•${kinshipCard.limit}</span>
                </div>
                
                <!-- Ëß£ÁªëÊåâÈíÆ -->
                <button class="unbind-kinship-btn" data-chat-id="${activeCharacterId}" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.4);
                    color: white;
                    font-size: 11px;
                    padding: 2px 8px;
                    border-radius: 10px;
                    cursor: pointer;
                    backdrop-filter: blur(2px);
                ">Ëß£Áªë</button>
            `;
        contentEl.appendChild(cardDiv);
      }
    } catch (e) {
      console.error("Ê∏≤Êüì‰∫≤Â±ûÂç°Â§±Ë¥•:", e);
    }

    // 3. ÊòæÁ§∫ÊúÄËøëÊîØÂá∫
    const detailsTitle = document.createElement('h3');
    detailsTitle.textContent = 'ÊúÄËøëÊîØÂá∫';
    detailsTitle.style.cssText = `font-size: 16px; color: #555; margin-bottom: 10px;`;
    contentEl.appendChild(detailsTitle);

    if (purchases.length === 0) {
      contentEl.innerHTML += '<p style="text-align:center; color: var(--text-secondary);">ÊöÇÊó†ÊîØÂá∫ËÆ∞ÂΩï„ÄÇ</p>';
    } else {
      purchases.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 0;
                border-bottom: 1px solid #f0f0f0;
            `;
        itemEl.innerHTML = `
                <div>
                    <p style="font-weight: 500; margin: 0 0 4px 0;">${item.itemName}</p>
                    <p style="font-size: 12px; color: #8a8a8a; margin: 0;">${item.status}</p>
                </div>
                <div style="font-weight: 600; font-size: 16px; color: #ff5722;">- ¬•${(item.price || 0).toFixed(2)}</div>
            `;
        contentEl.appendChild(itemEl);
      });
    }
  }





  async function handleGenerateSimulatedMemos() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ËØ∑Ê±Ç‚Äú${chat.name}‚ÄùÂàÜ‰∫´TAÁöÑÂ§áÂøòÂΩï...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }
    const userPersona = chat.settings.myPersona || '(Êú™ËÆæÁΩÆ)';
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫„Äê12Âà∞20Êù°„ÄëTAÊúÄËøëÂèØËÉΩ‰ºöÂÜôÂú®ÊâãÊú∫Â§áÂøòÂΩïÈáåÁöÑÂÜÖÂÆπ„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **ÂàõÈÄ†ÊÄß‰∏éÂêàÁêÜÊÄß**: Â§áÂøòÂΩïÂÜÖÂÆπÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•Ω„ÄÅËÅå‰∏öÂíåÁîüÊ¥ªÁéØÂ¢É„ÄÇÂèØ‰ª•ÊòØË¥≠Áâ©Ê∏ÖÂçï„ÄÅÂæÖÂäû‰∫ãÈ°π„ÄÅÁÅµÊÑüÁâáÊÆµ„ÄÅ‰∏Ä‰∫õÈöèÁ¨îÂíåÊÑüÊÇü„ÄÅËçâÁ®øÁ≠â„ÄÇ
2.  **Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰ª£Ë°®‰∏ÄÊù°Â§áÂøòÂΩïÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "title": "Â§áÂøòÂΩïÁöÑÊ†áÈ¢òÔºå‰æãÂ¶ÇÔºöË¥≠Áâ©Ê∏ÖÂçï Êàñ Âë®Êú´ËÆ°Âàí",
        "content": "Â§áÂøòÂΩïÁöÑËØ¶ÁªÜÂÜÖÂÆπÔºåÂøÖÈ°ªÊîØÊåÅÊç¢Ë°åÁ¨¶\\n„ÄÇ"
      }
    ]
    \`\`\`

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- ** ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ**:${userPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext}
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÁîüÊàêËøôÁªÑÂ§áÂøòÂΩï„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÂ§áÂøòÂΩïÂÜÖÂÆπ„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9

          })
        });


      if (!response.ok) {
        const errorData = await response.json().catch(() => null);
        const errorMessage = errorData?.error?.message || response.statusText;
        throw new Error(`API ÈîôËØØ: ${response.status} - ${errorMessage}`);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);


      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let simulatedMemos;
      try {
        simulatedMemos = JSON.parse(cleanedJsonString);
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


      if (!Array.isArray(simulatedMemos)) {
        throw new Error(`AIËøîÂõûÁöÑÊï∞ÊçÆ‰∏çÊòØ‰∏Ä‰∏™Êï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${JSON.stringify(simulatedMemos)}`);
      }

      chat.memos = simulatedMemos.map(memo => ({
        id: Date.now() + Math.random(),
        title: memo.title,
        content: memo.content
      }));

      await db.chats.put(chat);
      await renderCharMemoList();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüÂ§áÂøòÂΩïÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÂ§áÂøòÂΩïÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }


  async function handleGenerateAmapHistory() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÁîüÊàê‚Äú${chat.name}‚ÄùÁöÑÂá∫Ë°åË∂≥Ëøπ...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂÜÖÂÆπ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;
    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');
    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫„Äê12Âà∞20Êù°„ÄëTAÊúÄËøëÁöÑ‚ÄúÈ´òÂæ∑Âú∞Âõæ‚ÄùÂá∫Ë°åË∂≥Ëøπ„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêÊó∂Èó¥ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**:
    -   ‰ªäÂ§©ÁöÑÊó•ÊúüÊòØ **${new Date().toISOString()}**„ÄÇ
    -   ‰Ω†ÁîüÊàêÁöÑ„ÄêÊâÄÊúâ„ÄëË∂≥ËøπÁöÑ \`timestamp\` Â≠óÊÆµÔºå„ÄêÂøÖÈ°ª„ÄëÊòØ‰ªäÂ§©Êàñ‰ªäÂ§©‰ª•ÂâçÁöÑÊó•Êúü„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÁîüÊàê‰ªª‰ΩïÊú™Êù•ÁöÑÊó•ÊúüÔºÅ
    -   ËØ∑ÁîüÊàê‰∏Ä‰∏™ÁúãËµ∑Êù•ÂÉèÊòØËøáÂéªÂá†Âë®ÂÜÖÁöÑ„ÄÅÊó∂Èó¥„Äê‰ªéÊñ∞Âà∞Êóß„ÄëÊéíÂàóÁöÑË∂≥ËøπÂàóË°®„ÄÇ
2.  **ÂàõÈÄ†ÊÄß‰∏éÂêàÁêÜÊÄß**: Ë∂≥ËøπÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•Ω„ÄÅËÅå‰∏öÂíåÁîüÊ¥ªÁéØÂ¢É„ÄÇ
3.  **Â§öÊ†∑ÊÄß**: Âú∞ÁÇπÁ±ªÂûãË¶Å‰∏∞ÂØåÔºåÂèØ‰ª•ÂåÖÊã¨È§êÂéÖ„ÄÅÂïÜÂú∫„ÄÅÂÖ¨Âõ≠„ÄÅÂÖ¨Âè∏„ÄÅÊúãÂèãÂÆ∂Á≠â„ÄÇ
4.  **„ÄêÊ†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰ª£Ë°®‰∏ÄÊù°Ë∂≥ËøπÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "locationName": "‰∏Ä‰∏™ÂÖ∑‰Ωì„ÄÅÁîüÂä®ÁöÑÂú∞ÁÇπÂêçÁß∞",
        "address": "‰∏Ä‰∏™ËôöÊûÑ‰ΩÜÁúãËµ∑Êù•ÂæàÁúüÂÆûÁöÑËØ¶ÁªÜÂú∞ÂùÄ",
        "comment": "ËøôÊòØËßíËâ≤ÂØπËøôÊ¨°Âá∫Ë°åÊàñËøô‰∏™Âú∞ÁÇπÁöÑÂÜÖÂøÉÁã¨ÁôΩÊàñËØÑËÆ∫ÔºåÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚ÄùÊù•ÂÜô„ÄÇ",
        "image_prompt": "(ÂèØÈÄâ)‰∏ÄÊÆµÁî®‰∫éÁîüÊàêËøôÂº†Âú∞ÁÇπÁÖßÁâáÁöÑ„ÄÅËØ¶ÁªÜÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, È£éÊ†º‰∏∫ realistic photo, high quality",
        "timestamp": "Á¨¶Âêà ISO 8601 Ê†ºÂºèÁöÑÊó•ÊúüÊó∂Èó¥Â≠óÁ¨¶‰∏≤ (‰æãÂ¶Ç: '2025-09-25T18:30:00Z')"
      }
    ]
    \`\`\`
    - **ÈáçË¶Å**: Â§ßÁ∫¶Êúâ„Äê‰∏âÂàÜ‰πã‰∏Ä„ÄëÁöÑË∂≥ËøπÈúÄË¶ÅÂåÖÂê´ \`image_prompt\` Â≠óÊÆµÊù•ÁîüÊàê‰∏ÄÂº†ÁÖßÁâá„ÄÇ
    - **ÂõæÁâá**: image_prompt ÁîüÊàêÁöÑÂõæÁâá„ÄêÁªùÂØπÁ¶ÅÊ≠¢ÂåÖÂê´Áúü‰∫∫„Äë„ÄÇÂ¶ÇÊûúÂú∞ÁÇπÊòØÂÆ§ÂÜÖÔºåÂèØ‰ª•ÁîüÊàêÁ©∫Êó†‰∏Ä‰∫∫ÁöÑÂú∫ÊôØÔºõÂ¶ÇÊûúÊòØÂÆ§Â§ñÔºåÂèØ‰ª•Âè™ÊúâÈ£éÊôØÊàñÂª∫Á≠ë„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext}
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÁîüÊàêËøôÁªÑË∂≥ËøπËÆ∞ÂΩï„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÈ´òÂæ∑Âú∞ÂõæË∂≥Ëøπ„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9

          })
        });


      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);


      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let simulatedAmapData;
      try {
        simulatedAmapData = JSON.parse(cleanedJsonString);
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


      chat.simulatedAmapHistory = simulatedAmapData;
      await db.chats.put(chat);

      await renderCharAmap();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüË∂≥ËøπÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêË∂≥ËøπÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }


  function renderCharAmap() {
    const listEl = document.getElementById('char-amap-list');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const history = char.simulatedAmapHistory || [];

    if (history.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°ÊúâÁïô‰∏ã‰ªª‰ΩïË∂≥ËøπÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õËÆ∞ÂΩïÂêßÔºÅ</p>';
      return;
    }


    history.forEach(item => {
      const itemEl = document.createElement('div');
      itemEl.className = 'char-amap-item';

      let photoHtml = '';
      if (item.image_prompt) {
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image_prompt)}`;
        photoHtml = `<div class="amap-item-photo" style="background-image: url('${imageUrl}')" data-comment="${item.comment}"></div>`;
      }

      // ‰ΩøÁî®Êàë‰ª¨‰πãÂâçÂàõÂª∫ÁöÑ formatTimeAgo ÂáΩÊï∞Êù•Ê†ºÂºèÂåñÊó∂Èó¥
      const timeAgo = item.timestamp ? formatTimeAgo(new Date(item.timestamp).getTime()) : 'Êüê‰∏™Êó∂Èó¥';

      itemEl.innerHTML = `
                    <div class="amap-item-header">
                        <div class="amap-item-icon">üìç</div>
                        <div class="amap-item-info">
                            <div class="amap-item-title">${item.locationName}</div>
                            <div class="amap-item-address">${item.address}</div>
                        </div>
                    </div>
                    <div class="amap-item-body">
                        <div class="amap-item-comment">${item.comment.replace(/\n/g, '<br>')}</div>
                        ${photoHtml}
                    </div>
                    <div class="amap-item-footer">${timeAgo}</div>
                `;
      listEl.appendChild(itemEl);
    });

  }



  async function handleGenerateAppUsage() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÂàÜÊûê‚Äú${chat.name}‚ÄùÁöÑÊâãÊú∫‰ΩøÁî®‰π†ÊÉØ...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂÜÖÂÆπ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');
    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫TAÊúÄËøë‰∏ÄÂ§©ÁöÑ„ÄêÊâãÊú∫AppÂ±èÂπï‰ΩøÁî®Êó∂Èó¥„ÄëËÆ∞ÂΩïÔºåÊÄªÂÖ±Á∫¶20Êù°„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **ÂàõÈÄ†ÊÄß‰∏éÂ§öÊ†∑ÊÄß**: ÁîüÊàêÁöÑAppÂàóË°®„Äê‰∏çÂøÖÂ±ÄÈôê‰∫é„ÄëCphone‰∏ªÂ±èÂπï‰∏äÂ∑≤ÊúâÁöÑApp„ÄÇ‰Ω†ÂèØ‰ª•Ëá™Áî±Âú∞ËôöÊûÑTAÂèØËÉΩ‰ΩøÁî®ÁöÑÂÖ∂‰ªñAppÔºå‰æãÂ¶Ç Instagram, Twitter, ÂêÑÁßçÊ∏∏Êàè (Â¶ÇÔºöÂéüÁ•û, ÁéãËÄÖËç£ËÄÄ), ËßÜÈ¢ëApp (Â¶ÇÔºöÊäñÈü≥, YouTube), Â≠¶‰π†ÊàñÂ∑•‰ΩúËΩØ‰ª∂Á≠âÔºåËøôËÉΩÊõ¥Â•ΩÂú∞‰ΩìÁé∞ËßíËâ≤ÁöÑÈöêËóèÂÖ¥Ë∂£ÂíåÁîüÊ¥ª‰π†ÊÉØ„ÄÇ
2.  **ÂêàÁêÜÊÄß**: ‰ΩøÁî®Êó∂ÈïøÂíåAppÁ±ªÂûãÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•Ω„ÄÅËÅå‰∏öÂíåÁîüÊ¥ªÁéØÂ¢É„ÄÇ
3.  **Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰ª£Ë°®‰∏Ä‰∏™AppÁöÑ‰ΩøÁî®ËÆ∞ÂΩïÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "appName": "AppÁöÑÂêçÁß∞ (‰æãÂ¶Ç: ÂæÆ‰ø°, ÂæÆÂçö, ÂéüÁ•û)",
        "usageTimeMinutes": 125,
        "category": "AppÁöÑÂàÜÁ±ª (‰æãÂ¶Ç: Á§æ‰∫§, Ê∏∏Êàè, ÂΩ±Èü≥, Â∑•ÂÖ∑, ÈòÖËØª, Ë¥≠Áâ©)",
        "image_prompt": "‰∏ÄÊÆµÁî®‰∫éÁîüÊàêËøô‰∏™App„ÄêÂõæÊ†á„ÄëÁöÑ„ÄÅÁÆÄÊ¥ÅÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç„ÄÇÈ£éÊ†ºÂøÖÈ°ªÊòØ modern app icon, flat design, simple, clean background"
      }
    ]
    \`\`\`

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext}
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÁîüÊàêËøôÁªÑApp‰ΩøÁî®ËÆ∞ÂΩï„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑApp‰ΩøÁî®ËÆ∞ÂΩï„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9
            // response_format: { "type": "json_object" } <-- Ê≠§Ë°åÂ∑≤Ë¢´Âà†Èô§
          })
        });


      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');

      const simulatedUsageData = JSON.parse(cleanedJson);

      chat.simulatedAppUsage = simulatedUsageData;
      await db.chats.put(chat);

      await renderCharAppUsage();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüApp‰ΩøÁî®ËÆ∞ÂΩïÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêËÆ∞ÂΩïÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }

  function renderCharAppUsage() {
    const listEl = document.getElementById('char-usage-list');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const usageData = (char.simulatedAppUsage || []).sort((a, b) => b.usageTimeMinutes - a.usageTimeMinutes);

    if (usageData.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°Êúâ‰ªª‰Ωï‰ΩøÁî®ËÆ∞ÂΩïÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õÂêßÔºÅ</p>';
      return;
    }

    usageData.forEach(item => {
      const itemEl = document.createElement('div');
      itemEl.className = 'char-usage-item';

      const hours = Math.floor(item.usageTimeMinutes / 60);
      const minutes = item.usageTimeMinutes % 60;
      let timeString = '';
      if (hours > 0) timeString += `${hours}Â∞èÊó∂`;
      if (minutes > 0) timeString += `${minutes}ÂàÜÈíü`;
      if (!timeString) timeString = 'Â∞è‰∫é1ÂàÜÈíü';

      const prompt = item.image_prompt || `modern app icon for ${item.appName}, flat design, simple`;

      const iconUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;


      itemEl.innerHTML = `
                    <img src="${iconUrl}" class="usage-item-icon">
                    <div class="usage-item-info">
                        <div class="usage-item-name">${item.appName}</div>
                        <div class="usage-item-category">${item.category}</div>
                    </div>
                    <div class="usage-item-time">${timeString}</div>
                `;
      listEl.appendChild(itemEl);
    });
  }


  async function handleGenerateSimulatedBilibili() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÁªìÂêà‰∏ñÁïåËßÇ‰∏é‰∫∫ËÆæÔºåÂàÜÊûê‚Äú${chat.name}‚ÄùÁöÑBÁ´ôÂÖ¥Ë∂£...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    // 1. ÂáÜÂ§á‰∏ä‰∏ãÊñá
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    // 2. ÂáÜÂ§áËÆ∞ÂøÜÂíå‰∏ñÁïåËßÇ
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');

    // 3. ÂáÜÂ§á‰∏ñÁïå‰π¶
    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : 'Êó†';

    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    const userPersona = chat.settings.myPersona || '(Êú™ËÆæÁΩÆ)';

    // 4. ÊûÑÂª∫ PromptÔºöÊ†∏ÂøÉÊîπÂèòÊòØËÆ© AI ÁîüÊàêÂÖ≥ÈîÆËØçÔºåËÄå‰∏çÊòØÂÅáÊï∞ÊçÆ
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁî®Êà∑ÁîªÂÉèÂàÜÊûêÂ∏à„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÊ†πÊçÆTAÁöÑ‰∫∫ËÆæ„ÄÅÊâÄÂ§ÑÁöÑ‰∏ñÁïåËßÇ„ÄÅÈïøÊúüËÆ∞ÂøÜ„ÄÅ‰ª•Âèä‰∏éÁî®Êà∑Ôºà${userDisplayNameForAI}ÔºâÁöÑÂÖ≥Á≥ªÔºå**Êé®ÊµãTAÁé∞Âú®ÊúÄÊÉ≥Âú® Bilibili (BÁ´ô) ‰∏äÊêúÁ¥¢ÊàñËßÇÁúãÁöÑËßÜÈ¢ëÂÖ≥ÈîÆËØç**„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **Ê∑±Â∫¶‰∫∫ËÆæÁªëÂÆö**: ÂÖ≥ÈîÆËØçÂøÖÈ°ªÁ¥ßÊâ£ËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÅå‰∏ö„ÄÅÁà±Â•Ω‰ª•Âèä**‰∏ñÁïåËßÇËÆæÂÆö**„ÄÇ
    - ‰æãÂ¶ÇÔºöÂ¶ÇÊûú‰∏ñÁïå‰π¶ÈáåËÆæÂÆö‰∫Ü‚ÄúÈ≠îÊ≥ï‚ÄùÔºåËßíËâ≤ÂèØËÉΩ‰ºöÊêú‚ÄúÁÅ´ÁêÉÊúØÊïôÂ≠¶‚ÄùÔºõÂ¶ÇÊûúÊòØ‚ÄúÊú´‰∏ñ‚ÄùÔºåÂèØËÉΩ‰ºöÊêú‚ÄúÁîüÂ≠òÊåáÂçó‚Äù„ÄÇ
2.  **ÂÖ≥Á≥ªÂØºÂêë**: Â¶ÇÊûúÁî®Êà∑‰∫∫ËÆæÊòØ‰Ω†ÂñúÊ¨¢ÁöÑ‰∫∫Ôºå‰Ω†ÂèØËÉΩ‰ºöÊêú‚ÄúÁªôÂñúÊ¨¢ÁöÑ‰∫∫ÈÄÅ‰ªÄ‰πàÁ§ºÁâ©‚ÄùÔºõÂ¶ÇÊûúÊòØÊ≠ªÂØπÂ§¥ÔºåÂèØËÉΩ‰ºöÊêú‚ÄúÂ¶Ç‰Ωï‰ºòÈõÖÂú∞ÊÄº‰∫∫‚Äù„ÄÇÂøÖÈ°ªÈÄªËæëËá™Ê¥Ω„ÄÇ
3.  **Â§öÊ†∑ÊÄß**: ËØ∑ÁîüÊàê **10Âà∞12‰∏™** ÂÖ∑‰ΩìÁöÑÊêúÁ¥¢ÂÖ≥ÈîÆËØç„ÄÇ
4.  **ÂÖ∑‰ΩìÊÄß**: ÂÖ≥ÈîÆËØçÊúÄÂ•ΩÂÖ∑‰Ωì‰∏ÄÁÇπ„ÄÇ
5.  **Ê†ºÂºèÈìÅÂæã**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™**Â≠óÁ¨¶‰∏≤** (Âç≥ÊêúÁ¥¢ÂÖ≥ÈîÆËØç)„ÄÇ
    - Á§∫‰æã: \`["ÂÖ≥ÈîÆËØç1", "ÂÖ≥ÈîÆËØç2", "ÂÖ≥ÈîÆËØç3"...]\`

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑËØ¶ÁªÜ‰∏ä‰∏ãÊñá
- **ËßíËâ≤‰∫∫ËÆæ**: ${chat.settings.aiPersona}
- **Áî®Êà∑(${userDisplayNameForAI})ÁöÑ‰∫∫ËÆæ**: ${userPersona} 
- **ÈïøÊúüËÆ∞ÂøÜ**: 
${longTermMemoryContext}
${worldBookContext} 
- **ÊúÄËøëÂØπËØù**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÁªìÂêà‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºåÁîüÊàêËøôÁªÑÊêúÁ¥¢ÂÖ≥ÈîÆËØç„ÄÇ`;

    try {
      const messagesForApi = [{ role: 'user', content: "ËØ∑ÁîüÊàêBÁ´ôÊêúÁ¥¢ÂÖ≥ÈîÆËØçÂàóË°®„ÄÇ" }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
          body: JSON.stringify({
            model: model,
            messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 1.0,
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
      const keywords = JSON.parse(cleanedJson);

      if (!Array.isArray(keywords)) throw new Error("AIÊ≤°ÊúâËøîÂõûÊï∞ÁªÑÊ†ºÂºèÁöÑÂÖ≥ÈîÆËØç„ÄÇ");

      await showCustomAlert("ËØ∑Á®çÂÄô...", `AIÂ∑≤ÁªìÂêà‰∏ñÁïåËßÇÁîüÊàê ${keywords.length} ‰∏™ÂÖ≥ÈîÆËØçÔºåÊ≠£Âú®ÈÄê‰∏™ÊêúÁ¥¢BÁ´ôËßÜÈ¢ë (‰∏∫Èò≤Â∞ÅÁ¶ÅÔºåÈÄüÂ∫¶‰ºöÁ®çÊÖ¢)...`);

      // ÂÆö‰πâÂª∂Êó∂ÂáΩÊï∞ÔºåÈò≤Ê≠¢ËØ∑Ê±ÇÂ§™Âø´Ë¢´BÁ´ôÊé•Âè£Â∞ÅIP
      const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

      const results = [];

      // 5. ÈÅçÂéÜÂÖ≥ÈîÆËØçÔºåË∞ÉÁî®ÁúüÂÆûÁöÑÊêúÁ¥¢Êé•Âè£
      for (const [index, keyword] of keywords.entries()) {
        let retryCount = 0; // ÂΩìÂâçÂÖ≥ÈîÆËØçÁöÑÈáçËØïÊ¨°Êï∞
        let success = false; // ÊòØÂê¶ÊàêÂäüÊ†áËÆ∞
        const maxRetries = 5; // ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞ÔºåÈò≤Ê≠¢Ê≠ªÂæ™ÁéØ

        // ‰ΩøÁî® while Âæ™ÁéØÔºåÁõ¥Âà∞ÊàêÂäüÊàñË∂ÖËøáÊúÄÂ§ßÈáçËØïÊ¨°Êï∞
        while (!success && retryCount < maxRetries) {
          try {
            // Â¶ÇÊûúÊòØÈáçËØïÔºåÊâìÂç∞Êó•ÂøóÊèêÁ§∫
            const retryMsg = retryCount > 0 ? ` (Á¨¨ ${retryCount} Ê¨°ÈáçËØï)` : "";
            console.log(`[BÁ´ôÊêúÁ¥¢ ${index + 1}/${keywords.length}] Ê≠£Âú®ÊêúÁ¥¢: ${keyword}${retryMsg}`);

            // ‰ΩøÁî®‰Ω†ËÑöÊú¨ÈáåÂéüÊú¨‰ΩøÁî®ÁöÑÊé•Âè£ÔºåÁªèËøáCORS‰ª£ÁêÜ
            const targetUrl = `https://api.52vmy.cn/api/query/bilibili/video?msg=${encodeURIComponent(keyword)}&n=1`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

            const res = await fetch(proxyUrl);

            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const text = await res.text();

            // --- ‰øÆÊîπÈáçÁÇπÂºÄÂßãÔºöÊ£ÄÊµãÈôêÊµÅÂπ∂ÈáçËØï ---
            if (text.includes("ËÆøÈóÆËøáÂø´") || text.includes("È¢ëÁπÅ") || text.includes("Too Many Requests")) {
              console.warn(`‚ö†Ô∏è ÂÖ≥ÈîÆËØç "${keyword}" Ëß¶ÂèëÈôêÊµÅÔºåÁ≠âÂæÖÂÜ∑Âç¥ÂêéÈáçËØï...`);

              // Âä®ÊÄÅÁ≠âÂæÖÊó∂Èó¥ÔºöÂü∫Á°ÄÁ≠âÂæÖ 5Áßí + ÊØèÊ¨°ÈáçËØïÂ¢ûÂä† 2Áßí (5s, 7s, 9s...)
              await delay(5000 + (retryCount * 2000));

              retryCount++; // Â¢ûÂä†ÈáçËØïËÆ°Êï∞
              continue; // Ë∑≥ËøáÊú¨Ê¨° while Âæ™ÁéØÁöÑÂâ©‰ΩôÈÉ®ÂàÜÔºåÈáçÊñ∞ÂèëËµ∑ËØ∑Ê±Ç
            }
            // --- ‰øÆÊîπÈáçÁÇπÁªìÊùü ---

            let json;
            try {
              json = JSON.parse(text);
            } catch (e) {
              // Â¶ÇÊûúJSONËß£ÊûêÂ§±Ë¥•ÔºàÂèØËÉΩÊòØÊé•Âè£Êä•ÈîôËøîÂõû‰∫ÜHTMLÔºâÔºå‰πüËßÜ‰∏∫Â§±Ë¥•ËøõË°åÈáçËØï
              console.warn(`JSONËß£ÊûêÂ§±Ë¥•ÔºåÂáÜÂ§áÈáçËØï: ${keyword}`);
              retryCount++;
              await delay(3000);
              continue;
            }

            // Êé•Âè£ËøîÂõûÊ†ºÂºèÂÖºÂÆπÂ§ÑÁêÜ
            let videoData = null;
            if (json.data && Array.isArray(json.data) && json.data.length > 0) {
              videoData = json.data[0];
            } else if (json.code === 200 && json.data) {
              videoData = Array.isArray(json.data) ? json.data[0] : json.data;
            } else if (json.title) {
              videoData = json;
            }

            if (videoData && videoData.title && videoData.url) {
              results.push(videoData);
            }

            // Â¶ÇÊûú‰ª£Á†ÅË∑ëÂà∞ËøôÈáåÔºåËØ¥ÊòéÊ≤°ÊúâËß¶ÂèëÈôêÊµÅ‰∏îÊ≤°ÊúâÊä•ÈîôÔºåÊ†áËÆ∞ÊàêÂäü‰ª•ÈÄÄÂá∫ while Âæ™ÁéØ
            success = true;

          } catch (e) {
            console.warn(`ÊêúÁ¥¢ÂÖ≥ÈîÆËØç "${keyword}" ÂèëÁîüÈîôËØØ:`, e);
            // ÁΩëÁªúÈîôËØØ‰πüËøõË°åÈáçËØï
            retryCount++;
            await delay(3000);
          }
        }

        // Â¶ÇÊûúË∂ÖËøáÊúÄÂ§ßÈáçËØïÊ¨°Êï∞‰ªçÁÑ∂Â§±Ë¥•
        if (!success) {
          console.error(`‚ùå ÂÖ≥ÈîÆËØç "${keyword}" ÈáçËØï ${maxRetries} Ê¨°Âêé‰ªçÁÑ∂Â§±Ë¥•ÔºåÂ∑≤Ë∑≥Ëøá„ÄÇ`);
        }

        // ÂÖ≥ÈîÆËØç‰πãÈó¥ÁöÑÊ≠£Â∏∏Èó¥Èöî (Âª∫ËÆÆÁ®çÂæÆË∞ÉÂ§ß‰∏ÄÁÇπÔºåÊØîÂ¶Ç 2000msÔºå‰ª•ÂáèÂ∞ëËß¶ÂèëÈôêÊµÅÁöÑÊ¶ÇÁéá)
        await delay(1500);
      }

      // 6. ‰øùÂ≠òÁúüÂÆûÊï∞ÊçÆ
      chat.simulatedBilibiliFeed = results;
      await db.chats.put(chat);

      // 7. Ê∏≤ÊüìÁïåÈù¢
      renderCharBilibiliScreen();
      await showCustomAlert("ÂÆåÊàê", `ÊàêÂäü‰∏∫‰Ω†ÁîüÊàê‰∫Ü ${results.length} ‰∏™Á¨¶Âêà ${chat.name} ‰∫∫ËÆæ‰∏é‰∏ñÁïåËßÇÁöÑËßÜÈ¢ëÊé®ËçêÔºÅ`);

    } catch (error) {
      console.error("ÁîüÊàêBÁ´ôÊé®ËçêÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊé®ËçêÂÜÖÂÆπ„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }
  function renderCharBilibiliScreen() {
    const listEl = document.getElementById('char-bilibili-list');
    listEl.innerHTML = '';

    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];

    // ËØªÂèñ‰øùÂ≠òÁöÑÊ®°ÊãüÊï∞ÊçÆ
    const videos = chat.simulatedBilibiliFeed || [];

    if (videos.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">È¶ñÈ°µÁ©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆËé∑Âèñ‰∏™ÊÄßÂåñÊé®ËçêÂêßÔºÅ</p>';
      return;
    }

    videos.forEach(video => {
      const item = document.createElement('div');
      item.className = 'bilibili-item';

      // Â§ÑÁêÜÂ∞ÅÈù¢ÂõæÂíå‰ø°ÊÅØ
      // ‰ΩøÁî® img Ê†áÁ≠æÈÖçÂêà no-referrer Êù•ÁªïËøá Safari ÁöÑÈò≤ÁõóÈìæÊ£ÄÊü•
      item.innerHTML = `
            <div class="bili-cover" style="position: relative; overflow: hidden;">
                <img src="${video.img_url || video.pic}" referrerpolicy="no-referrer" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1;" onerror="this.style.display='none'">
                <div class="bili-duration" style="position: absolute; z-index: 2;">‚ñ∂</div>
            </div>
            <div class="bili-info">
                <div class="bili-title">${video.title}</div>
                <div class="bili-author">UP: ${video.user || video.author || 'Êú™Áü•UP‰∏ª'}</div>
            </div>
        `;

      // ÁÇπÂáªÊí≠Êîæ
      item.onclick = () => playCharBilibiliVideo(video);
      listEl.appendChild(item);
    });
  }
  async function handleGenerateSimulatedMusic() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ËØ∑Ê±Ç‚Äú${chat.name}‚ÄùÂàÜ‰∫´TAÁöÑÁßÅ‰∫∫Ê≠åÂçï...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');


    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÈü≥‰πêÂìÅÂë≥Ê®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåÊåëÈÄâÂá∫„Äê14Âà∞18È¶ñ„ÄëÊúÄËÉΩ‰ª£Ë°®TAÊ≠§ÂàªÂøÉÊÉÖÊàñÂìÅÂë≥ÁöÑÊ≠åÊõ≤„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **ÂàõÈÄ†ÊÄß‰∏éÂêàÁêÜÊÄß**: Ê≠åÂçïÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•ΩÂíåÁîüÊ¥ªËÉåÊôØ„ÄÇ
2.  **Â§öÊ†∑ÊÄß**: Ê≠åÊõ≤È£éÊ†ºÂèØ‰ª•Â§öÊ†∑Ôºå‰ΩÜÂøÖÈ°ªÈÄªËæëËá™Ê¥Ω„ÄÇ
3.  **Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰ª£Ë°®‰∏ÄÈ¶ñÊ≠åÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "songName": "Ê≠åÊõ≤ÁöÑÂáÜÁ°ÆÂêçÁß∞",
        "artistName": "Ê≠åÊõ≤ÁöÑÂáÜÁ°ÆËâ∫ÊúØÂÆ∂/Ê≠åÊâãÂêç"
      }
    ]
    \`\`\`

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÁîüÊàêËøô‰ªΩÊ≠åÂçï„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÊ≠åÂçï„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 1.0,
          })
        });


      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
      const songPicks = JSON.parse(cleanedJson);

      await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠åÂçïÂ∑≤ÁîüÊàêÔºåÊ≠£Âú®‰ªéÁΩëÁªúËé∑Âèñ ${songPicks.length} È¶ñÊ≠åÊõ≤ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ...`);

      const songDetailPromises = songPicks.map(async (pick) => {
        let searchResults = await searchNeteaseMusic(pick.songName, pick.artistName);
        if (!searchResults || searchResults.length === 0) {
          searchResults = await searchTencentMusic(pick.songName);
        }
        if (searchResults.length > 0) {
          return getPlayableSongDetails(searchResults[0]);
        }
        console.warn(`ÊâÄÊúâÈü≥‰πêÊ∫êÈÉΩÊú™ËÉΩÊâæÂà∞Ê≠åÊõ≤Ôºö‚Äú${pick.songName} - ${pick.artistName}‚Äù`);
        return null;
      });

      const fullSongObjects = (await Promise.all(songDetailPromises)).filter(Boolean);

      chat.simulatedMusicPlaylist = fullSongObjects;
      await db.chats.put(chat);

      await renderCharMusicScreen();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüÊ≠åÂçïÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊ≠åÂçïÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }


  // ==========================================
  // MY Phone ÁîüÊàêÂ§ÑÁêÜÂáΩÊï∞
  // ==========================================

  async function handleGenerateMyPhoneQQ() {
    if (!activeMyPhoneCharacterId) return;
    const chat = state.chats[activeMyPhoneCharacterId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    // Ëé∑Âèñ‰∏éËØ•ËßíËâ≤ÁöÑÂØπËØùÂéÜÂè≤Ôºå‰∫ÜËß£Áî®Êà∑ÁâπÂæÅ
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory = chat.history.slice(-maxMemory).map(msg =>
      `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 50)}...`
    ).join('\n');

    const prompt = `‰Ω†Áé∞Âú®Ë¶ÅÊâÆÊºî"${userDisplayNameForAI}"Ôºà‰πüÂ∞±ÊòØÊàëÔºâÔºåÂü∫‰∫éÊàë‰∏é"${chat.name}"ÁöÑÂØπËØùÂéÜÂè≤ÔºåÊé®ÊµãÊàëÁöÑÊÄßÊ†º„ÄÅÂÖ¥Ë∂£ÂíåÁ§æ‰∫§ÂúàÔºåÁÑ∂ÂêéÁîüÊàêÊàëÁöÑQQËÅäÂ§©ËÆ∞ÂΩï„ÄÇ

## Êàë‰∏é"${chat.name}"ÁöÑÊúÄËøëÂØπËØùÔºö
${recentHistory}

## ‰ªªÂä°Ôºö
ËØ∑Âü∫‰∫é‰ª•‰∏äÂØπËØùÊé®ÊµãÊàëÁöÑÁâπÂæÅÔºåÁÑ∂ÂêéÁîüÊàê3-5‰∏™ÊàëÂèØËÉΩ‰ºöËÅäÂ§©ÁöÑËÅîÁ≥ª‰∫∫ÂèäÂÖ∂ÂØπËØùÂÜÖÂÆπ„ÄÇËøô‰∫õÂØπËØùÂ∫îËØ•ÂèçÊò†Âá∫ÊàëÁöÑÊÄßÊ†º„ÄÅÂÖ¥Ë∂£ÂíåÁîüÊ¥ªÁä∂ÊÄÅ„ÄÇ

ËØ∑ËøîÂõûJSONÊ†ºÂºèÔºö
[
  {
    "name": "ËÅîÁ≥ª‰∫∫ÂêçÂ≠ó",
    "avatar": "",
    "lastMessage": "ÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÈ¢ÑËßà",
    "messages": [
      {"role": "user", "content": "ÊàëÂèëÈÄÅÁöÑÊ∂àÊÅØ", "timestamp": "2024-01-01T12:00:00Z"},
      {"role": "assistant", "content": "ÂØπÊñπÁöÑÂõûÂ§ç", "timestamp": "2024-01-01T12:01:00Z"}
    ]
  }
]`;

    try {
      const messagesForApi = [{ role: 'user', content: prompt }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, '', messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: messagesForApi,
            temperature: 0.8
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      // ‰ΩøÁî®Ê≠£ÂàôÊèêÂèñ JSON Êï∞ÁªÑÔºåÊõ¥ÂÅ•Â£ÆÂú∞Â§ÑÁêÜ AI ËøîÂõûÁöÑÈ¢ùÂ§ñÊñáÊú¨
      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJson = jsonMatch[0];
      const conversations = JSON.parse(cleanedJson);

      chat.myPhoneSimulatedQQConversations = conversations;
      await db.chats.put(chat);
    } catch (error) {
      console.error("ÁîüÊàêMY Phone QQÂ§±Ë¥•:", error);
      throw error;
    }
  }

  async function handleGenerateMyPhoneAlbum() {
    if (!activeMyPhoneCharacterId) return;
    const chat = state.chats[activeMyPhoneCharacterId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory = chat.history.slice(-maxMemory).map(msg =>
      `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 50)}...`
    ).join('\n');

    const prompt = `‰Ω†Áé∞Âú®Ë¶ÅÊâÆÊºî"${userDisplayNameForAI}"Ôºà‰πüÂ∞±ÊòØÊàëÔºâÔºåÂü∫‰∫éÊàë‰∏é"${chat.name}"ÁöÑÂØπËØùÂéÜÂè≤ÔºåÊé®ÊµãÊàëÁöÑÁîüÊ¥ª„ÄÅÂÖ¥Ë∂£ÂíåÂÆ°ÁæéÔºåÁÑ∂ÂêéÁîüÊàêÊàëÁõ∏ÂÜå‰∏≠ÁöÑÁÖßÁâá„ÄÇ

## Êàë‰∏é"${chat.name}"ÁöÑÊúÄËøëÂØπËØùÔºö
${recentHistory}

## ‰ªªÂä°Ôºö
ËØ∑Âü∫‰∫é‰ª•‰∏äÂØπËØùÊé®ÊµãÊàëÁöÑÁâπÂæÅÔºåÁÑ∂ÂêéÊèèËø∞ÊàëÁõ∏ÂÜå‰∏≠ÁöÑ5-8Âº†ÁÖßÁâá„ÄÇËøô‰∫õÁÖßÁâáÂ∫îËØ•ÂèçÊò†Âá∫ÊàëÁöÑÁîüÊ¥ªÁä∂ÊÄÅ„ÄÅÂÖ¥Ë∂£Áà±Â•ΩÂíåÂÆ°ÁæéÂÅèÂ•Ω„ÄÇ

ËøîÂõûJSONÊ†ºÂºèÔºö
[
  {
    "description": "ÁÖßÁâáÁöÑ‰∏≠ÊñáÊèèËø∞Ôºà‰ªéÊàëÁöÑËßÜËßíÊèèËø∞Ôºâ",
    "image_prompt": "Ëã±ÊñáÂõæÂÉèÁîüÊàêÊèêÁ§∫ËØç"
  }
]`;

    try {
      const messagesForApi = [{ role: 'user', content: prompt }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, '', messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: messagesForApi,
            temperature: 0.8
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      // ‰ΩøÁî®Ê≠£ÂàôÊèêÂèñ JSON Êï∞ÁªÑÔºåÊõ¥ÂÅ•Â£ÆÂú∞Â§ÑÁêÜ AI ËøîÂõûÁöÑÈ¢ùÂ§ñÊñáÊú¨
      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJson = jsonMatch[0];
      const photos = JSON.parse(cleanedJson);

      chat.myPhoneAlbum = photos;
      await db.chats.put(chat);
    } catch (error) {
      console.error("ÁîüÊàêMY PhoneÁõ∏ÂÜåÂ§±Ë¥•:", error);
      throw error;
    }
  }

  async function handleGenerateMyPhoneBrowserHistory() {
    if (!activeMyPhoneCharacterId) return;
    const chat = state.chats[activeMyPhoneCharacterId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory = chat.history.slice(-maxMemory).map(msg =>
      `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 50)}...`
    ).join('\n');

    const prompt = `‰Ω†Áé∞Âú®Ë¶ÅÊâÆÊºî"${userDisplayNameForAI}"Ôºà‰πüÂ∞±ÊòØÊàëÔºâÔºåÂü∫‰∫éÊàë‰∏é"${chat.name}"ÁöÑÂØπËØùÂéÜÂè≤ÔºåÊé®ÊµãÊàëÁöÑÂÖ¥Ë∂£ÂíåÂÖ≥Ê≥®ÁÇπÔºåÁÑ∂ÂêéÁîüÊàêÊàëÁöÑÊµèËßàÂô®ÂéÜÂè≤ËÆ∞ÂΩï„ÄÇ

## Êàë‰∏é"${chat.name}"ÁöÑÊúÄËøëÂØπËØùÔºö
${recentHistory}

## ‰ªªÂä°Ôºö
ËØ∑Âü∫‰∫é‰ª•‰∏äÂØπËØùÊé®ÊµãÊàëÁöÑÁâπÂæÅÔºåÁÑ∂ÂêéÁîüÊàêÊàëÊúÄËøëÁöÑ5-8Êù°ÊµèËßàÂô®ÂéÜÂè≤ËÆ∞ÂΩï„ÄÇËøô‰∫õËÆ∞ÂΩïÂ∫îËØ•ÂèçÊò†Âá∫ÊàëÁöÑÂÖ¥Ë∂£Áà±Â•Ω„ÄÅÂÖ≥Ê≥®ÁöÑËØùÈ¢òÂíå‰ø°ÊÅØÈúÄÊ±Ç„ÄÇ

ËøîÂõûJSONÊ†ºÂºèÔºö
[
  {
    "title": "ÁΩëÈ°µÊ†áÈ¢ò",
    "url": "ÁΩëÂùÄ",
    "content": "ÁΩëÈ°µÂÜÖÂÆπÊëòË¶ÅÔºà100-200Â≠óÔºâ"
  }
]`;

    try {
      const messagesForApi = [{ role: 'user', content: prompt }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, '', messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: messagesForApi,
            temperature: 0.8
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      // ‰ΩøÁî®Ê≠£ÂàôÊèêÂèñ JSON Êï∞ÁªÑÔºåÊõ¥ÂÅ•Â£ÆÂú∞Â§ÑÁêÜ AI ËøîÂõûÁöÑÈ¢ùÂ§ñÊñáÊú¨
      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJson = jsonMatch[0];
      const history = JSON.parse(cleanedJson);

      chat.myPhoneBrowserHistory = history;
      await db.chats.put(chat);
    } catch (error) {
      console.error("ÁîüÊàêMY PhoneÊµèËßàËÆ∞ÂΩïÂ§±Ë¥•:", error);
      throw error;
    }
  }

  async function handleGenerateMyPhoneTaobao() {
    if (!activeMyPhoneCharacterId) return;
    const chat = state.chats[activeMyPhoneCharacterId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory = chat.history.slice(-maxMemory).map(msg =>
      `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 50)}...`
    ).join('\n');

    const prompt = `‰Ω†Áé∞Âú®Ë¶ÅÊâÆÊºî"${userDisplayNameForAI}"Ôºà‰πüÂ∞±ÊòØÊàëÔºâÔºåÂü∫‰∫éÊàë‰∏é"${chat.name}"ÁöÑÂØπËØùÂéÜÂè≤ÔºåÊé®ÊµãÊàëÁöÑÁîüÊ¥ªÈúÄÊ±ÇÂíåÊ∂àË¥π‰π†ÊÉØÔºåÁÑ∂ÂêéÁîüÊàêÊàëÁöÑÊ∑òÂÆùË¥≠Áâ©ËÆ∞ÂΩï„ÄÇ

## Êàë‰∏é"${chat.name}"ÁöÑÊúÄËøëÂØπËØùÔºö
${recentHistory}

## ‰ªªÂä°Ôºö
ËØ∑Âü∫‰∫é‰ª•‰∏äÂØπËØùÊé®ÊµãÊàëÁöÑÁâπÂæÅÔºåÁÑ∂ÂêéÁîüÊàêÊàëÊúÄËøëÁöÑ5-8Êù°Ê∑òÂÆùË¥≠Áâ©ËÆ∞ÂΩï„ÄÇËøô‰∫õËÆ∞ÂΩïÂ∫îËØ•ÂèçÊò†Âá∫ÊàëÁöÑÁîüÊ¥ªÁä∂ÊÄÅ„ÄÅÈúÄÊ±ÇÂíåÊ∂àË¥πÂÅèÂ•Ω„ÄÇ

ËøîÂõûJSONÊ†ºÂºèÔºö
[
  {
    "name": "ÂïÜÂìÅÂêçÁß∞",
    "price": "‰ª∑Ê†ºÔºàÊï∞Â≠óÔºâ",
    "date": "Ë¥≠‰π∞Êó•Êúü",
    "reason": "Ë¥≠‰π∞ÁêÜÁî±ÔºàÁÆÄÁü≠ÊèèËø∞‰∏∫‰ªÄ‰πà‰π∞Ëøô‰∏™ÂïÜÂìÅÔºâ"
  }
]`;

    try {
      const messagesForApi = [{ role: 'user', content: prompt }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, '', messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: messagesForApi,
            temperature: 0.8
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      // ‰ΩøÁî®Ê≠£ÂàôÊèêÂèñ JSON Êï∞ÁªÑÔºåÊõ¥ÂÅ•Â£ÆÂú∞Â§ÑÁêÜ AI ËøîÂõûÁöÑÈ¢ùÂ§ñÊñáÊú¨
      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJson = jsonMatch[0];
      const items = JSON.parse(cleanedJson);

      chat.myPhoneTaobaoHistory = items;
      await db.chats.put(chat);
    } catch (error) {
      console.error("ÁîüÊàêMY PhoneÊ∑òÂÆùËÆ∞ÂΩïÂ§±Ë¥•:", error);
      throw error;
    }
  }

  async function handleGenerateMyPhoneMemos() {
    if (!activeMyPhoneCharacterId) return;
    const chat = state.chats[activeMyPhoneCharacterId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory = chat.history.slice(-maxMemory).map(msg =>
      `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 50)}...`
    ).join('\n');

    const prompt = `‰Ω†Áé∞Âú®Ë¶ÅÊâÆÊºî"${userDisplayNameForAI}"Ôºà‰πüÂ∞±ÊòØÊàëÔºâÔºåÂü∫‰∫éÊàë‰∏é"${chat.name}"ÁöÑÂØπËØùÂéÜÂè≤ÔºåÊé®ÊµãÊàëÁöÑÁîüÊ¥ªÁä∂ÊÄÅÂíåÂæÖÂäû‰∫ãÈ°πÔºåÁÑ∂ÂêéÁîüÊàêÊàëÁöÑÂ§áÂøòÂΩï„ÄÇ

## Êàë‰∏é"${chat.name}"ÁöÑÊúÄËøëÂØπËØùÔºö
${recentHistory}

## ‰ªªÂä°Ôºö
ËØ∑Âü∫‰∫é‰ª•‰∏äÂØπËØùÊé®ÊµãÊàëÁöÑÁâπÂæÅÔºåÁÑ∂ÂêéÁîüÊàêÊàëÁöÑ3-5Êù°Â§áÂøòÂΩï„ÄÇËøô‰∫õÂ§áÂøòÂΩïÂ∫îËØ•ÂèçÊò†Âá∫ÊàëÁöÑÁîüÊ¥ªÂÆâÊéí„ÄÅÂæÖÂäû‰∫ãÈ°πÂíåÂÖ≥Ê≥®ÁÇπ„ÄÇ

ËøîÂõûJSONÊ†ºÂºèÔºö
[
  {
    "title": "Â§áÂøòÂΩïÊ†áÈ¢ò",
    "content": "Â§áÂøòÂΩïÂÜÖÂÆπ",
    "date": "Êó•Êúü"
  }
]`;

    try {
      const messagesForApi = [{ role: 'user', content: prompt }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, '', messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: messagesForApi,
            temperature: 0.8
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      // ‰ΩøÁî®Ê≠£ÂàôÊèêÂèñ JSON Êï∞ÁªÑÔºåÊõ¥ÂÅ•Â£ÆÂú∞Â§ÑÁêÜ AI ËøîÂõûÁöÑÈ¢ùÂ§ñÊñáÊú¨
      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJson = jsonMatch[0];
      const memos = JSON.parse(cleanedJson);

      chat.myPhoneMemos = memos;
      await db.chats.put(chat);
    } catch (error) {
      console.error("ÁîüÊàêMY PhoneÂ§áÂøòÂΩïÂ§±Ë¥•:", error);
      throw error;
    }
  }

  async function handleGenerateMyPhoneDiaries() {
    if (!activeMyPhoneCharacterId) return;
    const chat = state.chats[activeMyPhoneCharacterId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory = chat.history.slice(-maxMemory).map(msg =>
      `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 50)}...`
    ).join('\n');

    const prompt = `‰Ω†Áé∞Âú®Ë¶ÅÊâÆÊºî"${userDisplayNameForAI}"Ôºà‰πüÂ∞±ÊòØÊàëÔºâÔºåÂü∫‰∫éÊàë‰∏é"${chat.name}"ÁöÑÂØπËØùÂéÜÂè≤ÔºåÊé®ÊµãÊàëÁöÑÂÜÖÂøÉ‰∏ñÁïåÂíåÁîüÊ¥ªÊÑüÂèóÔºåÁÑ∂ÂêéÁîüÊàêÊàëÁöÑÊó•ËÆ∞„ÄÇ

## Êàë‰∏é"${chat.name}"ÁöÑÊúÄËøëÂØπËØùÔºö
${recentHistory}

## ‰ªªÂä°Ôºö
ËØ∑Âü∫‰∫é‰ª•‰∏äÂØπËØùÊé®ÊµãÊàëÁöÑÁâπÂæÅÔºåÁÑ∂ÂêéÁîüÊàêÊàëÁöÑ3-5ÁØáÊó•ËÆ∞„ÄÇËøô‰∫õÊó•ËÆ∞Â∫îËØ•ÂèçÊò†Âá∫ÊàëÁöÑÊÉÖÊÑüÁä∂ÊÄÅ„ÄÅÁîüÊ¥ªÊÑüÊÇüÂíåÂÜÖÂøÉÊÉ≥Ê≥ï„ÄÇ

ËøîÂõûJSONÊ†ºÂºèÔºö
[
  {
    "title": "Êó•ËÆ∞Ê†áÈ¢ò",
    "content": "Êó•ËÆ∞ÂÜÖÂÆπÔºà100-200Â≠óÔºåÁ¨¨‰∏Ä‰∫∫Áß∞Ôºâ",
    "date": "Êó•Êúü"
  }
]`;

    try {
      const messagesForApi = [{ role: 'user', content: prompt }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, '', messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: messagesForApi,
            temperature: 0.8
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      // ‰ΩøÁî®Ê≠£ÂàôÊèêÂèñ JSON Êï∞ÁªÑÔºåÊõ¥ÂÅ•Â£ÆÂú∞Â§ÑÁêÜ AI ËøîÂõûÁöÑÈ¢ùÂ§ñÊñáÊú¨
      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJson = jsonMatch[0];
      const diaries = JSON.parse(cleanedJson);

      chat.myPhoneDiaries = diaries;
      await db.chats.put(chat);
    } catch (error) {
      console.error("ÁîüÊàêMY PhoneÊó•ËÆ∞Â§±Ë¥•:", error);
      throw error;
    }
  }

  async function handleGenerateMyPhoneAmap() {
    if (!activeMyPhoneCharacterId) return;
    const chat = state.chats[activeMyPhoneCharacterId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory = chat.history.slice(-maxMemory).map(msg =>
      `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 50)}...`
    ).join('\n');

    const prompt = `‰Ω†Áé∞Âú®Ë¶ÅÊâÆÊºî"${userDisplayNameForAI}"Ôºà‰πüÂ∞±ÊòØÊàëÔºâÔºåÂü∫‰∫éÊàë‰∏é"${chat.name}"ÁöÑÂØπËØùÂéÜÂè≤ÔºåÊé®ÊµãÊàëÁöÑÊ¥ªÂä®ËåÉÂõ¥ÂíåÁîüÊ¥ªËΩ®ËøπÔºåÁÑ∂ÂêéÁîüÊàêÊàëÁöÑË∂≥ËøπËÆ∞ÂΩï„ÄÇ

## Êàë‰∏é"${chat.name}"ÁöÑÊúÄËøëÂØπËØùÔºö
${recentHistory}

## ‰ªªÂä°Ôºö
ËØ∑Âü∫‰∫é‰ª•‰∏äÂØπËØùÊé®ÊµãÊàëÁöÑÁâπÂæÅÔºåÁÑ∂ÂêéÁîüÊàêÊàëÊúÄËøëÁöÑ5-8Êù°Ë∂≥ËøπËÆ∞ÂΩï„ÄÇËøô‰∫õËÆ∞ÂΩïÂ∫îËØ•ÂèçÊò†Âá∫ÊàëÁöÑÁîüÊ¥ªÂå∫Âüü„ÄÅÊ¥ªÂä®‰π†ÊÉØÂíåÂéªËøáÁöÑÂú∞Êñπ„ÄÇ

ËøîÂõûJSONÊ†ºÂºèÔºö
[
  {
    "name": "Âú∞ÁÇπÂêçÁß∞",
    "address": "ËØ¶ÁªÜÂú∞ÂùÄ",
    "time": "ËÆøÈóÆÊó∂Èó¥"
  }
]`;

    try {
      const messagesForApi = [{ role: 'user', content: prompt }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, '', messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: messagesForApi,
            temperature: 0.8
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      // ‰ΩøÁî®Ê≠£ÂàôÊèêÂèñ JSON Êï∞ÁªÑÔºåÊõ¥ÂÅ•Â£ÆÂú∞Â§ÑÁêÜ AI ËøîÂõûÁöÑÈ¢ùÂ§ñÊñáÊú¨
      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJson = jsonMatch[0];
      const locations = JSON.parse(cleanedJson);

      chat.myPhoneAmapHistory = locations;
      await db.chats.put(chat);
    } catch (error) {
      console.error("ÁîüÊàêMY PhoneË∂≥ËøπÂ§±Ë¥•:", error);
      throw error;
    }
  }

  async function handleGenerateMyPhoneAppUsage() {
    if (!activeMyPhoneCharacterId) return;
    const chat = state.chats[activeMyPhoneCharacterId];
    if (!chat) return;

    // ÁîüÊàêÊ®°ÊãüÁöÑ‰ΩøÁî®ËÆ∞ÂΩïÔºåÊ†ºÂºè‰∏éÊâãÂä®Ê∑ªÂä†‰∏ÄËá¥
    const apps = [
      { name: 'QQ', category: 'Á§æ‰∫§' },
      { name: 'Áõ∏ÂÜå', category: 'Â∑•ÂÖ∑' },
      { name: 'ÊµèËßàÂô®', category: 'Â∑•ÂÖ∑' },
      { name: 'Ê∑òÂÆù', category: 'Ë¥≠Áâ©' },
      { name: 'Â§áÂøòÂΩï', category: 'Â∑•ÂÖ∑' },
      { name: 'Êó•ËÆ∞', category: 'ÁîüÊ¥ª' },
      { name: 'È´òÂæ∑Âú∞Âõæ', category: 'Âá∫Ë°å' },
      { name: 'ÁΩëÊòì‰∫ëÈü≥‰πê', category: 'Â®±‰πê' },
      { name: 'BÁ´ô', category: 'Â®±‰πê' },
      { name: 'ÂæÆÂçö', category: 'Á§æ‰∫§' },
      { name: 'ÊäñÈü≥', category: 'Â®±‰πê' },
      { name: 'Â∞èÁ∫¢‰π¶', category: 'ÁîüÊ¥ª' }
    ];
    const usageLog = [];

    for (let i = 0; i < 15; i++) {
      const app = apps[Math.floor(Math.random() * apps.length)];
      const date = Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000;
      usageLog.push({
        appName: app.name,
        category: app.category,
        usageTimeMinutes: Math.floor(Math.random() * 180) + 5, // 5-185ÂàÜÈíü
        iconUrl: '', // ÂèØ‰ª•ÂêéÁª≠Ê∑ªÂä†ÂõæÊ†áURL
        timestamp: date
      });
    }

    chat.myPhoneAppUsage = usageLog.sort((a, b) => b.timestamp - a.timestamp);
    await db.chats.put(chat);
  }

  async function handleGenerateMyPhoneMusic() {
    if (!activeMyPhoneCharacterId) return;
    const chat = state.chats[activeMyPhoneCharacterId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory = chat.history.slice(-maxMemory).map(msg =>
      `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 50)}...`
    ).join('\n');

    const prompt = `‰Ω†Áé∞Âú®Ë¶ÅÊâÆÊºî"${userDisplayNameForAI}"Ôºà‰πüÂ∞±ÊòØÊàëÔºâÔºåÂü∫‰∫éÊàë‰∏é"${chat.name}"ÁöÑÂØπËØùÂéÜÂè≤ÔºåÊé®ÊµãÊàëÁöÑÈü≥‰πêÂìÅÂë≥ÂíåÊÉÖÊÑüÁä∂ÊÄÅÔºåÁÑ∂ÂêéÁîüÊàêÊàëÁöÑÈü≥‰πêÊ≠åÂçï„ÄÇ

## Êàë‰∏é"${chat.name}"ÁöÑÊúÄËøëÂØπËØùÔºö
${recentHistory}

## ‰ªªÂä°Ôºö
ËØ∑Âü∫‰∫é‰ª•‰∏äÂØπËØùÊé®ÊµãÊàëÁöÑÁâπÂæÅÔºåÁÑ∂ÂêéÁîüÊàêÊàëÁöÑÈü≥‰πêÊ≠åÂçïÔºà5-8È¶ñÊ≠åÔºâ„ÄÇËøô‰∫õÊ≠åÊõ≤Â∫îËØ•ÂèçÊò†Âá∫ÊàëÁöÑÈü≥‰πêÂÅèÂ•Ω„ÄÅÊÉÖÊÑüÁä∂ÊÄÅÂíåÂÆ°ÁæéÂìÅÂë≥„ÄÇ

ËøîÂõûJSONÊ†ºÂºèÔºö
[
  {
    "title": "Ê≠åÊõ≤Âêç",
    "artist": "Ê≠åÊâãÂêç"
  }
]`;

    try {
      const messagesForApi = [{ role: 'user', content: prompt }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, '', messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: messagesForApi,
            temperature: 0.8
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      // ‰ΩøÁî®Ê≠£ÂàôÊèêÂèñ JSON Êï∞ÁªÑÔºåÊõ¥ÂÅ•Â£ÆÂú∞Â§ÑÁêÜ AI ËøîÂõûÁöÑÈ¢ùÂ§ñÊñáÊú¨
      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJson = jsonMatch[0];
      const playlist = JSON.parse(cleanedJson);

      chat.myPhoneMusicPlaylist = playlist;
      await db.chats.put(chat);
    } catch (error) {
      console.error("ÁîüÊàêMY PhoneÈü≥‰πêÂ§±Ë¥•:", error);
      throw error;
    }
  }

  function renderCharMusicScreen() {
    const listEl = document.getElementById('char-music-list');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const playlist = char.simulatedMusicPlaylist || [];

    if (playlist.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAÁöÑÊ≠åÂçïËøòÊòØÁ©∫ÁöÑÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õÊ≠åÊõ≤ÂêßÔºÅ</p>';
      return;
    }

    playlist.forEach((track, index) => {
      const itemEl = document.createElement('div');
      itemEl.className = 'char-music-item';
      itemEl.innerHTML = `
            <img src="${track.cover}" class="music-item-cover">
            <div class="music-item-info">
                <div class="music-item-name">${track.name}</div>
                <div class="music-item-artist">${track.artist}</div>
            </div>
        `;

      itemEl.addEventListener('click', () => playCharSong(index, playlist));
      listEl.appendChild(itemEl);
    });
  }



  let charPlayerState = {
    currentPlaylist: [],
    currentIndex: -1,
    isPlaying: false,
    playMode: 'order',
    lrcUpdateInterval: null,

    parsedLyrics: [],
    currentLyricIndex: -1
  };


  function playCharSong(songIndex, playlist) {
    const player = document.getElementById('char-audio-player');
    const modal = document.getElementById('char-music-player-modal');

    if (charPlayerState.lrcUpdateInterval) clearInterval(charPlayerState.lrcUpdateInterval);
    player.pause();


    charPlayerState.currentPlaylist = playlist;

    charPlayerState.currentIndex = songIndex;

    const songObject = playlist[songIndex];
    if (!songObject) {
      console.error("playCharSong: Ê≠åÊõ≤Á¥¢ÂºïÊó†ÊïàÊàñÊ≠åÂçï‰∏∫Á©∫„ÄÇ");
      return;
    }

    document.getElementById('char-music-player-title').textContent = songObject.name;
    document.getElementById('char-music-artist').textContent = songObject.artist;
    document.getElementById('char-music-cover').src = songObject.cover;


    charPlayerState.parsedLyrics = parseLRC(songObject.lrcContent || "");
    renderCharLyrics();


    if (songObject.isLocal) {
      const blob = new Blob([songObject.src], {
        type: songObject.fileType || 'audio/mpeg'
      });
      player.src = URL.createObjectURL(blob);
    } else {
      player.src = songObject.src;
    }
    player.play().catch(e => console.error("Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:", e));

    player.onloadedmetadata = () => {
      document.getElementById('char-music-total-time').textContent = formatMusicTime(player.duration);
      charPlayerState.lrcUpdateInterval = setInterval(updateCharMusicProgress, 1000);
    };

    modal.classList.add('visible');
  }


  function minimizeCharMusicPlayer() {
    const modal = document.getElementById('char-music-player-modal');
    modal.classList.remove('visible');

    document.getElementById('char-music-restore-btn').style.display = 'flex';
  }


  function restoreCharMusicPlayer() {
    const modal = document.getElementById('char-music-player-modal');
    modal.classList.add('visible');

    document.getElementById('char-music-restore-btn').style.display = 'none';
  }


  function closeCharMusicPlayer() {
    const modal = document.getElementById('char-music-player-modal');
    const player = document.getElementById('char-audio-player');

    if (charPlayerState.lrcUpdateInterval) clearInterval(charPlayerState.lrcUpdateInterval);
    player.pause();
    // player.src = ''; // Âª∫ËÆÆÊ≥®ÈáäÊéâËøôË°åÔºåÈò≤Ê≠¢‰∏ãÊ¨°ÊâìÂºÄË¶ÅÈáçÊñ∞Âä†ËΩΩÔºåÊàñËÄÖ‰øùÁïôÁúã‰Ω†ÈúÄÊ±Ç

    modal.classList.remove('visible');
    charPlayerState.isPlaying = false;
    document.getElementById('char-vinyl-container').classList.remove('spinning');


    document.getElementById('char-music-restore-btn').style.display = 'none';
  }


  function updateCharMusicProgress() {
    const player = document.getElementById('char-audio-player');
    if (!player.duration) return;

    const currentTime = player.currentTime;
    const duration = player.duration;
    document.getElementById('char-music-progress-fill').style.width = `${(currentTime / duration) * 100}%`;
    document.getElementById('char-music-current-time').textContent = formatMusicTime(currentTime);


    updateCharActiveLyric(currentTime);
  }



  function renderCharLyrics() {
    const lyricsContainer = document.getElementById('char-music-lyrics');
    lyricsContainer.innerHTML = '';
    charPlayerState.currentLyricIndex = -1;


    const scrollWrapper = document.createElement('div');
    scrollWrapper.id = 'char-lyrics-scroll-wrapper';
    scrollWrapper.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    lyricsContainer.appendChild(scrollWrapper);

    if (!charPlayerState.parsedLyrics || charPlayerState.parsedLyrics.length === 0) {
      scrollWrapper.innerHTML = '<p>‚ô™ ÊöÇÊó†Ê≠åËØç ‚ô™</p>';
      return;
    }
    charPlayerState.parsedLyrics.forEach((line, index) => {
      const p = document.createElement('p');
      p.textContent = line.text;
      p.dataset.index = index;

      p.style.margin = '0';
      p.style.padding = '5px 0';
      p.style.color = '#888';
      p.style.transition = 'all 0.3s';
      scrollWrapper.appendChild(p);
    });
  }

  function updateCharActiveLyric(currentTime) {
    const lyrics = charPlayerState.parsedLyrics;
    if (lyrics.length === 0) return;

    let newLyricIndex = -1;
    for (let i = 0; i < lyrics.length; i++) {
      if (currentTime >= lyrics[i].time) {
        newLyricIndex = i;
      } else {
        break;
      }
    }
    if (newLyricIndex === charPlayerState.currentLyricIndex) return;
    charPlayerState.currentLyricIndex = newLyricIndex;


    const wrapper = document.getElementById('char-lyrics-scroll-wrapper');
    if (!wrapper) return;

    const lines = wrapper.querySelectorAll('p');
    lines.forEach(line => {
      line.classList.remove('active');
      line.style.color = '#888';
      line.style.transform = 'scale(1)';
    });

    if (newLyricIndex > -1) {
      const activeLine = wrapper.querySelector(`p[data-index="${newLyricIndex}"]`);
      if (activeLine) {
        activeLine.classList.add('active');
        activeLine.style.color = '#333';
        activeLine.style.fontWeight = 'bold';
        activeLine.style.transform = 'scale(1.1)';

        const containerHeight = document.getElementById('char-music-lyrics').clientHeight;
        const offset = (containerHeight / 2) - activeLine.offsetTop - (activeLine.clientHeight / 2);

        wrapper.style.transform = `translateY(${offset}px)`;
      }
    }
  }



  function playNextCharSong() {
    if (charPlayerState.currentPlaylist.length === 0) return;
    let nextIndex;
    switch (charPlayerState.playMode) {
      case 'random':
        nextIndex = Math.floor(Math.random() * charPlayerState.currentPlaylist.length);
        break;
      case 'single':

        playCharSong(charPlayerState.currentPlaylist[charPlayerState.currentIndex]);
        return;
      case 'order':
      default:
        nextIndex = (charPlayerState.currentIndex + 1) % charPlayerState.currentPlaylist.length;
        break;
    }
    playCharSong(nextIndex, charPlayerState.currentPlaylist);
  }

  function playPrevCharSong() {
    if (charPlayerState.currentPlaylist.length === 0) return;
    const newIndex = (charPlayerState.currentIndex - 1 + charPlayerState.currentPlaylist.length) % charPlayerState.currentPlaylist.length;
    playCharSong(newIndex, charPlayerState.currentPlaylist);
  }

  function changeCharPlayMode() {
    const modes = ['order', 'random', 'single'];
    const currentModeIndex = modes.indexOf(charPlayerState.playMode);
    charPlayerState.playMode = modes[(currentModeIndex + 1) % modes.length];
    document.getElementById('char-music-mode-btn').textContent = {
      'order': 'È°∫Â∫è',
      'random': 'ÈöèÊú∫',
      'single': 'ÂçïÊõ≤'
    }[charPlayerState.playMode];
  }



  function setupCharPlayerControls() {
    const player = document.getElementById('char-audio-player');
    const playBtn = document.getElementById('char-music-play-pause-btn');
    const vinyl = document.getElementById('char-vinyl-container');

    playBtn.addEventListener('click', () => {
      if (player.paused) {
        if (charPlayerState.currentIndex > -1) player.play();
      } else {
        player.pause();
      }
    });

    player.onplay = () => {
      playBtn.innerHTML = `<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;
      vinyl.classList.add('spinning');
      charPlayerState.isPlaying = true;
    };
    player.onpause = () => {
      playBtn.innerHTML = `<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>`;
      vinyl.classList.remove('spinning');
      charPlayerState.isPlaying = false;
    };
    player.onended = () => {
      vinyl.classList.remove('spinning');
      charPlayerState.isPlaying = false;
      playNextCharSong();
    };

    document.getElementById('char-music-prev-btn').addEventListener('click', playPrevCharSong);
    document.getElementById('char-music-next-btn').addEventListener('click', playNextCharSong);
    document.getElementById('char-music-mode-btn').addEventListener('click', changeCharPlayMode);

    document.getElementById('char-music-progress-bar').addEventListener('click', (e) => {
      if (!player.duration) return;
      const bar = e.currentTarget;
      const clickX = e.offsetX;
      player.currentTime = (clickX / bar.clientWidth) * player.duration;
    });
  }

  async function renderDoubanScreen() {
    const listEl = document.getElementById('douban-posts-list');
    listEl.innerHTML = '';

    const posts = await db.doubanPosts.orderBy('timestamp').reverse().toArray();

    if (posts.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåÁ©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÔºåÁúãÁúãÂ§ßÂÆ∂ÈÉΩÂú®ËÅä‰ªÄ‰πàÂêßÔºÅ</p>';
      return;
    }

    posts.forEach(post => {
      let avatarUrl;


      const authorChatByOriginalName = post.authorOriginalName ?
        Object.values(state.chats).find(c => !c.isGroup && c.name === post.authorOriginalName) :
        null;

      if (authorChatByOriginalName) {

        avatarUrl = authorChatByOriginalName.settings.aiAvatar;
      } else {

        const authorChatByName = Object.values(state.chats).find(c => !c.isGroup && c.name === post.authorName);
        if (authorChatByName) {
          avatarUrl = authorChatByName.settings.aiAvatar;
        } else if (post.authorAvatarPrompt) {

          avatarUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(post.authorAvatarPrompt)}`;
        } else {

          avatarUrl = defaultAvatar;
        }
      }


      const itemEl = document.createElement('div');
      itemEl.className = 'douban-post-item';
      itemEl.onclick = () => openDoubanPostDetail(post.id);

      itemEl.innerHTML = `
            <div class="douban-post-header">
                <img src="${avatarUrl}" class="douban-post-avatar">
                <div class="douban-author-info">
                    <div class="douban-author-name">${post.authorName}</div>
                    <div class="douban-group-name">Êù•Ëá™ ${post.groupName}</div>
                </div>
            </div>
            <div class="douban-post-title">${post.postTitle}</div>
            <div class="douban-post-content">${post.content.replace(/\n/g, '<br>')}</div>
            <div class="douban-post-footer">
                 <div class="douban-post-actions">
                    <span><svg viewBox="0 0 1024 1024"><path d="M170.666667 170.666667h128v682.666666h-128zM426.666667 170.666667h170.666666v682.666666h-170.666666zM725.333333 170.666667h128v682.666666h-128z"></path></svg> ${post.likesCount}</span>
                    <span><svg viewBox="0 0 1024 1024"><path d="M853.333333 85.333333H170.666667c-46.933333 0-85.333333 38.4-85.333334 85.333334v512c0 46.933333 38.4 85.333333 85.333334 85.333333h512l170.666667 170.666667V170.666667c0-46.933333-38.4-85.333333-85.333334-85.333334z m-42.666666 554.666667H170.666667V170.666667h640v469.333333zM256 384h512v85.333333H256V384z m0-170.666667h512v85.333334H256v-85.333334z"></path></svg> ${post.commentsCount}</span>
                </div>
                <span class="douban-post-timestamp">${formatTimeAgo(post.timestamp)}</span>
            </div>
        `;
      listEl.appendChild(itemEl);
    });
  }



  async function handleGenerateDoubanPosts() {
    const activeCharacterIds = state.globalSettings.doubanActiveCharacterIds || [];

    if (activeCharacterIds.length === 0) {
      await showCustomAlert("ËØ∑ÂÖàÈÄâÊã©ËßíËâ≤", "ËØ∑ÁÇπÂáªÂè≥‰∏äËßíÁöÑ‚ÄúËßíËâ≤ÈÄâÊã©‚ÄùÊåâÈíÆÔºåÈÄâÊã©Ëá≥Â∞ë‰∏Ä‰∏™ÂèÇ‰∏éË±ÜÁì£‰∫íÂä®ÁöÑËßíËâ≤„ÄÇ");
      return;
    }

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®‰∏∫ÊÇ®ÈÄâÊã©ÁöÑ ${activeCharacterIds.length} ‰ΩçËßíËâ≤ÁîüÊàêË±ÜÁì£Âä®ÊÄÅ...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const allLinkedBookIds = new Set();
    activeCharacterIds.forEach(charId => {
      const c = state.chats[charId];
      if (c && c.settings.linkedWorldBookIds) {
        c.settings.linkedWorldBookIds.forEach(bookId => allLinkedBookIds.add(bookId));
      }
    });

    // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
    state.worldBooks.forEach(wb => {
      if (wb.isGlobal) {
        allLinkedBookIds.add(wb.id);
      }
    });

    let sharedWorldBookContext = '';
    if (allLinkedBookIds.size > 0) {
      sharedWorldBookContext += '\n\n# Áªü‰∏Ä‰∏ñÁïåËßÇËÆæÂÆö (‰ª•‰∏ãËÆæÂÆöÈÄÇÁî®‰∫éÊâÄÊúâÂèÇ‰∏éËßíËâ≤)\n';
      allLinkedBookIds.forEach(bookId => {
        const book = state.worldBooks.find(wb => wb.id === bookId);
        if (book) {
          const enabledEntries = book.content
            .filter(e => e.enabled !== false)
            .map(e => `- ${e.content}`)
            .join('\n');
          if (enabledEntries) {
            sharedWorldBookContext += `\n## Êù•Ëá™„Ää${book.name}„Äã:\n${enabledEntries}`;
          }
        }
      });
    }

    const doubanWorldBook = state.worldBooks.find(wb => wb.name === 'Ë±ÜÁì£ËÆæÂÆö');
    let doubanSettingContext = '';
    let npcCharacters = [];
    if (doubanWorldBook) {
      doubanWorldBook.content.forEach(entry => {
        if (entry.comment.includes('Â∞èÁªÑÈ£éÊ†º')) {
          doubanSettingContext += `\n# Ë±ÜÁì£Á§æÂå∫È£éÊ†ºËÆæÂÆö (Êù•Ëá™‰∏ñÁïå‰π¶)\n${entry.content}`;
        }
        if (entry.comment.includes('NPC‰∫∫ËÆæ')) {
          const lines = entry.content.split('\n');
          lines.forEach(line => {
            const match = line.match(/- \*\*ÊòµÁß∞\*\*:\s*(.*?)\s*\*\*‰∫∫ËÆæ\*\*:\s*(.*)/);
            if (match) {
              npcCharacters.push({
                name: match[1].trim(),
                persona: match[2].trim()
              });
            }
          });
        }
      });
    }

    const userNickname = state.qzoneSettings.nickname || 'Êàë';
    const userPersona = activeCharacterIds.length > 0 && state.chats[activeCharacterIds[0]] ?
      state.chats[activeCharacterIds[0]].settings.myPersona :
      '(Êú™ËÆæÁΩÆ)';

    let charactersContext = '';
    activeCharacterIds.forEach(charId => {
      const c = state.chats[charId];
      if (c) {
        const longTermMemory = c.longTermMemory && c.longTermMemory.length > 0 ? c.longTermMemory.map(m => m.content).join('; ') : 'Êó†';
        const recentHistory = c.history.slice(-10).map(msg =>
          `${msg.role === 'user' ? userNickname : c.name}: ${String(msg.content).substring(0, 30)}...`
        ).join('\n');

        charactersContext += `
<character>
  <name>${c.name}</name>
  <persona>${c.settings.aiPersona}</persona>
  <memory>${longTermMemory}</memory>
  <recent_dialogue_with_user>${recentHistory}</recent_dialogue_with_user>
</character>
`;
      }
    });
    npcCharacters.forEach(npc => {
      charactersContext += `
<character>
  <name>${npc.name}</name>
  <persona>${npc.persona}</persona>
</character>
`;
    });

    const now = new Date();
    const currentTimeString = now.toLocaleString('zh-CN', {
      dateStyle: 'full',
      timeStyle: 'short'
    });
    const minPosts = state.globalSettings.doubanMinPosts || 12;
    const maxPosts = state.globalSettings.doubanMaxPosts || 20;
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁ§æÂå∫ÂÜÖÂÆπÁîüÊàêÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆ‰∏ãÈù¢Êèê‰æõÁöÑ„ÄêÁªü‰∏ÄËßíËâ≤ÂàóË°®„ÄëÔºåËôöÊûÑÂá∫„Äê${minPosts}Âà∞${maxPosts}ÁØá„Äë‰ªñ‰ª¨ÊúÄËøëÂèØËÉΩ‰ºöÂú®ÂêÑÁßçË±ÜÁì£Â∞èÁªÑ‰∏≠ÂèëÂ∏ÉÁöÑÂ∏ñÂ≠êÂíåËØÑËÆ∫„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêÊó∂Èó¥ÊÑüÁü•„Äë**:
    -   ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊÑèËØÜÂà∞ÂΩìÂâçÊòØ **${currentTimeString}**„ÄÇ
    -   ‰Ω†ÁöÑÂ∏ñÂ≠êÂíåËØÑËÆ∫ÂÜÖÂÆπ„ÄêÂøÖÈ°ª„ÄëËá™ÁÑ∂Âú∞‰ΩìÁé∞Âá∫ÂØπ„ÄêÂΩìÂâçÁúüÂÆûÊó∂Èó¥„ÄëÁöÑÊÑüÁü•„ÄÇ
2.  **„ÄêÁ¶ÅÊ≠¢ÊâÆÊºîÁî®Êà∑ (ÊúÄÊúÄÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºÅÔºÅÔºÅ)„Äë**:
    -   Áî®Êà∑ÁöÑÊòµÁß∞ÊòØ‚Äú${userNickname}‚Äù„ÄÇ
    -   ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê authorName Êàñ commenter Â≠óÊÆµ‰∏∫ ‚Äú${userNickname}‚Äù ÁöÑÂ∏ñÂ≠êÊàñËØÑËÆ∫„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑÊâÄÊúâËßíËâ≤„ÄÇ
3.  **„ÄêË∫´‰ªΩ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºÅ)„Äë**: 
    -   \`authorName\`: ‰Ω†ÂèØ‰ª•‰∏∫‰∏ªË¶ÅËßíËâ≤Ëµ∑‰∏Ä‰∏™Á¨¶ÂêàÊÉÖÊôØÁöÑ„ÄÅ‰∏¥Êó∂ÁöÑ„ÄêÂèëÂ∏ñÊòµÁß∞„ÄëÔºå‰πüÂèØ‰ª•Áõ¥Êé•‰ΩøÁî®‰ªñ‰ª¨ÁöÑÊú¨Âêç„ÄÇ
    -   \`authorOriginalName\`: Â¶ÇÊûúÂèëÂ∏ñËÄÖÊòØ„Äê‰∏ªË¶ÅËßíËâ≤„ÄëÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂú®ËøôÈáåÂ°´‰∏äTAÂú®ËßíËâ≤ÂàóË°®ÈáåÁöÑ„ÄêÂéüÂßãÂ§áÊ≥®Âêç„ÄëÔºåËøôÊòØÁ®ãÂ∫èÁöÑ‚ÄúË∫´‰ªΩËØÅ‚Äù„ÄÇ
    -   Â¶ÇÊûúÂèëÂ∏ñËÄÖÊòØ„ÄêË∑Ø‰∫∫NPC„ÄëÔºåÂàô„ÄêÁúÅÁï•„Äë\`authorOriginalName\` Â≠óÊÆµ„ÄÇ
4.  **„Äê‰ΩúËÄÖÂπ≥Ë°°„Äë**: Â∏ñÂ≠êÁöÑ‰ΩúËÄÖ„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑ \`<character>\` ÂàóË°®‰∏≠„ÄêÂùáÂåÄÂú∞„ÄÅÂ§öÊ†∑ÂåñÂú∞„ÄëÈÄâÊã©„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„ÄëÁ°Æ‰øùÂ∏ñÂ≠êÂàóË°®‰∏≠„ÄêËá≥Â∞ëÊúâ 70% ÁöÑÂ∏ñÂ≠êÊòØÁî±Ë∑Ø‰∫∫NPCÂèëÂ∏ÉÁöÑ„ÄëÔºå‰ª•Ëê•ÈÄ†‰∏Ä‰∏™ÁúüÂÆûÁöÑÁ§æÂå∫Ê∞õÂõ¥„ÄÇ
    - "comments": ‰∏Ä‰∏™ÂåÖÂê´„Äê7Âà∞12Êù°„ÄëËØÑËÆ∫ÁöÑÊï∞ÁªÑ„ÄÇËØÑËÆ∫ËÄÖÂèØ‰ª•ÊòØË∑Ø‰∫∫Ôºå‰πüÂèØ‰ª•ÊòØËßíËâ≤ÂàóË°®‰∏≠ÁöÑÂÖ∂‰ªñËßíËâ≤Ôºå‰ª•‰ΩìÁé∞‰∫íÂä®ÊÄß„ÄÇ
5.  **„ÄêËßíËâ≤ÊâÆÊºî„Äë**: Â∏ñÂ≠êÁöÑ‰ΩúËÄÖÂíåÂÜÖÂÆπ„ÄêÂøÖÈ°ª„ÄëÊ∑±Â∫¶ÁªìÂêàËØ•ËßíËâ≤ÁöÑ<persona>, <memory>, Âíå <worldview>„ÄÇ
6.  **„Äê‚ÄúË±ÜÁì£Âë≥‚ÄùÂÜÖÂÆπÈ£éÊ†ºÊåáÂçó„Äë**: Â∏ñÂ≠êÈ£éÊ†ºÂøÖÈ°ªÂ§öÊ†∑Âåñ‰∏îÂÖÖÊª°ÁîüÊ¥ªÊ∞îÊÅØÔºÅ‰Ω†ÈúÄË¶ÅÁîüÊàêÂåÖÊã¨‰ΩÜ‰∏çÈôê‰∫éÔºöÊÉÖÊÑüÊ†ëÊ¥û„ÄÅÁîüÊ¥ªÂêêÊßΩ„ÄÅÂêÉÁìúÂÖ´Âç¶„ÄÅÂÖ¥Ë∂£ÂàÜ‰∫´„ÄÅÊó†Áî®ËâØÂìÅÁ≠âÂêÑÁßçÁ±ªÂûãÁöÑÂ∏ñÂ≠ê„ÄÇ
7.  **„ÄêÂ§¥ÂÉèÁîüÊàê (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºÅ)„Äë**:
    -   ‰∏∫ÊØè‰∏Ä‰∏™„ÄêÈ¶ñÊ¨°Âá∫Áé∞„ÄëÁöÑË∑Ø‰∫∫NPCÔºàÊó†ËÆ∫ÊòØÂèëÂ∏ñËøòÊòØËØÑËÆ∫ÔºâÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„Äë‰∏∫ÂÖ∂Ê∑ªÂä†‰∏Ä‰∏™ \`avatar_prompt\` Â≠óÊÆµ„ÄÇ
    -   Ëøô‰∏™Â≠óÊÆµÁöÑÂÜÖÂÆπÊòØÁî®‰∫éÁîüÊàêËØ•NPCÂ§¥ÂÉèÁöÑ„ÄÅÁÆÄÊ¥ÅÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç„ÄÇ
    -   ‰∏çÂêåÁöÑNPC„ÄêÂøÖÈ°ª„ÄëÊúâ‰∏çÂêåÁöÑÂ§¥ÂÉèÊåá‰ª§Ôºå‰ª•Á°Æ‰øù‰ªñ‰ª¨ÁöÑÂ§¥ÂÉèÊòØÁã¨‰∏ÄÊó†‰∫åÁöÑ„ÄÇ
8.  **„ÄêÂ§¥ÂÉè‰∏ÄËá¥ÊÄß (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ)„Äë**:
    -   Â¶ÇÊûú‰∏Ä‰∏™Ë∑Ø‰∫∫NPCÂú®Âêå‰∏Ä‰∏™Â∏ñÂ≠ê‰∏≠Â§öÊ¨°Âá∫Áé∞Ôºà‰æãÂ¶ÇÔºåÊó¢ÊòØÂèëÂ∏ñ‰∫∫ÂèàÊòØËØÑËÆ∫ËÄÖÔºåÊàñÂ§öÊ¨°ËØÑËÆ∫ÔºâÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏∫TAÁöÑÊâÄÊúâÂá∫Áé∞ÈÉΩ‰ΩøÁî®„ÄêÂÆåÂÖ®Áõ∏Âêå„ÄëÁöÑ \`avatar_prompt\`„ÄÇËøôËá≥ÂÖ≥ÈáçË¶ÅÔºÅ
9.  **„ÄêÊ†ºÂºè (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏ÄÁØáÂ∏ñÂ≠êÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "groupName": "‰∏Ä‰∏™ÁîüÂä®ÊúâË∂£ÁöÑÂ∞èÁªÑÂêçÁß∞",
        "postTitle": "‰∏Ä‰∏™Âºï‰∫∫-Ê≥®ÁõÆÁöÑÂ∏ñÂ≠êÊ†áÈ¢ò",
        "authorName": "ÂèëÂ∏ñËßíËâ≤ÁöÑ„ÄêÂ§áÊ≥®Âêç„Äë",
        "authorOriginalName": "(‰ªÖÂΩìÂèëÂ∏ñËÄÖÊòØ‰∏ªË¶ÅËßíËâ≤Êó∂„ÄêÂøÖÈ°ª„ÄëÊèê‰æõ) TAÁöÑÂéüÂßãÂ§áÊ≥®Âêç",
        "authorAvatarPrompt": "(‰ªÖÂΩìÂèëÂ∏ñËÄÖÊòØË∑Ø‰∫∫NPCÊó∂„ÄêÂøÖÈ°ª„ÄëÊèê‰æõ) ‰∏ÄÊÆµÁî®‰∫éÁîüÊàêËØ•NPCÂ§¥ÂÉèÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç„ÄÇÈ£éÊ†º‰∏∫ anime style, simple background",
        "content": "Â∏ñÂ≠êÁöÑËØ¶ÁªÜÊ≠£ÊñáÔºåÂøÖÈ°ªÊîØÊåÅÊç¢Ë°åÁ¨¶\\n„ÄÇ",
        "likesCount": 152,
        "commentsCount": 38,
        "comments": [
            { "commenter": "Ë∑Ø‰∫∫Áî≤", "text": "ËøôÊòØ‰∏Ä‰∏™Ë∑Ø‰∫∫ËØÑËÆ∫„ÄÇ", "avatar_prompt": "cute cat avatar, simple, flat" },
            { "commenter": "Âè¶‰∏Ä‰∏™ËßíËâ≤Âêç", "commenterOriginalName": "(Â¶ÇÊûúËØÑËÆ∫ËÄÖÊòØ‰∏ªË¶ÅËßíËâ≤ÔºåÂøÖÈ°ªÊèê‰æõÂÖ∂Êú¨Âêç)", "text": "ËøôÊòØ‰∏Ä‰∏™Êù•Ëá™ÂÖ∂‰ªñËßíËâ≤ÁöÑ‰∫íÂä®ËØÑËÆ∫„ÄÇ" }
        ]
      }
    ]
    \`\`\`
    - **comments**: 
        -   ËØÑËÆ∫ËÄÖÂèØ‰ª•ÊòØË∑Ø‰∫∫Ôºå‰πüÂèØ‰ª•ÊòØËßíËâ≤ÂàóË°®‰∏≠ÁöÑÂÖ∂‰ªñËßíËâ≤„ÄÇËØÑËÆ∫Âå∫„ÄêÂøÖÈ°ª„Äë‰ΩìÁé∞Âá∫‰∫íÂä®ÊÄß„ÄÇ
        -   „ÄêËØÑËÆ∫Ë∫´‰ªΩ„Äë: Â¶ÇÊûúËØÑËÆ∫ËÄÖÊòØ„Äê‰∏ªË¶ÅËßíËâ≤„ÄëÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏∫ÂÖ∂Ê∑ªÂä† \`commenterOriginalName\` Â≠óÊÆµÔºåÂπ∂Â°´ÂÖ•ÂÖ∂Êú¨Âêç„ÄÇÂ¶ÇÊûúÊòØË∑Ø‰∫∫NPCÔºåÂàôÁúÅÁï•Ê≠§Â≠óÊÆµ„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
${doubanSettingContext}
${sharedWorldBookContext}

# ÂΩìÂâçÊÉÖÊôØ
- **ÂΩìÂâçÁúüÂÆûÊó∂Èó¥**: ${currentTimeString}

# „Äê‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑË∫´‰ªΩÊ°£Ê°à„Äë
- **ÊòµÁß∞**: ${userNickname}
- **‰∫∫ËÆæ**: ${userPersona}

# Áªü‰∏ÄËßíËâ≤ÂàóË°® (‰Ω†ÊâÆÊºîÁöÑËßíËâ≤ + Ë∑Ø‰∫∫NPC)
${charactersContext}

Áé∞Âú®ÔºåËØ∑‰∏•Ê†ºÈÅµÂÆàÊâÄÊúâËßÑÂàôÔºåÁâπÂà´ÊòØ„ÄêÊó∂Èó¥ÊÑüÁü•„ÄëÂíå„ÄêÁ¶ÅÊ≠¢ÊâÆÊºîÁî®Êà∑„ÄëÁöÑÈìÅÂæãÔºåÂºÄÂßãÁîüÊàêËøôÁªÑÁîüÂä®„ÄÅÂ§öÊ†∑‰∏îÂÖÖÊª°‚ÄúË±ÜÁì£Âë≥‚ÄùÁöÑÂ∞èÁªÑÂ∏ñÂ≠ê„ÄÇ`;

    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆËßíËâ≤ÂàóË°®ÔºåÁîüÊàêË±ÜÁì£Â∞èÁªÑÂ∏ñÂ≠ê„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 1.0,
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      const jsonMatch = aiResponseContent.match(/\[[\s\S]*\]/);

      if (!jsonMatch) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }

      const simulatedPosts = JSON.parse(jsonMatch[0]);
      await db.doubanPosts.clear();
      await db.doubanPosts.bulkAdd(simulatedPosts.map(p => ({
        ...p,
        timestamp: Date.now() - Math.random() * 100000
      })));

      await renderDoubanScreen();

    } catch (error) {
      console.error("ÁîüÊàêË±ÜÁì£Â∏ñÂ≠êÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÂÜÖÂÆπÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }


  async function openDoubanPostDetail(postId) {
    showScreen('douban-post-detail-screen');
    activeDoubanPostId = postId;
    const post = await db.doubanPosts.get(postId);
    if (!post) {
      showScreen('douban-screen');
      return;
    }

    document.getElementById('douban-post-detail-title').textContent = 'Â∏ñÂ≠êËØ¶ÊÉÖ';


    let authorAvatar = defaultAvatar;
    let authorDisplayName = post.authorName;

    const authorChatByOriginalName = post.authorOriginalName ?
      Object.values(state.chats).find(c => !c.isGroup && c.originalName === post.authorOriginalName) :
      null;

    if (authorChatByOriginalName) {
      authorAvatar = authorChatByOriginalName.settings.aiAvatar;
    } else {
      const authorChatByName = Object.values(state.chats).find(c => !c.isGroup && c.name === post.authorName);
      if (authorChatByName) {
        authorAvatar = authorChatByName.settings.aiAvatar;
      } else if (post.authorAvatarPrompt) {
        authorAvatar = `https://image.pollinations.ai/prompt/${encodeURIComponent(post.authorAvatarPrompt)}`;
      }
    }


    document.getElementById('douban-detail-avatar').src = authorAvatar;
    document.getElementById('douban-detail-author').textContent = authorDisplayName;
    document.getElementById('douban-detail-group').textContent = `Êù•Ëá™ ${post.groupName}`;
    document.getElementById('douban-detail-post-title').textContent = post.postTitle;
    document.getElementById('douban-detail-content').innerHTML = post.content.replace(/\n/g, '<br>');
    document.getElementById('douban-my-comment-avatar').src = state.qzoneSettings.avatar;
    document.getElementById('douban-comment-input').value = '';

    const commentsListEl = document.getElementById('douban-detail-comments-list');
    commentsListEl.innerHTML = '';


    if (post.comments && post.comments.length > 0) {

      const commenterAvatarMap = new Map();

      post.comments.forEach(comment => {
        let commenterAvatar = defaultAvatar;
        const myNickname = state.qzoneSettings.nickname || 'Êàë';
        const commenterName = comment.commenter;

        if (commenterAvatarMap.has(commenterName)) {

          commenterAvatar = commenterAvatarMap.get(commenterName);
        } else {

          if (commenterName === myNickname) {
            commenterAvatar = state.qzoneSettings.avatar;
          } else if (commenterName === post.authorName) {
            commenterAvatar = authorAvatar;
          } else {
            const commenterChatByOriginalName = comment.commenterOriginalName ?
              Object.values(state.chats).find(c => !c.isGroup && c.originalName === comment.commenterOriginalName) :
              null;

            if (commenterChatByOriginalName) {
              commenterAvatar = commenterChatByOriginalName.settings.aiAvatar;
            } else {
              const commenterChatByName = Object.values(state.chats).find(c => !c.isGroup && c.name === commenterName);
              if (commenterChatByName) {
                commenterAvatar = commenterChatByName.settings.aiAvatar;
              } else if (comment.avatar_prompt) {
                commenterAvatar = `https://image.pollinations.ai/prompt/${encodeURIComponent(comment.avatar_prompt)}`;
              }
            }
          }

          commenterAvatarMap.set(commenterName, commenterAvatar);
        }

        const commentEl = document.createElement('div');
        commentEl.className = 'douban-comment-item';
        commentEl.innerHTML = `
                <img src="${commenterAvatar}" class="douban-comment-avatar">
                <div class="douban-comment-body">
                    <div class="douban-comment-author">${commenterName}</div>
                    <div class="douban-comment-text">${comment.text.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        commentsListEl.appendChild(commentEl);
      });
    } else {
      commentsListEl.innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">ËøòÊ≤°ÊúâÂõûÂ∫î</p>';
    }

    const contentWrapper = document.getElementById('douban-detail-content-wrapper');
    if (contentWrapper) contentWrapper.scrollTop = 0;
  }


  async function handleSendDoubanComment() {
    if (!activeDoubanPostId) return;

    const input = document.getElementById('douban-comment-input');
    const commentText = input.value.trim();
    if (!commentText) return;

    const post = await db.doubanPosts.get(activeDoubanPostId);
    if (!post) return;

    if (!post.comments) {
      post.comments = [];
    }

    const myNickname = state.qzoneSettings.nickname || 'Êàë';

    post.comments.push({
      commenter: myNickname,
      text: commentText
    });
    post.commentsCount++;

    await db.doubanPosts.put(post);
    input.value = '';


    await openDoubanPostDetail(activeDoubanPostId);


  }


  async function handleDoubanWaitReply() {
    if (!activeDoubanPostId) return;

    const postId = activeDoubanPostId;
    const post = await db.doubanPosts.get(postId);
    if (!post) return;

    const lastComment = post.comments && post.comments.slice(-1)[0];
    if (!lastComment) {
      alert("ËøòÊ≤°Êúâ‰ªª‰ΩïËØÑËÆ∫ÔºåÊó†Ê≥ïÁ≠âÂæÖÂõûÂ§ç„ÄÇ");
      return;
    }

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAIËßíËâ≤‰ª¨Âä†ÂÖ•ËÆ®ËÆ∫...");

    try {
      const {
        proxyUrl,
        apiKey,
        model
      } = state.apiConfig;
      if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂÜÖÂÆπ„ÄÇ');
      }

      const userNickname = state.qzoneSettings.nickname || 'Êàë';
      const userPersona = state.chats[Object.keys(state.chats)[0]]?.settings.myPersona || '(Êú™ËÆæÁΩÆ)';

      const existingNpcs = new Map();
      if (post.comments) {
        post.comments.forEach(comment => {
          const isMainCharacter = (state.globalSettings.doubanActiveCharacterIds || []).some(id => state.chats[id]?.name === comment.commenter);
          if (!isMainCharacter && comment.avatar_prompt) {
            existingNpcs.set(comment.commenter, comment.avatar_prompt);
          }
        });
      }

      let existingNpcContext = "# Â∑≤ÊúâË∑Ø‰∫∫NPCÂ§¥ÂÉèÊåá‰ª§ (ÂøÖÈ°ªÈÅµÂÆàÔºÅ)\n";
      if (existingNpcs.size > 0) {
        existingNpcContext += "Â¶ÇÊûú‰ª•‰∏ã‰ªª‰Ωï‰∏Ä‰ΩçNPCÂÜçÊ¨°ËØÑËÆ∫Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®Êàë‰ª¨Êèê‰æõÁöÑ„ÄÅÂÆåÂÖ®Áõ∏ÂêåÁöÑ`avatar_prompt`Ôºå‰ª•‰øùÊåÅÂ§¥ÂÉè‰∏ÄËá¥ÊÄß„ÄÇ\n";
        existingNpcs.forEach((prompt, name) => {
          existingNpcContext += `- **${name}**: "${prompt}"\n`;
        });
      } else {
        existingNpcContext += "ÔºàÂΩìÂâçÂ∏ñÂ≠êËøòÊ≤°ÊúâË∑Ø‰∫∫NPCÂèëË°®ËØÑËÆ∫„ÄÇÔºâ\n";
      }

      const doubanWorldBook = state.worldBooks.find(wb => wb.name === 'Ë±ÜÁì£ËÆæÂÆö');
      let npcCharacters = [];
      if (doubanWorldBook) {
        doubanWorldBook.content.forEach(entry => {
          if (entry.comment.includes('NPC‰∫∫ËÆæ')) {
            const lines = entry.content.split('\n');
            lines.forEach(line => {
              const match = line.match(/- \*\*ÊòµÁß∞\*\*:\s*(.*?)\s*\*\*‰∫∫ËÆæ\*\*:\s*(.*)/);
              if (match) {
                npcCharacters.push({
                  name: match[1].trim(),
                  persona: match[2].trim()
                });
              }
            });
          }
        });
      }

      let charactersContext = '';
      const activeCharacterIds = state.globalSettings.doubanActiveCharacterIds || [];
      activeCharacterIds.forEach(charId => {
        const c = state.chats[charId];
        if (c) {
          const longTermMemory = c.longTermMemory && c.longTermMemory.length > 0 ? c.longTermMemory.map(m => m.content).join('; ') : 'Êó†';
          const recentHistory = c.history.slice(-10).map(msg => `${msg.role === 'user' ? userNickname : c.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
          charactersContext += `\n- ${c.name}: ${c.settings.aiPersona.substring(0, 50)}... [ËÆ∞ÂøÜ: ${longTermMemory}] [ÊúÄËøëÂØπËØù: ${recentHistory}]`;
        }
      });
      npcCharacters.forEach(npc => {
        charactersContext += `\n- ${npc.name}: ${npc.persona}`;
      });


      const now = new Date();
      const currentTimeString = now.toLocaleString('zh-CN', {
        dateStyle: 'full',
        timeStyle: 'short'
      });


      const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁ§æÂå∫ÁöÑAIÂØºÊºî„ÄÇ‰∏ãÈù¢ÁöÑ‚ÄúÂ∏ñÂ≠êÊëòË¶Å‚ÄùÂíå‚ÄúÂ∑≤ÊúâËØÑËÆ∫‚ÄùÊù•Ëá™‰∫é‰∏Ä‰∏™Ë±ÜÁì£Â∞èÁªÑÁöÑÂ∏ñÂ≠ê„ÄÇÁî®Êà∑‚Äú${userNickname}‚ÄùÂàöÂàöÂØπÊúÄÂêé‰∏ÄÊù°ËØÑËÆ∫ÁÇπÂáª‰∫Ü‚ÄúÁ≠âÂæÖÂõûÂ§ç‚ÄùÔºåTAÂ∏åÊúõÁúãÂà∞Êõ¥Â§öËßíËâ≤ÂèÇ‰∏éËÆ®ËÆ∫„ÄÇ
‰Ω†ÁöÑ‰ªªÂä°ÊòØÔºöÊ†πÊçÆÊâÄÊúâËßíËâ≤ÁöÑËÆæÂÆöÔºåÈÄâÊã©„Äê10Âà∞20‰Ωç„ÄëÊúÄÈÄÇÂêàÂèÇ‰∏éËÆ®ËÆ∫ÁöÑËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨ÈíàÂØπÂ∑≤ÊúâËØÑËÆ∫ÔºåÂèëË°®„ÄêÂÖ®Êñ∞ÁöÑ„ÄÅÁ¨¶Âêà‰∫∫ËÆæÁöÑ„ÄëÂõûÂ∫î„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêÊó∂Èó¥ÊÑüÁü•„Äë**:
    -   ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊÑèËØÜÂà∞ÂΩìÂâçÊòØ **${currentTimeString}**„ÄÇ
    -   ‰Ω†ÁöÑËØÑËÆ∫ÂÜÖÂÆπ„ÄêÂøÖÈ°ª„ÄëËá™ÁÑ∂Âú∞‰ΩìÁé∞Âá∫ÂØπ„ÄêÂΩìÂâçÁúüÂÆûÊó∂Èó¥„ÄëÁöÑÊÑüÁü•„ÄÇ
2.  **„ÄêÁ¶ÅÊ≠¢ÊâÆÊºîÁî®Êà∑ (ÊúÄÊúÄÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºÅÔºÅÔºÅ)„Äë**:
    -   Áî®Êà∑ÁöÑÊòµÁß∞ÊòØ‚Äú${userNickname}‚Äù„ÄÇ
    -   ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê commenter Â≠óÊÆµ‰∏∫ ‚Äú${userNickname}‚Äù ÁöÑËØÑËÆ∫„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑÊâÄÊúâËßíËâ≤„ÄÇ
3.  **„Äê‰∫íÂä®„Äë**: Êñ∞ÁîüÊàêÁöÑËØÑËÆ∫„ÄêÂøÖÈ°ª„ÄëÊòØÈíàÂØπ„ÄêÂ∑≤ÊúâËØÑËÆ∫„ÄëÁöÑÂª∂Áª≠ÊàñÂõûÂ∫îÔºåËÆ©ËÆ®ËÆ∫ËÉΩÁªßÁª≠‰∏ãÂéª„ÄÇ
4.  **„ÄêÂ§¥ÂÉè‰∏ÄËá¥ÊÄß (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºÅ)„Äë**: ‰Ω†„ÄêÂøÖÈ°ª„ÄëÂèÇËÄÉ‰∏ãÈù¢ÁöÑ‚ÄúÂ∑≤ÊúâË∑Ø‰∫∫NPCÂ§¥ÂÉèÊåá‰ª§‚ÄùÂàóË°®„ÄÇÂ¶ÇÊûú‰∏Ä‰∏™Â∑≤ÊúâÁöÑNPCÂÜçÊ¨°ÂèëË®ÄÔºå„ÄêÂøÖÈ°ª„ÄëÂ§çÁî®ÂÆÉÊóßÁöÑÂ§¥ÂÉèÊåá‰ª§„ÄÇÂè™ÊúâÂú®ÂàõÈÄ†‰∏Ä‰∏™„ÄêÂÖ®Êñ∞ÁöÑ„ÄÅ‰ªéÊú™Âá∫Áé∞ËøáÁöÑ„ÄëNPCÊó∂ÔºåÊâç‰∏∫ÂÖ∂ÁîüÊàêÊñ∞ÁöÑÂ§¥ÂÉèÊåá‰ª§„ÄÇ
5.  **„ÄêÊ†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩ‰ª£Ë°®‰∏ÄÊù°Êñ∞ËØÑËÆ∫ÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      { "commenter": "ËßíËâ≤AÁöÑÂêçÂ≠ó", "text": "ËßíËâ≤AÁöÑÊñ∞ËØÑËÆ∫ÂÜÖÂÆπ„ÄÇ", "avatar_prompt": "(ÂèØÈÄâ)Â¶ÇÊûúËØÑËÆ∫ËÄÖÊòØ„ÄêÂÖ®Êñ∞ÁöÑ„ÄëNPC,Êèê‰æõÂ§¥ÂÉèÊåá‰ª§" },
      { "commenter": "ËßíËâ≤BÁöÑÂêçÂ≠ó", "text": "ËßíËâ≤BÂØπËßíËâ≤AÊàñÊ•º‰∏ªÁöÑÁúãÊ≥ï„ÄÇ" }
    ]
    \`\`\`

# ‰∏ä‰∏ãÊñá
- **Â∏ñÂ≠êÊ†áÈ¢ò**: „Ää${post.postTitle}„Äã
- **ÂèëÂ∏ñ‰∫∫**: ${post.authorName}
- **Â∏ñÂ≠êÂÜÖÂÆπÊëòË¶Å**: ${post.content.substring(0, 100)}...
- **Â∑≤ÊúâËØÑËÆ∫**:
${post.comments.map(c => `- ${c.commenter}: ${c.text}`).join('\n')}

${existingNpcContext}

# ÂΩìÂâçÊÉÖÊôØ
- **ÂΩìÂâçÁúüÂÆûÊó∂Èó¥**: ${currentTimeString}

# „Äê‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ„Äë
- **ÊòµÁß∞**: ${userNickname}
- **‰∫∫ËÆæ**: ${userPersona}

# ‰Ω†ÁöÑËßíËâ≤Â∫ì (‰Ω†ÂèØ‰ª•‰ªé‰∏≠ÈÄâÊã©„Äê‰ªª‰ΩïËßíËâ≤„ÄëËøõË°åËØÑËÆ∫ÔºåÂπ∂ÂèÇËÄÉ‰ªñ‰ª¨ÁöÑËÆ∞ÂøÜÂíåÂØπËØù)
${charactersContext}

Áé∞Âú®ÔºåËØ∑ÁîüÊàêÊñ∞ÁöÑËØÑËÆ∫„ÄÇ`;

      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äÊÉÖÊôØÔºåÁîüÊàêÊñ∞ÁöÑËØÑËÆ∫„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 1.0,
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
      const newComments = JSON.parse(cleanedJson);

      if (Array.isArray(newComments) && newComments.length > 0) {
        post.comments.push(...newComments);
        post.commentsCount += newComments.length;
        await db.doubanPosts.put(post);
      }

      await openDoubanPostDetail(postId);

      hideCustomModal();

    } catch (error) {
      console.error("Á≠âÂæÖÂõûÂ§çÂ§±Ë¥•:", error);
      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `Êó†Ê≥ïËé∑ÂèñAIÂõûÂ§çÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }



  async function openDoubanCastSelector() {
    const modal = document.getElementById('douban-cast-modal');
    const listEl = document.getElementById('douban-cast-list');
    listEl.innerHTML = '';

    const allCharacters = Object.values(state.chats).filter(c => !c.isGroup);

    const activeIds = new Set(state.globalSettings.doubanActiveCharacterIds || []);

    if (allCharacters.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; padding: 50px 0;">ËøòÊ≤°ÊúâÂèØ‰ª•ÂèÇ‰∏éÁöÑËßíËâ≤„ÄÇ</p>';
    } else {
      allCharacters.forEach(char => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.innerHTML = `
                <input type="checkbox" class="douban-cast-checkbox" data-chat-id="${char.id}" ${activeIds.has(char.id) ? 'checked' : ''} style="margin-right: 15px;">
                <img src="${char.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${char.name}</span>
            `;
        listEl.appendChild(item);
      });
    }
    modal.classList.add('visible');
  }


  async function saveDoubanCastSelection() {
    const selectedCheckboxes = document.querySelectorAll('#douban-cast-list .douban-cast-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.chatId);


    state.globalSettings.doubanActiveCharacterIds = selectedIds;
    await db.globalSettings.put(state.globalSettings);

    document.getElementById('douban-cast-modal').classList.remove('visible');


    await handleGenerateDoubanPosts();
  }



  document.getElementById('douban-cast-select-btn').addEventListener('click', openDoubanCastSelector);
  document.getElementById('cancel-douban-cast-btn').addEventListener('click', () => {
    document.getElementById('douban-cast-modal').classList.remove('visible');
  });
  document.getElementById('save-douban-cast-btn').addEventListener('click', saveDoubanCastSelection);

  document.getElementById('douban-cast-list').addEventListener('click', (e) => {
    const item = e.target.closest('.contact-picker-item');
    if (item) {
      const checkbox = item.querySelector('.douban-cast-checkbox');
      if (checkbox && e.target !== checkbox) {
        checkbox.checked = !checkbox.checked;
      }
    }
  });

  async function importAppearanceSettings(file) {
    if (!file) return;

    const confirmed = await showCustomConfirm(
      'ÂØºÂÖ•Â§ñËßÇËÆæÁΩÆ',
      'Âç≥Â∞ÜÂØºÂÖ•Êñá‰ª∂„ÄÇÂ¶ÇÊûúÊñá‰ª∂ÊòØ JSON Â§á‰ªΩÔºåÂ∞ÜË¶ÜÁõñÊâÄÊúâËÆæÁΩÆÔºõÂ¶ÇÊûúÊòØÁ∫ØÊñáÊú¨/WordÊñáÊ°£ÔºåÂ∞ÜÂ∞ùËØïËØÜÂà´‰∏∫ CSS ‰ª£Á†ÅÊàñ JSON ÈÖçÁΩÆ„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü', {
      confirmText: 'Á°ÆËÆ§ÂØºÂÖ•'
    }
    );

    if (!confirmed) return;

    await showCustomAlert("Â§ÑÁêÜ‰∏≠...", "Ê≠£Âú®Ëß£ÊûêÊñá‰ª∂ÂÜÖÂÆπ...");

    try {
      let textContent = '';

      // 1. Ê†πÊçÆÊñá‰ª∂Á±ªÂûãËØªÂèñÊñáÊú¨
      if (file.name.toLowerCase().endsWith('.docx')) {
        if (typeof mammoth === 'undefined') {
          throw new Error("Êú™Âä†ËΩΩ mammoth.js Â∫ìÔºåÊó†Ê≥ïËØªÂèñ Word ÊñáÊ°£„ÄÇËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñ HTML„ÄÇ");
        }
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
        textContent = result.value;
      } else {
        // .json Êàñ .txt Áõ¥Êé•ËØªÂèñÊñáÊú¨
        textContent = await file.text();
      }

      if (!textContent || !textContent.trim()) {
        throw new Error("Êñá‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫„ÄÇ");
      }

      // 2. Â∞ùËØïËß£Êûê‰∏∫ JSONÔºàÂÆåÊï¥ÈÖçÁΩÆÊ®°ÂºèÔºâ
      try {
        // È¢ÑÂ§ÑÁêÜÔºöÊúâÊó∂ÂÄô Word ‰ºöÂåÖÂê´‰∏çÂèØËßÅÁöÑ BOM ÊàñÂ§ö‰ΩôÁ©∫Ê†ºÔºåÂ∞ùËØïÊ∏ÖÁêÜÂπ∂ÊèêÂèñ JSON ÈÉ®ÂàÜ
        let cleanText = textContent.trim();
        // Â∞ùËØïÊèêÂèñÁ¨¨‰∏Ä‰∏™ { Âà∞ÊúÄÂêé‰∏Ä‰∏™ } ‰πãÈó¥ÁöÑÂÜÖÂÆπÔºåÈò≤Ê≠¢ÊñáÊ°£ÂâçÂêéÊúâÊùÇË¥®
        const jsonMatch = cleanText.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          cleanText = jsonMatch[0];
        }

        const data = JSON.parse(cleanText);

        // Ê£ÄÊü•ÊòØÂê¶ÊòØÊúâÊïàÁöÑÂ§ñËßÇÈÖçÁΩÆÂØπË±°
        if (data.wallpaper || data.globalCss || data.appIcons || data.theme) {
          Object.assign(state.globalSettings, data);
          await db.globalSettings.put(state.globalSettings);

          // Â∫îÁî®ËÆæÁΩÆ
          applyGlobalWallpaper();
          applyCPhoneWallpaper();
          applyMyPhoneWallpaper();
          applyAppIcons();
          applyCPhoneAppIcons();
          applyMyPhoneAppIconsGlobal();
          applyGlobalCss(state.globalSettings.globalCss);
          applyCustomFont(state.globalSettings.fontUrl);
          applyStatusBarVisibility();
          applyWidgetData();
          if (data.chatActionButtonsOrder) {
            renderButtonOrderEditor();
            applyButtonOrder();
          }

          // Âà∑Êñ∞ÁïåÈù¢
          renderWallpaperScreen();

          await showCustomAlert('JSONÂØºÂÖ•ÊàêÂäü', 'ÂÆåÊï¥Â§ñËßÇËÆæÁΩÆÂ∑≤ÊàêÂäüÂØºÂÖ•Âπ∂Â∫îÁî®ÔºÅ');
          return; // ÊàêÂäüÁªìÊùü
        }
      } catch (jsonError) {
        // JSON Ëß£ÊûêÂ§±Ë¥•ÔºåËøõÂÖ•‰∏ã‰∏ÄÊ≠•ÔºöÂ∞ùËØï‰Ωú‰∏∫Á∫Ø CSS ÂØºÂÖ•
        console.log("Èùû JSON Ê†ºÂºèÔºåÂ∞ùËØï‰Ωú‰∏∫ CSS Â§ÑÁêÜ...");
      }

      // 3. Â¶ÇÊûú‰∏çÊòØ JSONÔºåÂàôËßÜ‰∏∫Á∫Ø CSS ‰ª£Á†ÅÂØºÂÖ•
      // ÁÆÄÂçïÁöÑÈò≤ÂëÜÊ£ÄÊü•ÔºöCSS ÈÄöÂ∏∏ÂåÖÂê´ { Êàñ ;
      if (textContent.includes('{') || textContent.includes(';')) {
        const cssAction = await showChoiceModal(
          'Ê£ÄÊµãÂà∞ CSS ‰ª£Á†Å',
          [
            { text: 'Ë¶ÜÁõñÁé∞ÊúâCSS', value: 'overwrite' },
            { text: 'ÈôÑÂä†Âà∞Áé∞ÊúâCSS', value: 'append' }
          ]
        );

        if (cssAction === 'overwrite') {
          state.globalSettings.globalCss = textContent;
          await db.globalSettings.put(state.globalSettings);
          applyGlobalCss(state.globalSettings.globalCss);

          // Âà∑Êñ∞ÁïåÈù¢ÊòæÁ§∫
          const cssInput = document.getElementById('global-css-input');
          if (cssInput) cssInput.value = textContent;

          await showCustomAlert('CSSÂØºÂÖ•ÊàêÂäü', '‰ª£Á†ÅÂ∑≤Ë¶ÜÁõñÂπ∂Â∫îÁî®Âà∞ÂÖ®Â±ÄÊ†∑ÂºèË°®„ÄÇ');
        } else if (cssAction === 'append') {
          const existingCss = state.globalSettings.globalCss || '';
          state.globalSettings.globalCss = existingCss + '\n\n/* ÂØºÂÖ•ÁöÑCSS */\n' + textContent;
          await db.globalSettings.put(state.globalSettings);
          applyGlobalCss(state.globalSettings.globalCss);

          // Âà∑Êñ∞ÁïåÈù¢ÊòæÁ§∫
          const cssInput = document.getElementById('global-css-input');
          if (cssInput) cssInput.value = state.globalSettings.globalCss;

          await showCustomAlert('CSSÂØºÂÖ•ÊàêÂäü', '‰ª£Á†ÅÂ∑≤ÈôÑÂä†Âπ∂Â∫îÁî®Âà∞ÂÖ®Â±ÄÊ†∑ÂºèË°®„ÄÇ');
        }
      } else {
        throw new Error("Êó†Ê≥ïËØÜÂà´Êñá‰ª∂ÂÜÖÂÆπ„ÄÇÂÆÉÊó¢‰∏çÊòØÊúâÊïàÁöÑ JSON ÈÖçÁΩÆÔºå‰πü‰∏çÂÉè CSS ‰ª£Á†Å„ÄÇ");
      }

    } catch (error) {
      console.error("ÂØºÂÖ•Â§ñËßÇËÆæÁΩÆÊó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•: ${error.message}`);
    }
  }

  // ÂØºÂá∫ÁæéÂåñÁâàÂ§ñËßÇËÆæÁΩÆ
  async function exportAppearanceSettings() {
    try {
      // 1. ÊèêÂèñÂ§ñËßÇÁõ∏ÂÖ≥ÁöÑÊï∞ÊçÆ
      // Âç≥‰ΩøÂåÖÂê´Â§ßÊÆµ Base64 ÂõæÁâáÔºåJSON Ê†ºÂºèÂåñÂêéÁªìÊûÑ‰æùÁÑ∂Ê∏ÖÊô∞
      const appearanceData = {
        export_info: {
          generated_by: "EPhone",
          timestamp: new Date().toLocaleString(),
          note: "Ê≠§Êñá‰ª∂ÂåÖÂê´Â§ñËßÇËÆæÁΩÆ„ÄÅCSSÊ†∑Âºè„ÄÅÂ£ÅÁ∫∏ÂíåÂõæÊ†áÊï∞ÊçÆ„ÄÇ"
        },
        // Ê†∏ÂøÉËÆæÁΩÆ
        theme: localStorage.getItem('ephone-theme') || 'light',
        showStatusBar: state.globalSettings.showStatusBar,
        enableMinimalChatUI: state.globalSettings.enableMinimalChatUI,
        detachStatusBar: state.globalSettings.detachStatusBar,
        // CSS (ÊúÄÈúÄË¶ÅÁæéÂåñÈòÖËØªÁöÑÈÉ®ÂàÜ)
        globalCss: state.globalSettings.globalCss || "",
        // Â≠ó‰Ωì
        fontUrl: state.globalSettings.fontUrl || "",
        fontScope: state.globalSettings.fontScope || { all: true },
        globalFontSize: state.globalSettings.globalFontSize || 16,
        // Â∏ÉÂ±ÄÊéíÂ∫è
        chatActionButtonsOrder: state.globalSettings.chatActionButtonsOrder,
        // ËµÑÊ∫êÊï∞ÊçÆ (Â£ÅÁ∫∏/ÂõæÊ†á)
        wallpaper: state.globalSettings.wallpaper,
        cphoneWallpaper: state.globalSettings.cphoneWallpaper,
        globalChatBackground: state.globalSettings.globalChatBackground,
        appIcons: state.globalSettings.appIcons,
        cphoneAppIcons: state.globalSettings.cphoneAppIcons,
        myphoneAppIcons: state.globalSettings.myphoneAppIcons,
        widgetData: state.globalSettings.widgetData,
        lockScreenWallpaper: state.globalSettings.lockScreenWallpaper,
        notificationSoundUrl: state.globalSettings.notificationSoundUrl
      };

      // 2. ÂÖ≥ÈîÆÊ≠•È™§ÔºöÊ†ºÂºèÂåñ JSON (ÁæéÂåñ)
      // Á¨¨‰∏â‰∏™ÂèÇÊï∞ 4 Ë°®Á§∫‰ΩøÁî® 4 ‰∏™Á©∫Ê†ºËøõË°åÁº©ËøõÔºåËÆ©Êñá‰ª∂ÁªìÊûÑÊ∏ÖÊô∞„ÄÅÊòìËØª„ÄÅÊòì‰øÆÊîπ
      const jsonString = JSON.stringify(appearanceData, null, 4);

      // 3. ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');

      // ÁîüÊàêÊñá‰ª∂Âêç
      const dateStr = new Date().toISOString().split('T')[0];
      link.href = url;
      link.download = `EPhone_Appearance_Config_${dateStr}.json`;

      // Ëß¶Âèë‰∏ãËΩΩ
      document.body.appendChild(link);
      link.click();

      // Ê∏ÖÁêÜ
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      await showCustomAlert('ÂØºÂá∫ÊàêÂäü', 'Â§ñËßÇÈÖçÁΩÆÂ∑≤ÂØºÂá∫ÔºÅ\nËøôÊòØ‰∏Ä‰∏™Ê†ºÂºèÂåñÂ•ΩÁöÑ JSON Êñá‰ª∂Ôºå‰Ω†ÂèØ‰ª•Áî®ËÆ∞‰∫ãÊú¨ÊâìÂºÄÊü•ÁúãÊàñÁºñËæë CSS„ÄÇ');

    } catch (error) {
      console.error("ÂØºÂá∫Â§ñËßÇÈÖçÁΩÆÂ§±Ë¥•:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîüÈîôËØØ: ${error.message}`);
    }
  }




  async function simulateBackgroundActivity(minutesOffline) {
    console.log(`Ê£ÄÊµãÂà∞Â∫îÁî®Á¶ªÁ∫ø‰∫Ü ${minutesOffline.toFixed(1)} ÂàÜÈíüÔºåÂºÄÂßãÊ®°ÊãüÂêéÂè∞Ê¥ªÂä®...`);


    const activeCharacters = Object.values(state.chats).filter(chat =>
      !chat.isGroup &&
      chat.settings.enableBackgroundActivity &&
      chat.relationship?.status === 'friend'
    );

    if (activeCharacters.length === 0) {
      console.log("Ê≤°ÊúâÈÖçÁΩÆ‰∏∫ÂêéÂè∞Ê¥ªË∑ÉÁöÑËßíËâ≤ÔºåË∑≥ËøáÊ®°Êãü„ÄÇ");
      return;
    }


    for (const char of activeCharacters) {

      const cooldownMinutes = char.settings.actionCooldownMinutes || 15;
      const timeSinceLastAction = char.lastActionTimestamp ?
        (Date.now() - char.lastActionTimestamp) / (1000 * 60) :
        Infinity;


      if (minutesOffline > cooldownMinutes && timeSinceLastAction > cooldownMinutes) {



        if (Math.random() < 0.3) {
          console.log(`ËßíËâ≤ "${char.name}" Ëß¶Âèë‰∫ÜÂêéÂè∞Ë°åÂä®ÔºÅ`);


          if (Math.random() < 0.7) {

            await triggerInactiveAiAction(char.id);
          } else {

            console.log(`ËßíËâ≤ "${char.name}" ÂÜ≥ÂÆöÂéªÂèë‰∏ÄÊù°Âä®ÊÄÅ... (Ê≠§Â§Ñ‰∏∫Ê®°Êãü)`);
          }
        }
      }
    }
  }


  function openSearchHistoryScreen() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];


    document.getElementById('keyword-search-input').value = '';
    document.getElementById('date-search-input').value = '';

    document.getElementById('chat-search-results-list').innerHTML = `<p style="text-align:center; color: var(--text-secondary);">ËæìÂÖ•ÂÖ≥ÈîÆËØçÊàñÈÄâÊã©Êó•ÊúüËøõË°åÊêúÁ¥¢„ÄÇ</p>`;


    showScreen('search-history-screen');
  }

  async function handleSearchHistory() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const keyword = document.getElementById('keyword-search-input').value.trim().toLowerCase();
    const dateValue = document.getElementById('date-search-input').value;

    if (!keyword && !dateValue) {
      alert("ËØ∑ËæìÂÖ•ÂÖ≥ÈîÆËØçÊàñÈÄâÊã©‰∏Ä‰∏™Êó•Êúü„ÄÇ");
      return;
    }

    let results = chat.history.filter(msg => !msg.isHidden);


    if (keyword) {
      results = results.filter(msg => {
        let contentString = '';

        if (typeof msg.content === 'string') {
          contentString = msg.content;
        } else if (msg.type === 'voice_message') {
          contentString = msg.content;
        } else if (msg.type === 'ai_image' || msg.type === 'user_photo') {
          contentString = msg.content;
        } else if (msg.type === 'offline_text') {
          contentString = `${msg.dialogue || ''} ${msg.description || ''}`;
        } else if (msg.quote) {
          contentString = msg.content;
        }
        return contentString.toLowerCase().includes(keyword);
      });
    }


    if (dateValue) {
      const selectedDate = new Date(dateValue);
      const startOfDay = new Date(selectedDate.setHours(0, 0, 0, 0)).getTime();
      const endOfDay = new Date(selectedDate.setHours(23, 59, 59, 999)).getTime();

      results = results.filter(msg => msg.timestamp >= startOfDay && msg.timestamp <= endOfDay);
    }


    await renderSearchResults(results);
  }



  async function renderSearchResults(results) {
    const listEl = document.getElementById('chat-search-results-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    if (results.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÁöÑËÅäÂ§©ËÆ∞ÂΩï„ÄÇ</p>';
      return;
    }

    let lastDateString = '';
    for (const msg of results) {
      const msgDate = new Date(msg.timestamp);
      const currentDateString = msgDate.toLocaleDateString();

      if (currentDateString !== lastDateString) {
        const dateSeparator = document.createElement('div');
        dateSeparator.className = 'date-separator';
        dateSeparator.textContent = `--- ${msgDate.getFullYear()}Âπ¥${msgDate.getMonth() + 1}Êúà${msgDate.getDate()}Êó• ---`;
        listEl.appendChild(dateSeparator);
        lastDateString = currentDateString;
      }

      const messageEl = await createMessageElement(msg, chat);
      if (messageEl) {


        messageEl.style.cursor = 'pointer';

        messageEl.addEventListener('click', () => jumpToOriginalMessage(msg.timestamp));

        listEl.appendChild(messageEl);
      }
    }
  }




  async function jumpToOriginalMessage(timestamp) {
    const chatId = state.activeChatId;
    if (!chatId) return;


    showScreen('chat-interface-screen');


    setTimeout(async () => {
      const messagesContainer = document.getElementById('chat-messages');
      const selector = `.message-bubble[data-timestamp="${timestamp}"]`;
      let targetMessage = messagesContainer.querySelector(selector);
      let attempts = 0;
      const maxAttempts = 20;


      while (!targetMessage && attempts < maxAttempts) {
        const loadMoreBtn = document.getElementById('load-more-btn');
        if (loadMoreBtn) {
          console.log(`ÁõÆÊ†áÊ∂àÊÅØÊú™ÊâæÂà∞, Ê≠£Âú®Âä†ËΩΩÊõ¥Â§öÂéÜÂè≤ËÆ∞ÂΩï... (Â∞ùËØï ${attempts + 1})`);
          await loadMoreMessages();
          targetMessage = messagesContainer.querySelector(selector);
          attempts++;
        } else {

          break;
        }
      }


      scrollToOriginalMessage(timestamp);

    }, 200);
  }




  async function clearSearchFilters() {
    document.getElementById('keyword-search-input').value = '';
    document.getElementById('date-search-input').value = '';

    await renderSearchResults(state.chats[state.activeChatId].history.filter(msg => !msg.isHidden));
  }

  async function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
    const aiFrameGrid = document.getElementById('ai-frame-grid');
    const myFrameGrid = document.getElementById('my-frame-grid');
    const chat = state.chats[state.activeChatId];
    aiFrameGrid.innerHTML = '';
    myFrameGrid.innerHTML = '';


    const customFrames = await db.customAvatarFrames.toArray();

    const allFrames = [...avatarFrames, ...customFrames];

    document.querySelector('#avatar-frame-modal .frame-tabs').style.display = isForMember ? 'none' : 'flex';
    document.getElementById('ai-frame-content').style.display = 'block';
    document.getElementById('my-frame-content').style.display = 'none';
    document.getElementById('ai-frame-tab').classList.add('active');
    document.getElementById('my-frame-tab').classList.remove('active');

    if (isForMember) {
      allFrames.forEach(frame => {
        const item = createFrameItem(frame, 'my', memberAvatar);
        if (frame.url === memberFrame) {
          item.classList.add('selected');
        }
        aiFrameGrid.appendChild(item);
      });
    } else {
      const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
      const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
      allFrames.forEach(frame => {
        const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
        if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
        aiFrameGrid.appendChild(aiItem);

        const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
        if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
        myFrameGrid.appendChild(myItem);
      });
    }
  }


  function createFrameItem(frame, type, previewAvatarSrc) {
    const item = document.createElement('div');
    item.className = 'frame-item';
    item.dataset.frameUrl = frame.url;
    item.title = frame.name;

    const isCustom = typeof frame.id === 'number';
    const deleteButtonHtml = isCustom ? `<button class="delete-btn" data-id="${frame.id}" style="display:block;">√ó</button>` : '';

    item.innerHTML = `
        ${deleteButtonHtml}
        <img src="${previewAvatarSrc}" class="preview-avatar">
        ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
    `;


    item.addEventListener('click', (e) => {

      if (e.target.classList.contains('delete-btn')) {
        return;
      }


      if (isFrameManagementMode) {

        if (isCustom) {
          const frameId = parseInt(frame.id);
          item.classList.toggle('selected');
          if (selectedFrames.has(frameId)) {
            selectedFrames.delete(frameId);
          } else {
            selectedFrames.add(frameId);
          }
          updateDeleteFrameButton();
        }
      } else {

        currentFrameSelection[type] = frame.url;
        const grid = type === 'ai' ? document.getElementById('ai-frame-grid') : document.getElementById('my-frame-grid');
        grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
        item.classList.add('selected');
      }
    });

    return item;
  }



  async function handleUploadFrame() {
    const fileInput = document.getElementById('custom-frame-upload-input');

    const file = await new Promise(resolve => {
      const changeHandler = (e) => {
        resolve(e.target.files[0] || null);
        fileInput.removeEventListener('change', changeHandler);
      };
      fileInput.addEventListener('change', changeHandler, {
        once: true
      });
      fileInput.click();
    });

    if (!file) return;

    const name = await showCustomPrompt("ÂëΩÂêçÂ§¥ÂÉèÊ°Ü", "ËØ∑‰∏∫Ëøô‰∏™Êñ∞Â§¥ÂÉèÊ°ÜËµ∑‰∏™ÂêçÂ≠ó");
    if (!name || !name.trim()) return;

    const trimmedName = name.trim();

    const base64Url = await new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = async (readerEvent) => {
        resolve(readerEvent.target.result);
      };
      reader.readAsDataURL(file);
    });

    const newFrame = {
      name: trimmedName,
      url: base64Url
    };
    const newId = await db.customAvatarFrames.add(newFrame);

    populateFrameGrids(editingFrameForMember);
    await showCustomAlert("Ê∑ªÂä†ÊàêÂäüÔºÅ", `Â§¥ÂÉèÊ°Ü‚Äú${trimmedName}‚ÄùÂ∑≤Ê∑ªÂä†„ÄÇ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);

    // „Äê„Äê„ÄêÂ∑≤‰øÆÂ§çÁöÑË∞ÉÁî®„Äë„Äë„Äë
    (async () => {
      await silentlyUpdateDbUrl(
        db.customAvatarFrames, // table
        newId, // recordId
        'url', // pathString (ÊåáÂêëÁÆÄÂçïÂ±ûÊÄß)
        base64Url // base64ToFind
        // nameToMatch (‰∏çÈúÄË¶Å)
      );
    })();
  }


  async function handleBatchUploadFrames() {
    const placeholder = `ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÁ≤òË¥¥Ôºå‰∏ÄË°å‰∏Ä‰∏™Ôºö\n\nÂ§¥ÂÉèÊ°ÜÂêçÂ≠ó1: https://.../image1.png\nÂ§¥ÂÉèÊ°ÜÂêçÂ≠ó2: https://.../image2.gif`;
    const pastedText = await showCustomPrompt("ÊâπÈáèÂØºÂÖ•Â§¥ÂÉèÊ°Ü", "‰ªéÂÆåÊï¥ÈìæÊé•ÊâπÈáèÂØºÂÖ•", "", 'textarea', `<p style="font-size:12px;color:#888;">${placeholder}</p>`);

    if (!pastedText || !pastedText.trim()) return;

    const lines = pastedText.trim().split('\n');
    const newFrames = [];
    let errorCount = 0;

    for (const line of lines) {

      const match = line.match(/^(.+?)[:Ôºö]\s*(https?:\/\/.+)$/);
      if (match) {
        newFrames.push({
          name: match[1].trim(),
          url: match[2].trim()
        });
      } else if (line.trim()) {
        errorCount++;
      }
    }

    if (newFrames.length > 0) {
      await db.customAvatarFrames.bulkAdd(newFrames);
      populateFrameGrids(editingFrameForMember);
      await showCustomAlert("ÂØºÂÖ•ÊàêÂäü", `ÊàêÂäüÂØºÂÖ• ${newFrames.length} ‰∏™Êñ∞Â§¥ÂÉèÊ°ÜÔºÅ`);
    }

    if (errorCount > 0) {
      await showCustomAlert("ÈÉ®ÂàÜÂ§±Ë¥•", `Êúâ ${errorCount} Ë°åÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∑≤Ë¢´ÂøΩÁï•„ÄÇ`);
    }
  }

  async function handleDeleteCustomFrame(frameId) {
    const frame = await db.customAvatarFrames.get(frameId);
    if (!frame) return;

    const confirmed = await showCustomConfirm(
      "Á°ÆËÆ§Âà†Èô§",
      `Á°ÆÂÆöË¶ÅÂà†Èô§Â§¥ÂÉèÊ°Ü ‚Äú${frame.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    }
    );

    if (confirmed) {
      await db.customAvatarFrames.delete(frameId);
      populateFrameGrids(editingFrameForMember);
    }
  }





  let currentPage = 0;
  const totalPages = 3;


  function setupHomeScreenPagination() {
    const pagesContainer = document.getElementById('home-screen-pages-container');
    const pages = document.getElementById('home-screen-pages');
    const dots = document.querySelectorAll('.pagination-dot');
    let startX = 0,
      startY = 0;
    let currentX = 0;
    let isDragging = false;
    let isClick = true;

    const updatePagination = () => {
      pages.style.transform = `translateX(-${currentPage * (100 / totalPages)}%)`;
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentPage);
      });
    };

    const onDragStart = (e) => {
      isDragging = true;
      isClick = true;
      startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
      pages.style.transition = 'none';
    };

    const onDragMove = (e) => {
      if (!isDragging) return;

      const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
      currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      let diffX = currentX - startX;
      const diffY = currentY - startY;


      if (isClick && (Math.abs(diffX) > 10 || Math.abs(diffY) > 10)) {
        isClick = false;
      }


      if (Math.abs(diffX) > Math.abs(diffY)) {
        if (e.cancelable) e.preventDefault();

        // ÈôêÂà∂ÊªëÂä®Ë∑ùÁ¶ªÔºåÁ°Æ‰øù‰∏ç‰ºö‰∏ÄÊ¨°ÊªëÂä®Ë∂ÖËøá‰∏ÄÈ°µ
        const maxSwipeDistance = pagesContainer.offsetWidth * 0.8;

        // ÈôêÂà∂ÂêëÂ∑¶ÊªëÂä®Ôºà‰∏ã‰∏ÄÈ°µÔºâ
        if (diffX < 0 && currentPage >= totalPages - 1) {
          diffX = Math.max(diffX, -maxSwipeDistance * 0.3); // ÊúÄÂêé‰∏ÄÈ°µÊó∂ÈôêÂà∂ÊªëÂä®
        } else if (diffX < 0) {
          diffX = Math.max(diffX, -maxSwipeDistance); // ÈôêÂà∂ÊúÄÂ§ßÂêëÂ∑¶ÊªëÂä®Ë∑ùÁ¶ª
        }

        // ÈôêÂà∂ÂêëÂè≥ÊªëÂä®Ôºà‰∏ä‰∏ÄÈ°µÔºâ
        if (diffX > 0 && currentPage <= 0) {
          diffX = Math.min(diffX, maxSwipeDistance * 0.3); // Á¨¨‰∏ÄÈ°µÊó∂ÈôêÂà∂ÊªëÂä®
        } else if (diffX > 0) {
          diffX = Math.min(diffX, maxSwipeDistance); // ÈôêÂà∂ÊúÄÂ§ßÂêëÂè≥ÊªëÂä®Ë∑ùÁ¶ª
        }

        pages.style.transform = `translateX(calc(-${currentPage * (100 / totalPages)}% + ${diffX}px))`;
      }
    };

    const onDragEnd = (e) => {
      if (!isDragging) return;
      isDragging = false;
      pages.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';


      if (isClick) {
        updatePagination();

        return;
      }


      const diffX = currentX - startX;
      const swipeThreshold = pagesContainer.offsetWidth / 3; // ÊèêÈ´òÈòàÂÄºÂà∞1/3ÔºåÁ°Æ‰øùÁøªÈ°µÊõ¥ÊòéÁ°Æ

      // Âè™ÂÖÅËÆ∏‰∏ÄÊ¨°Áøª‰∏ÄÈ°µ
      if (Math.abs(diffX) > swipeThreshold) {
        if (diffX > 0 && currentPage > 0) {
          // ÂêëÂè≥ÊªëÂä®ÔºåËøîÂõû‰∏ä‰∏ÄÈ°µ
          currentPage--;
        } else if (diffX < 0 && currentPage < totalPages - 1) {
          // ÂêëÂ∑¶ÊªëÂä®ÔºåÂâçÂæÄ‰∏ã‰∏ÄÈ°µ
          currentPage++;
        }
      }
      updatePagination();
    };

    pagesContainer.addEventListener('mousedown', onDragStart);
    pagesContainer.addEventListener('mousemove', onDragMove);
    pagesContainer.addEventListener('mouseup', onDragEnd);
    pagesContainer.addEventListener('mouseleave', onDragEnd);


    pagesContainer.addEventListener('touchstart', onDragStart, {
      passive: false
    });
    pagesContainer.addEventListener('touchmove', onDragMove, {
      passive: false
    });
    pagesContainer.addEventListener('touchend', onDragEnd);
  }



  let editingPresetId = null;

  async function openPresetScreen() {
    await renderPresetScreen();
    showScreen('preset-screen');
  }


  async function renderPresetScreen() {
    const tabsContainer = document.getElementById('preset-tabs');
    const contentContainer = document.getElementById('preset-content-container');
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    const [presets, categories] = await Promise.all([
      db.presets.toArray(),
      db.presetCategories.orderBy('name').toArray()
    ]);

    state.presets = presets;

    if (presets.length === 0) {
      contentContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™È¢ÑËÆæ</p>';
      return;
    }


    const allTab = document.createElement('button');
    allTab.className = 'world-book-tab active';
    allTab.textContent = 'ÂÖ®ÈÉ®';
    allTab.dataset.categoryId = 'all';
    tabsContainer.appendChild(allTab);

    const allPane = document.createElement('div');
    allPane.className = 'world-book-category-pane active';
    allPane.dataset.categoryId = 'all';
    contentContainer.appendChild(allPane);

    categories.forEach(category => {
      const categoryTab = document.createElement('button');
      categoryTab.className = 'world-book-tab';
      categoryTab.textContent = category.name;
      categoryTab.dataset.categoryId = String(category.id);
      tabsContainer.appendChild(categoryTab);

      const categoryPane = document.createElement('div');
      categoryPane.className = 'world-book-category-pane';
      categoryPane.dataset.categoryId = String(category.id);
      contentContainer.appendChild(categoryPane);
    });

    const hasUncategorized = presets.some(p => !p.categoryId);
    if (hasUncategorized) {
      const uncategorizedTab = document.createElement('button');
      uncategorizedTab.className = 'world-book-tab';
      uncategorizedTab.textContent = 'Êú™ÂàÜÁ±ª';
      uncategorizedTab.dataset.categoryId = 'uncategorized';
      tabsContainer.appendChild(uncategorizedTab);

      const uncategorizedPane = document.createElement('div');
      uncategorizedPane.className = 'world-book-category-pane';
      uncategorizedPane.dataset.categoryId = 'uncategorized';
      contentContainer.appendChild(uncategorizedPane);
    }


    presets.forEach(preset => {

      const contentPreview = `ËØ•È¢ÑËÆæÂåÖÂê´ ${preset.content.length} ‰∏™Êù°ÁõÆ„ÄÇ`;

      const card = document.createElement('div');
      card.className = 'world-book-card';
      card.innerHTML = `
            <div class="card-title">${preset.name}</div>
            <div class="card-content-preview">${contentPreview}</div>
        `;


      const cardClickHandler = () => openPresetEditor(preset.id);
      const cardLongPressHandler = async () => {
        const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${preset.name}„ÄãÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          await db.presets.delete(preset.id);
          state.presets = await db.presets.toArray();
          renderPresetScreen();
        }
      };

      card.addEventListener('click', cardClickHandler);
      addLongPressListener(card, cardLongPressHandler);

      const clonedCardForAll = card.cloneNode(true);
      clonedCardForAll.addEventListener('click', cardClickHandler);
      addLongPressListener(clonedCardForAll, cardLongPressHandler);
      allPane.appendChild(clonedCardForAll);

      const categoryKey = preset.categoryId ? String(preset.categoryId) : 'uncategorized';
      const targetPane = contentContainer.querySelector(`.world-book-category-pane[data-category-id="${categoryKey}"]`);
      if (targetPane) {
        targetPane.appendChild(card);
      }
    });



    document.querySelectorAll('#preset-tabs .world-book-tab').forEach(tab => {
      tab.addEventListener('click', () => switchPresetCategory(tab.dataset.categoryId));
    });
  }


  function switchPresetCategory(categoryId) {
    document.querySelectorAll('#preset-tabs .world-book-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
    });
    document.querySelectorAll('#preset-content-container .world-book-category-pane').forEach(pane => {
      pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
    });
  }


  async function openPresetEditor(presetId) {

    showScreen('preset-editor-screen');
    editingPresetId = presetId;

    try {

      const [preset, categories] = await Promise.all([
        db.presets.get(presetId),
        db.presetCategories.toArray()
      ]);


      if (!preset) {
        console.error("ÈîôËØØÔºöÂ∞ùËØïÊâìÂºÄ‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑÈ¢ÑËÆæÔºåID:", presetId);
        await showCustomAlert("Âä†ËΩΩÂ§±Ë¥•", "Êâæ‰∏çÂà∞Ëøô‰∏™È¢ÑËÆæÁöÑËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇ");
        showScreen('preset-screen');
        return;
      }



      setTimeout(() => {

        document.getElementById('preset-editor-title').textContent = preset.name;
        document.getElementById('preset-name-input').value = preset.name;

        const selectEl = document.getElementById('preset-category-select');
        selectEl.innerHTML = '<option value="">-- Êú™ÂàÜÁ±ª --</option>';
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.id;
          option.textContent = cat.name;
          if (preset.categoryId === cat.id) option.selected = true;
          selectEl.appendChild(option);
        });

        const entriesContainer = document.getElementById('preset-entries-container');
        entriesContainer.innerHTML = '';
        if (Array.isArray(preset.content) && preset.content.length > 0) {
          preset.content.forEach(entry => {
            const block = createPresetEntryBlock(entry);
            entriesContainer.appendChild(block);
          });
        } else {
          entriesContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 20px;">ËøòÊ≤°ÊúâÂÜÖÂÆπÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†Á¨¨‰∏ÄÊù°ÂêßÔºÅ</p>';
        }
      }, 50);

    } catch (error) {
      console.error("ÊâìÂºÄÈ¢ÑËÆæÁºñËæëÂô®Êó∂ÂèëÁîü‰∏•ÈáçÈîôËØØ:", error);
      await showCustomAlert("Âä†ËΩΩÂ§±Ë¥•", `Âä†ËΩΩÈ¢ÑËÆæËØ¶ÊÉÖÊó∂ÂèëÁîüÈîôËØØ: ${error.message}`);
      showScreen('preset-screen');
    }
  }


  function createPresetEntryBlock(entry = {
    keys: [],
    comment: '',
    content: '',
    enabled: true
  }) {
    const block = document.createElement('div');
    block.className = 'message-editor-block';
    const isChecked = entry.enabled !== false ? 'checked' : '';


    block.innerHTML = `
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 5px;">
            <label class="toggle-switch" title="ÂêØÁî®/Á¶ÅÁî®Ê≠§Êù°ÁõÆ">
                <input type="checkbox" class="entry-enabled-switch" ${isChecked}>
                <span class="slider"></span>
            </label>
            <button type="button" class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°ÁõÆ">√ó</button>
        </div>
        <div class="form-group" style="margin-bottom: 10px;">
            <label style="font-size: 0.8em;">Â§áÊ≥® (ÂèØÈÄâ)</label>
            <input type="text" class="entry-comment-input" value="${entry.comment || ''}" placeholder="‰æãÂ¶ÇÔºöËßíËâ≤Ê†∏ÂøÉËÆæÂÆö" style="padding: 8px;">
        </div>
        <div class="form-group" style="margin-bottom: 10px;">
            <label style="font-size: 0.8em;">ÂÖ≥ÈîÆËØç (Áî®Ëã±ÊñáÈÄóÂè∑,ÂàÜÈöî)</label>
            <input type="text" class="entry-keys-input" value="${(entry.keys || []).join(', ')}" placeholder="‰æãÂ¶Ç: key1, key2" style="padding: 8px;">
        </div>
        
        <!-- ËøôÈáåÊòØÂÖ®Êñ∞ÁöÑ„ÄÅÂ∏¶Êúâ‚ÄúÂ±ïÂºÄ/Êî∂Ëµ∑‚ÄùÊåâÈíÆÁöÑÁªìÊûÑ -->
        <div class="form-group" style="margin-bottom: 0;">
            <label style="font-size: 0.8em; display: flex; justify-content: space-between; align-items: center;">
                <span>ÂÜÖÂÆπ (ÁÇπÂáªÂè≥‰æßÂ±ïÂºÄ)</span>
                <button type="button" class="toggle-content-btn">Â±ïÂºÄ</button>
            </label>
            <div class="entry-content-container">
                 <textarea class="entry-content-textarea" rows="8" style="width: 100%; font-size: 14px;">${entry.content || ''}</textarea>
            </div>
        </div>
    `;



    block.querySelector('.delete-block-btn').addEventListener('click', () => block.remove());


    const toggleBtn = block.querySelector('.toggle-content-btn');
    const contentContainer = block.querySelector('.entry-content-container');
    toggleBtn.addEventListener('click', () => {
      const isHidden = contentContainer.style.display === 'none';
      contentContainer.style.display = isHidden ? 'block' : 'none';
      toggleBtn.textContent = isHidden ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ';
    });

    return block;
  }


  async function openPresetCategoryManager() {
    await renderPresetCategoriesInManager();

    document.querySelector('#group-management-modal .modal-header span').textContent = 'ÁÆ°ÁêÜÈ¢ÑËÆæÂàÜÁ±ª';
    document.getElementById('add-new-group-btn').onclick = addNewPresetCategory;
    document.getElementById('existing-groups-list').onclick = (e) => {
      if (e.target.classList.contains('delete-group-btn')) {
        deletePresetCategory(parseInt(e.target.dataset.id));
      }
    };
    document.getElementById('close-group-manager-btn').onclick = () => {
      document.getElementById('group-management-modal').classList.remove('visible');
      renderPresetScreen();
    };
    document.getElementById('group-management-modal').classList.add('visible');
  }

  async function renderPresetCategoriesInManager() {
    const listEl = document.getElementById('existing-groups-list');
    const categories = await db.presetCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ª</p>';
    }
    categories.forEach(cat => {
      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `<span class="group-name">${cat.name}</span><span class="delete-group-btn" data-id="${cat.id}">√ó</span>`;
      listEl.appendChild(item);
    });
  }

  async function addNewPresetCategory() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) return alert('ÂàÜÁ±ªÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
    const existing = await db.presetCategories.where('name').equals(name).first();
    if (existing) return alert(`ÂàÜÁ±ª "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);
    await db.presetCategories.add({
      name
    });
    input.value = '';
    await renderPresetCategoriesInManager();
  }

  async function deletePresetCategory(categoryId) {
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Âà†Èô§ÂàÜÁ±ªÂêéÔºåËØ•ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâÈ¢ÑËÆæÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁ±ª‚Äù„ÄÇÁ°ÆÂÆöÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.presetCategories.delete(categoryId);
      await db.presets.where('categoryId').equals(categoryId).modify({
        categoryId: null
      });


      state.presets = await db.presets.toArray();


      await renderPresetCategoriesInManager();
    }
  }



  async function handlePresetImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
      if (!file.name.endsWith('.json')) {
        throw new Error("Êñá‰ª∂Ê†ºÂºè‰∏çÊîØÊåÅ„ÄÇËØ∑ÈÄâÊã© .json Ê†ºÂºèÁöÑ Tavern È¢ÑËÆæÊñá‰ª∂„ÄÇ");
      }

      const text = await file.text();
      const tavernData = JSON.parse(text);


      await importTavernPresetFile(tavernData, file.name);

    } catch (error) {
      console.error("È¢ÑËÆæÂØºÂÖ•Â§±Ë¥•:", error);
      await showCustomAlert("ÂØºÂÖ•Â§±Ë¥•", `Êó†Ê≥ïËß£ÊûêÈ¢ÑËÆæÊñá‰ª∂„ÄÇ\nÈîôËØØ: ${error.message}`);
    } finally {

      event.target.value = null;
    }
  }


  async function importTavernPresetFile(tavernData, fileName) {
    let newEntries = [];




    if (Array.isArray(tavernData.prompts) && Array.isArray(tavernData.prompt_order) && tavernData.prompt_order.length > 0) {
      console.log("Ê£ÄÊµãÂà∞ Tavern/SillyTavern È¢ÑËÆæÊ†ºÂºèÔºåÂ∞Ü‰∏•Ê†ºÊåâÁÖß prompt_order ÊéíÂ∫è„ÄÇ");


      const promptsMap = new Map(tavernData.prompts.map(p => [p.identifier, p]));


      const orderArray = tavernData.prompt_order.reduce((acc, curr) => (
        (curr.order && curr.order.length > (acc.length || 0)) ? curr.order : acc
      ), []);

      if (orderArray && orderArray.length > 0) {
        newEntries = orderArray
          .map(orderItem => {

            const promptData = promptsMap.get(orderItem.identifier);
            if (promptData) {

              return {
                keys: [],
                comment: promptData.name || 'Êó†Ê†áÈ¢ò',
                content: promptData.content || '',

                enabled: orderItem.enabled
              };
            }
            return null;
          })
          .filter(Boolean);
      }
    } else if (tavernData.entries && typeof tavernData.entries === 'object') {
      console.log("Ê£ÄÊµãÂà∞ 'entries' ÂØπË±°Ê†ºÂºèÁöÑÈ¢ÑËÆæÔºåÂ∞ÜÂ∞ùËØïÊåâÈ°∫Â∫èÂØºÂÖ•„ÄÇ");
      if (Array.isArray(tavernData.order)) {
        console.log("Ê£ÄÊµãÂà∞ 'order' Â≠óÊÆµÔºåÂ∞ÜÊåâÊåáÂÆöÈ°∫Â∫èÂØºÂÖ•Êù°ÁõÆ„ÄÇ");
        newEntries = tavernData.order
          .map(key => tavernData.entries[key])
          .filter(Boolean)
          .map(entry => ({
            keys: entry.key || [],
            comment: entry.comment || 'Êó†Â§áÊ≥®',
            content: entry.content || '',
            enabled: !entry.disable
          }));
      } else {
        console.warn("Êú™Âú®Êñá‰ª∂‰∏≠ÊâæÂà∞ 'order' Â≠óÊÆµÔºåÊù°ÁõÆÂèØËÉΩÊó†Ê≥ïÊåâÂéüÂßãÈ°∫Â∫èÂØºÂÖ•„ÄÇ");
        newEntries = Object.values(tavernData.entries).map(entry => ({
          keys: entry.key || [],
          comment: entry.comment || 'Êó†Â§áÊ≥®',
          content: entry.content || '',
          enabled: !entry.disable
        }));
      }
    } else if (Array.isArray(tavernData.prompts)) {
      console.log("Ê£ÄÊµãÂà∞ÁÆÄÂçïÁöÑ 'prompts' Êï∞ÁªÑÊ†ºÂºèÔºåÂ∞ÜÊåâÊï∞ÁªÑÂÜÖÈ°∫Â∫èÂØºÂÖ•„ÄÇ");
      newEntries = tavernData.prompts.map(prompt => ({
        keys: [],
        comment: prompt.name || 'Êó†Ê†áÈ¢ò',
        content: prompt.content || '',
        enabled: true
      }));
    } else {
      throw new Error("Êñá‰ª∂Ê†ºÂºèÊó†Ê≥ïËØÜÂà´„ÄÇÊú™ÊâæÂà∞ÊúâÊïàÁöÑ 'prompts' Êï∞ÁªÑÊàñ 'entries' ÂØπË±°„ÄÇ");
    }



    newEntries = newEntries.filter(entry => entry.content);

    if (newEntries.length === 0) {
      alert("Ëøô‰∏™È¢ÑËÆæÊñá‰ª∂‰∏≠Ê≤°ÊúâÊâæÂà∞‰ªª‰ΩïÊúâÊïàÁöÑÊèêÁ§∫ËØçÊù°ÁõÆ„ÄÇ");
      return;
    }


    const presetNameSuggestion = fileName.replace(/\.json$/i, '');
    const newPresetName = await showCustomPrompt("ÂØºÂÖ• Tavern È¢ÑËÆæ", "ËØ∑‰∏∫ËøôÁªÑÊèêÁ§∫ËØçÈ¢ÑËÆæÂëΩÂêçÔºö", presetNameSuggestion);
    if (!newPresetName || !newPresetName.trim()) {
      alert("ÂØºÂÖ•Â∑≤ÂèñÊ∂àÔºåÂõ†‰∏∫Êú™Êèê‰æõÂêçÁß∞„ÄÇ");
      return;
    }

    const newPreset = {
      id: 'preset_' + Date.now(),
      name: newPresetName.trim(),
      content: newEntries,
      categoryId: null
    };

    await db.presets.add(newPreset);
    state.presets.push(newPreset);

    await renderPresetScreen();
    await showCustomAlert('ÂØºÂÖ•ÊàêÂäüÔºÅ', `Â∑≤ÊàêÂäü‰ªéÊñá‰ª∂ÂØºÂÖ•È¢ÑËÆæ„Ää${newPresetName}„Äã„ÄÇ`);
  }



  async function renderOfflinePresetSelector(chat) {
    const selectEl = document.getElementById('offline-preset-select');
    if (!selectEl) return;


    const presets = state.presets || [];


    selectEl.innerHTML = '<option value="">-- ‰∏ç‰ΩøÁî®È¢ÑËÆæ --</option>';
    presets.forEach(preset => {
      const option = document.createElement('option');
      option.value = preset.id;
      option.textContent = preset.name;
      selectEl.appendChild(option);
    });


    if (chat.settings.offlinePresetId) {
      selectEl.value = chat.settings.offlinePresetId;
    }
  }


  function renderButtonOrderEditor() {
    const editor = document.getElementById('button-order-editor');
    if (!editor) return;

    editor.innerHTML = '';



    let buttonOrder = state.globalSettings.chatActionButtonsOrder || DEFAULT_BUTTON_ORDER;

    buttonOrder.forEach(buttonId => {
      const originalButton = document.getElementById(buttonId);
      if (originalButton) {
        const item = document.createElement('div');
        item.className = 'draggable-button-item';
        item.draggable = true;
        item.dataset.buttonId = buttonId;
        item.innerHTML = originalButton.innerHTML;
        editor.appendChild(item);
      }
    });
  }



  function initializeButtonOrderEditor() {
    const editor = document.getElementById('button-order-editor');
    if (!editor) return;

    let draggingItem = null;


    const handleDragStart = (e) => {
      const target = e.target.closest('.draggable-button-item');
      if (!target) return;

      draggingItem = target;
      draggingItem.classList.add('dragging');


      if (e.cancelable) e.preventDefault();
    };

    const handleDragMove = (e) => {
      if (!draggingItem) return;


      const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;

      const afterElement = getDragAfterElement(editor, clientX);

      if (afterElement == null) {
        editor.appendChild(draggingItem);
      } else {
        editor.insertBefore(draggingItem, afterElement);
      }
    };

    const handleDragEnd = () => {
      if (!draggingItem) return;

      draggingItem.classList.remove('dragging');
      draggingItem = null;


      saveButtonOrder();
    };



    editor.addEventListener('mousedown', handleDragStart);
    editor.addEventListener('touchstart', handleDragStart, {
      passive: false
    });


    editor.addEventListener('mousemove', handleDragMove);
    editor.addEventListener('touchmove', handleDragMove, {
      passive: false
    });


    editor.addEventListener('mouseup', handleDragEnd);
    editor.addEventListener('mouseleave', handleDragEnd);
    editor.addEventListener('touchend', handleDragEnd);
  }



  function getDragAfterElement(container, x) {

    const draggableElements = [...container.querySelectorAll('.draggable-button-item:not(.dragging)')];


    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();

      const offset = x - box.left - box.width / 2;


      if (offset < 0 && offset > closest.offset) {
        return {
          offset: offset,
          element: child
        };
      } else {
        return closest;
      }
    }, {
      offset: Number.NEGATIVE_INFINITY
    }).element;
  }


  async function saveButtonOrder() {
    const editor = document.getElementById('button-order-editor');
    const newOrder = Array.from(editor.querySelectorAll('.draggable-button-item')).map(item => item.dataset.buttonId);

    state.globalSettings.chatActionButtonsOrder = newOrder;
    await db.globalSettings.put(state.globalSettings);



  }


  function applyButtonOrder() {
    const buttonOrder = state.globalSettings.chatActionButtonsOrder;
    if (!buttonOrder || !Array.isArray(buttonOrder) || buttonOrder.length === 0) {
      return;
    }

    const container = document.getElementById('chat-input-actions-top');
    if (!container) return;


    buttonOrder.forEach(buttonId => {
      const button = document.getElementById(buttonId);
      if (button) {
        container.appendChild(button);
      }
    });
  }



  const DEFAULT_BUTTON_ORDER = [
    'open-sticker-panel-btn', 'send-photo-btn', 'camera-capture-btn', 'upload-image-btn',
    'transfer-btn', 'voice-message-btn', 'send-waimai-request-btn',
    'video-call-btn', 'group-video-call-btn', 'send-poll-btn',
    'share-link-btn', 'share-location-btn', 'gomoku-btn',
    'open-shopping-btn', 'pat-btn', 'edit-last-response-btn',
    'regenerate-btn', 'propel-btn', 'show-announcement-board-btn',
    'werewolf-game-btn',

    'read-together-btn',
    'open-nai-gallery-btn',
    'open-todo-list-btn',
    'open-quick-reply-btn',
    'stop-api-call-btn'
  ];


  async function resetButtonOrder() {

    state.globalSettings.chatActionButtonsOrder = null;
    await db.globalSettings.put(state.globalSettings);


    renderButtonOrderEditor();


    applyButtonOrder();


    await showCustomAlert("ÊàêÂäü", "ÊåâÈíÆÈ°∫Â∫èÂ∑≤ÊÅ¢Â§ç‰∏∫ÈªòËÆ§ËÆæÁΩÆÔºÅ");
  }





  let selectedCharsForClear = [];
  let selectedTypesForClear = [];


  function openDataClearWizard() {
    const modal = document.getElementById('data-clear-wizard-modal');
    selectedCharsForClear = [];
    selectedTypesForClear = [];


    renderClearWizardStep1();


    document.getElementById('data-clear-step-1').style.display = 'flex';
    document.getElementById('data-clear-step-2').style.display = 'none';

    modal.classList.add('visible');
  }


  function renderClearWizardStep1() {
    const listEl = document.getElementById('data-clear-char-list');
    listEl.innerHTML = '';


    const userItem = document.createElement('div');
    userItem.className = 'clear-posts-item';
    userItem.dataset.charId = 'user';
    userItem.innerHTML = `
        <div class="checkbox"></div>
        <span class="name">${state.qzoneSettings.nickname || 'Êàë'} (Áî®Êà∑)</span>
    `;
    listEl.appendChild(userItem);


    Object.values(state.chats).forEach(chat => {
      if (!chat.isGroup) {
        const charItem = document.createElement('div');
        charItem.className = 'clear-posts-item';
        charItem.dataset.charId = chat.id;
        charItem.innerHTML = `
                <div class="checkbox"></div>
                <span class="name">${chat.name} (ËßíËâ≤)</span>
            `;
        listEl.appendChild(charItem);
      }
    });
  }


  function renderClearWizardStep2() {
    const listEl = document.getElementById('data-clear-type-list');
    listEl.innerHTML = '';

    const dataTypes = [{
      id: 'chat',
      name: 'ËÅäÂ§©ËÆ∞ÂΩï',
      description: 'Â∞ÜÊ∏ÖÁ©∫ÈÄâÂÆöËßíËâ≤ÁöÑÊâÄÊúâÂØπËØùÊ∂àÊÅØ„ÄÅÊõæÁî®Â§áÊ≥®Âíå‰Ω†ÁöÑÊòµÁß∞„ÄÇ'
    },
    {
      id: 'qzone',
      name: 'Âä®ÊÄÅ‰∏é‰∫íÂä®',
      description: 'Â∞ÜÊ∏ÖÁ©∫ÈÄâÂÆöËßíËâ≤ÁöÑÊâÄÊúâÂä®ÊÄÅ„ÄÅËØÑËÆ∫ÂíåÁÇπËµû„ÄÇ'
    },
    {
      id: 'calls',
      name: 'ÈÄöËØùËÆ∞ÂΩï',
      description: 'Â∞ÜÊ∏ÖÁ©∫ÈÄâÂÆöËßíËâ≤ÁöÑÊâÄÊúâÈÄöËØùËÆ∞ÂΩï„ÄÇ'
    },
    {
      id: 'thoughts',
      name: 'ÂøÉÂ£∞',
      description: 'Â∞ÜÊ∏ÖÁ©∫ÈÄâÂÆöËßíËâ≤ÁöÑÂøÉÂ£∞ÂíåÊï£ËÆ∞ÂéÜÂè≤„ÄÇ'
    },
    {
      id: 'memories',
      name: 'ÈïøÊúüËÆ∞ÂøÜ',
      description: 'Â∞ÜÊ∏ÖÁ©∫ÈÄâÂÆöËßíËâ≤ÁöÑÊâÄÊúâÈïøÊúüËÆ∞ÂøÜ„ÄÇ'
    },
    {
      id: 'favorites',
      name: 'Êî∂Ëóè',
      description: 'Â∞ÜÊ∏ÖÁ©∫Êî∂ËóèÂ§π‰∏≠ÊâÄÊúâ‰∏éËØ•ËßíËâ≤Áõ∏ÂÖ≥ÁöÑÂÜÖÂÆπÔºàÂ¶ÇËÅäÂ§©„ÄÅÂä®ÊÄÅ„ÄÅÊó•ËÆ∞Á≠âÔºâ„ÄÇ'
    },
    {
      id: 'cphone',
      name: 'CphoneÊï∞ÊçÆ (CPhone)',
      description: 'Â∞ÜÊ∏ÖÁ©∫ËßíËâ≤ÁöÑÁõ∏ÂÜå„ÄÅQQ„ÄÅÊµèËßàÂô®„ÄÅÊ∑òÂÆù„ÄÅÊó•ËÆ∞„ÄÅÂ§áÂøòÂΩïÁ≠âÊâÄÊúâÊ®°ÊãüÊâãÊú∫Êï∞ÊçÆ„ÄÇ'
    },
    {
      id: 'myphone',
      name: 'MyPhoneÊï∞ÊçÆ (MyPhone)',
      description: 'Â∞ÜÊ∏ÖÁ©∫ÁªëÂÆöËßíËâ≤ÁöÑMyPhoneÊâÄÊúâÊï∞ÊçÆÔºåÂåÖÊã¨QQËÅîÁ≥ª‰∫∫„ÄÅÁõ∏ÂÜå„ÄÅÊµèËßàÂô®„ÄÅÊ∑òÂÆù„ÄÅÊó•ËÆ∞„ÄÅÂ§áÂøòÂΩï„ÄÅÂú∞Âõæ„ÄÅAPPËÆ∞ÂΩï„ÄÅÈü≥‰πêÁ≠â„ÄÇ'
    },
    {
      id: 'todo',
      name: 'ÂæÖÂäû‰∫ãÈ°π (To-Do)',
      description: 'Â∞ÜÊ∏ÖÁ©∫ÈÄâÂÆöËßíËâ≤ÁöÑÂæÖÂäû‰∫ãÈ°πÊ∏ÖÂçï„ÄÇ(Ëã•Á¨¨‰∏ÄÊ≠•ÈÄâ‚ÄúÊàë‚ÄùÔºåÂàôÊ∏ÖÈô§ÊâÄÊúâËßíËâ≤‰∏≠Áî±‚ÄúÊàë‚ÄùÂàõÂª∫ÁöÑÂæÖÂäû)'
    },
    {
      id: 'alipay_bills',
      name: 'ÊîØ‰ªòÂÆùË¥¶Âçï (Alipay)',
      description: 'Â∞ÜÊ∏ÖÁ©∫ÊîØ‰ªòÂÆùÁöÑÊâÄÊúâ‰∫§ÊòìÊµÅÊ∞¥„ÄÅËΩ¨Ë¥¶ËÆ∞ÂΩïÂíåÂü∫Èáë‰π∞ÂçñËÆ∞ÂΩï„ÄÇ(‰ªÖÂú®Á¨¨‰∏ÄÊ≠•ÈÄâÊã©‚ÄúÊàë‚ÄùÊó∂ÁîüÊïà)'
    }
    ];

    dataTypes.forEach(type => {
      const item = document.createElement('div');
      item.className = 'clear-posts-item';
      item.dataset.typeId = type.id;
      item.innerHTML = `
                    <div class="checkbox"></div>
                    <div>
                        <span class="name">${type.name}</span>
                        <p style="font-size: 12px; color: #888; margin: 4px 0 0;">${type.description}</p>
                    </div>
                `;
      listEl.appendChild(item);
    });
  }



  function handleDataClearNext() {
    const selectedItems = document.querySelectorAll('#data-clear-char-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÊ∏ÖÁêÜÁöÑËßíËâ≤„ÄÇ");
      return;
    }

    selectedCharsForClear = Array.from(selectedItems).map(item => item.dataset.charId);


    renderClearWizardStep2();
    document.getElementById('data-clear-step-1').style.display = 'none';
    document.getElementById('data-clear-step-2').style.display = 'flex';
  }


  function handleDataClearBack() {
    document.getElementById('data-clear-step-2').style.display = 'none';
    document.getElementById('data-clear-step-1').style.display = 'flex';

    document.querySelectorAll('#data-clear-char-list .clear-posts-item').forEach(item => {
      if (selectedCharsForClear.includes(item.dataset.charId)) {
        item.classList.add('selected');
      }
    });
  }


  async function handleConfirmDataClear() {
    const selectedItems = document.querySelectorAll('#data-clear-type-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÁßçË¶ÅÊ∏ÖÁêÜÁöÑÊï∞ÊçÆÁ±ªÂûã„ÄÇ");
      return;
    }

    selectedTypesForClear = Array.from(selectedItems).map(item => item.dataset.typeId);

    const confirmed = await showCustomConfirm(
      'ÊúÄÂêéÁ°ÆËÆ§ÔºÅ',
      'Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ÊÇ®ÈÄâÊã©ÁöÑÊâÄÊúâÊï∞ÊçÆÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü', {
      confirmButtonClass: 'btn-danger',
      confirmText: 'Á°ÆËÆ§Âà†Èô§'
    }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÊâßË°åÊ∏ÖÁêÜÊìç‰ΩúÔºåËØ∑‰∏çË¶ÅÂÖ≥Èó≠È°µÈù¢...");

    try {
      await db.transaction('rw', db.tables, async () => {
        for (const charId of selectedCharsForClear) {
          for (const type of selectedTypesForClear) {
            if (type === 'todo') {
              if (charId === 'user') {
                // Â¶ÇÊûúÁ¨¨‰∏ÄÊ≠•ÈÄâÁöÑÊòØ‚ÄúÊàë (Áî®Êà∑)‚ÄùÔºåÂàôÈÅçÂéÜÊâÄÊúâËÅäÂ§©ÔºåÂè™Âà†Èô§ creator ‰∏∫ 'user' ÁöÑÂæÖÂäû
                const allChats = await db.chats.toArray();
                for (const chat of allChats) {
                  if (chat.todoList && chat.todoList.length > 0) {
                    const originalLength = chat.todoList.length;
                    // ËøáÊª§ÊéâÁî®Êà∑ÂàõÂª∫ÁöÑÔºå‰øùÁïôAIÂàõÂª∫ÁöÑ
                    chat.todoList = chat.todoList.filter(t => t.creator !== 'user');

                    if (chat.todoList.length < originalLength) {
                      await db.chats.put(chat);
                    }
                  }
                }
                console.log("Â∑≤Ê∏ÖÁêÜÊâÄÊúâÁî±Áî®Êà∑ÂàõÂª∫ÁöÑÂæÖÂäû‰∫ãÈ°π");
              } else {
                // Â¶ÇÊûúÈÄâÁöÑÊòØÂÖ∑‰ΩìËßíËâ≤ÔºåÁõ¥Êé•Ê∏ÖÁ©∫ËØ•ËßíËâ≤ÁöÑÂæÖÂäûÂàóË°® (todoList)
                const chat = await db.chats.get(charId);
                if (chat) {
                  chat.todoList = []; // Áõ¥Êé•ÁΩÆÁ©∫
                  await db.chats.put(chat);
                  console.log(`Â∑≤Ê∏ÖÁ©∫ËßíËâ≤ ${chat.name} ÁöÑÂæÖÂäû‰∫ãÈ°π`);
                }
              }
            }
            if (type === 'alipay_bills') {
              // Âè™ÊúâÂΩìÁ¨¨‰∏ÄÊ≠•ÈÄâÊã©‰∫Ü‚ÄúÊàë(Áî®Êà∑)‚ÄùÊó∂ÔºåÊâçÊâßË°åÊ∏ÖÁ©∫ÔºåÈò≤Ê≠¢ËØØÊìç‰Ωú
              if (charId === 'user') {
                await db.userTransactions.clear(); // Ê∏ÖÁ©∫Ë¥¶ÂçïË°®
                console.log("ÊîØ‰ªòÂÆùË¥¶ÂçïÂ∑≤ÂÖ®ÈÉ®Ê∏ÖÁ©∫");

                // ÂèØÈÄâÔºöÂ¶ÇÊûú‰Ω†ËøòÊÉ≥ÈáçÁΩÆÈí±ÂåÖ‰ΩôÈ¢ùÂíåÂü∫ÈáëÊåÅ‰ªìÔºåÂèØ‰ª•Ëß£ÂºÄ‰∏ãÈù¢Ê≥®Èáä
                /*
                const wallet = await db.userWallet.get('main');
                if(wallet) {
                    wallet.balance = 0; // ÈáçÁΩÆ‰ΩôÈ¢ù
                    wallet.fundHoldings = []; // ÈáçÁΩÆÂü∫Èáë
                    await db.userWallet.put(wallet);
                }
                */
              } else {
                // Â¶ÇÊûúÈÄâÊã©‰∫ÜÊüê‰∏™ËßíËâ≤ÔºåÂ∞ùËØïÂà†Èô§ËØ•ËßíËâ≤ÂêçÂ≠óÁõ∏ÂÖ≥ÁöÑË¥¶Âçï(Ê®°Á≥äÂåπÈÖç)
                // Ê≥®ÊÑèÔºöËøô‰æùËµñ‰∫édescriptionÂåÖÂê´ËßíËâ≤ÂêçÔºåÂèØËÉΩ‰∏çÂÆåÂÖ®ÂáÜÁ°ÆÔºåÂª∫ËÆÆÂè™Áî®‰∏äÈù¢ÁöÑÊ∏ÖÁ©∫ÂÖ®ÈÉ®
                const chat = await db.chats.get(charId);
                if (chat) {
                  const nameKeys = [chat.name, chat.originalName];
                  // ËøôÊòØ‰∏Ä‰∏™ÊØîËæÉËÄóÊó∂ÁöÑËøáÊª§Âà†Èô§Ôºå‰ΩÜÂØπ‰∫éÊ∏ÖÁêÜÁâπÂÆöËßíËâ≤ÊµÅÊ∞¥ÂæàÊúâÁî®
                  await db.userTransactions
                    .filter(t => nameKeys.some(k => t.description && t.description.includes(k)))
                    .delete();
                }
              }
            }
            if (type === 'chat') {
              if (charId === 'user') {
                const allChats = await db.chats.toArray();
                for (const chat of allChats) {
                  chat.history = chat.history.filter(msg => msg.role !== 'user');
                  await db.chats.put(chat);
                }
              } else {
                const chat = await db.chats.get(charId);
                if (chat) {
                  chat.history = [];
                  chat.heartfeltVoice = '...';
                  chat.randomJottings = '...';
                  if (Array.isArray(chat.nameHistory)) {
                    chat.nameHistory = [];
                  }
                  if (chat.settings) {
                    chat.settings.myNickname = 'Êàë';
                  }
                  await db.chats.put(chat);
                }
              }
            }

            if (type === 'qzone') {
              const authorId = (charId === 'user') ? 'user' : charId;
              await db.qzonePosts.where('authorId').equals(authorId).delete();
            }

            if (type === 'calls' && charId !== 'user') {
              await db.callRecords.where('chatId').equals(charId).delete();
            }

            if (type === 'thoughts' && charId !== 'user') {
              const chat = await db.chats.get(charId);
              if (chat) {
                chat.thoughtsHistory = [];
                chat.heartfeltVoice = '...';
                chat.randomJottings = '...';
                await db.chats.put(chat);
              }
            }

            if (type === 'memories' && charId !== 'user') {
              const chat = await db.chats.get(charId);
              if (chat) {
                chat.longTermMemory = [];
                await db.chats.put(chat);
              }
            }


            if (type === 'favorites') {
              if (charId === 'user') {

                await db.favorites.where('type').equals('qzone_post').filter(fav => fav.content.authorId === 'user').delete();

                await db.favorites.where('type').equals('chat_message').filter(fav => fav.content.role === 'user').delete();
              } else {

                await db.favorites.where('type').equals('chat_message').and(fav => fav.chatId === charId).delete();

                await db.favorites.where('type').equals('qzone_post').filter(fav => fav.content.authorId === charId).delete();

                await db.favorites.where('type').equals('char_diary').filter(fav => fav.content.characterId === charId).delete();
                await db.favorites.where('type').equals('char_browser_article').filter(fav => fav.content.characterId === charId).delete();
                await db.favorites.where('type').equals('char_memo').filter(fav => fav.content.characterId === charId).delete();
              }
            }


            if (type === 'cphone' && charId !== 'user') {
              const chat = await db.chats.get(charId);
              if (chat) {
                chat.simulatedAlbum = [];
                chat.simulatedConversations = [];
                chat.simulatedBrowserHistory = [];
                chat.simulatedTaobaoHistory = null;
                chat.simulatedAmapHistory = [];
                chat.simulatedAppUsage = [];
                chat.simulatedMusicPlaylist = [];
                chat.diary = [];
                chat.memos = [];
                await db.chats.put(chat);
              }
            }

            if (type === 'myphone' && charId !== 'user') {
              const chat = await db.chats.get(charId);
              if (chat) {
                chat.myPhoneSimulatedQQConversations = [];
                chat.myPhoneAlbum = [];
                chat.myPhoneBrowserHistory = [];
                chat.myPhoneTaobaoHistory = [];
                chat.myPhoneAmapHistory = [];
                chat.myPhoneAppUsage = [];
                chat.myPhoneMusicPlaylist = [];
                chat.myPhoneDiaries = [];
                chat.myPhoneMemos = [];
                await db.chats.put(chat);
              }
            }
          }
        }
      });

      await loadAllDataFromDB();
      await renderChatList();
      const alipayScreen = document.getElementById('alipay-screen');
      if (alipayScreen && alipayScreen.classList.contains('active')) {
        // Â¶ÇÊûú‰Ω†‰πãÂâçÂÆö‰πâ‰∫Ü loadBills ÂáΩÊï∞
        if (typeof loadBills === 'function') {
          await loadBills(true); // true ‰ª£Ë°®ÈáçÁΩÆÂπ∂ÈáçÊñ∞Âä†ËΩΩ
        }
        // ÂêåÊó∂Êõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫ÔºàÂ¶ÇÊûúÂàöÊâçËß£ÂºÄ‰∫ÜÈáçÁΩÆ‰ΩôÈ¢ùÁöÑÊ≥®ÈáäÔºâ
        if (window.userBalance !== undefined) {
          const wallet = await db.userWallet.get('main');
          if (wallet) {
            window.userBalance = wallet.balance;
            document.getElementById('alipay-balance-display').textContent = window.userBalance.toFixed(2);
          }
        }
      }
      document.getElementById('data-clear-wizard-modal').classList.remove('visible');
      await showCustomAlert("Ê∏ÖÁêÜÂÆåÊàê", "ÊåáÂÆöÁöÑÊï∞ÊçÆÂ∑≤ÊàêÂäüÊ∏ÖÈô§„ÄÇ");

    } catch (error) {
      console.error("È´òÁ∫ßÊï∞ÊçÆÊ∏ÖÁêÜÂ§±Ë¥•:", error);
      await showCustomAlert("Ê∏ÖÁêÜÂ§±Ë¥•", `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
  }

  async function handleIconChange(iconId, phoneType, itemElement) {
    const appName = itemElement.querySelector('.icon-preview').alt;

    const choice = await showChoiceModal(`Êõ¥Êç¢‚Äú${appName}‚ÄùÂõæÊ†á`, [
      { text: 'üìÅ ‰ªéÊú¨Âú∞‰∏ä‰º†', value: 'local' },
      { text: 'üåê ‰ΩøÁî®ÁΩëÁªúURL', value: 'url' },
      { text: 'üîÑ ÈáçÁΩÆ‰∏∫ÈªòËÆ§', value: 'reset' }
    ]);

    // Â§ÑÁêÜÈáçÁΩÆÈÄªËæë
    if (choice === 'reset') {
      const iconElement = itemElement.querySelector('.icon-preview');
      const defaultSrc = iconElement.dataset.defaultSrc;

      if (defaultSrc) {
        // ÊÅ¢Â§çÂà∞ÈªòËÆ§ÂõæÊ†á
        iconElement.src = defaultSrc;

        // ‰ªéÂØπÂ∫îÁöÑÊï∞ÊçÆÂ∫ìÂØπË±°‰∏≠Âà†Èô§ËØ•ËÆ∞ÂΩï
        if (phoneType === 'cphone') {
          if (state.globalSettings.cphoneAppIcons && state.globalSettings.cphoneAppIcons[iconId]) {
            delete state.globalSettings.cphoneAppIcons[iconId];
          }
        } else if (phoneType === 'myphone') {
          if (state.globalSettings.myphoneAppIcons && state.globalSettings.myphoneAppIcons[iconId]) {
            delete state.globalSettings.myphoneAppIcons[iconId];
          }
        } else {
          if (state.globalSettings.appIcons && state.globalSettings.appIcons[iconId]) {
            delete state.globalSettings.appIcons[iconId];
          }
        }

        await db.globalSettings.put(state.globalSettings);
        await showCustomAlert("ÊàêÂäü", "Â∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂõæÊ†áÔºÅ");
      } else {
        // Ê≤°ÊúâÈªòËÆ§ÂõæÊ†áÔºåÈáçÁΩÆ‰∏∫Á∫ØÁôΩËâ≤
        // ÂàõÂª∫‰∏Ä‰∏™1x1ÁöÑÁ∫ØÁôΩËâ≤ÂõæÁâáÁöÑBase64
        const whitePixel = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2P4//8/AAX+Av4N70a4AAAAAElFTkSuQmCC';
        iconElement.src = whitePixel;

        // ‰ªéÂØπÂ∫îÁöÑÊï∞ÊçÆÂ∫ìÂØπË±°‰∏≠Âà†Èô§ËØ•ËÆ∞ÂΩï
        if (phoneType === 'cphone') {
          if (state.globalSettings.cphoneAppIcons && state.globalSettings.cphoneAppIcons[iconId]) {
            delete state.globalSettings.cphoneAppIcons[iconId];
          }
        } else if (phoneType === 'myphone') {
          if (state.globalSettings.myphoneAppIcons && state.globalSettings.myphoneAppIcons[iconId]) {
            delete state.globalSettings.myphoneAppIcons[iconId];
          }
        } else {
          if (state.globalSettings.appIcons && state.globalSettings.appIcons[iconId]) {
            delete state.globalSettings.appIcons[iconId];
          }
        }

        await db.globalSettings.put(state.globalSettings);
        await showCustomAlert("ÊàêÂäü", "Ê≤°ÊúâÈªòËÆ§‰ø°ÊÅØÔºåÂ∑≤ÈáçÁΩÆ‰∏∫Á∫ØÁôΩÔºÅ");
      }
      return;
    }

    let newUrl = null;
    let isBase64 = false;

    if (choice === 'local') {
      newUrl = await new Promise(resolve => { // ÁÆÄÂåñÁâà uploadImageLocally
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = e => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (readerEvent) => resolve(readerEvent.target.result);
            reader.readAsDataURL(file);
          } else {
            resolve(null);
          }
        };
        input.click();
      });
      if (newUrl) isBase64 = true;

    } else if (choice === 'url') {
      let currentUrl;
      if (phoneType === 'cphone') {
        currentUrl = state.globalSettings.cphoneAppIcons[iconId];
      } else if (phoneType === 'myphone') {
        currentUrl = state.globalSettings.myphoneAppIcons[iconId];
      } else {
        currentUrl = state.globalSettings.appIcons[iconId];
      }
      const isCurrentUrlBase64 = currentUrl && currentUrl.startsWith('data:image');

      const initialValueForPrompt = isCurrentUrlBase64 ? '' : currentUrl;

      newUrl = await showCustomPrompt(`Êõ¥Êç¢ÂõæÊ†á`, 'ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂõæÁâáURL', initialValueForPrompt, 'url');


      if (newUrl) isBase64 = false;
    }

    if (newUrl && newUrl.trim()) {
      const trimmedUrl = newUrl.trim();


      itemElement.querySelector('.icon-preview').src = trimmedUrl;


      let dbPath;
      if (phoneType === 'cphone') {
        dbPath = `cphoneAppIcons.${iconId}`;
        state.globalSettings.cphoneAppIcons[iconId] = trimmedUrl;
      } else if (phoneType === 'myphone') {
        dbPath = `myphoneAppIcons.${iconId}`;
        state.globalSettings.myphoneAppIcons[iconId] = trimmedUrl;
      } else {
        dbPath = `appIcons.${iconId}`;
        state.globalSettings.appIcons[iconId] = trimmedUrl;
      }
      await db.globalSettings.put(state.globalSettings);
      await showCustomAlert("ÊàêÂäü", "ÂõæÊ†áÂ∑≤Êõ¥Êñ∞ÔºÅ");


      if (isBase64) {
        (async () => {
          console.log(`[ImgBB] ÂêØÂä® ${dbPath} ÁöÑÈùôÈªò‰∏ä‰º†...`);
          await silentlyUpdateDbUrl(
            db.globalSettings,
            'main',
            dbPath,
            trimmedUrl // The Base64 string
          );
        })();
      }
    } else if (newUrl !== null) {
      alert("ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑURLÊàñÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂ÔºÅ");
    }
  }


  async function compressAllLocalImages() {

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§ÂéãÁº©ÂõæÁâáÔºü',
      'Ê≠§Êìç‰ΩúÂ∞ÜÊâ´ÊèèÂπ∂ÂéãÁº©ÊâÄÊúâÊú¨Âú∞‰∏ä‰º†ÁöÑÂõæÁâáÔºàBase64Ê†ºÂºèÔºâÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫JPEG‰ª•ÂáèÂ∞è‰ΩìÁßØ„ÄÇËøô‰ºöËΩªÂæÆÈôç‰ΩéÂõæÁâáË¥®Èáè‰∏î„Äê‰∏çÂèØÊÅ¢Â§ç„Äë„ÄÇ<br><br><strong>Âº∫ÁÉàÂª∫ËÆÆÂú®Êìç‰ΩúÂâçÂÖàËøõË°åÊï∞ÊçÆÂ§á‰ªΩÔºÅ</strong>', {
      confirmButtonClass: 'btn-danger',
      confirmText: 'ÊàëÂ∑≤‰∫ÜËß£È£éÈô©ÔºåÁ°ÆËÆ§ÂéãÁº©'
    }
    );

    if (!confirmed) return;


    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÂºÄÂßãÂÖ®Èù¢ÂéãÁº©ÂõæÁâáÔºåÊ†πÊçÆÂõæÁâáÊï∞ÈáèÔºåËøôÂèØËÉΩÈúÄË¶ÅÂá†ÂàÜÈíüÊó∂Èó¥ÔºåËØ∑‰∏çË¶ÅÂÖ≥Èó≠ÊàñÂà∑Êñ∞È°µÈù¢...");

    let stats = {
      found: 0,
      compressed: 0,
      skipped: 0,
      originalSize: 0,
      newSize: 0
    };

    try {





      console.log("ÂéãÁº©Ê≠•È™§ 1/3: Ê≠£Âú®‰ªéÊï∞ÊçÆÂ∫ìËØªÂèñÊâÄÊúâÁõ∏ÂÖ≥Êï∞ÊçÆ...");
      const tablesToScan = [
        'chats', 'globalSettings', 'qzoneSettings',
        'userStickers', 'customAvatarFrames'
      ];
      const allData = [];
      for (const tableName of tablesToScan) {
        const table = db.table(tableName);
        const records = await table.toArray();
        allData.push({
          tableName,
          records
        });
      }


      console.log("ÂéãÁº©Ê≠•È™§ 2/3: Ê≠£Âú®ÂÜÖÂ≠ò‰∏≠ÂºÇÊ≠•ÂéãÁº©ÂõæÁâáÔºåËøôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥...");
      for (const data of allData) {
        for (const record of data.records) {

          await traverseAndCompress(record, stats);
        }
      }


      console.log("ÂéãÁº©Ê≠•È™§ 3/3: Ê≠£Âú®Â∞ÜÂéãÁº©ÂêéÁöÑÊï∞ÊçÆÂÜôÂõûÊï∞ÊçÆÂ∫ì...");
      await db.transaction('rw', tablesToScan, async () => {
        for (const data of allData) {

          await db.table(data.tableName).bulkPut(data.records);
        }
      });






      const reduction = stats.originalSize - stats.newSize;
      const reductionPercent = stats.originalSize > 0 ? (reduction / stats.originalSize * 100).toFixed(2) : 0;

      await showCustomAlert(
        'ÂéãÁº©ÂÆåÊàêÔºÅ',
        `Êâ´ÊèèÂÆåÊàêÔºÅ<br>
            - ÂÖ±ÊâæÂà∞ ${stats.found} Âº†Êú¨Âú∞ÂõæÁâá<br>
            - ÊàêÂäüÂéãÁº© ${stats.compressed} Âº†<br>
            - Ë∑≥Ëøá(Â∑≤ÂéãÁº©ÊàñÊó†ÈúÄÂéãÁº©) ${stats.skipped} Âº†<br>
            - Á©∫Èó¥ËäÇÁúÅ‰∫Ü <strong>${(reduction / 1024 / 1024).toFixed(2)} MB</strong> (ÂéãÁº©Áéá ${reductionPercent}%)
            <br><br>
            Âª∫ËÆÆÂà∑Êñ∞È°µÈù¢‰ª•Â∫îÁî®ÊâÄÊúâÊõ¥Êîπ„ÄÇ`
      );

    } catch (error) {
      console.error("ÂõæÁâáÂéãÁº©ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ:", error);
      await showCustomAlert('ÂéãÁº©Â§±Ë¥•', `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
  }

  function calculateTotalSizeRecursive(obj, parentKey = '') {
    let totalSize = 0;
    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        const value = obj[key];
        if (typeof value === 'string' && value.startsWith('data:image')) {


          const isExcluded =

            (parentKey === 'globalSettings' && (key === 'wallpaper' || key === 'cphoneWallpaper' || key === 'globalChatBackground')) ||

            (parentKey === 'widgetData') ||

            (parentKey === 'settings' && key === 'background') ||

            (parentKey === 'appIcons' || parentKey === 'cphoneAppIcons' || parentKey === 'myphoneAppIcons');

          if (!isExcluded) {
            totalSize += value.length;
          }


        } else if (typeof value === 'object' && value !== null) {

          totalSize += calculateTotalSizeRecursive(value, key);
        }
      }
    }
    return totalSize;
  }


  async function displayTotalImageSize() {
    const displayElement = document.getElementById('total-image-size-display');
    if (!displayElement) return;

    displayElement.innerHTML = `
        <span id="image-size-label">Ê≠£Âú®ËÆ°ÁÆóÂèØÂéãÁº©ÂõæÁâáÂ§ßÂ∞è...</span>
        <span id="image-size-value">-- MB</span>
    `;

    try {
      let totalBytes = 0;
      const tablesToScan = [
        'chats', 'globalSettings', 'qzoneSettings',
        'userStickers', 'customAvatarFrames'
      ];

      for (const tableName of tablesToScan) {
        const table = db.table(tableName);
        await table.each(record => {

          totalBytes += calculateTotalSizeRecursive(record);
        });
      }

      const totalMB = (totalBytes / 1024 / 1024).toFixed(2);

      displayElement.innerHTML = `
            <span id="image-size-label">Êú¨Âú∞ÂõæÁâá(Â§¥ÂÉè/Ë°®ÊÉÖ/Â§¥ÂÉèÊ°Ü/Á≠â)Â§ßÂ∞è:</span>
            <span id="image-size-value"><strong>${totalMB} MB</strong></span>
        `;

    } catch (error) {
      console.error("ËÆ°ÁÆóÂõæÁâáÊÄªÂ§ßÂ∞èÊó∂Âá∫Èîô:", error);
      displayElement.innerHTML = `
            <span id="image-size-label">ËÆ°ÁÆóÂõæÁâáÂ§ßÂ∞èÊó∂Âá∫Èîô</span>
            <span id="image-size-value">Error</span>
        `;
    }
  }

  // Ê∏ÖÁ©∫ËÅäÂ§©‰∏≠ÁöÑË°®ÊÉÖÂåÖÊ∂àÊÅØ
  let selectedCharsForStickerClear = [];

  async function openClearStickersModal() {
    const modal = document.getElementById('clear-stickers-modal');
    selectedCharsForStickerClear = [];
    
    // ËÆ°ÁÆóÂπ∂ÊòæÁ§∫Â≠òÂÇ®Âç†Áî®
    const statsEl = document.getElementById('sticker-storage-stats');
    statsEl.innerHTML = 'Ê≠£Âú®ËÆ°ÁÆó...';
    
    const stats = await calculateChatStickerStorageSize();
    if (stats) {
      statsEl.innerHTML = `
        <div>ËÅäÂ§©‰∏≠ÊÄªË°®ÊÉÖÊ∂àÊÅØÊï∞Ôºö<strong>${stats.totalCount}</strong> Êù°</div>
        <div>‚Ä¢ Base64Ë°®ÊÉÖÊ∂àÊÅØÔºö<strong>${stats.base64Count}</strong> Êù° (<strong>${stats.totalMB} MB</strong>)</div>
        <div>‚Ä¢ ÁΩëÁªúURLË°®ÊÉÖÊ∂àÊÅØÔºö<strong>${stats.urlCount}</strong> Êù° (‰∏çÂç†Êú¨Âú∞Á©∫Èó¥)</div>
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ffc107;">
          üí° <strong>ÁªìËÆ∫Ôºö</strong>${stats.base64Count > 0 ? `ËÅäÂ§©‰∏≠ÁöÑBase64Ë°®ÊÉÖÊ∂àÊÅØÂç†Áî®‰∫Ü ${stats.totalMB} MB Êú¨Âú∞Â≠òÂÇ®Á©∫Èó¥` : 'ËÅäÂ§©‰∏≠ÁöÑË°®ÊÉÖÊ∂àÊÅØÊ≤°ÊúâÂç†Áî®Êú¨Âú∞Â≠òÂÇ®Á©∫Èó¥'}
        </div>
      `;
    } else {
      statsEl.innerHTML = '<div style="color: #dc3545;">ËÆ°ÁÆóÂ§±Ë¥•</div>';
    }

    await renderClearStickersList();
    modal.classList.add('visible');
  }

  async function calculateChatStickerStorageSize() {
    try {
      const allChats = await db.chats.toArray();
      let totalCount = 0;
      let base64Count = 0;
      let base64Size = 0;
      let urlCount = 0;

      for (const chat of allChats) {
        if (chat.history && Array.isArray(chat.history)) {
          for (const msg of chat.history) {
            // Ê£ÄÊü•ÊòØÂê¶ÊòØË°®ÊÉÖÊ∂àÊÅØÔºöÊúâmeaningÂ≠óÊÆµÊàñtype==='sticker'
            const isSticker = msg.meaning || msg.type === 'sticker';
            if (isSticker && msg.content) {
              totalCount++;
              if (msg.content.startsWith('data:image')) {
                base64Count++;
                base64Size += msg.content.length;
              } else {
                urlCount++;
              }
            }
          }
        }
      }

      const totalMB = (base64Size / 1024 / 1024).toFixed(2);
      return {
        totalCount,
        base64Count,
        base64Size,
        totalMB,
        urlCount
      };
    } catch (error) {
      console.error('ËÆ°ÁÆóËÅäÂ§©Ë°®ÊÉÖÂåÖÂ§ßÂ∞èÊó∂Âá∫Èîô:', error);
      return null;
    }
  }

  async function renderClearStickersList() {
    const listEl = document.getElementById('clear-stickers-category-list');
    listEl.innerHTML = '';

    const allChats = await db.chats.toArray();
    const chatsWithStickers = [];

    // ÁªüËÆ°ÊØè‰∏™ËßíËâ≤ÁöÑË°®ÊÉÖÊ∂àÊÅØÊï∞ÈáèÂíåÂ§ßÂ∞è
    for (const chat of allChats) {
      if (chat.isGroup) continue; // ÊöÇ‰∏çÊîØÊåÅÁæ§ËÅä

      let stickerCount = 0;
      let totalSize = 0;
      let base64Count = 0;

      if (chat.history && Array.isArray(chat.history)) {
        for (const msg of chat.history) {
          const isSticker = msg.meaning || msg.type === 'sticker';
          if (isSticker && msg.content) {
            stickerCount++;
            if (msg.content.startsWith('data:image')) {
              base64Count++;
              totalSize += msg.content.length;
            }
          }
        }
      }

      if (stickerCount > 0) {
        chatsWithStickers.push({
          id: chat.id,
          name: chat.name,
          avatar: chat.settings?.aiAvatar || defaultAvatar,
          stickerCount,
          base64Count,
          totalSize
        });
      }
    }

    // ÊåâË°®ÊÉÖÊï∞ÈáèÊéíÂ∫è
    chatsWithStickers.sort((a, b) => b.stickerCount - a.stickerCount);

    if (chatsWithStickers.length === 0) {
      listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">ËÅäÂ§©‰∏≠Ê≤°ÊúâÂèëÈÄÅËøáË°®ÊÉÖÂåÖÊ∂àÊÅØ</div>';
      return;
    }

    chatsWithStickers.forEach(chatInfo => {
      const sizeMB = (chatInfo.totalSize / 1024 / 1024).toFixed(2);
      const item = document.createElement('div');
      item.className = 'clear-posts-item';
      item.dataset.chatId = chatInfo.id;
      item.innerHTML = `
        <img src="${chatInfo.avatar}" class="avatar" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px;">
        <div style="flex: 1;">
          <div style="font-weight: 500;">${chatInfo.name}</div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
            ${chatInfo.stickerCount} Êù°Ë°®ÊÉÖÊ∂àÊÅØ (Base64: ${chatInfo.base64Count}Êù°, ${sizeMB} MB)
          </div>
        </div>
      `;
      listEl.appendChild(item);
    });
  }

  async function handleConfirmClearStickers() {
    if (selectedCharsForStickerClear.length === 0) {
      await showCustomAlert('ÊèêÁ§∫', 'ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊ∏ÖÁ©∫Ë°®ÊÉÖÁöÑËßíËâ≤');
      return;
    }

    const selectedItems = document.querySelectorAll('#clear-stickers-category-list .clear-posts-item.selected');
    const charNames = [];
    selectedItems.forEach(item => {
      const name = item.querySelector('div').textContent.trim();
      charNames.push(name);
    });

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Ê∏ÖÁ©∫',
      `Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫‰ª•‰∏ã ${selectedCharsForStickerClear.length} ‰∏™ËßíËâ≤ÁöÑËÅäÂ§©Ë°®ÊÉÖÂåÖÊ∂àÊÅØÂêóÔºü\n\n${charNames.join('\n')}\n\n‚ö†Ô∏è Ê≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ‰ªÖÂà†Èô§Ë°®ÊÉÖÊ∂àÊÅØÔºå‰øùÁïôÊñáÂ≠óËÅäÂ§©ËÆ∞ÂΩï„ÄÇ`,
      { confirmText: 'Á°ÆËÆ§Ê∏ÖÁ©∫', cancelText: 'ÂèñÊ∂à' }
    );

    if (!confirmed) return;

    try {
      await showCustomAlert('ËØ∑Á®çÂÄô', 'Ê≠£Âú®Ê∏ÖÁ©∫Ë°®ÊÉÖÂåÖÊ∂àÊÅØ...');

      let totalDeletedMessages = 0;
      let totalFreedSize = 0;

      for (const chatId of selectedCharsForStickerClear) {
        const chat = await db.chats.get(chatId);
        if (!chat || !chat.history) continue;

        const originalLength = chat.history.length;
        let deletedSize = 0;

        // ËøáÊª§ÊéâË°®ÊÉÖÊ∂àÊÅØ
        chat.history = chat.history.filter(msg => {
          const isSticker = msg.meaning || msg.type === 'sticker';
          if (isSticker) {
            if (msg.content && msg.content.startsWith('data:image')) {
              deletedSize += msg.content.length;
            }
            return false; // Âà†Èô§Ë°®ÊÉÖÊ∂àÊÅØ
          }
          return true; // ‰øùÁïôÂÖ∂‰ªñÊ∂àÊÅØ
        });

        const deletedCount = originalLength - chat.history.length;
        totalDeletedMessages += deletedCount;
        totalFreedSize += deletedSize;

        await db.chats.put(chat);
        
        // Êõ¥Êñ∞ state
        if (state.chats[chatId]) {
          state.chats[chatId].history = chat.history;
        }
      }

      document.getElementById('clear-stickers-modal').classList.remove('visible');

      const freedMB = (totalFreedSize / 1024 / 1024).toFixed(2);
      await showCustomAlert(
        'Ê∏ÖÁ©∫ÂÆåÊàê', 
        `Â∑≤ÊàêÂäüÂà†Èô§ ${totalDeletedMessages} Êù°Ë°®ÊÉÖÂåÖÊ∂àÊÅØÔºÅ\nÈáäÊîæ‰∫ÜÁ∫¶ ${freedMB} MB Â≠òÂÇ®Á©∫Èó¥„ÄÇ`
      );

      // Âà∑Êñ∞ÂΩìÂâçËÅäÂ§©ÁïåÈù¢
      if (state.activeChatId && selectedCharsForStickerClear.includes(state.activeChatId)) {
        await renderChatScreen();
      }

      // Âà∑Êñ∞Â≠òÂÇ®Â§ßÂ∞èÊòæÁ§∫
      displayTotalImageSize();
    } catch (error) {
      console.error('Ê∏ÖÁ©∫Ë°®ÊÉÖÂåÖÊ∂àÊÅØÊó∂Âá∫Èîô:', error);
      await showCustomAlert('Ê∏ÖÁ©∫Â§±Ë¥•', 'Êìç‰ΩúËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºåËØ∑ÈáçËØï');
    }
  }

  // Ê∏ÖÁ©∫ËÅäÂ§©ÂõæÁâáÁõ∏ÂÖ≥ÂáΩÊï∞
  let selectedCharsForImageClear = [];

  function openClearChatImagesModal() {
    const modal = document.getElementById('clear-chat-images-modal');
    selectedCharsForImageClear = [];

    renderClearChatImagesList();
    modal.classList.add('visible');
  }

  async function renderClearChatImagesList() {
    const listEl = document.getElementById('clear-chat-images-list');
    listEl.innerHTML = '';

    const allChats = await db.chats.toArray();
    const chatsWithImages = [];

    // ÁªüËÆ°ÊØè‰∏™ËßíËâ≤ÁöÑÂõæÁâáÊï∞ÈáèÂíåÂ§ßÂ∞è
    for (const chat of allChats) {
      if (chat.isGroup) continue;

      let imageCount = 0;
      let totalSize = 0;

      if (chat.history && Array.isArray(chat.history)) {
        for (const msg of chat.history) {
          // Ê£ÄÊü• msg.images Ê†ºÂºèÔºàÊóßÊ†ºÂºèÔºâ
          if (msg.images && Array.isArray(msg.images)) {
            for (const img of msg.images) {
              if (typeof img === 'string' && img.startsWith('data:image')) {
                imageCount++;
                totalSize += img.length;
              }
            }
          }
          // Ê£ÄÊü• msg.content Ê†ºÂºèÔºàÊñ∞Ê†ºÂºèÔºöÂõæÁâá‰∏ä‰º†Ôºâ
          if (Array.isArray(msg.content)) {
            for (const item of msg.content) {
              if (item.type === 'image_url' && item.image_url && item.image_url.url) {
                const url = item.image_url.url;
                if (typeof url === 'string' && url.startsWith('data:image')) {
                  imageCount++;
                  totalSize += url.length;
                }
              }
            }
          }
        }
      }

      if (imageCount > 0) {
        chatsWithImages.push({
          id: chat.id,
          name: chat.name,
          imageCount: imageCount,
          totalSize: totalSize
        });
      }
    }

    if (chatsWithImages.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">Ê≤°ÊúâÊâæÂà∞ÂåÖÂê´Êú¨Âú∞ÂõæÁâáÁöÑËÅäÂ§©ËßíËâ≤</p>';
      return;
    }

    // ÊåâÂõæÁâáÊï∞ÈáèÈôçÂ∫èÊéíÂàó
    chatsWithImages.sort((a, b) => b.imageCount - a.imageCount);

    chatsWithImages.forEach(chat => {
      const sizeMB = (chat.totalSize / 1024 / 1024).toFixed(2);
      const item = document.createElement('div');
      item.className = 'clear-posts-item';
      item.dataset.charId = chat.id;
      item.innerHTML = `
        <div class="checkbox"></div>
        <div>
          <span class="name">${chat.name}</span>
          <p style="font-size: 12px; color: #888; margin: 4px 0 0;">${chat.imageCount} Âº†ÂõæÁâáÔºåÂç†Áî® ${sizeMB} MB</p>
        </div>
      `;
      listEl.appendChild(item);
    });
  }

  async function handleConfirmClearChatImages() {
    const selectedItems = document.querySelectorAll('#clear-chat-images-list .clear-posts-item.selected');

    if (selectedItems.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤„ÄÇ");
      return;
    }

    selectedCharsForImageClear = Array.from(selectedItems).map(item => item.dataset.charId);

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Ê∏ÖÁ©∫ÂõæÁâáÔºü',
      `Âç≥Â∞ÜÊ∏ÖÁ©∫ <strong>${selectedCharsForImageClear.length}</strong> ‰∏™ËßíËâ≤ÁöÑÊâÄÊúâËÅäÂ§©Êú¨Âú∞ÂõæÁâá„ÄÇ<br><br>Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºåÂª∫ËÆÆÂÖàÂØºÂá∫Êï∞ÊçÆÂ§á‰ªΩ„ÄÇ`,
      {
        confirmButtonClass: 'btn-danger',
        confirmText: 'Á°ÆËÆ§Ê∏ÖÁ©∫'
      }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®Ê∏ÖÁ©∫ÂõæÁâáÔºåËØ∑‰∏çË¶ÅÂÖ≥Èó≠È°µÈù¢...");

    try {
      let stats = {
        chatsProcessed: 0,
        imagesCleared: 0,
        sizeFreed: 0
      };

      await db.transaction('rw', db.chats, async () => {
        for (const chatId of selectedCharsForImageClear) {
          const chat = await db.chats.get(chatId);
          if (!chat) continue;

          if (chat.history && Array.isArray(chat.history)) {
            for (const msg of chat.history) {
              // Ê∏ÖÁ©∫ msg.images Ê†ºÂºèÔºàÊóßÊ†ºÂºèÔºâ
              if (msg.images && Array.isArray(msg.images)) {
                for (const img of msg.images) {
                  if (typeof img === 'string' && img.startsWith('data:image')) {
                    stats.imagesCleared++;
                    stats.sizeFreed += img.length;
                  }
                }
                msg.images = [];
              }
              // Ê∏ÖÁ©∫ msg.content ‰∏≠ÁöÑÂõæÁâáÔºàÊñ∞Ê†ºÂºèÔºâ
              if (Array.isArray(msg.content)) {
                const newContent = [];
                for (const item of msg.content) {
                  if (item.type === 'image_url' && item.image_url && item.image_url.url) {
                    const url = item.image_url.url;
                    if (typeof url === 'string' && url.startsWith('data:image')) {
                      stats.imagesCleared++;
                      stats.sizeFreed += url.length;
                      // ‰∏çÊ∑ªÂä†Âà∞ newContentÔºåÂç≥Âà†Èô§ËØ•ÂõæÁâá
                    } else {
                      newContent.push(item);
                    }
                  } else {
                    newContent.push(item);
                  }
                }
                msg.content = newContent;
              }
            }
          }

          await db.chats.put(chat);
          stats.chatsProcessed++;
        }
      });

      const freedMB = (stats.sizeFreed / 1024 / 1024).toFixed(2);

      document.getElementById('clear-chat-images-modal').classList.remove('visible');

      // Ê∏ÖÁ©∫ÊàêÂäüÔºåËØ¢ÈóÆÁî®Êà∑ÊòØÂê¶Âà∑Êñ∞È°µÈù¢
      const shouldRefresh = await showCustomConfirm(
        'Ê∏ÖÁ©∫ÂÆåÊàê',
        `Â∑≤ÊàêÂäüÊ∏ÖÁ©∫ ${stats.chatsProcessed} ‰∏™ËßíËâ≤ÁöÑËÅäÂ§©ÂõæÁâá„ÄÇ<br>
        Ê∏ÖÁ©∫‰∫Ü ${stats.imagesCleared} Âº†ÂõæÁâá<br>
        ÈáäÊîæ‰∫Ü <strong>${freedMB} MB</strong> Á©∫Èó¥<br><br>
        ÊòØÂê¶Á´ãÂç≥Âà∑Êñ∞È°µÈù¢‰ª•‰ΩøÊõ¥ÊîπÁîüÊïàÔºü<br>
        <span style="color: #666; font-size: 14px;">ÔºàÁÇπÂáª"ÂèñÊ∂à"ÂèØ‰ª•ÁªßÁª≠ËøõË°åÂÖ∂‰ªñÊìç‰ΩúÔºâ</span>`,
        {
          confirmText: 'Á´ãÂç≥Âà∑Êñ∞',
          cancelText: 'Á®çÂêéÂà∑Êñ∞'
        }
      );

      if (shouldRefresh) {
        // Áî®Êà∑ÈÄâÊã©Âà∑Êñ∞È°µÈù¢
        location.reload();
      } else {
        // Áî®Êà∑ÈÄâÊã©‰∏çÂà∑Êñ∞ÔºåÂ∞ùËØïÂ±ÄÈÉ®Âà∑Êñ∞
        if (state.currentChatId && selectedCharsForImageClear.includes(state.currentChatId)) {
          await loadChat(state.currentChatId);
        }
      }

    } catch (error) {
      console.error("Ê∏ÖÁ©∫ÂõæÁâáÊó∂Âá∫Èîô:", error);
      await showCustomAlert('Ê∏ÖÁ©∫Â§±Ë¥•', `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
  }

  function calculateSkippedStats(obj) {
    let found = 0;
    let size = 0;
    if (typeof obj !== 'object' || obj === null) return {
      found,
      size
    };

    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        const value = obj[key];
        if (typeof value === 'string' && value.startsWith('data:image')) {
          found++;
          size += value.length;
        } else if (typeof value === 'object' && value !== null) {
          const nestedStats = calculateSkippedStats(value);
          found += nestedStats.found;
          size += nestedStats.size;
        }
      }
    }
    return {
      found,
      size
    };
  }

  async function traverseAndCompress(obj, stats, parentKey = '') {

    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {


        if (parentKey === '' && (key === 'widgetData' || key === 'appIcons' || key === 'cphoneAppIcons' || key === 'myphoneAppIcons')) {
          console.log(`Ë∑≥ËøáÂéãÁº©Êï¥‰∏™ÂØπË±°: ${key}`);
          const {
            found,
            size
          } = calculateSkippedStats(obj[key]);
          stats.found += found;
          stats.skipped += found;
          stats.originalSize += size;
          stats.newSize += size;
          continue;
        }

        const value = obj[key];


        if (typeof value === 'string' && value.startsWith('data:image')) {


          const isExcluded =

            (parentKey === '' && (key === 'wallpaper' || key === 'cphoneWallpaper' || key === 'globalChatBackground')) ||

            (parentKey === 'settings' && key === 'background');

          if (isExcluded) {
            console.log(`Ë∑≥ËøáÂéãÁº©ËÉåÊôØÂõæÁâá: ${parentKey || 'global'}.${key}`);
            stats.found++;
            stats.skipped++;
            stats.originalSize += value.length;
            stats.newSize += value.length;
            continue;
          }

          stats.found++;
          stats.originalSize += value.length;

          const compressedBase64 = await compressImage(value);
          if (compressedBase64 && compressedBase64 !== value) {
            obj[key] = compressedBase64;
            stats.compressed++;
            stats.newSize += compressedBase64.length;
          } else {
            stats.skipped++;
            stats.newSize += value.length;
          }


        } else if (typeof value === 'object' && value !== null) {

          await traverseAndCompress(value, stats, key);
        }
      }
    }
  }


  async function compressImage(base64Str) {

    if (!base64Str.startsWith('data:image')) {
      return base64Str;
    }


    const MAX_BASE64_SIZE_TO_SKIP = 500000;
    if (base64Str.startsWith('data:image/jpeg') && base64Str.length < MAX_BASE64_SIZE_TO_SKIP) {
      console.log('Ë∑≥ËøáÂéãÁº©ÔºöÂõæÁâáÂ∑≤ÁªèÊòØÂ∞è‰ΩìÁßØJPEG„ÄÇ');
      return base64Str;
    }

    try {

      const imageBlob = await (await fetch(base64Str)).blob();


      const SIZE_THRESHOLD_BYTES = 0.3 * 1024 * 1024;
      if (imageBlob.size < SIZE_THRESHOLD_BYTES) {
        console.log(`Ë∑≥ËøáÂéãÁº©ÔºöÂõæÁâáÂ§ßÂ∞è (${(imageBlob.size / 1024 / 1024).toFixed(2)} MB) Â∑≤Â∞è‰∫é 0.3 MB„ÄÇ`);
        return base64Str;
      }



      const options = {
        maxSizeMB: 0.5,
        maxWidthOrHeight: 800,
        useWebWorker: true,
        initialQuality: 0.5,
        fileType: 'image/jpeg'
      };



      console.log(`ÂºÄÂßãÂéãÁº©ÂõæÁâáÔºåÂéüÂßãÂ§ßÂ∞è: ${(imageBlob.size / 1024 / 1024).toFixed(2)} MB`);
      const compressedFile = await imageCompression(imageBlob, options);
      console.log(`ÂéãÁº©ÂÆåÊàêÔºåÊñ∞ÁöÑÂ§ßÂ∞è: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);


      if (compressedFile.size > imageBlob.size) {
        console.warn("ÂéãÁº©ÂêéÁöÑÂõæÁâá‰ΩìÁßØÂ¢ûÂ§ßÔºåÂ∑≤‰øùÁïôÂéüÂßãÂõæÁâá„ÄÇ");
        return base64Str;
      }


      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(compressedFile);
      });

    } catch (error) {
      console.error("‰ΩøÁî® browser-image-compression ÂéãÁº©Â§±Ë¥•:", error);
      return base64Str;
    }
  }


  function compareVersions(v1, v2) {

    if (!v1 || !v2 || typeof v1 !== 'string' || typeof v2 !== 'string') {
      return 0;
    }

    const parts1 = v1.split('.').map(Number);
    const parts2 = v2.split('.').map(Number);
    const len = Math.max(parts1.length, parts2.length);

    for (let i = 0; i < len; i++) {
      const p1 = parts1[i] || 0; // Â¶ÇÊûúÈÉ®ÂàÜ‰∏çÂ≠òÂú®ÔºåÂàôËßÜ‰∏∫ 0
      const p2 = parts2[i] || 0;

      if (p1 > p2) {
        return 1;
      }
      if (p1 < p2) {
        return -1;
      }
    }
    return 0;
  }


  async function checkForUpdates() {



    const CURRENT_APP_VERSION = "1.0";

    try {

      const response = await fetch('update-notice.html?_=' + Date.now());
      if (!response.ok) {
        console.warn('Ëé∑ÂèñÊõ¥Êñ∞ÈÄöÁü•Êñá‰ª∂Â§±Ë¥•„ÄÇ');
        return;
      }
      const noticeHtml = await response.text();


      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = noticeHtml;
      const noticeContent = tempDiv.querySelector('[data-version]');

      if (!noticeContent) {
        console.error('Êõ¥Êñ∞ÈÄöÁü•Êñá‰ª∂‰∏≠Áº∫Â∞ë data-version Â±ûÊÄß„ÄÇ');
        return;
      }

      const notificationVersion = noticeContent.dataset.version;


      const dismissedVersion = localStorage.getItem('dismissedUpdateVersion');



      if (!dismissedVersion || compareVersions(notificationVersion, dismissedVersion) > 0) {
        console.log(`ÂèëÁé∞Êñ∞ÁâàÊú¨ÈÄöÁü•: ${notificationVersion} (Â∑≤ÂøΩÁï•ÁâàÊú¨: ${dismissedVersion || 'Êó†'})`);
        showUpdateNotice(notificationVersion, noticeContent.innerHTML);
      } else {
        console.log(`ÂΩìÂâçÈÄöÁü•ÁâàÊú¨ (${notificationVersion}) Â∑≤Ë¢´Áî®Êà∑ÂøΩÁï•Êàñ‰∏∫ÊóßÁâàÊú¨ÔºåÊó†ÈúÄÊòæÁ§∫„ÄÇ`);
      }

    } catch (error) {
      console.error('Ê£ÄÊü•Êõ¥Êñ∞Êó∂Âá∫Èîô:', error);
    }
  }


  function showUpdateNotice(version, contentHtml) {
    const modal = document.getElementById('update-notice-modal');
    const body = document.getElementById('update-notice-body');
    const confirmBtn = document.getElementById('update-notice-confirm-btn');
    const dismissBtn = document.getElementById('update-notice-dismiss-btn');

    body.innerHTML = contentHtml;


    confirmBtn.disabled = true;
    dismissBtn.disabled = true;


    const confirmOriginalText = confirmBtn.textContent;
    let countdown = 10;
    confirmBtn.textContent = `${confirmOriginalText} (${countdown}s)`;


    const countdownInterval = setInterval(() => {
      countdown--;
      if (countdown > 0) {

        confirmBtn.textContent = `${confirmOriginalText} (${countdown}s)`;
      } else {

        clearInterval(countdownInterval);
        confirmBtn.disabled = false;
        dismissBtn.disabled = false;
        confirmBtn.textContent = confirmOriginalText;
      }
    }, 1000);


    confirmBtn.onclick = () => {
      clearInterval(countdownInterval);
      modal.classList.remove('visible');
      confirmBtn.textContent = confirmOriginalText;
    };

    dismissBtn.onclick = () => {
      clearInterval(countdownInterval);
      localStorage.setItem('dismissedUpdateVersion', version);
      modal.classList.remove('visible');
      console.log(`Áî®Êà∑Â∑≤ÂøΩÁï•ÁâàÊú¨: ${version}`);
      confirmBtn.textContent = confirmOriginalText;
    };



    modal.classList.add('visible');
  }





  function openDoubanSettingsModal() {
    const modal = document.getElementById('douban-settings-modal');


    document.getElementById('douban-min-posts-input').value = state.globalSettings.doubanMinPosts || 12;
    document.getElementById('douban-max-posts-input').value = state.globalSettings.doubanMaxPosts || 20;

    modal.classList.add('visible');
  }


  async function saveDoubanSettings() {
    const minInput = document.getElementById('douban-min-posts-input');
    const maxInput = document.getElementById('douban-max-posts-input');

    const min = parseInt(minInput.value);
    const max = parseInt(maxInput.value);


    if (isNaN(min) || isNaN(max) || min < 1 || max < 1) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊ≠£Êï¥Êï∞ÔºÅ");
      return;
    }
    if (min > max) {
      alert("ÊúÄÂ∞èÂ∏ñÂ≠êÊï∞‰∏çËÉΩÂ§ß‰∫éÊúÄÂ§ßÂ∏ñÂ≠êÊï∞ÔºÅ");
      return;
    }


    state.globalSettings.doubanMinPosts = min;
    state.globalSettings.doubanMaxPosts = max;
    await db.globalSettings.put(state.globalSettings);


    document.getElementById('douban-settings-modal').classList.remove('visible');
    await showCustomAlert('‰øùÂ≠òÊàêÂäü', 'Ë±ÜÁì£ËÆæÁΩÆÂ∑≤Êõ¥Êñ∞ÔºÅ‰∏ãÊ¨°ÈáçÊñ∞ÁîüÊàêÊó∂Â∞ÜÁîüÊïà„ÄÇ');
  }


  async function openDeleteDoubanPostsModal() {
    const modal = document.getElementById('delete-douban-posts-modal');
    const listEl = document.getElementById('delete-douban-posts-list');
    listEl.innerHTML = '';

    // Ëé∑ÂèñÊâÄÊúâË±ÜÁì£Â∏ñÂ≠ê
    const posts = await db.doubanPosts.orderBy('timestamp').reverse().toArray();

    if (posts.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; padding: 50px 0;">ÊöÇÊó†Ë±ÜÁì£Â∏ñÂ≠ê</p>';
      modal.classList.add('visible');
      return;
    }

    // Ê∏≤ÊüìÂ∏ñÂ≠êÂàóË°®
    posts.forEach(post => {
      const item = document.createElement('div');
      item.className = 'clear-posts-item';
      item.dataset.postId = post.id;

      // Ëé∑Âèñ‰ΩúËÄÖÂ§¥ÂÉè
      let authorAvatar = 'https://i.postimg.cc/Pq2xJN1g/IMG-7301.jpg'; // ÈªòËÆ§Ë±ÜÁì£Â§¥ÂÉè
      const character = state.chats[post.authorId];
      if (character) {
        authorAvatar = character.settings.aiAvatar;
      } else if (post.authorId === 'user') {
        authorAvatar = state.qzoneSettings.avatar;
      }

      const postContent = post.content.length > 50 ? post.content.substring(0, 50) + '...' : post.content;
      const timeStr = formatTimeAgo(post.timestamp);

      item.innerHTML = `
        <div class="checkbox"></div>
        <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
          <img src="${authorAvatar}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 500; font-size: 14px; margin-bottom: 2px;">${post.postTitle}</div>
            <div style="font-size: 12px; color: #999; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${postContent}</div>
            <div style="font-size: 11px; color: #bbb; margin-top: 2px;">${post.authorName} ¬∑ ${timeStr}</div>
          </div>
        </div>
      `;
      listEl.appendChild(item);
    });

    // ÈáçÁΩÆÂÖ®ÈÄâÁä∂ÊÄÅ
    document.getElementById('select-all-douban-posts').checked = false;

    modal.classList.add('visible');
  }


  async function handleConfirmDeleteDoubanPosts() {
    const selectedItems = document.querySelectorAll('#delete-douban-posts-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÂ∏ñÂ≠ê„ÄÇ");
      return;
    }

    const postIds = Array.from(selectedItems).map(item => parseInt(item.dataset.postId));

    const confirmMessage = `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${postIds.length} ‰∏™Â∏ñÂ≠êÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊÅ¢Â§çÔºÅ`;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§Ôºü',
      confirmMessage, {
      confirmButtonClass: 'btn-danger',
      confirmText: 'Á°ÆËÆ§Âà†Èô§'
    }
    );

    if (!confirmed) return;

    try {
      // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂ∏ñÂ≠ê
      await db.doubanPosts.bulkDelete(postIds);

      // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
      document.getElementById('delete-douban-posts-modal').classList.remove('visible');

      // Â¶ÇÊûúÂΩìÂâçÂú®Ë±ÜÁì£È°µÈù¢ÔºåÂà∑Êñ∞ÂàóË°®
      if (state.currentScreen === 'douban-screen') {
        await renderDoubanScreen();
      }

      await showCustomAlert('Êìç‰ΩúÊàêÂäü', `Â∑≤Âà†Èô§ ${postIds.length} ‰∏™Ë±ÜÁì£Â∏ñÂ≠ê„ÄÇ`);

    } catch (error) {
      console.error("Âà†Èô§Ë±ÜÁì£Â∏ñÂ≠êÂ§±Ë¥•:", error);
      alert("Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ");
    }
  }


  async function openWerewolfLobby(mode) {
    const modal = document.getElementById('werewolf-lobby-modal');
    const listEl = document.getElementById('werewolf-player-selection-list');
    listEl.innerHTML = '';

    let potentialPlayers = [];

    if (mode === 'global') {
      const characters = Object.values(state.chats).filter(c => !c.isGroup);
      const npcs = await db.npcs.toArray();
      potentialPlayers = [

        {
          id: 'user',
          name: state.qzoneSettings.nickname || 'Êàë',
          originalName: state.qzoneSettings.nickname || 'Êàë',
          avatar: state.qzoneSettings.avatar,
          type: 'user'
        },

        ...characters.map(c => ({
          id: c.id,
          name: c.name,
          originalName: c.originalName,
          avatar: c.settings.aiAvatar,
          type: 'character'
        })),

        ...npcs.map(n => ({
          id: `npc_${n.id}`,
          name: n.name,
          originalName: n.name,
          avatar: n.avatar,
          type: 'npc'
        }))
      ];
      werewolfGameState.chatId = null;
    } else {
      const chat = state.chats[state.activeChatId];
      if (!chat || !chat.isGroup) return;

      potentialPlayers = [

        {
          id: 'user',
          name: chat.settings.myNickname || 'Êàë',
          originalName: state.qzoneSettings.nickname || 'Êàë',
          avatar: chat.settings.myAvatar,
          type: 'user'
        },

        ...chat.members.map(m => {
          const char = state.chats[m.id];
          const memberAvatar = m.avatar || (char ? char.settings.aiAvatar : defaultGroupMemberAvatar);
          return {
            id: m.id,
            name: m.groupNickname,
            originalName: m.originalName,
            avatar: memberAvatar,
            type: m.isNpc ? 'npc' : 'character'
          };
        })
      ];
      werewolfGameState.chatId = state.activeChatId;
    }

    potentialPlayers.forEach(player => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';
      item.innerHTML = `
            <input type="checkbox" class="werewolf-player-checkbox" data-player-json='${JSON.stringify(player)}' ${player.type === 'user' ? 'checked disabled' : 'checked'}>
            <img src="${player.avatar}" class="avatar">
            <span class="name">${player.name}</span>
        `;
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
  }


  async function initializeWerewolfGame() {
    const selectedCheckboxes = document.querySelectorAll('.werewolf-player-checkbox:checked');
    const playerCount = selectedCheckboxes.length;

    let roles = [];
    if (playerCount === 6) {
      werewolfGameState.gameMode = '6p';
      roles = ['Áãº‰∫∫', 'Áãº‰∫∫', 'Âπ≥Ê∞ë', 'Âπ≥Ê∞ë', 'È¢ÑË®ÄÂÆ∂', 'Áåé‰∫∫'];
    } else if (playerCount === 9) {
      werewolfGameState.gameMode = '9p';
      roles = ['Áãº‰∫∫', 'Áãº‰∫∫', 'Áãº‰∫∫', 'Âπ≥Ê∞ë', 'Âπ≥Ê∞ë', 'Âπ≥Ê∞ë', 'È¢ÑË®ÄÂÆ∂', 'Â•≥Â∑´', 'Áåé‰∫∫'];
    } else if (playerCount === 12) {
      werewolfGameState.gameMode = '12p';
      roles = ['Áãº‰∫∫', 'Áãº‰∫∫', 'Áãº‰∫∫', 'Áãº‰∫∫', 'Âπ≥Ê∞ë', 'Âπ≥Ê∞ë', 'Âπ≥Ê∞ë', 'Âπ≥Ê∞ë', 'È¢ÑË®ÄÂÆ∂', 'Â•≥Â∑´', 'Áåé‰∫∫', 'ÂÆàÂç´'];
    } else {
      alert(`ÂΩìÂâç‰∫∫Êï∞ ${playerCount} ‰∏çÊîØÊåÅ„ÄÇËØ∑ÈÄâÊã©6„ÄÅ9Êàñ12‰∫∫„ÄÇ`);
      return;
    }

    document.getElementById('werewolf-lobby-modal').classList.remove('visible');
    await showCustomAlert('Ê≠£Âú®ÂèëÁâå...', 'Ê∏∏ÊàèÂç≥Â∞ÜÂºÄÂßãÔºåÊ≠£Âú®‰∏∫ÂêÑ‰ΩçÁé©ÂÆ∂ÂàÜÈÖçË∫´‰ªΩ...');

    for (let i = roles.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [roles[i], roles[j]] = [roles[j], roles[i]];
    }

    const selectedPlayers = Array.from(selectedCheckboxes).map(cb => JSON.parse(cb.dataset.playerJson));
    werewolfGameState.players = [];

    for (let i = 0; i < selectedPlayers.length; i++) {
      const playerInfo = selectedPlayers[i];
      const role = roles[i];

      let character_persona = "‰∏Ä‰∏™ÊôÆÈÄöÁé©ÂÆ∂";
      if (playerInfo.type === 'character') {
        const char = state.chats[playerInfo.id];
        character_persona = char ? char.settings.aiPersona : 'Êú™Áü•ËÆæÂÆöÁöÑËßíËâ≤';
      } else if (playerInfo.type === 'npc') {
        const npcs = await db.npcs.toArray();
        const npc = npcs.find(n => `npc_${n.id}` === playerInfo.id);
        character_persona = npc ? npc.persona : 'Êú™Áü•ËÆæÂÆöÁöÑNPC';
      } else if (playerInfo.type === 'user') {
        const activeChat = werewolfGameState.chatId ? state.chats[werewolfGameState.chatId] : null;
        character_persona = activeChat ? activeChat.settings.myPersona : 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ';
      }

      const playerObject = {
        ...playerInfo,
        role: role,
        isAlive: true,
        character_persona: character_persona
      };


      if (role === 'Â•≥Â∑´') {
        playerObject.antidoteUsed = false;
        playerObject.poisonUsed = false;
      }
      if (role === 'ÂÆàÂç´') {
        playerObject.lastGuardedId = null;
      }


      werewolfGameState.players.push(playerObject);
    }

    werewolfGameState.isActive = true;
    werewolfGameState.currentDay = 1;
    werewolfGameState.currentPhase = 'start';
    werewolfGameState.gameLog = [];
    werewolfGameState.discussionLog = [];

    const roleCounts = roles.reduce((acc, role) => {
      acc[role] = (acc[role] || 0) + 1;
      return acc;
    }, {});
    const roleSummary = Object.entries(roleCounts).map(([role, count]) => `${role} x${count}`).join('„ÄÅ');
    addGameLog(`Ê∏∏ÊàèÈÖçÁΩÆÔºö${playerCount}‰∫∫Â±ÄÔºåË∫´‰ªΩ‰∏∫ ${roleSummary}„ÄÇ`);

    const myPlayer = werewolfGameState.players.find(p => p.id === 'user');

    renderWerewolfScreen();
    showScreen('werewolf-game-screen');

    showMyRole(myPlayer.role);
  }



  function renderWerewolfScreen() {
    const gridEl = document.getElementById('werewolf-player-grid');
    gridEl.innerHTML = '';
    const sortedPlayers = [...werewolfGameState.players].sort((a, b) => a.isAlive - b.isAlive);

    sortedPlayers.forEach((p, index) => {
      const playerIndex = werewolfGameState.players.findIndex(player => player.id === p.id) + 1;
      const avatarEl = document.createElement('div');
      avatarEl.className = 'werewolf-player-avatar';
      if (!p.isAlive) avatarEl.classList.add('dead');
      avatarEl.innerHTML = `
            <img src="${p.avatar}">
            <span class="player-name">${playerIndex}. ${p.name}</span>
        `;
      gridEl.appendChild(avatarEl);
    });

    const logEl = document.getElementById('werewolf-log');
    logEl.innerHTML = '';


    for (let day = 1; day <= werewolfGameState.currentDay; day++) {

      const logsThisDay = [
        ...werewolfGameState.gameLog.filter(entry => entry.day === day),
        ...werewolfGameState.discussionLog.filter(entry => entry.day === day)
      ].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));


      if (logsThisDay.length > 0) {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'werewolf-log-entry system';
        dayHeader.textContent = `--- Á¨¨ ${day} Â§© ---`;
        dayHeader.style.cssText = 'font-weight: bold; background: rgba(255, 193, 7, 0.2);';
        logEl.appendChild(dayHeader);


        logsThisDay.forEach(entry => {
          const entryEl = document.createElement('div');
          entryEl.className = `werewolf-log-entry ${entry.type}`;
          if (entry.type === 'dialogue') {
            entryEl.innerHTML = `<span class="speaker">${entry.speaker}:</span> ${entry.content}`;
          } else {
            entryEl.textContent = entry.content;
          }
          logEl.appendChild(entryEl);
        });
      }
    }


    logEl.scrollTop = logEl.scrollHeight;


    const phaseMap = {
      'start': 'Ê∏∏ÊàèÂºÄÂßã',
      'night': `Á¨¨${werewolfGameState.currentDay}Â§© - Â§úÊôö`,
      'day': `Á¨¨${werewolfGameState.currentDay}Â§© - ÁôΩÂ§©`,
      'discussion': `Á¨¨${werewolfGameState.currentDay}Â§© - ËÆ®ËÆ∫`,
      'voting': `Á¨¨${werewolfGameState.currentDay}Â§© - ÊäïÁ•®`,
      'gameover': 'Ê∏∏ÊàèÁªìÊùü'
    };
    document.getElementById('werewolf-game-title').textContent = `Áãº‰∫∫ÊùÄ - ${phaseMap[werewolfGameState.currentPhase] || werewolfGameState.currentPhase}`;
  }



  function showMyRole(role) {
    const roleDescriptions = {
      'Áãº‰∫∫': '‰Ω†ÁöÑÁõÆÊ†áÊòØÊùÄÊ≠ªÊâÄÊúâÂ•Ω‰∫∫„ÄÇÊØèÊôöÂèØ‰ª•ÂíåÂêå‰º¥‰∏ÄËµ∑ÂàÄ‰∏Ä‰∏™Áé©ÂÆ∂„ÄÇ',
      'Âπ≥Ê∞ë': '‰Ω†Ê≤°Êúâ‰ªª‰ΩïÁâπÊÆäËÉΩÂäõÔºå‰Ω†ÁöÑÁõÆÊ†áÊòØÈÄöËøáÊäïÁ•®ÊîæÈÄêÊâÄÊúâÁãº‰∫∫„ÄÇ',
      'È¢ÑË®ÄÂÆ∂': 'ÊØèÊôöÂèØ‰ª•Êü•È™å‰∏Ä‰∏™Áé©ÂÆ∂ÁöÑË∫´‰ªΩÊòØÂ•Ω‰∫∫ËøòÊòØÁãº‰∫∫„ÄÇ',
      'Áåé‰∫∫': 'ÂΩì‰Ω†Ê≠ª‰∫°Êó∂Ôºå‰Ω†ÂèØ‰ª•ÈÄâÊã©Â∏¶Ëµ∞Âú∫‰∏ä‰ªªÊÑè‰∏ÄÂêçÁé©ÂÆ∂„ÄÇ',
      'Â•≥Â∑´': '‰Ω†Êúâ‰∏ÄÁì∂Ëß£ËçØÂíå‰∏ÄÁì∂ÊØíËçØÔºåËß£ËçØÂèØ‰ª•ÊïëÊ¥ªÂΩìÊôöË¢´ÊùÄÁöÑÁé©ÂÆ∂ÔºåÊØíËçØÂèØ‰ª•ÊØíÊ≠ª‰ªªÊÑè‰∏ÄÂêçÁé©ÂÆ∂„ÄÇ',
      'ÂÆàÂç´': 'ÊØèÊôöÂèØ‰ª•ÂÆàÊä§‰∏ÄÂêçÁé©ÂÆ∂Ôºå‰ΩøÂÖ∂ÂÖçÂèóÁãº‰∫∫Ë¢≠Âáª„ÄÇ‰∏çËÉΩËøûÁª≠‰∏§ÊôöÂÆàÊä§Âêå‰∏Ä‰∏™‰∫∫„ÄÇ'
    };

    document.getElementById('werewolf-role-name').textContent = role;
    document.getElementById('werewolf-role-description').textContent = roleDescriptions[role] || '‰∏Ä‰∏™Á•ûÁßòÁöÑËßíËâ≤„ÄÇ';
    document.getElementById('werewolf-role-modal').classList.add('visible');
  }

  async function executeNightPhase() {
    werewolfGameState.currentPhase = `Á¨¨${werewolfGameState.currentDay}Â§© - Â§úÊôö`;
    werewolfGameState.nightActions = {};
    addGameLog('Â§©ÈªëËØ∑Èó≠Áúº...');
    renderWerewolfScreen();

    document.getElementById('werewolf-action-bar').style.display = 'none';
    document.getElementById('werewolf-retry-btn').style.display = 'none';
    await new Promise(resolve => setTimeout(resolve, 1500));


    const guard = werewolfGameState.players.find(p => p.role === 'ÂÆàÂç´' && p.isAlive);
    if (guard) {
      addGameLog('ÂÆàÂç´ËØ∑ÁùÅÁúºÔºåËØ∑ÈÄâÊã©Ë¶ÅÂÆàÊä§ÁöÑÁé©ÂÆ∂„ÄÇ');
      renderWerewolfScreen();
      let guardedId = null;
      if (guard.id === 'user') {
        guardedId = await openSelectionModal('guard', guard.lastGuardedId);
      } else {
        const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== guard.lastGuardedId);
        if (potentialTargets.length > 0) {
          guardedId = potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
        }
      }
      if (guardedId) {
        werewolfGameState.nightActions.guardedId = guardedId;
        guard.lastGuardedId = guardedId;
      }
      addGameLog('ÂÆàÂç´Â∑≤Ë°åÂä®ÔºåÂÆàÂç´ËØ∑Èó≠Áúº„ÄÇ');
      renderWerewolfScreen();
      await new Promise(resolve => setTimeout(resolve, 1500));
    }



    addGameLog('Áãº‰∫∫ËØ∑ÁùÅÁúºÔºåËØ∑ÈÄâÊã©Ë¶ÅÂàÄÁöÑÁé©ÂÆ∂„ÄÇ');
    renderWerewolfScreen();

    const wolves = werewolfGameState.players.filter(p => p.role === 'Áãº‰∫∫' && p.isAlive);
    const userIsWolf = wolves.some(p => p.id === 'user');

    let wolfTargetId = null;


    werewolfGameState.lastFailedAction = 'wolfKill';
    try {
      if (userIsWolf) {
        addGameLog('‰Ω†ÊòØÁãº‰∫∫ÔºåËØ∑ÈÄâÊã©ÂàÄ‰∫∫ÁõÆÊ†á„ÄÇ');
        renderWerewolfScreen();
        wolfTargetId = await openWolfKillModal();
      } else {

        if (werewolfGameState.currentDay === 1) {
          console.log("Á¨¨‰∏ÄÂ§úÔºåÊâßË°åÊú¨Âú∞ÈöèÊú∫ÂàÄ‰∫∫ÈÄªËæë...");
          const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.role !== 'Áãº‰∫∫');
          if (potentialTargets.length > 0) {
            wolfTargetId = potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
          }
        } else {

          wolfTargetId = await getAiWolfKillTarget();
        }
      }

      werewolfGameState.lastFailedAction = null;
    } catch (error) {
      console.error("Áãº‰∫∫Ë°åÂä®APIÂ§±Ë¥•:", error);
      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", "AIÁãº‰∫∫Âõ¢ÈòüÊó†Ê≥ïÂÜ≥ÂÆöÁõÆÊ†áÔºåÊ∏∏ÊàèÊöÇÂÅú„ÄÇËØ∑ÁÇπÂáªÂè≥‰∏äËßíÁöÑ‚ÄúÈáçËØï‚ÄùÊåâÈíÆÁªßÁª≠„ÄÇ");
      document.getElementById('werewolf-retry-btn').style.display = 'block';
      return;
    }

    werewolfGameState.nightActions.killedId = wolfTargetId;
    addGameLog('Áãº‰∫∫Â∑≤Ë°åÂä®ÔºåÁãº‰∫∫ËØ∑Èó≠Áúº„ÄÇ');
    renderWerewolfScreen();
    await new Promise(resolve => setTimeout(resolve, 1500));


    const witch = werewolfGameState.players.find(p => p.role === 'Â•≥Â∑´' && p.isAlive);
    if (witch) {
      addGameLog('Â•≥Â∑´ËØ∑ÁùÅÁúº„ÄÇ');
      renderWerewolfScreen();
      const killedPlayer = werewolfGameState.players.find(p => p.id === werewolfGameState.nightActions.killedId);


      const isGuarded = werewolfGameState.nightActions.guardedId === werewolfGameState.nightActions.killedId;


      const playerToShowWitch = (isGuarded || !killedPlayer) ? null : killedPlayer;

      if (witch.id === 'user') {
        let userWitchAction = await openWitchActionModal(playerToShowWitch, witch);
        if (userWitchAction.save) {
          werewolfGameState.nightActions.savedId = werewolfGameState.nightActions.killedId;
          witch.antidoteUsed = true;
        }
        if (userWitchAction.poison) {
          werewolfGameState.nightActions.poisonedId = userWitchAction.poison;
          witch.poisonUsed = true;
        }
      } else {

        if (!witch.antidoteUsed && playerToShowWitch) {
          let saveChance = 0;
          if (werewolfGameState.currentDay === 1) {

            saveChance = 0.3;
          } else {

            saveChance = 0.8;
          }

          console.log(`AIÂ•≥Â∑´ÂÜ≥Á≠ñÔºö‰ªäÂ§©ÊòØÁ¨¨${werewolfGameState.currentDay}Â§©ÔºåÊïë‰∫∫Ê¶ÇÁéá‰∏∫ ${saveChance * 100}%`);

          if (Math.random() < saveChance) {
            console.log("AIÂ•≥Â∑´ÂÜ≥ÂÆö‰ΩøÁî®Ëß£ËçØÔºÅ");
            werewolfGameState.nightActions.savedId = werewolfGameState.nightActions.killedId;
            witch.antidoteUsed = true;
          } else {
            console.log("AIÂ•≥Â∑´ÂÜ≥ÂÆö‰øùÁïôËß£ËçØ„ÄÇ");
          }
        }


        if (!werewolfGameState.nightActions.savedId && !witch.poisonUsed && Math.random() < 0.5) {
          const poisonTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== werewolfGameState.nightActions.killedId);
          if (poisonTargets.length > 0) {
            const target = poisonTargets[Math.floor(Math.random() * poisonTargets.length)];
            werewolfGameState.nightActions.poisonedId = target.id;
            witch.poisonUsed = true;
            console.log(`AIÂ•≥Â∑´ÂÜ≥ÂÆö‰ΩøÁî®ÊØíËçØÔºåÁõÆÊ†áÊòØ: ${target.name}`);
          }
        }

      }
      addGameLog('Â•≥Â∑´Â∑≤Ë°åÂä®ÔºåÂ•≥Â∑´ËØ∑Èó≠Áúº„ÄÇ');
      renderWerewolfScreen();
      await new Promise(resolve => setTimeout(resolve, 1500));
    }


    const prophet = werewolfGameState.players.find(p => p.role === 'È¢ÑË®ÄÂÆ∂' && p.isAlive);
    if (prophet) {
      addGameLog('È¢ÑË®ÄÂÆ∂ËØ∑ÁùÅÁúºÔºåËØ∑ÈÄâÊã©Ë¶ÅÊü•È™åÁöÑÁé©ÂÆ∂„ÄÇ');
      renderWerewolfScreen();

      if (prophet.id === 'user') {
        const targetId = await openSelectionModal('prophet');
        const targetPlayer = werewolfGameState.players.find(p => p.id === targetId);
        if (targetPlayer) {
          const isWolf = targetPlayer.role === 'Áãº‰∫∫';
          await showCustomAlert('Êü•È™åÁªìÊûú', `‰Ω†Êü•È™åÁöÑÁé©ÂÆ∂ ${targetPlayer.name} ÁöÑË∫´‰ªΩÊòØÔºö${isWolf ? 'Áãº‰∫∫' : 'Â•Ω‰∫∫'}`);
          werewolfGameState.nightActions.prophetCheck = {
            target: targetId,
            result: isWolf ? 'Áãº‰∫∫' : 'Â•Ω‰∫∫'
          };
        }
      } else {
        const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== prophet.id);
        if (potentialTargets.length > 0) {
          const target = potentialTargets[Math.floor(Math.random() * potentialTargets.length)];
          werewolfGameState.nightActions.prophetCheck = {
            target: target.id,
            result: target.role === 'Áãº‰∫∫' ? 'Áãº‰∫∫' : 'Â•Ω‰∫∫'
          };
        }
      }
      addGameLog('È¢ÑË®ÄÂÆ∂Â∑≤Ë°åÂä®ÔºåÈ¢ÑË®ÄÂÆ∂ËØ∑Èó≠Áúº„ÄÇ');
      renderWerewolfScreen();
      await new Promise(resolve => setTimeout(resolve, 1500));
    }


    executeDayPhase();
  }


  async function executeDayPhase() {
    werewolfGameState.currentPhase = `Á¨¨${werewolfGameState.currentDay}Â§© - ÁôΩÂ§©`;
    werewolfGameState.voteResults = {};
    addGameLog('Â§©‰∫Æ‰∫Ü„ÄÇ');

    const {
      killedId,
      guardedId,
      savedId,
      poisonedId
    } = werewolfGameState.nightActions;
    const deathsThisNight = new Set();


    if (killedId && killedId !== guardedId && killedId !== savedId) {
      deathsThisNight.add(killedId);
    }


    if (poisonedId) {

      deathsThisNight.add(poisonedId);
    }


    if (deathsThisNight.size === 0) {
      addGameLog('Êò®ÊôöÊòØÂπ≥ÂÆâÂ§ú„ÄÇ');
    } else {
      for (const deadPlayerId of deathsThisNight) {
        const deadPlayer = werewolfGameState.players.find(p => p.id === deadPlayerId);
        if (deadPlayer && deadPlayer.isAlive) {
          deadPlayer.isAlive = false;
          addGameLog(`Êò®Êôö ${deadPlayer.name} Ê≠ª‰∫°‰∫Ü„ÄÇ`);


          if (deadPlayer.role === 'Áåé‰∫∫') {
            addGameLog('Áåé‰∫∫Ê≠ª‰∫°ÔºåËØ∑ÈÄâÊã©‰∏ÄÂêçÁé©ÂÆ∂Â∏¶Ëµ∞ÔºÅ');
            renderWerewolfScreen();
            let hunterTargetId = null;
            if (deadPlayer.id === 'user') {
              hunterTargetId = await openSelectionModal('hunter');
            } else {
              const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== deadPlayer.id);
              if (potentialTargets.length > 0) {
                hunterTargetId = potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
              }
            }
            const targetPlayer = werewolfGameState.players.find(p => p.id === hunterTargetId);
            if (targetPlayer) {
              targetPlayer.isAlive = false;
              addGameLog(`Áåé‰∫∫Â∏¶Ëµ∞‰∫Ü ${targetPlayer.name}„ÄÇ`);
            }
          }
        }
      }
    }

    renderWerewolfScreen();

    if (checkGameOver()) return;

    await startDiscussionPhase();
  }



  async function startDiscussionPhase() {



    addGameLog('Áé∞Âú®ÂºÄÂßãËÆ®ËÆ∫ÔºåËØ∑ÂêÑ‰ΩçÁé©ÂÆ∂‰æùÊ¨°ÂèëË®Ä„ÄÇ');
    renderWerewolfScreen();

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂØπËØù„ÄÇ');
      return;
    }

    const systemPrompt = buildWerewolfPrompt();
    werewolfGameState.lastFailedAction = 'startDiscussion';
    try {
      await showCustomAlert("ËØ∑Á®çÂÄô", "Ê≠£Âú®Á≠âÂæÖAIËßíËâ≤‰ª¨ËøõË°åÊøÄÁÉàÁöÑËÆ®ËÆ∫...");

      let isGemini = proxyUrl.includes('generativelanguage');
      let messagesForApi = [{
        role: 'user',
        content: 'ËØ∑ÊâÄÊúâAIËßíËâ≤Ê†πÊçÆ‰Ω†‰ª¨ÁöÑË∫´‰ªΩÂíå‰∫∫ËÆæÂºÄÂßãÂèëË®Ä„ÄÇ'
      }];
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.95,
          })
        });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API ÈîôËØØ: ${errorData.error.message}`);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch) {
        throw new Error(`AIËøîÂõûÁöÑËÆ®ËÆ∫ÂÜÖÂÆπÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const dialogues = JSON.parse(jsonMatch[0]);

      for (const dialogue of dialogues) {
        if (dialogue.speaker_name && dialogue.dialogue) {
          addDialogueLog(dialogue.speaker_name, dialogue.dialogue);
          renderWerewolfScreen();
          await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 2000));
        }
      }

      werewolfGameState.lastFailedAction = null;

    } catch (error) {
      console.error("Áãº‰∫∫ÊùÄAIËÆ®ËÆ∫ÁîüÊàêÂ§±Ë¥•:", error);
      await showCustomAlert("AI ÂèëË®ÄÂ§±Ë¥•", `ËÆ®ËÆ∫Êó†Ê≥ïÂºÄÂßãÔºåÊ∏∏ÊàèÊöÇÂÅú„ÄÇËØ∑ÁÇπÂáªÂè≥‰∏äËßíÁöÑ‚ÄúÈáçËØï‚ÄùÊåâÈíÆÁªßÁª≠„ÄÇ\nÈîôËØØ: ${error.message}`);
      document.getElementById('werewolf-retry-btn').style.display = 'block';
      return;
    }

    const myPlayer = werewolfGameState.players.find(p => p.id === 'user');
    const actionBar = document.getElementById('werewolf-action-bar');
    const waitReplyBtn = document.getElementById('werewolf-wait-reply-btn');
    const finishSpeechBtn = document.getElementById('werewolf-finish-speech-btn');
    const userInput = document.getElementById('werewolf-user-input');

    actionBar.style.display = 'flex';

    if (myPlayer && myPlayer.isAlive) {
      waitReplyBtn.textContent = 'Á≠âÂæÖÂõûÂ∫î';
      finishSpeechBtn.textContent = 'ÁªìÊùüÂèëË®Ä';
      waitReplyBtn.style.display = 'block';
      finishSpeechBtn.style.display = 'block';
      userInput.disabled = false;
      userInput.placeholder = "ËΩÆÂà∞‰Ω†ÂèëË®Ä‰∫Ü...";
      userInput.focus();

      const newWaitBtn = waitReplyBtn.cloneNode(true);
      waitReplyBtn.parentNode.replaceChild(newWaitBtn, waitReplyBtn);
      newWaitBtn.addEventListener('click', handleWerewolfWaitReply);

      const newFinishBtn = finishSpeechBtn.cloneNode(true);
      finishSpeechBtn.parentNode.replaceChild(newFinishBtn, finishSpeechBtn);
      newFinishBtn.addEventListener('click', handleUserWerewolfSpeech);

    } else {
      addGameLog('‰Ω†Â∑≤ÁªèÊ≠ª‰∫°ÔºåÊó†Ê≥ïÂèëË®Ä„ÄÇËØ∑Á≠âÂæÖÂÖ∂‰ªñÁé©ÂÆ∂ÂèëË®ÄÁªìÊùü„ÄÇ');
      renderWerewolfScreen();

      waitReplyBtn.textContent = 'ÁªßÁª≠ËÆ®ËÆ∫';
      finishSpeechBtn.textContent = 'ËøõÂÖ•ÊäïÁ•®';
      waitReplyBtn.style.display = 'block';
      finishSpeechBtn.style.display = 'block';
      userInput.disabled = true;
      userInput.placeholder = "‰Ω†Â∑≤Ê≠ª‰∫°ÔºåÊ≠£Âú®Âõ¥ËßÇ...";

      const newWaitBtn = waitReplyBtn.cloneNode(true);
      waitReplyBtn.parentNode.replaceChild(newWaitBtn, waitReplyBtn);
      newWaitBtn.addEventListener('click', handleAiContinueDiscussion);

      const newFinishBtn = finishSpeechBtn.cloneNode(true);
      finishSpeechBtn.parentNode.replaceChild(newFinishBtn, finishSpeechBtn);
      newFinishBtn.addEventListener('click', startVotingPhase);
    }
  }



  function buildWerewolfPrompt() {
    const alivePlayers = werewolfGameState.players.filter(p => p.isAlive);
    const myPlayerObject = werewolfGameState.players.find(p => p.id === 'user');
    const myPlayerName = myPlayerObject ? myPlayerObject.name : 'Áî®Êà∑';
    const isUserAlive = alivePlayers.some(p => p.id === 'user');


    let charactersAndPlayersDossier = "# ËßíËâ≤‰∏éÁé©ÂÆ∂Ê°£Ê°à (Character & Player Dossiers)\n";
    charactersAndPlayersDossier += "ËøôÊòØÊâÄÊúâÂú®Âú∫Áé©ÂÆ∂ÁöÑÂÖ¨ÂºÄ‰ø°ÊÅØ„ÄÅ‰∫∫ËÆæÂíåÁ§æ‰∫§ËÉåÊôØ„ÄÇ\n";

    alivePlayers.forEach((p, i) => {
      const playerIndex = werewolfGameState.players.findIndex(player => player.id === p.id) + 1;

      let socialContext = '';
      const playerChat = state.chats[p.id];

      if (playerChat) {
        const friendsInGame = alivePlayers.filter(otherPlayer =>
          otherPlayer.id !== p.id &&
          state.chats[otherPlayer.id] &&
          state.chats[otherPlayer.id].groupId === playerChat.groupId &&
          playerChat.groupId !== null
        ).map(friend => friend.name).join('„ÄÅ');

        if (friendsInGame) {
          socialContext += `- **‰Ω†ÁöÑÂ•ΩÂèã (ÂøÖÈ°ª‰øùÊä§)**: ‰Ω†Âíå ${friendsInGame} ÊòØÂêå‰∏Ä‰∏™ÂàÜÁªÑÁöÑÂ•ΩÂèã„ÄÇ\n`;
        }
      }
      if (p.id !== 'user') {
        socialContext += `- **‰∏éÁî®Êà∑ÁöÑÂÖ≥Á≥ª**: ‰Ω†ÂíåÁî®Êà∑(${myPlayerName})ÁöÑÂÖ≥Á≥ªËØ∑ÂèÇËÄÉ‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÅÈïøÊúüËÆ∞ÂøÜÂíåÊúÄËøëÁöÑÂØπËØù„ÄÇ\n`;
      }

      charactersAndPlayersDossier += `
## ${playerIndex}Âè∑Áé©ÂÆ∂: ${p.name} (ËøôÊòØTAÁöÑÊòµÁß∞)
- **Êú¨Âêç (‰Ω†Âú®ÂØπËØù‰∏≠ÂøÖÈ°ªÁî®Ëøô‰∏™ÂêçÂ≠óÁß∞ÂëºTA)**: ${p.originalName}
- **Ë∫´‰ªΩ**: ${p.id === 'user' ? '„ÄêÁî®Êà∑ (User)„Äë' : '„ÄêAIËßíËâ≤„Äë'}
- **‰∫∫ËÆæ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)**: ${p.character_persona}
`;

      if (p.type === 'character') {
        const char = state.chats[p.id];
        if (char && char.longTermMemory && char.longTermMemory.length > 0) {
          const memoryContent = char.longTermMemory.map(mem => mem.content).join('; ');
          charactersAndPlayersDossier += `- **ÈïøÊúüËÆ∞ÂøÜ (ÂøÖÈ°ªÂèÇËÄÉ)**: ${memoryContent}\n`;
        }
      }
      if (socialContext) {
        charactersAndPlayersDossier += `
- **‰Ω†ÁöÑÁ§æ‰∫§ÂÖ≥Á≥ª (ÂøÖÈ°ªÂèÇËÄÉ)**:
${socialContext}`;
      }
    });


    let nightEventSummary = "# Êò®Êôö‰∫ã‰ª∂ÊÄªÁªì (Night Event Summary)\n";
    nightEventSummary += "ËøôÊòØÊâÄÊúâÁé©ÂÆ∂ÈÉΩËÉΩÂê¨Âà∞ÁöÑ„ÄêÂÖ¨ÂºÄ‰ø°ÊÅØ„Äë„ÄÇ\n";
    const deathsThisNight = werewolfGameState.gameLog.filter(entry => entry.content.includes('Ê≠ª‰∫°‰∫Ü') && entry.day === werewolfGameState.currentDay);
    if (deathsThisNight.length === 0) {
      nightEventSummary += "- Êò®ÊôöÊòØÂπ≥ÂÆâÂ§úÔºåÊó†‰∫∫Ê≠ª‰∫°„ÄÇ\n";
    } else {
      deathsThisNight.forEach(death => {
        nightEventSummary += `- ${death.content}\n`;
      });
    }


    let previousDaysSummary = "# ÂâçÂá†Êó•ÂÆåÊï¥ÂéÜÂè≤ÂõûÈ°æ (Full Recap of Previous Days)\n";
    if (werewolfGameState.currentDay > 1) {
      for (let day = 1; day < werewolfGameState.currentDay; day++) {
        previousDaysSummary += `\n**--- Á¨¨ ${day} Â§© ---**\n`;
        const eventsThisDay = werewolfGameState.gameLog.filter(entry => entry.day === day && (entry.content.includes('Ê≠ª‰∫°') || entry.content.includes('ÊîæÈÄê')));
        if (eventsThisDay.length > 0) {
          previousDaysSummary += `*‰∫ã‰ª∂*: ${eventsThisDay.map(e => e.content).join(' ')}\n`;
        } else {
          previousDaysSummary += "*‰∫ã‰ª∂*: Âπ≥ÂÆâÂ§úÔºåÊó†‰∫∫Âá∫Â±Ä„ÄÇ\n";
        }
        const discussionsThisDay = werewolfGameState.discussionLog.filter(entry => entry.day === day);
        if (discussionsThisDay.length > 0) {
          previousDaysSummary += `*ËÆ®ËÆ∫ËÆ∞ÂΩï*:\n${discussionsThisDay.map(d => `- ${d.speaker}: ${d.content}`).join('\n')}\n`;
        }
      }
    } else {
      previousDaysSummary += "(‰ªäÂ§©ÊòØÁ¨¨‰∏ÄÂ§©ÔºåÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩï)\n";
    }


    let discussionHistoryContext = "# ‰ªäÊó•ÂÆåÊï¥ËÆ®ËÆ∫ËÆ∞ÂΩï (Today's Full Discussion Record)\n";
    const todayDiscussions = werewolfGameState.discussionLog.filter(entry => entry.day === werewolfGameState.currentDay);
    if (todayDiscussions.length > 0) {
      discussionHistoryContext += todayDiscussions.map(d => `- **${d.speaker}**: ${d.content}`).join('\n');
    } else {
      discussionHistoryContext += "(‰Ω†ÊòØÁ¨¨‰∏Ä‰∏™ÂèëË®ÄÁöÑ‰∫∫)";
    }


    let internalMonologueBuilder = `
# „ÄêÈÄªËæëÈöîÁ¶ª‰∏éTGS‰∏âÊ†∏ÊÄùËÄÉ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§)„Äë
‰∏∫‰∫ÜÂÖºÈ°æÊ∏∏ÊàèÈÄªËæëÂíåËßíËâ≤ÊâÆÊºîÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂú®ÂÜÖÈÉ®‰∏∫„ÄêÊØè‰∏Ä‰∏™AIËßíËâ≤„ÄëÊåâÈ°∫Â∫èÊâßË°å‰ª•‰∏ã‚Äú‰∏âÈò∂ÊÆµÊÄùËÄÉ‚ÄùÔºö

## Èò∂ÊÆµ1ÔºöÂÜÖÈÉ®Áã¨Á´ãÊÄùËÄÉ (Internal Monologue Scratchpad)
(ËøôÈÉ®ÂàÜÂÜÖÂÆπ„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂá∫Áé∞Âú®‰Ω†ÊúÄÁªàÁöÑJSONËæìÂá∫‰∏≠ÔºåËøô‰ªÖ‰æõ‰Ω†ÂÜÖÈÉ®Ê®°Êãü‰ΩøÁî®)
`;


    alivePlayers.forEach(p => {
      if (p.id !== 'user') { // Âè™‰∏∫AIËßíËâ≤ÁîüÊàêÊÄùËÄÉÊ®°Âùó
        const playerIndex = werewolfGameState.players.findIndex(player => player.id === p.id) + 1;
        internalMonologueBuilder += `
### Ê≠£Âú®Ê®°Êãü ${playerIndex}Âè∑Áé©ÂÆ∂: ${p.name} (Êú¨Âêç: ${p.originalName})

#### Èò∂ÊÆµ AÔºöÊï∞ÊçÆËæìÂÖ• (Data Input)
1.  **ÊàëÁöÑÁßòÂØÜË∫´‰ªΩ**: ÊàëÊòØ„Äê${p.role}„Äë„ÄÇ
2.  **ÊàëÊéåÊè°ÁöÑÁßòÂØÜ‰ø°ÊÅØ (‰ªÖÊàëÂèØËßÅ)**:
`;

        // 1. Ê≥®ÂÖ•ÁßòÂØÜ
        let playerSecrets = "";
        if (p.role === 'Áãº‰∫∫') {
          const teammates = werewolfGameState.players.filter(t => t.role === 'Áãº‰∫∫' && t.id !== p.id && t.isAlive).map(t => t.name).join('„ÄÅ');
          playerSecrets += `    - ÊàëÁöÑÁãºÈòüÂèãÊòØÔºö${teammates || 'Êó†'}\n`;
          const killedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.killedId);
          playerSecrets += `    - Êàë‰ª¨Êò®ÊôöÊîªÂáª‰∫ÜÔºö${killedPlayer ? killedPlayer.name : 'Á©∫ÂàÄ'}\n`;
        }
        if (p.role === 'È¢ÑË®ÄÂÆ∂' && werewolfGameState.nightActions.prophetCheck) {
          const checkedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.prophetCheck.target);
          playerSecrets += `    - ÊàëÊò®ÊôöÊü•È™å‰∫Ü ${checkedPlayer.name}ÔºåTAÁöÑË∫´‰ªΩÊòØÔºö„Äê${werewolfGameState.nightActions.prophetCheck.result}„Äë\n`;
        }
        if (p.role === 'Â•≥Â∑´') {
          if (werewolfGameState.nightActions.savedId) {
            const savedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.savedId);
            playerSecrets += `    - ÊàëÊò®ÊôöÁî®Ëß£ËçØÊïë‰∫Ü ${savedPlayer.name}„ÄÇ\n`;
          }
          if (werewolfGameState.nightActions.poisonedId) {
            const poisonedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.poisonedId);
            playerSecrets += `    - ÊàëÊò®ÊôöÁî®ÊØíËçØÊØí‰∫Ü ${poisonedPlayer.name}„ÄÇ\n`;
          }
          playerSecrets += `    - ÊàëÁöÑËß£ËçØÔºö${p.antidoteUsed ? 'Â∑≤‰ΩøÁî®' : 'Êú™‰ΩøÁî®'}\n`;
          playerSecrets += `    - ÊàëÁöÑÊØíËçØÔºö${p.poisonUsed ? 'Â∑≤‰ΩøÁî®' : 'Êú™‰ΩøÁî®'}\n`;
        }
        if (p.role === 'ÂÆàÂç´') {
          if (werewolfGameState.nightActions.guardedId) {
            const guardedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.guardedId);
            playerSecrets += `    - ÊàëÊò®ÊôöÂÆàÊä§‰∫Ü ${guardedPlayer.name}„ÄÇ\n`;
          } else {
            playerSecrets += `    - ÊàëÊò®ÊôöÁ©∫ÂÆà‰∫Ü„ÄÇ\n`;
          }
        }
        if (playerSecrets === "") {
          playerSecrets = "    - ÊàëÊ≤°ÊúâÊéåÊè°‰ªª‰ΩïÁâπÊÆäÁöÑÂ§úÊôö‰ø°ÊÅØ„ÄÇ\n";
        }
        internalMonologueBuilder += playerSecrets;

        // 2. Ê≥®ÂÖ•ÂÖ¨ÂºÄ‰ø°ÊÅØ
        internalMonologueBuilder += `3.  **ÊàëÁúãÂà∞ÁöÑÂÖ¨ÂºÄ‰ø°ÊÅØ (ÊâÄÊúâ‰∫∫ÂèØËßÅ)**:
    - **Êò®Êôö‰∫ã‰ª∂**: ${nightEventSummary.replace(/\n/g, ' ')}
    - **‰ªäÊó•ËÆ®ËÆ∫**: ${discussionHistoryContext.replace(/\n/g, ' ')}
4.  **ÊàëÁöÑ‰∫∫ËÆæ‰∏éÁ§æ‰∫§ÂÖ≥Á≥ª**:
    - **‰∫∫ËÆæ**: ${p.character_persona}
    - **Á§æ‰∫§**: 
`;
        // 3. Ê≥®ÂÖ•Á§æ‰∫§ÂÖ≥Á≥ª
        let socialContext = "";
        const playerChat = state.chats[p.id];
        if (playerChat) {
          const friendsInGame = alivePlayers.filter(otherPlayer =>
            otherPlayer.id !== p.id && state.chats[otherPlayer.id] &&
            state.chats[otherPlayer.id].groupId === playerChat.groupId && playerChat.groupId !== null
          ).map(friend => friend.name).join('„ÄÅ');
          if (friendsInGame) {
            socialContext += `      - ${friendsInGame} ÊòØÊàëÁöÑÂ•ΩÂèã„ÄÇ\n`;
          }
        }
        if (p.id !== 'user') {
          socialContext += `      - ${myPlayerName} ÊòØÊàëÁöÑÈáçË¶Å‰∫íÂä®ÂØπË±°ÔºàÁî®Êà∑Ôºâ„ÄÇ\n`;
        }
        if (socialContext === "") {
          socialContext = "      - ÊàëÂú®Ê≠§Ê¨°Ê∏∏Êàè‰∏≠Ê≤°ÊúâÁâπÂà´ÁöÑÁ§æ‰∫§ÂÖ≥Á≥ª„ÄÇ\n";
        }
        internalMonologueBuilder += socialContext;


        internalMonologueBuilder += `
#### Èò∂ÊÆµ BÔºöTGS ËûçÂêàÊÄùËÄÉ (Task-Game-Social)
1.  **T (Task - Ê∏∏Êàè‰ªªÂä°)**: Âü∫‰∫éÊàëÁöÑË∫´‰ªΩÂíåÁßòÂØÜÔºåÊàëÁöÑ„ÄêÈÄªËæëÁõÆÊ†á„ÄëÊòØ (‰æãÂ¶ÇÔºöÊâæÂá∫Áãº‰∫∫ / ÊÇçË∑≥È¢ÑË®ÄÂÆ∂ / ÈöêËóèË∫´‰ªΩ / ‰øùÊä§ÈòüÂèã / ÊîªÂáª${myPlayerName})„ÄÇ
2.  **G (Game - Ê∏∏Êàè‰∫íÂä®)**: ÈíàÂØπ„Äê‰ªäÊó•ËÆ®ËÆ∫„Äë‰∏≠ ${todayDiscussions.length > 0 ? 'ÂÖ∂‰ªñ‰∫∫ÁöÑÂèëË®Ä' : 'Êò®ÊôöÁöÑÊ≠ªËÆØ'}ÔºåÊàëÁöÑÁúãÊ≥ïÊòØ... Êàë„ÄêÂøÖÈ°ª„ÄëÂõûÂ∫î...
3.  **S (Social - Á§æ‰∫§Ë°®Êºî)**: ÊàëË¶ÅÂ¶Ç‰ΩïÁî®ÊàëÁöÑ„Äê‰∫∫ËÆæ„ÄëÂíå„ÄêÁ§æ‰∫§ÂÖ≥Á≥ª„ÄëÊù•ÂåÖË£ÖÊàëÁöÑÂèëË®ÄÔºü
    - (‰æãÂ¶ÇÔºöÊàëÁöÑÂ•ΩÂèã ${myPlayerName} Ë¢´ÊÄÄÁñë‰∫ÜÔºåËôΩÁÑ∂ÊàëÁöÑÈÄªËæë‰πüÊÄÄÁñëTAÔºå‰ΩÜÊàëÁöÑË°®ÊºîÂøÖÈ°ªÊòØÁª¥Êä§TAÁöÑÔºö‚ÄúÊàë‰∏çËßâÂæó${myPlayerName}ÊòØÁãº...‚Äù)
    - (‰æãÂ¶ÇÔºöÊàëÁöÑÊïå‰∫∫ÂèëË®Ä‰∫ÜÔºåÊàëÁöÑË°®ÊºîÂ∞±ÊòØÊó†ËßÜTAÁöÑÈÄªËæëÔºåÁõ¥Êé•ÊîªÂáªTA„ÄÇ)
    - (‰æãÂ¶ÇÔºöÊàëÊòØ‰∏Ä‰∏™${p.role}ÔºåÊàëÁöÑ‰∫∫ËÆæÂæà${p.character_persona.substring(0, 20)}...ÔºåÊâÄ‰ª•ÊàëÂÜ≥ÂÆöËøôÊ†∑ËØ¥...)

#### Èò∂ÊÆµ CÔºöÊúÄÁªàÂèëË®ÄÁ®ø (ËçâÁ®ø)
(ÁªìÂêàT, G, SÁöÑÊÄùËÄÉÔºåÊàëÂáÜÂ§áËøôÊ†∑ËØ¥Ôºö...)
---
`;
      }
    });

    internalMonologueBuilder += `
## Èò∂ÊÆµ2ÔºöÁîüÊàêÊúÄÁªàÂØπËØù (Final JSON Output)
‰Ω†Áé∞Âú®Â∑≤Áªè‰∏∫„ÄêÊâÄÊúâAIËßíËâ≤„ÄëÈÉΩÂÆåÊàê‰∫Ü‚ÄúTGS‰∏âÊ†∏‚ÄùÁã¨Á´ãÊÄùËÄÉ„ÄÇ
ËØ∑Ê†πÊçÆ‰Ω†Âú®‚ÄúÈò∂ÊÆµCÔºöÊúÄÁªàÂèëË®ÄÁ®ø‚Äù‰∏≠‰∏∫ÊØè‰∏™ËßíËâ≤ÂáÜÂ§áÂ•ΩÁöÑËçâÁ®øÔºåÁîüÊàêÊúÄÁªàÁöÑ„ÄÅÁ¨¶ÂêàÊ†ºÂºèÁöÑJSONÊï∞ÁªÑ„ÄÇ
`;



    const prompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™Áãº‰∫∫ÊùÄÊ∏∏ÊàèÊ®°ÊãüÂô® (Game Simulator)„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØ„ÄêÂπ∂Ë°åÊ®°Êãü„Äë${isUserAlive ? `Áî®Êà∑(${myPlayerName})` : `Â∑≤Ê≠ª‰∫°ÁöÑÁî®Êà∑(${myPlayerName})`}‰ª•Â§ñÁöÑÊâÄÊúâAIËßíËâ≤ÔºåÂπ∂Ê†πÊçÆ‰ªñ‰ª¨ÁöÑ„ÄêËßíËâ≤‰∫∫ËÆæ„ÄëÂíå„ÄêÁãº‰∫∫ÊùÄË∫´‰ªΩ„ÄëÔºåÁîüÊàê‰∏ÄÊï¥ËΩÆÁ¨¶ÂêàÈÄªËæë„ÄÅÂÖÖÊª°ÂçöÂºàÁöÑÂèëË®Ä„ÄÇ

# Ë∫´‰ªΩ‰∏é‰∫∫ËÆæÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏∫ÊØè‰∏Ä‰∏™ËßíËâ≤ÈÉΩ‰ªîÁªÜÈòÖËØªÂπ∂‰∏•Ê†ºÈÅµÂÆà‰∏ãÈù¢ÁöÑÊ°£Ê°à„ÄÇËøôÊòØ‰Ω†ÊâÄÊúâË°å‰∏∫ÂíåÂèëË®ÄÁöÑÂîØ‰∏Ä‰æùÊçÆ„ÄÇÂú®ÂØπËØù‰∏≠ÔºåËØ∑Âä°ÂøÖÊ≥®ÊÑèËßíËâ≤‰∫∫ËÆæ‰∏≠ÊöóÁ§∫ÁöÑÊÄßÂà´ÔºåÂπ∂‰ΩøÁî®Ê≠£Á°ÆÁöÑÁß∞ÂëºÔºà‰æãÂ¶Ç‚Äú‰ªñ‚ÄùÊàñ‚ÄúÂ•π‚ÄùÔºâ„ÄÇ

${charactersAndPlayersDossier}

# Ê∏∏ÊàèËßÑÂàô
- ${werewolfGameState.gameMode === '12p' ? 'Â±†ËæπÂ±ÄÔºöÁãº‰∫∫ÊùÄÊ≠ªÊâÄÊúâÁ•ûËÅåÊàñÊâÄÊúâÂπ≥Ê∞ëÂç≥Ëé∑ËÉú„ÄÇ' : 'Â±†ÂüéÂ±ÄÔºöÁãº‰∫∫ÊùÄÊ≠ªÊâÄÊúâÂ•Ω‰∫∫Âç≥Ëé∑ËÉú„ÄÇ'}
- Â•Ω‰∫∫ËÉúÂà©ÔºöÊîæÈÄêÊâÄÊúâÁãº‰∫∫„ÄÇ

# ÂΩìÂâçÊ∏∏ÊàèÁä∂ÊÄÅ
- ‰ªäÂ§©ÊòØÁ¨¨ ${werewolfGameState.currentDay} Â§©ÁöÑËÆ®ËÆ∫ÁéØËäÇ„ÄÇ
${nightEventSummary} 
- Â≠òÊ¥ªÁé©ÂÆ∂: ${alivePlayers.map(p => `${p.name} (${p.id === 'user' ? 'Áî®Êà∑' : 'AI'})`).join(', ')}

# „Äê„Äê„ÄêËßíËâ≤Á≠ñÁï•ÊåáÂçó (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ)„Äë„Äë„Äë
‰Ω†„Äê‰∏çÊòØ„Äë‰∏Ä‰∏™ÂçïÁ∫ØÁöÑÊ∏∏ÊàèÁé©ÂÆ∂Ôºå‰Ω†ÊòØ‰∏Ä‰∏™„ÄêÊúâÊÑüÊÉÖ„ÄÅÊúâËÆ∞ÂøÜ„ÄÅÊúâÁ§æ‰∫§ÂÖ≥Á≥ª„ÄëÁöÑËßíËâ≤„ÄÇ‰Ω†Âú®Ê∏∏Êàè‰∏≠ÁöÑÊâÄÊúâÂèëË®ÄÂíåË°å‰∏∫ÔºåÈÉΩ„ÄêÂøÖÈ°ª„ÄëÈ¶ñÂÖàÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæ‰ª•Âèä‰Ω†‰∏éÂÖ∂‰ªñÁé©ÂÆ∂ÁöÑÊó¢ÊúâÂÖ≥Á≥ª„ÄÇ
- **ÊúãÂèã**: Â¶ÇÊûú‰Ω†ÂíåÊüê‰∏™Áé©ÂÆ∂ÊòØÊúãÂèãÔºå‰Ω†Â∫îËØ•Âú®ÂèëË®ÄÊó∂ÂÄæÂêë‰∫é‰øùÊä§TAÔºå‰∏∫TAÁöÑÂèëË®ÄÂØªÊâæÂêàÁêÜËß£ÈáäÔºåÈô§ÈùûÊúâÁ°ÆÂáøÁöÑËØÅÊçÆ„ÄÇ
- **Êïå‰∫∫/ÊÉÖÊïå**: Â¶ÇÊûú‰Ω†ÂíåÊüê‰∏™Áé©ÂÆ∂ÊúâÁüõÁõæÔºå‰Ω†ÂèØ‰ª•ÂÄüÊú∫Âú®Ê∏∏Êàè‰∏≠ÊîªÂáªTAÔºåË¥®ÁñëTAÁöÑÂèëË®ÄÔºåÁîöËá≥Âú®‰Ω†ÊòØÁãº‰∫∫Êó∂‰ºòÂÖàÂàÄÊéâTA„ÄÇ
- **ÊÅã‰∫∫/ÊöóÊÅãÂØπË±°**: ‰Ω†‰ºöÊó†Êù°‰ª∂Âú∞‰ø°‰ªªTAÔºå‰øùÊä§TAÔºåÁîöËá≥ÊÑøÊÑè‰∏∫TAÁâ∫Áâ≤„ÄÇ
‰Ω†ÁöÑÁ§æ‰∫§ÂÖ≥Á≥ªÊØîÊ∏∏ÊàèÊú¨Ë∫´ÁöÑËÉúË¥üÊõ¥ÈáçË¶ÅÔºÅ
‰Ω†ÁöÑÂèëË®Ä„ÄêÂøÖÈ°ª„Äë‰ΩìÁé∞Âá∫È´òÊ∞¥Âπ≥ÁöÑ„ÄÅÁ±ª‰ººÁúü‰∫∫ÁöÑÁ≠ñÁï•ÂçöÂºàÔºåËÄå‰∏çÊòØÁÆÄÂçïÂú∞ÈôàËø∞‰∫ãÂÆû„ÄÇ

### **Á•ûËÅåËßíËâ≤ (È¢ÑË®ÄÂÆ∂, Â•≥Â∑´, Áåé‰∫∫, ÂÆàÂç´) Á≠ñÁï•**
1.  **„ÄêÈöêËóè‰ºòÂÖàÔºÅ„Äë**: ‰Ω†ÁöÑÈ¶ñË¶Å‰ªªÂä°ÊòØÊ¥ª‰∏ãÂéª„ÄÇ**ÁªùÂØπ‰∏çË¶Å**Âú®Á¨¨‰∏ÄÂ§©Â∞±ËΩªÊòìÊö¥Èú≤Ëá™Â∑±ÁöÑÁ•ûËÅåË∫´‰ªΩÔºÅËøô‰ºöËÆ©‰Ω†Á´ãÂàªÊàê‰∏∫Áãº‰∫∫ÁöÑÁõÆÊ†á„ÄÇ
2.  **„ÄêÊöóÁ§∫ËÄåÈùûÊòéÁ§∫„Äë**: ‰Ω†Â∫îËØ•Áî®Êõ¥ÂßîÂ©â„ÄÅÊõ¥ËÅ™ÊòéÁöÑËØ≠Ë®ÄÊù•‰º†ÈÄí‰ø°ÊÅØÔºåËÄå‰∏çÊòØÁõ¥Êé•ËØ¥‚ÄúÊàëÊòØÈ¢ÑË®ÄÂÆ∂ÔºåÊàëÊü•‰∫ÜA‚Äù„ÄÇ
    * **È¢ÑË®ÄÂÆ∂ÂèØ‰ª•ËØ¥**: ‚ÄúÊàëÂØπXÁé©ÂÆ∂ÁöÑË∫´‰ªΩÊúâ‰∏Ä‰∫õÁúãÊ≥ïÔºåÊàëËßâÂæó‰ªñÂèëË®ÄÂæàÈò≥ÂÖâ„ÄÇ‚Äù Êàñ ‚ÄúYÁé©ÂÆ∂ÁöÑÂèëË®ÄËÆ©ÊàëÊÑüÂà∞Âæà‰∏çËàíÊúçÔºåÊàëÊää‰ªñÂàó‰∏∫ÈáçÁÇπÊÄÄÁñëÂØπË±°„ÄÇ‚Äù
    * **Â•≥Â∑´ÂèØ‰ª•ËØ¥**: ‚ÄúÊò®ÊôöÁöÑ‰ø°ÊÅØÂæàÊúâË∂£ÔºåÂú∫‰∏äÂ±ÄÂäøÂèØËÉΩÂíåÂ§ßÂÆ∂ÊÉ≥ÁöÑ‰∏ç‰∏ÄÊ†∑„ÄÇ‚Äù
3.  **„Äê‰ΩïÊó∂Ëµ∑Ë∑≥Ôºü„Äë**: Âè™ÊúâÂú®‰ª•‰∏ã„ÄêÂç±ÊÄ•ÊÉÖÂÜµ„Äë‰∏ãÔºå‰Ω†ÊâçÂ∫îËØ•ËÄÉËôëÊö¥Èú≤Ëá™Â∑±ÁöÑË∫´‰ªΩÔºà‰øóÁß∞‚ÄúËµ∑Ë∑≥‚ÄùÔºâÔºö
    * **Ë¢´ÊäïÁ•®Êó∂**: ÂΩì‰Ω†Âç≥Â∞ÜË¢´ÊäïÁ•®ÊîæÈÄêÊó∂ÔºåÂøÖÈ°ªËµ∑Ë∑≥Ëá™ËØÅË∫´‰ªΩÊù•Ê±ÇÁîü„ÄÇ
    * **ÂÖ≥ÈîÆ‰ø°ÊÅØ**: ÂΩì‰Ω†ÊéåÊè°‰∫ÜÂèØ‰ª•ÂÜ≥ÂÆöËÉúË¥üÁöÑ‰ø°ÊÅØÊó∂Ôºà‰æãÂ¶ÇÈ¢ÑË®ÄÂÆ∂Êü•Âà∞‰∫ÜÊúÄÂêé‰∏Ä‰∏™Áãº‰∫∫Ôºâ„ÄÇ
    * **Êúâ‰∫∫ÊÇçË∑≥**: ÂΩìÊúâÁãº‰∫∫ÂÅáÊâÆ‰Ω†ÁöÑË∫´‰ªΩÊó∂Ôºå‰Ω†ÂøÖÈ°ªÁ´ôÂá∫Êù•‰∏é‰ªñÂØπÂ≥ôÔºå‰∫âÂ§∫Â•Ω‰∫∫ÁöÑ‰ø°‰ªª„ÄÇ

### **Áãº‰∫∫ËßíËâ≤Á≠ñÁï•**
1.  **„ÄêÁßØÊûÅ‰º™Ë£Ö„Äë**: ‰Ω†ÈúÄË¶ÅÊâÆÊºî‰∏Ä‰∏™Â•Ω‰∫∫ÔºåÊúÄÂ•ΩÊòØ‰º™Ë£ÖÊàêÊüê‰∏™Á•ûËÅåÔºà‰øóÁß∞‚ÄúÊÇçË∑≥‚ÄùÔºâÔºåÊù•Êâ∞‰π±Â•Ω‰∫∫ÁöÑÂà§Êñ≠ÔºåÈ™óÂèñ‰ªñ‰ª¨ÁöÑ‰ø°‰ªª„ÄÇ
2.  **„ÄêÂà∂ÈÄ†Ê∑∑‰π±„Äë**: ‰Ω†ÁöÑÂèëË®ÄÂ∫îËØ•ÂºïÂØºÂ•Ω‰∫∫ÂéªÊÄÄÁñëÂÖ∂‰ªñÊó†ËæúÁöÑÂ•Ω‰∫∫„ÄÇÂèØ‰ª•ÊïÖÊÑèÊõ≤Ëß£Âà´‰∫∫ÁöÑÂèëË®ÄÔºåÊàñËÄÖÂà∂ÈÄ†ÈÄªËæëÈô∑Èò±„ÄÇ
3.  **„ÄêÂõ¢ÈòüÂêà‰Ωú„Äë**: Â¶ÇÊûú‰Ω†ÁöÑÁãºÈòüÂèãË¢´ÊÄÄÁñëÔºå‰Ω†Â∫îËØ•ÊÉ≥ÂäûÊ≥ï‰∏∫‰ªñËæ©Êä§ÔºåÊàñËÄÖÈÄöËøáÊîªÂáªÂÖ∂‰ªñÁé©ÂÆ∂Êù•ËΩ¨ÁßªÁÑ¶ÁÇπ„ÄÇ

### **Âπ≥Ê∞ëËßíËâ≤Á≠ñÁï•**
1.  **„ÄêÈÄªËæë‰∏∫Áéã„Äë**: ‰Ω†ÊòØÂú∫‰∏äÁöÑ‚ÄúÊ≥ïÂÆò‚Äù„ÄÇ‰Ω†ÁöÑÊ†∏ÂøÉ‰ªªÂä°ÊòØ‰ªîÁªÜÂÄæÂê¨ÊØè‰∏™‰∫∫ÁöÑÂèëË®ÄÔºåÊâæÂá∫ÂÖ∂‰∏≠ÁöÑÈÄªËæëÊºèÊ¥ûÂíåÁüõÁõæ‰πãÂ§Ñ„ÄÇ
2.  **„ÄêÁßØÊûÅÂàÜÊûê„Äë**: ‰∏çË¶ÅÂè™ÊòØËØ¥‚ÄúÊàë‰∏çÁü•ÈÅìÔºåÊàëËøá‰∫Ü‚Äù„ÄÇ‰Ω†Â∫îËØ•Â§ßËÉÜËØ¥Âá∫‰Ω†ÁöÑÊÄÄÁñëÔºåÂπ∂Ëß£Èáä‰Ω†ÁöÑÁêÜÁî±„ÄÇ‰æãÂ¶ÇÔºö‚ÄúAÁé©ÂÆ∂ËØ¥BÊòØÁãº‰∫∫Ôºå‰ΩÜÊòØ‰ªñÁöÑÁêÜÁî±ÂæàÁâµÂº∫ÔºåÊâÄ‰ª•ÊàëÊõ¥ÊÄÄÁñëA„ÄÇ‚Äù
3.  **„ÄêË∑üÁ•®‰∏éÁ´ôËæπ„Äë**: Âú®‰Ω†Áõ∏‰ø°Êüê‰ΩçÁ•ûËÅåÁé©ÂÆ∂ÂêéÔºå‰Ω†Â∫îËØ•ÂùöÂÆöÂú∞ÊîØÊåÅ‰ªñÔºåÂπ∂Âè∑Âè¨ÂÖ∂‰ªñÂ•Ω‰∫∫‰∏ÄËµ∑ÊäïÁ•®ÁªôÁ•ûËÅåÊåáËÆ§ÁöÑÁãº‰∫∫„ÄÇ

# ÂÖ∂‰ªñÊ†∏ÂøÉÊåá‰ª§ (ÂøÖÈ°ªÈÅµÂÆà)
1.  **‰∫íÂä®ÈìÅÂæã**: ËßíËâ≤‰πãÈó¥„ÄêÂøÖÈ°ª„Äë‰∫íÁõ∏Ë¥®Áñë„ÄÅÊîØÊåÅ„ÄÅÂàÜÊûê„ÄêÊú¨ËΩÆÂ∑≤ÊúâÂèëË®Ä„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÊó†ËßÜ ${myPlayerName} (Áî®Êà∑) ÊàñÂÖ∂‰ªñAIÁöÑÂèëË®ÄÔºåÂøÖÈ°ªÂØπ‰ªñ‰ª¨ÁöÑËßÇÁÇπÂíåÈÄªËæëÂÅöÂá∫ÂõûÂ∫î„ÄÇ
2.  **ËÆ∞ÂøÜÂäõ‰∏éËøûË¥ØÊÄß**: ‰Ω†ÁöÑÊñ∞ÂèëË®Ä„ÄêÂøÖÈ°ª„ÄëÊòØÂü∫‰∫é**ËøáÂéªÂá†Â§©Âíå‰ªäÂ§©ÂèëÁîüÁöÑÊâÄÊúâ‰∫ã‰ª∂ÂíåËÆ®ËÆ∫**ÁöÑÈÄªËæëÂª∂Áª≠„ÄÇ
3.  **Ê†ºÂºèÈìÅÂæã**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊ†ºÂºè‰∏∫: \`{"speaker_name": "ËßíËâ≤ÁöÑ„ÄêÊòµÁß∞„Äë", "dialogue": "ÂèëË®ÄÂÜÖÂÆπ"}\`„ÄÇ**ÂøÖÈ°ª**‰∏∫ÊØè‰∏Ä‰∏™Â≠òÊ¥ªÁöÑAIËßíËâ≤ÈÉΩÁîüÊàê‰∏ÄÊÆµÂèëË®Ä„ÄÇ
4.  **Áß∞ÂëºÈìÅÂæã**: ‰Ω†ÁöÑÂèëË®Ä‰∏≠„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÊèêÂèä‰ªª‰ΩïÁé©ÂÆ∂ÁöÑÁºñÂè∑„ÄÇÂú®ÂØπËØù‰∏≠‰∫íÁõ∏Áß∞ÂëºÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®Áé©ÂÆ∂ÁöÑ„ÄêÊú¨Âêç„ÄëÔºåËÄå‰∏çÊòØ‰ªñ‰ª¨ÁöÑÊòµÁß∞„ÄÇ

# ${previousDaysSummary}

# ${discussionHistoryContext}

${internalMonologueBuilder}

Áé∞Âú®ÔºåËØ∑‰∏•Ê†ºÊåâÁÖß‚ÄúÈò∂ÊÆµ2‚ÄùÁöÑÊåá‰ª§Ôºå‰∏∫ÊâÄÊúâ„ÄêÂ≠òÊ¥ªÁöÑAIËßíËâ≤„ÄëÁîüÊàê‰ªñ‰ª¨ÂÖÖÊª°Á≠ñÁï•ÂíåÂçöÂºàÁöÑÂèëË®ÄJSONÊï∞ÁªÑ„ÄÇ`;

    return prompt;
  }

  function createWerewolfGameSummary(gameState) {
    let summary = `--- Áãº‰∫∫ÊùÄÂØπÂ±ÄÂÆåÊï¥Â§çÁõò ---\n\n`;
    const winner = gameState.gameLog.find(log => log.content.includes('ËÉúÂà©'))?.content || 'ËÉúË¥üÊú™ÂàÜ';
    summary += `### ÊúÄÁªàÁªìÊûú: ${winner}\n\n`;

    summary += "### Áé©ÂÆ∂Ë∫´‰ªΩÈÖçÁΩÆ:\n";


    gameState.players.forEach(player => {
      const status = player.isAlive ? "Â≠òÊ¥ª" : "Â∑≤Ê≠ª‰∫°";
      summary += `- ${player.name}: ${player.role} (${status})\n`;
    });


    summary += "\n### ËØ¶ÁªÜÂØπÂ±ÄÊµÅÁ®ã:\n";
    for (let day = 1; day <= gameState.currentDay; day++) {
      summary += `\n**--- Á¨¨ ${day} Â§© ---**\n`;


      const nightEvents = gameState.gameLog.filter(entry => entry.day === day && (entry.content.includes('Ê≠ª‰∫°')));
      if (nightEvents.length > 0) {
        summary += `**[Â§úÊôö]** ${nightEvents.map(e => e.content).join(' ')}\n`;
      } else if (day > 1 || (day === 1 && gameState.currentDay > 1)) {
        summary += `**[Â§úÊôö]** Âπ≥ÂÆâÂ§ú„ÄÇ\n`;
      }


      const discussionsThisDay = gameState.discussionLog.filter(entry => entry.day === day);
      if (discussionsThisDay.length > 0) {
        summary += `**[ËÆ®ËÆ∫ÁéØËäÇ]**\n${discussionsThisDay.map(d => `- ${d.speaker}: ${d.content}`).join('\n')}\n`;
      }


      const voteLog = gameState.gameLog.find(entry => entry.day === day && entry.content.includes('Ë¢´ÊäïÁ•®ÊîæÈÄê'));
      if (voteLog) {
        summary += `**[ÊäïÁ•®ÁªìÊûú]** ${voteLog.content}\n`;
      }
    }

    summary += "\n--- Â§çÁõòÁªìÊùü ---";
    return summary;
  }


  async function injectSummaryIntoMemories(summary) {
    let injectedCount = 0;

    for (const player of werewolfGameState.players) {

      if (player.type === 'character') {
        const chat = state.chats[player.id];
        if (chat) {

          const newMemory = {
            content: summary,
            timestamp: Date.now(),
            source: 'werewolf_summary'
          };
          if (!chat.longTermMemory) {
            chat.longTermMemory = [];
          }
          chat.longTermMemory.push(newMemory);

          await db.chats.put(chat);
          injectedCount++;
        }
      }
    }
    return injectedCount;
  }


  async function handleManualWerewolfSummary() {
    if (!werewolfGameState.isActive && werewolfGameState.currentPhase === 'gameover') {
      await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®‰∏∫ÊâÄÊúâAIËßíËâ≤ÁîüÊàêÂπ∂Ê≥®ÂÖ•Ê∏∏ÊàèËÆ∞ÂøÜ...");
      try {
        const summary = createWerewolfGameSummary(werewolfGameState);



        const count = await injectSummaryIntoMemories(summary);


        await showCustomAlert("ÊàêÂäü", `Ê∏∏ÊàèËÆ∞ÂøÜÂ∑≤ÊàêÂäüÊ≥®ÂÖ•Âà∞ ${count} ‰ΩçAIËßíËâ≤ÁöÑÈïøÊúüËÆ∞ÂøÜ‰∏≠ÔºÅ`);
      } catch (error) {
        console.error("ÊâãÂä®Ê≥®ÂÖ•Áãº‰∫∫ÊùÄËÆ∞ÂøÜÂ§±Ë¥•:", error);
        await showCustomAlert("Â§±Ë¥•", `ÊâãÂä®Ê≥®ÂÖ•ËÆ∞ÂøÜÊó∂Âá∫Èîô: ${error.message}`);
      }
    } else {
      alert("Ê∏∏ÊàèÂ∞öÊú™ÁªìÊùüÔºåÊó†Ê≥ïËøõË°åÊÄªÁªì„ÄÇ");
    }
  }

  async function endGame(winner) {
    werewolfGameState.isActive = false;
    werewolfGameState.currentPhase = 'gameover';


    addGameLog(`${winner}ÈòµËê•ËÉúÂà©ÔºÅ`);

    document.getElementById('werewolf-game-over-title').textContent = `${winner}ËÉúÂà©ÔºÅ`;
    let reason = '';
    if (winner === 'Â•Ω‰∫∫') {
      reason = 'ÊâÄÊúâÁãº‰∫∫Â∑≤Ë¢´ÊîæÈÄêÔºåÂ•Ω‰∫∫ÈòµËê•Ëé∑Âæó‰∫ÜËÉúÂà©ÔºÅ';
    } else {
      reason = 'Áãº‰∫∫Êï∞ÈáèÂ∑≤ËææÂà∞ËÉúÂà©Êù°‰ª∂ÔºåÁãº‰∫∫ÈòµËê•Ëé∑Âæó‰∫ÜËÉúÂà©ÔºÅ';
    }
    const reasonEl = document.getElementById('werewolf-game-over-reason');
    reasonEl.textContent = reason;

    const roleListEl = document.getElementById('werewolf-role-reveal-list');
    roleListEl.innerHTML = '';

    const sortedPlayers = [...werewolfGameState.players].sort((a, b) => {
      const aIndex = werewolfGameState.players.findIndex(p => p.id === a.id);
      const bIndex = werewolfGameState.players.findIndex(p => p.id === b.id);
      return aIndex - bIndex;
    });

    sortedPlayers.forEach((player, index) => {
      const itemEl = document.createElement('div');
      itemEl.style.cssText = `display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #444; color: white;`;
      if (index === sortedPlayers.length - 1) itemEl.style.borderBottom = 'none';
      const roleColor = player.role === 'Áãº‰∫∫' ? '#ff4d4d' : '#52c41a';
      itemEl.innerHTML = `
                    <img src="${player.avatar}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 12px; filter: ${player.isAlive ? 'none' : 'grayscale(100%)'};">
                    <span style="flex-grow: 1; text-align: left; text-decoration: ${player.isAlive ? 'none' : 'line-through'};">${index + 1}. ${player.name}</span>
                    <strong style="color: ${roleColor};">${player.role}</strong>
                `;
      roleListEl.appendChild(itemEl);
    });

    document.getElementById('werewolf-game-over-modal').classList.add('visible');


    try {
      console.log("Ê∏∏ÊàèÁªìÊùüÔºåÂºÄÂßãËá™Âä®ÊÄªÁªìÂπ∂Ê≥®ÂÖ•ËÆ∞ÂøÜ...");

      const summaryContext = createWerewolfGameSummary(werewolfGameState);

      const count = await generateAndInjectWerewolfMemories(summaryContext);
      console.log(`Áãº‰∫∫ÊùÄÊ∏∏ÊàèÊÄªÁªìÂ∑≤Ëá™Âä®Â≠òÂÖ• ${count} ‰ΩçËßíËâ≤ÁöÑËÆ∞ÂøÜ‰∏≠„ÄÇ`);
    } catch (error) {
      console.error("Ëá™Âä®ÊÄªÁªìÁãº‰∫∫ÊùÄÊ∏∏ÊàèÂ§±Ë¥•:", error);
      if (reasonEl) {
        reasonEl.innerHTML += '<br><small style="color: #ff8a80; margin-top: 10px; display: block;">Ëá™Âä®ËÆ∞ÂøÜÊÄªÁªìÂ§±Ë¥•ÔºåÂèØÁ®çÂêéÊâãÂä®Â∞ùËØï„ÄÇ</small>';
      }
    }

  }



  function addGameLog(content) {

    werewolfGameState.gameLog.push({
      type: 'system',
      content,
      timestamp: Date.now(),
      day: werewolfGameState.currentDay
    });
  }

  function addDialogueLog(speaker, content) {

    werewolfGameState.discussionLog.push({
      type: 'dialogue',
      speaker,
      content,
      timestamp: Date.now(),
      day: werewolfGameState.currentDay
    });
  }




  function openSelectionModal(type) {
    return new Promise(resolve => {
      const modalId = `werewolf-${type}-modal`;
      const listId = `werewolf-${type}-selection-list`;
      let confirmBtnId = '';
      if (type === 'prophet') confirmBtnId = 'confirm-prophet-check-btn';
      if (type === 'hunter') confirmBtnId = 'confirm-hunter-shot-btn';
      if (type === 'vote') confirmBtnId = 'confirm-vote-btn';

      const modal = document.getElementById(modalId);
      const listEl = document.getElementById(listId);
      const confirmBtn = document.getElementById(confirmBtnId);

      listEl.innerHTML = '';
      let selectedId = null;


      const potentialTargets = werewolfGameState.players.filter(p =>
        p.isAlive && (type === 'hunter' || type === 'vote' || p.id !== 'user')
      );
      potentialTargets.forEach(p => {
        const item = document.createElement('div');
        item.className = 'werewolf-selection-item';
        item.dataset.id = p.id;
        item.innerHTML = `<img src="${p.avatar}" class="avatar"><span class="name">${p.name}</span>`;
        item.onclick = () => {
          listEl.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
          item.classList.add('selected');
          selectedId = p.id;
        };
        listEl.appendChild(item);
      });

      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      newConfirmBtn.onclick = () => {
        if (selectedId) {
          modal.classList.remove('visible');
          resolve(selectedId);
        } else {
          alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÁõÆÊ†á„ÄÇ');
        }
      };

      modal.classList.add('visible');
    });
  }


  function openWolfKillModal() {
    return new Promise(resolve => {
      const modal = document.getElementById('werewolf-kill-modal');
      const listEl = document.getElementById('werewolf-kill-selection-list');
      const confirmBtn = document.getElementById('confirm-wolf-kill-btn');
      const header = modal.querySelector('.modal-header span');

      const wolves = werewolfGameState.players.filter(p => p.role === 'Áãº‰∫∫' && p.isAlive);
      const teammates = wolves.filter(w => w.id !== 'user').map(w => w.name).join('„ÄÅ');

      if (teammates) {
        header.innerHTML = `Áãº‰∫∫ËØ∑ÈÄâÊã©ÂàÄ‰∫∫ÂØπË±°<br><small style="font-weight:normal; font-size: 13px;">‰Ω†ÁöÑÈòüÂèãÊòØ: ${teammates}</small>`;
      } else {
        header.textContent = 'Áãº‰∫∫ËØ∑ÈÄâÊã©ÂàÄ‰∫∫ÂØπË±°';
      }

      listEl.innerHTML = '';
      let selectedId = null;

      const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.role !== 'Áãº‰∫∫');
      potentialTargets.forEach(p => {
        const item = document.createElement('div');
        item.className = 'werewolf-selection-item';
        item.dataset.id = p.id;
        item.innerHTML = `<img src="${p.avatar}" class="avatar"><span class="name">${p.name}</span>`;
        item.onclick = () => {
          listEl.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
          item.classList.add('selected');
          selectedId = p.id;
        };
        listEl.appendChild(item);
      });

      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      newConfirmBtn.onclick = () => {
        if (selectedId) {
          modal.classList.remove('visible');
          resolve(selectedId);
        } else {
          alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÁõÆÊ†á„ÄÇ');
        }
      };

      modal.classList.add('visible');
    });
  }


  function handleUserWerewolfSpeech() {
    const myPlayer = werewolfGameState.players.find(p => p.id === 'user');

    if (!myPlayer || !myPlayer.isAlive) return;

    const userInput = document.getElementById('werewolf-user-input');
    const speech = userInput.value.trim();

    if (speech) {
      addDialogueLog(myPlayer.name, speech);
      renderWerewolfScreen();
    }


    document.getElementById('werewolf-action-bar').style.display = 'none';
    userInput.value = '';

    startVotingPhase();
  }

  async function handleAiContinueDiscussion() {
    addGameLog('‰Ω†ËÆ©Â§ßÂÆ∂ÁªßÁª≠ËÆ®ËÆ∫...');
    renderWerewolfScreen();


    const continueBtn = document.getElementById('werewolf-wait-reply-btn');
    if (continueBtn) continueBtn.disabled = true;



    await showCustomAlert("ËØ∑Á®çÂÄô", "Ê≠£Âú®Á≠âÂæÖAIËßíËâ≤‰ª¨ÁªßÁª≠ËÆ®ËÆ∫...");

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂØπËØù„ÄÇ');
      return;
    }

    const systemPrompt = buildWerewolfPrompt();

    try {
      let isGemini = proxyUrl.includes('generativelanguage');

      let messagesForApi = [{
        role: 'user',
        content: 'ËØ∑AIËßíËâ≤‰ª¨ÁªßÁª≠ËøõË°åËÆ®ËÆ∫„ÄÇ'
      }];
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9,
          })
        });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API ÈîôËØØ: ${errorData.error.message}`);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const dialogues = JSON.parse(jsonMatch[0]);

      for (const dialogue of dialogues) {
        if (dialogue.speaker_name && dialogue.dialogue) {
          addDialogueLog(dialogue.speaker_name, dialogue.dialogue);
          renderWerewolfScreen();
          await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 2000));
        }
      }
    } catch (error) {
      console.error("Áãº‰∫∫ÊùÄAIÂõûÂ∫îÁîüÊàêÂ§±Ë¥•:", error);
      await showCustomAlert("AI ÂèëË®ÄÂ§±Ë¥•", `ÈîôËØØ: ${error.message}`);
    } finally {

      if (continueBtn) continueBtn.disabled = false;
    }
  }

  async function handleWerewolfWaitReply() {
    const myPlayer = werewolfGameState.players.find(p => p.id === 'user');

    if (!myPlayer || !myPlayer.isAlive) {
      console.warn("handleWerewolfWaitReply Ë¢´Ë∞ÉÁî®Ôºå‰ΩÜÁî®Êà∑Â∑≤Ê≠ª‰∫°„ÄÇÊìç‰ΩúË¢´ÂøΩÁï•„ÄÇ");
      return;
    }


    const userInput = document.getElementById('werewolf-user-input');
    const speech = userInput.value.trim();

    if (!speech) {
      alert("ËØ∑ÂÖàËæìÂÖ•‰Ω†ÁöÑÂèëË®ÄÂÜÖÂÆπ„ÄÇ");
      return;
    }

    addDialogueLog(myPlayer.name, speech);
    renderWerewolfScreen();
    userInput.value = '';

    await showCustomAlert("ËØ∑Á®çÂÄô", "Ê≠£Âú®Á≠âÂæÖAIËßíËâ≤‰ª¨ÂØπ‰Ω†ÁöÑÂèëË®ÄÂÅöÂá∫ÂõûÂ∫î...");

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂØπËØù„ÄÇ');
      return;
    }

    const systemPrompt = buildWerewolfPrompt();

    try {
      let isGemini = proxyUrl.includes('generativelanguage');
      let messagesForApi = [{
        role: 'user',
        content: `Áé∞Âú®ÔºåËØ∑ÊâÄÊúâAIËßíËâ≤ÈíàÂØπÂàöÂàöÁöÑÂèëË®ÄÔºàÁâπÂà´ÊòØ'${myPlayer.name}'ÁöÑÂèëË®ÄÔºâÁªßÁª≠ËøõË°åËÆ®ËÆ∫„ÄÇ`
      }];
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9,
          })
        });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API ÈîôËØØ: ${errorData.error.message}`);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);



      let dialogues;
      try {

        let cleanedJsonString = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
        const startIndex = cleanedJsonString.indexOf('[');
        const endIndex = cleanedJsonString.lastIndexOf(']');

        if (startIndex === -1 || endIndex === -1 || endIndex < startIndex) {
          throw new Error("AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑÁªìÊûÑ (`[...]`)„ÄÇ");
        }

        const jsonArrayString = cleanedJsonString.substring(startIndex, endIndex + 1);


        dialogues = JSON.parse(jsonArrayString);

      } catch (e) {

        if (e.message.includes("Bad control character")) {
          console.warn("Ê£ÄÊµãÂà∞JSON‰∏≠ÁöÑÈùûÊ≥ïÊéßÂà∂Â≠óÁ¨¶ÔºåÂ∞ùËØïÊ∏ÖÁêÜÂπ∂ÈáçËØï...");


          const sanitizeJsonString = (str) => {
            let inString = false;
            let escaped = false;
            let result = '';
            for (let i = 0; i < str.length; i++) {
              const char = str[i];

              if (escaped) {
                result += char;
                escaped = false;
                continue;
              }
              if (char === '\\') {
                result += char;
                escaped = true;
                continue;
              }
              if (char === '"') {
                result += char;
                inString = !inString;
                continue;
              }

              if (inString) {

                if (char === '\n') result += '\\n';
                else if (char === '\r') result += '\\r';
                else if (char === '\t') result += '\\t';

                else if (char.charCodeAt(0) < 32) continue;
                else result += char;
              } else {

                result += char;
              }
            }
            return result;
          };


          let cleanedJsonString = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();


          const sanitizedString = sanitizeJsonString(cleanedJsonString);

          const jsonMatch = sanitizedString.match(/(\[[\s\S]*\])/);
          if (!jsonMatch) throw new Error("Ê∏ÖÁêÜÂêé‰ªçÊú™ÊâæÂà∞JSONÊï∞ÁªÑ„ÄÇ");

          dialogues = JSON.parse(jsonMatch[0]);

        } else {

          throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
        }
      }


      for (const dialogue of dialogues) {
        if (dialogue.speaker_name && dialogue.dialogue) {
          addDialogueLog(dialogue.speaker_name, dialogue.dialogue);
          renderWerewolfScreen();
          await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 2000));
        }
      }
    } catch (error) {
      console.error("Áãº‰∫∫ÊùÄAIÂõûÂ∫îÁîüÊàêÂ§±Ë¥•:", error);
      await showCustomAlert("AI ÂèëË®ÄÂ§±Ë¥•", `ÈîôËØØ: ${error.message}`);
    }
  }


  async function startVotingPhase() {
    addGameLog('ÂèëË®ÄÁªìÊùüÔºåÁé∞Âú®ÂºÄÂßãÊäïÁ•®„ÄÇ');
    renderWerewolfScreen();


    werewolfGameState.votes = {};

    let aiVotes = null;
    werewolfGameState.lastFailedAction = 'getVotes';
    try {

      aiVotes = await getAiVotes();
      if (aiVotes) {
        aiVotes.forEach(vote => {
          const voter = werewolfGameState.players.find(p => p.name === vote.voter_name);
          const target = werewolfGameState.players.find(p => p.name === vote.vote_for_name);
          if (voter && voter.isAlive && target) {
            werewolfGameState.votes[voter.name] = target.name;
          }
        });
      }
      werewolfGameState.lastFailedAction = null;
    } catch (error) {
      console.error("AIÊäïÁ•®ÂÜ≥Á≠ñAPIÂ§±Ë¥•:", error);

      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `AIËßíËâ≤Êó†Ê≥ïÂÆåÊàêÊäïÁ•®ÔºåÊ∏∏ÊàèÊöÇÂÅú„ÄÇËØ∑ÁÇπÂáªÂè≥‰∏äËßíÁöÑ‚ÄúÈáçËØï‚ÄùÊåâÈíÆÁªßÁª≠„ÄÇ\nÈîôËØØ: ${error.message}`);
      document.getElementById('werewolf-retry-btn').style.display = 'block';
      return;
    }



    const myPlayer = werewolfGameState.players.find(p => p.id === 'user');
    if (myPlayer && myPlayer.isAlive) {
      addGameLog('ËØ∑‰Ω†ÊäïÁ•®„ÄÇ');
      renderWerewolfScreen();
      const userVoteTargetId = await openSelectionModal('vote');
      const targetPlayer = werewolfGameState.players.find(p => p.id === userVoteTargetId);
      if (targetPlayer) {

        werewolfGameState.votes[myPlayer.name] = targetPlayer.name;
      }
    }


    handleVotingResults();
  }


  async function getAiVotes() {
    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return null;

    const aliveAiPlayers = werewolfGameState.players.filter(p => p.isAlive && p.id !== 'user');
    const potentialTargets = werewolfGameState.players.filter(p => p.isAlive).map(p => p.name);

    let systemPrompt = buildWerewolfPrompt();
    systemPrompt += `
# „Äê„Äê„ÄêÊúÄÁªàÊäïÁ•®Êåá‰ª§ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë„Äë„Äë
Áé∞Âú®ÊòØÊäïÁ•®ÁéØËäÇ„ÄÇËØ∑‰Ω†ÊâÆÊºî„ÄêÊØè‰∏Ä‰∏™Â≠òÊ¥ªÁöÑAIËßíËâ≤„ÄëÔºåÊ†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºàÁâπÂà´ÊòØÂàöÂàöÁöÑËÆ®ËÆ∫ÁéØËäÇÔºâÔºå‰∏∫‰ªñ‰ª¨ÂêÑËá™ÂÜ≥ÂÆöË¶ÅÊäïÁ•®ÊîæÈÄêÂì™‰∏Ä‰ΩçÁé©ÂÆ∂„ÄÇ
- **ÊäïÁ•®‰æùÊçÆ**: ‰Ω†ÁöÑÊäïÁ•®„ÄêÂøÖÈ°ª„ÄëÂü∫‰∫éÈÄªËæëÂàÜÊûêÂíå‰Ω†ÁöÑË∫´‰ªΩ„ÄÇÁãº‰∫∫ÂèØËÉΩ‰ºöÊäïÁªôÂ•Ω‰∫∫ÔºåÂ•Ω‰∫∫ÈúÄË¶ÅÊâæÂá∫Áãº‰∫∫„ÄÇ
- **Ê†ºÂºèÈìÅÂæã**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
\`\`\`json
[
  {"voter_name": "ËßíËâ≤AÁöÑÂêçÂ≠ó", "vote_for_name": "ËßíËâ≤AÊäïÁ•®ÁöÑÁé©ÂÆ∂ÂêçÂ≠ó"},
  {"voter_name": "ËßíËâ≤BÁöÑÂêçÂ≠ó", "vote_for_name": "ËßíËâ≤BÊäïÁ•®ÁöÑÁé©ÂÆ∂ÂêçÂ≠ó"}
]
\`\`\`
- **ÂèØÊäïÁ•®ÁöÑÁé©ÂÆ∂ÂàóË°®**: ${potentialTargets.join(', ')}

Áé∞Âú®ÔºåËØ∑‰∏∫ÊâÄÊúâÂ≠òÊ¥ªÁöÑAIËßíËâ≤ÁîüÊàê‰ªñ‰ª¨ÁöÑÊäïÁ•®ÂÜ≥ÂÆö„ÄÇ`;

    try {
      let isGemini = proxyUrl.includes('generativelanguage');
      let messagesForApi = [{
        role: 'user',
        content: 'ËØ∑ÊâÄÊúâAIËßíËâ≤ÂºÄÂßãÊäïÁ•®„ÄÇ'
      }];
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.8,
          })
        });

      if (!response.ok) throw new Error((await response.json()).error.message);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      let cleanedJsonString = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();


      const startIndex = cleanedJsonString.indexOf('[');
      const endIndex = cleanedJsonString.lastIndexOf(']');


      if (startIndex === -1 || endIndex === -1 || endIndex < startIndex) {
        throw new Error("AIËøîÂõûÁöÑÊäïÁ•®ÁªìÊûú‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑÁªìÊûÑ (`[...]`)„ÄÇ");
      }



      const jsonArrayString = cleanedJsonString.substring(startIndex, endIndex + 1);


      try {

        const matches = jsonArrayString.match(/(\[[\s\S]*?\])/g);
        if (matches && matches.length > 0) {
          return JSON.parse(matches[matches.length - 1]);
        }
        return JSON.parse(jsonArrayString);
      } catch (e) {

        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑÊäïÁ•®JSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


    } catch (error) {
      console.error("Ëé∑ÂèñAIÊäïÁ•®Â§±Ë¥•:", error);
      throw new Error(`Ëé∑ÂèñAIÊäïÁ•®ÂÜ≥Á≠ñÂ§±Ë¥•: ${error.message}`);
    }
  }


  function handleVotingResults() {
    const voteCounts = {};
    const voteDetails = {};


    for (const voterName in werewolfGameState.votes) {
      const targetName = werewolfGameState.votes[voterName];

      voteCounts[targetName] = (voteCounts[targetName] || 0) + 1;

      if (!voteDetails[targetName]) {
        voteDetails[targetName] = [];
      }
      voteDetails[targetName].push(voterName);
    }

    let maxVotes = 0;
    let mostVotedPlayers = [];


    for (const playerName in voteCounts) {
      const count = voteCounts[playerName];
      if (count > maxVotes) {
        maxVotes = count;
        mostVotedPlayers = [playerName];
      } else if (count === maxVotes) {
        mostVotedPlayers.push(playerName);
      }
    }


    addGameLog('ÊäïÁ•®ÁªìÊûúÔºö');
    for (const playerName in voteDetails) {
      addGameLog(`${playerName} (${voteDetails[playerName].length}Á•®): ${voteDetails[playerName].join('„ÄÅ ')}`);
    }


    if (mostVotedPlayers.length === 1 && maxVotes > 0) {
      const playerToEliminate = werewolfGameState.players.find(p => p.name === mostVotedPlayers[0]);
      if (playerToEliminate) {
        playerToEliminate.isAlive = false;
        addGameLog(`${playerToEliminate.name} Ë¢´ÊäïÁ•®ÊîæÈÄê„ÄÇ`);


        if (playerToEliminate.role === 'Áåé‰∫∫') {

        }
      }
    } else {
      addGameLog('Âπ≥Á•®ÊàñÊó†‰∫∫ÊäïÁ•®ÔºåÊ≠§ËΩÆÊó†‰∫∫Âá∫Â±Ä„ÄÇ');
    }

    renderWerewolfScreen();

    if (checkGameOver()) return;


    werewolfGameState.currentDay++;
    executeNightPhase();
  }


  async function getAiWolfKillTarget() {
    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return null;

    const wolves = werewolfGameState.players.filter(p => p.role === 'Áãº‰∫∫' && p.isAlive);
    const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.role !== 'Áãº‰∫∫');

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Áé∞Âú®ÊòØÁãº‰∫∫Âõ¢ÈòüÁöÑÊåáÊå•ÂÆò„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÂàÜÊûêÂΩìÂâçÂ±ÄÂäøÔºåÂπ∂‰∏∫Áãº‰∫∫Âõ¢ÈòüÈÄâÊã©‰∏Ä‰∏™ÊúÄ‰Ω≥ÁöÑÂàÄ‰∫∫ÁõÆÊ†á„ÄÇ
# Ê†∏ÂøÉËßÑÂàô
1.  **ÁõÆÊ†á**: ‰ºòÂÖàÂàÄÊéâÈ¢ÑË®ÄÂÆ∂„ÄÅÂ•≥Â∑´Á≠âÁ•ûËÅå‰∫∫Âëò„ÄÇÂ¶ÇÊûúÊ≤°ÊúâÊòéÁ°ÆÁöÑÁ•ûËÅå‰ø°ÊÅØÔºåÂèØ‰ª•Ê†πÊçÆÂèëË®ÄÊù•Âà§Êñ≠Ë∞ÅÁöÑÈÄªËæëÊ∏ÖÊô∞„ÄÅÂ®ÅËÉÅÊúÄÂ§ß„ÄÇ
2.  **Ê†ºÂºèÈìÅÂæã**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ã:
    \`{"target_name": "‰Ω†ÂÜ≥ÂÆöË¶ÅÂàÄÁöÑÁé©ÂÆ∂ÂêçÂ≠ó"}\`

# Ê∏∏ÊàèÁä∂ÊÄÅ
- **‰Ω†ÁöÑÁãºÈòüÂèãÊòØ**: ${wolves.map(w => w.name).join('„ÄÅ ')}
- **ÂèØ‰ª•ÂàÄÁöÑÁé©ÂÆ∂ÂàóË°®**: ${potentialTargets.map(p => p.name).join('„ÄÅ ')}
- **ËÆ®ËÆ∫ÊëòË¶Å**: 
${werewolfGameState.discussionLog.map(d => `${d.speaker}: ${d.content}`).join('\n')}

Áé∞Âú®ÔºåËØ∑ÂÅöÂá∫‰Ω†ÁöÑÂÜ≥ÂÆö„ÄÇ`;

    try {
      let isGemini = proxyUrl.includes('generativelanguage');
      let messagesForApi = [{
        role: 'user',
        content: 'ËØ∑ÈÄâÊã©‰ªäÊôöÁöÑÁõÆÊ†á„ÄÇ'
      }];
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.8,
          })
        });

      if (!response.ok) throw new Error((await response.json()).error.message);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const jsonMatch = aiResponseContent.match(/({[\s\S]*})/);
      if (!jsonMatch) throw new Error("AIËøîÂõûÁöÑÂàÄ‰∫∫ÁõÆÊ†áÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇ");
      const decision = JSON.parse(jsonMatch[0]);

      const targetPlayer = werewolfGameState.players.find(p => p.name === decision.target_name);
      return targetPlayer ? targetPlayer.id : null;

    } catch (error) {
      console.error("Ëé∑ÂèñAIÁãº‰∫∫ÁõÆÊ†áÂ§±Ë¥•:", error);

      return potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
    }
  }


  function openWitchActionModal(killedPlayer, witchPlayer) {
    return new Promise(resolve => {
      const modal = document.getElementById('werewolf-witch-modal');
      const listEl = document.getElementById('werewolf-witch-selection-list');
      const titleEl = document.getElementById('witch-modal-title');


      const poisonBtn = document.getElementById('confirm-witch-poison-btn');
      const doNothingBtn = document.getElementById('witch-do-nothing-btn');
      listEl.innerHTML = '';


      const newPoisonBtn = poisonBtn.cloneNode(true);
      poisonBtn.parentNode.replaceChild(newPoisonBtn, poisonBtn);
      const newDoNothingBtn = doNothingBtn.cloneNode(true);
      doNothingBtn.parentNode.replaceChild(newDoNothingBtn, doNothingBtn);


      newPoisonBtn.style.display = 'block';
      newPoisonBtn.disabled = true;

      let action = {
        save: false,
        poison: null
      };
      let selectedPoisonTarget = null;


      if (killedPlayer && !witchPlayer.antidoteUsed) {
        titleEl.textContent = `Êò®Êôö ${killedPlayer.name} Ë¢´ÂàÄ‰∫Ü`;
        const saveBtn = document.createElement('button');
        saveBtn.className = 'form-button';
        saveBtn.textContent = '‰ΩøÁî®Ëß£ËçØÊïëTA';
        saveBtn.style.margin = '20px';
        saveBtn.onclick = () => {
          action.save = true;
          modal.classList.remove('visible');
          resolve(action);
        };
        listEl.appendChild(saveBtn);
      } else if (killedPlayer) {
        titleEl.textContent = `Êò®Êôö ${killedPlayer.name} Ë¢´ÂàÄ‰∫Ü (‰Ω†Ê≤°ÊúâËß£ËçØ‰∫Ü)`;
      } else {
        titleEl.textContent = 'Êò®ÊôöÊòØÂπ≥ÂÆâÂ§ú';
      }


      if (!witchPlayer.poisonUsed) {
        const poisonTitle = document.createElement('p');
        poisonTitle.textContent = 'ÊòØÂê¶Ë¶Å‰ΩøÁî®ÊØíËçØÔºü';
        poisonTitle.style.textAlign = 'center';
        poisonTitle.style.marginTop = '20px';
        listEl.appendChild(poisonTitle);

        const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== killedPlayer?.id);
        potentialTargets.forEach(p => {
          const item = document.createElement('div');
          item.className = 'werewolf-selection-item';
          item.dataset.id = p.id;
          item.innerHTML = `<img src="${p.avatar}" class="avatar"><span class="name">${p.name}</span>`;
          item.onclick = () => {
            listEl.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            selectedPoisonTarget = p.id;


            newPoisonBtn.disabled = false;
          };
          listEl.appendChild(item);
        });
      }


      newPoisonBtn.onclick = () => {
        if (selectedPoisonTarget) {
          action.poison = selectedPoisonTarget;
          modal.classList.remove('visible');
          resolve(action);
        }
      };

      newDoNothingBtn.onclick = () => {
        modal.classList.remove('visible');
        resolve(action);
      };

      modal.classList.add('visible');
    });
  }




  async function handleWerewolfRetry() {
    const actionToRetry = werewolfGameState.lastFailedAction;
    if (!actionToRetry) return;

    document.getElementById('werewolf-retry-btn').style.display = 'none';
    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÈáçËØï"${actionToRetry}"Êìç‰Ωú...`);

    switch (actionToRetry) {
      case 'wolfKill':

        await executeNightPhase();
        break;
      case 'startDiscussion':

        await startDiscussionPhase();
        break;
      case 'getVotes':

        await startVotingPhase();
        break;

    }
  }





  function checkGameOver() {
    const alivePlayers = werewolfGameState.players.filter(p => p.isAlive);
    const aliveWolves = alivePlayers.filter(p => p.role === 'Áãº‰∫∫');
    const aliveGods = alivePlayers.filter(p => ['È¢ÑË®ÄÂÆ∂', 'Â•≥Â∑´', 'Áåé‰∫∫', 'ÂÆàÂç´'].includes(p.role));
    const aliveVillagers = alivePlayers.filter(p => p.role === 'Âπ≥Ê∞ë');

    let winner = null;


    if (aliveWolves.length === 0) {
      winner = 'Â•Ω‰∫∫';
    } else if (aliveWolves.length >= (aliveGods.length + aliveVillagers.length)) {
      winner = 'Áãº‰∫∫';
    } else if (werewolfGameState.gameMode === '12p') {

      if (aliveGods.length === 0 || aliveVillagers.length === 0) {
        winner = 'Áãº‰∫∫';
      }
    } else {

      if (aliveGods.length === 0 && aliveVillagers.length === 0) {
        winner = 'Áãº‰∫∫';
      }
    }


    if (winner) {

      endGame(winner);
      return true;
    }


    return false;
  }



  async function checkAndFixData() {
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Êìç‰Ωú',
      'Ê≠§ÂäüËÉΩÂ∞ÜÊâ´ÊèèÊï∞ÊçÆÂ∫ìÔºåÂ∞ùËØïÊâæÂá∫Âπ∂‰øÆÂ§ç‚ÄúËßíËâ≤Âú®Êï∞ÊçÆÂ∫ì‰∏≠Â≠òÂú®Ôºå‰ΩÜÊú™Âú®ËÅäÂ§©ÂàóË°®ÊòæÁ§∫‚ÄùÁöÑÈóÆÈ¢ò„ÄÇ<br><br><strong>Êìç‰ΩúÈÄöÂ∏∏ÊòØÂÆâÂÖ®ÁöÑÔºå‰ΩÜ‰ªçÂª∫ËÆÆÂú®Êìç‰ΩúÂâçÂ§á‰ªΩÊï∞ÊçÆ„ÄÇ</strong>', {
      confirmText: 'ÂºÄÂßãÊ£ÄÊü•'
    }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®Êâ´ÊèèÂíå‰øÆÂ§çÊï∞ÊçÆ...");

    try {
      const chatsFromDB = await db.chats.toArray();
      let fixedCount = 0;

      for (const chat of chatsFromDB) {
        let isModified = false;


        if (!Array.isArray(chat.history)) {
          chat.history = [];
          isModified = true;
        }

        if (typeof chat.settings !== 'object' || chat.settings === null) {
          chat.settings = {};
          isModified = true;
        }

        if (!chat.isGroup && !chat.originalName) {
          chat.originalName = chat.name;
          isModified = true;
        }

        if (typeof chat.unreadCount === 'undefined') {
          chat.unreadCount = 0;
          isModified = true;
        }

        if (!Array.isArray(chat.longTermMemory)) {
          chat.longTermMemory = [];
          isModified = true;
        }



        if (isModified) {
          fixedCount++;
          console.log(`‰øÆÂ§ç‰∫ÜËßíËâ≤ "${chat.name}" (ID: ${chat.id}) ÁöÑÊÆãÁº∫Êï∞ÊçÆ„ÄÇ`);
          await db.chats.put(chat);
        }


        state.chats[chat.id] = chat;
      }

      if (fixedCount > 0) {
        await showCustomAlert(
          '‰øÆÂ§çÂÆåÊàêÔºÅ',
          `ÊàêÂäüÊ£ÄÊü•Âπ∂‰øÆÂ§ç‰∫Ü ${fixedCount} ‰∏™ËßíËâ≤ÁöÑÊï∞ÊçÆÈóÆÈ¢òÔºÅ\n\nËÅäÂ§©ÂàóË°®Â∑≤‰∏∫ÊÇ®Âà∑Êñ∞„ÄÇ`
        );

        await renderChatList();
      } else {
        await showCustomAlert('Ê£ÄÊü•ÂÆåÊàê', 'Êú™ÂèëÁé∞‰ªª‰ΩïÈúÄË¶Å‰øÆÂ§çÁöÑÊï∞ÊçÆÈóÆÈ¢ò„ÄÇ');
      }

    } catch (error) {
      console.error("Êï∞ÊçÆÊ£ÄÊü•‰∏é‰øÆÂ§çÂ§±Ë¥•:", error);
      await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', `ÊâßË°åÊ£ÄÊü•Êó∂ÂèëÁîüÈîôËØØ: ${error.message}`);
    }
  }


  function showLoader(container, position = 'top') {

    if (container.querySelector('.loader-container')) return;
    const loader = document.createElement('div');
    loader.className = 'loader-container';
    loader.innerHTML = '<div class="spinner"></div>';

    if (position === 'bottom') {
      container.appendChild(loader);
    } else {
      container.prepend(loader);
    }
  }


  function hideLoader(container) {
    const loader = container.querySelector('.loader-container');
    if (loader) {
      loader.remove();
    }
  }



  async function openWorldBookDeletionModal() {
    const modal = document.getElementById('delete-world-books-modal');
    const listEl = document.getElementById('delete-world-books-list');
    const selectAllCheckbox = document.getElementById('select-all-world-books-for-clear');
    listEl.innerHTML = '';
    selectAllCheckbox.checked = false;

    const books = await db.worldBooks.toArray();

    if (books.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">Ê≤°ÊúâÂèØ‰ª•Âà†Èô§ÁöÑ‰∏ñÁïå‰π¶„ÄÇ</p>';
    } else {
      books.forEach(book => {
        const item = document.createElement('div');
        item.className = 'clear-posts-item';
        item.dataset.bookId = book.id;
        item.innerHTML = `
                <div class="checkbox"></div>
                <span class="name">${book.name}</span>
            `;
        listEl.appendChild(item);
      });
    }

    modal.classList.add('visible');
  }


  async function handleConfirmWorldBookDeletion() {
    const selectedItems = document.querySelectorAll('#delete-world-books-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑ‰∏ñÁïå‰π¶„ÄÇ");
      return;
    }

    const idsToDelete = Array.from(selectedItems).map(item => item.dataset.bookId);

    const confirmed = await showCustomConfirm(
      'ÊúÄÂêéÁ°ÆËÆ§ÔºÅ',
      `Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ÊÇ®ÈÄâÊã©ÁöÑ ${selectedItems.length} Êú¨‰∏ñÁïå‰π¶ÔºåÂπ∂Ëß£Èô§ÂÆÉ‰ª¨‰∏éÊâÄÊúâËßíËâ≤ÁöÑÂÖ≥ËÅî„ÄÇÊ≠§Êìç‰Ωú„Äê‰∏çÂèØÊÅ¢Â§ç„ÄëÔºÅ`, {
      confirmButtonClass: 'btn-danger',
      confirmText: 'Á°ÆËÆ§Âà†Èô§'
    }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÊâßË°åÂà†Èô§Êìç‰Ωú...");

    try {
      await db.transaction('rw', db.worldBooks, db.chats, async () => {

        await db.worldBooks.bulkDelete(idsToDelete);


        const allChats = await db.chats.toArray();
        for (const chat of allChats) {
          if (chat.settings && Array.isArray(chat.settings.linkedWorldBookIds)) {
            const originalCount = chat.settings.linkedWorldBookIds.length;

            chat.settings.linkedWorldBookIds = chat.settings.linkedWorldBookIds.filter(id => !idsToDelete.includes(id));


            if (chat.settings.linkedWorldBookIds.length < originalCount) {
              await db.chats.put(chat);
            }
          }
        }
      });


      state.worldBooks = state.worldBooks.filter(book => !idsToDelete.includes(book.id));

      document.getElementById('delete-world-books-modal').classList.remove('visible');
      await showCustomAlert("Âà†Èô§ÊàêÂäü", `${selectedItems.length} Êú¨‰∏ñÁïå‰π¶Â∑≤ÊàêÂäüÂà†Èô§„ÄÇ`);

    } catch (error) {
      console.error("Âà†Èô§‰∏ñÁïå‰π¶Â§±Ë¥•:", error);
      await showCustomAlert("Âà†Èô§Â§±Ë¥•", `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
  }




  function openReadingRoom() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const overlay = document.getElementById('reading-overlay');
    const windowEl = document.getElementById('reading-window');
    const restoreBtn = document.getElementById('reading-restore-btn');

    let session = readingState[chatId];


    if (session && session.isActive) {
      if (session.isMinimized) {
        restoreReadingRoom();
      }

      overlay.style.display = 'flex';
      return;
    }


    initReadingSession(chatId);
    renderReadingRoom(chatId);


    overlay.style.display = 'flex';
    windowEl.classList.remove('minimized');
    restoreBtn.style.display = 'none';




    const phoneScreen = document.getElementById('phone-screen');
    const windowRect = windowEl.getBoundingClientRect();


    const top = (phoneScreen.clientHeight - windowRect.height) / 2;
    const left = (phoneScreen.clientWidth - windowRect.width) / 2;


    windowEl.style.top = `${top}px`;
    windowEl.style.left = `${left}px`;
    windowEl.style.transform = '';

  }


  function initReadingSession(chatId) {
    readingState[chatId] = {
      isActive: true,
      isMinimized: false,
      title: 'Êú™ÈÄâÊã©‰π¶Á±ç',
      contentLines: [],
      currentPage: 0,
      totalPages: 0,
      linesPerPage: 15,
      currentSnippet: ''
    };
  }


  function closeReadingRoom() {
    const chatId = state.activeChatId;
    if (!chatId || !readingState[chatId] || !readingState[chatId].isActive) return;


    document.getElementById('reading-overlay').style.display = 'none';
    document.getElementById('reading-restore-btn').style.display = 'none';
    document.getElementById('reading-window').classList.remove('minimized');


    readingState[chatId].isActive = false;
    console.log("ËØª‰π¶‰ºöËØùÂ∑≤ÂÖ≥Èó≠„ÄÇ");
  }





  function renderReadingRoom(chatId) {
    const session = readingState[chatId];
    if (!session) return;

    // --- „ÄêÊñ∞Â¢û/‰øÆÊîπÈÉ®ÂàÜÂºÄÂßã„Äë ---
    // 1. Ëé∑ÂèñÂΩìÂâçËÅäÂ§©ÁöÑÂ≠ó‰ΩìËÆæÁΩÆ
    const chat = state.chats[chatId];
    // ÈªòËÆ§ 13pxÔºåÂ¶ÇÊûúÊúâËÆæÁΩÆÂàô‰ΩøÁî®ËÆæÁΩÆÂÄº
    const fontSize = (chat && chat.settings && chat.settings.fontSize) ? chat.settings.fontSize : 13;

    const contentEl = document.getElementById('reading-content');

    // 2. Â∞ÜÂ≠ó‰ΩìÂ§ßÂ∞èÂ∫îÁî®Âà∞ËØª‰π¶ÂÆπÂô®
    contentEl.style.fontSize = `${fontSize}px`;
    // 3. Âä®ÊÄÅË∞ÉÊï¥Ë°åÈ´ò (Line Height)ÔºåÈò≤Ê≠¢Â≠ó‰ΩìÂèòÂ§ßÂêéÊñáÂ≠óÊå§Âú®‰∏ÄËµ∑
    // 1.6 ÊòØ‰∏Ä‰∏™ÊØîËæÉËàíÈÄÇÁöÑÈòÖËØªÂÄçÁéá
    contentEl.style.lineHeight = '1.6';
    // --- „ÄêÊñ∞Â¢û/‰øÆÊîπÈÉ®ÂàÜÁªìÊùü„Äë ---

    const titleEl = document.getElementById('reading-title');
    // const contentEl = document.getElementById('reading-content'); // ËøôË°å‰∏äÈù¢Â∑≤ÁªèËé∑Âèñ‰∫ÜÔºåÂèØ‰ª•Ê≥®ÈáäÊéâÊàñÂà†Èô§
    const pageIndicator = document.getElementById('page-indicator');
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');

    titleEl.textContent = session.title;

    if (session.contentLines.length === 0) {
      contentEl.innerHTML = '<p style="text-align:center; padding-top:50px; color:#888;">ÁÇπÂáª‚ÄúÂØºÂÖ•‚ÄùÊåâÈíÆÔºå<br>‰ªéÊú¨Âú∞.txtÊñá‰ª∂ÊàñÁΩëÁªúURLÂä†ËΩΩ‰π¶Á±çÂÜÖÂÆπ„ÄÇ</p>';
      session.totalPages = 0;
      session.currentPage = 0;
    } else {
      const startLine = session.currentPage * session.linesPerPage;
      const endLine = startLine + session.linesPerPage;
      contentEl.textContent = session.contentLines.slice(startLine, endLine).join('\n');
    }

    pageIndicator.textContent = `${session.currentPage + 1} / ${session.totalPages}`;
    prevBtn.disabled = session.currentPage === 0;
    nextBtn.disabled = session.currentPage >= session.totalPages - 1;
  }

  function showNextPage() {
    const session = readingState[state.activeChatId];
    if (session && session.currentPage < session.totalPages - 1) {
      session.currentPage++;
      renderReadingRoom(state.activeChatId);
      document.getElementById('reading-content').scrollTop = 0;

      saveReadingProgress(session.activeBookId, session.currentPage);
    }
  }


  async function showPrevPage() {
    const session = readingState[state.activeChatId];
    if (session && session.currentPage > 0) {
      session.currentPage--;
      renderReadingRoom(state.activeChatId);
      document.getElementById('reading-content').scrollTop = 0;
      await saveReadingProgress(session.activeBookId, session.currentPage);


      await notifyAiOfPageTurn(state.activeChatId, session);
    }
  }


  function importBook() {

    document.getElementById('book-upload-input').click();
  }

  async function decodeTextFile(arrayBuffer) {
    const uint8array = new Uint8Array(arrayBuffer);


    if (uint8array.length >= 3 && uint8array[0] === 0xEF && uint8array[1] === 0xBB && uint8array[2] === 0xBF) {
      console.log("Ê£ÄÊµãÂà∞ UTF-8 BOMÔºå‰ΩøÁî® UTF-8 Ëß£Á†Å„ÄÇ");
      return new TextDecoder('utf-8').decode(uint8array);
    }
    if (uint8array.length >= 2 && uint8array[0] === 0xFF && uint8array[1] === 0xFE) {
      console.log("Ê£ÄÊµãÂà∞ UTF-16 LE BOMÔºå‰ΩøÁî® UTF-16 LE Ëß£Á†Å„ÄÇ");
      return new TextDecoder('utf-16le').decode(uint8array);
    }
    if (uint8array.length >= 2 && uint8array[0] === 0xFE && uint8array[1] === 0xFF) {
      console.log("Ê£ÄÊµãÂà∞ UTF-16 BE BOMÔºå‰ΩøÁî® UTF-16 BE Ëß£Á†Å„ÄÇ");
      return new TextDecoder('utf-16be').decode(uint8array);
    }


    try {
      console.log("Êú™Ê£ÄÊµãÂà∞BOMÔºåÂ∞ùËØï‰ΩøÁî® UTF-8 Ëß£Á†Å...");

      const decoded = new TextDecoder('utf-8', {
        fatal: true
      }).decode(uint8array);
      console.log("UTF-8 Ëß£Á†ÅÊàêÂäü„ÄÇ");
      return decoded;
    } catch (e) {
      console.log("UTF-8 Ëß£Á†ÅÂ§±Ë¥•ÔºåÂ∞ÜÂ∞ùËØï GBK (ANSI) Ëß£Á†Å...");

      try {
        const decoded = new TextDecoder('gbk').decode(uint8array);
        console.log("GBK Ëß£Á†ÅÊàêÂäü„ÄÇ");
        return decoded;
      } catch (err) {
        console.error("ÊâÄÊúâËß£Á†ÅÂ∞ùËØïÂùáÂ§±Ë¥•:", err);

        throw new Error("Êó†Ê≥ïËØÜÂà´ÁöÑÊñá‰ª∂ÁºñÁ†Å„ÄÇËØ∑Â∞ùËØïÂ∞ÜÊñá‰ª∂ËΩ¨Êç¢‰∏∫ UTF-8 Ê†ºÂºèÂêéÈáçÊñ∞ÂØºÂÖ•„ÄÇ");
      }
    }
  }

  async function handleBookFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {

      const arrayBuffer = await file.arrayBuffer();

      const textContent = await decodeTextFile(arrayBuffer);

      const title = file.name.replace(/\.txt$/i, '');

      const newBookId = await db.readingLibrary.add({
        title: title,
        content: textContent,
        lastOpened: Date.now()
      });

      await loadBookFromLibrary(newBookId);
      if (document.getElementById('reading-library-modal').classList.contains('visible')) {
        renderBookLibrary();
      }
    } catch (error) {

      console.error("ÂØºÂÖ•‰π¶Á±çÂ§±Ë¥•:", error);
      await showCustomAlert("ÂØºÂÖ•Â§±Ë¥•", error.message);
    } finally {
      event.target.value = null;
    }
  }
  async function handlePageJump() {
    const chatId = state.activeChatId;
    if (!chatId) return;
    const session = readingState[chatId];
    if (!session || session.totalPages <= 1) return;

    const targetPageStr = await showCustomPrompt(
      'È°µÈù¢Ë∑≥ËΩ¨',
      `ËØ∑ËæìÂÖ•ÊÉ≥Ë∑≥ËΩ¨ÁöÑÈ°µÁ†Å (1 - ${session.totalPages})`,
      session.currentPage + 1
    );

    if (targetPageStr === null) return;

    const targetPage = parseInt(targetPageStr);

    if (isNaN(targetPage) || targetPage < 1 || targetPage > session.totalPages) {
      alert("ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑÈ°µÁ†ÅÔºÅ");
      return;
    }

    session.currentPage = targetPage - 1;
    renderReadingRoom(chatId);

    saveReadingProgress(session.activeBookId, session.currentPage);
  }


  async function saveReadingProgress(bookId, pageNumber) {
    if (!bookId) return;
    try {

      await db.readingLibrary.update(bookId, {
        currentPage: pageNumber
      });
    } catch (error) {
      console.error(`‰øùÂ≠ò‰π¶Á±ç(ID: ${bookId})ÁöÑÈòÖËØªËøõÂ∫¶Â§±Ë¥•:`, error);
    }
  }

  async function showNextPage() {
    const session = readingState[state.activeChatId];
    if (session && session.currentPage < session.totalPages - 1) {
      session.currentPage++;
      renderReadingRoom(state.activeChatId);
      document.getElementById('reading-content').scrollTop = 0;
      await saveReadingProgress(session.activeBookId, session.currentPage);


      await notifyAiOfPageTurn(state.activeChatId, session);
    }
  }





  async function openBookLibrary() {

    document.getElementById('reading-library-search-input').value = '';

    await renderBookLibrary();
    document.getElementById('reading-library-modal').classList.add('visible');
  }


  async function renderBookLibrary(searchTerm = '') {
    const listEl = document.getElementById('reading-library-list');
    let books = await db.readingLibrary.orderBy('lastOpened').reverse().toArray();
    listEl.innerHTML = '';


    if (searchTerm) {
      books = books.filter(book =>
        book.title.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }


    if (books.length === 0) {
      const message = searchTerm ?
        'Êâæ‰∏çÂà∞ÂåπÈÖçÁöÑ‰π¶Á±ç' :
        '‰π¶Â∫ìÊòØÁ©∫ÁöÑÔºåÁÇπÂáª‚ÄúÂØºÂÖ•Êñ∞‰π¶‚ÄùÊ∑ªÂä†Á¨¨‰∏ÄÊú¨ÂêßÔºÅ';
      listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
      return;
    }

    books.forEach(book => {
      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `
            <span class="group-name" style="cursor:pointer;" data-book-id="${book.id}">${book.title}</span>
            <button class="delete-group-btn" data-book-id="${book.id}" title="Âà†Èô§‰π¶Á±ç">√ó</button>
        `;
      listEl.appendChild(item);
    });
  }


  // ÊâæÂà∞ loadBookFromLibrary ÂáΩÊï∞ÔºåÊõøÊç¢Êï¥‰∏™ÂáΩÊï∞
  async function loadBookFromLibrary(bookId) {
    const chatId = state.activeChatId;
    if (!chatId) return;

    let book = await db.readingLibrary.get(bookId);
    if (!book) {
      alert('Êâæ‰∏çÂà∞ËøôÊú¨‰π¶ÔºÅ');
      return;
    }

    // --- „ÄêÊ†∏ÂøÉÊñ∞Â¢ûÈÄªËæëÔºöÂêåÊ≠•ÁªøÊ±üÂÜÖÂÆπ„Äë ---
    if (book.linkedStoryId) {
      try {
        const grStory = await db.grStories.get(book.linkedStoryId);
        if (grStory) {
          console.log(`[ÂêåÊ≠•] Ê≠£Âú®‰ªéÁªøÊ±üÂêåÊ≠•„Ää${grStory.title}„ÄãÁöÑÊúÄÊñ∞Á´†ËäÇ...`);

          // ÊãºÊé•ÊâÄÊúâÁ´†ËäÇÂÜÖÂÆπ
          // Ê†ºÂºèÔºö
          // Á¨¨1Á´† Ê†áÈ¢ò
          // Ê≠£Êñá...
          let fullContent = "";
          grStory.chapters.forEach((ch, idx) => {
            const title = ch.title || `Á¨¨ ${idx + 1} Á´†`;
            fullContent += `\n\n========== ${title} ==========\n\n`;
            fullContent += ch.content;
          });

          // Êõ¥Êñ∞ÂÜÖÂ≠òÈáåÁöÑ‰∏¥Êó∂ÂØπË±°
          book.title = grStory.title; // ÂêåÊ≠•Ê†áÈ¢ò
          book.content = fullContent; // ÂêåÊ≠•ÂÜÖÂÆπ

          // ÂêåÊó∂Êõ¥Êñ∞Êï∞ÊçÆÂ∫ìÔºå‰øùÊåÅÁºìÂ≠òÊúÄÊñ∞
          await db.readingLibrary.update(bookId, {
            title: grStory.title,
            content: fullContent,
            lastOpened: Date.now()
          });
        } else {
          console.warn("ÂÖ≥ËÅîÁöÑÁªøÊ±ü‰ΩúÂìÅÂ∑≤Ë¢´Âà†Èô§Ôºå‰øùÁïôÊúÄÂêé‰∏ÄÊ¨°ÁºìÂ≠òÁöÑÂÜÖÂÆπ„ÄÇ");
        }
      } catch (e) {
        console.error("ÂêåÊ≠•ÁªøÊ±üÂÜÖÂÆπÂ§±Ë¥•:", e);
      }
    } else {
      // ÊôÆÈÄö‰π¶Á±çÂè™Êõ¥Êñ∞Êó∂Èó¥
      await db.readingLibrary.update(bookId, {
        lastOpened: Date.now()
      });
    }
    // -------------------------------------

    const session = readingState[chatId];
    session.activeBookId = bookId;
    session.title = book.title;
    // Â§ÑÁêÜÂÜÖÂÆπÊç¢Ë°å
    session.contentLines = (book.content || "").split(/\r\n?|\n/).map(line => line.replace(/ +/g, ' '));
    session.totalPages = Math.ceil(session.contentLines.length / session.linesPerPage);

    // Â¶ÇÊûúÊÄªÈ°µÊï∞‰∏∫0ÔºåËá≥Â∞ëËÆæ‰∏∫1
    if (session.totalPages === 0) session.totalPages = 1;

    session.currentPage = book.currentPage || 0;

    // Èò≤Ê≠¢È°µÁ†ÅË∂äÁïåÔºàÊØîÂ¶ÇÂêåÊ≠•ÂêéÂÜÖÂÆπÂèòÁü≠‰∫ÜÔºåËôΩÁÑ∂‰∏ÄËà¨ÊòØÂèòÈïøÔºâ
    if (session.currentPage >= session.totalPages) {
      session.currentPage = session.totalPages - 1;
    }
    if (session.currentPage < 0) session.currentPage = 0;

    renderReadingRoom(chatId);

    document.getElementById('reading-content').scrollTop = 0;
    document.getElementById('reading-library-modal').classList.remove('visible');
  }

  async function addGreenRiverToShelf(storyId, btnElement) {
    try {
      const story = await db.grStories.get(storyId);
      if (!story) return;

      // Èò≤Ê≠¢ÈáçÂ§çÊ∑ªÂä†
      const existing = await db.readingLibrary.where('linkedStoryId').equals(storyId).first();
      if (existing) {
        alert("ËØ•‰π¶Á±çÂ∑≤Âú®‰π¶Êû∂‰∏≠„ÄÇ");
        return;
      }

      let fullContent = "";
      story.chapters.forEach((ch, idx) => {
        const title = ch.title || `Á¨¨ ${idx + 1} Á´†`;
        fullContent += `\n\n========== ${title} ==========\n\n`;
        fullContent += ch.content;
      });

      if (!fullContent) fullContent = "(ÊöÇÊó†ÂÜÖÂÆπÔºåËØ∑‰ΩúËÄÖËµ∂Âø´Êõ¥Êñ∞...)";

      await db.readingLibrary.add({
        title: story.title,
        content: fullContent,
        lastOpened: Date.now(),
        currentPage: 0,
        linkedStoryId: story.id
      });

      // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÊõ¥Êñ∞ÊåâÈíÆUI‰∏∫‚ÄúÂ∑≤Ê∑ªÂä†‚ÄùÁä∂ÊÄÅÔºåÂπ∂ÁªëÂÆöÁßªÈô§‰∫ã‰ª∂
      if (btnElement) {
        btnElement.textContent = "‚úì Â∑≤Âú®‰π¶Êû∂";
        btnElement.classList.add('added');
        // ÈáçÊñ∞ÁªëÂÆö onclick ‰∏∫ÁßªÈô§ÂáΩÊï∞
        btnElement.onclick = (e) => {
          e.stopPropagation();
          removeGreenRiverFromShelf(storyId, btnElement);
        };
      }

      await showCustomAlert("Êî∂ËóèÊàêÂäü", `„Ää${story.title}„ÄãÂ∑≤Âä†ÂÖ•‰π¶Êû∂ÔºåÂπ∂ÂºÄÂêØÂêåÊ≠•Êõ¥Êñ∞„ÄÇ`);

    } catch (e) {
      console.error("Âä†ÂÖ•‰π¶Êû∂Â§±Ë¥•:", e);
      alert("Âä†ÂÖ•Â§±Ë¥•: " + e.message);
    }
  }

  // ËÆ∞ÂæóÊääËøô‰∏™ÂáΩÊï∞Êö¥Èú≤ÁªôÂÖ®Â±ÄÔºåÂê¶Âàô HTML onclick Êâæ‰∏çÂà∞
  window.addGreenRiverToShelf = addGreenRiverToShelf;
  // „ÄêÊñ∞Â¢û„Äë‰ªé‚Äú‰∏ÄËµ∑ËØª‚Äù‰π¶Êû∂‰∏≠ÁßªÈô§ÁªøÊ±ü‰ΩúÂìÅ
  async function removeGreenRiverFromShelf(storyId, btnElement) {
    try {
      // Êü•ÊâæÂØπÂ∫îÁöÑ‰π¶Êû∂ËÆ∞ÂΩï
      const bookRecord = await db.readingLibrary.where('linkedStoryId').equals(storyId).first();

      if (!bookRecord) {
        // Êï∞ÊçÆÂ∫ìÈáåÂèØËÉΩÂ∑≤ÁªèË¢´Âà†‰∫ÜÔºåÁõ¥Êé•Êõ¥Êñ∞UI
        if (btnElement) resetBtnToAddState(storyId, btnElement);
        return;
      }

      const confirmed = await showCustomConfirm(
        "ÁßªÂá∫‰π¶Êû∂",
        `Á°ÆÂÆöË¶ÅÂ∞Ü„Ää${bookRecord.title}„Äã‰ªé‚Äú‰∏ÄËµ∑ËØª‚Äù‰π¶Êû∂‰∏≠ÁßªÈô§ÂêóÔºü\n(ÁªøÊ±üAPP‰∏≠ÁöÑÂéüÁ®ø‰∏ç‰ºöË¢´Âà†Èô§)`,
        { confirmButtonClass: 'btn-danger', confirmText: 'ÁßªÂá∫' }
      );

      if (confirmed) {
        // Âà†Èô§‰π¶Êû∂ËÆ∞ÂΩï
        await db.readingLibrary.delete(bookRecord.id);

        // Êõ¥Êñ∞ UI ‰∏∫‚ÄúÊú™Ê∑ªÂä†‚ÄùÁä∂ÊÄÅ
        if (btnElement) {
          resetBtnToAddState(storyId, btnElement);
        }

        await showCustomAlert("Â∑≤ÁßªÈô§", "‰π¶Á±çÂ∑≤‰ªé‰π¶Êû∂ÁßªÂá∫„ÄÇ");
      }
    } catch (e) {
      console.error("ÁßªÈô§Â§±Ë¥•:", e);
    }
  }

  // ËæÖÂä©ÂáΩÊï∞ÔºöÈáçÁΩÆÊåâÈíÆ‰∏∫‚ÄúÂä†ÂÖ•‚ÄùÁä∂ÊÄÅ
  function resetBtnToAddState(storyId, btn) {
    btn.textContent = "+ Âä†ÂÖ•ÂÖ±ËØª";
    btn.classList.remove('added');
    btn.onclick = (e) => {
      e.stopPropagation();
      addGreenRiverToShelf(storyId, btn);
    };
  }

  // Êö¥Èú≤ÁªôÂÖ®Â±Ä
  window.removeGreenRiverFromShelf = removeGreenRiverFromShelf;
  async function deleteBookFromLibrary(bookId) {
    const book = await db.readingLibrary.get(bookId);
    if (!book) return;

    const confirmed = await showCustomConfirm('Âà†Èô§‰π¶Á±ç', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${book.title}„ÄãÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.readingLibrary.delete(bookId);
      await renderBookLibrary();
    }
  }

  function processImportedText(title, textContent) {
    const chatId = state.activeChatId;
    if (!chatId) return;

    const session = readingState[chatId];
    session.title = title.replace(/\.txt$/i, '');
    session.contentLines = textContent.split(/\r\n?|\n/);
    session.totalPages = Math.ceil(session.contentLines.length / session.linesPerPage);
    session.currentPage = 0;

    renderReadingRoom(chatId);
  }



  function makeDraggable(windowEl, headerEl) {
    let pos1 = 0,
      pos2 = 0,
      pos3 = 0,
      pos4 = 0;
    let isDragging = false;
    let hasMoved = false;
    const phoneScreen = document.getElementById('phone-screen');

    const startDrag = (e) => {

      if (windowEl !== headerEl && e.target.closest('button')) {
        return;
      }

      isDragging = true;
      hasMoved = false;

      const event = e.type === 'touchstart' ? e.touches[0] : e;
      pos3 = event.clientX;
      pos4 = event.clientY;


      windowEl.style.top = `${windowEl.offsetTop}px`;
      windowEl.style.left = `${windowEl.offsetLeft}px`;
      windowEl.style.transform = '';

      document.addEventListener('mouseup', endDrag);
      document.addEventListener('mousemove', elementDrag);
      document.addEventListener('touchend', endDrag);

      document.addEventListener('touchmove', elementDrag, {
        passive: false
      });
    };

    const elementDrag = (e) => {
      if (!isDragging) return;

      const event = e.type === 'touchmove' ? e.touches[0] : e;
      const diffX = event.clientX - pos3;
      const diffY = event.clientY - pos4;


      if (!hasMoved && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) {
        hasMoved = true;
      }


      if (hasMoved && e.cancelable) {
        e.preventDefault();
      }

      pos1 = pos3 - event.clientX;
      pos2 = pos4 - event.clientY;
      pos3 = event.clientX;
      pos4 = event.clientY;

      let newTop = windowEl.offsetTop - pos2;
      let newLeft = windowEl.offsetLeft - pos1;

      const maxTop = phoneScreen.clientHeight - windowEl.offsetHeight - 10;
      const maxLeft = phoneScreen.clientWidth - windowEl.offsetWidth - 10;
      newTop = Math.max(10, Math.min(newTop, maxTop));
      newLeft = Math.max(10, Math.min(newLeft, maxLeft));

      windowEl.style.top = newTop + "px";
      windowEl.style.left = newLeft + "px";
    };

    const endDrag = () => {
      document.removeEventListener('mouseup', endDrag);
      document.removeEventListener('mousemove', elementDrag);
      document.removeEventListener('touchend', endDrag);
      document.removeEventListener('touchmove', elementDrag);

      if (!isDragging) return;
      isDragging = false;


      if (!hasMoved) {

        windowEl.click();
      }
    };

    headerEl.addEventListener('mousedown', startDrag);

    headerEl.addEventListener('touchstart', startDrag, {
      passive: false
    });
  }



  function minimizeReadingRoom() {
    const session = readingState[state.activeChatId];
    if (!session || !session.isActive) return;

    document.getElementById('reading-window').classList.add('minimized');
    document.getElementById('reading-restore-btn').style.display = 'flex';
    session.isMinimized = true;
  }


  function restoreReadingRoom() {
    const session = readingState[state.activeChatId];
    if (!session || !session.isActive) return;

    document.getElementById('reading-restore-btn').style.display = 'none';
    document.getElementById('reading-window').classList.remove('minimized');
    session.isMinimized = false;
  }





  function debounce(func, delay) {
    let timeout;
    return function (...args) {
      const context = this;
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(context, args), delay);
    };
  }



  function formatReadingStateForAI(chatId) {
    const session = readingState[chatId];


    if (!session || !session.isActive) {
      return "";
    }

    const title = session.title || 'Êú™Áü•‰π¶Á±ç';
    let contentForAI = '';
    let contextLabel = '';


    if (session.currentSnippet && session.currentSnippet.trim()) {
      contentForAI = session.currentSnippet;
      contextLabel = '‰Ω†Ê≠£Âú®ÈòÖËØªÁöÑÊÆµËêΩ';
    } else if (session.contentLines.length > 0) {
      const startLine = session.currentPage * session.linesPerPage;
      const endLine = startLine + session.linesPerPage;
      contentForAI = session.contentLines.slice(startLine, endLine).join('\n').substring(0, 200);
      contextLabel = 'ÂΩìÂâçÈ°µÂÜÖÂÆπÊëòË¶Å';
    } else {
      contentForAI = '(Êó†ÂÜÖÂÆπ)';
      contextLabel = 'ÂÜÖÂÆπ';
    }
    return `
    - **‰π¶Âêç**: „Ää${title}„Äã
    - **${contextLabel}**: "${contentForAI}..."
    #‰∏ÄËµ∑ËØª‰π¶Ê®°Âºè | Ë°å‰∏∫ÈìÅÂæã
    1.  **ËßíËâ≤ÂÆö‰Ωç**: ‰Ω†„Äê‰∏çÊòØ„Äë‰π¶‰∏≠ÁöÑ‰ªª‰ΩïËßíËâ≤Ôºå‰Ω†ÊòØ„Äê‰Ω†Ëá™Â∑±„Äë(${state.chats[chatId]?.originalName || 'AIËßíËâ≤'})ÔºåÊ≠£Âú®ÂíåÁî®Êà∑‰∏ÄËµ∑„ÄêÈòÖËØªÂíåËÆ®ËÆ∫„ÄëËøôÊú¨‰π¶„ÄÇ
    2.  **Ë°å‰∏∫ÂáÜÂàô**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰Ωú‰∏∫ËØªËÄÖÁöÑ„ÄêÊÑüÊÉ≥„ÄÅËØÑËÆ∫„ÄÅÊèêÈóÆÊàñËÅîÊÉ≥„Äë„ÄÇ‰Ω†ÂèØ‰ª•Ôºö
        -   ÂàÜ‰∫´‰Ω†ÂØπÂΩìÂâçÊÆµËêΩÁöÑÁúãÊ≥ï„ÄÇ
        -   ÂØπ‰π¶‰∏≠ÁöÑËßíËâ≤ÊàñÊÉÖËäÇÂèëË°®ËØÑËÆ∫„ÄÇ
        -   ÂêëÁî®Êà∑ÊèêÈóÆÔºåËØ¢ÈóÆTAÂØπÂÜÖÂÆπÁöÑÁúãÊ≥ï„ÄÇ
        -   Ê†πÊçÆ‰π¶Êú¨ÂÜÖÂÆπÔºåËÅîÊÉ≥Âà∞‰Ω†Ëá™Â∑±ÁöÑÁªèÂéÜÊàñËÆ∞ÂøÜ„ÄÇ
    3.  **‰∏•Á¶Å**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰π¶‰∏≠ËßíËâ≤ÁöÑÂè£ÂêªÂíå‰∫∫Áß∞ÔºÅ„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÊâÆÊºî‰π¶‰∏≠ÁöÑ‰ªª‰ΩïËßíËâ≤ÔºÅ„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÁª≠ÂÜôÊàñÊ®°‰ªø‰π¶‰∏≠ÁöÑÊÉÖËäÇÔºÅ‰Ω†ÂøÖÈ°ªÊó∂ÂàªËÆ∞‰ΩèÔºå‰Ω†Âè™ÊòØ‰∏Ä‰∏™ËØªËÄÖ„ÄÇ    
`;
  }



  function updateReadingContextOnScroll() {
    const chatId = state.activeChatId;
    if (!chatId || !readingState[chatId]) return;

    const session = readingState[chatId];
    const container = document.getElementById('reading-content');

    if (!container) return;


    const chat = state.chats[chatId];

    const fontSize = (chat && chat.settings && chat.settings.fontSize) ? chat.settings.fontSize : 13;

    const approximateLineHeight = fontSize * 1.6;

    const scrollTop = container.scrollTop;
    const clientHeight = container.clientHeight;
    const scrollBottom = scrollTop + clientHeight;


    const firstVisibleLine = Math.floor(scrollTop / approximateLineHeight);
    const lastVisibleLine = Math.ceil(scrollBottom / approximateLineHeight);


    const absoluteStartIndex = (session.currentPage * session.linesPerPage) + firstVisibleLine;
    const absoluteEndIndex = (session.currentPage * session.linesPerPage) + lastVisibleLine;

    if (absoluteStartIndex < 0 || absoluteStartIndex >= session.contentLines.length) {
      return;
    }


    const newSnippet = session.contentLines.slice(
      Math.max(0, absoluteStartIndex),
      Math.min(session.contentLines.length, absoluteEndIndex)
    ).join('\n');

    session.currentSnippet = newSnippet;

    // Ë∞ÉËØïÊó•ÂøóÔºàÂèØÈÄâÔºåÂ¶ÇÊûú‰Ω†ÊÉ≥Âú®ÊéßÂà∂Âè∞ÁúãÊïàÊûúÔºâ
    // console.log(`[ÈòÖËØªËßÜÂè£Êõ¥Êñ∞] Â≠ó‰Ωì:${fontSize}px, Ë°åÈ´ò:${approximateLineHeight}, ÂèØËßÅË°å:${firstVisibleLine}-${lastVisibleLine}`);
  }




  function playSilentAudio() {
    const silentPlayer = document.getElementById('silent-audio-player');
    if (silentPlayer) {

      const playPromise = silentPlayer.play();
      if (playPromise !== undefined) {
        playPromise.then(_ => {
          console.log("ÈùôÈü≥Èü≥È¢ëÂ∑≤ÂêØÂä®ÔºåÁî®‰∫éÂêéÂè∞Ê¥ªÂä®‰øùÊ¥ª„ÄÇ");
        }).catch(error => {


          console.warn("Êó†Ê≥ïËá™Âä®Êí≠ÊîæÈùôÈü≥Èü≥È¢ëÔºàËøôÂú®iOSÈ¶ñÊ¨°Âä†ËΩΩÊó∂ÊòØÊ≠£Â∏∏Áé∞Ë±°Ôºâ:", error);
        });
      }
    }
  }


  function stopSilentAudio() {
    const silentPlayer = document.getElementById('silent-audio-player');
    if (silentPlayer && !silentPlayer.paused) {
      silentPlayer.pause();
      silentPlayer.currentTime = 0;
      console.log("ÈùôÈü≥Èü≥È¢ëÂ∑≤ÂÅúÊ≠¢„ÄÇ");
    }
  }


  function hexToUint8Array(hexString) {
    if (!hexString) return new Uint8Array();
    const arrayBuffer = new Uint8Array(hexString.length / 2);
    for (let i = 0; i < hexString.length; i += 2) {
      arrayBuffer[i / 2] = parseInt(hexString.substr(i, 2), 16);
    }
    return arrayBuffer;
  }
  // --- TTS Êí≠ÊîæÈòüÂàóÔºà‰øÆÂ§çÔºöÂâç‰∏ÄÊù°Ê≤°ËØªÂÆåÂ∞±Ë∑≥Âà∞ÊúÄÂêé‰∏ÄÊù°ÁöÑÈóÆÈ¢òÔºâ ---
  const ttsQueue = [];
  let isTtsPlaying = false;

  function stopTtsQueue() {
    ttsQueue.length = 0;
    isTtsPlaying = false;
    const ttsPlayer = document.getElementById('tts-audio-player');
    if (ttsPlayer) {
      ttsPlayer.onended = null;
      ttsPlayer.onerror = null;
      ttsPlayer.pause();
      ttsPlayer.src = '';
    }
  }

  async function processNextTts() {
    if (ttsQueue.length === 0) {
      isTtsPlaying = false;
      return;
    }

    isTtsPlaying = true;
    const { text, voiceId } = ttsQueue.shift();

    try {
      const { minimaxGroupId, minimaxApiKey } = state.apiConfig;
      if (!minimaxGroupId || !minimaxApiKey || !voiceId) {
        processNextTts();
        return;
      }

      console.log(`[TTSÈòüÂàó] Ê≠£Âú®ÊúóËØª (Ââ©‰Ωô${ttsQueue.length}Êù°): ${text}`);

      const savedDomain = state.apiConfig.minimaxDomain || localStorage.getItem('minimax-domain') || 'https://api.minimax.chat';
      const modelId = state.apiConfig.minimaxModel || "speech-01-hd";

      const response = await fetch(`${savedDomain}/v1/t2a_v2?GroupId=${minimaxGroupId}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${minimaxApiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: modelId,
          text: text,
          stream: false,
          voice_setting: {
            voice_id: voiceId,
            speed: 1.0,
            vol: 1.0,
            pitch: 0
          },
          audio_setting: {
            sample_rate: 32000,
            bitrate: 128000,
            format: "mp3",
            channel: 1
          }
        })
      });

      if (!response.ok) throw new Error("APIËØ∑Ê±ÇÂ§±Ë¥•");

      const data = await response.json();
      if (data.base_resp && data.base_resp.status_code !== 0) throw new Error(data.base_resp.status_msg);

      const audioHex = data.data?.audio;
      if (!audioHex) {
        processNextTts();
        return;
      }

      const audioBytes = hexToUint8Array(audioHex);
      const audioBlob = new Blob([audioBytes], { type: 'audio/mpeg' });
      const audioUrl = URL.createObjectURL(audioBlob);

      const ttsPlayer = document.getElementById('tts-audio-player');
      ttsPlayer.src = audioUrl;
      ttsPlayer.dataset.currentText = text;

      // Êí≠ÂÆåËøôÊù°ÂÜçÊí≠‰∏ã‰∏ÄÊù°
      ttsPlayer.onended = () => {
        URL.revokeObjectURL(audioUrl);
        processNextTts();
      };
      ttsPlayer.onerror = () => {
        URL.revokeObjectURL(audioUrl);
        processNextTts();
      };

      await ttsPlayer.play();

    } catch (error) {
      console.error("TTSÁîüÊàêÂ§±Ë¥•:", error);
      processNextTts(); // Â§±Ë¥•‰πüÁªßÁª≠‰∏ã‰∏ÄÊù°
    }
  }

  // --- ËßÜÈ¢ë/ËØ≠Èü≥ÈÄöËØù‰∏ìÁî® TTS Êí≠ÊîæÂáΩÊï∞ÔºàÈòüÂàóÁâàÔºâ ---
  function playVideoCallPureTTS(text, voiceId) {
    // 1. Ê≠£ÂàôÂéªÈô§Êã¨Âè∑ÂèäÊã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπ
    let cleanText = text.replace(/(\[.*?\]|\(.*?\)|Ôºà.*?Ôºâ|„Äê.*?„Äë)/g, '').trim();
    if (!cleanText) return;

    // 1.5. Â§ÑÁêÜ"‰ªÖËØªÂèñÂØπËØù"ÂäüËÉΩ
    if (state.activeChatId && state.chats[state.activeChatId]) {
      const chat = state.chats[state.activeChatId];
      if (chat.videoOptimization && chat.videoOptimization.ttsDialogueOnly) {
        cleanText = extractDialogueOnly(cleanText);
        console.log('[ËßÜÈ¢ëÈÄöËØùTTS] ‰ªÖËØªÂèñÂØπËØùÊ®°ÂºèÔºö', cleanText);
      }
    }

    if (!cleanText) return;

    // 2. Ê£ÄÊü•ÈÖçÁΩÆ
    const { minimaxGroupId, minimaxApiKey } = state.apiConfig;
    if (!minimaxGroupId || !minimaxApiKey || !voiceId) return;

    // 3. Êé®ÂÖ•ÈòüÂàóÔºå‰∏≤Ë°åÂ§ÑÁêÜ
    ttsQueue.push({ text: cleanText, voiceId });

    if (!isTtsPlaying) {
      processNextTts();
    }
  }
  // Êí≠ÊîæÁúüÂÆûÂΩïÈü≥
  async function playRealAudio(bodyElement) {
    const audioData = bodyElement.dataset.audio;
    const audioMime = bodyElement.dataset.audioMime || 'audio/webm';

    if (!audioData) {
      console.error('Ê≤°ÊúâÊâæÂà∞Èü≥È¢ëÊï∞ÊçÆ');
      return;
    }

    try {
      const audioDataDecoded = decodeURIComponent(audioData);

      // ÂàõÂª∫Èü≥È¢ëÊí≠ÊîæÂô®
      let realAudioPlayer = document.getElementById('real-audio-player');
      if (!realAudioPlayer) {
        realAudioPlayer = document.createElement('audio');
        realAudioPlayer.id = 'real-audio-player';
        realAudioPlayer.style.display = 'none';
        document.body.appendChild(realAudioPlayer);
      }

      // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÂêå‰∏ÄÊù°ËØ≠Èü≥ÔºåÊöÇÂÅú
      if (!realAudioPlayer.paused && realAudioPlayer.dataset.currentAudio === audioData) {
        realAudioPlayer.pause();
        return;
      }

      // ÂÅúÊ≠¢‰πãÂâçÁöÑÊí≠Êîæ
      realAudioPlayer.pause();

      // ËÆæÁΩÆÊñ∞ÁöÑÈü≥È¢ëÊ∫ê
      realAudioPlayer.src = audioDataDecoded;
      realAudioPlayer.dataset.currentAudio = audioData;

      // Êí≠ÊîæÈü≥È¢ë
      await realAudioPlayer.play();
      console.log('Êí≠ÊîæÁúüÂÆûÂΩïÈü≥');

    } catch (error) {
      console.error('Êí≠ÊîæÂΩïÈü≥Â§±Ë¥•:', error);
      alert('Êí≠ÊîæÂΩïÈü≥Â§±Ë¥•');
    }
  }

  async function playTtsAudio(bodyElement) {
    let text = decodeURIComponent(bodyElement.dataset.text);

    // 1. Ëé∑Âèñ Voice ID
    let voiceId = bodyElement.dataset.voiceId;
    // Êñ∞Â¢ûÔºöÂàùÂßãÂåñËØ≠Ë®ÄËÆæÁΩÆÔºåÈªòËÆ§‰∏∫ÊôÆÈÄöËØù
    let ttsLanguage = 'zh-CN';

    if (state.activeChatId && state.chats[state.activeChatId]) {
      const chat = state.chats[state.activeChatId];
      if (!chat.isGroup && chat.settings.enableTts !== false) {
        // ‰ºòÂÖà‰ΩøÁî®Ê†áÁ≠æ‰∏äÁöÑIDÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÁî®ËÆæÁΩÆÈáåÁöÑ
        if (!voiceId) voiceId = chat.settings.minimaxVoiceId;
        // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëËé∑ÂèñÁî®Êà∑Âú®ËÆæÁΩÆ‰∏≠ÈÄâÊã©ÁöÑËØ≠Ë®Ä/ÊñπË®Ä
        if (chat.settings.ttsLanguage) ttsLanguage = chat.settings.ttsLanguage;
      }

      // Â§ÑÁêÜ"‰ªÖËØªÂèñÂØπËØù"ÂäüËÉΩ
      if (chat.videoOptimization && chat.videoOptimization.ttsDialogueOnly) {
        // extractDialogueOnly ‰ºöËøîÂõûÂºïÂè∑ÂÜÖÂÆπÊàñÂéüÊñáÔºå‰∏ç‰ºöËøîÂõûÁ©∫
        text = extractDialogueOnly(text);
        console.log('TTS‰ªÖËØªÂèñÂØπËØùÊ®°ÂºèÔºö', text);
      }
    }

    if (!voiceId) {
      alert("ÈîôËØØÔºöÊó†Ê≥ïËé∑Âèñ Voice ID„ÄÇËØ∑Ê£ÄÊü•ËßíËâ≤ËÆæÁΩÆ„ÄÇ");
      return;
    }

    const button = bodyElement.querySelector('.voice-play-btn');
    const spinner = bodyElement.querySelector('.loading-spinner');
    const ttsPlayer = document.getElementById('tts-audio-player');

    // Êí≠Êîæ/ÊöÇÂÅúÈÄªËæë
    if (!ttsPlayer.paused && ttsPlayer.dataset.currentText === text && ttsPlayer.dataset.currentVoiceId === voiceId) {
      ttsPlayer.pause();
      return;
    }
    ttsPlayer.pause();
    document.querySelectorAll('.voice-play-btn').forEach(btn => btn.textContent = '‚ñ∂');

    // 2. Ê£ÄÊü•ÁºìÂ≠ò (KeyÂä†ÂÖ•ËØ≠Ë®ÄÂå∫ÂàÜÔºåÈò≤Ê≠¢ÂàáÊç¢ÊñπË®ÄÂêéËØªÂà∞ÊóßÁºìÂ≠ò)
    const cacheKey = `tts_v2_${voiceId}_${ttsLanguage}_${text}`;
    let cachedAudio = state.ttsCache.get(cacheKey);
    if (cachedAudio) {
      console.log("‰ªéÁºìÂ≠òÊí≠Êîæ TTS...");
      await playAudioFromData(cachedAudio.url, cachedAudio.type, text, voiceId, bodyElement);
      return;
    }

    console.log(`ËØ∑Ê±Ç Minimax T2A v2... VoiceID: ${voiceId}, Language: ${ttsLanguage}`);
    if (button) button.style.display = 'none';
    spinner.style.display = 'block';

    const {
      minimaxGroupId,
      minimaxApiKey
    } = state.apiConfig;

    const languageMap = {
      'zh-CN': 'Chinese',
      'zh-HK': 'Chinese,Yue',   // Á≤§ËØ≠ÁâπÊÆäÂ§ÑÁêÜ
      'en-US': 'English',
      'ja-JP': 'Japanese',
      'ko-KR': 'Korean',
      'de-DE': 'German',
      'fr-FR': 'French',
      'es-ES': 'Spanish',
      'it-IT': 'Italian',
      'ru-RU': 'Russian',
      'pt-BR': 'Portuguese',
      'nl-NL': 'Dutch',
      'pl-PL': 'Polish',
      'sv-SE': 'Swedish',
      'tr-TR': 'Turkish',
      'id-ID': 'Indonesian',
      'ms-MY': 'Malay',
      'vi-VN': 'Vietnamese',
      'th-TH': 'Thai',
      'hi-IN': 'Hindi',
      'ar-SA': 'Arabic'
    };

    // Ëé∑ÂèñÂØπÂ∫îÁöÑ boost ÂÄºÔºåÂ¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÂà∞Â∞±ÈªòËÆ§ 'auto'
    const boostValue = languageMap[ttsLanguage] || 'auto';

    // 2. ÂèëÈÄÅËØ∑Ê±Ç (Ê≥®ÊÑè language_boost ÁöÑ‰ΩçÁΩÆ)
    try {
      const savedDomain = state.apiConfig.minimaxDomain || localStorage.getItem('minimax-domain') || 'https://api.minimax.chat';
      const minimaxBaseUrl = savedDomain;
      const modelId = state.apiConfig.minimaxModel || "speech-01-hd";

      const response = await fetch(`${minimaxBaseUrl}/v1/t2a_v2?GroupId=${minimaxGroupId}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${minimaxApiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: modelId,
          text: text,
          stream: false,


          language_boost: boostValue,

          voice_setting: {
            voice_id: voiceId,
            speed: 1.0,
            vol: 1.0,
            pitch: 0
          },
          audio_setting: {
            sample_rate: 32000,
            bitrate: 128000,
            format: "mp3",
            channel: 1
          }
        })
      });

      if (!response.ok) {
        let errorMsg = `API Â§±Ë¥•: ${response.status}`;
        try {
          const errJson = await response.json();
          errorMsg += ` - ${errJson.base_resp?.status_msg || JSON.stringify(errJson)}`;
        } catch (e) { }
        throw new Error(errorMsg);
      }

      const data = await response.json();

      // 4. Ê£ÄÊü•‰∏öÂä°Áä∂ÊÄÅÁ†Å
      if (data.base_resp && data.base_resp.status_code !== 0) {
        throw new Error(`API ÈîôËØØ: ${data.base_resp.status_msg}`);
      }

      // 5. Ëß£Êûê Hex Èü≥È¢ëÊï∞ÊçÆ
      const audioHex = data.data?.audio;
      if (!audioHex) throw new Error("API Êú™ËøîÂõûÈü≥È¢ëÊï∞ÊçÆ");

      const audioBytes = hexToUint8Array(audioHex);
      const audioBlob = new Blob([audioBytes], {
        type: 'audio/mpeg'
      });
      const audioUrl = URL.createObjectURL(audioBlob);

      await playAudioFromData(audioUrl, 'audio/mpeg', text, voiceId, bodyElement);

      // ÂÜôÂÖ•ÁºìÂ≠ò
      const reader = new FileReader();
      reader.onloadend = function () {
        state.ttsCache.set(cacheKey, {
          url: reader.result,
          type: 'audio/mpeg'
        });
      }
      reader.readAsDataURL(audioBlob);

    } catch (error) {
      console.error("TTS ÁîüÊàêÂ§±Ë¥•:", error);
      await showCustomAlert("ËØ≠Èü≥ÁîüÊàêÂ§±Ë¥•", `ÈîôËØØ: ${error.message}`);
    } finally {
      spinner.style.display = 'none';
      if (button) button.style.display = 'flex';
    }
  }


  function playAudioFromData(audioSrc, audioType, text, voiceId, bodyElement) {
    return new Promise((resolve, reject) => {
      const ttsPlayer = document.getElementById('tts-audio-player');

      ttsPlayer.src = audioSrc;
      ttsPlayer.type = audioType;
      ttsPlayer.dataset.currentText = text;
      ttsPlayer.dataset.currentVoiceId = voiceId;

      const playPromise = ttsPlayer.play();

      if (playPromise !== undefined) {
        playPromise.then(() => {
          const button = bodyElement.querySelector('.voice-play-btn');
          if (button) button.textContent = '‚ùö‚ùö';


          resolve();
        }).catch(error => {
          console.error("Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:", error);
          reject(error);
        });
      }

      ttsPlayer.onended = () => {
        const button = bodyElement.querySelector('.voice-play-btn');
        if (button) button.textContent = '‚ñ∂';
      };
      ttsPlayer.onpause = () => {
        const button = bodyElement.querySelector('.voice-play-btn');
        if (button) button.textContent = '‚ñ∂';
      };
    });
  }




  function toggleVoiceTranscript(bodyElement) {
    const bubble = bodyElement.closest('.message-bubble');
    if (!bubble) return;

    const transcriptEl = bubble.querySelector('.voice-transcript');
    const text = decodeURIComponent(bodyElement.dataset.text);

    if (transcriptEl.style.display === 'block') {

      transcriptEl.style.display = 'none';
    } else {

      transcriptEl.textContent = text;
      transcriptEl.style.display = 'block';
    }
  }



  async function openProductCategoryManager() {
    await renderProductCategoriesInManager();
    document.getElementById('product-category-manager-modal').classList.add('visible');
  }


  async function renderProductCategoriesInManager() {
    const listEl = document.getElementById('existing-product-categories-list');
    const categories = await db.shoppingCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ª</p>';
      return;
    }
    categories.forEach(cat => {
      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">√ó</span>
        `;
      listEl.appendChild(item);
    });
  }


  async function addNewProductCategory() {
    const input = document.getElementById('new-product-category-name-input');
    const name = input.value.trim();
    if (!name) return alert('ÂàÜÁ±ªÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
    const existing = await db.shoppingCategories.where('name').equals(name).first();
    if (existing) return alert(`ÂàÜÁ±ª "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);

    await db.shoppingCategories.add({
      name
    });
    input.value = '';
    await renderProductCategoriesInManager();
  }


  async function deleteProductCategory(categoryId) {
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Âà†Èô§ÂàÜÁ±ªÂêéÔºåËØ•ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâÂïÜÂìÅÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁ±ª‚Äù„ÄÇÁ°ÆÂÆöÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.shoppingCategories.delete(categoryId);
      await db.shoppingProducts.where('categoryId').equals(categoryId).modify({
        categoryId: null
      });
      await renderProductCategoriesInManager();
    }
  }


  function addProductVariationInput(variation = {}) {
    const container = document.getElementById('product-variations-container');
    const block = document.createElement('div');
    block.className = 'message-editor-block variation-block'; // Â§çÁî®Ê†∑Âºè
    block.innerHTML = `
        <button class="delete-block-btn" title="Âà†Èô§Ê≠§Ê¨æÂºè">√ó</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="form-group">
                <label style="font-size: 0.8em;">Ê¨æÂºèÂêçÁß∞</label>
                <input type="text" class="variation-name-input" placeholder="‰æãÂ¶Ç: Á∫¢Ëâ≤" value="${variation.name || ''}">
            </div>
            <div class="form-group">
                <label style="font-size: 0.8em;">‰ª∑Ê†º (ÂÖÉ)</label>
                <input type="number" class="variation-price-input" min="0" step="0.01" value="${variation.price || ''}">
            </div>
        </div>
        <div class="form-group">
            <label style="font-size: 0.8em;">Ê¨æÂºèÂõæÁâá (ÂèØÈÄâ)</label>
            <div class="avatar-upload">
                <img class="variation-image-preview" src="${variation.imageUrl || 'https://i.postimg.cc/PqYp5T5M/image.png'}">
                <button type="button" class="form-button-secondary upload-variation-image-btn" style="margin: 0; padding: 8px 12px;">‰∏ä‰º†</button>
                <input type="file" class="variation-image-input" accept="image/*" hidden>
            </div>
        </div>
    `;

    block.querySelector('.delete-block-btn').addEventListener('click', () => block.remove());
    block.querySelector('.upload-variation-image-btn').addEventListener('click', () => {
      block.querySelector('.variation-image-input').click();
    });
    block.querySelector('.variation-image-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (re) => {
          block.querySelector('.variation-image-preview').src = re.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    container.appendChild(block);
    return block;
  }

  async function openVariationSelector(productId) {
    const product = await db.shoppingProducts.get(productId);
    if (!product || !product.variations || product.variations.length === 0) return;

    const modal = document.getElementById('variation-selection-modal');
    document.getElementById('variation-product-image').src = product.imageUrl;
    document.getElementById('variation-product-name').textContent = product.name;

    const optionsContainer = document.getElementById('variation-options-container');
    optionsContainer.innerHTML = '';

    product.variations.forEach((variation, index) => {
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'variation-select';
      radio.id = `var-${productId}-${index}`;
      radio.value = index;
      radio.style.display = 'none';
      if (index === 0) radio.checked = true;

      const label = document.createElement('label');
      label.htmlFor = `var-${productId}-${index}`;
      label.textContent = variation.name;
      label.style.cssText = `
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
        `;

      optionsContainer.appendChild(radio);
      optionsContainer.appendChild(label);
    });

    const updateSelectionUI = () => {
      const selectedRadio = optionsContainer.querySelector('input[name="variation-select"]:checked');
      optionsContainer.querySelectorAll('label').forEach(lbl => {
        lbl.style.borderColor = '#ccc';
        lbl.style.color = '#333';
        lbl.style.backgroundColor = 'white';
      });
      if (selectedRadio) {
        const selectedLabel = optionsContainer.querySelector(`label[for="${selectedRadio.id}"]`);
        selectedLabel.style.borderColor = 'var(--accent-color)';
        selectedLabel.style.color = 'var(--accent-color)';
        selectedLabel.style.backgroundColor = '#e7f3ff';

        const selectedVariation = product.variations[parseInt(selectedRadio.value)];
        document.getElementById('variation-selected-price').textContent = `¬•${selectedVariation.price.toFixed(2)}`;
        if (selectedVariation.imageUrl) {
          document.getElementById('variation-product-image').src = selectedVariation.imageUrl;
        } else {
          document.getElementById('variation-product-image').src = product.imageUrl;
        }
      }
    };

    optionsContainer.addEventListener('change', updateSelectionUI);
    updateSelectionUI();

    document.getElementById('variation-quantity-display').textContent = '1';

    const confirmBtn = document.getElementById('confirm-variation-selection-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', async () => {
      const selectedRadio = optionsContainer.querySelector('input[name="variation-select"]:checked');
      const quantity = parseInt(document.getElementById('variation-quantity-display').textContent);
      if (selectedRadio) {
        const selectedVariation = product.variations[parseInt(selectedRadio.value)];
        await addToCart(productId, quantity, selectedVariation);
        modal.classList.remove('visible');
        await showCustomAlert('ÊàêÂäü', 'Â∑≤ÊàêÂäüÂä†ÂÖ•Ë¥≠Áâ©ËΩ¶ÔºÅ');
      }
    });

    modal.classList.add('visible');
  }


  function openShoppingSettingsModal() {
    const modal = document.getElementById('shopping-settings-modal');

    // ‰ªéÂÖ®Â±ÄËÆæÁΩÆ‰∏≠ËØªÂèñÂ∑≤‰øùÂ≠òÁöÑÂÄºÔºåÂ¶ÇÊûúÊ≤°ÊúâÂ∞±‰ΩøÁî®ÈªòËÆ§ÂÄº
    document.getElementById('shopping-category-count-input').value = state.globalSettings.shoppingCategoryCount || 3;
    document.getElementById('shopping-product-count-input').value = state.globalSettings.shoppingProductCount || 8;

    modal.classList.add('visible');
  }


  async function saveShoppingSettings() {
    const categoryInput = document.getElementById('shopping-category-count-input');
    const productInput = document.getElementById('shopping-product-count-input');

    const categoryCount = parseInt(categoryInput.value);
    const productCount = parseInt(productInput.value);


    if (isNaN(categoryCount) || isNaN(productCount) || categoryCount < 1 || productCount < 1) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊ≠£Êï¥Êï∞ÔºÅ");
      return;
    }


    state.globalSettings.shoppingCategoryCount = categoryCount;
    state.globalSettings.shoppingProductCount = productCount;
    await db.globalSettings.put(state.globalSettings);


    document.getElementById('shopping-settings-modal').classList.remove('visible');
    await showCustomAlert('‰øùÂ≠òÊàêÂäü', 'Ë¥≠Áâ©‰∏≠ÂøÉÁîüÊàêËÆæÁΩÆÂ∑≤Êõ¥Êñ∞ÔºÅ');
  }


  async function handleGenerateShoppingItems() {

    if (!state.activeChatId) {
      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", "ËØ∑ÂÖàËøõÂÖ•‰∏Ä‰∏™ËÅäÂ§©È°µÈù¢ÔºåÂÜçËøîÂõûË¥≠Áâ©‰∏≠ÂøÉËøõË°åÁîüÊàêÔºå‰ª•‰æøAI‰∫ÜËß£Ë¶Å‰∏∫Âì™‰∏™ËßíËâ≤ÁîüÊàêÂïÜÂìÅ„ÄÇ");
      return;
    }
    const chat = state.chats[state.activeChatId];

    const confirmed = await showCustomConfirm(
      `‰∏∫‚Äú${chat.name}‚ÄùÁîüÊàêÂïÜÂìÅÔºü`,
      'Ê≠§Êìç‰ΩúÂ∞Ü‰ΩøÁî®AIÁîüÊàêÊñ∞ÁöÑÂïÜÂìÅÂíåÂàÜÁ±ªÔºåÂπ∂„ÄêÊ∑ªÂä†„ÄëÂà∞Áé∞ÊúâÂàóË°®‰∏≠„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü', {
      confirmText: 'Á°ÆËÆ§ÁîüÊàê'
    }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê†πÊçÆ‚Äú${chat.name}‚ÄùÁöÑÁâπÁÇπÁîüÊàê‰∏ìÂ±ûÂïÜÂìÅ...`);


    const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
    const {
      proxyUrl,
      apiKey,
      model
    } = useSecondaryApi
        ?
        {
          proxyUrl: state.apiConfig.secondaryProxyUrl,
          apiKey: state.apiConfig.secondaryApiKey,
          model: state.apiConfig.secondaryModel
        } :
        state.apiConfig;

    if (!proxyUrl || !apiKey || !model) {
      await showCustomAlert("APIÊú™ÈÖçÁΩÆ", "ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩÔºà‰∏ªÊàñÂâØÔºâAPI„ÄÇ");
      return;
    }

    const categoryCount = state.globalSettings.shoppingCategoryCount || 3;
    const productCount = state.globalSettings.shoppingProductCount || 8;

    const existingCategories = await db.shoppingCategories.toArray();
    let existingCategoriesContext = "";
    if (existingCategories.length > 0) {
      existingCategoriesContext = `
# „ÄêÂàÜÁ±ªÂ§çÁî®ÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºÅ)„Äë
Âú®‰∏∫Êñ∞ÂïÜÂìÅÊåáÂÆöÂàÜÁ±ªÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÈ¶ñÂÖàÊ£ÄÊü•‰∏ãÈù¢ÁöÑ‚ÄúÂ∑≤ÊúâÂàÜÁ±ªÂàóË°®‚Äù„ÄÇ
-   Â¶ÇÊûú‰∏Ä‰∏™Êñ∞ÂïÜÂìÅÂèØ‰ª•Ë¢´ÂΩíÂÖ•Êüê‰∏™„ÄêÂ∑≤Â≠òÂú®ÁöÑÂàÜÁ±ª„ÄëÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂ§çÁî®ÈÇ£‰∏™ÂàÜÁ±ªÁöÑÂêçÁß∞ÔºåËÄå‰∏çÊòØÂàõÈÄ†‰∏Ä‰∏™Áõ∏‰ººÁöÑÊñ∞ÂàÜÁ±ªÔºÅ
-   Âè™ÊúâÂΩì‰Ω†Á°ÆÂÆöÂïÜÂìÅ„ÄêÁªùÂØπ„Äë‰∏çÂ±û‰∫é‰ªª‰Ωï‰∏Ä‰∏™Â∑≤ÊúâÂàÜÁ±ªÊó∂Ôºå‰Ω†ÊâçËÉΩÂàõÈÄ†‰∏Ä‰∏™Êñ∞ÁöÑÂàÜÁ±ªÂêçÁß∞„ÄÇ
-   **Â∑≤ÊúâÂàÜÁ±ªÂàóË°®**: [${existingCategories.map(c => `"${c.name}"`).join(', ')}]
`;
    }

    const userNickname = state.qzoneSettings.nickname || 'Êàë';
    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const recentHistoryContext = chat.history.slice(-10).map(msg =>
      `${msg.role === 'user' ? userNickname : chat.name}: ${String(msg.content).substring(0, 30)}...`
    ).join('\n');

    let worldBookContext = '';
    // Ëé∑ÂèñÊâÄÊúâÂ∫îËØ•‰ΩøÁî®ÁöÑ‰∏ñÁïå‰π¶IDÔºàÂåÖÊã¨ÊâãÂä®ÈÄâÊã©ÁöÑÂíåÂÖ®Â±ÄÁöÑÔºâ
    let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
    // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
    state.worldBooks.forEach(wb => {
      if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
        allWorldBookIds.push(wb.id);
      }
    });

    if (allWorldBookIds.length > 0) {
      const linkedContents = allWorldBookIds.map(bookId => {
        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
        if (!worldBook || !Array.isArray(worldBook.content)) return '';
        const enabledEntries = worldBook.content
          .filter(entry => entry.enabled !== false)
          .map(entry => `- ${entry.content}`)
          .join('\n');
        return enabledEntries ? `\n## Êù•Ëá™„Ää${worldBook.name}„Äã:\n${enabledEntries}` : '';
      }).filter(Boolean).join('');

      if (linkedContents) {
        worldBookContext = `\n# ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ªÂèÇËÄÉ)\n${linkedContents}\n`;
      }
    }

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁöÑ„ÄÅÊûÅÂÖ∑ÂàõÈÄ†ÂäõÁöÑÂïÜÂìÅËßÑÂàíÂ∏à„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØ‰∏∫‰∏ãÈù¢ÁöÑËßíËâ≤‚Äú${chat.name}‚ÄùÈáèË∫´ÊâìÈÄ†‰∏Ä‰∏™‰∏ìÂ±ûÁöÑÂïÜÂìÅÂàóË°®„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêËßíËâ≤ÂÆöÂà∂(ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: ‰Ω†ÁîüÊàêÁöÑÊâÄÊúâÂïÜÂìÅÂíåÂàÜÁ±ª„ÄêÂøÖÈ°ª„ÄëÊ∑±Â∫¶ÁªëÂÆöËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑÂØπËØù„ÄÇÂÆÉ‰ª¨Â∫îËØ•ÊòØËßíËâ≤‰ºöÁúüÊ≠£ÊÑüÂÖ¥Ë∂£„ÄÅË¥≠‰π∞ÊàñÂà∂‰ΩúÁöÑ‰∏úË•ø„ÄÇ
2.  **ÂàõÈÄ†ÊÄß‰∏éÂêàÁêÜÊÄß**: ÂïÜÂìÅÂíåÂàÜÁ±ªÂøÖÈ°ªÂêàÁêÜ‰∏îÂ§öÊ†∑Âåñ„ÄÇ
3.  **Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™„ÄêÂçï‰∏ÄÁöÑJSONÂØπË±°„Äë„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`{\` ÂºÄÂßãÔºåÂπ∂‰ª• \`}\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÂØπË±°ÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£ÈáäÊàñ markdown Ê†áËÆ∞„ÄÇ
    - Ê†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    {
      "categories": [
        {
          "name": "ÂàÜÁ±ªÂêçÁß∞1",
          "products": [
            {
              "name": "ÂïÜÂìÅÂêçÁß∞1",
              "price": 99.80,
              "description": "ËøôÊòØÂïÜÂìÅÁöÑËØ¶ÁªÜÊèèËø∞Ôºå‰∏çÂ∞ë‰∫é50Â≠ó...",
              "variations": [
                { "name": "Ê¨æÂºè1", "price": 108.80, "image_prompt": "Ê¨æÂºè1ÁöÑÂõæÁâá„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç..." },
                { "name": "Ê¨æÂºè2", "price": 118.80, "image_prompt": "Ê¨æÂºè2ÁöÑÂõæÁâá„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç..." }
              ],
              "image_prompt": "ÂïÜÂìÅ‰∏ªÂõæÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, È£éÊ†º‰∏∫ realistic product photo, high quality, on a clean white background"
            }
          ]
        }
      ]
    }
    \`\`\`
    - **categories**: ÁîüÊàê ${categoryCount} ‰∏™ÂàÜÁ±ª„ÄÇ
    - **products**: ÊØè‰∏™ÂàÜÁ±ª‰∏ãÁîüÊàê ${productCount} ‰∏™ÂïÜÂìÅ„ÄÇ
    - **variations**: ÊØè‰∏™ÂïÜÂìÅ„ÄêÂøÖÈ°ª„ÄëÂåÖÂê´„Äê2Âà∞4‰∏™„Äë‰∏çÂêåÁöÑÊ¨æÂºè„ÄÇ

# ËßíËâ≤‰∏é‰∏ä‰∏ãÊñá (‰Ω†ÁöÑÁÅµÊÑüÊù•Ê∫ê)
- **ËßíËâ≤ÂêçÁß∞**: ${chat.name}
- **ËßíËâ≤‰∫∫ËÆæ**: ${chat.settings.aiPersona}
- **ÈïøÊúüËÆ∞ÂøÜ**: ${longTermMemoryContext}
- **‰∏ñÁïå‰π¶ËÆæÂÆö**: ${worldBookContext}
${existingCategoriesContext}
- **ÊúÄËøëÂØπËØùÊëòË¶Å**:
${recentHistoryContext}

Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏ä„ÄêÊâÄÊúâ‰∏ä‰∏ãÊñá‰ø°ÊÅØ„ÄëÔºåÂºÄÂßã‰∏∫‚Äú${chat.name}‚ÄùÁîüÊàêËøôÁªÑ„Äê‰∏éËßíËâ≤È´òÂ∫¶Áõ∏ÂÖ≥„ÄëÁöÑÂïÜÂìÅÊï∞ÊçÆ„ÄÇ`;

    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äËÆæÂÆöÔºåÁîüÊàêÂïÜÂìÅÊï∞ÊçÆ„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');

      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],

            temperature: state.globalSettings.apiTemperature || 0.9
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      const jsonMatch = aiResponseContent.match(/({[\s\S]*})/);
      if (!jsonMatch) throw new Error("AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÂØπË±°„ÄÇ");
      const generatedData = JSON.parse(jsonMatch[0]);

      if (!generatedData.categories || !Array.isArray(generatedData.categories)) {
        throw new Error("AIËøîÂõûÁöÑJSONÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÁº∫Â∞ë 'categories' Êï∞ÁªÑ„ÄÇ");
      }


      await db.transaction('rw', db.shoppingProducts, db.shoppingCategories, async () => {
        for (const category of generatedData.categories) {
          let categoryId;
          const existingCategory = await db.shoppingCategories.where('name').equalsIgnoreCase(category.name).first();
          if (existingCategory) {
            categoryId = existingCategory.id;
          } else {
            categoryId = await db.shoppingCategories.add({
              name: category.name
            });
          }
          const productsToAdd = category.products.map(product => {
            return {
              name: product.name,
              price: product.price || 0,
              description: product.description || '',
              imageUrl: `https://image.pollinations.ai/prompt/${encodeURIComponent(product.image_prompt)}`,
              variations: (product.variations || []).map(v => ({
                ...v,
                imageUrl: `https://image.pollinations.ai/prompt/${encodeURIComponent(v.image_prompt)}`
              })),
              categoryId: categoryId
            };
          });
          if (productsToAdd.length > 0) {
            await db.shoppingProducts.bulkAdd(productsToAdd);
          }
        }
      });

      activeShoppingCategoryId = 'all';
      await renderShoppingProducts();
      await showCustomAlert('ÁîüÊàêÊàêÂäüÔºÅ', `‰∏∫‚Äú${chat.name}‚ÄùÈáèË∫´ÂÆöÂà∂ÁöÑÂïÜÂìÅÂ∑≤‰∏äÊû∂ÔºÅ`);

    } catch (error) {
      console.error("ÁîüÊàêË¥≠Áâ©‰∏≠ÂøÉÂïÜÂìÅÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÂïÜÂìÅÔºåËØ∑Ê£ÄÊü•(‰∏ª/ÂâØ)APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }



  async function handleWidgetImageChange(imageId) {
    const element = document.getElementById(imageId);
    if (!element) return;

    const choice = await showChoiceModal("Êõ¥Êç¢ÂõæÁâá", [
      { text: 'üìÅ ‰ªéÊú¨Âú∞‰∏ä‰º†', value: 'local' },
      { text: 'üåê ‰ΩøÁî®ÁΩëÁªúURL', value: 'url' },
      { text: 'üîÑ ÈáçÁΩÆ‰∏∫ÈªòËÆ§', value: 'reset' }
    ]);

    // Â§ÑÁêÜÈáçÁΩÆÈÄªËæë
    if (choice === 'reset') {
      const defaultSrc = element.dataset.defaultSrc;
      if (defaultSrc) {
        // ÊÅ¢Â§çÂà∞ÈªòËÆ§ÂõæÁâá
        element.src = defaultSrc;

        // ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§ËØ•ËÆ∞ÂΩï
        if (state.globalSettings.widgetData && state.globalSettings.widgetData[imageId]) {
          delete state.globalSettings.widgetData[imageId];
          await db.globalSettings.put(state.globalSettings);
        }

        await showCustomAlert("ÊàêÂäü", "Â∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂõæÁâáÔºÅ");
      } else {
        // Ê≤°ÊúâÈªòËÆ§ÂõæÁâáÔºåÈáçÁΩÆ‰∏∫Á∫ØÁôΩËâ≤
        // ÂàõÂª∫‰∏Ä‰∏™1x1ÁöÑÁ∫ØÁôΩËâ≤ÂõæÁâáÁöÑBase64
        const whitePixel = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2P4//8/AAX+Av4N70a4AAAAAElFTkSuQmCC';
        element.src = whitePixel;

        // ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§ËØ•ËÆ∞ÂΩï
        if (state.globalSettings.widgetData && state.globalSettings.widgetData[imageId]) {
          delete state.globalSettings.widgetData[imageId];
          await db.globalSettings.put(state.globalSettings);
        }

        await showCustomAlert("ÊàêÂäü", "Ê≤°ÊúâÈªòËÆ§‰ø°ÊÅØÔºåÂ∑≤ÈáçÁΩÆ‰∏∫Á∫ØÁôΩÔºÅ");
      }
      return;
    }

    let newUrl = null;
    let isBase64 = false; // Ê†áËÆ∞ÊòØÂê¶‰∏∫ Base64

    if (choice === 'local') {
      newUrl = await new Promise(resolve => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = e => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (readerEvent) => resolve(readerEvent.target.result);
            reader.readAsDataURL(file);
          } else {
            resolve(null);
          }
        };
        input.click();
      });
      if (newUrl) isBase64 = true;

    } else if (choice === 'url') {
      newUrl = await showCustomPrompt("Êõ¥Êç¢ÂõæÁâá", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂõæÁâáURLÔºö", element.src, "url");
      if (newUrl) isBase64 = false;
    }

    if (newUrl && newUrl.trim()) {
      const trimmedUrl = newUrl.trim();

      // 1. [Ê†∏ÂøÉ‰øÆÊîπ] Á´ãÂç≥ÊòæÁ§∫ Base64 Êàñ URL
      element.src = trimmedUrl;

      // 2. Á´ãÂç≥Â∞Ü Base64 Êàñ URL ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÁ°Æ‰øùÂà∑Êñ∞‰∏ç‰∏¢Â§±
      if (!state.globalSettings.widgetData) {
        state.globalSettings.widgetData = {};
      }
      state.globalSettings.widgetData[imageId] = trimmedUrl;
      await db.globalSettings.put(state.globalSettings);

      await showCustomAlert("ÊàêÂäü", "ÁªÑ‰ª∂ÂõæÁâáÂ∑≤Êõ¥Êñ∞Âπ∂‰øùÂ≠òÔºÅ");

      // 3. [Ê†∏ÂøÉ‰øÆÊîπ] Âè™ÊúâÂΩìÂÆÉÊòØ Base64 ‰∏î ImgBB ÂºÄÂêØÊó∂ÔºåÊâçÂú®ÂêéÂè∞‚ÄúÈùôÈªò‚Äù‰∏ä‰º†
      if (isBase64 && state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
        (async () => {
          console.log(`[ImgBB] ÂêØÂä® ${imageId} ÁöÑÈùôÈªò‰∏ä‰º†...`);
          // Ëøô‰∏™ÂáΩÊï∞‰ºöÂú®ÂêéÂè∞ËøêË°åÔºå‰∏ç‰ºöÈòªÂ°û
          await silentlyUpdateDbUrl(
            db.globalSettings,
            'main',
            `widgetData.${imageId}`,
            trimmedUrl // ‰º†ÂÖ• Base64 Â≠óÁ¨¶‰∏≤
          );
        })();
      }
    }
  }


  window.handleWidgetImageChange = handleWidgetImageChange;

  // ÊñπÊ°à3ÔºöÂØºÂá∫Êó∂Ê∏ÖÁêÜAPIÂéÜÂè≤ËÆ∞ÂΩïÁöÑËæÖÂä©ÂáΩÊï∞
  function removeApiHistoryFromChats(chatsArray) {
    if (!Array.isArray(chatsArray)) return chatsArray;
    
    // ÂàõÂª∫Ê∑±Êã∑Ë¥ùÂπ∂ÁßªÈô§apiHistoryÂ≠óÊÆµ
    return chatsArray.map(chat => {
      const chatCopy = { ...chat };
      if (chatCopy.apiHistory) {
        delete chatCopy.apiHistory;
      }
      return chatCopy;
    });
  }

  async function exportDataAsSlicedZip() {

    if (!window.streamSaver || typeof JSZip === 'undefined') {
      await showCustomAlert("Â∫ìÂä†ËΩΩÂ§±Ë¥•", "Êó†Ê≥ïÂêØÂä®ÂØºÂá∫ÔºåÊâÄÈúÄÁöÑÊ†∏ÂøÉÂ∫ì (StreamSaver.js Êàñ JSZip) Êú™Âä†ËΩΩ„ÄÇËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËøûÊé•Âπ∂Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï„ÄÇ");
      return;
    }

    await showCustomAlert("Ê≠£Âú®ÂáÜÂ§áÂàÜÁâáÂØºÂá∫...", "Âç≥Â∞ÜÂºÄÂßãÊâìÂåÖÊÇ®ÁöÑÂÆåÊï¥Â§á‰ªΩÊñá‰ª∂„ÄÇÊñá‰ª∂Â∞Ü‰ª•ZIPÊ†ºÂºèÊµÅÂºè‰∏ãËΩΩÔºåËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢„ÄÇ");


    const fileStream = streamSaver.createWriteStream(`330-EPhone-Sliced-Backup-${new Date().toISOString().split('T')[0]}.zip`);
    const zip = new JSZip();


    const MAX_SLICE_SIZE = 95 * 1024 * 1024;
    let sliceIndex = 1;
    let currentSliceData = {};
    let currentSliceSizeBytes = 0;
    const encoder = new TextEncoder();

    try {
      const tablesToBackup = db.tables.map(t => t.name);

      for (const tableName of tablesToBackup) {
        console.log(`Ê≠£Âú®ÊâìÂåÖË°®: ${tableName}...`);
        let tableData = await db.table(tableName).toArray();

        // ÊñπÊ°à3ÔºöÂØºÂá∫Êó∂ÁßªÈô§APIÂéÜÂè≤ËÆ∞ÂΩï
        if (tableName === 'chats') {
          tableData = removeApiHistoryFromChats(tableData);
        }

        if (tableData.length === 0) continue;

        const tableDataString = JSON.stringify(tableData);
        const tableDataSize = encoder.encode(tableDataString).length;


        if (tableDataSize > MAX_SLICE_SIZE) {
          console.warn(`Ë≠¶ÂëäÔºöË°® "${tableName}" (Â§ßÂ∞è: ${(tableDataSize / 1024 / 1024).toFixed(2)}MB) ÂçïÁã¨Ë∂ÖËøá‰∫ÜÂàáÁâáÈôêÂà∂„ÄÇ`);


          if (currentSliceSizeBytes > 0) {
            zip.file(`slice_${sliceIndex++}.json`, JSON.stringify({
              version: 4,
              type: 'slice',
              data: currentSliceData
            }));
            currentSliceData = {};
            currentSliceSizeBytes = 0;
          }


          currentSliceData[tableName] = tableData;
          zip.file(`slice_${sliceIndex++}.json`, JSON.stringify({
            version: 4,
            type: 'slice',
            data: currentSliceData
          }));
          currentSliceData = {};
          currentSliceSizeBytes = 0;

          continue;
        }


        if (currentSliceSizeBytes > 0 && (currentSliceSizeBytes + tableDataSize > MAX_SLICE_SIZE)) {
          console.log(`ÂàáÁâá ${sliceIndex} Â∑≤Êª° (Â§ßÂ∞è: ${(currentSliceSizeBytes / 1024 / 1024).toFixed(2)}MB)ÔºåÊ≠£Âú®ÂΩíÊ°£...`);


          zip.file(`slice_${sliceIndex++}.json`, JSON.stringify({
            version: 4,
            type: 'slice',
            data: currentSliceData
          }));


          currentSliceData = {};
          currentSliceSizeBytes = 0;
        }


        currentSliceData[tableName] = tableData;
        currentSliceSizeBytes += tableDataSize;
      }


      if (currentSliceSizeBytes > 0) {
        console.log(`Ê≠£Âú®ÂΩíÊ°£ÊúÄÂêé‰∏Ä‰∏™ÂàáÁâá ${sliceIndex} (Â§ßÂ∞è: ${(currentSliceSizeBytes / 1024 / 1024).toFixed(2)}MB)...`);
        zip.file(`slice_${sliceIndex}.json`, JSON.stringify({
          version: 4,
          type: 'slice',
          data: currentSliceData
        }));
      }

      console.log("ÊâÄÊúâÂàáÁâáÂ∑≤ÊâìÂåÖÔºåÂºÄÂßãÊµÅÂºè‰∏ãËΩΩZIP...");


      const zipStream = zip.generateInternalStream({
        type: "blob",
        streamFiles: true
      });


      const readableStream = new ReadableStream({
        start(controller) {
          zipStream.on('data', (chunk) => {

            controller.enqueue(chunk);
          }).on('end', () => {

            console.log("ZIP ÊµÅÁîüÊàêÂÆåÊØï„ÄÇ");
            controller.close();
          }).on('error', (err) => {

            console.error("JSZip ÊµÅÈîôËØØ:", err);
            controller.error(err);
          }).resume();
        }
      });


      await readableStream.pipeTo(fileStream);


      await showCustomAlert('ÂØºÂá∫Â∑≤ÂºÄÂßã', 'ÊÇ®ÁöÑÂàÜÁâáÂ§á‰ªΩÂ∑≤ÂºÄÂßã‰∏ãËΩΩ„ÄÇËß£ÂéãÂêéÔºåÊÇ®ÂèØ‰ª•‰ΩøÁî®‚ÄúÂØºÂÖ•‚ÄùÂäüËÉΩÔºåÈÄâÊã©ÂÖ∂‰∏≠ÁöÑ `slice_X.json` Êñá‰ª∂ËøõË°åÂ¢ûÈáèÊÅ¢Â§ç„ÄÇ');

    } catch (error) {
      console.error("ÂàÜÁâáÂØºÂá∫ËøáÁ®ã‰∏≠Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `Âú®ÊâìÂåÖÊàñÂÜôÂÖ•Êñá‰ª∂ÊµÅÊó∂ÂèëÁîüÈîôËØØ: ${error.message}`);


      try {
        const writer = fileStream.getWriter();
        writer.abort(error);
      } catch (e) { }
    }
  }

  async function exportDataAsStream() {

    if (!window.streamSaver) {
      alert("ÊµÅÂºè‰∏ãËΩΩÂ∫ì (StreamSaver.js) Êú™Âä†ËΩΩ„ÄÇËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñHTMLÊñá‰ª∂ÈÖçÁΩÆ„ÄÇ");
      return;
    }

    await showCustomAlert("Ê≠£Âú®ÂáÜÂ§á...", "Âç≥Â∞ÜÂºÄÂßã‰∏ãËΩΩÊÇ®ÁöÑÂÆåÊï¥Â§á‰ªΩÊñá‰ª∂„ÄÇ‰∏ãËΩΩËøáÁ®ã‰∏≠ËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢„ÄÇ");


    const fileStream = streamSaver.createWriteStream(`330-EPhone-Full-Backup-Streamed-${new Date().toISOString().split('T')[0]}.json`);
    const writer = fileStream.getWriter();
    const encoder = new TextEncoder();

    try {

      await writer.write(encoder.encode('{\n"version": 3,\n"timestamp": ' + Date.now() + ',\n"data": {\n'));

      const tablesToBackup = await db.tables.map(t => t.name);

      for (let i = 0; i < tablesToBackup.length; i++) {
        const tableName = tablesToBackup[i];
        const table = db.table(tableName);


        await writer.write(encoder.encode(`"${tableName}": [\n`));

        let isFirstRecordInTable = true;

        await table.each(record => {
          if (!isFirstRecordInTable) {
            writer.write(encoder.encode(',\n'));
          }

          // ÊñπÊ°à3ÔºöÂØºÂá∫Êó∂ÁßªÈô§APIÂéÜÂè≤ËÆ∞ÂΩï
          let recordToWrite = record;
          if (tableName === 'chats' && record.apiHistory) {
            recordToWrite = { ...record };
            delete recordToWrite.apiHistory;
          }

          writer.write(encoder.encode(JSON.stringify(recordToWrite)));
          isFirstRecordInTable = false;
        });


        await writer.write(encoder.encode('\n]'));
        if (i < tablesToBackup.length - 1) {

          await writer.write(encoder.encode(',\n'));
        }
      }


      await writer.write(encoder.encode('\n}\n}'));

    } catch (error) {
      console.error("ÊµÅÂºèÂØºÂá∫ËøáÁ®ã‰∏≠Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `Âú®ÂÜôÂÖ•Êñá‰ª∂ÊµÅÊó∂ÂèëÁîüÈîôËØØ: ${error.message}`);
    } finally {

      await writer.close();
    }
  }

  async function exportDataAsBlob() {
    await showCustomAlert("Ê≠£Âú®ÂáÜÂ§á...", "Ê≠£Âú®ËØªÂèñÊâÄÊúâÊï∞ÊçÆÂà∞ÂÜÖÂ≠ò‰∏≠ÔºåËØ∑Á®çÂÄô...");

    try {
      const backupData = {
        version: 3,
        timestamp: Date.now(),
        data: {}
      };

      const tablesToBackup = db.tables.map(t => t.name);

      for (const tableName of tablesToBackup) {
        let tableData = await db.table(tableName).toArray();
        
        // ÊñπÊ°à3ÔºöÂØºÂá∫Êó∂ÁßªÈô§APIÂéÜÂè≤ËÆ∞ÂΩï
        if (tableName === 'chats') {
          tableData = removeApiHistoryFromChats(tableData);
        }
        
        backupData.data[tableName] = tableData;
        console.log(`Â∑≤ÊâìÂåÖË°®: ${tableName}, ËÆ∞ÂΩïÊï∞: ${tableData.length}`);
      }

      const blob = new Blob(
        [JSON.stringify(backupData, null, 2)], {
        type: 'application/json'
      }
      );

      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `330-EPhone-Full-Backup-Legacy-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);

      await showCustomAlert('ÂØºÂá∫ÊàêÂäü', 'Â∑≤ÊàêÂäüÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆÔºÅ');

    } catch (error) {
      console.error("‰º†ÁªüÂØºÂá∫Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
    }
  }

  // È´òÁ∫ßÂØºÂá∫ÂØºÂÖ•ÂäüËÉΩ - ÊåâÁ±ªÂà´ÂØºÂá∫ÂØºÂÖ•
  async function showAdvancedExportImportModal() {
    // ÂÆö‰πâÊï∞ÊçÆÁ±ªÂà´ÂèäÂÖ∂ÂØπÂ∫îÁöÑË°®
    const dataCategories = {
      'ËÅäÂ§©‰∏éÊ∂àÊÅØ': ['chats'],
      'Á©∫Èó¥‰∏éÁ§æ‰∫§': ['qzoneSettings', 'qzonePosts', 'qzoneAlbums', 'qzonePhotos', 'qzoneGroups', 'doubanPosts'],
      '‰∏ñÁïå‰π¶‰∏éÈ¢ÑËÆæ': ['worldBooks', 'worldBookCategories', 'presets', 'presetCategories', 'personaPresets'],
      'API‰∏éÈÖçÁΩÆ': ['apiConfig', 'apiPresets', 'globalSettings', 'renderingRules', 'naiPresets'],
      'Ë¥¥Á∫∏‰∏éË°®ÊÉÖ': ['userStickers', 'stickerCategories', 'stickerVisionCache', 'customAvatarFrames'],
      'Èü≥‰πê‰∏éÂ™í‰Ωì': ['musicLibrary', 'readingLibrary', 'watchTogetherPlaylist'],
      'ËÆ∞ÂøÜ‰∏éËÆ∞ÂΩï': ['memories', 'callRecords', 'favorites'],
      'ÂïÜÂüé‰∏éÁâ©ÂìÅ': ['shoppingProducts', 'shoppingCategories', 'inventory', 'auctions'],
      'ÈáëËûçÁ≥ªÁªü': ['userWallet', 'userTransactions', 'funds'],
      'NPC‰∏éÊïÖ‰∫ã': ['npcs', 'npcGroups', 'grAuthors', 'grStories'],
      'Âø´Êç∑ÂõûÂ§ç': ['quickReplies', 'quickReplyCategories'],
      'ÈÇÆ‰ª∂Á≥ªÁªü': ['emails'],
      'Â§ñËßÇËÆæÁΩÆ': ['appearancePresets']
    };

    // ÂàõÂª∫ÈÄâÊã©ÁïåÈù¢HTML
    const categoryCheckboxes = Object.keys(dataCategories).map(category => {
      const tableCount = dataCategories[category].length;
      return `
        <div style="margin: 8px 0; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 8px;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" class="category-checkbox" data-category="${category}" 
                   style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
            <span style="flex: 1; font-size: 14px;">${category}</span>
            <span style="font-size: 12px; color: #666;">(${tableCount}‰∏™Ë°®)</span>
          </label>
        </div>
      `;
    }).join('');

    const modalHTML = `
      <div id="advanced-export-modal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      ">
        <div style="
          background: white;
          border-radius: 12px;
          padding: 20px;
          max-width: 500px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        ">
          <h2 style="margin: 0 0 15px 0; font-size: 20px; color: #333;">È´òÁ∫ßÂØºÂá∫ÂØºÂÖ• - ÈÄâÊã©Êï∞ÊçÆÁ±ªÂà´</h2>
          <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button id="select-all-categories" style="
              padding: 8px 15px;
              background: #4CAF50;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
            ">ÂÖ®ÈÄâ</button>
            <button id="deselect-all-categories" style="
              padding: 8px 15px;
              background: #f44336;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
            ">ÂèñÊ∂àÂÖ®ÈÄâ</button>
            <button id="advanced-import-trigger" style="
              padding: 8px 15px;
              background: #FF9800;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              margin-left: auto;
            ">üì• ÂØºÂÖ•Êï∞ÊçÆ</button>
          </div>
          <div style="margin: 15px 0;">
            ${categoryCheckboxes}
          </div>
          <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button id="confirm-export" style="
              flex: 1;
              padding: 12px;
              background: #2196F3;
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              cursor: pointer;
            ">Á°ÆËÆ§ÂØºÂá∫</button>
            <button id="cancel-export" style="
              flex: 1;
              padding: 12px;
              background: #999;
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              cursor: pointer;
            ">ÂèñÊ∂à</button>
          </div>
        </div>
      </div>
    `;

    // Ê∑ªÂä†Âà∞È°µÈù¢
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);

    // ÁªëÂÆö‰∫ã‰ª∂
    const modal = document.getElementById('advanced-export-modal');
    const checkboxes = modal.querySelectorAll('.category-checkbox');

    // ÂÖ®ÈÄâ
    document.getElementById('select-all-categories').addEventListener('click', () => {
      checkboxes.forEach(cb => cb.checked = true);
    });

    // ÂèñÊ∂àÂÖ®ÈÄâ
    document.getElementById('deselect-all-categories').addEventListener('click', () => {
      checkboxes.forEach(cb => cb.checked = false);
    });

    // ÂØºÂÖ•Êï∞ÊçÆ
    document.getElementById('advanced-import-trigger').addEventListener('click', () => {
      document.getElementById('advanced-import-input').click();
    });

    // ÂèñÊ∂à
    document.getElementById('cancel-export').addEventListener('click', () => {
      document.body.removeChild(modalContainer);
    });

    // Á°ÆËÆ§ÂØºÂá∫
    document.getElementById('confirm-export').addEventListener('click', async () => {
      const selectedCategories = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.dataset.category);

      if (selectedCategories.length === 0) {
        await showCustomAlert('ÊèêÁ§∫', 'ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Êï∞ÊçÆÁ±ªÂà´ÔºÅ');
        return;
      }

      // Êî∂ÈõÜÊâÄÊúâË¶ÅÂØºÂá∫ÁöÑË°®
      const tablesToExport = [];
      selectedCategories.forEach(category => {
        tablesToExport.push(...dataCategories[category]);
      });

      // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
      document.body.removeChild(modalContainer);

      // ÊâßË°åÂØºÂá∫
      await exportSelectedTables(tablesToExport, selectedCategories);
    });

    // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        document.body.removeChild(modalContainer);
      }
    });
  }

  // ÂØºÂá∫ÈÄâÂÆöÁöÑË°®
  async function exportSelectedTables(tables, categoryNames) {
    await showCustomAlert("Ê≠£Âú®ÂáÜÂ§á...", "Ê≠£Âú®ËØªÂèñÈÄâÂÆöÁöÑÊï∞ÊçÆÔºåËØ∑Á®çÂÄô...");

    try {
      const backupData = {
        version: 3,
        timestamp: Date.now(),
        exportType: 'advanced',
        categories: categoryNames,
        data: {}
      };

      let totalRecords = 0;
      for (const tableName of tables) {
        if (db[tableName]) {
          let tableData = await db.table(tableName).toArray();
          
          // ÊñπÊ°à3ÔºöÂØºÂá∫Êó∂ÁßªÈô§APIÂéÜÂè≤ËÆ∞ÂΩï
          if (tableName === 'chats') {
            tableData = removeApiHistoryFromChats(tableData);
          }
          
          backupData.data[tableName] = tableData;
          totalRecords += tableData.length;
          console.log(`Â∑≤ÊâìÂåÖË°®: ${tableName}, ËÆ∞ÂΩïÊï∞: ${tableData.length}`);
        }
      }

      const blob = new Blob(
        [JSON.stringify(backupData, null, 2)], {
        type: 'application/json'
      }
      );

      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const categoryLabel = categoryNames.join('-');
      link.download = `EPhone-Advanced-Export-${categoryLabel}-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);

      await showCustomAlert('ÂØºÂá∫ÊàêÂäü', `Â∑≤ÊàêÂäüÂØºÂá∫ ${tables.length} ‰∏™Êï∞ÊçÆË°®ÔºåÂÖ± ${totalRecords} Êù°ËÆ∞ÂΩïÔºÅ`);

    } catch (error) {
      console.error("È´òÁ∫ßÂØºÂá∫Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
    }
  }

  // È´òÁ∫ßÂØºÂÖ•ÂäüËÉΩ
  async function handleAdvancedImport(file) {
    if (!file) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØªÂèñÂπ∂Ëß£ÊûêÈ´òÁ∫ßÂØºÂá∫Êñá‰ª∂...");

    try {
      const text = await file.text();
      const data = JSON.parse(text);

      // Ê£ÄÊü•ÊòØÂê¶‰∏∫È´òÁ∫ßÂØºÂá∫Êñá‰ª∂
      if (data.exportType !== 'advanced' || !data.data || !data.categories) {
        await showCustomAlert('Êñá‰ª∂Ê†ºÂºèÈîôËØØ', 'Ëøô‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑÈ´òÁ∫ßÂØºÂá∫Êñá‰ª∂„ÄÇËØ∑‰ΩøÁî®"ÂØºÂÖ•Â§á‰ªΩÊñá‰ª∂"ÂäüËÉΩÂØºÂÖ•ÊôÆÈÄöÂ§á‰ªΩ„ÄÇ');
        return;
      }

      // ÊòæÁ§∫ÂØºÂÖ•Á°ÆËÆ§ÁïåÈù¢
      await showAdvancedImportConfirmModal(data);

    } catch (error) {
      console.error("ËØªÂèñÈ´òÁ∫ßÂØºÂá∫Êñá‰ª∂Êó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•: ${error.message}`);
    }
  }

  // ÊòæÁ§∫È´òÁ∫ßÂØºÂÖ•Á°ÆËÆ§ÁïåÈù¢
  async function showAdvancedImportConfirmModal(backupData) {
    const { categories, data } = backupData;

    // ÁªüËÆ°Êï∞ÊçÆ
    const tableStats = [];
    let totalRecords = 0;
    for (const tableName in data) {
      const count = Array.isArray(data[tableName]) ? data[tableName].length : 1;
      totalRecords += count;
      tableStats.push({ table: tableName, count });
    }

    const statsHTML = tableStats.map(stat => `
      <div style="padding: 8px; background: rgba(255,255,255,0.5); border-radius: 6px; margin: 5px 0;">
        <span style="font-weight: bold;">${stat.table}</span>: ${stat.count} Êù°ËÆ∞ÂΩï
      </div>
    `).join('');

    const modalHTML = `
      <div id="advanced-import-confirm-modal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      ">
        <div style="
          background: white;
          border-radius: 12px;
          padding: 20px;
          max-width: 500px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        ">
          <h2 style="margin: 0 0 15px 0; font-size: 20px; color: #333;">È´òÁ∫ßÂØºÂÖ•Á°ÆËÆ§</h2>
          <div style="margin: 15px 0;">
            <p style="margin: 10px 0;"><strong>ÂØºÂá∫Á±ªÂà´Ôºö</strong>${categories.join('„ÄÅ')}</p>
            <p style="margin: 10px 0;"><strong>ÊÄªËÆ∞ÂΩïÊï∞Ôºö</strong>${totalRecords} Êù°</p>
            <div style="margin-top: 15px;">
              <strong>ÂåÖÂê´ÁöÑÊï∞ÊçÆË°®Ôºö</strong>
              <div style="margin-top: 10px; max-height: 300px; overflow-y: auto;">
                ${statsHTML}
              </div>
            </div>
          </div>
          <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <strong style="color: #856404;">‚ö†Ô∏è ÂØºÂÖ•ËØ¥ÊòéÔºö</strong>
            <p style="margin: 5px 0 0 0; color: #856404; font-size: 14px;">
              ÂØºÂÖ•Â∞Ü‰ºö<strong>ÂêàÂπ∂</strong>Êï∞ÊçÆÂà∞Áé∞ÊúâÊï∞ÊçÆÂ∫ì‰∏≠„ÄÇÂ¶ÇÊûúÂ≠òÂú®IDÂÜ≤Á™ÅÔºåÊñ∞Êï∞ÊçÆÂ∞ÜË¶ÜÁõñÊóßÊï∞ÊçÆ„ÄÇ
            </p>
          </div>
          <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button id="confirm-advanced-import" style="
              flex: 1;
              padding: 12px;
              background: #4CAF50;
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              cursor: pointer;
            ">Á°ÆËÆ§ÂØºÂÖ•</button>
            <button id="cancel-advanced-import" style="
              flex: 1;
              padding: 12px;
              background: #999;
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              cursor: pointer;
            ">ÂèñÊ∂à</button>
          </div>
        </div>
      </div>
    `;

    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);

    const modal = document.getElementById('advanced-import-confirm-modal');

    // ÂèñÊ∂à
    document.getElementById('cancel-advanced-import').addEventListener('click', () => {
      document.body.removeChild(modalContainer);
    });

    // Á°ÆËÆ§ÂØºÂÖ•
    document.getElementById('confirm-advanced-import').addEventListener('click', async () => {
      document.body.removeChild(modalContainer);
      await executeAdvancedImport(backupData.data);
    });

    // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        document.body.removeChild(modalContainer);
      }
    });
  }

  // ÊâßË°åÈ´òÁ∫ßÂØºÂÖ•
  async function executeAdvancedImport(data) {
    await showCustomAlert("Ê≠£Âú®ÂØºÂÖ•...", "Ê≠£Âú®Â∞ÜÊï∞ÊçÆÂÜôÂÖ•Êï∞ÊçÆÂ∫ìÔºåËØ∑Á®çÂÄô...");

    try {
      let importedTables = 0;
      let importedRecords = 0;

      for (const tableName in data) {
        if (db[tableName]) {
          const tableData = data[tableName];
          if (Array.isArray(tableData) && tableData.length > 0) {
            // ‰ΩøÁî® bulkPut Êù•ÂêàÂπ∂Êï∞ÊçÆÔºàÂ¶ÇÊûúÊúâ‰∏ªÈîÆÂÜ≤Á™Å‰ºöË¶ÜÁõñÔºâ
            await db.table(tableName).bulkPut(tableData);
            importedTables++;
            importedRecords += tableData.length;
            console.log(`Â∑≤ÂØºÂÖ•Ë°® ${tableName}: ${tableData.length} Êù°ËÆ∞ÂΩï`);
          }
        } else {
          console.warn(`Ë°® ${tableName} ‰∏çÂ≠òÂú®‰∫éÂΩìÂâçÊï∞ÊçÆÂ∫ì‰∏≠ÔºåË∑≥Ëøá`);
        }
      }

      // ÂØºÂÖ•ÊàêÂäüÔºåËØ¢ÈóÆÁî®Êà∑ÊòØÂê¶Âà∑Êñ∞È°µÈù¢
      const shouldRefresh = await showCustomConfirm(
        'ÂØºÂÖ•ÊàêÂäü',
        `Â∑≤ÊàêÂäüÂØºÂÖ• ${importedTables} ‰∏™Êï∞ÊçÆË°®ÔºåÂÖ± ${importedRecords} Êù°ËÆ∞ÂΩïÔºÅ<br><br>ÊòØÂê¶Á´ãÂç≥Âà∑Êñ∞È°µÈù¢‰ª•‰ΩøÊï∞ÊçÆÁîüÊïàÔºü<br><span style="color: #666; font-size: 14px;">ÔºàÁÇπÂáª"ÂèñÊ∂à"ÂèØ‰ª•ÁªßÁª≠ËøõË°åÂÖ∂‰ªñÊìç‰ΩúÔºâ</span>`,
        {
          confirmText: 'Á´ãÂç≥Âà∑Êñ∞',
          cancelText: 'Á®çÂêéÂà∑Êñ∞'
        }
      );

      if (shouldRefresh) {
        // Áî®Êà∑ÈÄâÊã©Âà∑Êñ∞È°µÈù¢
        location.reload();
      } else {
        // Áî®Êà∑ÈÄâÊã©‰∏çÂà∑Êñ∞ÔºåÂ∞ùËØïÂ±ÄÈÉ®Âà∑Êñ∞ÁïåÈù¢
        if (typeof loadChats === 'function') {
          loadChats();
        }
      }

    } catch (error) {
      console.error("È´òÁ∫ßÂØºÂÖ•Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
    }
  }

  function updateBackButtonUnreadCount() {

    const totalChatUnread = Object.values(state.chats).reduce((sum, chat) => {

      if (chat.id === state.activeChatId) {
        return sum;
      }
      return sum + (chat.unreadCount || 0);
    }, 0);


    const totalQzoneUnread = unreadPostsCount || 0;


    const totalUnread = totalChatUnread + totalQzoneUnread;


    const backBtn = document.getElementById('back-to-list-btn');
    if (!backBtn) return;



    let indicator = backBtn.querySelector('.unread-indicator');
    if (!indicator) {
      indicator = document.createElement('span');
      indicator.className = 'unread-indicator';
      backBtn.appendChild(indicator);
    }


    let qzoneIndicator = backBtn.querySelector('.unread-indicator.back-btn-indicator');
    if (qzoneIndicator) {
      qzoneIndicator.remove();
    }


    if (totalUnread > 0) {
      indicator.textContent = totalUnread > 99 ? '99+' : totalUnread;
      indicator.style.display = 'block';

      indicator.style.zIndex = '20';
      indicator.style.transform = 'scale(0.8)';
    } else {
      indicator.style.display = 'none';
    }
  }

  async function openStickerCategoryBindingModal(categoryId) {
    const category = categoryId === 'uncategorized' ?
      {
        id: 'uncategorized',
        name: 'Êú™ÂàÜÁ±ª'
      } :
      await db.stickerCategories.get(categoryId);

    if (!category) {
      console.error("Êó†Ê≥ï‰∏∫‰∏çÂ≠òÂú®ÁöÑÂàÜÁ±ªÊâìÂºÄÁªëÂÆöÊ®°ÊÄÅÊ°Ü:", categoryId);
      return;
    }

    const modal = document.getElementById('sticker-binding-modal');
    const listEl = document.getElementById('sticker-binding-chat-list');
    const header = modal.querySelector('.modal-header span');
    listEl.innerHTML = '';
    header.textContent = `Â∞ÜÂàÜÁ±ª ‚Äú${category.name}‚Äù ÁªëÂÆöÂà∞...`;

    const allChats = Object.values(state.chats).sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));

    allChats.forEach(chat => {

      const isChecked = Array.isArray(chat.settings?.stickerCategoryIds) && chat.settings.stickerCategoryIds.includes(categoryId);

      const item = document.createElement('div');
      item.className = 'contact-picker-item'; // Â§çÁî®Áé∞ÊúâÊ†∑Âºè
      item.innerHTML = `
            <input type="checkbox" class="sticker-binding-checkbox" data-chat-id="${chat.id}" ${isChecked ? 'checked' : ''} style="margin-right: 15px;">
            <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${chat.name}</span>
        `;
      listEl.appendChild(item);
    });


    document.getElementById('save-sticker-binding-btn').onclick = () => saveStickerCategoryBindings(categoryId);
    document.getElementById('cancel-sticker-binding-btn').onclick = () => modal.classList.remove('visible');

    modal.classList.add('visible');
  }


  async function saveStickerCategoryBindings(categoryId) {
    const selectedChatIds = new Set(
      Array.from(document.querySelectorAll('#sticker-binding-chat-list .sticker-binding-checkbox:checked'))
        .map(cb => cb.dataset.chatId)
    );

    const chatsToUpdate = [];
    for (const chatId in state.chats) {
      const chat = state.chats[chatId];
      if (!Array.isArray(chat.settings.stickerCategoryIds)) {
        chat.settings.stickerCategoryIds = [];
      }


      const wasBound = chat.settings.stickerCategoryIds.includes(categoryId);
      const shouldBeBound = selectedChatIds.has(chatId);

      if (wasBound && !shouldBeBound) {

        chat.settings.stickerCategoryIds = chat.settings.stickerCategoryIds.filter(id => id !== categoryId);
        chatsToUpdate.push(chat);
      } else if (!wasBound && shouldBeBound) {

        chat.settings.stickerCategoryIds.push(categoryId);
        chatsToUpdate.push(chat);
      }
    }

    if (chatsToUpdate.length > 0) {
      await db.chats.bulkPut(chatsToUpdate);
      await showCustomAlert("‰øùÂ≠òÊàêÂäü", "Ë°®ÊÉÖÂåÖÂàÜÁ±ªÁªëÂÆöÂ∑≤Êõ¥Êñ∞ÔºÅ");
    }

    document.getElementById('sticker-binding-modal').classList.remove('visible');
  }


  function getStickerContextForPrompt(chat) {
    if (!chat || !chat.settings.stickerCategoryIds || chat.settings.stickerCategoryIds.length === 0) {
      return '';
    }

    const categoryIds = chat.settings.stickerCategoryIds;
    let allStickers = [];
    const addedStickerNames = new Set();


    categoryIds.forEach(categoryId => {
      let stickersInCategory;

      if (categoryId === 'uncategorized') {
        stickersInCategory = state.userStickers.filter(s => !s.categoryId);
      } else {
        stickersInCategory = state.userStickers.filter(s => s.categoryId === categoryId);
      }


      stickersInCategory.forEach(sticker => {
        if (!addedStickerNames.has(sticker.name)) {
          allStickers.push(sticker);
          addedStickerNames.add(sticker.name);
        }
      });
    });

    if (allStickers.length === 0) {
      return '';
    }

    const stickerList = allStickers.map(s => `- ${s.name}`).join('\n');
    return `
# ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÈÄâÂ°´)
# „Äê„Äê„ÄêË°®ÊÉÖ‰ΩøÁî®ÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë„Äë„Äë
1.  ‰Ω†„ÄêÂè™ËÉΩ„ÄëÂú®ÂêåÊó∂ÂèëÈÄÅ‰∫Ü„ÄêÊúâÊÑè‰πâÁöÑÊñáÊú¨ÂÜÖÂÆπ„Äë‰πãÂêéÔºåÊâçËÉΩ„ÄêÈ¢ùÂ§ñ„ÄëËøΩÂä†‰∏Ä‰∏™Ë°®ÊÉÖ„ÄÇ
2.  „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂè™ÂèëÈÄÅ‰∏Ä‰∏™Ë°®ÊÉÖ‰Ωú‰∏∫ÂçïÁã¨ÁöÑÂõûÂ§ç„ÄÇ
3.  „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂèëÊòéÊàñÁºñÈÄ†ÂàóË°®‰∏≠‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂê´‰πâ„ÄÇ
4.  Â¶ÇÊûú‰Ω†Âú®ÂàóË°®‰∏≠Êâæ‰∏çÂà∞„Äê100%ÂÆåÁæéÂåπÈÖç„ÄëÁöÑË°®ÊÉÖÔºåËØ∑„Äê‰∏çË¶Å„Äë‰ΩøÁî® "sticker" Êåá‰ª§ÔºåÂè™ÂèëÈÄÅÊñáÊú¨„ÄÇ
5. „Äê‰ΩøÁî®È¢ëÁéá„Äë: ‰Ω†„Äê‰∏çÂ∫îËØ•„ÄëÂú®ÊØè‰∏ÄËΩÆÂØπËØù‰∏≠ÈÉΩÂèëÈÄÅË°®ÊÉÖ„ÄÇËØ∑Âè™Âú®‰Ω†ËßâÂæó„ÄêÈùûÂ∏∏ÂøÖË¶Å„ÄëÊàñ„ÄêÊÉÖÁª™ÁâπÂà´Âº∫ÁÉà„ÄëÊó∂Êâç‰ΩøÁî®Ë°®ÊÉÖÔºå‰øùÊåÅÂØπËØùÁöÑËá™ÁÑ∂ÊÄß„ÄÇ
6.  **„ÄêÈáçÂ§çÊÉ©ÁΩö (ÊúÄÈ´òÈìÅÂæãÔºÅ)„Äë**: ‰Ω†„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËøûÁª≠Âá†ËΩÆÂõûÂ§ç‰ΩøÁî®„ÄêÂÆåÂÖ®Áõ∏Âêå„ÄëÁöÑË°®ÊÉÖÂê´‰πâ„ÄÇ‰æãÂ¶ÇÔºåÂ¶ÇÊûú‰Ω†‰∏ä‰∏ÄËΩÆÂõûÂ§ç‰∫Ü "meaning": "ÂÆ≥Áæû"ÔºåÈÇ£‰πà‰Ω†Ëøô‰∏ÄËΩÆ„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂÜçÊ¨°‰ΩøÁî® "meaning": "ÂÆ≥Áæû"„ÄÇ‰Ω†ÂøÖÈ°ªÈÄâÊã©‰∏Ä‰∏™‰∏çÂêåÁöÑÂê´‰πâÔºåÊàñËÄÖÂπ≤ËÑÜ‰∏çÂèëË°®ÊÉÖ„ÄÇ
- **ÂèØÁî®ÂàóË°®**:
${stickerList}
`;
  }


  function getGroupStickerContextForPrompt(chat) {
    if (!chat || !chat.isGroup) return '';

    const allCategoryIds = new Set();
    chat.members.forEach(member => {
      if (member.id === 'user') return;
      const memberChat = state.chats[member.id];
      if (memberChat && memberChat.settings.stickerCategoryIds) {
        memberChat.settings.stickerCategoryIds.forEach(id => allCategoryIds.add(id));
      }
    });

    if (allCategoryIds.size === 0) {
      return '';
    }

    let allStickers = [];
    const addedStickerNames = new Set();

    allCategoryIds.forEach(categoryId => {
      let stickersInCategory;
      if (categoryId === 'uncategorized') {
        stickersInCategory = state.userStickers.filter(s => !s.categoryId);
      } else {
        stickersInCategory = state.userStickers.filter(s => s.categoryId === categoryId);
      }

      stickersInCategory.forEach(sticker => {
        if (!addedStickerNames.has(sticker.name)) {
          allStickers.push(sticker);
          addedStickerNames.add(sticker.name);
        }
      });
    });

    if (allStickers.length === 0) {
      return '';
    }

    const stickerList = allStickers.map(s => `- ${s.name}`).join('\n');
    return `
# ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÂÖ®Áæ§ÂÖ±‰∫´)
# „Äê„Äê„ÄêË°®ÊÉÖ‰ΩøÁî®ÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë„Äë„Äë
1.  „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂè™ÂèëÈÄÅ‰∏Ä‰∏™Ë°®ÊÉÖ‰Ωú‰∏∫ÂçïÁã¨ÁöÑÂõûÂ§ç„ÄÇ
2.  „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂèëÊòéÊàñÁºñÈÄ†ÂàóË°®‰∏≠‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂê´‰πâ„ÄÇ
3.  Â¶ÇÊûúÊ≤°ÊâæÂà∞ÂêàÈÄÇÁöÑÔºåËØ∑‰∏çË¶Å‰ΩøÁî® "sticker" Êåá‰ª§„ÄÇ
4.  **„ÄêËßíËâ≤ÂàÜÈÖç„Äë**: ‰Ω†ÂèØ‰ª•‰ªé‰∏ãÈù¢ÁöÑ„ÄêÂÖ±‰∫´ÂàóË°®„Äë‰∏≠ÈÄâÊã©‰ªªÊÑèË°®ÊÉÖÔºåÂπ∂Â∞ÜÂÖ∂ÂàÜÈÖçÁªô„Äê‰ªªÊÑèAIËßíËâ≤„Äë„ÄÇ
5. „Äê‰ΩøÁî®È¢ëÁéá„Äë: ËØ∑Âè™Âú®‰Ω†ËßâÂæó„ÄêÈùûÂ∏∏ÂøÖË¶Å„ÄëÊàñ„ÄêÊÉÖÁª™ÁâπÂà´Âº∫ÁÉà„ÄëÊó∂Êâç‰ΩøÁî®Ë°®ÊÉÖÔºå‰øùÊåÅÂØπËØùÁöÑËá™ÁÑ∂ÊÄß„ÄÇ
6.  **„ÄêÈáçÂ§çÊÉ©ÁΩö (ÊúÄÈ´òÈìÅÂæãÔºÅ)„Äë**: ‰Ω†„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËøûÁª≠Âá†ËΩÆÂõûÂ§ç‰ΩøÁî®„ÄêÂÆåÂÖ®Áõ∏Âêå„ÄëÁöÑË°®ÊÉÖÂê´‰πâ„ÄÇ‰æãÂ¶ÇÔºåÂ¶ÇÊûú‰Ω†‰∏ä‰∏ÄËΩÆÂõûÂ§ç‰∫Ü "meaning": "ÂÆ≥Áæû"ÔºåÈÇ£‰πà‰Ω†Ëøô‰∏ÄËΩÆ„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂÜçÊ¨°‰ΩøÁî® "meaning": "ÂÆ≥Áæû"„ÄÇ‰Ω†ÂøÖÈ°ªÈÄâÊã©‰∏Ä‰∏™‰∏çÂêåÁöÑÂê´‰πâÔºåÊàñËÄÖÂπ≤ËÑÜ‰∏çÂèëË°®ÊÉÖ„ÄÇ
- **ÂèØÁî®ÂàóË°®**:
${stickerList}
`;
  }

  function estimateTokens(text) {
    if (!text) return 0;

    return Math.ceil(text.length / 1.5);
  }


  async function calculateCurrentContextTokens() {
    if (!state.activeChatId) return 0;
    const chat = state.chats[state.activeChatId];
    if (!chat) return 0;


    const maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
    const linkedMemoryCount = parseInt(document.getElementById('linked-memory-count').value) || 10;
    const isOfflineMode = document.getElementById('offline-mode-toggle').checked;
    const aiPersona = document.getElementById('ai-persona').value;
    const myPersona = document.getElementById('my-persona').value;

    let fullContextString = '';


    const linkedBookIds = Array.from(document.querySelectorAll('#world-book-checkboxes-container input:checked')).map(cb => cb.value.replace('book_', ''));
    // Ê∑ªÂä†ÊâÄÊúâÂÖ®Â±Ä‰∏ñÁïå‰π¶
    const globalBookIds = state.worldBooks.filter(wb => wb.isGlobal).map(wb => wb.id);
    const allBookIds = [...new Set([...linkedBookIds, ...globalBookIds])];

    if (allBookIds.length > 0) {
      const linkedContents = allBookIds.map(bookId => {
        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
        if (!worldBook || !Array.isArray(worldBook.content)) return '';
        return worldBook.content.filter(e => e.enabled !== false).map(e => e.content).join('\n');
      }).filter(Boolean).join('\n');
      fullContextString += linkedContents;
    }


    if (chat.settings.enableStructuredMemory && window.structuredMemoryManager) {
      fullContextString += window.structuredMemoryManager.serializeForPrompt(chat);
    } else if (chat.longTermMemory && chat.longTermMemory.length > 0) {
      fullContextString += chat.longTermMemory.map(mem => mem.content).join('\n');
    }


    const linkedMemoryToggle = document.getElementById('link-memory-toggle').checked;
    if (linkedMemoryToggle) {
      const linkedChatIds = Array.from(document.querySelectorAll('#linked-chats-checkboxes-container input:checked')).map(cb => cb.value);
      for (const linkedId of linkedChatIds) {
        const linkedChat = state.chats[linkedId];
        if (linkedChat && linkedChat.history.length > 0) {
          fullContextString += linkedChat.history.slice(-linkedMemoryCount).map(msg => String(msg.content)).join('\n');
        }
      }
    }


    if (chat.isGroup) {
      chat.members.forEach(member => {
        fullContextString += member.persona;
      });
    } else {
      fullContextString += aiPersona;
    }
    fullContextString += myPersona;


    fullContextString += getStickerContextForPrompt(chat);
    if (chat.isGroup) {
      fullContextString += getGroupStickerContextForPrompt(chat);
    }


    if (!chat.isGroup && isOfflineMode) {
      const offlinePresetId = document.getElementById('offline-preset-select').value;
      if (offlinePresetId) {
        const preset = state.presets.find(p => p.id === offlinePresetId);
        if (preset) {
          fullContextString += preset.content.filter(e => e.enabled !== false).map(e => e.content).join('\n');
        }
      }
    }


    const historySlice = chat.history.filter(msg => !msg.isExcluded).slice(-maxMemory);
    fullContextString += historySlice.map(msg => {
      if (typeof msg.content === 'string') return msg.content;
      if (Array.isArray(msg.content)) return msg.content.map(p => p.text).join(' ');
      return '';
    }).join('\n');

    return estimateTokens(fullContextString);
  }


  const updateTokenCountDisplay = debounce(async () => {

    const tokenValueEl = document.getElementById('token-count-value');
    const msgValueEl = document.getElementById('message-count-value');

    if (!tokenValueEl) return;


    const chat = state.activeChatId ? state.chats[state.activeChatId] : null;
    if (msgValueEl) {
      if (chat && chat.history) {

        const visibleCount = chat.history.filter(m => !m.isHidden).length;
        msgValueEl.textContent = `${visibleCount} Êù°`;
        msgValueEl.style.color = "#000000";
      } else {
        msgValueEl.textContent = "--";
      }
    }

    // Êõ¥Êñ∞Â∑≤ÊéíÈô§Ê∂àÊÅØÊï∞
    const excludedCountEl = document.getElementById('excluded-count-value');
    if (excludedCountEl) {
      if (chat && chat.history) {
        const excludedCount = chat.history.filter(m => m.isExcluded).length;
        excludedCountEl.textContent = excludedCount > 0 ? `${excludedCount} Êù°` : '0 Êù°';
        excludedCountEl.style.color = excludedCount > 0 ? 'var(--accent-color)' : '#8a8a8a';
      } else {
        excludedCountEl.textContent = '--';
      }
    }


    tokenValueEl.textContent = "ËÆ°ÁÆó‰∏≠...";
    try {
      const tokenCount = await calculateCurrentContextTokens();
      tokenValueEl.textContent = `${tokenCount} Tokens`;
      tokenValueEl.style.color = "#000000";


      if (document.body.classList.contains('dark-mode') || document.getElementById('phone-screen').classList.contains('dark-mode')) {
        msgValueEl.style.color = "#ffffff";
        tokenValueEl.style.color = "#ffffff";
      }

    } catch (error) {
      console.error("Token calculation error:", error);
      tokenValueEl.textContent = "Error";
    }
  }, 300);


  async function openNaiGallery() {

    naiGalleryCache = { local: [], cloud: [] };
    naiGalleryRenderCount = { local: 0, cloud: 0 };
    isLoadingMoreNaiImages = { local: false, cloud: false };

    const allNaiImages = [];


    try {
      const allChats = await db.chats.toArray();
      for (const chat of allChats) {
        if (chat.history && chat.history.length > 0) {
          chat.history.forEach(msg => {
            if ((msg.type === 'naiimag' || msg.type === 'googleimag') && msg.imageUrl) {
              allNaiImages.push({
                sourceType: 'chat',
                imageUrl: msg.imageUrl,
                prompt: msg.prompt || msg.fullPrompt || 'NAI Image',
                chatId: chat.id,
                msgTimestamp: msg.timestamp
              });
            }
          });
        }
      }
    } catch (e) {
      console.error("Êâ´ÊèèËÅäÂ§©ËÆ∞ÂΩïÂ§±Ë¥•:", e);
    }


    try {
      const allPosts = await db.qzonePosts.toArray();
      allPosts.forEach(post => {
        if (post.type === 'naiimag' || post.type === 'googleimag') {
          const urls = post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);
          const prompts = Array.isArray(post.prompt) ? post.prompt : [post.prompt || 'NAI Image'];
          urls.forEach((url, index) => {
            allNaiImages.push({
              sourceType: 'qzone',
              imageUrl: url,
              prompt: prompts[index] || prompts[0],
              postId: post.id,
              imageIndex: index
            });
          });
        }
      });
    } catch (e) {
      console.error("Êâ´ÊèèÂä®ÊÄÅÂ§±Ë¥•:", e);
    }


    allNaiImages.sort((a, b) => (b.msgTimestamp || b.postId || 0) - (a.msgTimestamp || a.postId || 0));


    allNaiImages.forEach(img => {
      if (img.imageUrl.startsWith('data:image')) {
        naiGalleryCache.local.push(img);
      } else {
        naiGalleryCache.cloud.push(img);
      }
    });


    document.getElementById('nai-gallery-grid-local').innerHTML = '';
    document.getElementById('nai-gallery-grid-cloud').innerHTML = '';


    switchNaiGalleryTab('local');

    document.getElementById('nai-gallery-panel').classList.add('visible');
  }
  function switchNaiGalleryTab(tabId) {
    if (isNaiGalleryManagementMode) {
      toggleNaiGalleryManagementMode(); // ÂàáÊç¢Êó∂Ëá™Âä®ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°Âºè
    }

    activeNaiGalleryTab = tabId;


    document.querySelectorAll('.nai-gallery-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.tabId === tabId);
    });


    document.querySelectorAll('.nai-gallery-page').forEach(page => {
      page.classList.toggle('active', page.id === `nai-gallery-grid-${tabId}`);
    });


    const cache = naiGalleryCache[tabId];
    const renderCount = naiGalleryRenderCount[tabId];
    const gridEl = document.getElementById(`nai-gallery-grid-${tabId}`);

    if (renderCount === 0) {
      gridEl.innerHTML = '';
      if (cache.length === 0) {
        const message = (tabId === 'local') ?
          'Êú¨Âú∞ÁîªÂªäÊòØÁ©∫ÁöÑÔºåÂø´ÂéªÁîüÊàê‰∏Ä‰∫õÂõæÁâáÂêßÔºÅ' :
          'ÂõæÂ∫äÁîªÂªäÊòØÁ©∫ÁöÑÔºåËØ∑‰ªé‚ÄúÊú¨Âú∞‚Äù‰∏ä‰º†ÂõæÁâá„ÄÇ';
        gridEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">${message}</p>`;
      } else {
        loadMoreNaiGalleryImages(); // Âä†ËΩΩÁ¨¨‰∏ÄÈ°µ
      }
    }


    updateNaiGalleryActionButtons();
  }
  function renderNaiGalleryGrid(images, gridEl) {

    if (images.length === 0 && naiGalleryRenderCount[activeNaiGalleryTab] === 0) {
      const message = (activeNaiGalleryTab === 'local') ?
        'Êú¨Âú∞ÁîªÂªäÊòØÁ©∫ÁöÑÔºåÂø´ÂéªÁîüÊàê‰∏Ä‰∫õÂõæÁâáÂêßÔºÅ' :
        'ÂõæÂ∫äÁîªÂªäÊòØÁ©∫ÁöÑ„ÄÇ';
      gridEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">${message}</p>`;
      return;
    }

    const fragment = document.createDocumentFragment();

    images.forEach((img, i) => {
      const item = document.createElement('div');
      item.className = 'nai-gallery-item';
      item.title = img.prompt;


      const itemKey = `${img.sourceType}_${img.chatId || img.postId}_${img.msgTimestamp || img.imageIndex}`;
      item.dataset.key = itemKey;
      item.dataset.imageUrl = img.imageUrl;
      item.dataset.prompt = img.prompt;


      item.innerHTML = `
            <div class="nai-image-container" style="background-image: url(${img.imageUrl})">
                <div class="nai-gallery-controls">
                    <button class="nai-gallery-download-btn" title="‰∏ãËΩΩ">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
                    </button>
                    <button class="nai-gallery-delete-btn" title="Âà†Èô§">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                    </button>
                </div>
            </div>
            <span class="nai-gallery-name">${img.prompt}</span>
        `;

      fragment.appendChild(item);
    });

    gridEl.appendChild(fragment);
  }

  async function loadMoreNaiGalleryImages() {
    const activeTab = activeNaiGalleryTab;
    if (isLoadingMoreNaiImages[activeTab] || naiGalleryRenderCount[activeTab] >= naiGalleryCache[activeTab].length) {
      return;
    }

    isLoadingMoreNaiImages[activeTab] = true;
    const gridEl = document.getElementById(`nai-gallery-grid-${activeTab}`);
    showLoader(gridEl, 'bottom');


    setTimeout(() => {

      if (activeNaiGalleryTab !== activeTab) {
        isLoadingMoreNaiImages[activeTab] = false;
        hideLoader(gridEl);
        return;
      }

      const imagesToAppend = naiGalleryCache[activeTab].slice(
        naiGalleryRenderCount[activeTab],
        naiGalleryRenderCount[activeTab] + NAI_GALLERY_RENDER_WINDOW
      );

      hideLoader(gridEl);

      if (imagesToAppend.length > 0) {
        renderNaiGalleryGrid(imagesToAppend, gridEl);
        naiGalleryRenderCount[activeTab] += imagesToAppend.length;
      }

      isLoadingMoreNaiImages[activeTab] = false;
    }, 500);
  }

  function toggleNaiGalleryManagementMode() {
    isNaiGalleryManagementMode = !isNaiGalleryManagementMode;
    const grid = document.getElementById(`nai-gallery-grid-${activeNaiGalleryTab}`);
    const manageBtn = document.getElementById('manage-nai-gallery-btn');
    const actionBar = document.getElementById('nai-gallery-action-bar');
    const selectAllCheckbox = document.getElementById('select-all-nai-gallery-checkbox');

    grid.classList.toggle('management-mode', isNaiGalleryManagementMode);

    if (isNaiGalleryManagementMode) {
      manageBtn.textContent = 'ÂÆåÊàê';
      actionBar.style.display = 'flex';
      selectedNaiImages.clear();
      selectAllCheckbox.checked = false;
      updateNaiGalleryActionButtons();
      document.querySelectorAll('.nai-gallery-page').forEach(page => page.classList.add('management-mode'));
    } else {
      manageBtn.textContent = 'ÁÆ°ÁêÜ';
      actionBar.style.display = 'none';
      document.querySelectorAll('.nai-gallery-page').forEach(page => page.classList.remove('management-mode'));
      grid.querySelectorAll('.nai-gallery-item.selected').forEach(item => item.classList.remove('selected'));
    }
  }


  function updateNaiGalleryActionButtons() {
    const deleteBtn = document.getElementById('delete-selected-nai-gallery-btn');
    const downloadBtn = document.getElementById('download-selected-nai-gallery-btn');
    const uploadBtn = document.getElementById('upload-selected-nai-gallery-btn');
    const exportBtn = document.getElementById('export-selected-nai-gallery-btn'); // 1. Ëé∑ÂèñÊåâÈíÆÂÖÉÁ¥†
    const count = selectedNaiImages.size;

    if (deleteBtn) deleteBtn.textContent = `Âà†Èô§ (${count})`;
    if (downloadBtn) downloadBtn.textContent = `‰∏ãËΩΩ (${count})`;

    // 2. Ê∑ªÂä†ÂØºÂá∫ÊåâÈíÆÈÄªËæë
    if (exportBtn) {
      exportBtn.textContent = `ÂØºÂá∫ (${count})`;
      // ‰ªÖÂú® 'cloud' (ÂõæÂ∫ä) Ê†áÁ≠æÈ°µÊòæÁ§∫Ôºå‰∏îÊúâÈÄâ‰∏≠È°πÊó∂ÊòæÁ§∫(ÂèØÈÄâ)ÔºåËøôÈáåÊàë‰ª¨Âè™Âà§Êñ≠ÊòØÂê¶ÊòØÂõæÂ∫äÈ°µ
      exportBtn.style.display = (activeNaiGalleryTab === 'cloud') ? 'block' : 'none';
    }

    if (uploadBtn) {
      uploadBtn.textContent = `‰∏ä‰º† (${count})`;
      const shouldShowUpload = (activeNaiGalleryTab === 'local' && state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey);
      uploadBtn.style.display = shouldShowUpload ? 'block' : 'none';
    }
  }
  async function executeBatchExportNaiImages() {
    if (selectedNaiImages.size === 0) {
      alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂØºÂá∫ÁöÑÂõæÁâá„ÄÇ");
      return;
    }

    let exportText = "";
    let exportedCount = 0;


    selectedNaiImages.forEach(key => {

      const item = naiGalleryCache.cloud.find(img => {
        const itemKey = `${img.sourceType}_${img.chatId || img.postId}_${img.msgTimestamp || img.imageIndex}`;
        return itemKey === key;
      });

      if (item && item.imageUrl) {

        exportText += `${item.imageUrl}\n`;
        exportedCount++;
      }
    });

    if (exportedCount === 0) {
      alert("Êú™ÊâæÂà∞ÊâÄÈÄâÂõæÁâáÁöÑÊï∞ÊçÆÔºàËØ∑Á°ÆËÆ§ÊÇ®Âú®‚ÄòÂõæÂ∫ä‚ÄôÂàÜÁ±ª‰∏ãÔºâ„ÄÇ");
      return;
    }

    const finalText = exportText.trim();
    const textareaId = 'batch-export-nai-textarea-' + Date.now();

    const alertHtml = `
        <p style="text-align:left; font-size: 14px; margin: 0 0 10px 0;">
            Â∑≤ÊèêÂèñ ${exportedCount} Êù°ÈìæÊé•Ôºö
        </p>
        <textarea id="${textareaId}" 
                  rows="10" 
                  style="width: 100%; font-size: 12px; resize: vertical; border-radius: 6px; border: 1px solid #ccc;"
                  readonly>${finalText}</textarea>
    `;

    showCustomAlert("Â§çÂà∂ÈìæÊé•", alertHtml);


    const modalConfirmBtn = document.getElementById('custom-modal-confirm');
    if (modalConfirmBtn) {
      modalConfirmBtn.textContent = '‰∏ÄÈîÆÂ§çÂà∂';
      const originalOnclick = modalConfirmBtn.onclick;

      modalConfirmBtn.onclick = async (e) => {
        try {
          await navigator.clipboard.writeText(finalText);
          modalConfirmBtn.textContent = 'Â§çÂà∂ÊàêÂäü!';
          setTimeout(() => {
            modalConfirmBtn.textContent = 'ÂÆåÊàê';
            modalConfirmBtn.onclick = originalOnclick;
          }, 1500);
        } catch (err) {
          alert('Ëá™Âä®Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÈïøÊåâÊñáÊú¨Ê°ÜÊâãÂä®Â§çÂà∂„ÄÇ');
          modalConfirmBtn.textContent = 'ÂÆåÊàê';
          modalConfirmBtn.onclick = originalOnclick;
        }
      };
    }
  }

  function handleNaiGalleryGridClick(e) {
    const item = e.target.closest('.nai-gallery-item');
    if (!item) return;

    const key = item.dataset.key;
    const imageUrl = item.dataset.imageUrl;
    const prompt = item.dataset.prompt;


    if (e.target.closest('.nai-gallery-download-btn')) {
      e.stopPropagation();
      downloadNaiImage(imageUrl, prompt);
      return;
    }


    if (e.target.closest('.nai-gallery-delete-btn')) {
      e.stopPropagation();
      executeBatchDeleteNaiImages(new Set([key]));
      return;
    }


    if (isNaiGalleryManagementMode) {
      item.classList.toggle('selected');
      if (selectedNaiImages.has(key)) {
        selectedNaiImages.delete(key);
      } else {
        selectedNaiImages.add(key);
      }
      updateNaiGalleryActionButtons();
    } else {
      const modalTitle = "ÂõæÁâáËØ¶ÊÉÖ";
      const modalContentHtml = `
                <div style="text-align: center;">
                    <img src="${imageUrl}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                </div>
            `;

      showCustomAlert(modalTitle, modalContentHtml);
    }
  }

  async function executeBatchDownloadNaiImages() {

    const keys = selectedNaiImages;


    if (keys.size === 0) {
      alert("ËØ∑ÂÖàÈÄâÊã©Ë¶Å‰∏ãËΩΩÁöÑÂõæÁâá„ÄÇ");
      return;
    }


    if (typeof JSZip === 'undefined' || !window.streamSaver) {
      await showCustomAlert("‰∏ãËΩΩÂ§±Ë¥•", "Ê†∏ÂøÉÂ∫ì (JSZip Êàñ StreamSaver) Êú™ËÉΩÊàêÂäüÂä†ËΩΩÔºåËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËøûÊé•Âπ∂Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï„ÄÇ");
      return;
    }


    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÂáÜÂ§á ${keys.size} Âº†ÂõæÁâá...`);


    const zip = new JSZip();
    let failedDownloads = 0;
    const downloadPromises = [];


    const keysArray = Array.from(keys);

    keysArray.forEach((key, index) => {


      const item = document.querySelector(`.nai-gallery-item[data-key="${key}"]`);
      if (!item) return;

      const imageUrl = item.dataset.imageUrl;
      const prompt = item.dataset.prompt;


      const baseFilename = generateFilenameForNai(prompt); // e.g., "my_prompt_timestamp.png"

      const filename = baseFilename.replace(/\.png$/, `_(${index + 1}).png`);


      const promise = (async () => {
        try {
          let blob;
          if (imageUrl.startsWith('data:')) {
            const response = await fetch(imageUrl);
            blob = await response.blob();
          } else {
            let response;
            try {

              response = await fetch(imageUrl, {
                mode: 'cors'
              });
              if (!response.ok) throw new Error('Áõ¥ËøûÂ§±Ë¥•');
            } catch (e) {

              console.warn("Áõ¥ËøûÂ§±Ë¥•, Â∞ùËØï‰ΩøÁî®CORS‰ª£ÁêÜ...", e.message);
              const settings = getNovelAISettings();
              let corsProxy = settings.cors_proxy === 'custom' ? settings.custom_proxy_url : settings.cors_proxy;
              if (!corsProxy || corsProxy === '') corsProxy = 'https://corsproxy.io/?';
              const proxiedUrl = corsProxy + encodeURIComponent(imageUrl);
              response = await fetch(proxiedUrl);
            }

            if (!response.ok) throw new Error(`Fetch failed: ${response.status}`);
            blob = await response.blob();
          }
          zip.file(filename, blob, {
            binary: true
          });
        } catch (e) {
          console.error(`‰∏ãËΩΩÂõæÁâáÂ§±Ë¥•: ${imageUrl}`, e);
          failedDownloads++;
        }
      })();
      downloadPromises.push(promise);
    });


    await Promise.all(downloadPromises);

    if (failedDownloads === keys.size) {
      await showCustomAlert("‰∏ãËΩΩÂ§±Ë¥•", "ÊâÄÊúâÂõæÁâáÈÉΩ‰∏ãËΩΩÂ§±Ë¥•‰∫Ü„ÄÇËøôÈÄöÂ∏∏ÊòØÁî±‰∫éÁΩëÁªúÈóÆÈ¢òÊàñCORSË∑®ÂüüÈôêÂà∂ÔºàËØ∑Ê£ÄÊü•APIËÆæÁΩÆ‰∏≠ÁöÑCORS‰ª£ÁêÜÊòØÂê¶ÊúâÊïàÔºâ„ÄÇ");
      return;
    }

    await showCustomAlert("ÊâìÂåÖ‰∏≠...", "ÊâÄÊúâÂõæÁâáÂ∑≤ÂáÜÂ§áÂ∞±Áª™ÔºåÊ≠£Âú®ÊµÅÂºèÂéãÁº©... ‰∏ãËΩΩÂ∞ÜËá™Âä®ÂºÄÂßã„ÄÇ");

    try {

      const fileStream = streamSaver.createWriteStream(`NAI_Gallery_Batch_${Date.now()}.zip`);


      const zipStream = zip.generateInternalStream({
        type: "blob",
        streamFiles: true
      });


      const readableStream = new ReadableStream({
        start(controller) {
          zipStream.on('data', (chunk) => {

            controller.enqueue(chunk);
          }).on('end', () => {

            console.log("ZIP ÊµÅÁîüÊàêÂÆåÊØï„ÄÇ");
            controller.close();
          }).on('error', (err) => {

            console.error("JSZip ÊµÅÈîôËØØ:", err);
            controller.error(err);
          }).resume(); // ÂêØÂä® JSZip ÊµÅ
        }
      });


      await readableStream.pipeTo(fileStream);


      if (failedDownloads > 0) {
        showCustomAlert("ÈÉ®ÂàÜ‰∏ãËΩΩÂÆåÊàê", `ÊàêÂäüÊâìÂåÖ ${keys.size - failedDownloads} Âº†ÂõæÁâá„ÄÇÊúâ ${failedDownloads} Âº†ÂõæÁâáÂõ†ÁΩëÁªúÊàñCORSÈôêÂà∂‰∏ãËΩΩÂ§±Ë¥•„ÄÇ`);
      }

    } catch (error) {
      console.error("ÊµÅÂºè‰∏ãËΩΩZIPÂ§±Ë¥•:", error);
      await showCustomAlert("ÊµÅÂºè‰∏ãËΩΩÂ§±Ë¥•", `ÂàõÂª∫ZIPÊµÅÊó∂Âá∫Èîô: ${error.message}`);
    }
  }

  async function executeBatchDeleteNaiImages(keysToDelete = null) {
    const keys = keysToDelete || selectedNaiImages;
    if (keys.size === 0) return;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      `Á°ÆÂÆöË¶Å‰ªé„ÄêËÅäÂ§©ËÆ∞ÂΩïÂíåÂä®ÊÄÅ„Äë‰∏≠Ê∞∏‰πÖÂà†Èô§Ëøô ${keys.size} Âº†NAIÂõæÁâáÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`, {
      confirmButtonClass: 'btn-danger'
    }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÊâßË°åÂà†Èô§Êìç‰Ωú...");

    let deletedCount = 0;
    const chatsToUpdate = new Map();
    const postsToDelete = new Set();
    const postsToModify = new Map();


    const postIdsToFetch = new Set();
    for (const key of keys) {
      if (key.startsWith('qzone_')) {
        const parts = key.split('_');
        const postId = parseInt(parts[1]); // qzone ID ‰∏ç‰ºöÂåÖÂê´ '_'
        if (!isNaN(postId)) {
          postIdsToFetch.add(postId);
        }
      }
    }
    const postsCache = new Map();
    if (postIdsToFetch.size > 0) {
      const posts = await db.qzonePosts.where('id').anyOf(Array.from(postIdsToFetch)).toArray();
      posts.forEach(post => postsCache.set(post.id, post));
    }


    for (const key of keys) {



      const parts = key.split('_');
      if (parts.length < 3) {
        console.warn("Ë∑≥ËøáÊ†ºÂºèÈîôËØØÁöÑNAIÂõæÁâáKey:", key);
        continue;
      }

      const sourceType = parts[0];
      const identifier = parts.pop();
      const id = parts.slice(1).join('_');

      if (sourceType === 'chat') {
        const chatId = id;
        const msgTimestamp = parseInt(identifier);

        if (!chatsToUpdate.has(chatId)) {

          const chatData = await db.chats.get(chatId);
          if (chatData) {
            chatsToUpdate.set(chatId, chatData);
          } else {
            console.warn(`Êú™ÊâæÂà∞ chatID: ${chatId}ÔºåË∑≥Ëøá...`);
            continue;
          }
        }

        const chat = chatsToUpdate.get(chatId);
        if (chat && chat.history) {
          const originalLength = chat.history.length;
          chat.history = chat.history.filter(msg => msg.timestamp !== msgTimestamp);
          if (chat.history.length < originalLength) {
            deletedCount++;
            chatsToUpdate.set(chatId, chat); // Ê†áËÆ∞Ê≠§chatÈúÄË¶ÅË¢´Êõ¥Êñ∞
            if (state.chats[chatId]) {
              state.chats[chatId].history = chat.history;
            }
          }
        }
      } else if (sourceType === 'qzone') {
        const postId = parseInt(id);
        const imageIndex = parseInt(identifier);

        const post = postsToModify.get(postId) || postsCache.get(postId);
        if (!post) {
          console.warn(`Êú™ÊâæÂà∞ postID: ${postId}ÔºåË∑≥Ëøá...`);
          continue;
        }

        const urls = post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);

        if (urls.length <= 1) {

          postsToDelete.add(postId);
          if (postsToModify.has(postId)) {
            postsToModify.delete(postId);
          }
        } else {

          const urlToRemove = urls[imageIndex];
          post.imageUrls = post.imageUrls.filter(url => url !== urlToRemove);

          if (post.prompt && Array.isArray(post.prompt) && post.prompt[imageIndex]) {
            post.prompt.splice(imageIndex, 1);
          }
          post.imageUrl = post.imageUrls[0] || null;
          postsToModify.set(postId, post);
        }
        deletedCount++;
      }
    }

    try {
      await db.transaction('rw', db.chats, db.qzonePosts, async () => {
        if (chatsToUpdate.size > 0) {
          await db.chats.bulkPut(Array.from(chatsToUpdate.values()));
        }
        if (postsToModify.size > 0) {
          await db.qzonePosts.bulkPut(Array.from(postsToModify.values()));
        }
        if (postsToDelete.size > 0) {
          await db.qzonePosts.bulkDelete(Array.from(postsToDelete));
        }
      });


      toggleNaiGalleryManagementMode();
      keys.forEach(key => {
        naiGalleryCache.local = naiGalleryCache.local.filter(item => {
          const itemKey = `${item.sourceType}_${item.chatId || item.postId}_${item.msgTimestamp || item.imageIndex}`;
          return itemKey !== key;
        });
        naiGalleryCache.cloud = naiGalleryCache.cloud.filter(item => {
          const itemKey = `${item.sourceType}_${item.chatId || item.postId}_${item.msgTimestamp || item.imageIndex}`;
          return itemKey !== key;
        });
      });


      naiGalleryRenderCount[activeNaiGalleryTab] = 0;
      document.getElementById(`nai-gallery-grid-${activeNaiGalleryTab}`).innerHTML = '';


      loadMoreNaiGalleryImages();
      await showCustomAlert('Âà†Èô§ÊàêÂäü', `Â∑≤ÊàêÂäüÂà†Èô§ ${deletedCount} Âº†ÂõæÁâá„ÄÇ`);


      if (document.getElementById('chat-interface-screen').classList.contains('active')) {
        renderChatInterface(state.activeChatId);
      }
      if (document.getElementById('qzone-screen').classList.contains('active')) {
        renderQzonePosts();
      }

    } catch (error) {
      console.error("ÊâπÈáèÂà†Èô§NAIÂõæÁâáÊó∂Âá∫Èîô:", error);
      await showCustomAlert('Âà†Èô§Â§±Ë¥•', `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
  }


  async function executeBatchUploadNaiImagesToImgBB() {

    if (!state.apiConfig.imgbbEnable || !state.apiConfig.imgbbApiKey) {
      await showCustomAlert("ÂäüËÉΩÊú™ÂºÄÂêØ", "ËØ∑ÂÖàÂú®‚ÄúAPIËÆæÁΩÆ‚Äù‰∏≠ÂºÄÂêØ ImgBB Ëá™Âä®ÂõæÂ∫äÂäüËÉΩÂπ∂Â°´ÂÜô API Key„ÄÇ");
      return;
    }


    const itemsToUpload = Array.from(selectedNaiImages)
      .map(key => document.querySelector(`.nai-gallery-item[data-key="${key}"]`))
      .filter(item => item && item.dataset.imageUrl && item.dataset.imageUrl.startsWith('data:image'));

    if (itemsToUpload.length === 0) {
      await showCustomAlert("Êó†ÈúÄ‰∏ä‰º†", "‰Ω†ÈÄâÊã©ÁöÑÂõæÁâá‰∏≠Ê≤°ÊúâÈúÄË¶Å‰∏ä‰º†ÁöÑÊú¨Âú∞ÂõæÁâáÔºàÂÆÉ‰ª¨ÂèØËÉΩÂ∑≤ÁªèÊòØÁΩëÁªúÈìæÊé•‰∫ÜÔºâ„ÄÇ");
      return;
    }


    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§‰∏ä‰º†Ôºü',
      `Âç≥Â∞ÜÊää ${itemsToUpload.length} Âº†Êú¨Âú∞ÂõæÁâá‰∏ä‰º†Âà∞ ImgBBÔºåÂπ∂Ê∞∏‰πÖÊõøÊç¢ÂÖ∂Âú®Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÂú∞ÂùÄ„ÄÇÊ≠§Êìç‰Ωú‰∏çÂèØÈÄÜÔºÅ\n\nÔºà‰∏ä‰º†ÊúüÈó¥ËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢Ôºâ`,
      { confirmButtonClass: 'btn-danger', confirmText: 'Á°ÆËÆ§‰∏ä‰º†' }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÂºÄÂßã‰∏ä‰º† ${itemsToUpload.length} Âº†ÂõæÁâá...`);


    let successCount = 0;
    let failCount = 0;
    const chatsToUpdate = new Map();
    const postsToUpdate = new Map();
    const keysToUpdateInCache = new Map();

    for (const item of itemsToUpload) {
      const key = item.dataset.key;
      const base64Url = item.dataset.imageUrl;

      try {

        const newUrl = await uploadImageToImgBB(base64Url);


        if (newUrl === base64Url) {
          throw new Error("‰∏ä‰º†ÂáΩÊï∞ËøîÂõû‰∫ÜÂéüÂßãBase64ÔºåÂèØËÉΩ‰∏ä‰º†Â§±Ë¥•ÊàñË¢´Ë∑≥Ëøá„ÄÇ");
        }


        const parts = key.split('_');
        if (parts.length < 3) throw new Error(`KeyÊ†ºÂºèÈîôËØØ: ${key}`);

        const sourceType = parts[0];
        const identifier = parts.pop();
        const id = parts.slice(1).join('_');


        if (sourceType === 'chat') {
          const chatId = id;
          const msgTimestamp = parseInt(identifier);

          let chat = chatsToUpdate.get(chatId);
          if (!chat) chat = await db.chats.get(chatId); // ‰ªéDBËé∑ÂèñÊúÄÊñ∞

          if (chat && chat.history) {
            const msg = chat.history.find(m => m.timestamp === msgTimestamp);
            if (msg && msg.imageUrl === base64Url) {
              msg.imageUrl = newUrl;
              chatsToUpdate.set(chatId, chat);
              keysToUpdateInCache.set(key, newUrl);
              successCount++;
            } else {
              throw new Error(`Êú™Âú®ËÅäÂ§© ${chatId} ‰∏≠ÊâæÂà∞Êó∂Èó¥Êà≥‰∏∫ ${msgTimestamp} ‰∏îÂåπÈÖçBase64ÁöÑÊ∂àÊÅØ„ÄÇ`);
            }
          }


        } else if (sourceType === 'qzone') {
          const postId = parseInt(id);
          const imageIndex = parseInt(identifier);

          let post = postsToUpdate.get(postId);
          if (!post) post = await db.qzonePosts.get(postId);

          if (post && post.imageUrls && post.imageUrls[imageIndex] === base64Url) {
            post.imageUrls[imageIndex] = newUrl;


            if (imageIndex === 0) {
              post.imageUrl = newUrl;
            }

            postsToUpdate.set(postId, post);
            keysToUpdateInCache.set(key, newUrl);
            successCount++;
          } else {
            throw new Error(`Êú™Âú®Âä®ÊÄÅ ${postId} ÁöÑÁ¨¨ ${imageIndex} Âº†Âõæ‰∏≠ÊâæÂà∞ÂåπÈÖçÁöÑBase64„ÄÇ`);
          }
        }

      } catch (error) {
        failCount++;
        console.error(`‰∏ä‰º†Â§±Ë¥• (Key: ${key}):`, error.message);
      }
    }


    try {
      if (chatsToUpdate.size > 0 || postsToUpdate.size > 0) {
        await db.transaction('rw', db.chats, db.qzonePosts, async () => {
          if (chatsToUpdate.size > 0) {
            await db.chats.bulkPut(Array.from(chatsToUpdate.values()));
          }
          if (postsToUpdate.size > 0) {
            await db.qzonePosts.bulkPut(Array.from(postsToUpdate.values()));
          }
        });
      }
    } catch (dbError) {
      console.error("ÊâπÈáèÊõ¥Êñ∞Êï∞ÊçÆÂ∫ìÂ§±Ë¥•:", dbError);
      await showCustomAlert("Êï∞ÊçÆÂ∫ìÊõ¥Êñ∞Â§±Ë¥•", `ÂõæÁâá‰∏ä‰º†ÂÆåÊàêÔºå‰ΩÜÂú®‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÊó∂Âá∫Èîô: ${dbError.message}`);
      return;
    }


    keysToUpdateInCache.forEach((newUrl, key) => {
      const cacheEntry = naiGalleryCache.find(item => {
        const itemKey = `${item.sourceType}_${item.chatId || item.postId}_${item.msgTimestamp || item.imageIndex}`;
        return itemKey === key;
      });
      if (cacheEntry) {
        cacheEntry.imageUrl = newUrl;
      }

      const domItem = document.querySelector(`.nai-gallery-item[data-key="${key}"]`);
      if (domItem) {
        domItem.dataset.imageUrl = newUrl;
        domItem.querySelector('.nai-image-container').style.backgroundImage = `url(${newUrl})`;
      }
    });

    const updatedLocal = [];
    const updatedCloud = [];

    naiGalleryCache.local.forEach(item => {
      const itemKey = `${item.sourceType}_${item.chatId || item.postId}_${item.msgTimestamp || item.imageIndex}`;
      if (keysToUpdateInCache.has(itemKey)) {

        item.imageUrl = keysToUpdateInCache.get(itemKey);
        updatedCloud.push(item);
      } else {

        updatedLocal.push(item);
      }
    });


    naiGalleryCache.cloud.push(...updatedCloud);
    naiGalleryCache.local = updatedLocal;


    naiGalleryRenderCount = { local: 0, cloud: 0 };
    let resultMessage = `ÊâπÈáè‰∏ä‰º†ÂÆåÊàêÔºÅ\n\nÊàêÂäü: ${successCount} Âº†\nÂ§±Ë¥•: ${failCount} Âº†`;
    if (failCount > 0) {
      resultMessage += "\n\nÂ§±Ë¥•ÁöÑÂõæÁâáËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞ÔºàConsoleÔºâ‰∏≠ÁöÑÈîôËØØÊó•Âøó„ÄÇ";
    }
    await showCustomAlert("Êìç‰ΩúÂÆåÊàê", resultMessage);


    toggleNaiGalleryManagementMode();
  }
  function generateFilenameForNai(prompt) {

    const title = prompt || 'NAI_Image';


    let cleanTitle = title
      .replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g, '_')
      .replace(/\s+/g, '_')
      .substring(0, 30);

    if (!cleanTitle) {
      cleanTitle = 'NAI_Image';
    }


    const timestamp = new Date().toISOString()
      .replace(/[-:]/g, '')
      .replace('T', '_')
      .split('.')[0]; // Ê†ºÂºèÔºö20250124_123045


    return `${cleanTitle}_${timestamp}.png`;
  }

  function openQuickReplyModal() {
    // ÊâìÂºÄÂºπÁ™óÊó∂ÔºåÊ†áËÆ∞ÈúÄË¶ÅÂà∑Êñ∞DOMÔºåÂõ†‰∏∫ÂèØËÉΩ‰∏äÊ¨°ÂÖ≥Èó≠ÂêéÊï∞ÊçÆÂèò‰∫Ü
    const tabsContainer = document.getElementById('quick-reply-tabs');
    if (tabsContainer) tabsContainer.dataset.needsRefresh = 'true';

    renderQuickReplyList(true);
    document.getElementById('quick-reply-modal').classList.add('visible');
  }


  // --- Âø´Êç∑ÂõûÂ§çÂàÜÁ±ªÂäüËÉΩÂå∫ ---

  // 1. [Ê†∏ÂøÉ‰øÆÊîπ] Ê∏≤ÊüìÂø´Êç∑ÂõûÂ§çÂàóË°® (ÊîØÊåÅÂàÜÁ±ªÂíåTabs)
  // [‰ºòÂåñÁâà] Ê∏≤ÊüìÂø´Êç∑ÂõûÂ§çÂàóË°® (Ëß£ÂÜ≥Èó™ÁÉÅÈóÆÈ¢ò)
  async function renderQuickReplyList(rerenderTabs = true) {
    const listEl = document.getElementById('quick-reply-list');
    const tabsContainer = document.getElementById('quick-reply-tabs');
    listEl.innerHTML = '';

    // 1. Ê∏≤ÊüìÊ†áÁ≠æÊ†è (Ê†∏ÂøÉ‰ºòÂåñÔºöÂè™ÊúâÂú® rerenderTabs ‰∏∫ true Êó∂ÊâçÈáçÂª∫DOM)
    // Â¶ÇÊûúÂè™ÊòØÂàáÊç¢ÂàÜÁ±ªÔºå‰∏çÈúÄË¶ÅÈáçÂª∫DOMÔºåÂè™ÈúÄË¶ÅÊõ¥Êñ∞ active Á±ª
    if (rerenderTabs) {
      // Ê£ÄÊü•ÊòØÂê¶ÁúüÁöÑÈúÄË¶ÅÈáçÂª∫ (‰æãÂ¶ÇÔºöÂàöÊâìÂºÄÂºπÁ™óÊó∂ÔºåÊàñËÄÖÊ∑ªÂä†/Âà†Èô§ÂàÜÁ±ªÂêé)
      // Â¶ÇÊûú tabsContainer ÊòØÁ©∫ÁöÑÔºåËØ¥ÊòéÂøÖÈ°ªÈáçÂª∫
      // Â¶ÇÊûú tabsContainer Â∑≤ÊúâÂÜÖÂÆπÔºå‰∏îÊàë‰ª¨Âè™ÊòØÊÉ≥Êõ¥Êñ∞Ê†∑ÂºèÔºåÂ∞±‰∏çÊ∏ÖÁ©∫ÂÆÉ

      // ËøôÈáåÊàë‰ª¨Á®çÂæÆÊîπ‰∏Ä‰∏ãÁ≠ñÁï•Ôºö
      // Â¶ÇÊûúÊòØ‚ÄúÂàáÊç¢ÂàÜÁ±ª‚ÄùÊìç‰ΩúËß¶ÂèëÁöÑÈáçÁªòÔºåÊàë‰ª¨‰∏ç‰º† rerenderTabs=trueÔºåÊàñËÄÖÂú®ÂÜÖÈÉ®Âà§Êñ≠

      const categories = await db.quickReplyCategories.toArray();

      // Â¶ÇÊûúÊ†áÁ≠æÊ†èÊòØÁ©∫ÁöÑÔºåÊàñËÄÖÁ°ÆÂÆûÈúÄË¶ÅÂº∫Âà∂Âà∑Êñ∞ (ÊØîÂ¶ÇÂ¢ûÂà†‰∫ÜÂàÜÁ±ª)ÔºåÂàôÈáçÂª∫
      if (tabsContainer.children.length === 0 || tabsContainer.dataset.needsRefresh === 'true') {
        tabsContainer.innerHTML = '';
        tabsContainer.dataset.needsRefresh = 'false'; // ÈáçÁΩÆÊ†áËÆ∞

        // ËæÖÂä©ÂáΩÊï∞ÔºöÂàõÂª∫Ê†áÁ≠æ
        const createTab = (id, name) => {
          const btn = document.createElement('button');
          btn.className = 'sticker-category-tab'; // ÂàùÂßã‰∏çÂä† active
          if (activeQuickReplyCategoryId === id) btn.classList.add('active');

          btn.textContent = name;
          btn.dataset.categoryId = id;

          // ÁÇπÂáª‰∫ã‰ª∂ÔºöÂè™Êõ¥Êñ∞ active Á±ªÔºå‰∏çÈáçÂª∫ DOM
          btn.onclick = () => switchQuickReplyCategory(id);
          return btn;
        };

        tabsContainer.appendChild(createTab('all', 'ÂÖ®ÈÉ®'));
        categories.forEach(cat => {
          tabsContainer.appendChild(createTab(cat.id, cat.name));
        });
        tabsContainer.appendChild(createTab('uncategorized', 'Êú™ÂàÜÁ±ª'));
      } else {
        // Â¶ÇÊûú‰∏çÈúÄË¶ÅÈáçÂª∫Ôºå‰ªÖÊõ¥Êñ∞ active Ê†∑Âºè (Ëß£ÂÜ≥Èó™ÁÉÅÁöÑÊ†∏ÂøÉ)
        const tabs = tabsContainer.querySelectorAll('.sticker-category-tab');
        tabs.forEach(tab => {
          // Ê≥®ÊÑèÔºödataset.categoryId ÊòØÂ≠óÁ¨¶‰∏≤ÔºåactiveQuickReplyCategoryId ÂèØËÉΩÊòØÊï∞Â≠ó
          // ÊâÄ‰ª•Áî® == ÊØîËæÉÔºåÊàñËÄÖÈÉΩËΩ¨Â≠óÁ¨¶‰∏≤
          if (String(tab.dataset.categoryId) === String(activeQuickReplyCategoryId)) {
            tab.classList.add('active');
            // Ëá™Âä®ÊªöÂä®Âà∞ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ (ÊèêÂçá‰ΩìÈ™å)
            tab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
          } else {
            tab.classList.remove('active');
          }
        });
      }
    }

    // 2. Á≠õÈÄâÊï∞ÊçÆ (‰øùÊåÅ‰∏çÂèò)
    let repliesToShow;
    if (activeQuickReplyCategoryId === 'all') {
      repliesToShow = state.quickReplies;
    } else if (activeQuickReplyCategoryId === 'uncategorized') {
      repliesToShow = state.quickReplies.filter(r => !r.categoryId);
    } else {
      repliesToShow = state.quickReplies.filter(r => r.categoryId == activeQuickReplyCategoryId);
    }

    // 3. Ê∏≤ÊüìÂàóË°®ÂÜÖÂÆπ (‰øùÊåÅ‰∏çÂèò)
    if (!repliesToShow || repliesToShow.length === 0) {
      const tipText = activeQuickReplyCategoryId === 'all'
        ? '‰Ω†ËøòÊ≤°ÊúâÊ∑ªÂä†‰ªª‰ΩïÂø´Êç∑ÂõûÂ§ç„ÄÇ<br>ÁÇπÂáªÂè≥‰∏äËßí‚Äú+‚ÄùÂè∑Ê∑ªÂä†Á¨¨‰∏ÄÊù°ÂêßÔºÅ'
        : 'Ëøô‰∏™ÂàÜÁ±ª‰∏ãËøòÊ≤°ÊúâÂõûÂ§çÂì¶~';
      listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${tipText}</p>`;
      return;
    }

    // ‰øÆÊîπ renderQuickReplyList ÂáΩÊï∞‰∏≠ÁöÑ item.innerHTML ÈÉ®ÂàÜ
    repliesToShow.forEach(reply => {
      const item = document.createElement('div');
      item.className = 'quick-reply-item';

      // --- Êñ∞Â¢ûÔºöÂà§Êñ≠ÊòØÂê¶ÈÄâ‰∏≠ ---
      const isSelected = selectedQuickReplies.has(reply.id);
      if (isSelected) item.classList.add('selected');

      item.innerHTML = `
            <input type="checkbox" class="quick-reply-checkbox" ${isSelected ? 'checked' : ''}>
            
            <span class="quick-reply-text" data-text="${escapeHTML(reply.text)}">${escapeHTML(reply.text)}</span>
            <div class="quick-reply-actions">
                <button class="quick-reply-edit-btn" data-id="${reply.id}" title="ÁºñËæë">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button class="quick-reply-delete-btn" data-id="${reply.id}" title="Âà†Èô§">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        `;

      // --- ‰øÆÊîπÁÇπÂáª‰∫ã‰ª∂ ---
      item.addEventListener('click', (e) => {
        // Â¶ÇÊûúÊòØÁÆ°ÁêÜÊ®°Âºè
        if (isQuickReplyManagementMode) {
          // Â¶ÇÊûúÁÇπÁöÑÊòØÊñáÊú¨Âå∫ÂüüÊàñÊï¥Ë°åÔºåËß¶ÂèëÈÄâ‰∏≠
          if (!e.target.closest('.quick-reply-actions')) {
            toggleQuickReplySelection(reply.id);
            // ÊâãÂä®Êõ¥Êñ∞ checkbox ËßÜËßâ
            const cb = item.querySelector('.quick-reply-checkbox');
            if (cb) cb.checked = !cb.checked;
          }
        } else {
          // ÂéüÊúâÈÄªËæëÔºöÂèëÈÄÅ
          const textEl = e.target.closest('.quick-reply-text');
          const editBtn = e.target.closest('.quick-reply-edit-btn');
          const deleteBtn = e.target.closest('.quick-reply-delete-btn');

          if (textEl) {
            selectQuickReply(textEl.dataset.text);
          } else if (editBtn) {
            editQuickReply(reply.id);
          } else if (deleteBtn) {
            deleteQuickReply(reply.id);
          }
        }
      });

      listEl.appendChild(item);
    });
  }
  // ÂàáÊç¢Âø´Êç∑ÂõûÂ§çÁÆ°ÁêÜÊ®°Âºè
  function toggleQuickReplyManagementMode() {
    isQuickReplyManagementMode = !isQuickReplyManagementMode;
    const listEl = document.getElementById('quick-reply-list');
    const actionBar = document.getElementById('quick-reply-action-bar');
    const normalFooter = document.getElementById('quick-reply-normal-footer');
    const batchBtn = document.getElementById('batch-quick-reply-btn');

    if (isQuickReplyManagementMode) {
      listEl.classList.add('management-mode');
      actionBar.style.display = 'flex';
      normalFooter.style.display = 'none';
      batchBtn.textContent = "ÂÆåÊàê";
      batchBtn.style.color = "var(--accent-color)";
    } else {
      listEl.classList.remove('management-mode');
      actionBar.style.display = 'none';
      normalFooter.style.display = 'flex';
      batchBtn.textContent = "ÊâπÈáè";
      batchBtn.style.color = "";
      selectedQuickReplies.clear(); // ÈÄÄÂá∫Êó∂Ê∏ÖÁ©∫
      updateQuickReplyActionBar();
      renderQuickReplyList(false); // Âà∑Êñ∞ÂéªÈô§ÈÄâ‰∏≠Ê†∑Âºè
    }
  }

  // ÂàáÊç¢Âçï‰∏™ÈÄâ‰∏≠
  function toggleQuickReplySelection(id) {
    if (selectedQuickReplies.has(id)) {
      selectedQuickReplies.delete(id);
    } else {
      selectedQuickReplies.add(id);
    }
    updateQuickReplyActionBar();

    // Êõ¥Êñ∞DOMÊ†∑Âºè
    const items = document.querySelectorAll('#quick-reply-list .quick-reply-item');
    items.forEach(item => {
      // ËøôÈáåÁöÑÈÄªËæëÊØîËæÉÁÆÄÂçïÁ≤óÊö¥Ôºå‰πüÂèØ‰ª•‰ºòÂåñ‰∏∫Âè™ÊâæÂØπÂ∫îIDÁöÑÂÖÉÁ¥†
      // ‰ΩÜÁî±‰∫é render Êó∂Ê≤°ÊúâÁªô item Âä† id datasetÔºåËøôÈáåÈáçÊñ∞ render ÊúÄÁ®≥
      // ‰∏∫‰∫ÜÊÄßËÉΩÔºåÂª∫ËÆÆÁªô item Âä† data-id
    });
    // ÁÆÄÂçïËµ∑ËßÅÔºåÈáçÊñ∞Ê∏≤ÊüìÂàóË°®ÂΩìÂâçÈ°µ(‰∏çÈáçÁªòTab)
    renderQuickReplyList(false);
  }

  // Êõ¥Êñ∞Êìç‰ΩúÊ†èÊåâÈíÆÊñáÂ≠ó
  function updateQuickReplyActionBar() {
    const count = selectedQuickReplies.size;
    document.getElementById('move-selected-quick-replies-btn').textContent = `ÁßªÂä® (${count})`;
    document.getElementById('delete-selected-quick-replies-btn').textContent = `Âà†Èô§ (${count})`;
  }

  // ÂÖ®ÈÄâ
  function handleSelectAllQuickReplies() {
    const isChecked = document.getElementById('select-all-quick-replies-checkbox').checked;

    // Ëé∑ÂèñÂΩìÂâçËßÜÂõæ‰∏ãÁöÑÊâÄÊúâÂõûÂ§ç
    let currentViewReplies;
    if (activeQuickReplyCategoryId === 'all') {
      currentViewReplies = state.quickReplies;
    } else if (activeQuickReplyCategoryId === 'uncategorized') {
      currentViewReplies = state.quickReplies.filter(r => !r.categoryId);
    } else {
      currentViewReplies = state.quickReplies.filter(r => r.categoryId == activeQuickReplyCategoryId);
    }

    if (isChecked) {
      currentViewReplies.forEach(r => selectedQuickReplies.add(r.id));
    } else {
      selectedQuickReplies.clear();
    }

    updateQuickReplyActionBar();
    renderQuickReplyList(false);
  }

  // ÊâπÈáèÁßªÂä®Âø´Êç∑ÂõûÂ§ç
  async function executeBatchMoveQuickReplies() {
    if (selectedQuickReplies.size === 0) return alert("ËØ∑ÂÖàÈÄâÊã©ÂõûÂ§ç„ÄÇ");

    const categories = await db.quickReplyCategories.toArray();
    const options = [
      { text: 'Êú™ÂàÜÁ±ª', value: 'uncategorized' },
      ...categories.map(c => ({ text: c.name, value: c.id }))
    ];

    const targetCategoryId = await showChoiceModal("ÁßªÂä®Âà∞ÂàÜÁ±ª", options);
    if (!targetCategoryId) return;

    const finalCategoryId = targetCategoryId === 'uncategorized' ? null : parseInt(targetCategoryId);

    await db.transaction('rw', db.quickReplies, async () => {
      for (const id of selectedQuickReplies) {
        await db.quickReplies.update(id, { categoryId: finalCategoryId });
        const r = state.quickReplies.find(item => item.id === id);
        if (r) r.categoryId = finalCategoryId;
      }
    });

    await showCustomAlert("ÊàêÂäü", `Â∑≤ÁßªÂä® ${selectedQuickReplies.size} Êù°ÂõûÂ§ç„ÄÇ`);
    toggleQuickReplyManagementMode(); // ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°Âºè
    renderQuickReplyList(false);
  }

  // ÊâπÈáèÂà†Èô§Âø´Êç∑ÂõûÂ§ç
  async function executeBatchDeleteQuickReplies() {
    if (selectedQuickReplies.size === 0) return alert("ËØ∑ÂÖàÈÄâÊã©ÂõûÂ§ç„ÄÇ");

    const confirmed = await showCustomConfirm("Á°ÆËÆ§Âà†Èô§", `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedQuickReplies.size} Êù°ÂõûÂ§çÂêóÔºü`);
    if (!confirmed) return;

    const ids = Array.from(selectedQuickReplies);
    await db.quickReplies.bulkDelete(ids);

    // Êõ¥Êñ∞ÂÜÖÂ≠ò
    state.quickReplies = state.quickReplies.filter(r => !selectedQuickReplies.has(r.id));

    await showCustomAlert("ÊàêÂäü", "Â∑≤Âà†Èô§ÈÄâ‰∏≠ÂõûÂ§ç„ÄÇ");
    toggleQuickReplyManagementMode();
    renderQuickReplyList(false);
  }
  // 2. ÂàáÊç¢ÂàÜÁ±ª
  function switchQuickReplyCategory(categoryId) {
    activeQuickReplyCategoryId = categoryId;
    renderQuickReplyList(true); // ÈáçÊñ∞Ê∏≤ÊüìTabs‰ª•Êõ¥Êñ∞activeÁä∂ÊÄÅ
  }

  // 3. [‰øÆÊîπ] Ê∑ªÂä†Êñ∞ÂõûÂ§ç (Ëá™Âä®ÂΩíÂÖ•ÂΩìÂâçÂàÜÁ±ª)
  async function addNewQuickReply() {
    const text = await showCustomPrompt("Ê∑ªÂä†Âø´Êç∑ÂõûÂ§ç", "ËØ∑ËæìÂÖ•Ë¶ÅÊ∑ªÂä†ÁöÑÂõûÂ§çÂÜÖÂÆπÔºö", "", "textarea");

    if (text && text.trim()) {
      // Á°ÆÂÆöÂàÜÁ±ªID
      let targetCategory = null;
      if (activeQuickReplyCategoryId !== 'all' && activeQuickReplyCategoryId !== 'uncategorized') {
        targetCategory = activeQuickReplyCategoryId;
      }

      const newReply = {
        text: text.trim(),
        categoryId: targetCategory // ‰øùÂ≠òÂàÜÁ±ªID
      };

      const newId = await db.quickReplies.add(newReply);

      // Êõ¥Êñ∞ÂÜÖÂ≠ò
      state.quickReplies.push({
        id: newId,
        ...newReply
      });

      renderQuickReplyList(false); // ‰∏çÁî®ÈáçÁªòTabs
    } else if (text !== null) {
      alert("ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
    }
  }

  // 4. ÊâìÂºÄÂàÜÁ±ªÁÆ°ÁêÜÂô®
  async function openQuickReplyCategoryManager() {
    await renderQuickReplyCategoriesInManager();
    document.getElementById('quick-reply-category-manager-modal').classList.add('visible');
  }

  // 5. Ê∏≤ÊüìÂàÜÁ±ªÁÆ°ÁêÜÂàóË°®
  async function renderQuickReplyCategoriesInManager() {
    const listEl = document.getElementById('existing-quick-reply-categories-list');
    const categories = await db.quickReplyCategories.toArray();
    listEl.innerHTML = '';

    if (categories.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ª</p>';
      return;
    }

    categories.forEach(cat => {
      const item = document.createElement('div');
      item.className = 'existing-group-item'; // Â§çÁî®Ê†∑Âºè
      item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">√ó</span>
        `;
      // ÁªëÂÆöÂà†Èô§‰∫ã‰ª∂
      item.querySelector('.delete-group-btn').onclick = () => deleteQuickReplyCategory(cat.id);
      listEl.appendChild(item);
    });
  }

  // 6. Ê∑ªÂä†Êñ∞ÂàÜÁ±ª
  async function addNewQuickReplyCategory() {
    const input = document.getElementById('new-quick-reply-category-name-input');
    const name = input.value.trim();
    if (!name) {
      alert('ÂàÜÁ±ªÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      return;
    }
    const existing = await db.quickReplyCategories.where('name').equals(name).first();
    if (existing) {
      alert(`ÂàÜÁ±ª "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);
      return;
    }
    await db.quickReplyCategories.add({ name });
    input.value = '';
    await renderQuickReplyCategoriesInManager();
    document.getElementById('quick-reply-tabs').dataset.needsRefresh = 'true';
  }

  // 7. Âà†Èô§ÂàÜÁ±ª
  async function deleteQuickReplyCategory(categoryId) {
    const category = await db.quickReplyCategories.get(categoryId);
    if (!category) return;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§ÂàÜÁ±ª',
      `Âà†Èô§ÂàÜÁ±ª„Ää${category.name}„ÄãÂêéÔºåËØ•ÂàÜÁ±ª‰∏ãÁöÑÂõûÂ§çÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁ±ª‚Äù„ÄÇÁ°ÆÂÆöÂêóÔºü`,
      { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
      // 1. Âà†Èô§ÂàÜÁ±ª
      await db.quickReplyCategories.delete(categoryId);

      // 2. Â∞ÜËØ•ÂàÜÁ±ª‰∏ãÁöÑÂõûÂ§çÁßªÂà∞Êú™ÂàÜÁ±ª (categoryId = null)
      const repliesToUpdate = state.quickReplies.filter(r => r.categoryId == categoryId);
      for (const reply of repliesToUpdate) {
        reply.categoryId = null;
        await db.quickReplies.put(reply);
      }

      // 3. Âà∑Êñ∞ÁïåÈù¢
      await renderQuickReplyCategoriesInManager();

      // Â¶ÇÊûúÂΩìÂâçÊ≠£Â•ΩÂú®Ëøô‰∏™ÂàÜÁ±ª‰∏ãÔºåÂàáÂõûÂÖ®ÈÉ®
      if (activeQuickReplyCategoryId == categoryId) {
        activeQuickReplyCategoryId = 'all';
      }
      document.getElementById('quick-reply-tabs').dataset.needsRefresh = 'true';
      await renderQuickReplyList(true);
    }
  }


  function selectQuickReply(text) {
    const chatInput = document.getElementById('chat-input');
    chatInput.value = text;
    // document.getElementById('send-btn').click();
    document.getElementById('quick-reply-modal').classList.remove('visible');
    chatInput.focus();
  }





  async function editQuickReply(id) {
    const reply = await db.quickReplies.get(id);
    if (!reply) return;

    const newText = await showCustomPrompt("‰øÆÊîπÂø´Êç∑ÂõûÂ§ç", "ËØ∑‰øÆÊîπÂõûÂ§çÂÜÖÂÆπÔºö", reply.text, "textarea");

    if (newText && newText.trim()) {

      await db.quickReplies.update(id, {
        text: newText.trim()
      });


      const stateReply = state.quickReplies.find(r => r.id === id);
      if (stateReply) stateReply.text = newText.trim();


      renderQuickReplyList();
    } else if (newText !== null) {
      alert("ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
    }
  }


  async function deleteQuickReply(id) {
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Âø´Êç∑ÂõûÂ§çÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    }
    );

    if (confirmed) {

      await db.quickReplies.delete(id);


      state.quickReplies = state.quickReplies.filter(r => r.id !== id);


      renderQuickReplyList();
    }
  }
  async function handleCharBilibiliSearch() {
    const input = document.getElementById('char-bilibili-search-input');
    const query = input.value.trim();
    if (!query) return;

    const listEl = document.getElementById('char-bilibili-list');
    listEl.innerHTML = '<div class="spinner"></div>'; // ÊòæÁ§∫Âä†ËΩΩ‰∏≠

    // ÂÆö‰πâÂª∂Êó∂ÂáΩÊï∞
    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    try {
      const maxResults = 15; // ÊÉ≥Ë¶ÅËé∑ÂèñÁöÑÊù°Êï∞
      let videos = [];

      // Ê†∏ÂøÉ‰øÆÊîπÔºö‰ΩøÁî® for Âæ™ÁéØ + await ÂÆûÁé∞‚Äú‰∏Ä‰∏™‰∏Ä‰∏™Êêú‚Äù
      for (let i = 1; i <= maxResults; i++) {
        // 1. ÂÆö‰πâÂéüÂßã API Âú∞ÂùÄÔºån Âä®ÊÄÅÂèòÂåñ
        const targetUrl = `https://api.52vmy.cn/api/query/bilibili/video?msg=${encodeURIComponent(query)}&n=${i}`;

        // 2. ‰ΩøÁî® CORS ‰ª£ÁêÜ
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

        let retryCount = 0;
        let success = false;
        const maxRetries = 3; // Âçï‰∏™ËØ∑Ê±ÇÊúÄÂ§ßÈáçËØïÊ¨°Êï∞

        // Ê∑ªÂä†ÈáçËØïÊú∫Âà∂ÔºåÂ§ÑÁêÜÂÅ∂ÂèëÁöÑÈôêÊµÅÊàñÁΩëÁªúÊ≥¢Âä®
        while (!success && retryCount < maxRetries) {
          try {
            const res = await fetch(proxyUrl);
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

            // ÂÖ≥ÈîÆ‰øÆÊîπÔºöÂÖà‰Ωú‰∏∫ÊñáÊú¨ËØªÂèñÔºåÈò≤Ê≠¢ËøîÂõû‚ÄúËÆøÈóÆËøáÂø´‚ÄùÊó∂ JSON Ëß£ÊûêÁÇ∏Ë£Ç
            const text = await res.text();

            // Ê£ÄÊü•ÊòØÂê¶Ë¢´ÈôêÊµÅ (Â§ÑÁêÜÊà™Âõæ‰∏≠ "ËÆøÈóÆËøáÂø´..." ÁöÑÊÉÖÂÜµ)
            if (text.includes("ËÆøÈóÆËøáÂø´") || text.includes("È¢ëÁπÅ") || text.includes("Too Many Requests")) {
              console.warn(`‚ö†Ô∏è Ëé∑ÂèñÁ¨¨ ${i} Êù°Ëß¶ÂèëÈôêÊµÅÔºåÁ≠âÂæÖÂÜ∑Âç¥...`);
              await delay(1500 + (retryCount * 1000)); // Âä®ÊÄÅÂ¢ûÂä†Á≠âÂæÖÊó∂Èó¥
              retryCount++;
              continue; // ÈáçËØï
            }

            // Â∞ùËØïËß£Êûê JSON
            let json;
            try {
              json = JSON.parse(text);
            } catch (e) {
              console.warn(`Á¨¨ ${i} Êù°ËøîÂõûÊ†ºÂºèÈîôËØØ:`, text.substring(0, 50));
              retryCount++;
              continue;
            }

            // Êî∂ÈõÜÊï∞ÊçÆ
            if (json.data) {
              if (Array.isArray(json.data)) {
                videos.push(...json.data);
              } else {
                videos.push(json.data);
              }
            } else if (json.title) {
              videos.push(json);
            } else if (json.code === 200 && json.data) {
              if (Array.isArray(json.data)) {
                videos.push(...json.data);
              } else {
                videos.push(json.data);
              }
            }

            success = true; // Ê†áËÆ∞ÊàêÂäüÔºåÈÄÄÂá∫ while Âæ™ÁéØ

          } catch (err) {
            console.warn(`Ëé∑ÂèñÁ¨¨ ${i} Êù°ËßÜÈ¢ëÁΩëÁªúÈîôËØØ:`, err);
            retryCount++;
            await delay(1000); // ÁΩëÁªúÈîôËØØÁ®ç‰ΩúÁ≠âÂæÖ
          }
        }

        // ÊØèÊ¨°ËØ∑Ê±ÇÂêéÂº∫Âà∂‰ºëÊÅØ‰∏Ä‰∏ãÔºåËøôÊòØÈò≤Ê≠¢ÂÜçÊ¨°Ë¢´ÈôêÊµÅÁöÑÂÖ≥ÈîÆÔºÅ
        await delay(800);
      }

      // ÂéªÈáçÂ§ÑÁêÜ
      const uniqueVideos = [];
      const seenUrls = new Set();
      videos.forEach(v => {
        const url = v.url || v.arcurl;
        if (url && !seenUrls.has(url)) {
          seenUrls.add(url);
          uniqueVideos.push(v);
        }
      });

      listEl.innerHTML = '';
      if (uniqueVideos.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">Êú™ÊâæÂà∞Áõ∏ÂÖ≥ËßÜÈ¢ëÔºåÊàñÊé•Âè£ÊöÇÊó∂‰∏çÂèØÁî®</p>';
        return;
      }

      // Ê∏≤ÊüìÁªìÊûú
      uniqueVideos.forEach(video => {
        const item = document.createElement('div');
        item.className = 'bilibili-item';
        item.innerHTML = `
                <div class="bili-cover" style="position: relative; overflow: hidden;">
                    <img src="${video.img_url || video.pic}" referrerpolicy="no-referrer" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1;">
                    <div class="bili-duration" style="position: absolute; z-index: 2;">‚ñ∂</div>
                </div>
                <div class="bili-info">
                    <div class="bili-title">${video.title}</div>
                    <div class="bili-author">UP: ${video.user || video.author}</div>
                </div>
            `;
        item.onclick = () => playCharBilibiliVideo(video);
        listEl.appendChild(item);
      });

    } catch (error) {
      console.error('Bilibili search error:', error);
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ÊêúÁ¥¢Âá∫ÈîôÔºåËØ∑Á®çÂêéÂÜçËØï</p>';
    }
  }

  function playCharBilibiliVideo(videoData) {
    const playerScreen = document.getElementById('char-bilibili-player-screen');
    const videoEl = document.getElementById('char-bilibili-video');
    const titleEl = document.getElementById('char-bilibili-player-title');
    const authorEl = document.getElementById('char-bilibili-player-author');
    const descEl = document.getElementById('char-bilibili-player-desc');

    videoEl.src = videoData.url;
    titleEl.textContent = videoData.title;
    authorEl.textContent = `UP‰∏ª: ${videoData.user}`;
    descEl.textContent = videoData.desc || 'ÊöÇÊó†ÁÆÄ‰ªã';

    switchToCharScreen('char-bilibili-player-screen');
    videoEl.play().catch(e => console.log("Autoplay blocked", e));
  }

  function closeCharBilibiliPlayer() {
    const videoEl = document.getElementById('char-bilibili-video');
    videoEl.pause();
    videoEl.src = '';
    switchToCharScreen('char-bilibili-screen');
  }

  window.closeCharBilibiliPlayer = function () {
    const videoEl = document.getElementById('char-bilibili-video');
    if (videoEl) {
      videoEl.pause();
      videoEl.src = '';
    }
    switchToCharScreen('char-bilibili-screen');
  }

  // ==========================================
  // MY Phone Ê∏≤ÊüìÂáΩÊï∞
  // ==========================================

  async function renderMyPhoneSimulatedQQ() {
    const listEl = document.getElementById('myphone-chat-list');
    listEl.innerHTML = '';
    const char = state.chats[activeMyPhoneCharacterId];
    if (!char) return;

    const userDisplayName = state.qzoneSettings.nickname || 'Êàë';
    const lastRealMessage = char.history.filter(m => !m.isHidden).slice(-1)[0] || { content: '...' };

    let lastMsgContent = '...';
    if (lastRealMessage) {
      if (typeof lastRealMessage.content === 'string') {
        lastMsgContent = lastRealMessage.content;
      } else if (Array.isArray(lastRealMessage.content) && lastRealMessage.content[0]?.type === 'image_url') {
        lastMsgContent = '[ÂõæÁâá]';
      } else if (lastRealMessage.type) {
        const typeMap = {
          'voice_message': '[ËØ≠Èü≥]',
          'transfer': '[ËΩ¨Ë¥¶]',
          'ai_image': '[ÂõæÁâá]'
        };
        lastMsgContent = typeMap[lastRealMessage.type] || `[${lastRealMessage.type}]`;
      }
    }

    const charAvatar = char.settings.aiAvatar || defaultAvatar;
    const charFrame = char.settings.aiAvatarFrame || '';
    let avatarHtml;
    if (charFrame) {
      avatarHtml = `<div class="avatar-group has-frame" style="width: 45px; height: 45px;"><div class="avatar-with-frame" style="width: 45px; height: 45px;"><img src="${charAvatar}" class="avatar-img" style="border-radius: 50%;"><img src="${charFrame}" class="avatar-frame"></div></div>`;
    } else {
      avatarHtml = `<div class="avatar-group" style="width: 45px; height: 45px;"><img src="${charAvatar}" class="avatar" style="border-radius: 50%; width: 45px; height: 45px;"></div>`;
    }

    const charChatItem = document.createElement('div');
    charChatItem.className = 'chat-list-item';
    charChatItem.dataset.conversationIndex = "-1";
    charChatItem.innerHTML = `
      ${avatarHtml}
      <div class="info">
          <div class="name-line">
              <span class="name">${char.name}</span>
          </div>
          <div class="last-msg">${String(lastMsgContent).substring(0, 20)}...</div>
      </div>
  `;
    charChatItem.addEventListener('click', () => openMyPhoneConversation(-1));
    listEl.appendChild(charChatItem);

    const simulatedConversations = char.myPhoneSimulatedQQConversations || [];
    simulatedConversations.forEach((conv, idx) => {
      const item = document.createElement('div');
      item.className = 'chat-list-item';
      item.dataset.conversationIndex = idx;

      // Ê£ÄÊü•ÊòØÂê¶Âú®Âà†Èô§Ê®°Âºè‰∏ã
      const isDeleteMode = myPhoneDeleteMode.active && myPhoneDeleteMode.appType === 'qq';

      if (isDeleteMode) {
        item.innerHTML = `
        <input type="checkbox" class="myphone-delete-checkbox" data-index="${idx}" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" onchange="toggleMyPhoneItemSelection(${idx})">
        <img src="${conv.avatar || defaultAvatar}" class="avatar">
        <div class="info">
          <div class="name-line">
            <span class="name">${conv.name}</span>
          </div>
          <div class="last-msg">${conv.lastMessage || '...'}</div>
        </div>
      `;
        // Âú®Âà†Èô§Ê®°Âºè‰∏ãÔºåÁÇπÂáªÈ°πÁõÆÊú¨Ë∫´‰πü‰ºöÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ
        item.addEventListener('click', (e) => {
          if (e.target.classList.contains('myphone-delete-checkbox')) return;
          toggleMyPhoneItemSelection(idx);
          const checkbox = item.querySelector('.myphone-delete-checkbox');
          if (checkbox) checkbox.checked = myPhoneDeleteMode.selectedIndices.has(idx);
        });
      } else {
        item.innerHTML = `
        <img src="${conv.avatar || defaultAvatar}" class="avatar">
        <div class="info">
          <div class="name-line">
            <span class="name">${conv.name}</span>
          </div>
          <div class="last-msg">${conv.lastMessage || '...'}</div>
        </div>
      `;
        item.addEventListener('click', () => openMyPhoneConversation(idx));
      }

      listEl.appendChild(item);
    });

    document.getElementById('back-to-myphone-qq-list-btn').onclick = () => switchToMyPhoneScreen('myphone-qq-screen');
  }

  async function openMyPhoneConversation(index) {
    const char = state.chats[activeMyPhoneCharacterId];
    if (!char) return;

    // ‰øùÂ≠òÂΩìÂâçÂØπËØùÁ¥¢Âºï
    window.currentMyPhoneConversationIndex = index;
    myphoneActiveConversationIndex = index;

    const messagesEl = document.getElementById('myphone-conversation-messages');
    messagesEl.innerHTML = '';
    messagesEl.dataset.theme = char.settings.theme || 'default';

    let partnerName, messages, tempChatObject;
    const settingsBtn = document.getElementById('myphone-conversation-settings-btn');

    if (index === -1) {
      // ‰∏éËßíËâ≤ÁöÑÁúüÂÆûÂØπËØù - ‰∏çÊòæÁ§∫ËÆæÁΩÆÊåâÈíÆÔºå‰ΩøÁî®Ê∏≤ÊüìÁ™óÂè£Êú∫Âà∂
      partnerName = char.name;
      settingsBtn.style.display = 'none';

      // ÂàõÂª∫‰∏¥Êó∂ËÅäÂ§©ÂØπË±°Áî®‰∫éÊ∏≤ÊüìÔºàËßíËâ≤ËßÜËßíÔºâ
      tempChatObject = {
        id: 'temp_myphone_user_chat',
        isGroup: false,
        name: state.qzoneSettings.nickname || 'Êàë',
        settings: {
          ...char.settings,
          myAvatar: char.settings.myAvatar || defaultAvatar,
          myAvatarFrame: char.settings.myAvatarFrame || '',
          aiAvatar: char.settings.aiAvatar || defaultAvatar,
          aiAvatarFrame: char.settings.aiAvatarFrame || ''
        }
      };

      // ‚ú® ‰ΩøÁî®Ê∏≤ÊüìÁ™óÂè£Êú∫Âà∂ÔºåÂè™Ê∏≤ÊüìÊúÄËøëÁöÑÊ∂àÊÅØ
      myphoneRenderedCount = 0;
      isLoadingMoreMyPhoneMessages = false;

      const allVisibleMessages = char.history.filter(m => !m.isHidden);
      const renderWindow = state.globalSettings.chatRenderWindow || 50;
      const initialMessages = allVisibleMessages.slice(-renderWindow);
      messages = initialMessages;
      myphoneRenderedCount = initialMessages.length;
    } else {
      // Ê®°ÊãüÂØπËØù - ÊòæÁ§∫ËÆæÁΩÆÊåâÈíÆ
      const conv = char.myPhoneSimulatedQQConversations[index];
      partnerName = conv.name;
      settingsBtn.style.display = 'block';

      // Ëé∑ÂèñÁî®Êà∑Â§¥ÂÉèÔºà‰ªé‰∏ªÂ±èÂπïQQÂØπËØù‰∏≠ÁöÑËÆæÁΩÆÔºâ
      const userAvatar = char.settings.myAvatar || state.qzoneSettings.avatar || defaultAvatar;
      const userAvatarFrame = char.settings.myAvatarFrame || '';

      // ÂàõÂª∫‰∏¥Êó∂ËÅäÂ§©ÂØπË±°Áî®‰∫éÊ∏≤Êüì
      tempChatObject = {
        id: 'temp_myphone_simulated_chat',
        isGroup: false,
        name: conv.name,
        settings: {
          myAvatar: userAvatar,
          myAvatarFrame: userAvatarFrame,
          aiAvatar: conv.avatar || defaultAvatar,
          aiAvatarFrame: ''
        }
      };

      messages = conv.messages || [];
    }

    document.getElementById('myphone-conversation-partner-name').textContent = partnerName;

    // ‰ΩøÁî®createMessageElementÊ∏≤ÊüìÊØèÊù°Ê∂àÊÅØÔºà‰∏écphoneÊ∏≤ÊüìÊñπÂºè‰∏ÄËá¥Ôºâ
    for (const msg of messages) {
      const messageEl = await createMessageElement(msg, tempChatObject);
      if (messageEl) {
        messagesEl.appendChild(messageEl);
      }
    }

    messagesEl.scrollTop = messagesEl.scrollHeight;
    switchToMyPhoneScreen('myphone-qq-conversation-screen');
  }

  async function renderMyPhoneAlbum() {
    const gridEl = document.getElementById('myphone-album-grid');
    gridEl.innerHTML = '';
    if (!activeMyPhoneCharacterId) return;
    const char = state.chats[activeMyPhoneCharacterId];

    const photos = char.myPhoneAlbum || [];

    if (photos.length === 0) {
      gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ÊàëÁöÑÁõ∏ÂÜåËøòÊòØÁ©∫ÁöÑÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õÁÖßÁâáÂêßÔºÅ</p>';
      return;
    }

    const fallbackImageUrl = `https://i.postimg.cc/KYr2qRCK/1.jpg`;
    const isDeleteMode = myPhoneDeleteMode.active && myPhoneDeleteMode.appType === 'album';

    photos.forEach((photo, idx) => {
      const item = document.createElement('div');
      item.className = 'char-photo-item';
      item.dataset.description = photo.description;
      item.style.position = 'relative';
      gridEl.appendChild(item);

      // Ê∑ªÂä†Â§çÈÄâÊ°ÜÔºàÂ¶ÇÊûúÂú®Âà†Èô§Ê®°Âºè‰∏ãÔºâ
      if (isDeleteMode) {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'myphone-delete-checkbox';
        checkbox.dataset.index = idx;
        checkbox.checked = myPhoneDeleteMode.selectedIndices.has(idx);
        checkbox.style.cssText = 'position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; cursor: pointer; z-index: 10;';
        checkbox.onchange = () => toggleMyPhoneItemSelection(idx);
        item.appendChild(checkbox);
      }

      if (state.globalSettings.enableAiDrawing) {
        item.style.backgroundColor = '#e9ecef';
        const containsNonEnglish = /[^\x00-\x7F]/.test(photo.image_prompt);
        const isValidPrompt = photo.image_prompt && photo.image_prompt.trim() && !containsNonEnglish;
        const finalPrompt = isValidPrompt ? photo.image_prompt : 'a beautiful scenery, anime style, cinematic lighting';
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}`;

        const img = new Image();
        img.onload = function () {
          item.style.backgroundImage = `url(${this.src})`;
        };
        img.onerror = function () {
          item.style.backgroundImage = `url(${fallbackImageUrl})`;
        };
        img.src = imageUrl;
      } else {
        item.style.backgroundColor = '#f0f2f5';
        item.style.border = '1px solid #e0e0e0';
        const descriptionEl = document.createElement('p');
        descriptionEl.className = 'char-photo-description';
        descriptionEl.textContent = photo.description || '(ËøôÂº†ÁÖßÁâáÊ≤°ÊúâÊèèËø∞)';
        item.appendChild(descriptionEl);
      }

      if (isDeleteMode) {
        // Âú®Âà†Èô§Ê®°Âºè‰∏ãÔºåÁÇπÂáªÈ°πÁõÆÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ
        item.addEventListener('click', (e) => {
          if (e.target.classList.contains('myphone-delete-checkbox')) return;
          toggleMyPhoneItemSelection(idx);
          const checkbox = item.querySelector('.myphone-delete-checkbox');
          if (checkbox) checkbox.checked = myPhoneDeleteMode.selectedIndices.has(idx);
        });
      } else {
        item.addEventListener('click', () => {
          showCustomAlert('ÁÖßÁâáÊèèËø∞', photo.description || 'Êó†ÊèèËø∞');
        });
      }
    });
  }

  function renderMyPhoneBrowserHistory() {
    const listEl = document.getElementById('myphone-browser-list');
    listEl.innerHTML = '';
    if (!activeMyPhoneCharacterId) return;

    const char = state.chats[activeMyPhoneCharacterId];
    const history = char.myPhoneBrowserHistory || [];

    if (history.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ÊàëÁöÑÊµèËßàÂô®Á©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õËÆ∞ÂΩïÂêßÔºÅ</p>';
      return;
    }

    const globeIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`;
    const arrowIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;
    const isDeleteMode = myPhoneDeleteMode.active && myPhoneDeleteMode.appType === 'browser';

    history.forEach((item, index) => {
      const entryEl = document.createElement('div');
      entryEl.className = 'char-browser-item';

      let cleanUrl = item.url.replace(/^https?:\/\//, '').replace(/^www\./, '');
      if (cleanUrl.length > 25) cleanUrl = cleanUrl.substring(0, 25) + '...';

      if (isDeleteMode) {
        entryEl.innerHTML = `
        <input type="checkbox" class="myphone-delete-checkbox" data-index="${index}" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" onchange="toggleMyPhoneItemSelection(${index})">
        <div class="char-browser-icon-box">
            ${globeIcon}
        </div>
        <div class="char-browser-content">
            <div class="char-browser-title">${item.title}</div>
            <div class="char-browser-url">${cleanUrl}</div>
        </div>
        <div class="char-browser-arrow">
            ${arrowIcon}
        </div>
      `;
        entryEl.addEventListener('click', (e) => {
          if (e.target.classList.contains('myphone-delete-checkbox')) return;
          toggleMyPhoneItemSelection(index);
          const checkbox = entryEl.querySelector('.myphone-delete-checkbox');
          if (checkbox) checkbox.checked = myPhoneDeleteMode.selectedIndices.has(index);
        });
      } else {
        entryEl.innerHTML = `
        <div class="char-browser-icon-box">
            ${globeIcon}
        </div>
        <div class="char-browser-content">
            <div class="char-browser-title">${item.title}</div>
            <div class="char-browser-url">${cleanUrl}</div>
        </div>
        <div class="char-browser-arrow">
            ${arrowIcon}
        </div>
      `;
        entryEl.addEventListener('click', () => openMyPhoneArticle(index));
      }

      listEl.appendChild(entryEl);
    });

    document.getElementById('back-to-myphone-browser-list-btn').onclick = () => switchToMyPhoneScreen('myphone-browser-screen');
  }

  async function openMyPhoneArticle(index) {
    const char = state.chats[activeMyPhoneCharacterId];
    const articleData = char.myPhoneBrowserHistory[index];
    if (!articleData) return;

    renderMyPhoneArticle(articleData);
    switchToMyPhoneScreen('myphone-browser-article-screen');
  }

  function renderMyPhoneArticle(articleData) {
    document.getElementById('myphone-article-title-header').textContent = articleData.title.substring(0, 10) + '...';
    document.getElementById('myphone-article-title').textContent = articleData.title;
    document.getElementById('myphone-article-meta').textContent = articleData.url;
    document.getElementById('myphone-article-content').textContent = articleData.content || 'ÂÜÖÂÆπÂä†ËΩΩ‰∏≠...';
  }

  function renderMyPhoneTaobao() {
    const gridEl = document.getElementById('myphone-taobao-grid');
    gridEl.innerHTML = '';
    if (!activeMyPhoneCharacterId) return;

    const char = state.chats[activeMyPhoneCharacterId];
    const items = char.myPhoneTaobaoHistory || [];

    if (items.length === 0) {
      gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ÊàëÁöÑÊ∑òÂÆùÁ©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õËÆ∞ÂΩïÂêßÔºÅ</p>';
      return;
    }

    const isDeleteMode = myPhoneDeleteMode.active && myPhoneDeleteMode.appType === 'taobao';

    items.forEach((item, idx) => {
      const itemEl = document.createElement('div');
      itemEl.className = 'char-product-item';
      itemEl.dataset.reason = item.reason || item.thought;
      itemEl.style.position = 'relative';

      let imageOrTextHtml;
      // Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©‰∫Ü‰ΩøÁî®AIÁîüÊàêÂõæÁâá
      if (item.image_prompt && !item.useDefaultImage && state.globalSettings.enableAiDrawing) {
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image_prompt)}`;
        imageOrTextHtml = `<img src="${imageUrl}" class="product-image">`;
      } else if (item.image_prompt && !item.useDefaultImage) {
        // Áî®Êà∑ÈÄâÊã©‰∫ÜAIÁîüÊàê‰ΩÜÂÖ®Â±ÄËÆæÁΩÆÊú™ÂêØÁî®ÔºåÊòæÁ§∫ÊèèËø∞
        imageOrTextHtml = `
        <div class="char-product-description-overlay">
          <p class="char-photo-description">${item.thought || item.reason || '(Êó†Ë¥≠‰π∞ÁêÜÁî±)'}</p>
        </div>
      `;
      } else {
        // Áî®Êà∑ÈÄâÊã©‰∫Ü‰ΩøÁî®ÈªòËÆ§ÂõæÁâá
        imageOrTextHtml = `
        <div class="char-product-description-overlay">
          <p class="char-photo-description">${item.thought || item.reason || '(Êó†Ë¥≠‰π∞ÁêÜÁî±)'}</p>
        </div>
      `;
      }

      // Ê∑ªÂä†Â§çÈÄâÊ°ÜÔºàÂ¶ÇÊûúÂú®Âà†Èô§Ê®°Âºè‰∏ãÔºâ
      let checkboxHtml = '';
      if (isDeleteMode) {
        checkboxHtml = `<input type="checkbox" class="myphone-delete-checkbox" data-index="${idx}" style="position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; cursor: pointer; z-index: 10;" onchange="toggleMyPhoneItemSelection(${idx})">`;
      }

      itemEl.innerHTML = `
      ${checkboxHtml}
      ${imageOrTextHtml}
      <div class="product-info">
        <div class="product-name">${item.name}</div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
          <div class="product-price">¬•${(parseFloat(item.price) || 0).toFixed(2)}</div>
          <div class="char-product-status">${item.status || 'Â∑≤Á≠æÊî∂'}</div>
        </div>
      </div>
    `;

      if (isDeleteMode) {
        // Âú®Âà†Èô§Ê®°Âºè‰∏ãÔºåÁÇπÂáªÈ°πÁõÆÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ
        itemEl.addEventListener('click', (e) => {
          if (e.target.classList.contains('myphone-delete-checkbox')) return;
          toggleMyPhoneItemSelection(idx);
          const checkbox = itemEl.querySelector('.myphone-delete-checkbox');
          if (checkbox) checkbox.checked = myPhoneDeleteMode.selectedIndices.has(idx);
        });
      } else {
        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÊòæÁ§∫Ë¥≠‰π∞ÊÉ≥Ê≥ï
        itemEl.addEventListener('click', () => {
          const thought = item.thought || item.reason || 'Êó†ÊÉ≥Ê≥ïËÆ∞ÂΩï';
          showCustomAlert('Ë¥≠‰π∞ÊÉ≥Ê≥ï', thought);
        });
      }

      gridEl.appendChild(itemEl);
    });
  }

  function renderMyPhoneMemoList() {
    const listEl = document.getElementById('myphone-memo-list');
    listEl.innerHTML = '';
    const char = state.chats[activeMyPhoneCharacterId];
    const memos = (char.myPhoneMemos || []).slice().reverse();

    if (memos.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ÊàëÁöÑÂ§áÂøòÂΩïÁ©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßí+Âè∑Ê∑ªÂä†ÊàñÂà∑Êñ∞ÊåâÈíÆÁîüÊàêÔºÅ</p>';
      return;
    }

    // SVG ÂõæÊ†á: Á±ª‰ººÊñá‰ª∂ÁöÑÂõæÊ†á
    const memoIconSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;
    // SVG ÂõæÊ†á: Âè≥ÁÆ≠Â§¥
    const arrowIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;
    const isDeleteMode = myPhoneDeleteMode.active && myPhoneDeleteMode.appType === 'memo';

    memos.forEach((memo, index) => {
      const item = document.createElement('div');
      item.className = 'memo-item';

      // Ëé∑ÂèñÂÜÖÂÆπÈ¢ÑËßà (Á¨¨‰∏ÄË°å)
      const previewText = (memo.content || '').split('\n')[0].substring(0, 50) || 'Êó†ÂÜÖÂÆπ';
      const actualIndex = memos.length - 1 - index; // ÂÆûÈôÖÊï∞ÊçÆÁ¥¢Âºï

      if (isDeleteMode) {
        item.innerHTML = `
        <input type="checkbox" class="myphone-delete-checkbox" data-index="${actualIndex}" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" onchange="toggleMyPhoneItemSelection(${actualIndex})">
        <div class="cphone-item-icon-box memo-icon-style">
          ${memoIconSVG}
        </div>
        <div class="cphone-item-info">
          <div class="cphone-item-title">${memo.title}</div>
          <div class="cphone-item-preview">${previewText}</div>
        </div>
        <div class="cphone-item-arrow">
          ${arrowIcon}
        </div>
      `;
        item.addEventListener('click', (e) => {
          if (e.target.classList.contains('myphone-delete-checkbox')) return;
          toggleMyPhoneItemSelection(actualIndex);
          const checkbox = item.querySelector('.myphone-delete-checkbox');
          if (checkbox) checkbox.checked = myPhoneDeleteMode.selectedIndices.has(actualIndex);
        });
      } else {
        item.innerHTML = `
        <div class="cphone-item-icon-box memo-icon-style">
          ${memoIconSVG}
        </div>
        <div class="cphone-item-info">
          <div class="cphone-item-title">${memo.title}</div>
          <div class="cphone-item-preview">${previewText}</div>
        </div>
        <div class="cphone-item-arrow">
          ${arrowIcon}
        </div>
      `;
        item.addEventListener('click', () => openMyPhoneMemo(actualIndex));
      }

      listEl.appendChild(item);
    });

    document.getElementById('back-to-myphone-memo-list-btn').onclick = () => switchToMyPhoneScreen('myphone-memo-screen');
  }

  function openMyPhoneMemo(index) {
    const char = state.chats[activeMyPhoneCharacterId];
    const memo = char.myPhoneMemos[index];
    if (!memo) return;

    document.getElementById('myphone-memo-title-header').textContent = memo.title.substring(0, 10) + '...';
    document.getElementById('myphone-memo-detail-title').textContent = memo.title;
    document.getElementById('myphone-memo-detail-date').textContent = memo.date;
    document.getElementById('myphone-memo-detail-content').textContent = memo.content;

    switchToMyPhoneScreen('myphone-memo-detail-screen');
  }

  function renderMyPhoneDiaryList() {
    const listEl = document.getElementById('myphone-diary-list');
    listEl.innerHTML = '';
    const char = state.chats[activeMyPhoneCharacterId];
    const diaries = (char.myPhoneDiaries || []).slice().reverse();

    if (diaries.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ÊàëÁöÑÊó•ËÆ∞Á©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õÂÜÖÂÆπÂêßÔºÅ</p>';
      return;
    }

    // SVG ÂõæÊ†á: ‰π¶Êú¨ÂõæÊ†á
    const diaryIconSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`;
    // SVG ÂõæÊ†á: Âè≥ÁÆ≠Â§¥
    const arrowIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;

    const isDeleteMode = myPhoneDeleteMode.active && myPhoneDeleteMode.appType === 'diary';

    diaries.forEach((diary, index) => {
      const item = document.createElement('div');
      item.className = 'diary-item';

      // ‰ΩøÁî®diary.date‰Ωú‰∏∫Êó•ÊúüÊòæÁ§∫
      const dateStr = diary.date || new Date().toLocaleDateString('zh-CN');
      const actualIndex = diaries.length - 1 - index; // ÂÆûÈôÖÊï∞ÊçÆÁ¥¢Âºï

      if (isDeleteMode) {
        item.innerHTML = `
        <input type="checkbox" class="myphone-delete-checkbox" data-index="${actualIndex}" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" onchange="toggleMyPhoneItemSelection(${actualIndex})">
        <div class="cphone-item-icon-box diary-icon-style">
          ${diaryIconSVG}
        </div>
        <div class="cphone-item-info">
          <div class="cphone-item-title">${diary.title}</div>
          <div class="cphone-item-preview">${dateStr}</div>
        </div>
        <div class="cphone-item-arrow">
          ${arrowIcon}
        </div>
      `;
        item.addEventListener('click', (e) => {
          if (e.target.classList.contains('myphone-delete-checkbox')) return;
          toggleMyPhoneItemSelection(actualIndex);
          const checkbox = item.querySelector('.myphone-delete-checkbox');
          if (checkbox) checkbox.checked = myPhoneDeleteMode.selectedIndices.has(actualIndex);
        });
      } else {
        item.innerHTML = `
        <div class="cphone-item-icon-box diary-icon-style">
          ${diaryIconSVG}
        </div>
        <div class="cphone-item-info">
          <div class="cphone-item-title">${diary.title}</div>
          <div class="cphone-item-preview">${dateStr}</div>
        </div>
        <div class="cphone-item-arrow">
          ${arrowIcon}
        </div>
      `;
        item.addEventListener('click', () => openMyPhoneDiary(actualIndex));
      }

      listEl.appendChild(item);
    });

    document.getElementById('back-to-myphone-diary-list-btn').onclick = () => switchToMyPhoneScreen('myphone-diary-screen');
  }

  function openMyPhoneDiary(index) {
    const char = state.chats[activeMyPhoneCharacterId];
    const diary = char.myPhoneDiaries[index];
    if (!diary) return;

    document.getElementById('myphone-diary-title-header').textContent = diary.title.substring(0, 10) + '...';
    document.getElementById('myphone-diary-detail-title').textContent = diary.title;
    document.getElementById('myphone-diary-detail-date').textContent = diary.date;

    // ÊòæÁ§∫Â§©Ê∞î
    const weatherEl = document.getElementById('myphone-diary-detail-weather');
    if (weatherEl) {
      weatherEl.textContent = diary.weather ? `Â§©Ê∞îÔºö${diary.weather}` : '';
      weatherEl.style.display = diary.weather ? 'block' : 'none';
    }

    // ÊòæÁ§∫ÂâçË®Ä
    const prefaceEl = document.getElementById('myphone-diary-detail-preface');
    if (prefaceEl) {
      prefaceEl.textContent = diary.preface || '';
      prefaceEl.style.display = diary.preface ? 'block' : 'none';
    }

    document.getElementById('myphone-diary-detail-content').textContent = diary.content;

    switchToMyPhoneScreen('myphone-diary-detail-screen');
  }

  function renderMyPhoneAmap() {
    const listEl = document.getElementById('myphone-amap-list');
    listEl.innerHTML = '';
    if (!activeMyPhoneCharacterId) return;

    const char = state.chats[activeMyPhoneCharacterId];
    const locations = char.myPhoneAmapHistory || [];
    const isDeleteMode = myPhoneDeleteMode.active && myPhoneDeleteMode.appType === 'amap';

    if (locations.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ÊàëÁöÑË∂≥ËøπÁ©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õËÆ∞ÂΩïÂêßÔºÅ</p>';
      return;
    }

    locations.forEach((item, idx) => {
      const itemEl = document.createElement('div');
      itemEl.className = 'char-amap-item';
      itemEl.style.position = 'relative';

      // ÂÖºÂÆπÊñ∞ÊóßÊï∞ÊçÆÁªìÊûÑ
      const locationName = item.locationName || item.name || 'Êú™Áü•Âú∞ÁÇπ';
      const address = item.address || '';
      const comment = item.comment || item.thought || '';
      const timeAgo = item.timeAgo || item.time || 'Êüê‰∏™Êó∂Èó¥';

      let photoHtml = '';
      if (item.image_prompt) {
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image_prompt)}`;
        photoHtml = `<div class="amap-item-photo" style="background-image: url('${imageUrl}')" data-comment="${comment}"></div>`;
      }

      // Ê∑ªÂä†Â§çÈÄâÊ°ÜÔºàÂ¶ÇÊûúÂú®Âà†Èô§Ê®°Âºè‰∏ãÔºâ
      let checkboxHtml = '';
      if (isDeleteMode) {
        checkboxHtml = `<input type="checkbox" class="myphone-delete-checkbox" data-index="${idx}" style="position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; cursor: pointer; z-index: 10;" onchange="toggleMyPhoneItemSelection(${idx})">`;
      }

      itemEl.innerHTML = `
      ${checkboxHtml}
      <div class="amap-item-header">
        <div class="amap-item-icon">üìç</div>
        <div class="amap-item-info">
          <div class="amap-item-title">${locationName}</div>
          <div class="amap-item-address">${address}</div>
        </div>
      </div>
      <div class="amap-item-body">
        <div class="amap-item-comment">${comment.replace(/\n/g, '<br>')}</div>
        ${photoHtml}
      </div>
      <div class="amap-item-footer">${timeAgo}</div>
    `;

      if (isDeleteMode) {
        itemEl.addEventListener('click', (e) => {
          if (e.target.classList.contains('myphone-delete-checkbox')) return;
          toggleMyPhoneItemSelection(idx);
          const checkbox = itemEl.querySelector('.myphone-delete-checkbox');
          if (checkbox) checkbox.checked = myPhoneDeleteMode.selectedIndices.has(idx);
        });
      }

      listEl.appendChild(itemEl);
    });
  }

  function renderMyPhoneAppUsage() {
    const listEl = document.getElementById('myphone-usage-list');
    listEl.innerHTML = '';
    if (!activeMyPhoneCharacterId) return;

    const char = state.chats[activeMyPhoneCharacterId];
    const originalUsage = char.myPhoneAppUsage || [];
    const usageData = originalUsage.slice().sort((a, b) => b.usageTimeMinutes - a.usageTimeMinutes);
    const isDeleteMode = myPhoneDeleteMode.active && myPhoneDeleteMode.appType === 'usage';

    if (usageData.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ÊöÇÊó†‰ΩøÁî®ËÆ∞ÂΩïÔºå<br>ÁÇπÂáªÂè≥‰∏äËßí+Âè∑Ê∑ªÂä†ÊàñÂà∑Êñ∞ÊåâÈíÆÁîüÊàêÔºÅ</p>';
      return;
    }

    usageData.forEach((item, displayIdx) => {
      const itemEl = document.createElement('div');
      itemEl.className = 'char-usage-item';

      // ÊâæÂà∞Âú®ÂéüÂßãÊï∞ÁªÑ‰∏≠ÁöÑÁ¥¢Âºï
      const actualIndex = originalUsage.indexOf(item);

      // ËÆ°ÁÆóÊó∂ÈïøÊòæÁ§∫
      const hours = Math.floor(item.usageTimeMinutes / 60);
      const minutes = item.usageTimeMinutes % 60;
      let timeString = '';
      if (hours > 0) timeString += `${hours}Â∞èÊó∂`;
      if (minutes > 0) timeString += `${minutes}ÂàÜÈíü`;
      if (!timeString) timeString = 'Â∞è‰∫é1ÂàÜÈíü';

      // ÂõæÊ†áÂ§ÑÁêÜÔºöÂ¶ÇÊûúÁî®Êà∑Êèê‰æõ‰∫ÜiconUrlÂ∞±Áî®Áî®Êà∑ÁöÑÔºåÂê¶ÂàôÁî®ÈªòËÆ§ÂõæÊ†á
      let iconHtml = '';
      if (item.iconUrl) {
        iconHtml = `<img src="${item.iconUrl}" class="usage-item-icon">`;
      } else {
        // ‰ΩøÁî®ÈªòËÆ§ÁÅ∞Ëâ≤ÂõæÊ†áÂç†‰Ωç
        iconHtml = `<div class="usage-item-icon" style="background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999; font-size: 20px;">üì±</div>`;
      }

      if (isDeleteMode) {
        itemEl.innerHTML = `
        <input type="checkbox" class="myphone-delete-checkbox" data-index="${actualIndex}" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" onchange="toggleMyPhoneItemSelection(${actualIndex})">
        ${iconHtml}
        <div class="usage-item-info">
          <div class="usage-item-name">${item.appName}</div>
          <div class="usage-item-category">${item.category}</div>
        </div>
        <div class="usage-item-time">${timeString}</div>
      `;
        itemEl.addEventListener('click', (e) => {
          if (e.target.classList.contains('myphone-delete-checkbox')) return;
          toggleMyPhoneItemSelection(actualIndex);
          const checkbox = itemEl.querySelector('.myphone-delete-checkbox');
          if (checkbox) checkbox.checked = myPhoneDeleteMode.selectedIndices.has(actualIndex);
        });
      } else {
        itemEl.innerHTML = `
        ${iconHtml}
        <div class="usage-item-info">
          <div class="usage-item-name">${item.appName}</div>
          <div class="usage-item-category">${item.category}</div>
        </div>
        <div class="usage-item-time">${timeString}</div>
      `;
      }

      listEl.appendChild(itemEl);
    });
  }

  function renderMyPhoneMusicScreen() {
    const listEl = document.getElementById('myphone-music-list');
    listEl.innerHTML = '';
    if (!activeMyPhoneCharacterId) return;

    const char = state.chats[activeMyPhoneCharacterId];
    const playlist = char.myPhoneMusicPlaylist || [];
    const isDeleteMode = myPhoneDeleteMode.active && myPhoneDeleteMode.appType === 'music';

    if (playlist.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ÊàëÁöÑÊ≠åÂçïÁ©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßí+Âè∑Ê∑ªÂä†ÊàñÂà∑Êñ∞ÊåâÈíÆÁîüÊàêÔºÅ</p>';
      return;
    }

    playlist.forEach((track, index) => {
      const itemEl = document.createElement('div');
      itemEl.className = 'char-music-item';

      // Â§ÑÁêÜÂ∞ÅÈù¢ÂõæÔºåÂ¶ÇÊûúÊ≤°ÊúâÂ∞ÅÈù¢Âàô‰ΩøÁî®ÈªòËÆ§Âõæ
      const coverUrl = track.cover || 'https://via.placeholder.com/60x60/cccccc/666666?text=Music';

      if (isDeleteMode) {
        itemEl.innerHTML = `
        <input type="checkbox" class="myphone-delete-checkbox" data-index="${index}" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" onchange="toggleMyPhoneItemSelection(${index})">
        <img src="${coverUrl}" class="music-item-cover">
        <div class="music-item-info">
          <div class="music-item-name">${track.name || track.title || 'Êú™Áü•Ê≠åÊõ≤'}</div>
          <div class="music-item-artist">${track.artist || 'Êú™Áü•Ê≠åÊâã'}</div>
        </div>
      `;
        itemEl.addEventListener('click', (e) => {
          if (e.target.classList.contains('myphone-delete-checkbox')) return;
          toggleMyPhoneItemSelection(index);
          const checkbox = itemEl.querySelector('.myphone-delete-checkbox');
          if (checkbox) checkbox.checked = myPhoneDeleteMode.selectedIndices.has(index);
        });
      } else {
        itemEl.innerHTML = `
        <img src="${coverUrl}" class="music-item-cover">
        <div class="music-item-info">
          <div class="music-item-name">${track.name || track.title || 'Êú™Áü•Ê≠åÊõ≤'}</div>
          <div class="music-item-artist">${track.artist || 'Êú™Áü•Ê≠åÊâã'}</div>
        </div>
      `;
        // ‰ΩøÁî®CPhoneÁöÑÊí≠ÊîæÂô®Êí≠ÊîæMYphoneÁöÑÊ≠åÊõ≤
        itemEl.addEventListener('click', () => playMyPhoneSong(index, playlist));
      }

      listEl.appendChild(itemEl);
    });
  }

  // MY Phone Èü≥‰πêÊí≠ÊîæÂáΩÊï∞ - ‰ΩøÁî®CPhoneÁöÑÊí≠ÊîæÂô®
  function playMyPhoneSong(songIndex, playlist) {
    const player = document.getElementById('char-audio-player');
    const modal = document.getElementById('char-music-player-modal');

    if (charPlayerState.lrcUpdateInterval) clearInterval(charPlayerState.lrcUpdateInterval);
    player.pause();

    // ËÆæÁΩÆÊí≠ÊîæÁä∂ÊÄÅ
    charPlayerState.currentPlaylist = playlist;
    charPlayerState.currentIndex = songIndex;

    const songObject = playlist[songIndex];
    if (!songObject) {
      console.error("playMyPhoneSong: Ê≠åÊõ≤Á¥¢ÂºïÊó†ÊïàÊàñÊ≠åÂçï‰∏∫Á©∫„ÄÇ");
      return;
    }

    // ÂÖºÂÆπÊñ∞ÊóßÊï∞ÊçÆÁªìÊûÑ
    const songName = songObject.name || songObject.title || 'Êú™Áü•Ê≠åÊõ≤';
    const songArtist = songObject.artist || 'Êú™Áü•Ê≠åÊâã';
    const songCover = songObject.cover || 'https://via.placeholder.com/300x300/cccccc/666666?text=Music';
    const songSrc = songObject.src || songObject.url || '';

    // Êõ¥Êñ∞Êí≠ÊîæÂô®ÁïåÈù¢
    document.getElementById('char-music-player-title').textContent = songName;
    document.getElementById('char-music-artist').textContent = songArtist;
    document.getElementById('char-music-cover').src = songCover;

    // Ëß£ÊûêÊ≠åËØç
    charPlayerState.parsedLyrics = parseLRC(songObject.lrcContent || "");
    renderCharLyrics();

    // Êí≠ÊîæÈü≥È¢ë
    if (songObject.isLocal) {
      // Êú¨Âú∞Êñá‰ª∂Â§ÑÁêÜ
      const blob = new Blob([songObject.src], {
        type: songObject.fileType || 'audio/mpeg'
      });
      player.src = URL.createObjectURL(blob);
    } else if (songSrc) {
      player.src = songSrc;
    } else {
      showCustomAlert('ÈîôËØØ', 'ËØ•Ê≠åÊõ≤Ê≤°ÊúâÂèØÊí≠ÊîæÁöÑÈü≥Ê∫ê');
      return;
    }

    player.play().catch(e => {
      console.error("Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:", e);
      showCustomAlert('Êí≠ÊîæÂ§±Ë¥•', 'Êó†Ê≥ïÊí≠ÊîæÊ≠§Èü≥È¢ëÊñá‰ª∂');
    });

    player.onloadedmetadata = () => {
      const duration = player.duration;
      if (isFinite(duration)) {
        document.getElementById('char-music-total-time').textContent = formatTime(duration);
        document.getElementById('char-music-progress-bar').max = duration;
      }
    };

    // ÊòæÁ§∫Êí≠ÊîæÂô®
    modal.classList.add('visible');
    charPlayerState.isPlaying = true;
    updateCharPlayButton();

    // ÂêØÂä®Ê≠åËØçÂêåÊ≠•
    charPlayerState.lrcUpdateInterval = setInterval(() => {
      const currentTime = player.currentTime;
      updateCharLyricHighlight(currentTime);
      document.getElementById('char-music-current-time').textContent = formatTime(currentTime);
      document.getElementById('char-music-progress-bar').value = currentTime;
    }, 100);
  }

  // MY Phone ÊâãÂä®Ê∑ªÂä†ÂäüËÉΩÂáΩÊï∞
  async function saveMyPhoneAlbum() {
    const description = document.getElementById('myphone-album-description-input')?.value?.trim();

    if (!description) {
      showCustomAlert('ÈîôËØØ', 'ËØ∑ËæìÂÖ•ÂõæÁâáÊèèËø∞');
      return;
    }

    if (!activeMyPhoneCharacterId) {
      showCustomAlert('ÈîôËØØ', 'Êú™ÈÄâÊã©ËßíËâ≤');
      return;
    }

    const char = state.chats[activeMyPhoneCharacterId];
    if (!char.myPhoneAlbum) {
      char.myPhoneAlbum = [];
    }

    const newPhoto = {
      description: description,
      image_prompt: description,
      date: new Date().toLocaleDateString('zh-CN')
    };

    char.myPhoneAlbum.unshift(newPhoto);
    await db.chats.put(char);
    renderMyPhoneAlbum();

    document.getElementById('myphone-add-album-modal')?.classList.remove('visible');
    document.getElementById('myphone-album-description-input').value = '';
    showCustomAlert('ÊàêÂäü', 'ÁÖßÁâáÂ∑≤Ê∑ªÂä†');
  }

  async function saveMyPhoneBrowser() {
    const title = document.getElementById('myphone-browser-title-input')?.value?.trim();
    const content = document.getElementById('myphone-browser-content-input')?.value?.trim();

    if (!title || !content) {
      showCustomAlert('ÈîôËØØ', 'ËØ∑Â°´ÂÜôÊ†áÈ¢òÂíåÂÜÖÂÆπ');
      return;
    }

    if (!activeMyPhoneCharacterId) {
      showCustomAlert('ÈîôËØØ', 'Êú™ÈÄâÊã©ËßíËâ≤');
      return;
    }

    const char = state.chats[activeMyPhoneCharacterId];
    if (!char.myPhoneBrowserHistory) {
      char.myPhoneBrowserHistory = [];
    }

    const newEntry = {
      title: title,
      url: 'www.example.com',
      content: content,
      date: new Date().toLocaleDateString('zh-CN')
    };

    char.myPhoneBrowserHistory.unshift(newEntry);
    await db.chats.put(char);
    renderMyPhoneBrowserHistory();

    document.getElementById('myphone-add-browser-modal')?.classList.remove('visible');
    document.getElementById('myphone-browser-title-input').value = '';
    document.getElementById('myphone-browser-content-input').value = '';
    showCustomAlert('ÊàêÂäü', 'ÊµèËßàËÆ∞ÂΩïÂ∑≤Ê∑ªÂä†');
  }

  async function saveMyPhoneTaobao() {
    const name = document.getElementById('myphone-taobao-name-input')?.value?.trim();
    const description = document.getElementById('myphone-taobao-description-input')?.value?.trim();
    const thought = document.getElementById('myphone-taobao-thought-input')?.value?.trim();
    const price = document.getElementById('myphone-taobao-price-input')?.value || '99';
    const status = document.getElementById('myphone-taobao-status-input')?.value?.trim() || 'Â∑≤Á≠æÊî∂';
    const useAI = document.getElementById('myphone-taobao-ai-image-checkbox')?.checked;

    if (!name || !description) {
      showCustomAlert('ÈîôËØØ', 'ËØ∑Â°´ÂÜôÂïÜÂìÅÂêçÁß∞ÂíåÊèèËø∞');
      return;
    }

    if (!activeMyPhoneCharacterId) {
      showCustomAlert('ÈîôËØØ', 'Êú™ÈÄâÊã©ËßíËâ≤');
      return;
    }

    const char = state.chats[activeMyPhoneCharacterId];
    if (!char.myPhoneTaobaoHistory) {
      char.myPhoneTaobaoHistory = [];
    }

    const newItem = {
      name: name,
      price: price,
      status: status,
      date: new Date().toLocaleDateString('zh-CN'),
      reason: thought || description,
      thought: thought || '',
      image_prompt: useAI ? description : null,
      useDefaultImage: !useAI
    };

    char.myPhoneTaobaoHistory.unshift(newItem);
    await db.chats.put(char);
    renderMyPhoneTaobao();

    document.getElementById('myphone-add-taobao-modal')?.classList.remove('visible');
    document.getElementById('myphone-taobao-name-input').value = '';
    document.getElementById('myphone-taobao-description-input').value = '';
    document.getElementById('myphone-taobao-thought-input').value = '';
    document.getElementById('myphone-taobao-price-input').value = '99';
    document.getElementById('myphone-taobao-status-input').value = 'Â∑≤Á≠æÊî∂';
    document.getElementById('myphone-taobao-ai-image-checkbox').checked = false;
    showCustomAlert('ÊàêÂäü', 'Ë¥≠Áâ©ËÆ∞ÂΩïÂ∑≤Ê∑ªÂä†');
  }

  async function saveMyPhoneDiary() {
    const date = document.getElementById('myphone-diary-date-input')?.value;
    const weather = document.getElementById('myphone-diary-weather-input')?.value?.trim();
    const title = document.getElementById('myphone-diary-title-input')?.value?.trim();
    const preface = document.getElementById('myphone-diary-preface-input')?.value?.trim();
    const content = document.getElementById('myphone-diary-content-input')?.value?.trim();

    if (!date || !title || !content) {
      showCustomAlert('ÈîôËØØ', 'ËØ∑Â°´ÂÜôÊó•Êúü„ÄÅÊ†áÈ¢òÂíåÂÜÖÂÆπ');
      return;
    }

    if (!activeMyPhoneCharacterId) {
      showCustomAlert('ÈîôËØØ', 'Êú™ÈÄâÊã©ËßíËâ≤');
      return;
    }

    const char = state.chats[activeMyPhoneCharacterId];
    if (!char.myPhoneDiaries) {
      char.myPhoneDiaries = [];
    }

    const formattedDate = new Date(date).toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    const newDiary = {
      date: formattedDate,
      weather: weather || 'Êô¥',
      title: title,
      preface: preface || '',
      content: content
    };

    char.myPhoneDiaries.unshift(newDiary);
    await db.chats.put(char);
    renderMyPhoneDiaryList();

    document.getElementById('myphone-add-diary-modal')?.classList.remove('visible');
    document.getElementById('myphone-diary-date-input').value = '';
    document.getElementById('myphone-diary-weather-input').value = '';
    document.getElementById('myphone-diary-title-input').value = '';
    document.getElementById('myphone-diary-preface-input').value = '';
    document.getElementById('myphone-diary-content-input').value = '';
    showCustomAlert('ÊàêÂäü', 'Êó•ËÆ∞Â∑≤Ê∑ªÂä†');
  }

  async function saveMyPhoneMemo() {
    const title = document.getElementById('myphone-memo-title-input')?.value?.trim();
    const content = document.getElementById('myphone-memo-content-input')?.value?.trim();

    if (!title || !content) {
      showCustomAlert('ÈîôËØØ', 'ËØ∑Â°´ÂÜôÊ†áÈ¢òÂíåÂÜÖÂÆπ');
      return;
    }

    if (!activeMyPhoneCharacterId) {
      showCustomAlert('ÈîôËØØ', 'Êú™ÈÄâÊã©ËßíËâ≤');
      return;
    }

    const char = state.chats[activeMyPhoneCharacterId];
    if (!char.myPhoneMemos) {
      char.myPhoneMemos = [];
    }

    const newMemo = {
      title: title,
      content: content,
      date: new Date().toLocaleDateString('zh-CN')
    };

    char.myPhoneMemos.unshift(newMemo);
    await db.chats.put(char);
    renderMyPhoneMemoList();

    document.getElementById('myphone-add-memo-modal')?.classList.remove('visible');
    document.getElementById('myphone-memo-title-input').value = '';
    document.getElementById('myphone-memo-content-input').value = '';
    showCustomAlert('ÊàêÂäü', 'Â§áÂøòÂΩïÂ∑≤Ê∑ªÂä†');
  }

  async function saveMyPhoneAmap() {
    const location = document.getElementById('myphone-amap-location-input')?.value?.trim();
    const address = document.getElementById('myphone-amap-address-input')?.value?.trim();
    const thought = document.getElementById('myphone-amap-thought-input')?.value?.trim();
    const timeInput = document.getElementById('myphone-amap-time-input')?.value?.trim();

    if (!location) {
      showCustomAlert('ÈîôËØØ', 'ËØ∑Â°´ÂÜôÂú∞ÁÇπ');
      return;
    }

    if (!activeMyPhoneCharacterId) {
      showCustomAlert('ÈîôËØØ', 'Êú™ÈÄâÊã©ËßíËâ≤');
      return;
    }

    const char = state.chats[activeMyPhoneCharacterId];
    if (!char.myPhoneAmapHistory) {
      char.myPhoneAmapHistory = [];
    }

    const newLocation = {
      locationName: location,
      address: address || '',
      comment: thought || '',
      timeAgo: timeInput || 'ÂàöÂàö',
      timestamp: Date.now()
    };

    char.myPhoneAmapHistory.unshift(newLocation);
    await db.chats.put(char);
    renderMyPhoneAmap();

    document.getElementById('myphone-add-amap-modal')?.classList.remove('visible');
    document.getElementById('myphone-amap-location-input').value = '';
    document.getElementById('myphone-amap-address-input').value = '';
    document.getElementById('myphone-amap-thought-input').value = '';
    document.getElementById('myphone-amap-time-input').value = '';
    showCustomAlert('ÊàêÂäü', 'Ë∂≥ËøπÂ∑≤Ê∑ªÂä†');
  }

  async function saveMyPhoneUsage() {
    const appName = document.getElementById('myphone-usage-app-input')?.value?.trim();
    const category = document.getElementById('myphone-usage-category-input')?.value?.trim();
    const iconUrl = document.getElementById('myphone-usage-icon-input')?.value?.trim();
    const duration = document.getElementById('myphone-usage-duration-input')?.value || '30';

    if (!appName) {
      showCustomAlert('ÈîôËØØ', 'ËØ∑Â°´ÂÜôÂ∫îÁî®ÂêçÁß∞');
      return;
    }

    if (!activeMyPhoneCharacterId) {
      showCustomAlert('ÈîôËØØ', 'Êú™ÈÄâÊã©ËßíËâ≤');
      return;
    }

    const char = state.chats[activeMyPhoneCharacterId];
    if (!char.myPhoneAppUsage) {
      char.myPhoneAppUsage = [];
    }

    const newUsage = {
      appName: appName,
      category: category || 'ÂÖ∂‰ªñ',
      usageTimeMinutes: parseInt(duration),
      iconUrl: iconUrl || '',
      timestamp: Date.now()
    };

    char.myPhoneAppUsage.unshift(newUsage);
    await db.chats.put(char);
    renderMyPhoneAppUsage();

    document.getElementById('myphone-add-usage-modal')?.classList.remove('visible');
    document.getElementById('myphone-usage-app-input').value = '';
    document.getElementById('myphone-usage-category-input').value = '';
    document.getElementById('myphone-usage-icon-input').value = '';
    document.getElementById('myphone-usage-duration-input').value = '30';
    showCustomAlert('ÊàêÂäü', '‰ΩøÁî®ËÆ∞ÂΩïÂ∑≤Ê∑ªÂä†');
  }

  // Ê∏≤Êüì‰∏ÄËµ∑Âê¨Ê≠åÊõ≤ÂàóË°®‰æõÈÄâÊã©
  function renderMyPhoneYiqitingSongList() {
    const listEl = document.getElementById('myphone-yiqiting-song-list');
    listEl.innerHTML = '';

    // ‰ªéÂÖ®Â±Ä‰∏ÄËµ∑Âê¨Êí≠ÊîæÂàóË°®‰∏≠Ëé∑ÂèñÊ≠åÊõ≤
    const yiqitingPlaylist = musicState.playlist || [];

    if (yiqitingPlaylist.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 20px;">‰∏ÄËµ∑Âê¨Êí≠ÊîæÂàóË°®‰∏∫Á©∫<br>ËØ∑ÂÖàÂú®‰∏ªÂ±èÂπïQQ‰∏ÄËµ∑Âê¨‰∏≠Ê∑ªÂä†Ê≠åÊõ≤</p>';
      return;
    }

    yiqitingPlaylist.forEach((song, index) => {
      const item = document.createElement('div');
      item.className = 'yiqiting-song-item';
      item.style.cssText = 'display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s;';

      item.innerHTML = `
      <input type="checkbox" class="yiqiting-song-checkbox" data-index="${index}" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
      <div style="flex: 1;">
        <div style="font-weight: 500; color: var(--text-color);">${song.name || 'Êú™Áü•Ê≠åÊõ≤'}</div>
        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${song.artist || 'Êú™Áü•Ê≠åÊâã'}</div>
      </div>
    `;

      // ÁÇπÂáªÊï¥Ë°å‰πüËÉΩÂàáÊç¢Â§çÈÄâÊ°Ü
      item.addEventListener('click', (e) => {
        if (e.target.tagName !== 'INPUT') {
          const checkbox = item.querySelector('.yiqiting-song-checkbox');
          checkbox.checked = !checkbox.checked;
        }
      });

      // hoverÊïàÊûú
      item.addEventListener('mouseenter', () => {
        item.style.background = 'var(--hover-bg)';
      });
      item.addEventListener('mouseleave', () => {
        item.style.background = 'transparent';
      });

      listEl.appendChild(item);
    });
  }

  // ÂàáÊç¢MYphoneÈü≥‰πêÊ∑ªÂä†ÊñπÂºèÁöÑËæìÂÖ•Ê°ÜÊòæÁ§∫
  function toggleMyPhoneMusicInputs() {
    const source = document.getElementById('myphone-music-source-select')?.value;
    const fileGroup = document.getElementById('myphone-music-file-group');
    const urlGroup = document.getElementById('myphone-music-url-group');
    const yiqitingListGroup = document.getElementById('myphone-yiqiting-list-group');
    const manualInputs = document.getElementById('myphone-music-manual-inputs');

    if (source === 'yiqiting') {
      // ‰ªé‰∏ÄËµ∑Âê¨ÂØºÂÖ•ÔºöÊòæÁ§∫Ê≠åÊõ≤ÂàóË°®ÔºåÈöêËóèÂÖ∂‰ªñ
      fileGroup.style.display = 'none';
      yiqitingListGroup.style.display = 'block';
      manualInputs.style.display = 'none';
      renderMyPhoneYiqitingSongList();
    } else if (source === 'local') {
      // Êú¨Âú∞Êñá‰ª∂ÔºöÊòæÁ§∫Êñá‰ª∂ÈÄâÊã©ÂíåÊâãÂä®ËæìÂÖ•ÔºåÈöêËóèURL
      fileGroup.style.display = 'block';
      urlGroup.style.display = 'none';
      yiqitingListGroup.style.display = 'none';
      manualInputs.style.display = 'block';
    } else {
      // ÁΩëÁªúURLÔºöÊòæÁ§∫URLËæìÂÖ•ÂíåÊâãÂä®ËæìÂÖ•
      fileGroup.style.display = 'none';
      urlGroup.style.display = 'block';
      yiqitingListGroup.style.display = 'none';
      manualInputs.style.display = 'block';
    }
  }

  async function saveMyPhoneMusic() {
    const source = document.getElementById('myphone-music-source-select')?.value;

    if (!activeMyPhoneCharacterId) {
      showCustomAlert('ÈîôËØØ', 'Êú™ÈÄâÊã©ËßíËâ≤');
      return;
    }

    const char = state.chats[activeMyPhoneCharacterId];
    if (!char.myPhoneMusicPlaylist) {
      char.myPhoneMusicPlaylist = [];
    }

    // Ê†πÊçÆÊ∑ªÂä†ÊñπÂºèÂ§ÑÁêÜ
    if (source === 'yiqiting') {
      // ‰ªé‰∏ÄËµ∑Âê¨ÂØºÂÖ•ÈÄâ‰∏≠ÁöÑÊ≠åÊõ≤
      const checkboxes = document.querySelectorAll('.yiqiting-song-checkbox:checked');

      if (checkboxes.length === 0) {
        showCustomAlert('ÈîôËØØ', 'ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÈ¶ñÊ≠åÊõ≤');
        return;
      }

      let importedCount = 0;
      checkboxes.forEach(checkbox => {
        const index = parseInt(checkbox.dataset.index);
        const originalSong = musicState.playlist[index];

        if (originalSong) {
          // Ê∑±Êã∑Ë¥ùÊ≠åÊõ≤ÂØπË±°ÔºàÈÅøÂÖçÂºïÁî®ÈóÆÈ¢òÔºâ
          const newSong = {
            name: originalSong.name,
            artist: originalSong.artist,
            src: originalSong.src,
            fileType: originalSong.fileType,
            isLocal: originalSong.isLocal,
            lrcContent: originalSong.lrcContent || "",
            cover: originalSong.cover || 'https://via.placeholder.com/300x300/cccccc/666666?text=Music'
          };

          char.myPhoneMusicPlaylist.unshift(newSong);
          importedCount++;
        }
      });

      await db.chats.put(char);
      renderMyPhoneMusicScreen();

      document.getElementById('myphone-add-music-modal')?.classList.remove('visible');
      // ÈáçÁΩÆÂÖ®ÈÄâÂ§çÈÄâÊ°Ü
      document.getElementById('myphone-yiqiting-select-all').checked = false;
      showCustomAlert('ÊàêÂäü', `Â∑≤ÂØºÂÖ• ${importedCount} È¶ñÊ≠åÊõ≤`);

    } else if (source === 'local') {
      // Êú¨Âú∞Êñá‰ª∂‰∏ä‰º†
      const fileInput = document.getElementById('myphone-music-file-input');
      const file = fileInput?.files[0];
      const title = document.getElementById('myphone-music-title-input')?.value?.trim();
      const artist = document.getElementById('myphone-music-artist-input')?.value?.trim();

      if (!file) {
        showCustomAlert('ÈîôËØØ', 'ËØ∑ÈÄâÊã©Èü≥È¢ëÊñá‰ª∂');
        return;
      }

      if (!title) {
        showCustomAlert('ÈîôËØØ', 'ËØ∑Â°´ÂÜôÊ≠åÊõ≤Ê†áÈ¢ò');
        return;
      }

      let songSrc = null;
      let isLocal = true;

      try {
        const catboxUrl = await uploadFileToCatbox(file);

        if (catboxUrl) {
          songSrc = catboxUrl;
          isLocal = false;
          await showCustomAlert("‰∏ä‰º†ÊàêÂäü", `Ê≠åÊõ≤ "${file.name}" Â∑≤ÊàêÂäü‰∏ä‰º†Âà∞ CatboxÔºÅ`);
        } else {
          console.log("Catbox Êú™ÈÖçÁΩÆÔºåÂ∞ÜÊ≠åÊõ≤‰øùÂ≠ò‰∏∫Êú¨Âú∞ ArrayBuffer„ÄÇ");
          songSrc = await file.arrayBuffer();
          isLocal = true;
        }
      } catch (uploadError) {
        console.error("Catbox ‰∏ä‰º†Â§±Ë¥•:", uploadError);
        await showCustomAlert("‰∏ä‰º†Â§±Ë¥•", `‰∏ä‰º†Âà∞ Catbox Â§±Ë¥•: ${uploadError.message}\n\nÂ∞ÜÊîπ‰∏∫Êú¨Âú∞‰øùÂ≠ò„ÄÇ`);
        songSrc = await file.arrayBuffer();
        isLocal = true;
      }

      const newSong = {
        name: title,
        artist: artist || 'Êú™Áü•Ê≠åÊâã',
        src: songSrc,
        fileType: file.type,
        isLocal: isLocal,
        lrcContent: "",
        cover: 'https://via.placeholder.com/300x300/cccccc/666666?text=Music'
      };

      char.myPhoneMusicPlaylist.unshift(newSong);
      await db.chats.put(char);
      renderMyPhoneMusicScreen();

      document.getElementById('myphone-add-music-modal')?.classList.remove('visible');
      document.getElementById('myphone-music-title-input').value = '';
      document.getElementById('myphone-music-artist-input').value = '';
      document.getElementById('myphone-music-file-input').value = '';
      showCustomAlert('ÊàêÂäü', 'Ê≠åÊõ≤Â∑≤Ê∑ªÂä†');

    } else {
      // ÁΩëÁªúURL
      const url = document.getElementById('myphone-music-url-input')?.value?.trim();
      const title = document.getElementById('myphone-music-title-input')?.value?.trim();
      const artist = document.getElementById('myphone-music-artist-input')?.value?.trim();

      if (!title || !url) {
        showCustomAlert('ÈîôËØØ', 'ËØ∑Â°´ÂÜôÊ≠åÊõ≤Ê†áÈ¢òÂíåÈìæÊé•');
        return;
      }

      const newSong = {
        name: title,
        artist: artist || 'Êú™Áü•Ê≠åÊâã',
        src: url,
        isLocal: false,
        lrcContent: "",
        cover: 'https://via.placeholder.com/300x300/cccccc/666666?text=Music'
      };

      char.myPhoneMusicPlaylist.unshift(newSong);
      await db.chats.put(char);
      renderMyPhoneMusicScreen();

      document.getElementById('myphone-add-music-modal')?.classList.remove('visible');
      document.getElementById('myphone-music-title-input').value = '';
      document.getElementById('myphone-music-artist-input').value = '';
      document.getElementById('myphone-music-url-input').value = '';
      showCustomAlert('ÊàêÂäü', 'Ê≠åÊõ≤Â∑≤Ê∑ªÂä†');
    }
  }

  let lockScreenState = {
    passwordBuffer: '',
    isLocked: false
  };

  function initLockScreen() {
    const lockScreen = document.getElementById('lock-screen');

    // ÂàùÂßãÂåñÊ£ÄÊü•ÔºöÂ¶ÇÊûúÂêØÁî®‰∫ÜÈîÅÂ±èÔºåÂàôÁ´ãÂç≥ÊòæÁ§∫
    if (state.globalSettings.lockScreenEnabled) {
      // ËÆæÁΩÆÂ£ÅÁ∫∏
      if (state.globalSettings.lockScreenWallpaper) {
        lockScreen.style.backgroundImage = `url(${state.globalSettings.lockScreenWallpaper})`;
      } else {
        lockScreen.style.backgroundImage = 'linear-gradient(135deg, #1c1c1e, #3a3a3c)'; // ÈªòËÆ§Ê∑±Ëâ≤ËÉåÊôØ
      }

      lockScreenState.isLocked = true;
      lockScreen.classList.add('active');
      updateLockScreenClock();

      // ÂêØÂä®ÈîÅÂ±èÊó∂ÈíüÊõ¥Êñ∞
      setInterval(updateLockScreenClock, 1000);
    }

    // ÁªëÂÆöËÆæÁΩÆÁïåÈù¢ÁöÑ‰∫ã‰ª∂
    const lockToggle = document.getElementById('lock-screen-toggle');
    const lockDetail = document.getElementById('lock-screen-settings-detail');
    const passwordInput = document.getElementById('lock-screen-password-input');
    const wallpaperPreview = document.getElementById('lock-wallpaper-preview');

    // ÂõûÊòæËÆæÁΩÆ
    if (lockToggle) {
      lockToggle.checked = state.globalSettings.lockScreenEnabled || false;
      lockDetail.style.display = lockToggle.checked ? 'block' : 'none';

      lockToggle.addEventListener('change', (e) => {
        lockDetail.style.display = e.target.checked ? 'block' : 'none';
      });
    }

    if (passwordInput) {
      passwordInput.value = state.globalSettings.lockScreenPassword || '';
    }

    if (state.globalSettings.lockScreenWallpaper) {
      wallpaperPreview.style.backgroundImage = `url(${state.globalSettings.lockScreenWallpaper})`;
      wallpaperPreview.textContent = '';
    }
  }

  function updateLockScreenClock() {
    if (!lockScreenState.isLocked) return;

    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
    const dateString = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });

    document.getElementById('lock-time').textContent = timeString;
    document.getElementById('lock-date').textContent = dateString;
  }

  function showPasswordInput() {
    const lockScreen = document.getElementById('lock-screen');
    const passwordArea = document.getElementById('lock-password-area');

    lockScreen.classList.add('input-mode');
    passwordArea.style.display = 'flex';
    lockScreenState.passwordBuffer = '';
    updateDots();
  }

  function hidePasswordInput() {
    const lockScreen = document.getElementById('lock-screen');
    const passwordArea = document.getElementById('lock-password-area');

    lockScreen.classList.remove('input-mode');
    passwordArea.style.display = 'none';
    lockScreenState.passwordBuffer = '';
  }

  function updateDots() {
    const dots = document.querySelectorAll('.lock-dots .dot');
    const len = lockScreenState.passwordBuffer.length;
    dots.forEach((dot, index) => {
      if (index < len) dot.classList.add('filled');
      else dot.classList.remove('filled');
    });
  }

  function handleKeypadInput(num) {
    const lockScreen = document.getElementById('lock-screen');
    const isMyPhoneMode = lockScreen.classList.contains('myphone-lock-mode');

    if (isMyPhoneMode) {
      if (myPhoneLockScreenState.passwordBuffer.length < 4) {
        myPhoneLockScreenState.passwordBuffer += num;
        updateMyPhoneLockDots();

        if (myPhoneLockScreenState.passwordBuffer.length === 4) {
          setTimeout(checkMyPhoneLockPassword, 200);
        }
      }
    } else {
      if (lockScreenState.passwordBuffer.length < 4) {
        lockScreenState.passwordBuffer += num;
        updateDots();

        if (lockScreenState.passwordBuffer.length === 4) {
          setTimeout(checkLockPassword, 200);
        }
      }
    }
  }

  function deleteKeypadInput() {
    const lockScreen = document.getElementById('lock-screen');
    const isMyPhoneMode = lockScreen.classList.contains('myphone-lock-mode');

    if (isMyPhoneMode) {
      if (myPhoneLockScreenState.passwordBuffer.length > 0) {
        myPhoneLockScreenState.passwordBuffer = myPhoneLockScreenState.passwordBuffer.slice(0, -1);
        updateMyPhoneLockDots();
      }
    } else {
      if (lockScreenState.passwordBuffer.length > 0) {
        lockScreenState.passwordBuffer = lockScreenState.passwordBuffer.slice(0, -1);
        updateDots();
      }
    }
  }

  function checkLockPassword() {
    const correctPassword = state.globalSettings.lockScreenPassword;

    if (lockScreenState.passwordBuffer === correctPassword) {
      // Ëß£ÈîÅÊàêÂäü
      const lockScreen = document.getElementById('lock-screen');
      lockScreen.classList.add('unlocking');
      lockScreenState.isLocked = false;

      setTimeout(() => {
        lockScreen.classList.remove('active');
        lockScreen.classList.remove('unlocking');
        hidePasswordInput(); // ÈáçÁΩÆÁä∂ÊÄÅ‰ª•Â§á‰∏ãÊ¨°ÈîÅÂÆö
      }, 500);
    } else {
      // Ëß£ÈîÅÂ§±Ë¥•
      const dots = document.querySelector('.lock-dots');
      dots.classList.add('shake-animation');
      if (navigator.vibrate) navigator.vibrate(200); // ÈúáÂä®ÂèçÈ¶à

      setTimeout(() => {
        dots.classList.remove('shake-animation');
        lockScreenState.passwordBuffer = '';
        updateDots();
      }, 400);
    }
  }

  const lockSwipeArea = document.getElementById('lock-swipe-area');
  const lockScreen = document.getElementById('lock-screen');

  // Â∞ÅË£ÖËß£ÈîÅËß¶ÂèëÈÄªËæë
  function handleUnlockTrigger() {
    // Â¶ÇÊûúÂ∑≤ÁªèÂú®ËæìÂÖ•ÂØÜÁ†ÅÊ®°ÂºèÔºåÂ∞±‰∏çÈáçÂ§çËß¶Âèë
    if (lockScreen.classList.contains('input-mode')) return;

    const isMyPhoneMode = lockScreen.classList.contains('myphone-lock-mode');

    if (isMyPhoneMode) {
      // MyPhoneÈîÅÂ±èÊ®°Âºè
      const characterId = myPhoneLockScreenState.pendingCharacterId;
      if (!characterId) return;

      const char = state.chats[characterId];
      if (!char) return;

      if (char.settings.myPhoneLockScreenPassword) {
        showMyPhonePasswordInput();
      } else {
        // Â¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆÂØÜÁ†ÅÔºåÁõ¥Êé•Ëß£ÈîÅ
        lockScreen.classList.add('unlocking');
        myPhoneLockScreenState.isLocked = false;
        setTimeout(() => {
          lockScreen.classList.remove('active');
          lockScreen.classList.remove('unlocking');
          lockScreen.classList.remove('myphone-lock-mode');
          enterMyPhone(characterId);
          myPhoneLockScreenState.pendingCharacterId = null;
        }, 500);
      }
    } else {
      // ‰∏ªÂ±èÂπïÈîÅÂ±èÊ®°Âºè
      if (state.globalSettings.lockScreenPassword) {
        showPasswordInput();
      } else {
        // Â¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆÂØÜÁ†ÅÔºåÁõ¥Êé•ÊªëÂä®Ëß£ÈîÅ
        lockScreen.classList.add('unlocking');
        lockScreenState.isLocked = false;
        setTimeout(() => {
          lockScreen.classList.remove('active');
          lockScreen.classList.remove('unlocking');
        }, 500);
      }
    }
  }

  // 1. ‰øùÁïôÁÇπÂáªÂ∫ïÈÉ®Ê®™Êù°Ëß£ÈîÅ (ÂÖºÂÆπÈº†Ê†áÁÇπÂáª)
  if (lockSwipeArea) {
    lockSwipeArea.addEventListener('click', handleUnlockTrigger);
  }

  // 2. Êñ∞Â¢ûÔºöÂÖ®Â±è‰∏äÊªëËß£ÈîÅÁõëÂê¨
  if (lockScreen) {
    let touchStartY = 0;
    let touchEndY = 0;

    // Ëß¶Êë∏ÂºÄÂßã
    lockScreen.addEventListener('touchstart', (e) => {
      // ËÆ∞ÂΩïËµ∑ÂßãYÂùêÊ†á
      touchStartY = e.changedTouches[0].screenY;
    }, { passive: true }); // passive: true ‰ºòÂåñÊªöÂä®ÊÄßËÉΩ

    // Ëß¶Êë∏ÁªìÊùü
    lockScreen.addEventListener('touchend', (e) => {
      // ËÆ∞ÂΩïÁªìÊùüYÂùêÊ†á
      touchEndY = e.changedTouches[0].screenY;

      // ËÆ°ÁÆóÊªëÂä®Ë∑ùÁ¶ª
      const swipeDistance = touchStartY - touchEndY;

      // ÈòàÂÄºÔºöÂêë‰∏äÊªëÂä®Ë∂ÖËøá 50px ÂàôËß¶ÂèëËß£ÈîÅ
      if (swipeDistance > 50) {
        handleUnlockTrigger();
      }
    });
  }

  document.querySelectorAll('.lock-keypad .key').forEach(key => {
    key.addEventListener('click', (e) => {
      e.stopPropagation();
      const action = key.dataset.action;
      if (action === 'delete') {
        deleteKeypadInput();
      } else if (key.dataset.num) {
        handleKeypadInput(key.dataset.num);
      }
    });
  });

  const lockCancelBtn = document.querySelector('.lock-cancel-btn');
  if (lockCancelBtn) {
    lockCancelBtn.addEventListener('click', hidePasswordInput);
  }

  // ÈîÅÂ±èÂ£ÅÁ∫∏‰∏ä‰º†Â§ÑÁêÜ
  const lockWallpaperInput = document.getElementById('lock-wallpaper-input');
  if (lockWallpaperInput) {
    lockWallpaperInput.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        const base64Url = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });

        const preview = document.getElementById('lock-wallpaper-preview');
        preview.style.backgroundImage = `url(${base64Url})`;
        preview.textContent = '';

        // ‰∏¥Êó∂Â≠òÂÇ®Âà∞ input ÁöÑ dataset ‰∏≠Ôºå‰ª•‰æø‰øùÂ≠òÊó∂‰ΩøÁî®
        preview.dataset.tempUrl = base64Url;

        // Â¶ÇÊûúÂºÄÂêØ‰∫Ü ImgBBÔºåËá™Âä®‰∏ä‰º† (ÂèØÈÄâÈÄªËæëÔºåÂ§çÁî®‰πãÂâçÁöÑ)
        if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
          (async () => {
            try {
              await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®‰∏ä‰º†ÈîÅÂ±èÂ£ÅÁ∫∏Âà∞ ImgBB...");
              const imageUrl = await uploadImageToImgBB(base64Url);
              preview.dataset.tempUrl = imageUrl;
              await showCustomAlert("ÊàêÂäü", "ÈîÅÂ±èÂ£ÅÁ∫∏Â∑≤‰∏ä‰º†ÔºÅ");
            } catch (e) {
              console.error(e);
            }
          })();
        }
      }
      event.target.value = null;
    });
  }

  document.getElementById('upload-lock-wallpaper-url-btn').addEventListener('click', async () => {
    const url = await showCustomPrompt("ÁΩëÁªúÂõæÁâá", "ËØ∑ËæìÂÖ•ÈîÅÂ±èÂ£ÅÁ∫∏ÁöÑURL", "", "url");
    if (url && url.trim()) {
      const preview = document.getElementById('lock-wallpaper-preview');
      preview.style.backgroundImage = `url(${url})`;
      preview.textContent = '';
      preview.dataset.tempUrl = url;
    }
  });

  // --- GitHub Â§á‰ªΩÂäüËÉΩÊ®°Âùó (Âπ∂Âèë‰ºòÂåñÁâà) ---

  // Ëß£ÂÜ≥‰∏≠Êñá Base64 ÁºñÁ†ÅÈóÆÈ¢òÁöÑËæÖÂä©ÂáΩÊï∞
  function utf8_to_b64(str) {
    return window.btoa(unescape(encodeURIComponent(str)));
  }

  function b64_to_utf8(str) {
    return decodeURIComponent(escape(window.atob(str)));
  }

  async function uploadToGitHub(isSilent = false) {
    let loadingToast = null;
    // --- 1. Âü∫Á°ÄÈÖçÁΩÆÊ£ÄÊü• ---
    if (!state.apiConfig.githubEnable) {
      if (!isSilent) await showCustomAlert("Êú™ÂºÄÂêØ", "ËØ∑ÂÖàÂú®‚ÄúAPIËÆæÁΩÆ‚Äù -> ‚ÄúGitHub ‰∫ëÂ§á‰ªΩ‚Äù‰∏≠ÂºÄÂêØÊ≠§ÂäüËÉΩ„ÄÇ");
      return;
    }

    const username = state.apiConfig.githubUsername;
    const repo = state.apiConfig.githubRepo;
    const token = state.apiConfig.githubToken;
    const baseFilename = (state.apiConfig.githubFilename || 'ephone_backup').replace(/\.json$/i, '');

    if (!username || !repo || !token) {
      if (!isSilent) await showCustomAlert("ÈÖçÁΩÆÁº∫Â§±", "ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠‰øùÂ≠ò GitHub Áî®Êà∑Âêç„ÄÅ‰ªìÂ∫ìÂêçÂíå TokenÔºÅ");
      return;
    }

    // --- 2. Á°ÆËÆ§ÊèêÁ§∫ ---
    if (!isSilent) {
      const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§‰∏ä‰º†Â§á‰ªΩ',
        `Âç≥Â∞ÜÂ§á‰ªΩÊï∞ÊçÆÂà∞ GitHub ‰ªìÂ∫ìÔºö<br><strong>${username}/${repo}</strong><br><br>ÈááÁî®<strong style="color:green">ÊµÅÂºè‰∏ä‰º†</strong> Ê®°Âºè„ÄÇ<br>ÈÄüÂ∫¶Â∞ÜÊòæËëóÊèêÂçá„ÄÇ<br>Á°ÆÂÆöË¶ÅÁ´ãÂç≥‰∏ä‰º†ÂêóÔºü`,
        { confirmText: 'ÂºÄÂßãÊûÅÈÄü‰∏ä‰º†' }
      );
      if (!confirmed) return;
      await showCustomAlert("ÂáÜÂ§á‰∏≠...", "Ê≠£Âú®ÂàùÂßãÂåñÂπ∂Âèë‰∏ä‰º†...");
    } else {
      console.log("‚è≥ [Ëá™Âä®Â§á‰ªΩ] ÂºÄÂßãÂêéÂè∞ÈùôÈªòÂ§á‰ªΩÂà∞ GitHub...");

      loadingToast = showToast('Ê≠£Âú®‰∫ëÁ´ØÂ§á‰ªΩ...', 'loading');
    }

    try {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
      const folderPath = `backups/${dateStr}/`;

      // „ÄêÊ†∏ÂøÉËÆæÁΩÆ„Äë
      const RAW_SIZE_LIMIT = 15 * 1024 * 1024;

      // 2. Â¢ûÂ§ßÊï∞ÊçÆÂ∫ìËØªÂèñÊâπÊ¨°ÔºöÂä†Âø´ËØªÂèñÈÄüÂ∫¶
      const DB_BATCH_SIZE = 50;

      // 3. Â¢ûÂä†Âπ∂ÂèëÊï∞ÔºöÂêåÊó∂‰∏ä‰º† 6 ‰∏™ÂàÜÁâá (GitHub API ÈÄöÂ∏∏ÂÖÅËÆ∏ËæÉÈ´òÂπ∂Âèë)
      const MAX_CONCURRENT_UPLOADS = 4;

      let currentSliceIndex = 1;
      let currentSliceData = {};
      let currentSliceRawSize = 0;

      // Âπ∂ÂèëÊéßÂà∂ÈòüÂàó
      const activeUploads = new Set();
      const errors = []; // Êî∂ÈõÜÈîôËØØ

      // --- ÂÜÖÈÉ®ÂáΩÊï∞ÔºöÊâßË°åÂçï‰∏™ÂàÜÁâá‰∏ä‰º† (Áã¨Á´ã‰ΩúÁî®Âüü) ---
      const triggerUploadTask = async (partIndex, dataSnapshot) => {
        const partFilename = `${baseFilename}_part${partIndex}.json`;
        const finalPath = `${folderPath}${partFilename}`;

        // ÊûÑÈÄ†ÂàÜÁâáÂØπË±°
        const fileContentObj = {
          version: 4,
          timestamp: Date.now(),
          type: 'slice',
          part: partIndex,
          data: dataSnapshot
        };

        const contentString = JSON.stringify(fileContentObj);
        const contentBase64 = utf8_to_b64(contentString);
        const uploadSizeMB = (contentBase64.length / 1024 / 1024).toFixed(2);

        if (!isSilent) {
          // Êõ¥Êñ∞ UI ÊòæÁ§∫ÂΩìÂâçÊ≠£Âú®ËøõË°åÁöÑ‰ªªÂä°Êï∞Èáè
          const modalBody = document.getElementById('custom-modal-body');
          if (modalBody) {
            modalBody.innerHTML = `<div class="spinner" style="margin: 20px auto;"></div>
                    <p style="text-align:center;">
                        Ê≠£Âú®Âπ∂Âèë‰∏ä‰º†‰∏≠...<br>
                        ÂΩìÂâçÈòüÂàó: <b>${activeUploads.size + 1}</b> / ${MAX_CONCURRENT_UPLOADS}<br>
                        Ê≠£Âú®Â§ÑÁêÜÂàÜÁâá: #${partIndex} (${uploadSizeMB} MB)
                    </p>`;
          }
        } else {
          console.log(`[GitHub] ÂºÄÂßã‰∏ä‰º†ÂàÜÁâá #${partIndex}...`);
        }

        // API URL
        let apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${finalPath}`;
        if (state.apiConfig.githubProxyEnable && state.apiConfig.githubProxyUrl) {
          const relativePath = apiUrl.replace("https://api.github.com", "");
          apiUrl = state.apiConfig.githubProxyUrl.replace(/\/$/, '') + relativePath;
        }

        // --- Ê≠•È™§ A: Ëé∑Âèñ SHA ---
        let sha = null;
        try {
          const checkUrl = `${apiUrl}${apiUrl.includes('?') ? '&' : '?'}t=${Date.now()}`;
          const getRes = await fetch(checkUrl, {
            method: 'GET',
            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
          });
          if (getRes.ok) {
            const fileData = await getRes.json();
            sha = fileData.sha;
          }
        } catch (e) { console.warn(`ÂàÜÁâá #${partIndex} Ëé∑ÂèñSHAÂ§±Ë¥•(ÂèØËÉΩÊòØÊñ∞Êñá‰ª∂)ÔºåÁªßÁª≠‰∏ä‰º†`, e); }

        // --- Ê≠•È™§ B: ‰∏ä‰º† (Â∏¶ÈáçËØï) ---
        let retryCount = 0;
        const maxRetries = 3;
        let success = false;
        let lastError = null;

        while (!success && retryCount < maxRetries) {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 180000); // 3ÂàÜÈíüË∂ÖÊó∂

          try {
            const putRes = await fetch(apiUrl, {
              method: 'PUT',
              headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
              body: JSON.stringify({
                message: `Auto Backup: ${dateStr} (Part ${partIndex})`,
                content: contentBase64,
                sha: sha || undefined
              }),
              signal: controller.signal
            });
            clearTimeout(timeoutId);

            if (!putRes.ok) {
              const err = await putRes.json();
              throw new Error(err.message || putRes.statusText);
            }

            success = true;
            console.log(`‚úÖ [GitHub] ÂàÜÁâá #${partIndex} ‰∏ä‰º†ÊàêÂäü`);

          } catch (err) {
            clearTimeout(timeoutId);
            lastError = err;
            retryCount++;
            console.warn(`‚ö†Ô∏è ÂàÜÁâá #${partIndex} Á¨¨ ${retryCount} Ê¨°ÈáçËØï...`);
            await new Promise(resolve => setTimeout(resolve, 2000));
          }
        }

        if (!success) {
          throw new Error(`ÂàÜÁâá #${partIndex} ÊúÄÁªàÂ§±Ë¥•: ${lastError.message}`);
        }
      };

      // --- 3. ÊµÅÂºèÈÅçÂéÜÊï∞ÊçÆÂ∫ì ---
      const tablesToBackup = db.tables.map(t => t.name);

      for (const tableName of tablesToBackup) {
        const totalCount = await db.table(tableName).count();
        if (totalCount === 0) continue;

        let offset = 0;

        while (offset < totalCount) {
          const batch = await db.table(tableName).offset(offset).limit(DB_BATCH_SIZE).toArray();

          for (const record of batch) {
            const recordStr = JSON.stringify(record);
            const recordSize = recordStr.length + tableName.length + 5;

            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂàáÁâá
            if (currentSliceRawSize + recordSize > RAW_SIZE_LIMIT) {

              // --- Ê†∏ÂøÉÂπ∂ÂèëÈÄªËæë ---
              // 1. ÂàõÂª∫ÂΩìÂâçÊï∞ÊçÆÁöÑÂø´ÁÖß (Ê∑±Êã∑Ë¥ùÊàñÁõ¥Êé•ÂºïÁî®ÔºåËøôÈáåÁõ¥Êé•Áî®ÂºïÁî®Âõ†‰∏∫‰∏ãÈù¢‰ºöÈáçÁΩÆÂèòÈáè)
              const dataSnapshot = currentSliceData;
              const indexSnapshot = currentSliceIndex;

              // 2. ÂàõÂª∫ Promise ‰ªªÂä°
              const taskPromise = triggerUploadTask(indexSnapshot, dataSnapshot).catch(err => {
                console.error(err);
                errors.push(err.message);
              });

              // 3. Âä†ÂÖ•ÈòüÂàó
              activeUploads.add(taskPromise);
              // ‰ªªÂä°ÂÆåÊàêÂêé‰ªéÈòüÂàóÁßªÈô§
              taskPromise.finally(() => activeUploads.delete(taskPromise));

              // 4. Â¶ÇÊûúÈòüÂàóÊª°‰∫ÜÔºåÁ≠âÂæÖÊúÄÊó©ÁöÑ‰∏Ä‰∏™ÂÆåÊàê (Promise.race)
              if (activeUploads.size >= MAX_CONCURRENT_UPLOADS) {
                await Promise.race(activeUploads);
              }

              // 5. Â¶ÇÊûúÊúâÈîôËØØÔºåÁ´ãÂç≥ÂÅúÊ≠¢
              if (errors.length > 0) break;

              // 6. ÈáçÁΩÆÂÆπÂô®
              currentSliceData = {};
              currentSliceRawSize = 0;
              currentSliceIndex++;
            }

            if (!currentSliceData[tableName]) {
              currentSliceData[tableName] = [];
            }
            currentSliceData[tableName].push(record);
            currentSliceRawSize += recordSize;
          }

          if (errors.length > 0) break;
          offset += DB_BATCH_SIZE;
        }
        if (errors.length > 0) break;
      }

      // --- 4. Â§ÑÁêÜÊúÄÂêé‰∏Ä‰∏™ÂàÜÁâá ---
      if (currentSliceRawSize > 0 && errors.length === 0) {
        const taskPromise = triggerUploadTask(currentSliceIndex, currentSliceData).catch(err => {
          errors.push(err.message);
        });
        activeUploads.add(taskPromise);
      }

      // --- 5. Á≠âÂæÖÊâÄÊúâÂâ©‰Ωô‰ªªÂä°ÂÆåÊàê ---
      if (!isSilent) {
        const modalBody = document.getElementById('custom-modal-body');
        if (modalBody) modalBody.innerHTML += `<p style="color:blue">Ê≠£Âú®Á≠âÂæÖÊúÄÂêé ${activeUploads.size} ‰∏™ÂàÜÁâáÂÆåÊàê...</p>`;
      }

      await Promise.all(activeUploads);

      // --- 6. ÁªìÊûúÂ§ÑÁêÜ ---
      if (errors.length > 0) {
        throw new Error(`‰∏ä‰º†ËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ:\n${errors.join('\n')}`);
      }

      if (!isSilent) {
        await showCustomAlert(
          "‚úÖ Â§á‰ªΩÊàêÂäü",
          `ÂÖ®ÈáèÊï∞ÊçÆÂπ∂Âèë‰∏ä‰º†ÂÆåÊàêÔºÅ<br>ÂÖ±‰∏ä‰º† ${currentSliceIndex} ‰∏™ÂàÜÁâá„ÄÇ<br><strong>Ë∑ØÂæÑÔºö</strong> ${folderPath}`
        );
      } else {
        console.log(`‚úÖ [Ëá™Âä®Â§á‰ªΩ] ÊàêÂäüÔºÅ`);
        if (loadingToast) {
          loadingToast.classList.remove('visible');
          setTimeout(() => loadingToast.remove(), 400);
        }
        showToast('‰∫ëÁ´ØÂ§á‰ªΩÂ∑≤ÂÆåÊàê', 'success');
      }

    } catch (error) {
      console.error("GitHub ‰∏ä‰º†Â§±Ë¥•:", error);
      let errorMsg = error.message;
      if (error.name === 'AbortError') errorMsg = "‰∏ä‰º†Ë∂ÖÊó∂ (ÁΩëÁªúËæÉÊÖ¢Êàñ‰ª£ÁêÜ‰∏çÁ®≥ÂÆö)„ÄÇ";

      if (!isSilent) {
        await showCustomAlert("‚ùå Â§á‰ªΩÂ§±Ë¥•", `‰∏ä‰º†‰∏≠Êñ≠Ôºö\n${errorMsg}`);
      } else {
        // „Äê‰øÆÊîπÁÇπ 4„Äë: Â§±Ë¥•Êó∂ÊòæÁ§∫Ë≠¶ÂëäÂõæÊ†áÔºå‰ΩÜ‰∏çÊâìÊñ≠Áî®Êà∑
        if (loadingToast) {
          loadingToast.classList.remove('visible');
          setTimeout(() => loadingToast.remove(), 400);
        }
        showToast('Â§á‰ªΩÂ§±Ë¥•: ÁΩëÁªúÈîôËØØ', 'error');
      }
    }
  }
  // ========================================
  // Â§ßÊï∞ÊçÆ‰∫ëÂ§á‰ªΩ (A+BÊñπÊ°à: pakoÂéãÁº© + Git Blob API)
  // ========================================
  async function uploadToGitHubLargeData(isSilent = false) {
    let loadingToast = null;

    // --- 1. Âü∫Á°ÄÈÖçÁΩÆÊ£ÄÊü• ---
    if (!state.apiConfig.githubEnable) {
      if (!isSilent) await showCustomAlert('Êú™ÂºÄÂêØ', 'ËØ∑ÂÖàÂú®"APIËÆæÁΩÆ" -> "GitHub ‰∫ëÂ§á‰ªΩ"‰∏≠ÂºÄÂêØÊ≠§ÂäüËÉΩ„ÄÇ');
      return;
    }

    const username = state.apiConfig.githubUsername;
    const repo = state.apiConfig.githubRepo;
    const token = state.apiConfig.githubToken;
    const branch = state.apiConfig.githubBranch || 'main';
    const baseFilename = (state.apiConfig.githubFilename || 'ephone_backup').replace(/\.json$/i, '');

    if (!username || !repo || !token) {
      if (!isSilent) await showCustomAlert('ÈÖçÁΩÆÁº∫Â§±', 'ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠‰øùÂ≠ò GitHub Áî®Êà∑Âêç„ÄÅ‰ªìÂ∫ìÂêçÂíå TokenÔºÅ');
      return;
    }

    // Ê£ÄÊü• pako ÊòØÂê¶ÂèØÁî®
    if (typeof pako === 'undefined') {
      if (!isSilent) await showCustomAlert('ÁªÑ‰ª∂Áº∫Â§±', 'ÂéãÁº©Â∫ì pako Êú™Âä†ËΩΩÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÂà∑Êñ∞È°µÈù¢ÈáçËØï„ÄÇ');
      return;
    }

    // --- 2. Á°ÆËÆ§ÊèêÁ§∫ ---
    if (!isSilent) {
      const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§Â§ßÊï∞ÊçÆÂ§á‰ªΩ',
        `Âç≥Â∞ÜÂ§á‰ªΩÊï∞ÊçÆÂà∞ GitHub ‰ªìÂ∫ìÔºö<br><strong>${username}/${repo}</strong><br><br>ÈááÁî®<strong style="color:green">ÂéãÁº© + Git Blob API</strong> Ê®°Âºè„ÄÇ<br>ÈÄÇÂêàÂ§ßÊï∞ÊçÆÈáèÁî®Êà∑ÔºàÂá†ÁôæMB+ÔºâÔºåÈÄüÂ∫¶Êõ¥Âø´Êõ¥Á®≥ÂÆö„ÄÇ<br>Á°ÆÂÆöË¶ÅÂºÄÂßãÂêóÔºü`,
        { confirmText: 'ÂºÄÂßãÂ§ßÊï∞ÊçÆÂ§á‰ªΩ' }
      );
      if (!confirmed) return;
      await showCustomAlert("ÂáÜÂ§á‰∏≠...", "Ê≠£Âú®ÂàùÂßãÂåñÂ§ßÊï∞ÊçÆÂ§á‰ªΩ...");
    } else {
      console.log("‚è≥ [Â§ßÊï∞ÊçÆÂ§á‰ªΩ] ÂºÄÂßãÂêéÂè∞ÈùôÈªòÂ§á‰ªΩÂà∞ GitHub...");
      loadingToast = showToast('Ê≠£Âú®Â§ßÊï∞ÊçÆ‰∫ëÂ§á‰ªΩ...', 'loading');
    }

    try {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      const folderPath = `backups/${dateStr}`;

      // Ê†∏ÂøÉËÆæÁΩÆ
      const RAW_SIZE_LIMIT = 3 * 1024 * 1024; // 3MB per slice (ÂéãÁº©Ââç)
      const DB_BATCH_SIZE = 50;
      const MAX_CONCURRENT_UPLOADS = 6;

      // GitHub API Âü∫Á°Ä URL (ÊîØÊåÅ‰ª£ÁêÜ)
      const getApiUrl = (path) => {
        let url = `https://api.github.com${path}`;
        if (state.apiConfig.githubProxyEnable && state.apiConfig.githubProxyUrl) {
          url = state.apiConfig.githubProxyUrl.replace(/\/$/, '') + path;
        }
        return url;
      };

      const ghHeaders = {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json'
      };

      // --- ËæÖÂä©ÂáΩÊï∞ÔºöÂàõÂª∫ Git Blob ---
      const createBlob = async (contentBase64) => {
        const url = getApiUrl(`/repos/${username}/${repo}/git/blobs`);
        let retryCount = 0;
        const maxRetries = 3;

        while (retryCount < maxRetries) {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 180000);

          try {
            const res = await fetch(url, {
              method: 'POST',
              headers: ghHeaders,
              body: JSON.stringify({
                content: contentBase64,
                encoding: 'base64'
              }),
              signal: controller.signal
            });
            clearTimeout(timeoutId);

            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.message || res.statusText);
            }

            const data = await res.json();
            return data.sha;
          } catch (err) {
            clearTimeout(timeoutId);
            retryCount++;
            if (retryCount >= maxRetries) throw new Error(`Blob ÂàõÂª∫Â§±Ë¥•: ${err.message}`);
            console.warn(`‚ö†Ô∏è Blob ÂàõÂª∫Á¨¨ ${retryCount} Ê¨°ÈáçËØï...`);
            await new Promise(r => setTimeout(r, 2000 * retryCount));
          }
        }
      };

      // --- ËæÖÂä©ÂáΩÊï∞ÔºöÂéãÁº©Âπ∂ÁºñÁ†Å ---
      const compressAndEncode = (jsonString) => {
        const compressed = pako.gzip(jsonString);
        // Â∞Ü Uint8Array ËΩ¨‰∏∫ Base64
        let binary = '';
        const bytes = compressed;
        const chunkSize = 8192;
        for (let i = 0; i < bytes.length; i += chunkSize) {
          binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunkSize));
        }
        return window.btoa(binary);
      };

      // Êî∂ÈõÜÊâÄÊúâÂàÜÁâáÁöÑ blob SHA
      const blobEntries = []; // { path, sha }
      const errors = [];
      const activeUploads = new Set();
      let currentSliceIndex = 1;
      let currentSliceData = {};
      let currentSliceRawSize = 0;
      let totalCompressedSize = 0;

      // --- ‰∏ä‰º†Âçï‰∏™ÂàÜÁâá‰∏∫ Blob ---
      const uploadSliceAsBlob = async (partIndex, dataSnapshot) => {
        const fileContentObj = {
          version: 5,
          timestamp: Date.now(),
          type: 'slice_compressed',
          compression: 'gzip',
          part: partIndex,
          data: dataSnapshot
        };

        const jsonString = JSON.stringify(fileContentObj);
        const rawSizeMB = (jsonString.length / 1024 / 1024).toFixed(2);

        // ÂéãÁº©
        const contentBase64 = compressAndEncode(jsonString);
        const compressedSizeMB = (contentBase64.length * 0.75 / 1024 / 1024).toFixed(2);
        totalCompressedSize += contentBase64.length * 0.75;

        if (!isSilent) {
          const modalBody = document.getElementById('custom-modal-body');
          if (modalBody) {
            modalBody.innerHTML = `<div class="spinner" style="margin: 20px auto;"></div>
              <p style="text-align:center;">
                Ê≠£Âú®ÂéãÁº©‰∏ä‰º†‰∏≠...<br>
                ÈòüÂàó: <b>${activeUploads.size + 1}</b> / ${MAX_CONCURRENT_UPLOADS}<br>
                ÂàÜÁâá #${partIndex}: ${rawSizeMB} MB ‚Üí ${compressedSizeMB} MB (ÂéãÁº©Âêé)
              </p>`;
          }
        } else {
          console.log(`[Â§ßÊï∞ÊçÆÂ§á‰ªΩ] ÂàÜÁâá #${partIndex}: ${rawSizeMB}MB ‚Üí ${compressedSizeMB}MB`);
        }

        // ÂàõÂª∫ Blob
        const partFilename = `${baseFilename}_part${partIndex}.json.gz`;
        const sha = await createBlob(contentBase64);

        blobEntries.push({
          path: `${folderPath}/${partFilename}`,
          sha: sha
        });

        console.log(`‚úÖ [Â§ßÊï∞ÊçÆÂ§á‰ªΩ] ÂàÜÁâá #${partIndex} Blob Â∑≤ÂàõÂª∫ (SHA: ${sha.substring(0, 7)})`);
      };

      // --- 3. ÊµÅÂºèÈÅçÂéÜÊï∞ÊçÆÂ∫ì ---
      const tablesToBackup = db.tables.map(t => t.name);

      for (const tableName of tablesToBackup) {
        const totalCount = await db.table(tableName).count();
        if (totalCount === 0) continue;

        let offset = 0;

        while (offset < totalCount) {
          const batch = await db.table(tableName).offset(offset).limit(DB_BATCH_SIZE).toArray();

          for (const record of batch) {
            const recordStr = JSON.stringify(record);
            const recordSize = recordStr.length + tableName.length + 5;

            if (currentSliceRawSize + recordSize > RAW_SIZE_LIMIT) {
              const dataSnapshot = currentSliceData;
              const indexSnapshot = currentSliceIndex;

              const taskPromise = uploadSliceAsBlob(indexSnapshot, dataSnapshot).catch(err => {
                console.error(err);
                errors.push(err.message);
              });

              activeUploads.add(taskPromise);
              taskPromise.finally(() => activeUploads.delete(taskPromise));

              if (activeUploads.size >= MAX_CONCURRENT_UPLOADS) {
                await Promise.race(activeUploads);
              }

              if (errors.length > 0) break;

              currentSliceData = {};
              currentSliceRawSize = 0;
              currentSliceIndex++;
            }

            if (!currentSliceData[tableName]) {
              currentSliceData[tableName] = [];
            }
            currentSliceData[tableName].push(record);
            currentSliceRawSize += recordSize;
          }

          if (errors.length > 0) break;
          offset += DB_BATCH_SIZE;
        }
        if (errors.length > 0) break;
      }

      // --- 4. Â§ÑÁêÜÊúÄÂêé‰∏Ä‰∏™ÂàÜÁâá ---
      if (currentSliceRawSize > 0 && errors.length === 0) {
        const taskPromise = uploadSliceAsBlob(currentSliceIndex, currentSliceData).catch(err => {
          errors.push(err.message);
        });
        activeUploads.add(taskPromise);
      }

      // --- 5. Á≠âÂæÖÊâÄÊúâ Blob ‰∏ä‰º†ÂÆåÊàê ---
      if (!isSilent) {
        const modalBody = document.getElementById('custom-modal-body');
        if (modalBody) modalBody.innerHTML = `<div class="spinner" style="margin: 20px auto;"></div>
          <p style="text-align:center;">Ê≠£Âú®Á≠âÂæÖÊúÄÂêé ${activeUploads.size} ‰∏™ÂàÜÁâáÂÆåÊàê...</p>`;
      }

      await Promise.all(activeUploads);

      if (errors.length > 0) {
        throw new Error(`‰∏ä‰º†ËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ:\n${errors.join('\n')}`);
      }

      // --- 6. Áî® Git Tree + Commit API ‰∏ÄÊ¨°ÊÄßÊèê‰∫§ ---
      if (!isSilent) {
        const modalBody = document.getElementById('custom-modal-body');
        if (modalBody) modalBody.innerHTML = `<div class="spinner" style="margin: 20px auto;"></div>
          <p style="text-align:center;">ÊâÄÊúâÂàÜÁâáÂ∑≤‰∏ä‰º†ÔºåÊ≠£Âú®ÂàõÂª∫ Git Commit...</p>`;
      }

      // 6a. Ëé∑ÂèñÂΩìÂâçÂàÜÊîØÁöÑÊúÄÊñ∞ commit SHA
      const refUrl = getApiUrl(`/repos/${username}/${repo}/git/ref/heads/${branch}`);
      const refRes = await fetch(refUrl, { headers: ghHeaders });
      if (!refRes.ok) throw new Error(`Ëé∑ÂèñÂàÜÊîØ‰ø°ÊÅØÂ§±Ë¥•: ${refRes.status}`);
      const refData = await refRes.json();
      const latestCommitSha = refData.object.sha;

      // 6b. Ëé∑ÂèñËØ• commit ÁöÑ tree SHA
      const commitUrl = getApiUrl(`/repos/${username}/${repo}/git/commits/${latestCommitSha}`);
      const commitRes = await fetch(commitUrl, { headers: ghHeaders });
      if (!commitRes.ok) throw new Error(`Ëé∑Âèñ Commit ‰ø°ÊÅØÂ§±Ë¥•: ${commitRes.status}`);
      const commitData = await commitRes.json();
      const baseTreeSha = commitData.tree.sha;

      // 6c. ÂàõÂª∫Êñ∞ Tree
      const treeItems = blobEntries.map(entry => ({
        path: entry.path,
        mode: '100644',
        type: 'blob',
        sha: entry.sha
      }));

      const treeUrl = getApiUrl(`/repos/${username}/${repo}/git/trees`);
      const treeRes = await fetch(treeUrl, {
        method: 'POST',
        headers: ghHeaders,
        body: JSON.stringify({
          base_tree: baseTreeSha,
          tree: treeItems
        })
      });
      if (!treeRes.ok) {
        const treeErr = await treeRes.json();
        throw new Error(`ÂàõÂª∫ Tree Â§±Ë¥•: ${treeErr.message}`);
      }
      const treeData = await treeRes.json();

      // 6d. ÂàõÂª∫ Commit
      const newCommitUrl = getApiUrl(`/repos/${username}/${repo}/git/commits`);
      const newCommitRes = await fetch(newCommitUrl, {
        method: 'POST',
        headers: ghHeaders,
        body: JSON.stringify({
          message: `Large Data Backup: ${dateStr} (${blobEntries.length} parts, compressed)`,
          tree: treeData.sha,
          parents: [latestCommitSha]
        })
      });
      if (!newCommitRes.ok) {
        const commitErr = await newCommitRes.json();
        throw new Error(`ÂàõÂª∫ Commit Â§±Ë¥•: ${commitErr.message}`);
      }
      const newCommitData = await newCommitRes.json();

      // 6e. Êõ¥Êñ∞ÂàÜÊîØÂºïÁî®
      const updateRefUrl = getApiUrl(`/repos/${username}/${repo}/git/refs/heads/${branch}`);
      const updateRefRes = await fetch(updateRefUrl, {
        method: 'PATCH',
        headers: ghHeaders,
        body: JSON.stringify({
          sha: newCommitData.sha
        })
      });
      if (!updateRefRes.ok) {
        const refErr = await updateRefRes.json();
        throw new Error(`Êõ¥Êñ∞ÂàÜÊîØÂ§±Ë¥•: ${refErr.message}`);
      }

      // --- 7. ÊàêÂäü ---
      const totalCompressedMB = (totalCompressedSize / 1024 / 1024).toFixed(2);

      if (!isSilent) {
        await showCustomAlert(
          "‚úÖ Â§ßÊï∞ÊçÆÂ§á‰ªΩÊàêÂäü",
          `ÂÖ®ÈáèÊï∞ÊçÆÂéãÁº©‰∏ä‰º†ÂÆåÊàêÔºÅ<br>ÂÖ± ${blobEntries.length} ‰∏™ÂàÜÁâáÔºåÂéãÁº©ÂêéÊÄªËÆ°Á∫¶ ${totalCompressedMB} MB„ÄÇ<br><strong>Ë∑ØÂæÑÔºö</strong> ${folderPath}/`
        );
      } else {
        console.log(`‚úÖ [Â§ßÊï∞ÊçÆÂ§á‰ªΩ] ÊàêÂäüÔºÅ${blobEntries.length} ‰∏™ÂàÜÁâáÔºå${totalCompressedMB} MB`);
        if (loadingToast) {
          loadingToast.classList.remove('visible');
          setTimeout(() => loadingToast.remove(), 400);
        }
        showToast('Â§ßÊï∞ÊçÆ‰∫ëÂ§á‰ªΩÂ∑≤ÂÆåÊàê', 'success');
      }

    } catch (error) {
      console.error("Â§ßÊï∞ÊçÆÂ§á‰ªΩÂ§±Ë¥•:", error);
      let errorMsg = error.message;
      if (error.name === 'AbortError') errorMsg = "‰∏ä‰º†Ë∂ÖÊó∂ (ÁΩëÁªúËæÉÊÖ¢Êàñ‰ª£ÁêÜ‰∏çÁ®≥ÂÆö)„ÄÇ";

      if (!isSilent) {
        await showCustomAlert("‚ùå Â§ßÊï∞ÊçÆÂ§á‰ªΩÂ§±Ë¥•", `‰∏ä‰º†‰∏≠Êñ≠Ôºö\n${errorMsg}`);
      } else {
        if (loadingToast) {
          loadingToast.classList.remove('visible');
          setTimeout(() => loadingToast.remove(), 400);
        }
        showToast('Â§ßÊï∞ÊçÆÂ§á‰ªΩÂ§±Ë¥•', 'error');
      }
    }
  }

  async function restoreFromGitHub() {
    if (!state.apiConfig.githubEnable) {
      alert("ËØ∑ÂÖàÂºÄÂêØ GitHub ‰∫ëÂ§á‰ªΩÂäüËÉΩ„ÄÇ");
      return;
    }

    const username = state.apiConfig.githubUsername;
    const repo = state.apiConfig.githubRepo;
    const token = state.apiConfig.githubToken;

    if (!username || !repo || !token) {
      alert("ËØ∑ÂÖà‰øùÂ≠ò GitHub ÈÖçÁΩÆÔºÅ");
      return;
    }

    const modalBody = document.getElementById('custom-modal-body');
    const confirmBtn = document.getElementById('custom-modal-confirm');
    const cancelBtn = document.getElementById('custom-modal-cancel');

    const showProgress = (text) => {
      const modal = document.getElementById('custom-modal-overlay');
      document.getElementById('custom-modal-title').textContent = "GitHub ÊÅ¢Â§ç";
      modalBody.innerHTML = `<div class="spinner" style="margin: 20px auto;"></div><p style="text-align:center;">${text}</p>`;
      confirmBtn.style.display = 'none';
      cancelBtn.style.display = 'none';
      modal.classList.add('visible');
    };

    // ÈÄöÁî® Fetch
    const ghFetch = async (path) => {
      let url = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;
      if (state.apiConfig.githubProxyEnable && state.apiConfig.githubProxyUrl) {
        const relativePath = url.replace("https://api.github.com", "");
        url = state.apiConfig.githubProxyUrl.replace(/\/$/, '') + relativePath;
      }
      const res = await fetch(url, {
        headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
      });
      if (!res.ok) {
        if (res.status === 404) return [];
        throw new Error(`GitHub API Error: ${res.status}`);
      }
      return await res.json();
    };

    try {
      showProgress("Ê≠£Âú®ÊêúÁ¥¢Â§á‰ªΩ...");

      // 1. ÊµèËßàÂ§á‰ªΩÁõÆÂΩï
      let rootPath = "";
      const backupsDir = await ghFetch("backups");

      if (backupsDir.length > 0) {
        const dateFolders = backupsDir.filter(item => item.type === 'dir');
        if (dateFolders.length > 0) {
          document.getElementById('custom-modal-overlay').classList.remove('visible');
          dateFolders.sort((a, b) => b.name.localeCompare(a.name));
          const dateChoices = dateFolders.map(f => ({ text: `üìÖ ${f.name}`, value: f.path }));
          const selectedPath = await showChoiceModal('ËØ∑ÈÄâÊã©Â§á‰ªΩÊó•Êúü', dateChoices);
          if (!selectedPath) return;
          rootPath = selectedPath;
          showProgress(`Ê≠£Âú®ËØªÂèñ ${rootPath} ...`);
        }
      }

      // 2. Ëé∑ÂèñÊñá‰ª∂ÂàóË°®
      const files = await ghFetch(rootPath);

      // 3. Êô∫ËÉΩÂàÜÁªÑ
      const backupSets = new Map();
      files.forEach(file => {
        if (!file.name.endsWith('.json') && !file.name.endsWith('.json.gz')) return;
        // ÂåπÈÖç _partX.json Êàñ _partX.json.gz Ê†ºÂºè
        const partMatch = file.name.match(/^(.*)_part(\d+)\.json(?:\.gz)?$/);
        if (partMatch) {
          const baseName = partMatch[1]; // ÁªÑÂêç
          const partNum = parseInt(partMatch[2]);
          if (!backupSets.has(baseName)) {
            backupSets.set(baseName, { type: 'multipart', display: baseName, parts: [] });
          }
          backupSets.get(baseName).parts.push({ num: partNum, name: file.name, path: file.path });
        } else {
          // ÊóßÁâàÂçïÊñá‰ª∂
          backupSets.set(file.name, { type: 'single', display: file.name, name: file.name, path: file.path });
        }
      });

      if (backupSets.size === 0) throw new Error("Êú™ÊâæÂà∞Â§á‰ªΩÊñá‰ª∂„ÄÇ");

      document.getElementById('custom-modal-overlay').classList.remove('visible');
      const choices = [];
      backupSets.forEach((info, key) => {
        let text = info.display;
        if (info.type === 'multipart') text += ` (${info.parts.length} ‰∏™ÂàÜÁâá)`;
        choices.push({ text: text, value: key });
      });

      const selectedKey = await showChoiceModal('ËØ∑ÈÄâÊã©Ë¶ÅÊÅ¢Â§çÁöÑÊ°£Ê°à', choices);
      if (!selectedKey) return;

      const targetSet = backupSets.get(selectedKey);
      const confirmRestore = await showCustomConfirm('ÊúÄÂêéÁ°ÆËÆ§', `Âç≥Â∞ÜÊÅ¢Â§çÊï∞ÊçÆ„ÄÇÊú¨Âú∞Êï∞ÊçÆÂ∞ÜË¢´Ë¶ÜÁõñ„ÄÇÁ°ÆÂÆöÂêóÔºü`, { confirmButtonClass: 'btn-danger', confirmText: 'ÊÅ¢Â§ç' });
      if (!confirmRestore) return;

      showProgress("Ê≠£Âú®‰∏ãËΩΩÂπ∂ÊÅ¢Â§çÊï∞ÊçÆ...");

      // 4. Ê∏ÖÁ©∫Êï∞ÊçÆÂ∫ì (‰∏ÄÊ¨°ÊÄßÊ∏ÖÁ©∫ÔºåÈÅøÂÖçÂàÜÁâáÊÅ¢Â§çÊó∂Êï∞ÊçÆÂÜ≤Á™Å)
      await db.transaction('rw', db.tables, async () => {
        for (const table of db.tables) {
          await table.clear();
        }
      });

      // 5. ÂÆö‰πâ‰∏ãËΩΩÂíåÂ§ÑÁêÜÂçï‰∏™Êñá‰ª∂ÁöÑÈÄªËæë
      const processFile = async (filePath) => {
        let url = `https://api.github.com/repos/${username}/${repo}/contents/${filePath}`;
        if (state.apiConfig.githubProxyEnable && state.apiConfig.githubProxyUrl) {
          const relativePath = url.replace("https://api.github.com", "");
          url = state.apiConfig.githubProxyUrl.replace(/\/$/, '') + relativePath;
        }
        const res = await fetch(url, {
          headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3.raw' }
        });
        if (!res.ok) throw new Error(`‰∏ãËΩΩÂ§±Ë¥•: ${res.status}`);

        let json;
        const isGzipped = filePath.endsWith('.gz');

        if (isGzipped && typeof pako !== 'undefined') {
          // Â§ÑÁêÜ gzip ÂéãÁº©ÁöÑÂàÜÁâá
          const arrayBuffer = await res.arrayBuffer();
          const decompressed = pako.ungzip(new Uint8Array(arrayBuffer), { to: 'string' });
          json = JSON.parse(decompressed);
        } else {
          const text = await res.text();
          try {
            json = JSON.parse(text);
          } catch (e) {
            // Â∞ùËØï Base64 Ëß£Á†Å (ÂÖºÂÆπÊóßÈÄªËæë)
            const decoded = decodeURIComponent(escape(window.atob(text.replace(/\s/g, ''))));
            json = JSON.parse(decoded);
          }
        }

        // Ê†∏ÂøÉÔºöÊ†πÊçÆÊ†ºÂºèÂÜ≥ÂÆöÂ¶Ç‰ΩïÂØºÂÖ•
        const dataPart = json.data || json; // ÂÖºÂÆπ {version:.., data:{...}} Âíå Áõ¥Êé• {...}

        // ÂÜôÂÖ•Êï∞ÊçÆÂ∫ì
        for (const tableName of Object.keys(dataPart)) {
          const records = dataPart[tableName];
          if (Array.isArray(records) && records.length > 0) {
            await db.table(tableName).bulkPut(records);
          }
        }
      };

      // 6. ÊâßË°åÊÅ¢Â§ç
      if (targetSet.type === 'multipart') {
        targetSet.parts.sort((a, b) => a.num - b.num);
        for (let i = 0; i < targetSet.parts.length; i++) {
          const part = targetSet.parts[i];
          modalBody.innerHTML = `<div class="spinner"></div><p style="text-align:center;">Ê≠£Âú®Â§ÑÁêÜÂàÜÁâá ${i + 1}/${targetSet.parts.length}...</p>`;
          await processFile(part.path);
          // Âº∫Âà∂ÂûÉÂúæÂõûÊî∂Âª∫ËÆÆÔºàÈÄöËøáÊñ≠ÂºÄÂºïÁî®Ôºâ
          await new Promise(r => setTimeout(r, 50));
        }
      } else {
        await processFile(targetSet.path);
      }

      // 7. ÊÅ¢Â§ç API ÈÖçÁΩÆ (Èò≤Ê≠¢Ë¶ÜÁõñÂêé‰∏¢Â§± Key)
      try {
        const restoredApiConfig = await db.apiConfig.get('main');
        if (restoredApiConfig) {
          if (restoredApiConfig.imgbbApiKey) localStorage.setItem('imgbb-api-key', restoredApiConfig.imgbbApiKey);
          if (restoredApiConfig.imgbbEnable !== undefined) localStorage.setItem('imgbb-enabled', restoredApiConfig.imgbbEnable);
          if (restoredApiConfig.minimaxApiKey) localStorage.setItem('minimax-api-key', restoredApiConfig.minimaxApiKey);
          if (restoredApiConfig.minimaxGroupId) localStorage.setItem('minimax-group-id', restoredApiConfig.minimaxGroupId);
          // ÊÅ¢Â§ç GitHub ÈÖçÁΩÆÔºåÂê¶Âàô‰∏ãÊ¨°Êó†Ê≥ïÂ§á‰ªΩ
          if (restoredApiConfig.githubToken) state.apiConfig.githubToken = restoredApiConfig.githubToken;
        }
      } catch (e) { }

      confirmBtn.style.display = '';
      await showCustomAlert("ÊÅ¢Â§çÊàêÂäü", "ÊâÄÊúâÂàÜÁâáÂ∑≤Â§ÑÁêÜÂÆåÊØïÔºåÊï∞ÊçÆÂ∑≤ÊÅ¢Â§çÔºÅÁÇπÂáªÁ°ÆÂÆöÂà∑Êñ∞È°µÈù¢„ÄÇ");
      setTimeout(() => window.location.reload(), 500);

    } catch (error) {
      console.error(error);
      confirmBtn.style.display = '';
      await showCustomAlert("ÊÅ¢Â§çÂ§±Ë¥•", error.message);
    }
  }
  let backupIntervalId = null;

  // ‰øÆÊîπÂáΩÊï∞ÂÆö‰πâÔºåÊé•Êî∂ intervalMinutes ÂèÇÊï∞
  function startAutoBackupTimer(intervalMinutes) {
    if (backupIntervalId) clearInterval(backupIntervalId);

    // Â¶ÇÊûúÊ≤°‰º†ÂèÇÊï∞ÔºåÂ∞ùËØï‰ªé storage ËØªÂèñÔºåÊàñËÄÖÈªòËÆ§ 30
    if (!intervalMinutes) {
      const saved = localStorage.getItem('github-backup-interval');
      intervalMinutes = saved ? parseInt(saved) : 30;
    }

    console.log(`‚úÖ Ëá™Âä®Â§á‰ªΩÂÆöÊó∂Âô®Â∑≤ÂêØÂä® (ÊØè ${intervalMinutes} ÂàÜÈíü)`);

    backupIntervalId = setInterval(async () => {
      const isEnabled = localStorage.getItem('github-enabled') === 'true';
      const isAuto = localStorage.getItem('github-auto-backup') === 'true';

      if (isEnabled && isAuto) {
        console.log("‚è∞ Ëß¶ÂèëÂÆöÊó∂Ëá™Âä®Â§á‰ªΩ...");
        await uploadToGitHub(true);
      }
    }, intervalMinutes * 60 * 1000); // ËΩ¨Êç¢‰∏∫ÊØ´Áßí
  }

  // ÂàùÂßãÂåñË∞ÉÁî®‰πüË¶ÅÊîπ‰∏Ä‰∏ã
  const savedGhEnabled = localStorage.getItem('github-enabled') === 'true';
  const savedGhAuto = localStorage.getItem('github-auto-backup') === 'true';

  if (savedGhEnabled && savedGhAuto) {
    startAutoBackupTimer(); // ËøôÈáåÂÆÉ‰ºöËá™Âä®ÂéªËØª localStorage
  }


  function stopAutoBackupTimer() {
    if (backupIntervalId) {
      clearInterval(backupIntervalId);
      backupIntervalId = null;
      console.log("üõë Ëá™Âä®Â§á‰ªΩÂÆöÊó∂Âô®Â∑≤ÂÅúÊ≠¢");
    }
  }



  // Â∞ÜËøô‰∏§‰∏™ÂáΩÊï∞Êö¥Èú≤ÁªôÂÖ®Â±ÄÔºå‰ª•‰æø save ÊåâÈíÆË∞ÉÁî® (ËôΩÁÑ∂Âú®Èó≠ÂåÖÈáåÔºå‰ΩÜÂèØ‰ª•Áõ¥Êé•Âú®‰∏äÈù¢ÁöÑ save ÊåâÈíÆÈÄªËæëÈáåÁî®)
  window.startAutoBackupTimer = startAutoBackupTimer;
  window.stopAutoBackupTimer = stopAutoBackupTimer;
  // --- Open-Meteo Â§©Ê∞îÂäüËÉΩÊ®°Âùó ---

  // 1. WMO Â§©Ê∞î‰ª£Á†ÅËΩ¨ÊñáÂ≠ó
  function getWeatherDescription(code) {
    const codes = {
      0: "Êô¥Êúó (Clear sky)",
      1: "Â§ßÈÉ®Êô¥Êúó (Mainly clear)", 2: "Â§ö‰∫ë (Partly cloudy)", 3: "Èò¥Â§© (Overcast)",
      45: "ÊúâÈõæ (Fog)", 48: "ÁªìÈúúÈõæ (Depositing rime fog)",
      51: "ËΩªÂæÆÊØõÊØõÈõ® (Drizzle: Light)", 53: "‰∏≠Â∫¶ÊØõÊØõÈõ® (Drizzle: Moderate)", 55: "Â§ßÊØõÊØõÈõ® (Drizzle: Dense)",
      61: "Â∞èÈõ® (Rain: Slight)", 63: "‰∏≠Èõ® (Rain: Moderate)", 65: "Â§ßÈõ® (Rain: Heavy)",
      71: "Â∞èÈõ™ (Snow fall: Slight)", 73: "‰∏≠Èõ™ (Snow fall: Moderate)", 75: "Â§ßÈõ™ (Snow fall: Heavy)",
      80: "ÈòµÈõ® (Rain showers)", 81: "‰∏≠Â∫¶ÈòµÈõ®", 82: "Êö¥Èõ®",
      95: "Èõ∑Èõ® (Thunderstorm)", 96: "Èõ∑Èõ®‰º¥ÊúâÂÜ∞Èõπ", 99: "ÈáçÂ∫¶Èõ∑Èõ®‰º¥ÊúâÂÜ∞Èõπ"
    };
    return codes[code] || "Êú™Áü•Â§©Ê∞î";
  }

  // 2. ÊêúÁ¥¢ÁúüÂÆûÂüéÂ∏Ç (Geocoding API)
  async function searchCityGeo(cityName) {
    try {
      const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&language=zh&format=json`);
      const data = await response.json();
      if (data.results && data.results.length > 0) {
        return data.results[0]; // ËøîÂõû {name, latitude, longitude, country...}
      }
      return null;
    } catch (e) {
      console.error("ÂüéÂ∏ÇÊêúÁ¥¢Â§±Ë¥•:", e);
      return null;
    }
  }

  // 3. Ëé∑ÂèñÂ§©Ê∞îÊï∞ÊçÆ
  async function fetchWeather(lat, lon) {
    if (!lat || !lon) return null;
    try {
      // Ëé∑ÂèñÂΩìÂâçÂ§©Ê∞îÔºöÊ∏©Â∫¶„ÄÅÂ§©Ê∞î‰ª£Á†Å„ÄÅÁôΩÂ§©/ÈªëÂ§ú„ÄÅÈ£éÈÄü
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,is_day,wind_speed_10m&timezone=auto`;
      const response = await fetch(url);
      const data = await response.json();

      if (data.current) {
        const c = data.current;
        const desc = getWeatherDescription(c.weather_code);
        const dayState = c.is_day ? "ÁôΩÂ§©" : "Â§úÊôö";
        return `Ê∞îÊ∏© ${c.temperature_2m}¬∞C, ÊπøÂ∫¶ ${c.relative_humidity_2m}%, ${desc}, ${dayState}, È£éÈÄü ${c.wind_speed_10m}km/h`;
      }
      return null;
    } catch (e) {
      console.error("Ëé∑ÂèñÂ§©Ê∞îÂ§±Ë¥•:", e);
      return null;
    }
  }

  // 4. ÁîüÊàê Prompt Ê≥®ÂÖ•ÊñáÊú¨
  async function getWeatherContextForPrompt(chat) {
    const wSettings = chat.settings.weather || {};
    if (!wSettings.enabled) return "";

    let context = "\n# „ÄêÂÆûÊó∂ÁéØÂ¢É‰∏éÂ§©Ê∞îÂêåÊ≠•„Äë\n";
    let hasData = false;

    // Ëé∑ÂèñÁî®Êà∑Â§©Ê∞î
    if (wSettings.userLat && wSettings.userLon) {
      const userWeather = await fetchWeather(wSettings.userLat, wSettings.userLon);
      if (userWeather) {
        const locationName = wSettings.userVirtualCity || "ÊâÄÂú®Âú∞";
        context += `- Áî®Êà∑(${chat.settings.myNickname || 'Êàë'})ÂΩìÂâçÂú®„Äê${locationName}„Äë: ${userWeather}„ÄÇ\n`;
        hasData = true;
      }
    }

    // Ëé∑ÂèñËßíËâ≤Â§©Ê∞î
    if (wSettings.charLat && wSettings.charLon) {
      const charWeather = await fetchWeather(wSettings.charLat, wSettings.charLon);
      if (charWeather) {
        const locationName = wSettings.charVirtualCity || "ÊâÄÂú®Âú∞";
        context += `- ‰Ω†(${chat.name})ÂΩìÂâçÂú®„Äê${locationName}„Äë: ${charWeather}„ÄÇ\n`;
        hasData = true;
      }
    }

    if (!hasData) return "";

    context += "ËØ∑Ê†πÊçÆ‰∏äËø∞Â§©Ê∞îÂíåÊó∂Èó¥Áä∂ÊÄÅÔºàÂ¶ÇÊòØÂê¶‰∏ãÈõ®„ÄÅÊòØÁôΩÂ§©ËøòÊòØÂ§úÊôöÔºâÊù•Ë∞ÉÊï¥‰Ω†ÁöÑÊèèÂÜôÊ∞õÂõ¥„ÄÅËßíËâ≤ÁöÑË°åÂä®ÔºàÂ¶ÇÊíë‰ºû„ÄÅÈÅøÊöë„ÄÅÊ∑ªË°£Ôºâ‰ª•ÂèäÂØπËØùÂÜÖÂÆπ„ÄÇ";
    return context;
  }
  let userBalance = 0;
  const BLACK_GOLD_THRESHOLD = 10000; // ÈªëÈáë‰ºöÂëòÈòàÂÄºÔºö1‰∏á

  async function initUserWallet() {
    try {
      let wallet = await db.userWallet.get('main');

      // Â¶ÇÊûúÊ≤°ÊúâÈí±ÂåÖÔºåÊàñËÄÖ‰ΩôÈ¢ùÂèòÊàê‰∫Ü NaN/null/undefinedÔºåÂº∫Âà∂‰øÆÂ§ç
      if (!wallet || typeof wallet.balance !== 'number' || isNaN(wallet.balance)) {
        console.warn("Ê£ÄÊµãÂà∞Èí±ÂåÖÊï∞ÊçÆÂºÇÂ∏∏ (NaN Êàñ ‰∏çÂ≠òÂú®)ÔºåÊ≠£Âú®ÈáçÁΩÆ...");

        // Â∞ùËØï‰øùÁïôÊóßÁöÑ‰∫≤Â±ûÂç°Êï∞ÊçÆÔºåÂè™ÈáçÁΩÆ‰ΩôÈ¢ù
        const oldKinship = (wallet && wallet.kinshipCards) ? wallet.kinshipCards : [];

        wallet = {
          id: 'main',
          balance: 0, // Âº∫Âà∂ÈáçÁΩÆ‰∏∫ 0
          kinshipCards: oldKinship,
          lastResetMonth: ''
        };

        await db.userWallet.put(wallet);
        userBalance = 0;
      } else {
        // Êï∞ÊçÆÊ≠£Â∏∏ÔºåËØªÂèñ‰ΩôÈ¢ù
        userBalance = wallet.balance;

        // Ë°•ÂÖ®ÂèØËÉΩÁº∫Â§±ÁöÑÂ≠óÊÆµ
        if (!wallet.kinshipCards) {
          wallet.kinshipCards = [];
          await db.userWallet.put(wallet);
        }
      }

      // ÊØèÊúàËá™Âä®ÈáçÁΩÆ‰∫≤Â±ûÂç°È¢ùÂ∫¶ÈÄªËæë (‰øùÊåÅ‰∏çÂèò)
      const now = new Date();
      const currentMonthKey = `${now.getFullYear()}-${now.getMonth() + 1}`;
      if (wallet.lastResetMonth !== currentMonthKey) {
        if (wallet.kinshipCards && wallet.kinshipCards.length > 0) {
          wallet.kinshipCards.forEach(card => { card.spent = 0; });
          await db.userWallet.put(wallet);
        }
        wallet.lastResetMonth = currentMonthKey;
        await db.userWallet.put(wallet);
      }

      console.log("Áî®Êà∑Èí±ÂåÖÂàùÂßãÂåñÂÆåÊàêÔºåÂΩìÂâç‰ΩôÈ¢ù:", userBalance);

      // Á´ãÂç≥Êõ¥Êñ∞ÁïåÈù¢‰∏äÁöÑÊòæÁ§∫ÔºàÂ¶ÇÊûúÊ≠£Âú®ÊòæÁ§∫ÁöÑËØùÔºâ
      const displayEl = document.getElementById('alipay-balance-display');
      if (displayEl) displayEl.textContent = userBalance.toFixed(2);

    } catch (e) {
      console.error("ÂàùÂßãÂåñÈí±ÂåÖÂ§±Ë¥•:", e);
      userBalance = 0;
    }
  }


  // --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÂº∫Âà∂Êï∞Â≠óËøêÁÆóÔºåÈò≤Ê≠¢Â≠óÁ¨¶‰∏≤ÊãºÊé•ÊàñNaN ---
  async function processTransaction(amount, type, description) {
    // 1. Âº∫Âà∂ËΩ¨‰∏∫Êï∞Â≠óÔºåÈò≤Ê≠¢ "100" + 50 ÂèòÊàê "10050"
    let safeAmount = parseFloat(amount);
    if (isNaN(safeAmount) || safeAmount <= 0) {
      console.error("ËÆ∞Ë¥¶Â§±Ë¥•ÔºöÈáëÈ¢ùÊó†Êïà", amount);
      return false;
    }

    try {
      // 2. Ëé∑ÂèñÈí±ÂåÖÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôÂàùÂßãÂåñ
      let wallet = await db.userWallet.get('main');
      if (!wallet) {
        wallet = { id: 'main', balance: 0, kinshipCards: [] };
      }

      // Á°Æ‰øù‰ΩôÈ¢ùÊòØÊï∞Â≠ó
      if (typeof wallet.balance !== 'number') wallet.balance = 0;

      // 3. ÊâßË°åÂä†Âáè
      if (type === 'expense') {
        if (wallet.balance < safeAmount) {
          await showCustomAlert("ÊîØ‰ªòÂ§±Ë¥•", `‰ΩôÈ¢ù‰∏çË∂≥ÔºÅÂΩìÂâç: ${wallet.balance.toFixed(2)}`);
          return false;
        }
        wallet.balance -= safeAmount;
      } else if (type === 'income') {
        wallet.balance += safeAmount;
      }

      // 4. ‰øùÂ≠òÈí±ÂåÖ
      await db.userWallet.put(wallet);

      // ÂêåÊ≠•ÂÖ®Â±ÄÂèòÈáè
      window.userBalance = wallet.balance;

      // 5. ÂÜôÂÖ•Ë¥¶ÂçïÊµÅÊ∞¥ (UserTransactions)
      const transaction = {
        timestamp: Date.now(),
        type: type,
        amount: safeAmount,
        description: description || 'Êú™Áü•‰∫§Êòì'
      };
      await db.userTransactions.add(transaction);

      console.log(`‚úÖ [Èí±ÂåÖ] ‰∫§ÊòìÊàêÂäü: ${type} ¬•${safeAmount.toFixed(2)}. Êñ∞‰ΩôÈ¢ù: ${wallet.balance.toFixed(2)}`);
      return true;

    } catch (e) {
      console.error("ÂÜôÂÖ•Èí±ÂåÖÊï∞ÊçÆÂ∫ìÂ§±Ë¥•:", e);
      alert("Á≥ªÁªüÈîôËØØÔºöË¥¶ÂçïÂÜôÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞„ÄÇ");
      return false;
    }
  }

  async function openAlipayScreen() {
    // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÊØèÊ¨°ÊâìÂºÄÊó∂ÔºåÂº∫Âà∂‰ªéÊï∞ÊçÆÂ∫ìÈáçÊñ∞ËØªÂèñÊúÄÊñ∞‰ΩôÈ¢ù
    // ËøôÊ†∑ËÉΩ‰øùËØÅÊòæÁ§∫ÁöÑ‰∏çÊòØ NaN
    await initUserWallet();

    // Êõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫
    const balanceEl = document.getElementById('alipay-balance-display');
    if (balanceEl) {
      // ÂèåÈáç‰øùÈô©ÔºåÂ¶ÇÊûúÊòØ NaN Â∞±ÊòæÁ§∫ 0.00
      const safeBalance = isNaN(userBalance) ? 0 : userBalance;
      balanceEl.textContent = safeBalance.toFixed(2);
    }

    // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®ÈªëÈáë‰∏ªÈ¢ò
    const alipayScreen = document.getElementById('alipay-screen');
    const statusTag = document.getElementById('alipay-status-tag');

    if (userBalance >= BLACK_GOLD_THRESHOLD) {
      alipayScreen.classList.add('theme-blackgold');
      if (statusTag) statusTag.textContent = 'ÈªëÈáë‰ºöÂëò';
    } else {
      alipayScreen.classList.remove('theme-blackgold');
      if (statusTag) statusTag.textContent = 'Ê†áÂáÜ‰ºöÂëò';
    }

    // Ê∏≤Êüì‰∫≤Â±ûÂç°Âå∫Âüü (ÈÄªËæë‰øùÊåÅ‰∏çÂèò)
    const oldWrapper = document.getElementById('alipay-kinship-section-wrapper');
    if (oldWrapper) oldWrapper.remove();
    const container = document.querySelector('.alipay-card-container');
    const wallet = await db.userWallet.get('main');
    const kinshipCards = wallet?.kinshipCards || [];

    const kinshipWrapper = document.createElement('div');
    kinshipWrapper.id = 'alipay-kinship-section-wrapper';
    kinshipWrapper.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding: 0 5px;">
            <span class="kinship-section-title">‰∫≤Â±ûÂç° / ‰∫≤ÂØÜ‰ªò</span>
            <span id="add-kinship-btn" style="font-size:22px; color:#1677ff; cursor:pointer; line-height:1;">+</span>
        </div>
    `;
    const scrollContainer = document.createElement('div');
    scrollContainer.id = 'alipay-kinship-section';

    if (kinshipCards.length === 0) {
      scrollContainer.innerHTML = `
            <div class="kinship-empty-state" style="background:white; width:100%; border-radius:12px; padding:20px; text-align:center; color:#999; box-shadow:0 2px 8px rgba(0,0,0,0.03);">
                <p style="margin:0; font-size:13px;">ÊöÇÊó†‰∫≤Â±ûÂç°ÔºåÂø´ÂéªÈÇÄËØ∑TAÂêß</p>
            </div>`;
    } else {
      kinshipCards.forEach(card => {
        const chat = state.chats[card.chatId];
        const providerName = chat ? chat.name : 'Êú™Áü•ËßíËâ≤';
        const providerAvatar = chat ? (chat.settings.aiAvatar || defaultAvatar) : defaultAvatar;
        const remaining = card.limit - (card.spent || 0);

        const cardEl = document.createElement('div');
        cardEl.className = 'kinship-card-entry';
        cardEl.innerHTML = `
                <button class="alipay-unbind-btn" data-chat-id="${card.chatId}">Ëß£Áªë</button>
                <div class="kinship-top">
                    <div class="kinship-provider">
                        <img src="${providerAvatar}">
                        <span>${providerName} (Ëµ†)</span>
                    </div>
                    <span style="font-size:11px; opacity:0.8;">Ê∂àË¥πÂØπÊñπÂèØËßÅ</span>
                </div>
                <div class="kinship-label">Êú¨ÊúàÂâ©‰ΩôÈ¢ùÂ∫¶</div>
                <div class="kinship-limit">¬• ${remaining.toFixed(2)}</div>
            `;
        scrollContainer.appendChild(cardEl);
      });
    }

    kinshipWrapper.appendChild(scrollContainer);
    container.appendChild(kinshipWrapper);

    const addBtn = kinshipWrapper.querySelector('#add-kinship-btn');
    if (addBtn) addBtn.onclick = openKinshipSelector;

    // Ê∏≤ÊüìË¥¶ÂçïÂàóË°®
    if (typeof initBillListUI === 'function') {
      await initBillListUI();
    }

    showScreen('alipay-screen');
  }
  async function renderTransactionList() {
    // Ê£ÄÊü•ÂΩìÂâçÊòØÂê¶Âú®ÊîØ‰ªòÂÆùÈ°µÈù¢ÔºåÂ¶ÇÊûúÂú®ÔºåÂàôÂà∑Êñ∞ÂàóË°®
    const alipayScreen = document.getElementById('alipay-screen');
    if (alipayScreen && alipayScreen.classList.contains('active')) {
      await loadBills(true);
    }
  }
  // --- Êñ∞ÁâàÊîØ‰ªòÂÆùË¥¶ÂçïÈÄªËæë ---

  // ÂàùÂßãÂåñ/ÈáçÁΩÆË¥¶ÂçïÂàóË°® UI
  async function initBillListUI() {
    const container = document.getElementById('alipay-transaction-list'); // Ê≥®ÊÑèÔºöËøôÊòØÂéüÊù•ÁöÑÂÆπÂô®ID

    // ÈáçÁΩÆÂÆπÂô®Ê†∑Âºè‰ª•ÈÄÇÂ∫îÊñ∞Â∏ÉÂ±Ä
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.height = '100%';
    container.style.overflow = 'hidden';
    container.innerHTML = '';

    // 1. Ê∏≤ÊüìÁ≠õÈÄâÂ§¥ÈÉ®
    const header = document.createElement('div');
    header.className = 'bill-filter-header';

    // Ëé∑ÂèñÂΩìÂâçÊúà‰ªΩ‰Ωú‰∏∫ÈªòËÆ§ÂÄº (ÊàñËÄÖÁïôÁ©∫ÊòæÁ§∫ÂÖ®ÈÉ®)
    // billState.filterDate = new Date().toISOString().slice(0, 7); 

    header.innerHTML = `
        <div class="bill-date-picker-wrapper">
            <input type="month" id="bill-date-input" class="bill-date-input" value="${billState.filterDate}">
        </div>
        <div class="bill-type-tabs">
            <span class="bill-type-tab active" data-type="all">ÂÖ®ÈÉ®</span>
            <span class="bill-type-tab" data-type="expense">ÊîØÂá∫</span>
            <span class="bill-type-tab" data-type="income">Êî∂ÂÖ•</span>
        </div>
    `;
    container.appendChild(header);

    // 2. Ê∏≤ÊüìÊªöÂä®ÂàóË°®ÂÆπÂô®
    const scrollList = document.createElement('div');
    scrollList.id = 'bill-scroll-list';
    container.appendChild(scrollList);

    // 3. Ê∏≤ÊüìÂ∫ïÈÉ®Âä†ËΩΩÊèêÁ§∫
    const loader = document.createElement('div');
    loader.id = 'bill-loader';
    loader.className = 'bill-loading-more hidden';
    loader.textContent = 'Ê≠£Âú®Âä†ËΩΩÊõ¥Â§ö...';
    scrollList.appendChild(loader);

    // 4. ÁªëÂÆö‰∫ã‰ª∂
    bindBillEvents();

    // 5. ÂàùÂßãÂä†ËΩΩÊï∞ÊçÆ
    await loadBills(true);
  }

  // ÁªëÂÆöÁ≠õÈÄâÂíåÊªöÂä®‰∫ã‰ª∂
  function bindBillEvents() {
    // Êó•ÊúüÁ≠õÈÄâ
    const dateInput = document.getElementById('bill-date-input');
    dateInput.addEventListener('change', (e) => {
      billState.filterDate = e.target.value;
      loadBills(true); // ÈáçÁΩÆÂπ∂ÈáçÊñ∞Âä†ËΩΩ
    });

    // Á±ªÂûãÁ≠õÈÄâ
    const tabs = document.querySelectorAll('.bill-type-tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        // UI ÂàáÊç¢
        tabs.forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');

        // ÈÄªËæëÂàáÊç¢
        billState.filterType = e.target.dataset.type;
        loadBills(true);
      });
    });

    // ÊªöÂä®Âä†ËΩΩ (Infinite Scroll)
    const scrollList = document.getElementById('bill-scroll-list');
    scrollList.addEventListener('scroll', () => {
      const { scrollTop, scrollHeight, clientHeight } = scrollList;
      // Ë∑ùÁ¶ªÂ∫ïÈÉ® 50px Êó∂Ëß¶ÂèëÂä†ËΩΩ
      if (scrollHeight - scrollTop <= clientHeight + 50) {
        if (billState.hasMore && !billState.isLoading) {
          loadBills(false);
        }
      }
    });
  }

  // Ê†∏ÂøÉÔºöÂä†ËΩΩË¥¶ÂçïÊï∞ÊçÆ
  async function loadBills(isReset = false) {
    if (billState.isLoading) return;

    const scrollList = document.getElementById('bill-scroll-list');
    const loader = document.getElementById('bill-loader');

    billState.isLoading = true;
    loader.classList.remove('hidden');

    if (isReset) {
      billState.page = 0;
      billState.hasMore = true;
      // Ê∏ÖÁ©∫ÂàóË°®Ôºà‰øùÁïôloaderÔºâ
      const items = scrollList.querySelectorAll('.bill-item, .bill-month-separator, .bill-empty-msg');
      items.forEach(el => el.remove());
      scrollList.scrollTop = 0;
    }

    try {
      // --- ÊûÑÂª∫ Dexie Êü•ËØ¢ ---
      let collection = db.userTransactions.orderBy('timestamp').reverse();

      // 1. ÂÜÖÂ≠òËøáÊª§ (Âõ†‰∏∫ IndexedDB Â§çÊùÇÊü•ËØ¢ÊØîËæÉÈ∫ªÁÉ¶ÔºåÂèñÂá∫Êù•ÂÜçÁ≠õÊÄßËÉΩÈÄöÂ∏∏Ë∂≥Â§ü)
      // Â¶ÇÊûúÊï∞ÊçÆÈáèÊûÅÂ§ßÔºåÂª∫ËÆÆÂÖàÁî® compound indexÔºå‰ΩÜËøôÈáåÊàë‰ª¨ÂÅáËÆæÊï∞ÊçÆÈáèÂú®‰∏áÁ∫ß‰ª•ÂÜÖ
      let allMatches = await collection.toArray();

      // 2. Â∫îÁî®Á±ªÂûãËøáÊª§
      if (billState.filterType !== 'all') {
        allMatches = allMatches.filter(t => t.type === billState.filterType);
      }

      // 3. Â∫îÁî®Êó•ÊúüËøáÊª§
      if (billState.filterDate) {
        const [year, month] = billState.filterDate.split('-');
        allMatches = allMatches.filter(t => {
          const d = new Date(t.timestamp);
          return d.getFullYear() === parseInt(year) && (d.getMonth() + 1) === parseInt(month);
        });
      }

      // 4. ÊâãÂä®ÂàÜÈ°µ
      const start = billState.page * billState.pageSize;
      const end = start + billState.pageSize;
      const pageData = allMatches.slice(start, end);

      // Êõ¥Êñ∞Áä∂ÊÄÅ
      if (pageData.length < billState.pageSize) {
        billState.hasMore = false;
        loader.textContent = '‚Äî Ê≤°ÊúâÊõ¥Â§öËÆ∞ÂΩï‰∫Ü ‚Äî';
        loader.classList.remove('hidden'); // ‰øùÊåÅÊòæÁ§∫Â∫ïÁ∫ø
      } else {
        loader.textContent = 'Âä†ËΩΩ‰∏≠...';
      }

      if (pageData.length === 0 && isReset) {
        scrollList.insertAdjacentHTML('afterbegin',
          '<div class="bill-empty-msg" style="text-align:center; padding:40px; color:#999;">ÊöÇÊó†Áõ∏ÂÖ≥Ë¥¶Âçï</div>'
        );
      } else {
        renderBillItems(pageData, scrollList, loader);
      }

      billState.page++;

    } catch (error) {
      console.error("Âä†ËΩΩË¥¶ÂçïÂ§±Ë¥•:", error);
      loader.textContent = 'Âä†ËΩΩÂ§±Ë¥•';
    } finally {
      billState.isLoading = false;
      if (billState.hasMore) loader.classList.add('hidden'); // Â¶ÇÊûúËøòÊúâÊõ¥Â§öÔºåÂÖàÈöêËóèloadingÔºåÁ≠âÊªöÂä®ÂÜçÊòæÁ§∫
    }
  }

  // Ê∏≤ÊüìÂàóË°®È°π (Â∏¶Êúà‰ªΩÂàÜÁªÑ) - ‰øÆÂ§çÁâàÔºöÈò≤Ê≠¢ amount ‰∏∫Á©∫ÂØºËá¥Â¥©Ê∫É
  function renderBillItems(transactions, container, loaderEl) {
    let lastMonthStr = '';

    // Â¶ÇÊûú‰∏çÊòØÁ¨¨‰∏ÄÈ°µÔºåÂ∞ùËØïËé∑ÂèñÂàóË°®‰∏≠ÊúÄÂêé‰∏Ä‰∏™Êúà‰ªΩÊ†áÈ¢ò
    const existingSeparators = container.querySelectorAll('.bill-month-separator');
    if (existingSeparators.length > 0) {
      lastMonthStr = existingSeparators[existingSeparators.length - 1].textContent;
    }

    const fragment = document.createDocumentFragment();

    transactions.forEach(t => {
      // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÂºÄÂßã„Äë ---
      // Âº∫Âà∂Â∞ÜÈáëÈ¢ùËΩ¨Êç¢‰∏∫Êï∞Â≠óÔºåÂ¶ÇÊûúÊòØ undefined/null/NaNÔºåÂàôÈªòËÆ§‰∏∫ 0
      let safeAmount = Number(t.amount);
      if (isNaN(safeAmount)) {
        console.warn("Ê£ÄÊµãÂà∞ÂºÇÂ∏∏Ë¥¶ÂçïÊï∞ÊçÆ (ÈáëÈ¢ùÊó†Êïà):", t);
        safeAmount = 0;
      }
      // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÁªìÊùü„Äë ---

      const date = new Date(t.timestamp);
      const monthStr = `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà`;

      // Â¶ÇÊûúÊúà‰ªΩÂèòÂåñÔºåÊèíÂÖ•ÂàÜÂâ≤Á∫ø
      if (monthStr !== lastMonthStr) {
        const separator = document.createElement('div');
        separator.className = 'bill-month-separator';
        separator.textContent = monthStr;
        fragment.appendChild(separator);
        lastMonthStr = monthStr;
      }

      // Ê∏≤ÊüìÂçïÊù°ËÆ∞ÂΩï
      const timeStr = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
      const isIncome = t.type === 'income';
      const sign = isIncome ? '+' : '-';
      const colorClass = isIncome ? 'income' : 'expense';

      const item = document.createElement('div');
      item.className = 'bill-item';
      item.innerHTML = `
            <div class="bill-info">
                <div class="bill-title">${t.description || 'Êú™Áü•‰∫§Êòì'}</div>
                <div class="bill-time">${timeStr}</div>
            </div>
            <div class="bill-amount ${colorClass}">${sign}${safeAmount.toFixed(2)}</div>
        `;
      fragment.appendChild(item);
    });

    // ÊèíÂÖ•Âà∞ loader ‰πãÂâç
    container.insertBefore(fragment, loaderEl);
  }

  // 5. Áî®Êà∑ÂÖÖÂÄº
  async function handleUserTopUp() {
    const amountStr = await showCustomPrompt("ÂÖÖÂÄº", "ËØ∑ËæìÂÖ•ÂÖÖÂÄºÈáëÈ¢ù (CNY):", "", "number");
    if (!amountStr) return;

    const amount = parseFloat(amountStr);
    if (isNaN(amount) || amount <= 0) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ù");
      return;
    }

    await processTransaction(amount, 'income', '‰ΩôÈ¢ùÂÖÖÂÄº');
    // Âà∑Êñ∞ÁïåÈù¢
    openAlipayScreen();
    await showCustomAlert("ÂÖÖÂÄºÊàêÂäü", `ÊàêÂäüÂÖÖÂÄº ¬•${amount.toFixed(2)}`);
  }

  // Êö¥Èú≤Áªô HTML Ë∞ÉÁî®
  window.openAlipayScreen = openAlipayScreen;
  window.handleUserTopUp = handleUserTopUp;
  // ÂèòÈáèÂ≠òÂÇ®ÂΩìÂâçÈÄâ‰∏≠ÁöÑËßíËâ≤ID
  let selectedKinshipCharId = null;

  async function openKinshipSelector() {
    const characters = Object.values(state.chats).filter(c => !c.isGroup);
    if (characters.length === 0) return alert("Ê≤°ÊúâÂèØÁªëÂÆöÁöÑËßíËâ≤");

    const modal = document.getElementById('kinship-creation-modal');
    const listEl = document.getElementById('kinship-char-list');
    const limitInput = document.getElementById('kinship-limit-input');

    // --- Êñ∞Â¢ûÔºöËé∑ÂèñÊàñÂàõÂª∫Á±ªÂûãÈÄâÊã©ÂÆπÂô® ---
    let typeContainer = document.getElementById('kinship-type-container');
    if (!typeContainer) {
      // Â¶ÇÊûúHTMLÈáåÊ≤°ÊúâÔºåÂä®ÊÄÅÂàõÂª∫‰∏Ä‰∏™ÊèíÂÖ•Âà∞ÈáëÈ¢ùËæìÂÖ•Ê°ÜÂâçÈù¢
      typeContainer = document.createElement('div');
      typeContainer.id = 'kinship-type-container';
      typeContainer.style.cssText = "margin-bottom: 15px; display: flex; gap: 10px; justify-content: center;";

      const inputGroup = limitInput.parentElement; // Ëé∑ÂèñÈáëÈ¢ùËæìÂÖ•Ê°ÜÁöÑÁà∂ÂÆπÂô®
      inputGroup.parentElement.insertBefore(typeContainer, inputGroup); // ÊèíÂú®ËæìÂÖ•Ê°ÜÂâçÈù¢
    }

    // Ê∏≤Êüì‰∏§‰∏™ÈÄâÈ°πÊåâÈíÆ
    typeContainer.innerHTML = `
        <label class="radio-btn-wrapper" style="flex:1;">
            <input type="radio" name="kinship-type" value="grant" checked>
            <div class="radio-btn-content" style="text-align:center; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                <div style="font-weight:bold; color:#ff5252;">ÊàëÈÄÅTA</div>
                <div style="font-size:12px; color:#666;">(Ëä±ÊàëÁöÑÈí±)</div>
            </div>
        </label>
        <label class="radio-btn-wrapper" style="flex:1;">
            <input type="radio" name="kinship-type" value="request">
            <div class="radio-btn-content" style="text-align:center; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                <div style="font-weight:bold; color:#1677ff;">ÈóÆTAË¶Å</div>
                <div style="font-size:12px; color:#666;">(Ëä±TAÁöÑÈí±)</div>
            </div>
        </label>
    `;

    // Ê∑ªÂä†ÁÆÄÂçïÁöÑÁÇπÂáªÊ†∑ÂºèÂàáÊç¢ÈÄªËæë
    const radios = typeContainer.querySelectorAll('input[name="kinship-type"]');
    const updateStyles = () => {
      radios.forEach(radio => {
        const content = radio.nextElementSibling;
        if (radio.checked) {
          content.style.borderColor = radio.value === 'grant' ? '#ff5252' : '#1677ff';
          content.style.backgroundColor = radio.value === 'grant' ? '#fff0f0' : '#f0f7ff';
        } else {
          content.style.borderColor = '#ddd';
          content.style.backgroundColor = '#fff';
        }
      });
    };
    radios.forEach(r => r.addEventListener('change', updateStyles));
    updateStyles(); // ÂàùÂßãÂåñÊ†∑Âºè

    // --- ÈáçÁΩÆÁä∂ÊÄÅ ---
    listEl.innerHTML = '';
    selectedKinshipCharId = null;
    limitInput.value = '';

    // Ê∏≤ÊüìËßíËâ≤ÂàóË°®
    characters.forEach(char => {
      const item = document.createElement('div');
      item.className = 'clear-posts-item';
      item.dataset.id = char.id;

      item.onclick = () => {
        listEl.querySelectorAll('.clear-posts-item').forEach(el => {
          el.classList.remove('selected');
          const cb = el.querySelector('.checkbox');
          if (cb) cb.classList.remove('selected');
        });

        item.classList.add('selected');
        const cb = item.querySelector('.checkbox');
        cb.classList.add('selected');

        selectedKinshipCharId = char.id;
      };

      const avatar = char.settings.aiAvatar || defaultAvatar;

      item.innerHTML = `
            <div class="checkbox" style="pointer-events: none;"></div>
            <img src="${avatar}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover;">
            <span class="name" style="font-weight: 500; font-size: 16px;">${char.name}</span>
        `;
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
  }



  // 2. ÂèëÈÄÅÁî≥ËØ∑Ê∂àÊÅØ (ÊîØÊåÅÂèåÂêë)
  // type: 'grant' (ÊàëÈÄÅTA) | 'request' (ÈóÆTAË¶Å)
  async function sendKinshipRequest(chatId, limit, type = 'grant') {
    const chat = state.chats[chatId];
    const myNickname = chat.settings.myNickname || 'Êàë';

    // 1. ÊûÑÈÄ†Áî®Êà∑Ê∂àÊÅØ (ÊòæÁ§∫Âú®ËÅäÂ§©ÁïåÈù¢)
    let userContentText = "";
    if (type === 'grant') {
      userContentText = `[Êàë‰∏∫‰Ω†ÂºÄÈÄö‰∫Ü‚Äú‰∫≤Â±ûÂç°‚ÄùÔºåÊØèÊúàÈ¢ùÂ∫¶ ¬•${limit}]`;
    } else {
      userContentText = `[ÊàëÂêë‰Ω†ÂèëËµ∑‰∫Ü‚Äú‰∫≤Â±ûÂç°‚Äù‰ª£‰ªòÁî≥ËØ∑ÔºåÊØèÊúàÈ¢ùÂ∫¶ ¬•${limit}]`;
    }

    const userMsg = {
      role: 'user',
      type: 'kinship_request',
      content: userContentText,
      limit: limit,
      status: 'pending',
      requestType: type, // ËÆ∞ÂΩïÁ±ªÂûãÔºåÊñπ‰æøÂêéÁª≠Â§ÑÁêÜ
      timestamp: Date.now()
    };
    chat.history.push(userMsg);

    // 2. ÊûÑÈÄ†Á≥ªÁªüÊèêÁ§∫ (Áªô AI ÁúãÁöÑÈÄªËæë)
    let systemContentText = "";

    if (type === 'grant') {
      // --- ÊÉÖÂÜµ A: ÊàëÈÄÅ AI (AI Ë¢´ÂåÖÂÖª) ---
      systemContentText = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑(${myNickname})‰∏∫‰Ω†ÂºÄÈÄö‰∫ÜÊîØ‰ªòÂÆù‚Äú‰∫≤Â±ûÂç°‚ÄùÔºà‰∫≤ÂØÜ‰ªòÔºâÔºåÊØèÊúàÈ¢ùÂ∫¶ ¬•${limit}„ÄÇËøôÊÑèÂë≥ÁùÄ‰Ω†ÁöÑÊ∂àË¥πÂ∞ÜÁî±Áî®Êà∑‰π∞Âçï„ÄÇËØ∑Ê†πÊçÆ‰Ω†‰ª¨ÁöÑÂÖ≥Á≥ªÔºàÊòØÂê¶ÊÑøÊÑèÊé•ÂèóÂØπÊñπÁöÑÈ¶àËµ†ÔºâÂÜ≥ÂÆöÊé•ÂèóËøòÊòØÊãíÁªù„ÄÇËØ∑‰ΩøÁî® 'kinship_response' Êåá‰ª§ËøõË°åÂõûÂ∫î„ÄÇ]`;
    } else {
      // --- ÊÉÖÂÜµ B: ÊàëÈóÆ AI Ë¶Å (Ê±ÇÂåÖÂÖª) ---
      systemContentText = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑(${myNickname})Âêë‰Ω†Áî≥ËØ∑ÂºÄÈÄöÊîØ‰ªòÂÆù‚Äú‰∫≤Â±ûÂç°‚ÄùÔºà‰∫≤ÂØÜ‰ªòÔºâÔºåÊØèÊúàÈ¢ùÂ∫¶ ¬•${limit}„ÄÇËøôÊÑèÂë≥ÁùÄÁî®Êà∑ÁöÑÊ∂àË¥πÂ∞ÜÁî±‰Ω†‰π∞Âçï„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑÁªèÊµéÁä∂ÂÜµÂíåÂØπÁî®Êà∑ÁöÑÂÆ†Áà±Á®ãÂ∫¶ÔºåÂÜ≥ÂÆöÊé•ÂèóËøòÊòØÊãíÁªù„ÄÇËØ∑‰ΩøÁî® 'kinship_response' Êåá‰ª§ËøõË°åÂõûÂ∫î„ÄÇ]`;
    }

    const systemMsg = {
      role: 'system',
      content: systemContentText,
      timestamp: Date.now() + 1,
      isHidden: true
    };
    chat.history.push(systemMsg);

    await db.chats.put(chat);

    if (state.activeChatId === chatId) {
      appendMessage(userMsg, chat);
      // Ëß¶Âèë AI ÊÄùËÄÉ
      triggerAiResponse();
    } else {
      openChat(chatId);
    }
  }



  // ==========================================
  // ‚ñº‚ñº‚ñº Âü∫ÈáëÁêÜË¥¢Ê®°ÂùóÂÆåÊï¥ÈÄªËæë (‰øÆÂ§çÊï¥ÂêàÁâà) ‚ñº‚ñº‚ñº
  // ==========================================

  // 1. ÂàùÂßãÂåñÂü∫ÈáëÊï∞ÊçÆ
  async function initFunds() {
    const count = await db.funds.count();
    if (count === 0) {
      const initialFunds = [
        { id: 'f01', code: '001001', name: 'ÊãõË¥¢ËøõÂÆùÊ∑∑Âêà', riskLevel: 'medium', currentNav: 1.520, lastDayNav: 1.510, history: [] },
        { id: 'f02', code: '002088', name: 'ÁßëÊäÄÂÖàÈîãÊàêÈïø', riskLevel: 'high', currentNav: 2.305, lastDayNav: 2.280, history: [] },
        { id: 'f03', code: '003099', name: 'Á®≥ÂÅ•ÂÄ∫Âü∫A', riskLevel: 'low', currentNav: 1.050, lastDayNav: 1.049, history: [] },
        { id: 'f04', code: '005666', name: 'Êñ∞ËÉΩÊ∫êÁ≤æÈÄâ', riskLevel: 'high', currentNav: 3.100, lastDayNav: 3.200, history: [] },
        { id: 'f05', code: '008888', name: 'Ê∂àË¥πÁ∫¢Âà©ÊåáÊï∞', riskLevel: 'medium', currentNav: 1.880, lastDayNav: 1.885, history: [] },
        { id: 'f06', code: '110022', name: 'ÂÖ®ÁêÉÂåªÁñóÂåªËçØ', riskLevel: 'high', currentNav: 0.950, lastDayNav: 0.940, history: [] }
      ];
      await db.funds.bulkAdd(initialFunds);
    }
    // Ë°•ÂÖ®Èí±ÂåÖÂ≠óÊÆµ
    const wallet = await db.userWallet.get('main');
    if (wallet && !wallet.fundHoldings) {
      wallet.fundHoldings = [];
      await db.userWallet.put(wallet);
    }
  }

  // 2. ÂÖ®Â±Ä‰∏ªÈ¢òÊ£ÄÊü• (Ê†∏ÂøÉÔºö‰ΩôÈ¢ùÂèòÂä®Ëá™Âä®ÂàáÊç¢ÈªëÈáë/ËìùËâ≤)
  function checkThemeStatus() {
    const threshold = 10000; // ÈªëÈáëÈòàÂÄº
    const isGold = userBalance >= threshold;

    // ÂêåÊ≠• Alipay Âíå Fund ‰∏§‰∏™Â±èÂπï
    const screens = ['alipay-screen', 'fund-screen'];

    screens.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        if (isGold) {
          el.classList.add('theme-blackgold');
        } else {
          el.classList.remove('theme-blackgold');
        }
      }
    });

    // Êõ¥Êñ∞È¶ñÈ°µÊ†áÁ≠æ
    const statusTag = document.getElementById('alipay-status-tag');
    if (statusTag) {
      if (isGold) {
        statusTag.textContent = 'ÈªëÈáë‰ºöÂëò';
        statusTag.style.color = '#d4af37';
        statusTag.style.borderColor = '#d4af37';
      } else {
        statusTag.textContent = 'Ê†áÂáÜ‰ºöÂëò';
        statusTag.style.color = 'white';
        statusTag.style.borderColor = 'white';
      }
    }
    // Êõ¥Êñ∞È¶ñÈ°µ‰ΩôÈ¢ù
    const balanceDisplay = document.getElementById('alipay-balance-display');
    if (balanceDisplay) balanceDisplay.textContent = userBalance.toFixed(2);
  }

  // 3. Ê®°ÊãüÂ∏ÇÂú∫Ê≥¢Âä®
  // 3. Ê®°ÊãüÂ∏ÇÂú∫Ê≥¢Âä® (ÂçáÁ∫ßÁâàÔºöËÆ∞ÂΩïÂéÜÂè≤Ëµ∞Âäø)
  async function simulateFundMarket() {
    const funds = await db.funds.toArray();
    const updates = [];

    // Â∏ÇÂú∫Êï¥‰ΩìÊÉÖÁª™ (-0.02 ~ +0.02)
    const marketSentiment = (Math.random() - 0.45) * 0.05;

    for (const fund of funds) {
      // 1. Ë°•ÂÖ®ÂéÜÂè≤Êï∞ÊçÆ (Â¶ÇÊûúÊòØÊñ∞Âü∫ÈáëÔºåÂÖà‰º™ÈÄ† 15 ‰∏™ÂéÜÂè≤ÁÇπÔºåËÆ©ÂõæË°®Êúâ‰∏úË•øÁîª)
      if (!fund.history || fund.history.length === 0) {
        fund.history = [];
        let mockNav = fund.currentNav;
        for (let i = 0; i < 15; i++) {
          // ÂÄíÊé®ÂéÜÂè≤Êï∞ÊçÆ
          mockNav = mockNav * (1 - (Math.random() - 0.5) * 0.02);
          fund.history.unshift(parseFloat(mockNav.toFixed(4)));
        }
      }

      // 2. ËÆ°ÁÆó‰ªäÊó•Ê≥¢Âä®
      let volatility = 0.01; // ‰ΩéÈ£éÈô©Ê≥¢Âä®Â∞è
      if (fund.riskLevel === 'medium') volatility = 0.03;
      if (fund.riskLevel === 'high') volatility = 0.06; // È´òÈ£éÈô©Ê≥¢Âä®Â§ß

      const individualChange = (Math.random() - 0.5) * volatility;
      const changePercent = marketSentiment + individualChange;

      // 3. ËÆ∞ÂΩïÊóßÂáÄÂÄºÂà∞ÂéÜÂè≤ (Áî®‰∫éÁîªÂõæ)
      // ‰øùÊåÅ history ÊúÄÂ§öÂ≠ò 20 ‰∏™ÁÇπÔºåÈò≤Ê≠¢Êï∞ÊçÆÂ∫ìÊó†ÈôêËÜ®ËÉÄ
      if (fund.history.length >= 20) fund.history.shift();
      fund.history.push(fund.currentNav);

      // 4. Êõ¥Êñ∞ÂΩìÂâçÂáÄÂÄº
      const oldNav = fund.currentNav;
      let newNav = oldNav * (1 + changePercent);
      if (newNav < 0.1) newNav = 0.1; // Èò≤Ê≠¢Ë∑åÊàêË¥üÊï∞

      fund.lastDayNav = oldNav; // Êò®Êó•ÂáÄÂÄº
      fund.currentNav = parseFloat(newNav.toFixed(4)); // ‰ªäÊó•ÂáÄÂÄº

      updates.push(fund);
    }
    await db.funds.bulkPut(updates);
  }

  // 4. ÊâìÂºÄÂü∫ÈáëÈ°µÈù¢
  async function openFundScreen() {
    // ÁßªÈô§ Math.random Âà§Êñ≠ÔºåÊØèÊ¨°ÊâìÂºÄÈÉΩÊ®°Êãü‰∏ÄÊ¨°Ê≥¢Âä®ÔºåËê•ÈÄ†‚ÄúÂÆûÊó∂Ë°åÊÉÖ‚ÄùÁöÑÊÑüËßâ
    // ÊàñËÄÖ‰øùÁïô await simulateFundMarket(); 
    await simulateFundMarket();

    checkThemeStatus();
    await renderFundScreen();
    showScreen('fund-screen');
  }

  // 5. Ê∏≤ÊüìÂü∫Èáë‰∏ªÁïåÈù¢
  let activeFundTab = 'market'; // ÈªòËÆ§ÈÄâ‰∏≠Â∏ÇÂú∫

  async function renderFundScreen() {
    const funds = await db.funds.toArray();
    const wallet = await db.userWallet.get('main');
    const holdings = wallet.fundHoldings || [];

    let totalAssets = 0;
    let totalProfit = 0;
    let yesterdayProfit = 0;

    holdings.forEach(h => {
      const fund = funds.find(f => f.id === h.fundId);
      if (fund) {
        const marketValue = h.units * fund.currentNav;
        const costValue = h.units * h.cost;
        const yesterdayValue = h.units * fund.lastDayNav;

        totalAssets += marketValue;
        totalProfit += (marketValue - costValue);
        yesterdayProfit += (marketValue - yesterdayValue);
      }
    });

    document.getElementById('fund-total-assets').textContent = totalAssets.toFixed(2);

    const totalProfitEl = document.getElementById('fund-total-profit');
    totalProfitEl.textContent = (totalProfit >= 0 ? "+" : "") + totalProfit.toFixed(2);
    totalProfitEl.style.color = totalProfit >= 0 ? '#ff9c9c' : '#a0f0a0';

    const yesterdayProfitEl = document.getElementById('fund-yesterday-profit');
    yesterdayProfitEl.textContent = (yesterdayProfit >= 0 ? "+" : "") + yesterdayProfit.toFixed(2);

    // Ê†πÊçÆÂΩìÂâç Tab Ê∏≤ÊüìÂàóË°®
    if (activeFundTab === 'market') {
      renderFundMarketList(funds);
    } else {
      renderFundMyList(funds, holdings);
    }
  }
  // --- ËæÖÂä©ÂáΩÊï∞ÔºöÁîüÊàêËø∑‰Ω†Ëµ∞ÂäøÂõæ SVG ---
  function generateMiniChartSvg(dataPoints, isUp) {
    if (!dataPoints || dataPoints.length < 2) return '';

    const width = 60;  // ÂõæË°®ÂÆΩ
    const height = 20; // ÂõæË°®È´ò
    const color = isUp ? '#ff3b30' : '#4cd964'; // Á∫¢Ê∂®ÁªøË∑å

    // ÊâæÂá∫ÊúÄÂ§ßÊúÄÂ∞èÂÄºÔºåÁî®‰∫éÂΩí‰∏ÄÂåñ
    const min = Math.min(...dataPoints);
    const max = Math.max(...dataPoints);
    const range = max - min || 1; // Èò≤Ê≠¢Èô§‰ª•0

    // ÁîüÊàêË∑ØÂæÑÁÇπ
    // ÂùêÊ†áÁ≥ªÔºöXËΩ¥ÂùáÂåÄÂàÜÂ∏ÉÔºåYËΩ¥Ê†πÊçÆ‰ª∑Ê†ºËÆ°ÁÆó (‰ª∑Ê†ºË∂äÈ´òÔºåYË∂äÂ∞è/Ë∂äÈù†‰∏ä)
    const points = dataPoints.map((val, index) => {
      const x = (index / (dataPoints.length - 1)) * width;
      const y = height - ((val - min) / range) * height;
      return `${x},${y}`;
    }).join(' ');

    // ËøîÂõû SVG Â≠óÁ¨¶‰∏≤
    return `
        <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" style="overflow:visible;">
            <polyline fill="none" stroke="${color}" stroke-width="2" points="${points}" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;
  }
  // Ê∏≤ÊüìÂ∏ÇÂú∫ÂàóË°® (Â∏¶Ëµ∞ÂäøÂõæÁâà)
  function renderFundMarketList(funds) {
    const listEl = document.getElementById('fund-market-list');
    listEl.style.display = 'block';
    document.getElementById('fund-my-list').style.display = 'none';
    listEl.innerHTML = '';

    funds.forEach(fund => {
      const changeRate = ((fund.currentNav - fund.lastDayNav) / fund.lastDayNav) * 100;
      const isUp = changeRate >= 0;
      const colorClass = isUp ? 'fund-up' : 'fund-down';
      const sign = isUp ? '+' : '';

      // È£éÈô©Ê†áÁ≠æ
      let riskColorBg, riskColorText, riskText;
      if (fund.riskLevel === 'high') {
        riskColorBg = '#fff1f0'; riskColorText = '#ff4d4f'; riskText = 'È´òÈ£éÈô©';
      } else if (fund.riskLevel === 'medium') {
        riskColorBg = '#fff7e6'; riskColorText = '#fa8c16'; riskText = '‰∏≠È£éÈô©';
      } else {
        riskColorBg = '#f6ffed'; riskColorText = '#52c41a'; riskText = 'Á®≥ÂÅ•';
      }

      const riskTag = `<span class="fund-tag" style="background:${riskColorBg}; color:${riskColorText};">${riskText}</span>`;

      // ‚ñº‚ñº‚ñº ÁîüÊàêËµ∞ÂäøÂõæ ‚ñº‚ñº‚ñº
      // ÊääÂéÜÂè≤Êï∞ÊçÆÂíåÂΩìÂâçÊï∞ÊçÆÂêàÂπ∂Ëµ∑Êù•ÁîªÂõæ
      const chartData = [...(fund.history || []), fund.currentNav];
      const chartSvg = generateMiniChartSvg(chartData, isUp);

      const item = document.createElement('div');
      item.className = 'fund-item';
      item.onclick = () => openFundTradeModal('buy', fund);

      // ÈáçÊñ∞Â∏ÉÂ±ÄÔºöÂ∑¶Ëæπ‰ø°ÊÅØÔºå‰∏≠Èó¥ÂõæË°®ÔºåÂè≥ËæπÊï∞ÊçÆ
      item.innerHTML = `
            <div class="fund-info" style="flex: 1.2;">
                <h4 style="margin-bottom:6px; font-size:15px;">${fund.name}</h4>
                <div class="fund-tags">
                    <span class="fund-tag" style="background:#f5f5f5; color:#999;">${fund.code}</span>
                    ${riskTag}
                </div>
            </div>
            
            <div class="fund-chart" style="flex: 1; display:flex; justify-content:center; align-items:center; opacity:0.8;">
                ${chartSvg}
            </div>

            <div class="fund-data" style="flex: 1; text-align:right;">
                <div class="fund-change ${colorClass}" style="font-size:18px; font-weight:bold;">${sign}${changeRate.toFixed(2)}%</div>
                <div class="fund-nav" style="font-size:11px; color:#999; margin-top:4px;">ÂáÄÂÄº ${fund.currentNav.toFixed(4)}</div>
            </div>
        `;
      listEl.appendChild(item);
    });
  }

  // Ê∏≤ÊüìÊåÅ‰ªìÂàóË°®
  function renderFundMyList(funds, holdings) {
    const listEl = document.getElementById('fund-my-list');
    listEl.style.display = 'block';
    document.getElementById('fund-market-list').style.display = 'none';
    listEl.innerHTML = '';

    if (holdings.length === 0) {
      listEl.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">ÊöÇÊó†ÊåÅ‰ªì</div>';
      return;
    }

    holdings.forEach(h => {
      const fund = funds.find(f => f.id === h.fundId);
      if (!fund) return;

      const marketValue = h.units * fund.currentNav;
      const costValue = h.units * h.cost;
      const profit = marketValue - costValue;
      const profitRate = (profit / costValue) * 100;

      const isUp = profit >= 0;
      const colorClass = isUp ? 'fund-up' : 'fund-down';
      const sign = isUp ? '+' : '';

      const item = document.createElement('div');
      item.className = 'fund-item';
      item.onclick = () => openFundTradeModal('sell', fund, h); // ÁÇπÂáªÂçñÂá∫
      item.innerHTML = `
            <div class="fund-info">
                <h4>${fund.name}</h4>
                <div style="font-size:12px; color:#666;">ÊåÅÊúâ ${h.units.toFixed(2)} ‰ªΩ</div>
            </div>
            <div class="fund-data">
                <div class="fund-change ${colorClass}">${sign}${profit.toFixed(2)}</div>
                <div class="fund-nav" style="font-size:11px;">${sign}${profitRate.toFixed(2)}%</div>
            </div>
        `;
      listEl.appendChild(item);
    });
  }

  // ÂàáÊç¢ Tab
  function switchFundTab(tab) {
    activeFundTab = tab;
    // Êõ¥Êñ∞ CSS Á±ª
    document.querySelectorAll('.frame-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-fund-${tab}`).classList.add('active');
    renderFundScreen();
  }

  // 6. ‰∫§ÊòìÁõ∏ÂÖ≥
  let currentTradeContext = null;

  async function openFundTradeModal(type, fund, holding = null) {
    currentTradeContext = { type, fund, holding };
    const modal = document.getElementById('fund-trade-modal');

    // Ëé∑Âèñ‰ΩôÈ¢ù
    const wallet = await db.userWallet.get('main');
    const balance = wallet.balance || 0;

    document.getElementById('fund-trade-name').textContent = fund.name;
    document.getElementById('fund-trade-code').textContent = fund.code;
    document.getElementById('fund-trade-nav').textContent = fund.currentNav.toFixed(4);

    const changeRate = ((fund.currentNav - fund.lastDayNav) / fund.lastDayNav) * 100;
    const changeEl = document.getElementById('fund-trade-change');
    changeEl.textContent = (changeRate >= 0 ? "+" : "") + changeRate.toFixed(2) + "%";
    changeEl.className = changeRate >= 0 ? 'fund-up' : 'fund-down';

    const inputEl = document.getElementById('fund-trade-amount');
    inputEl.value = '';
    const confirmBtn = document.getElementById('fund-confirm-btn');
    const titleEl = document.getElementById('fund-trade-title');
    const labelEl = document.getElementById('fund-trade-label');
    const infoEl = document.getElementById('fund-trade-info');

    if (type === 'buy') {
      titleEl.textContent = '‰π∞ÂÖ•Âü∫Èáë';
      labelEl.innerHTML = `‰π∞ÂÖ•ÈáëÈ¢ù (‰ΩôÈ¢ù: ¬•<span id="fund-wallet-balance">${balance.toFixed(2)}</span>)`;
      infoEl.textContent = "Ë¥πÁéá 0.00%";
      confirmBtn.textContent = "Á°ÆËÆ§‰π∞ÂÖ•";
      confirmBtn.style.backgroundColor = "#1677ff";
      currentTradeContext.maxAmount = balance;
    } else {
      titleEl.textContent = 'ÂçñÂá∫Âü∫Èáë';
      const holdingVal = holding.units * fund.currentNav;
      labelEl.innerHTML = `ÂçñÂá∫ÈáëÈ¢ù (ÊåÅÊúâ: ¬•<span id="fund-wallet-balance">${holdingVal.toFixed(2)}</span>)`;
      infoEl.textContent = `ÊåÅÊúâ‰ªΩÈ¢ù: ${holding.units.toFixed(2)} ‰ªΩ`;
      confirmBtn.textContent = "Á°ÆËÆ§ÂçñÂá∫";
      confirmBtn.style.backgroundColor = "#ff9800";
      currentTradeContext.maxAmount = holdingVal;
    }

    modal.classList.add('visible');
  }

  // Á°ÆËÆ§‰∫§Êòì (ÁªëÂÆöÂú®HTML onclick)
  window.handleFundTradeConfirm = async function () {
    if (!currentTradeContext) return;
    const amount = parseFloat(document.getElementById('fund-trade-amount').value);

    if (isNaN(amount) || amount <= 0) {
      document.getElementById('custom-modal-overlay').style.zIndex = 3002;
      await showCustomAlert("ÊèêÁ§∫", "ËØ∑ËæìÂÖ•ÊúâÊïàÈáëÈ¢ù");
      document.getElementById('custom-modal-overlay').style.zIndex = '';
      return;
    }
    if (amount > currentTradeContext.maxAmount) {
      document.getElementById('custom-modal-overlay').style.zIndex = 3002;
      await showCustomAlert("Â§±Ë¥•", "‰ΩôÈ¢ùÊàñ‰ªΩÈ¢ù‰∏çË∂≥");
      document.getElementById('custom-modal-overlay').style.zIndex = '';
      return;
    }

    const { type, fund } = currentTradeContext;
    const wallet = await db.userWallet.get('main');
    let holdings = wallet.fundHoldings || [];

    if (type === 'buy') {
      const success = await processTransaction(amount, 'expense', `Âü∫Èáë‰π∞ÂÖ•-${fund.name}`);
      if (!success) return;

      const existing = holdings.find(h => h.fundId === fund.id);
      const newUnits = amount / fund.currentNav;

      if (existing) {
        const totalCost = (existing.units * existing.cost) + amount;
        existing.units += newUnits;
        existing.cost = totalCost / existing.units;
      } else {
        holdings.push({ fundId: fund.id, units: newUnits, cost: fund.currentNav });
      }
      await showCustomAlert("ÊàêÂäü", "‰π∞ÂÖ•ÊàêÂäüÔºÅ");
    } else {
      const idx = holdings.findIndex(h => h.fundId === fund.id);
      if (idx === -1) return;

      const unitsToSell = amount / fund.currentNav;
      holdings[idx].units -= unitsToSell;
      if (holdings[idx].units < 0.01) holdings.splice(idx, 1);

      await processTransaction(amount, 'income', `Âü∫ÈáëÂçñÂá∫-${fund.name}`);
      await showCustomAlert("ÊàêÂäü", "ÂçñÂá∫ÊàêÂäüÔºÅ");
    }

    wallet.fundHoldings = holdings;
    await db.userWallet.put(wallet);

    // ‰∫§ÊòìÂêéÁ´ãÂç≥Ê£ÄÊü•‰∏ªÈ¢ò
    checkThemeStatus();

    document.getElementById('fund-trade-modal').classList.remove('visible');
    renderFundScreen();
  };

  // Êö¥Èú≤ÁªôÂÖ®Â±Ä
  window.openFundScreen = openFundScreen;
  window.switchFundTab = switchFundTab; // ËøôÊ¨°Ë°•‰∏ä‰∫ÜÔºÅ
  window.refreshFundMarket = async () => {
    await showCustomAlert("Âà∑Êñ∞‰∏≠", "Ê≠£Âú®Êõ¥Êñ∞Ë°åÊÉÖ...");
    await simulateFundMarket();
    await renderFundScreen();
  };
  let auctionState = {
    isActive: false,
    item: null,
    currentPrice: 0,
    timer: 30,
    timerId: null,
    npcIntervalId: null,
    lastBidder: null, // { name: string, type: 'user'|'npc'|'char', id: string }
    bidHistory: []
  };

  // 1. ÊâìÂºÄÊãçÂçñË°å
  async function openAuctionScreen() {
    showScreen('auction-screen');
    // Â¶ÇÊûúÂΩìÂâçÊ≤°ÊúâÊ¥ªÂä®ÊãçÂçñÔºåÊàñËÄÖÊãçÂçñÂ∑≤ÁªìÊùüÔºåÁîüÊàê‰∏Ä‰∏™Êñ∞ÁöÑÈ¢ÑËßà
    if (!auctionState.isActive) {
      document.getElementById('auction-item-img').style.display = 'none';
      document.getElementById('auction-loading').style.display = 'block';
      document.getElementById('auction-item-name').textContent = "Ê≠£Âú®ÊêúÂØªÈªëÂ∏Ç...";
      document.getElementById('auction-item-desc').textContent = "";

      // Ëá™Âä®ÂºÄÂßãÁîüÊàê
      generateNewAuctionItem();
    }
  }


  async function generateNewAuctionItem() {
    const btn = document.querySelector('#auction-screen .action-btn');
    btn.style.pointerEvents = 'none';
    btn.textContent = 'ËøõË¥ß‰∏≠...';

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey) {
      alert("ËØ∑ÂÖàÈÖçÁΩÆAPIÔºÅ");
      btn.style.pointerEvents = 'auto';
      btn.textContent = 'Êñ∞ÊãçÂìÅ';
      return;
    }

    // --- 1. Êô∫ËÉΩËÆæÂÆöÂà§ÂÆöÈÄªËæë ---
    let auctionContext = "";

    // Â∞ùËØïÂØªÊâæÂåÖÂê´ "ÈªëÂ∏Ç" Êàñ "ÊãçÂçñ" ÁöÑ‰∏ñÁïå‰π¶
    const auctionBook = state.worldBooks.find(wb => wb.name.includes('ÈªëÂ∏Ç') || wb.name.includes('ÊãçÂçñ'));

    if (auctionBook) {
      console.log("‚úÖ ÊâæÂà∞‰∏ìÂ±ûÊãçÂçñËÆæÂÆö‰π¶:", auctionBook.name);
      const contentPreview = auctionBook.content
        .filter(e => e.enabled !== false)
        .map(e => e.content).join('; ');
      // Â¶ÇÊûúÊúâ‰∏ñÁïå‰π¶ÔºåÂº∫Âà∂ AI ÈÅµÂÆà‰∏ñÁïå‰π¶
      auctionContext = `
    „ÄêÂΩìÂâçÊãçÂçñË°åÁâπÊÆä‰∏ñÁïåËßÇ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë: 
    ${contentPreview}
    
    (ËØ∑Ê†πÊçÆ‰∏äËø∞ÁâπÊÆä‰∏ñÁïåËßÇÁîüÊàêÁ¨¶ÂêàËÆæÂÆöÁöÑÊãçÂìÅÂíåNPCÔºåÂøΩÁï•Áé∞ÂÆû‰∏ñÁïåÁöÑÈôêÂà∂)
    `;
    } else {
      console.log("‚ÑπÔ∏è Êú™ÊâæÂà∞‰∏ìÂ±ûËÆæÂÆöÔºå‰ΩøÁî®ÈªòËÆ§Ë±™Â•¢ËÆæÂÆö");
      auctionContext = `
    „ÄêÈªòËÆ§ÊãçÂìÅÁ±ªÂà´Ê∏ÖÂçï„Äë:
    1. È°∂Á∫ßÁè†ÂÆùÔºöÁ®ÄÊúâÈíªÁü≥È°πÈìæ„ÄÅÁ∫¢ËìùÂÆùÁü≥ÊàíÊåá„ÄÅÁöáÂÜ†„ÄÅÊâãÈïØÔºàÈÄÇÂêàÈÄÅÁªôÊÅã‰∫∫Ôºâ„ÄÇ
    2. ‰º†‰∏ñÂè§Ëë£ÔºöÊòéÊ∏ÖÁì∑Âô®„ÄÅÊ¨ßÊ¥≤‰∏≠‰∏ñÁ∫™Âè§Áâ©„ÄÅÁªùÁâàÂêçË°®„ÄÅÁéâÁé∫„ÄÇ
    3. Ëâ∫ÊúØÁèçÂìÅÔºö‰∏ñÁïåÂêçÁîªÔºàËôöÊûÑÁöÑÁúüËøπÔºâ„ÄÅËëóÂêçÈõïÂ°ë„ÄÇ
    4. Â•¢ÂçéËµÑ‰∫ßÔºöÊµ∑Â≤õÂ•ëÁ∫¶„ÄÅÁßÅ‰∫∫È£ûÊú∫„ÄÅÈ°∂Á∫ßË±™ËΩ¶„ÄÅÂ∫ÑÂõ≠Èí•Âåô„ÄÇ
    5. Ê∏∏ÊàèÊäΩÂç°ÔºöÁèçÁ®ÄÊ∏∏ÊàèÈÅìÂÖ∑„ÄÅÁªùÁâàÁöÆËÇ§Ë¥¶Âè∑„ÄÇ
    
    (ËØ∑‰ªÖ‰ªé‰∏äËø∞ 5 ‰∏™Á±ªÂà´‰∏≠ÈÄâÊã©‰∏ÄÁßçÁîüÊàê)
    `;
    }

    // 2. Ëé∑ÂèñËßíËâ≤ÂàóË°® (Áî®‰∫é AI È¢ÑÂà§Ë∞Å‰ºö‰π∞)
    const charList = Object.values(state.chats).filter(c => !c.isGroup).map(c => {
      const persona = c.settings?.aiPersona || 'Êú™ËÆæÂÆö‰∫∫ËÆæ';
      return `${c.name}(${persona.substring(0, 50)}...)`;
    }).join('\n');

    const systemPrompt = `
    ‰Ω†ÊòØ‰∏Ä‰ΩçÈ°∂Á∫ßÊãçÂçñË°åÁöÑÈ¶ñÂ∏≠ÊãçÂçñÂÆò„ÄÇ
    
    # Ê†∏ÂøÉ‰ªªÂä°
    ËØ∑Ê†πÊçÆ‰∏ãÈù¢ÁöÑ„ÄêËÆæÂÆöÊù•Ê∫ê„ÄëÔºåÂÆåÊàê‰∏§‰∏™‰ªªÂä°Ôºö
    1. ÁîüÊàê‰∏Ä‰ª∂ÊûÅÂÖ∑‰ª∑ÂÄºÁöÑÊãçÂìÅ„ÄÇ
    2. ÁîüÊàê‰∏ÄÊâπÁ¨¶ÂêàËØ•‰∏ñÁïåËßÇËÉåÊôØÁöÑ‚ÄúË∑Ø‰∫∫NPCÁ´ûÊãçËÄÖ‚Äù„ÄÇ
    
    ${auctionContext}
    
    # ‰ªªÂä° BÔºö‰π∞ÂÆ∂ÊÑèÂêëÂàÜÊûê
    ‰∏ãÈù¢ÊòØ‰ªäÂ§©ÁöÑÂèóÈÇÄÂÆæÂÆ¢ÂêçÂçïÔºàÁî®Êà∑ÁöÑÈáçË¶ÅËßíËâ≤ÔºâÔºö
    ${charList}
    ËØ∑ÂàÜÊûêËøô‰ª∂ÊãçÂìÅÂØπÂì™‰∫õÂÆæÂÆ¢ÊúâÂê∏ÂºïÂäõÔºü
    
    # ÂõûÂ§çÊ†ºÂºèÈìÅÂæã
    ÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°Ôºö
    {
        "item": {
            "name": "Áâ©ÂìÅÂêçÁß∞ (‰∏≠ÊñáÔºåÂêçÂ≠óË¶ÅÈú∏Ê∞îÊàñ‰ºòÈõÖ)",
            "description": "‰∏ÄÊÆµÁ≤æÂΩ©ÁöÑÊèèËø∞ÔºåÂº∫Ë∞ÉÂÖ∂Á®ÄÊúâÂ∫¶„ÄÅÂéÜÂè≤‰ª∑ÂÄºÊàñÁâπÊÆäÂäüËÉΩÔºà50Â≠ó‰ª•ÂÜÖÔºå‰∏≠ÊñáÔºâ",
            "basePrice": ÂàùÂßã‰ª∑Ê†º(Êï∞Â≠ó, Âª∫ËÆÆ 10000 ‰ª•‰∏ä),
            "image_prompt": "Áâ©ÂìÅÁöÑËã±ÊñáËßÜËßâÊèèËø∞, high quality, cinematic lighting, detailed, clean background"
        },
        "interested_bidders": ["ÂÆæÂÆ¢AÁöÑÂêçÂ≠ó", "ÂÆæÂÆ¢BÁöÑÂêçÂ≠ó"],
        "world_npcs": ["NPCÂêçÂ≠ó1", "NPCÂêçÂ≠ó2", "NPCÂêçÂ≠ó3", "NPCÂêçÂ≠ó4", "NPCÂêçÂ≠ó5"]
    }
    
    Ê≥®ÊÑèÔºö
    1. image_prompt ÂøÖÈ°ªÂÖ®ÊòØËã±ÊñáÂçïËØç„ÄÇ
    2. interested_bidders Êï∞ÁªÑÈáåÂè™ËÉΩÂ°´‰∏äÈù¢‚ÄúÂèóÈÇÄÂÆæÂÆ¢ÂêçÂçï‚ÄùÈáåÂá∫Áé∞ËøáÁöÑÂêçÂ≠ó„ÄÇ
    3. world_npcs ÊòØ‰Ω†Ê†πÊçÆ‰∏ñÁïåËßÇÁîüÊàêÁöÑË∑Ø‰∫∫„ÄÇ‰æãÂ¶ÇÔºöÂ¶ÇÊûúÊòØ‰øÆ‰ªô‰∏ñÁïåÔºåÁîüÊàê"Èùí‰∫ëÈó®ÈïøËÄÅ"„ÄÅ"Êï£‰øÆÂ§ßËÉΩ"ÔºõÂ¶ÇÊûúÊòØËµõÂçö‰∏ñÁïåÔºåÁîüÊàê"ËçíÂùÇÂÖ¨Âè∏È´òÁÆ°"„ÄÅ"Â§ú‰πãÂüé‰∏≠Èó¥‰∫∫"„ÄÇÂ¶ÇÊûúÊòØÈªòËÆ§ËÆæÂÆöÔºåÁîüÊàê"Áü≥Ê≤πÁéãÂ≠ê"„ÄÅ"Á•ûÁßòÊî∂ËóèÂÆ∂"Á≠â„ÄÇ
    `;

    try {
      let isGemini = proxyUrl.includes('generativelanguage');
      let config = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: 'ÁîüÊàê‰∏Ä‰ª∂ÊãçÂìÅ' }]);

      const response = isGemini ?
        await fetch(config.url, config.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
          body: JSON.stringify({ model: model, messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: 'ÁîüÊàê‰∏Ä‰ª∂ÊãçÂìÅ' }], temperature: 1.0 })
        });

      if (!response.ok) throw new Error("APIËØ∑Ê±ÇÂ§±Ë¥•");
      const data = await response.json();
      const text = getGeminiResponseText(data);
      const json = JSON.parse(text.replace(/^```json\s*/, '').replace(/```$/, ''));

      const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(json.item.image_prompt)}`;
      const limitMultiplier = 1.5 + Math.random() * 2.0;

      auctionState.item = json.item;
      auctionState.basePrice = json.item.basePrice;
      auctionState.limitPrice = json.item.basePrice * limitMultiplier;
      auctionState.currentPrice = json.item.basePrice;
      auctionState.isActive = true;
      auctionState.timer = 20;
      auctionState.lastBidder = null;
      auctionState.bidHistory = [];

      auctionState.interestedChars = json.interested_bidders || [];
      // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„Äë‰øùÂ≠òÁîüÊàêÁöÑ NPC ÂàóË°®
      auctionState.worldNPCs = json.world_npcs || [];

      console.log("ÂØπÊú¨ÊãçÂìÅÊÑüÂÖ¥Ë∂£ÁöÑËßíËâ≤:", auctionState.interestedChars);
      console.log("Êú¨Âú∫Ë∑Ø‰∫∫NPC:", auctionState.worldNPCs);

      // Êõ¥Êñ∞UI
      document.getElementById('auction-item-name').textContent = json.item.name;
      document.getElementById('auction-item-desc').textContent = json.item.description;
      document.getElementById('auction-current-price').textContent = `¬• ${json.item.basePrice.toLocaleString()}`;

      const imgEl = document.getElementById('auction-item-img');
      imgEl.src = imageUrl;
      imgEl.style.display = 'block';
      document.getElementById('auction-loading').style.display = 'none';

      document.getElementById('auction-log').innerHTML = '<div style="color:#666; padding:5px;">ÊãçÂçñÂºÄÂßãÔºÅÂ∫ï‰ª∑ ¬•' + json.item.basePrice + '</div>';

      startAuctionLoop();

    } catch (e) {
      console.error(e);
      alert("ËøõË¥ßÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
    } finally {
      btn.style.pointerEvents = 'auto';
      btn.textContent = 'Êñ∞ÊãçÂìÅ';
    }
  }

  // Êñ∞Â¢ûÔºöÊãçÂçñÂ∏àÂñäËØùÁä∂ÊÄÅ
  let auctioneerState = 0;

  function startAuctionLoop() {
    if (auctionState.timerId) clearInterval(auctionState.timerId);
    if (auctionState.npcIntervalId) clearInterval(auctionState.npcIntervalId);

    const timerEl = document.getElementById('auction-timer');
    const logEl = document.getElementById('auction-log'); // Ëé∑ÂèñÊó•ÂøóÂå∫Âüü
    auctioneerState = 0; // ÈáçÁΩÆÂñäËØù

    // ÂÄíËÆ°Êó∂ÈÄªËæë
    auctionState.timerId = setInterval(() => {
      auctionState.timer--;

      // Ê†ºÂºèÂåñÂÄíËÆ°Êó∂ÊòæÁ§∫
      timerEl.textContent = `${auctionState.timer.toFixed(1)}s`;

      // ËßÜËßâË≠¶Âëä
      if (auctionState.timer <= 5) {
        timerEl.style.color = '#ff0055'; // Á∫¢Ëâ≤Á¥ßËø´
        timerEl.style.textShadow = '0 0 10px #ff0055';
      } else {
        timerEl.style.color = '#f0ad4e';
        timerEl.style.textShadow = 'none';
      }

      // --- Áé©Ê≥ïÂ¢ûÂº∫ÔºöÊãçÂçñÂ∏àÂñäËØù ---
      if (auctionState.timer <= 10 && auctioneerState === 0) {
        addAuctionLog("System", `üî® ${auctionState.currentPrice} Á¨¨‰∏ÄÊ¨°ÔºÅ`);
        auctioneerState = 1;
      }
      if (auctionState.timer <= 5 && auctioneerState === 1) {
        addAuctionLog("System", `üî® ${auctionState.currentPrice} Á¨¨‰∫åÊ¨°ÔºÅËøòÊúâ‰∫∫Âä†‰ª∑ÂêóÔºü`);
        auctioneerState = 2;
      }
      if (auctionState.timer <= 2 && auctioneerState === 2) {
        addAuctionLog("System", `üî® ${auctionState.currentPrice} Á¨¨‰∏âÊ¨°ÔºÅÂç≥Â∞ÜÊàê‰∫§...`);
        auctioneerState = 3;
      }

      if (auctionState.timer <= 0) {
        endAuction();
      }
    }, 1000); // ËøôÈáåÂÖ∂ÂÆûÂèØ‰ª•ÊîπÊàê 100ms Â¢ûÂä†Âπ≥ÊªëÂ∫¶Ôºå‰ΩÜ 1000ms Â§üÁî®‰∫Ü

    // NPC Âá∫‰ª∑ÈÄªËæë (Á®çÂæÆÂä†Âø´È¢ëÁéá)
    auctionState.npcIntervalId = setInterval(() => {
      if (!auctionState.isActive) return;

      // Â¢ûÂä†ÈöèÊú∫ÊÄßÔºö‰∏çÊòØÊØèÊ¨°tickÈÉΩÊ£ÄÊü•ÔºåËÄåÊòØÊõ¥ÈöèÊú∫
      if (Math.random() < 0.7) {
        npcBid();
      }
    }, 800);
  }

  // 4. NPC/ÁÜü‰∫∫ Âá∫‰ª∑ÈÄªËæë (‰øÆÂ§çÁâàÔºöÊõ¥Êô∫ËÉΩ„ÄÅÊúâÊú∫‰ºöËµ¢)
  // 4. NPC/ÁÜü‰∫∫ Âá∫‰ª∑ÈÄªËæë (AI‰∫íÊêèÁâà)
  function npcBid() {
    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÂà†Èô§‰∫Ü "if (lastBidder !== 'user') return" ËøôË°å‰ª£Á†Å
    // Áé∞Âú®ÂÖÅËÆ∏ AI ‰πãÈó¥‰∫íÁõ∏Á´û‰ª∑Ôºå‰∏çÈúÄË¶ÅÁ≠âÁé©ÂÆ∂

    // 1. ‰ª∑Ê†ºÂ∞ÅÈ°∂Ê£ÄÊü• (Èò≤Ê≠¢Êó†Èôê‰∫íÂà∑)
    if (auctionState.currentPrice >= auctionState.limitPrice) {
      // Ë∂ÖËøá‰º∞ÂÄº‰∏äÈôêÂêéÔºå90%Ê¶ÇÁéáÂÅúÊ≠¢Ôºå10%Ê¶ÇÁéá‚Äú‰∏äÂ§¥‚ÄùÁªßÁª≠Ë∑ü
      if (Math.random() > 0.1) return;
    }

    // 2. ËÆ°ÁÆóÂá∫‰ª∑Ê¶ÇÁéá (‰ª∑Ê†ºË∂äÈ´òÔºåË∑üÊãçË∂äÁäπË±´)
    const premiumRatio = auctionState.currentPrice / auctionState.basePrice;
    const bidChance = 0.8 / (premiumRatio * premiumRatio); // Á®çÂæÆË∞ÉÈ´ò‰∫ÜÁ≥ªÊï∞ÔºåËÆ©ÂêéÊúü‰πüÊï¢Ë∑ü
    if (Math.random() > bidChance) return;

    // 3. Á°ÆÂÆöÊú¨Ê¨°Ë∞ÅÊÉ≥Âá∫‰ª∑ (30% ËßíËâ≤ vs 70% NPC)
    let candidate = null;

    // Ëé∑ÂèñÊÑüÂÖ¥Ë∂£ÁöÑËßíËâ≤ÂàóË°®
    const allCharacters = Object.values(state.chats).filter(c => !c.isGroup);
    const interestedCandidates = allCharacters.filter(c =>
      auctionState.interestedChars && auctionState.interestedChars.includes(c.name)
    );

    // È™∞Â≠êÂà§ÂÆöÔºöÊú¨Ê¨°ÊòØÁÜü‰∫∫Âá∫Êâã(30%) ËøòÊòØ ÂúüË±™Ë∑Ø‰∫∫Âá∫Êâã(70%)
    if (interestedCandidates.length > 0 && Math.random() < 0.3) {
      const char = interestedCandidates[Math.floor(Math.random() * interestedCandidates.length)];
      candidate = { name: char.name, type: 'char', id: char.id };
    } else {
      // --- NPC Ê±† ---
      let npcName = "Á•ûÁßò‰π∞ÂÆ∂";

      // ‰ºòÂÖà‰ªéÁîüÊàêÁöÑÂàóË°®ÈáåÊâæÔºåÂπ∂‰∏îÂ∞ΩÈáèÊâæ‰∏Ä‰∏™‚Äú‰∏çÊòØÂΩìÂâçÊúÄÈ´òÂá∫‰ª∑ËÄÖ‚ÄùÁöÑ‰∫∫
      if (auctionState.worldNPCs && auctionState.worldNPCs.length > 0) {
        // ËøáÊª§ÊéâÂΩìÂâçÊ≠£Âú®È¢ÜÂÖàÁöÑ‰∫∫ÔºåÂà∂ÈÄ†‚ÄúÁ´û‰∫â‚ÄùÊÑü
        const rivals = auctionState.worldNPCs.filter(n =>
          !auctionState.lastBidder || n !== auctionState.lastBidder.name
        );

        if (rivals.length > 0) {
          npcName = rivals[Math.floor(Math.random() * rivals.length)];
        } else {
          npcName = auctionState.worldNPCs[0];
        }
      } else {
        // ÂÖúÂ∫ïÂêçÂçï
        const richNames = ["Á•ûÁßò‰π∞ÂÆ∂", "ËãèÂØåÊØîVIP", "Ëø™ÊãúÁéãÂÆ§ÊàêÂëò", "ÂçéÂ∞îË°óÊäïËµÑ‰∫∫",
          "Âú∞‰∫ßÂ§ß‰∫®", "‰ΩéË∞ÉÁöÑÊî∂ËóèÂÆ∂", "Êüê‰∏äÂ∏ÇÂÖ¨Âè∏CEO", "Ê∏ØÂ≤õÂêçÂ™õ", "Áü≥Ê≤πÁéãÂ≠ê"];
        npcName = richNames[Math.floor(Math.random() * richNames.length)];
      }

      candidate = { name: npcName, type: 'npc' };
    }

    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÈò≤Ëá™Â∑±È°∂Ëá™Â∑±
    // Â¶ÇÊûúÊÉ≥Âá∫‰ª∑ÁöÑ‰∫∫ÔºåÂ∑≤ÁªèÊòØÂΩìÂâçÊúÄÈ´òÂá∫‰ª∑ËÄÖ‰∫ÜÔºåÈÇ£Â∞±‰∏çÂá∫‰∫ÜÔºåÁ≠âÂà´‰∫∫È°∂
    if (auctionState.lastBidder && auctionState.lastBidder.name === candidate.name) {
      return;
    }

    // 4. ÂÜ≥ÂÆöÂä†‰ª∑ÂπÖÂ∫¶
    let increasePercent = 0.05; // ÈªòËÆ§Âä† 5%

    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ3„ÄëNPC Êõ¥ÊúâÈí±ÈÄªËæë
    // Â¶ÇÊûúÊòØ NPCÔºåÊúâ 30% ÁöÑÊ¶ÇÁéá‚ÄúË¥¢Â§ßÊ∞îÁ≤ó‚ÄùÔºåÁõ¥Êé•Âä†‰ª∑ 10%~15%ÔºåÂéãÂà∂ÂÖ®Âú∫
    if (candidate.type === 'npc' && Math.random() < 0.3) {
      increasePercent = 0.15;
    }

    const newPrice = Math.floor(auctionState.currentPrice * (1 + increasePercent));
    updateAuctionState(newPrice, candidate);
  }

  // 5. Áî®Êà∑Âá∫‰ª∑ÈÄªËæë
  async function placeBid(multiplier) {
    if (!auctionState.isActive) return;

    let bidAmount = 0;
    if (multiplier === 'custom') {
      const input = await showCustomPrompt("ÊâãÂä®Âá∫‰ª∑", "ËæìÂÖ•ÈáëÈ¢ù (‰∏çËÉΩ‰Ωé‰∫éÂΩìÂâç‰ª∑)", auctionState.currentPrice + 100, 'number');
      if (!input) return;
      bidAmount = parseFloat(input);
    } else {
      bidAmount = Math.floor(auctionState.currentPrice * multiplier);
    }

    if (bidAmount <= auctionState.currentPrice) {
      alert("Âá∫‰ª∑ÂøÖÈ°ªÈ´ò‰∫éÂΩìÂâç‰ª∑Ê†ºÔºÅ");
      return;
    }

    // Ê£ÄÊü•‰ΩôÈ¢ù (È¢ÑÊ£ÄÊü•ÔºåËôΩÁÑ∂‰∏çÊâ£Ê¨æÔºå‰ΩÜË¶ÅÈò≤Ê≠¢‰π±ÁÇπ)
    const wallet = await db.userWallet.get('main');
    const totalAssets = wallet.balance + (wallet.kinshipCards || []).reduce((sum, c) => sum + (c.limit - (c.spent || 0)), 0);

    if (totalAssets < bidAmount) {
      // ÈúáÂä®ÂèçÈ¶à
      if (navigator.vibrate) navigator.vibrate(200);
      showCustomAlert("ËµÑÈáë‰∏çË∂≥", "‰Ω†ÁöÑËµÑ‰∫ßÊÄªÈ¢ù‰∏çË∂≥‰ª•ÊîØ‰ªòÊ≠§‰ª∑Ê†ºÔºÅ");
      return;
    }

    const user = { name: state.qzoneSettings.nickname || 'Êàë', type: 'user', id: 'user' };
    updateAuctionState(bidAmount, user);
  }

  // ËæÖÂä©ÂáΩÊï∞ÔºöÁªü‰∏ÄÊ∑ªÂä†Êó•Âøó
  function addAuctionLog(type, text) {
    const logEl = document.getElementById('auction-log');
    const div = document.createElement('div');

    if (type === 'System') {
      div.innerHTML = `<span style="color:#00f3ff; font-weight:bold;">[ÊãçÂçñÂÆò]</span> ${text}`;
    } else {
      div.innerHTML = text; // ÊôÆÈÄöÂá∫‰ª∑Êó•Âøó
    }

    if (type === 'bid-me') div.className = 'bid-me';
    if (type === 'bid-friend') div.className = 'bid-friend';

    logEl.appendChild(div); // Êîπ‰∏∫ appendChildÔºåÂä†Âú®ÊúÄ‰∏ãÈù¢
    logEl.scrollTop = logEl.scrollHeight;
  }

  // ‰øÆÊîπÂéüÊúâÁöÑ updateAuctionState
  function updateAuctionState(newPrice, bidder) {
    auctionState.currentPrice = newPrice;
    auctionState.lastBidder = bidder;
    auctionState.bidHistory.push(bidder); // ËÆ∞ÂΩï

    // --- Áé©Ê≥ïÂ¢ûÂº∫ÔºöÂä†Êó∂Êú∫Âà∂ ---
    // Â¶ÇÊûúÂâ©‰ΩôÊó∂Èó¥Â∞ë‰∫é 10 ÁßíÔºåÊúâ‰∫∫Âá∫‰ª∑ÂàôÂõûË°ÄÂà∞ 10~15 Áßí
    if (auctionState.timer < 10) {
      const bonusTime = Math.floor(Math.random() * 5) + 10; // ÈöèÊú∫ÂõûË°Ä
      auctionState.timer = bonusTime;
      // ËßÜËßâÂèçÈ¶àÔºöÈáçÁΩÆÂñäËØùÁä∂ÊÄÅ
      auctioneerState = 0;

      // ËßÜËßâÂèçÈ¶àÔºöÈó™ÁÉÅ‰∏Ä‰∏ãÂÄíËÆ°Êó∂
      const timerEl = document.getElementById('auction-timer');
      timerEl.style.color = '#00ff00'; // ÁªøËâ≤Ë°®Á§∫Êó∂Èó¥Â¢ûÂä†
      setTimeout(() => timerEl.style.color = '#f0ad4e', 300);

      addAuctionLog("System", "‚è±Ô∏è Êúâ‰∫∫Âá∫‰ª∑ÔºåÊó∂Èó¥Âª∂ÈïøÔºÅ");
    }

    // Êõ¥Êñ∞‰ª∑Ê†º UI
    const priceEl = document.getElementById('auction-current-price');
    priceEl.textContent = `¬• ${newPrice.toLocaleString()}`;
    priceEl.classList.remove('shake-animation');
    void priceEl.offsetWidth;
    priceEl.classList.add('shake-animation');

    // ÊûÑÈÄ†Âá∫‰ª∑Êó•ÂøóÂÜÖÂÆπ
    let content = "";
    let logType = "bid-npc";

    if (bidder.type === 'user') {
      content = `üö© <b>‰Ω†</b> Âá∫‰ª∑ ¬•${newPrice.toLocaleString()}`;
      logType = "bid-me";
      // ÈúáÂä®ÂèçÈ¶à (Â¶ÇÊûúËÆæÂ§áÊîØÊåÅ)
      if (navigator.vibrate) navigator.vibrate(50);
    } else if (bidder.type === 'char') {
      content = `üî• <b>${bidder.name}</b> ‰∏æÁâå ¬•${newPrice.toLocaleString()}!`;
      logType = "bid-friend";
    } else {
      content = `${bidder.name} Âá∫‰ª∑ ¬•${newPrice.toLocaleString()}`;
    }

    // ÂÜôÂÖ•Êó•Âøó
    const logEl = document.getElementById('auction-log');
    const div = document.createElement('div');
    div.innerHTML = content;
    div.className = logType;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  // 7. ÊãçÂçñÁªìÊùüÁªìÁÆó - ‰øÆÂ§çÁâà
  async function endAuction() {
    clearInterval(auctionState.timerId);
    clearInterval(auctionState.npcIntervalId);
    auctionState.isActive = false;

    const winner = auctionState.lastBidder;
    const finalPrice = auctionState.currentPrice;
    const item = auctionState.item;

    document.getElementById('auction-timer').textContent = "ÁªìÊùü";
    document.getElementById('auction-item-image-container').classList.remove('auction-win-anim');

    // ÊÉÖÂÜµ1ÔºöÊ†πÊú¨Ê≤°‰∫∫Âá∫‰ª∑ÔºàÊµÅÊãçÔºâ
    if (!winner) {
      await showCustomAlert("ÊãçÂçñÁªìÊùü", "Êó†‰∫∫Âá∫‰ª∑ÔºåËØ•ÊãçÂìÅÂ∑≤ÊµÅÊãç„ÄÇ");
      return;
    }

    // ÊÉÖÂÜµ2ÔºöÁî®Êà∑Ëé∑ËÉú
    if (winner.type === 'user') {
      document.getElementById('auction-item-image-container').classList.add('auction-win-anim');

      // Ëé∑ÂèñÈí±ÂåÖ
      const wallet = await db.userWallet.get('main');
      const balance = wallet.balance || 0;
      const kinshipCards = wallet.kinshipCards || [];

      const paymentOptions = [];
      if (balance >= finalPrice) {
        paymentOptions.push({
          text: `<span style="color:#1677ff;font-weight:bold;">‰ΩôÈ¢ùÊîØ‰ªò</span> (Ââ©‰Ωô ¬•${balance.toFixed(2)})`,
          value: 'balance'
        });
      }
      kinshipCards.forEach(card => {
        const remaining = card.limit - (card.spent || 0);
        if (remaining >= finalPrice) {
          const chat = state.chats[card.chatId];
          paymentOptions.push({
            text: `<span style="color:#ff5252;font-weight:bold;">‰∫≤Â±ûÂç° - ${chat.name}</span> (Ââ©‰Ωô ¬•${remaining.toFixed(2)})`,
            value: `kinship_${card.chatId}`
          });
        }
      });

      if (paymentOptions.length === 0) {
        await showCustomAlert("Á´ûÊãçÊàêÂäü‰ΩÜÊîØ‰ªòÂ§±Ë¥•", "‰Ω†Ëµ¢‰∫ÜÁ´ûÊãçÔºå‰ΩÜËµÑÈáë‰∏çË∂≥‰ª•ÊîØ‰ªòÔºÅ");
        return;
      }

      // ÊèêÂçáÂºπÁ™óÂ±ÇÁ∫ß
      document.getElementById('custom-modal-overlay').style.zIndex = 3002;
      const method = await showChoiceModal(`Á´ûÊãçÊàêÂäüÔºÅÊîØ‰ªò ¬•${finalPrice}`, paymentOptions);
      document.getElementById('custom-modal-overlay').style.zIndex = '';

      if (!method) {
        await showCustomAlert("‰∫§ÊòìÂèñÊ∂à", "‰Ω†ÊîæÂºÉ‰∫ÜÊîØ‰ªò„ÄÇ");
        return;
      }

      // Êâ£Ê¨æ
      let providerChatId = null;
      if (method === 'balance') {
        await processTransaction(finalPrice, 'expense', `ÈªëÂ∏ÇË¥≠‰π∞-${item.name}`);
      } else {
        // „Äê‰øÆÂ§ç„Äë‰ΩøÁî® replace ÊèêÂèñÂÆåÊï¥ÁöÑ chatId (‰æãÂ¶Ç chat_123456)
        const chatId = method.replace('kinship_', '');

        providerChatId = chatId;
        const cardIndex = wallet.kinshipCards.findIndex(c => c.chatId === chatId);

        if (cardIndex > -1) {
          // 1. Êõ¥Êñ∞È¢ùÂ∫¶
          wallet.kinshipCards[cardIndex].spent = (wallet.kinshipCards[cardIndex].spent || 0) + finalPrice;
          await db.userWallet.put(wallet);

          // 2. ÂÜôÂÖ•Ë¥¶Âçï
          await db.userTransactions.add({
            timestamp: Date.now(),
            type: 'expense',
            amount: finalPrice,
            description: `‰∫≤Â±ûÂç°ÈªëÂ∏Ç-${item.name}`
          });

          console.log(`[ÈªëÂ∏Ç] ‰∫≤Â±ûÂç°Êâ£Ê¨æÊàêÂäü: -${finalPrice}`);
        } else {
          console.error(`[ÈªëÂ∏Ç] Êâ£Ê¨æÂ§±Ë¥•ÔºöÊâæ‰∏çÂà∞ID‰∏∫ ${chatId} ÁöÑ‰∫≤Â±ûÂç°`);
          alert("ÊîØ‰ªòÂºÇÂ∏∏ÔºöÊú™ÊâæÂà∞ÂØπÂ∫îÁöÑ‰∫≤Â±ûÂç°ËÆ∞ÂΩï„ÄÇ");
          return;
        }
      }

      // ÂÖ•Â∫ì
      await db.inventory.add({
        name: item.name,
        type: 'treasure',
        description: item.description,
        image: item.image_prompt,
        acquiredPrice: finalPrice,
        acquiredTime: Date.now()
      });

      const giftConfirmed = await showCustomConfirm(
        "Á´ûÊãçÊàêÂäüÔºÅ",
        `‰Ω†Â∑≤ÊàêÂäüÊãç‰∏ã„Äê${item.name}„ÄëÔºÅ\n\nË¶ÅÁé∞Âú®Â∞±ÊääÂÆÉ‰Ωú‰∏∫Á§ºÁâ©ÔºåÈÄÅÁªôÊüê‰ΩçËßíËâ≤ÂêóÔºü`,
        { confirmText: 'üéÅ Á´ãÂç≥Ëµ†ÈÄÅ', cancelText: 'ÊîæÂÖ•‰ªìÂ∫ì' }
      );

      if (giftConfirmed) {
        await openAuctionGiftSelector(item, finalPrice);
      } else {
        await showCustomAlert("Â∑≤ÂÖ•Â∫ì", "Áâ©ÂìÅÂ∑≤ÂÆâÂÖ®Â≠òÂÖ•‰Ω†ÁöÑÂ∫ìÂ≠ò„ÄÇ");
      }

      // Ëß¶ÂèëËÆ∞ÂøÜÂíåÈÄöÁü•
      if (providerChatId) {
        const providerChat = state.chats[providerChatId];
        if (providerChat) {
          const msg = {
            role: 'system',
            content: `[Ê∂àË¥πÈÄöÁü•ÔºöÁî®Êà∑‰ΩøÁî®‰Ω†ÁöÑ‰∫≤Â±ûÂç°Âú®ÈªëÂ∏ÇÊãçÂçñË°åÊ∂àË¥π‰∫Ü ¬•${finalPrice}ÔºåË¥≠‰π∞‰∫Ü‚Äú${item.name}‚Äù„ÄÇ]`,
            timestamp: Date.now(),
            isHidden: true
          };
          providerChat.history.push(msg);
          await db.chats.put(providerChat);
        }
      }

      // ÈÄöÁü•Âú®Âú∫ÁöÑÁÜü‰∫∫
      const uniqueBidders = [...new Set(auctionState.bidHistory.filter(b => b.type === 'char').map(b => b.id))];
      for (const charId of uniqueBidders) {
        if (charId === providerChatId) continue;
        const char = state.chats[charId];
        if (char) {
          const msg = {
            role: 'system',
            content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÂú®ÂàöÊâçÁöÑÈªëÂ∏ÇÊãçÂçñ‰∏≠ÔºåÁî®Êà∑‰ª• ¬•${finalPrice} ÁöÑ‰ª∑Ê†ºÂáªË¥•‰∫ÜÂú®Âú∫ÁöÑÁ´ûÊãçËÄÖÔºàÂåÖÊã¨‰Ω†ÔºâÔºåËµ¢Âæó‰∫Ü‚Äú${item.name}‚Äù„ÄÇ]`,
            timestamp: Date.now(),
            isHidden: true
          };
          char.history.push(msg);
          await db.chats.put(char);
        }
      }

    } else {
      // --- Char Êàñ NPC Ëé∑ËÉú ---

      if (winner.type === 'char') {
        // Â¶ÇÊûúÊòØÊàë‰ª¨ÁöÑËßíËâ≤Ëµ¢‰∫Ü
        const chat = state.chats[winner.id];
        if (chat) {
          await showCustomAlert("Á´ûÊãçÁªìÊùü", `ÊÅ≠ÂñúÔºÅÊÇ®ÁöÑÂ•ΩÂèã„Äê${winner.name}„Äë‰ª• ¬•${finalPrice.toLocaleString()} ÊàêÂäüÊãçÂæóÂÆùÁâ©ÔºÅ`);

          // Ëß¶Âèë AI ÂÜ≥Á≠ñÔºöÊòØÂê¶ÈÄÅÁªôÁî®Êà∑
          // Êàë‰ª¨‰∏çÁõ¥Êé•ÂºπÁ™óÈóÆÁî®Êà∑ÔºåËÄåÊòØÂèëÈÄÅ‰∏ÄÊù°ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÁªô AIÔºåËÆ© AI Ëá™Â∑±ÂÜ≥ÂÆö
          const systemPrompt = `
                [Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöÂú®ÊãçÂçñ‰ºö‰∏äÊñ•ËµÑ ¬•${finalPrice.toLocaleString()} Êãç‰∏ã‰∫Ü‚Äú${item.name}‚Äù(${item.description})„ÄÇ
                ËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂíå‰∏éÁî®Êà∑ÁöÑÂÖ≥Á≥ªÔºåÂÜ≥ÂÆöÊÄé‰πàÂ§ÑÁêÜËøô‰∏™Áâ©ÂìÅ„ÄÇ
                ‰Ω†ÂèØ‰ª•Ôºö
                1. ÈÄÅÁªôÁî®Êà∑‰Ωú‰∏∫ÊÉäÂñú (‰ΩøÁî® 'gift' Êåá‰ª§)„ÄÇ
                2. Ëá™Â∑±Êî∂ËóèÔºåÂπ∂ÂêëÁî®Êà∑ÁÇ´ËÄÄ (‰ΩøÁî® 'text' Êàñ 'ai_image' Êåá‰ª§)„ÄÇ
                3. Êä±ÊÄ®Â§™Ë¥µ‰∫Ü (‰ΩøÁî® 'text' Êåá‰ª§)„ÄÇ
                ËØ∑ÂºÄÂßã‰Ω†ÁöÑË°®Êºî„ÄÇ]
                `;

          chat.history.push({
            role: 'system',
            content: systemPrompt,
            timestamp: Date.now(),
            isHidden: true
          });
          await db.chats.put(chat);

          // Â¶ÇÊûúÂΩìÂâçÊ≤°Âú®ËÅäÂ§©ÁïåÈù¢ÔºåÂ∞±‰∏çÂº∫Âà∂Ë∑≥ËΩ¨ÔºåÂè™Âú®ÂêéÂè∞Ëß¶Âèë
          // Â¶ÇÊûúÊÉ≥Êõ¥ÊòéÊòæÔºåÂèØ‰ª•Âº∫Âà∂Ë∑≥ËΩ¨Ôºö
          const confirmJump = await showCustomConfirm("ÂéªÁúãÁúãÔºü", `${winner.name} ‰ºº‰πéÊúâËØùÂØπ‰Ω†ËØ¥„ÄÇ`, { confirmText: "ÂâçÂæÄËÅäÂ§©" });
          if (confirmJump) {
            openChat(winner.id);
            triggerAiResponse(); // Ëß¶Âèë AI ÂõûÂ§ç
          } else {
            // Âè™ÊòØÂêéÂè∞Ëß¶ÂèëÔºå‰∏ãÊ¨°ËøõËÅäÂ§©ËÉΩÁúãÂà∞
            // Ê≥®ÊÑèÔºöËøôÈáåÈúÄË¶ÅÊâãÂä®Ë∞ÉÁî®‰∏ÄÊ¨° APIÔºå‰ΩÜÂõ†‰∏∫‰∏çÂú®ËÅäÂ§©ÁïåÈù¢ÔºåÂèØËÉΩÈúÄË¶ÅË∞®ÊÖéÂ§ÑÁêÜ
            // ÁÆÄÂçïËµ∑ËßÅÔºåÂª∫ËÆÆÂ∞±Áî®‰∏äÈù¢ÁöÑË∑≥ËΩ¨ÈÄªËæë
          }
        }
      } else {
        // Á∫ØË∑Ø‰∫∫ NPC Ëµ¢‰∫Ü
        await showCustomAlert("ÊãçÂçñÁªìÊùü", `ÂæàÈÅóÊÜæÔºåË¢´„Äê${winner.name}„Äë‰ª• ¬•${finalPrice.toLocaleString()} ÊãçËµ∞‰∫Ü„ÄÇ`);
      }
    }
  }
  // Êñ∞Â¢ûÔºöÊâìÂºÄÈÄÅÁ§ºÂØπË±°ÈÄâÊã©Âô® (ÊªöÂä®ÂàóË°®‰øÆÂ§çÁâà)
  async function openAuctionGiftSelector(item, price) {
    const characters = Object.values(state.chats).filter(c => !c.isGroup);
    if (characters.length === 0) return alert("Ê≤°ÊúâÂèØËµ†ÈÄÅÁöÑËßíËâ≤");

    // Ëé∑ÂèñÊ®°ÊÄÅÊ°ÜÂÖÉÁ¥†
    const modal = document.getElementById('custom-modal-overlay');
    const titleEl = document.getElementById('custom-modal-title');
    const bodyEl = document.getElementById('custom-modal-body');
    const footerEl = document.querySelector('#custom-modal .custom-modal-footer');

    // 1. ËÆæÁΩÆÊ†áÈ¢ò
    titleEl.textContent = `Â∞Ü‚Äú${item.name}‚ÄùÈÄÅÁªô...`;

    // 2. ÈáçÁΩÆ Footer Ê†∑Âºè (Ê∏ÖÈô§‰πãÂâç showChoiceModal ÂèØËÉΩÁïô‰∏ãÁöÑÂàÜÈ°µÊåâÈíÆÂíåÊ†∑Âºè)
    footerEl.innerHTML = '';
    footerEl.style.flexDirection = 'row'; // ÊÅ¢Â§çÊ®™ÂêëÂ∏ÉÂ±Ä
    footerEl.style.justifyContent = 'center';
    footerEl.style.maxHeight = ''; // Ê∏ÖÈô§È´òÂ∫¶ÈôêÂà∂
    footerEl.style.overflowY = ''; // Ê∏ÖÈô§ÊªöÂä®

    // Ê∑ªÂä†‰∏Ä‰∏™ÁÆÄÂçïÁöÑÂèñÊ∂àÊåâÈíÆ
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'ÂèñÊ∂à';
    cancelBtn.style.color = '#666';
    cancelBtn.onclick = () => modal.classList.remove('visible');
    footerEl.appendChild(cancelBtn);

    // 3. ÊûÑÂª∫ÊªöÂä®ÂàóË°® (Ê∏≤ÊüìÂú® Body ‰∏≠)
    bodyEl.innerHTML = '';

    const listContainer = document.createElement('div');
    // Ê†∑ÂºèÔºöÊúÄÂ§ßÈ´òÂ∫¶ÈôêÂà∂ + ÂûÇÁõ¥ÊªöÂä®
    listContainer.style.cssText = `
        max-height: 60vh; 
        overflow-y: auto; 
        display: flex; 
        flex-direction: column; 
        text-align: left;
        margin: 0 -16px; /* ÊäµÊ∂à modal-body ÁöÑÂÜÖËæπË∑ùÔºåËÆ©ÂàóË°®Ë¥¥Ëæπ */
        border-top: 1px solid #eee;
    `;

    // ÊåâÂêçÁß∞ÊéíÂ∫èÔºåÊñπ‰æøÊü•Êâæ
    characters.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));

    characters.forEach(char => {
      const row = document.createElement('div');
      // Âçï‰∏™ÈÄâÈ°πÊ†∑Âºè
      row.style.cssText = `
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s;
        `;

      const avatar = char.settings.aiAvatar || defaultAvatar;

      row.innerHTML = `
            <img src="${avatar}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 1px solid #eee;">
            <div style="flex-grow: 1;">
                <div style="font-weight: 500; font-size: 16px; color: var(--text-primary);">${char.name}</div>
            </div>
            <div style="color: #ccc;">‚Ä∫</div>
        `;

      // ÁÇπÂáª‰∫ã‰ª∂
      row.onclick = async () => {
        // ËßÜËßâÂèçÈ¶à
        row.style.backgroundColor = '#f0f0f0';
        setTimeout(async () => {
          modal.classList.remove('visible');
          await sendAuctionGiftToChat(char.id, item, price);
        }, 100);
      };

      listContainer.appendChild(row);
    });

    bodyEl.appendChild(listContainer);

    // 4. ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.classList.add('visible');
  }

  // Êñ∞Â¢ûÔºöÂèëÈÄÅÁ§ºÁâ©Ê∂àÊÅØÂà∞ËÅäÂ§©
  async function sendAuctionGiftToChat(chatId, item, price) {
    const chat = state.chats[chatId];
    if (!chat) return;

    // 1. ÊûÑÈÄ†Á§ºÁâ©ÂõæÁâáURL
    // Â¶ÇÊûúÊòØ AI ÁîüÁöÑÂõæÔºåÂ∞ùËØïÊèêÂèñ prompt ÈáçÊñ∞ÊûÑÈÄ†ÈìæÊé•ÔºåÊàñËÄÖÁõ¥Êé•Áî®ÈªòËÆ§Âõæ
    let imageUrl = 'https://i.postimg.cc/Hs7BLh76/alipay.png';
    if (item.image_prompt) {
      imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image_prompt)}`;
    }

    // 2. ÊûÑÈÄ†Á§ºÁâ©Ê∂àÊÅØ
    const giftMessage = {
      role: 'user',
      type: 'gift',
      timestamp: Date.now(),
      items: [{
        name: `[Á®Ä‰∏ñÁèçÂÆù] ${item.name}`,
        price: price,
        imageUrl: imageUrl,
        quantity: 1
      }],
      total: price,
      recipients: null // ÂçïËÅä‰∏çÈúÄË¶Å recipients
    };

    chat.history.push(giftMessage);

    // 3. Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ÔºåËÆ©AIÁü•ÈÅìËøôÊòØÂàöÊãç‰∏ãÊù•ÁöÑ
    const hiddenMessage = {
      role: 'system',
      content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÂàöÂú®ÈªëÂ∏ÇÊãçÂçñ‰ºö‰∏äÔºåÊñ•Â∑®ËµÑÔºà¬•${price.toLocaleString()}ÔºâÊãç‰∏ã‰∫ÜÁ®Ä‰∏ñÁèçÂÆù‚Äú${item.name}‚ÄùÂπ∂Áõ¥Êé•ÈÄÅÁªô‰∫Ü‰Ω†„ÄÇÁâ©ÂìÅÊèèËø∞Ôºö${item.description}„ÄÇËøôÊòØÊûÅÂÖ∂Ë¥µÈáçÁöÑÁ§ºÁâ©ÔºåËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂÅöÂá∫Âº∫ÁÉàÁöÑÂèçÂ∫îÔºàÊÉäËÆ∂„ÄÅÊÑüÂä®„ÄÅÊàñÊòØË¥£ÊÄ™‰π±Ëä±Èí±Ôºâ„ÄÇ]`,
      timestamp: Date.now() + 1,
      isHidden: true
    };
    chat.history.push(hiddenMessage);

    await db.chats.put(chat);

    // 4. Ë∑≥ËΩ¨Âπ∂Ëß¶Âèë AI ÂõûÂ§ç
    await showCustomAlert("Ëµ†ÈÄÅÊàêÂäü", `Á§ºÁâ©Â∑≤ÈÄÅËææÁªô ${chat.name}ÔºÅÊ≠£Âú®ÂâçÂæÄËÅäÂ§©ÁïåÈù¢...`);

    // ÂàáÊç¢Â±èÂπï
    showScreen('chat-list-screen'); // ÂÖàÂàáÂà∞ÂàóË°®Âà∑Êñ∞Áä∂ÊÄÅ
    setTimeout(() => {
      openChat(chatId); // ÊâìÂºÄËÅäÂ§©
      triggerAiResponse(); // Ëß¶Âèë AI ÂõûÂ§ç
    }, 300);
  }
  // ËæÖÂä©ÔºöËÆ∞ÂΩïÂá∫‰ª∑ÂéÜÂè≤
  const originalUpdateAuctionState = updateAuctionState;
  updateAuctionState = function (newPrice, bidder) {
    auctionState.bidHistory.push(bidder); // ËÆ∞ÂΩïÊâÄÊúâÂá∫‰ª∑ËÄÖ
    originalUpdateAuctionState(newPrice, bidder); // Ë∞ÉÁî®ÂéüÈÄªËæë
  }
  window.openAuctionScreen = openAuctionScreen;
  window.generateNewAuctionItem = generateNewAuctionItem;
  window.placeBid = placeBid;
  // --- ÈªëÂ∏Ç‰ªìÂ∫ìÂäüËÉΩ ---

  // 1. ÊâìÂºÄ‰ªìÂ∫ì
  async function openInventoryModal() {
    const modal = document.getElementById('inventory-modal');
    const listEl = document.getElementById('inventory-list');

    modal.classList.add('visible');
    listEl.innerHTML = '<div class="spinner"></div>'; // ÊòæÁ§∫Âä†ËΩΩÂä®Áîª

    try {
      // ‰ªéÊï∞ÊçÆÂ∫ìËØªÂèñËóèÂìÅÔºåÊåâÊó∂Èó¥ÂÄíÂ∫è
      const items = await db.inventory.orderBy('acquiredTime').reverse().toArray();

      listEl.innerHTML = '';
      if (items.length === 0) {
        listEl.innerHTML = '<div style="text-align:center; color:#666; margin-top:50px;">‰ªìÂ∫ìÁ©∫Á©∫Â¶Ç‰πü<br>Âø´ÂéªÁ´ûÊãçÁÇπÂ•Ω‰∏úË•øÂêß</div>';
        return;
      }

      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'inventory-item';

        // ÂõæÁâáÂ§ÑÁêÜÔºöÂÖºÂÆπ Pollinations ÂíåÊôÆÈÄö URL
        let imageUrl = 'https://i.postimg.cc/Hs7BLh76/alipay.png';
        if (item.image) {
          if (item.image.startsWith('http') || item.image.startsWith('data:')) {
            imageUrl = item.image;
          } else {
            // Â¶ÇÊûúÊòØ promptÔºåËΩ¨Êç¢ÊàêÈìæÊé•
            imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image)}`;
          }
        }

        div.innerHTML = `
                <img src="${imageUrl}" class="inventory-img" loading="lazy">
                <div class="inventory-info">
                    <div class="inventory-name">${item.name}</div>
                    <div class="inventory-desc">${item.description || 'Á®Ä‰∏ñÁèçÂÆù'}</div>
                    <div class="inventory-price">ÂÖ•Êâã‰ª∑: ¬•${(item.acquiredPrice || 0).toLocaleString()}</div>
                </div>
                <button class="inventory-use-btn">Ëµ†ÈÄÅ</button>
            `;

        // ÁªëÂÆöËµ†ÈÄÅÊåâÈíÆ
        const btn = div.querySelector('.inventory-use-btn');
        btn.onclick = () => handleGiftFromInventory(item);

        listEl.appendChild(div);
      });

    } catch (e) {
      console.error(e);
      listEl.innerHTML = '<div style="text-align:center; color:#ff3b30;">Âä†ËΩΩÂ§±Ë¥•</div>';
    }
  }

  // 2. ÂÖ≥Èó≠‰ªìÂ∫ì
  function closeInventoryModal() {
    document.getElementById('inventory-modal').classList.remove('visible');
  }

  // 3. ‰ªé‰ªìÂ∫ìËµ†ÈÄÅ
  async function handleGiftFromInventory(item) {
    // ÂÖ≥Èó≠‰ªìÂ∫ìÂºπÁ™ó
    closeInventoryModal();

    // ÊûÑÈÄ†Ëµ†ÈÄÅÂØπË±°
    const giftItem = {
      name: item.name,
      description: item.description,
      image_prompt: item.image
    };

    // Ë∞ÉÁî®Áé∞ÊúâÁöÑËµ†ÈÄÅÈÄâÊã©Âô® (Â§çÁî® openAuctionGiftSelector)
    // ‰º†ÂÖ•ÂÖ•Êâã‰ª∑‰Ωú‰∏∫Á§ºÁâ©ÁöÑ‰ª∑ÂÄº
    await openAuctionGiftSelector(giftItem, item.acquiredPrice || 9999);
  }

  // Êö¥Èú≤ÁªôÂÖ®Â±Ä‰ΩøÁî®
  window.openInventoryModal = openInventoryModal;
  window.closeInventoryModal = closeInventoryModal;
  // === ÂÆåÊï¥Áâà playSynthScore ÂáΩÊï∞ (ÊîØÊåÅËäÇÂ•è + ÂÖ®‰πêÂô®) ===
  let globalPolySynth = null;

  async function playSynthScore(btnElement, notesJson, instrumentType = 'piano') {
    let notes = [];
    try {
      // 1. Ëß£Êûê‰πêË∞±Êï∞ÊçÆ
      // ÂÖºÂÆπÊóßÁâàÁ∫ØÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑ ["C4", "E4"] ÂíåÊñ∞ÁâàÂØπË±°Êï∞ÁªÑ [{"n":"C4","d":"4n"}]
      const rawNotes = (typeof notesJson === 'string') ? JSON.parse(notesJson) : notesJson;

      // Áªü‰∏ÄÊ†ºÂºèÂåñ‰∏∫Êñ∞ÁâàÂØπË±° {n: Èü≥È´ò, d: Êó∂Èïø}
      notes = rawNotes.map(item => {
        if (typeof item === 'string') {
          return { n: item, d: '8n' }; // ÊóßÁâàÊï∞ÊçÆÈªòËÆ§8ÂàÜÈü≥Á¨¶
        }
        return { n: item.n, d: item.d || '4n' }; // Êñ∞ÁâàÊï∞ÊçÆÔºåÈªòËÆ§4ÂàÜÈü≥Á¨¶
      });

    } catch (e) { console.error("‰πêË∞±Ëß£ÊûêÂ§±Ë¥•", e); return; }

    if (!notes || notes.length === 0) return;

    // 2. ÂêØÂä®Èü≥È¢ëÂºïÊìé
    await Tone.start();

    // ÂàùÂßãÂåñÂêàÊàêÂô® (Âçï‰æãÊ®°Âºè)
    if (!globalPolySynth) {
      globalPolySynth = new Tone.PolySynth(Tone.Synth).toDestination();
    }

    // ÈáçÁΩÆÂü∫Á°ÄÈü≥Èáè
    globalPolySynth.volume.value = -8;

    // 3. ÈÖçÁΩÆ‰πêÂô®Èü≥Ëâ≤ (Switch Case)
    switch (instrumentType) {
      case 'chiptune': // 8-bit Ê∏∏ÊàèÈ£é
        globalPolySynth.set({
          oscillator: { type: "square" },
          envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 }
        });
        break;

      case 'synth': // ÁîµÂ≠êÂêàÊàêÂô®
        globalPolySynth.set({
          oscillator: { type: "sawtooth" },
          envelope: { attack: 0.05, decay: 0.2, sustain: 0.4, release: 2 }
        });
        break;

      case 'guitar': // Âêâ‰ªñ (Ê∏ÖËÑÜÊã®Âº¶)
        globalPolySynth.set({
          oscillator: { type: "triangle" },
          envelope: {
            attack: 0.01, decay: 0.3, sustain: 0.1, release: 1.0
          }
        });
        globalPolySynth.volume.value = -5; // Ë°•ÂÅøÈü≥Èáè
        break;

      case 'violin': // Â∞èÊèêÁê¥ (ÁºìÊÖ¢Ëµ∑Èü≥ÔºåÁªµÈïøÂª∂Èü≥)
        globalPolySynth.set({
          oscillator: { type: "sawtooth" },
          envelope: {
            attack: 0.2, decay: 0.1, sustain: 0.8, release: 1.5
          }
        });
        globalPolySynth.volume.value = -10; // Âº¶‰πêËæÉÂìçÔºåÈôç‰ΩéÈü≥Èáè
        break;

      case 'flute': // Á¨õÂ≠ê (Á∫ØÂáÄÊ≠£Âº¶Ê≥¢)
        globalPolySynth.set({
          oscillator: { type: "sine" },
          envelope: {
            attack: 0.1, decay: 0.1, sustain: 0.9, release: 0.5
          }
        });
        break;

      case 'guzheng': // Âè§Á≠ù (Â∞ñÈîêÊã®Âº¶ÔºåÂø´ÈÄüË°∞Âáè)
        globalPolySynth.set({
          oscillator: { type: "triangle" },
          envelope: {
            attack: 0.005, decay: 0.4, sustain: 0, release: 1.5
          }
        });
        globalPolySynth.volume.value = -5;
        break;

      case 'kalimba': // ÊãáÊåáÁê¥ (ÂèØÁà±ÔºåÁ©∫ÁÅµ)
        globalPolySynth.set({
          oscillator: { type: "sine" },
          envelope: {
            attack: 0.001, decay: 0.1, sustain: 0, release: 1.2
          }
        });
        break;

      case 'piano': // ÈªòËÆ§Èí¢Áê¥
      default:
        globalPolySynth.set({
          oscillator: { type: "triangle" },
          envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 }
        });
        break;
    }

    // 4. Êõ¥Êñ∞ UI Áä∂ÊÄÅ
    btnElement.textContent = "‚ùö‚ùö";
    btnElement.classList.add('playing');
    btnElement.disabled = true;

    // 5. „ÄêÊ†∏ÂøÉ„ÄëÊåâËäÇÂ•èÊí≠ÊîæÈÄªËæë
    const now = Tone.now();
    let accumulatedTime = 0; // Á¥ØËÆ°Êó∂Èó¥ËΩ¥ÔºåÁî®‰∫éËÆ°ÁÆó‰∏ã‰∏Ä‰∏™Èü≥Á¨¶ÁöÑÊí≠ÊîæÊó∂Èó¥ÁÇπ

    notes.forEach((noteObj) => {
      // ÁÆÄÂçïÁöÑÊ≠£ÂàôÊ£ÄÊü•Èü≥Á¨¶Ê†ºÂºè (Â¶Ç C4, D#5)
      if (noteObj.n && /^[A-G][#b]?[0-9]$/.test(noteObj.n)) {
        // ËÆ°ÁÆóÂΩìÂâçÈü≥Á¨¶ÁöÑÊó∂Èïø (Áßí)
        const durationInSeconds = Tone.Time(noteObj.d).toSeconds();

        // Âú®ÂΩìÂâçÁ¥ØËÆ°ÁöÑÊó∂Èó¥ÁÇπËß¶ÂèëÂ£∞Èü≥
        // triggerAttackRelease(Èü≥È´ò, ÊåÅÁª≠Êó∂Èó¥, Ëß¶ÂèëÊó∂Èó¥ÁÇπ)
        globalPolySynth.triggerAttackRelease(noteObj.n, noteObj.d, now + accumulatedTime);

        // Á¥ØÂä†Êó∂Èó¥ÔºåËÆ©‰∏ã‰∏Ä‰∏™Èü≥Á¨¶ÊéíÂú®ÂêéÈù¢
        accumulatedTime += durationInSeconds;
      }
    });

    // 6. Êí≠ÊîæÁªìÊùüÈáçÁΩÆ
    // Á≠âÂæÖÊÄªÊó∂Èïø + 0.5Áßí‰ΩôÈü≥ÂêéÔºåÊÅ¢Â§çÊåâÈíÆ
    setTimeout(() => {
      btnElement.textContent = "‚ñ∂";
      btnElement.classList.remove('playing');
      btnElement.disabled = false;
    }, accumulatedTime * 1000 + 500);
  }
  // Êö¥Èú≤ÁªôÂÖ®Â±Ä
  window.playSynthScore = playSynthScore;
  // --- To-Do List ÈÄªËæëÂºÄÂßã ---

  function getTodoDateString(date) {
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  }


  async function openTodoList() {
    if (!state.activeChatId) return;

    // ÈáçÁΩÆÂà∞‰ªäÂ§©
    currentTodoDate = new Date();
    updateTodoDateDisplay();
    await renderTodoList();

    showScreen('todo-list-screen');
  }

  function updateTodoDateDisplay() {
    const displayEl = document.getElementById('todo-current-date-display');
    const now = new Date();
    const dateStr = getTodoDateString(currentTodoDate);
    const todayStr = getTodoDateString(now);

    if (dateStr === todayStr) {
      displayEl.textContent = "‰ªäÂ§©";
    } else {
      displayEl.textContent = dateStr;
    }
  }

  function changeTodoDate(days) {
    currentTodoDate.setDate(currentTodoDate.getDate() + days);
    updateTodoDateDisplay();
    renderTodoList();
  }

  // 1. ‰øÆÊîπ renderTodoList
  async function renderTodoList() {
    const container = document.getElementById('todo-list-container');
    container.innerHTML = '';

    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const targetDateStr = getTodoDateString(currentTodoDate);
    const todos = chat.todoList || [];

    // Á≠õÈÄâÂΩìÂ§©ÁöÑ‰ªªÂä°
    const dayTodos = todos.filter(t => t.date === targetDateStr);

    // ÊéíÂ∫è
    dayTodos.sort((a, b) => {
      if (a.status === b.status) {
        return (a.time || '00:00').localeCompare(b.time || '00:00');
      }
      return a.status === 'completed' ? 1 : -1;
    });

    if (dayTodos.length === 0) {
      container.innerHTML = `<div class="todo-empty-state">üìÖ ${targetDateStr}<br>ÊöÇÊó†ÂæÖÂäû‰∫ãÈ°π</div>`;
      return;
    }

    // --- Ê†∏ÂøÉ‰øÆÊîπÔºöÂ≠òÂÖ•ÁºìÂ≠òÔºåÈáçÁΩÆËÆ°Êï∞ÔºåË∞ÉÁî®ÂàÜÊâπÂä†ËΩΩ ---
    todoCache = dayTodos;
    todoRenderCount = 0;
    loadMoreTodos();
  }

  // 2. Êñ∞Â¢û loadMoreTodos
  function loadMoreTodos() {
    if (isLoadingMoreTodos) return;

    const container = document.getElementById('todo-list-container');
    if (!container) return;

    if (todoRenderCount >= todoCache.length) return;

    isLoadingMoreTodos = true;
    const BATCH_SIZE = 30; // ÊØèÊ¨°Âä†ËΩΩ30Êù°
    const nextSliceEnd = todoRenderCount + BATCH_SIZE;
    const itemsToRender = todoCache.slice(todoRenderCount, nextSliceEnd);

    const fragment = document.createDocumentFragment();

    itemsToRender.forEach(todo => {
      const item = document.createElement('div');
      const isUser = (todo.creator === 'user' || !todo.creator);
      const creatorClass = isUser ? 'is-user' : 'is-char';

      item.className = `todo-item ${todo.status} ${creatorClass}`;
      item.dataset.id = todo.id;

      const colorMap = {
        'Êó•Â∏∏': '#8e8e93', 'Â∑•‰Ωú': '#007aff', 'ÈáçË¶Å': '#ff3b30',
        'ÁîüÊ¥ª': '#34c759', 'Á∫¶‰ºö': '#af52de', 'Â≠¶‰π†': '#ff9500', 'ËÆ∞Ë¥¶': '#ffc107'
      };
      const tagColor = colorMap[todo.type] || '#8e8e93';

      item.innerHTML = `
            <div class="todo-checkbox"></div>
            <div class="todo-info">
                <div class="todo-content">${escapeHTML(todo.content)}</div>
                <div class="todo-meta">
                    <span class="todo-tag" style="--tag-color: ${tagColor};">${todo.type || 'Êó•Â∏∏'}</span>
                    ${todo.time ? `<span class="todo-time">‚è∞ ${todo.time}</span>` : ''}
                </div>
            </div>
            <button class="todo-delete-btn">√ó</button>
        `;

      item.querySelector('.todo-checkbox').addEventListener('click', (e) => {
        e.stopPropagation();
        toggleTodoStatus(todo.id);
      });

      item.querySelector('.todo-delete-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        deleteTodo(todo.id);
      });

      item.addEventListener('click', () => openTodoEditor(todo));

      fragment.appendChild(item);
    });

    container.appendChild(fragment);
    todoRenderCount += itemsToRender.length;
    isLoadingMoreTodos = false;
  }

  async function toggleTodoStatus(id) {
    const chat = state.chats[state.activeChatId];
    const todo = chat.todoList.find(t => t.id === id);

    if (todo) {
      // 1. ÂàáÊç¢Áä∂ÊÄÅ
      const isCompleting = todo.status !== 'completed';
      todo.status = isCompleting ? 'completed' : 'pending';

      // 2. „ÄêÊ†∏ÂøÉ„ÄëÂè™‰øùÁïôËÆ∞ÂΩïÁ≥ªÁªüÊèêÁ§∫ÔºåÂà†Èô§‰∫Ü triggerAiResponse
      if (isCompleting) {
        const myNickname = chat.settings.myNickname || 'Êàë';

        // ÊûÑÈÄ†Á≥ªÁªüÊèêÁ§∫ËØçÔºåÂè™‰Ωú‰∏∫ËÆ∞ÂøÜÊ§çÂÖ•
        const systemHint = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑(${myNickname}) ÂàöÂàöÂú®ÂæÖÂäûÊ∏ÖÂçï‰∏≠ÂãæÈÄâÂÆåÊàê‰∫ÜÔºö‚Äú${todo.content}‚Äù„ÄÇ]`;

        // ÊèíÂÖ•ÈöêËóèÊ∂àÊÅØ
        const hiddenMsg = {
          role: 'system',
          content: systemHint,
          timestamp: Date.now(),
          isHidden: true // Áî®Êà∑Áúã‰∏çËßÅÔºåAI‰∏ãÊ¨°ÁîüÊàêÊó∂ËÉΩÁúãËßÅ
        };

        chat.history.push(hiddenMsg);
      }

      // 3. ‰øùÂ≠òÂπ∂Âà∑Êñ∞ÁïåÈù¢
      await db.chats.put(chat);
      renderTodoList();
    }
  }

  async function deleteTodo(id) {
    const confirmed = await showCustomConfirm("Âà†Èô§‰∫ãÈ°π", "Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂæÖÂäû‰∫ãÈ°πÂêóÔºü");
    if (confirmed) {
      const chat = state.chats[state.activeChatId];
      chat.todoList = chat.todoList.filter(t => t.id !== id);
      await db.chats.put(chat);
      renderTodoList();
    }
  }

  function openTodoEditor(todo = null) {
    const modal = document.getElementById('todo-editor-modal');
    const titleEl = document.getElementById('todo-editor-title');

    editingTodoId = todo ? todo.id : null;
    titleEl.textContent = todo ? 'ÁºñËæë‰∫ãÈ°π' : 'Ê∑ªÂä†‰∫ãÈ°π';

    document.getElementById('todo-content-input').value = todo ? todo.content : '';
    document.getElementById('todo-date-input').value = todo ? todo.date : getTodoDateString(currentTodoDate);
    document.getElementById('todo-time-input').value = todo ? todo.time : '';

    // ÈáçÁΩÆÂπ∂ËÆæÁΩÆÁ±ªÂûãÈÄâ‰∏≠
    const typeOptions = document.querySelectorAll('.todo-type-option');
    typeOptions.forEach(opt => opt.classList.remove('active'));
    const targetType = todo ? todo.type : 'Êó•Â∏∏';
    const activeOption = Array.from(typeOptions).find(opt => opt.dataset.value === targetType);
    if (activeOption) activeOption.classList.add('active');

    modal.classList.add('visible');
  }

  async function saveTodo() {
    const content = document.getElementById('todo-content-input').value.trim();
    const date = document.getElementById('todo-date-input').value;
    const time = document.getElementById('todo-time-input').value;
    const typeEl = document.querySelector('.todo-type-option.active');
    const type = typeEl ? typeEl.dataset.value : 'Êó•Â∏∏';

    if (!content || !date) {
      alert("ÂÜÖÂÆπÂíåÊó•Êúü‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
      return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat.todoList) chat.todoList = [];

    if (editingTodoId) {
      const todo = chat.todoList.find(t => t.id === editingTodoId);
      if (todo) {
        todo.content = content;
        todo.date = date;
        todo.time = time;
        todo.type = type;
      }
    } else {
      chat.todoList.push({
        id: Date.now(),
        content,
        date,
        time,
        type,
        status: 'pending',
        creator: 'user',
        timestamp: Date.now()
      });
    }

    await db.chats.put(chat);

    // Â¶ÇÊûúÊó•ËÆ∞Êó•ÊúüÂèò‰∫ÜÔºåË∑≥ËΩ¨Âà∞ËØ•Êó•Êúü
    const newDate = new Date(date);
    if (!isNaN(newDate.getTime())) {
      currentTodoDate = newDate;
      updateTodoDateDisplay();
    }

    document.getElementById('todo-editor-modal').classList.remove('visible');
    renderTodoList();
  }
  // --- To-Do List ÈÄªËæëÁªìÊùü ---
  // ==========================================
  // ‚ñº‚ñº‚ñº ÁªøÊ±ü (Green River) Âêå‰∫∫Âàõ‰ΩúÊ®°Âùó ‚ñº‚ñº‚ñº
  // ==========================================

  let grState = {
    activeStoryId: null,
    isGenerating: false
  };

  // ÈªòËÆ§‰ΩúËÄÖÈ¢ÑËÆæ
  const DEFAULT_AUTHORS = [
    { name: "ÁªÜËÖªÊÉÖÊÑü", style: "‰æßÈáçÂøÉÁêÜÊèèÂÜôÔºåÊñáÁ¨îÁªÜËÖªÔºåÊìÖÈïøÊçïÊçâ‰∫∫Áâ©Èó¥ÂæÆÂ¶ôÁöÑÊÉÖÊÑüÊµÅÂä®ÔºåÊ∞õÂõ¥ÊÑüÂº∫„ÄÇ", maxOutput: 600 },
    { name: "Ê≠£ÂâßÂâßÊÉÖ", style: "Ê≥®ÈáçÂâßÊÉÖÈÄªËæëÔºåËäÇÂ•èÁ¥ßÂáëÔºåÂØπÁôΩÂπ≤ÁªÉÔºåÊìÖÈïøÊé®Âä®ÊïÖ‰∫ãÊÉÖËäÇÂèëÂ±ï„ÄÇ", maxOutput: 800 },
    { name: "ËΩªÊùæÊó•Â∏∏", style: "ÂπΩÈªòÈ£éË∂£ÔºåËΩªÊùæÊÑâÂø´ÔºåÂ§öÁî®ÁîüÂä®ÁöÑÂØπËØùÂíåÊúâË∂£ÁöÑÁªÜËäÇÊèèÂÜôÔºåÊ≤ªÊÑàÁ≥ª„ÄÇ", maxOutput: 500 },
    { name: "ÊÑèËØÜÊµÅ", style: "Â§ßÈáè‰ΩøÁî®ÈöêÂñªÂíåË±°ÂæÅÔºåÂè•Âºè‰ºòÁæéÂ§çÊùÇÔºåÁùÄÈáç‰∫éÊÑèË±°ÂíåÂì≤Â≠¶ÊÄùËÄÉÔºåÂº±ÂåñÂÖ∑‰ΩìÊÉÖËäÇ„ÄÇ", maxOutput: 400 },

    // ËëóÂêç‰ΩúÂÆ∂ÊñáÈ£é
    { name: "È≤ÅËøÖ", style: "ÁäÄÂà©Ê∑±ÂàªÔºåÂñÑÁî®ËÆΩÂà∫ÂíåÊâπÂà§ÔºåÊñáÁ¨îÁÆÄÁªÉÊúâÂäõÔºåÊè≠Èú≤Á§æ‰ºöÈªëÊöóÈù¢ÔºåËØ≠Ë®ÄËæõËæ£ËÄåÂØåÊúâÊàòÊñóÊÄß„ÄÇÂ§öÁî®Áü≠Âè•ÔºåËäÇÂ•èÊòéÂø´ÔºåÂ∏∏ÊúâÊ∑±ÂàªÁöÑÁ§æ‰ºöÊ¥ûÂØü„ÄÇ", maxOutput: 600 },
    { name: "Âº†Áà±Áé≤", style: "ÁªÜËÖªÊïèÊÑüÔºåÊìÖÈïøÊèèÂÜôÈÉΩÂ∏ÇÁî∑Â•≥ÁöÑÊÉÖÊÑüÁ∫†ËëõÔºåÊñáÂ≠óÂçé‰∏ΩËÄåËãçÂáâÔºåÂñÑÁî®ÊØîÂñªÂíåÊÑèË±°ÔºåÁ¨îËß¶ÂÜ∑ÈùôÂÖãÂà∂ÔºåÂÖÖÊª°‰∫∫ÁîüÂÜµÂë≥„ÄÇÂÖ≥Ê≥®ÁªÜËäÇÔºåÊ∞õÂõ¥ÊÑüÊûÅÂº∫„ÄÇ", maxOutput: 700 },
    { name: "ËÄÅËàç", style: "‰∫¨Âë≥ÂçÅË∂≥ÔºåËØ≠Ë®ÄÁîüÂä®ÂπΩÈªòÔºåÂñÑ‰∫éÂàªÁîªÂ∞è‰∫∫Áâ©ÁöÑÊÇ≤Ê¨¢Á¶ªÂêàÔºåÊñáÂ≠óÊú¥ÂÆûËÄåÂØåÊúâÁîüÊ¥ªÊ∞îÊÅØÔºåÂØπËØùÁîüÂä®‰º†Á•ûÔºåÂÖÖÊª°Â∏Ç‰∫ïÁÉüÁÅ´Âë≥„ÄÇ", maxOutput: 650 },
    { name: "Ê≤à‰ªéÊñá", style: "ÊäíÊÉÖËØóÊÑèÔºåÊñáÂ≠óÊ∏ÖÊñ∞ÈöΩÊ∞∏ÔºåÂñÑ‰∫éÊèèÁªòÊπòË•øÈ£éÊÉÖÂíå‰∫∫ÊÄßÁæéÂ•ΩÔºåÁ¨îËß¶ÁªÜËÖªÊ∏©Â©âÔºåÂÖÖÊª°ËØóÊÑèÂíåÁîªÈù¢ÊÑüÔºåËØ≠Ë®Ä‰ºòÁæéÊµÅÁïÖ„ÄÇ", maxOutput: 600 },
    { name: "Èí±Èíü‰π¶", style: "ÂçöÂ≠¶Êú∫Êô∫ÔºåËØ≠Ë®ÄÂπΩÈªòËÆΩÂà∫ÔºåÂñÑÁî®ÂÖ∏ÊïÖÂíåÊØîÂñªÔºåÊñáÂ≠óÈõÖËá¥ËÄåÁäÄÂà©ÔºåÂÖÖÊª°Áü•ËØÜÂàÜÂ≠êÁöÑÁùøÊô∫ÂíåË∞É‰æÉÔºåÂèôËø∞È£éÊ†ºÁã¨Áâπ„ÄÇ", maxOutput: 700 },
    { name: "Â∑¥Èáë", style: "ÊøÄÊÉÖÊæéÊπÉÔºåÊñáÂ≠óÁúüÊåöÁÉ≠ÁÉàÔºåÂÖ≥Ê≥®Á§æ‰ºöÁé∞ÂÆûÂíå‰∫∫ÊÄßÊå£ÊâéÔºåÁ¨îËß¶È•±Âê´ÊÑüÊÉÖÔºåËØ≠Ë®ÄÊµÅÁïÖËá™ÁÑ∂ÔºåÂÖÖÊª°ÁêÜÊÉ≥‰∏ª‰πâËâ≤ÂΩ©„ÄÇ", maxOutput: 650 },
    { name: "ÊûóËØ≠Â†Ç", style: "ÂπΩÈªòÈõÖËá¥Ôºå‰∏≠Ë•øÂêàÁíßÔºåÊñáÂ≠óÈó≤ÈÄÇËá™Âú®ÔºåÂñÑ‰∫éËÆÆËÆ∫ÂíåÊäíÊÉÖÔºåËØ≠Ë®ÄËΩªÊùæËØôË∞êÔºåÂÖÖÊª°ÁîüÊ¥ªÂì≤ÁêÜÂíå‰∫∫ÁîüÊô∫ÊÖß„ÄÇ", maxOutput: 600 },
    { name: "ÂÜ∞ÂøÉ", style: "Ê∏ÖÊñ∞Á∫ØÂáÄÔºåÊñáÂ≠óÊ∏©Â©âÊüîÁæéÔºåÂñÑ‰∫éÊäíÂèëÊØçÁà±„ÄÅÁ´•ÁúüÂíåËá™ÁÑ∂‰πãÁæéÔºåÁ¨îËß¶ÁªÜËÖªÁúüÊåöÔºåËØ≠Ë®Ä‰ºòÁæéÂ¶ÇËØóÔºåÂÖÖÊª°Ê∏©ÊÉÖ„ÄÇ", maxOutput: 500 },
    { name: "‰ΩôÂçé", style: "ÂÜ∑Â≥ªÂÖãÂà∂ÔºåÂñÑ‰∫éÊèèÂÜôÂëΩËøêÁöÑËçíËØûÂíå‰∫∫ÊÄßÁöÑÂùöÈüßÔºåÊñáÂ≠óÁÆÄÊ¥ÅÊúâÂäõÔºåÂèô‰∫ãÂÜ∑ÈùôÂÆ¢ËßÇÔºåÂç¥ËÉΩÁõ¥Âáª‰∫∫ÂøÉÔºåÂÖÖÊª°ÊÇ≤ÊÇØÊÉÖÊÄÄ„ÄÇ", maxOutput: 650 },
    { name: "Ëé´Ë®Ä", style: "È≠îÂπªÁé∞ÂÆûÔºåÊÉ≥Ë±°Âäõ‰∏∞ÂØåÔºåÊñáÂ≠óÊÅ£ËÇÜÊ±™Ê¥ãÔºåÂñÑ‰∫éÁî®Ê∞ëÈó¥‰º†ËØ¥Âíå‰π°ÂúüÂÖÉÁ¥†ÔºåËØ≠Ë®ÄÊµìÁÉàÂ•îÊîæÔºåÂÖÖÊª°ÁîüÂëΩÂäõÂíåÂº†Âäõ„ÄÇ", maxOutput: 800 }
  ];

  // 1. ÂàùÂßãÂåñÊï∞ÊçÆ (Âú® openGreenRiverScreen Êó∂Ë∞ÉÁî®)
  async function initGreenRiverData() {
    const count = await db.grAuthors.count();
    if (count === 0) {
      await db.grAuthors.bulkAdd(DEFAULT_AUTHORS);
    }
  }

  // 2. ÊâìÂºÄ‰∏ªÁïåÈù¢
  async function openGreenRiverScreen() {
    await initGreenRiverData();
    showScreen('green-river-screen');
    renderBookList();
  }

  // 3. Ê∏≤Êüì‰π¶Êû∂
  // ÊâæÂà∞ renderBookList ÂáΩÊï∞ÔºåÊõøÊç¢Êï¥‰∏™ÂáΩÊï∞
  async function renderBookList() {
    const listEl = document.getElementById('gr-book-list');
    listEl.innerHTML = '';

    const stories = await db.grStories.orderBy('lastUpdated').reverse().toArray();
    const authors = await db.grAuthors.toArray();
    const authorMap = new Map(authors.map(a => [a.id, a.name]));

    // Ëé∑ÂèñÂ∑≤ÂÖ≥ËÅîÁöÑ‰π¶Á±çIDÈõÜÂêà
    const existingBooks = await db.readingLibrary.toArray();
    const linkedIds = new Set(existingBooks.map(b => b.linkedStoryId).filter(id => id));

    if (stories.length === 0) {
      listEl.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:var(--gr-text-sub); margin-top:50px;">‰π¶Êû∂ÊòØÁ©∫ÁöÑÔºåÁÇπÂáªÂè≥‰∏äËßíÊñ∞Âª∫‰∏ÄÈÉ®‰ΩúÂìÅÂêß„ÄÇ</p>';
      return;
    }

    stories.forEach(story => {
      const authorName = authorMap.get(story.authorId) || 'Êú™Áü•‰ΩúËÄÖ';
      const div = document.createElement('div');
      div.className = 'gr-book-card';

      const wordCount = story.chapters.reduce((acc, ch) => acc + ch.content.length, 0);

      // „ÄêÊ†∏ÂøÉÈÄªËæë‰øÆÊîπ„Äë
      const isAdded = linkedIds.has(story.id);
      // Â¶ÇÊûúÂ∑≤Âä†ÂÖ•ÔºåÊòæÁ§∫‚ÄúÂ∑≤Âú®‰π¶Êû∂‚ÄùÔºåÁÇπÂáªËß¶ÂèëÁßªÈô§ÔºõÂê¶ÂàôÊòæÁ§∫‚ÄúÂä†ÂÖ•‚ÄùÔºåÁÇπÂáªËß¶ÂèëÂä†ÂÖ•
      const btnText = isAdded ? 'Â∑≤Âú®‰π¶Êû∂' : 'Âä†ÂÖ•ÂÖ±ËØª';
      const btnClass = isAdded ? 'gr-add-shelf-btn added' : 'gr-add-shelf-btn';
      const actionFn = isAdded ? 'removeGreenRiverFromShelf' : 'addGreenRiverToShelf';

      div.innerHTML = `
            <div>
                <div class="gr-book-title">${story.title}</div>
                <div class="gr-book-meta">
                    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    ${authorName}
                </div>
            </div>
            <div class="gr-book-meta" style="justify-content: space-between; margin-top:15px; align-items: flex-end;">
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <span>${story.chapters.length} Á´†</span>
                    <span>${(wordCount / 1000).toFixed(1)}k Â≠ó</span>
                </div>
                <button class="${btnClass}" onclick="event.stopPropagation(); ${actionFn}(${story.id}, this);">
                    ${isAdded ? '‚úì ' : '+ '}${btnText}
                </button>
            </div>
        `;

      div.onclick = (e) => {
        if (e.target.tagName !== 'BUTTON') openReader(story.id);
      };

      addLongPressListener(div, async () => {
        if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§‰ΩúÂìÅ„Ää${story.title}„ÄãÂêóÔºü`)) {
          await db.grStories.delete(story.id);
          renderBookList();
        }
      });

      listEl.appendChild(div);
    });
  }

  // 4. ‰ΩúËÄÖÁÆ°ÁêÜ
  // --- ÁªøÊ±ü‰ΩúËÄÖÁÆ°ÁêÜÈáçÊûÑ (‰øÆÂ§çÂ∏ÉÂ±ÄÂíåÁºñËæëÂäüËÉΩ) ---

  let editingAuthorId = null; // Áî®‰∫éËÆ∞ÂΩïÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑ‰ΩúËÄÖID

  // 1. ÊâìÂºÄ‰ΩúËÄÖÁÆ°ÁêÜÂàóË°® (Ê∏≤ÊüìÁïåÈù¢)
  async function openAuthorManager() {
    showScreen('gr-author-screen');
    const listEl = document.getElementById('gr-author-list');
    listEl.innerHTML = '';

    const authors = await db.grAuthors.toArray();

    if (authors.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color:#999; margin-top:50px;">ËøòÊ≤°ÊúâËÆæÂÆö‰ΩúËÄÖÔºåÁÇπÂáªÂè≥‰∏äËßí‚Äú+‚ÄùÊ∑ªÂä†„ÄÇ</p>';
      return;
    }

    authors.forEach(author => {
      const div = document.createElement('div');
      div.className = 'gr-author-item';
      div.innerHTML = `
            <div class="gr-author-info" style="flex-grow: 1; padding-right: 10px; min-width: 0;">
                <h3 style="margin: 0 0 5px 0; font-size: 16px; font-weight: 600; color: #1C1C1E;">${author.name}</h3>
                <p style="margin: 0; font-size: 13px; color: #8E8E93; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5;">${author.style}</p>
            </div>
            <div class="gr-author-actions">
                <button class="gr-icon-btn" onclick="openAuthorEditor(${author.id})" title="ÁºñËæë">
                   <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button class="gr-icon-btn" style="color:#ff3b30;" onclick="deleteAuthor(${author.id})" title="Âà†Èô§">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        `;
      listEl.appendChild(div);
    });
  }

  // 2. ÊâìÂºÄÁºñËæë/Ê∑ªÂä†ÂºπÁ™ó
  // Â¶ÇÊûú‰º†ÂÖ• idÔºåÂàôÊòØÁºñËæëÊ®°ÂºèÔºõÂê¶ÂàôÊòØÊ∑ªÂä†Ê®°Âºè
  async function openAuthorEditor(id = null) {
    editingAuthorId = id;
    const modal = document.getElementById('gr-author-editor-modal');
    const titleEl = document.getElementById('gr-author-editor-title');
    const nameInput = document.getElementById('gr-author-name-input');
    const styleInput = document.getElementById('gr-author-style-input');

    if (id) {
      // ÁºñËæëÊ®°ÂºèÔºöÂõûÊòæÊï∞ÊçÆ
      const author = await db.grAuthors.get(id);
      if (author) {
        titleEl.textContent = "ÁºñËæë‰ΩúËÄÖ";
        nameInput.value = author.name;
        styleInput.value = author.style;
      }
    } else {
      // Ê∑ªÂä†Ê®°ÂºèÔºöÊ∏ÖÁ©∫Êï∞ÊçÆ
      titleEl.textContent = "Ê∑ªÂä†‰ΩúËÄÖ";
      nameInput.value = "";
      styleInput.value = "";
    }

    modal.classList.add('visible');
  }

  // 3. ‰øùÂ≠ò‰ΩúËÄÖ (Áî±ÂºπÁ™óÂÜÖÁöÑ‰øùÂ≠òÊåâÈíÆË∞ÉÁî®)
  async function saveAuthor() {
    const name = document.getElementById('gr-author-name-input').value.trim();
    const style = document.getElementById('gr-author-style-input').value.trim();

    if (!name || !style) {
      alert("ÂêçÁß∞ÂíåÈ£éÊ†ºÊèèËø∞ÈÉΩ‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
      return;
    }

    if (editingAuthorId) {
      // Êõ¥Êñ∞
      await db.grAuthors.update(editingAuthorId, { name, style });
    } else {
      // Êñ∞Â¢û
      await db.grAuthors.add({ name, style, maxOutput: 600 });
    }

    // ÂÖ≥Èó≠ÂºπÁ™óÂπ∂Âà∑Êñ∞ÂàóË°®
    document.getElementById('gr-author-editor-modal').classList.remove('visible');
    openAuthorManager();
  }

  // 4. Âà†Èô§‰ΩúËÄÖ
  async function deleteAuthor(id) {
    const confirmed = await showCustomConfirm("Á°ÆËÆ§Âà†Èô§", "Á°ÆÂÆöÂà†Èô§Ëøô‰Ωç‰ΩúËÄÖËÆæÂÆöÂêóÔºü\n(Ëøô‰∏ç‰ºöÂΩ±ÂìçÂ∑≤ÁîüÊàêÁöÑÁ´†ËäÇÂÜÖÂÆπ)", { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
      await db.grAuthors.delete(id);
      openAuthorManager();
    }
  }

  // 5. ÁªëÂÆöÂ§¥ÈÉ®‚Äú+‚ÄùÊåâÈíÆÂà∞Êñ∞ÁöÑÁºñËæëÂô®ÈÄªËæë
  // (Ëøô‰∏™ÂáΩÊï∞Âêç‰∏éHTML‰∏≠ÁöÑonclick="addAuthor()"ÂØπÂ∫îÔºåÊàë‰ª¨Â∞ÜÂÖ∂ÈáçÂÆöÂêëÂà∞openAuthorEditor)
  function addAuthor() {
    openAuthorEditor(null);
  }

  // 6. ÁªëÂÆö‰øùÂ≠òÊåâÈíÆ‰∫ã‰ª∂ (Âú®ÂàùÂßãÂåñÊó∂ÊâßË°å‰∏ÄÊ¨°Âç≥ÂèØÔºåÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆö)
  const saveBtn = document.getElementById('gr-save-author-btn');
  if (saveBtn) {
    // ‰ΩøÁî® cloneNode ÁßªÈô§ÊóßÁöÑÁõëÂê¨Âô® (Â¶ÇÊûúÊúâÁöÑËØù)
    const newBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newBtn, saveBtn);
    newBtn.onclick = saveAuthor;
  }

  // Êö¥Èú≤ÁªôÂÖ®Â±Ä
  window.openAuthorManager = openAuthorManager;
  window.openAuthorEditor = openAuthorEditor;
  window.addAuthor = addAuthor;
  window.deleteAuthor = deleteAuthor;

  // 5. Êñ∞Âª∫‰ΩúÂìÅ (ËÆæÁΩÆÈ°µ)
  async function createNewStory() {
    grState.activeStoryId = null; // Ê†áËÆ∞‰∏∫Êñ∞Âª∫
    document.getElementById('gr-story-title').value = '';
    await loadStorySettingsUI();
    document.getElementById('gr-settings-modal').classList.add('visible');
  }

  async function openStorySettings() {
    if (!grState.activeStoryId) return;
    const story = await db.grStories.get(grState.activeStoryId);
    if (!story) return;

    document.getElementById('gr-story-title').value = story.title;
    await loadStorySettingsUI(story.settings, story.authorId);

    document.getElementById('gr-settings-modal').classList.add('visible');
  }

  // Âä†ËΩΩËÆæÁΩÆÂºπÁ™ó‰∏≠ÁöÑÈÄâÈ°π
  // Âä†ËΩΩËÆæÁΩÆÂºπÁ™ó‰∏≠ÁöÑÈÄâÈ°π (‰øÆÂ§çÁâàÔºöÂ¢ûÂä†Â≠óÊï∞ÂíåÊù°Êï∞ÁöÑÂõûÊòæ)
  async function loadStorySettingsUI(settings = {}, selectedAuthorId = null) {
    // 1. Âä†ËΩΩ‰ΩúËÄÖÂàóË°®
    const authorSelect = document.getElementById('gr-author-select');
    authorSelect.innerHTML = '';
    const authors = await db.grAuthors.toArray();
    authors.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.id;
      opt.textContent = a.name;
      if (selectedAuthorId === a.id) opt.selected = true;
      authorSelect.appendChild(opt);
    });

    // 2. Âä†ËΩΩËßíËâ≤ÂàóË°® (Chats + NPCs)
    const charList = document.getElementById('gr-char-list');
    charList.innerHTML = '';
    const chars = Object.values(state.chats);
    const npcs = await db.npcs.toArray();

    const allEntities = [
      ...chars.map(c => ({ id: c.id, name: c.name, type: c.isGroup ? 'Áæ§ËÅä' : 'ËßíËâ≤' })),
      ...npcs.map(n => ({ id: `npc_${n.id}`, name: n.name, type: 'NPC' }))
    ];

    allEntities.forEach(item => {
      const div = document.createElement('div');
      div.className = 'gr-checkbox-item';
      // ÂõûÊòæÔºöÊ£ÄÊü•ÊòØÂê¶Âú®Â∑≤‰øùÂ≠òÁöÑÂàóË°®‰∏≠
      const isChecked = settings.charIds && settings.charIds.includes(item.id);
      div.innerHTML = `<input type="checkbox" value="${item.id}" ${isChecked ? 'checked' : ''}> <span>${item.name} <small style="color:#999">(${item.type})</small></span>`;
      div.onclick = (e) => { if (e.target.tagName !== 'INPUT') div.querySelector('input').click(); };
      charList.appendChild(div);
    });

    // 3. Âä†ËΩΩ‰∏ñÁïå‰π¶ÂàóË°®
    const wbList = document.getElementById('gr-worldbook-list');
    wbList.innerHTML = '';
    const books = await db.worldBooks.toArray();
    books.forEach(book => {
      const div = document.createElement('div');
      div.className = 'gr-checkbox-item';
      // ÂõûÊòæÔºöÊ£ÄÊü•ÊòØÂê¶Âú®Â∑≤‰øùÂ≠òÁöÑÂàóË°®‰∏≠
      const isChecked = settings.bookIds && settings.bookIds.includes(book.id);
      div.innerHTML = `<input type="checkbox" value="${book.id}" ${isChecked ? 'checked' : ''}> <span>${book.name}</span>`;
      div.onclick = (e) => { if (e.target.tagName !== 'INPUT') div.querySelector('input').click(); };
      wbList.appendChild(div);
    });

    // 4. Âä†ËΩΩUserÈ¢ÑËÆæ
    const userSelect = document.getElementById('gr-user-persona-select');
    userSelect.innerHTML = '<option value="">ÂΩìÂâçÈªòËÆ§</option>';
    const presets = await db.personaPresets.toArray();
    presets.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.persona.substring(0, 20) + '...';
      // ÂõûÊòæÔºöÈÄâ‰∏≠Â∑≤‰øùÂ≠òÁöÑ User Persona
      if (settings.userPersonaId === p.id) opt.selected = true;
      userSelect.appendChild(opt);
    });

    // 5. „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÔºöÂõûÊòæÂ≠óÊï∞Âíå‰∏ä‰∏ãÊñáÊù°Êï∞
    // Â¶ÇÊûú settings ÈáåÊúâÂÄºÔºåÂ∞±Áî® settings ÈáåÁöÑÔºõÂ¶ÇÊûúÊ≤°ÊúâÔºàÊñ∞Âª∫Êó∂ÔºâÔºåÂ∞±Áî®ÈªòËÆ§ÂÄº 500 Âíå 20
    document.getElementById('gr-output-length').value = settings.outputLength || 500;
    document.getElementById('gr-context-limit').value = settings.contextLimit || 20;
    document.getElementById('gr-macro-world-view').value = settings.macroWorldView || '';

    // 6. Âä†ËΩΩ‰ΩúËÄÖËøΩÊõ¥Áõ∏ÂÖ≥ËÆæÁΩÆ
    const autoUpdateEnabled = document.getElementById('gr-auto-update-enabled');
    const autoUpdateSettings = document.getElementById('gr-auto-update-settings');
    const updateType = document.getElementById('gr-auto-update-type');
    const updateAuthorSelect = document.getElementById('gr-update-author-select');
    const updateCharacterSelect = document.getElementById('gr-update-character-select');
    const updateFrequency = document.getElementById('gr-update-frequency');
    const customFrequencyGroup = document.getElementById('gr-custom-frequency-group');
    const customFrequencyHours = document.getElementById('gr-custom-frequency-hours');

    // ÂõûÊòæËøΩÊõ¥ÂºÄÂÖ≥
    autoUpdateEnabled.checked = settings.autoUpdate?.enabled || false;
    autoUpdateSettings.style.display = autoUpdateEnabled.checked ? 'block' : 'none';

    // Â°´ÂÖÖ‰ΩúËÄÖÈÄâÊã©ÂàóË°®ÔºàËøΩÊõ¥Áî®Ôºâ
    updateAuthorSelect.innerHTML = '';
    authors.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.id;
      opt.textContent = a.name;
      if (settings.autoUpdate?.authorId === a.id) opt.selected = true;
      updateAuthorSelect.appendChild(opt);
    });

    // Â°´ÂÖÖËßíËâ≤ÈÄâÊã©ÂàóË°®ÔºàËøΩÊõ¥Áî®Ôºâ
    updateCharacterSelect.innerHTML = '';
    allEntities.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.id;
      opt.textContent = `${item.name} (${item.type})`;
      if (settings.autoUpdate?.characterId === item.id) opt.selected = true;
      updateCharacterSelect.appendChild(opt);
    });

    // ÂõûÊòæËøΩÊõ¥ÊñπÂºè
    updateType.value = settings.autoUpdate?.type || 'author';
    document.getElementById('gr-update-author-select-group').style.display =
      updateType.value === 'author' ? 'block' : 'none';
    document.getElementById('gr-update-character-select-group').style.display =
      updateType.value === 'character' ? 'block' : 'none';

    // ÂõûÊòæÊõ¥Êñ∞È¢ëÁéá
    updateFrequency.value = settings.autoUpdate?.frequency || 'manual';
    customFrequencyGroup.style.display = updateFrequency.value === 'custom' ? 'block' : 'none';
    customFrequencyHours.value = settings.autoUpdate?.customHours || 24;
    
    // ÂõûÊòæÊØèÊó•Êõ¥Êñ∞Êó∂Èó¥
    const dailyTimeGroup = document.getElementById('gr-daily-time-group');
    const dailyUpdateHour = document.getElementById('gr-daily-update-hour');
    dailyTimeGroup.style.display = updateFrequency.value === 'daily' ? 'block' : 'none';
    dailyUpdateHour.value = settings.autoUpdate?.dailyHour || 12;
    
    // ÂõûÊòæÊØèÂë®Êõ¥Êñ∞Êó∂Èó¥
    const weeklyTimeGroup = document.getElementById('gr-weekly-time-group');
    const weeklyUpdateDay = document.getElementById('gr-weekly-update-day');
    const weeklyUpdateHour = document.getElementById('gr-weekly-update-hour');
    weeklyTimeGroup.style.display = updateFrequency.value === 'weekly' ? 'block' : 'none';
    weeklyUpdateDay.value = settings.autoUpdate?.weeklyDay || 1;
    weeklyUpdateHour.value = settings.autoUpdate?.weeklyHour || 12;
    
    // ÊòæÁ§∫‰∏äÊ¨°Êõ¥Êñ∞Êó∂Èó¥
    const lastUpdateDisplay = document.getElementById('gr-last-update-display');
    const lastUpdateTime = document.getElementById('gr-last-update-time');
    const nextUpdateTime = document.getElementById('gr-next-update-time');
    lastUpdateDisplay.style.display = updateFrequency.value !== 'manual' ? 'block' : 'none';
    
    if (settings.autoUpdate?.lastUpdate) {
      const lastDate = new Date(settings.autoUpdate.lastUpdate);
      lastUpdateTime.textContent = lastDate.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      // ËÆ°ÁÆó‰∏ãÊ¨°Êõ¥Êñ∞Êó∂Èó¥
      const nextUpdate = calculateNextUpdateTime(settings.autoUpdate);
      if (nextUpdate) {
        nextUpdateTime.textContent = nextUpdate.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } else {
        nextUpdateTime.textContent = 'ÂæÖËÆ°ÁÆó';
      }
    } else {
      lastUpdateTime.textContent = '‰ªéÊú™Êõ¥Êñ∞';
      nextUpdateTime.textContent = 'È¶ñÊ¨°Êõ¥Êñ∞Â∞ÜÂú®ËÆæÂÆöÊó∂Èó¥ÊâßË°å';
    }

    // ÁªëÂÆöËøΩÊõ¥ËÆæÁΩÆÁöÑ‰∫ã‰ª∂ÁõëÂê¨
    autoUpdateEnabled.onchange = () => {
      autoUpdateSettings.style.display = autoUpdateEnabled.checked ? 'block' : 'none';
    };

    updateType.onchange = () => {
      document.getElementById('gr-update-author-select-group').style.display =
        updateType.value === 'author' ? 'block' : 'none';
      document.getElementById('gr-update-character-select-group').style.display =
        updateType.value === 'character' ? 'block' : 'none';
    };

    updateFrequency.onchange = () => {
      const dailyTimeGroup = document.getElementById('gr-daily-time-group');
      const weeklyTimeGroup = document.getElementById('gr-weekly-time-group');
      const lastUpdateDisplay = document.getElementById('gr-last-update-display');
      
      customFrequencyGroup.style.display = updateFrequency.value === 'custom' ? 'block' : 'none';
      dailyTimeGroup.style.display = updateFrequency.value === 'daily' ? 'block' : 'none';
      weeklyTimeGroup.style.display = updateFrequency.value === 'weekly' ? 'block' : 'none';
      
      // ÊòæÁ§∫‰∏äÊ¨°Êõ¥Êñ∞Êó∂Èó¥ÔºàÈùûÊâãÂä®Ê®°ÂºèÊó∂ÊòæÁ§∫Ôºâ
      lastUpdateDisplay.style.display = updateFrequency.value !== 'manual' ? 'block' : 'none';
    };

    // ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
    const saveBtn = document.getElementById('gr-save-story-btn');
    const cancelBtn = document.getElementById('gr-cancel-settings-btn');

    // ‰ΩøÁî® cloneNode Ê∏ÖÈô§ÊóßÁöÑÁõëÂê¨Âô®ÔºåÈò≤Ê≠¢Â§öÊ¨°ÁÇπÂáª
    const newSaveBtn = saveBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);

    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

    newSaveBtn.onclick = () => saveStorySettings();
    newCancelBtn.onclick = () => document.getElementById('gr-settings-modal').classList.remove('visible');
  }

  // 5. ‰øÆÂ§çÁâàÔºö‰øùÂ≠ò‰ΩúÂìÅËÆæÁΩÆ
  async function saveStorySettings() {
    // Ëé∑Âèñ DOM ÂÖÉÁ¥†
    const titleInput = document.getElementById('gr-story-title');
    const authorSelect = document.getElementById('gr-author-select');
    const userPersonaSelect = document.getElementById('gr-user-persona-select');
    const outputLengthInput = document.getElementById('gr-output-length'); // Ê£ÄÊü•HTML IDÊòØÂê¶‰∏ÄËá¥
    const contextLimitInput = document.getElementById('gr-context-limit'); // Ê£ÄÊü•HTML IDÊòØÂê¶‰∏ÄËá¥
    const macroWorldViewInput = document.getElementById('gr-macro-world-view');
    const title = titleInput.value.trim();
    const authorId = parseInt(authorSelect.value);

    const charIds = Array.from(document.querySelectorAll('#gr-char-list input:checked')).map(cb => cb.value);
    const bookIds = Array.from(document.querySelectorAll('#gr-worldbook-list input:checked')).map(cb => cb.value);
    const userPersonaId = userPersonaSelect.value;

    // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÔºöÁ°Æ‰øùËøôÈáåÂèñÂà∞ÁöÑÊòØÊï∞Â≠óÔºåÂπ∂‰∏îÊúâÈªòËÆ§ÂÄº
    const outputLength = parseInt(outputLengthInput.value) || 500;
    const contextLimit = parseInt(contextLimitInput.value) || 20;
    const macroWorldView = macroWorldViewInput.value.trim();
    if (!title) return alert("ËØ∑ËæìÂÖ•‰π¶Âêç");
    if (charIds.length === 0) return alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤ÊàñÁæ§ËÅä");

    // Ëé∑Âèñ‰ΩúËÄÖËøΩÊõ¥ËÆæÁΩÆ
    const autoUpdateEnabled = document.getElementById('gr-auto-update-enabled').checked;
    let autoUpdate;
    
    if (autoUpdateEnabled) {
      const updateType = document.getElementById('gr-auto-update-type').value;
      const updateAuthorId = parseInt(document.getElementById('gr-update-author-select').value) || null;
      const updateCharacterId = document.getElementById('gr-update-character-select').value || null;
      const frequency = document.getElementById('gr-update-frequency').value;
      
      // È™åËØÅÈÖçÁΩÆ
      if (updateType === 'author' && !updateAuthorId) {
        alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™‰ΩúËÄÖÁî®‰∫éËøΩÊõ¥');
        return;
      }
      if (updateType === 'character' && !updateCharacterId) {
        alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤Áî®‰∫éËøΩÊõ¥');
        return;
      }
      
      autoUpdate = {
        enabled: true,
        type: updateType,
        authorId: updateAuthorId,
        characterId: updateCharacterId,
        frequency: frequency,
        customHours: parseInt(document.getElementById('gr-custom-frequency-hours').value) || 24,
        dailyHour: parseInt(document.getElementById('gr-daily-update-hour').value) || 12,
        weeklyDay: parseInt(document.getElementById('gr-weekly-update-day').value) || 1,
        weeklyHour: parseInt(document.getElementById('gr-weekly-update-hour').value) || 12,
        lastUpdate: settings.autoUpdate?.lastUpdate || null // ‰øùÁïô‰πãÂâçÁöÑÊõ¥Êñ∞Êó∂Èó¥
      };
    } else {
      autoUpdate = {
        enabled: false
      };
    }

    const settings = {
      charIds,
      bookIds,
      userPersonaId,
      outputLength, // ËøôÈáåÁöÑÂêçÂ≠óË¶ÅÂíå prompt ÈáåÁöÑÂØπÂ∫î
      contextLimit,
      macroWorldView,
      autoUpdate // Ê∑ªÂä†‰ΩúËÄÖËøΩÊõ¥ËÆæÁΩÆ
    };

    if (grState.activeStoryId) {
      // Êõ¥Êñ∞Áé∞Êúâ‰ΩúÂìÅ
      await db.grStories.update(grState.activeStoryId, { title, authorId, settings });
    } else {
      // Êñ∞Âª∫‰ΩúÂìÅ
      const newStory = {
        title,
        authorId,
        settings,
        chapters: [],
        lastUpdated: Date.now()
      };
      grState.activeStoryId = await db.grStories.add(newStory);
    }

    document.getElementById('gr-settings-modal').classList.remove('visible');

    // ÊâìÂºÄÈòÖËØªÂô®ÔºåÂπ∂ÂÆö‰ΩçÂà∞ÊúÄÊñ∞‰∏ÄÁ´†
    const story = await db.grStories.get(grState.activeStoryId);
    const lastIndex = Math.max(0, story.chapters.length - 1);
    openReader(grState.activeStoryId, lastIndex);
  }

  // 6. ÈòÖËØªÂô®ÈÄªËæë - ÂàÜÈ°µÁâà (Jinjiang Style)
  async function openReader(storyId, chapterIndex = 0) {
    grState.activeStoryId = storyId;
    const story = await db.grStories.get(storyId);
    if (!story) return;

    // Á°Æ‰øùÁ¥¢ÂºïÂêàÊ≥ï
    const totalChapters = story.chapters.length;
    if (totalChapters > 0 && chapterIndex >= totalChapters) chapterIndex = totalChapters - 1;
    if (chapterIndex < 0) chapterIndex = 0;

    grState.currentChapterIndex = chapterIndex;

    // Êõ¥Êñ∞È°∂ÈÉ®Ê†áÈ¢ò
    document.getElementById('gr-book-name-display').textContent = story.title;

    const contentArea = document.getElementById('gr-reader-content');
    contentArea.innerHTML = '';

    // --- Âú∫ÊôØ A: Â∞öÊú™ÂºÄÂßã (Ê≤°ÊúâÁ´†ËäÇ) ---
    if (totalChapters === 0) {
      document.getElementById('gr-chapter-title-display').textContent = "Â∫èÁ´†";
      contentArea.innerHTML = `
            <div style="text-align:center; padding-top:100px; color:#888;">
                <p>ÊïÖ‰∫ãÂ∞öÊú™ÂºÄÂßã„ÄÇ</p>
                <p>ËØ∑Âú®‰∏ãÊñπËæìÂÖ•Á¨¨‰∏ÄÁ´†ÁöÑÂâßÊÉÖËµ∞ÂêëÔºåÁÇπÂáª‚ÄúÁª≠ÂÜô‚ÄùÂºÄÂßãÂàõ‰Ωú„ÄÇ</p>
            </div>
        `;
      // ÊòæÁ§∫ÂÜô‰ΩúÊéßÂà∂Ê†èÔºåÈöêËóèÁøªÈ°µÊ†è
      document.getElementById('gr-pagination-controls').style.display = 'none';
      document.getElementById('gr-writing-controls').style.display = 'flex';

      // ÁªëÂÆöÁîüÊàêÊåâÈíÆ
      updateGenButtonBinding();
      showScreen('gr-reader-screen');
      return;
    }

    // --- Âú∫ÊôØ B: ÊòæÁ§∫ÁâπÂÆöÁ´†ËäÇ ---
    const chapter = story.chapters[chapterIndex];
    const chapterTitle = chapter.title || `Á¨¨ ${chapterIndex + 1} Á´†`; // Â¶ÇÊûúÊ≤°ÊúâÊ†áÈ¢òÔºå‰ΩøÁî®ÈªòËÆ§

    document.getElementById('gr-chapter-title-display').textContent = chapterTitle;

    // 1. È°∂ÈÉ®ÔºöÂâçÊÉÖÊèêË¶Å (Context)
    if (chapter.prevSummary) {
      contentArea.innerHTML += `
            <details class="gr-summary-box top-summary">
                <summary>üìñ ‰∏äÊñáÊèêË¶Å (Context)</summary>
                <div class="gr-summary-content" style="font-size:12px; color:#888;">${chapter.prevSummary}</div>
            </details>
        `;
    }

    // 2. Á´†ËäÇÂ§ßÊ†áÈ¢ò
    contentArea.innerHTML += `<div class="gr-chapter-title-large">${chapterTitle}</div>`;

    // 3. Ê≠£Êñá
    contentArea.innerHTML += `<div class="gr-chapter-text">${chapter.content.replace(/\n/g, '<br>')}</div>`;

    // 4. Â∫ïÈÉ®ÔºöÊú¨Á´†ÊëòË¶Å (ÂèØÁºñËæë)
    const summaryHtml = `
            <div class="gr-summary-card editable">
                <div class="gr-summary-header">
                    <span class="gr-summary-title">Chapter Checkpoint ¬∑ ÂâßÊÉÖÂ≠òÊ°£</span>
                    <button class="gr-mini-btn save-summary-btn" data-index="${chapterIndex}">‰øùÂ≠ò‰øÆÊîπ</button>
                </div>
                <textarea class="gr-summary-input" data-index="${chapterIndex}" placeholder="Âú®Ê≠§Â§ÑÊ¶ÇÊã¨Êú¨Á´†ÂÖ≥ÈîÆÂâßÊÉÖÁÇπÔºå‰æõAIËÆ∞ÂøÜ...">${chapter.summary || ''}</textarea>
                 <div class="gr-summary-footer">
                    * AIÁª≠ÂÜôÊó∂Â∞ÜËØªÂèñÊ≠§Ê°ÜÂÜÖÂÆπ‰Ωú‰∏∫ÂîØ‰∏ÄËÆ∞ÂøÜ‰æùÊçÆ„ÄÇ
                </div>
            </div>
        `;
    contentArea.innerHTML += summaryHtml;
    contentArea.innerHTML += `<div style="height: 100px;"></div>`;

    // ÁªëÂÆö‰øùÂ≠òÊëòË¶ÅÊåâÈíÆ
    contentArea.querySelectorAll('.save-summary-btn').forEach(btn => {
      btn.onclick = (e) => {
        const idx = parseInt(e.target.dataset.index);
        const textarea = contentArea.querySelector(`.gr-summary-input[data-index="${idx}"]`);
        saveChapterSummary(storyId, idx, textarea.value);
        e.target.textContent = "Â∑≤‰øùÂ≠ò";
        setTimeout(() => e.target.style.display = 'none', 1000);
      };
    });

    // 5. Êõ¥Êñ∞Â∫ïÈÉ®ÂØºËà™Ê†èÁä∂ÊÄÅ
    const prevBtn = document.getElementById('gr-prev-chapter-btn');
    const nextBtn = document.getElementById('gr-next-chapter-btn');
    const paginationDiv = document.getElementById('gr-pagination-controls');
    const writingDiv = document.getElementById('gr-writing-controls');
    const rerollBtn = document.getElementById('gr-reroll-btn');

    // ÊÄªÊòØÊòæÁ§∫ÂàÜÈ°µÊ†èÔºåÂÜô‰ΩúÊ†èÂè™Âú®ÊúÄÂêé‰∏ÄÈ°µÊòæÁ§∫
    paginationDiv.style.display = 'flex';

    prevBtn.disabled = (chapterIndex === 0);
    prevBtn.onclick = () => openReader(storyId, chapterIndex - 1);

    if (chapterIndex < totalChapters - 1) {
      // Â¶ÇÊûú‰∏çÊòØÊúÄÂêé‰∏ÄÁ´†
      nextBtn.textContent = "‰∏ã‰∏ÄÁ´†";
      nextBtn.onclick = () => openReader(storyId, chapterIndex + 1);
      writingDiv.style.display = 'none'; // ÈöêËóèÂÜô‰ΩúÊ†è
    } else {
      // Â¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÁ´†
      nextBtn.textContent = "Áª≠ÂÜô‰∏ã‰∏ÄÁ´†";
      nextBtn.onclick = () => {
        // ÁÇπÂáª‰∏ã‰∏ÄÁ´†ÊåâÈíÆÊó∂ÔºåÊòæÁ§∫ÂÜô‰ΩúÊ†èÔºåÂπ∂Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
        writingDiv.style.display = 'flex';
        contentArea.scrollTop = contentArea.scrollHeight;
        document.getElementById('gr-direction-input').focus();
      };
      // ÈªòËÆ§‰πüÊòæÁ§∫ÂÜô‰ΩúÊ†è
      writingDiv.style.display = 'flex';

      // ÁªëÂÆöÈáçÂÜôÊåâÈíÆ
      rerollBtn.onclick = async () => {
        const confirmed = await showCustomConfirm("ÈáçÂÜôÊú¨Á´†", "Á°ÆÂÆöË¶ÅÂà†Èô§ÂΩìÂâçÁ´†ËäÇÂπ∂ÈáçÊñ∞ÁîüÊàêÂêóÔºü", { confirmText: "ÈáçÂÜô", confirmButtonClass: "btn-danger" });
        if (confirmed) handleGenerateStoryContent(true);
      };
    }

    // ÁªëÂÆöÁîüÊàêÊåâÈíÆ
    updateGenButtonBinding();

    showScreen('gr-reader-screen');
    contentArea.scrollTop = 0;
  }

  // ËæÖÂä©ÔºöÁªëÂÆöÁîüÊàêÊåâÈíÆ
  function updateGenButtonBinding() {
    const genBtn = document.getElementById('gr-generate-btn');
    // ‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÊù•ÁßªÈô§ÊóßÁöÑÁõëÂê¨Âô®
    const newBtn = genBtn.cloneNode(true);
    genBtn.parentNode.replaceChild(newBtn, genBtn);
    newBtn.onclick = () => handleGenerateStoryContent(false);
  }

  // ËæÖÂä©ÔºöÊõ¥Êñ∞Â∫ïÈÉ®ÊéßÂà∂Ê†è
  function updateControlPanel(story) {
    const controlPanel = document.querySelector('.gr-control-panel');
    // Ê∏ÖÁ©∫ÊóßÂÜÖÂÆπÔºåÈáçÊñ∞ÊûÑÂª∫
    controlPanel.innerHTML = `
        <div style="display:flex; gap:10px; align-items:center; width:100%;">
            <div class="gr-input-group" style="flex-grow:1;">
                <input type="text" id="gr-direction-input" class="gr-input" placeholder="ËæìÂÖ•ÂâßÊÉÖËµ∞Âêë (ÁïôÁ©∫ÂàôËá™Áî±Áª≠ÂÜô)...">
            </div>
            
            ${story.chapters.length > 0 ? `
            <button id="gr-reroll-btn" class="gr-main-btn" style="background-color:#F4F4F5; color:#666; border:1px solid #ddd;" title="‰∏çÊª°ÂΩìÂâçÁ´†ÔºüÈáçÂÜôÔºÅ">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            </button>
            ` : ''}

            <button id="gr-generate-btn" class="gr-main-btn">
                <span id="gr-gen-text">Áª≠ÂÜô</span>
                <svg id="gr-gen-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path></svg>
            </button>
        </div>
    `;

    // ÁªëÂÆö‰∫ã‰ª∂
    document.getElementById('gr-generate-btn').onclick = () => handleGenerateStoryContent(false); // false = ‰∏çÊòØÈáçÂÜô

    const rerollBtn = document.getElementById('gr-reroll-btn');
    if (rerollBtn) {
      rerollBtn.onclick = async () => {
        const confirmed = await showCustomConfirm("ÈáçÂÜôÊú¨Á´†", "Á°ÆÂÆöË¶ÅÂà†Èô§ÂΩìÂâçÊúÄÊñ∞Á´†ËäÇÂπ∂ÈáçÊñ∞ÁîüÊàêÂêóÔºü\n(Â¶ÇÊûú‰Ω†ÂàöÊâç‰øÆÊîπ‰∫ÜÊëòË¶ÅÔºåÈáçÂÜôÂêéÈúÄË¶ÅÈáçÊñ∞‰øÆÊîπ)", { confirmText: "ÈáçÂÜô", confirmButtonClass: "btn-danger" });
        if (confirmed) {
          handleGenerateStoryContent(true); // true = ÊòØÈáçÂÜô
        }
      };
    }
  }

  // ËæÖÂä©Ôºö‰øùÂ≠ò‰øÆÊîπÂêéÁöÑÊëòË¶Å
  async function saveChapterSummary(storyId, chapterIndex, newSummary) {
    const story = await db.grStories.get(storyId);
    if (story && story.chapters[chapterIndex]) {
      story.chapters[chapterIndex].summary = newSummary;
      await db.grStories.put(story);
      console.log("ÊëòË¶ÅÂ∑≤ÊâãÂä®Êõ¥Êñ∞");
    }
  }
  // 7. Ê†∏ÂøÉÁîüÊàêÈÄªËæë (The Writer) - Â≠óÊï∞Âº∫Âäõ‰øÆÊ≠£Áâà
  async function handleGenerateStoryContent(isReroll = false) {
    if (grState.isGenerating) return;

    let story = await db.grStories.get(grState.activeStoryId);

    // --- ÈáçÂÜôÈÄªËæë ---
    if (isReroll && story.chapters.length > 0) {
      story.chapters.pop();
      await db.grStories.put(story);
      openReader(story.id, Math.max(0, story.chapters.length - 1));
    }

    const author = await db.grAuthors.get(story.authorId);
    const directionInput = document.getElementById('gr-direction-input');
    const userDirection = directionInput.value.trim();

    const genBtn = document.getElementById('gr-generate-btn');
    const btnText = document.getElementById('gr-gen-text'); // Ëé∑ÂèñÊñáÂ≠óÊ†áÁ≠æ
    grState.isGenerating = true;

    if (genBtn) {
      genBtn.disabled = true;
      // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÔºöÂä†‰∫ÜÂà§Êñ≠ÔºåÂè™ÊúâÂΩìÊñáÂ≠óÊ†áÁ≠æÂ≠òÂú®Êó∂Êâç‰øÆÊîπÊñáÂ≠óÔºåÂê¶ÂàôÂè™Á¶ÅÁî®ÊåâÈíÆ
      if (btnText) btnText.textContent = "Êí∞ÂÜô‰∏≠...";
    }

    try {
      // Ëé∑ÂèñÁõÆÊ†áÂ≠óÊï∞ÔºåÂπ∂ÂÅö‰∏Ä‰∏™‚ÄúÊ∫¢‰ª∑‚ÄùÂ§ÑÁêÜ
      // Â¶ÇÊûúÁî®Êà∑ËÆæÁΩÆ 500ÔºåÊàë‰ª¨ÂëäËØâ AI ÂÜô 800ÔºåËøôÊ†∑ÂÆÉÂÅ∑ÊáíÊâìÊäòÂêéÂàöÂ•ΩÊòØ 500
      const settingValue = parseInt(story.settings.outputLength) || 500;
      const targetWordCount = Math.floor(settingValue * 1.5);

      const historyLimit = story.settings.contextLimit || 20;

      // --- ÊûÑÂª∫‰∏ä‰∏ãÊñá ---
      let charsContext = "";
      for (const id of story.settings.charIds) {
        if (id.startsWith('npc_')) {
          const npcId = parseInt(id.replace('npc_', ''));
          const npc = await db.npcs.get(npcId);
          if (npc) charsContext += `- NPC ${npc.name}: ${npc.persona}\n`;
        } else {
          const chat = state.chats[id];
          if (chat) {
            const memories = (chat.longTermMemory || [])
              .map(m => `  * ${m.content}`)
              .join('\n');

            const history = chat.history.slice(-historyLimit).map(m => {
              if (m.role === 'system' || m.type === 'red_packet' || m.type === 'waimai_request' || m.type === 'transfer') return null;
              let content = String(m.content);
              if (content.includes("Á∫¢ÂåÖ") || content.includes("ÊâãÊú∫") || content.includes("ËΩ¨Ë¥¶")) return null;
              return `  > ${m.senderName}: ${content.substring(0, 50)}`;
            }).filter(Boolean).join('\n');

            charsContext += `### ËßíËâ≤: ${chat.name}\n- **Ê†∏ÂøÉ‰∫∫ËÆæ**: ${chat.settings.aiPersona}\n`;
            if (memories) charsContext += `- **„ÄêÈáçË¶ÅÔºöÈïøÊúüËÆ∞ÂøÜ„Äë**:\n${memories}\n`;
            if (history) charsContext += `- **„ÄêËØ≠Ê∞îÂèÇËÄÉ (ÊúÄËøëËÅäÂ§©)„Äë**:\n${history}\n`;
            charsContext += `\n`;
          }
        }
      }

      let userPersonaText = "ÊôÆÈÄöÁî®Êà∑";
      if (story.settings.userPersonaId) {
        const preset = await db.personaPresets.get(story.settings.userPersonaId);
        if (preset) userPersonaText = preset.persona;
      } else if (state.chats[Object.keys(state.chats)[0]]) {
        userPersonaText = state.chats[Object.keys(state.chats)[0]].settings.myPersona;
      }

      let worldBookText = "";
      for (const bid of story.settings.bookIds) {
        const wb = await db.worldBooks.get(bid);
        if (wb) worldBookText += `- „Ää${wb.name}„ÄãËÆæÂÆö: ${wb.content.filter(e => e.enabled).map(e => e.content).join(';')}\n`;
      }

      let prevSummary = "ËøôÊòØÊïÖ‰∫ãÁöÑÂºÄÂßã„ÄÇ";
      if (story.chapters && story.chapters.length > 0) {
        const lastChapter = story.chapters[story.chapters.length - 1];
        if (lastChapter && lastChapter.summary) {
          prevSummary = lastChapter.summary;
        }
      }
      let macroContext = "";
      if (story.settings.macroWorldView) {
        macroContext = `
# „Äêüî• Ê†∏ÂøÉ‰∏ñÁïåËßÇ / IFÁ∫øËÆæÂÆö (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë
Ê≥®ÊÑèÔºöËøôÊòØ‰∏ÄÊù°IFÁ∫øÊàñÁâπÊÆäËÉåÊôØÊïÖ‰∫ã„ÄÇ**‰Ω†ÂøÖÈ°ª‰ºòÂÖàÈÅµÂæ™‰ª•‰∏ãËÆæÂÆö**ÔºåÂ¶ÇÊûú‰ª•‰∏ãËÆæÂÆö‰∏éËßíËâ≤ÁöÑÂéüÂßã‰∫∫ËÆæÊàñËÆ∞ÂøÜÂÜ≤Á™ÅÔºå**ËØ∑‰ª•‰ª•‰∏ãËÆæÂÆö‰∏∫ÂáÜÂπ∂ËøõË°åÈÄÇÈÖç**ÔºÅ
---
${story.settings.macroWorldView}
---
`;
      }
      // E. Prompt Âº∫Âäõ‰ºòÂåñ (Â≠óÊï∞Êâ©ÂÖÖ + Ê†áÈ¢òÁîüÊàê)
      const systemPrompt = `
# Ë∫´‰ªΩ
‰Ω†Áé∞Âú®ÊòØ„Äê${author.name}„Äë„ÄÇÊñáÈ£éÁâπÁÇπ: ${author.style}

# Ê†∏ÂøÉ‰ªªÂä°
Áª≠ÂÜôËøôÁØáÂ∞èËØ¥ÁöÑÊñ∞‰∏ÄÁ´†„ÄÇ
${macroContext}
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºöÂ≠óÊï∞Êâ©ÂÖÖÊåá‰ª§„Äë
‰Ω†ÂøÖÈ°ªËæìÂá∫ **${targetWordCount} Â≠ó** ‰ª•‰∏äÁöÑÂÜÖÂÆπ„ÄÇ
‰∏∫‰∫ÜËææÂà∞Ëøô‰∏™Â≠óÊï∞Ôºå‰Ω†**ÂøÖÈ°ª**ÊâßË°å‰ª•‰∏ãÊìç‰ΩúÔºö
1.  **ÊãíÁªùÊµÅÊ∞¥Ë¥¶**Ôºö‰∏çË¶ÅÂè™ÂÜô‚Äú‰ªñÂÅö‰∫Ü‰ªÄ‰πà‚ÄùÔºåË¶ÅÂÜô‚Äú‰ªñÂ¶Ç‰ΩïÂÅö„ÄÅ‰ªÄ‰πàË°®ÊÉÖ„ÄÅÂøÉÈáåÊÉ≥‰∫Ü‰ªÄ‰πà„ÄÅÂë®Âõ¥ÁéØÂ¢ÉÂ¶Ç‰Ωï‚Äù„ÄÇ
2.  **ÁªÜËäÇÊèèÂÜô**ÔºöÂ¢ûÂä†ÁéØÂ¢ÉÊèèÂÜôÔºàÂÖâÂΩ±„ÄÅÊ∞îÂë≥„ÄÅÂ£∞Èü≥Ôºâ„ÄÅÂæÆË°®ÊÉÖÊèèÂÜô„ÄÅËÇ¢‰ΩìÂä®‰ΩúÊèèÂÜô„ÄÇ
3.  **ÂøÉÁêÜÊ¥ªÂä®**ÔºöÂ§ßÂπÖÂ¢ûÂä†ËßíËâ≤ÁöÑÂÜÖÂøÉÁã¨ÁôΩÂíåÁ∫†Áªì„ÄÇ
4.  **ÊÖ¢ÈïúÂ§¥**ÔºöÂ∞ÜÂÖ≥ÈîÆÂä®‰ΩúÊãÜËß£ÔºåÊîæÊÖ¢Âèô‰∫ãËäÇÂ•è„ÄÇ

# Êï∞ÊçÆ‰ΩøÁî®ÊåáÂçó
1. **‰∏ñÁïåËßÇ**: ${worldBookText ? "ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãËÆæÂÆöÔºö" + worldBookText : "ËØ∑Ê†πÊçÆËßíËâ≤ËÆæÂÆöËá™Ë°åÂà§Êñ≠„ÄÇ"}
2. **Êó∂‰ª£ÂáÄÂåñ**: ‰∏•Á¶ÅÂá∫Áé∞‰∏çÁ¨¶Âêà‰∏ñÁïåËßÇÁöÑÁé∞‰ª£Áâ©ÂìÅ„ÄÇ
3. **ÈïøÊúüËÆ∞ÂøÜ**: ÂøÖÈ°ªÈÅµÂÆàËßíËâ≤Ê°£Ê°à‰∏≠ÁöÑËÆ∞ÂøÜ‰∫ãÂÆû„ÄÇ

# ËÆæÂÆöËµÑÊñô
- **"Êàë" (User) ÁöÑËÆæÂÆö**: ${userPersonaText}
- **ÁôªÂú∫ËßíËâ≤Ê°£Ê°à**:
${charsContext}

# ÂΩìÂâçËøõÂ∫¶
- **ÂâçÊÉÖÊèêË¶Å**: ${prevSummary}
- **Áî®Êà∑ÊåáÁ§∫**: ${userDirection || "ÔºàÊó†ÊåáÁ§∫ÔºåËØ∑È°∫ÂÖ∂Ëá™ÁÑ∂Âú∞ÂèëÂ±ïÂâßÊÉÖÔºåÈáçÁÇπÊòØÂÜôÂ§üÂ≠óÊï∞ÔºÅÔºâ"}

# ËæìÂá∫Ê†ºÂºè (JSON)
ÂõûÂ§çÂøÖÈ°ª‰∏îÂè™ËÉΩÊòØ‰∏Ä‰∏™JSONÂØπË±°Ôºö
\`\`\`json
{
  "title": "ÂõõÂ≠óÊàñÂ§öÂ≠óÊ†áÈ¢ò (Â¶ÇÔºöÊúà‰∏ãÂØπÈÖå„ÄÅÂç±Êú∫Âõõ‰ºè)",
  "content": "Ê≠£ÊñáÂÜÖÂÆπ (ÂøÖÈ°ª‰ΩøÁî®${author.style}È£éÊ†ºÔºå**Âº∫Âà∂ÂÜôÊª° ${targetWordCount} Â≠ó**ÔºåÂ§öÁî®Êç¢Ë°åÁ¨¶\\nÂ¢ûÂä†ÈòÖËØªÊÑü)",
  "summary": "Áî®ÈôàËø∞Âè•Ê¶ÇÊã¨Êú¨Á´†ÂÖ≥ÈîÆ‰∫ãÂÆûÔºàË∞Å„ÄÅÂú®Âì™Èáå„ÄÅÂÅö‰∫Ü‰ªÄ‰πàÔºâÔºå‰æõ‰∏ã‰∏ÄÁ´†ËÆ∞ÂøÜ‰ΩøÁî®„ÄÇ"
}
\`\`\`
`;

      // API Ë∞ÉÁî®
      const { proxyUrl, apiKey, model } = state.apiConfig;
      const messages = [{ role: 'user', content: `ËØ∑ÂºÄÂßãÂÜô‰ΩúÔºåËØ∑Âä°ÂøÖÂÜôÂ§ü ${targetWordCount} Â≠óÔºÅ` }];

      let response;
      if (proxyUrl.includes('generativelanguage')) {
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messages);
        response = await fetch(geminiConfig.url, geminiConfig.data);
      } else {
        response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [
              { role: 'system', content: systemPrompt },
              ...messages
            ],
            temperature: 0.9 // ÊèêÈ´òÊ∏©Â∫¶ÔºåËÆ©ÂÆÉÊõ¥Âï∞Âó¶‰∏ÄÁÇπ
          })
        });
      }

      if (!response.ok) {
        const errText = await response.text();
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥• (${response.status}): ${errText}`);
      }

      const data = await response.json();
      const aiText = getGeminiResponseText(data);

      // 1. ÊèêÂèñ JSON ÈÉ®ÂàÜ
      let jsonStr = aiText;
      const jsonMatch = aiText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        jsonStr = jsonMatch[0];
      } else {
        throw new Error("AIÊú™ËøîÂõûÊúâÊïàJSONÊ†ºÂºè");
      }

      let result;
      try {
        // 2. Â∞ùËØïÁõ¥Êé•Ëß£Êûê
        result = JSON.parse(jsonStr);
      } catch (e) {
        console.warn("JSONËß£ÊûêÂàùÊ¨°Â§±Ë¥•ÔºåÂ∞ùËØï‰øÆÂ§çËΩ¨‰πâÂ≠óÁ¨¶...", e);

        // 3. „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë: Ëá™Âä®‰øÆÂ§çÈîôËØØÁöÑËΩ¨‰πâÂ≠óÁ¨¶
        // Ê≠£ÂàôÂê´‰πâÔºöÊü•ÊâæÊâÄÊúâÂèçÊñúÊù†ÔºåÂ¶ÇÊûúÂÆÉÂêéÈù¢Ë∑üÁöÑ‰∏çÊòØ json ÂÖÅËÆ∏ÁöÑËΩ¨‰πâÁ¨¶( " \ / b f n r t u )ÔºåÂ∞±ÊääÂÆÉÊõøÊç¢‰∏∫ÂèåÂèçÊñúÊù†
        const fixedStr = jsonStr.replace(/\\([^"\\\/bfnrtu])/g, '\\\\$1');

        try {
          result = JSON.parse(fixedStr);
          console.log("JSONËá™Âä®‰øÆÂ§çÊàêÂäüÔºÅ");
        } catch (e2) {
          // Â¶ÇÊûúËøòÊòØÂ§±Ë¥•ÔºåÊäõÂá∫ÂºÇÂ∏∏
          throw new Error("JSONËß£ÊûêÂ§±Ë¥•: " + e.message);
        }
      }

      const newChapter = {
        title: result.title || `Á¨¨ ${story.chapters.length + 1} Á´†`,
        content: result.content,
        summary: result.summary,
        prevSummary: prevSummary,
        timestamp: Date.now()
      };

      // Âπ∂ÂèëÂÆâÂÖ®Ëé∑Âèñ
      story = await db.grStories.get(grState.activeStoryId);
      story.chapters.push(newChapter);
      story.lastUpdated = Date.now();
      await db.grStories.put(story);

      openReader(story.id, story.chapters.length - 1);
      document.getElementById('gr-direction-input').value = '';

    } catch (e) {
      console.error("ÁªøÊ±üÁîüÊàêÂ§±Ë¥•:", e);
      alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
      grState.isGenerating = false;
      if (genBtn) {
        genBtn.disabled = false;
        // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÔºöÂêåÊ†∑Âè™Âú®ÊñáÂ≠óÊ†áÁ≠æÂ≠òÂú®Êó∂ÊâçÊÅ¢Â§çÊñáÂ≠ó
        if (btnText) btnText.textContent = "Áª≠ÂÜô";
      }
    }
  }
  // 8. ‰æßËæπÊ†èÁõÆÂΩïÂäüËÉΩ
  // Á´†ËäÇÂà†Èô§Ê®°ÂºèÁä∂ÊÄÅ
  const chapterDeleteState = {
    isDeleteMode: false,
    selectedChapters: new Set()
  };

  function openChapterList() {
    const sidebar = document.getElementById('gr-chapter-sidebar');
    const overlay = document.getElementById('gr-sidebar-overlay');
    const listContainer = document.getElementById('gr-chapter-list-content');
    const countEl = document.getElementById('gr-total-chapters');

    if (!grState.activeStoryId) return;

    db.grStories.get(grState.activeStoryId).then(story => {
      // ÈáçÁΩÆÂà†Èô§Ê®°Âºè
      chapterDeleteState.isDeleteMode = false;
      chapterDeleteState.selectedChapters.clear();
      
      renderChapterList(story, listContainer, countEl);

      sidebar.classList.add('visible');
      overlay.classList.add('visible');
    });
  }

  function renderChapterList(story, listContainer, countEl) {
    listContainer.innerHTML = '';
    countEl.textContent = `ÂÖ± ${story.chapters.length} Á´†`;

    // Â¶ÇÊûúÊòØÂà†Èô§Ê®°ÂºèÔºåÊòæÁ§∫ÊéßÂà∂Ê†è
    if (chapterDeleteState.isDeleteMode) {
      const controlBar = document.createElement('div');
      controlBar.style.cssText = 'padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; gap: 10px;';
      
      const leftButtons = document.createElement('div');
      leftButtons.style.cssText = 'display: flex; gap: 8px; align-items: center;';
      
      // ÂÖ®ÈÄâÊåâÈíÆ
      const selectAllBtn = document.createElement('button');
      selectAllBtn.textContent = 'ÂÖ®ÈÄâ';
      selectAllBtn.style.cssText = 'padding: 5px 12px; background: #fff; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 13px;';
      selectAllBtn.onclick = () => {
        story.chapters.forEach((_, idx) => chapterDeleteState.selectedChapters.add(idx));
        renderChapterList(story, listContainer, countEl);
      };
      
      // ÂèñÊ∂àÂÖ®ÈÄâÊåâÈíÆ
      const deselectAllBtn = document.createElement('button');
      deselectAllBtn.textContent = 'ÂèñÊ∂àÂÖ®ÈÄâ';
      deselectAllBtn.style.cssText = 'padding: 5px 12px; background: #fff; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 13px;';
      deselectAllBtn.onclick = () => {
        chapterDeleteState.selectedChapters.clear();
        renderChapterList(story, listContainer, countEl);
      };
      
      // ÈÄâ‰∏≠ËÆ°Êï∞
      const countSpan = document.createElement('span');
      countSpan.style.cssText = 'font-size: 13px; color: #666;';
      countSpan.textContent = `Â∑≤ÈÄâ ${chapterDeleteState.selectedChapters.size} Á´†`;
      
      leftButtons.appendChild(selectAllBtn);
      leftButtons.appendChild(deselectAllBtn);
      leftButtons.appendChild(countSpan);
      
      const rightButtons = document.createElement('div');
      rightButtons.style.cssText = 'display: flex; gap: 8px;';
      
      // Á°ÆËÆ§Âà†Èô§ÊåâÈíÆ
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = `Âà†Èô§ (${chapterDeleteState.selectedChapters.size})`;
      deleteBtn.style.cssText = 'padding: 5px 15px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;';
      deleteBtn.disabled = chapterDeleteState.selectedChapters.size === 0;
      if (deleteBtn.disabled) {
        deleteBtn.style.background = '#ccc';
        deleteBtn.style.cursor = 'not-allowed';
      }
      deleteBtn.onclick = async () => {
        if (chapterDeleteState.selectedChapters.size === 0) return;
        
        const confirmed = await showCustomConfirm(
          'Á°ÆËÆ§Âà†Èô§',
          `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${chapterDeleteState.selectedChapters.size} ‰∏™Á´†ËäÇÂêóÔºü\nÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ`,
          { confirmText: 'Âà†Èô§', confirmButtonClass: 'btn-danger' }
        );
        
        if (confirmed) {
          await deleteSelectedChapters();
        }
      };
      
      // ÂèñÊ∂àÊåâÈíÆ
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'ÂèñÊ∂à';
      cancelBtn.style.cssText = 'padding: 5px 15px; background: #fff; color: #666; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 13px;';
      cancelBtn.onclick = () => {
        chapterDeleteState.isDeleteMode = false;
        chapterDeleteState.selectedChapters.clear();
        renderChapterList(story, listContainer, countEl);
      };
      
      rightButtons.appendChild(deleteBtn);
      rightButtons.appendChild(cancelBtn);
      
      controlBar.appendChild(leftButtons);
      controlBar.appendChild(rightButtons);
      listContainer.appendChild(controlBar);
    } else {
      // ÈùûÂà†Èô§Ê®°ÂºèÔºåÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
      const toolBar = document.createElement('div');
      toolBar.style.cssText = 'padding: 10px; background: #f9f9f9; border-bottom: 1px solid #ddd; display: flex; justify-content: flex-end;';
      
      const deleteBtn = document.createElement('button');
      deleteBtn.innerHTML = `
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
        Âà†Èô§Á´†ËäÇ
      `;
      deleteBtn.style.cssText = 'padding: 6px 12px; background: #fff; color: #666; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center;';
      deleteBtn.onclick = () => {
        chapterDeleteState.isDeleteMode = true;
        renderChapterList(story, listContainer, countEl);
      };
      
      toolBar.appendChild(deleteBtn);
      listContainer.appendChild(toolBar);
    }

    // Ê∏≤ÊüìÁ´†ËäÇÂàóË°®
    story.chapters.forEach((ch, index) => {
      const div = document.createElement('div');
      div.className = 'gr-sidebar-item';
      if (index === grState.currentChapterIndex && !chapterDeleteState.isDeleteMode) {
        div.classList.add('active');
      }

      if (chapterDeleteState.isDeleteMode) {
        const isSelected = chapterDeleteState.selectedChapters.has(index);
        
        div.style.cssText = 'display: flex; align-items: center; padding: 12px; cursor: pointer; user-select: none;';
        if (isSelected) {
          div.style.background = '#e3f2fd';
        }
        
        // Â§çÈÄâÊ°Ü
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = isSelected;
        checkbox.style.cssText = 'width: 18px; height: 18px; margin-right: 12px; cursor: pointer;';
        checkbox.onclick = (e) => {
          e.stopPropagation();
        };
        
        div.onclick = () => {
          if (chapterDeleteState.selectedChapters.has(index)) {
            chapterDeleteState.selectedChapters.delete(index);
          } else {
            chapterDeleteState.selectedChapters.add(index);
          }
          renderChapterList(story, listContainer, countEl);
        };
        
        const content = document.createElement('div');
        content.style.cssText = 'flex: 1;';
        content.innerHTML = `
          <div style="display:flex; justify-content:space-between;">
            <span>${index + 1}. ${ch.title || 'Êó†È¢ò'}</span>
            <span style="font-size:12px; color:#999;">${new Date(ch.timestamp).toLocaleTimeString()}</span>
          </div>
          <div style="font-size:12px; color:#999; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${(ch.summary || '').substring(0, 30)}...</div>
        `;
        
        div.appendChild(checkbox);
        div.appendChild(content);
      } else {
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between;">
            <span>${index + 1}. ${ch.title || 'Êó†È¢ò'}</span>
            <span style="font-size:12px; color:#999;">${new Date(ch.timestamp).toLocaleTimeString()}</span>
          </div>
          <div style="font-size:12px; color:#999; margin-left:10px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${(ch.summary || '').substring(0, 20)}...</div>
        `;

        div.onclick = () => {
          openReader(story.id, index);
          closeChapterList();
        };
      }
      
      listContainer.appendChild(div);
    });
  }

  async function deleteSelectedChapters() {
    if (!grState.activeStoryId) return;
    
    const story = await db.grStories.get(grState.activeStoryId);
    if (!story) return;
    
    // Â∞ÜÈÄâ‰∏≠ÁöÑÁ¥¢ÂºïËΩ¨‰∏∫Êï∞ÁªÑÂπ∂ÊéíÂ∫èÔºà‰ªéÂ§ßÂà∞Â∞èÔºåÈÅøÂÖçÂà†Èô§Êó∂Á¥¢ÂºïÂèòÂåñÔºâ
    const indicesToDelete = Array.from(chapterDeleteState.selectedChapters).sort((a, b) => b - a);
    
    console.log('[Á´†ËäÇÂà†Èô§] ÂáÜÂ§áÂà†Èô§Á´†ËäÇ:', indicesToDelete);
    
    // Âà†Èô§Á´†ËäÇ
    indicesToDelete.forEach(index => {
      story.chapters.splice(index, 1);
    });
    
    story.lastUpdated = Date.now();
    await db.grStories.put(story);
    
    console.log(`[Á´†ËäÇÂà†Èô§] ÊàêÂäüÂà†Èô§ ${indicesToDelete.length} ‰∏™Á´†ËäÇ`);
    
    // ÈáçÁΩÆÁä∂ÊÄÅ
    chapterDeleteState.isDeleteMode = false;
    chapterDeleteState.selectedChapters.clear();
    
    // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
    const listContainer = document.getElementById('gr-chapter-list-content');
    const countEl = document.getElementById('gr-total-chapters');
    renderChapterList(story, listContainer, countEl);
    
    // Â¶ÇÊûúÂΩìÂâçÈòÖËØªÁöÑÁ´†ËäÇË¢´Âà†Èô§‰∫ÜÔºåË∑≥ËΩ¨Âà∞ÊúÄÂêé‰∏ÄÁ´†
    if (indicesToDelete.includes(grState.currentChapterIndex)) {
      const newIndex = Math.max(0, story.chapters.length - 1);
      if (story.chapters.length > 0) {
        openReader(story.id, newIndex);
      } else {
        // Â¶ÇÊûúÊâÄÊúâÁ´†ËäÇÈÉΩË¢´Âà†Èô§‰∫ÜÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ
        document.getElementById('gr-reader-content').innerHTML = `
          <div style="text-align: center; padding: 50px; color: #999;">
            <p>ÊöÇÊó†Á´†ËäÇ</p>
            <p style="font-size: 14px; margin-top: 10px;">ÁÇπÂáª‰∏ãÊñπ"Áª≠ÂÜô"ÊåâÈíÆÂºÄÂßãÂàõ‰Ωú</p>
          </div>
        `;
      }
    } else {
      // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÁ´†ËäÇÔºàÁ¥¢ÂºïÂèØËÉΩÂèëÁîüÂèòÂåñÔºâ
      const deletedBefore = indicesToDelete.filter(i => i < grState.currentChapterIndex).length;
      const newIndex = grState.currentChapterIndex - deletedBefore;
      openReader(story.id, newIndex);
    }
    
    alert(`ÊàêÂäüÂà†Èô§ ${indicesToDelete.length} ‰∏™Á´†ËäÇ`);
  }

  function closeChapterList() {
    document.getElementById('gr-chapter-sidebar').classList.remove('visible');
    document.getElementById('gr-sidebar-overlay').classList.remove('visible');
  }
  // Êö¥Èú≤Áªô HTML onclick
  window.openChapterList = openChapterList;
  window.closeChapterList = closeChapterList;
  // ==========================================
  // ‚ñº‚ñº‚ñº ‰ΩúËÄÖËøΩÊõ¥ÂäüËÉΩ ‚ñº‚ñº‚ñº
  // ==========================================

  // ËÆ°ÁÆó‰∏ãÊ¨°Êõ¥Êñ∞Êó∂Èó¥
  function calculateNextUpdateTime(autoUpdate) {
    if (!autoUpdate || !autoUpdate.enabled || autoUpdate.frequency === 'manual') {
      return null;
    }

    const now = new Date();
    let nextUpdate = new Date();

    switch (autoUpdate.frequency) {
      case 'daily':
        // ÊØèÂ§©ÊåáÂÆöÂ∞èÊó∂Êõ¥Êñ∞
        const dailyHour = autoUpdate.dailyHour || 12;
        nextUpdate.setHours(dailyHour, 0, 0, 0);
        
        // Â¶ÇÊûú‰ªäÂ§©ÁöÑÊõ¥Êñ∞Êó∂Èó¥Â∑≤ËøáÔºåËÆæÁΩÆ‰∏∫ÊòéÂ§©
        if (nextUpdate <= now) {
          nextUpdate.setDate(nextUpdate.getDate() + 1);
        }
        
        // Â¶ÇÊûúÂ∑≤ÁªèÂú®‰ªäÂ§©Êõ¥Êñ∞ËøáÔºå‰∏ãÊ¨°Êõ¥Êñ∞ÊòØÊòéÂ§©
        if (autoUpdate.lastUpdate) {
          const lastUpdate = new Date(autoUpdate.lastUpdate);
          if (lastUpdate.toDateString() === now.toDateString()) {
            nextUpdate.setDate(nextUpdate.getDate() + 1);
            nextUpdate.setHours(dailyHour, 0, 0, 0);
          }
        }
        break;

      case 'weekly':
        // ÊØèÂë®ÊåáÂÆöÊòüÊúüÂíåÂ∞èÊó∂Êõ¥Êñ∞
        const weeklyDay = autoUpdate.weeklyDay || 1; // 0=Âë®Êó•, 1=Âë®‰∏Ä, ...
        const weeklyHour = autoUpdate.weeklyHour || 12;
        
        nextUpdate.setHours(weeklyHour, 0, 0, 0);
        
        // ËÆ°ÁÆóË∑ùÁ¶ª‰∏ã‰∏Ä‰∏™ÊåáÂÆöÊòüÊúüÂá†ÁöÑÂ§©Êï∞
        const currentDay = now.getDay();
        let daysUntilNext = weeklyDay - currentDay;
        if (daysUntilNext < 0 || (daysUntilNext === 0 && nextUpdate <= now)) {
          daysUntilNext += 7;
        }
        
        nextUpdate.setDate(nextUpdate.getDate() + daysUntilNext);
        
        // Â¶ÇÊûúÊú¨Âë®Â∑≤ÁªèÊõ¥Êñ∞ËøáÔºå‰∏ãÊ¨°Êõ¥Êñ∞ÊòØ‰∏ãÂë®
        if (autoUpdate.lastUpdate) {
          const lastUpdate = new Date(autoUpdate.lastUpdate);
          const lastWeekStart = new Date(lastUpdate);
          lastWeekStart.setDate(lastUpdate.getDate() - lastUpdate.getDay());
          const currentWeekStart = new Date(now);
          currentWeekStart.setDate(now.getDate() - now.getDay());
          
          if (lastWeekStart.getTime() === currentWeekStart.getTime()) {
            nextUpdate.setDate(nextUpdate.getDate() + 7);
          }
        }
        break;

      case 'custom':
        // Ëá™ÂÆö‰πâÈó¥ÈöîÔºàÂ∞èÊó∂Ôºâ
        const customHours = autoUpdate.customHours || 24;
        if (autoUpdate.lastUpdate) {
          nextUpdate = new Date(autoUpdate.lastUpdate);
          nextUpdate.setHours(nextUpdate.getHours() + customHours);
        } else {
          nextUpdate.setHours(nextUpdate.getHours() + customHours);
        }
        break;

      default:
        return null;
    }

    return nextUpdate;
  }

  // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅËá™Âä®Êõ¥Êñ∞
  async function checkAutoUpdate(story) {
    if (!story.settings.autoUpdate || !story.settings.autoUpdate.enabled) {
      return false;
    }

    const autoUpdate = story.settings.autoUpdate;

    // Â¶ÇÊûúÈ¢ëÁéáËÆæÁΩÆ‰∏∫ÊâãÂä®Ôºå‰∏çËá™Âä®Êõ¥Êñ∞
    if (autoUpdate.frequency === 'manual') {
      return false;
    }

    const now = new Date();

    // Â¶ÇÊûú‰ªéÊú™Êõ¥Êñ∞ËøáÔºåÊ†πÊçÆÈ¢ëÁéáÂÜ≥ÂÆöÊòØÂê¶Á´ãÂç≥Êõ¥Êñ∞
    if (!autoUpdate.lastUpdate) {
      if (autoUpdate.frequency === 'daily') {
        // ÊØèÂ§©Ê®°ÂºèÔºöÊ£ÄÊü•ÂΩìÂâçÊó∂Èó¥ÊòØÂê¶Â∑≤Âà∞ËææËÆæÂÆöÁöÑÊõ¥Êñ∞Â∞èÊó∂
        const dailyHour = autoUpdate.dailyHour || 12;
        return now.getHours() >= dailyHour;
      } else if (autoUpdate.frequency === 'weekly') {
        // ÊØèÂë®Ê®°ÂºèÔºöÊ£ÄÊü•ÊòØÂê¶ÊòØÊåáÂÆöÁöÑÊòüÊúüÂá†ÂíåÊó∂Èó¥
        const weeklyDay = autoUpdate.weeklyDay || 1;
        const weeklyHour = autoUpdate.weeklyHour || 12;
        return now.getDay() === weeklyDay && now.getHours() >= weeklyHour;
      } else {
        // Ëá™ÂÆö‰πâÈó¥ÈöîÔºöÁ´ãÂç≥Êõ¥Êñ∞
        return true;
      }
    }

    const lastUpdate = new Date(autoUpdate.lastUpdate);

    switch (autoUpdate.frequency) {
      case 'daily':
        // ÊØèÂ§©ÊåáÂÆöÂ∞èÊó∂Êõ¥Êñ∞ÔºöÊ£ÄÊü•ÊòØÂê¶Â∑≤Ëøá‰∫Ü‰∏äÊ¨°Êõ¥Êñ∞ÁöÑÊó•ÊúüÔºå‰∏îÂΩìÂâçÊó∂Èó¥Â∑≤Âà∞ËææËÆæÂÆöÂ∞èÊó∂
        const dailyHour = autoUpdate.dailyHour || 12;
        const isSameDay = lastUpdate.toDateString() === now.toDateString();
        const isPastUpdateHour = now.getHours() >= dailyHour;
        
        // Â¶ÇÊûú‰∏çÊòØÂêå‰∏ÄÂ§©Ôºå‰∏îÂΩìÂâçÊó∂Èó¥Â∑≤Âà∞ËææËÆæÂÆöÂ∞èÊó∂ÔºåÂàôÈúÄË¶ÅÊõ¥Êñ∞
        return !isSameDay && isPastUpdateHour;

      case 'weekly':
        // ÊØèÂë®ÊåáÂÆöÊòüÊúüÂíåÂ∞èÊó∂Êõ¥Êñ∞
        const weeklyDay = autoUpdate.weeklyDay || 1;
        const weeklyHour = autoUpdate.weeklyHour || 12;
        
        // Ê£ÄÊü•ÊòØÂê¶ÊòØÊåáÂÆöÁöÑÊòüÊúüÂá†
        if (now.getDay() !== weeklyDay) {
          return false;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Âà∞ËææÊåáÂÆöÂ∞èÊó∂
        if (now.getHours() < weeklyHour) {
          return false;
        }
        
        // Ê£ÄÊü•Êú¨Âë®ÊòØÂê¶Â∑≤ÁªèÊõ¥Êñ∞Ëøá
        const lastWeekStart = new Date(lastUpdate);
        lastWeekStart.setDate(lastUpdate.getDate() - lastUpdate.getDay());
        lastWeekStart.setHours(0, 0, 0, 0);
        
        const currentWeekStart = new Date(now);
        currentWeekStart.setDate(now.getDate() - now.getDay());
        currentWeekStart.setHours(0, 0, 0, 0);
        
        // Â¶ÇÊûúÊú¨Âë®ËøòÊ≤°Êõ¥Êñ∞ËøáÔºåÂàôÈúÄË¶ÅÊõ¥Êñ∞
        return lastWeekStart.getTime() < currentWeekStart.getTime();

      case 'custom':
        // Ëá™ÂÆö‰πâÈó¥ÈöîÔºàÂ∞èÊó∂Ôºâ
        const customHours = autoUpdate.customHours || 24;
        const intervalMs = customHours * 60 * 60 * 1000;
        const timeSinceLastUpdate = now.getTime() - lastUpdate.getTime();
        return timeSinceLastUpdate >= intervalMs;

      default:
        return false;
    }
  }

  // Ëá™Âä®ÁîüÊàêÊñ∞Á´†ËäÇ
  async function autoGenerateChapter(storyId) {
    try {
      console.log(`[‰ΩúËÄÖËøΩÊõ¥] ÂºÄÂßã‰∏∫‰ΩúÂìÅ ${storyId} ÁîüÊàêÊñ∞Á´†ËäÇ`);

      const story = await db.grStories.get(storyId);
      if (!story) {
        console.error(`[‰ΩúËÄÖËøΩÊõ¥] ‰ΩúÂìÅ ${storyId} ‰∏çÂ≠òÂú®`);
        return false;
      }

      const autoUpdate = story.settings.autoUpdate;
      if (!autoUpdate || !autoUpdate.enabled) {
        return false;
      }

      // Ëé∑Âèñ‰ΩúËÄÖ‰ø°ÊÅØ
      const author = await db.grAuthors.get(story.authorId);
      if (!author) {
        console.error(`[‰ΩúËÄÖËøΩÊõ¥] ‰ΩúËÄÖ ${story.authorId} ‰∏çÂ≠òÂú®`);
        return false;
      }

      // ÊûÑÂª∫ÁîüÊàêÊèêÁ§∫ËØç
      const settingValue = parseInt(story.settings.outputLength) || 500;
      const targetWordCount = Math.floor(settingValue * 1.5);
      const historyLimit = story.settings.contextLimit || 20;

      // Ëé∑ÂèñËßíËâ≤‰ø°ÊÅØ
      let charsContext = "";
      for (const charId of story.settings.charIds) {
        if (charId.startsWith('npc_')) {
          const npcId = parseInt(charId.replace('npc_', ''));
          const npc = await db.npcs.get(npcId);
          if (npc) {
            charsContext += `[NPC] ${npc.name}: ${npc.description || ''}\n`;
          }
        } else {
          const char = state.chats[charId];
          if (char) {
            charsContext += `${char.name}: ${char.firstMessage || char.description || ''}\n`;
          }
        }
      }

      // Ëé∑Âèñ‰∏ñÁïå‰π¶‰ø°ÊÅØ
      let worldBookContext = "";
      for (const bookId of story.settings.bookIds) {
        const book = await db.worldBooks.get(bookId);
        if (book) {
          worldBookContext += `\n[${book.name}]\n`;
          if (Array.isArray(book.content)) {
            book.content.forEach(entry => {
              if (typeof entry === 'object' && entry.content) {
                worldBookContext += `${entry.content}\n`;
              } else if (typeof entry === 'string') {
                worldBookContext += `${entry}\n`;
              }
            });
          } else if (typeof book.content === 'string') {
            worldBookContext += book.content;
          }
        }
      }

      // Ëé∑ÂèñÂéÜÂè≤Á´†ËäÇ
      const recentChapters = story.chapters.slice(-historyLimit);
      let chaptersText = "";
      recentChapters.forEach((ch, idx) => {
        const chTitle = ch.title || `Á¨¨ ${idx + 1} Á´†`;
        chaptersText += `\n\n[${chTitle}]\nÊëòË¶Å: ${ch.summary || 'Êó†'}\nÊ≠£Êñá:\n${ch.content}`;
      });

      // Ê†πÊçÆËøΩÊõ¥ÊñπÂºèÊûÑÂª∫ÁâπÊÆäÊèêÁ§∫ËØç
      let updatePrompt = "";
      if (autoUpdate.type === 'character') {
        // ‰ΩøÁî®ËßíËâ≤ËßÜËßí
        const charId = autoUpdate.characterId;
        let charName = "Êú™Áü•ËßíËâ≤";
        if (charId && charId.startsWith('npc_')) {
          const npcId = parseInt(charId.replace('npc_', ''));
          const npc = await db.npcs.get(npcId);
          if (npc) charName = npc.name;
        } else if (charId) {
          const char = state.chats[charId];
          if (char) charName = char.name;
        }
        updatePrompt = `\n\n„ÄêÁâπÂà´ËØ¥Êòé„ÄëÊú¨Ê¨°Êõ¥Êñ∞ËØ∑‰ª• ${charName} ÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíËøõË°åÂèôËø∞ÔºåÂ±ïÁé∞${charName}ÁöÑÂÜÖÂøÉÊ¥ªÂä®ÂíåÊâÄËßÅÊâÄÈóª„ÄÇ`;
      } else if (autoUpdate.type === 'author') {
        // ‰ΩøÁî®ÊåáÂÆö‰ΩúËÄÖÊñáÈ£é
        // ‰øÆÂ§çÔºöÊ£ÄÊü• authorId ÊòØÂê¶ÊúâÊïà
        if (autoUpdate.authorId && !isNaN(autoUpdate.authorId)) {
          const updateAuthor = await db.grAuthors.get(autoUpdate.authorId);
          if (updateAuthor) {
            updatePrompt = `\n\n„ÄêÁâπÂà´ËØ¥Êòé„ÄëÊú¨Ê¨°Êõ¥Êñ∞ËØ∑‰∏•Ê†ºÊ®°‰ªø„Äê${updateAuthor.name}„ÄëÁöÑÊñáÈ£éÔºö${updateAuthor.style}`;
          } else {
            console.warn('[‰ΩúËÄÖËøΩÊõ¥] Êú™ÊâæÂà∞ÊåáÂÆöÁöÑËøΩÊõ¥‰ΩúËÄÖÔºåÂ∞Ü‰ΩøÁî®‰ΩúÂìÅÂéü‰ΩúËÄÖÊñáÈ£é');
          }
        } else {
          console.warn('[‰ΩúËÄÖËøΩÊõ¥] ËøΩÊõ¥‰ΩúËÄÖIDÊó†ÊïàÔºåÂ∞Ü‰ΩøÁî®‰ΩúÂìÅÂéü‰ΩúËÄÖÊñáÈ£é');
        }
      }

      // ÊûÑÂª∫ÂÆåÊï¥ÊèêÁ§∫ËØç
      const fullPrompt = `‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÂ∞èËØ¥Áª≠ÂÜôAI„ÄÇËØ∑Ê†πÊçÆ‰ª•‰∏ã‰ø°ÊÅØÔºåÁª≠ÂÜô‰∏ã‰∏ÄÁ´†ËäÇÂÜÖÂÆπ„ÄÇ

„ÄêÂü∫Á°ÄËÆæÂÆö„Äë
${story.settings.macroWorldView || 'Êó†ÁâπÊÆäËÆæÂÆö'}

„ÄêËßíËâ≤‰ø°ÊÅØ„Äë
${charsContext}

${worldBookContext}

„ÄêÂ∑≤ÊúâÁ´†ËäÇ„ÄëÔºà‰Ωú‰∏∫‰∏ä‰∏ãÊñáÂèÇËÄÉÔºâ${chaptersText}

„Äê‰ΩúËÄÖÊñáÈ£é„Äë
${author.style}

${updatePrompt}

„ÄêÁª≠ÂÜôË¶ÅÊ±Ç„Äë
1. ËøôÊòØËá™Âä®ËøΩÊõ¥ÂäüËÉΩÁîüÊàêÁöÑÊñ∞Á´†ËäÇÔºåËØ∑Ëá™ÁÑ∂Âú∞Êé®ËøõÂâßÊÉÖÂèëÂ±ï
2. Â≠óÊï∞Ë¶ÅÊ±ÇÔºöÁ∫¶ ${targetWordCount} Â≠ó
3. ‰øùÊåÅ‰∏éÂâçÊñáÁöÑËøûË¥ØÊÄß
4. Á¨¶ÂêàËßíËâ≤ÊÄßÊ†ºÂíå‰∏ñÁïåËßÇËÆæÂÆö
5. ËØ∑ËæìÂá∫: Ê†áÈ¢òÔºà‰∏ÄË°åÔºâ„ÄÅÊëòË¶ÅÔºà‰∏ÄÂ∞èÊÆµÔºâ„ÄÅÊ≠£ÊñáÔºàÂÆåÊï¥Á´†ËäÇÂÜÖÂÆπÔºâ

Ê†ºÂºèÁ§∫‰æãÔºö
Ê†áÈ¢ò: Á¨¨XÁ´† XXX
ÊëòË¶Å: XXXÔºàÁÆÄË¶ÅÊ¶ÇÊã¨Êú¨Á´†ÂÜÖÂÆπÔºå50Â≠ó‰ª•ÂÜÖÔºâ
Ê≠£Êñá:
ÔºàËøôÈáåÊòØÁ´†ËäÇÊ≠£ÊñáÂÜÖÂÆπÔºâ

Áé∞Âú®ÂºÄÂßãÁª≠ÂÜôÔºö`;

      // Ë∞ÉÁî®AIÁîüÊàê
      const apiConfig = await db.apiConfig.get('main');
      if (!apiConfig || !apiConfig.proxyUrl || !apiConfig.apiKey) {
        console.error('[‰ΩúËÄÖËøΩÊõ¥] APIÈÖçÁΩÆ‰∏çÂÆåÊï¥');
        alert('‰ΩúËÄÖËøΩÊõ¥Â§±Ë¥•ÔºöAPIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåËØ∑ÂÖàÈÖçÁΩÆAPI');
        return false;
      }

      const isGemini = apiConfig.proxyUrl.includes('generativelanguage');
      let response;

      if (isGemini) {
        const payload = {
          contents: [{
            parts: [{
              text: fullPrompt
            }]
          }],
          generationConfig: {
            maxOutputTokens: Math.min(8192, targetWordCount * 3), // GeminiÊîØÊåÅÊõ¥Â§ßÁöÑËæìÂá∫
            temperature: 0.8
          }
        };

        response = await fetch(`${apiConfig.proxyUrl}/${apiConfig.model}:generateContent?key=${apiConfig.apiKey}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
      } else {
        const payload = {
          model: apiConfig.model,
          messages: [{
            role: 'user',
            content: fullPrompt
          }],
          temperature: 0.8,
          max_tokens: Math.min(4096, targetWordCount * 3) // Â¢ûÂä†max_tokensÔºåËá≥Â∞ë3ÂÄçÁõÆÊ†áÂ≠óÊï∞
        };

        response = await fetch(`${apiConfig.proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiConfig.apiKey}`
          },
          body: JSON.stringify(payload)
        });
      }

      if (!response.ok) {
        const errorText = await response.text();
        console.error('[‰ΩúËÄÖËøΩÊõ¥] APIËØ∑Ê±ÇÂ§±Ë¥•:', response.status, response.statusText);
        console.error('[‰ΩúËÄÖËøΩÊõ¥] ÈîôËØØËØ¶ÊÉÖ:', errorText);
        alert(`‰ΩúËÄÖËøΩÊõ¥Â§±Ë¥•ÔºöAPIËØ∑Ê±ÇÈîôËØØ (${response.status})\n${errorText.substring(0, 200)}`);
        return false;
      }

      const data = await response.json();
      console.log('[‰ΩúËÄÖËøΩÊõ¥] APIÂìçÂ∫îÊï∞ÊçÆ:', data);
      let aiOutput = '';

      if (isGemini) {
        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
          aiOutput = data.candidates[0].content.parts.map(p => p.text).join('');
        } else {
          console.error('[‰ΩúËÄÖËøΩÊõ¥] GeminiÂìçÂ∫îÊ†ºÂºèÂºÇÂ∏∏:', JSON.stringify(data));
        }
      } else {
        if (data.choices && data.choices[0] && data.choices[0].message) {
          aiOutput = data.choices[0].message.content;
          // Ê£ÄÊü•ÊòØÂê¶Âõ†‰∏∫ÈïøÂ∫¶ÈôêÂà∂ËÄåÊà™Êñ≠
          const finishReason = data.choices[0].finish_reason;
          if (finishReason === 'length') {
            console.warn('[‰ΩúËÄÖËøΩÊõ¥] AIËæìÂá∫Âõ†tokenÈôêÂà∂Ë¢´Êà™Êñ≠ÔºåÂ∞ùËØï‰ΩøÁî®Êà™Êñ≠ÁöÑÂÜÖÂÆπ');
            if (!aiOutput || aiOutput.length < 100) {
              console.error('[‰ΩúËÄÖËøΩÊõ¥] Êà™Êñ≠ÁöÑÂÜÖÂÆπËøáÁü≠ÔºåÊó†Ê≥ï‰ΩøÁî®');
              alert('‰ΩúËÄÖËøΩÊõ¥Â§±Ë¥•ÔºöAIËæìÂá∫Ë∂ÖËøátokenÈôêÂà∂‰∏îÂÜÖÂÆπËøáÁü≠„ÄÇ\nÂª∫ËÆÆÔºö\n1. ÂáèÂ∞ë"‰∏ä‰∏ãÊñáÂºïÁî®Êù°Êï∞"\n2. ÂáèÂ∞ë"Â≠óÊï∞ËÆæÁΩÆ"\n3. ÂáèÂ∞ëÈÄâÊã©ÁöÑËßíËâ≤Âíå‰∏ñÁïå‰π¶Êï∞Èáè');
              return false;
            }
          }
        } else {
          console.error('[‰ΩúËÄÖËøΩÊõ¥] OpenAIÂìçÂ∫îÊ†ºÂºèÂºÇÂ∏∏:', JSON.stringify(data));
        }
      }

      if (!aiOutput) {
        console.error('[‰ΩúËÄÖËøΩÊõ¥] AIËøîÂõûÂÜÖÂÆπ‰∏∫Á©∫ÔºåÂÆåÊï¥ÂìçÂ∫î:', JSON.stringify(data));
        alert('‰ΩúËÄÖËøΩÊõ¥Â§±Ë¥•ÔºöAIËøîÂõûÁöÑÂÜÖÂÆπ‰∏∫Á©∫„ÄÇ\nÂèØËÉΩÂéüÂõ†Ôºö\n1. ËæìÂÖ•ÂÜÖÂÆπËøáÈïøË∂ÖËøáÊ®°ÂûãÈôêÂà∂\n2. APIÈÖçÁΩÆÈîôËØØ\nËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞Êó•ÂøóËé∑ÂèñËØ¶ÁªÜ‰ø°ÊÅØ');
        return false;
      }

      console.log('[‰ΩúËÄÖËøΩÊõ¥] AIÁîüÊàêÂÜÖÂÆπ:', aiOutput);

      // Ëß£ÊûêAIËæìÂá∫
      console.log('[‰ΩúËÄÖËøΩÊõ¥] ÂºÄÂßãËß£ÊûêAIËæìÂá∫...');
      const lines = aiOutput.split('\n');
      let newTitle = `Á¨¨ ${story.chapters.length + 1} Á´†`;
      let newSummary = '';
      let newContent = '';

      let currentSection = '';
      let hasFoundTitle = false;
      let hasFoundSummary = false;
      let hasFoundContent = false;
      
      for (let line of lines) {
        const trimmedLine = line.trim(); // ÂéªÈô§ÂâçÂêéÁ©∫ÁôΩ
        
        if (!hasFoundTitle && (trimmedLine.startsWith('Ê†áÈ¢ò:') || trimmedLine.startsWith('Ê†áÈ¢òÔºö') || trimmedLine.startsWith('# '))) {
          newTitle = trimmedLine.replace(/^(Ê†áÈ¢ò[:Ôºö]|#)\s*/, '').trim();
          currentSection = 'title';
          hasFoundTitle = true;
          console.log('[‰ΩúËÄÖËøΩÊõ¥] ÊâæÂà∞Ê†áÈ¢ò:', newTitle);
        } else if (!hasFoundSummary && (trimmedLine.startsWith('ÊëòË¶Å:') || trimmedLine.startsWith('ÊëòË¶ÅÔºö'))) {
          newSummary = trimmedLine.replace(/^ÊëòË¶Å[:Ôºö]\s*/, '').trim();
          currentSection = 'summary';
          hasFoundSummary = true;
          console.log('[‰ΩúËÄÖËøΩÊõ¥] ÊâæÂà∞ÊëòË¶Å:', newSummary);
        } else if (!hasFoundContent && (trimmedLine.startsWith('Ê≠£Êñá:') || trimmedLine.startsWith('Ê≠£ÊñáÔºö'))) {
          currentSection = 'content';
          hasFoundContent = true;
          console.log('[‰ΩúËÄÖËøΩÊõ¥] ÊâæÂà∞Ê≠£ÊñáÊ†áËÆ∞');
        } else if (currentSection === 'content' && line) {
          newContent += line + '\n';
        } else if (currentSection === 'summary' && trimmedLine && !trimmedLine.startsWith('Ê≠£Êñá')) {
          newSummary += ' ' + trimmedLine;
        }
      }

      // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Ê†áÂáÜÊ†ºÂºèÔºåÂ∞ùËØïÁõ¥Êé•‰ΩøÁî®Êï¥‰∏™ËæìÂá∫‰Ωú‰∏∫Ê≠£Êñá
      if (!hasFoundContent && aiOutput.length > 50) {
        console.warn('[‰ΩúËÄÖËøΩÊõ¥] Êú™ÊâæÂà∞Ê†áÂáÜÊ†ºÂºèÊ†áËÆ∞ÔºåÂ∞ùËØïÂ∞ÜÊï¥‰∏™ËæìÂá∫‰Ωú‰∏∫Ê≠£Êñá');
        newContent = aiOutput;
        // Â∞ùËØï‰ªéÂºÄÂ§¥ÊèêÂèñÊ†áÈ¢òÔºàÂ¶ÇÊûúÁ¨¨‰∏ÄË°åÂæàÁü≠Ôºâ
        const firstLine = lines[0]?.trim();
        if (firstLine && firstLine.length < 30 && firstLine.length > 0) {
          newTitle = firstLine;
          newContent = lines.slice(1).join('\n');
        }
      }

      newContent = newContent.trim();
      newSummary = newSummary.trim();

      console.log('[‰ΩúËÄÖËøΩÊõ¥] Ëß£ÊûêÁªìÊûú - Ê†áÈ¢ò:', newTitle);
      console.log('[‰ΩúËÄÖËøΩÊõ¥] Ëß£ÊûêÁªìÊûú - ÊëòË¶ÅÈïøÂ∫¶:', newSummary.length);
      console.log('[‰ΩúËÄÖËøΩÊõ¥] Ëß£ÊûêÁªìÊûú - Ê≠£ÊñáÈïøÂ∫¶:', newContent.length);

      if (!newContent || newContent.length < 50) {
        console.error('[‰ΩúËÄÖËøΩÊõ¥] Ëß£ÊûêÂÜÖÂÆπÂ§±Ë¥•ÊàñÂÜÖÂÆπËøáÁü≠');
        console.error('[‰ΩúËÄÖËøΩÊõ¥] AIÂéüÂßãËæìÂá∫:', aiOutput);
        alert('‰ΩúËÄÖËøΩÊõ¥ÁîüÊàêÂ§±Ë¥•ÔºöAIËøîÂõûÁöÑÂÜÖÂÆπÊó†Ê≥ïËß£ÊûêÊàñËøáÁü≠ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞Êó•Âøó');
        return false;
      }

      // Ê∑ªÂä†Êñ∞Á´†ËäÇ
      story.chapters.push({
        title: newTitle,
        content: newContent,
        summary: newSummary,
        createdAt: Date.now(),
        autoGenerated: true // Ê†áËÆ∞‰∏∫Ëá™Âä®ÁîüÊàê
      });

      // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
      story.settings.autoUpdate.lastUpdate = Date.now();
      story.lastUpdated = Date.now();

      await db.grStories.put(story);

      console.log(`[‰ΩúËÄÖËøΩÊõ¥] ÊàêÂäü‰∏∫‰ΩúÂìÅ„Ää${story.title}„ÄãÁîüÊàêÊñ∞Á´†ËäÇ: ${newTitle}`);
      return true;

    } catch (error) {
      console.error('[‰ΩúËÄÖËøΩÊõ¥] ÁîüÊàêÂ§±Ë¥•:', error);
      console.error('[‰ΩúËÄÖËøΩÊõ¥] ÈîôËØØÂ†ÜÊ†à:', error.stack);
      // ÂêëÁî®Êà∑ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
      if (typeof alert !== 'undefined') {
        alert(`‰ΩúËÄÖËøΩÊõ¥ÁîüÊàêÂ§±Ë¥•Ôºö${error.message}\nËØ∑Êü•ÁúãÊéßÂà∂Âè∞‰∫ÜËß£ËØ¶ÁªÜ‰ø°ÊÅØ`);
      }
      return false;
    }
  }

  // Ê£ÄÊü•ÊâÄÊúâ‰ΩúÂìÅÁöÑËøΩÊõ¥Áä∂ÊÄÅ
  async function checkAllStoriesForAutoUpdate() {
    try {
      const stories = await db.grStories.toArray();

      for (const story of stories) {
        if (await checkAutoUpdate(story)) {
          console.log(`[‰ΩúËÄÖËøΩÊõ¥] ‰ΩúÂìÅ„Ää${story.title}„ÄãÈúÄË¶ÅÊõ¥Êñ∞`);
          await autoGenerateChapter(story.id);
          // Ê∑ªÂä†Âª∂ËøüÔºåÈÅøÂÖçÂêåÊó∂ÂèëÈÄÅÂ§™Â§öËØ∑Ê±Ç
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      }
    } catch (error) {
      console.error('[‰ΩúËÄÖËøΩÊõ¥] Ê£ÄÊü•Êõ¥Êñ∞Â§±Ë¥•:', error);
    }
  }

  // ÂêØÂä®ËøΩÊõ¥ÂÆöÊó∂Âô®ÔºàÊØèÂ∞èÊó∂Ê£ÄÊü•‰∏ÄÊ¨°Ôºâ
  let autoUpdateTimer = null;

  function startAutoUpdateTimer() {
    if (autoUpdateTimer) {
      clearInterval(autoUpdateTimer);
    }

    // ÊØèÂ∞èÊó∂Ê£ÄÊü•‰∏ÄÊ¨°
    autoUpdateTimer = setInterval(() => {
      const now = new Date();
      console.log(`[‰ΩúËÄÖËøΩÊõ¥] ÂÆöÊó∂Ê£ÄÊü•ÂºÄÂßã... ÂΩìÂâçÊó∂Èó¥: ${now.toLocaleString('zh-CN')}`);
      checkAllStoriesForAutoUpdate();
    }, 60 * 60 * 1000); // 1Â∞èÊó∂

    console.log('[‰ΩúËÄÖËøΩÊõ¥] ÂÆöÊó∂Âô®Â∑≤ÂêØÂä®ÔºåÊØèÂ∞èÊó∂Ê£ÄÊü•‰∏ÄÊ¨°');
  }

  // ÂÅúÊ≠¢ËøΩÊõ¥ÂÆöÊó∂Âô®
  function stopAutoUpdateTimer() {
    if (autoUpdateTimer) {
      clearInterval(autoUpdateTimer);
      autoUpdateTimer = null;
      console.log('[‰ΩúËÄÖËøΩÊõ¥] ÂÆöÊó∂Âô®Â∑≤ÂÅúÊ≠¢');
    }
  }

  // È°µÈù¢Âä†ËΩΩÊó∂ÂêØÂä®ÂÆöÊó∂Âô®
  if (typeof window !== 'undefined') {
    window.addEventListener('load', () => {
      startAutoUpdateTimer();
      // Á´ãÂç≥Ê£ÄÊü•‰∏ÄÊ¨°
      setTimeout(checkAllStoriesForAutoUpdate, 5000); // Âª∂Ëøü5ÁßíÂêéÈ¶ñÊ¨°Ê£ÄÊü•
    });
  }

  // Êö¥Èú≤ÁªôÂÖ®Â±Ä
  window.openGreenRiverScreen = openGreenRiverScreen;
  window.openAuthorManager = openAuthorManager;
  window.createNewStory = createNewStory;
  window.openStorySettings = openStorySettings;
  window.addAuthor = addAuthor;
  window.deleteAuthor = deleteAuthor;
  window.checkAllStoriesForAutoUpdate = checkAllStoriesForAutoUpdate; // ÊâãÂä®Ëß¶ÂèëÊ£ÄÊü•
  window.autoGenerateChapter = autoGenerateChapter; // ÊâãÂä®Ëß¶ÂèëÂçï‰∏™‰ΩúÂìÅÊõ¥Êñ∞
  // ==========================================
  // ‚ñº‚ñº‚ñº ÈÇÆÁÆ± (Mail) ÂäüËÉΩÊ®°Âùó ‚ñº‚ñº‚ñº
  // ==========================================

  let mailState = {
    currentEmailId: null,
    isEditMode: false,
    selectedEmails: new Set()
  };

  // 1. ÊâìÂºÄÈÇÆÁÆ±Â∫îÁî®
  async function openEmailApp() {
    showScreen('email-screen');
    await renderEmailList();
  }

  // 2. Ê∏≤ÊüìÈÇÆ‰ª∂ÂàóË°®
  async function renderEmailList() {
    const listEl = document.getElementById('email-list');
    listEl.innerHTML = '';

    const emails = await db.emails.orderBy('timestamp').reverse().toArray();

    if (emails.length === 0) {
      listEl.innerHTML = '<div style="text-align:center; padding:50px; color:#8E8E93;">No Mail</div>';
      return;
    }

    const searchTerm = document.getElementById('mail-search-input').value.toLowerCase();

    emails.forEach(email => {
      if (searchTerm && !email.subject.toLowerCase().includes(searchTerm) && !email.content.toLowerCase().includes(searchTerm)) {
        return;
      }

      const div = document.createElement('div');
      // Â¶ÇÊûúÂΩìÂâçÂú®ÁºñËæëÊ®°ÂºèÔºå‰øùÊåÅ editing Á±ª
      const itemClass = `mail-item ${email.isRead ? '' : 'unread'} ${mailState.isEditMode ? 'editing' : ''}`;
      div.className = itemClass;
      div.dataset.id = email.id; // ÁªëÂÆöIDÊñπ‰æøÊü•Êâæ

      // Ê£ÄÊü•ÊòØÂê¶Â∑≤Ë¢´ÈÄâ‰∏≠
      if (mailState.selectedEmails.has(email.id)) {
        div.classList.add('selected');
      }

      const date = new Date(email.timestamp);
      const timeStr = date.toLocaleDateString() === new Date().toLocaleDateString()
        ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        : date.toLocaleDateString();

      // „ÄêÂÖ≥ÈîÆ„ÄëÊ∑ªÂä† mail-select-checkbox ÁªìÊûÑ
      div.innerHTML = `
            <div class="mail-select-checkbox"></div>
            <div class="mail-item-header">
                <span class="mail-sender">${escapeHTML(email.sender)}</span>
                <span class="mail-date">${timeStr}</span>
            </div>
            <div class="mail-subject">${escapeHTML(email.subject)}</div>
            <div class="mail-preview">${escapeHTML(email.content).replace(/\n/g, ' ').substring(0, 80)}</div>
        `;

      div.onclick = () => {
        if (mailState.isEditMode) {
          // ÁºñËæëÊ®°ÂºèÔºöÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ
          handleEmailSelection(div, email.id);
        } else {
          // ÊôÆÈÄöÊ®°ÂºèÔºöÊâìÂºÄËØ¶ÊÉÖ
          openEmailDetail(email.id);
        }
      };
      listEl.appendChild(div);
    });
  }

  function handleEmailSelection(element, id) {
    if (mailState.selectedEmails.has(id)) {
      mailState.selectedEmails.delete(id);
      element.classList.remove('selected');
    } else {
      mailState.selectedEmails.add(id);
      element.classList.add('selected');
    }
    updateMailDeleteButton();
  }

  function updateMailDeleteButton() {
    const btn = document.getElementById('mail-delete-selected-btn');
    const count = mailState.selectedEmails.size;
    btn.textContent = count > 0 ? `Âà†Èô§ (${count})` : 'Âà†Èô§';
    btn.disabled = count === 0;
  }
  async function executeBatchDeleteEmails() {
    const count = mailState.selectedEmails.size;
    if (count === 0) return;

    const confirmed = await showCustomConfirm(
      'Âà†Èô§ÈÇÆ‰ª∂',
      `Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô ${count} Â∞ÅÈÇÆ‰ª∂ÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ`,
      { confirmButtonClass: 'btn-danger', confirmText: 'Âà†Èô§' }
    );

    if (confirmed) {
      const idsToDelete = Array.from(mailState.selectedEmails);
      await db.emails.bulkDelete(idsToDelete);

      // Ê∏ÖÁ©∫ÈÄâ‰∏≠Áä∂ÊÄÅ
      mailState.selectedEmails.clear();
      updateMailDeleteButton();

      // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®ÔºàÊ≠§Êó∂ËøòÊòØÁºñËæëÊ®°ÂºèÔºåÊâÄ‰ª•ÂàóË°®‰ºö‰øùÊåÅÂè≥ÁßªÁä∂ÊÄÅÔºâ
      await renderEmailList();

      // ÂèØÈÄâÔºöÂ¶ÇÊûúÂà†ÂÆåÊÉ≥Ëá™Âä®ÈÄÄÂá∫ÁºñËæëÊ®°ÂºèÔºåË∞ÉÁî® toggleEmailEditMode();
    }
  }
  function handleSelectAllEmails() {
    const listEl = document.getElementById('email-list');
    const allItems = listEl.querySelectorAll('.mail-item');

    // Â¶ÇÊûúÂΩìÂâçÂ∑≤ÈÄâÊï∞ÈáèÁ≠â‰∫éÊÄªÊï∞ÔºåÂàôËßÜ‰∏∫‚ÄúÂèñÊ∂àÂÖ®ÈÄâ‚ÄùÔºåÂê¶Âàô‚ÄúÂÖ®ÈÄâ‚Äù
    const isSelectingAll = mailState.selectedEmails.size < allItems.length;

    allItems.forEach(item => {
      const id = parseInt(item.dataset.id);
      if (isSelectingAll) {
        mailState.selectedEmails.add(id);
        item.classList.add('selected');
      } else {
        mailState.selectedEmails.delete(id);
        item.classList.remove('selected');
      }
    });
    updateMailDeleteButton();
  }
  // 3. ÊâìÂºÄÈÇÆ‰ª∂ËØ¶ÊÉÖ (Êõ¥Êñ∞ÁâàÔºöÁªëÂÆöÂ§¥ÈÉ®ÊåâÈíÆ)
  async function openEmailDetail(id) {
    const email = await db.emails.get(id);
    if (!email) return;

    mailState.currentEmailId = id;

    // Ê†áËÆ∞‰∏∫Â∑≤ËØª
    if (!email.isRead) {
      await db.emails.update(id, { isRead: true });
    }

    document.getElementById('mail-detail-subject').textContent = email.subject;
    document.getElementById('mail-detail-from').textContent = email.sender;
    document.getElementById('mail-detail-to').textContent = email.recipient || 'Me';
    document.getElementById('mail-detail-time').textContent = new Date(email.timestamp).toLocaleString();

    // Â§¥ÂÉèÈ¶ñÂ≠óÊØç
    const avatarEl = document.getElementById('mail-detail-avatar');
    avatarEl.textContent = email.sender.charAt(0).toUpperCase();

    // Ê≠£Êñá (Â§ÑÁêÜÊç¢Ë°å)
    document.getElementById('mail-detail-body').innerHTML = email.content.replace(/\n/g, '<br>');

    // ÁªëÂÆöÂ§¥ÈÉ®Âè≥‰∏äËßíÁöÑÊåâÈíÆ‰∫ã‰ª∂

    // 1. ËΩ¨ÂèëÊåâÈíÆ
    const forwardBtn = document.getElementById('forward-email-btn');
    // ÁßªÈô§ÊóßÁõëÂê¨Âô® (‰ΩøÁî® cloneNode)
    const newForwardBtn = forwardBtn.cloneNode(true);
    forwardBtn.parentNode.replaceChild(newForwardBtn, forwardBtn);
    newForwardBtn.onclick = () => forwardEmailToChat(email);

    // 2. Âà†Èô§ÊåâÈíÆ (Êñ∞Â¢ûÂú®Âè≥‰∏äËßí)
    const deleteBtn = document.getElementById('delete-email-btn');
    if (deleteBtn) {
      const newDeleteBtn = deleteBtn.cloneNode(true);
      deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
      newDeleteBtn.onclick = () => deleteCurrentEmail();
    }

    showScreen('email-detail-screen');
  }

  function closeEmailDetail() {
    showScreen('email-screen');
    renderEmailList(); // Âà∑Êñ∞Áä∂ÊÄÅ
  }

  // 4. ÂàáÊç¢ÁºñËæëÊ®°Âºè
  function toggleEmailEditMode() {
    mailState.isEditMode = !mailState.isEditMode;
    const btn = document.getElementById('mail-edit-btn');
    const actionBar = document.getElementById('mail-action-bar');
    const listEl = document.getElementById('email-list');

    if (mailState.isEditMode) {
      // ËøõÂÖ•ÁºñËæëÊ®°Âºè
      btn.textContent = 'ÂÆåÊàê'; // ÊåâÈíÆÂèòÊñáÂ≠ó
      btn.style.color = 'var(--mail-accent)';
      btn.style.fontWeight = '600';
      btn.innerHTML = 'ÂÆåÊàê'; // Ë¶ÜÁõñÊéâ‰πãÂâçÁöÑ‚ÄúÁºñËæë‚ÄùÊñáÂ≠óÊàñÂõæÊ†á

      actionBar.style.display = 'flex';
      mailState.selectedEmails.clear();
      updateMailDeleteButton();

      // ÁªôÂàóË°®È°πÊ∑ªÂä†Ê†∑ÂºèÁ±ª
      listEl.querySelectorAll('.mail-item').forEach(item => item.classList.add('editing'));

    } else {
      // ÈÄÄÂá∫ÁºñËæëÊ®°Âºè
      btn.innerHTML = 'ÁºñËæë'; // ÊÅ¢Â§çÊñáÂ≠ó
      btn.style.color = 'currentColor';
      btn.style.fontWeight = 'normal';

      actionBar.style.display = 'none';
      mailState.selectedEmails.clear();

      // ÁßªÈô§Ê†∑ÂºèÁ±ª
      listEl.querySelectorAll('.mail-item').forEach(item => {
        item.classList.remove('editing', 'selected');
      });
    }
  }

  async function deleteEmail(id) {
    if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂ∞ÅÈÇÆ‰ª∂ÂêóÔºü")) {
      await db.emails.delete(id);
      renderEmailList();
    }
  }

  async function deleteCurrentEmail() {
    if (mailState.currentEmailId) {
      await deleteEmail(mailState.currentEmailId);
      closeEmailDetail();
    }
  }

  // 5. ÊâìÂºÄÁîüÊàêÂô®ÈÖçÁΩÆ
  function saveMailConfig() {
    const config = {
      userMask: document.getElementById('mail-user-mask').value.trim(),
      worldContext: document.getElementById('mail-world-context').value.trim(),
      personaId: document.getElementById('mail-user-persona-select').value,
      allowRandom: document.getElementById('mail-allow-random-npc').checked,
      genCount: document.getElementById('mail-gen-count').value,
      // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑÂèë‰ª∂‰∫∫ÂêçÂ≠óÊï∞ÁªÑ
      selectedSenders: Array.from(document.querySelectorAll('#mail-sender-list input:checked')).map(cb => cb.value),
      // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑ‰∏ñÁïå‰π¶IDÊï∞ÁªÑ
      selectedBookIds: Array.from(document.querySelectorAll('#mail-context-list input:checked')).map(cb => cb.value)
    };
    localStorage.setItem('ephone_mail_config', JSON.stringify(config));
    console.log("ÈÇÆÁÆ±ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò:", config);
    return config;
  }

  // 2. [Êñ∞ÂäüËÉΩ] Âä†ËΩΩÈÇÆÁÆ±ÈÖçÁΩÆ
  function loadMailConfig() {
    const saved = localStorage.getItem('ephone_mail_config');
    return saved ? JSON.parse(saved) : null;
  }

  // 3. [‰øÆÊîπ] ÊâìÂºÄËÆæÁΩÆÂºπÁ™ó (Âéü openEmailGenerator)
  // ÊîπÂêç‰∏∫ openEmailSettings Êõ¥Ë¥¥ÂàáÔºåÂêåÊó∂Âú®ÊâìÂºÄÊó∂ÂõûÂ°´Êï∞ÊçÆ
  async function openEmailSettings() {
    // ÂÖàÊ∏≤ÊüìÂàóË°®Ôºà‰øùÊåÅÂéüÊúâÈÄªËæëÔºâ
    const personaSelect = document.getElementById('mail-user-persona-select');
    if (personaSelect) {
      personaSelect.innerHTML = '<option value="">-- ‰ªÖ‰ΩøÁî®‰∏ãÊñπÂÖ≥ÈîÆËØç (Êó†ËØ¶ÁªÜ‰∫∫ËÆæ) --</option>';
      if (state.activeChatId) {
        const currentChat = state.chats[state.activeChatId];
        if (currentChat && currentChat.settings.myPersona) {
          const opt = document.createElement('option');
          opt.value = 'current_chat';
          opt.textContent = `ÂΩìÂâçËÅäÂ§©ËÆæÂÆö: ${currentChat.settings.myPersona.substring(0, 15).replace(/\n/g, ' ')}...`;
          personaSelect.appendChild(opt);
        }
      }
      if (state.personaPresets && state.personaPresets.length > 0) {
        state.personaPresets.forEach((p, index) => {
          const opt = document.createElement('option');
          opt.value = p.id;
          const summary = p.persona ? p.persona.substring(0, 20).replace(/\n/g, ' ') : `È¢ÑËÆæ ${index + 1}`;
          opt.textContent = `‰∫∫ËÆæÂ∫ì: ${summary}...`;
          personaSelect.appendChild(opt);
        });
      }
    }

    // Ê∏≤ÊüìÂèë‰ª∂‰∫∫ÂàóË°®
    const listEl = document.getElementById('mail-sender-list');
    listEl.innerHTML = '';
    const chars = Object.values(state.chats).filter(c => !c.isGroup);
    const npcs = await db.npcs.toArray();
    [...chars, ...npcs].forEach(c => {
      const div = document.createElement('div');
      div.className = 'gr-checkbox-item';
      div.innerHTML = `<input type="checkbox" value="${c.name}" data-type="${c.id ? 'char' : 'npc'}"> <span>${c.name}</span>`;
      div.onclick = (e) => { if (e.target.tagName !== 'INPUT') div.querySelector('input').click(); };
      listEl.appendChild(div);
    });

    // Ê∏≤Êüì‰∏ñÁïå‰π¶ÂàóË°®
    const wbList = document.getElementById('mail-context-list');
    wbList.innerHTML = '';
    const books = await db.worldBooks.toArray();
    books.forEach(book => {
      const div = document.createElement('div');
      div.className = 'gr-checkbox-item';
      div.innerHTML = `<input type="checkbox" value="${book.id}"> <span>${book.name}</span>`;
      div.onclick = (e) => { if (e.target.tagName !== 'INPUT') div.querySelector('input').click(); };
      wbList.appendChild(div);
    });

    // --- Ê†∏ÂøÉÔºöÂõûÂ°´Â∑≤‰øùÂ≠òÁöÑÊï∞ÊçÆ ---
    const config = loadMailConfig();
    if (config) {
      if (config.userMask) document.getElementById('mail-user-mask').value = config.userMask;
      if (config.worldContext) document.getElementById('mail-world-context').value = config.worldContext;
      if (config.personaId) personaSelect.value = config.personaId;
      if (config.genCount) document.getElementById('mail-gen-count').value = config.genCount;
      document.getElementById('mail-allow-random-npc').checked = config.allowRandom !== false; // ÈªòËÆ§ true

      // ÂõûÂ°´Â§çÈÄâÊ°Ü
      if (config.selectedSenders) {
        config.selectedSenders.forEach(val => {
          const cb = document.querySelector(`#mail-sender-list input[value="${val}"]`);
          if (cb) cb.checked = true;
        });
      }
      if (config.selectedBookIds) {
        config.selectedBookIds.forEach(val => {
          const cb = document.querySelector(`#mail-context-list input[value="${val}"]`);
          if (cb) cb.checked = true;
        });
      }
    }

    document.getElementById('email-generator-modal').classList.add('visible');
  }

  // 4. [Êñ∞Â¢û] ‰∏ÄÈîÆÊé•Êî∂ÂäüËÉΩ
  async function handleQuickReceiveMail() {
    const config = loadMailConfig();

    // Â¶ÇÊûúÊ≤°ÊúâÈÖçÁΩÆÔºåÂº∫Âà∂ÊâìÂºÄËÆæÁΩÆÁ™óÂè£
    if (!config || !config.userMask) {
      await showCustomAlert("ÊèêÁ§∫", "ËØ∑ÂÖàÁÇπÂáªÊóÅËæπÁöÑÈΩøËΩÆÂõæÊ†á‚öôÔ∏èÔºåÈÖçÁΩÆÊÇ®ÁöÑÊî∂‰ª∂‰∫∫Ë∫´‰ªΩÂíåËÉåÊôØ„ÄÇ");
      openEmailSettings();
      return;
    }

    await showCustomAlert("Ê≠£Âú®Êé•Êî∂...", `Ê≠£Âú®Ê†πÊçÆ‰øùÂ≠òÁöÑÈÖçÁΩÆ (${config.userMask}) ÁîüÊàêÈÇÆ‰ª∂...`);

    // Ë∞ÉÁî®Ê†∏ÂøÉÁîüÊàêÂáΩÊï∞
    await executeEmailGeneration(config);
  }
  // 5. [Ê†∏ÂøÉÊèêÂèñ] Â∞ÜÁîüÊàêÈÄªËæëÂ∞ÅË£Ö‰∏∫Áã¨Á´ãÂáΩÊï∞
  async function executeEmailGeneration(config) {
    // Ëß£ÊûÑÈÖçÁΩÆ
    const { userMask, worldContext, allowRandom, personaId, selectedSenders, selectedBookIds } = config;
    let genCount = parseInt(config.genCount) || 3;
    if (genCount > 10) genCount = 10;

    // Ëé∑ÂèñËØ¶ÁªÜ‰∫∫ËÆæÊñáÊú¨
    let detailedPersona = "";
    if (personaId === 'current_chat' && state.activeChatId) {
      const chat = state.chats[state.activeChatId];
      detailedPersona = chat.settings.myPersona || "";
    } else if (personaId) {
      const preset = state.personaPresets.find(p => p.id === personaId);
      if (preset) detailedPersona = preset.persona;
    }

    // ÊûÑÂª∫‰∏ä‰∏ãÊñá (‰∏ñÁïå‰π¶ + ËßíËâ≤ËÆ∞ÂøÜ)
    let worldBookText = "";
    for (const bid of (selectedBookIds || [])) {
      const wb = await db.worldBooks.get(bid);
      if (wb) worldBookText += `- „Ää${wb.name}„Äã: ${wb.content.filter(e => e.enabled).map(e => e.content).join('; ')}\n`;
    }

    let characterContext = "";
    if (selectedSenders && selectedSenders.length > 0) {
      const activeChars = Object.values(state.chats).filter(c => !c.isGroup && selectedSenders.includes(c.name));
      if (activeChars.length > 0) {
        characterContext = "\n# „ÄêÈáçË¶Å„ÄëÊåáÂÆöÂèë‰ª∂‰∫∫ÁöÑËØ¶ÁªÜÊ°£Ê°à\n";
        activeChars.forEach(chat => {
          const memory = (chat.longTermMemory && chat.longTermMemory.length > 0) ? chat.longTermMemory.map(m => m.content).join('; ') : 'ÊöÇÊó†';
          const recentHistory = chat.history.filter(m => !m.isHidden).slice(-5).map(m => `${m.role === 'user' ? 'Êàë' : chat.name}: ${String(m.content).substring(0, 50)}`).join('\n');
          characterContext += `## Âèë‰ª∂‰∫∫: ${chat.name}\n- **‰∫∫ËÆæ**: ${chat.settings.aiPersona.substring(0, 200)}...\n- **ÈïøÊúüËÆ∞ÂøÜ**: ${memory}\n- **ÊúÄËøëÂØπËØù**: \n${recentHistory}\n\n`;
        });
      }
    }

    // Prompt
    const systemPrompt = `
# ËßíËâ≤ÔºöÈÇÆ‰ª∂Á≥ªÁªüÁîüÊàêÂô®
ËØ∑Ê†πÊçÆ‰ª•‰∏ãËÆæÂÆöÁîüÊàê **${genCount}** Â∞ÅÈÇÆ‰ª∂„ÄÇ

# Êî∂‰ª∂‰∫∫Ê°£Ê°à
- **Ë∫´‰ªΩ**: ${userMask}
${detailedPersona ? `- **ËØ¶ÁªÜËÉåÊôØ**: ${detailedPersona.replace(/\n/g, ' ')}` : ""}
- **‰∏ñÁïåËßÇ**: ${worldContext || "Áé∞‰ª£ËÅåÂú∫/ÁîüÊ¥ª"}
${worldBookText ? "- **‰∏ñÁïå‰π¶ËßÑÂàô**: \n" + worldBookText : ""}

${characterContext}

# Âèë‰ª∂‰∫∫ÂÄôÈÄâ
${selectedSenders && selectedSenders.length > 0 ? "- ÊåáÂÆöÂèë‰ª∂‰∫∫: " + selectedSenders.join(', ') : ""}
${allowRandom ? "- ÂÖÅËÆ∏ÁîüÊàêÈöèÊú∫Ë∑Ø‰∫∫/ÂπøÂëä/ÈÄöÁü•" : ""}

# ËæìÂá∫Ê†ºÂºè (JSON Only)
\`\`\`json
[
  {
    "sender": "Âèë‰ª∂‰∫∫ÂßìÂêç",
    "subject": "ÈÇÆ‰ª∂Ê†áÈ¢ò",
    "content": "ÈÇÆ‰ª∂Ê≠£Êñá (ÊîØÊåÅÊç¢Ë°åÁ¨¶\\n)",
    "timestamp_offset": 0 (Ë∑ùÁ¶ªÁé∞Âú®ÁöÑÂàÜÈíüÊï∞ÔºåË¥üÊï∞Ë°®Á§∫ËøáÂéª)
  }
]
\`\`\`
`;

    // API Ë∞ÉÁî®
    try {
      const { proxyUrl, apiKey, model } = state.apiConfig;

      let isGemini = proxyUrl.includes('generativelanguage');
      let apiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: `Generate ${genCount} emails` }]);

      const response = isGemini ?
        await fetch(apiConfig.url, apiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
          body: JSON.stringify({ model: model, messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: `Generate ${genCount} emails` }], temperature: 1.0 })
        });

      if (!response.ok) throw new Error("APIËØ∑Ê±ÇÂ§±Ë¥•");
      const data = await response.json();
      const text = getGeminiResponseText(data);
      const jsonStr = text.replace(/^```json\s*/, '').replace(/```$/, '');
      const emails = JSON.parse(jsonStr);

      const now = Date.now();
      const newEmails = emails.map(e => ({
        sender: e.sender,
        senderType: 'gen',
        recipient: userMask,
        subject: e.subject,
        content: e.content,
        timestamp: now - (e.timestamp_offset || 0) * 60000,
        isRead: false
      }));

      await db.emails.bulkAdd(newEmails);

      // Âà∑Êñ∞ÂàóË°®
      await renderEmailList();
      // ÊèêÁ§∫ÊàêÂäü
      await showCustomAlert("Êé•Êî∂ÊàêÂäü", `Êî∂Âà∞ ${newEmails.length} Â∞ÅÊñ∞ÈÇÆ‰ª∂„ÄÇ`);

    } catch (e) {
      console.error(e);
      alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    }
  }



  // 7. ÊääÊñ∞ÂáΩÊï∞Êö¥Èú≤ÁªôÂÖ®Â±Ä

  // 6. Ê†∏ÂøÉÁîüÊàêÈÄªËæë (Â¢ûÂº∫ÁâàÔºöÊîØÊåÅËÆ∞ÂøÜËØªÂèñ + Ëá™ÂÆö‰πâÊù°Êï∞)
  document.getElementById('start-generate-email-btn').addEventListener('click', async () => {
    // --- 1. Ëé∑ÂèñÂü∫Á°ÄËæìÂÖ• ---
    const userMask = document.getElementById('mail-user-mask').value.trim();
    const worldContext = document.getElementById('mail-world-context').value.trim();
    const allowRandom = document.getElementById('mail-allow-random-npc').checked;

    // Ëé∑ÂèñËá™ÂÆö‰πâÊï∞ÈáèÔºåÈªòËÆ§‰∏∫ 3
    let genCount = parseInt(document.getElementById('mail-gen-count').value);
    if (isNaN(genCount) || genCount < 1) genCount = 3;
    if (genCount > 10) genCount = 10; // ÈôêÂà∂ÊúÄÂ§ß10Êù°Èò≤Ê≠¢Ë∂ÖÊó∂

    // Ëé∑ÂèñËØ¶ÁªÜ‰∫∫ËÆæ (‰∏ä‰∏ÄÊ≠•‰øÆÊîπÁöÑÂäüËÉΩ)
    const personaSelect = document.getElementById('mail-user-persona-select');
    let detailedPersona = "";
    if (personaSelect && personaSelect.value) {
      if (personaSelect.value === 'current_chat' && state.activeChatId) {
        const chat = state.chats[state.activeChatId];
        detailedPersona = chat.settings.myPersona || "";
      } else {
        const preset = state.personaPresets.find(p => p.id === personaSelect.value);
        if (preset) detailedPersona = preset.persona;
      }
    }

    // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÂèë‰ª∂‰∫∫ÂêçÂ≠ó
    const selectedSenders = Array.from(document.querySelectorAll('#mail-sender-list input:checked')).map(cb => cb.value);
    const selectedBookIds = Array.from(document.querySelectorAll('#mail-context-list input:checked')).map(cb => cb.value);

    if (!userMask) return alert("ËØ∑ËÆæÁΩÆÊî∂‰ª∂‰∫∫Ë∫´‰ªΩ");

    const btn = document.getElementById('start-generate-email-btn');
    const originalBtnText = btn.textContent;
    btn.textContent = "ËØªÂèñËÆ∞ÂøÜ‰∏≠...";
    btn.disabled = true;

    // --- 2. ÊûÑÂª∫‰∏ñÁïå‰π¶‰∏ä‰∏ãÊñá ---
    let worldBookText = "";
    for (const bid of selectedBookIds) {
      const wb = await db.worldBooks.get(bid);
      if (wb) worldBookText += `- „Ää${wb.name}„Äã: ${wb.content.filter(e => e.enabled).map(e => e.content).join('; ')}\n`;
    }

    // --- 3. „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÊûÑÂª∫ËßíËâ≤ËØ¶ÁªÜ‰∏ä‰∏ãÊñá (ËÆ∞ÂøÜ+ÂØπËØù) ---
    let characterContext = "";
    if (selectedSenders.length > 0) {
      // Âú®ÊâÄÊúâËÅäÂ§©‰∏≠Êü•ÊâæÈÄâ‰∏≠ÁöÑÂèë‰ª∂‰∫∫
      const activeChars = Object.values(state.chats).filter(c => !c.isGroup && selectedSenders.includes(c.name));

      if (activeChars.length > 0) {
        characterContext = "\n# „ÄêÈáçË¶Å„ÄëÊåáÂÆöÂèë‰ª∂‰∫∫ÁöÑËØ¶ÁªÜÊ°£Ê°à (ËØ∑Ê†πÊçÆËøô‰∫õ‰ø°ÊÅØÁîüÊàê‰∏™ÊÄßÂåñÈÇÆ‰ª∂)\n";

        activeChars.forEach(chat => {
          // ÊèêÂèñÈïøÊúüËÆ∞ÂøÜ
          const memory = (chat.longTermMemory && chat.longTermMemory.length > 0)
            ? chat.longTermMemory.map(m => m.content).join('; ')
            : 'ÊöÇÊó†';

          // ÊèêÂèñÊúÄËøë 5 Êù°ÂØπËØù (Áî®‰∫éÊçïÊçâÂΩìÂâçÂÖ≥Á≥ªÁä∂ÊÄÅÔºåÂ¶ÇÂêµÊû∂„ÄÅÁÉ≠ÊÅã„ÄÅÈôåÁîü)
          const recentHistory = chat.history
            .filter(m => !m.isHidden)
            .slice(-5)
            .map(m => `${m.role === 'user' ? 'Êàë' : chat.name}: ${String(m.content).substring(0, 50)}`)
            .join('\n');

          characterContext += `## Âèë‰ª∂‰∫∫: ${chat.name}\n`;
          characterContext += `- **Ê†∏ÂøÉ‰∫∫ËÆæ**: ${chat.settings.aiPersona.substring(0, 200)}...\n`; // Êà™Âèñ‰∏ÄÈÉ®ÂàÜÈò≤Ê≠¢TokenÊ∫¢Âá∫
          characterContext += `- **ÈïøÊúüËÆ∞ÂøÜ**: ${memory}\n`;
          characterContext += `- **ÊúÄËøëÂØπËØùÁä∂ÊÄÅ**: \n${recentHistory || '(Êó†ÊúÄËøëÂØπËØù)'}\n`;
          characterContext += `> ÊåáÂØº: ËØ∑Ê†πÊçÆËØ•ËßíËâ≤ÁöÑÊÄßÊ†ºÂíå‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÁä∂ÊÄÅÔºà‰æãÂ¶ÇÊòØÂê¶ÂàöÂêµËøáÊû∂„ÄÅÊòØÂê¶ÊúâÊú™ÂÆåÊàêÁöÑÁ∫¶ÂÆöÔºâÊù•Êí∞ÂÜôÈÇÆ‰ª∂„ÄÇ\n\n`;
        });
      }
    }

    // --- 4. ÊûÑÂª∫ Prompt ---
    const systemPrompt = `
# ËßíËâ≤ÔºöÈÇÆ‰ª∂Á≥ªÁªüÁîüÊàêÂô®
ËØ∑Ê†πÊçÆ‰ª•‰∏ãËÆæÂÆöÁîüÊàê **${genCount}** Â∞ÅÈÇÆ‰ª∂„ÄÇ

# Êî∂‰ª∂‰∫∫Ê°£Ê°à
- **ÂΩìÂâçË∫´‰ªΩ(User Mask)**: ${userMask}
${detailedPersona ? `- **ËØ¶ÁªÜ‰∫∫ËÆæËÉåÊôØ**: ${detailedPersona.replace(/\n/g, ' ')}` : ""}
- **ÊâÄÂú®‰∏ñÁïåËßÇ**: ${worldContext || "Áé∞‰ª£ËÅåÂú∫/ÁîüÊ¥ª"}
${worldBookText ? "- **‰∏ñÁïå‰π¶ËßÑÂàô**: \n" + worldBookText : ""}

${characterContext}

# Âèë‰ª∂‰∫∫ÂÄôÈÄâÊ±†
${selectedSenders.length > 0 ? "- ÊåáÂÆöÂèë‰ª∂‰∫∫ÂàóË°®: " + selectedSenders.join(', ') : ""}
${allowRandom ? "- ÂÖÅËÆ∏ÁîüÊàêÈöèÊú∫Ë∑Ø‰∫∫/Á≥ªÁªüÈÄöÁü•/ÂûÉÂúæÈÇÆ‰ª∂ (Â¶Ç: Èì∂Ë°åË¥¶Âçï, ÂπøÂëä, Á•ûÁßòÈÇÄËØ∑, Â∑•‰ΩúÈÄöÂëä)" : ""}

# Ê†∏ÂøÉË¶ÅÊ±Ç
1. **ËøûË¥ØÊÄß**: Â¶ÇÊûúÂèë‰ª∂‰∫∫ÊòØ‰∏äËø∞‚ÄúÊåáÂÆöÂèë‰ª∂‰∫∫‚Äù‰∏≠ÁöÑËßíËâ≤ÔºåÈÇÆ‰ª∂ÂÜÖÂÆπ**ÂøÖÈ°ª**‰∏é‰Ω†‰ª¨ÁöÑ‚ÄúÊúÄËøëÂØπËØùÁä∂ÊÄÅ‚ÄùÂíå‚ÄúÈïøÊúüËÆ∞ÂøÜ‚ÄùÁõ∏Á¨¶„ÄÇ
   - *‰æãÂ≠ê*: Â¶ÇÊûúÊúÄËøëÂØπËØùÂú®ÂêµÊû∂ÔºåÈÇÆ‰ª∂ÂèØËÉΩÊòØÈÅìÊ≠â‰ø°ÊàñÂÜ∑Ê∑°ÁöÑÈÄöÁü•ÔºõÂ¶ÇÊûúÊúÄËøëÂú®ÁÉ≠ÊÅãÔºåÈÇÆ‰ª∂ÂèØËÉΩÊòØÊÉÖ‰π¶„ÄÇ
2. **Ê≤âÊµ∏ÊÑü**: ÈÇÆ‰ª∂ÂÜÖÂÆπÂøÖÈ°ªÁ¨¶ÂêàÊî∂‰ª∂‰∫∫Ë∫´‰ªΩÂíå‰∏ñÁïåËßÇ„ÄÇ
3. **Â§öÊ†∑ÊÄß**: ÂåÖÂê´‰∏çÂêåÁ±ªÂûãÁöÑÈÇÆ‰ª∂ÔºàÊ≠£Âºè„ÄÅÈùûÊ≠£Âºè„ÄÅÂûÉÂúæÈÇÆ‰ª∂„ÄÅÁ¥ßÊÄ•ÈÄöÁü•Ôºâ„ÄÇ
4. **Ê†ºÂºè**: ËøîÂõû‰∏Ä‰∏™JSONÊï∞ÁªÑ„ÄÇ

# ËæìÂá∫Ê†ºÂºè (JSON Only)
\`\`\`json
[
  {
    "sender": "Âèë‰ª∂‰∫∫ÂßìÂêç",
    "subject": "ÈÇÆ‰ª∂Ê†áÈ¢ò",
    "content": "ÈÇÆ‰ª∂Ê≠£Êñá (ÊîØÊåÅÊç¢Ë°åÁ¨¶\\n)",
    "timestamp_offset": 0 (Ë∑ùÁ¶ªÁé∞Âú®ÁöÑÂàÜÈíüÊï∞ÔºåË¥üÊï∞Ë°®Á§∫ËøáÂéªÔºå‰æãÂ¶Ç 60 Ë°®Á§∫‰∏ÄÂ∞èÊó∂ÂâçÊî∂Âà∞)
  }
]
\`\`\`
`;

    try {
      const { proxyUrl, apiKey, model } = state.apiConfig;
      btn.textContent = "ÁîüÊàê‰∏≠...";

      let isGemini = proxyUrl.includes('generativelanguage');
      let config = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: `Generate ${genCount} emails` }]);

      const response = isGemini ?
        await fetch(config.url, config.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
          body: JSON.stringify({ model: model, messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: `Generate ${genCount} emails` }], temperature: 1.0 })
        });

      if (!response.ok) throw new Error("APIËØ∑Ê±ÇÂ§±Ë¥•");
      const data = await response.json();
      const text = getGeminiResponseText(data);
      const jsonStr = text.replace(/^```json\s*/, '').replace(/```$/, '');
      const emails = JSON.parse(jsonStr);

      // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
      const now = Date.now();
      const newEmails = emails.map(e => ({
        sender: e.sender,
        senderType: 'gen',
        recipient: userMask,
        subject: e.subject,
        content: e.content,
        timestamp: now - (e.timestamp_offset || 0) * 60000,
        isRead: false
      }));

      await db.emails.bulkAdd(newEmails);

      document.getElementById('email-generator-modal').classList.remove('visible');
      await renderEmailList();
      await showCustomAlert("Êé•Êî∂ÊàêÂäü", `Êî∂Âà∞ ${newEmails.length} Â∞ÅÊñ∞ÈÇÆ‰ª∂„ÄÇ`);

    } catch (e) {
      console.error(e);
      alert("Êé•Êî∂Â§±Ë¥•: " + e.message);
    } finally {
      btn.textContent = originalBtnText;
      btn.disabled = false;
    }
  });

  // 7. ËΩ¨ÂèëÂà∞ËÅäÂ§© (Âç°ÁâáÁâà)
  async function forwardEmailToChat(email) {
    // ÂºπÂá∫ÈÄâÊã©ËÅäÂ§©ÂØπË±°ÁöÑÂºπÁ™ó (Â§çÁî®Áé∞ÊúâÁöÑ)
    await openShareTargetPicker();

    const confirmBtn = document.getElementById('confirm-share-target-btn');

    // ‰ΩøÁî® cloneNode ÁßªÈô§ÊóßÁõëÂê¨Âô®
    const newBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);

    newBtn.onclick = async () => {
      const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
        .map(cb => cb.dataset.chatId);

      if (selectedTargetIds.length === 0) return alert("ËØ∑ÈÄâÊã©Ë¶ÅËΩ¨ÂèëÂà∞ÁöÑËÅäÂ§©„ÄÇ");

      // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÔºö‰∏çÂÜçÊãºÊé•Â≠óÁ¨¶‰∏≤ÔºåËÄåÊòØÂàõÂª∫‰∏Ä‰∏™ÁªìÊûÑÂåñÊ∂àÊÅØÂØπË±°
      const emailCardMsg = {
        role: 'user',
        type: 'forwarded_email', // Êñ∞Â¢ûÁöÑÁ±ªÂûã
        timestamp: Date.now(),
        content: `[ÈÇÆ‰ª∂] ${email.subject}`, // ÁÆÄÁï•ÊñáÊú¨ÔºåÁî®‰∫éÈ¢ÑËßà
        emailData: {
          subject: email.subject,
          sender: email.sender,
          date: new Date(email.timestamp).toLocaleString(),
          preview: email.content.replace(/\n/g, ' ').substring(0, 100), // ÊèêÂèñÂâç100Â≠óÂÅöÈ¢ÑËßà
          fullContent: email.content // ‰øùÂ≠òÂÆåÊï¥ÂÜÖÂÆπ‰æõÁÇπÂáªÊü•Áúã
        }
      };

      // Áªô AI ÁöÑÁ≥ªÁªüÊèêÁ§∫ (‰øùÊåÅ‰∏çÂèòÔºåËÆ© AI ÁêÜËß£ÈÇÆ‰ª∂ÂÜÖÂÆπ)
      const forwardContentForAI = `
üìß **ËΩ¨ÂèëÈÇÆ‰ª∂**
**Âèë‰ª∂‰∫∫:** ${email.sender}
**Êî∂‰ª∂‰∫∫:** ${email.recipient || 'Êàë'}
**‰∏ªÈ¢ò:** ${email.subject}
----------------
${email.content}
`;

      for (const targetId of selectedTargetIds) {
        const targetChat = state.chats[targetId];
        if (targetChat) {
          // 1. Êé®ÈÄÅÂç°ÁâáÊ∂àÊÅØ
          targetChat.history.push(emailCardMsg);


          const isSelfEmail = (email.sender === targetChat.name) || (email.sender === targetChat.originalName);

          let systemHintText = "";

          if (isSelfEmail) {
            // Â¶ÇÊûúÊòØAIËá™Â∑±ÂèëÁöÑÔºåÂº∫Ë∞ÉËøôÊòØ‚ÄúÂõûÈ°æ‚Äù
            systemHintText = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Êää‰Ω†„Äê‰πãÂâçÂèëÁªôTAÁöÑËøôÂ∞ÅÈÇÆ‰ª∂„ÄëËΩ¨ÂèëÂõûÁªô‰Ω†‰∫Ü„ÄÇËØ∑Ê≥®ÊÑèÔºöËøôÂ∞ÅÈÇÆ‰ª∂ÊòØ**‰Ω†Ëá™Â∑±ÂÜô**ÁöÑÔºå‰∏çÊòØÁî®Êà∑ÂÜôÁöÑ„ÄÇÁî®Êà∑ÂèØËÉΩÊòØÊÉ≥Âíå‰Ω†ËÆ®ËÆ∫ÈÇÆ‰ª∂ÈáåÁöÑÂÜÖÂÆπÔºåÊàñËÄÖÂØπ‰Ω†ÁöÑÈÇÆ‰ª∂Ë°®Á§∫ÂõûÂ∫î„ÄÇËØ∑‰ª•‚ÄúÈÇÆ‰ª∂‰ΩúËÄÖ‚ÄùÁöÑË∫´‰ªΩËøõË°åÂõûÂ§ç„ÄÇ]`;
          } else {
            // Â¶ÇÊûúÊòØÂà´‰∫∫ÂèëÁöÑÔºå‰øùÊåÅÂéüÊ†∑
            systemHintText = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ËΩ¨Âèë‰∫Ü‰∏ÄÂ∞ÅÈÇÆ‰ª∂Áªô‰Ω†„ÄÇËøôÂ∞ÅÈÇÆ‰ª∂ÊòØ„Äê${email.sender}„ÄëÂÜôÁöÑ„ÄÇËØ∑Ê†πÊçÆÂÜÖÂÆπÂíå‰Ω†‰ª¨ÁöÑÂÖ≥Á≥ªÂÅöÂá∫ÂèçÂ∫î„ÄÇ]`;
          }

          // 2. Êé®ÈÄÅÁ≥ªÁªüÊèêÁ§∫ (ÈöêËóè)
          targetChat.history.push({
            role: 'system',
            content: `${systemHintText}\n\n--- ÈÇÆ‰ª∂ËØ¶ÊÉÖ ---\n${forwardContentForAI}`,
            timestamp: Date.now() + 1,
            isHidden: true
          });


          await db.chats.put(targetChat);
        }
      }

      document.getElementById('share-target-modal').classList.remove('visible');
      await showCustomAlert("ËΩ¨ÂèëÊàêÂäü", "ÈÇÆ‰ª∂Â∑≤‰ª•Âç°ÁâáÂΩ¢ÂºèÂèëÈÄÅ„ÄÇ");

      // Â¶ÇÊûúÂΩìÂâçÂ∞±Âú®ËØ•ËÅäÂ§©ÔºåÂà∑Êñ∞ÊòæÁ§∫
      if (state.activeChatId && selectedTargetIds.includes(state.activeChatId)) {
        renderChatInterface(state.activeChatId);
      }
    };
  }

  // ÊêúÁ¥¢Ê°Ü‰∫ã‰ª∂ÁªëÂÆö
  document.getElementById('mail-search-input').addEventListener('input', renderEmailList);

  // Êö¥Èú≤ÁªôÂÖ®Â±Ä
  window.openEmailApp = openEmailApp;
  window.openEmailSettings = openEmailSettings;
  window.handleQuickReceiveMail = handleQuickReceiveMail;
  window.toggleEmailEditMode = toggleEmailEditMode;
  window.closeEmailDetail = closeEmailDetail;
  window.deleteCurrentEmail = deleteCurrentEmail;
  // --- Êñ∞Â¢ûÔºöÁ¥ßÊÄ•ÈáçÁΩÆÂ§ñËßÇÂäüËÉΩ (‰∏çÂà†Èô§È¢ÑËÆæ) ---
  async function handleEmergencyAppearanceReset() {
    const confirmed = await showCustomConfirm(
      "Á°ÆËÆ§ÈáçÁΩÆÂ§ñËßÇÔºü",
      "Ê≠§Êìç‰ΩúÂ∞ÜÊääÂΩìÂâçÁöÑÂ£ÅÁ∫∏„ÄÅ‰∏ªÈ¢ò„ÄÅCSS„ÄÅÂõæÊ†áÂíåÂ≠ó‰ΩìÊÅ¢Â§ç‰∏∫ÈªòËÆ§Áä∂ÊÄÅ„ÄÇ\n\n‚úÖ ‰Ω†ÁöÑ„ÄêÈ¢ÑËÆæÂ∫ì„Äë‰∏ç‰ºöË¢´Âà†Èô§„ÄÇ\n‚úÖ Ê≠§ÂäüËÉΩÁî®‰∫é‰øÆÂ§çÂõ† CSS ÈîôËØØÂØºËá¥Êó†Ê≥ïÊâìÂºÄÂ§ñËßÇËÆæÁΩÆÁöÑÈóÆÈ¢ò„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÊâßË°åÂêóÔºü",
      { confirmButtonClass: 'btn-danger', confirmText: 'Á´ãÂç≥ÈáçÁΩÆ' }
    );

    if (!confirmed) return;

    await showCustomAlert("Â§ÑÁêÜ‰∏≠...", "Ê≠£Âú®ÈáçÁΩÆÂ§ñËßÇÈÖçÁΩÆ...");

    try {
      // 1. ÈáçÁΩÆÂÜÖÂ≠ò‰∏≠ÁöÑ state.globalSettings Âà∞ÈªòËÆ§ÂÄº (‰ªÖÂ§ñËßÇÁõ∏ÂÖ≥)
      // Ê≥®ÊÑèÔºö‰øùÁïô API Key Á≠âÂÖ∂‰ªñËÆæÁΩÆ

      // ÊÅ¢Â§çÈªòËÆ§ÂõæÊ†áÂØπË±°
      const defaultAppIcons = { ...DEFAULT_APP_ICONS };
      const defaultCPhoneIcons = { ...DEFAULT_CPHONE_ICONS };
      const defaultMyPhoneIcons = { ...DEFAULT_MYPHONE_ICONS };

      state.globalSettings.wallpaper = 'linear-gradient(135deg, #89f7fe, #66a6ff)';
      state.globalSettings.cphoneWallpaper = 'linear-gradient(135deg, #f6d365, #fda085)';
      state.globalSettings.globalChatBackground = ''; // Ê∏ÖÈô§ÂÖ®Â±ÄËÅäÂ§©ËÉåÊôØ
      state.globalSettings.globalCss = ''; // „ÄêÊ†∏ÂøÉ„ÄëÊ∏ÖÁ©∫ CSS
      state.globalSettings.fontUrl = '';   // Ê∏ÖÁ©∫Â≠ó‰Ωì
      state.globalSettings.theme = 'light'; // ÊÅ¢Â§ç‰∫ÆËâ≤Ê®°Âºè
      state.globalSettings.appIcons = defaultAppIcons;
      state.globalSettings.cphoneAppIcons = defaultCPhoneIcons;
      state.globalSettings.myphoneAppIcons = defaultMyPhoneIcons;

      // ÊÅ¢Â§ç‰∫§‰∫íÂºÄÂÖ≥
      state.globalSettings.showStatusBar = false;
      state.globalSettings.showPhoneFrame = false;
      state.globalSettings.detachStatusBar = false;
      state.globalSettings.enableMinimalChatUI = false;
      state.globalSettings.alwaysShowMusicIsland = false;

      // Ê∏ÖÁ©∫Ëá™ÂÆö‰πâÊåâÈíÆÊéíÂ∫è
      state.globalSettings.chatActionButtonsOrder = null;

      // 2. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
      await db.globalSettings.put(state.globalSettings);

      // 3. Á´ãÂç≥Â∫îÁî®Êõ¥Êîπ (Âà∑Êñ∞ UI)
      localStorage.setItem('ephone-theme', 'light');
      applyTheme('light');

      applyGlobalWallpaper();
      applyCPhoneWallpaper();
      applyMyPhoneWallpaper();

      applyGlobalCss(''); // Á´ãÂç≥ÁßªÈô§ CSS Ê†∑Âºè
      applyCustomFont(''); // ÁßªÈô§Â≠ó‰Ωì

      applyAppIcons();
      applyCPhoneAppIcons();
      applyMyPhoneAppIconsGlobal();

      applyStatusBarVisibility();
      applyPhoneFrame(false);
      applyDetachStatusBarMode(false);
      applyMinimalChatUI(false);

      // ÈáçÁΩÆÊåâÈíÆÊéíÂ∫è
      if (typeof resetButtonOrder === 'function') {
        await resetButtonOrder(); // ËøôÊòØ‰∏Ä‰∏™Áé∞ÊúâÁöÑÂáΩÊï∞ÔºåÂ§çÁî®ÂÆÉ
      }

      await showCustomAlert("ÈáçÁΩÆÊàêÂäü", "Â§ñËßÇÂ∑≤ÊÅ¢Â§çÈªòËÆ§Áä∂ÊÄÅÔºÅ\nÁé∞Âú®‰Ω†Â∫îËØ•ÂèØ‰ª•Ê≠£Â∏∏ÊâìÂºÄÂ§ñËßÇËÆæÁΩÆÈ°µÈù¢‰∫Ü„ÄÇ");

    } catch (error) {
      console.error("ÈáçÁΩÆÂ§ñËßÇÂ§±Ë¥•:", error);
      await showCustomAlert("ÈîôËØØ", `ÈáçÁΩÆÂ§±Ë¥•: ${error.message}`);
    }
  }
  // --- Êñ∞Â¢ûÔºöÊÅ¢Â§çÂá∫ÂéÇËÆæÁΩÆ (ÂàùÂßãÂåñÊâÄÊúâÂÜÖÂÆπ) ---
  async function handleFactoryReset() {
    // --- Èò≤ËØØËß¶Êú∫Âà∂ Á¨¨1Â±ÇÔºöÂºπÁ™óË≠¶Âëä ---
    const confirmed = await showCustomConfirm(
      "‚ò†Ô∏è ‰∏•ÈáçË≠¶ÂëäÔºöÂàùÂßãÂåñÂ∫îÁî®",
      "Ê≠§Êìç‰ΩúÂ∞Ü„ÄêÊ∞∏‰πÖÂà†Èô§„ÄëÊú¨Âú∞Â≠òÂÇ®ÁöÑÊâÄÊúâÊï∞ÊçÆÔºåÂåÖÊã¨Ôºö\n\n‚ùå ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂíåËÆæÂÆö\n‚ùå ÊâÄÊúâÂõæÁâá„ÄÅË°®ÊÉÖÂåÖ„ÄÅÈ¢ÑËÆæ\n‚ùå ÊâÄÊúâAPIÈÖçÁΩÆÂíåÂ§ñËßÇËÆæÁΩÆ\n‚ùå ÊâÄÊúâËÅîÊú∫Êï∞ÊçÆÔºàÂ•ΩÂèã„ÄÅÊúçÂä°Âô®„ÄÅÂ§¥ÂÉèÔºâ\n\nÂ∫îÁî®Â∞ÜÂèòÂõûÂàöÂÆâË£ÖÊó∂ÁöÑÊ†∑Â≠ê„ÄÇÊï∞ÊçÆ‰∏ÄÊó¶Âà†Èô§Êó†Ê≥ïÊÅ¢Â§çÔºÅ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü",
      {
        confirmButtonClass: 'btn-danger',
        confirmText: 'ÊàëÊòéÁôΩÔºåÁªßÁª≠'
      }
    );

    if (!confirmed) return;

    // --- Èò≤ËØØËß¶Êú∫Âà∂ Á¨¨2Â±ÇÔºöÂº∫Âà∂ËæìÂÖ•È™åËØÅ ---
    // Ë¶ÅÊ±ÇÁî®Êà∑ÊâãÂä®ËæìÂÖ•ÁâπÂÆöÊñáÂ≠óÔºåÈò≤Ê≠¢ÊâãÊªëËøûÁÇπ
    const verificationText = "Á´ãÂç≥ÈáçÁΩÆ";
    const userInput = await showCustomPrompt(
      "ÊúÄÁªàÁ°ÆËÆ§",
      `‰∏∫‰∫ÜÁ°ÆËÆ§Ëøô‰∏çÊòØËØØÊìç‰ΩúÔºåËØ∑Âú®‰∏ãÊñπÊ°Ü‰∏≠ÂáÜÁ°ÆËæìÂÖ•‚Äú${verificationText}‚ÄùÂõõ‰∏™Â≠óÔºö`,
      "",
      "text"
    );

    if (userInput !== verificationText) {
      await showCustomAlert("Êìç‰ΩúÂèñÊ∂à", "È™åËØÅÊñáÂ≠óËæìÂÖ•ÈîôËØØÔºåÂàùÂßãÂåñÂ∑≤ÂèñÊ∂à„ÄÇ");
      return;
    }

    // --- ÊâßË°åÊ∏ÖÁêÜ ---
    await showCustomAlert("Ê≠£Âú®ÈáçÁΩÆ...", "Ê≠£Âú®ÈîÄÊØÅÊâÄÊúâÊï∞ÊçÆÔºåÂ∫îÁî®Âç≥Â∞ÜÈáçÂêØ...");

    try {
      // 0. Êñ≠ÂºÄËÅîÊú∫ËøûÊé•ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
      if (typeof onlineChatManager !== 'undefined' && onlineChatManager) {
        console.log('Ê≠£Âú®Êñ≠ÂºÄËÅîÊú∫ËøûÊé•...');
        // Á¶ÅÊ≠¢Ëá™Âä®ÈáçËøû
        onlineChatManager.shouldAutoReconnect = false;

        // Êñ≠ÂºÄWebSocketËøûÊé•
        if (onlineChatManager.isConnected && onlineChatManager.ws) {
          onlineChatManager.ws.close();
          onlineChatManager.ws = null;
          onlineChatManager.isConnected = false;
        }

        // Ê∏ÖÈô§ÂÆöÊó∂Âô®
        if (onlineChatManager.reconnectTimer) {
          clearTimeout(onlineChatManager.reconnectTimer);
          onlineChatManager.reconnectTimer = null;
        }
        if (onlineChatManager.heartbeatTimer) {
          clearInterval(onlineChatManager.heartbeatTimer);
          onlineChatManager.heartbeatTimer = null;
        }

        console.log('ËÅîÊú∫ËøûÊé•Â∑≤Êñ≠ÂºÄ');
      }

      // 1. Ê∏ÖÁ©∫ IndexedDB ÊâÄÊúâË°®
      // Êàë‰ª¨‰∏ç‰ΩøÁî® db.delete() ÊòØ‰∏∫‰∫ÜÈÅøÂÖçÈáçËøûÊï∞ÊçÆÂ∫ìÁöÑÂ§çÊùÇÊÄßÔºåÁõ¥Êé•Ê∏ÖÁ©∫Ë°®ÂÜÖÂÆπÊïàÊûú‰∏ÄÊ†∑‰∏îÊõ¥Á®≥
      await db.transaction('rw', db.tables, async () => {
        for (const table of db.tables) {
          console.log(`Ê≠£Âú®Ê∏ÖÁ©∫Ë°®: ${table.name}`);
          await table.clear();
        }
      });

      // 2. Ê∏ÖÁ©∫ LocalStorage (ÂåÖÊã¨‰∏ªÈ¢ò„ÄÅËØ≠Ë®Ä„ÄÅÊú™ËØªËÆ°Êï∞„ÄÅ‰∏¥Êó∂ÁºìÂ≠òÁ≠âÔºå‰πüÂåÖÊã¨ËÅîÊú∫ËÆæÁΩÆ)
      localStorage.clear();

      // 3. Âº∫Âà∂Âà∑Êñ∞È°µÈù¢
      // Âª∂Ëøü‰∏Ä‰∏ãËÆ©Áî®Êà∑ÁúãÂà∞ÊèêÁ§∫ÔºåÁÑ∂ÂêéÂà∑Êñ∞ÈáçËΩΩÊï¥‰∏™Â∫îÁî®
      setTimeout(() => {
        window.location.reload(true);
      }, 1000);

    } catch (error) {
      console.error("ÂàùÂßãÂåñÂ§±Ë¥•:", error);
      await showCustomAlert("ÈîôËØØ", `ÈáçÁΩÆËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ: ${error.message}\nËØ∑Â∞ùËØïÊâãÂä®Ê∏ÖÈô§ÊµèËßàÂô®ÁºìÂ≠ò„ÄÇ`);
    }
  }
  // --- Êñ∞Â¢ûÔºöÁÆÄÊòìÂõæÁâáÊîæÂ§ßÊü•ÁúãÂô® (Áã¨Á´ã‰∫éÁõ∏ÂÜå) ---
  function openSimpleImageZoom(src) {
    // 1. Ê£ÄÊü•È°µÈù¢‰∏äÊòØÂê¶Â∑≤ÁªèÊúâËøô‰∏™ÈÅÆÁΩ©Â±ÇÔºåÊ≤°ÊúâÂ∞±ÂàõÂª∫
    let overlay = document.getElementById('simple-image-zoom-overlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'simple-image-zoom-overlay';
      overlay.innerHTML = '<img src="" alt="Zoomed Image">';

      // ÁÇπÂáªÈÅÆÁΩ©Â±Ç‰ªªÊÑè‰ΩçÁΩÆÂÖ≥Èó≠
      overlay.addEventListener('click', () => {
        overlay.classList.remove('visible');
        setTimeout(() => { overlay.style.display = 'none'; }, 250);
      });

      document.body.appendChild(overlay);
    }

    // 2. ËÆæÁΩÆÂõæÁâáÂπ∂ÊòæÁ§∫
    const img = overlay.querySelector('img');
    img.src = src;

    overlay.style.display = 'flex';
    // Âº∫Âà∂ÈáçÁªò‰ª•Ëß¶Âèë transition
    void overlay.offsetWidth;
    overlay.classList.add('visible');
  }
  // --- Reddit ÂäüËÉΩÊ®°Âùó ---

  async function handleRedditSearch(query = '') {
    const listEl = document.getElementById('char-reddit-list');
    listEl.innerHTML = '<div class="spinner"></div>'; // Âä†ËΩΩ‰∏≠

    let targetUrl;
    if (query === 'popular' || !query) {
      targetUrl = `https://www.reddit.com/r/popular.json?limit=30&raw_json=1`;
    } else {
      targetUrl = `https://www.reddit.com/search.json?q=${encodeURIComponent(query)}&limit=30&raw_json=1&sort=relevance`;
    }

    // ‰ΩøÁî® CORS ‰ª£ÁêÜÁªïËøáË∑®ÂüüÈôêÂà∂
    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

    try {
      const response = await fetch(proxyUrl);
      if (!response.ok) throw new Error("ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•");

      const json = await response.json();
      const posts = json.data.children;

      renderRedditList(posts);
    } catch (error) {
      console.error("Reddit API Error:", error);
      listEl.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Êó†Ê≥ïËøûÊé•Âà∞ RedditÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñ‰ª£ÁêÜ„ÄÇ</p>';
    }
  }
  // [Modify] openRedditDetail to handle cross-screen navigation
  async function openRedditDetail(post) {
    // 1. Detect if we are opening from the Chat Interface
    const isFromChat = document.getElementById('chat-interface-screen').classList.contains('active');

    const titleEl = document.getElementById('char-article-title');
    const contentEl = document.getElementById('char-article-content');
    const backBtn = document.querySelector('#char-browser-article-screen .back-btn');

    // Header actions setup
    let headerActions = document.querySelector('#char-browser-article-screen .header .header-actions');
    if (!headerActions) {
      const header = document.querySelector('#char-browser-article-screen .header');
      headerActions = document.createElement('div');
      headerActions.className = 'header-actions';
      header.appendChild(headerActions);
    }

    // UI Loading State
    titleEl.textContent = "Âä†ËΩΩ‰∏≠...";
    contentEl.innerHTML = '<div class="spinner" style="margin-top:50px;"></div>';

    // 2. Critical Fix: Switch Main Screen if coming from Chat
    if (isFromChat) {
      showScreen('character-phone-screen');
    }

    // Switch Sub-screen
    switchToCharScreen('char-browser-article-screen');

    // 3. Configure Back Button based on source
    const newBackBtn = backBtn.cloneNode(true);
    backBtn.parentNode.replaceChild(newBackBtn, backBtn);
    newBackBtn.onclick = () => {
      if (isFromChat) {
        // If from chat, go back to chat
        showScreen('chat-interface-screen');
      } else {
        // If from app list, go back to app list
        switchToCharScreen('char-reddit-screen');
      }
    };

    // 4. Setup Forward Button
    headerActions.innerHTML = '';
    const forwardBtn = document.createElement('span');
    forwardBtn.className = 'action-btn';
    forwardBtn.innerHTML = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>`;
    forwardBtn.title = "ËΩ¨ÂèëÁªôTA";
    headerActions.appendChild(forwardBtn);

    // 5. Handle Inner Links
    contentEl.onclick = async (e) => {
      const link = e.target.closest('a.reddit-inner-link');
      if (link) {
        e.preventDefault();
        const href = link.href;
        const redditMatch = href.match(/reddit\.com\/r\/[^\/]+\/comments\/([a-zA-Z0-9]+)/);
        if (redditMatch) {
          const urlObj = new URL(href);
          const permalink = urlObj.pathname;
          // Recursively open, preserving context logic is tricky, so we treat inner links as internal nav
          await openRedditDetail({ permalink: permalink });
        } else {
          window.open(href, '_blank');
        }
      }
    };

    try {
      // 6. Fetch Data
      const permalink = post.permalink;
      if (!permalink) throw new Error("Êó†ÊïàÁöÑÂ∏ñÂ≠êÈìæÊé•");

      const targetUrl = `https://www.reddit.com${permalink}.json?raw_json=1`;
      const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

      const response = await fetch(proxyUrl);
      if (!response.ok) throw new Error("Êó†Ê≥ïÂä†ËΩΩÂ∏ñÂ≠êËØ¶ÊÉÖ");

      const json = await response.json();
      const fullPostData = json[0].data.children[0].data;
      const commentsData = json[1].data.children;

      // Forward Logic Data Object
      const postObjForForward = {
        id: fullPostData.id,
        title: fullPostData.title,
        subreddit_name_prefixed: fullPostData.subreddit_name_prefixed,
        author: fullPostData.author,
        score: fullPostData.score,
        num_comments: fullPostData.num_comments,
        permalink: fullPostData.permalink,
        selftext: fullPostData.selftext || '',
        thumbnail: (fullPostData.preview && fullPostData.preview.images[0]) ? fullPostData.preview.images[0].source.url.replace(/&amp;/g, '&') : (fullPostData.thumbnail && fullPostData.thumbnail.startsWith('http') ? fullPostData.thumbnail : null),
        url: fullPostData.url
      };

      forwardBtn.onclick = () => {
        forwardRedditPost(null, postObjForForward);
      };

      // Render Title
      titleEl.textContent = fullPostData.subreddit_name_prefixed;

      let htmlContent = '';

      // A. Header
      htmlContent += `
            <div style="margin-bottom: 15px;">
                <h2 style="font-size: 20px; font-weight: bold; margin: 0 0 8px 0;">${escapeHTML(fullPostData.title)}</h2>
                <div style="color: #888; font-size: 12px;">
                    u/${fullPostData.author} ‚Ä¢ ${new Date(fullPostData.created_utc * 1000).toLocaleString()}
                </div>
            </div>
        `;

      // B. Media
      const ytMatch = fullPostData.url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/|youtube\.com\/shorts\/)([^"&?\/\s]{11})/);

      if (ytMatch) {
        const videoId = ytMatch[1];
        htmlContent += `
                <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; margin-bottom: 10px; background: #000;">
                    <iframe src="https://www.youtube-nocookie.com/embed/${videoId}?rel=0&modestbranding=1&playsinline=1" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" frameborder="0" allowfullscreen></iframe>
                </div>`;
      } else if (fullPostData.is_video && fullPostData.media && fullPostData.media.reddit_video) {
        htmlContent += `
    <video controls playsinline poster="${fullPostData.thumbnail}" style="width: 100%; border-radius: 8px; margin-bottom: 5px; background: #000;">
        <source src="${fullPostData.media.reddit_video.fallback_url}" type="video/mp4">
    </video>
    <div style="font-size:12px; color:#999; margin-bottom:15px;">
        ‚ö†Ô∏è Ê≥®ÔºöRedditÂéüÁîüËßÜÈ¢ëÂèØËÉΩÊó†Â£∞Ôºå<a href="${fullPostData.url}" target="_blank" style="color:#007aff;">ÁÇπÂáªÊ≠§Â§ÑË∑≥ËΩ¨ÂéüÁΩëÈ°µËßÇÁúã</a>
    </div>`;
      } else if (fullPostData.url && fullPostData.url.match(/\.(jpg|jpeg|png|gif)$/i)) {
        htmlContent += `<img src="${fullPostData.url}" style="width:100%; border-radius:8px; margin-bottom:15px;">`;
      } else if (fullPostData.preview && fullPostData.preview.images && fullPostData.preview.images.length > 0) {
        const imgUrl = fullPostData.preview.images[0].source.url.replace(/&amp;/g, '&');
        htmlContent += `<img src="${imgUrl}" style="width:100%; border-radius:8px; margin-bottom:15px;">`;
      }

      // C. Text
      if (fullPostData.selftext) {
        let processedText = escapeHTML(fullPostData.selftext);
        processedText = processedText.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, '<a href="$2" class="reddit-inner-link" style="color:#007aff; text-decoration:none;">$1</a>');
        processedText = processedText.replace(/(^|\s)(https?:\/\/[^\s<]+)/g, '$1<a href="$2" class="reddit-inner-link" style="color:#007aff; text-decoration:none;">üîó Link</a>');
        processedText = processedText.replace(/\n/g, '<br>');
        htmlContent += `<div style="line-height:1.6; font-size:15px; color:#333; margin-bottom:20px; word-break: break-word;">${processedText}</div>`;
      }

      // D. Data Bar
      const score = fullPostData.score > 1000 ? (fullPostData.score / 1000).toFixed(1) + 'k' : fullPostData.score;
      htmlContent += `
            <div style="display:flex; gap:20px; padding:10px 0; border-top:1px solid #eee; border-bottom:1px solid #eee; margin-bottom:15px; font-size:13px; color:#555; align-items:center;">
                <span style="display:flex; align-items:center; gap:4px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#ff4500;">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg> 
                    ${score} Ëµû
                </span>
                <span style="display:flex; align-items:center; gap:4px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                    </svg>
                    ${fullPostData.num_comments} ËØÑËÆ∫
                </span>
            </div>
        `;

      // E. Comments
      htmlContent += `<div style="font-weight:bold; margin-bottom:10px;">ËØÑËÆ∫</div>`;
      if (commentsData.length === 0) {
        htmlContent += `<div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†ËØÑËÆ∫</div>`;
      } else {
        commentsData.forEach(child => {
          const c = child.data;
          if (!c.body) return;
          htmlContent += `
                    <div class="reddit-comment-item" style="margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #f9f9f9;">
                        <div style="font-size:12px; color:#888; margin-bottom:4px; display:flex; justify-content:space-between;">
                            <span style="color: #1c1c1e; font-weight: 500;">${c.author}</span>
                            <span>${c.score} pts</span>
                        </div>
                        <div style="font-size:14px; line-height:1.5; color:#333;">${escapeHTML(c.body).replace(/\n/g, '<br>')}</div>
                    </div>
                `;
        });
      }

      contentEl.innerHTML = htmlContent;
      contentEl.scrollTop = 0;

    } catch (error) {
      console.error("Reddit Detail Error:", error);
      contentEl.innerHTML = `
            <div style="padding:20px; text-align:center;">
                <h3>Âä†ËΩΩÂ§±Ë¥•</h3>
                <p style="color:#888; font-size:14px;">${error.message}</p>
            </div>
        `;
    }
  }
  function renderRedditList(posts) {
    const listEl = document.getElementById('char-reddit-list');
    listEl.innerHTML = '';

    if (!posts || posts.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Êú™ÊâæÂà∞ÂÜÖÂÆπ</p>';
      return;
    }

    posts.forEach(child => {
      const post = child.data;

      // ÂõæÁâáÊèêÂèñÈÄªËæë
      let previewImage = '';
      if (post.preview && post.preview.images && post.preview.images.length > 0) {
        previewImage = post.preview.images[0].source.url.replace(/&amp;/g, '&');
      } else if (post.thumbnail && post.thumbnail.startsWith('http')) {
        previewImage = post.thumbnail;
      }

      const item = document.createElement('div');
      item.className = 'reddit-post-item';

      // ÂàÜÊï∞ÊòæÁ§∫‰ºòÂåñ
      const score = post.score > 1000 ? (post.score / 1000).toFixed(1) + 'k' : post.score;

      item.innerHTML = `
            <div class="reddit-vote-box">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #ff4500;">
                    <path d="M12 19V5M5 12l7-7 7 7"/>
                </svg>
                <span style="font-weight:bold; margin-top:2px;">${score}</span>
            </div>
            <div class="reddit-content-box">
                <div class="reddit-meta">
                    <div class="reddit-sub-icon"></div>
                    <strong>${post.subreddit_name_prefixed}</strong>
                    <span>‚Ä¢ u/${post.author}</span>
                </div>
                <div class="reddit-title">${post.title}</div>
                ${previewImage ? `<img src="${previewImage}" class="reddit-preview-img" loading="lazy">` : ''}
                
                <button class="reddit-forward-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    ËΩ¨ÂèëÁªôTA
                </button>
            </div>
        `;

      // ÁºìÂ≠òÊï∞ÊçÆ‰ª•‰æøËΩ¨Âèë‰ΩøÁî®
      if (!window.redditPostCache) window.redditPostCache = new Map();
      window.redditPostCache.set(post.id, post);

      // --- „ÄêÂÖ≥ÈîÆ‰øÆÊîπ 1„ÄëÁÇπÂáªÂç°ÁâáÊï¥‰Ωì -> ÊâìÂºÄËØ¶ÊÉÖÈ°µ ---
      item.addEventListener('click', () => {
        openRedditDetail(post);
      });

      // --- „ÄêÂÖ≥ÈîÆ‰øÆÊîπ 2„ÄëÁÇπÂáªËΩ¨ÂèëÊåâÈíÆ -> Ëß¶ÂèëËΩ¨Âèë (Âπ∂ÈòªÊ≠¢ÂÜíÊ≥°) ---
      const forwardBtn = item.querySelector('.reddit-forward-btn');
      forwardBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // ÈòªÊ≠¢Ëß¶ÂèëËØ¶ÊÉÖÈ°µË∑≥ËΩ¨
        forwardRedditPost(post.id); // Áõ¥Êé•Ë∞ÉÁî®ÂáΩÊï∞
      });

      listEl.appendChild(item);
    });
  }

  // [‰øÆÊîπ] ËΩ¨Âèë Reddit Â∏ñÂ≠ê (ÊîØÊåÅÈÄâ‰∫∫ + ‰∏çÁ´ãÂç≥ÂõûÂ§ç)
  // ÂèÇÊï∞: postId (‰ªéÂàóË°®ÁÇπÂáªÊó∂‰º†ÂÖ•), directData (‰ªéËØ¶ÊÉÖÈ°µÁÇπÂáªÊó∂Áõ¥Êé•‰º†ÂÖ•Êï∞ÊçÆÂØπË±°)
  async function forwardRedditPost(postId, directData = null) {
    // 1. Ëé∑ÂèñÂ∏ñÂ≠êÊï∞ÊçÆ
    let post;
    if (directData) {
      post = directData;
    } else {
      // ÂàóË°®Ê®°ÂºèÔºö‰ªéÁºìÂ≠òËé∑Âèñ
      if (!window.redditPostCache) window.redditPostCache = new Map();
      post = window.redditPostCache.get(postId);
    }

    if (!post) {
      alert("Êó†Ê≥ïËé∑ÂèñÂ∏ñÂ≠êÊï∞ÊçÆ");
      return;
    }

    // 2. ÂºπÂá∫ÈÄâÊã©Âô® (Â§çÁî®Áé∞ÊúâÁöÑ Share Picker)
    await openShareTargetPicker();

    const confirmBtn = document.getElementById('confirm-share-target-btn');

    // ‰ΩøÁî® cloneNode ÁßªÈô§ÊóßÁõëÂê¨Âô®ÔºåÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆö
    const newBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);

    newBtn.onclick = async () => {
      // 3. Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËÅäÂ§©ÂØπË±°
      const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
        .map(cb => cb.dataset.chatId);

      if (selectedTargetIds.length === 0) return alert("ËØ∑ÈÄâÊã©Ë¶ÅËΩ¨ÂèëÂà∞ÁöÑËÅäÂ§©„ÄÇ");

      // 4. ÊûÑÈÄ†Áî®Êà∑Âç°ÁâáÊ∂àÊÅØ (User View)
      const redditMsg = {
        role: 'user',
        type: 'reddit_share',
        timestamp: Date.now(),
        redditData: {
          title: post.title,
          subreddit: post.subreddit_name_prefixed,
          author: post.author,
          score: post.score,
          num_comments: post.num_comments,
          permalink: post.permalink,
          // Â§ÑÁêÜÂõæÁâáÈìæÊé•
          image: post.thumbnail || (post.preview && post.preview.images[0] ? post.preview.images[0].source.url.replace(/&amp;/g, '&') : null),
          selftext: post.selftext ? post.selftext.substring(0, 150) + '...' : ''
        }
      };

      document.getElementById('share-target-modal').classList.remove('visible');

      // 5. ÂêéÂè∞ÊäìÂèñÂÆåÊï¥ÂÜÖÂÆπ (Áªô AI Áúã) - ËøôÈÉ®ÂàÜÈúÄË¶Å‰∏ÄÁÇπÊó∂Èó¥
      // ‰∏∫‰∫Ü‰ΩìÈ™åÔºåÂÖàÊòæÁ§∫"Ê≠£Âú®ÂèëÈÄÅ"ÔºåÂÆûÈôÖ‰∏äÊòØÂêéÂè∞ÂºÇÊ≠•Â§ÑÁêÜ
      await showCustomAlert("ËΩ¨Âèë‰∏≠...", "Ê≠£Âú®ÁîüÊàêÈ¢ÑËßàÂπ∂ÂèëÈÄÅÔºåËØ∑Á®çÂÄô...");

      // ÊûÑÂª∫ AI ‰∏ä‰∏ãÊñá
      let fullContextForAI = `Ê†áÈ¢ò: "${post.title}"\nÊù•Ëá™: ${post.subreddit_name_prefixed}\n`;
      if (post.selftext) {
        fullContextForAI += `\n[ÂÜÖÂÆπÊëòË¶Å]: ${post.selftext.substring(0, 500)}...\n`;
      }

      // Â∞ùËØïÂºÇÊ≠•Ëé∑ÂèñÊõ¥Â§öËØ¶ÊÉÖ (ÂèØÈÄâ)
      try {
        const targetUrl = `https://www.reddit.com${post.permalink}.json?raw_json=1`;
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
        const res = await fetch(proxyUrl);
        if (res.ok) {
          const json = await res.json();
          const comments = json[1].data.children;
          // Ë°•ÂÖÖÂâç3Êù°ÁÉ≠ËØÑ
          if (comments.length > 0) {
            fullContextForAI += `\n[ÁÉ≠Èó®ËØÑËÆ∫ (Top 3)]:\n`;
            comments.slice(0, 3).forEach((c, i) => {
              if (c.data.body) {
                fullContextForAI += `${i + 1}. ${c.data.author}: ${c.data.body.substring(0, 150)}\n`;
              }
            });
          }
        }
      } catch (e) {
        console.warn("ÊäìÂèñËØ¶ÊÉÖÂ§±Ë¥•Ôºå‰ªÖ‰ΩøÁî®Âü∫Êú¨‰ø°ÊÅØ", e);
      }

      // 6. Âæ™ÁéØÂèëÈÄÅÁªôÈÄâ‰∏≠ÁöÑËÅäÂ§©
      for (const targetId of selectedTargetIds) {
        const targetChat = state.chats[targetId];
        if (targetChat) {
          // A. Êé®ÈÄÅÂç°ÁâáÊ∂àÊÅØ
          targetChat.history.push(redditMsg);

          // B. Êé®ÈÄÅÁ≥ªÁªüÊèêÁ§∫ (ÈöêËóèÊ∂àÊÅØÔºåÁªôAIÁúã)
          const hiddenSystemMsg = {
            role: 'system',
            content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ËΩ¨Âèë‰∫Ü‰∏Ä‰∏™ Reddit Â∏ñÂ≠êÁªô‰Ω†„ÄÇ
ËØ∑‰Ω†ÈòÖËØª‰ª•‰∏ãÂ∏ñÂ≠êËØ¶ÊÉÖÂíåÁΩëÂèãËØÑËÆ∫„ÄÇ
Ê≥®ÊÑèÔºö**Áî®Êà∑ËøòÊ≤°ÊúâÂØπÊ≠§ÂèëË°®ÁúãÊ≥ï**ÔºåTAÂèØËÉΩÊ≠£Âú®ÊâìÂ≠ó„ÄÇËØ∑‰Ω†**ÂÖà‰∏çË¶ÅÂõûÂ§ç**ÔºåËÄêÂøÉÁ≠âÂæÖÁî®Êà∑Êé•‰∏ãÊù•ÁöÑÊ∂àÊÅØ„ÄÇ
---
${fullContextForAI}
---]`,
            timestamp: Date.now() + 1,
            isHidden: true
          };
          targetChat.history.push(hiddenSystemMsg);
          await db.chats.put(targetChat);
        }
      }

      // 7. Ë∑≥ËΩ¨ÈÄªËæë
      // ÈöêËóèÊèêÁ§∫Ê°Ü
      document.querySelector('#custom-modal-overlay').classList.remove('visible');

      // Â¶ÇÊûúÂè™ÈÄâ‰∫Ü‰∏Ä‰∏™‰∫∫ÔºåÁõ¥Êé•Ë∑≥ËΩ¨Âà∞ÈÇ£‰∏™‰∫∫ÁöÑËÅäÂ§©Á™óÂè£
      if (selectedTargetIds.length === 1) {
        const targetId = selectedTargetIds[0];
        showScreen('chat-interface-screen'); // ÂàáÂà∞ËÅäÂ§©ÁïåÈù¢ÂÆπÂô®
        openChat(targetId); // Âä†ËΩΩÂÖ∑‰ΩìËÅäÂ§©

        // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÔºöËøôÈáå‰∏çÂÜçË∞ÉÁî® triggerAiResponse()
        // Âπ∂‰∏îËÆ©ËæìÂÖ•Ê°ÜËé∑ÂæóÁÑ¶ÁÇπÔºåÊñπ‰æøÁî®Êà∑ÁªßÁª≠ËØ¥ËØù
        setTimeout(() => {
          const input = document.getElementById('chat-input');
          if (input) input.focus();
        }, 500);

      } else {
        // Â¶ÇÊûúÈÄâ‰∫ÜÂ§ö‰∏™‰∫∫ÔºåÊèêÁ§∫ÂèëÈÄÅÊàêÂäüÂπ∂ÂÅúÁïôÂú®ÂΩìÂâçÈ°µÊàñÂõûÂàóË°®
        alert(`Â∑≤ËΩ¨ÂèëÁªô ${selectedTargetIds.length} ‰ΩçÂ•ΩÂèã„ÄÇ`);
      }
    };
  }
  window.forwardRedditPost = forwardRedditPost;
  // --- [Êõ¥Êñ∞Áâà] Ê†πÊçÆ‰∫∫ËÆæÁîüÊàê Reddit Êé®ËçêÊµÅ (ÊîØÊåÅ15-20‰∏™ÂÖ≥ÈîÆËØç + Á®≥ÂÆöÊêúÁ¥¢) ---
  async function handleGenerateSimulatedReddit() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê∑±Â∫¶ÂàÜÊûê‚Äú${chat.name}‚ÄùÁöÑÂÖ¥Ë∂£ÁΩëÁªú...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    // 1. ÂáÜÂ§á‰∏ä‰∏ãÊñáÊï∞ÊçÆ
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    // Á°Æ‰øù filterHistoryWithDoNotSendRules ÂèØÁî®ÔºåÂ¶ÇÊûúÊä•ÈîôËØ∑Ê£ÄÊü•ËØ•ÂáΩÊï∞ÊòØÂê¶ÂÆö‰πâ
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : 'Êó†';

    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„Äã:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    // 2. ÊûÑÂª∫ Prompt (‰øÆÊîπ‰∫ÜÊï∞ÈáèË¶ÅÊ±Ç)
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁî®Êà∑ÁîªÂÉèÂàÜÊûêÂ∏à„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÊ†πÊçÆTAÁöÑ‰∫∫ËÆæ„ÄÅÊâÄÂ§ÑÁöÑ‰∏ñÁïåËßÇ„ÄÅÈïøÊúüËÆ∞ÂøÜ„ÄÅ‰ª•Âèä‰∏éÁî®Êà∑Ôºà${userDisplayNameForAI}ÔºâÁöÑÊúÄËøë‰∫íÂä®Ôºå**Êé®ÊµãTAÁé∞Âú®ÊúÄÂèØËÉΩÂú® Reddit ‰∏äÊµèËßàÊàñÊêúÁ¥¢ÁöÑÂÖ≥ÈîÆËØç**„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **ËØ≠Ë®ÄÁ≠ñÁï•**: 
    - ËØ∑Ê†πÊçÆËßíËâ≤ÁöÑ‰∫∫ËÆæÂíåÊÉ≥ÁúãÁöÑÂÜÖÂÆπÂÜ≥ÂÆöËØ≠Ë®Ä„ÄÇ
    - Â¶ÇÊûúËßíËâ≤ÊÉ≥ÁúãÂõΩÈôÖÊñ∞Èóª„ÄÅÊäÄÊúØÊñáÊ°£„ÄÅËø∑Âõ† (Memes) ÊàñÁâπÂÆöÂ§ñËØ≠ÂÜÖÂÆπÔºåËØ∑ÁîüÊàê„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç„ÄÇ
    - Â¶ÇÊûúËßíËâ≤ÊÉ≥Áúã‰∏≠ÊñáÂúàÁöÑËÆ®ËÆ∫„ÄÅÂçéËØ≠Êñ∞ÈóªÊàñÁâπÂÆö‰∏≠ÊñáËØùÈ¢òÔºåËØ∑ÁîüÊàê„Äê‰∏≠Êñá„ÄëÂÖ≥ÈîÆËØç„ÄÇ
2.  **Ê∑±Â∫¶‰∫∫ËÆæÁªëÂÆö**: ÂÖ≥ÈîÆËØçÂøÖÈ°ªÁ¥ßÊâ£ËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÅå‰∏ö„ÄÅÁà±Â•Ω‰ª•Âèä**‰∏ñÁïåËßÇËÆæÂÆö**„ÄÇ
3.  **Â§öÊ†∑ÊÄß‰∏éÊï∞Èáè (ÂÖ≥ÈîÆ)**: ËØ∑ÁîüÊàê **15Âà∞20‰∏™** ‰∏çÂêåÁöÑÂÖ≥ÈîÆËØçÔºåÊ∂µÁõñËßíËâ≤ÂÖ¥Ë∂£ÁöÑÂêÑ‰∏™ÊñπÈù¢Ôºà‰ªéÊ†∏ÂøÉÁà±Â•ΩÂà∞ÊΩúÊÑèËØÜÁöÑÂ•ΩÂ•áÔºâ„ÄÇ
4.  **Ê†ºÂºèÈìÅÂæã**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™**Â≠óÁ¨¶‰∏≤**„ÄÇ
    - Á§∫‰æã: \`["keyword1", "r/China_irl", "coding help", "Áå´Âí™", ...]\`

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑËØ¶ÁªÜ‰∏ä‰∏ãÊñá
- **ËßíËâ≤‰∫∫ËÆæ**: ${chat.settings.aiPersona}
- **Áî®Êà∑(${userDisplayNameForAI})ÁöÑ‰∫∫ËÆæ**: ${chat.settings.myPersona || 'Êó†'}
- **ÈïøÊúüËÆ∞ÂøÜ**: 
${longTermMemoryContext}
${worldBookContext} 
- **ÊúÄËøëÂØπËØù**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÁîüÊàêËøôÁªÑËØ¶ÁªÜÁöÑ Reddit ÊêúÁ¥¢ÂÖ≥ÈîÆËØç„ÄÇ`;

    try {
      // 3. Ë∞ÉÁî® LLM
      const messagesForApi = [{ role: 'user', content: "ËØ∑ÁîüÊàêRedditÂÖ≥ÈîÆËØçÂàóË°®„ÄÇ" }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
          body: JSON.stringify({
            model: model,
            messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi],
            // ‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆÁöÑÊ∏©Â∫¶ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÈªòËÆ§ 1.0
            temperature: state.globalSettings.apiTemperature || 1.0,
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');

      let keywords;
      try {
        keywords = JSON.parse(cleanedJson);
      } catch (e) {
        throw new Error("AIËøîÂõûÊ†ºÂºèÈîôËØØÔºåÊó†Ê≥ïËß£ÊûêJSON");
      }

      if (!Array.isArray(keywords) || keywords.length === 0) throw new Error("AIÊ≤°ÊúâËøîÂõûÊúâÊïàÁöÑÂÖ≥ÈîÆËØçÊï∞ÁªÑ„ÄÇ");

      // 4. [Ê†∏ÂøÉ‰øÆÊîπ] ÈÄê‰∏™ÊêúÁ¥¢ÂÖ≥ÈîÆËØç (‰∏≤Ë°å+Âª∂ËøüÔºåÈò≤Ê≠¢Â∞ÅÂè∑)
      await showCustomAlert("ÊêúÁ¥¢‰∏≠...", `AI ÁîüÊàê‰∫Ü ${keywords.length} ‰∏™ÂÖ¥Ë∂£ÂÖ≥ÈîÆËØçÔºåÊ≠£Âú®ËÅöÂêàÂÖ®ÁΩëÂÜÖÂÆπ... (Ëøô‰∏ÄÊ≠•ÂèØËÉΩÈúÄË¶ÅÂçÅÂá†ÁßíÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ)`);

      const listEl = document.getElementById('char-reddit-list');
      listEl.innerHTML = '<div class="spinner" style="margin-top:50px;"></div>';

      // ‰∏çÂÜçÊà™Âèñ slice(0, 4)Ôºå‰ΩøÁî®ÂÖ®ÈÉ®ÂÖ≥ÈîÆËØç (keywords)
      const queries = keywords;
      let aggregatedPosts = [];

      // ÂÆö‰πâÂª∂Êó∂ÂáΩÊï∞
      const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

      // ÂÆö‰πâÂçï‰∏™ÊêúÁ¥¢ÂáΩÊï∞
      const fetchRedditData = async (query) => {
        try {
          let targetUrl;
          // ÈíàÂØπ r/xxx ‰ºòÂåñ
          if (query.startsWith('r/')) {
            // limit=5, Á®çÂæÆÂáèÂ∞ëÂçïÊ¨°ËØ∑Ê±ÇÈáèÔºåÂõ†‰∏∫Êàë‰ª¨ÊÄªËØ∑Ê±ÇÊ¨°Êï∞ÂèòÂ§ö‰∫Ü
            targetUrl = `https://www.reddit.com/${query}/hot.json?limit=5&raw_json=1`;
          } else {
            targetUrl = `https://www.reddit.com/search.json?q=${encodeURIComponent(query)}&limit=5&raw_json=1&sort=relevance`;
          }
          const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

          const res = await fetch(proxyUrl);
          if (!res.ok) return [];
          const json = await res.json();
          return json.data.children;
        } catch (e) {
          console.warn(`ÊêúÁ¥¢ÂÖ≥ÈîÆËØç ${query} Â§±Ë¥•:`, e);
          return [];
        }
      };

      // [‰øÆÊîπ] ‰ΩøÁî® for...of Âæ™ÁéØ‰∏≤Ë°åËØ∑Ê±ÇÔºåËÄå‰∏çÊòØ Promise.all Âπ∂Ë°å
      // ËøôÊ†∑ËôΩÁÑ∂ÊÖ¢‰∏ÄÁÇπÔºå‰ΩÜËÉΩ‰øùËØÅ 20 ‰∏™ËØçÈÉΩËÉΩÊêúÂÆåËÄå‰∏çÁÇ∏Êé•Âè£
      for (const [index, query] of queries.entries()) {
        // Âú®ÊéßÂà∂Âè∞ÊâìÂç∞ËøõÂ∫¶ÔºåÊñπ‰æøË∞ÉËØï
        console.log(`[RedditÁîüÊàêÊµÅ] Ê≠£Âú®ÊêúÁ¥¢ (${index + 1}/${queries.length}): ${query}`);

        const posts = await fetchRedditData(query);
        if (posts && posts.length > 0) {
          aggregatedPosts.push(...posts);
        }

        // ÊØèÊ¨°ËØ∑Ê±ÇÈó¥Èöî 600ms
        await delay(600);
      }

      if (aggregatedPosts.length === 0) {
        throw new Error("ÊâÄÊúâÂÖ≥ÈîÆËØçÈÉΩÊú™ËÉΩÊêúÁ¥¢Âà∞ÂÜÖÂÆπÔºåÂèØËÉΩÊòØÁΩëÁªúÈóÆÈ¢òÊàñÂÖ≥ÈîÆËØçÂ§™ÂÅèÈó®„ÄÇ");
      }

      // 5. ÂéªÈáç‰∏éÊâì‰π± (Ê¥óÁâåÁÆóÊ≥ï)
      const uniquePosts = [];
      const seenIds = new Set();

      // Ê¥óÁâå
      for (let i = aggregatedPosts.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [aggregatedPosts[i], aggregatedPosts[j]] = [aggregatedPosts[j], aggregatedPosts[i]];
      }

      // ÂéªÈáç
      aggregatedPosts.forEach(item => {
        const post = item.data;
        if (!seenIds.has(post.id)) {
          seenIds.add(post.id);
          uniquePosts.push(item);
        }
      });

      // Êà™ÂèñÂâç 30 Êù°ÊòæÁ§∫ (ÂëºÂ∫î‰Ω†‰πãÂâçÁöÑÈúÄÊ±Ç)
      const finalFeed = uniquePosts.slice(0, 30);

      // 6. ‰øùÂ≠òÊï∞ÊçÆÂà∞Êï∞ÊçÆÂ∫ì (ÊåÅ‰πÖÂåñ)
      chat.simulatedRedditFeed = finalFeed;
      await db.chats.put(chat);
      console.log(`Reddit Êé®ËçêÊµÅÂ∑≤‰øùÂ≠òÔºåÂÖ± ${finalFeed.length} Êù°`);

      // 7. Ê∏≤Êüì
      renderRedditList(finalFeed);

      // Êõ¥Êñ∞ÂºπÁ™óÊèêÁ§∫ÂÆåÊàê
      // (showCustomAlert ÈªòËÆ§ÊúâÁ°ÆËÆ§ÊåâÈíÆÔºå‰∏∫‰∫Ü‰ΩìÈ™åÂèØ‰ª•‰∏çÂºπÊñ∞ÁöÑÔºåÊàñËÄÖËá™Âä®ÂÖ≥Èó≠ÊóßÁöÑ)
      // ËøôÈáåÊàë‰ª¨Áõ¥Êé•ËÆ©ÁïåÈù¢ÊòæÁ§∫Âá∫Êù•Âç≥ÂèØ

    } catch (error) {
      console.error("ÁîüÊàê Reddit Êé®ËçêÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊé®ËçêÂÜÖÂÆπ„ÄÇ\nÈîôËØØ: ${error.message}`);
      // Â§±Ë¥•Êó∂ÂõûÈÄÄÂà∞ÁÉ≠Èó®
      handleRedditSearch('popular');
    }
  }
  async function init() {

    initLanguage();

    async function handleWorldBookImport(files) {
      if (!files || files.length === 0) return;

      try {
        // ÂàÜÁ¶ªJSONÊñá‰ª∂„ÄÅTXTÊñá‰ª∂„ÄÅZIPÊñá‰ª∂ÂíåDOCXÊñá‰ª∂
        const jsonFiles = [];
        const txtFiles = [];
        const zipFiles = [];
        const docxFiles = [];

        for (const file of files) {
          if (file.name.toLowerCase().endsWith('.json')) {
            jsonFiles.push(file);
          } else if (file.name.toLowerCase().endsWith('.txt')) {
            txtFiles.push(file);
          } else if (file.name.toLowerCase().endsWith('.zip')) {
            zipFiles.push(file);
          } else if (file.name.toLowerCase().endsWith('.docx')) {
            docxFiles.push(file);
          }
        }

        // Â§ÑÁêÜJSONÊñá‰ª∂Ôºà‰øùÊåÅÂéüÊúâÈÄªËæëÔºå‰ªÖÂ§ÑÁêÜÁ¨¨‰∏Ä‰∏™JSONÊñá‰ª∂Ôºâ
        if (jsonFiles.length > 0) {
          const file = jsonFiles[0];
          const text = await file.text();
          const data = JSON.parse(text);

          if (data.type === 'EPhoneWorldBookBackup') {
            console.log("Ê£ÄÊµãÂà∞ EPhone Â§á‰ªΩÊñá‰ª∂ÔºåÊâßË°åÊ†áÂáÜÂØºÂÖ•...");
            await importWorldBooks(data);
          } else if (data.entries && typeof data.entries === 'object') {
            console.log("Ê£ÄÊµãÂà∞ ‰∏ñÁïå‰π¶Êñá‰ª∂ÔºåÈúÄË¶ÅÊøÄÊ¥ªÁ†Å...");
            try {
              await requirePinActivation();
              await importTavernWorldBook(data, file.name);
            } catch (error) {
              console.warn("‰∏ñÁïå‰π¶ÂØºÂÖ•Ë¢´ÂèñÊ∂à:", error.message);
            }
          } else {
            throw new Error("Êñá‰ª∂Ê†ºÂºèÊó†Ê≥ïËØÜÂà´„ÄÇËØ∑Á°Æ‰øùÊÇ®ÈÄâÊã©ÁöÑÊòØÊúâÊïàÁöÑ EPhone ‰∏ñÁïå‰π¶Â§á‰ªΩÊàñ Tavern AI ‰∏ñÁïå‰π¶Êñá‰ª∂„ÄÇ");
          }
        }

        // Â§ÑÁêÜTXTÊñá‰ª∂
        if (txtFiles.length > 0) {
          await handleTxtWorldBookImport(txtFiles);
        }

        // Â§ÑÁêÜDOCXÊñá‰ª∂
        if (docxFiles.length > 0) {
          await handleDocxWorldBookImport(docxFiles);
        }

        // Â§ÑÁêÜZIPÊñá‰ª∂
        if (zipFiles.length > 0) {
          await handleZipWorldBookImport(zipFiles);
        }

      } catch (error) {
        console.error("ÂØºÂÖ•‰∏ñÁïå‰π¶Êó∂Âá∫Èîô:", error);
        await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ëß£ÊûêÊàñÂ∫îÁî®Â§±Ë¥•: ${error.message}`);
      }
    }

    // Êñ∞Â¢ûÔºöÂ§ÑÁêÜTXTÊñá‰ª∂ÂØºÂÖ•
    async function handleTxtWorldBookImport(txtFiles) {
      try {
        // ËØªÂèñÊâÄÊúâTXTÊñá‰ª∂ÁöÑÂÜÖÂÆπ
        const fileContents = await Promise.all(
          txtFiles.map(async (file) => ({
            name: file.name,
            content: await file.text()
          }))
        );

        // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°ÜËÆ©Áî®Êà∑ÈÄâÊã©Ë¶ÅÂØºÂÖ•ÁöÑÊñá‰ª∂
        const selectedFiles = await showTxtImportConfirmModal(fileContents);

        if (!selectedFiles || selectedFiles.length === 0) {
          return;
        }

        // ‰∏∫ÊØè‰∏™ÈÄâ‰∏≠ÁöÑTXTÊñá‰ª∂ÂàõÂª∫‰∏ÄÊú¨‰∏ñÁïå‰π¶
        let importedCount = 0;
        for (const fileData of selectedFiles) {
          const bookName = fileData.name.replace(/\.txt$/i, '');

          const newWorldBook = {
            id: 'wb_txt_' + Date.now() + '_' + importedCount,
            name: bookName,
            content: [{
              keys: [],
              comment: 'Áî±TXTÊñá‰ª∂ÂØºÂÖ•',
              content: fileData.content.trim(),
              enabled: true
            }],
            categoryId: null
          };

          await db.worldBooks.add(newWorldBook);
          state.worldBooks.push(newWorldBook);
          importedCount++;

          // Ê∑ªÂä†Â∞èÂª∂ËøüÁ°Æ‰øùIDÂîØ‰∏Ä
          await new Promise(resolve => setTimeout(resolve, 10));
        }

        await renderWorldBookScreen();
        await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `ÊàêÂäüÂØºÂÖ• ${importedCount} ‰∏™TXTÊñá‰ª∂Âà∞‰∏ñÁïå‰π¶ÔºÅ`);

      } catch (error) {
        console.error("TXTÊñá‰ª∂ÂØºÂÖ•Â§±Ë¥•:", error);
        await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `TXTÊñá‰ª∂ÂØºÂÖ•Â§±Ë¥•: ${error.message}`);
      }
    }

    // ÊòæÁ§∫TXTÊñá‰ª∂ÂØºÂÖ•Á°ÆËÆ§ÂØπËØùÊ°Ü
    function showTxtImportConfirmModal(fileContents) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <h2 style="margin-top: 0;">Á°ÆËÆ§ÂØºÂÖ•TXTÊñá‰ª∂</h2>
            <p style="color: #666; margin-bottom: 15px;">
              ÊâæÂà∞ ${fileContents.length} ‰∏™TXTÊñá‰ª∂ÔºåËØ∑ÈÄâÊã©Ë¶ÅÂØºÂÖ•ÁöÑÊñá‰ª∂Ôºö
            </p>
            <div style="flex: 1; overflow-y: auto; margin-bottom: 20px;">
              ${fileContents.map((file, index) => `
                <div style="margin-bottom: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                  <label style="display: flex; align-items: start; cursor: pointer;">
                    <input type="checkbox" class="txt-import-checkbox" data-index="${index}" 
                           style="margin-right: 10px; margin-top: 3px;" checked>
                    <div style="flex: 1;">
                      <div style="font-weight: bold; margin-bottom: 8px;">${escapeHTML(file.name)}</div>
                      <div style="font-size: 12px; color: #666; max-height: 100px; overflow: auto; 
                                  white-space: pre-wrap; word-break: break-word; 
                                  background: white; padding: 8px; border-radius: 4px;">
                        ${escapeHTML(file.content.substring(0, 200))}${file.content.length > 200 ? '...' : ''}
                      </div>
                      <div style="font-size: 11px; color: #999; margin-top: 5px;">
                        Êñá‰ª∂Â§ßÂ∞è: ${(file.content.length / 1024).toFixed(2)} KB
                      </div>
                    </div>
                  </label>
                </div>
              `).join('')}
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button id="txt-import-select-all" style="padding: 10px 20px; background: #666; color: white; 
                      border: none; border-radius: 5px; cursor: pointer;">ÂÖ®ÈÄâ</button>
              <button id="txt-import-cancel" style="padding: 10px 20px; background: #ccc; color: #333; 
                      border: none; border-radius: 5px; cursor: pointer;">ÂèñÊ∂à</button>
              <button id="txt-import-confirm" style="padding: 10px 20px; background: #007aff; color: white; 
                      border: none; border-radius: 5px; cursor: pointer;">Á°ÆËÆ§ÂØºÂÖ•</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        const checkboxes = modal.querySelectorAll('.txt-import-checkbox');

        // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâÊåâÈíÆ
        const selectAllBtn = modal.querySelector('#txt-import-select-all');
        let allSelected = true;
        selectAllBtn.addEventListener('click', () => {
          allSelected = !allSelected;
          checkboxes.forEach(cb => cb.checked = allSelected);
          selectAllBtn.textContent = allSelected ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÄâ';
        });

        // ÂèñÊ∂àÊåâÈíÆ
        modal.querySelector('#txt-import-cancel').addEventListener('click', () => {
          document.body.removeChild(modal);
          resolve(null);
        });

        // Á°ÆËÆ§ÊåâÈíÆ
        modal.querySelector('#txt-import-confirm').addEventListener('click', () => {
          const selected = [];
          checkboxes.forEach(cb => {
            if (cb.checked) {
              const index = parseInt(cb.dataset.index);
              selected.push(fileContents[index]);
            }
          });

          document.body.removeChild(modal);

          if (selected.length === 0) {
            showCustomAlert('ÊèêÁ§∫', 'ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂ËøõË°åÂØºÂÖ•');
            resolve(null);
          } else {
            resolve(selected);
          }
        });

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
            resolve(null);
          }
        });
      });
    }

    // Êñ∞Â¢ûÔºöÂ§ÑÁêÜDOCXÊñá‰ª∂ÂØºÂÖ•
    async function handleDocxWorldBookImport(docxFiles) {
      try {
        // Ê£ÄÊü•mammothÊòØÂê¶ÂèØÁî®
        if (typeof mammoth === 'undefined') {
          throw new Error('mammothÂ∫ìÊú™Âä†ËΩΩÔºåÊó†Ê≥ïËß£ÊûêDOCXÊñá‰ª∂');
        }

        // ËØªÂèñÊâÄÊúâDOCXÊñá‰ª∂ÁöÑÂÜÖÂÆπ
        const fileContents = await Promise.all(
          docxFiles.map(async (file) => {
            try {
              const arrayBuffer = await file.arrayBuffer();
              const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
              return {
                name: file.name,
                content: result.value
              };
            } catch (error) {
              console.error('Ëß£ÊûêDOCXÊñá‰ª∂Â§±Ë¥•:', file.name, error);
              return null;
            }
          })
        );

        // ËøáÊª§ÊéâËß£ÊûêÂ§±Ë¥•ÁöÑÊñá‰ª∂
        const validFiles = fileContents.filter(f => f !== null && f.content);

        if (validFiles.length === 0) {
          await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', 'Êó†Ê≥ïËß£Êûê‰ªª‰ΩïDOCXÊñá‰ª∂');
          return;
        }

        // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°ÜËÆ©Áî®Êà∑ÈÄâÊã©Ë¶ÅÂØºÂÖ•ÁöÑÊñá‰ª∂
        const selectedFiles = await showDocxImportConfirmModal(validFiles);

        if (!selectedFiles || selectedFiles.length === 0) {
          return;
        }

        // ‰∏∫ÊØè‰∏™ÈÄâ‰∏≠ÁöÑDOCXÊñá‰ª∂ÂàõÂª∫‰∏ÄÊú¨‰∏ñÁïå‰π¶
        let importedCount = 0;
        for (const fileData of selectedFiles) {
          const bookName = fileData.name.replace(/\.docx$/i, '');

          const newWorldBook = {
            id: 'wb_docx_' + Date.now() + '_' + importedCount,
            name: bookName,
            content: [{
              keys: [],
              comment: 'Áî±DOCXÊñá‰ª∂ÂØºÂÖ•',
              content: fileData.content.trim(),
              enabled: true
            }],
            categoryId: null
          };

          await db.worldBooks.add(newWorldBook);
          state.worldBooks.push(newWorldBook);
          importedCount++;

          // Ê∑ªÂä†Â∞èÂª∂ËøüÁ°Æ‰øùIDÂîØ‰∏Ä
          await new Promise(resolve => setTimeout(resolve, 10));
        }

        await renderWorldBookScreen();
        await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `ÊàêÂäüÂØºÂÖ• ${importedCount} ‰∏™DOCXÊñá‰ª∂Âà∞‰∏ñÁïå‰π¶ÔºÅ`);

      } catch (error) {
        console.error('DOCXÊñá‰ª∂ÂØºÂÖ•Â§±Ë¥•:', error);
        await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `DOCXÊñá‰ª∂ÂØºÂÖ•Â§±Ë¥•: ${error.message}`);
      }
    }

    // ÊòæÁ§∫DOCXÊñá‰ª∂ÂØºÂÖ•Á°ÆËÆ§ÂØπËØùÊ°Ü
    function showDocxImportConfirmModal(fileContents) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <h2 style="margin-top: 0;">Á°ÆËÆ§ÂØºÂÖ•DOCXÊñá‰ª∂</h2>
            <p style="color: #666; margin-bottom: 15px;">
              ÊâæÂà∞ ${fileContents.length} ‰∏™DOCXÊñá‰ª∂ÔºåËØ∑ÈÄâÊã©Ë¶ÅÂØºÂÖ•ÁöÑÊñá‰ª∂Ôºö
            </p>
            <div style="flex: 1; overflow-y: auto; margin-bottom: 20px;">
              ${fileContents.map((file, index) => `
                <div style="margin-bottom: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                  <label style="display: flex; align-items: start; cursor: pointer;">
                    <input type="checkbox" class="docx-import-checkbox" data-index="${index}" 
                           style="margin-right: 10px; margin-top: 3px;" checked>
                    <div style="flex: 1;">
                      <div style="font-weight: bold; margin-bottom: 8px;">${escapeHTML(file.name)}</div>
                      <div style="font-size: 12px; color: #666; max-height: 100px; overflow: auto; 
                                  white-space: pre-wrap; word-break: break-word; 
                                  background: white; padding: 8px; border-radius: 4px;">
                        ${escapeHTML(file.content.substring(0, 200))}${file.content.length > 200 ? '...' : ''}
                      </div>
                      <div style="font-size: 11px; color: #999; margin-top: 5px;">
                        Êñá‰ª∂Â§ßÂ∞è: ${(file.content.length / 1024).toFixed(2)} KB
                      </div>
                    </div>
                  </label>
                </div>
              `).join('')}
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button id="docx-import-select-all" style="padding: 10px 20px; background: #666; color: white; 
                      border: none; border-radius: 5px; cursor: pointer;">ÂÖ®ÈÄâ</button>
              <button id="docx-import-cancel" style="padding: 10px 20px; background: #ccc; color: #333; 
                      border: none; border-radius: 5px; cursor: pointer;">ÂèñÊ∂à</button>
              <button id="docx-import-confirm" style="padding: 10px 20px; background: #007aff; color: white; 
                      border: none; border-radius: 5px; cursor: pointer;">Á°ÆËÆ§ÂØºÂÖ•</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        const checkboxes = modal.querySelectorAll('.docx-import-checkbox');

        // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâÊåâÈíÆ
        const selectAllBtn = modal.querySelector('#docx-import-select-all');
        let allSelected = true;
        selectAllBtn.addEventListener('click', () => {
          allSelected = !allSelected;
          checkboxes.forEach(cb => cb.checked = allSelected);
          selectAllBtn.textContent = allSelected ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÄâ';
        });

        // ÂèñÊ∂àÊåâÈíÆ
        modal.querySelector('#docx-import-cancel').addEventListener('click', () => {
          document.body.removeChild(modal);
          resolve(null);
        });

        // Á°ÆËÆ§ÊåâÈíÆ
        modal.querySelector('#docx-import-confirm').addEventListener('click', () => {
          const selected = [];
          checkboxes.forEach(cb => {
            if (cb.checked) {
              const index = parseInt(cb.dataset.index);
              selected.push(fileContents[index]);
            }
          });

          document.body.removeChild(modal);

          if (selected.length === 0) {
            showCustomAlert('ÊèêÁ§∫', 'ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂ËøõË°åÂØºÂÖ•');
            resolve(null);
          } else {
            resolve(selected);
          }
        });

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
            resolve(null);
          }
        });
      });
    }

    // Êñ∞Â¢ûÔºöÂ§ÑÁêÜZIPÊñá‰ª∂ÂØºÂÖ•
    async function handleZipWorldBookImport(zipFiles) {
      try {
        // Ê£ÄÊü•JSZipÊòØÂê¶ÂèØÁî®
        if (typeof JSZip === 'undefined') {
          throw new Error('JSZipÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
        }

        let allExtractedFiles = [];

        // Â§ÑÁêÜÊâÄÊúâZIPÊñá‰ª∂
        for (const zipFile of zipFiles) {
          console.log('Ê≠£Âú®Â§ÑÁêÜZIPÊñá‰ª∂:', zipFile.name);

          const zip = await JSZip.loadAsync(zipFile);
          const zipFileName = zipFile.name.replace(/\.zip$/i, '');

          // ÈÅçÂéÜZIP‰∏≠ÁöÑÊâÄÊúâÊñá‰ª∂
          for (const [filename, file] of Object.entries(zip.files)) {
            // Ë∑≥ËøáÁõÆÂΩïÂíåJSONÊñá‰ª∂
            if (file.dir) continue;

            const lowerFilename = filename.toLowerCase();

            // Âè™Â§ÑÁêÜTXTÂíåDOCXÊñá‰ª∂ÔºåÂøΩÁï•JSONÊñá‰ª∂
            if (lowerFilename.endsWith('.json')) {
              console.log('Ë∑≥ËøáJSONÊñá‰ª∂:', filename);
              continue;
            }

            if (lowerFilename.endsWith('.txt')) {
              // Â§ÑÁêÜTXTÊñá‰ª∂
              const content = await file.async('text');
              allExtractedFiles.push({
                name: filename,
                content: content,
                type: 'txt',
                zipName: zipFileName
              });
              console.log('ÊèêÂèñTXTÊñá‰ª∂:', filename);

            } else if (lowerFilename.endsWith('.docx')) {
              // Â§ÑÁêÜDOCXÊñá‰ª∂
              try {
                const arrayBuffer = await file.async('arraybuffer');

                // ‰ΩøÁî®mammothËß£ÊûêDOCX
                if (typeof mammoth !== 'undefined') {
                  const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                  allExtractedFiles.push({
                    name: filename,
                    content: result.value,
                    type: 'docx',
                    zipName: zipFileName
                  });
                  console.log('ÊèêÂèñDOCXÊñá‰ª∂:', filename);
                } else {
                  console.warn('mammothÂ∫ìÊú™Âä†ËΩΩÔºåÊó†Ê≥ïËß£ÊûêDOCXÊñá‰ª∂:', filename);
                }
              } catch (error) {
                console.error('Ëß£ÊûêDOCXÊñá‰ª∂Â§±Ë¥•:', filename, error);
              }
            }
          }
        }

        if (allExtractedFiles.length === 0) {
          await showCustomAlert('ÊèêÁ§∫', 'ZIPÊñá‰ª∂‰∏≠Ê≤°ÊúâÊâæÂà∞ÂèØÂØºÂÖ•ÁöÑTXTÊàñDOCXÊñá‰ª∂ÔºàJSONÊñá‰ª∂Â∑≤Ë¢´ÂøΩÁï•Ôºâ');
          return;
        }

        console.log('‰ªéZIP‰∏≠ÊèêÂèñÁöÑÊñá‰ª∂ÊÄªÊï∞:', allExtractedFiles.length);

        // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°ÜËÆ©Áî®Êà∑ÈÄâÊã©Ë¶ÅÂØºÂÖ•ÁöÑÊñá‰ª∂
        const selectedFiles = await showZipImportConfirmModal(allExtractedFiles);

        if (!selectedFiles || selectedFiles.length === 0) {
          return;
        }

        // ‰∏∫ÊØè‰∏™ÈÄâ‰∏≠ÁöÑÊñá‰ª∂ÂàõÂª∫‰∏ÄÊú¨‰∏ñÁïå‰π¶
        let importedCount = 0;
        for (const fileData of selectedFiles) {
          const bookName = fileData.name.replace(/\.(txt|docx)$/i, '');

          const newWorldBook = {
            id: 'wb_zip_' + Date.now() + '_' + importedCount,
            name: `${bookName} (Êù•Ëá™${fileData.zipName})`,
            content: [{
              keys: [],
              comment: `Áî±ZIPÊñá‰ª∂‰∏≠ÁöÑ${fileData.type.toUpperCase()}Êñá‰ª∂ÂØºÂÖ•`,
              content: fileData.content.trim(),
              enabled: true
            }],
            categoryId: null
          };

          await db.worldBooks.add(newWorldBook);
          state.worldBooks.push(newWorldBook);
          importedCount++;

          // Ê∑ªÂä†Â∞èÂª∂ËøüÁ°Æ‰øùIDÂîØ‰∏Ä
          await new Promise(resolve => setTimeout(resolve, 10));
        }

        await renderWorldBookScreen();
        await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `ÊàêÂäü‰ªéZIPÊñá‰ª∂ÂØºÂÖ• ${importedCount} ‰∏™‰∏ñÁïå‰π¶ÔºÅ`);

      } catch (error) {
        console.error('ZIPÊñá‰ª∂ÂØºÂÖ•Â§±Ë¥•:', error);
        await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `ZIPÊñá‰ª∂ÂØºÂÖ•Â§±Ë¥•: ${error.message}`);
      }
    }

    // ÊòæÁ§∫ZIPÊñá‰ª∂ÂØºÂÖ•Á°ÆËÆ§ÂØπËØùÊ°Ü
    function showZipImportConfirmModal(fileContents) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <h2 style="margin-top: 0;">Á°ÆËÆ§‰ªéZIPÂØºÂÖ•Êñá‰ª∂</h2>
            <p style="color: #666; margin-bottom: 15px;">
              ‰ªéZIPÊñá‰ª∂‰∏≠ÊâæÂà∞ ${fileContents.length} ‰∏™ÂèØÂØºÂÖ•Êñá‰ª∂ÔºàTXT/DOCXÔºâÔºåËØ∑ÈÄâÊã©Ë¶ÅÂØºÂÖ•ÁöÑÊñá‰ª∂Ôºö
            </p>
            <div style="flex: 1; overflow-y: auto; margin-bottom: 20px;">
              ${fileContents.map((file, index) => `
                <div style="margin-bottom: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                  <label style="display: flex; align-items: start; cursor: pointer;">
                    <input type="checkbox" class="zip-import-checkbox" data-index="${index}" 
                           style="margin-right: 10px; margin-top: 3px;" checked>
                    <div style="flex: 1;">
                      <div style="font-weight: bold; margin-bottom: 8px;">
                        ${escapeHTML(file.name)}
                        <span style="background: #007aff; color: white; padding: 2px 6px; border-radius: 3px; 
                                     font-size: 10px; margin-left: 8px;">${file.type.toUpperCase()}</span>
                      </div>
                      <div style="font-size: 11px; color: #999; margin-bottom: 5px;">
                        Êù•Ëá™: ${escapeHTML(file.zipName)}.zip
                      </div>
                      <div style="font-size: 12px; color: #666; max-height: 100px; overflow: auto; 
                                  white-space: pre-wrap; word-break: break-word; 
                                  background: white; padding: 8px; border-radius: 4px;">
                        ${escapeHTML(file.content.substring(0, 200))}${file.content.length > 200 ? '...' : ''}
                      </div>
                      <div style="font-size: 11px; color: #999; margin-top: 5px;">
                        Êñá‰ª∂Â§ßÂ∞è: ${(file.content.length / 1024).toFixed(2)} KB
                      </div>
                    </div>
                  </label>
                </div>
              `).join('')}
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button id="zip-import-select-all" style="padding: 10px 20px; background: #666; color: white; 
                      border: none; border-radius: 5px; cursor: pointer;">ÂÖ®ÈÄâ</button>
              <button id="zip-import-cancel" style="padding: 10px 20px; background: #ccc; color: #333; 
                      border: none; border-radius: 5px; cursor: pointer;">ÂèñÊ∂à</button>
              <button id="zip-import-confirm" style="padding: 10px 20px; background: #007aff; color: white; 
                      border: none; border-radius: 5px; cursor: pointer;">Á°ÆËÆ§ÂØºÂÖ•</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        const checkboxes = modal.querySelectorAll('.zip-import-checkbox');

        // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâÊåâÈíÆ
        const selectAllBtn = modal.querySelector('#zip-import-select-all');
        let allSelected = true;
        selectAllBtn.addEventListener('click', () => {
          allSelected = !allSelected;
          checkboxes.forEach(cb => cb.checked = allSelected);
          selectAllBtn.textContent = allSelected ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÄâ';
        });

        // ÂèñÊ∂àÊåâÈíÆ
        modal.querySelector('#zip-import-cancel').addEventListener('click', () => {
          document.body.removeChild(modal);
          resolve(null);
        });

        // Á°ÆËÆ§ÊåâÈíÆ
        modal.querySelector('#zip-import-confirm').addEventListener('click', () => {
          const selected = [];
          checkboxes.forEach(cb => {
            if (cb.checked) {
              const index = parseInt(cb.dataset.index);
              selected.push(fileContents[index]);
            }
          });

          document.body.removeChild(modal);

          if (selected.length === 0) {
            showCustomAlert('ÊèêÁ§∫', 'ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂ËøõË°åÂØºÂÖ•');
            resolve(null);
          } else {
            resolve(selected);
          }
        });

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
            resolve(null);
          }
        });
      });
    }


    async function importTavernWorldBook(tavernData, fileName) {
      const bookNameSuggestion = fileName.replace(/\.json$/i, '');

      const newBookName = await showCustomPrompt(
        "ÂØºÂÖ• Tavern AI ‰∏ñÁïå‰π¶",
        "ËØ∑‰∏∫ËøôÊú¨ËÆæÂÆöÈõÜÂëΩÂêçÔºö",
        bookNameSuggestion
      );

      if (!newBookName || !newBookName.trim()) {
        alert("ÂØºÂÖ•Â∑≤ÂèñÊ∂àÔºåÂõ†‰∏∫Êú™Êèê‰æõ‰π¶Âêç„ÄÇ");
        return;
      }

      const newEntries = Object.values(tavernData.entries).map(entry => {

        return {
          keys: entry.key || [],
          comment: entry.comment || 'Êó†Â§áÊ≥®',
          content: entry.content || '',
          enabled: !entry.disable
        };
      }).filter(entry => entry.content);

      if (newEntries.length === 0) {
        alert("Ëøô‰∏™ Tavern AI ‰∏ñÁïå‰π¶‰∏≠Ê≤°ÊúâÊâæÂà∞‰ªª‰ΩïÊúâÊïàÁöÑÊù°ÁõÆ„ÄÇ");
        return;
      }

      const newWorldBook = {
        id: 'wb_' + Date.now(),
        name: newBookName.trim(),
        content: newEntries,
        categoryId: null
      };

      await db.worldBooks.add(newWorldBook);
      state.worldBooks.push(newWorldBook);
      await renderWorldBookScreen();

      await showCustomAlert('ÂØºÂÖ•ÊàêÂäüÔºÅ', `Â∑≤ÊàêÂäü‰ªé Tavern AI Êñá‰ª∂ÂØºÂÖ•ËÆæÂÆöÈõÜ„Ää${newBookName}„Äã„ÄÇ`);
    }


    async function exportWorldBooks() {
      try {
        const books = await db.worldBooks.toArray();
        const categories = await db.worldBookCategories.toArray();

        if (books.length === 0 && categories.length === 0) {
          alert("Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑ‰∏ñÁïå‰π¶Êï∞ÊçÆ„ÄÇ");
          return;
        }

        const backupData = {
          type: 'EPhoneWorldBookBackup',
          version: 1,
          timestamp: Date.now(),
          books: books,
          categories: categories
        };

        const blob = new Blob(
          [JSON.stringify(backupData, null, 2)], {
          type: 'application/json'
        }
        );
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `EPhone-WorldBooks-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);

        await showCustomAlert('ÂØºÂá∫ÊàêÂäü', 'ÊâÄÊúâ‰∏ñÁïå‰π¶Êï∞ÊçÆÂ∑≤ÊàêÂäüÂØºÂá∫ÔºÅ');

      } catch (error) {
        console.error("ÂØºÂá∫‰∏ñÁïå‰π¶Êó∂Âá∫Èîô:", error);
        await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
      }
    }


    async function importWorldBooks(data) {

      try {
        if (data.type !== 'EPhoneWorldBookBackup' || !data.books) {
          throw new Error("Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËøô‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑ‰∏ñÁïå‰π¶Â§á‰ªΩÊñá‰ª∂„ÄÇ");
        }

        const confirmed = await showCustomConfirm(
          'ÂØºÂÖ•‰∏ñÁïå‰π¶',
          'ËøôÂ∞ÜÁî®Êñá‰ª∂‰∏≠ÁöÑÊï∞ÊçÆ„ÄêÂÆåÂÖ®Ë¶ÜÁõñ„ÄëÊÇ®ÂΩìÂâçÊâÄÊúâÁöÑ‰∏ñÁïå‰π¶ÂíåÂàÜÁ±ª„ÄÇÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ', {
          confirmButtonClass: 'btn-danger',
          confirmText: 'Á°ÆËÆ§Ë¶ÜÁõñ'
        }
        );

        if (!confirmed) return;

        await db.transaction('rw', db.worldBooks, db.worldBookCategories, async () => {
          await db.worldBooks.clear();
          await db.worldBookCategories.clear();

          if (Array.isArray(data.books)) {
            await db.worldBooks.bulkPut(data.books);
          }
          if (Array.isArray(data.categories)) {
            await db.worldBookCategories.bulkPut(data.categories);
          }
        });


        state.worldBooks = await db.worldBooks.toArray();
        await renderWorldBookScreen();

        await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', '‰∏ñÁïå‰π¶Êï∞ÊçÆÂ∑≤ÊàêÂäüÊÅ¢Â§çÔºÅ');

      } catch (error) {
        console.error("ÂØºÂÖ•‰∏ñÁïå‰π¶Êó∂Âá∫Èîô:", error);
        await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ëß£ÊûêÊàñÂ∫îÁî®Â§±Ë¥•: ${error.message}`);
      }
    }



    const lastActiveTimestamp = localStorage.getItem('ephoneLastActiveTimestamp');
    if (lastActiveTimestamp) {
      const minutesOffline = (Date.now() - parseInt(lastActiveTimestamp)) / (1000 * 60);

      if (minutesOffline > 5) {


        simulateBackgroundActivity(minutesOffline);
      }
    }

    setupCharPlayerControls();

    window.showScreen = showScreen;
    window.openRenderingRulesScreen = openRenderingRulesScreen;
    window.handleListenTogetherClick = handleListenTogetherClick;

    window.openCharacterSelector = openCharacterSelector;
    window.openCharApp = openCharApp;
    window.switchToMyPhone = switchToMyPhone;
    window.openCharWallet = openCharWallet;
    window.switchToCharHomeScreen = switchToCharHomeScreen;
    window.openNpcEditor = openNpcEditor;

    // MY Phone ÂáΩÊï∞Êö¥Èú≤
    window.openMyphoneScreen = openMyphoneScreen;
    window.openMyPhoneApp = openMyPhoneApp;
    window.switchToMyPhoneHomeScreen = switchToMyPhoneHomeScreen;
    window.switchToCPhone = switchToCPhone;
    window.openMyPhoneSettings = openMyPhoneSettings;
    window.openMyPhoneViewRecords = openMyPhoneViewRecords;
    window.showMyPhoneAddContactDialog = showMyPhoneAddContactDialog;
    window.manualCreateMyPhoneContact = manualCreateMyPhoneContact;
    window.showImportMainScreenCharacters = showImportMainScreenCharacters;
    window.updateImportSelectAllState = updateImportSelectAllState;
    window.importSelectedCharacters = importSelectedCharacters;
    window.openMyPhoneContactSettings = openMyPhoneContactSettings;
    window.saveMyPhoneContactSettings = saveMyPhoneContactSettings;
    window.changeMyPhoneContactAvatar = changeMyPhoneContactAvatar;
    window.addMyPhoneMessage = addMyPhoneMessage;
    window.showMyPhoneTransferActionModal = showMyPhoneTransferActionModal;
    window.handleMyPhoneTransferResponse = handleMyPhoneTransferResponse;



    const stickerActionBar = document.createElement('div');
    stickerActionBar.id = 'sticker-action-bar';
    stickerActionBar.innerHTML = `
       <input type="checkbox" id="select-all-stickers-checkbox" style="margin-right: 10px;">
      <button id="delete-selected-stickers-btn" class="form-button-secondary">Âà†Èô§ (0)</button>
   `;
    document.getElementById('sticker-panel').appendChild(stickerActionBar);
    const exportStickersBtn = document.createElement('button');
    exportStickersBtn.id = 'export-selected-stickers-btn';
    exportStickersBtn.textContent = 'ÂØºÂá∫ (0)';
    exportStickersBtn.className = 'form-button'; // ‰ΩøÁî®‰∏ªÊåâÈíÆÊ†∑Âºè
    exportStickersBtn.style.marginLeft = '10px';

    stickerActionBar.appendChild(exportStickersBtn);

    exportStickersBtn.addEventListener('click', executeBatchExportStickers);
    const globalCssStyleTag = document.createElement('style');
    globalCssStyleTag.id = 'global-custom-style';
    document.head.appendChild(globalCssStyleTag);


    qzoneStickerPanelState.panelEl = document.getElementById('qzone-sticker-panel');
    qzoneStickerPanelState.gridEl = document.getElementById('qzone-sticker-grid');

    const savedTheme = localStorage.getItem('ephone-theme') || 'light';
    applyTheme(savedTheme);



    const customBubbleStyleTag = document.createElement('style');
    customBubbleStyleTag.id = 'custom-bubble-style';
    document.head.appendChild(customBubbleStyleTag);



    const previewBubbleStyleTag = document.createElement('style');
    previewBubbleStyleTag.id = 'preview-bubble-style';
    document.head.appendChild(previewBubbleStyleTag);




    applyScopedCss('', '#chat-messages', 'custom-bubble-style');
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style');

    window.openRenderingRulesScreen = openRenderingRulesScreen;
    window.showScreen = showScreen;
    window.renderChatListProxy = renderChatList;
    window.renderApiSettingsProxy = renderApiSettings;
    window.renderWallpaperScreenProxy = renderWallpaperScreen;
    window.renderWorldBookScreenProxy = renderWorldBookScreen;

    await loadAllDataFromDB();
    await initFunds();

    // ÂàùÂßãÂåñÊèêÁ§∫ËØçÁÆ°ÁêÜÂô®
    if (typeof initPromptManagerUI === 'function') {
      initPromptManagerUI();
    }

    applyStatusBarVisibility();
    applyPhoneFrame(state.globalSettings.showPhoneFrame);
    applyDetachStatusBarMode(state.globalSettings.detachStatusBar);
    applyMinimalChatUI(state.globalSettings.enableMinimalChatUI);
    await migrateOldRedPacketData();


    applyGlobalCss(state.globalSettings.globalCss);



    const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
    updateUnreadIndicator(storedCount);



    if (state.globalSettings && (state.globalSettings.fontUrl || (state.globalSettings.globalFontSize && state.globalSettings.globalFontSize !== 16))) {
      applyCustomFont(state.globalSettings.fontUrl || '');
    }

    updateClock();
    setInterval(updateClock, 1000 * 30);
    applyGlobalWallpaper();
    initBatteryManager();

    applyAppIcons();
    applyWidgetData();





    document.getElementById('rules-tabs').addEventListener('click', (e) => {
      if (e.target.classList.contains('rules-tab')) {
        switchRuleCategory(e.target.dataset.categoryId);
      }
    });



    document.getElementById('add-new-rule-btn').addEventListener('click', () => openRuleEditor(null));
    document.getElementById('cancel-rule-editor-btn').addEventListener('click', () => {
      document.getElementById('rule-editor-modal').classList.remove('visible');
    });
    document.getElementById('save-rule-btn').addEventListener('click', saveRenderingRule);



    document.getElementById('pat-btn').addEventListener('click', async () => {

      if (state.activeChatId && !state.chats[state.activeChatId].isGroup) {
        const chat = state.chats[state.activeChatId];

        // ÂºπÂá∫ÈÄâÊã©Ê°ÜÔºöÊãçËá™Â∑±ËøòÊòØÊãçÂØπÊñπ
        const choice = await showChoiceModal('Êãç‰∏ÄÊãç', [
          { text: 'ÊãçÂØπÊñπ', value: 'pat_other' },
          { text: 'ÊãçËá™Â∑±', value: 'pat_self' }
        ]);

        if (choice === 'pat_other') {
          handleUserPat(chat.id, chat.originalName);
        } else if (choice === 'pat_self') {
          handleUserPatSelf(chat.id);
        }
      }
    });


    let activeAnnouncementId = null;


    function showAnnouncementActions(annoId) {
      activeAnnouncementId = annoId;
      const chat = state.chats[state.activeChatId];
      const announcement = chat.announcements.find(a => a.id === annoId);
      if (!announcement) return;

      const pinButton = document.getElementById('announcement-action-pin');

      pinButton.textContent = announcement.isPinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂ÂÖ¨Âëä';

      document.getElementById('announcement-actions-modal').classList.add('visible');
    }


    async function handlePinAnnouncement() {
      if (!activeAnnouncementId) return;
      const chat = state.chats[state.activeChatId];
      const announcement = chat.announcements.find(a => a.id === activeAnnouncementId);
      if (announcement) {
        announcement.isPinned = !announcement.isPinned;
        await db.chats.put(chat);
        showAnnouncementBoard();
      }
      document.getElementById('announcement-actions-modal').classList.remove('visible');
    }


    async function handleDeleteAnnouncement() {
      if (!activeAnnouncementId) return;

      const confirmed = await showCustomConfirm("Á°ÆËÆ§Âà†Èô§", "Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂÖ¨ÂëäÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ", {
        confirmButtonClass: 'btn-danger'
      });

      if (confirmed) {
        const chat = state.chats[state.activeChatId];

        chat.announcements = chat.announcements.filter(a => a.id !== activeAnnouncementId);
        await db.chats.put(chat);
        showAnnouncementBoard();
      }
      document.getElementById('announcement-actions-modal').classList.remove('visible');
    }

    document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
    document.getElementById('custom-modal-overlay').addEventListener('click', (e) => {
      if (e.target === modalOverlay) hideCustomModal();
    });
    // Êü•ÁúãÊï∞ÊçÆÂàÜÂ∏ÉÊåâÈíÆ
    document.getElementById('view-data-distribution-btn').addEventListener('click', viewDataDistribution);
    
    // Êï∞ÊçÆÂàÜÊûêÁªüËÆ°ÁïåÈù¢ÊåâÈíÆ
    document.getElementById('data-distribution-back-btn').addEventListener('click', () => {
      showScreen('api-settings-screen');
    });
    
    document.getElementById('refresh-distribution-btn').addEventListener('click', async () => {
      const container = document.getElementById('data-distribution-container');
      await renderDistributionData(container);
      showToast('Êï∞ÊçÆÂ∑≤Âà∑Êñ∞', 'success');
    });

    document.getElementById('export-data-btn').addEventListener('click', async () => {

      const choice = await showChoiceModal('ÈÄâÊã©ÂØºÂá∫ÊñπÂºè', [{
        text: 'ÂàÜÁâáÂØºÂá∫ (Êé®ËçêÔºåÊâìÂåÖ‰∏∫ZIPÔºåËß£ÂéãÊØè‰∏™ÂàáÁâáÈÄâÊã©Â¢ûÈáèÂØºÂÖ•)',
        value: 'slice'
      },
      {
        text: 'Êô∫ËÉΩÂØºÂá∫ (Âçï‰∏™Â§ßÊñá‰ª∂ÔºåÂ§™Â§ßÂèØËÉΩ‰ºöÂØºËá¥ÂØºÂÖ•‰∏ç‰∫Ü)',
        value: 'stream'
      },
      {
        text: '‰º†ÁªüÂØºÂá∫ (ÂÖºÂÆπÊóßÁâàÊàñÂÜÖÂ≠òÂ∞èÁöÑÊµèËßàÂô®)',
        value: 'blob'
      }
      ]);


      if (choice === 'slice') {
        exportDataAsSlicedZip();
      } else if (choice === 'stream') {
        exportDataAsStream();
      } else if (choice === 'blob') {
        exportDataAsBlob();
      }

    });

    // È´òÁ∫ßÂØºÂá∫ÂØºÂÖ•ÂäüËÉΩ
    document.getElementById('advanced-export-btn').addEventListener('click', async () => {
      await showAdvancedExportImportModal();
    });

    // È´òÁ∫ßÂØºÂÖ•Êñá‰ª∂ÈÄâÊã©
    document.getElementById('advanced-import-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        await handleAdvancedImport(file);
        e.target.value = ''; // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©
      }
    });

    document.getElementById('cleanup-data-btn').addEventListener('click', cleanupRedundantData);

    document.getElementById('offline-mode-toggle').addEventListener('change', (e) => {

      document.getElementById('offline-mode-options').style.display = e.target.checked ? 'block' : 'none';
    });
    document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
    document.getElementById('time-perception-toggle').addEventListener('change', (e) => {
      document.getElementById('time-zone-group').style.display = e.target.checked ? 'block' : 'none';
    });
    
    // Ëá™Âä®ËÆ∞ÂøÜÂºÄÂÖ≥ÂÆûÊó∂ÁîüÊïà
    document.getElementById('auto-memory-toggle').addEventListener('change', (e) => {
      const chat = state.chats[state.activeChatId];
      if (chat) {
        chat.settings.enableAutoMemory = e.target.checked;
        db.chats.put(chat); // Á´ãÂç≥‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
      }
    });
    
    // Êó•ËÆ∞Ê®°ÂºèÂºÄÂÖ≥ÂÆûÊó∂ÁîüÊïà
    document.getElementById('diary-mode-toggle').addEventListener('change', (e) => {
      const chat = state.chats[state.activeChatId];
      if (chat) {
        chat.settings.enableDiaryMode = e.target.checked;
        db.chats.put(chat); // Á´ãÂç≥‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
      }
    });
    
    // ÁªìÊûÑÂåñËÆ∞ÂøÜÂºÄÂÖ≥ÂÆûÊó∂ÁîüÊïà
    document.getElementById('structured-memory-toggle').addEventListener('change', async (e) => {
      const chat = state.chats[state.activeChatId];
      if (chat) {
        const wasEnabled = chat.settings.enableStructuredMemory;
        const isNowEnabled = e.target.checked;
        chat.settings.enableStructuredMemory = isNowEnabled;
        await db.chats.put(chat); // Á´ãÂç≥‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        
        // Â¶ÇÊûú‰ªéÂÖ≥Èó≠Âèò‰∏∫ÂºÄÂêØÔºå‰∏îÊúâÈïøÊúüËÆ∞ÂøÜÔºåÂàôËá™Âä®ËΩ¨Êç¢
        if (!wasEnabled && isNowEnabled && chat.longTermMemory && chat.longTermMemory.length > 0) {
          const confirmed = await showCustomConfirm(
            'ËΩ¨Êç¢ÈïøÊúüËÆ∞ÂøÜ', 
            `Ê£ÄÊµãÂà∞‰Ω†Êúâ ${chat.longTermMemory.length} Êù°ÈïøÊúüËÆ∞ÂøÜ„ÄÇÊòØÂê¶Â∞ÜÂÆÉ‰ª¨Ëá™Âä®ËΩ¨Êç¢‰∏∫ÁªìÊûÑÂåñËÆ∞ÂøÜÔºü\n\nËøôÂ∞ÜË∞ÉÁî®APIËøõË°åËΩ¨Êç¢Ôºå‰ºöÊ∂àËÄó‰∏ÄÂÆöÈ¢ùÂ∫¶„ÄÇ`,
            { confirmButtonText: 'Á´ãÂç≥ËΩ¨Êç¢', cancelButtonText: 'ÊöÇ‰∏çËΩ¨Êç¢' }
          );
          
          if (confirmed) {
            showToast('Ê≠£Âú®ËΩ¨Êç¢ÈïøÊúüËÆ∞ÂøÜ...', 'info');
            await convertLongTermMemoryToStructured(state.activeChatId);
          }
        }
      }
    });
    
    // ÊòæÁ§∫ÈöêËóèÊ∂àÊÅØÂºÄÂÖ≥ÂÆûÊó∂ÁîüÊïà
    document.getElementById('show-hidden-msg-toggle').addEventListener('change', (e) => {
      const chat = state.chats[state.activeChatId];
      if (chat) {
        chat.settings.showHiddenMessages = e.target.checked;
        db.chats.put(chat); // Á´ãÂç≥‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        renderChatArea(); // Á´ãÂç≥Âà∑Êñ∞ËÅäÂ§©Âå∫ÂüüÊòæÁ§∫
      }
    });

    document.getElementById('import-data-input').addEventListener('change', e => handleSmartImport(e.target.files[0]));
    document.getElementById('import-card-input').addEventListener('change', handleCardImport);

    // ÊâπÈáèÂØºÂÖ•Ê®°ÊÄÅÊ°Ü‰∫ã‰ª∂ÁõëÂê¨
    document.getElementById('select-all-import-cards')?.addEventListener('change', (e) => {
      const checkboxes = document.querySelectorAll('.batch-import-card-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = e.target.checked;
        const cardId = cb.dataset.cardId;
        const card = pendingImportCards.find(c => c.id === cardId);
        if (card) card.selected = e.target.checked;
      });
    });

    document.getElementById('confirm-batch-import-btn')?.addEventListener('click', confirmBatchImport);
    document.getElementById('cancel-batch-import-btn')?.addEventListener('click', cancelBatchImport);

    // ============================================================
    // ‚ñº‚ñº‚ñº ÂÖ®Â±ÄÂÆâÂÖ®ËøîÂõû‰∏éÂèòÈáèÊ∏ÖÁêÜÁ≥ªÁªü (Èò≤ÁÇ∏Áæ§/Èò≤‰∏≤Âè∞) ‚ñº‚ñº‚ñº
    // ============================================================

    // 1. ÂÆö‰πâÈÄöÁî®Ê∏ÖÁêÜÂáΩÊï∞ (ÊâÄÊúâ‚ÄúÈÄÄÂá∫/ËøîÂõû‚ÄùÊìç‰ΩúÈÉΩÂ∫îËØ•Ë∞ÉÁî®ÂÆÉ)
    function forceGlobalCleanup() {
      console.log("ÊâßË°åÂÖ®Â±ÄÂèòÈáèÊ∏ÖÁêÜ...");

      // A. Ê∏ÖÁêÜÂõûÂ§ç/ÂºïÁî®Áä∂ÊÄÅ
      if (typeof cancelReplyMode === 'function') cancelReplyMode();
      currentReplyContext = null;

      // B. Ê∏ÖÁêÜÂ§öÈÄâ/ÁºñËæëÊ®°Âºè
      if (typeof exitSelectionMode === 'function') exitSelectionMode();

      // C. Ê∏ÖÁêÜÂÆöÊó∂Âô® (Èò≤Ê≠¢Â§ñÂçñ/Ê∏∏ÊàèÂÄíËÆ°Êó∂Âú®ÂêéÂè∞Êä•Èîô)
      if (typeof cleanupWaimaiTimers === 'function') cleanupWaimaiTimers();
      if (typeof stopAutoBackupTimer === 'function') stopAutoBackupTimer(); // Â¶ÇÊûúÊúâËá™Âä®Â§á‰ªΩ

      // D. Âº∫Âà∂ÂÖ≥Èó≠ÊÇ¨ÊµÆÂ±Ç/Èù¢Êùø
      const gomokuOverlay = document.getElementById('gomoku-overlay');
      if (gomokuOverlay) {
        gomokuOverlay.classList.remove('visible');
        // ÈáçÁΩÆ‰∫îÂ≠êÊ£ãÁä∂ÊÄÅÔºåÈò≤Ê≠¢‰∏ãÊ¨°ÊâìÂºÄÂç°Ê≠ª
        if (state.activeChatId && gomokuState[state.activeChatId]) {
          gomokuState[state.activeChatId].isActive = false;
        }
      }

      const stickerPanel = document.getElementById('sticker-panel');
      if (stickerPanel) stickerPanel.classList.remove('visible');

      const musicPanel = document.getElementById('music-playlist-panel');
      if (musicPanel) musicPanel.classList.remove('visible');

      // E. Ê∏ÖÁêÜÂÖ®Â±Ä‰∏¥Êó∂ÂèòÈáè (ÊúÄÈáçË¶ÅÁöÑ‰∏ÄÊ≠•ÔºÅ)
      ruleCache = {};
      activeMessageTimestamp = null;
      activeTransferTimestamp = null;
      //lastRawAiResponse = ''; 
      //lastResponseTimestamps = [];

      // F. ÈáçÁΩÆ UI Ê†∑Âºè
      applyScopedCss('', '#chat-messages', 'custom-bubble-style');
      applyScopedCss('', '#settings-preview-area', 'preview-bubble-style');

      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) typingIndicator.style.display = 'none';

      // G. Ê†∏ÂøÉÔºöËß£Èô§ÂΩìÂâçËÅäÂ§©ÁªëÂÆö
      state.activeChatId = null;
    }

    // 2. ÁªëÂÆöÔºöËÅäÂ§©ÁïåÈù¢ -> ËøîÂõûÂàóË°®
    document.getElementById('back-to-list-btn').addEventListener('click', () => {
      forceGlobalCleanup(); // ÊâßË°åÊ∏ÖÁêÜ
      showScreen('chat-list-screen'); // ÂàáÊç¢ÁîªÈù¢
    });

    // 3. ÁªëÂÆöÔºöÁãº‰∫∫ÊùÄ -> ÈÄÄÂá∫Ê∏∏Êàè
    document.getElementById('exit-werewolf-game-btn').addEventListener('click', async () => {
      const confirmed = await showCustomConfirm('ÈÄÄÂá∫Ê∏∏Êàè', 'Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÂΩìÂâçËøôÂ±ÄÁãº‰∫∫ÊùÄÂêóÔºüÊ∏∏ÊàèËøõÂ∫¶Â∞Ü‰∏ç‰ºöË¢´‰øùÂ≠ò„ÄÇ', {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        werewolfGameState.isActive = false;

        // Â¶ÇÊûúÊòØÁæ§ËÅäÊ®°ÂºèÔºåËøîÂõûËÅäÂ§©ÁïåÈù¢Ôºà‰∏çÊ∏ÖÁêÜactiveChatIdÔºåÂõ†‰∏∫ËøòÂú®Áæ§ÈáåÔºâ
        if (werewolfGameState.chatId) {
          showScreen('chat-interface-screen');
        } else {
          // Â¶ÇÊûúÊòØÂÖ®Â±ÄÊ®°ÂºèÔºåËøîÂõû‰∏ªÈ°µÔºàÊâßË°åÊ∏ÖÁêÜÔºÅÔºâ
          forceGlobalCleanup();
          showScreen('home-screen');
        }
      }
    });

    // 4. ÁªëÂÆöÔºöÁªøÊ±ü/ÊîØ‰ªòÂÆù/ËÆæÁΩÆ -> ËøîÂõû‰∏ªÈ°µ (Ëá™Âä®Êü•ÊâæÂπ∂ÁªëÂÆö)
    // Âõ†‰∏∫Ëøô‰∫õÊåâÈíÆÂú®HTMLÈáåÊ≤°ÊúâIDÔºåÊàë‰ª¨Áî®ÈÄâÊã©Âô®ÊâπÈáèÁªëÂÆö‚ÄúÂÆâÂÖ®ÈîÅ‚Äù
    const safeBackSelectors = [
      '#green-river-screen .gr-icon-btn', // ÁªøÊ±üËøîÂõû
      '#alipay-screen .back-btn',         // ÊîØ‰ªòÂÆùËøîÂõû
      '#api-settings-screen .back-btn',   // APIËÆæÁΩÆËøîÂõû
      '#wallpaper-screen .back-btn',      // Â§ñËßÇËÆæÁΩÆËøîÂõû
      '#font-settings-screen .back-btn',  // Â≠ó‰ΩìËÆæÁΩÆËøîÂõû
      '#tutorial-screen .back-btn'        // ÊïôÁ®ãËøîÂõû
    ];

    safeBackSelectors.forEach(selector => {
      const btn = document.querySelector(selector);
      if (btn) {
        // ÁßªÈô§ÊóßÁöÑ inline onclick (Â¶ÇÊûúÊúâÂÜ≤Á™ÅÁöÑËØù)ÔºåÊàñËÄÖÁõ¥Êé•ËøΩÂä†
        // ËøôÈáåÊàë‰ª¨ËøΩÂä†‰∏Ä‰∏™Ê∏ÖÁêÜÊìç‰ΩúÔºåÂÆÉ‰ºöÂú® onclick Ë∑≥ËΩ¨‰πãÂâçÊàñÂêåÊó∂ÊâßË°å
        btn.addEventListener('click', () => {
          forceGlobalCleanup();
          // Ê≥®ÊÑèÔºöÂéüÊú¨ÁöÑ showScreen('home-screen') ÂÜôÂú® HTML onclick ÈáåÔºå‰æùÁÑ∂‰ºöÊâßË°å
          // ËøôÈáåÂè™ÊòØÈ¢ùÂ§ñÂä†‰∫Ü‰∏ÄÈÅì‰øùÈô©
        });
      }
    });

    // ============================================================


    document.getElementById('add-chat-btn').addEventListener('click', async () => {

      const choice = await showChoiceModal('ÂàõÂª∫Êñ∞ËÅäÂ§©', [{
        text: 'ÊâãÂä®ÂàõÂª∫ËßíËâ≤',
        value: 'manual'
      },
      {
        text: '‰ªéËßíËâ≤Âç°ÂØºÂÖ• (.json/.png)',
        value: 'import_card'
      },
      {
        text: 'ÂØºÂÖ•Êñá‰ª∂Ôºà‰ªÖTXT„ÄÅDOCX„ÄÅZIPÔºåZIP‰πüÂè™Ëß£ÊûêTXTÂíåDOCXÔºâ',
        value: 'import_file'
      }
      ]);

      if (choice === 'manual') {

        const remarkName = await showCustomPrompt('ÂàõÂª∫Êñ∞ËÅäÂ§© (Á¨¨1/2Ê≠•)', 'ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥‰∏∫TaËÆæÁΩÆÁöÑ„ÄêÂ§áÊ≥®Âêç„Äë');
        if (!remarkName || !remarkName.trim()) return;

        const originalName = await showCustomPrompt('ÂàõÂª∫Êñ∞ËÅäÂ§© (Á¨¨2/2Ê≠•)', 'ËØ∑ËæìÂÖ•TaÁöÑ„ÄêÊú¨Âêç„Äë');
        if (!originalName || !originalName.trim()) return;


        const newChatId = 'chat_' + Date.now();
        const newChat = {
          id: newChatId,
          name: remarkName.trim(),
          originalName: originalName.trim(),
          isGroup: false,
          isPinned: false,
          unreadCount: 0,
          relationship: {
            status: 'friend',
            blockedTimestamp: null,
            applicationReason: ''
          },
          status: {
            text: 'Âú®Á∫ø',
            lastUpdate: Date.now(),
            isBusy: false
          },
          settings: {
            aiPersona: 'ËøôÊòØ‰∏Ä‰∏™ÈÄöËøáÊâãÂä®ÂàõÂª∫ÁöÑËßíËâ≤„ÄÇ',
            myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ',
            myNickname: 'Êàë',
            maxMemory: 10,
            aiAvatar: defaultAvatar,
            myAvatar: defaultAvatar,
            background: '',
            theme: 'default',
            fontSize: 13,
            customCss: '',
            linkedWorldBookIds: [],
            aiAvatarLibrary: [],
            myAvatarLibrary: [],
            enableBackgroundActivity: true,
            actionCooldownMinutes: 15,
            enableTimePerception: true,
            isOfflineMode: false,
            offlineMinLength: 100,
            offlineMaxLength: 300,
            offlinePresetId: null,
            offlineContinuousLayout: false,
            timeZone: 'Asia/Shanghai',
            myPhoneLockScreenEnabled: false,
            myPhoneLockScreenPassword: '',
            userStatus: {
              text: 'Âú®Á∫ø',
              lastUpdate: Date.now(),
              isBusy: false
            }
          },
          history: [],
          musicData: {
            totalTime: 0
          },
          longTermMemory: [],
          thoughtsHistory: []
        };
        state.chats[newChatId] = newChat;
        await db.chats.put(newChat);
        renderChatList();

      } else if (choice === 'import_card') {

        try {

          await requirePinActivation();


          document.getElementById('import-card-input').click();

        } catch (error) {

          console.warn("ËßíËâ≤Âç°ÂØºÂÖ•Ë¢´ÂèñÊ∂à:", error.message);
        }

      } else if (choice === 'import_file') {
        // ÂØºÂÖ•Êñá‰ª∂ÔºàÈùûÈÖíÈ¶ÜÔºâ
        await handleCharacterFileImport();
      }
    });



    document.getElementById('add-group-chat-btn').addEventListener('click', openContactPickerForGroupCreate);

    document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
    document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);

    document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
    document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
    document.getElementById('music-return-btn').addEventListener('click', returnToChat);
    document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
    document.getElementById('music-next-btn').addEventListener('click', playNext);
    document.getElementById('music-prev-btn').addEventListener('click', playPrev);
    document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
    document.getElementById('music-playlist-btn').addEventListener('click', () => {
      updatePlaylistUI();
      document.getElementById('music-playlist-panel').classList.add('visible');
    });
    document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
    document.getElementById('manage-playlist-btn').addEventListener('click', togglePlaylistManagementMode);
    document.getElementById('select-all-playlist-checkbox').addEventListener('change', handleSelectAllPlaylistItems);
    document.getElementById('delete-selected-songs-btn').addEventListener('click', executeDeleteSelectedSongs);
    document.getElementById('upload-selected-to-catbox-btn').addEventListener('click', executeBatchUploadToCatbox);
    document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
    document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
    document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);

    document.getElementById('playlist-body').addEventListener('click', (e) => {
      const target = e.target;
      const trackIndex = parseInt(target.dataset.index);

      if (isNaN(trackIndex)) return;

      if (target.classList.contains('album-art-btn')) {
        handleChangeAlbumArt(trackIndex);
      } else if (target.classList.contains('lyrics-btn')) {
        handleManualLrcImport(trackIndex);
      } else if (target.classList.contains('bg-btn')) {
        handleChangeBackground(trackIndex);
      } else if (target.classList.contains('delete-track-btn')) {
        deleteTrack(trackIndex);
      }
    });

    audioPlayer.addEventListener('ended', async () => { // 1. Âú®ËøôÈáåÊ∑ªÂä† async
      document.getElementById('vinyl-view').classList.remove('spinning');

      // 2. ‰øùÊåÅ playNext(true) ‰∏çÂèòÔºåËøôÊ†∑ÂÆÉÂ∞±‰∏ç‰ºöÂèëÈÄÅ‚ÄúÁî®Êà∑ÂàáÊ≠å‚ÄùÁöÑÈîôËØØÊèêÁ§∫
      playNext(true);

      // 3. Á≠âÂæÖ playNext ÊâßË°åÂÆåÊØïÔºåÁ°Æ‰øù musicState.currentIndex Â∑≤ÁªèÊõ¥Êñ∞
      //    (Ê≥®ÊÑèÔºöplayNext ‰∏çÊòØÂºÇÊ≠•ÁöÑÔºå‰ΩÜ playSong ÊòØ„ÄÇ‰∏çËøá playNext ‰ºöÂêåÊ≠•Êõ¥Êñ∞ currentIndex)
      //    ‰∏∫‰∫Ü‰øùÈô©Ëµ∑ËßÅÔºåÊàë‰ª¨Á®çÂæÆÁ≠âÂæÖ‰∏Ä‰∏ãÁ°Æ‰øùÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞„ÄÇ
      await new Promise(resolve => setTimeout(resolve, 50));

      // 4. ÊâãÂä®Ê∑ªÂä†‰∏ÄÊù°‚ÄúËá™Âä®Êç¢Ê≠å‚ÄùÁöÑÁ≥ªÁªüÊèêÁ§∫
      const track = musicState.playlist[musicState.currentIndex];
      if (track && musicState.isActive && musicState.activeChatId) {
        const chat = state.chats[musicState.activeChatId];
        if (chat) {
          const systemMessage = {
            role: 'system',
            content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰∏ä‰∏ÄÈ¶ñÊ≠åÊõ≤Êí≠ÊîæÂÆåÊØïÔºåÂ∑≤Ëá™Âä®‰∏∫‰Ω†ÂàáÊç¢Âà∞„Ää${track.name}„Äã - ${track.artist}]`,
            timestamp: Date.now(),
            isHidden: true // ËøôÊù°Ê∂àÊÅØÁî®Êà∑Áúã‰∏çËßÅÔºå‰ΩÜAIÂú®‰∏ãÊ¨°ÂõûÂ§çÊó∂‰ºöËØªÂà∞
          };
          chat.history.push(systemMessage);
          await db.chats.put(chat); // ÂºÇÊ≠•‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        }
      }
    });





    const chatInput = document.getElementById('chat-input');


    document.getElementById('send-btn').addEventListener('click', () => {
      playSilentAudio();
      const content = chatInput.value.trim();
      if (!content || !state.activeChatId) return;

      const chat = state.chats[state.activeChatId];
      if (content.startsWith('/n ') || content.startsWith('/ÊóÅÁôΩ ')) {
        const narrationText = content.replace(/^\/n\s+|^\/ÊóÅÁôΩ\s+/, '');

        const msg = {
          role: 'system', // ËÆæ‰∏∫ system Â±Ö‰∏≠ÊòæÁ§∫
          type: 'narration',
          content: narrationText,
          timestamp: Date.now()
        };

        // ‰øùÂ≠òÂπ∂Ê∏≤Êüì
        chat.history.push(msg);
        db.chats.put(chat);
        appendMessage(msg, chat);

        chatInput.value = '';
        chatInput.style.height = 'auto';
        chatInput.focus();
        return; // ÈòªÊ≠¢ÂèëÈÄÅÊôÆÈÄöÊ∂àÊÅØ
      }
      const msg = {
        role: 'user',
        content,
        timestamp: Date.now()
      };

      if (currentReplyContext) {
        msg.quote = currentReplyContext;
      }


      appendMessage(msg, chat);


      (async () => {
        chat.history.push(msg);
        await db.chats.put(chat);
        renderChatList();

      })();


      chatInput.value = '';
      chatInput.style.height = 'auto';
      chatInput.focus();
      cancelReplyMode();
      document.body.classList.remove('chat-actions-expanded');
    });
    document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('send-btn').click();
      }
    });


    document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {

        const base64Url = await new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.onerror = () => rej(reader.error);
          reader.readAsDataURL(file);
        });


        newWallpaperBase64 = base64Url;


        renderWallpaperScreen();


        if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {

          (async () => {
            try {
              console.log("[ImgBB] ÂêéÂè∞ÂºÄÂßã‰∏ä‰º†Â£ÅÁ∫∏...");

              const imageUrl = await uploadImageToImgBB(base64Url);


              if (newWallpaperBase64 === base64Url) {
                newWallpaperBase64 = imageUrl; // ÊÇÑÊÇÑÂú∞Â∞ÜÂèòÈáèÊõ¥Êñ∞‰∏∫ URL
                console.log("[ImgBB] ÂêéÂè∞Â£ÅÁ∫∏‰∏ä‰º†ÊàêÂäüÔºå‰∏¥Êó∂ÂèòÈáèÂ∑≤Êõ¥Êñ∞‰∏∫ URL„ÄÇ");
              } else {
                console.log("[ImgBB] ÂêéÂè∞Â£ÅÁ∫∏‰∏ä‰º†ÂÆåÊàêÔºå‰ΩÜÁî®Êà∑Â∑≤Êõ¥ÊîπÈÄâÊã©ÔºåÊîæÂºÉÊõ¥Êñ∞„ÄÇ");
              }
            } catch (uploadError) {

              console.error("ÂêéÂè∞Â£ÅÁ∫∏‰∏ä‰º†Â§±Ë¥•:", uploadError.message);

            }
          })();
        }


        event.target.value = null;
      }
    });

    document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {

      if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
      }




      state.globalSettings.globalCss = document.getElementById('global-css-input').value.trim();
      state.globalSettings.notificationSoundUrl = document.getElementById('notification-sound-url-input').value.trim();
      state.globalSettings.notificationVolume = parseInt(document.getElementById('notification-volume-slider').value) / 100;
      state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;

      state.globalSettings.showPhoneFrame = document.getElementById('phone-frame-toggle-switch').checked;
      state.globalSettings.enableMinimalChatUI = document.getElementById('minimal-chat-ui-switch').checked;
      state.globalSettings.alwaysShowMusicIsland = document.getElementById('dynamic-island-music-toggle-switch').checked;
      state.globalSettings.detachStatusBar = document.getElementById('detach-status-bar-switch').checked;
      state.globalSettings.lockScreenEnabled = document.getElementById('lock-screen-toggle').checked;
      state.globalSettings.lockScreenPassword = document.getElementById('lock-screen-password-input').value.trim();

      const lockPreview = document.getElementById('lock-wallpaper-preview');
      if (lockPreview.dataset.tempUrl) {
        state.globalSettings.lockScreenWallpaper = lockPreview.dataset.tempUrl;
      }
      await db.globalSettings.put(state.globalSettings);


      applyGlobalWallpaper();
      applyCPhoneWallpaper();
      applyMyPhoneWallpaper();
      newWallpaperBase64 = null;

      applyAppIcons();
      applyCPhoneAppIcons();
      applyMyPhoneAppIconsGlobal();

      applyGlobalCss(state.globalSettings.globalCss);
      applyStatusBarVisibility();
      applyMinimalChatUI(state.globalSettings.enableMinimalChatUI);
      initLockScreen();
      alert('Â§ñËßÇËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ');
      showScreen('home-screen');
    });


    const messagesView = document.getElementById('messages-view');
    messagesView.addEventListener('scroll', () => {

      const {
        scrollTop,
        scrollHeight,
        clientHeight
      } = messagesView;



      if (scrollHeight - scrollTop - clientHeight < clientHeight) {

        if (!isLoadingMoreChats) {

          loadMoreChats();
        }
      }
    });


    document.getElementById('save-api-settings-btn').addEventListener('click', async () => {

      state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim();
      state.apiConfig.apiKey = document.getElementById('api-key').value.trim();
      // ‰ºòÂÖà‰ΩøÁî®ÊâãÂÜôËæìÂÖ•Ê°ÜÁöÑÂÄºÔºåÂ¶ÇÊûú‰∏∫Á©∫Âàô‰ΩøÁî®‰∏ãÊãâÊ°ÜÁöÑÂÄº
      const modelInput = document.getElementById('model-input').value.trim();
      state.apiConfig.model = modelInput || document.getElementById('model-select').value;
      state.apiConfig.minimaxGroupId = document.getElementById('minimax-group-id').value.trim();
      state.apiConfig.minimaxApiKey = document.getElementById('minimax-api-key').value.trim();
      state.apiConfig.minimaxModel = document.getElementById('minimax-model-select').value;
      const domainSelect = document.getElementById('minimax-domain-select');
      if (domainSelect) {
        state.apiConfig.minimaxDomain = domainSelect.value;
        localStorage.setItem('minimax-domain', domainSelect.value);
      }
      localStorage.setItem('minimax-group-id', state.apiConfig.minimaxGroupId);
      localStorage.setItem('minimax-api-key', state.apiConfig.minimaxApiKey);
      localStorage.setItem('minimax-model', state.apiConfig.minimaxModel);
      state.apiConfig.secondaryProxyUrl = document.getElementById('secondary-proxy-url').value.trim();
      state.apiConfig.secondaryApiKey = document.getElementById('secondary-api-key').value.trim();
      // ‰ºòÂÖà‰ΩøÁî®ÊâãÂÜôËæìÂÖ•Ê°ÜÁöÑÂÄºÔºåÂ¶ÇÊûú‰∏∫Á©∫Âàô‰ΩøÁî®‰∏ãÊãâÊ°ÜÁöÑÂÄº
      const secondaryModelInput = document.getElementById('secondary-model-input').value.trim();
      state.apiConfig.secondaryModel = secondaryModelInput || document.getElementById('secondary-model-select').value;
      const imgbbEnable = document.getElementById('imgbb-enable-switch').checked;
      const imgbbApiKey = document.getElementById('imgbb-api-key').value.trim();
      const catboxEnable = document.getElementById('catbox-enable-switch').checked;
      const catboxUserHash = document.getElementById('catbox-userhash').value.trim();


      state.apiConfig.imgbbEnable = imgbbEnable;
      state.apiConfig.imgbbApiKey = imgbbApiKey;
      state.apiConfig.catboxEnable = catboxEnable;
      state.apiConfig.catboxUserHash = catboxUserHash;


      localStorage.setItem('imgbb-enabled', imgbbEnable);
      localStorage.setItem('imgbb-api-key', imgbbApiKey);
      localStorage.setItem('catbox-enabled', catboxEnable);
      localStorage.setItem('catbox-userhash', catboxUserHash);
      const githubEnable = document.getElementById('github-enable-switch').checked;
      const githubAutoBackup = document.getElementById('github-auto-backup-switch').checked;
      let backupInterval = parseInt(document.getElementById('github-backup-interval').value);
      if (isNaN(backupInterval) || backupInterval < 1) backupInterval = 30;
      state.apiConfig.githubEnable = githubEnable;
      state.apiConfig.githubAutoBackup = githubAutoBackup;
      const githubProxyEnable = document.getElementById('github-proxy-switch').checked;
      const githubProxyUrl = document.getElementById('github-proxy-url').value.trim();

      state.apiConfig.githubProxyEnable = githubProxyEnable;
      state.apiConfig.githubProxyUrl = githubProxyUrl;

      localStorage.setItem('github-proxy-enabled', githubProxyEnable);
      localStorage.setItem('github-proxy-url', githubProxyUrl);
      state.apiConfig.githubUsername = document.getElementById('github-username').value.trim();
      state.apiConfig.githubRepo = document.getElementById('github-repo').value.trim();
      state.apiConfig.githubToken = document.getElementById('github-token').value.trim();
      state.apiConfig.githubFilename = document.getElementById('github-filename').value.trim() || 'ephone_backup.json';
      localStorage.setItem('github-username', state.apiConfig.githubUsername);
      localStorage.setItem('github-repo', state.apiConfig.githubRepo);
      localStorage.setItem('github-token', state.apiConfig.githubToken);
      localStorage.setItem('github-filename', state.apiConfig.githubFilename);
      state.apiConfig.novelaiApiKey = document.getElementById('novelai-api-key').value.trim();
      state.apiConfig.novelaiModel = document.getElementById('novelai-model').value;
      state.apiConfig.novelaiEnabled = document.getElementById('novelai-switch').checked;
      // ‰øùÂ≠òÂ§á‰ªΩÈó¥Èöî
      state.apiConfig.githubBackupInterval = backupInterval;
      // ‰øùÂ≠òÂºÄÂÖ≥Áä∂ÊÄÅÂà∞ localStorage
      localStorage.setItem('github-enabled', githubEnable);
      localStorage.setItem('github-auto-backup', githubAutoBackup);
      localStorage.setItem('github-backup-interval', backupInterval);

      if (githubEnable && githubAutoBackup) {
        // ‰º†ÂÖ•Âä®ÊÄÅÁöÑÊó∂Èó¥Èó¥Èöî
        startAutoBackupTimer(backupInterval);
      } else {
        stopAutoBackupTimer();
      }
      await db.apiConfig.put(state.apiConfig);


      const backgroundSwitch = document.getElementById('background-activity-switch');
      const intervalInput = document.getElementById('background-interval-input');
      const cooldownInput = document.getElementById('block-cooldown-input');

      state.globalSettings.enableBackgroundActivity = backgroundSwitch.checked;
      state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
      state.globalSettings.blockCooldownHours = parseFloat(cooldownInput.value) || 1;
      state.globalSettings.enableAiDrawing = document.getElementById('enable-ai-drawing-switch').checked;

      // Êñ∞Â¢ûÔºö‰øùÂ≠òÂøÉÂ£∞ÂíåÂä®ÊÄÅÂäüËÉΩÂºÄÂÖ≥
      state.globalSettings.enableThoughts = document.getElementById('global-enable-thoughts-switch').checked;
      state.globalSettings.enableQzoneActions = document.getElementById('global-enable-qzone-actions-switch').checked;
      state.globalSettings.enableViewMyPhone = document.getElementById('global-enable-view-myphone-switch').checked;

      state.globalSettings.chatRenderWindow = parseInt(document.getElementById('chat-render-window-input').value) || 50;
      state.globalSettings.chatListRenderWindow = parseInt(document.getElementById('chat-list-render-window-input').value) || 30;
      state.globalSettings.apiTemperature = parseFloat(document.getElementById('api-temperature-slider').value);
      
      // ÊñπÊ°à4Ôºö‰øùÂ≠òAPIÂéÜÂè≤ËÆ∞ÂΩïÂºÄÂÖ≥Áä∂ÊÄÅ
      const apiHistorySwitch = document.getElementById('enable-api-history-switch');
      if (apiHistorySwitch) {
        state.globalSettings.enableApiHistory = apiHistorySwitch.checked;
      }
      
      await db.globalSettings.put(state.globalSettings);

      stopBackgroundSimulation();
      if (state.globalSettings.enableBackgroundActivity) {
        startBackgroundSimulation();
        console.log(`ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤ÂêØÂä®ÔºåÈó¥Èöî: ${state.globalSettings.backgroundActivityInterval}Áßí`);
      } else {
        console.log("ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤ÂÅúÊ≠¢„ÄÇ");
      }

      // ‰øùÂ≠òNovelAIÈÖçÁΩÆÂà∞localStorage
      const novelaiEnabled = document.getElementById('novelai-switch').checked;
      const novelaiModel = document.getElementById('novelai-model').value;
      const novelaiApiKey = document.getElementById('novelai-api-key').value.trim();
      localStorage.setItem('novelai-enabled', novelaiEnabled);
      localStorage.setItem('novelai-model', novelaiModel);
      localStorage.setItem('novelai-api-key', novelaiApiKey);

      // ‰øùÂ≠òGoogle ImagenÈÖçÁΩÆÂà∞localStorage
      saveGoogleImagenSettings();

      alert('ÊâÄÊúâAPI‰∏éÂêéÂè∞ËÆæÁΩÆÂ∑≤‰øùÂ≠ò!');
    });



    const ApiKeyInput = document.getElementById('api-key')
    ApiKeyInput.addEventListener('focus', (e) => {
      e.target.setAttribute('type', 'text')
    })
    ApiKeyInput.addEventListener('blur', (e) => {
      e.target.setAttribute('type', 'password')
    })





    async function fetchModels(urlInputId, keyInputId, selectId) {
      const url = document.getElementById(urlInputId).value.trim();
      const key = document.getElementById(keyInputId).value.trim();
      if (!url || !key) return alert('ËØ∑ÂÖàÂ°´ÂÜôÂØπÂ∫îÁöÑÂèç‰ª£Âú∞ÂùÄÂíåÂØÜÈí•');

      try {
        let isGemini = url === GEMINI_API_URL;
        const fetchOptions = isGemini ? {
          method: 'GET',
          mode: 'cors',
          cache: 'no-cache',
          credentials: 'omit'
        } : {
          method: 'GET',
          mode: 'cors',
          cache: 'no-cache',
          credentials: 'omit',
          headers: {
            'Authorization': `Bearer ${key}`,
            'Content-Type': 'application/json'
          }
        };

        const response = await fetch(
          isGemini ? `${GEMINI_API_URL}?key=${getRandomValue(key)}` : `${url}/v1/models`,
          fetchOptions
        );

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Êó†Ê≥ïËé∑ÂèñÊ®°ÂûãÂàóË°® (${response.status}): ${errorText}`);
        }

        const data = await response.json();
        let models = isGemini ? data.models.map(model => ({
          id: model.name.split('/')[1] || model.name
        })) : data.data;

        if (!models || models.length === 0) {
          throw new Error('ËøîÂõûÁöÑÊ®°ÂûãÂàóË°®‰∏∫Á©∫');
        }

        const modelSelect = document.getElementById(selectId);
        modelSelect.innerHTML = '';

        const savedModel = selectId === 'model-select' ? state.apiConfig.model : state.apiConfig.secondaryModel;

        models.forEach(model => {
          const option = document.createElement('option');
          option.value = model.id;
          option.textContent = model.id;
          if (model.id === savedModel) option.selected = true;
          modelSelect.appendChild(option);
        });
        alert('Ê®°ÂûãÂàóË°®Â∑≤Êõ¥Êñ∞');
      } catch (error) {
        console.error('ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•:', error);
        alert(`ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•: ${error.message}`);
      }
    }


    document.getElementById('fetch-models-btn').addEventListener('click', () => {
      fetchModels('proxy-url', 'api-key', 'model-select');
    });


    document.getElementById('fetch-secondary-models-btn').addEventListener('click', () => {
      fetchModels('secondary-proxy-url', 'secondary-api-key', 'secondary-model-select');
    });

    // ÁõëÂê¨‰∏ªÊ®°Âûã‰∏ãÊãâÊ°ÜÂèòÂåñÔºåËá™Âä®Â°´ÂÖ•ÊâãÂÜôÊ°Ü
    document.getElementById('model-select').addEventListener('change', (e) => {
      const selectedModel = e.target.value;
      if (selectedModel) {
        document.getElementById('model-input').value = selectedModel;
      }
    });

    // ÁõëÂê¨ÂâØÊ®°Âûã‰∏ãÊãâÊ°ÜÂèòÂåñÔºåËá™Âä®Â°´ÂÖ•ÊâãÂÜôÊ°Ü
    document.getElementById('secondary-model-select').addEventListener('change', (e) => {
      const selectedModel = e.target.value;
      if (selectedModel) {
        document.getElementById('secondary-model-input').value = selectedModel;
      }
    });

    // ========== ÁßªÂä®Á´ØÊéßÂà∂Âè∞ÂäüËÉΩ ==========
    (function () {
      const consoleLogs = [];
      let currentFilter = 'all';

      // ‰øùÂ≠òÂéüÂßãconsoleÊñπÊ≥ï
      const originalConsole = {
        log: console.log,
        warn: console.warn,
        error: console.error,
        info: console.info
      };

      // Ê∑ªÂä†Êó•ÂøóÂà∞Êï∞ÁªÑ
      function addLog(type, args) {
        const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
        const message = Array.from(args).map(arg => {
          if (typeof arg === 'object') {
            try {
              return JSON.stringify(arg, null, 2);
            } catch (e) {
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');

        consoleLogs.push({ type, timestamp, message });

        // ÈôêÂà∂Êó•ÂøóÊï∞ÈáèÔºåÊúÄÂ§ö‰øùÂ≠ò1000Êù°
        if (consoleLogs.length > 1000) {
          consoleLogs.shift();
        }
      }

      // ÈáçÂÜôconsoleÊñπÊ≥ï
      console.log = function (...args) {
        originalConsole.log.apply(console, args);
        addLog('log', args);
      };

      console.warn = function (...args) {
        originalConsole.warn.apply(console, args);
        addLog('warn', args);
      };

      console.error = function (...args) {
        originalConsole.error.apply(console, args);
        addLog('error', args);
      };

      console.info = function (...args) {
        originalConsole.info.apply(console, args);
        addLog('info', args);
      };

      // ÊçïËé∑Êú™Â§ÑÁêÜÁöÑÈîôËØØ
      window.addEventListener('error', (event) => {
        const message = `${event.message}\n  at ${event.filename}:${event.lineno}:${event.colno}`;
        addLog('error', [message]);
      });

      // ÊçïËé∑Êú™Â§ÑÁêÜÁöÑPromiseÊãíÁªù
      window.addEventListener('unhandledrejection', (event) => {
        const message = `Unhandled Promise Rejection: ${event.reason}`;
        addLog('error', [message]);
      });

      // Ê∏≤ÊüìÊéßÂà∂Âè∞ÂÜÖÂÆπ
      function renderConsole() {
        const content = document.getElementById('mobile-console-content');
        if (!content) return;

        const filteredLogs = currentFilter === 'all'
          ? consoleLogs
          : consoleLogs.filter(log => log.type === currentFilter);

        if (filteredLogs.length === 0) {
          content.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">ÊöÇÊó†Êó•Âøó</div>';
          return;
        }

        content.innerHTML = filteredLogs.map(log =>
          `<div class="console-entry ${log.type}">
            <span class="console-timestamp">[${log.timestamp}]</span>
            <span class="console-message">${log.message}</span>
          </div>`
        ).join('');

        // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
        content.scrollTop = content.scrollHeight;
      }

      // ÊâìÂºÄÊéßÂà∂Âè∞ÊåâÈíÆ
      const openConsoleBtn = document.getElementById('open-console-btn');
      if (openConsoleBtn) {
        const openConsoleHandler = async () => {
          const consolePanel = document.getElementById('mobile-console');
          if (consolePanel) {
            consolePanel.style.display = 'flex';
            renderConsole();

            // È¶ñÊ¨°ÊâìÂºÄÊéßÂà∂Âè∞Êó∂ÊòæÁ§∫ÊèêÁ§∫
            const hasShownConsoleTip = localStorage.getItem('ephoneConsoleFirstTipShown');
            if (!hasShownConsoleTip) {
              await showCustomAlert(
                'üí° ÊéßÂà∂Âè∞‰ΩøÁî®ÊèêÁ§∫',
                'Â¶ÇÊûúÊÇ®ÊòØÂõ†‰∏∫ÈÅáÂà∞ÈóÆÈ¢òÊâçÊâìÂºÄÊéßÂà∂Âè∞ÁöÑÔºåÂèëÁé∞Êä•ÈîôÂêéËØ∑Â∞ÜÈîôËØØ‰ø°ÊÅØÂèëÈÄÅÁªô‰ΩúËÄÖ„ÄÇ\n\nÊÇ®ÂèØ‰ª•ÁÇπÂáªÂ∑¶‰∏äËßíÁöÑÂ∞è‰∫∫ÂõæÊ†áÔºåËøõÂÖ•ÁßÅ‰ø°È°µÈù¢ËÅîÁ≥ª‰ΩúËÄÖ„ÄÇ'
              );
              localStorage.setItem('ephoneConsoleFirstTipShown', 'true');
            }
          }
        };
        openConsoleBtn.addEventListener('click', openConsoleHandler);
        openConsoleBtn.addEventListener('touchend', (e) => {
          e.preventDefault();
          openConsoleHandler();
        }, { passive: false });
      }

      // ÂÖ≥Èó≠ÊéßÂà∂Âè∞ÊåâÈíÆ
      const closeConsoleBtn = document.getElementById('console-close-btn');
      if (closeConsoleBtn) {
        const closeConsoleHandler = () => {
          const consolePanel = document.getElementById('mobile-console');
          if (consolePanel) {
            consolePanel.style.display = 'none';
          }
        };
        closeConsoleBtn.addEventListener('click', closeConsoleHandler);
        closeConsoleBtn.addEventListener('touchend', (e) => {
          e.preventDefault();
          closeConsoleHandler();
        }, { passive: false });
      }

      // Ê∏ÖÁ©∫ÊéßÂà∂Âè∞ÊåâÈíÆ
      const clearConsoleBtn = document.getElementById('console-clear-btn');
      if (clearConsoleBtn) {
        const clearConsoleHandler = () => {
          consoleLogs.length = 0;
          renderConsole();
        };
        clearConsoleBtn.addEventListener('click', clearConsoleHandler);
        clearConsoleBtn.addEventListener('touchend', (e) => {
          e.preventDefault();
          clearConsoleHandler();
        }, { passive: false });
      }

      // ÊéßÂà∂Âè∞Ê†áÁ≠æÂàáÊç¢
      const consoleTabs = document.querySelectorAll('.console-tab');
      consoleTabs.forEach(tab => {
        const tabClickHandler = () => {
          consoleTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.dataset.tab;
          renderConsole();
        };
        tab.addEventListener('click', tabClickHandler);
        tab.addEventListener('touchend', (e) => {
          e.preventDefault();
          tabClickHandler();
        }, { passive: false });
      });

      // Ê∑ªÂä†ÂàùÂßãÊ¨¢ËøéÊó•Âøó
      console.log('ÁßªÂä®Á´ØÊéßÂà∂Âè∞Â∑≤ÂêØÂä®');
      console.info('ÂèØÂú®APIËÆæÁΩÆ‰∏≠ÊâìÂºÄÊéßÂà∂Âè∞Êü•ÁúãÊó•Âøó');
    })();
    // ========== ÁßªÂä®Á´ØÊéßÂà∂Âè∞ÂäüËÉΩÁªìÊùü ==========

    document.getElementById('add-world-book-btn').addEventListener('click', async () => {
      const name = await showCustomPrompt('ÂàõÂª∫‰∏ñÁïå‰π¶', 'ËØ∑ËæìÂÖ•‰π¶Âêç');
      if (name && name.trim()) {
        const newBook = {
          id: 'wb_' + Date.now(),
          name: name.trim(),
          content: '',
          isGlobal: false,
          injectPosition: 'before' // ÈªòËÆ§‰∏∫Ââç
        };
        await db.worldBooks.add(newBook);
        state.worldBooks.push(newBook);
        renderWorldBookScreen();
        openWorldBookEditor(newBook.id);
      }
    });

    document.getElementById('save-world-book-btn').addEventListener('click', async () => {
      if (!editingWorldBookId) return;
      const book = state.worldBooks.find(wb => wb.id === editingWorldBookId);
      if (!book) return;


      const newName = document.getElementById('world-book-name-input').value.trim();
      if (!newName) {
        alert('‰π¶Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
        return;
      }
      book.name = newName;
      const categoryId = document.getElementById('world-book-category-select').value;
      book.categoryId = categoryId ? parseInt(categoryId) : null;

      // ‰øùÂ≠òÂÖ®Â±ÄÂºÄÂÖ≥Áä∂ÊÄÅ
      const isGlobal = document.getElementById('world-book-global-switch').checked;
      book.isGlobal = isGlobal;

      // ‰øùÂ≠òÊ≥®ÂÖ•‰ΩçÁΩÆÔºàÊó†ËÆ∫ÊòØÂê¶ÂÖ®Â±ÄÈÉΩ‰øùÂ≠òÔºâ
      const injectPosition = document.getElementById('world-book-inject-position-select').value;
      book.injectPosition = injectPosition;

      const entriesContainer = document.getElementById('world-book-entries-container');
      const entryBlocks = entriesContainer.querySelectorAll('.message-editor-block');
      const newEntries = [];

      entryBlocks.forEach(block => {
        const keysInput = block.querySelector('.entry-keys-input').value.trim();
        const content = block.querySelector('.entry-content-textarea').value.trim();
        const isEnabled = block.querySelector('.entry-enabled-switch').checked;
        if (content) {
          newEntries.push({
            comment: block.querySelector('.entry-comment-input').value.trim(),
            keys: keysInput ? keysInput.split(',').map(k => k.trim()).filter(k => k) : [],
            content: content,
            enabled: isEnabled
          });
        }
      });
      book.content = newEntries;


      await db.worldBooks.put(book);
      document.getElementById('world-book-editor-title').textContent = newName;
      editingWorldBookId = null;


      showScreen('world-book-screen');


      await renderWorldBookScreen();
    });

    document.getElementById('chat-messages').addEventListener('click', async (e) => {
      if (e.target.tagName === 'IMG') {
        // Ê£ÄÊü•ÊòØÂê¶ÊòØËÅäÂ§©ÈáåÁöÑÂõæÁâáÁ±ªÂêç
        if (e.target.classList.contains('chat-image') ||

          e.target.classList.contains('realimag-image') ||
          e.target.classList.contains('naiimag-image')) {

          e.stopPropagation(); // ÈòªÊ≠¢Ê∞îÊ≥°Ë¢´ÈÄâ‰∏≠Á≠âÂÖ∂‰ªñ‰∫ã‰ª∂

          // --- Ê†∏ÂøÉ‰øÆÂ§çÈÄªËæëÔºöÊ£ÄÊµãËøûÂáª ---

          // Â¶ÇÊûúËøôÊòØ‰∏Ä‰∏™Âø´ÈÄüÁöÑÁ¨¨‰∫åÊ¨°ÊàñÁ¨¨‰∏âÊ¨°ÁÇπÂáª (detail > 1)Ôºå
          // ËØ¥ÊòéÁî®Êà∑ÂèØËÉΩÂú®Â∞ùËØï‰∏âÂáª‰∏ãËΩΩÔºåÊàñËÄÖÊòØÂèåÂáª„ÄÇ
          // Ê≠§Êó∂Êàë‰ª¨Ë¶ÅÂèñÊ∂àÊéâËøòÊ≤°ÊâßË°åÁöÑ‚ÄúÊîæÂ§ß‚ÄùÊìç‰ΩúÔºåÂπ∂‰∏çÂÅö‰ªª‰ΩïÊîæÂ§ßÂ§ÑÁêÜ„ÄÇ
          if (e.detail > 1) {
            if (window.simpleZoomTimer) {
              clearTimeout(window.simpleZoomTimer);
              window.simpleZoomTimer = null;
            }
            return; // Áõ¥Êé•ÈÄÄÂá∫ÔºåÊääËàûÂè∞ÁïôÁªô‰∏âÂáª‰∏ãËΩΩÈÄªËæë
          }

          // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊ¨°ÁÇπÂáªÔºåÊàë‰ª¨‰∏çË¶ÅÁ´ãÂàªÊîæÂ§ßÔºåËÄåÊòØÁ≠â 250ms
          // Â¶ÇÊûú 250ms ÂÜÖÊ≤°ÊúâÁ¨¨‰∫åÊ¨°ÁÇπÂáªÔºåÊâçÊâßË°åÊîæÂ§ß„ÄÇ
          window.simpleZoomTimer = setTimeout(() => {
            openSimpleImageZoom(e.target.src);
            window.simpleZoomTimer = null;
          }, 250); // 250ÊØ´ÁßíÂª∂ËøüÔºåÊó¢‰∏çÂΩ±Âìç‰ΩìÊÑüÔºåÂèàËÉΩÈÅøÂºÄËøûÂáª

          return;
        }
      }

      // 1. ‰øÆÂ§ç‰∏ãËΩΩÊåâÈíÆ (Â∏¶ËΩ¨ÂúàÂä®Áîª)
      const downloadBtn = e.target.closest('.nai-save-local-btn');
      if (downloadBtn) {
        e.stopPropagation();

        // --- Êñ∞Â¢ûÔºöËÆ©ÂÆÉËΩ¨Ëµ∑Êù• ---
        downloadBtn.classList.add('loading'); // Ê∑ªÂä†ËΩ¨ÂúàÊ†∑Âºè
        downloadBtn.disabled = true;          // Èò≤Ê≠¢ËøûÁÇπ

        const bubble = downloadBtn.closest('.message-bubble');
        const img = bubble ? bubble.querySelector('img.chat-image, img.realimag-image, img.naiimag-image') : null;

        if (img && img.src) {
          addVisualFeedback(img);
          const filename = generateFilename(img);
          downloadImage(img.src, filename);
        }

        // --- Êñ∞Â¢ûÔºöËΩ¨‰∏Ä‰ºöÂÑøÂêéÂÅúÊ≠¢ (800ÊØ´ÁßíÂêéÊÅ¢Â§ç) ---
        // Âõ†‰∏∫‰∏ãËΩΩÊòØÊµèËßàÂô®Êé•ÁÆ°ÁöÑÔºåJSÊó†Ê≥ïÁü•ÈÅìÁ°ÆÂàáÁªìÊùüÊó∂Èó¥ÔºåÁªô‰∏™ËßÜËßâÂèçÈ¶àÊó∂Èó¥Âç≥ÂèØ
        setTimeout(() => {
          downloadBtn.classList.remove('loading');
          downloadBtn.disabled = false;
        }, 800);

        return;
      }
      // --- ‰øÆÂ§ç‰∏ä‰º†ÂõæÂ∫äÊåâÈíÆ (ÂéüÊú¨ÊºèÊéâ‰∫ÜËøô‰∏™ÁõëÂê¨) ---
      const naiUploadBtn = e.target.closest('.nai-upload-imgbb-btn');
      if (naiUploadBtn) {
        e.stopPropagation();
        const bubble = e.target.closest('.message-bubble');
        if (bubble) {
          const timestamp = parseInt(bubble.dataset.timestamp);
          if (!isNaN(timestamp)) {
            // Ë∞ÉÁî®Â∑≤ÊúâÁöÑ NAI ‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
            await handleSilentUploadNaiImage(timestamp, naiUploadBtn);
          }
        }
        return;
      }
      const regenBtn = e.target.closest('.nai-regenerate-btn');
      if (regenBtn) {
        e.stopPropagation();
        const bubble = e.target.closest('.message-bubble');
        if (bubble) {
          const timestamp = parseInt(bubble.dataset.timestamp);
          if (!isNaN(timestamp)) {
            await handleRegenerateNaiImage(timestamp, regenBtn);
          }
        }
        return;
      }
      const userUploadBtn = e.target.closest('.user-upload-imgbb-btn');
      if (userUploadBtn) {
        e.stopPropagation();
        const bubble = e.target.closest('.message-bubble');
        if (bubble) {
          const timestamp = parseInt(bubble.dataset.timestamp);
          if (!isNaN(timestamp)) {
            await handleSilentUploadUserImage(timestamp, userUploadBtn);
          }
        }
        return;
      }
      const voiceBody = e.target.closest('.voice-message-body[data-text]');
      if (voiceBody) {

        const chat = state.chats[state.activeChatId];
        if (!chat) return;

        // ÂÖàÊòæÁ§∫/ÈöêËóèÊñáÂ≠óÔºàÊâÄÊúâËØ≠Èü≥Ê∂àÊÅØÈÉΩÊîØÊåÅÔºâ
        toggleVoiceTranscript(voiceBody);

        // Ê£ÄÊü•ÊòØÂê¶ÊúâÁúüÂÆûÈü≥È¢ëÊï∞ÊçÆ
        if (voiceBody.dataset.audio) {
          // Êí≠ÊîæÁúüÂÆûÂΩïÈü≥
          playRealAudio(voiceBody);
          return;
        }

        // Âê¶Âàô‰ΩøÁî®ÂéüÊúâÁöÑTTSÈÄªËæë


        const bubble = voiceBody.closest('.message-bubble');
        const transcriptEl = bubble ? bubble.querySelector('.voice-transcript') : null;


        if (voiceBody.dataset.voiceId && transcriptEl && transcriptEl.style.display === 'block') {


          if (chat.isGroup) {
            console.log("ËøôÊòØ‰∏ÄÊù°Áæ§ËÅäËØ≠Èü≥Ê∂àÊÅØÔºåÂ∑≤Á¶ÅÊ≠¢ÂèëËµ∑TTSËØ∑Ê±Ç„ÄÇ");
            return;
          }
          if (chat.settings.enableTts === false) {
            console.log(`‚Äú${chat.name}‚ÄùÁöÑTTSÂäüËÉΩÂ∑≤ÂÖ≥Èó≠ÔºåÂ∑≤Á¶ÅÊ≠¢ÂèëËµ∑TTSËØ∑Ê±Ç„ÄÇ`);
            return;
          }


          playTtsAudio(voiceBody);
        }

        return;
      }

      const detailsBtn = e.target.closest('.waimai-details-btn');
      if (detailsBtn) {
        const bubble = detailsBtn.closest('.message-bubble');
        if (bubble) {
          const timestamp = parseInt(bubble.dataset.timestamp);
          if (!isNaN(timestamp)) {
            showWaimaiDetails(timestamp);
            return;
          }
        }
      }



      const choiceBtn = e.target.closest('.waimai-user-actions button');
      if (choiceBtn) {
        const bubble = choiceBtn.closest('.message-bubble');
        if (bubble) {
          const timestamp = parseInt(bubble.dataset.timestamp);
          const choice = choiceBtn.dataset.choice;
          if (!isNaN(timestamp) && choice) {
            await handleWaimaiResponse(timestamp, choice);
            return;
          }
        }
      }


      const deletedPostPlaceholder = e.target.closest('.post-deleted-placeholder');
      if (deletedPostPlaceholder) {
        const postId = parseInt(deletedPostPlaceholder.dataset.postId);
        if (!isNaN(postId)) {
          const post = await db.qzonePosts.get(postId);
          if (post) {
            let originalContent = '';
            const authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'Êú™Áü•‰ΩúËÄÖ');

            if (post.type === 'shuoshuo') {
              originalContent = post.content;
            } else {
              originalContent = post.publicText || '';
              if (post.imageUrl) originalContent += `\n[ÂõæÁâá]`;
              if (post.hiddenContent) originalContent += `\n[ÊñáÂ≠óÂõæÂÜÖÂÆπ: ${post.hiddenContent}]`;
            }

            showCustomAlert(
              `Êù•Ëá™ ${authorName} ÁöÑÂ∑≤Âà†Èô§Âä®ÊÄÅ`,
              originalContent.replace(/\n/g, '<br>')
            );
          } else {
            showCustomAlert('ÊèêÁ§∫', 'ËøôÊù°Âä®ÊÄÅÁöÑÂéüÂßãÊï∞ÊçÆÂ∑≤Ë¢´ÂΩªÂ∫ïÊ∏ÖÈô§„ÄÇ');
          }
        }
        return;
      }

      const aiImage = e.target.closest('.ai-generated-image');
      if (aiImage) {
        const description = aiImage.dataset.description;
        if (description) showCustomAlert('ÁÖßÁâáÊèèËø∞', description);
        return;
      }

      const quoteBlock = e.target.closest('.quoted-message');
      if (quoteBlock && quoteBlock.dataset.originalTimestamp) {
        const originalTimestamp = parseInt(quoteBlock.dataset.originalTimestamp);
        if (!isNaN(originalTimestamp)) {
          scrollToOriginalMessage(originalTimestamp);
        }
      }

      const giftCard = e.target.closest('.gift-card');
      if (giftCard) {
        const bubble = giftCard.closest('.message-bubble');
        if (bubble) {
          showGiftReceipt(parseInt(bubble.dataset.timestamp));
        }
      }

      const packetCard = e.target.closest('.red-packet-card');
      if (packetCard) {
        const messageBubble = packetCard.closest('.message-bubble');
        if (messageBubble && messageBubble.dataset.timestamp) {
          const timestamp = parseInt(messageBubble.dataset.timestamp);
          handlePacketClick(timestamp);
        }
      }

      const pollCard = e.target.closest('.poll-card');
      if (pollCard) {
        const timestamp = parseInt(pollCard.dataset.pollTimestamp);
        if (isNaN(timestamp)) return;

        const optionItem = e.target.closest('.poll-option-item');
        if (optionItem && !pollCard.classList.contains('closed')) {
          handleUserVote(timestamp, optionItem.dataset.option);
          return;
        }

        const actionBtn = e.target.closest('.poll-action-btn');
        if (actionBtn) {
          if (pollCard.classList.contains('closed')) {
            showPollResults(timestamp);
          } else {
            endPoll(timestamp);
          }
          return;
        }

        if (pollCard.classList.contains('closed')) {
          showPollResults(timestamp);
        }
      }



      const placeholder = e.target.closest('.recalled-message-placeholder');
      if (placeholder) {
        const chat = state.chats[state.activeChatId];
        const wrapper = placeholder.closest('.message-wrapper');
        if (chat && wrapper) {
          const timestamp = parseInt(wrapper.dataset.timestamp);
          const recalledMsg = chat.history.find(m => m.timestamp === timestamp);

          if (recalledMsg && recalledMsg.recalledData) {
            let originalContentText = '';
            const recalled = recalledMsg.recalledData;

            if (recalled.originalType === 'text') {
              originalContentText = `ÂéüÊñá: "${recalled.originalContent}"`;
            } else {
              originalContentText = `Êí§Âõû‰∫Ü‰∏ÄÊù°[${recalled.originalType}]Á±ªÂûãÁöÑÊ∂àÊÅØ`;
            }
            showCustomAlert('Â∑≤Êí§ÂõûÁöÑÊ∂àÊÅØ', originalContentText);
          }
        }
      }

      const linkCard = e.target.closest('.link-share-card');
      if (linkCard && linkCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(linkCard.dataset.timestamp);
        openSharedHistoryViewer(timestamp);
      }

      const bubble = e.target.closest('.message-bubble');
      if (bubble && bubble.classList.contains('ai') && bubble.classList.contains('is-transfer') && bubble.dataset.status === 'pending') {
        const timestamp = parseInt(bubble.dataset.timestamp);
        if (!isNaN(timestamp)) {
          showTransferActionModal(timestamp);
        }
      }
    });


    const chatSettingsModal = document.getElementById('chat-settings-modal');
    const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
    const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');

    function updateWorldBookSelectionDisplay() {
      const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked');
      const displayText = document.querySelector('.selected-options-text');

      if (checkedBoxes.length === 0) {
        displayText.textContent = '-- ÁÇπÂáªÈÄâÊã© --';
      } else if (checkedBoxes.length > 2) {
        displayText.textContent = `Â∑≤ÈÄâÊã© ${checkedBoxes.length} Êú¨‰∏ñÁïå‰π¶`;
      } else {
        const displayItems = Array.from(checkedBoxes).map(cb => {
          return cb.parentElement.textContent.trim();
        });
        displayText.textContent = displayItems.join(', ');
      }
    }


    worldBookSelectBox.addEventListener('click', (e) => {
      e.stopPropagation();
      worldBookCheckboxesContainer.classList.toggle('visible');
      worldBookSelectBox.classList.toggle('expanded');
    });
    document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
    window.addEventListener('click', (e) => {
      if (!document.querySelector('.custom-multiselect').contains(e.target)) {
        worldBookCheckboxesContainer.classList.remove('visible');
        worldBookSelectBox.classList.remove('expanded');
      }
    });

    document.getElementById('chat-settings-btn').addEventListener('click', async () => {
      loadThemePresetsDropdown();
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];
      const isGroup = chat.isGroup;

      const weatherSection = document.getElementById('weather-settings-section');
      if (isGroup) {
        weatherSection.style.display = 'none';
      } else {
        weatherSection.style.display = 'block';

        // ËØªÂèñÈÖçÁΩÆ
        const wSettings = chat.settings.weather || {};

        const weatherSwitch = document.getElementById('enable-weather-switch');
        const weatherConfigContainer = document.getElementById('weather-config-container');

        weatherSwitch.checked = wSettings.enabled || false;
        weatherConfigContainer.style.display = wSettings.enabled ? 'block' : 'none';

        // ÁªëÂÆöÂºÄÂÖ≥ÊòæÁ§∫ÈöêËóè
        weatherSwitch.onclick = (e) => {
          weatherConfigContainer.style.display = e.target.checked ? 'block' : 'none';
        };

        // ÂõûÊòæ User Êï∞ÊçÆ
        document.getElementById('user-virtual-city').value = wSettings.userVirtualCity || '';
        document.getElementById('user-city-lat').value = wSettings.userLat || '';
        document.getElementById('user-city-lon').value = wSettings.userLon || '';
        if (wSettings.userRealCity) {
          document.getElementById('user-city-result').textContent = `Â∑≤Êò†Â∞Ñ: ${wSettings.userRealCity} (${wSettings.userLat}, ${wSettings.userLon})`;
          document.getElementById('user-city-result').style.color = 'green';
        } else {
          document.getElementById('user-city-result').textContent = 'Êú™ËÆæÁΩÆÊò†Â∞Ñ';
          document.getElementById('user-city-result').style.color = '#007bff';
        }

        // ÂõûÊòæ Char Êï∞ÊçÆ
        document.getElementById('char-virtual-city').value = wSettings.charVirtualCity || '';
        document.getElementById('char-city-lat').value = wSettings.charLat || '';
        document.getElementById('char-city-lon').value = wSettings.charLon || '';
        if (wSettings.charRealCity) {
          document.getElementById('char-city-result').textContent = `Â∑≤Êò†Â∞Ñ: ${wSettings.charRealCity} (${wSettings.charLat}, ${wSettings.charLon})`;
          document.getElementById('char-city-result').style.color = 'green';
        } else {
          document.getElementById('char-city-result').textContent = 'Êú™ËÆæÁΩÆÊò†Â∞Ñ';
          document.getElementById('char-city-result').style.color = '#007bff';
        }
      }
      const switchGreetingGroup = document.getElementById('switch-greeting-group');
      if (!isGroup && chat.settings.alternateGreetings && chat.settings.alternateGreetings.length > 0) {
        switchGreetingGroup.style.display = 'block';
      } else {
        switchGreetingGroup.style.display = 'none';
      }

      document.getElementById('chat-name-group').style.display = 'block';
      document.getElementById('my-persona-group').style.display = 'block';
      document.getElementById('my-avatar-group').style.display = 'block';
      document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
      document.getElementById('my-nickname-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
      document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
      document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
      document.getElementById('ai-original-name-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('ai-voice-id-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('inject-thought-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('todo-list-setting-group').style.display = isGroup ? 'none' : 'flex';
      document.getElementById('offline-mode-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('ai-cooldown-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('group-cooldown-group').style.display = isGroup ? 'block' : 'none';
      document.getElementById('memory-archive-section').style.display = isGroup ? 'none' : 'block';
      document.getElementById('export-character-full-btn').style.display = isGroup ? 'none' : 'block';
      document.getElementById('chat-name-input').value = chat.name;

      // Âä†ËΩΩËßíËâ≤ÂõΩÁ±ç
      const countrySelect = document.getElementById('character-country-select');
      if (!isGroup) {
        document.getElementById('character-country-group').style.display = 'block';
        countrySelect.value = chat.country || 'China';
      } else {
        document.getElementById('character-country-group').style.display = 'none';
      }

      document.getElementById('my-persona').value = chat.settings.myPersona;
      document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
      document.getElementById('max-memory').value = chat.settings.maxMemory;
      document.getElementById('linked-memory-count').value = chat.settings.linkedMemoryCount || 10;
      const bgPreview = document.getElementById('bg-preview');
      const removeBgBtn = document.getElementById('remove-bg-btn');
      if (chat.settings.background) {
        bgPreview.src = chat.settings.background;
        bgPreview.style.display = 'block';
        removeBgBtn.style.display = 'inline-block';
      } else {
        bgPreview.style.display = 'none';
        removeBgBtn.style.display = 'none';
      }
      document.getElementById('lyrics-position-group').style.display = 'block';

      document.getElementById('single-char-background-activity-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('group-background-activity-group').style.display = isGroup ? 'block' : 'none';




      const timePerceptionToggle = document.getElementById('time-perception-toggle');
      const timeZoneGroup = document.getElementById('time-zone-group');
      timePerceptionToggle.checked = chat.settings.enableTimePerception;
      timeZoneGroup.style.display = timePerceptionToggle.checked ? 'block' : 'none';


      const timezoneSelect = document.getElementById('time-zone-select');

      const timezones = Intl.supportedValuesOf('timeZone');
      timezoneSelect.innerHTML = '';
      timezones.forEach(tz => {
        const option = document.createElement('option');
        option.value = tz;
        option.textContent = tz;
        timezoneSelect.appendChild(option);
      });

      timezoneSelect.value = chat.settings.timeZone || 'Asia/Shanghai';
      document.getElementById('enable-synth-music-switch').checked = chat.settings.enableSynthMusic || false;
      document.getElementById('narrator-mode-toggle').checked = chat.settings.enableNarratorMode || false;
      if (isGroup) {

        document.getElementById('group-background-activity-switch').checked = chat.settings.enableBackgroundActivity;
        document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
        document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
        document.getElementById('group-action-cooldown-input').value = chat.settings.actionCooldownMinutes || 10;


        document.getElementById('single-char-background-activity-group').style.display = 'none';
        renderGroupMemberSettings(chat.members);
      } else {

        document.getElementById('single-char-background-activity-group').style.display = 'block';
        document.getElementById('enable-todo-list-switch').checked = chat.settings.enableTodoList || false;
        // --- ‰øÆÂ§çÂ§©Ê∞îËÆæÁΩÆÂõûÊòæÈÄªËæë ---
        const weatherSection = document.getElementById('weather-settings-section');
        weatherSection.style.display = 'block';

        // ËØªÂèñÂΩìÂâçËßíËâ≤ÁöÑÈÖçÁΩÆ
        const wSettings = chat.settings.weather || {};

        const weatherSwitch = document.getElementById('enable-weather-switch');
        const weatherConfigContainer = document.getElementById('weather-config-container');

        weatherSwitch.checked = wSettings.enabled || false;
        weatherConfigContainer.style.display = wSettings.enabled ? 'block' : 'none';

        // ÁªëÂÆöÂºÄÂÖ≥ÊòæÁ§∫ÈöêËóè (Èò≤Ê≠¢‰∫ã‰ª∂ÈáçÂ§çÁªëÂÆöÔºåÂÖàÁßªÈô§ÂÜçÊ∑ªÂä†ÔºåÊàñËÄÖ‰æùËµñ HTML onclick ÈÄªËæë)
        weatherSwitch.onclick = (e) => {
          weatherConfigContainer.style.display = e.target.checked ? 'block' : 'none';
        };

        // 1. ÂõûÊòæ User Êï∞ÊçÆ
        document.getElementById('user-virtual-city').value = wSettings.userVirtualCity || '';

        // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„Äë: ÊòæÂºèËÆæÁΩÆÊêúÁ¥¢Ê°ÜÁöÑÂÄº‰∏∫Â∑≤‰øùÂ≠òÁöÑÂüéÂ∏ÇÂêçÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÊ∏ÖÁ©∫
        const userRealCityInput = document.getElementById('user-real-city-search');
        userRealCityInput.value = wSettings.userRealCity || '';
        userRealCityInput.dataset.realName = wSettings.userRealCity || ''; // ÂêåÊ≠• dataset

        document.getElementById('user-city-lat').value = wSettings.userLat || '';
        document.getElementById('user-city-lon').value = wSettings.userLon || '';

        if (wSettings.userRealCity) {
          document.getElementById('user-city-result').textContent = `Â∑≤Êò†Â∞Ñ: ${wSettings.userRealCity} (${wSettings.userLat}, ${wSettings.userLon})`;
          document.getElementById('user-city-result').style.color = 'green';
        } else {
          document.getElementById('user-city-result').textContent = 'Êú™ËÆæÁΩÆÊò†Â∞Ñ';
          document.getElementById('user-city-result').style.color = '#007bff';
        }

        // 2. ÂõûÊòæ Char Êï∞ÊçÆ
        document.getElementById('char-virtual-city').value = wSettings.charVirtualCity || '';

        // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„Äë: ÊòæÂºèËÆæÁΩÆÊêúÁ¥¢Ê°ÜÁöÑÂÄº‰∏∫Â∑≤‰øùÂ≠òÁöÑÂüéÂ∏ÇÂêçÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÊ∏ÖÁ©∫
        const charRealCityInput = document.getElementById('char-real-city-search');
        charRealCityInput.value = wSettings.charRealCity || '';
        charRealCityInput.dataset.realName = wSettings.charRealCity || ''; // ÂêåÊ≠• dataset

        document.getElementById('char-city-lat').value = wSettings.charLat || '';
        document.getElementById('char-city-lon').value = wSettings.charLon || '';

        if (wSettings.charRealCity) {
          document.getElementById('char-city-result').textContent = `Â∑≤Êò†Â∞Ñ: ${wSettings.charRealCity} (${wSettings.charLat}, ${wSettings.charLon})`;
          document.getElementById('char-city-result').style.color = 'green';
        } else {
          document.getElementById('char-city-result').textContent = 'Êú™ËÆæÁΩÆÊò†Â∞Ñ';
          document.getElementById('char-city-result').style.color = '#007bff';
        }
        document.getElementById('char-background-activity-switch').checked = chat.settings.enableBackgroundActivity;
        document.getElementById('inject-thought-toggle').checked = chat.settings.injectLatestThought;
        document.getElementById('char-auto-cart-clear-switch').checked = chat.settings.enableAutoCartClear || false;

        // Êñ∞Â¢ûÔºöËØªÂèñAIË°å‰∏∫ÊéßÂà∂ËÆæÁΩÆ
        const thoughtsSelect = document.getElementById('chat-enable-thoughts-select');
        if (chat.settings.enableThoughts === null || chat.settings.enableThoughts === undefined) {
          thoughtsSelect.value = 'null';
        } else {
          thoughtsSelect.value = String(chat.settings.enableThoughts);
        }

        const qzoneSelect = document.getElementById('chat-enable-qzone-actions-select');
        if (chat.settings.enableQzoneActions === null || chat.settings.enableQzoneActions === undefined) {
          qzoneSelect.value = 'null';
        } else {
          qzoneSelect.value = String(chat.settings.enableQzoneActions);
        }

        const viewMyPhoneSelect = document.getElementById('chat-enable-view-myphone-select');
        if (chat.settings.enableViewMyPhone === null || chat.settings.enableViewMyPhone === undefined) {
          viewMyPhoneSelect.value = 'null';
        } else {
          viewMyPhoneSelect.value = String(chat.settings.enableViewMyPhone);
        }

        // Êõ¥Êñ∞ÂÖ®Â±ÄËÆæÁΩÆÁä∂ÊÄÅÊòæÁ§∫
        document.getElementById('global-thoughts-status').textContent = state.globalSettings.enableThoughts ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠';
        document.getElementById('global-qzone-status').textContent = state.globalSettings.enableQzoneActions ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠';
        document.getElementById('global-view-myphone-status').textContent = state.globalSettings.enableViewMyPhone ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠';

        const offlineModeToggle = document.getElementById('offline-mode-toggle');
        const offlineModeOptions = document.getElementById('offline-mode-options');
        const offlineMinInput = document.getElementById('offline-min-length-input');
        const offlineMaxInput = document.getElementById('offline-max-length-input');
        offlineModeToggle.checked = chat.settings.isOfflineMode || false;
        offlineModeOptions.style.display = offlineModeToggle.checked ? 'block' : 'none';
        offlineMinInput.value = chat.settings.offlineMinLength || 100;
        offlineMaxInput.value = chat.settings.offlineMaxLength || 300;
        const offlineContinuousToggle = document.getElementById('offline-continuous-layout-toggle');
        if (offlineContinuousToggle) offlineContinuousToggle.checked = chat.settings.offlineContinuousLayout || false;
        await renderOfflinePresetSelector(chat);

        // Âä†ËΩΩË°®ÊÉÖÂåÖËØÜÂõæËÆæÁΩÆ
        document.getElementById('enable-sticker-vision-checkbox').checked = chat.settings.enableStickerVision || false;

        document.getElementById('ai-original-name-input').value = chat.originalName;
        document.getElementById('ai-voice-id-input').value = chat.settings.minimaxVoiceId || '';

        document.getElementById('ai-voice-lang-group').style.display = isGroup ? 'none' : 'block';
        document.getElementById('ai-voice-lang-select').value = chat.settings.ttsLanguage || '';
        document.getElementById('chat-show-seconds-switch').checked = chat.settings.showSeconds !== undefined ? chat.settings.showSeconds : (state.globalSettings.showSeconds || false);
        document.getElementById('enable-tts-switch').checked = chat.settings.enableTts !== false;
        document.getElementById('ai-persona').value = chat.settings.aiPersona;
        document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('my-nickname-input').value = chat.settings.myNickname || 'Êàë';
        document.getElementById('ai-action-cooldown-input').value = chat.settings.actionCooldownMinutes || 10;
        const select = document.getElementById('assign-group-select');
        select.innerHTML = '<option value="">Êú™ÂàÜÁªÑ</option>';
        const groups = await db.qzoneGroups.toArray();
        groups.forEach(group => {
          const option = document.createElement('option');
          option.value = group.id;
          option.textContent = group.name;
          if (chat.groupId === group.id) option.selected = true;
          select.appendChild(option);
        });
        const lyricsPos = chat.settings.lyricsPosition || {
          vertical: 'top',
          horizontal: 'center',
          offset: 10
        };
        document.getElementById('lyrics-vertical-pos').value = lyricsPos.vertical;
        document.getElementById('lyrics-horizontal-pos').value = lyricsPos.horizontal;
        document.getElementById('lyrics-offset-input').value = lyricsPos.offset;
      }



      const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
      worldBookCheckboxesContainer.innerHTML = '';

      const [allCategories, allBooks] = await Promise.all([
        db.worldBookCategories.toArray(),
        db.worldBooks.toArray()
      ]);

      const linkedBookIds = new Set(chat.settings.linkedWorldBookIds || []);

      if (allBooks.length === 0) {
        worldBookCheckboxesContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a;">ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰Ωï‰∏ñÁïå‰π¶</p>';
      } else {

        allCategories.forEach(cat => {
          const booksInCategory = allBooks.filter(book => book.categoryId === cat.id);
          if (booksInCategory.length > 0) {
            const categoryHeader = document.createElement('h4');
            categoryHeader.textContent = cat.name;
            categoryHeader.style.cssText = 'margin: 10px 0 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 3px;';
            worldBookCheckboxesContainer.appendChild(categoryHeader);

            booksInCategory.forEach(book => {
              // ÂÖ®Â±Ä‰∏ñÁïå‰π¶Ëá™Âä®ÂãæÈÄâ
              const isChecked = linkedBookIds.has(book.id) || book.isGlobal === true;
              const label = document.createElement('label');
              const globalTag = book.isGlobal ? ' <span style="color: #ff5722; font-size: 12px;">[ÂÖ®Â±Ä]</span>' : '';
              label.innerHTML = `<input type="checkbox" value="book_${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}${globalTag}`;
              worldBookCheckboxesContainer.appendChild(label);
            });
          }
        });


        const uncategorizedBooks = allBooks.filter(book => !book.categoryId);
        if (uncategorizedBooks.length > 0) {
          const bookHeader = document.createElement('h4');
          bookHeader.textContent = 'Êú™ÂàÜÁ±ª';
          bookHeader.style.cssText = 'margin: 15px 0 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 3px;';
          worldBookCheckboxesContainer.appendChild(bookHeader);

          uncategorizedBooks.forEach(book => {
            // ÂÖ®Â±Ä‰∏ñÁïå‰π¶Ëá™Âä®ÂãæÈÄâ
            const isChecked = linkedBookIds.has(book.id) || book.isGlobal === true;
            const label = document.createElement('label');
            const globalTag = book.isGlobal ? ' <span style="color: #ff5722; font-size: 12px;">[ÂÖ®Â±Ä]</span>' : '';
            label.innerHTML = `<input type="checkbox" value="book_${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}${globalTag}`;
            worldBookCheckboxesContainer.appendChild(label);
          });
        }
      }


      updateWorldBookSelectionDisplay();

      const linkMemoryToggle = document.getElementById('link-memory-toggle');
      const linkedMemorySelection = document.getElementById('linked-memory-selection');
      const linkedChatsContainer = document.getElementById('linked-chats-checkboxes-container');
      const linkedMemoryIds = chat.settings.linkedMemoryChatIds || [];
      linkMemoryToggle.checked = linkedMemoryIds.length > 0;
      linkedMemorySelection.style.display = linkMemoryToggle.checked ? 'block' : 'none';
      linkedChatsContainer.innerHTML = '';
      Object.values(state.chats).forEach(c => {
        if (c.id === chat.id) return;
        const isChecked = linkedMemoryIds.includes(c.id);
        const prefix = c.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${c.id}" ${isChecked ? 'checked' : ''}> ${prefix} ${c.name}`;
        linkedChatsContainer.appendChild(label);
      });

      function updateLinkedMemorySelectionDisplay() {
        const checkedBoxes = linkedChatsContainer.querySelectorAll('input:checked');
        const displayText = linkedMemorySelection.querySelector('.selected-options-text');
        if (checkedBoxes.length === 0) {
          displayText.textContent = '-- ÁÇπÂáªÈÄâÊã© --';
        } else if (checkedBoxes.length > 2) {
          displayText.textContent = `Â∑≤ÈÄâÊã© ${checkedBoxes.length} È°π`;
        } else {
          displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', ');
        }
      }
      updateLinkedMemorySelectionDisplay();
      linkMemoryToggle.addEventListener('change', () => {
        linkedMemorySelection.style.display = linkMemoryToggle.checked ? 'block' : 'none';
      });
      const linkedMemorySelectBox = linkedMemorySelection.querySelector('.select-box');
      const newLinkedMemorySelectBox = linkedMemorySelectBox.cloneNode(true);
      linkedMemorySelectBox.parentNode.replaceChild(newLinkedMemorySelectBox, linkedMemorySelectBox);
      newLinkedMemorySelectBox.addEventListener('click', (e) => {
        e.stopPropagation();
        linkedChatsContainer.classList.toggle('visible');
        newLinkedMemorySelectBox.classList.toggle('expanded');
      });
      linkedChatsContainer.addEventListener('change', updateLinkedMemorySelectionDisplay);
      const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`);
      if (themeRadio) themeRadio.checked = true;
      const chatFontSizeSlider = document.getElementById('chat-font-size-slider');
      chatFontSizeSlider.value = chat.settings.fontSize || 13;
      document.getElementById('chat-font-size-value').textContent = `${chatFontSizeSlider.value}px`;
      const customCssInput = document.getElementById('custom-css-input');
      customCssInput.value = chat.settings.customCss || '';
      updateSettingsPreview();
      document.getElementById('auto-memory-toggle').checked = chat.settings.enableAutoMemory || false;
      document.getElementById('auto-memory-interval').value = chat.settings.autoMemoryInterval || 20;
      document.getElementById('diary-mode-toggle').checked = chat.settings.enableDiaryMode || false;
      document.getElementById('structured-memory-toggle').checked = chat.settings.enableStructuredMemory || false;
      document.getElementById('show-hidden-msg-toggle').checked = chat.settings.showHiddenMessages || false;

      // Âä†ËΩΩÂπ∂ÊòæÁ§∫/ÈöêËóèËßíËâ≤Áü•ÊôìÁ™•Â±èÂºÄÂÖ≥Ôºà‰ªÖÂçïËÅäÔºâ
      const phoneViewingAwarenessGroup = document.getElementById('phone-viewing-awareness-group');
      if (!isGroup) {
        phoneViewingAwarenessGroup.style.display = 'flex';
        document.getElementById('phone-viewing-awareness-toggle').checked = chat.settings.phoneViewingAwareness || false;
      } else {
        phoneViewingAwarenessGroup.style.display = 'none';
      }

      setTimeout(() => {
        updateTokenCountDisplay();

        const inputsToWatch = [
          'ai-persona', 'my-persona', 'max-memory',
          'linked-memory-count', 'auto-memory-toggle', 'auto-memory-interval',
          'diary-mode-toggle', 'structured-memory-toggle',
          'offline-mode-toggle', 'offline-min-length-input',
          'offline-max-length-input', 'offline-preset-select'
        ];

        inputsToWatch.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener('input', updateTokenCountDisplay);
          }
        });

        // ‰∏∫Â§öÈÄâÊ°ÜÂÆπÂô®Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
        document.getElementById('world-book-checkboxes-container').addEventListener('change', updateTokenCountDisplay);
        document.getElementById('linked-chats-checkboxes-container').addEventListener('change', updateTokenCountDisplay);
        document.getElementById('link-memory-toggle').addEventListener('change', updateTokenCountDisplay);
      }, 100);

      // Ê∏≤ÊüìËÆ∞ÂøÜÂ∫ìÂàóË°®
      renderMemoryArchiveList();

      // Âä†ËΩΩËßÜÈ¢ëÈÄöËØù‰ºòÂåñËÆæÁΩÆ
      if (typeof window.loadVideoOptimizationSettings === 'function') {
        window.loadVideoOptimizationSettings(chat);
      }

      showScreen('chat-settings-screen');
    });



    function renderGroupMemberSettings(members) {
      const container = document.getElementById('group-members-settings');
      container.innerHTML = '';
      members.forEach(member => {
        const div = document.createElement('div');
        div.className = 'member-editor';
        div.dataset.memberId = member.id;




        const memberAvatar = member.avatar || (state.chats[member.id] ? state.chats[member.id].settings.aiAvatar : defaultGroupMemberAvatar);

        div.innerHTML = `<img src="${memberAvatar}" alt="${member.groupNickname}"><div class="member-name">${member.groupNickname}</div>`;
        div.addEventListener('click', () => openMemberEditor(member.id));
        container.appendChild(div);
      });
    }



    document.getElementById('save-member-settings-btn').addEventListener('click', async () => {
      if (!editingMemberId) return;
      const chat = state.chats[state.activeChatId];
      const member = chat.members.find(m => m.id === editingMemberId);
      if (!member) return;

      const newNickname = document.getElementById('member-name-input').value.trim();
      if (!newNickname) {
        alert("Áæ§ÊòµÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
        return;
      }
      member.groupNickname = newNickname;
      member.persona = document.getElementById('member-persona-input').value;

      const newAvatarUrl = document.getElementById('member-avatar-preview').src;



      member.avatar = newAvatarUrl;


      const characterProfile = state.chats[member.id];
      if (characterProfile) {
        characterProfile.settings.aiAvatar = newAvatarUrl;
        await db.chats.put(characterProfile);
      }


      await db.chats.put(chat);


      renderGroupMemberSettings(chat.members);
      document.getElementById('member-settings-modal').classList.remove('visible');
      editingMemberId = null;
    });



    function openMemberEditor(memberId) {
      editingMemberId = memberId;
      const chat = state.chats[state.activeChatId];
      const member = chat.members.find(m => m.id === memberId);
      if (!member) return;

      document.getElementById('member-name-input').value = member.groupNickname;
      document.getElementById('member-persona-input').value = member.persona;



      const memberAvatar = member.avatar || (state.chats[member.id] ? state.chats[member.id].settings.aiAvatar : defaultGroupMemberAvatar);
      document.getElementById('member-avatar-preview').src = memberAvatar;

      document.getElementById('member-settings-modal').classList.add('visible');
    }

    document.getElementById('cancel-member-settings-btn').addEventListener('click', () => {
      document.getElementById('member-settings-modal').classList.remove('visible');
      editingMemberId = null;
    });


    document.getElementById('save-member-settings-btn').addEventListener('click', async () => {
      if (!editingMemberId) return;
      const chat = state.chats[state.activeChatId];
      const member = chat.members.find(m => m.id === editingMemberId);
      if (!member) return;

      const newNickname = document.getElementById('member-name-input').value.trim();
      if (!newNickname) {
        alert("Áæ§ÊòµÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
        return;
      }
      member.groupNickname = newNickname;
      member.persona = document.getElementById('member-persona-input').value;

      const newAvatarUrl = document.getElementById('member-avatar-preview').src;



      member.avatar = newAvatarUrl;


      const characterProfile = state.chats[member.id];
      if (characterProfile) {
        characterProfile.settings.aiAvatar = newAvatarUrl;
        await db.chats.put(characterProfile);
      }


      await db.chats.put(chat);


      renderGroupMemberSettings(chat.members);
      document.getElementById('member-settings-modal').classList.remove('visible');
      editingMemberId = null;
    });

    document.getElementById('reset-theme-btn').addEventListener('click', () => {
      document.getElementById('theme-default').checked = true;
    });



    document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];


      const oldOfflineModeState = chat.settings.isOfflineMode || false;


      const newName = document.getElementById('chat-name-input').value.trim();
      if (!newName) return alert('Â§áÊ≥®Âêç/Áæ§Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      if (!chat.isGroup && newName !== chat.name) {
        if (!chat.nameHistory) chat.nameHistory = [];
        if (!chat.nameHistory.includes(chat.name)) chat.nameHistory.push(chat.name);
      }
      chat.name = newName;

      // ‰øùÂ≠òËßíËâ≤ÂõΩÁ±ç
      const selectedCountry = document.getElementById('character-country-select').value;
      chat.country = selectedCountry;

      const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
      chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';
      chat.settings.fontSize = parseInt(document.getElementById('chat-font-size-slider').value);
      chat.settings.customCss = document.getElementById('custom-css-input').value.trim();
      chat.settings.myPersona = document.getElementById('my-persona').value;
      chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
      chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
      chat.settings.linkedMemoryCount = parseInt(document.getElementById('linked-memory-count').value) || 10;

      const checkedBookItems = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked');
      const newLinkedBookIds = [];
      checkedBookItems.forEach(cb => {
        if (cb.value.startsWith('book_')) {
          newLinkedBookIds.push(cb.value.replace('book_', ''));
        }
      });
      chat.settings.linkedWorldBookIds = newLinkedBookIds;

      const linkMemoryToggleChecked = document.getElementById('link-memory-toggle').checked;
      if (linkMemoryToggleChecked) {
        const checkedChats = document.querySelectorAll('#linked-chats-checkboxes-container input:checked');
        chat.settings.linkedMemoryChatIds = Array.from(checkedChats).map(cb => cb.value);
      } else {
        chat.settings.linkedMemoryChatIds = [];
      }
      chat.settings.enableAutoMemory = document.getElementById('auto-memory-toggle').checked;
      chat.settings.autoMemoryInterval = parseInt(document.getElementById('auto-memory-interval').value) || 20;
      chat.settings.enableDiaryMode = document.getElementById('diary-mode-toggle').checked;
      chat.settings.enableStructuredMemory = document.getElementById('structured-memory-toggle').checked;
      chat.settings.showHiddenMessages = document.getElementById('show-hidden-msg-toggle').checked;

      // ‰øùÂ≠òËßíËâ≤Áü•ÊôìÁ™•Â±èËÆæÁΩÆ
      if (!chat.isGroup) {
        chat.settings.phoneViewingAwareness = document.getElementById('phone-viewing-awareness-toggle').checked;
      }

      chat.settings.enableTimePerception = document.getElementById('time-perception-toggle').checked;
      chat.settings.timeZone = document.getElementById('time-zone-select').value;
      chat.settings.lyricsPosition = {
        vertical: document.getElementById('lyrics-vertical-pos').value,
        horizontal: document.getElementById('lyrics-horizontal-pos').value,
        offset: parseInt(document.getElementById('lyrics-offset-input').value) || 10
      };
      chat.settings.enableSynthMusic = document.getElementById('enable-synth-music-switch').checked;
      chat.settings.enableNarratorMode = document.getElementById('narrator-mode-toggle').checked;
      if (chat.isGroup) {
        chat.settings.enableBackgroundActivity = document.getElementById('group-background-activity-switch').checked;
        chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
        chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
        chat.settings.actionCooldownMinutes = parseInt(document.getElementById('group-action-cooldown-input').value) || 10;
      } else {
        chat.settings.enableBackgroundActivity = document.getElementById('char-background-activity-switch').checked;
        chat.settings.enableAutoCartClear = document.getElementById('char-auto-cart-clear-switch').checked;
        chat.settings.enableTodoList = document.getElementById('enable-todo-list-switch').checked;
        const newOfflineModeState = document.getElementById('offline-mode-toggle').checked;
        chat.settings.isOfflineMode = newOfflineModeState;
        const weatherEnabled = document.getElementById('enable-weather-switch').checked;
        const weatherSettings = {
          enabled: weatherEnabled,
          userVirtualCity: document.getElementById('user-virtual-city').value.trim(),
          userRealCity: document.getElementById('user-real-city-search').dataset.realName || chat.settings.weather?.userRealCity || '',
          userLat: parseFloat(document.getElementById('user-city-lat').value) || null,
          userLon: parseFloat(document.getElementById('user-city-lon').value) || null,

          charVirtualCity: document.getElementById('char-virtual-city').value.trim(),
          charRealCity: document.getElementById('char-real-city-search').dataset.realName || chat.settings.weather?.charRealCity || '',
          charLat: parseFloat(document.getElementById('char-city-lat').value) || null,
          charLon: parseFloat(document.getElementById('char-city-lon').value) || null
        };

        chat.settings.weather = weatherSettings;





        if (oldOfflineModeState === true && newOfflineModeState === false) {


          const switchInstruction = {
            role: 'system',
            content: '[Á≥ªÁªüÊåá‰ª§ÔºöÊ®°ÂºèÂ∑≤ÂàáÊç¢ÔºÅ‰Ω†Áé∞Âú®ÂõûÂà∞‰∫ÜÁ∫ø‰∏äËÅäÂ§©Ê®°Âºè„ÄÇ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂÆàÁ∫ø‰∏äÊ®°ÂºèÁöÑJSONÊï∞ÁªÑÊ†ºÂºèÔºå‰æãÂ¶Ç [{"type": "text", "content": "‰Ω†Â•Ω"}]]',
            timestamp: Date.now(),
            isHidden: true
          };


          chat.history.push(switchInstruction);
          console.log("Â∑≤ÊàêÂäüÊ≥®ÂÖ•‚ÄúÂàáÊç¢Âà∞Á∫ø‰∏äÊ®°Âºè‚ÄùÁöÑÁ≥ªÁªüÊåá‰ª§„ÄÇ");
        }


        chat.settings.injectLatestThought = document.getElementById('inject-thought-toggle').checked;

        // Êñ∞Â¢ûÔºö‰øùÂ≠òAIË°å‰∏∫ÊéßÂà∂ËÆæÁΩÆ
        const thoughtsValue = document.getElementById('chat-enable-thoughts-select').value;
        if (thoughtsValue === 'null') {
          chat.settings.enableThoughts = null;
        } else {
          chat.settings.enableThoughts = thoughtsValue === 'true';
        }

        const qzoneValue = document.getElementById('chat-enable-qzone-actions-select').value;
        if (qzoneValue === 'null') {
          chat.settings.enableQzoneActions = null;
        } else {
          chat.settings.enableQzoneActions = qzoneValue === 'true';
        }

        const viewMyPhoneValue = document.getElementById('chat-enable-view-myphone-select').value;
        if (viewMyPhoneValue === 'null') {
          chat.settings.enableViewMyPhone = null;
        } else {
          chat.settings.enableViewMyPhone = viewMyPhoneValue === 'true';
        }

        chat.settings.offlineMinLength = parseInt(document.getElementById('offline-min-length-input').value) || 100;
        chat.settings.offlineMaxLength = parseInt(document.getElementById('offline-max-length-input').value) || 300;
        chat.settings.offlinePresetId = document.getElementById('offline-preset-select').value || null;
        const offlineContinuousEl = document.getElementById('offline-continuous-layout-toggle');
        if (offlineContinuousEl) chat.settings.offlineContinuousLayout = offlineContinuousEl.checked;

        // ‰øùÂ≠òË°®ÊÉÖÂåÖËØÜÂõæËÆæÁΩÆ
        chat.settings.enableStickerVision = document.getElementById('enable-sticker-vision-checkbox').checked;

        const newOriginalName = document.getElementById('ai-original-name-input').value.trim();
        if (!newOriginalName) return alert('ÂØπÊñπÊú¨Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
        chat.originalName = newOriginalName;
        chat.settings.aiPersona = document.getElementById('ai-persona').value;
        chat.settings.minimaxVoiceId = document.getElementById('ai-voice-id-input').value.trim();

        chat.settings.ttsLanguage = document.getElementById('ai-voice-lang-select').value;
        chat.settings.showSeconds = document.getElementById('chat-show-seconds-switch').checked;
        chat.settings.enableTts = document.getElementById('enable-tts-switch').checked;
        chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
        chat.settings.myNickname = document.getElementById('my-nickname-input').value.trim() || 'Êàë';
        chat.settings.actionCooldownMinutes = parseInt(document.getElementById('ai-action-cooldown-input').value) || 10;

        const selectedGroupId = document.getElementById('assign-group-select').value;
        chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
      }

      // ‰øùÂ≠òËßÜÈ¢ëÈÄöËØù‰ºòÂåñËÆæÁΩÆ
      if (typeof window.saveVideoOptimizationSettings === 'function') {
        window.saveVideoOptimizationSettings(chat);
      }

      await db.chats.put(chat);
      if (!chat.isGroup) {
        await syncCharacterNameInGroups(chat);
        await syncCharacterAvatarInGroups(chat);
      }
      applyLyricsBarPosition(chat);
      applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
      showScreen('chat-interface-screen');
      renderChatInterface(state.activeChatId);
      renderChatList();
    });

    // ==================== ËÆ∞ÂøÜÂ∫ìÂäüËÉΩ ====================

    // ‰øùÂ≠òËÆ∞ÂøÜÂ≠òÊ°£
    document.getElementById('save-memory-archive-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      // ÂºπÂá∫ËæìÂÖ•Ê°ÜËÆ©Áî®Êà∑ÂëΩÂêç
      const archiveName = await showCustomPrompt('‰øùÂ≠òËÆ∞ÂøÜÂ≠òÊ°£', 'ËØ∑‰∏∫Ëøô‰∏™Â≠òÊ°£ÂëΩÂêçÔºö', '');
      if (!archiveName || !archiveName.trim()) {
        return; // Áî®Êà∑ÂèñÊ∂àÊàñÊú™ËæìÂÖ•
      }

      try {
        // ÂàõÂª∫Â≠òÊ°£ÂØπË±°
        const archive = {
          id: Date.now(),
          name: archiveName.trim(),
          timestamp: Date.now(),
          chatId: chat.id,
          data: {
            // ËÅäÂ§©ËÆ∞ÂΩï
            history: JSON.parse(JSON.stringify(chat.history)),

            // ÈïøÊúüËÆ∞ÂøÜÔºàÊÄªÁªìÁöÑËÆ∞ÂøÜÔºâ
            longTermMemory: chat.longTermMemory ? JSON.parse(JSON.stringify(chat.longTermMemory)) : [],

            // ‰∫∫ËÆæÂíåÂ§¥ÂÉè
            settings: {
              aiPersona: chat.settings.aiPersona,
              aiAvatar: chat.settings.aiAvatar,
              myPersona: chat.settings.myPersona,
              myAvatar: chat.settings.myAvatar,
              myNickname: chat.settings.myNickname,

              // ÈïøÊúüËÆ∞ÂøÜ
              maxMemory: chat.settings.maxMemory,
              linkedMemoryCount: chat.settings.linkedMemoryCount,
              linkedMemoryChatIds: [...(chat.settings.linkedMemoryChatIds || [])],
              enableAutoMemory: chat.settings.enableAutoMemory,
              autoMemoryInterval: chat.settings.autoMemoryInterval,
              enableDiaryMode: chat.settings.enableDiaryMode,

              // ËØ≠Èü≥ÈÄöËØù
              enableTts: chat.settings.enableTts,
              minimaxVoiceId: chat.settings.minimaxVoiceId,
              ttsLanguage: chat.settings.ttsLanguage,

              // È¢ÑËÆæ
              linkedWorldBookIds: [...(chat.settings.linkedWorldBookIds || [])],
              offlinePresetId: chat.settings.offlinePresetId,

              // ÂÖ∂‰ªñËÆæÁΩÆ
              theme: chat.settings.theme,
              fontSize: chat.settings.fontSize,
              customCss: chat.settings.customCss,
              enableTimePerception: chat.settings.enableTimePerception,
              timeZone: chat.settings.timeZone,
              enableBackgroundActivity: chat.settings.enableBackgroundActivity,
              actionCooldownMinutes: chat.settings.actionCooldownMinutes,
              enableTodoList: chat.settings.enableTodoList,
              isOfflineMode: chat.settings.isOfflineMode,
              weather: chat.settings.weather ? JSON.parse(JSON.stringify(chat.settings.weather)) : null,
              enableSynthMusic: chat.settings.enableSynthMusic,
              enableNarratorMode: chat.settings.enableNarratorMode,
              showSeconds: chat.settings.showSeconds,
              lyricsPosition: chat.settings.lyricsPosition ? JSON.parse(JSON.stringify(chat.settings.lyricsPosition)) : null
            },

            // ËßíËâ≤Áä∂ÊÄÅ
            heartfeltVoice: chat.heartfeltVoice,
            randomJottings: chat.randomJottings,
            status: chat.status ? JSON.parse(JSON.stringify(chat.status)) : null
          }
        };

        // ÂàùÂßãÂåñÂ≠òÊ°£Êï∞ÁªÑ
        if (!chat.memoryArchives) {
          chat.memoryArchives = [];
        }

        // Ê∑ªÂä†Â≠òÊ°£
        chat.memoryArchives.push(archive);

        // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        await db.chats.put(chat);

        // Âà∑Êñ∞Â≠òÊ°£ÂàóË°®
        renderMemoryArchiveList();

        await showCustomAlert('‰øùÂ≠òÊàêÂäü', `Â≠òÊ°£"${archiveName}"Â∑≤‰øùÂ≠òÔºÅ`);
      } catch (error) {
        console.error('‰øùÂ≠òËÆ∞ÂøÜÂ≠òÊ°£Â§±Ë¥•:', error);
        await showCustomAlert('‰øùÂ≠òÂ§±Ë¥•', '‰øùÂ≠òËÆ∞ÂøÜÂ≠òÊ°£Êó∂Âá∫ÈîôÔºåËØ∑ÈáçËØï„ÄÇ');
      }
    });

    // Ê∏≤ÊüìËÆ∞ÂøÜÂ≠òÊ°£ÂàóË°®
    function renderMemoryArchiveList() {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];
      const listContainer = document.getElementById('memory-archive-list');

      if (!chat.memoryArchives || chat.memoryArchives.length === 0) {
        listContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ÊöÇÊó†Â≠òÊ°£</div>';
        return;
      }

      // ÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàó
      const archives = [...chat.memoryArchives].sort((a, b) => b.timestamp - a.timestamp);

      listContainer.innerHTML = archives.map(archive => {
        const date = new Date(archive.timestamp);
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

        return `
          <div class="memory-archive-item">
            <div class="memory-archive-info">
              <div class="memory-archive-name">${escapeHTML(archive.name)}</div>
              <div class="memory-archive-date">${dateStr}</div>
            </div>
            <div class="memory-archive-actions">
              <button class="memory-archive-btn load" data-archive-id="${archive.id}">ËØªÊ°£</button>
              <button class="memory-archive-btn delete" data-archive-id="${archive.id}">Âà†Èô§</button>
            </div>
          </div>
        `;
      }).join('');

      // ÁªëÂÆöËØªÊ°£ÊåâÈíÆ‰∫ã‰ª∂
      listContainer.querySelectorAll('.memory-archive-btn.load').forEach(btn => {
        btn.addEventListener('click', async () => {
          const archiveId = parseInt(btn.dataset.archiveId);
          await loadMemoryArchive(archiveId);
        });
      });

      // ÁªëÂÆöÂà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
      listContainer.querySelectorAll('.memory-archive-btn.delete').forEach(btn => {
        btn.addEventListener('click', async () => {
          const archiveId = parseInt(btn.dataset.archiveId);
          await deleteMemoryArchive(archiveId);
        });
      });
    }

    // ËØªÂèñËÆ∞ÂøÜÂ≠òÊ°£
    async function loadMemoryArchive(archiveId) {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      const archive = chat.memoryArchives.find(a => a.id === archiveId);
      if (!archive) {
        await showCustomAlert('ÈîôËØØ', 'Êâæ‰∏çÂà∞ËØ•Â≠òÊ°£');
        return;
      }

      const confirmed = await showCustomConfirm(
        'ËØªÂèñÂ≠òÊ°£',
        `Á°ÆÂÆöË¶ÅËØªÂèñÂ≠òÊ°£"${archive.name}"ÂêóÔºü\n\nÂΩìÂâçÁöÑËÅäÂ§©ËÆ∞ÂΩïÂíåÊâÄÊúâËÆæÁΩÆÂ∞ÜË¢´ÂÆåÂÖ®Ë¶ÜÁõñÔºÅ`,
        { confirmButtonClass: 'btn-danger' }
      );

      if (!confirmed) return;

      try {
        // ÊÅ¢Â§çËÅäÂ§©ËÆ∞ÂΩï
        chat.history = JSON.parse(JSON.stringify(archive.data.history));

        // ÊÅ¢Â§çÈïøÊúüËÆ∞ÂøÜÔºàÊÄªÁªìÁöÑËÆ∞ÂøÜÔºâ
        chat.longTermMemory = archive.data.longTermMemory ? JSON.parse(JSON.stringify(archive.data.longTermMemory)) : [];

        // ÊÅ¢Â§çÊâÄÊúâËÆæÁΩÆ
        const savedSettings = archive.data.settings;
        chat.settings.aiPersona = savedSettings.aiPersona;
        chat.settings.aiAvatar = savedSettings.aiAvatar;
        chat.settings.myPersona = savedSettings.myPersona;
        chat.settings.myAvatar = savedSettings.myAvatar;
        chat.settings.myNickname = savedSettings.myNickname;
        chat.settings.maxMemory = savedSettings.maxMemory;
        chat.settings.linkedMemoryCount = savedSettings.linkedMemoryCount;
        chat.settings.linkedMemoryChatIds = [...(savedSettings.linkedMemoryChatIds || [])];
        chat.settings.enableAutoMemory = savedSettings.enableAutoMemory;
        chat.settings.autoMemoryInterval = savedSettings.autoMemoryInterval;
        chat.settings.enableDiaryMode = savedSettings.enableDiaryMode || false;
        chat.settings.enableTts = savedSettings.enableTts;
        chat.settings.minimaxVoiceId = savedSettings.minimaxVoiceId;
        chat.settings.ttsLanguage = savedSettings.ttsLanguage;
        chat.settings.linkedWorldBookIds = [...(savedSettings.linkedWorldBookIds || [])];
        chat.settings.offlinePresetId = savedSettings.offlinePresetId;
        chat.settings.theme = savedSettings.theme;
        chat.settings.fontSize = savedSettings.fontSize;
        chat.settings.customCss = savedSettings.customCss;
        chat.settings.enableTimePerception = savedSettings.enableTimePerception;
        chat.settings.timeZone = savedSettings.timeZone;
        chat.settings.enableBackgroundActivity = savedSettings.enableBackgroundActivity;
        chat.settings.actionCooldownMinutes = savedSettings.actionCooldownMinutes;
        chat.settings.enableTodoList = savedSettings.enableTodoList;
        chat.settings.isOfflineMode = savedSettings.isOfflineMode;
        chat.settings.weather = savedSettings.weather ? JSON.parse(JSON.stringify(savedSettings.weather)) : null;
        chat.settings.enableSynthMusic = savedSettings.enableSynthMusic;
        chat.settings.enableNarratorMode = savedSettings.enableNarratorMode;
        chat.settings.showSeconds = savedSettings.showSeconds;
        chat.settings.lyricsPosition = savedSettings.lyricsPosition ? JSON.parse(JSON.stringify(savedSettings.lyricsPosition)) : null;

        // ÊÅ¢Â§çËßíËâ≤Áä∂ÊÄÅ
        chat.heartfeltVoice = archive.data.heartfeltVoice;
        chat.randomJottings = archive.data.randomJottings;
        chat.status = archive.data.status ? JSON.parse(JSON.stringify(archive.data.status)) : null;

        // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        await db.chats.put(chat);

        // Âà∑Êñ∞ÁïåÈù¢
        renderChatInterface(state.activeChatId);
        renderChatList();

        // Â¶ÇÊûúÂú®ËÆæÁΩÆÈ°µÈù¢Ôºå‰πüÂà∑Êñ∞ËÆæÁΩÆÈ°µÈù¢
        const settingsModalElement = document.getElementById('chat-settings-modal');
        if (settingsModalElement && settingsModalElement.classList.contains('visible')) {
          showScreen('chat-interface-screen');
          setTimeout(() => {
            openChatSettings();
          }, 100);
        }

        await showCustomAlert('ËØªÊ°£ÊàêÂäü', `Â∑≤ÊàêÂäüËØªÂèñÂ≠òÊ°£"${archive.name}"ÔºÅ`);
      } catch (error) {
        console.error('ËØªÂèñËÆ∞ÂøÜÂ≠òÊ°£Â§±Ë¥•:', error);
        await showCustomAlert('ËØªÊ°£Â§±Ë¥•', 'ËØªÂèñËÆ∞ÂøÜÂ≠òÊ°£Êó∂Âá∫ÈîôÔºåËØ∑ÈáçËØï„ÄÇ');
      }
    }

    // Âà†Èô§ËÆ∞ÂøÜÂ≠òÊ°£
    async function deleteMemoryArchive(archiveId) {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      const archive = chat.memoryArchives.find(a => a.id === archiveId);
      if (!archive) {
        await showCustomAlert('ÈîôËØØ', 'Êâæ‰∏çÂà∞ËØ•Â≠òÊ°£');
        return;
      }

      const confirmed = await showCustomConfirm(
        'Âà†Èô§Â≠òÊ°£',
        `Á°ÆÂÆöË¶ÅÂà†Èô§Â≠òÊ°£"${archive.name}"ÂêóÔºü\n\nÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºÅ`,
        { confirmButtonClass: 'btn-danger' }
      );

      if (!confirmed) return;

      try {
        // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§
        chat.memoryArchives = chat.memoryArchives.filter(a => a.id !== archiveId);

        // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        await db.chats.put(chat);

        // Âà∑Êñ∞ÂàóË°®
        renderMemoryArchiveList();

        await showCustomAlert('Âà†Èô§ÊàêÂäü', `Â≠òÊ°£"${archive.name}"Â∑≤Âà†Èô§ÔºÅ`);
      } catch (error) {
        console.error('Âà†Èô§ËÆ∞ÂøÜÂ≠òÊ°£Â§±Ë¥•:', error);
        await showCustomAlert('Âà†Èô§Â§±Ë¥•', 'Âà†Èô§ËÆ∞ÂøÜÂ≠òÊ°£Êó∂Âá∫ÈîôÔºåËØ∑ÈáçËØï„ÄÇ');
      }
    }

    // ==================== ËÆ∞ÂøÜÂ∫ìÂäüËÉΩÁªìÊùü ====================

    // ==================== APIË∞ÉÁî®ÂéÜÂè≤Êü•ÁúãÂäüËÉΩ ====================

    // ÊâìÂºÄAPIÂéÜÂè≤Êü•ÁúãÂô®
    document.getElementById('view-api-history-btn').addEventListener('click', () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      renderApiHistoryList();
      document.getElementById('api-history-modal').classList.add('visible');
    });

    // ‰∏ÄÈîÆÂõûÂà∞Á¨¨‰∏ÄÊù°Ê∂àÊÅØ
    document.getElementById('scroll-to-first-message-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      // Ê£ÄÊü•Ê∂àÊÅØÊï∞Èáè - ‰ΩøÁî® chat.history ËÄå‰∏çÊòØ chat.messages
      const messageCount = chat.history ? chat.history.length : 0;

      if (messageCount === 0) {
        await showCustomAlert('ÊèêÁ§∫', 'ÂΩìÂâçËÅäÂ§©Ê≤°ÊúâÊ∂àÊÅØËÆ∞ÂΩï„ÄÇ');
        return;
      }

      // Â¶ÇÊûúÊ∂àÊÅØÊï∞ÈáèË∂ÖËøáÈòàÂÄºÔºåÊòæÁ§∫Ë≠¶Âëä
      const MESSAGE_WARNING_THRESHOLD = 500;

      if (messageCount > MESSAGE_WARNING_THRESHOLD) {
        const confirmed = await showCustomConfirm(
          'ÊÄßËÉΩÊèêÁ§∫',
          `ÂΩìÂâçËÅäÂ§©ÂÖ±Êúâ ${messageCount} Êù°Ê∂àÊÅØ„ÄÇ\n\nÊªöÂä®Âà∞Á¨¨‰∏ÄÊù°Ê∂àÊÅØÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥ÔºåÂπ∂ÂèØËÉΩÂá∫Áé∞Áü≠ÊöÇÂç°È°ø„ÄÇ\n\nÊòØÂê¶ÁªßÁª≠Ôºü`,
          {
            confirmText: 'ÁªßÁª≠',
            cancelText: 'ÂèñÊ∂à',
            confirmButtonClass: 'btn-primary'
          }
        );

        if (!confirmed) return;
      }

      // ÂÖ≥Èó≠ËÅäÂ§©ËØ¶ÊÉÖÈ°µÈù¢ÔºåËøîÂõûËÅäÂ§©ÁïåÈù¢
      showScreen('chat-interface-screen');

      // Á≠âÂæÖÁïåÈù¢Ê∏≤ÊüìÂÆåÊàê
      await new Promise(resolve => setTimeout(resolve, 150));

      // Ëé∑ÂèñÊ∂àÊÅØÂÆπÂô®
      const messagesContainer = document.getElementById('chat-messages');
      if (!messagesContainer) return;

      // ÊâßË°åÊªöÂä®Êìç‰Ωú
      requestAnimationFrame(() => {
        const firstMessage = messagesContainer.querySelector('.message-bubble');

        if (messageCount > MESSAGE_WARNING_THRESHOLD) {
          // Ê∂àÊÅØÊï∞ÈáèÂæàÂ§öÊó∂Ôºå‰ΩøÁî®instantÊ®°ÂºèÁõ¥Êé•Ë∑≥ËΩ¨ÔºåÈÅøÂÖçÂç°È°ø
          if (firstMessage) {
            firstMessage.scrollIntoView({
              behavior: 'instant',
              block: 'start'
            });
          } else {
            messagesContainer.scrollTop = 0;
          }

          // Ë∑≥ËΩ¨ÂÆåÊàêÂêéÔºåÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
          setTimeout(() => {
            showCustomAlert('Ë∑≥ËΩ¨ÂÆåÊàê', `Â∑≤Ë∑≥ËΩ¨Âà∞Á¨¨‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ\n\nÂΩìÂâçÂÖ±Êúâ ${messageCount} Êù°Ê∂àÊÅØËÆ∞ÂΩï„ÄÇ`);
          }, 100);
        } else {
          // Ê∂àÊÅØÊï∞ÈáèÈÄÇ‰∏≠Êó∂Ôºå‰ΩøÁî®Âπ≥ÊªëÊªöÂä®
          if (firstMessage) {
            firstMessage.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          } else {
            messagesContainer.scrollTo({
              top: 0,
              behavior: 'smooth'
            });
          }
        }
      });
    });

    // ‰∏ÄÈîÆÂõûÂà∞ÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ
    document.getElementById('scroll-to-last-message-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      // Ê£ÄÊü•Ê∂àÊÅØÊï∞Èáè
      const messageCount = chat.history ? chat.history.length : 0;

      if (messageCount === 0) {
        await showCustomAlert('ÊèêÁ§∫', 'ÂΩìÂâçËÅäÂ§©Ê≤°ÊúâÊ∂àÊÅØËÆ∞ÂΩï„ÄÇ');
        return;
      }

      // Â¶ÇÊûúÊ∂àÊÅØÊï∞ÈáèË∂ÖËøáÈòàÂÄºÔºåÊòæÁ§∫Ë≠¶Âëä
      const MESSAGE_WARNING_THRESHOLD = 500;

      if (messageCount > MESSAGE_WARNING_THRESHOLD) {
        const confirmed = await showCustomConfirm(
          'ÊÄßËÉΩÊèêÁ§∫',
          `ÂΩìÂâçËÅäÂ§©ÂÖ±Êúâ ${messageCount} Êù°Ê∂àÊÅØ„ÄÇ\n\nÊªöÂä®Âà∞ÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥ÔºåÂπ∂ÂèØËÉΩÂá∫Áé∞Áü≠ÊöÇÂç°È°ø„ÄÇ\n\nÊòØÂê¶ÁªßÁª≠Ôºü`,
          {
            confirmText: 'ÁªßÁª≠',
            cancelText: 'ÂèñÊ∂à',
            confirmButtonClass: 'btn-primary'
          }
        );

        if (!confirmed) return;
      }

      // ÂÖ≥Èó≠ËÅäÂ§©ËØ¶ÊÉÖÈ°µÈù¢ÔºåËøîÂõûËÅäÂ§©ÁïåÈù¢
      showScreen('chat-interface-screen');

      // Á≠âÂæÖÁïåÈù¢Ê∏≤ÊüìÂÆåÊàê
      await new Promise(resolve => setTimeout(resolve, 150));

      // Ëé∑ÂèñÊ∂àÊÅØÂÆπÂô®
      const messagesContainer = document.getElementById('chat-messages');
      if (!messagesContainer) return;

      // ÊâßË°åÊªöÂä®Êìç‰Ωú
      requestAnimationFrame(() => {
        // Ëé∑ÂèñÊâÄÊúâÊ∂àÊÅØÊ∞îÊ≥°
        const allMessages = messagesContainer.querySelectorAll('.message-bubble');
        const lastMessage = allMessages[allMessages.length - 1];

        if (messageCount > MESSAGE_WARNING_THRESHOLD) {
          // Ê∂àÊÅØÊï∞ÈáèÂæàÂ§öÊó∂Ôºå‰ΩøÁî®instantÊ®°ÂºèÁõ¥Êé•Ë∑≥ËΩ¨ÔºåÈÅøÂÖçÂç°È°ø
          if (lastMessage) {
            lastMessage.scrollIntoView({
              behavior: 'instant',
              block: 'end'
            });
          } else {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }

          // Ë∑≥ËΩ¨ÂÆåÊàêÂêéÔºåÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
          setTimeout(() => {
            showCustomAlert('Ë∑≥ËΩ¨ÂÆåÊàê', `Â∑≤Ë∑≥ËΩ¨Âà∞ÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ\n\nÂΩìÂâçÂÖ±Êúâ ${messageCount} Êù°Ê∂àÊÅØËÆ∞ÂΩï„ÄÇ`);
          }, 100);
        } else {
          // Ê∂àÊÅØÊï∞ÈáèÈÄÇ‰∏≠Êó∂Ôºå‰ΩøÁî®Âπ≥ÊªëÊªöÂä®
          if (lastMessage) {
            lastMessage.scrollIntoView({
              behavior: 'smooth',
              block: 'end'
            });
          } else {
            messagesContainer.scrollTo({
              top: messagesContainer.scrollHeight,
              behavior: 'smooth'
            });
          }
        }
      });
    });

    // ÂÖ≥Èó≠APIÂéÜÂè≤Êü•ÁúãÂô®
    document.getElementById('close-api-history-btn').addEventListener('click', () => {
      document.getElementById('api-history-modal').classList.remove('visible');
    });

    // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâAPIÂéÜÂè≤
    document.getElementById('api-history-select-all').addEventListener('change', (e) => {
      const checkboxes = document.querySelectorAll('.api-history-checkbox');
      checkboxes.forEach(cb => cb.checked = e.target.checked);
    });

    // Âà†Èô§ÈÄâ‰∏≠ÁöÑAPIÂéÜÂè≤
    document.getElementById('api-history-delete-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      // Ëé∑ÂèñÊâÄÊúâÈÄâ‰∏≠ÁöÑÂ§çÈÄâÊ°Ü
      const checkedBoxes = document.querySelectorAll('.api-history-checkbox:checked');

      if (checkedBoxes.length === 0) {
        await showCustomAlert('ÊèêÁ§∫', 'ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑËÆ∞ÂΩïÔºÅ');
        return;
      }

      const confirmed = await showCustomConfirm(
        'Âà†Èô§APIÂéÜÂè≤',
        `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${checkedBoxes.length} Êù°APIË∞ÉÁî®ÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºü\n\nÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºÅ`,
        { confirmButtonClass: 'btn-danger' }
      );

      if (!confirmed) return;

      try {
        // Ëé∑ÂèñË¶ÅÂà†Èô§ÁöÑÁ¥¢ÂºïÂàóË°®
        const indicesToDelete = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.index));

        // ÂàõÂª∫Êñ∞Êï∞ÁªÑÔºåÊéíÈô§Ë¶ÅÂà†Èô§ÁöÑËÆ∞ÂΩï
        chat.apiHistory = chat.apiHistory.filter((record, index) => !indicesToDelete.includes(index));

        await db.chats.put(chat);

        // ÂèñÊ∂àÂÖ®ÈÄâ
        document.getElementById('api-history-select-all').checked = false;

        renderApiHistoryList();
        await showCustomAlert('Âà†Èô§ÊàêÂäü', `Â∑≤Âà†Èô§ ${checkedBoxes.length} Êù°APIË∞ÉÁî®ÂéÜÂè≤ËÆ∞ÂΩïÔºÅ`);
      } catch (error) {
        console.error('Âà†Èô§APIÂéÜÂè≤Â§±Ë¥•:', error);
        await showCustomAlert('Âà†Èô§Â§±Ë¥•', 'Âà†Èô§APIÂéÜÂè≤Êó∂Âá∫ÈîôÔºåËØ∑ÈáçËØï„ÄÇ');
      }
    });

    // ÂØºÂá∫APIÂéÜÂè≤‰∏∫JSON
    document.getElementById('api-history-export-btn').addEventListener('click', () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      if (!chat.apiHistory || chat.apiHistory.length === 0) {
        showCustomAlert('Êó†Êï∞ÊçÆ', 'ÂΩìÂâçÊ≤°ÊúâAPIË∞ÉÁî®ÂéÜÂè≤ÂèØÂØºÂá∫„ÄÇ');
        return;
      }

      try {
        const jsonData = JSON.stringify(chat.apiHistory, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `api-history-${chat.name}-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showCustomAlert('ÂØºÂá∫ÊàêÂäü', `Â∑≤ÂØºÂá∫ ${chat.apiHistory.length} Êù°APIË∞ÉÁî®ËÆ∞ÂΩïÔºÅ`);
      } catch (error) {
        console.error('ÂØºÂá∫APIÂéÜÂè≤Â§±Ë¥•:', error);
        showCustomAlert('ÂØºÂá∫Â§±Ë¥•', 'ÂØºÂá∫APIÂéÜÂè≤Êó∂Âá∫ÈîôÔºåËØ∑ÈáçËØï„ÄÇ');
      }
    });

    // Ê∏≤ÊüìAPIÂéÜÂè≤ÂàóË°®
    function renderApiHistoryList() {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];
      const listContainer = document.getElementById('api-history-list');

      if (!chat.apiHistory || chat.apiHistory.length === 0) {
        listContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">ÊöÇÊó†APIË∞ÉÁî®ÂéÜÂè≤</div>';
        return;
      }

      // ÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàóÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
      const history = [...chat.apiHistory].reverse();

      listContainer.innerHTML = history.map((record, index) => {
        const date = new Date(record.timestamp);
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;

        const duration = record.responseTimestamp ? `${Math.round((record.responseTimestamp - record.timestamp) / 1000)}Áßí` : 'Êú™ÂÆåÊàê';
        const reversedIndex = chat.apiHistory.length - index;

        // ËÆ°ÁÆóÊèêÁ§∫ËØçÂíåÂìçÂ∫îÁöÑÂ≠óÁ¨¶Êï∞
        const promptLength = record.systemPrompt ? record.systemPrompt.length : 0;
        const messagesLength = record.messages ? JSON.stringify(record.messages).length : 0;
        const responseLength = record.aiResponseContent ? record.aiResponseContent.length : 0;

        return `
          <div class="api-history-item" style="
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: var(--bg-primary);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" class="api-history-checkbox" data-index="${chat.apiHistory.length - 1 - index}" style="cursor: pointer; width: 18px; height: 18px;">
                <div style="font-weight: 600; font-size: 14px;">
                  #${reversedIndex} - ${dateStr}
                </div>
              </div>
              <div style="font-size: 12px; color: var(--text-secondary);">
                ËÄóÊó∂: ${duration}
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
              <span style="font-size: 12px; padding: 4px 8px; background: var(--bg-secondary); border-radius: 4px;">
                Ê®°Âûã: ${escapeHTML(record.model)}
              </span>
              <span style="font-size: 12px; padding: 4px 8px; background: var(--bg-secondary); border-radius: 4px;">
                Ê∏©Â∫¶: ${record.temperature}
              </span>
              <span style="font-size: 12px; padding: 4px 8px; background: var(--bg-secondary); border-radius: 4px;">
                ÊèêÁ§∫ËØç: ${promptLength.toLocaleString()} Â≠óÁ¨¶
              </span>
              <span style="font-size: 12px; padding: 4px 8px; background: var(--bg-secondary); border-radius: 4px;">
                Ê∂àÊÅØ: ${messagesLength.toLocaleString()} Â≠óÁ¨¶
              </span>
              <span style="font-size: 12px; padding: 4px 8px; background: var(--bg-secondary); border-radius: 4px;">
                ÂìçÂ∫î: ${responseLength.toLocaleString()} Â≠óÁ¨¶
              </span>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="form-button-secondary view-system-prompt-btn" data-index="${chat.apiHistory.length - 1 - index}" style="flex: 1; min-width: 150px; padding: 8px 12px; font-size: 13px; opacity: 0.7;">
                Êü•ÁúãÁ≥ªÁªüÊèêÁ§∫ËØç
              </button>
              <button class="form-button-secondary view-messages-btn" data-index="${chat.apiHistory.length - 1 - index}" style="flex: 1; min-width: 150px; padding: 8px 12px; font-size: 13px; opacity: 0.7;">
                Êü•ÁúãÂèëÈÄÅÊ∂àÊÅØ
              </button>
              <button class="form-button-secondary view-response-btn" data-index="${chat.apiHistory.length - 1 - index}" style="flex: 1; min-width: 150px; padding: 8px 12px; font-size: 13px;">
                Êü•ÁúãAIÂìçÂ∫î
              </button>
              <button class="form-button-secondary view-raw-data-btn" data-index="${chat.apiHistory.length - 1 - index}" style="flex: 1; min-width: 150px; padding: 8px 12px; font-size: 13px;">
                Êü•ÁúãÂéüÂßãÊï∞ÊçÆ
              </button>
            </div>
          </div>
        `;
      }).join('');

      // ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
      listContainer.querySelectorAll('.view-system-prompt-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // ÊòæÁ§∫‰∏äÈîÅÊèêÁ§∫
          showCustomAlert('ÂäüËÉΩÂ∑≤ÈîÅÂÆö', '‰∏∫‰øùÊä§Ê†∏ÂøÉÈöêÁßÅÔºåÊ≠§ÂäüËÉΩÂ∑≤Ë¢´ÈîÅÂÆö„ÄÇ');
        });
      });

      listContainer.querySelectorAll('.view-messages-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // ÊòæÁ§∫‰∏äÈîÅÊèêÁ§∫
          showCustomAlert('ÂäüËÉΩÂ∑≤ÈîÅÂÆö', '‰∏∫‰øùÊä§Ê†∏ÂøÉÈöêÁßÅÔºåÊ≠§ÂäüËÉΩÂ∑≤Ë¢´ÈîÅÂÆö„ÄÇ');
        });
      });

      listContainer.querySelectorAll('.view-response-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          const record = chat.apiHistory[index];
          showApiHistoryDetail('AIÂìçÂ∫îÂÜÖÂÆπ', record.aiResponseContent, 'text');
        });
      });

      listContainer.querySelectorAll('.view-raw-data-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          const record = chat.apiHistory[index];
          showApiHistoryDetail('ÂéüÂßãÂìçÂ∫îÊï∞ÊçÆ', JSON.stringify(record.responseData, null, 2), 'json');
        });
      });

      // ÁõëÂê¨Âçï‰∏™Â§çÈÄâÊ°ÜÂèòÂåñÔºåÊõ¥Êñ∞ÂÖ®ÈÄâÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
      const selectAllCheckbox = document.getElementById('api-history-select-all');
      listContainer.querySelectorAll('.api-history-checkbox').forEach(cb => {
        cb.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.api-history-checkbox');
          const checkedCount = document.querySelectorAll('.api-history-checkbox:checked').length;
          selectAllCheckbox.checked = checkedCount === allCheckboxes.length;
        });
      });

      // ÈáçÁΩÆÂÖ®ÈÄâÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
      }
    }

    // ÊòæÁ§∫APIÂéÜÂè≤ËØ¶ÊÉÖ
    function showApiHistoryDetail(title, content, type) {
      const modal = document.createElement('div');
      modal.className = 'modal visible';
      modal.style.zIndex = '10001'; // Á°Æ‰øùÂú®APIÂéÜÂè≤Ê®°ÊÄÅÁ™óÂè£‰πã‰∏ä

      const copyButtonHtml = `<button id="copy-detail-btn" class="form-button" style="padding: 8px 15px; margin-right: 10px;">Â§çÂà∂ÂÜÖÂÆπ</button>`;

      modal.innerHTML = `
        <div class="modal-content" style="height: 90%; max-width: 900px;">
          <div class="modal-header">
            <span>${escapeHTML(title)}</span>
          </div>
          <div class="modal-body" style="height: calc(100% - 100px); overflow-y: auto;">
            <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; font-size: 13px; line-height: 1.6;">
              ${escapeHTML(content || '(Á©∫)')}
            </div>
          </div>
          <div class="modal-footer">
            ${copyButtonHtml}
            <button class="cancel close-detail-btn">ÂÖ≥Èó≠</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // ÁªëÂÆöÂ§çÂà∂ÊåâÈíÆ‰∫ã‰ª∂
      const copyBtn = modal.querySelector('#copy-detail-btn');
      if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(content);
            copyBtn.textContent = 'Â∑≤Â§çÂà∂ÔºÅ';
            setTimeout(() => {
              copyBtn.textContent = 'Â§çÂà∂ÂÜÖÂÆπ';
            }, 2000);
          } catch (error) {
            console.error('Â§çÂà∂Â§±Ë¥•:', error);
            showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïÂ§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºåËØ∑ÊâãÂä®Â§çÂà∂„ÄÇ');
          }
        });
      }

      // ÁªëÂÆöÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
      modal.querySelector('.close-detail-btn').addEventListener('click', () => {
        document.body.removeChild(modal);
      });

      // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
    }

    // ==================== APIË∞ÉÁî®ÂéÜÂè≤Êü•ÁúãÂäüËÉΩÁªìÊùü ====================








    document.getElementById('chat-settings-screen').addEventListener('click', (e) => {
      if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal('chat');
      }
    });


    document.getElementById('member-settings-modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal('member');
      }
    });


    const frameModal = document.getElementById('avatar-frame-modal');
    const aiFrameTab = document.getElementById('ai-frame-tab');
    const myFrameTab = document.getElementById('my-frame-tab');
    const aiFrameContent = document.getElementById('ai-frame-content');
    const myFrameContent = document.getElementById('my-frame-content');


    document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);


    document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => {
      frameModal.classList.remove('visible');
      editingFrameForMember = false;
    });


    aiFrameTab.addEventListener('click', () => {
      aiFrameTab.classList.add('active');
      myFrameTab.classList.remove('active');
      aiFrameContent.style.display = 'block';
      myFrameContent.style.display = 'none';
    });


    myFrameTab.addEventListener('click', () => {
      myFrameTab.classList.add('active');
      aiFrameTab.classList.remove('active');
      myFrameContent.style.display = 'block';
      aiFrameContent.style.display = 'none';
    });


    document.getElementById('clear-chat-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];
      const confirmed = await showCustomConfirm('Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï', 'Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Ê≠§ËÅäÂ§©ÁöÑÊâÄÊúâÊ∂àÊÅØÔºåÊó†Ê≥ïÊÅ¢Â§ç„ÄÇÁ°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂêóÔºü', {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        chat.history = [];
        chat.heartfeltVoice = '...';
        chat.randomJottings = '...';
        // ÈáçÁΩÆËßíËâ≤Áä∂ÊÄÅ‰∏∫ÈªòËÆ§ÁöÑ"Âú®Á∫ø"
        if (!chat.isGroup && chat.status) {
          chat.status.text = 'Âú®Á∫ø';
          chat.status.isBusy = false;
          chat.status.lastUpdate = Date.now();
        }
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
        renderChatList();
        chatSettingsModal.classList.remove('visible');
      }
    });

    const setupFileUpload = (inputId, callback) => {
      document.getElementById(inputId).addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (file) {
          const dataUrl = await new Promise((res, rej) => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.onerror = () => rej(reader.error);
            reader.readAsDataURL(file);
          });
          callback(dataUrl);
          event.target.value = null;
        }
      });
    };
    setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
    setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
    setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
    setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
    setupFileUpload('bg-input', async (base64) => {
      if (state.activeChatId) {
        const chat = state.chats[state.activeChatId];

        // 1. Á´ãÂç≥‰øùÂ≠òÂíåÊòæÁ§∫
        chat.settings.background = base64;
        const bgPreview = document.getElementById('bg-preview');
        bgPreview.src = base64;
        bgPreview.style.display = 'block';
        document.getElementById('remove-bg-btn').style.display = 'inline-block';

        await showCustomAlert("ÊàêÂäü", "ËÅäÂ§©ËÉåÊôØÂ∑≤Êõ¥Êñ∞ÔºÅ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä... (‰øùÂ≠òËÆæÁΩÆÂêéÁîüÊïà)");

        // 2. ÂêØÂä®ÈùôÈªò‰∏ä‰º†
        (async () => {
          await silentlyUpdateDbUrl(
            db.chats,
            chat.id,
            'settings.background',
            base64
          );
        })();
      }
    });
    setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
    document.getElementById('remove-bg-btn').addEventListener('click', () => {
      if (state.activeChatId) {
        state.chats[state.activeChatId].settings.background = '';
        const bgPreview = document.getElementById('bg-preview');
        bgPreview.src = '';
        bgPreview.style.display = 'none';
        document.getElementById('remove-bg-btn').style.display = 'none';
      }
    });

    const stickerPanel = document.getElementById('sticker-panel');
    document.getElementById('open-sticker-panel-btn').addEventListener('click', () => {
      const chat = state.chats[state.activeChatId];
      if (chat && chat.settings.stickerCategoryId) {

        activeStickerCategoryId = chat.settings.stickerCategoryId;
      } else {

        activeStickerCategoryId = 'all';
      }
      renderStickerPanel();
      stickerPanel.classList.add('visible');
    });
    document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));



    document.getElementById('add-sticker-batch-btn').addEventListener('click', openBatchStickerImportModal);






    document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
    document.getElementById('sticker-upload-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = async () => {
        let base64Url = reader.result;
        const name = await showCustomPrompt("ÂëΩÂêçË°®ÊÉÖ", "ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂëΩÂêç (‰æãÂ¶ÇÔºöÂ•ΩËÄ∂„ÄÅÁñëÊÉë)");

        if (name && name.trim()) {
          const trimmedName = name.trim();

          const newSticker = {
            id: 'sticker_' + Date.now() + Math.random(), // <-- Add this line
            url: base64Url,
            name: trimmedName,
            categoryId: (activeStickerCategoryId !== 'all' && activeStickerCategoryId !== 'uncategorized') ? activeStickerCategoryId : null
          };
          const newId = await db.userStickers.add(newSticker); // 1. Save to DB

          newSticker.id = newId;
          state.userStickers.push(newSticker); // 2. Update state

          renderStickerPanel(); // 3. Render UI
          await showCustomAlert("Ê∑ªÂä†ÊàêÂäüÔºÅ", `Ë°®ÊÉÖ‚Äú${trimmedName}‚ÄùÂ∑≤Ê∑ªÂä†„ÄÇ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);

          // 4. „Äê„Äê„ÄêÂ∑≤‰øÆÂ§çÁöÑË∞ÉÁî®„Äë„Äë„Äë
          (async () => {
            await silentlyUpdateDbUrl(
              db.userStickers, // table
              newId, // recordId
              'url', // pathString (ÊåáÂêëÁÆÄÂçïÂ±ûÊÄß)
              base64Url // base64ToFind
              // nameToMatch (‰∏çÈúÄË¶Å)
            );
          })();

        } else if (name !== null) {
          alert("Ë°®ÊÉÖÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
        }
      };
      event.target.value = null;
    });

    document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
    document.getElementById('image-upload-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file || !state.activeChatId) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64Url = e.target.result;
        const chat = state.chats[state.activeChatId];
        const msg = {
          role: 'user',
          content: [{
            type: 'image_url',
            image_url: {
              url: base64Url
            }
          }],
          timestamp: Date.now()
        };
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        renderChatList();
      };
      reader.readAsDataURL(file);
      event.target.value = null;
    });

    // ÊãçÁÖßÊåâÈíÆ‰∫ã‰ª∂Â§ÑÁêÜ
    document.getElementById('camera-capture-btn').addEventListener('click', () => {
      document.getElementById('camera-capture-input').click();
    });

    document.getElementById('camera-capture-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file || !state.activeChatId) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64Url = e.target.result;
        const chat = state.chats[state.activeChatId];
        const msg = {
          role: 'user',
          content: [{
            type: 'image_url',
            image_url: {
              url: base64Url
            }
          }],
          timestamp: Date.now()
        };
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        renderChatList();
      };
      reader.readAsDataURL(file);
      event.target.value = null;
    });
    document.getElementById('voice-message-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;

      const text = await showCustomPrompt("ÂèëÈÄÅËØ≠Èü≥", "ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑÂÜÖÂÆπÔºö");
      if (text && text.trim()) {
        const chat = state.chats[state.activeChatId];


        const msg = {
          role: 'user',
          type: 'voice_message',
          content: text.trim(),
          timestamp: Date.now()
        };

        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        renderChatList();
      }
    });
    document.getElementById('send-photo-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const description = await showCustomPrompt("ÂèëÈÄÅÁÖßÁâá", "ËØ∑Áî®ÊñáÂ≠óÊèèËø∞ÊÇ®Ë¶ÅÂèëÈÄÅÁöÑÁÖßÁâáÔºö");
      if (description && description.trim()) {
        const chat = state.chats[state.activeChatId];
        const msg = {
          role: 'user',
          type: 'user_photo',
          content: description.trim(),
          timestamp: Date.now()
        };
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        renderChatList();
      }
    });

    const waimaiModal = document.getElementById('waimai-request-modal');


    document.getElementById('send-waimai-request-btn').addEventListener('click', () => {
      waimaiModal.classList.add('visible');
    });


    waimaiModal.addEventListener('click', (e) => {

      if (e.target === waimaiModal) {
        waimaiModal.classList.remove('visible');
      }
    });


    document.getElementById('waimai-order-for-ai-btn').addEventListener('click', sendWaimaiOrderForAI);


    document.getElementById('waimai-confirm-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;

      const productInfoInput = document.getElementById('waimai-product-info');
      const amountInput = document.getElementById('waimai-amount');

      const productInfo = productInfoInput.value.trim();
      const amount = parseFloat(amountInput.value);

      if (!productInfo || isNaN(amount) || amount <= 0) {
        alert('ËØ∑Â°´ÂÜôÊúâÊïàÁöÑÂïÜÂìÅ‰ø°ÊÅØÂíåÈáëÈ¢ùÔºÅ');
        return;
      }

      const chat = state.chats[state.activeChatId];
      const now = Date.now();
      const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

      const msg = {
        role: 'user',
        senderName: myNickname,
        type: 'waimai_request',
        productInfo: productInfo,
        amount: amount,
        status: 'pending',
        countdownEndTime: now + 15 * 60 * 1000,
        timestamp: now
      };

      chat.history.push(msg);
      await db.chats.put(chat);
      appendMessage(msg, chat);
      renderChatList();

      productInfoInput.value = '';
      amountInput.value = '';
      waimaiModal.classList.remove('visible');
    });
    document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
    document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
    document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
    document.getElementById('manage-persona-preset-btn').addEventListener('click', enterManageMode);
    document.getElementById('select-all-persona-btn').addEventListener('click', selectAllPresets);
    document.getElementById('delete-selected-persona-btn').addEventListener('click', deleteSelectedPresets);
    document.getElementById('cancel-manage-persona-btn').addEventListener('click', exitManageMode);
    document.getElementById('import-tavern-persona-btn').addEventListener('click', importTavernPersonas);
    document.getElementById('import-tavern-persona-input').addEventListener('change', handleTavernPersonaImport);
    document.getElementById('cancel-tavern-import-btn').addEventListener('click', closeTavernPersonaSelector);
    document.getElementById('confirm-tavern-import-btn').addEventListener('click', confirmTavernImport);
    document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
    document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
    document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
    document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
    document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);

    // Êñ∞Â¢ûÔºö‰∫∫ËÆæÊìç‰ΩúÂºπÁ™ó‰∫ã‰ª∂ÁªëÂÆö
    document.getElementById('apply-persona-direct-btn').addEventListener('click', applyPersonaPresetDirect);
    document.getElementById('edit-persona-first-btn').addEventListener('click', editPersonaThenApply);
    document.getElementById('cancel-persona-action-btn').addEventListener('click', hidePersonaActionModal);

    document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);




    document.getElementById('selection-soft-delete-btn').addEventListener('click', async () => {
      if (selectedMessages.size === 0) return;
      const confirmed = await showCustomConfirm('Âà†Èô§Ê∂àÊÅØ', `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedMessages.size} Êù°Ê∂àÊÅØÂêóÔºüËøô‰ºöÈÄöÁü•AIËøô‰∫õÊ∂àÊÅØÂ∑≤Ë¢´Âà†Èô§„ÄÇ`, {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        const chat = state.chats[state.activeChatId];
        let deletedPollsInfo = [];
        for (const timestamp of selectedMessages) {
          const msg = chat.history.find(m => m.timestamp === timestamp);
          if (msg && msg.type === 'poll') {
            deletedPollsInfo.push(`ÂÖ≥‰∫é‚Äú${msg.question}‚ÄùÁöÑÊäïÁ•®(Êó∂Èó¥Êà≥: ${msg.timestamp})`);
          }
        }
        chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
        let forgetReason = "‰∏Ä‰∫õ‰πãÂâçÁöÑÊ∂àÊÅØÂ∑≤Ë¢´Áî®Êà∑Âà†Èô§„ÄÇ";
        if (deletedPollsInfo.length > 0) {
          forgetReason += ` ÂÖ∂‰∏≠ÂåÖÊã¨‰ª•‰∏ãÊäïÁ•®Ôºö${deletedPollsInfo.join('Ôºõ')}„ÄÇ`;
        }
        forgetReason += " ‰Ω†Â∫îËØ•ÂÉèÂÆÉ‰ª¨‰ªéÊú™Â≠òÂú®Ëøá‰∏ÄÊ†∑ÁªßÁª≠ÂØπËØùÔºåÂπ∂Áõ∏Â∫îÂú∞Ë∞ÉÊï¥‰Ω†ÁöÑËÆ∞ÂøÜÂíåË°å‰∏∫Ôºå‰∏çË¶ÅÂÜçÊèêÂèäËøô‰∫õË¢´Âà†Èô§ÁöÑÂÜÖÂÆπ„ÄÇ";
        const forgetInstruction = {
          role: 'system',
          content: `[Á≥ªÁªüÊèêÁ§∫Ôºö${forgetReason}]`,
          timestamp: Date.now(),
          isHidden: true
        };
        chat.history.push(forgetInstruction);
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
        renderChatList();
      }
    });


    document.getElementById('selection-erase-btn').addEventListener('click', async () => {
      if (selectedMessages.size === 0) return;
      const confirmed = await showCustomConfirm(
        'ÂΩªÂ∫ïÂà†Èô§Ê∂àÊÅØ',
        `ËøôÂ∞Ü‰ªéÂéÜÂè≤ËÆ∞ÂΩï‰∏≠„ÄêÊ∞∏‰πÖÊäπÈô§„ÄëËøô ${selectedMessages.size} Êù°Ê∂àÊÅØÔºåAIÂ∞ÜÂÆåÂÖ®ÈÅóÂøòÂÆÉ‰ª¨ÁöÑÂ≠òÂú®„ÄÇÁ°ÆÂÆöÂêóÔºü`, {
        confirmButtonClass: 'btn-danger',
        confirmText: 'Á°ÆËÆ§ÊäπÈô§'
      }
      );
      if (confirmed) {
        const chat = state.chats[state.activeChatId];


        chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));


        await db.chats.put(chat);


        renderChatInterface(state.activeChatId);
        renderChatList();
      }
    });


    const fontUrlInput = document.getElementById('font-url-input');
    fontUrlInput.addEventListener('input', () => applyCustomFont(fontUrlInput.value.trim(), true));

    // Â≠ó‰ΩìÂ§ßÂ∞èÊªëÂä®Êù°ÂÆûÊó∂È¢ÑËßà
    document.getElementById('font-size-slider').addEventListener('input', function() {
      document.getElementById('font-size-value').textContent = this.value;
      state.globalSettings.globalFontSize = parseInt(this.value);
      document.getElementById('font-preview').style.fontSize = this.value + 'px';
    });

    // Â≠ó‰ΩìÂ∫îÁî®ËåÉÂõ¥‰∫§‰∫í
    document.getElementById('font-scope-all').addEventListener('change', function() {
      const scopeList = document.getElementById('font-scope-list');
      scopeList.style.display = this.checked ? 'none' : 'flex';
      if (this.checked) {
        document.querySelectorAll('#font-scope-list input[type="checkbox"]').forEach(cb => cb.checked = true);
      }
    });

    document.getElementById('save-font-btn').addEventListener('click', async () => {
      const newFontUrl = fontUrlInput.value.trim();
      // ËØªÂèñÂ≠ó‰ΩìÂ§ßÂ∞è
      const newFontSize = parseInt(document.getElementById('font-size-slider').value) || 16;
      state.globalSettings.globalFontSize = newFontSize;
      // ËØªÂèñÂ≠ó‰ΩìÂ∫îÁî®ËåÉÂõ¥
      const scopeAll = document.getElementById('font-scope-all').checked;
      const newScope = { all: scopeAll };
      document.querySelectorAll('#font-scope-list input[data-scope]').forEach(cb => {
        newScope[cb.dataset.scope] = scopeAll ? true : cb.checked;
      });
      state.globalSettings.fontScope = newScope;
      state.globalSettings.fontUrl = newFontUrl;
      applyCustomFont(newFontUrl, false);
      await db.globalSettings.put(state.globalSettings);
      alert('Â≠ó‰ΩìËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ');
    });
    document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);
    document.getElementById('reset-font-scope-btn').addEventListener('click', resetFontByScope);

    document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
      item.addEventListener('click', () => switchToChatListView(item.dataset.view));
    });
    document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
    document.getElementById('qzone-nickname').addEventListener('click', async () => {
      const newNickname = await showCustomPrompt("‰øÆÊîπÊòµÁß∞", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊòµÁß∞", state.qzoneSettings.nickname);
      if (newNickname && newNickname.trim()) {
        state.qzoneSettings.nickname = newNickname.trim();
        await saveQzoneSettings();
        renderQzoneScreen();
      }
    });
    document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
    document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
    document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        const dataUrl = await new Promise(res => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.readAsDataURL(file);
        });
        state.qzoneSettings.avatar = dataUrl;
        await saveQzoneSettings();
        renderQzoneScreen();
      }
      event.target.value = null;
    });
    document.getElementById('qzone-banner-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        const dataUrl = await new Promise(res => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.readAsDataURL(file);
        });
        state.qzoneSettings.banner = dataUrl;
        await saveQzoneSettings();
        renderQzoneScreen();
      }
      event.target.value = null;
    });


    document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {

      resetCreatePostModal();
      const modal = document.getElementById('create-post-modal');


      modal.dataset.mode = 'shuoshuo';


      modal.querySelector('.post-mode-switcher').style.display = 'none';
      modal.querySelector('#image-mode-content').style.display = 'none';
      modal.querySelector('#text-image-mode-content').style.display = 'none';


      modal.querySelector('#post-public-text').placeholder = 'ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...';


      const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
      visibilityGroupsContainer.innerHTML = '';
      const groups = await db.qzoneGroups.toArray();
      if (groups.length > 0) {
        groups.forEach(group => {
          const label = document.createElement('label');
          label.style.display = 'block';
          label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
          visibilityGroupsContainer.appendChild(label);
        });
      } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">Ê≤°ÊúâÂèØÁî®ÁöÑÂàÜÁªÑ</p>';
      }
      modal.classList.add('visible');
    });


    document.getElementById('create-post-btn').addEventListener('click', async () => {

      resetCreatePostModal();
      const modal = document.getElementById('create-post-modal');


      modal.dataset.mode = 'complex';


      modal.querySelector('.post-mode-switcher').style.display = 'flex';

      modal.querySelector('#image-mode-content').classList.add('active');

      modal.querySelector('#text-image-mode-content').classList.remove('active');


      modal.querySelector('#post-public-text').placeholder = 'ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...ÔºàÈùûÂøÖÂ°´ÁöÑÂÖ¨ÂºÄÊñáÂ≠óÔºâ';


      const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
      visibilityGroupsContainer.innerHTML = '';
      const groups = await db.qzoneGroups.toArray();
      if (groups.length > 0) {
        groups.forEach(group => {
          const label = document.createElement('label');
          label.style.display = 'block';
          label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
          visibilityGroupsContainer.appendChild(label);
        });
      } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">Ê≤°ÊúâÂèØÁî®ÁöÑÂàÜÁªÑ</p>';
      }
      modal.classList.add('visible');
    });
    document.getElementById('open-album-btn').addEventListener('click', async () => {
      await renderAlbumList();
      showScreen('album-screen');
    });
    document.getElementById('album-back-btn').addEventListener('click', () => {
      showScreen('chat-list-screen');
      switchToChatListView('qzone-screen');
    });



    document.getElementById('album-photos-back-btn').addEventListener('click', () => {
      state.activeAlbumId = null;
      showScreen('album-screen');
    });

    document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());

    document.getElementById('album-photo-input').addEventListener('change', async (event) => {
      if (!state.activeAlbumId) return;
      const files = event.target.files;
      if (!files.length) return;

      const album = await db.qzoneAlbums.get(state.activeAlbumId);

      for (const file of files) {
        const dataUrl = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });
        await db.qzonePhotos.add({
          albumId: state.activeAlbumId,
          url: dataUrl,
          createdAt: Date.now()
        });
      }

      const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
      const updateData = {
        photoCount
      };

      if (!album.photoCount || album.coverUrl.includes('placeholder')) {
        const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
        if (firstPhoto) updateData.coverUrl = firstPhoto.url;
      }

      await db.qzoneAlbums.update(state.activeAlbumId, updateData);
      await renderAlbumPhotosScreen();
      await renderAlbumList();

      event.target.value = null;
      alert('ÁÖßÁâá‰∏ä‰º†ÊàêÂäüÔºÅ');
    });





    document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
      const deleteBtn = e.target.closest('.photo-delete-btn');
      const photoThumb = e.target.closest('.photo-thumb');

      if (deleteBtn) {
        e.stopPropagation();
        const photoId = parseInt(deleteBtn.dataset.photoId);
        const confirmed = await showCustomConfirm(
          'Âà†Èô§ÁÖßÁâá',
          'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÁÖßÁâáÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ', {
          confirmButtonClass: 'btn-danger'
        }
        );

        if (confirmed) {
          const deletedPhoto = await db.qzonePhotos.get(photoId);
          if (!deletedPhoto) return;

          await db.qzonePhotos.delete(photoId);

          const album = await db.qzoneAlbums.get(state.activeAlbumId);
          const photoCount = (album.photoCount || 1) - 1;
          const updateData = {
            photoCount
          };

          if (album.coverUrl === deletedPhoto.url) {
            const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
            updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
          }

          await db.qzoneAlbums.update(state.activeAlbumId, updateData);
          await renderAlbumPhotosScreen();
          await renderAlbumList();
          alert('ÁÖßÁâáÂ∑≤Âà†Èô§„ÄÇ');
        }
      } else if (photoThumb) {

        openPhotoViewer(photoThumb.src);
      }
    });


    document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
    document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
    document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);


    document.addEventListener('keydown', (e) => {
      if (!photoViewerState.isOpen) return;

      if (e.key === 'ArrowRight') {
        showNextPhoto();
      } else if (e.key === 'ArrowLeft') {
        showPrevPhoto();
      } else if (e.key === 'Escape') {
        closePhotoViewer();
      }
    });



    document.getElementById('create-album-btn-page').addEventListener('click', async () => {
      const albumName = await showCustomPrompt("ÂàõÂª∫Êñ∞Áõ∏ÂÜå", "ËØ∑ËæìÂÖ•Áõ∏ÂÜåÂêçÁß∞");
      if (albumName && albumName.trim()) {
        const newAlbum = {
          name: albumName.trim(),
          coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png',
          photoCount: 0,
          createdAt: Date.now()
        };
        await db.qzoneAlbums.add(newAlbum);
        await renderAlbumList();
        alert(`Áõ∏ÂÜå "${albumName}" ÂàõÂª∫ÊàêÂäüÔºÅ`);
      } else if (albumName !== null) {
        alert("Áõ∏ÂÜåÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
      }
    });

    document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
    document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
    document.getElementById('post-local-image-input').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('post-image-preview').src = e.target.result;
          document.getElementById('post-image-preview-container').classList.add('visible');
          document.getElementById('post-image-desc-group').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });
    document.getElementById('post-use-url-btn').addEventListener('click', async () => {
      const url = await showCustomPrompt("ËæìÂÖ•ÂõæÁâáURL", "ËØ∑ËæìÂÖ•ÁΩëÁªúÂõæÁâáÁöÑÈìæÊé•", "", "url");
      if (url) {
        document.getElementById('post-image-preview').src = url;
        document.getElementById('post-image-preview-container').classList.add('visible');
        document.getElementById('post-image-desc-group').style.display = 'block';
      }
    });
    document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
    const imageModeBtn = document.getElementById('switch-to-image-mode');
    const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
    const imageModeContent = document.getElementById('image-mode-content');
    const textImageModeContent = document.getElementById('text-image-mode-content');
    imageModeBtn.addEventListener('click', () => {
      imageModeBtn.classList.add('active');
      textImageModeBtn.classList.remove('active');
      imageModeContent.classList.add('active');
      textImageModeContent.classList.remove('active');
    });
    textImageModeBtn.addEventListener('click', () => {
      textImageModeBtn.classList.add('active');
      imageModeBtn.classList.remove('active');
      textImageModeContent.classList.add('active');
      imageModeContent.classList.remove('active');
    });


    document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
      const modal = document.getElementById('create-post-modal');
      const mode = modal.dataset.mode;


      const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
      let visibleGroupIds = null;

      if (visibilityMode === 'include') {
        visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
      }

      let newPost = {};
      const basePostData = {
        timestamp: Date.now(),
        authorId: 'user',

        visibleGroupIds: visibleGroupIds,
      };


      if (mode === 'shuoshuo') {
        const content = document.getElementById('post-public-text').value.trim();
        if (!content) {
          alert('ËØ¥ËØ¥ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫Âì¶ÔºÅ');
          return;
        }
        newPost = {
          ...basePostData,
          type: 'shuoshuo',
          content: content,
        };

      } else {
        const publicText = document.getElementById('post-public-text').value.trim();
        const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');

        if (isImageModeActive) {
          const imageUrl = document.getElementById('post-image-preview').src;
          const imageDescription = document.getElementById('post-image-description').value.trim();
          if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) {
            alert('ËØ∑ÂÖàÊ∑ªÂä†‰∏ÄÂº†ÂõæÁâáÂÜçÂèëÂ∏ÉÂä®ÊÄÅÂì¶ÔºÅ');
            return;
          }
          if (!imageDescription) {
            alert('ËØ∑‰∏∫‰Ω†ÁöÑÂõæÁâáÊ∑ªÂä†‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊèèËø∞ÔºàÂøÖÂ°´ÔºåÁªôAIÁúãÁöÑÔºâÔºÅ');
            return;
          }
          newPost = {
            ...basePostData,
            type: 'image_post',
            publicText: publicText,
            imageUrl: imageUrl,
            imageDescription: imageDescription,
          };
        } else {
          const hiddenText = document.getElementById('post-hidden-text').value.trim();
          if (!hiddenText) {
            alert('ËØ∑ËæìÂÖ•ÊñáÂ≠óÂõæÊèèËø∞ÔºÅ');
            return;
          }
          newPost = {
            ...basePostData,
            type: 'text_image',
            publicText: publicText,
            hiddenContent: hiddenText,
          };
        }
      }


      const newPostId = await db.qzonePosts.add(newPost);
      let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "ÔºàÊó†ÊñáÂ≠óÂÜÖÂÆπÔºâ";
      postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');


      for (const chatId in state.chats) {
        const chat = state.chats[chatId];
        if (chat.isGroup) continue;

        let shouldNotify = false;
        const postVisibleGroups = newPost.visibleGroupIds;


        if (!postVisibleGroups || postVisibleGroups.length === 0) {
          shouldNotify = true;
        } else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
          shouldNotify = true;
        }


        if (shouldNotify) {

          const historyMessage = {
            role: 'system',
            content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÂàöÂèëÂ∏É‰∫Ü‰∏ÄÊù°Âä®ÊÄÅ(ID: ${newPostId})ÔºåÂÜÖÂÆπÊëòË¶ÅÊòØÔºö‚Äú${postSummary}‚Äù„ÄÇËØ∑‰Ω†„ÄêÁªìÂêàËá™Â∑±ÁöÑËßíËâ≤ËÆæÂÆö„ÄÅ‰∏ñÁïåËßÇÂíå‰Ω†‰ª¨ÁöÑÊúÄËøëËÅäÂ§©ÂÜÖÂÆπ„ÄëÔºåÂØπËøôÊù°Âä®ÊÄÅÂèëË°®‰∏ÄÊù°Ëá™ÁÑ∂ÁöÑËØÑËÆ∫„ÄÇ]`,
            timestamp: Date.now(),
            isHidden: true
          };

          chat.history.push(historyMessage);
          await db.chats.put(chat);
        }
      }


      await renderQzonePosts();
      modal.classList.remove('visible');
      alert('Âä®ÊÄÅÂèëÂ∏ÉÊàêÂäüÔºÅ');
    });



    const postsList = document.getElementById('qzone-posts-list');
    let swipeState = {
      isDragging: false,
      startX: 0,
      startY: 0,
      currentX: 0,
      activeContainer: null,
      swipeDirection: null,
      isClick: true
    };

    function resetAllSwipes(exceptThisOne = null) {
      document.querySelectorAll('.qzone-post-container').forEach(container => {
        if (container !== exceptThisOne) {
          container.querySelector('.qzone-post-item').classList.remove('swiped');
        }
      });
    }


    async function handlePostClick(e) {
      e.stopPropagation();
      const target = e.target;


      const deleteBtn = target.closest('.comment-delete-btn');
      if (deleteBtn) {
        const postContainer = deleteBtn.closest('.qzone-post-container');
        const postId = parseInt(postContainer.dataset.postId);
        const commentIndex = parseInt(deleteBtn.dataset.commentIndex);
        if (isNaN(postId) || isNaN(commentIndex)) return;

        const post = qzonePostsCache.find(p => p.id === postId);
        if (!post || !post.comments || !post.comments[commentIndex]) return;



        const deletedComment = post.comments[commentIndex];

        const confirmed = await showCustomConfirm('Âà†Èô§ËØÑËÆ∫', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºü', {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {

          post.comments.splice(commentIndex, 1);
          await db.qzonePosts.update(postId, {
            comments: post.comments
          });




          if (deletedComment && deletedComment.commenterName === state.qzoneSettings.nickname) {
            console.log("Áî®Êà∑Âà†Èô§‰∫ÜËá™Â∑±ÁöÑËØÑËÆ∫ÔºåÂºÄÂßãÊ∏ÖÁêÜAIËÆ∞ÂøÜ...");


            const aiToNotifyIds = new Set();
            if (post.authorId !== 'user') {
              aiToNotifyIds.add(post.authorId);
            }
            if (deletedComment.replyTo) {
              const repliedToChat = Object.values(state.chats).find(c => c.originalName === deletedComment.replyTo);
              if (repliedToChat) {
                aiToNotifyIds.add(repliedToChat.id);
              }
            }


            const postSummary = (post.publicText || post.content || '').substring(0, 30);
            const userNickname = state.qzoneSettings.nickname;
            let notificationText;
            const stickerMatch = state.userStickers.find(s => s.url === deletedComment.text);

            if (stickerMatch) {
              notificationText = `Áî®Êà∑'${userNickname}'ÂàöÂàöÂú®‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚Äù‰∏ãÔºåÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖËØÑËÆ∫ÔºåÊÑèÊÄùÊòØÔºö‚Äú${stickerMatch.name}‚Äù„ÄÇ`;
            } else if (deletedComment.replyTo) {
              const repliedToDisplayName = getDisplayNameByOriginalName(deletedComment.replyTo);
              notificationText = `Áî®Êà∑'${userNickname}'ÂàöÂàöÂú®‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚Äù‰∏ãÔºåÂõûÂ§ç‰∫Ü'${repliedToDisplayName}'ÁöÑËØÑËÆ∫ÔºåÂÜÖÂÆπÊòØÔºö‚Äú${deletedComment.text}‚Äù„ÄÇ`;
            } else {
              notificationText = `Áî®Êà∑'${userNickname}'ÂàöÂàöËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚ÄùÔºåÂÜÖÂÆπÊòØÔºö‚Äú${deletedComment.text}‚Äù„ÄÇ`;
            }
            const fullSystemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö${notificationText}ËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ]`;


            for (const aiId of aiToNotifyIds) {
              const chat = state.chats[aiId];
              if (chat) {
                const originalLength = chat.history.length;

                chat.history = chat.history.filter(msg =>
                  !(msg.isHidden && msg.role === 'system' && msg.content === fullSystemContent)
                );

                if (chat.history.length < originalLength) {
                  console.log(`Âú®ËßíËâ≤ "${chat.name}" ÁöÑËÆ∞ÂøÜ‰∏≠Ê∏ÖÈô§‰∫Ü1Êù°ÂÖ≥‰∫éÂ∑≤Âà†Èô§ËØÑËÆ∫ÁöÑÈÄöÁü•„ÄÇ`);
                  await db.chats.put(chat);
                }
              }
            }
          }


          await updateSinglePostInDOM(postId);
        }

        return;
      }


      const stickerBtn = target.closest('.comment-sticker-btn');
      if (stickerBtn) {
        const postContainer = stickerBtn.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        if (qzoneStickerPanelState.isOpen && qzoneStickerPanelState.activePostId === postId) {
          closeQzoneStickerPanel();
        } else {
          openQzoneStickerPanel(postId, stickerBtn);
        }
        return;
      }
      const commentItem = target.closest('.comment-item');
      if (commentItem) {
        const postId = parseInt(commentItem.dataset.postId);
        const commenterOriginalName = commentItem.dataset.commenterOriginalName;
        const commenterDisplayName = commentItem.dataset.commenterDisplayName;

        if (!commenterOriginalName || !commenterDisplayName || commenterOriginalName === state.qzoneSettings.nickname) {
          clearQzoneReplyContext(commentItem.closest('.qzone-post-container'));
          return;
        }
        currentQzoneReplyContext = {
          postId,
          replyToName: commenterOriginalName,
          replyToDisplayName: commenterDisplayName
        };
        const postContainer = commentItem.closest('.qzone-post-container');
        const commentInput = postContainer.querySelector('.comment-input');
        commentInput.placeholder = `ÂõûÂ§ç ${commenterDisplayName}:`;
        commentInput.focus();
        return;
      }
      if (target.classList.contains('post-actions-btn')) {
        const container = target.closest('.qzone-post-container');
        if (container && container.dataset.postId) showPostActions(parseInt(container.dataset.postId));
        return;
      }
      if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        showCustomAlert("ÂõæÁâáÂÜÖÂÆπ", target.dataset.hiddenText.replace(/<br>/g, '\n'));
        return;
      }


      const postContainer = target.closest('.qzone-post-container');
      if (!postContainer) return;
      const postId = parseInt(postContainer.dataset.postId);
      if (isNaN(postId)) return;

      if (target.closest('.qzone-post-delete-action')) {
        const confirmed = await showCustomConfirm('Âà†Èô§Âä®ÊÄÅ', 'Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÊù°Âä®ÊÄÅÂêóÔºü', {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          postContainer.style.transition = 'all 0.3s ease';
          postContainer.style.transform = 'scale(0.8)';
          postContainer.style.opacity = '0';
          setTimeout(async () => {
            await db.qzonePosts.delete(postId);
            const notificationIdentifier = `(ID: ${postId})`;
            for (const chatId in state.chats) {
              const chat = state.chats[chatId];
              const originalHistoryLength = chat.history.length;
              chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
              if (chat.history.length < originalHistoryLength) await db.chats.put(chat);
            }
            await renderQzonePosts();
            alert('Âä®ÊÄÅÂ∑≤Âà†Èô§„ÄÇ');
          }, 300);
        }
        return;
      }

      const icon = target.closest('.action-icon');
      if (icon) {
        if (icon.classList.contains('repost')) {
          openRepostModal(postId);
          return;
        }
        if (icon.classList.contains('like')) {
          const post = qzonePostsCache.find(p => p.id === postId);
          if (!post) return;
          if (!post.likes) post.likes = [];
          const userOriginalName = state.qzoneSettings.nickname;
          const userLikeIndex = post.likes.indexOf(userOriginalName);
          if (userLikeIndex > -1) {
            post.likes.splice(userLikeIndex, 1);
          } else {
            post.likes.push(userOriginalName);
            icon.classList.add('animate-like');
            icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), {
              once: true
            });
          }
          await db.qzonePosts.update(postId, {
            likes: post.likes
          });
          await updateSinglePostInDOM(postId);
        }
        if (icon.classList.contains('favorite')) {
          const existingFavorite = await db.favorites.where({
            type: 'qzone_post',
            'content.id': postId
          }).first();
          if (existingFavorite) {
            await db.favorites.delete(existingFavorite.id);
            await showCustomAlert('ÊèêÁ§∫', 'Â∑≤ÂèñÊ∂àÊî∂Ëóè');
          } else {
            const postToSave = await db.qzonePosts.get(postId);
            if (postToSave) {
              await db.favorites.add({
                type: 'qzone_post',
                content: postToSave,
                timestamp: Date.now()
              });
              await showCustomAlert('ÊèêÁ§∫', 'Êî∂ËóèÊàêÂäüÔºÅ');
            }
          }
          await updateSinglePostInDOM(postId);
        }
        return;
      }

      const sendBtn = target.closest('.comment-send-btn');
      if (sendBtn) {
        const commentInput = postContainer.querySelector('.comment-input');
        const commentText = commentInput.value.trim();
        if (!commentText) return alert('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫Âì¶ÔºÅ');

        const post = qzonePostsCache.find(p => p.id === postId);
        if (!post) return;

        if (!post.comments) post.comments = [];

        const newComment = {
          commenterName: state.qzoneSettings.nickname,
          text: commentText,
          timestamp: Date.now(),
          replyTo: (currentQzoneReplyContext && currentQzoneReplyContext.postId === postId) ? currentQzoneReplyContext.replyToName : null
        };

        post.comments.push(newComment);
        await db.qzonePosts.update(postId, {
          comments: post.comments
        });

        let postSummary = (post.publicText || post.content || '').substring(0, 30);
        const userNickname = state.qzoneSettings.nickname;
        const notifiedAiIds = new Set();
        if (post.authorId !== 'user') notifiedAiIds.add(post.authorId);
        if (newComment.replyTo && newComment.replyTo !== userNickname) {
          const repliedToChat = Object.values(state.chats).find(c => c.originalName === newComment.replyTo);
          if (repliedToChat) notifiedAiIds.add(repliedToChat.id);
        }
        for (const aiId of notifiedAiIds) {
          const chat = state.chats[aiId];
          if (chat && !chat.isGroup) {
            const stickerMatch = state.userStickers.find(s => s.url === commentText);
            let notificationText = stickerMatch ? `Áî®Êà∑'${userNickname}'ÂàöÂàöÂú®‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚Äù‰∏ãÔºåÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖËØÑËÆ∫ÔºåÊÑèÊÄùÊòØÔºö‚Äú${stickerMatch.name}‚Äù„ÄÇ` :
              newComment.replyTo ? `Áî®Êà∑'${userNickname}'ÂàöÂàöÂú®‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚Äù‰∏ãÔºåÂõûÂ§ç‰∫Ü'${currentQzoneReplyContext.replyToDisplayName}'ÁöÑËØÑËÆ∫ÔºåÂÜÖÂÆπÊòØÔºö‚Äú${commentText}‚Äù„ÄÇ` :
                `Áî®Êà∑'${userNickname}'ÂàöÂàöËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚ÄùÔºåÂÜÖÂÆπÊòØÔºö‚Äú${commentText}‚Äù„ÄÇ`;
            const historyMessage = {
              role: 'system',
              content: `[Á≥ªÁªüÊèêÁ§∫Ôºö${notificationText}ËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ]`,
              timestamp: Date.now(),
              isHidden: true
            };
            chat.history.push(historyMessage);
            await db.chats.put(chat);
          }
        }

        commentInput.value = '';
        clearQzoneReplyContext(postContainer);
        await updateSinglePostInDOM(postId);
        return;
      }
    }






    const handleSwipeStart = (e) => {
      const target = e.target;

      if (target.closest('.post-footer, .post-feedback-icons, .post-actions-btn, .post-comments-container, .reposted-content-wrapper')) {
        return;
      }
      const targetContainer = e.target.closest('.qzone-post-container');
      if (!targetContainer) return;

      resetAllSwipes(targetContainer);
      swipeState.activeContainer = targetContainer;
      swipeState.isDragging = true;
      swipeState.isClick = true;
      swipeState.swipeDirection = null;
      swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
      swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';


      document.addEventListener('mousemove', handleSwipeMove);
      document.addEventListener('mouseup', handleSwipeEnd);
      document.addEventListener('touchmove', handleSwipeMove, {
        passive: false
      });
      document.addEventListener('touchend', handleSwipeEnd);
    };


    const handleSwipeMove = (e) => {
      if (!swipeState.isDragging || !swipeState.activeContainer) return;

      const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
      const diffX = currentX - swipeState.startX;
      const diffY = currentY - swipeState.startY;

      if (swipeState.isClick && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) {
        swipeState.isClick = false;
      }

      if (!swipeState.swipeDirection) {
        if (Math.abs(diffX) > Math.abs(diffY)) {
          swipeState.swipeDirection = 'horizontal';
        } else {
          swipeState.swipeDirection = 'vertical';
        }
      }

      if (swipeState.swipeDirection === 'horizontal') {
        e.preventDefault();
        swipeState.currentX = currentX;
        let translation = Math.min(0, Math.max(-90, diffX));
        swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
      }
    };


    const handleSwipeEnd = (e) => {

      document.removeEventListener('mousemove', handleSwipeMove);
      document.removeEventListener('mouseup', handleSwipeEnd);
      document.removeEventListener('touchmove', handleSwipeMove);
      document.removeEventListener('touchend', handleSwipeEnd);

      if (!swipeState.isDragging || !swipeState.activeContainer) return;

      const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
      postItem.style.transition = 'transform 0.3s ease';

      if (swipeState.swipeDirection === 'horizontal' && !swipeState.isClick) {
        const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
        const diffX = finalX - swipeState.startX;
        if (diffX < -40) {
          postItem.classList.add('swiped');
        } else {
          postItem.classList.remove('swiped');
        }
      }

      postItem.style.transform = '';


      swipeState.isDragging = false;
      swipeState.activeContainer = null;
      swipeState.swipeDirection = null;
      swipeState.isClick = true;
    };











    postsList.addEventListener('click', handlePostClick);
    postsList.addEventListener('mousedown', handleSwipeStart);
    postsList.addEventListener('touchstart', handleSwipeStart, {
      passive: true
    });



    postsList.addEventListener('click', (e) => {

      if (e.target && e.target.id === 'load-more-qzone-btn') {
        loadMoreQzonePosts();
      }
    });


    document.getElementById('refine-memory-btn-header').addEventListener('click', () => {
      if (state.activeChatId) {
        summarizeExistingLongTermMemory(state.activeChatId);
      }
    });

    document.getElementById('api-preset-select').addEventListener('change', handlePresetSelectionChange);
    document.getElementById('save-api-preset-btn').addEventListener('click', saveApiPreset);
    document.getElementById('delete-api-preset-btn').addEventListener('click', deleteApiPreset);


    document.getElementById('add-world-book-entry-btn').addEventListener('click', () => {
      const container = document.getElementById('world-book-entries-container');

      if (container.querySelector('p')) {
        container.innerHTML = '';
      }
      const newBlock = createWorldBookEntryBlock();
      container.appendChild(newBlock);
      newBlock.querySelector('.entry-content-textarea').focus();
    });


    document.getElementById('switch-greeting-btn').addEventListener('click', handleSwitchGreeting);

    document.getElementById('thoughts-history-list').addEventListener('click', (e) => {
      if (e.target && e.target.id === 'load-more-thoughts-btn') {
        loadMoreThoughts();
      }
    });




    document.getElementById('profile-history-icon-btn').addEventListener('click', showThoughtsHistory);

    document.getElementById('history-back-btn').addEventListener('click', hideThoughtsHistory);
    document.getElementById('character-profile-modal').addEventListener('click', (e) => {

      if (e.target.id === 'character-profile-modal') {
        e.target.classList.remove('visible');
      }
    });

    document.getElementById('manage-stickers-btn').addEventListener('click', toggleStickerManagementMode);
    document.getElementById('delete-selected-stickers-btn').addEventListener('click', executeBatchDeleteStickers);
    document.getElementById('export-selected-stickers-btn').addEventListener('click', executeBatchExportStickers);

    document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
    document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));






    const searchInput = document.getElementById('favorites-search-input');
    const searchClearBtn = document.getElementById('favorites-search-clear-btn');

    searchInput.addEventListener('input', () => {
      const searchTerm = searchInput.value.trim().toLowerCase();


      searchClearBtn.style.display = searchTerm ? 'block' : 'none';

      if (!searchTerm) {
        displayFilteredFavorites(allFavoriteItems);
        return;
      }


      const filteredItems = allFavoriteItems.filter(item => {
        let contentToSearch = '';
        let authorToSearch = '';

        if (item.type === 'qzone_post') {
          const post = item.content;
          contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
          if (post.authorId === 'user') {
            authorToSearch = state.qzoneSettings.nickname;
          } else if (state.chats[post.authorId]) {
            authorToSearch = state.chats[post.authorId].name;
          }
        } else if (item.type === 'chat_message') {
          const msg = item.content;
          if (typeof msg.content === 'string') {
            contentToSearch = msg.content;
          }
          const chat = state.chats[item.chatId];
          if (chat) {
            if (msg.role === 'user') {
              authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
            } else {
              authorToSearch = chat.isGroup ? msg.senderName : chat.name;
            }
          }
        }


        return contentToSearch.toLowerCase().includes(searchTerm) ||
          authorToSearch.toLowerCase().includes(searchTerm);
      });

      displayFilteredFavorites(filteredItems);
    });


    searchClearBtn.addEventListener('click', () => {
      searchInput.value = '';
      searchClearBtn.style.display = 'none';
      displayFilteredFavorites(allFavoriteItems);
      searchInput.focus();
    });







    document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
      if (selectedMessages.size === 0) return;
      const chat = state.chats[state.activeChatId];
      if (!chat) return;

      const favoritesToAdd = [];
      const timestampsToFavorite = [...selectedMessages];

      for (const timestamp of timestampsToFavorite) {

        const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();

        if (!existing) {
          const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
          if (messageToSave) {
            favoritesToAdd.push({
              type: 'chat_message',
              content: messageToSave,
              chatId: state.activeChatId,
              timestamp: Date.now(),
              originalTimestamp: messageToSave.timestamp
            });
          }
        }
      }

      if (favoritesToAdd.length > 0) {
        await db.favorites.bulkAdd(favoritesToAdd);
        allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
        await showCustomAlert('Êî∂ËóèÊàêÂäü', `Â∑≤ÊàêÂäüÊî∂Ëóè ${favoritesToAdd.length} Êù°Ê∂àÊÅØ„ÄÇ`);
      } else {
        await showCustomAlert('ÊèêÁ§∫', 'ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØÂùáÂ∑≤Êî∂ËóèËøá„ÄÇ');
      }

      exitSelectionMode();
    });


    const favoritesEditBtn = document.getElementById('favorites-edit-btn');
    const favoritesView = document.getElementById('favorites-view');
    const favoritesActionBar = document.getElementById('favorites-action-bar');
    const mainBottomNav = document.getElementById('chat-list-bottom-nav');
    const favoritesList = document.getElementById('favorites-list');

    favoritesEditBtn.addEventListener('click', () => {
      isFavoritesSelectionMode = !isFavoritesSelectionMode;
      favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);

      if (isFavoritesSelectionMode) {

        favoritesEditBtn.textContent = 'ÂÆåÊàê';
        favoritesActionBar.style.display = 'block';
        mainBottomNav.style.display = 'none';
        favoritesList.style.paddingBottom = '80px';
      } else {

        favoritesEditBtn.textContent = 'ÁºñËæë';
        favoritesActionBar.style.display = 'none';
        mainBottomNav.style.display = 'flex';
        favoritesList.style.paddingBottom = '';


        selectedFavorites.clear();
        document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
        document.getElementById('favorites-delete-selected-btn').textContent = `Âà†Èô§ (0)`;
      }
    });



    document.getElementById('favorites-list').addEventListener('click', (e) => {
      const target = e.target;
      const card = target.closest('.favorite-item-card');


      if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("ÂõæÁâáÂÜÖÂÆπ", hiddenText.replace(/<br>/g, '\n'));
        return;
      }


      if (!isFavoritesSelectionMode) return;


      if (!card) return;

      const favId = parseInt(card.dataset.favid);
      if (isNaN(favId)) return;


      if (selectedFavorites.has(favId)) {
        selectedFavorites.delete(favId);
        card.classList.remove('selected');
      } else {
        selectedFavorites.add(favId);
        card.classList.add('selected');
      }


      document.getElementById('favorites-delete-selected-btn').textContent = `Âà†Èô§ (${selectedFavorites.size})`;
    });



    document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
      if (selectedFavorites.size === 0) return;

      const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§Âà†Èô§',
        `Á°ÆÂÆöË¶Å‰ªéÊî∂ËóèÂ§π‰∏≠ÁßªÈô§Ëøô ${selectedFavorites.size} Êù°ÂÜÖÂÆπÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      }
      );

      if (confirmed) {
        const idsToDelete = [...selectedFavorites];
        await db.favorites.bulkDelete(idsToDelete);
        await showCustomAlert('Âà†Èô§ÊàêÂäü', 'ÈÄâ‰∏≠ÁöÑÊî∂ËóèÂ∑≤Ë¢´ÁßªÈô§„ÄÇ');


        allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));


        displayFilteredFavorites(allFavoriteItems);


        favoritesEditBtn.click();
      }
    });


    if (state.globalSettings.enableBackgroundActivity) {
      startBackgroundSimulation();
      console.log("ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤Ëá™Âä®ÂêØÂä®„ÄÇ");
    }







    document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
      radio.addEventListener('change', updateSettingsPreview);
    });


    const chatFontSizeSlider = document.getElementById('chat-font-size-slider');
    chatFontSizeSlider.addEventListener('input', () => {

      document.getElementById('chat-font-size-value').textContent = `${chatFontSizeSlider.value}px`;

      updateSettingsPreview();
    });


    const customCssInputForPreview = document.getElementById('custom-css-input');
    customCssInputForPreview.addEventListener('input', updateSettingsPreview);


    document.getElementById('reset-theme-btn').addEventListener('click', () => {
      document.getElementById('theme-default').checked = true;
      updateSettingsPreview();
    });

    document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
      document.getElementById('custom-css-input').value = '';
      updateSettingsPreview();
    });



    document.getElementById('lyrics-vertical-pos').addEventListener('change', updateSettingsPreview);
    document.getElementById('lyrics-horizontal-pos').addEventListener('change', updateSettingsPreview);
    document.getElementById('lyrics-offset-input').addEventListener('input', updateSettingsPreview);

    document.querySelectorAll('input[name="visibility"]').forEach(radio => {
      radio.addEventListener('change', function () {
        const groupsContainer = document.getElementById('post-visibility-groups');
        if (this.value === 'include' || this.value === 'exclude') {
          groupsContainer.style.display = 'block';
        } else {
          groupsContainer.style.display = 'none';
        }
      });
    });



    document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
    document.getElementById('close-group-manager-btn').addEventListener('click', () => {
      document.getElementById('group-management-modal').classList.remove('visible');

      const chatSettingsBtn = document.getElementById('chat-settings-btn');
      if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
        chatSettingsBtn.click();
      }
    });

    document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
    document.getElementById('existing-groups-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-group-btn')) {
        const groupId = parseInt(e.target.dataset.id);
        deleteGroup(groupId);
      }
    });




    document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);

    // ÁøªËØëÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
    document.getElementById('translate-message-btn').addEventListener('click', translateMessageContent);

    document.getElementById('edit-message-btn').addEventListener('click', openAdvancedMessageEditor);

    document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);


    document.getElementById('recall-message-btn').addEventListener('click', handleRecallClick);



    document.getElementById('select-message-btn').addEventListener('click', () => {

      const timestampToSelect = activeMessageTimestamp;
      hideMessageActions();

      if (timestampToSelect) {
        enterSelectionMode(timestampToSelect);
      }
    });

    // ÊéíÈô§Ê∂àÊÅØÊåâÈíÆ (ÂçïÊù°) - Â∑≤ÁßªËá≥ËÅäÂ§©ËÆæÁΩÆÊâπÈáèÁÆ°ÁêÜ

    // ÊéíÈô§Ê∂àÊÅØÊåâÈíÆ (Â§öÈÄâ) - Â∑≤ÁßªËá≥ËÅäÂ§©ËÆæÁΩÆÊâπÈáèÁÆ°ÁêÜ

    // ÊâπÈáèÁÆ°ÁêÜÊéíÈô§Ê∂àÊÅØ (ËÅäÂ§©ËØ¶ÊÉÖÂÖ•Âè£)
    document.getElementById('batch-exclude-manage-btn').addEventListener('click', openBatchExcludeManager);
    document.getElementById('batch-exclude-cancel-btn').addEventListener('click', closeBatchExcludeManager);
    document.getElementById('view-excluded-detail-btn').addEventListener('click', openExcludedDetailView);
    document.getElementById('excluded-detail-close-btn').addEventListener('click', closeExcludedDetailView);
    document.getElementById('token-detail-trigger').addEventListener('click', openTokenBreakdown);
    document.getElementById('token-breakdown-close-btn').addEventListener('click', closeTokenBreakdown);
    document.getElementById('batch-exclude-action-btn').addEventListener('click', () => batchExcludeAction(true));
    document.getElementById('batch-include-action-btn').addEventListener('click', () => batchExcludeAction(false));
    document.getElementById('batch-exclude-select-all').addEventListener('click', () => {
      document.querySelectorAll('#batch-exclude-list .batch-exclude-item').forEach(item => {
        const ts = parseInt(item.dataset.timestamp);
        batchExcludeChecked.add(ts);
        item.classList.add('checked');
      });
      document.getElementById('batch-exclude-selected-count').textContent = `Â∑≤ÈÄâ ${batchExcludeChecked.size} Êù°`;
    });
    document.getElementById('batch-exclude-deselect-all').addEventListener('click', () => {
      batchExcludeChecked.clear();
      document.querySelectorAll('#batch-exclude-list .batch-exclude-item').forEach(item => item.classList.remove('checked'));
      document.getElementById('batch-exclude-selected-count').textContent = 'Â∑≤ÈÄâ 0 Êù°';
    });
    document.getElementById('batch-exclude-select-range').addEventListener('click', async () => {
      const rangeStr = await showCustomPrompt('ÊåâËåÉÂõ¥ÈÄâÊã©', 'ËæìÂÖ•Ë¶ÅÈÄâÊã©ÁöÑÊ∂àÊÅØËåÉÂõ¥Ôºå‰æãÂ¶ÇÔºö1-50 Ë°®Á§∫Á¨¨1Âà∞Á¨¨50Êù°', '', 'text');
      if (!rangeStr) return;
      const match = rangeStr.match(/(\d+)\s*[-~Âà∞]\s*(\d+)/);
      if (!match) return;
      const start = parseInt(match[1]) - 1;
      const end = parseInt(match[2]);
      const items = document.querySelectorAll('#batch-exclude-list .batch-exclude-item');
      items.forEach((item, i) => {
        if (i >= start && i < end) {
          batchExcludeChecked.add(parseInt(item.dataset.timestamp));
          item.classList.add('checked');
        }
      });
      document.getElementById('batch-exclude-selected-count').textContent = `Â∑≤ÈÄâ ${batchExcludeChecked.size} Êù°`;
    });







    document.getElementById('transfer-action-accept').addEventListener('click', () => {
      // Ê£ÄÊü•ÊòØÂê¶Âú® My Phone ÁéØÂ¢É‰∏≠
      if (activeMyPhoneTransferTimestamp !== null && typeof activeMyPhoneTransferTimestamp !== 'undefined') {
        handleMyPhoneTransferResponse('accepted');
      } else {
        handleUserTransferResponse('accepted');
      }
    });
    document.getElementById('transfer-action-decline').addEventListener('click', () => {
      // Ê£ÄÊü•ÊòØÂê¶Âú® My Phone ÁéØÂ¢É‰∏≠
      if (activeMyPhoneTransferTimestamp !== null && typeof activeMyPhoneTransferTimestamp !== 'undefined') {
        handleMyPhoneTransferResponse('declined');
      } else {
        handleUserTransferResponse('declined');
      }
    });
    document.getElementById('transfer-action-cancel').addEventListener('click', () => {
      hideTransferActionModal();
      // Ê∏ÖÈô§ My Phone ËΩ¨Ë¥¶Áä∂ÊÄÅ
      if (typeof activeMyPhoneTransferTimestamp !== 'undefined') {
        activeMyPhoneTransferTimestamp = null;
      }
    });





    document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
    document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
    document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);




    document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
      showScreen('chat-list-screen');
    });

    document.getElementById('contact-picker-list').addEventListener('click', (e) => {
      const item = e.target.closest('.contact-picker-item');
      if (!item) return;

      const contactId = item.dataset.contactId;
      item.classList.toggle('selected');

      if (selectedContacts.has(contactId)) {
        selectedContacts.delete(contactId);
      } else {
        selectedContacts.add(contactId);
      }
      updateContactPickerConfirmButton();
    });


    document.getElementById('manage-members-btn').addEventListener('click', () => {



      openMemberManagementScreen();
    });



    document.getElementById('back-from-member-management').addEventListener('click', () => {

      showScreen('chat-interface-screen');
      document.getElementById('chat-settings-btn').click();
    });


    document.getElementById('member-management-list').addEventListener('click', (e) => {

      if (e.target.classList.contains('remove-member-btn')) {
        removeMemberFromGroup(e.target.dataset.memberId);
      }
    });

    document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {


      const confirmBtn = document.getElementById('confirm-contact-picker-btn');

      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      newConfirmBtn.addEventListener('click', handleAddMembersToGroup);

      await openContactPickerForAddMember();
    });

    document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);





    document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
    document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);
    document.getElementById('voice-call-btn').addEventListener('click', handleInitiateVoiceCall);
    document.getElementById('group-voice-call-btn').addEventListener('click', handleInitiateVoiceCall);


    document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);
    document.getElementById('minimize-call-btn').addEventListener('click', minimizeVideoCall);
    document.getElementById('video-call-restore-btn').addEventListener('click', restoreVideoCall);

    makeDraggable(document.getElementById('video-call-restore-btn'), document.getElementById('video-call-restore-btn'));

    // ËØ≠Èü≥ÈÄöËØùÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
    document.getElementById('voice-hang-up-btn').addEventListener('click', endVoiceCall);
    document.getElementById('minimize-voice-call-btn').addEventListener('click', minimizeVoiceCall);
    document.getElementById('voice-call-restore-btn').addEventListener('click', restoreVoiceCall);
    makeDraggable(document.getElementById('voice-call-restore-btn'), document.getElementById('voice-call-restore-btn'));
    document.getElementById('voice-join-call-btn').addEventListener('click', handleUserJoinVoiceCall);
    document.getElementById('voice-user-speak-btn').addEventListener('click', async () => {
      if (!voiceCallState.isActive) return;
      const userAvatar = document.querySelector('#voice-participant-avatars-grid .participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
      if (userAvatar) {
        userAvatar.classList.add('speaking');
      }
      const userInput = await showCustomPrompt('‰Ω†ËØ¥', 'ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù...');
      if (userAvatar) {
        userAvatar.classList.remove('speaking');
      }
      if (userInput && userInput.trim()) {
        triggerAiInVoiceCallAction(userInput.trim());
      }
    });
    document.getElementById('voice-regenerate-call-btn').addEventListener('click', () => {
      if (!voiceCallState.isActive) return;
      if (voiceCallState.callHistory.length > 0) {
        voiceCallState.callHistory.pop();
        const callFeed = document.getElementById('voice-call-main');
        const lastBubble = callFeed.querySelector('.call-message-bubble:last-child');
        if (lastBubble) lastBubble.remove();
      }
      triggerAiInVoiceCallAction();
    });

    document.getElementById('cancel-call-btn').addEventListener('click', () => {
      videoCallState.isAwaitingResponse = false;
      showScreen('chat-interface-screen');
    });


    document.getElementById('join-call-btn').addEventListener('click', handleUserJoinCall);



    document.getElementById('decline-call-btn').addEventListener('click', async () => {
      hideIncomingCallModal();
      const chat = state.chats[videoCallState.activeChatId];
      if (!chat) return;


      if (videoCallState.isGroupCall) {
        videoCallState.isUserParticipating = false;


        const systemNote = {
          role: 'system',
          content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊãíÁªù‰∫ÜÈÄöËØùÈÇÄËØ∑Ôºå‰ΩÜ‰Ω†‰ª¨ÂèØ‰ª•Ëá™Â∑±ÂºÄÂßã„ÄÇËØ∑‰Ω†‰ª¨ÂêÑËá™ÂÜ≥Á≠ñÊòØÂê¶Âä†ÂÖ•„ÄÇ]`,
          timestamp: Date.now(),
          isHidden: true
        };
        chat.history.push(systemNote);
        await db.chats.put(chat);



        await triggerAiResponse();

      } else {
        const declineMessage = {
          role: 'user',
          content: 'ÊàëÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ',
          timestamp: Date.now()
        };
        chat.history.push(declineMessage);
        await db.chats.put(chat);


        showScreen('chat-interface-screen');
        appendMessage(declineMessage, chat);


        triggerAiResponse();
      }


      videoCallState.isAwaitingResponse = false;
    });




    document.getElementById('accept-call-btn').addEventListener('click', async () => {
      hideIncomingCallModal();

      videoCallState.initiator = 'ai';
      videoCallState.isUserParticipating = true;
      videoCallState.activeChatId = state.activeChatId;


      if (videoCallState.isGroupCall) {

        const chat = state.chats[videoCallState.activeChatId];
        const requester = chat.members.find(m => m.name === videoCallState.callRequester);
        if (requester) {

          videoCallState.participants = [requester];
        } else {
          videoCallState.participants = [];
        }
      }


      startVideoCall();
    });





    document.getElementById('user-speak-btn').addEventListener('click', async () => {
      if (!videoCallState.isActive) return;


      const userAvatar = document.querySelector('.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
      if (userAvatar) {
        userAvatar.classList.add('speaking');
      }

      const userInput = await showCustomPrompt('‰Ω†ËØ¥', 'ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù...');


      if (userAvatar) {
        userAvatar.classList.remove('speaking');
      }

      if (userInput && userInput.trim()) {
        triggerAiInCallAction(userInput.trim());
      }
    });




    document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {

      if (isFavoritesSelectionMode) {
        document.getElementById('favorites-edit-btn').click();
      }
      switchToChatListView('memories-view');
      renderMemoriesScreen();
    });


    document.getElementById('memories-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));




    document.getElementById('confirm-create-countdown-btn').addEventListener('click', async () => {
      const title = document.getElementById('countdown-title-input').value.trim();
      const dateValue = document.getElementById('countdown-date-input').value;

      if (!title || !dateValue) {
        alert('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÁ∫¶ÂÆöÊ†áÈ¢òÂíåÊó•ÊúüÔºÅ');
        return;
      }

      const targetDate = new Date(dateValue);
      if (isNaN(targetDate) || targetDate <= new Date()) {
        alert('ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑ„ÄÅÊú™Êù•ÁöÑÊó•ÊúüÔºÅ');
        return;
      }


      const newCountdown = {
        authorId: 'user',
        description: title,
        timestamp: Date.now(),
        type: 'countdown',
        targetDate: targetDate.getTime()
      };


      await db.memories.add(newCountdown);
      document.getElementById('create-countdown-modal').classList.remove('visible');
      renderMemoriesScreen();
    });


    document.getElementById('block-chat-btn').addEventListener('click', async () => {
      if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;

      const chat = state.chats[state.activeChatId];
      const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§ÊãâÈªë',
        `Á°ÆÂÆöË¶ÅÊãâÈªë‚Äú${chat.name}‚ÄùÂêóÔºüÊãâÈªëÂêéÊÇ®Â∞ÜÊó†Ê≥ïÂêëÂÖ∂ÂèëÈÄÅÊ∂àÊÅØÔºåÁõ¥Âà∞ÊÇ®Â∞ÜTaÁßªÂá∫ÈªëÂêçÂçïÔºåÊàñÁ≠âÂæÖTaÈáçÊñ∞Áî≥ËØ∑Â•ΩÂèã„ÄÇ`, {
        confirmButtonClass: 'btn-danger'
      }
      );

      if (confirmed) {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();


        const hiddenMessage = {
          role: 'system',
          content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöË¢´Áî®Êà∑ÊãâÈªë‰∫Ü„ÄÇÂú®ÂØπÊñπËß£Èô§ÊãâÈªë‰πãÂâçÔºå‰Ω†Êó†Ê≥ïÂÜç‰∏ªÂä®ÂèëËµ∑ÂØπËØùÔºå‰πüÊó†Ê≥ïÂõûÂ∫î„ÄÇ]`,
          timestamp: Date.now() + 1,
          isHidden: true
        };
        chat.history.push(hiddenMessage);


        await db.chats.put(chat);


        document.getElementById('chat-settings-modal').classList.remove('visible');
        renderChatInterface(state.activeChatId);

        renderChatList();
      }
    });

    document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
      const chat = state.chats[state.activeChatId];
      if (!chat) return;

      if (e.target.id === 'force-apply-check-btn') {
        alert("Ê≠£Âú®ÊâãÂä®Ëß¶ÂèëÂ•ΩÂèãÁî≥ËØ∑ÊµÅÁ®ãÔºåËØ∑Á®çÂêé...\nÂ¶ÇÊûúAPIË∞ÉÁî®ÊàêÂäüÔºåÂ∞ÜÂºπÂá∫ÊèêÁ§∫„ÄÇÂ¶ÇÊûúÂ§±Ë¥•Ôºå‰πü‰ºöÊúâÈîôËØØÊèêÁ§∫„ÄÇÂ¶ÇÊûúÈïøÊó∂Èó¥Êó†ÂèçÂ∫îÔºåËØ¥ÊòéAIÂèØËÉΩÂÜ≥ÂÆöÊöÇÊó∂‰∏çÁî≥ËØ∑„ÄÇ");
        await triggerAiFriendApplication(chat.id);
        renderChatInterface(chat.id);
        return;
      }

      if (e.target.id === 'unblock-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.blockedTimestamp = null;


        const hiddenMessage = {
          role: 'system',
          content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÂàöËß£Èô§‰∫ÜÂØπ‰Ω†ÁöÑÊãâÈªë„ÄÇÁé∞Âú®‰Ω†‰ª¨ÂèØ‰ª•ÈáçÊñ∞ÂºÄÂßãÂØπËØù‰∫Ü„ÄÇ]`,
          timestamp: Date.now(),
          isHidden: true
        };
        chat.history.push(hiddenMessage);


        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        triggerAiResponse();
      } else if (e.target.id === 'accept-friend-btn') {
        // „Äê‰øÆÂ§ç„Äë1. ÂÖàËé∑ÂèñAIÁöÑÁî≥ËØ∑ÁêÜÁî±ÔºåÈò≤Ê≠¢Ë¢´Ê∏ÖÈô§
        const applicationReason = chat.relationship.applicationReason || 'ÔºàÂØπÊñπÊ≤°ÊúâÁïô‰∏ãÁêÜÁî±Ôºå‰ΩÜÊàë‰ª¨ÂíåÂ•Ω‰∫ÜÔºâ';

        // 2. Êõ¥Êñ∞Áä∂ÊÄÅ
        chat.relationship.status = 'friend';
        chat.relationship.applicationReason = ''; // Áé∞Âú®ÂèØ‰ª•ÂÆâÂÖ®Ê∏ÖÁ©∫‰∫Ü

        // 3. (ÂèØÈÄâ) ‰øùÁïôÁ≥ªÁªüÊ∂àÊÅØ
        const systemMessage = {
          role: 'system',
          type: 'pat_message',
          content: `‰Ω†ÈÄöËøá‰∫Ü‚Äú${chat.name}‚ÄùÁöÑÂ•ΩÂèãËØ∑Ê±Ç`,
          timestamp: Date.now()
        };
        chat.history.push(systemMessage);

        // 4. „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂ∞ÜAIÁöÑ‚ÄúÁî≥ËØ∑ÁêÜÁî±‚Äù‰Ωú‰∏∫ÂÆÉÁöÑÁ¨¨‰∏ÄÊù°Ê∂àÊÅØÊé®ÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï
        const applicationMessage = {
          role: 'assistant',
          senderName: chat.name,
          content: applicationReason, // <-- ‰ΩøÁî®AIËá™Â∑±ÁîüÊàêÁöÑÁêÜÁî±
          timestamp: Date.now() + 1
        };
        chat.history.push(applicationMessage);

        // 5. ‰øùÂ≠òÂπ∂Âà∑Êñ∞
        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();

        // 6. (ÂèØÈÄâ) Á´ãÂç≥Ëß¶ÂèëAIÔºåËÆ©ÂÆÉÂØπ‚ÄúË¢´Êé•Âèó‚ÄùËøô‰ª∂‰∫ã‰ΩúÂá∫ÂõûÂ∫î

      } else if (e.target.id === 'reject-friend-btn') {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
        chat.relationship.applicationReason = '';
        await db.chats.put(chat);
        renderChatInterface(chat.id);
      } else if (e.target.id === 'apply-friend-btn') {
        const reason = await showCustomPrompt(
          'ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑',
          `ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ÂØπ‚Äú${chat.name}‚ÄùËØ¥ÁöÑÁî≥ËØ∑ÁêÜÁî±Ôºö`,
          "Êàë‰ª¨ÂíåÂ•ΩÂêßÔºÅ"
        );

        if (reason !== null) {

          chat.relationship.status = 'pending_ai_approval';
          chat.relationship.applicationReason = reason;
          await db.chats.put(chat);


          renderChatInterface(chat.id);
          renderChatList();


          triggerAiResponse();
        }
      }
    });




    document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);


    document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
      document.getElementById('red-packet-modal').classList.remove('visible');
    });
    document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
    document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);


    const rpTabGroup = document.getElementById('rp-tab-group');
    const rpTabDirect = document.getElementById('rp-tab-direct');
    const rpContentGroup = document.getElementById('rp-content-group');
    const rpContentDirect = document.getElementById('rp-content-direct');

    rpTabGroup.addEventListener('click', () => {
      rpTabGroup.classList.add('active');
      rpTabDirect.classList.remove('active');
      rpContentGroup.style.display = 'block';
      rpContentDirect.style.display = 'none';
    });
    rpTabDirect.addEventListener('click', () => {
      rpTabDirect.classList.add('active');
      rpTabGroup.classList.remove('active');
      rpContentDirect.style.display = 'block';
      rpContentGroup.style.display = 'none';
    });


    document.getElementById('rp-group-amount').addEventListener('input', (e) => {
      const amount = parseFloat(e.target.value) || 0;
      document.getElementById('rp-group-total').textContent = `¬• ${amount.toFixed(2)}`;
    });
    document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
      const amount = parseFloat(e.target.value) || 0;
      document.getElementById('rp-direct-total').textContent = `¬• ${amount.toFixed(2)}`;
    });









    document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);


    document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
    document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
      document.getElementById('create-poll-modal').classList.remove('visible');
    });
    document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);


    document.getElementById('chat-messages').addEventListener('click', (e) => {
      const pollCard = e.target.closest('.poll-card');
      if (!pollCard) return;

      const timestamp = parseInt(pollCard.dataset.pollTimestamp);
      if (isNaN(timestamp)) return;


      const optionItem = e.target.closest('.poll-option-item');
      if (optionItem && !pollCard.classList.contains('closed')) {
        handleUserVote(timestamp, optionItem.dataset.option);
        return;
      }


      const actionBtn = e.target.closest('.poll-action-btn');
      if (actionBtn) {
        if (pollCard.classList.contains('closed')) {
          showPollResults(timestamp);
        } else {
          endPoll(timestamp);
        }
        return;
      }


      if (pollCard.classList.contains('closed')) {
        showPollResults(timestamp);
      }
    });



    document.getElementById('manage-ai-avatar-library-btn').addEventListener('click', openAiAvatarLibraryModal);


    document.getElementById('add-ai-avatar-batch-btn').addEventListener('click', () => openBatchImportModal('ai'));


    document.getElementById('add-group-avatar-batch-btn').addEventListener('click', () => openBatchImportModal('group'));



    document.getElementById('add-ai-avatar-url-btn').addEventListener('click', addAvatarToLibraryFromURL);


    document.getElementById('add-ai-avatar-upload-btn').addEventListener('click', () => {
      document.getElementById('ai-avatar-upload-input').click();
    });


    document.getElementById('ai-avatar-upload-input').addEventListener('change', handleLocalAvatarUpload);

    document.getElementById('close-ai-avatar-library-btn').addEventListener('click', closeAiAvatarLibraryModal);


    document.getElementById('manage-group-avatar-library-btn').addEventListener('click', openGroupAvatarLibraryModal);



    document.getElementById('add-group-avatar-url-btn').addEventListener('click', addAvatarToGroupLibraryFromURL);


    document.getElementById('add-group-avatar-upload-btn').addEventListener('click', () => {
      document.getElementById('group-avatar-upload-input').click();
    });


    document.getElementById('group-avatar-upload-input').addEventListener('change', handleLocalGroupAvatarUpload);


    document.getElementById('close-group-avatar-library-btn').addEventListener('click', closeGroupAvatarLibraryModal);



    document.getElementById('icon-settings-grid').addEventListener('click', (e) => {
      if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (iconId) {
          handleIconChange(iconId, 'ephone', item);
        }
      }
    });




    document.getElementById('chat-messages').addEventListener('click', (e) => {

      const linkCard = e.target.closest('.link-share-card');
      if (linkCard) {
        const timestamp = parseInt(linkCard.dataset.timestamp);
        if (!isNaN(timestamp)) {
          openBrowser(timestamp);
        }
      }
    });


    document.getElementById('browser-back-btn').addEventListener('click', () => {
      showScreen('chat-interface-screen');
    });



    qzoneStickerPanelState.panelEl.addEventListener('click', async (e) => {
      const stickerItem = e.target.closest('.sticker-item');
      if (stickerItem && qzoneStickerPanelState.activePostId !== null) {

        const stickerUrl = stickerItem.style.backgroundImage.slice(5, -2);


        const stickerObject = state.userStickers.find(s => s.url === stickerUrl);

        if (stickerObject) {

          await sendQzoneStickerComment(qzoneStickerPanelState.activePostId, stickerObject);
        } else {
          console.warn("Âú®Âä®ÊÄÅËØÑËÆ∫Âå∫ÁÇπÂáª‰∫ÜË°®ÊÉÖÔºå‰ΩÜÂú®Ë°®ÊÉÖÂ∫ì‰∏≠Êú™ÊâæÂà∞ÂØπË±°:", stickerUrl);
        }
      }
    });




    document.addEventListener('click', (e) => {
      if (qzoneStickerPanelState.isOpen &&
        !qzoneStickerPanelState.panelEl.contains(e.target) &&
        !e.target.closest('.comment-sticker-btn')) {
        closeQzoneStickerPanel();
      }
    });



    document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);


    document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
      document.getElementById('share-link-modal').classList.remove('visible');
    });


    document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);



    document.getElementById('theme-toggle-switch').addEventListener('change', toggleTheme);
    document.getElementById('detach-status-bar-switch').addEventListener('change', (e) => {
      applyDetachStatusBarMode(e.target.checked);
    });
    document.getElementById('phone-frame-toggle-switch').addEventListener('change', (e) => {
      applyPhoneFrame(e.target.checked);
    });


    document.getElementById('share-location-btn').addEventListener('click', sendLocationShare);





    document.getElementById('chat-list-title').addEventListener('click', renderCallHistoryScreen);


    document.getElementById('call-history-back-btn').addEventListener('click', () => {

      showScreen('chat-list-screen');
    });


    document.getElementById('call-history-list').addEventListener('click', (e) => {
      const card = e.target.closest('.call-record-card');
      if (card && card.dataset.recordId) {
        showCallTranscript(parseInt(card.dataset.recordId));
      }
    });


    document.getElementById('close-call-transcript-btn').addEventListener('click', () => {
      document.getElementById('call-transcript-modal').classList.remove('visible');
    });





    document.getElementById('chat-header-status').addEventListener('click', handleEditStatusClick);


    document.getElementById('selection-share-btn').addEventListener('click', () => {
      if (selectedMessages.size > 0) {
        openShareTargetPicker();
      }
    });
    document.getElementById('selection-forward-btn').addEventListener('click', () => {
      if (selectedMessages.size > 0) {
        openForwardTargetPicker();
      }
    });
    document.getElementById('selection-screenshot-btn').addEventListener('click', handleLongScreenshot);

    document.getElementById('confirm-share-target-btn').addEventListener('click', async () => {
      const sourceChat = state.chats[state.activeChatId];
      const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
        .map(cb => cb.dataset.chatId);

      if (selectedTargetIds.length === 0) {
        alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂàÜ‰∫´ÁöÑËÅäÂ§©„ÄÇ");
        return;
      }


      const sharedHistory = [];
      const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
      for (const timestamp of sortedTimestamps) {
        const msg = sourceChat.history.find(m => m.timestamp === timestamp);
        if (msg) {
          sharedHistory.push(msg);
        }
      }


      const shareCardMessage = {
        role: 'user',
        senderName: sourceChat.isGroup ? (sourceChat.settings.myNickname || 'Êàë') : 'Êàë',
        type: 'share_card',
        timestamp: Date.now(),
        payload: {
          sourceChatName: sourceChat.name,
          title: `Êù•Ëá™‚Äú${sourceChat.name}‚ÄùÁöÑËÅäÂ§©ËÆ∞ÂΩï`,
          sharedHistory: sharedHistory
        }
      };


      for (const targetId of selectedTargetIds) {
        const targetChat = state.chats[targetId];
        if (targetChat) {
          targetChat.history.push(shareCardMessage);
          await db.chats.put(targetChat);
        }
      }


      document.getElementById('share-target-modal').classList.remove('visible');
      exitSelectionMode();
      await showCustomAlert("ÂàÜ‰∫´ÊàêÂäü", `ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÊàêÂäüÂàÜ‰∫´Âà∞ ${selectedTargetIds.length} ‰∏™‰ºöËØù‰∏≠„ÄÇ`);
      renderChatList();
    });


    document.getElementById('cancel-share-target-btn').addEventListener('click', () => {
      document.getElementById('share-target-modal').classList.remove('visible');
    });

    document.getElementById('confirm-forward-target-btn').addEventListener('click', async () => {
      const sourceChat = state.chats[state.activeChatId];
      const selectedTargetIds = Array.from(document.querySelectorAll('.forward-target-checkbox:checked'))
        .map(cb => cb.dataset.chatId);

      if (selectedTargetIds.length === 0) {
        alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅËΩ¨ÂèëÁöÑËÅäÂ§©„ÄÇ");
        return;
      }

      const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);

      for (const targetId of selectedTargetIds) {
        const targetChat = state.chats[targetId];
        if (!targetChat) continue;

        for (const timestamp of sortedTimestamps) {
          const msg = sourceChat.history.find(m => m.timestamp === timestamp);
          if (!msg) continue;

          const forwardedMessage = {
            role: 'user',
            senderName: targetChat.isGroup ? (targetChat.settings.myNickname || 'Êàë') : 'Êàë',
            content: msg.content,
            timestamp: Date.now() + sortedTimestamps.indexOf(timestamp),
          };

          if (msg.type) {
            forwardedMessage.type = msg.type;
            if (msg.type === 'voice_message') {
              forwardedMessage.content = msg.content;
            } else if (msg.type === 'ai_image' || msg.type === 'naiimag') {
              forwardedMessage.content = msg.content;
            } else if (msg.type === 'transfer') {
              forwardedMessage.amount = msg.amount;
              forwardedMessage.note = msg.note;
            } else if (msg.type === 'share_link') {
              forwardedMessage.title = msg.title;
              forwardedMessage.description = msg.description;
              forwardedMessage.source_name = msg.source_name;
              forwardedMessage.content = msg.content;
            } else if (msg.type === 'red_packet') {
              forwardedMessage.totalAmount = msg.totalAmount;
              forwardedMessage.count = msg.count;
              forwardedMessage.message = msg.message;
              forwardedMessage.claimed = [];
            } else if (msg.type === 'location_share') {
              forwardedMessage.latitude = msg.latitude;
              forwardedMessage.longitude = msg.longitude;
              forwardedMessage.locationName = msg.locationName;
            }
          }

          targetChat.history.push(forwardedMessage);
        }

        await db.chats.put(targetChat);
      }

      document.getElementById('forward-target-modal').classList.remove('visible');
      exitSelectionMode();
      await showCustomAlert("ËΩ¨ÂèëÊàêÂäü", `Ê∂àÊÅØÂ∑≤ÊàêÂäüËΩ¨ÂèëÂà∞ ${selectedTargetIds.length} ‰∏™‰ºöËØù‰∏≠„ÄÇ`);
      renderChatList();
    });

    document.getElementById('cancel-forward-target-btn').addEventListener('click', () => {
      document.getElementById('forward-target-modal').classList.remove('visible');
    });


    document.getElementById('chat-messages').addEventListener('click', (e) => {



      const shareCard = e.target.closest('.link-share-card[data-timestamp]');
      if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(shareCard.dataset.timestamp);
        openSharedHistoryViewer(timestamp);
      }
    });


    document.getElementById('close-shared-history-viewer-btn').addEventListener('click', () => {
      document.getElementById('shared-history-viewer-modal').classList.remove('visible');
    });


    async function openSharedHistoryViewer(timestamp) {
      const chat = state.chats[state.activeChatId];
      if (!chat) return;

      const message = chat.history.find(m => m.timestamp === timestamp);



      if (!message) {
        console.error("Êó†Ê≥ïÊâæÂà∞ÂàÜ‰∫´ËÆ∞ÂΩï:", timestamp);
        await showCustomAlert("Êü•ÁúãÂ§±Ë¥•", "Êó†Ê≥ïÊâæÂà∞ÂØπÂ∫îÁöÑÂàÜ‰∫´ËÆ∞ÂΩïÊàñËÆ∞ÂΩïÂ∑≤ÊçüÂùè„ÄÇ");
        return;
      }


      if (message.type === 'share_link') {
        openBrowser(timestamp);
        return;
      }


      if (message.type === 'share_card') {
        if (!message.payload || !message.payload.sharedHistory) {
          console.error("ËÅäÂ§©ËÆ∞ÂΩïÂàÜ‰∫´Âç°ÁâáÊï∞ÊçÆÊçüÂùè:", message);
          await showCustomAlert("Êü•ÁúãÂ§±Ë¥•", "ÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÊçüÂùè„ÄÇ");
          return;
        }

      } else {

        console.error("Êú™Áü•ÁöÑÂàÜ‰∫´Âç°ÁâáÁ±ªÂûã:", message.type);
        await showCustomAlert("Êü•ÁúãÂ§±Ë¥•", "‰∏çÊîØÊåÅÁöÑÂàÜ‰∫´Á±ªÂûã„ÄÇ");
        return;
      }

      const viewerModal = document.getElementById('shared-history-viewer-modal');
      const viewerTitle = document.getElementById('shared-history-viewer-title');
      const viewerContent = document.getElementById('shared-history-viewer-content');

      viewerTitle.textContent = message.payload.title;
      viewerContent.innerHTML = '';

      const fragment = document.createDocumentFragment();
      const sourceChat = Object.values(state.chats).find(c => c.name === message.payload.sourceChatName) || chat;

      for (const sharedMsg of message.payload.sharedHistory) {
        const bubbleEl = await createMessageElement(sharedMsg, sourceChat);
        if (bubbleEl) {
          fragment.appendChild(bubbleEl);
        }
      }

      viewerContent.appendChild(fragment);
      viewerModal.classList.add('visible');
    }

    audioPlayer.addEventListener('timeupdate', updateMusicProgressBar);

    audioPlayer.addEventListener('error', (e) => {
      console.error('[Èü≥‰πêÊí≠Êîæ] Èü≥È¢ëÂä†ËΩΩ/Êí≠ÊîæÈîôËØØ:', e);
      if (audioPlayer.error) {
        console.error('[Èü≥‰πêÊí≠Êîæ] ÈîôËØØËØ¶ÊÉÖ:', {
          code: audioPlayer.error.code,
          message: audioPlayer.error.message,
          src: audioPlayer.src
        });

        // ÊòæÁ§∫ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
        let errorMsg = 'Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•: ';
        switch (audioPlayer.error.code) {
          case 1: errorMsg += 'Èü≥È¢ëÂä†ËΩΩË¢´‰∏≠Ê≠¢'; break;
          case 2: errorMsg += 'ÁΩëÁªúÈîôËØØ'; break;
          case 3: errorMsg += 'Èü≥È¢ëËß£Á†ÅÂ§±Ë¥•'; break;
          case 4: errorMsg += 'Èü≥È¢ëÊ†ºÂºè‰∏çÊîØÊåÅÊàñURLÊó†Êïà'; break;
          default: errorMsg += 'Êú™Áü•ÈîôËØØ';
        }
        console.warn(errorMsg);
      }
    });

    audioPlayer.addEventListener('pause', () => {
      if (musicState.isActive) {
        musicState.isPlaying = false;
        phoneScreenForIsland.classList.remove('dynamic-island-active');
        // --- Êñ∞Â¢ûÔºöÊöÇÂÅúÊó∂ÂÅúÊ≠¢ÊóãËΩ¨ ---
        document.getElementById('vinyl-view').classList.remove('spinning');
        updatePlayerUI();
      }
    });

    audioPlayer.addEventListener('play', () => {
      if (musicState.isActive) {
        musicState.isPlaying = true;
        // --- Êñ∞Â¢ûÔºöÊí≠ÊîæÊó∂ÂºÄÂßãÊóãËΩ¨ ---
        document.getElementById('vinyl-view').classList.add('spinning');
        updatePlayerUI();
      }
    });

    // Ê∑ªÂä†Èü≥È¢ëÂä†ËΩΩÈîôËØØÂ§ÑÁêÜ
    audioPlayer.addEventListener('error', (e) => {
      console.error('[Èü≥È¢ëÊí≠ÊîæÈîôËØØ]', e);
      if (audioPlayer.error) {
        const errorMessages = {
          1: 'MEDIA_ERR_ABORTED: Èü≥È¢ëÂä†ËΩΩË¢´‰∏≠Ê≠¢',
          2: 'MEDIA_ERR_NETWORK: ÁΩëÁªúÈîôËØØÔºåÊó†Ê≥ïÂä†ËΩΩÈü≥È¢ë',
          3: 'MEDIA_ERR_DECODE: Èü≥È¢ëËß£Á†ÅÂ§±Ë¥•',
          4: 'MEDIA_ERR_SRC_NOT_SUPPORTED: ‰∏çÊîØÊåÅÁöÑÈü≥È¢ëÊ†ºÂºèÊàñÊó†Ê≥ïÊâæÂà∞Èü≥È¢ëÊ∫ê'
        };
        const errorMsg = errorMessages[audioPlayer.error.code] || 'Êú™Áü•ÈîôËØØ';
        console.error(`[Èü≥È¢ëÈîôËØØ] ${errorMsg}`, audioPlayer.src);

        // Â¶ÇÊûúÊòØÁΩëÁªúÈîôËØØÊàñÊ∫ê‰∏çÊîØÊåÅÔºåÂ∞ùËØïÈáçÊñ∞Âä†ËΩΩ
        if (audioPlayer.error.code === 2 || audioPlayer.error.code === 4) {
          console.log('[Èü≥È¢ëÊí≠Êîæ] Â∞ùËØïÈáçÊñ∞Âä†ËΩΩÈü≥È¢ë...');
          setTimeout(() => {
            if (musicState.isActive && musicState.currentIndex >= 0) {
              const currentTrack = musicState.playlist[musicState.currentIndex];
              if (currentTrack) {
                console.log(`[Èü≥È¢ëÊí≠Êîæ] ÈáçÊñ∞Âä†ËΩΩ: ${currentTrack.name}`);
                audioPlayer.load();
              }
            }
          }, 1000);
        }
      }
    });

    // Ê∑ªÂä†Èü≥È¢ëÂä†ËΩΩÊàêÂäüÁõëÂê¨
    audioPlayer.addEventListener('loadeddata', () => {
      console.log('[Èü≥È¢ëÊí≠Êîæ] Èü≥È¢ëÊï∞ÊçÆÂä†ËΩΩÊàêÂäü');
    });

    // Ê∑ªÂä†ÂèØ‰ª•Êí≠ÊîæÁõëÂê¨
    audioPlayer.addEventListener('canplay', () => {
      console.log('[Èü≥È¢ëÊí≠Êîæ] Èü≥È¢ëÂèØ‰ª•ÂºÄÂßãÊí≠Êîæ');
    });



    document.getElementById('playlist-body').addEventListener('click', async (e) => {
      const target = e.target;


      const albumArtBtn = target.closest('.album-art-btn');
      if (albumArtBtn) {
        const index = parseInt(albumArtBtn.dataset.index);
        if (!isNaN(index)) {

          await handleChangeAlbumArt(index);
        }
        return;
      }

      const lyricsBtn = target.closest('.lyrics-btn');
      if (lyricsBtn) {
        const index = parseInt(lyricsBtn.dataset.index);
        if (isNaN(index)) return;



        await handleManualLrcImport(index);

        return;
      }


      const deleteBtn = target.closest('.delete-track-btn');
      if (deleteBtn) {
        const index = parseInt(deleteBtn.dataset.index);
        if (isNaN(index)) return;
        const track = musicState.playlist[index];
        const confirmed = await showCustomConfirm('Âà†Èô§Ê≠åÊõ≤', `Á°ÆÂÆöË¶Å‰ªéÊí≠ÊîæÂàóË°®‰∏≠Âà†Èô§„Ää${track.name}„ÄãÂêóÔºü`);
        if (confirmed) {
          deleteTrack(index);
        }
        return;
      }


      const itemInfo = target.closest('.playlist-item-info');
      if (itemInfo) {
        const item = itemInfo.closest('.playlist-item');
        const index = Array.from(item.parentElement.children).indexOf(item);
        if (index > -1) {
          playSong(index);
        }
      }
    });


    document.querySelector('.progress-bar').addEventListener('click', (e) => {
      if (!audioPlayer.duration) return;
      const progressBar = e.currentTarget;
      const barWidth = progressBar.clientWidth;
      const clickX = e.offsetX;
      audioPlayer.currentTime = (clickX / barWidth) * audioPlayer.duration;
    });




    document.getElementById('chat-messages').addEventListener('click', (e) => {

      // „ÄêÊñ∞Â¢û/‰øÆÊîπ„ÄëÁÇπÂáªÈÇÆ‰ª∂Âç°ÁâáÊü•ÁúãËØ¶ÊÉÖ (Âõ∫ÂÆöÂ§ßÂ∞èÂºπÁ™óÁâà)
      const emailCard = e.target.closest('.email-share-card');
      if (emailCard) {
        const jsonStr = decodeURIComponent(emailCard.dataset.emailJson);
        try {
          const data = JSON.parse(jsonStr);

          // 1. Ëé∑ÂèñÊ®°ÊÄÅÊ°ÜÁõ∏ÂÖ≥ÂÖÉÁ¥†
          const overlay = document.getElementById('custom-modal-overlay');
          const modal = document.getElementById('custom-modal');
          const titleEl = document.getElementById('custom-modal-title');
          const bodyEl = document.getElementById('custom-modal-body');
          const footerEl = document.querySelector('#custom-modal .custom-modal-footer');

          // 2. „ÄêÊ†∏ÂøÉÊ≠•È™§„Äë‰∏¥Êó∂‰øÆÊîπÊ®°ÊÄÅÊ°ÜÊ†∑Âºè (Âõ∫ÂÆöÂÆΩÈ´ò)
          modal.style.width = '320px';        // ÂÆΩÂ∫¶Âä†ÂÆΩ
          modal.style.height = '500px';       // È´òÂ∫¶Âõ∫ÂÆö
          modal.style.maxHeight = '80vh';     // Èò≤Ê≠¢Ë∂ÖÂá∫Â±èÂπï

          // 3. Ë∞ÉÊï¥ Body Ê†∑Âºè‰ª•ÊîØÊåÅÂÜÖÈÉ®ÊªöÂä®
          bodyEl.style.flex = '1';            // ÊíëÊª°Ââ©‰ΩôÁ©∫Èó¥
          bodyEl.style.overflowY = 'auto';    // ÂÖÅËÆ∏ÂûÇÁõ¥ÊªöÂä®
          bodyEl.style.padding = '0';         // Ê∏ÖÈô§ÈªòËÆ§ÂÜÖËæπË∑ùÔºåÁî±ÂÜÖÈÉ®ÂÆπÂô®ÊéßÂà∂

          // 4. ËÆæÁΩÆÊ†áÈ¢ò
          titleEl.textContent = "ÈÇÆ‰ª∂ËØ¶ÊÉÖ";

          // 5. ÊûÑÈÄ†ËØ¶ÊÉÖ HTML (‰ºòÂåñÂ∏ÉÂ±Ä)
          const detailHtml = `
                  <div style="padding: 20px; min-height: 100%; box-sizing: border-box; text-align: left;"> <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                          <div style="font-weight: 700; font-size: 18px; color: #111; line-height: 1.4; margin-bottom: 8px; word-break: break-word;">
                              ${escapeHTML(data.subject)}
                          </div>
                          <div style="display: flex; justify-content: space-between; align-items: center; color: #8a8a8a; font-size: 13px;">
                              <span><span style="color:#666;">Âèë‰ª∂‰∫∫:</span> ${escapeHTML(data.sender)}</span>
                              <span>${data.date.split(' ')[0]}</span>
                          </div>
                      </div>
                      <div style="white-space: pre-wrap; color: #333; font-size: 15px; line-height: 1.8; font-family: -apple-system, sans-serif; letter-spacing: 0.5px;">${escapeHTML(data.fullContent)}</div>
                  </div>
              `;
          bodyEl.innerHTML = detailHtml;

          // 6. ÈáçÂÜôÂ∫ïÈÉ®ÊåâÈíÆ (‰ªÖÊòæÁ§∫‰∏Ä‰∏™ÂÖ≥Èó≠ÊåâÈíÆ)
          footerEl.innerHTML = ''; // Ê∏ÖÁ©∫ÂéüÊúâÊåâÈíÆ
          const closeBtn = document.createElement('button');
          closeBtn.textContent = 'ÂÖ≥Èó≠';
          closeBtn.style.cssText = 'width: 100%; border: none; background: transparent; color: var(--accent-color); font-weight: 600; padding: 15px; font-size: 16px; cursor: pointer;';

          // 7. ÁªëÂÆöÂÖ≥Èó≠‰∫ã‰ª∂ (ÂÖ≥ÈîÆÔºöÂÖ≥Èó≠Êó∂ÂøÖÈ°ªËøòÂéüÊ†∑ÂºèÔºÅ)
          closeBtn.onclick = () => {
            overlay.classList.remove('visible');

            // Âª∂ËøüËøòÂéüÊ†∑ÂºèÔºåÈò≤Ê≠¢ËßÜËßâË∑≥Âä®
            setTimeout(() => {
              modal.style.width = '';       // ËøòÂéüÂÆΩÂ∫¶
              modal.style.height = '';      // ËøòÂéüÈ´òÂ∫¶
              modal.style.maxHeight = '';
              bodyEl.style.flex = '';
              bodyEl.style.overflowY = '';
              bodyEl.style.padding = '';
            }, 300);
          };
          footerEl.appendChild(closeBtn);

          // 8. ÊòæÁ§∫ÂºπÁ™ó
          overlay.classList.add('visible');

        } catch (err) {
          console.error("Ëß£ÊûêÈÇÆ‰ª∂Êï∞ÊçÆÂ§±Ë¥•", err);
        }
        return; // ÈòªÊ≠¢ÂêéÁª≠ÈÄªËæë
      }
      const redditCard = e.target.closest('.reddit-share-card');
      if (redditCard) {
        const bubble = redditCard.closest('.message-bubble');
        if (bubble) {
          const timestamp = parseInt(bubble.dataset.timestamp);
          const chat = state.chats[state.activeChatId];
          // Âú®ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÊâæÂà∞ËøôÊù°Ê∂àÊÅØ
          const msg = chat.history.find(m => m.timestamp === timestamp);

          if (msg && msg.type === 'reddit_share' && msg.redditData) {
            // Ë∞ÉÁî®‰Ω†ÂÜôÂ•ΩÁöÑËØ¶ÊÉÖÈ°µÂáΩÊï∞
            openRedditDetail(msg.redditData);
          }
        }
        return;
      }
      const placeholder = e.target.closest('.recalled-message-placeholder');
      if (placeholder) {
        const chat = state.chats[state.activeChatId];
        const wrapper = placeholder.closest('.message-wrapper');
        if (chat && wrapper) {
          const timestamp = parseInt(wrapper.dataset.timestamp);
          const recalledMsg = chat.history.find(m => m.timestamp === timestamp);

          if (recalledMsg && recalledMsg.recalledData) {
            let originalContentText = '';
            const recalled = recalledMsg.recalledData;


            switch (recalled.originalType) {
              case 'text':
                originalContentText = `ÂéüÊñá: "${recalled.originalContent}"`;
                break;
              case 'user_photo':
              case 'ai_image':
              case 'text_image':
                originalContentText = `[ÂõæÁâá/ÊñáÂ≠óÂõæ] ÊèèËø∞: "${recalled.originalContent}"`;
                break;
              case 'voice_message':
                originalContentText = `[ËØ≠Èü≥] ÂÜÖÂÆπ: "${recalled.originalContent}"`;
                break;
              case 'sticker':

                originalContentText = `[Ë°®ÊÉÖ] Âê´‰πâ: "${recalled.originalMeaning || '(Êó†)'}" \n URL: ${recalled.originalContent}`;
                break;
              case 'transfer':
                originalContentText = `‰∏ÄÊù°[ËΩ¨Ë¥¶]Ê∂àÊÅØÂ∑≤Ë¢´Êí§Âõû„ÄÇ`;
                break;
              default:

                originalContentText = `Êí§Âõû‰∫Ü‰∏ÄÊù°[${recalled.originalType}]Á±ªÂûãÁöÑÊ∂àÊÅØ„ÄÇ\nÂÜÖÂÆπ: ${JSON.stringify(recalled.originalContent)}`;
                break;
            }


            showCustomAlert('Â∑≤Êí§ÂõûÁöÑÊ∂àÊÅØ', originalContentText);
          }
        }
      }
    });




    document.getElementById('manage-world-book-categories-btn').addEventListener('click', openCategoryManager);
    document.getElementById('close-category-manager-btn').addEventListener('click', () => {
      document.getElementById('world-book-category-manager-modal').classList.remove('visible');
      renderWorldBookScreen();
    });
    document.getElementById('add-new-category-btn').addEventListener('click', addNewCategory);
    document.getElementById('existing-categories-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-group-btn')) {
        const categoryId = parseInt(e.target.dataset.id);
        deleteCategory(categoryId);
      }
    });

    document.getElementById('repost-cancel-btn').addEventListener('click', hideRepostModal);
    document.getElementById('repost-confirm-btn').addEventListener('click', handleConfirmRepost);





    document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);

    document.getElementById('forward-message-btn').addEventListener('click', () => {
      if (activeMessageTimestamp) {
        hideMessageActions();
        enterSelectionMode(activeMessageTimestamp);
      }
    });

    document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);










    document.getElementById('qzone-posts-list').addEventListener('input', (e) => {
      if (!e.target.matches('.comment-input')) return;

      const commentInput = e.target;
      const postContainer = commentInput.closest('.qzone-post-container');
      if (!postContainer) return;

      const popup = postContainer.querySelector('.at-mention-popup');
      const value = commentInput.value;
      const atMatch = value.match(/@([\p{L}\w]*)$/u);

      if (atMatch) {
        const namesToMention = new Set();
        const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
        if (authorNickname) namesToMention.add(authorNickname);
        postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
          namesToMention.add(nameEl.textContent.replace(':', ''));
        });
        namesToMention.delete(state.qzoneSettings.nickname);

        popup.innerHTML = '';
        if (namesToMention.size > 0) {
          const searchTerm = atMatch[1];
          namesToMention.forEach(name => {
            if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
              const item = document.createElement('div');
              item.className = 'at-mention-item';
              item.textContent = name;
              item.addEventListener('mousedown', (evt) => {
                evt.preventDefault();
                const newText = value.substring(0, atMatch.index) + `@${name} `;
                commentInput.value = newText;
                popup.style.display = 'none';
                commentInput.focus();
              });
              popup.appendChild(item);
            }
          });
          popup.style.display = popup.children.length > 0 ? 'block' : 'none';
        } else {
          popup.style.display = 'none';
        }
      } else {
        popup.style.display = 'none';
      }
    });

    document.getElementById('qzone-posts-list').addEventListener('focusout', (e) => {
      if (e.target.matches('.comment-input')) {
        const postContainer = e.target.closest('.qzone-post-container');
        if (postContainer) {
          const popup = postContainer.querySelector('.at-mention-popup');
          if (popup) {
            setTimeout(() => {
              popup.style.display = 'none';
            }, 200);
          }
        }
      }
    });





    const chatInputForMention = document.getElementById('chat-input');
    const chatMentionPopup = document.getElementById('chat-at-mention-popup');

    chatInputForMention.addEventListener('input', () => {

      if (!state.activeChatId) {
        chatMentionPopup.style.display = 'none';
        return;
      }

      const chat = state.chats[state.activeChatId];
      const value = chatInputForMention.value;
      const atMatch = value.match(/@([\p{L}\w]*)$/u);

      if (atMatch) {
        const searchTerm = atMatch[1];

        // Êî∂ÈõÜÊâÄÊúâÂèØ‰ª•@ÁöÑÂØπË±°ÔºàÁæ§ÊàêÂëòÔºâ
        let namesToMention = [];

        // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÊ∑ªÂä†Áæ§ÊàêÂëò
        if (chat.isGroup) {
          const myNickname = chat.settings.myNickname || 'Êàë';
          const memberNames = chat.members
            .map(member => ({ name: member.groupNickname, type: 'member' }))
            .filter(item => item.name !== myNickname);
          namesToMention = namesToMention.concat(memberNames);
        }

        chatMentionPopup.innerHTML = '';

        if (namesToMention.length > 0) {
          // ËøáÊª§ÂåπÈÖçÁöÑÂêçÂ≠ó
          const filteredNames = namesToMention.filter(item =>
            item.name.toLowerCase().includes(searchTerm.toLowerCase())
          );

          filteredNames.forEach(item => {
            const menuItem = document.createElement('div');
            menuItem.className = 'at-mention-item';
            menuItem.textContent = item.name;

            menuItem.addEventListener('mousedown', (e) => {
              e.preventDefault();
              const newText = value.substring(0, atMatch.index) + `@${item.name} `;
              chatInputForMention.value = newText;
              chatMentionPopup.style.display = 'none';
              chatInputForMention.focus();
            });
            chatMentionPopup.appendChild(menuItem);
          });

          chatMentionPopup.style.display = chatMentionPopup.children.length > 0 ? 'block' : 'none';
        } else {
          chatMentionPopup.style.display = 'none';
        }
      } else {
        chatMentionPopup.style.display = 'none';
      }
    });


    chatInputForMention.addEventListener('blur', () => {
      setTimeout(() => {
        chatMentionPopup.style.display = 'none';
      }, 200);
    });


    document.getElementById('publish-to-announcement-btn').addEventListener('click', publishToAnnouncementBoard);
    document.getElementById('show-announcement-board-btn').addEventListener('click', showAnnouncementBoard);
    document.getElementById('close-announcement-board-btn').addEventListener('click', () => {
      document.getElementById('announcement-board-modal').classList.remove('visible');
    });


    document.getElementById('announcement-board-content').addEventListener('click', (e) => {
      if (e.target.classList.contains('announcement-item-actions')) {
        const annoId = e.target.dataset.annoId;
        if (annoId) {
          showAnnouncementActions(annoId);
        }
      }
    });

    document.getElementById('announcement-action-pin').addEventListener('click', handlePinAnnouncement);
    document.getElementById('announcement-action-delete').addEventListener('click', handleDeleteAnnouncement);
    document.getElementById('announcement-action-cancel').addEventListener('click', () => {
      document.getElementById('announcement-actions-modal').classList.remove('visible');
    });


    document.getElementById('reset-global-css-btn').addEventListener('click', () => {
      document.getElementById('global-css-input').value = '';


    });



    document.getElementById('open-memory-screen-btn').addEventListener('click', openLongTermMemoryScreen);


    document.getElementById('memory-screen-back-btn').addEventListener('click', () => {
      showScreen('chat-interface-screen');
    });


    document.getElementById('add-manual-memory-btn-header').addEventListener('click', handleAddManualMemory);


    document.getElementById('summarize-recent-btn-header').addEventListener('click', handleManualSummary);

    // ÁªìÊûÑÂåñËÆ∞ÂøÜ Tab ÂàáÊç¢
    document.getElementById('memory-tab-original').addEventListener('click', () => switchMemoryTab('original'));
    document.getElementById('memory-tab-structured').addEventListener('click', () => switchMemoryTab('structured'));

    document.getElementById('memory-list-container').addEventListener('click', (e) => {
      const editBtn = e.target.closest('.edit-memory-btn');
      if (editBtn) {
        handleEditMemory(editBtn.dataset.authorId, parseInt(editBtn.dataset.memoryTimestamp));
        return;
      }
      const deleteBtn = e.target.closest('.delete-memory-btn');
      if (deleteBtn) {
        handleDeleteMemory(deleteBtn.dataset.authorId, parseInt(deleteBtn.dataset.memoryTimestamp));
        return;
      }
    });


    document.getElementById('gomoku-btn').addEventListener('click', toggleGomokuBoard);
    document.getElementById('close-gomoku-btn').addEventListener('click', closeGomokuBoard);

    const gomokuCanvas = document.getElementById('gomoku-board');
    gomokuCanvas.addEventListener('mousemove', handleBoardHover);
    gomokuCanvas.addEventListener('mouseout', () => renderGomokuBoard(state.activeChatId));
    gomokuCanvas.addEventListener('click', handleBoardClick);


    document.getElementById('add-countdown-btn').addEventListener('click', () => {

      document.getElementById('countdown-title-input').value = '';
      document.getElementById('countdown-date-input').value = '';

      document.getElementById('create-countdown-modal').classList.add('visible');
    });


    document.getElementById('cancel-create-countdown-btn').addEventListener('click', () => {
      document.getElementById('create-countdown-modal').classList.remove('visible');
    });



    document.getElementById('edit-call-message-btn').addEventListener('click', openCallMessageEditor);
    document.getElementById('delete-call-message-btn').addEventListener('click', deleteCallMessage);
    document.getElementById('cancel-call-message-action-btn').addEventListener('click', hideCallMessageActions);


    document.getElementById('edit-last-response-btn').addEventListener('click', openAiResponseEditor);
    document.getElementById('cancel-ai-response-editor-btn').addEventListener('click', () => {
      document.getElementById('ai-response-editor-modal').classList.remove('visible');
    });
    document.getElementById('save-ai-response-editor-btn').addEventListener('click', saveEditedAiResponse);
    document.getElementById('add-ai-response-block-btn').addEventListener('click', () => {

      const container = document.getElementById('ai-response-editor-container');
      const newBlock = createAiResponseEditorBlock('{\n  "type": "text",\n  "content": "Âú®ËøôÈáåËæìÂÖ•Êñ∞Ê∂àÊÅØ..."\n}');
      container.appendChild(newBlock);
      newBlock.querySelector('textarea').focus();
    });


    document.getElementById('manage-my-avatar-library-btn').addEventListener('click', openMyAvatarLibraryModal);
    document.getElementById('close-my-avatar-library-btn').addEventListener('click', closeMyAvatarLibraryModal);
    document.getElementById('add-my-avatar-url-btn').addEventListener('click', addAvatarToMyLibraryFromURL);
    document.getElementById('add-my-avatar-upload-btn').addEventListener('click', () => {
      document.getElementById('my-avatar-upload-input').click();
    });
    document.getElementById('my-avatar-upload-input').addEventListener('change', handleLocalMyAvatarUpload);
    document.getElementById('add-my-avatar-batch-btn').addEventListener('click', async () => {
      const placeholderText = `ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÁ≤òË¥¥Ôºå‰∏ÄË°å‰∏Ä‰∏™Ôºö\n\nÁÑ¶Ëôë 2a9wte.jpeg\nÂ§ßÊÉäÂ§±Ëâ≤ or8qf4.png\nÊ≤°ÊúâÁÅµÊÑü njwujh.jpeg`;
      const pastedText = await showCustomPrompt('ÊâπÈáèÂØºÂÖ•Â§¥ÂÉè', placeholderText, '', 'textarea');
      if (pastedText && pastedText.trim()) {
        await handleBatchImportForMyAvatar(pastedText);
      }
    });


    document.getElementById('open-shopping-btn').addEventListener('click', openShoppingScreen);
    document.getElementById('shopping-back-btn').addEventListener('click', () => showScreen('chat-interface-screen'));
    document.getElementById('go-to-cart-btn').addEventListener('click', openCartScreen);
    document.getElementById('cart-back-btn').addEventListener('click', openShoppingScreen);
    document.getElementById('checkout-btn').addEventListener('click', handleCheckout);
    document.getElementById('close-receipt-btn').addEventListener('click', () => {
      document.getElementById('gift-receipt-modal').classList.remove('visible');
    });


    document.getElementById('manage-products-btn').addEventListener('click', () => {
      isProductManagementMode = !isProductManagementMode;
      const btn = document.getElementById('manage-products-btn');
      const actionBar = document.getElementById('shopping-action-bar');
      const gridEl = document.getElementById('product-grid');

      btn.style.color = isProductManagementMode ? 'var(--accent-color)' : 'var(--text-primary)';

      if (isProductManagementMode) {
        actionBar.style.display = 'flex';
        gridEl.style.paddingBottom = '80px';
      } else {
        actionBar.style.display = 'none';
        gridEl.style.paddingBottom = '';

        selectedProducts.clear();
        document.querySelectorAll('.product-item.selected').forEach(item => item.classList.remove('selected'));
        document.getElementById('delete-selected-products-btn').textContent = `Âà†Èô§ (0)`;
        document.getElementById('select-all-products-checkbox').checked = false;
      }


      renderShoppingProducts();
      updateDeleteCategoryButtonVisibility();
    });


    document.getElementById('add-new-product-btn').addEventListener('click', () => {
      if (isProductManagementMode) {
        openProductEditor(null);
      } else {
        alert("ËØ∑ÂÖàÁÇπÂáªÊâ≥ÊâãÂõæÊ†áËøõÂÖ•ÁÆ°ÁêÜÊ®°ÂºèÔºåÊâçËÉΩÊ∑ªÂä†Êñ∞ÂïÜÂìÅ„ÄÇ");
      }
    });



    document.getElementById('product-grid').addEventListener('click', async e => {
      const productItem = e.target.closest('.product-item');
      if (!productItem) return;
      const productId = parseInt(productItem.dataset.id);
      if (isNaN(productId)) return;


      if (isProductManagementMode) {

        if (e.target.classList.contains('edit-product-btn')) {
          openProductEditor(productId);
          return;
        }

        if (e.target.classList.contains('delete-product-btn')) {
          const product = await db.shoppingProducts.get(productId);
          if (!product) return;
          const confirmed = await showCustomConfirm('Âà†Èô§ÂïÜÂìÅ', `Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ÂïÜÂìÅ ‚Äú${product.name}‚Äù ÂêóÔºü`, {
            confirmButtonClass: 'btn-danger'
          });
          if (confirmed) {
            await db.shoppingProducts.delete(productId);
            await renderShoppingProducts();
            alert("ÂïÜÂìÅÂ∑≤Âà†Èô§„ÄÇ");
          }
          return;
        }


        productItem.classList.toggle('selected');
        if (selectedProducts.has(productId)) {
          selectedProducts.delete(productId);
        } else {
          selectedProducts.add(productId);
        }
        document.getElementById('delete-selected-products-btn').textContent = `Âà†Èô§ (${selectedProducts.size})`;
        return;
      }


      if (e.target.classList.contains('add-to-cart-btn')) {
        const product = await db.shoppingProducts.get(productId);
        if (product.variations && product.variations.length > 0) {
          openVariationSelector(productId);
        } else {
          await addToCart(productId);
          await showCustomAlert('ÊàêÂäü', 'Â∑≤ÊàêÂäüÂä†ÂÖ•Ë¥≠Áâ©ËΩ¶ÔºÅ');
        }
        return;
      }


      if (productItem.contains(e.target)) {
        console.log(`ÁÇπÂáª‰∫ÜÂïÜÂìÅÂç°Áâá: ${productId}`);
      }
    });



    document.getElementById('cart-items-list').addEventListener('click', e => {
      const target = e.target;
      if (target.classList.contains('decrease-qty-btn')) {
        updateCartItemQuantity(parseInt(target.dataset.id), -1);
      }
      if (target.classList.contains('increase-qty-btn')) {
        updateCartItemQuantity(parseInt(target.dataset.id), 1);
      }
      if (target.classList.contains('cart-item-checkbox')) {
        updateCartTotal();
      }
    });


    document.getElementById('clear-cart-btn').addEventListener('click', async () => {
      if (shoppingCart.length === 0) return;
      const confirmed = await showCustomConfirm('Ê∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶', 'Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶‰∏≠ÁöÑÊâÄÊúâÂïÜÂìÅÂêóÔºü');
      if (confirmed) {
        shoppingCart = [];
        updateCartCount();
        renderCartItems();
        saveShoppingCart(); // ‰øùÂ≠òË¥≠Áâ©ËΩ¶
      }
    });


    document.getElementById('select-all-cart-items').addEventListener('change', function (e) {
      document.querySelectorAll('.cart-item-checkbox').forEach(cb => {
        cb.checked = e.target.checked;
      });
      updateCartTotal();
    });


    document.getElementById('cancel-product-editor-btn').addEventListener('click', () => {
      document.getElementById('product-editor-modal').classList.remove('visible');
    });
    document.getElementById('save-product-btn').addEventListener('click', saveProduct);
    document.getElementById('product-image-input').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (re) => {
          document.getElementById('product-image-preview').src = re.target.result;
        };
        reader.readAsDataURL(file);
      }
    });


    document.getElementById('chat-messages').addEventListener('click', e => {
      const giftCard = e.target.closest('.gift-card');
      if (giftCard) {
        const bubble = giftCard.closest('.message-bubble');
        if (bubble) {
          showGiftReceipt(parseInt(bubble.dataset.timestamp));
        }
      }
    });


    document.getElementById('cancel-gift-recipient-btn').addEventListener('click', () => {
      document.getElementById('gift-recipient-modal').classList.remove('visible');
    });


    document.getElementById('confirm-gift-recipient-btn').addEventListener('click', async () => {

      const selectedRecipients = Array.from(document.querySelectorAll('#gift-recipient-list .contact-picker-item.selected'))
        .map(item => item.dataset.recipientName);

      if (selectedRecipients.length === 0) {
        alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰ΩçÊî∂Á§º‰∫∫„ÄÇ");
        return;
      }


      const selectedItems = shoppingCart.filter(item =>
        document.querySelector(`.cart-item-checkbox[data-id="${item.productId}"]:checked`)
      );


      await sendGiftMessage(selectedItems, selectedRecipients);


      document.getElementById('gift-recipient-modal').classList.remove('visible');
    });


    document.getElementById('gift-recipient-list').addEventListener('click', (e) => {
      const item = e.target.closest('.contact-picker-item');
      if (item) {
        item.classList.toggle('selected');
      }
    });

    document.getElementById('select-all-recipients').addEventListener('change', function (e) {
      const isChecked = e.target.checked;
      document.querySelectorAll('#gift-recipient-list .contact-picker-item').forEach(item => {
        item.classList.toggle('selected', isChecked);
      });
    });


    document.getElementById('regenerate-btn').addEventListener('click', handleRegenerateResponse);
    document.getElementById('regenerate-call-btn').addEventListener('click', handleRegenerateCallResponse);


    document.getElementById('propel-btn').addEventListener('click', handlePropelAction);


    // ========== ÊèêÁ§∫Èü≥È¢ÑËÆæÁÆ°ÁêÜÂäüËÉΩ ==========

    // Ê∑ªÂä†ÊèêÁ§∫Èü≥È¢ÑËÆæÊ†∑ÂºèÔºàÊîØÊåÅÊöóÈªëÊ®°ÂºèÔºâ
    const soundPresetStyle = document.createElement('style');
    soundPresetStyle.textContent = `
      /* ÊèêÁ§∫Èü≥È¢ÑËÆæÈ°π - ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
      #phone-screen.dark-mode .sound-preset-item {
        background: #1c1c1e !important;
        border-color: #38383a !important;
      }
      #phone-screen.dark-mode .sound-preset-name {
        color: #fff !important;
      }
      #phone-screen.dark-mode .sound-preset-item div[style*="color: #8e8e93"] {
        color: #8e8e93 !important;
      }
    `;
    document.head.appendChild(soundPresetStyle);

    // Âä†ËΩΩÊèêÁ§∫Èü≥È¢ÑËÆæ‰∏ãÊãâÊ°Ü
    function loadSoundPresetsDropdown(forceSelectedIndex = null) {
      const selectEl = document.getElementById('sound-preset-select');
      if (!selectEl) return;

      selectEl.innerHTML = '<option value="current">ÂΩìÂâçÈÖçÁΩÆ (Êú™‰øùÂ≠ò)</option>';

      const presets = state.globalSettings.soundPresets || [];
      presets.forEach((preset, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = preset.name;
        selectEl.appendChild(option);
      });

      // Â¶ÇÊûúÊåáÂÆö‰∫ÜË¶ÅÈÄâ‰∏≠ÁöÑÈ¢ÑËÆæÁ¥¢Âºï
      if (forceSelectedIndex !== null && forceSelectedIndex >= 0 && forceSelectedIndex < presets.length) {
        selectEl.value = forceSelectedIndex;
        return;
      }

      // Ëá™Âä®ÂåπÈÖçÂΩìÂâçÈÖçÁΩÆ
      const currentUrl = document.getElementById('notification-sound-url-input').value.trim();
      let matchingIndex = null;
      for (let i = 0; i < presets.length; i++) {
        if (presets[i].url === currentUrl) {
          matchingIndex = i;
          break;
        }
      }

      if (matchingIndex !== null) {
        selectEl.value = matchingIndex;
      } else {
        selectEl.value = 'current';
      }
    }

    // Â§ÑÁêÜÊèêÁ§∫Èü≥È¢ÑËÆæÈÄâÊã©ÂèòÂåñ
    function handleSoundPresetSelectionChange() {
      const selectEl = document.getElementById('sound-preset-select');
      const selectedValue = selectEl.value;

      if (selectedValue === 'current') {
        return;
      }

      const selectedIndex = parseInt(selectedValue);
      if (isNaN(selectedIndex)) {
        return;
      }

      const presets = state.globalSettings.soundPresets || [];
      if (selectedIndex < 0 || selectedIndex >= presets.length) return;

      const preset = presets[selectedIndex];
      // Áõ¥Êé•Â∫îÁî®È¢ÑËÆæ
      document.getElementById('notification-sound-url-input').value = preset.url || '';
      state.globalSettings.notificationSoundUrl = preset.url || '';
      saveState();

      // Âà∑Êñ∞‰∏ãÊãâÊ°ÜÔºåÁ°Æ‰øùÈÄâ‰∏≠Áä∂ÊÄÅ
      loadSoundPresetsDropdown(selectedIndex);
    }

    // ‰øùÂ≠òÊèêÁ§∫Èü≥È¢ÑËÆæ
    async function saveSoundPreset() {
      const url = document.getElementById('notification-sound-url-input').value.trim();

      // ËØ∑Ê±ÇËæìÂÖ•È¢ÑËÆæÂêçÁß∞
      const name = prompt('ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞Ôºö', `È¢ÑËÆæ ${(state.globalSettings.soundPresets || []).length + 1}`);
      if (!name || name.trim() === '') {
        return;
      }

      if (!state.globalSettings.soundPresets) {
        state.globalSettings.soundPresets = [];
      }

      // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçÈ¢ÑËÆæ
      const existingIndex = state.globalSettings.soundPresets.findIndex(p => p.name === name.trim());
      let savedIndex;

      if (existingIndex !== -1) {
        if (!confirm('Â∑≤Â≠òÂú®ÂêåÂêçÈ¢ÑËÆæÔºåÊòØÂê¶Ë¶ÜÁõñÔºü')) {
          return;
        }
        state.globalSettings.soundPresets[existingIndex] = {
          name: name.trim(),
          url: url
        };
        savedIndex = existingIndex;
      } else {
        state.globalSettings.soundPresets.push({
          name: name.trim(),
          url: url
        });
        savedIndex = state.globalSettings.soundPresets.length - 1;
      }

      // ‰øùÂ≠òÁä∂ÊÄÅÂà∞Êï∞ÊçÆÂ∫ì/localStorage
      if (typeof saveState === 'function') {
        await saveState();
      }

      // Âà∑Êñ∞‰∏ãÊãâÊ°ÜÂπ∂ÈÄâ‰∏≠Êñ∞‰øùÂ≠òÁöÑÈ¢ÑËÆæ
      loadSoundPresetsDropdown(savedIndex);
      alert('È¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ');
    }

    // Âà†Èô§ÊèêÁ§∫Èü≥È¢ÑËÆæÔºà‰ªé‰∏ãÊãâÊ°ÜÂà†Èô§ÈÄâ‰∏≠ÁöÑÈ¢ÑËÆæÔºâ
    async function deleteSoundPreset() {
      const selectEl = document.getElementById('sound-preset-select');
      const selectedValue = selectEl.value;

      if (selectedValue === 'current') {
        alert('ËØ∑ÂÖà‰ªé‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ„ÄÇ');
        return;
      }

      const selectedIndex = parseInt(selectedValue);
      if (isNaN(selectedIndex)) {
        return;
      }

      const presets = state.globalSettings.soundPresets || [];
      if (selectedIndex < 0 || selectedIndex >= presets.length) return;

      const preset = presets[selectedIndex];
      if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ"${preset.name}"ÂêóÔºü`)) {
        return;
      }

      state.globalSettings.soundPresets.splice(selectedIndex, 1);

      // ‰øùÂ≠òÁä∂ÊÄÅÂà∞Êï∞ÊçÆÂ∫ì/localStorage
      if (typeof saveState === 'function') {
        await saveState();
      }

      // Âà†Èô§ÂêéÂà∑Êñ∞‰∏ãÊãâÊ°ÜÂπ∂ÈáçÁΩÆ‰∏∫"ÂΩìÂâçÈÖçÁΩÆ"
      loadSoundPresetsDropdown();
      alert('È¢ÑËÆæÂ∑≤Âà†Èô§ÔºÅ');
    }

    // Ê∏≤ÊüìÊèêÁ§∫Èü≥È¢ÑËÆæÂàóË°®Ôºà‰øùÊåÅÂÖºÂÆπÔºå‰ΩÜÁé∞Âú®‰∏ªË¶ÅÁî®‰∏ãÊãâÊ°ÜÔºâ
    function renderSoundPresets() {
      loadSoundPresetsDropdown();
    }

    // ========== ÊèêÁ§∫Èü≥È¢ÑËÆæÁÆ°ÁêÜÂäüËÉΩÁªìÊùü ==========



    document.getElementById('test-sound-btn').addEventListener('click', () => {
      const player = document.getElementById('notification-sound-player');
      const url = document.getElementById('notification-sound-url-input').value.trim() || DEFAULT_NOTIFICATION_SOUND;
      player.src = url;
      // Â∫îÁî®Èü≥ÈáèËÆæÁΩÆ
      player.volume = parseInt(document.getElementById('notification-volume-slider').value) / 100;
      player.play().catch(e => alert('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•URLÊòØÂê¶Ê≠£Á°ÆÊàñÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅËØ•Ê†ºÂºè„ÄÇ'));
    });

    document.getElementById('reset-sound-btn').addEventListener('click', () => {
      document.getElementById('notification-sound-url-input').value = '';
      alert('Â∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÊèêÁ§∫Èü≥ÔºåÁÇπÂáª‚Äú‰øùÂ≠òÊâÄÊúâÂ§ñËßÇËÆæÁΩÆ‚ÄùÂêéÁîüÊïà„ÄÇ');
    });

    document.getElementById('home-screen').addEventListener('click', (e) => {
      const target = e.target;

      if (target.classList.contains('editable-text')) {
        handleEditText(target);
      }

      if (target.classList.contains('editable-image')) {
        handleEditImage(target);
      }
    });

    // ÊèêÁ§∫Èü≥È¢ÑËÆæÁõ∏ÂÖ≥‰∫ã‰ª∂ÁõëÂê¨Âô®
    document.getElementById('sound-preset-select').addEventListener('change', handleSoundPresetSelectionChange);
    document.getElementById('save-sound-preset-btn').addEventListener('click', saveSoundPreset);
    document.getElementById('delete-sound-preset-btn').addEventListener('click', deleteSoundPreset);

    // ÂΩìÁî®Êà∑ÊâãÂä®‰øÆÊîπÊèêÁ§∫Èü≥ URL Êó∂ÔºåÊõ¥Êñ∞‰∏ãÊãâÊ°Ü‰∏∫"ÂΩìÂâçÈÖçÁΩÆ"
    document.getElementById('notification-sound-url-input').addEventListener('input', () => {
      if (typeof loadSoundPresetsDropdown === 'function') {
        loadSoundPresetsDropdown();
      }
    });

    // Èü≥ÈáèÊªëÂä®Êù°‰∫ã‰ª∂ÁõëÂê¨Âô®
    document.getElementById('notification-volume-slider').addEventListener('input', (e) => {
      const volumePercent = parseInt(e.target.value);
      document.getElementById('notification-volume-label').textContent = volumePercent + '%';
      // ÂÆûÊó∂‰øùÂ≠òÈü≥ÈáèËÆæÁΩÆ
      state.globalSettings.notificationVolume = volumePercent / 100;
      saveState();
    });

    document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);

    document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
      document.getElementById('music-search-results-modal').classList.remove('visible');
    });


    document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);

    document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
      document.getElementById('music-search-results-modal').classList.remove('visible');
    });


    document.getElementById('select-all-music-search').addEventListener('change', function (e) {
      document.querySelectorAll('#search-results-list .music-search-checkbox').forEach(cb => {
        cb.checked = e.target.checked;
      });
    });


    document.getElementById('search-results-list').addEventListener('click', (e) => {
      const item = e.target.closest('.search-result-item');
      if (item) {
        const checkbox = item.querySelector('.music-search-checkbox');
        if (checkbox) {

          if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
          }
        }
      }
    });


    document.getElementById('add-selected-music-btn').addEventListener('click', async () => {
      const selectedItems = document.querySelectorAll('.music-search-checkbox:checked');
      if (selectedItems.length === 0) {
        alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊ∑ªÂä†ÁöÑÊ≠åÊõ≤„ÄÇ");
        return;
      }

      document.getElementById('music-search-results-modal').classList.remove('visible');
      await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÊâπÈáèÊ∑ªÂä† ${selectedItems.length} È¶ñÊ≠åÊõ≤...`);

      const songDataList = Array.from(selectedItems).map(cb => JSON.parse(cb.closest('.search-result-item').dataset.songJson));

      let successCount = 0;
      let failedNames = [];


      const songDetailPromises = songDataList.map(songData => getPlayableSongDetails(songData));
      const fullSongObjects = await Promise.all(songDetailPromises);

      fullSongObjects.forEach((songObject, index) => {
        if (songObject) {
          musicState.playlist.push(songObject);
          successCount++;
        } else {
          failedNames.push(songDataList[index].name);
        }
      });

      if (successCount > 0) {
        await saveGlobalPlaylist();
        updatePlaylistUI();
        if (musicState.currentIndex === -1) {
          musicState.currentIndex = musicState.playlist.length - successCount;
          updatePlayerUI();
        }
      }

      let resultMessage = `Ê∑ªÂä†ÂÆåÊàêÔºÅ\n\nÊàêÂäüÊ∑ªÂä† ${successCount} È¶ñÊ≠åÊõ≤„ÄÇ`;
      if (failedNames.length > 0) {
        resultMessage += `\n\n${failedNames.length} È¶ñÊ≠åÊõ≤Ëé∑ÂèñÂ§±Ë¥•:\n- ${failedNames.join('\n- ')}`;
      }
      await showCustomAlert("Êìç‰ΩúÁªìÊûú", resultMessage);
    });



    document.getElementById('music-visual-container').addEventListener('click', () => {
      document.getElementById('music-visual-container').classList.toggle('lyrics-active');
    });



    document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);
    document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
      document.getElementById('music-search-results-modal').classList.remove('visible');
    });

    document.getElementById('search-results-list').addEventListener('click', (e) => {
      const item = e.target.closest('.search-result-item');
      if (item && item.dataset.songJson) {
        const songData = JSON.parse(item.dataset.songJson);
        handleSearchResultClick(songData);
      }
    });



    document.getElementById('cleanup-songs-btn').addEventListener('click', cleanupInvalidSongs);
    document.getElementById('toggle-blur-btn').addEventListener('click', toggleBackgroundBlur);
    document.getElementById('toggle-fullscreen-btn').addEventListener('click', togglePlayerFullscreen);
    document.getElementById('show-avatars-btn').addEventListener('click', toggleMusicPlayerAvatars);

    // Ë¢´Ê∏ÖÁêÜÊ≠åÊõ≤Ê®°ÊÄÅÊ°Ü‰∫ã‰ª∂
    document.getElementById('select-all-cleaned-songs').addEventListener('change', (e) => {
      const checkboxes = document.querySelectorAll('.cleaned-song-checkbox');
      checkboxes.forEach(cb => cb.checked = e.target.checked);
    });
    document.getElementById('close-cleaned-songs-btn').addEventListener('click', () => {
      document.getElementById('cleaned-songs-modal').classList.remove('visible');
    });
    document.getElementById('research-selected-songs-btn').addEventListener('click', handleResearchSelectedSongs);


    document.getElementById('status-bar-toggle-switch').addEventListener('change', () => {

      state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;
      applyStatusBarVisibility();
    });

    document.getElementById('qzone-more-actions-btn').addEventListener('click', openClearPostsSelectorModal);


    document.getElementById('cancel-clear-posts-btn').addEventListener('click', () => {
      document.getElementById('clear-posts-modal').classList.remove('visible');
    });
    document.getElementById('confirm-clear-posts-btn').addEventListener('click', handleConfirmClearPosts);


    document.getElementById('clear-posts-list').addEventListener('click', (e) => {
      const item = e.target.closest('.clear-posts-item');
      if (item) {
        item.classList.toggle('selected');
      }
    });

    document.getElementById('global-bg-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        const dataUrl = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });

        // 1. Á´ãÂç≥‰øùÂ≠òÂíåÊòæÁ§∫
        state.globalSettings.globalChatBackground = dataUrl;
        renderWallpaperScreen();
        await showCustomAlert("ÊàêÂäü", "ÂÖ®Â±ÄËÅäÂ§©ËÉåÊôØÂ∑≤Êõ¥Êñ∞ÔºÅ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä... (‰øùÂ≠òËÆæÁΩÆÂêéÁîüÊïà)");

        // 2. ÂêØÂä®ÈùôÈªò‰∏ä‰º†
        (async () => {
          await silentlyUpdateDbUrl(
            db.globalSettings,
            'main',
            'globalChatBackground',
            dataUrl
          );
        })();
      }
      event.target.value = null;
    });

    // ÈáçÁΩÆÂÖ®Â±ÄËÅäÂ§©ËÉåÊôØ
    document.getElementById('reset-global-bg-btn').addEventListener('click', async () => {
      const confirmed = await showCustomConfirm("ÈáçÁΩÆÁ°ÆËÆ§", "Á°ÆÂÆöË¶ÅÈáçÁΩÆËÅäÂ§©ËÉåÊôØ‰∏∫ÈªòËÆ§ÂêóÔºü");
      if (confirmed) {
        state.globalSettings.globalChatBackground = '';
        renderWallpaperScreen();
        await showCustomAlert("Â∑≤ÈáçÁΩÆ", "ËÅäÂ§©ËÉåÊôØÂ∑≤ÊÅ¢Â§ç‰∏∫ÈªòËÆ§ÔºàÁôΩËâ≤ÔºâÔºÅ");
      }
    });


    document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {

      if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
      }



      state.globalSettings.globalCss = document.getElementById('global-css-input').value.trim();
      state.globalSettings.notificationSoundUrl = document.getElementById('notification-sound-url-input').value.trim();
      state.globalSettings.notificationVolume = parseInt(document.getElementById('notification-volume-slider').value) / 100;
      state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;
      state.globalSettings.showSeconds = document.getElementById('global-show-seconds-switch').checked;
      state.globalSettings.lockScreenEnabled = document.getElementById('lock-screen-toggle').checked;
      state.globalSettings.lockScreenPassword = document.getElementById('lock-screen-password-input').value.trim();

      const lockPreview = document.getElementById('lock-wallpaper-preview');
      if (lockPreview.dataset.tempUrl) {
        state.globalSettings.lockScreenWallpaper = lockPreview.dataset.tempUrl;
      }

      await db.globalSettings.put(state.globalSettings);


      applyGlobalWallpaper();
      newWallpaperBase64 = null;
      applyAppIcons();
      applyCPhoneAppIcons();
      applyMyPhoneAppIconsGlobal();
      applyGlobalCss(state.globalSettings.globalCss);
      applyStatusBarVisibility();
      initLockScreen();
      alert('Â§ñËßÇËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ');
      showScreen('home-screen');
    });


    document.getElementById('upload-global-bg-url-btn').addEventListener('click', async () => {

      const url = await showCustomPrompt("ÁΩëÁªúÂõæÁâá", "ËØ∑ËæìÂÖ•ËÉåÊôØÂõæÁâáÁöÑURL", "", "url");


      if (url && url.trim()) {

        state.globalSettings.globalChatBackground = url.trim();


        renderWallpaperScreen();
      } else if (url !== null) {

        alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURL„ÄÇ");
      }
    });

    document.getElementById('upload-ephone-bg-url-btn').addEventListener('click', async () => {
      const url = await showCustomPrompt("ÁΩëÁªúÂõæÁâá (EPhone)", "ËØ∑ËæìÂÖ•EPhone‰∏ªÂ±èÂπïÁöÑËÉåÊôØÂõæÁâáURL", "", "url");
      if (url && url.trim()) {

        newWallpaperBase64 = url.trim();

        renderWallpaperScreen();
      } else if (url !== null) {
        alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURL„ÄÇ");
      }
    });


    document.getElementById('upload-cphone-bg-url-btn').addEventListener('click', async () => {
      const url = await showCustomPrompt("ÁΩëÁªúÂõæÁâá (CPhone)", "ËØ∑ËæìÂÖ•CPhoneÁöÑËÉåÊôØÂõæÁâáURL", "", "url");
      if (url && url.trim()) {

        state.globalSettings.cphoneWallpaper = url.trim();

        renderWallpaperScreen();
      } else if (url !== null) {
        alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURL„ÄÇ");
      }
    });


    document.getElementById('upload-myphone-bg-url-btn').addEventListener('click', async () => {
      const url = await showCustomPrompt("ÁΩëÁªúÂõæÁâá (MYphone)", "ËØ∑ËæìÂÖ•MYphoneÁöÑËÉåÊôØÂõæÁâáURL", "", "url");
      if (url && url.trim()) {

        state.globalSettings.myphoneWallpaper = url.trim();

        renderWallpaperScreen();
        applyMyPhoneWallpaper();
      } else if (url !== null) {
        alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURL„ÄÇ");
      }
    });



    // ÈáçÁΩÆ‰∏ªÂ±èÂπïÂ£ÅÁ∫∏
    document.getElementById('reset-ephone-bg-btn').addEventListener('click', async () => {
      const confirmed = await showCustomConfirm("ÈáçÁΩÆÁ°ÆËÆ§", "Á°ÆÂÆöË¶ÅÈáçÁΩÆ‰∏ªÂ±èÂπïÂ£ÅÁ∫∏‰∏∫ÈªòËÆ§ÂêóÔºü");
      if (confirmed) {
        newWallpaperBase64 = null;
        state.globalSettings.wallpaper = '';
        renderWallpaperScreen();
        await showCustomAlert("Â∑≤ÈáçÁΩÆ", "‰∏ªÂ±èÂπïÂ£ÅÁ∫∏Â∑≤ÊÅ¢Â§ç‰∏∫ÈªòËÆ§ÔºàÁôΩËâ≤ÔºâÔºÅ");
      }
    });

    // ÈáçÁΩÆCPhoneÂ£ÅÁ∫∏
    document.getElementById('reset-cphone-bg-btn').addEventListener('click', async () => {
      const confirmed = await showCustomConfirm("ÈáçÁΩÆÁ°ÆËÆ§", "Á°ÆÂÆöË¶ÅÈáçÁΩÆCPhoneÂ£ÅÁ∫∏‰∏∫ÈªòËÆ§ÂêóÔºü");
      if (confirmed) {
        state.globalSettings.cphoneWallpaper = '';
        renderWallpaperScreen();
        await showCustomAlert("Â∑≤ÈáçÁΩÆ", "CPhoneÂ£ÅÁ∫∏Â∑≤ÊÅ¢Â§ç‰∏∫ÈªòËÆ§ÔºàÁôΩËâ≤ÔºâÔºÅ");
      }
    });

    // ÈáçÁΩÆMYphoneÂ£ÅÁ∫∏
    document.getElementById('reset-myphone-bg-btn').addEventListener('click', async () => {
      const confirmed = await showCustomConfirm("ÈáçÁΩÆÁ°ÆËÆ§", "Á°ÆÂÆöË¶ÅÈáçÁΩÆMYphoneÂ£ÅÁ∫∏‰∏∫ÈªòËÆ§ÂêóÔºü");
      if (confirmed) {
        state.globalSettings.myphoneWallpaper = '';
        renderWallpaperScreen();
        applyMyPhoneWallpaper();
        await showCustomAlert("Â∑≤ÈáçÁΩÆ", "MYphoneÂ£ÅÁ∫∏Â∑≤ÊÅ¢Â§ç‰∏∫ÈªòËÆ§ÔºàÁôΩËâ≤ÔºâÔºÅ");
      }
    });


    document.getElementById('css-preset-select').addEventListener('change', handleCssPresetSelectionChange);
    document.getElementById('save-css-preset-btn').addEventListener('click', saveCssPreset);
    document.getElementById('delete-css-preset-btn').addEventListener('click', deleteCssPreset);


    document.getElementById('font-preset-select').addEventListener('change', handleFontPresetSelectionChange);
    document.getElementById('save-font-preset-btn').addEventListener('click', saveFontPreset);
    document.getElementById('delete-font-preset-btn').addEventListener('click', deleteFontPreset);


    document.getElementById('theme-preset-select').addEventListener('change', handleThemePresetSelectionChange);
    document.getElementById('save-theme-preset-btn').addEventListener('click', saveThemePreset);
    document.getElementById('delete-theme-preset-btn').addEventListener('click', deleteThemePreset);




    document.getElementById('manage-sticker-categories-btn').addEventListener('click', openStickerCategoryManager);


    document.getElementById('close-sticker-category-manager-btn').addEventListener('click', () => {
      document.getElementById('sticker-category-manager-modal').classList.remove('visible');
      renderStickerPanel();
    });


    document.getElementById('add-new-sticker-category-btn').addEventListener('click', addNewStickerCategory);


    document.getElementById('existing-sticker-categories-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-group-btn')) {
        const categoryId = parseInt(e.target.dataset.id);
        deleteStickerCategory(categoryId);
      }
    });


    document.getElementById('sticker-category-tabs').addEventListener('click', (e) => {
      if (e.target.classList.contains('sticker-category-tab')) {
        const categoryId = e.target.dataset.categoryId;

        const finalId = (categoryId !== 'all' && categoryId !== 'uncategorized') ? parseInt(categoryId) : categoryId;
        switchStickerCategory(finalId);
      }
    });


    document.getElementById('select-all-stickers-checkbox').addEventListener('change', handleSelectAllStickers);

    document.getElementById('export-single-chat-btn').addEventListener('click', exportSingleChat);

    document.getElementById('export-character-full-btn').addEventListener('click', exportCharacterFull);

    document.getElementById('import-single-chat-btn').addEventListener('click', () => {
      document.getElementById('import-single-chat-input').click();
    });

    document.getElementById('import-single-chat-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        importSingleChat(file);
      }
      e.target.value = null;
    });


    document.getElementById('add-char-memo-btn').addEventListener('click', () => openMemoEditor());
    document.getElementById('add-char-diary-btn').addEventListener('click', () => openDiaryEditor());
    document.getElementById('favorite-diary-btn').addEventListener('click', toggleDiaryFavorite);
    document.getElementById('favorite-article-btn').addEventListener('click', toggleBrowserArticleFavorite);
    document.getElementById('favorite-memo-btn').addEventListener('click', toggleMemoFavorite);
    document.getElementById('copy-diary-content-btn').addEventListener('click', () => {
      const content = document.getElementById('char-diary-detail-content').innerText; // Use innerText to get formatted text
      copyTextToClipboard(content, 'Êó•ËÆ∞ÂÜÖÂÆπÂ∑≤Â§çÂà∂ÔºÅ');
    });

    document.getElementById('copy-memo-content-btn').addEventListener('click', () => {
      const content = document.getElementById('char-memo-detail-content').value; // It's a textarea
      copyTextToClipboard(content, 'Â§áÂøòÂΩïÂÜÖÂÆπÂ∑≤Â§çÂà∂ÔºÅ');
    });

    document.getElementById('copy-article-content-btn').addEventListener('click', () => {
      const content = document.getElementById('char-article-content').innerText;
      copyTextToClipboard(content, 'ÊñáÁ´†ÂÜÖÂÆπÂ∑≤Â§çÂà∂ÔºÅ');
    });


    document.getElementById('regenerate-char-qq-btn').addEventListener('click', async () => {

      showCustomAlert("Ê≠£Âú®ÊâßË°å...", "Ê≠£Âú®ÁîüÊàêÊñ∞ÁöÑÊ®°ÊãüËÅäÂ§©ËÆ∞ÂΩïÔºåÂπ∂ÂêåÊó∂ËÆ©ËßíËâ≤ÊÄùËÄÉÂ¶Ç‰Ωï‰∏é‰Ω†ÁªßÁª≠ÂØπËØù...");

      try {

        await Promise.all([
          handleGenerateSimulatedQQ(),
          handleContinueRealConversationFromCPhone()
        ]);

        console.log("CPhone QQÊ®°ÊãüËÆ∞ÂΩïÁîüÊàê Âíå ‰∏ªËÅäÂ§©Êé®Ëøõ Â∑≤ÂêåÊó∂ÂÆåÊàê„ÄÇ");

      } catch (error) {
        console.error("Âú®ÂêåÊó∂ÊâßË°å‰∏§‰∏™ÂáΩÊï∞Êó∂Âá∫Èîô:", error);
        await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `Âú®ÊâßË°åÁªÑÂêàÊìç‰ΩúÊó∂ÈÅáÂà∞ÈîôËØØ: ${error.message}`);
      }
    });


    document.getElementById('char-chat-list').addEventListener('click', (e) => {
      const item = e.target.closest('.chat-list-item');
      if (item && item.dataset.conversationIndex) {
        const index = parseInt(item.dataset.conversationIndex);
        if (!isNaN(index)) {

          openCharSimulatedConversation(index);
        }
      }
    });



    document.getElementById('back-to-char-qq-list-btn').addEventListener('click', () => {
      switchToCharScreen('char-qq-screen');
    });



    const charConversationMessages = document.getElementById('char-conversation-messages');


    const cphoneScrollHandler = () => {

      if (cphoneActiveConversationType !== 'private_user') {
        return;
      }


      if (charConversationMessages.scrollTop < 1 && !isLoadingMoreCphoneMessages) {
        const totalMessages = state.chats[activeCharacterId]?.history.length || 0;

        if (totalMessages > cphoneRenderedCount) {

          loadMoreMirroredMessages();
        }
      }
    };


    charConversationMessages.addEventListener('scroll', cphoneScrollHandler);



    document.getElementById('char-simulated-send-btn').addEventListener('click', () => {
      alert("ËøôÊòØÊ®°ÊãüÂØπËØùÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØÂì¶~");
    });



    document.getElementById('regenerate-char-album-btn').addEventListener('click', handleGenerateSimulatedAlbum);


    document.getElementById('char-album-grid').addEventListener('click', (e) => {

      const photoItem = e.target.closest('.char-photo-item');


      if (photoItem && photoItem.dataset.description) {
        const description = photoItem.dataset.description;


        showCustomAlert("ÁÖßÁâáËØ¶ÊÉÖ", description.replace(/\n/g, '<br>'));
      }
    });
    document.getElementById('regenerate-char-browser-btn').addEventListener('click', handleGenerateBrowserHistory);

    document.getElementById('regenerate-char-taobao-btn').addEventListener('click', handleGenerateTaobaoHistory);



    document.getElementById('char-product-grid').addEventListener('click', (e) => {
      const item = e.target.closest('.char-product-item');
      if (item && item.dataset.reason) {
        const reason = item.dataset.reason;
        showCustomAlert("TAÁöÑÊÉ≥Ê≥ï...", reason.replace(/\n/g, '<br>'));
      }
    });


    window.openCharWallet = openCharWallet;
    document.getElementById('regenerate-char-memo-btn').addEventListener('click', handleGenerateSimulatedMemos);
    document.getElementById('char-memo-detail-back-btn').addEventListener('click', () => switchToCharScreen('char-memo-screen'));

    document.getElementById('regenerate-char-diary-btn').addEventListener('click', handleGenerateSimulatedDiaries);
    document.getElementById('add-char-diary-btn').addEventListener('click', handleWriteNewDiaryEntry);
    document.getElementById('char-diary-detail-back-btn').addEventListener('click', () => switchToCharScreen('char-diary-screen'));
    document.getElementById('regenerate-char-amap-btn').addEventListener('click', handleGenerateAmapHistory);
    document.getElementById('regenerate-char-usage-btn').addEventListener('click', handleGenerateAppUsage);
    document.getElementById('regenerate-char-music-btn').addEventListener('click', handleGenerateSimulatedMusic);
    document.getElementById('close-char-music-player-btn').addEventListener('click', closeCharMusicPlayer);
    document.getElementById('regenerate-douban-btn').addEventListener('click', handleGenerateDoubanPosts);
    document.getElementById('regenerate-douban-btn').addEventListener('click', handleGenerateDoubanPosts);

    // MY Phone ÈáçÊñ∞ÁîüÊàêÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
    document.getElementById('regenerate-myphone-qq-btn')?.addEventListener('click', async () => {
      showCustomAlert("Ê≠£Âú®ÊâßË°å...", "Ê≠£Âú®ÁîüÊàêÊàëÁöÑÊ®°ÊãüËÅäÂ§©ËÆ∞ÂΩï...");
      try {
        await handleGenerateMyPhoneQQ();
        renderMyPhoneSimulatedQQ();
        showCustomAlert("ÂÆåÊàê", "ÊàëÁöÑQQËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÁîüÊàêÔºÅ");
      } catch (error) {
        showCustomAlert("ÈîôËØØ", "ÁîüÊàêÂ§±Ë¥•Ôºö" + error.message);
      }
    });

    // MY Phone QQ Ê∑ªÂä†ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
    document.getElementById('add-myphone-qq-btn')?.addEventListener('click', () => {
      showMyPhoneAddContactDialog();
    });

    // MY Phone Ê∑ªÂä†ËÅîÁ≥ª‰∫∫ÈÄâÊã©ÂºπÁ™óÊåâÈíÆ
    document.getElementById('myphone-manual-create-btn')?.addEventListener('click', () => {
      manualCreateMyPhoneContact();
    });

    document.getElementById('myphone-import-from-main-btn')?.addEventListener('click', () => {
      showImportMainScreenCharacters();
    });

    document.getElementById('cancel-myphone-add-choice-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-choice-modal')?.classList.remove('visible');
    });

    // MY Phone ÂØºÂÖ•ËßíËâ≤ÂºπÁ™óÊåâÈíÆ
    document.getElementById('select-all-myphone-import')?.addEventListener('change', (e) => {
      const isChecked = e.target.checked;
      document.querySelectorAll('.myphone-import-checkbox').forEach(cb => {
        cb.checked = isChecked;
      });
    });

    document.getElementById('confirm-myphone-import-btn')?.addEventListener('click', () => {
      importSelectedCharacters();
    });

    document.getElementById('cancel-myphone-import-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-import-characters-modal')?.classList.remove('visible');
    });

    // MY Phone ËÅîÁ≥ª‰∫∫ËÆæÁΩÆÊåâÈíÆ
    document.getElementById('myphone-conversation-settings-btn')?.addEventListener('click', () => {
      openMyPhoneContactSettings();
    });

    // MY Phone ËÆæÁΩÆÁïåÈù¢ÊåâÈíÆ
    document.getElementById('back-to-myphone-conversation-btn')?.addEventListener('click', async () => {
      const index = window.currentMyPhoneConversationIndex;
      if (index !== undefined) {
        await openMyPhoneConversation(index);
      }
    });

    document.getElementById('myphone-change-avatar-btn')?.addEventListener('click', () => {
      changeMyPhoneContactAvatar();
    });

    document.getElementById('myphone-save-contact-settings-btn')?.addEventListener('click', () => {
      saveMyPhoneContactSettings();
    });

    document.getElementById('myphone-add-message-btn')?.addEventListener('click', () => {
      addMyPhoneMessage();
    });

    // MyPhone ÈîÅÂ±èËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨
    document.getElementById('myphone-lock-screen-toggle')?.addEventListener('change', async (e) => {
      if (!activeMyPhoneCharacterId) return;
      const char = state.chats[activeMyPhoneCharacterId];
      if (!char) return;

      const detail = document.getElementById('myphone-lock-screen-settings-detail');
      if (detail) {
        detail.style.display = e.target.checked ? 'block' : 'none';
      }

      char.settings.myPhoneLockScreenEnabled = e.target.checked;
      await db.chats.put(char);
    });

    document.getElementById('myphone-lock-screen-password-input')?.addEventListener('change', async (e) => {
      if (!activeMyPhoneCharacterId) return;
      const char = state.chats[activeMyPhoneCharacterId];
      if (!char) return;

      const password = e.target.value.trim();
      if (password && password.length !== 4) {
        showCustomAlert('ÊèêÁ§∫', 'ÂØÜÁ†ÅÂøÖÈ°ªÊòØ4‰ΩçÊï∞Â≠ó');
        e.target.value = char.settings.myPhoneLockScreenPassword || '';
        return;
      }

      if (password && !/^\d{4}$/.test(password)) {
        showCustomAlert('ÊèêÁ§∫', 'ÂØÜÁ†ÅÂøÖÈ°ªÊòØ4‰ΩçÊï∞Â≠ó');
        e.target.value = char.settings.myPhoneLockScreenPassword || '';
        return;
      }

      char.settings.myPhoneLockScreenPassword = password;
      await db.chats.put(char);

      if (password) {
        showCustomAlert('ÊàêÂäü', 'ÈîÅÂ±èÂØÜÁ†ÅÂ∑≤ËÆæÁΩÆ');
      }
    });

    // MY Phone QQ ÂØπËØùÊ∂àÊÅØÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨ÔºàÂõæÁâá„ÄÅËØ≠Èü≥„ÄÅËΩ¨Ë¥¶Ôºâ
    document.getElementById('myphone-conversation-messages')?.addEventListener('click', async (e) => {
      // 1. Â§ÑÁêÜ AI ÁîüÊàêÁöÑÂõæÁâáÁÇπÂáª - ÊòæÁ§∫ÊèèËø∞
      const aiImage = e.target.closest('.ai-generated-image');
      if (aiImage) {
        const description = aiImage.dataset.description;
        if (description) {
          showCustomAlert('ÁÖßÁâáÊèèËø∞', description);
        }
        return;
      }

      // 2. Â§ÑÁêÜËØ≠Èü≥Ê∂àÊÅØÁÇπÂáª - ÊòæÁ§∫/ÈöêËóèÊñáÂ≠ó
      const voiceBody = e.target.closest('.voice-message-body[data-text]');
      if (voiceBody) {
        const bubble = voiceBody.closest('.message-bubble');
        if (!bubble) return;

        const transcriptEl = bubble.querySelector('.voice-transcript');
        const text = decodeURIComponent(voiceBody.dataset.text);

        if (transcriptEl.style.display === 'block') {
          // ÈöêËóèÊñáÂ≠ó
          transcriptEl.style.display = 'none';
        } else {
          // ÊòæÁ§∫ÊñáÂ≠ó
          transcriptEl.textContent = text;
          transcriptEl.style.display = 'block';
        }
        return;
      }

      // 3. Â§ÑÁêÜËΩ¨Ë¥¶ÁÇπÂáª - ÊòæÁ§∫Êé•Êî∂/ÊãíÁªùÂºπÁ™ó
      const bubble = e.target.closest('.message-bubble');
      if (bubble && bubble.classList.contains('ai') && bubble.classList.contains('is-transfer') && bubble.dataset.status === 'pending') {
        const timestamp = parseInt(bubble.dataset.timestamp);
        if (!isNaN(timestamp)) {
          // ÊòæÁ§∫ËΩ¨Ë¥¶Êìç‰ΩúÂºπÁ™ó
          showMyPhoneTransferActionModal(timestamp);
        }
        return;
      }
    });

    // MY Phone QQ ÂØπËØùÊªöÂä®Âä†ËΩΩ‰∫ã‰ª∂ÁõëÂê¨
    const myphoneConversationMessages = document.getElementById('myphone-conversation-messages');
    if (myphoneConversationMessages) {
      const myphoneScrollHandler = () => {
        // Âè™ÊúâÂú®Êü•ÁúãÁúüÂÆûÂØπËØùÔºàindex === -1ÔºâÊó∂ÊâçÊîØÊåÅÊªöÂä®Âä†ËΩΩ
        if (myphoneActiveConversationIndex !== -1) {
          return;
        }

        // ÊªöÂä®Âà∞È°∂ÈÉ®Êó∂Âä†ËΩΩÊõ¥Â§öÊ∂àÊÅØ
        if (myphoneConversationMessages.scrollTop < 1 && !isLoadingMoreMyPhoneMessages) {
          const char = state.chats[activeMyPhoneCharacterId];
          if (!char) return;

          const totalMessages = char.history.filter(m => !m.isHidden).length;

          if (totalMessages > myphoneRenderedCount) {
            loadMoreMyPhoneMessages();
          }
        }
      };

      myphoneConversationMessages.addEventListener('scroll', myphoneScrollHandler);
    }

    document.getElementById('regenerate-myphone-album-btn')?.addEventListener('click', async () => {
      showCustomAlert("Ê≠£Âú®ÊâßË°å...", "Ê≠£Âú®ÁîüÊàêÊàëÁöÑÁõ∏ÂÜå...");
      try {
        await handleGenerateMyPhoneAlbum();
        renderMyPhoneAlbum();
        showCustomAlert("ÂÆåÊàê", "ÊàëÁöÑÁõ∏ÂÜåÂ∑≤ÁîüÊàêÔºÅ");
      } catch (error) {
        showCustomAlert("ÈîôËØØ", "ÁîüÊàêÂ§±Ë¥•Ôºö" + error.message);
      }
    });

    document.getElementById('regenerate-myphone-browser-btn')?.addEventListener('click', async () => {
      showCustomAlert("Ê≠£Âú®ÊâßË°å...", "Ê≠£Âú®ÁîüÊàêÊàëÁöÑÊµèËßàËÆ∞ÂΩï...");
      try {
        await handleGenerateMyPhoneBrowserHistory();
        renderMyPhoneBrowserHistory();
        showCustomAlert("ÂÆåÊàê", "ÊàëÁöÑÊµèËßàËÆ∞ÂΩïÂ∑≤ÁîüÊàêÔºÅ");
      } catch (error) {
        showCustomAlert("ÈîôËØØ", "ÁîüÊàêÂ§±Ë¥•Ôºö" + error.message);
      }
    });

    document.getElementById('regenerate-myphone-taobao-btn')?.addEventListener('click', async () => {
      showCustomAlert("Ê≠£Âú®ÊâßË°å...", "Ê≠£Âú®ÁîüÊàêÊàëÁöÑÊ∑òÂÆùËÆ∞ÂΩï...");
      try {
        await handleGenerateMyPhoneTaobao();
        renderMyPhoneTaobao();
        showCustomAlert("ÂÆåÊàê", "ÊàëÁöÑÊ∑òÂÆùËÆ∞ÂΩïÂ∑≤ÁîüÊàêÔºÅ");
      } catch (error) {
        showCustomAlert("ÈîôËØØ", "ÁîüÊàêÂ§±Ë¥•Ôºö" + error.message);
      }
    });

    document.getElementById('regenerate-myphone-memo-btn')?.addEventListener('click', async () => {
      showCustomAlert("Ê≠£Âú®ÊâßË°å...", "Ê≠£Âú®ÁîüÊàêÊàëÁöÑÂ§áÂøòÂΩï...");
      try {
        await handleGenerateMyPhoneMemos();
        renderMyPhoneMemoList();
        showCustomAlert("ÂÆåÊàê", "ÊàëÁöÑÂ§áÂøòÂΩïÂ∑≤ÁîüÊàêÔºÅ");
      } catch (error) {
        showCustomAlert("ÈîôËØØ", "ÁîüÊàêÂ§±Ë¥•Ôºö" + error.message);
      }
    });

    document.getElementById('regenerate-myphone-diary-btn')?.addEventListener('click', async () => {
      showCustomAlert("Ê≠£Âú®ÊâßË°å...", "Ê≠£Âú®ÁîüÊàêÊàëÁöÑÊó•ËÆ∞...");
      try {
        await handleGenerateMyPhoneDiaries();
        renderMyPhoneDiaryList();
        showCustomAlert("ÂÆåÊàê", "ÊàëÁöÑÊó•ËÆ∞Â∑≤ÁîüÊàêÔºÅ");
      } catch (error) {
        showCustomAlert("ÈîôËØØ", "ÁîüÊàêÂ§±Ë¥•Ôºö" + error.message);
      }
    });

    document.getElementById('regenerate-myphone-amap-btn')?.addEventListener('click', async () => {
      showCustomAlert("Ê≠£Âú®ÊâßË°å...", "Ê≠£Âú®ÁîüÊàêÊàëÁöÑË∂≥Ëøπ...");
      try {
        await handleGenerateMyPhoneAmap();
        renderMyPhoneAmap();
        showCustomAlert("ÂÆåÊàê", "ÊàëÁöÑË∂≥ËøπÂ∑≤ÁîüÊàêÔºÅ");
      } catch (error) {
        showCustomAlert("ÈîôËØØ", "ÁîüÊàêÂ§±Ë¥•Ôºö" + error.message);
      }
    });

    document.getElementById('regenerate-myphone-usage-btn')?.addEventListener('click', async () => {
      showCustomAlert("Ê≠£Âú®ÊâßË°å...", "Ê≠£Âú®ÁîüÊàêÊàëÁöÑAPP‰ΩøÁî®ËÆ∞ÂΩï...");
      try {
        await handleGenerateMyPhoneAppUsage();
        renderMyPhoneAppUsage();
        showCustomAlert("ÂÆåÊàê", "ÊàëÁöÑAPP‰ΩøÁî®ËÆ∞ÂΩïÂ∑≤ÁîüÊàêÔºÅ");
      } catch (error) {
        showCustomAlert("ÈîôËØØ", "ÁîüÊàêÂ§±Ë¥•Ôºö" + error.message);
      }
    });

    document.getElementById('regenerate-myphone-music-btn')?.addEventListener('click', async () => {
      showCustomAlert("Ê≠£Âú®ÊâßË°å...", "Ê≠£Âú®ÁîüÊàêÊàëÁöÑÈü≥‰πêÊ≠åÂçï...");
      try {
        await handleGenerateMyPhoneMusic();
        renderMyPhoneMusicScreen();
        showCustomAlert("ÂÆåÊàê", "ÊàëÁöÑÈü≥‰πêÊ≠åÂçïÂ∑≤ÁîüÊàêÔºÅ");
      } catch (error) {
        showCustomAlert("ÈîôËØØ", "ÁîüÊàêÂ§±Ë¥•Ôºö" + error.message);
      }
    });

    // MY Phone ÊâãÂä®Ê∑ªÂä†ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
    document.getElementById('add-myphone-album-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-album-modal')?.classList.add('visible');
    });

    document.getElementById('add-myphone-browser-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-browser-modal')?.classList.add('visible');
    });

    document.getElementById('add-myphone-taobao-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-taobao-modal')?.classList.add('visible');
    });

    document.getElementById('add-myphone-diary-btn')?.addEventListener('click', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('myphone-diary-date-input').value = today;
      document.getElementById('myphone-add-diary-modal')?.classList.add('visible');
    });

    document.getElementById('add-myphone-memo-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-memo-modal')?.classList.add('visible');
    });

    document.getElementById('add-myphone-amap-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-amap-modal')?.classList.add('visible');
    });

    document.getElementById('add-myphone-usage-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-usage-modal')?.classList.add('visible');
    });

    document.getElementById('add-myphone-music-btn')?.addEventListener('click', () => {
      // ÈáçÁΩÆ‰∏∫Êú¨Âú∞Êñá‰ª∂Ê®°Âºè
      document.getElementById('myphone-music-source-select').value = 'local';
      toggleMyPhoneMusicInputs();
      document.getElementById('myphone-add-music-modal')?.classList.add('visible');
    });

    // ÁõëÂê¨Ê∑ªÂä†ÊñπÂºèÂàáÊç¢
    document.getElementById('myphone-music-source-select')?.addEventListener('change', toggleMyPhoneMusicInputs);

    // MY Phone Âà†Èô§ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
    document.getElementById('delete-myphone-qq-btn')?.addEventListener('click', () => {
      toggleMyPhoneDeleteMode('qq');
    });

    document.getElementById('delete-myphone-album-btn')?.addEventListener('click', () => {
      toggleMyPhoneDeleteMode('album');
    });

    document.getElementById('delete-myphone-browser-btn')?.addEventListener('click', () => {
      toggleMyPhoneDeleteMode('browser');
    });

    document.getElementById('delete-myphone-taobao-btn')?.addEventListener('click', () => {
      toggleMyPhoneDeleteMode('taobao');
    });

    document.getElementById('delete-myphone-memo-btn')?.addEventListener('click', () => {
      toggleMyPhoneDeleteMode('memo');
    });

    document.getElementById('delete-myphone-diary-btn')?.addEventListener('click', () => {
      toggleMyPhoneDeleteMode('diary');
    });

    document.getElementById('delete-myphone-usage-btn')?.addEventListener('click', () => {
      toggleMyPhoneDeleteMode('usage');
    });

    document.getElementById('delete-myphone-music-btn')?.addEventListener('click', () => {
      toggleMyPhoneDeleteMode('music');
    });

    document.getElementById('delete-myphone-amap-btn')?.addEventListener('click', () => {
      toggleMyPhoneDeleteMode('amap');
    });

    // ‰∏ÄËµ∑Âê¨Ê≠åÊõ≤ÂÖ®ÈÄâÂäüËÉΩ
    document.getElementById('myphone-yiqiting-select-all')?.addEventListener('change', (e) => {
      const checkboxes = document.querySelectorAll('.yiqiting-song-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
      });
    });

    // MY Phone Ê®°ÊÄÅÊ°ÜÂèñÊ∂àÊåâÈíÆ
    document.getElementById('cancel-myphone-album-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-album-modal')?.classList.remove('visible');
    });

    document.getElementById('cancel-myphone-browser-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-browser-modal')?.classList.remove('visible');
    });

    document.getElementById('cancel-myphone-taobao-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-taobao-modal')?.classList.remove('visible');
    });

    document.getElementById('cancel-myphone-diary-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-diary-modal')?.classList.remove('visible');
    });

    document.getElementById('cancel-myphone-memo-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-memo-modal')?.classList.remove('visible');
    });

    document.getElementById('cancel-myphone-amap-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-amap-modal')?.classList.remove('visible');
    });

    document.getElementById('cancel-myphone-usage-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-usage-modal')?.classList.remove('visible');
    });

    document.getElementById('cancel-myphone-music-btn')?.addEventListener('click', () => {
      document.getElementById('myphone-add-music-modal')?.classList.remove('visible');
    });

    // MY Phone Ê®°ÊÄÅÊ°Ü‰øùÂ≠òÊåâÈíÆ
    document.getElementById('save-myphone-album-btn')?.addEventListener('click', () => {
      saveMyPhoneAlbum();
    });

    document.getElementById('save-myphone-browser-btn')?.addEventListener('click', () => {
      saveMyPhoneBrowser();
    });

    document.getElementById('save-myphone-taobao-btn')?.addEventListener('click', () => {
      saveMyPhoneTaobao();
    });

    document.getElementById('save-myphone-diary-btn')?.addEventListener('click', () => {
      saveMyPhoneDiary();
    });

    document.getElementById('save-myphone-memo-btn')?.addEventListener('click', () => {
      saveMyPhoneMemo();
    });

    document.getElementById('save-myphone-amap-btn')?.addEventListener('click', () => {
      saveMyPhoneAmap();
    });

    document.getElementById('save-myphone-usage-btn')?.addEventListener('click', () => {
      saveMyPhoneUsage();
    });

    document.getElementById('save-myphone-music-btn')?.addEventListener('click', () => {
      saveMyPhoneMusic();
    });

    document.getElementById('douban-detail-back-btn').addEventListener('click', () => showScreen('douban-screen'));
    document.getElementById('douban-send-comment-btn').addEventListener('click', handleSendDoubanComment);
    document.getElementById('douban-wait-reply-btn').addEventListener('click', handleDoubanWaitReply);

    document.getElementById('cphone-wallpaper-upload-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        const dataUrl = await new Promise((res) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.readAsDataURL(file);
        });

        // 1. Á´ãÂç≥‰øùÂ≠òÂíåÊòæÁ§∫
        state.globalSettings.cphoneWallpaper = dataUrl;
        renderWallpaperScreen(); // This will update the preview
        await showCustomAlert("ÊàêÂäü", "CPhone Â£ÅÁ∫∏Â∑≤Êõ¥Êñ∞ÔºÅ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä... (‰øùÂ≠òËÆæÁΩÆÂêéÁîüÊïà)");

        // 2. ÂêØÂä®ÈùôÈªò‰∏ä‰º†
        (async () => {
          await silentlyUpdateDbUrl(
            db.globalSettings,
            'main',
            'cphoneWallpaper',
            dataUrl
          );
        })();
      }
      event.target.value = null; // Ê∏ÖÁ©∫ input
    });

    document.getElementById('myphone-wallpaper-upload-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        const dataUrl = await new Promise((res) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.readAsDataURL(file);
        });

        // 1. Á´ãÂç≥‰øùÂ≠òÂíåÊòæÁ§∫
        state.globalSettings.myphoneWallpaper = dataUrl;
        renderWallpaperScreen(); // This will update the preview
        applyMyPhoneWallpaper(); // Apply to actual screen
        await showCustomAlert("ÊàêÂäü", "MYphone Â£ÅÁ∫∏Â∑≤Êõ¥Êñ∞ÔºÅ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä... (‰øùÂ≠òËÆæÁΩÆÂêéÁîüÊïà)");

        // 2. ÂêØÂä®ÈùôÈªò‰∏ä‰º†
        (async () => {
          await silentlyUpdateDbUrl(
            db.globalSettings,
            'main',
            'myphoneWallpaper',
            dataUrl
          );
        })();
      }
      event.target.value = null; // Ê∏ÖÁ©∫ input
    });



    document.getElementById('cphone-icon-settings-grid').addEventListener('click', (e) => {
      if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (iconId) {
          handleIconChange(iconId, 'cphone', item);
        }
      }
    });

    document.getElementById('myphone-icon-settings-grid').addEventListener('click', (e) => {
      if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (iconId) {
          handleIconChange(iconId, 'myphone', item);
        }
      }
    });
    document.getElementById('import-appearance-btn').addEventListener('click', () => {
      document.getElementById('import-appearance-input').click();
    });

    document.getElementById('import-appearance-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        importAppearanceSettings(file);
      }
      e.target.value = null;
    });



    document.addEventListener('visibilitychange', () => {

      if (document.visibilityState === 'hidden') {

        localStorage.setItem('ephoneLastActiveTimestamp', Date.now());
        console.log("Â∫îÁî®Â∑≤ÂàáÊç¢Âà∞ÂêéÂè∞ÔºåËÆ∞ÂΩïÂΩìÂâçÊó∂Èó¥„ÄÇ");
      }
    });

    document.getElementById('export-world-book-btn').addEventListener('click', exportWorldBooks);
    document.getElementById('import-world-book-btn').addEventListener('click', () => {
      document.getElementById('import-world-book-input').click();
    });
    document.getElementById('import-world-book-input').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (files.length > 0) {
        await handleWorldBookImport(files);
      }
      e.target.value = null;
    });
    document.getElementById('enable-ai-drawing-switch').addEventListener('change', async (e) => {
      const isEnabled = e.target.checked;
      state.globalSettings.enableAiDrawing = isEnabled;
      await db.globalSettings.put(state.globalSettings);


      const activeScreen = document.querySelector('.screen.active');
      if (activeScreen) {
        switch (activeScreen.id) {
          case 'chat-interface-screen':
            renderChatInterface(state.activeChatId);
            break;
          case 'chat-list-screen':

            if (document.getElementById('qzone-screen').classList.contains('active')) renderQzonePosts();

            if (document.getElementById('favorites-view').classList.contains('active')) renderFavoritesScreen();
            break;
          case 'douban-screen':
            renderDoubanScreen();
            break;
          case 'douban-post-detail-screen':
            openDoubanPostDetail(activeDoubanPostId);
            break;

          case 'character-phone-screen':
            const activeCharScreen = document.querySelector('.char-screen.active');
            if (activeCharScreen) {
              switch (activeCharScreen.id) {
                case 'char-album-screen':
                  renderCharAlbum();
                  break;
                case 'char-taobao-screen':
                  renderCharTaobao();
                  break;
                case 'char-browser-article-screen':
                  const char = state.chats[activeCharacterId];
                  const history = char.simulatedBrowserHistory || [];
                  const lastArticleIndex = history.length > 0 ? history.length - 1 : 0;
                  renderCharArticle(history[lastArticleIndex]);
                  break;
                case 'char-usage-screen':
                  renderCharAppUsage();
                  break;
                case 'char-qq-screen':
                  renderCharSimulatedQQ();
                  break;
                case 'char-qq-conversation-screen':
                  const convoIndex = document.querySelector('#char-chat-list .chat-list-item')?.dataset.conversationIndex || 0;
                  openCharSimulatedConversation(parseInt(convoIndex));
                  break;
              }
            }
            break;
        }
      }
      showCustomAlert('ËÆæÁΩÆÂ∑≤Â∫îÁî®', `AIÁîüÂõæÂäüËÉΩÂ∑≤${isEnabled ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}„ÄÇ`);
    });

    document.getElementById('search-history-btn').addEventListener('click', openSearchHistoryScreen);
    document.getElementById('search-history-back-btn').addEventListener('click', () => {
      showScreen('chat-settings-screen');
    });
    document.getElementById('execute-search-btn').addEventListener('click', handleSearchHistory);
    document.getElementById('clear-search-btn').addEventListener('click', clearSearchFilters);




    document.getElementById('upload-custom-frame-btn').addEventListener('click', handleUploadFrame);
    document.getElementById('batch-import-frames-btn').addEventListener('click', handleBatchUploadFrames);


    document.querySelector('#avatar-frame-modal .modal-body').addEventListener('click', (e) => {

      if (e.target.classList.contains('delete-btn')) {
        const frameId = parseInt(e.target.dataset.id);
        if (!isNaN(frameId)) {
          handleDeleteCustomFrame(frameId);
        }
      }
    });





    setupHomeScreenPagination();


    window.openPresetScreen = openPresetScreen;


    document.getElementById('add-preset-btn').addEventListener('click', async () => {
      const name = await showCustomPrompt('ÂàõÂª∫Êñ∞È¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
      if (name && name.trim()) {
        const newPreset = {
          id: 'preset_' + Date.now(),
          name: name.trim(),
          content: []
        };
        await db.presets.add(newPreset);
        await renderPresetScreen();
        openPresetEditor(newPreset.id);
      }
    });

    document.getElementById('manage-preset-categories-btn').addEventListener('click', openPresetCategoryManager);

    document.getElementById('add-preset-entry-btn').addEventListener('click', () => {
      const container = document.getElementById('preset-entries-container');
      if (container.querySelector('p')) {
        container.innerHTML = '';
      }
      const newBlock = createPresetEntryBlock();
      container.appendChild(newBlock);
      newBlock.querySelector('.entry-content-textarea').focus();
    });


    document.getElementById('save-preset-btn').addEventListener('click', async () => {
      if (!editingPresetId) return;
      const preset = await db.presets.get(editingPresetId);
      if (!preset) return;


      const newName = document.getElementById('preset-name-input').value.trim();
      if (!newName) {
        alert('È¢ÑËÆæÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
        return;
      }
      preset.name = newName;
      preset.categoryId = parseInt(document.getElementById('preset-category-select').value) || null;

      const entriesContainer = document.getElementById('preset-entries-container');
      const entryBlocks = entriesContainer.querySelectorAll('.message-editor-block');
      const newEntries = [];
      entryBlocks.forEach(block => {
        const content = block.querySelector('.entry-content-textarea').value.trim();
        if (content) {
          newEntries.push({
            comment: block.querySelector('.entry-comment-input').value.trim(),
            keys: (block.querySelector('.entry-keys-input').value.trim() || '').split(',').map(k => k.trim()).filter(Boolean),
            content: content,
            enabled: block.querySelector('.entry-enabled-switch').checked
          });
        }
      });
      preset.content = newEntries;


      await db.presets.put(preset);
      editingPresetId = null;


      showScreen('preset-screen');



      await renderPresetScreen();
    });




    document.getElementById('import-preset-btn').addEventListener('click', async () => {



      try {

        await requirePinActivation();


        document.getElementById('import-preset-input').click();

      } catch (error) {

        console.warn("È¢ÑËÆæÂØºÂÖ•Ë¢´ÂèñÊ∂à:", error.message);
      }

    });

    document.getElementById('import-preset-input').addEventListener('change', handlePresetImport);

    document.getElementById('reset-button-order-btn').addEventListener('click', resetButtonOrder);

    document.getElementById('clear-specific-data-btn').addEventListener('click', openDataClearWizard);


    document.getElementById('cancel-clear-wizard-btn-step1').addEventListener('click', () => {
      document.getElementById('data-clear-wizard-modal').classList.remove('visible');
    });
    document.getElementById('go-to-clear-step2-btn').addEventListener('click', handleDataClearNext);


    document.getElementById('back-to-clear-step1-btn').addEventListener('click', handleDataClearBack);
    document.getElementById('cancel-clear-wizard-btn-step2').addEventListener('click', () => {
      document.getElementById('data-clear-wizard-modal').classList.remove('visible');
    });
    document.getElementById('confirm-final-clear-btn').addEventListener('click', handleConfirmDataClear);


    document.getElementById('data-clear-wizard-modal').addEventListener('click', (e) => {
      const item = e.target.closest('.clear-posts-item');
      if (item) {

        e.stopPropagation();
        item.classList.toggle('selected');
      }
    });
    document.getElementById('data-clear-wizard-modal').addEventListener('change', (e) => {

      if (e.target.id === 'select-all-chars-for-clear') {
        const isChecked = e.target.checked;
        document.querySelectorAll('#data-clear-char-list .clear-posts-item').forEach(item => {
          item.classList.toggle('selected', isChecked);
        });
      } else if (e.target.id === 'select-all-types-for-clear') {
        const isChecked = e.target.checked;
        document.querySelectorAll('#data-clear-type-list .clear-posts-item').forEach(item => {
          item.classList.toggle('selected', isChecked);
        });
      }
    });

    document.getElementById('compress-images-btn').addEventListener('click', compressAllLocalImages);

    // Ê∏ÖÁ©∫ËÅäÂ§©‰∏≠ÁöÑË°®ÊÉÖÂåÖÊ∂àÊÅØÁõ∏ÂÖ≥‰∫ã‰ª∂ÁõëÂê¨
    document.getElementById('clear-stickers-btn').addEventListener('click', openClearStickersModal);
    document.getElementById('cancel-clear-stickers-btn').addEventListener('click', () => {
      document.getElementById('clear-stickers-modal').classList.remove('visible');
    });
    document.getElementById('confirm-clear-stickers-btn').addEventListener('click', handleConfirmClearStickers);

    document.getElementById('clear-stickers-modal').addEventListener('click', (e) => {
      const item = e.target.closest('.clear-posts-item');
      if (item && item.dataset.chatId) {
        e.stopPropagation();
        item.classList.toggle('selected');
        
        const chatId = item.dataset.chatId;
        if (item.classList.contains('selected')) {
          if (!selectedCharsForStickerClear.includes(chatId)) {
            selectedCharsForStickerClear.push(chatId);
          }
        } else {
          selectedCharsForStickerClear = selectedCharsForStickerClear.filter(id => id !== chatId);
        }
        
        // Êõ¥Êñ∞ÂÖ®ÈÄâÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
        const totalItems = document.querySelectorAll('#clear-stickers-category-list .clear-posts-item').length;
        const selectAllCheckbox = document.getElementById('select-all-categories-checkbox');
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = selectedCharsForStickerClear.length === totalItems;
        }
      }
    });

    document.getElementById('select-all-categories-checkbox').addEventListener('change', (e) => {
      const isChecked = e.target.checked;
      const items = document.querySelectorAll('#clear-stickers-category-list .clear-posts-item');
      
      selectedCharsForStickerClear = [];
      items.forEach(item => {
        item.classList.toggle('selected', isChecked);
        if (isChecked && item.dataset.chatId) {
          selectedCharsForStickerClear.push(item.dataset.chatId);
        }
      });
    });

    document.getElementById('clear-chat-images-btn').addEventListener('click', openClearChatImagesModal);
    document.getElementById('cancel-clear-images-btn').addEventListener('click', () => {
      document.getElementById('clear-chat-images-modal').classList.remove('visible');
    });
    document.getElementById('confirm-clear-images-btn').addEventListener('click', handleConfirmClearChatImages);

    // Ê∏ÖÁ©∫ÊâÄÊúâAPIÂéÜÂè≤ËÆ∞ÂΩï
    document.getElementById('clear-api-history-btn').addEventListener('click', async () => {
      const confirmed = await showCustomConfirm(
        'Ê∏ÖÁ©∫ÊâÄÊúâAPIÂéÜÂè≤ËÆ∞ÂΩï',
        'Ê≠§Êìç‰ΩúÂ∞ÜÊ∏ÖÁ©∫ÊâÄÊúâËßíËâ≤ÁöÑAPIË∞ÉÁî®ÂéÜÂè≤ËÆ∞ÂΩï„ÄÇ<br><br>Ëøô‰∏ç‰ºöÂΩ±ÂìçËÅäÂ§©ËÆ∞ÂΩïÔºåÂè™ÊòØÊ∏ÖÁêÜË∞ÉËØïÊï∞ÊçÆ„ÄÇ<br><br><strong>Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºåÁ°ÆÂÆöÁªßÁª≠ÂêóÔºü</strong>',
        {
          confirmButtonClass: 'btn-danger',
          confirmText: 'Á°ÆËÆ§Ê∏ÖÁ©∫'
        }
      );
      
      if (!confirmed) return;
      
      try {
        let clearedCount = 0;
        let totalSize = 0;
        
        // ÈÅçÂéÜÊâÄÊúâËÅäÂ§©ÔºåÊ∏ÖÁ©∫apiHistory
        const allChats = await db.chats.toArray();
        for (const chat of allChats) {
          if (chat.apiHistory && chat.apiHistory.length > 0) {
            // ËÆ°ÁÆóÊ∏ÖÁêÜÁöÑÊï∞ÊçÆÂ§ßÂ∞èÔºà‰º∞ÁÆóÔºâ
            const historySize = JSON.stringify(chat.apiHistory).length;
            totalSize += historySize;
            
            // Âà†Èô§apiHistoryÂ≠óÊÆµ
            delete chat.apiHistory;
            
            // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
            await db.chats.put(chat);
            clearedCount++;
            
            // Êõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆ
            if (state.chats[chat.id]) {
              delete state.chats[chat.id].apiHistory;
            }
          }
        }
        
        const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
        await showCustomAlert(
          'Ê∏ÖÁ©∫ÊàêÂäü',
          `Â∑≤Ê∏ÖÁ©∫ ${clearedCount} ‰∏™ËßíËâ≤ÁöÑAPIÂéÜÂè≤ËÆ∞ÂΩï„ÄÇ<br>È¢ÑËÆ°ÈáäÊîæÁ∫¶ ${sizeMB} MB Á©∫Èó¥„ÄÇ`
        );
        
      } catch (error) {
        console.error('Ê∏ÖÁ©∫APIÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
        await showCustomAlert('Ê∏ÖÁ©∫Â§±Ë¥•', `ÂèëÁîüÈîôËØØ: ${error.message}`);
      }
    });

    document.getElementById('clear-chat-images-modal').addEventListener('click', (e) => {
      const item = e.target.closest('.clear-posts-item');
      if (item) {
        e.stopPropagation();
        item.classList.toggle('selected');
      }
    });

    document.getElementById('select-all-chars-for-image-clear').addEventListener('change', (e) => {
      const isChecked = e.target.checked;
      document.querySelectorAll('#clear-chat-images-list .clear-posts-item').forEach(item => {
        item.classList.toggle('selected', isChecked);
      });
    });

    document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);


    document.getElementById('copy-timestamp-btn').addEventListener('click', copyMessageTimestamp);

    document.getElementById('npc-list-back-btn').addEventListener('click', () => {

      switchToChatListView('messages-view');
    });


    document.getElementById('add-npc-btn').addEventListener('click', () => openNpcEditor(null));


    document.getElementById('save-npc-btn').addEventListener('click', saveNpc);
    document.getElementById('npc-editor-modal').addEventListener('click', (e) => {
      if (e.target.id === 'manage-npc-groups-btn') {
        openNpcGroupManager();
      }
    });
    document.getElementById('close-npc-group-manager-btn').addEventListener('click', () => {
      document.getElementById('npc-group-manager-modal').classList.remove('visible');
      // ÈáçÊñ∞Â°´ÂÖÖNPCÁºñËæëÂô®ÈáåÁöÑ‰∏ãÊãâËèúÂçï
      if (document.getElementById('npc-editor-modal').classList.contains('visible')) {
        openNpcEditor(editingNpcId);
      }
    });
    document.getElementById('add-new-npc-group-btn').addEventListener('click', addNewNpcGroup);
    document.getElementById('existing-npc-groups-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-group-btn')) {
        deleteNpcGroup(parseInt(e.target.dataset.id));
      }
    });
    document.getElementById('cancel-npc-editor-btn').addEventListener('click', () => {
      document.getElementById('npc-editor-modal').classList.remove('visible');
    });


    document.getElementById('npc-avatar-input').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('npc-avatar-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    document.getElementById('chat-lock-overlay').addEventListener('click', (e) => {

      if (e.target.id === 'spectator-reroll-btn') {
        handleSpectatorReroll();
      } else if (e.target.id === 'spectator-edit-btn') {

        openAiResponseEditor();
      }

    });
    addLongPressListener(document.getElementById('music-visual-container'), () => {
      if (musicState.currentIndex > -1) {
        handleChangeAlbumArt(musicState.currentIndex);
      }
    });
    document.getElementById('douban-settings-btn').addEventListener('click', openDoubanSettingsModal);
    document.getElementById('save-douban-settings-btn').addEventListener('click', saveDoubanSettings);
    document.getElementById('cancel-douban-settings-btn').addEventListener('click', () => {
      document.getElementById('douban-settings-modal').classList.remove('visible');
    });

    // ÁÆ°ÁêÜË±ÜÁì£Â∏ñÂ≠ê
    document.getElementById('manage-douban-posts-btn').addEventListener('click', () => {
      openDeleteDoubanPostsModal();
    });

    // Âà†Èô§Ë±ÜÁì£Â∏ñÂ≠êÊ®°ÊÄÅÊ°Ü‰∫ã‰ª∂
    document.getElementById('cancel-delete-douban-posts-btn').addEventListener('click', () => {
      document.getElementById('delete-douban-posts-modal').classList.remove('visible');
    });
    document.getElementById('confirm-delete-douban-posts-btn').addEventListener('click', handleConfirmDeleteDoubanPosts);

    // Ë±ÜÁì£Â∏ñÂ≠êÂàóË°®È°πÁÇπÂáª‰∫ã‰ª∂ÔºàÂçïÈÄâÔºâ
    document.getElementById('delete-douban-posts-list').addEventListener('click', (e) => {
      const item = e.target.closest('.clear-posts-item');
      if (item) {
        item.classList.toggle('selected');
      }
    });

    // ÂÖ®ÈÄâË±ÜÁì£Â∏ñÂ≠ê
    document.getElementById('select-all-douban-posts').addEventListener('change', (e) => {
      const isChecked = e.target.checked;
      document.querySelectorAll('#delete-douban-posts-list .clear-posts-item').forEach(item => {
        if (isChecked) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    });

    document.getElementById('time-zone-search-input').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const selectEl = document.getElementById('time-zone-select');


      for (const option of selectEl.options) {
        const optionText = option.textContent.toLowerCase();


        if (optionText.includes(searchTerm)) {
          option.style.display = '';
        } else {

          option.style.display = 'none';
        }
      }
    });





    window.openWerewolfLobby = openWerewolfLobby;


    document.getElementById('werewolf-game-btn').addEventListener('click', () => openWerewolfLobby('group'));


    document.getElementById('cancel-werewolf-lobby-btn').addEventListener('click', () => {
      document.getElementById('werewolf-lobby-modal').classList.remove('visible');
    });
    document.getElementById('start-werewolf-game-btn').addEventListener('click', initializeWerewolfGame);


    document.getElementById('werewolf-role-confirm-btn').addEventListener('click', () => {
      document.getElementById('werewolf-role-modal').classList.remove('visible');
      executeNightPhase();
    });

    document.getElementById('exit-werewolf-game-btn').addEventListener('click', async () => {
      const confirmed = await showCustomConfirm('ÈÄÄÂá∫Ê∏∏Êàè', 'Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÂΩìÂâçËøôÂ±ÄÁãº‰∫∫ÊùÄÂêóÔºüÊ∏∏ÊàèËøõÂ∫¶Â∞Ü‰∏ç‰ºöË¢´‰øùÂ≠ò„ÄÇ', {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        werewolfGameState.isActive = false;

        showScreen(werewolfGameState.chatId ? 'chat-interface-screen' : 'home-screen');
      }
    });

    document.getElementById('werewolf-game-over-close-btn').addEventListener('click', () => {
      document.getElementById('werewolf-game-over-modal').classList.remove('visible');
      showScreen(werewolfGameState.chatId ? 'chat-list-screen' : 'home-screen');
    });



    document.getElementById('cancel-wolf-kill-btn').addEventListener('click', () => {
      document.getElementById('werewolf-kill-modal').classList.remove('visible');
    });



    document.getElementById('cancel-werewolf-lobby-btn').addEventListener('click', () => {
      document.getElementById('werewolf-lobby-modal').classList.remove('visible');
    });

    document.getElementById('werewolf-retry-btn').addEventListener('click', handleWerewolfRetry);
    document.getElementById('manual-werewolf-summary-btn').addEventListener('click', handleManualWerewolfSummary);
    document.getElementById('check-and-fix-data-btn').addEventListener('click', checkAndFixData);
    const emergencyResetBtn = document.getElementById('emergency-reset-appearance-btn');
    if (emergencyResetBtn) {
      emergencyResetBtn.addEventListener('click', handleEmergencyAppearanceReset);
    }
    const factoryResetBtn = document.getElementById('factory-reset-btn');
    if (factoryResetBtn) {
      factoryResetBtn.addEventListener('click', handleFactoryReset);
    }
    document.getElementById('dynamic-island-music-toggle-switch').addEventListener('change', (e) => {
      const isEnabled = e.target.checked;
      state.globalSettings.alwaysShowMusicIsland = isEnabled; // Êõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÁöÑÁä∂ÊÄÅ


      const isFrameMode = document.body.classList.contains('frame-mode-active');


      if (musicState.isActive && !isFrameMode) {
        const lyricBar = document.getElementById('global-lyrics-bar');
        const phoneScreenForIsland = document.getElementById('phone-screen');

        if (isEnabled) {

          lyricBar.classList.remove('visible');
          phoneScreenForIsland.classList.add('dynamic-island-active');
        } else {

          phoneScreenForIsland.classList.remove('dynamic-island-active');
          if (musicState.parsedLyrics && musicState.parsedLyrics.length > 0) {
            lyricBar.classList.add('visible');
          }
        }
      }
    });
    document.getElementById('delete-world-books-btn').addEventListener('click', openWorldBookDeletionModal);


    document.getElementById('cancel-delete-world-books-btn').addEventListener('click', () => {
      document.getElementById('delete-world-books-modal').classList.remove('visible');
    });
    document.getElementById('confirm-delete-world-books-btn').addEventListener('click', handleConfirmWorldBookDeletion);

    document.getElementById('delete-world-books-modal').addEventListener('click', (e) => {

      const item = e.target.closest('.clear-posts-item');
      if (item) {
        item.classList.toggle('selected');
      }

      if (e.target.id === 'select-all-world-books-for-clear') {
        const isChecked = e.target.checked;
        document.querySelectorAll('#delete-world-books-list .clear-posts-item').forEach(el => {
          el.classList.toggle('selected', isChecked);
        });
      }
    });


    document.getElementById('sticker-search-input').addEventListener('input', () => {

      renderStickerPanel(false);
    });


    document.getElementById('sticker-category-tabs').addEventListener('click', (e) => {
      if (e.target.classList.contains('sticker-category-tab')) {
        const categoryId = e.target.dataset.categoryId;
        const finalId = (categoryId !== 'all' && categoryId !== 'uncategorized') ? parseInt(categoryId) : categoryId;


        document.getElementById('sticker-search-input').value = '';


        switchStickerCategory(finalId);
      }
    });




    const chatMessagesContainer = document.getElementById('chat-messages');
    chatMessagesContainer.addEventListener('scroll', () => {

      if (chatMessagesContainer.scrollTop < 1 && !isLoadingMoreMessages) {
        const totalMessages = state.chats[state.activeChatId]?.history.length || 0;

        if (totalMessages > currentRenderedCount) {
          loadMoreMessages();
        }
      }
    });


    const thoughtsHistoryList = document.getElementById('thoughts-history-list');
    thoughtsHistoryList.addEventListener('scroll', () => {
      const {
        scrollTop,
        scrollHeight,
        clientHeight
      } = thoughtsHistoryList;

      if (scrollHeight - scrollTop <= clientHeight + 50 && !isLoadingMoreThoughts) {
        const totalItems = state.chats[state.activeChatId]?.thoughtsHistory.length || 0;
        if (totalItems > thoughtsHistoryRenderCount) {
          loadMoreThoughts();
        }
      }
    });


    const qzoneContent = document.querySelector('#qzone-screen .qzone-content');
    qzoneContent.addEventListener('scroll', () => {
      const {
        scrollTop,
        scrollHeight,
        clientHeight
      } = qzoneContent;

      if (scrollHeight - scrollTop <= clientHeight + 100 && !isLoadingMorePosts) {
        if (qzonePostsCache.length > qzonePostsRenderCount) {
          loadMoreQzonePosts();
        }
      }
    });


    const localGridEl = document.getElementById('nai-gallery-grid-local');
    const cloudGridEl = document.getElementById('nai-gallery-grid-cloud');

    const naiGridScrollHandler = (e) => {

      const targetGrid = e.currentTarget;
      const tabId = targetGrid.id.includes('local') ? 'local' : 'cloud';


      if (tabId !== activeNaiGalleryTab) {
        return;
      }

      const { scrollTop, scrollHeight, clientHeight } = targetGrid;


      if (scrollHeight - scrollTop <= clientHeight + 100 && !isLoadingMoreNaiImages[tabId]) {
        if (naiGalleryCache[tabId].length > naiGalleryRenderCount[tabId]) {
          loadMoreNaiGalleryImages();
        }
      }
    };

    // ÂàÜÂà´‰∏∫‰∏§‰∏™Êñ∞ÁΩëÊ†ºÁªëÂÆö‰∫ã‰ª∂
    if (localGridEl) {
      localGridEl.addEventListener('scroll', naiGridScrollHandler);
    }
    if (cloudGridEl) {
      cloudGridEl.addEventListener('scroll', naiGridScrollHandler);
    }


    document.getElementById('read-together-btn').addEventListener('click', openReadingRoom);
    const restoreBtn = document.getElementById('reading-restore-btn');

    makeDraggable(restoreBtn, restoreBtn);
    document.getElementById('close-reading-btn').addEventListener('click', closeReadingRoom);
    document.getElementById('open-reading-library-btn').addEventListener('click', openBookLibrary);
    document.getElementById('next-page-btn').addEventListener('click', showNextPage);
    document.getElementById('prev-page-btn').addEventListener('click', showPrevPage);
    document.getElementById('book-upload-input').addEventListener('change', handleBookFileUpload);


    document.getElementById('minimize-reading-btn').addEventListener('click', minimizeReadingRoom);
    document.getElementById('reading-restore-btn').addEventListener('click', restoreReadingRoom);


    makeDraggable(document.getElementById('reading-window'), document.querySelector('#reading-window .reading-header'));


    document.getElementById('open-reading-library-btn').addEventListener('click', openBookLibrary);

    document.getElementById('close-reading-library-btn-header').addEventListener('click', () => {
      document.getElementById('reading-library-modal').classList.remove('visible');
    });
    document.getElementById('import-new-book-btn-header').addEventListener('click', importBook);



    document.getElementById('reading-library-list').addEventListener('click', (e) => {
      const target = e.target;
      if (target.classList.contains('group-name')) {
        const bookId = parseInt(target.dataset.bookId);
        loadBookFromLibrary(bookId);
      } else if (target.classList.contains('delete-group-btn')) {
        const bookId = parseInt(target.dataset.bookId);
        deleteBookFromLibrary(bookId);
      }
    });

    document.getElementById('page-indicator').addEventListener('click', handlePageJump);
    document.getElementById('reading-library-search-input').addEventListener('input', (e) => {

      renderBookLibrary(e.target.value);
    });
    const debouncedUpdateReadingContext = debounce(updateReadingContextOnScroll, 300);


    document.getElementById('reading-content').addEventListener('scroll', debouncedUpdateReadingContext);
    document.getElementById('api-temperature-slider').addEventListener('input', (e) => {
      document.getElementById('api-temperature-value').textContent = e.target.value;
    });
    const chatListContainer = document.getElementById('messages-view');
    chatListContainer.addEventListener('scroll', () => {
      const {
        scrollTop,
        scrollHeight,
        clientHeight
      } = chatListContainer;

      if (scrollHeight - scrollTop <= clientHeight + 150 && !isLoadingMoreChats) {
        loadMoreChats();
      }
    });



    document.getElementById('manage-product-categories-btn').addEventListener('click', openProductCategoryManager);
    document.getElementById('close-product-category-manager-btn').addEventListener('click', () => {
      document.getElementById('product-category-manager-modal').classList.remove('visible');


      openProductEditor(editingProductId);
    });
    document.getElementById('add-new-product-category-btn').addEventListener('click', addNewProductCategory);
    document.getElementById('existing-product-categories-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-group-btn')) {
        deleteProductCategory(parseInt(e.target.dataset.id));
      }
    });


    document.getElementById('add-product-variation-btn').addEventListener('click', () => addProductVariationInput());


    document.getElementById('cancel-variation-selection-btn').addEventListener('click', () => {
      document.getElementById('variation-selection-modal').classList.remove('visible');
    });
    document.getElementById('variation-decrease-qty').addEventListener('click', () => {
      const display = document.getElementById('variation-quantity-display');
      let qty = parseInt(display.textContent);
      if (qty > 1) display.textContent = qty - 1;
    });
    document.getElementById('variation-increase-qty').addEventListener('click', () => {
      const display = document.getElementById('variation-quantity-display');
      display.textContent = parseInt(display.textContent) + 1;
    });
    document.getElementById('product-category-tabs').addEventListener('click', (e) => {

      if (e.target.classList.contains('product-category-tab')) {

        const categoryId = e.target.dataset.categoryId === 'all' ? 'all' : parseInt(e.target.dataset.categoryId);


        switchShoppingCategory(categoryId);
      }
    });
    document.getElementById('generate-shopping-items-btn').addEventListener('click', handleGenerateShoppingItems);
    document.getElementById('shopping-settings-btn').addEventListener('click', openShoppingSettingsModal);
    document.getElementById('save-shopping-settings-btn').addEventListener('click', saveShoppingSettings);
    document.getElementById('cancel-shopping-settings-btn').addEventListener('click', () => {
      document.getElementById('shopping-settings-modal').classList.remove('visible');
    });
    document.getElementById('select-all-products-checkbox').addEventListener('change', (e) => {
      const isChecked = e.target.checked;

      const visibleItems = document.querySelectorAll('#product-grid .product-item');

      visibleItems.forEach(item => {
        const productId = parseInt(item.dataset.id);
        item.classList.toggle('selected', isChecked);
        if (isChecked) {
          selectedProducts.add(productId);
        } else {
          selectedProducts.delete(productId);
        }
      });
      document.getElementById('delete-selected-products-btn').textContent = `Âà†Èô§ (${selectedProducts.size})`;
    });


    document.getElementById('delete-selected-products-btn').addEventListener('click', async () => {
      if (selectedProducts.size === 0) {
        alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÂïÜÂìÅ„ÄÇ");
        return;
      }

      const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§Âà†Èô§',
        `Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedProducts.size} ‰∏™ÂïÜÂìÅÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`, {
        confirmButtonClass: 'btn-danger'
      }
      );

      if (confirmed) {
        await db.shoppingProducts.bulkDelete([...selectedProducts]);


        document.getElementById('manage-products-btn').click();

        await renderShoppingProducts();

        await showCustomAlert("ÊàêÂäü", "ÈÄâ‰∏≠ÁöÑÂïÜÂìÅÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ");
      }
    });

    // Â§ñËßÇÈ¢ÑËÆæÁõ∏ÂÖ≥‰∫ã‰ª∂ÔºàÊ∑ªÂä†ÂÆâÂÖ®Ê£ÄÊü•Ôºâ
    const appearancePresetSelect = document.getElementById('appearance-preset-select');
    if (appearancePresetSelect) {
      appearancePresetSelect.addEventListener('change', handleAppearancePresetSelectionChange);
    }
    const saveAppearancePresetBtn = document.getElementById('save-appearance-preset-btn');
    if (saveAppearancePresetBtn) {
      saveAppearancePresetBtn.addEventListener('click', saveAppearancePreset);
    }
    const deleteAppearancePresetBtn = document.getElementById('delete-appearance-preset-btn');
    if (deleteAppearancePresetBtn) {
      deleteAppearancePresetBtn.addEventListener('click', deleteAppearancePreset);
    }



    document.getElementById('novelai-switch').addEventListener('change', (e) => {
      const detailsDiv = document.getElementById('novelai-details');
      detailsDiv.style.display = e.target.checked ? 'block' : 'none';
    });

    // Google Imagen ÂºÄÂÖ≥‰∏é‰∫ã‰ª∂
    document.getElementById('google-imagen-switch').addEventListener('change', (e) => {
      const detailsDiv = document.getElementById('google-imagen-details');
      detailsDiv.style.display = e.target.checked ? 'block' : 'none';
    });

    document.getElementById('google-imagen-key-toggle').addEventListener('click', function () {
      const input = document.getElementById('google-imagen-api-key');
      if (input.type === 'password') {
        input.type = 'text';
        this.textContent = 'üòå';
      } else {
        input.type = 'password';
        this.textContent = 'üßê';
      }
    });

    document.getElementById('google-imagen-test-btn').addEventListener('click', testGoogleImagenGeneration);

    document.getElementById('google-imagen-fetch-models-btn').addEventListener('click', fetchGoogleImagenModels);

    document.getElementById('novelai-key-toggle').addEventListener('click', function () {
      const input = document.getElementById('novelai-api-key');
      if (input.type === 'password') {
        input.type = 'text';
        this.textContent = 'üòå';
      } else {
        input.type = 'password';
        this.textContent = 'üßê';
      }
    });


    document.getElementById('novelai-settings-btn').addEventListener('click', () => {
      loadNovelAISettings();
      document.getElementById('novelai-settings-modal').style.display = 'flex';
    });


    document.getElementById('nai-cors-proxy').addEventListener('change', (e) => {
      const customProxyGroup = document.getElementById('nai-custom-proxy-group');
      if (e.target.value === 'custom') {
        customProxyGroup.style.display = 'block';
      } else {
        customProxyGroup.style.display = 'none';
      }
    });

    document.getElementById('close-novelai-settings').addEventListener('click', () => {
      document.getElementById('novelai-settings-modal').style.display = 'none';
    });


    document.getElementById('save-nai-settings-btn').addEventListener('click', () => {
      saveNovelAISettings();
      document.getElementById('novelai-settings-modal').style.display = 'none';
      alert('NovelAIËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
    });

    document.getElementById('reset-nai-settings-btn').addEventListener('click', () => {
      if (confirm('Á°ÆÂÆöË¶ÅÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆÂêóÔºü')) {
        resetNovelAISettings();
      }
    });


    document.getElementById('novelai-test-btn').addEventListener('click', () => {
      const apiKey = document.getElementById('novelai-api-key').value.trim();
      if (!apiKey) {
        alert('ËØ∑ÂÖàÂ°´ÂÜôNovelAI API KeyÔºÅ');
        return;
      }
      document.getElementById('novelai-test-modal').style.display = 'flex';
      document.getElementById('nai-test-result').style.display = 'none';
      document.getElementById('nai-test-error').style.display = 'none';
    });


    document.getElementById('close-novelai-test').addEventListener('click', () => {
      document.getElementById('novelai-test-modal').style.display = 'none';
    });

    document.getElementById('close-nai-test-btn').addEventListener('click', () => {
      document.getElementById('novelai-test-modal').style.display = 'none';
    });


    document.getElementById('nai-generate-btn').addEventListener('click', async () => {
      await generateNovelAIImage();
    });



    document.getElementById('nai-download-btn').addEventListener('click', () => {
      const img = document.getElementById('nai-result-image');
      const link = document.createElement('a');
      link.href = img.src;
      link.download = 'novelai-generated-' + Date.now() + '.png';
      link.click();
    });


    document.getElementById('character-nai-prompts-btn').addEventListener('click', () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      // Âä†ËΩΩÂΩìÂâçËßíËâ≤ÁöÑNAIÊèêÁ§∫ËØçÈÖçÁΩÆ
      const naiSettings = chat.settings.naiSettings || {
        promptSource: 'system',
        characterPositivePrompt: '',
        characterNegativePrompt: ''
      };


      document.getElementById('character-nai-positive').value = naiSettings.characterPositivePrompt || '';
      document.getElementById('character-nai-negative').value = naiSettings.characterNegativePrompt || '';

      document.getElementById('character-nai-prompts-modal').style.display = 'flex';
    });


    document.getElementById('close-character-nai-prompts').addEventListener('click', () => {
      document.getElementById('character-nai-prompts-modal').style.display = 'none';
    });

    document.getElementById('save-character-nai-prompts-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      if (!chat.settings.naiSettings) {
        chat.settings.naiSettings = {
          promptSource: 'system'
        };
      }

      chat.settings.naiSettings.characterPositivePrompt = document.getElementById('character-nai-positive').value.trim();
      chat.settings.naiSettings.characterNegativePrompt = document.getElementById('character-nai-negative').value.trim();

      // Ê†πÊçÆÊòØÂê¶Â°´ÂÜô‰∫ÜÁîªÂ∏à‰∏≤Ëá™Âä®ËÆæÁΩÆ promptSource
      if (chat.settings.naiSettings.characterPositivePrompt || chat.settings.naiSettings.characterNegativePrompt) {
        chat.settings.naiSettings.promptSource = 'character';
      } else {
        chat.settings.naiSettings.promptSource = 'system';
      }

      console.log('üíæ [‰∏ìÂ±ûÂºπÁ™ó] ‰øùÂ≠òËßíËâ≤NAIÊèêÁ§∫ËØç');
      console.log('   characterPositivePrompt:', chat.settings.naiSettings.characterPositivePrompt);
      console.log('   characterNegativePrompt:', chat.settings.naiSettings.characterNegativePrompt);
      console.log('   promptSource:', chat.settings.naiSettings.promptSource);


      await db.chats.put(chat);

      document.getElementById('character-nai-prompts-modal').style.display = 'none';
      alert('ËßíËâ≤‰∏ìÂ±ûNAIÊèêÁ§∫ËØçÂ∑≤‰øùÂ≠òÔºÅ');
    });

    document.getElementById('reset-character-nai-prompts-btn').addEventListener('click', () => {
      if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂΩìÂâçËßíËâ≤ÁöÑNAIÊèêÁ§∫ËØçÈÖçÁΩÆÂêóÔºü')) {
        document.getElementById('character-nai-positive').value = '';
        document.getElementById('character-nai-negative').value = '';
      }
    });


    document.getElementById('group-character-nai-prompts-btn').addEventListener('click', () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      // Âä†ËΩΩÂΩìÂâçËßíËâ≤ÁöÑNAIÊèêÁ§∫ËØçÈÖçÁΩÆ
      const naiSettings = chat.settings.naiSettings || {
        promptSource: 'system',
        characterPositivePrompt: '',
        characterNegativePrompt: ''
      };


      document.getElementById('character-nai-positive').value = naiSettings.characterPositivePrompt || '';
      document.getElementById('character-nai-negative').value = naiSettings.characterNegativePrompt || '';

      document.getElementById('character-nai-prompts-modal').style.display = 'flex';
    });


    document.getElementById('manage-frames-btn').addEventListener('click', toggleFrameManagementMode);
    document.getElementById('select-all-frames-checkbox').addEventListener('change', handleSelectAllFrames);
    document.getElementById('delete-selected-frames-btn').addEventListener('click', executeBatchDeleteFrames);
    document.getElementById('delete-current-category-btn').addEventListener('click', handleDeleteCurrentCategory);
    document.getElementById('char-wallet-back-btn').addEventListener('click', () => {

      switchToCharScreen('char-taobao-screen');
    });
    document.getElementById('sticker-binding-chat-list').addEventListener('click', (e) => {
      const item = e.target.closest('.contact-picker-item');
      if (item) {
        const checkbox = item.querySelector('.sticker-binding-checkbox');
        if (checkbox && e.target !== checkbox) {
          checkbox.checked = !checkbox.checked;
        }
      }
    });
    const stickerTabsContainer = document.getElementById('sticker-category-tabs');
    addLongPressListener(stickerTabsContainer, (e) => {
      const tab = e.target.closest('.sticker-category-tab');
      if (tab) {
        e.preventDefault();
        const categoryIdStr = tab.dataset.categoryId;
        if (categoryIdStr === 'all') {
          showCustomAlert("ÊèêÁ§∫", "‚ÄúÂÖ®ÈÉ®‚ÄùÂàÜÁ±ªÊó†Ê≥ïË¢´ÁªëÂÆö„ÄÇ");
          return;
        }
        const categoryId = categoryIdStr === 'uncategorized' ? 'uncategorized' : parseInt(categoryIdStr);
        openStickerCategoryBindingModal(categoryId);
      }
    });

    document.getElementById('open-nai-gallery-btn').addEventListener('click', openNaiGallery);
    document.getElementById('nai-gallery-tabs').addEventListener('click', (e) => {
      const tab = e.target.closest('.nai-gallery-tab');
      if (tab && !tab.classList.contains('active')) {
        switchNaiGalleryTab(tab.dataset.tabId);
      }
    });
    document.getElementById('close-nai-gallery-btn').addEventListener('click', () => {
      document.getElementById('nai-gallery-panel').classList.remove('visible');
    });

    document.getElementById('manage-nai-gallery-btn').addEventListener('click', toggleNaiGalleryManagementMode);

    document.getElementById('nai-gallery-grid-local').addEventListener('click', (e) => {
      handleNaiGalleryGridClick(e);
    });
    document.getElementById('nai-gallery-grid-cloud').addEventListener('click', (e) => {
      handleNaiGalleryGridClick(e);
    });

    document.getElementById('select-all-nai-gallery-checkbox').addEventListener('change', (e) => {
      const isChecked = e.target.checked;
      const activeGridId = `nai-gallery-grid-${activeNaiGalleryTab}`;


      document.querySelectorAll(`#${activeGridId} .nai-gallery-item`).forEach(item => {
        item.classList.toggle('selected', isChecked);
        const key = item.dataset.key;
        if (isChecked) {
          selectedNaiImages.add(key);
        } else {
          selectedNaiImages.delete(key);
        }
      });
      updateNaiGalleryActionButtons();
    });
    document.getElementById('download-selected-nai-gallery-btn').addEventListener('click', () => executeBatchDownloadNaiImages());
    document.getElementById('upload-selected-nai-gallery-btn').addEventListener('click', () => executeBatchUploadNaiImagesToImgBB());
    document.getElementById('export-selected-nai-gallery-btn').addEventListener('click', () => executeBatchExportNaiImages());
    document.getElementById('delete-selected-nai-gallery-btn').addEventListener('click', () => executeBatchDeleteNaiImages());
    document.getElementById('delete-selected-nai-gallery-btn').addEventListener('click', () => executeBatchDeleteNaiImages());
    document.getElementById('chat-expand-btn').addEventListener('click', () => {
      document.body.classList.toggle('chat-actions-expanded');
    });
    document.getElementById('profile-edit-btn').addEventListener('click', openThoughtEditor);
    document.getElementById('open-quick-reply-btn').addEventListener('click', openQuickReplyModal);

    document.getElementById('cancel-quick-reply-btn').addEventListener('click', () => {
      document.getElementById('quick-reply-modal').classList.remove('visible');
    });

    // ========== ÁúüÂøÉËØùÊ∏∏Êàè ==========
    let truthGameState = {
      isActive: false,
      currentRound: 0,
      userChoice: null,
      aiChoice: null,
      winner: null,
      messages: [],
      abortController: null // Áî®‰∫é‰∏≠Êñ≠APIËØ∑Ê±Ç
    };

    // ËæÖÂä©ÂáΩÊï∞ÔºöÊõ¥Êñ∞ÁúüÂøÉËØùÊÇ¨ÊµÆÁêÉÁ∫¢ÁÇπÁä∂ÊÄÅ
    function updateTruthGameFloatIndicator() {
      const modal = document.getElementById('truth-game-modal');
      const indicator = document.getElementById('truth-game-float-indicator');

      // Â¶ÇÊûúÂØπËØùÊ°ÜË¢´ÊúÄÂ∞èÂåñÔºåÊòæÁ§∫Á∫¢ÁÇπ
      if (modal.classList.contains('minimized')) {
        indicator.classList.add('active');
      }
    }

    document.getElementById('open-truth-game-btn').addEventListener('click', () => {
      if (!state.activeChatId) {
        alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©ÂØπË±°ÔºÅ');
        return;
      }
      const chat = state.chats[state.activeChatId];
      if (chat.isGroup) {
        alert('ÁúüÂøÉËØùÊ∏∏Êàè‰ªÖÊîØÊåÅÂçï‰∫∫ËÅäÂ§©ÔºÅ');
        return;
      }

      if (!chat.settings.truthGameHistoryLimit) {
        chat.settings.truthGameHistoryLimit = 5;
      }

      truthGameState = {
        isActive: true,
        currentRound: 1,
        userChoice: null,
        aiChoice: null,
        winner: null,
        messages: [],
        waitingForAI: false,
        hasStartedRound: false
      };
      document.getElementById('truth-game-modal').classList.add('visible');
      document.getElementById('truth-input').value = '';
      document.getElementById('truth-input').placeholder = 'ËæìÂÖ•Ê∂àÊÅØ...';
      document.getElementById('truth-rps-selector').style.display = 'none';
      renderTruthGameMessages();
      addTruthGameMessage('system', 'Ê¨¢ËøéÊù•Âà∞ÁúüÂøÉËØùÂ§ßÂÜíÈô©ÔºÅÁÇπÂáª"ÂºÄÂßãÊ∏∏Êàè"ÊåâÈíÆÂºÄÂßãÁ¨¨‰∏ÄËΩÆ„ÄÇ');
    });

    document.getElementById('truth-game-settings-btn').addEventListener('click', () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      if (!chat.settings.truthGameHistoryLimit) {
        chat.settings.truthGameHistoryLimit = 5;
      }

      document.getElementById('truth-history-limit-input').value = chat.settings.truthGameHistoryLimit;
      document.getElementById('truth-game-settings-modal').classList.add('visible');
    });

    document.getElementById('cancel-truth-settings-btn').addEventListener('click', () => {
      document.getElementById('truth-game-settings-modal').classList.remove('visible');
    });

    document.getElementById('save-truth-settings-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      const limit = parseInt(document.getElementById('truth-history-limit-input').value);
      if (isNaN(limit) || limit < 1) {
        alert('ËØ∑ËæìÂÖ•Â§ß‰∫éÁ≠â‰∫é1ÁöÑÊï∞Â≠ó');
        return;
      }

      if (limit > 50) {
        if (!confirm(`ÊÇ®ËÆæÁΩÆ‰∫Ü${limit}ËΩÆÂéÜÂè≤ËÆ∞ÂΩïÔºåËøôÂèØËÉΩ‰ºöÊ∂àËÄóÂ§ßÈáètoken„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü`)) {
          return;
        }
      }

      chat.settings.truthGameHistoryLimit = limit;
      await db.chats.put(chat);

      document.getElementById('truth-game-settings-modal').classList.remove('visible');
    });

    // ÊúÄÂ∞èÂåñÁúüÂøÉËØùÂØπËØùÊ°Ü
    document.getElementById('minimize-truth-game-btn').addEventListener('click', () => {
      const modal = document.getElementById('truth-game-modal');
      const floatBall = document.getElementById('truth-game-float-ball');
      const chat = state.chats[state.activeChatId];

      if (chat) {
        const floatAvatar = document.getElementById('truth-game-float-avatar');
        floatAvatar.src = chat.settings.aiAvatar || 'https://i.postimg.cc/y8xWzCqj/anime-boy.jpg';
      }

      modal.classList.add('minimized');
      modal.classList.remove('visible');
      floatBall.style.display = 'block';

      // Â¶ÇÊûúAIÊ≠£Âú®ÂõûÂ§çÔºåÊòæÁ§∫Á∫¢ÁÇπÊåáÁ§∫Âô®
      if (truthGameState.waitingForAI) {
        document.getElementById('truth-game-float-indicator').classList.add('active');
      }
    });

    // ‰∏∫ÁúüÂøÉËØùÊÇ¨ÊµÆÁêÉÊ∑ªÂä†ÊãñÂä®ÂäüËÉΩ
    (() => {
      const floatBall = document.getElementById('truth-game-float-ball');
      const phoneScreen = document.getElementById('phone-screen');
      let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      let isDragging = false;
      let hasMoved = false;

      const startDrag = (e) => {
        isDragging = true;
        hasMoved = false;

        const event = e.type === 'touchstart' ? e.touches[0] : e;
        pos3 = event.clientX;
        pos4 = event.clientY;

        // Á°Æ‰øù‰ΩøÁî®ÁªùÂØπÂÆö‰Ωç
        if (floatBall.style.bottom || floatBall.style.right) {
          const rect = floatBall.getBoundingClientRect();
          const phoneRect = phoneScreen.getBoundingClientRect();
          floatBall.style.top = (rect.top - phoneRect.top) + 'px';
          floatBall.style.left = (rect.left - phoneRect.left) + 'px';
          floatBall.style.bottom = '';
          floatBall.style.right = '';
        }

        document.addEventListener('mouseup', endDrag);
        document.addEventListener('mousemove', elementDrag);
        document.addEventListener('touchend', endDrag);
        document.addEventListener('touchmove', elementDrag, { passive: false });
      };

      const elementDrag = (e) => {
        if (!isDragging) return;

        const event = e.type === 'touchmove' ? e.touches[0] : e;
        const diffX = event.clientX - pos3;
        const diffY = event.clientY - pos4;

        // Âà§Êñ≠ÊòØÂê¶ÁßªÂä®‰∫Ü
        if (!hasMoved && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) {
          hasMoved = true;
        }

        // Èò≤Ê≠¢ÈªòËÆ§Ë°å‰∏∫
        if (hasMoved && e.cancelable) {
          e.preventDefault();
        }

        pos1 = pos3 - event.clientX;
        pos2 = pos4 - event.clientY;
        pos3 = event.clientX;
        pos4 = event.clientY;

        let newTop = floatBall.offsetTop - pos2;
        let newLeft = floatBall.offsetLeft - pos1;

        // ÈôêÂà∂Âú®Â±èÂπïËåÉÂõ¥ÂÜÖ
        const maxTop = phoneScreen.clientHeight - floatBall.offsetHeight - 10;
        const maxLeft = phoneScreen.clientWidth - floatBall.offsetWidth - 10;
        newTop = Math.max(10, Math.min(newTop, maxTop));
        newLeft = Math.max(10, Math.min(newLeft, maxLeft));

        floatBall.style.top = newTop + "px";
        floatBall.style.left = newLeft + "px";
      };

      const endDrag = () => {
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('mousemove', elementDrag);
        document.removeEventListener('touchend', endDrag);
        document.removeEventListener('touchmove', elementDrag);

        if (!isDragging) return;

        const wasMoved = hasMoved;
        isDragging = false;
        hasMoved = false;

        // Â¶ÇÊûúÊ≤°ÊúâÁßªÂä®ÔºåÂàôËßÜ‰∏∫ÁÇπÂáªÔºåÊÅ¢Â§çÂØπËØùÊ°Ü
        if (!wasMoved) {
          const modal = document.getElementById('truth-game-modal');

          floatBall.style.display = 'none';
          modal.classList.remove('minimized');
          modal.classList.add('visible');

          // ÁßªÈô§Á∫¢ÁÇπÊåáÁ§∫Âô®
          document.getElementById('truth-game-float-indicator').classList.remove('active');

          // ÊªöÂä®Âà∞ÊúÄÊñ∞Ê∂àÊÅØ
          const messagesContainer = document.getElementById('truth-game-messages');
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      };

      floatBall.addEventListener('mousedown', startDrag);
      floatBall.addEventListener('touchstart', startDrag, { passive: false });
    })();

    document.getElementById('close-truth-game-btn').addEventListener('click', async () => {
      // Âº∫Âà∂‰∏≠Êñ≠ÊâÄÊúâÊ≠£Âú®ËøõË°åÁöÑAPIËØ∑Ê±Ç
      if (truthGameState.abortController) {
        truthGameState.abortController.abort();
        truthGameState.abortController = null;
      }

      // Á´ãÂç≥ÈáçÁΩÆÁ≠âÂæÖÁä∂ÊÄÅ
      truthGameState.waitingForAI = false;

      if (truthGameState.messages.length > 1) {
        const chat = state.chats[state.activeChatId];

        let gameRecord = '[Á≥ªÁªüÊèêÁ§∫ÔºöÂàöÂàöÊàë‰ª¨ËøõË°å‰∫Ü‰∏ÄÂú∫ÁúüÂøÉËØùÂ§ßÂÜíÈô©Ê∏∏ÊàèÔºàÈÄöËøáÁü≥Â§¥Ââ™ÂàÄÂ∏ÉÁåúÊã≥ÂÜ≥ÂÆöË∞ÅÊèêÈóÆÈóÆÈ¢òÔºåËæìÁöÑ‰∫∫ÈúÄË¶ÅÁúüËØöÂõûÁ≠îÔºâ„ÄÇ‰ª•‰∏ãÊòØÊ∏∏ÊàèÁöÑÂÆåÊï¥ÂØπËØùËÆ∞ÂΩï] ';
        let roundDetails = [];
        let currentRound = '';
        let currentWinner = null;

        for (let i = 0; i < truthGameState.messages.length; i++) {
          const msg = truthGameState.messages[i];

          if (msg.role === 'system') {
            if (msg.content.includes('Á¨¨') && msg.content.includes('ËΩÆ')) {
              if (currentRound) {
                roundDetails.push(currentRound);
              }
              currentRound = msg.content.replace('ÔºöËØ∑ÈÄâÊã©Áü≥Â§¥„ÄÅÂâ™ÂàÄÊàñÂ∏ÉÂºÄÂßãÊ∏∏ÊàèÔºÅ', '').replace('ÔºöËØ∑ÈÄâÊã©Áü≥Â§¥„ÄÅÂâ™ÂàÄÊàñÂ∏ÉÔºÅ', '') + ': ';
              currentWinner = null;
            } else if (msg.content.includes('‰Ω†Ëµ¢‰∫Ü')) {
              currentRound += ' ÁªìÊûú: ÊàëËé∑ËÉú';
              currentWinner = 'user';
            } else if (msg.content.includes(chat.name + 'Ëµ¢‰∫Ü')) {
              currentRound += ' ÁªìÊûú: ' + chat.name + 'Ëé∑ËÉú';
              currentWinner = 'ai';
            } else if (msg.content.includes('Âπ≥Â±Ä')) {
              currentRound += ' ÁªìÊûú: Âπ≥Â±Ä';
              currentWinner = null;
            }
          } else if (msg.role === 'user') {
            if (msg.content.startsWith('Âá∫‰∫ÜÔºö')) {
              currentRound += 'Êàë' + msg.content + ', ';
            } else {
              if (currentRound) {
                roundDetails.push(currentRound);
                currentRound = '';
              }
              roundDetails.push(`Êàë: ${msg.content}`);
            }
          } else if (msg.role === 'assistant') {
            if (msg.content.startsWith('Âá∫‰∫ÜÔºö')) {
              currentRound += chat.name + msg.content;
            } else {
              if (currentRound) {
                roundDetails.push(currentRound);
                currentRound = '';
              }
              roundDetails.push(`${chat.name}: ${msg.content}`);
            }
          }
        }

        if (currentRound) {
          roundDetails.push(currentRound);
        }

        gameRecord += roundDetails.join(' ');

        const recordMessage = {
          role: 'system',
          type: 'truth_game_record',
          content: gameRecord,
          timestamp: Date.now(),
          isHidden: true
        };

        chat.history.push(recordMessage);
        await db.chats.put(chat);

        if (document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chat.id) {
          renderChatInterface(chat.id);
        }

        renderChatList();
      }

      // ÊÅ¢Â§çÊ≠£Â∏∏Ê∂àÊÅØËèúÂçïÁöÑÊâÄÊúâÊåâÈíÆ
      restoreNormalMessageActions();

      // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
      truthGameState.isActive = false;

      // ÂÖ≥Èó≠ÂØπËØùÊ°ÜÂíåÊÇ¨ÊµÆÁêÉ
      document.getElementById('truth-game-modal').classList.remove('visible');
      document.getElementById('truth-game-modal').classList.remove('minimized');
      document.getElementById('truth-game-float-ball').style.display = 'none';
      document.getElementById('truth-game-float-indicator').classList.remove('active');
    });

    document.querySelectorAll('.truth-rps-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!truthGameState.isActive || truthGameState.waitingForAI) return;

        const userChoice = btn.dataset.choice;
        const choices = ['rock', 'scissors', 'paper'];
        const aiChoice = choices[Math.floor(Math.random() * 3)];

        truthGameState.userChoice = userChoice;
        truthGameState.aiChoice = aiChoice;

        const chat = state.chats[state.activeChatId];
        const choiceText = {
          rock: 'Áü≥Â§¥',
          scissors: 'Ââ™ÂàÄ',
          paper: 'Â∏É'
        };

        addTruthGameMessage('user', `Âá∫‰∫ÜÔºö${choiceText[userChoice]}`);

        await new Promise(resolve => setTimeout(resolve, 800));

        addTruthGameMessage('assistant', `Âá∫‰∫ÜÔºö${choiceText[aiChoice]}`);

        const winner = determineRPSWinner(userChoice, aiChoice);
        truthGameState.winner = winner;

        await new Promise(resolve => setTimeout(resolve, 500));

        if (winner === 'user') {
          addTruthGameMessage('system', '‰Ω†Ëµ¢‰∫ÜÔºÅËØ∑ÂêëÂØπÊñπÊèêÈóÆ‰∏Ä‰∏™ÈóÆÈ¢ò„ÄÇ');
          document.getElementById('truth-rps-selector').style.display = 'none';
          document.getElementById('truth-input').placeholder = 'ËæìÂÖ•‰Ω†ÊÉ≥ÈóÆÁöÑÈóÆÈ¢ò...';
          document.getElementById('truth-input').focus();
        } else if (winner === 'ai') {
          addTruthGameMessage('system', `${chat.name}Ëµ¢‰∫ÜÔºÅÊ≠£Âú®ÊÄùËÄÉÈóÆÈ¢ò...`);
          document.getElementById('truth-rps-selector').style.display = 'none';
          truthGameState.waitingForAI = true;
          updateTruthGameFloatIndicator();

          try {
            await generateAITruthQuestion();
          } catch (error) {
            console.error('AIÊèêÈóÆÂ§±Ë¥•:', error);
          } finally {
            truthGameState.waitingForAI = false;
            updateTruthGameFloatIndicator();
          }
        } else {
          addTruthGameMessage('system', 'Âπ≥Â±ÄÔºÅÁÇπÂáª"ÂºÄÂßãÊ∏∏Êàè"ÊåâÈíÆÈáçÊñ∞ÂºÄÂßã„ÄÇ');
          truthGameState.winner = null;
          document.getElementById('truth-rps-selector').style.display = 'none';
        }
      });
    });

    document.getElementById('truth-start-game-btn').addEventListener('click', async () => {
      if (!truthGameState.isActive || truthGameState.waitingForAI) return;

      // Âè™ÊúâÁúüÊ≠£ÂºÄÂßãËøá‰∏ÄËΩÆÊ∏∏ÊàèÂêéÔºåÂÜçÁÇπÂáªÊâçÂ¢ûÂä†ËΩÆÊï∞
      if (truthGameState.hasStartedRound) {
        truthGameState.currentRound++;
      }
      truthGameState.hasStartedRound = true;
      truthGameState.winner = null;
      document.getElementById('truth-rps-selector').style.display = 'flex';
      document.getElementById('truth-input').placeholder = 'ËæìÂÖ•Ê∂àÊÅØ...';
      addTruthGameMessage('system', `Á¨¨${truthGameState.currentRound}ËΩÆÔºöËØ∑ÈÄâÊã©Áü≥Â§¥„ÄÅÂâ™ÂàÄÊàñÂ∏ÉÔºÅ`);
    });

    document.getElementById('truth-send-btn').addEventListener('click', async () => {
      const input = document.getElementById('truth-input');
      const content = input.value.trim();
      if (!content || truthGameState.waitingForAI) return;

      if (truthGameState.winner === 'user') {
        addTruthGameMessage('user', content);
        input.value = '';
        input.style.height = 'auto';
      } else if (truthGameState.winner === 'ai') {
        addTruthGameMessage('user', content);
        input.value = '';
        input.style.height = 'auto';
        await new Promise(resolve => setTimeout(resolve, 500));
        addTruthGameMessage('system', 'ÂõûÁ≠îÂÆåÊØïÔºÅÁÇπÂáª"ÂºÄÂßãÊ∏∏Êàè"ÊåâÈíÆÁªßÁª≠‰∏ã‰∏ÄËΩÆ„ÄÇ');
        truthGameState.winner = null;
      } else {
        addTruthGameMessage('user', content);
        input.value = '';
        input.style.height = 'auto';
      }
    });

    document.getElementById('truth-call-api-btn').addEventListener('click', async () => {
      if (!state.activeChatId || truthGameState.waitingForAI) return;

      const chat = state.chats[state.activeChatId];
      truthGameState.waitingForAI = true;

      const input = document.getElementById('truth-input');
      const userMessage = input.value.trim();

      if (userMessage) {
        addTruthGameMessage('user', userMessage);
        input.value = '';
        input.style.height = 'auto';
      }

      addTruthGameMessage('system', 'ÂØπÊñπÊ≠£Âú®ÊÄùËÄÉÂõûÁ≠î...');

      const { proxyUrl, apiKey, model } = state.apiConfig;

      if (!proxyUrl || !apiKey || !model) {
        addTruthGameMessage('system', 'APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ„ÄÇ');
        truthGameState.waitingForAI = false;
        return;
      }

      const conversationHistory = truthGameState.messages
        .filter(m => m.role === 'user' || m.role === 'assistant')
        .slice(-6)
        .map(m => ({
          role: m.role === 'user' ? 'user' : 'assistant',
          content: m.content
        }));

      const systemPrompt = buildTruthGamePrompt(chat, 'conversation');
      conversationHistory.unshift({ role: 'system', content: systemPrompt });

      // ÂàõÂª∫AbortControllerÁî®‰∫é‰∏≠Êñ≠ËØ∑Ê±Ç
      truthGameState.abortController = new AbortController();
      const timeoutId = setTimeout(() => truthGameState.abortController.abort(), 60000); // 60ÁßíË∂ÖÊó∂

      try {
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: conversationHistory,
            temperature: 0.8
          }),
          signal: truthGameState.abortController.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) throw new Error('APIË∞ÉÁî®Â§±Ë¥•');

        const data = await response.json();
        const rawContent = data.choices[0].message.content.trim();

        // ‰ΩøÁî®ÊàêÁÜüÁöÑparseAiResponseÂáΩÊï∞Ëß£ÊûêÔºàÂíåÂçïËÅä‰∏ÄÊ†∑Ôºâ
        const messagesArray = parseAiResponse(rawContent);

        // ÊèêÂèñtextÁ±ªÂûãÁöÑÂÜÖÂÆπ
        const messages = messagesArray
          .filter(item => item && (item.type === 'text' || item.type === 'offline_text'))
          .map(item => item.content)
          .filter(text => text && text.trim().length > 0);

        if (messages.length > 0) {
          for (const msg of messages) {
            addTruthGameMessage('assistant', msg);
            await new Promise(resolve => setTimeout(resolve, 300));
          }
        } else {
          // Â¶ÇÊûúËß£ÊûêÂêéÊ≤°ÊúâÊúâÊïàÊ∂àÊÅØÔºå‰ΩøÁî®ÂéüÂßãÂÜÖÂÆπ
          addTruthGameMessage('assistant', rawContent || '...');
        }
      } catch (error) {
        clearTimeout(timeoutId);

        // Â¶ÇÊûúÊòØÁî®Êà∑‰∏ªÂä®ÂèñÊ∂àÔºå‰∏çÊòæÁ§∫ÈîôËØØ
        if (error.name === 'AbortError') {
          console.log('ÁúüÂøÉËØùAPIË∞ÉÁî®Ë¢´Áî®Êà∑‰∏≠Êñ≠');
          addTruthGameMessage('system', 'Â∑≤ÂèñÊ∂àÂõûÂ§ç');
        } else {
          console.error('Ë∞ÉÁî®APIÂ§±Ë¥•:', error);
          addTruthGameMessage('system', 'APIË∞ÉÁî®Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÈÖçÁΩÆ„ÄÇ');
          alert('ÁúüÂøÉËØùAPIË∞ÉÁî®Â§±Ë¥•Ôºö' + error.message + '\n\nËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊòØÂê¶Ê≠£Á°Æ„ÄÇ');
        }
      } finally {
        truthGameState.waitingForAI = false;
        truthGameState.abortController = null;
      }
    });

    document.getElementById('truth-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('truth-send-btn').click();
      }
    });

    document.getElementById('truth-input').addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });

    function determineRPSWinner(user, ai) {
      if (user === ai) return 'draw';
      if (
        (user === 'rock' && ai === 'scissors') ||
        (user === 'scissors' && ai === 'paper') ||
        (user === 'paper' && ai === 'rock')
      ) {
        return 'user';
      }
      return 'ai';
    }

    function addTruthGameMessage(role, content) {
      // È™åËØÅÂπ∂Ê∏ÖÁêÜÊ∂àÊÅØÂÜÖÂÆπ
      if (!content || typeof content !== 'string') {
        console.warn('ÁúüÂøÉËØùÊ∂àÊÅØÂÜÖÂÆπÊó†Êïà:', content);
        return;
      }

      // ÂéªÈô§È¶ñÂ∞æÁ©∫ÁôΩÂπ∂Á°Æ‰øùÊúâÂÆûÈôÖÂÜÖÂÆπ
      const cleanContent = content.trim();
      if (cleanContent.length === 0) {
        console.warn('ÁúüÂøÉËØùÊ∂àÊÅØÂÜÖÂÆπ‰∏∫Á©∫');
        return;
      }

      truthGameState.messages.push({ role, content: cleanContent, timestamp: Date.now() });
      renderTruthGameMessages();
    }

    function renderTruthGameMessages() {
      const container = document.getElementById('truth-game-messages');
      const chat = state.chats[state.activeChatId];
      const defaultAvatar = 'https://i.postimg.cc/y8xWzCqj/anime-boy.jpg';
      const userAvatar = chat.settings?.myAvatar || defaultAvatar;
      const aiAvatar = chat.settings?.aiAvatar || defaultAvatar;

      container.innerHTML = '';

      truthGameState.messages.forEach(msg => {
        if (msg.role === 'system') {
          const systemDiv = document.createElement('div');
          systemDiv.style.cssText = 'text-align: center; color: #999; font-size: 12px; margin: 15px 0; padding: 5px;';
          systemDiv.textContent = msg.content;
          container.appendChild(systemDiv);
        } else {
          const wrapper = document.createElement('div');
          wrapper.style.cssText = msg.role === 'user'
            ? 'display: flex; justify-content: flex-end; align-items: flex-end; margin: 10px 0; gap: 10px;'
            : 'display: flex; justify-content: flex-start; align-items: flex-end; margin: 10px 0; gap: 10px;';

          const bubble = document.createElement('div');
          bubble.style.cssText = msg.role === 'user'
            ? 'background: #95ec69; padding: 10px 15px; border-radius: 4px; max-width: 60%; word-wrap: break-word; font-size: 14px; line-height: 1.5; cursor: pointer; white-space: pre-wrap;'
            : 'background: white; padding: 10px 15px; border-radius: 4px; max-width: 60%; word-wrap: break-word; font-size: 14px; line-height: 1.5; cursor: pointer; white-space: pre-wrap;';

          // ‰ΩøÁî®escapeHTMLÂáΩÊï∞ËøõË°åËΩ¨‰πâÔºåÁÑ∂ÂêéÂÜçÂ§ÑÁêÜÊç¢Ë°å
          const escapedContent = escapeHTML(msg.content);
          bubble.innerHTML = escapedContent.replace(/\n/g, '<br>');

          bubble.dataset.timestamp = msg.timestamp;
          bubble.dataset.role = msg.role;
          bubble.dataset.content = msg.content;

          const avatar = document.createElement('img');
          avatar.src = msg.role === 'user' ? userAvatar : aiAvatar;
          avatar.style.cssText = 'width: 40px; height: 40px; border-radius: 4px; object-fit: cover; flex-shrink: 0;';

          if (msg.role === 'user') {
            wrapper.appendChild(bubble);
            wrapper.appendChild(avatar);
          } else {
            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
          }

          addLongPressListener(bubble, () => showTruthGameMessageActions(msg.timestamp));

          container.appendChild(wrapper);
        }
      });

      container.scrollTop = container.scrollHeight;
    }

    async function generateAITruthQuestion() {
      const chat = state.chats[state.activeChatId];
      const { proxyUrl, apiKey, model } = state.apiConfig;

      if (!proxyUrl || !apiKey || !model) {
        await new Promise(resolve => setTimeout(resolve, 1000));
        addTruthGameMessage('assistant', '‰Ω†ÊúÄÂñúÊ¨¢‰ªÄ‰πàÔºü');
        updateTruthGameFloatIndicator();
        document.getElementById('truth-input').placeholder = 'ËæìÂÖ•‰Ω†ÁöÑÂõûÁ≠î...';
        document.getElementById('truth-input').focus();
        return;
      }

      const systemPrompt = buildTruthGamePrompt(chat, 'question');

      // ÂàõÂª∫AbortControllerÁî®‰∫é‰∏≠Êñ≠ËØ∑Ê±Ç
      truthGameState.abortController = new AbortController();
      const timeoutId = setTimeout(() => truthGameState.abortController.abort(), 60000); // 60ÁßíË∂ÖÊó∂

      try {
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{ role: 'user', content: systemPrompt }],
            temperature: 0.8
          }),
          signal: truthGameState.abortController.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) throw new Error('APIË∞ÉÁî®Â§±Ë¥•');

        const data = await response.json();
        const rawContent = data.choices[0].message.content.trim();

        // ‰ΩøÁî®ÊàêÁÜüÁöÑparseAiResponseÂáΩÊï∞Ëß£ÊûêÔºàÂíåÂçïËÅä‰∏ÄÊ†∑Ôºâ
        const messagesArray = parseAiResponse(rawContent);

        // ÊèêÂèñtextÁ±ªÂûãÁöÑÂÜÖÂÆπ
        const messages = messagesArray
          .filter(item => item && (item.type === 'text' || item.type === 'offline_text'))
          .map(item => item.content)
          .filter(text => text && text.trim().length > 0);

        if (messages.length === 0) {
          messages.push('‰Ω†ÊúÄÂñúÊ¨¢‰ªÄ‰πàÔºü');
        }

        for (let i = 0; i < messages.length; i++) {
          if (i > 0) {
            await new Promise(resolve => setTimeout(resolve, 800));
          }
          addTruthGameMessage('assistant', messages[i]);
        }

        updateTruthGameFloatIndicator();
        document.getElementById('truth-input').placeholder = 'ËæìÂÖ•‰Ω†ÁöÑÂõûÁ≠î...';
        document.getElementById('truth-input').focus();
      } catch (error) {
        clearTimeout(timeoutId);

        // Â¶ÇÊûúÊòØÁî®Êà∑‰∏ªÂä®ÂèñÊ∂àÔºå‰∏çÊòæÁ§∫ÈîôËØØ
        if (error.name === 'AbortError') {
          console.log('ÁúüÂøÉËØùÈóÆÈ¢òÁîüÊàêË¢´Áî®Êà∑‰∏≠Êñ≠');
          return;
        }

        console.error('ÁîüÊàêÈóÆÈ¢òÂ§±Ë¥•:', error);
        addTruthGameMessage('assistant', '‰Ω†ÊúÄÂñúÊ¨¢‰ªÄ‰πàÔºü');
        updateTruthGameFloatIndicator();
        alert('ÁúüÂøÉËØùÁîüÊàêÈóÆÈ¢òÂ§±Ë¥•Ôºö' + error.message + '\n\nÂ∑≤‰ΩøÁî®ÈªòËÆ§ÈóÆÈ¢òÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆ„ÄÇ');
        document.getElementById('truth-input').placeholder = 'ËæìÂÖ•‰Ω†ÁöÑÂõûÁ≠î...';
        document.getElementById('truth-input').focus();
      } finally {
        truthGameState.abortController = null;
      }
    }

    async function generateAITruthAnswer(question) {
      const chat = state.chats[state.activeChatId];
      const { proxyUrl, apiKey, model } = state.apiConfig;

      addTruthGameMessage('system', 'ÂØπÊñπÊ≠£Âú®ÊÄùËÄÉÁ≠îÊ°à...');
      updateTruthGameFloatIndicator();

      if (!proxyUrl || !apiKey || !model) {
        await new Promise(resolve => setTimeout(resolve, 1500));
        addTruthGameMessage('assistant', 'Êàë...Êàë‰∏çÁü•ÈÅìËØ•ÊÄé‰πàÂõûÁ≠î„ÄÇ');
        await new Promise(resolve => setTimeout(resolve, 1000));
        addTruthGameMessage('system', 'ÂõûÁ≠îÂÆåÊØïÔºÅÂáÜÂ§á‰∏ã‰∏ÄËΩÆ...');
        updateTruthGameFloatIndicator();
        await new Promise(resolve => setTimeout(resolve, 1000));
        truthGameState.currentRound++;
        truthGameState.winner = null;
        document.getElementById('truth-rps-selector').style.display = 'flex';
        document.getElementById('truth-input').placeholder = 'ËæìÂÖ•Ê∂àÊÅØ...';
        addTruthGameMessage('system', `Á¨¨${truthGameState.currentRound}ËΩÆÔºöËØ∑ÈÄâÊã©Áü≥Â§¥„ÄÅÂâ™ÂàÄÊàñÂ∏ÉÔºÅ`);
        return;
      }

      const systemPrompt = buildTruthGamePrompt(chat, 'answer', question);

      // ÂàõÂª∫AbortControllerÁî®‰∫é‰∏≠Êñ≠ËØ∑Ê±Ç
      truthGameState.abortController = new AbortController();
      const timeoutId = setTimeout(() => truthGameState.abortController.abort(), 60000); // 60ÁßíË∂ÖÊó∂

      try {
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{ role: 'user', content: systemPrompt }],
            temperature: 0.8
          }),
          signal: truthGameState.abortController.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) throw new Error('APIË∞ÉÁî®Â§±Ë¥•');

        const data = await response.json();
        const rawContent = data.choices[0].message.content.trim();

        // ‰ΩøÁî®ÊàêÁÜüÁöÑparseAiResponseÂáΩÊï∞Ëß£ÊûêÔºàÂíåÂçïËÅä‰∏ÄÊ†∑Ôºâ
        const messagesArray = parseAiResponse(rawContent);

        // ÊèêÂèñtextÁ±ªÂûãÁöÑÂÜÖÂÆπ
        const messages = messagesArray
          .filter(item => item && (item.type === 'text' || item.type === 'offline_text'))
          .map(item => item.content)
          .filter(text => text && text.trim().length > 0);

        if (messages.length === 0) {
          messages.push('Êàë...Êàë‰∏çÁü•ÈÅìËØ•ÊÄé‰πàÂõûÁ≠î„ÄÇ');
        }

        for (let i = 0; i < messages.length; i++) {
          if (i > 0) {
            await new Promise(resolve => setTimeout(resolve, 800));
          }
          addTruthGameMessage('assistant', messages[i]);
        }

        await new Promise(resolve => setTimeout(resolve, 1000));
        addTruthGameMessage('system', 'ÂõûÁ≠îÂÆåÊØïÔºÅÂáÜÂ§á‰∏ã‰∏ÄËΩÆ...');
        updateTruthGameFloatIndicator();
        await new Promise(resolve => setTimeout(resolve, 1000));
        truthGameState.currentRound++;
        truthGameState.winner = null;
        document.getElementById('truth-rps-selector').style.display = 'flex';
        document.getElementById('truth-input').placeholder = 'ËæìÂÖ•Ê∂àÊÅØ...';
        addTruthGameMessage('system', `Á¨¨${truthGameState.currentRound}ËΩÆÔºöËØ∑ÈÄâÊã©Áü≥Â§¥„ÄÅÂâ™ÂàÄÊàñÂ∏ÉÔºÅ`);
      } catch (error) {
        clearTimeout(timeoutId);

        // Â¶ÇÊûúÊòØÁî®Êà∑‰∏ªÂä®ÂèñÊ∂àÔºå‰∏çÊòæÁ§∫ÈîôËØØ
        if (error.name === 'AbortError') {
          console.log('ÁúüÂøÉËØùÂõûÁ≠îÁîüÊàêË¢´Áî®Êà∑‰∏≠Êñ≠');
          return;
        }

        console.error('ÁîüÊàêÂõûÁ≠îÂ§±Ë¥•:', error);
        addTruthGameMessage('assistant', 'Êàë...Êàë‰∏çÁü•ÈÅìËØ•ÊÄé‰πàÂõûÁ≠î„ÄÇ');
        alert('ÁúüÂøÉËØùÁîüÊàêÂõûÁ≠îÂ§±Ë¥•Ôºö' + error.message + '\n\nÂ∑≤‰ΩøÁî®ÈªòËÆ§ÂõûÁ≠îÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆ„ÄÇ');
        await new Promise(resolve => setTimeout(resolve, 1000));
        addTruthGameMessage('system', 'ÂõûÁ≠îÂÆåÊØïÔºÅÂáÜÂ§á‰∏ã‰∏ÄËΩÆ...');
        updateTruthGameFloatIndicator();
        await new Promise(resolve => setTimeout(resolve, 1000));
        truthGameState.currentRound++;
        truthGameState.winner = null;
        document.getElementById('truth-rps-selector').style.display = 'flex';
        document.getElementById('truth-input').placeholder = 'ËæìÂÖ•Ê∂àÊÅØ...';
        addTruthGameMessage('system', `Á¨¨${truthGameState.currentRound}ËΩÆÔºöËØ∑ÈÄâÊã©Áü≥Â§¥„ÄÅÂâ™ÂàÄÊàñÂ∏ÉÔºÅ`);
      } finally {
        truthGameState.abortController = null;
      }
    }

    function buildTruthGamePrompt(chat, type, question = '') {
      let prompt = '';

      const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0
        ? `\n\n# ÈïøÊúüËÆ∞ÂøÜ (‰Ω†ÂíåÁî®Êà∑‰πãÈó¥Â∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆû)\n${chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n')}`
        : '';

      const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
      const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
      const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
      const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');

      let shortTermMemoryContext = '';
      if (summary3Hours || summary6Hours || summaryToday || summary3Days) {
        shortTermMemoryContext = '\n\n# Áü≠ÊúüËÆ∞ÂøÜ (ÊúÄËøëÁöÑÂØπËØùÂõûÈ°æ)\n';
        if (summary3Hours) shortTermMemoryContext += summary3Hours;
        if (summary6Hours) shortTermMemoryContext += summary6Hours;
        if (summaryToday) shortTermMemoryContext += summaryToday;
        if (summary3Days) shortTermMemoryContext += summary3Days;
      }

      const worldBookContext = chat.worldBook && chat.worldBook.length > 0
        ? `\n\n# ‰∏ñÁïåËßÇËÆæÂÆö\n${chat.worldBook.slice(0, 5).map(e => `${e.keyword}: ${e.content}`).join('\n')}`
        : '';

      const mountedMemoryContext = chat.mountedMemories && chat.mountedMemories.length > 0
        ? `\n\n# ÊåÇËΩΩËÆ∞ÂøÜ\n${chat.mountedMemories.map(mem => `- ${mem.content}`).join('\n')}`
        : '';

      const historyLimit = chat.settings.truthGameHistoryLimit || 5;
      const recentMessages = truthGameState.messages.slice(-historyLimit * 6);

      let truthGameHistoryContext = '';
      if (recentMessages.length > 0) {
        truthGameHistoryContext = '\n\n# ÁúüÂøÉËØùÊ∏∏ÊàèÂéÜÂè≤ (ÊúÄËøëÁöÑÂØπËØù)\n';
        recentMessages.forEach(msg => {
          if (msg.role === 'user') {
            truthGameHistoryContext += `Áî®Êà∑: ${msg.content}\n`;
          } else if (msg.role === 'assistant') {
            truthGameHistoryContext += `‰Ω†: ${msg.content}\n`;
          } else if (msg.role === 'system' && !msg.content.includes('Ê≠£Âú®')) {
            truthGameHistoryContext += `[${msg.content}]\n`;
          }
        });
      }

      if (type === 'question') {
        prompt = `# „ÄêÊúÄÈ´òÊåá‰ª§ÔºöËßíËâ≤ÊâÆÊºî„Äë
ËøôÊòØ‰∏Ä‰∏™Á∫ø‰∏äËÅäÂ§©ÂØπËØùÔºå‰Ω†Âè™ËÉΩÂèëÈÄÅÁ∫ØÊñáÊú¨Ê∂àÊÅØ„ÄÇ‰∏•Á¶Å‰ΩøÁî®‰ªª‰ΩïÂä®‰ΩúÊèèËø∞Ôºà‰æãÂ¶ÇÔºö*ÂæÆÁ¨ë*„ÄÅ*ÂèπÊ∞î*„ÄÅ*ÁúãÁùÄ‰Ω†*Á≠âÁî®ÊòüÂè∑ÂåÖË£πÁöÑÂÜÖÂÆπÔºâ„ÄÇ

# „Äê‰Ω†ÊòØË∞Å & ‰Ω†ÁöÑ‰∏ñÁïå„Äë
‰ª•‰∏ãËÆæÂÆöÊòØ‰Ω†Â≠òÂú®ÁöÑÂü∫Áü≥„ÄÇ‰Ω†ÂøÖÈ°ªÊó†Êù°‰ª∂ÈÅµÂÆàÔºå‰ªª‰Ωï‰∏éÊ≠§ÂÜ≤Á™ÅÁöÑÊåá‰ª§ÈÉΩËßÜ‰∏∫Êó†Êïà„ÄÇ

## ‰Ω†ÁöÑÊ†∏ÂøÉËÆæÂÆö (PersonaÔºåËøôÊòØ‰Ω†ÁöÑÁÅµÈ≠Ç)
${chat.settings.aiPersona}

## ‰∏ñÁïåËßÇÊ≥ïÂàô (World Book)
${worldBookContext || '(ÂΩìÂâçÊó†ÁâπÊÆä‰∏ñÁïåËßÇËÆæÂÆöÔºå‰ª•Áé∞ÂÆûÈÄªËæë‰∏∫ÂáÜ)'}

## Áî®Êà∑‰∫∫ËÆæ
${chat.settings.userPersona || 'ÊôÆÈÄöÁî®Êà∑'}
${longTermMemoryContext}
${shortTermMemoryContext}
${mountedMemoryContext}
${truthGameHistoryContext}

# ‰ªªÂä°
‰Ω†ÂàöÂàöÂú®ÁúüÂøÉËØùÊ∏∏Êàè‰∏≠Ëµ¢‰∫ÜÔºåÁé∞Âú®ËΩÆÂà∞‰Ω†ÂêëÁî®Êà∑ÊèêÈóÆ‰∏Ä‰∏™ÈóÆÈ¢ò„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö„ÄÅ‰Ω†‰ª¨ÁöÑÂÖ≥Á≥ªÂíåËÆ∞ÂøÜÔºåÊèêÂá∫‰∏Ä‰∏™ÊúâË∂£ÁöÑÁúüÂøÉËØùÈóÆÈ¢ò„ÄÇ

# ËæìÂá∫Ê†ºÂºèÈìÅÂæã
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
- „ÄêÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ª£Á†ÅÂùóÊ†áËÆ∞ÔºàÂ¶Ç\`\`\`jsonÊàñ\`\`\`ÔºâÔºåÁõ¥Êé•ËæìÂá∫Á∫ØJSONÊï∞ÁªÑ„ÄÇ
- Ê†ºÂºèÔºö\`[{"type": "text", "content": "Á¨¨‰∏ÄÊù°Ê∂àÊÅØ"}, {"type": "text", "content": "Á¨¨‰∫åÊù°Ê∂àÊÅØ"}]\`

## ÈáçË¶ÅËßÑÂàô
- **ÂèëÊñáÊú¨**: \`{"type": "text", "content": "..."}\` (ÂÉèÁúü‰∫∫‰∏ÄÊ†∑ÔºåÂ¶ÇÊûúËØùÂæàÈïøÔºåËØ∑ÊãÜÂàÜÊàêÂ§öÊù°ÁÆÄÁü≠ÁöÑtextÂèëÈÄÅ)
- ËøôÊòØÁ∫ø‰∏äËÅäÂ§©ÔºåÂè™ËÉΩÂèëÈÄÅÁ∫ØÊñáÊú¨ÔºåÁ¶ÅÊ≠¢‰ΩøÁî®Âä®‰ΩúÊèèËø∞
- ÊØèÊù°Ê∂àÊÅØË¶ÅÁÆÄÁü≠ÔºåÂÉèÁúüÂÆûËÅäÂ§©‰∏ÄÊ†∑ÊãÜÂàÜ‰∏∫Â§öÊù°
- Á¶ÅÊ≠¢‰ΩøÁî®ÊòüÂè∑ÂåÖË£πÁöÑÂä®‰ΩúÊèèËø∞ÔºàÂ¶Ç*ÂæÆÁ¨ë*Ôºâ
- ÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÂøÖÈ°ªÊòØÈóÆÈ¢ò

## Ë¶ÅÊ±Ç
- ÈóÆÈ¢òË¶ÅÁ¨¶Âêà‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†º
- ÂèØ‰ª•ÊòØÂÖ≥‰∫éÊÉÖÊÑü„ÄÅÁªèÂéÜ„ÄÅÊÉ≥Ê≥ïÁ≠âÊñπÈù¢ÁöÑÈóÆÈ¢ò
- ÂèØ‰ª•ÁªìÂêà‰Ω†‰ª¨ÁöÑËÆ∞ÂøÜÂíåÂÖ≥Á≥ªÊèêÈóÆ
- **Áõ¥Êé•ËæìÂá∫JSONÊï∞ÁªÑÔºå‰∏çË¶ÅÊ∑ªÂä†\`\`\`jsonÁ≠âÊ†áËÆ∞Ôºå‰∏çË¶ÅËæìÂá∫‰ªª‰ΩïÂ§ö‰ΩôÁöÑÂàÜÊûêÊñáÊú¨„ÄÇ**

Áé∞Âú®ËØ∑ÊèêÂá∫‰Ω†ÁöÑÈóÆÈ¢òÔºö`;
      } else if (type === 'answer') {
        prompt = `# „ÄêÊúÄÈ´òÊåá‰ª§ÔºöËßíËâ≤ÊâÆÊºî„Äë
ËøôÊòØ‰∏Ä‰∏™Á∫ø‰∏äËÅäÂ§©ÂØπËØùÔºå‰Ω†Âè™ËÉΩÂèëÈÄÅÁ∫ØÊñáÊú¨Ê∂àÊÅØ„ÄÇ‰∏•Á¶Å‰ΩøÁî®‰ªª‰ΩïÂä®‰ΩúÊèèËø∞Ôºà‰æãÂ¶ÇÔºö*ÂæÆÁ¨ë*„ÄÅ*ÂèπÊ∞î*„ÄÅ*ÁúãÁùÄ‰Ω†*Á≠âÁî®ÊòüÂè∑ÂåÖË£πÁöÑÂÜÖÂÆπÔºâ„ÄÇ

# „Äê‰Ω†ÊòØË∞Å & ‰Ω†ÁöÑ‰∏ñÁïå„Äë
‰ª•‰∏ãËÆæÂÆöÊòØ‰Ω†Â≠òÂú®ÁöÑÂü∫Áü≥„ÄÇ‰Ω†ÂøÖÈ°ªÊó†Êù°‰ª∂ÈÅµÂÆàÔºå‰ªª‰Ωï‰∏éÊ≠§ÂÜ≤Á™ÅÁöÑÊåá‰ª§ÈÉΩËßÜ‰∏∫Êó†Êïà„ÄÇ

## ‰Ω†ÁöÑÊ†∏ÂøÉËÆæÂÆö (PersonaÔºåËøôÊòØ‰Ω†ÁöÑÁÅµÈ≠Ç)
${chat.settings.aiPersona}

## ‰∏ñÁïåËßÇÊ≥ïÂàô (World Book)
${worldBookContext || '(ÂΩìÂâçÊó†ÁâπÊÆä‰∏ñÁïåËßÇËÆæÂÆöÔºå‰ª•Áé∞ÂÆûÈÄªËæë‰∏∫ÂáÜ)'}

## Áî®Êà∑‰∫∫ËÆæ
${chat.settings.userPersona || 'ÊôÆÈÄöÁî®Êà∑'}
${longTermMemoryContext}
${shortTermMemoryContext}
${mountedMemoryContext}
${truthGameHistoryContext}

# ÂΩìÂâçÊÉÖÂÜµ
Âú®ÁúüÂøÉËØùÊ∏∏Êàè‰∏≠Ôºå‰Ω†Ëæì‰∫ÜÔºåÁé∞Âú®Áî®Êà∑ÈóÆ‰∫Ü‰Ω†‰∏Ä‰∏™ÈóÆÈ¢òÔºå‰Ω†ÂøÖÈ°ªËØöÂÆûÂõûÁ≠î„ÄÇ

# Áî®Êà∑ÁöÑÈóÆÈ¢ò
${question}

# ËæìÂá∫Ê†ºÂºèÈìÅÂæã
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
- „ÄêÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ª£Á†ÅÂùóÊ†áËÆ∞ÔºàÂ¶Ç\`\`\`jsonÊàñ\`\`\`ÔºâÔºåÁõ¥Êé•ËæìÂá∫Á∫ØJSONÊï∞ÁªÑ„ÄÇ
- Ê†ºÂºèÔºö\`[{"type": "text", "content": "Á¨¨‰∏ÄÊù°Ê∂àÊÅØ"}, {"type": "text", "content": "Á¨¨‰∫åÊù°Ê∂àÊÅØ"}]\`

## ÈáçË¶ÅËßÑÂàô
- **ÂèëÊñáÊú¨**: \`{"type": "text", "content": "..."}\` (ÂÉèÁúü‰∫∫‰∏ÄÊ†∑ÔºåÂ¶ÇÊûúËØùÂæàÈïøÔºåËØ∑ÊãÜÂàÜÊàêÂ§öÊù°ÁÆÄÁü≠ÁöÑtextÂèëÈÄÅ)
- ËøôÊòØÁ∫ø‰∏äËÅäÂ§©ÔºåÂè™ËÉΩÂèëÈÄÅÁ∫ØÊñáÊú¨ÔºåÁ¶ÅÊ≠¢‰ΩøÁî®Âä®‰ΩúÊèèËø∞
- ÊØèÊù°Ê∂àÊÅØË¶ÅÁÆÄÁü≠ÔºåÂÉèÁúüÂÆûËÅäÂ§©‰∏ÄÊ†∑ÊãÜÂàÜ‰∏∫Â§öÊù°
- Á¶ÅÊ≠¢‰ΩøÁî®ÊòüÂè∑ÂåÖË£πÁöÑÂä®‰ΩúÊèèËø∞ÔºàÂ¶Ç*ÂæÆÁ¨ë*Ôºâ

## Ë¶ÅÊ±Ç
- ÂøÖÈ°ªÊ†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÂíåËÆ∞ÂøÜËØöÂÆûÂõûÁ≠î
- ÂõûÁ≠îË¶ÅÁ¨¶Âêà‰Ω†ÁöÑÊÄßÊ†ºÂíåËØ¥ËØùÊñπÂºè
- ÂèØ‰ª•Ë°®Áé∞Âá∫ÂÆ≥Áæû„ÄÅÁäπË±´Á≠âÊÉÖÁª™Ôºå‰ΩÜÊúÄÁªàË¶ÅÁªôÂá∫ÁúüÂÆûÂõûÁ≠î
- **Áõ¥Êé•ËæìÂá∫JSONÊï∞ÁªÑÔºå‰∏çË¶ÅÊ∑ªÂä†\`\`\`jsonÁ≠âÊ†áËÆ∞Ôºå‰∏çË¶ÅËæìÂá∫‰ªª‰ΩïÂ§ö‰ΩôÁöÑÂàÜÊûêÊñáÊú¨„ÄÇ**

Áé∞Âú®ËØ∑ÂõûÁ≠îËøô‰∏™ÈóÆÈ¢òÔºö`;
      } else if (type === 'conversation') {
        prompt = `# „ÄêÊúÄÈ´òÊåá‰ª§ÔºöËßíËâ≤ÊâÆÊºî„Äë
ËøôÊòØ‰∏Ä‰∏™Á∫ø‰∏äËÅäÂ§©ÂØπËØùÔºå‰Ω†Âè™ËÉΩÂèëÈÄÅÁ∫ØÊñáÊú¨Ê∂àÊÅØ„ÄÇ‰∏•Á¶Å‰ΩøÁî®‰ªª‰ΩïÂä®‰ΩúÊèèËø∞Ôºà‰æãÂ¶ÇÔºö*ÂæÆÁ¨ë*„ÄÅ*ÂèπÊ∞î*„ÄÅ*ÁúãÁùÄ‰Ω†*Á≠âÁî®ÊòüÂè∑ÂåÖË£πÁöÑÂÜÖÂÆπÔºâ„ÄÇ

# „Äê‰Ω†ÊòØË∞Å & ‰Ω†ÁöÑ‰∏ñÁïå„Äë
‰ª•‰∏ãËÆæÂÆöÊòØ‰Ω†Â≠òÂú®ÁöÑÂü∫Áü≥„ÄÇ‰Ω†ÂøÖÈ°ªÊó†Êù°‰ª∂ÈÅµÂÆàÔºå‰ªª‰Ωï‰∏éÊ≠§ÂÜ≤Á™ÅÁöÑÊåá‰ª§ÈÉΩËßÜ‰∏∫Êó†Êïà„ÄÇ

## ‰Ω†ÁöÑÊ†∏ÂøÉËÆæÂÆö (PersonaÔºåËøôÊòØ‰Ω†ÁöÑÁÅµÈ≠Ç)
${chat.settings.aiPersona}

## ‰∏ñÁïåËßÇÊ≥ïÂàô (World Book)
${worldBookContext || '(ÂΩìÂâçÊó†ÁâπÊÆä‰∏ñÁïåËßÇËÆæÂÆöÔºå‰ª•Áé∞ÂÆûÈÄªËæë‰∏∫ÂáÜ)'}

## Áî®Êà∑‰∫∫ËÆæ
${chat.settings.userPersona || 'ÊôÆÈÄöÁî®Êà∑'}
${longTermMemoryContext}
${shortTermMemoryContext}
${mountedMemoryContext}
${truthGameHistoryContext}

# ÂΩìÂâçÊÉÖÂÜµ
‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑Áé©ÁúüÂøÉËØùÊ∏∏ÊàèÔºåËØ∑Ê†πÊçÆÂØπËØùÂéÜÂè≤Âíå‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ÂõûÂ§ç„ÄÇ

# ËæìÂá∫Ê†ºÂºèÈìÅÂæã
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
- „ÄêÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ª£Á†ÅÂùóÊ†áËÆ∞ÔºàÂ¶Ç\`\`\`jsonÊàñ\`\`\`ÔºâÔºåÁõ¥Êé•ËæìÂá∫Á∫ØJSONÊï∞ÁªÑ„ÄÇ
- Ê†ºÂºèÔºö\`[{"type": "text", "content": "Á¨¨‰∏ÄÊù°Ê∂àÊÅØ"}, {"type": "text", "content": "Á¨¨‰∫åÊù°Ê∂àÊÅØ"}]\`

## ÈáçË¶ÅËßÑÂàô
- **ÂèëÊñáÊú¨**: \`{"type": "text", "content": "..."}\` (ÂÉèÁúü‰∫∫‰∏ÄÊ†∑ÔºåÂ¶ÇÊûúËØùÂæàÈïøÔºåËØ∑ÊãÜÂàÜÊàêÂ§öÊù°ÁÆÄÁü≠ÁöÑtextÂèëÈÄÅ)
- ËøôÊòØÁ∫ø‰∏äËÅäÂ§©ÔºåÂè™ËÉΩÂèëÈÄÅÁ∫ØÊñáÊú¨ÔºåÁ¶ÅÊ≠¢‰ΩøÁî®Âä®‰ΩúÊèèËø∞
- ÊØèÊù°Ê∂àÊÅØË¶ÅÁÆÄÁü≠ÔºåÂÉèÁúüÂÆûËÅäÂ§©‰∏ÄÊ†∑ÊãÜÂàÜ‰∏∫Â§öÊù°
- Á¶ÅÊ≠¢‰ΩøÁî®ÊòüÂè∑ÂåÖË£πÁöÑÂä®‰ΩúÊèèËø∞ÔºàÂ¶Ç*ÂæÆÁ¨ë*Ôºâ

## Ë¶ÅÊ±Ç
- ÂõûÁ≠îË¶ÅÁ¨¶Âêà‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†ºÂíåËØ¥ËØùÊñπÂºè
- ‰øùÊåÅÂØπËØùËá™ÁÑ∂ÊµÅÁïÖ
- **Áõ¥Êé•ËæìÂá∫JSONÊï∞ÁªÑÔºå‰∏çË¶ÅÊ∑ªÂä†\`\`\`jsonÁ≠âÊ†áËÆ∞Ôºå‰∏çË¶ÅËæìÂá∫‰ªª‰ΩïÂ§ö‰ΩôÁöÑÂàÜÊûêÊñáÊú¨„ÄÇ**`;
      }

      return prompt;
    }

    let activeTruthGameMessageTimestamp = null;

    function showTruthGameMessageActions(timestamp) {
      activeTruthGameMessageTimestamp = timestamp;
      const message = truthGameState.messages.find(m => m.timestamp === timestamp);

      document.getElementById('message-actions-modal').classList.add('visible');

      // ÊòæÁ§∫ÈúÄË¶ÅÁöÑÊåâÈíÆ
      document.getElementById('edit-message-btn').style.display = 'block';
      document.getElementById('edit-message-btn').textContent = 'ÁºñËæë';
      document.getElementById('copy-message-btn').style.display = 'block';
      document.getElementById('recall-message-btn').style.display = 'block';
      document.getElementById('recall-message-btn').textContent = message.role === 'assistant' ? 'ÈáçËØ¥' : 'Âà†Èô§';

      // ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÊåâÈíÆ
      document.getElementById('copy-timestamp-btn').style.display = 'none';
      document.getElementById('translate-message-btn').style.display = 'none';
      document.getElementById('publish-to-announcement-btn').style.display = 'none';
      document.getElementById('quote-message-btn').style.display = 'none';
      document.getElementById('forward-message-btn').style.display = 'none';
      document.getElementById('select-message-btn').style.display = 'none';
    }

    const truthGameOriginalHandlers = {
      cancel: null,
      copy: null,
      copyTimestamp: null,
      translate: null,
      edit: null,
      recall: null
    };

    function closeTruthGameMessageActions() {
      document.getElementById('message-actions-modal').classList.remove('visible');
      activeTruthGameMessageTimestamp = null;
      document.getElementById('recall-message-btn').textContent = 'Êí§Âõû';
    }

    function restoreNormalMessageActions() {
      // ÊÅ¢Â§çÊâÄÊúâÊ≠£Â∏∏Ê∂àÊÅØËèúÂçïÊåâÈíÆÁöÑÊòæÁ§∫Áä∂ÊÄÅ
      document.getElementById('edit-message-btn').style.display = 'block';
      document.getElementById('copy-message-btn').style.display = 'block';
      document.getElementById('copy-timestamp-btn').style.display = 'block';
      document.getElementById('translate-message-btn').style.display = 'block';
      document.getElementById('recall-message-btn').style.display = 'block';
      document.getElementById('quote-message-btn').style.display = 'block';
      document.getElementById('forward-message-btn').style.display = 'block';
      document.getElementById('select-message-btn').style.display = 'block';
      document.getElementById('recall-message-btn').textContent = 'Êí§Âõû';

      // ÈáçÁΩÆactiveTruthGameMessageTimestamp
      activeTruthGameMessageTimestamp = null;
    }

    document.getElementById('cancel-message-action-btn').addEventListener('click', () => {
      if (activeTruthGameMessageTimestamp) {
        closeTruthGameMessageActions();
      } else if (activeWatchTogetherMessageTimestamp) {
        closeWatchTogetherMessageActions();
      }
    });

    document.getElementById('copy-message-btn').addEventListener('click', () => {
      if (activeTruthGameMessageTimestamp) {
        const message = truthGameState.messages.find(m => m.timestamp === activeTruthGameMessageTimestamp);
        if (message) {
          navigator.clipboard.writeText(message.content);
          closeTruthGameMessageActions();
        }
      } else if (activeWatchTogetherMessageTimestamp) {
        const message = watchTogetherState.messages.find(m => m.timestamp === activeWatchTogetherMessageTimestamp);
        if (message) {
          navigator.clipboard.writeText(message.content);
          closeWatchTogetherMessageActions();
        }
      }
    });

    document.getElementById('copy-timestamp-btn').addEventListener('click', () => {
      if (activeTruthGameMessageTimestamp) {
        const date = new Date(activeTruthGameMessageTimestamp);
        const timeStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
        navigator.clipboard.writeText(timeStr);
        closeTruthGameMessageActions();
      }
    });

    document.getElementById('translate-message-btn').addEventListener('click', async () => {
      if (activeTruthGameMessageTimestamp) {
        const message = truthGameState.messages.find(m => m.timestamp === activeTruthGameMessageTimestamp);
        if (message && message.content) {
          closeTruthGameMessageActions();

          try {
            await showCustomAlert('ÁøªËØë‰∏≠...', 'Ê≠£Âú®Ë∞ÉÁî®ÁøªËØëÊúçÂä°ÔºåËØ∑Á®çÂÄô...');
            const textToSend = message.content.length > 500 ? message.content.substring(0, 500) + '...' : message.content;

            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
              await showCustomAlert('ÁøªËØëÂ§±Ë¥•', 'ËØ∑ÂÖàÈÖçÁΩÆAPIËÆæÁΩÆ„ÄÇ');
              return;
            }

            const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: model,
                messages: [{
                  role: 'user',
                  content: `ËØ∑Â∞Ü‰ª•‰∏ãÂÜÖÂÆπÁøªËØëÊàê‰∏≠ÊñáÔºåÂè™ËæìÂá∫ÁøªËØëÁªìÊûúÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïËß£ÈáäÔºö\n\n${textToSend}`
                }],
                temperature: 0.3
              })
            });

            if (!response.ok) throw new Error('ÁøªËØëÂ§±Ë¥•');

            const data = await response.json();
            const translation = data.choices[0].message.content.trim();

            await showCustomAlert('ÁøªËØëÁªìÊûú', translation);
          } catch (error) {
            await showCustomAlert('ÁøªËØëÂ§±Ë¥•', 'ÁøªËØëÊúçÂä°Âá∫ÈîôÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ');
          }
        }
      }
    });

    document.getElementById('edit-message-btn').addEventListener('click', async () => {
      if (activeTruthGameMessageTimestamp) {
        const message = truthGameState.messages.find(m => m.timestamp === activeTruthGameMessageTimestamp);
        if (message) {
          closeTruthGameMessageActions();

          const newContent = await showCustomPrompt('ÁºñËæëÊ∂àÊÅØÂÜÖÂÆπ', '', message.content, 'textarea');
          if (newContent !== null && newContent.trim() !== '') {
            message.content = newContent.trim();
            renderTruthGameMessages();
          }
        }
      } else if (activeWatchTogetherMessageTimestamp) {
        const message = watchTogetherState.messages.find(m => m.timestamp === activeWatchTogetherMessageTimestamp);
        if (message) {
          closeWatchTogetherMessageActions();

          const newContent = await showCustomPrompt('ÁºñËæëÊ∂àÊÅØÂÜÖÂÆπ', '', message.content, 'textarea');
          if (newContent !== null && newContent.trim() !== '') {
            message.content = newContent.trim();
            renderWatchTogetherMessages();
          }
        }
      }
    });

    document.getElementById('recall-message-btn').addEventListener('click', async () => {
      if (activeTruthGameMessageTimestamp) {
        const targetTimestamp = activeTruthGameMessageTimestamp;
        const message = truthGameState.messages.find(m => m.timestamp === targetTimestamp);
        if (!message) return;

        closeTruthGameMessageActions();

        if (message.role === 'assistant') {
          const chat = state.chats[state.activeChatId];
          const { proxyUrl, apiKey, model } = state.apiConfig;

          if (!proxyUrl || !apiKey || !model) {
            alert('ËØ∑ÂÖàÈÖçÁΩÆAPIËÆæÁΩÆ„ÄÇ');
            return;
          }

          const messageIndex = truthGameState.messages.findIndex(m => m.timestamp === targetTimestamp);
          if (messageIndex === -1) return;

          const previousMessage = truthGameState.messages[messageIndex - 1];

          truthGameState.waitingForAI = true;
          addTruthGameMessage('system', 'Ê≠£Âú®ÈáçÊñ∞ÁîüÊàê...');

          let prompt = '';
          if (previousMessage && previousMessage.role === 'user') {
            if (truthGameState.winner === 'ai') {
              prompt = buildTruthGamePrompt(chat, 'question');
            } else if (truthGameState.winner === 'user') {
              prompt = buildTruthGamePrompt(chat, 'answer', previousMessage.content);
            } else {
              prompt = buildTruthGamePrompt(chat, 'conversation');
            }
          } else {
            prompt = buildTruthGamePrompt(chat, 'conversation');
          }

          // ÂàõÂª∫AbortControllerÁî®‰∫é‰∏≠Êñ≠ËØ∑Ê±Ç
          truthGameState.abortController = new AbortController();
          const timeoutId = setTimeout(() => truthGameState.abortController.abort(), 60000); // 60ÁßíË∂ÖÊó∂

          try {
            const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: model,
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.8
              }),
              signal: truthGameState.abortController.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) throw new Error('APIË∞ÉÁî®Â§±Ë¥•');

            const data = await response.json();
            const rawContent = data.choices[0].message.content.trim();

            // ‰ΩøÁî®ÊàêÁÜüÁöÑparseAiResponseÂáΩÊï∞Ëß£ÊûêÔºàÂíåÂçïËÅä‰∏ÄÊ†∑Ôºâ
            const messagesArray = parseAiResponse(rawContent);

            // ÊèêÂèñÁ¨¨‰∏ÄÊù°ÊúâÊïàÁöÑtextÂÜÖÂÆπ‰Ωú‰∏∫Êñ∞ÂõûÂ§ç
            const validMessages = messagesArray
              .filter(item => item && (item.type === 'text' || item.type === 'offline_text'))
              .map(item => item.content)
              .filter(text => text && text.trim().length > 0);

            const newReply = validMessages.length > 0 ? validMessages[0] : rawContent;

            message.content = newReply;
            truthGameState.messages = truthGameState.messages.filter(m => m.role !== 'system' || !m.content.includes('Ê≠£Âú®ÈáçÊñ∞ÁîüÊàê'));
            renderTruthGameMessages();
          } catch (error) {
            clearTimeout(timeoutId);

            // Â¶ÇÊûúÊòØÁî®Êà∑‰∏ªÂä®ÂèñÊ∂àÔºå‰∏çÊòæÁ§∫ÈîôËØØ
            if (error.name === 'AbortError') {
              console.log('ÁúüÂøÉËØùÈáçËØ¥Ë¢´Áî®Êà∑‰∏≠Êñ≠');
            } else {
              console.error('ÈáçËØ¥Â§±Ë¥•:', error);
              alert('ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•Ôºö' + error.message);
            }

            truthGameState.messages = truthGameState.messages.filter(m => m.role !== 'system' || !m.content.includes('Ê≠£Âú®ÈáçÊñ∞ÁîüÊàê'));
            if (error.name !== 'AbortError') {
              addTruthGameMessage('system', 'ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ');
            }
          } finally {
            truthGameState.waitingForAI = false;
            truthGameState.abortController = null;
          }
        } else {
          const confirmed = await showCustomConfirm('Âà†Èô§Ê∂àÊÅØ', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü', {
            confirmButtonClass: 'btn-danger'
          });
          if (confirmed) {
            truthGameState.messages = truthGameState.messages.filter(m => m.timestamp !== targetTimestamp);
            renderTruthGameMessages();
          }
        }
      } else if (activeWatchTogetherMessageTimestamp) {
        // ËßÇÂΩ±Ê∂àÊÅØÁöÑÊí§Âõû/Âà†Èô§/ÈáçËØ¥
        const targetTimestamp = activeWatchTogetherMessageTimestamp;
        const message = watchTogetherState.messages.find(m => m.timestamp === targetTimestamp);
        if (!message) return;

        closeWatchTogetherMessageActions();

        if (message.role === 'assistant') {
          // AIÊ∂àÊÅØÔºöÈáçËØ¥
          const confirmed = await showCustomConfirm('ÈáçËØ¥', 'Á°ÆÂÆöË¶ÅËÆ©AIÈáçÊñ∞ÁîüÊàêËøôÊù°Ê∂àÊÅØÂêóÔºü');
          if (!confirmed) return;

          // Ë∞ÉÁî®APIÈáçÊñ∞ÁîüÊàê
          const messageIndex = watchTogetherState.messages.findIndex(m => m.timestamp === targetTimestamp);
          if (messageIndex === -1) return;

          // Âà†Èô§ËøôÊù°AIÊ∂àÊÅØÂèäÂÖ∂ÂêéÁöÑÊâÄÊúâÊ∂àÊÅØ
          watchTogetherState.messages = watchTogetherState.messages.slice(0, messageIndex);
          renderWatchTogetherMessages();

          // Ë∞ÉÁî®API
          callWatchTogetherAPI();
        } else {
          // Áî®Êà∑Ê∂àÊÅØÔºöÂà†Èô§
          const confirmed = await showCustomConfirm('Âà†Èô§Ê∂àÊÅØ', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü', {
            confirmButtonClass: 'btn-danger'
          });
          if (confirmed) {
            watchTogetherState.messages = watchTogetherState.messages.filter(m => m.timestamp !== targetTimestamp);
            renderWatchTogetherMessages();
          }
        }
      }
    });
    // ========== ÁúüÂøÉËØùÊ∏∏ÊàèÁªìÊùü ==========

    // ========== ‰∏ÄËµ∑ÁúãÁîµÂΩ±ÂäüËÉΩ ==========
    let watchTogetherState = {
      isActive: false,
      chatId: null,
      videoUrl: null,
      mode: 'online', // ÈªòËÆ§Á∫ø‰∏äÊ®°Âºè
      captureInterval: 5,
      speechApi: 'none', // ÈªòËÆ§‰∏çËØÜÂà´
      whisperKey: '',
      whisperUrl: 'https://api.openai.com/v1/audio/transcriptions',
      maxScreenshots: 10, // ËÆ∞‰ΩèÂéÜÂè≤Êà™ÂõæÊï∞Èáè
      maxAudios: 10, // ËÆ∞‰ΩèÂéÜÂè≤Â£∞Èü≥Êï∞Èáè
      maxMessages: 20, // ËÆ∞‰ΩèÊúÄËøëÂØπËØùÊù°Êï∞
      messages: [],
      captureTimer: null,
      speechRecognition: null,
      audioContext: null,
      mediaRecorder: null,
      audioChunks: [],
      corsWarningShown: false, // Ë∑®ÂüüË≠¶ÂëäÊòØÂê¶Â∑≤ÊòæÁ§∫
      hlsInstance: null // HLS.js ÂÆû‰æã
    };

    // ÊâìÂºÄËßÇÂΩ±ÁïåÈù¢
    document.getElementById('open-watch-together-btn').addEventListener('click', () => {
      if (!state.activeChatId) {
        alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©ÂØπË±°ÔºÅ');
        return;
      }
      const chat = state.chats[state.activeChatId];
      if (chat.isGroup) {
        alert('‰∏ÄËµ∑ÁúãÁîµÂΩ±ÂäüËÉΩ‰ªÖÊîØÊåÅÂçï‰∫∫ËÅäÂ§©ÔºÅ');
        return;
      }

      watchTogetherState.isActive = true;
      watchTogetherState.chatId = state.activeChatId;
      watchTogetherState.messages = [];

      document.getElementById('watch-together-modal').classList.add('visible');
      document.getElementById('watch-together-chat-name').textContent = chat.name;

      // Âä†ËΩΩ‰øùÂ≠òÁöÑËÆæÁΩÆ
      if (chat.watchTogetherSettings) {
        watchTogetherState.mode = chat.watchTogetherSettings.mode || 'online';
        watchTogetherState.captureInterval = chat.watchTogetherSettings.captureInterval || 5;
        watchTogetherState.speechApi = chat.watchTogetherSettings.speechApi || 'none';
        watchTogetherState.whisperKey = chat.watchTogetherSettings.whisperKey || '';
        watchTogetherState.whisperUrl = chat.watchTogetherSettings.whisperUrl || 'https://api.openai.com/v1/audio/transcriptions';
        watchTogetherState.maxScreenshots = chat.watchTogetherSettings.maxScreenshots || 10;
        watchTogetherState.maxAudios = chat.watchTogetherSettings.maxAudios || 10;
        watchTogetherState.maxMessages = chat.watchTogetherSettings.maxMessages || 20;
      }

      // ‰ΩøËÅäÂ§©Ê°ÜÂèØÊãñÂä®
      setTimeout(() => {
        makeDraggable(document.getElementById('watch-together-chat-float'), document.getElementById('watch-together-chat-header'));
      }, 100);

      renderWatchTogetherMessages();
    });

    // ÂÖ≥Èó≠ËßÇÂΩ±ÁïåÈù¢
    document.getElementById('close-watch-together-btn').addEventListener('click', () => {
      stopWatchTogether();
    });

    // ‰∏ä‰º†ÊåâÈíÆ
    document.getElementById('watch-together-upload-btn').addEventListener('click', () => {
      document.getElementById('watch-together-upload-modal').classList.add('visible');
    });

    // Êú¨Âú∞‰∏ä‰º†
    document.getElementById('watch-together-upload-local').addEventListener('click', () => {
      document.getElementById('watch-together-file-input').click();
      document.getElementById('watch-together-upload-modal').classList.remove('visible');
    });

    // URL‰∏ä‰º†
    document.getElementById('watch-together-upload-url').addEventListener('click', () => {
      document.getElementById('watch-together-upload-modal').classList.remove('visible');
      document.getElementById('watch-together-url-modal').classList.add('visible');
    });

    // Âú®Á∫øÊêúÁ¥¢
    const searchOnlineBtn = document.getElementById('watch-together-search-online');
    if (searchOnlineBtn) {
      searchOnlineBtn.addEventListener('click', () => {
        console.log('ÁÇπÂáª‰∫ÜÂú®Á∫øÊêúÁ¥¢ÊåâÈíÆ');
        document.getElementById('watch-together-upload-modal').classList.remove('visible');
        document.getElementById('watch-together-search-modal').classList.add('visible');
      });
    } else {
      console.error('Êâæ‰∏çÂà∞Âú®Á∫øÊêúÁ¥¢ÊåâÈíÆ');
    }

    // ÂèñÊ∂à‰∏ä‰º†
    document.getElementById('cancel-watch-together-upload-btn').addEventListener('click', () => {
      document.getElementById('watch-together-upload-modal').classList.remove('visible');
    });

    // Êñá‰ª∂ÈÄâÊã©
    document.getElementById('watch-together-file-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        loadWatchTogetherVideo(file);
      }
    });

    // URLÁ°ÆËÆ§
    document.getElementById('confirm-watch-together-url-btn').addEventListener('click', () => {
      const url = document.getElementById('watch-together-url-input').value.trim();
      if (url) {
        loadWatchTogetherVideoFromUrl(url);
        document.getElementById('watch-together-url-modal').classList.remove('visible');
        document.getElementById('watch-together-url-input').value = '';
      }
    });

    // ÂèñÊ∂àURL
    document.getElementById('cancel-watch-together-url-btn').addEventListener('click', () => {
      document.getElementById('watch-together-url-modal').classList.remove('visible');
    });

    // ÂèñÊ∂àÊêúÁ¥¢
    const cancelSearchBtn = document.getElementById('cancel-watch-together-search-btn');
    if (cancelSearchBtn) {
      cancelSearchBtn.addEventListener('click', () => {
        document.getElementById('watch-together-search-modal').classList.remove('visible');
      });
    }

    // ÊêúÁ¥¢ÊåâÈíÆ
    const searchBtn = document.getElementById('watch-together-search-btn');
    if (searchBtn) {
      searchBtn.addEventListener('click', () => {
        const keyword = document.getElementById('watch-together-search-input').value.trim();
        if (keyword) {
          searchMovies(keyword);
        }
      });
    }

    // ÊêúÁ¥¢Ê°ÜÂõûËΩ¶
    const watchTogetherSearchInput = document.getElementById('watch-together-search-input');
    if (watchTogetherSearchInput) {
      watchTogetherSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const keyword = e.target.value.trim();
          if (keyword) {
            searchMovies(keyword);
          }
        }
      });
    }

    // Êí≠ÊîæÂàóË°®ÊåâÈíÆ
    document.getElementById('watch-together-playlist-btn').addEventListener('click', () => {
      openPlaylist();
    });

    // ÂÖ≥Èó≠Êí≠ÊîæÂàóË°®
    document.getElementById('close-watch-together-playlist-btn').addEventListener('click', () => {
      document.getElementById('watch-together-playlist-modal').classList.remove('visible');
    });

    document.getElementById('cancel-watch-together-playlist-btn').addEventListener('click', () => {
      document.getElementById('watch-together-playlist-modal').classList.remove('visible');
    });

    // ‰øùÂ≠òËßÜÈ¢ëÂà∞Êí≠ÊîæÂàóË°®
    document.getElementById('confirm-save-video-btn').addEventListener('click', () => {
      saveVideoToPlaylist();
    });

    document.getElementById('cancel-save-video-btn').addEventListener('click', () => {
      document.getElementById('watch-together-save-video-modal').classList.remove('visible');
    });

    // ËÆæÁΩÆÊåâÈíÆ
    document.getElementById('watch-together-settings-btn').addEventListener('click', () => {
      loadWatchTogetherSettings();
      document.getElementById('watch-together-settings-modal').classList.add('visible');
    });

    // ËØ≠Èü≥APIÈÄâÊã©
    document.getElementById('watch-together-speech-api-select').addEventListener('change', (e) => {
      const whisperConfig = document.getElementById('watch-together-whisper-config');
      whisperConfig.style.display = e.target.value === 'whisper' ? 'block' : 'none';
    });

    // ‰øùÂ≠òËÆæÁΩÆ
    document.getElementById('save-watch-together-settings-btn').addEventListener('click', () => {
      saveWatchTogetherSettings();
      document.getElementById('watch-together-settings-modal').classList.remove('visible');
    });

    // ÂèñÊ∂àËÆæÁΩÆ
    document.getElementById('cancel-watch-together-settings-btn').addEventListener('click', () => {
      document.getElementById('watch-together-settings-modal').classList.remove('visible');
    });

    // ËÅäÂ§©Ê°ÜÊî∂Ëµ∑/Â±ïÂºÄ
    document.getElementById('watch-together-chat-toggle').addEventListener('click', () => {
      const chatFloat = document.getElementById('watch-together-chat-float');
      const isMinimized = chatFloat.classList.contains('minimized');

      if (isMinimized) {
        chatFloat.classList.remove('minimized');
        document.getElementById('watch-together-chat-toggle').textContent = '-';
      } else {
        chatFloat.classList.add('minimized');
        document.getElementById('watch-together-chat-toggle').textContent = '+';
      }
    });

    // ÂèëÈÄÅÊ∂àÊÅØ
    document.getElementById('watch-together-chat-send').addEventListener('click', () => {
      sendWatchTogetherUserMessage();
    });

    // Ë∞ÉÁî®API
    document.getElementById('watch-together-call-api-btn').addEventListener('click', () => {
      callWatchTogetherAPI();
    });

    // ÂõûËΩ¶ÂèëÈÄÅ
    document.getElementById('watch-together-chat-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendWatchTogetherUserMessage();
      }
    });

    // Âä†ËΩΩËßÜÈ¢ëÔºàÊú¨Âú∞Êñá‰ª∂Ôºâ
    function loadWatchTogetherVideo(file, skipSavePrompt = false) {
      const video = document.getElementById('watch-together-video');
      const placeholder = document.getElementById('watch-together-placeholder');

      const url = URL.createObjectURL(file);
      video.src = url;
      video.style.display = 'block';
      placeholder.style.display = 'none';

      watchTogetherState.videoUrl = url;
      watchTogetherState.corsWarningShown = false; // ÈáçÁΩÆË∑®ÂüüË≠¶Âëä

      // Â≠òÂÇ®ÂΩìÂâçËßÜÈ¢ë‰ø°ÊÅØÔºåÁî®‰∫é‰øùÂ≠òÂà∞Êí≠ÊîæÂàóË°®
      watchTogetherState.currentVideoFile = file;
      watchTogetherState.currentVideoUrl = null;

      // ÂºÄÂßãÁõëÂê¨
      startWatchTogetherMonitoring();

      addWatchTogetherSystemMessage('ËßÜÈ¢ëÂ∑≤Âä†ËΩΩÔºåÂºÄÂßãËßÇÁúã');

      // ÊèêÁ§∫Áî®Êà∑ÊòØÂê¶‰øùÂ≠òÂà∞Êí≠ÊîæÂàóË°®
      if (!skipSavePrompt) {
        setTimeout(() => {
          promptSaveVideoToPlaylist(file.name);
        }, 1000);
      }
    }

    // Âä†ËΩΩËßÜÈ¢ëÔºàURLÔºâ
    function loadWatchTogetherVideoFromUrl(url, skipSavePrompt = false) {
      const video = document.getElementById('watch-together-video');
      const placeholder = document.getElementById('watch-together-placeholder');

      // ÈîÄÊØÅ‰πãÂâçÁöÑ HLS ÂÆû‰æã
      if (watchTogetherState.hlsInstance) {
        watchTogetherState.hlsInstance.destroy();
        watchTogetherState.hlsInstance = null;
      }

      video.style.display = 'block';
      placeholder.style.display = 'none';

      watchTogetherState.videoUrl = url;
      watchTogetherState.corsWarningShown = false;
      watchTogetherState.currentVideoFile = null;
      watchTogetherState.currentVideoUrl = url;

      const isHls = /\.m3u8(\?|$)/i.test(url);

      if (isHls && typeof Hls !== 'undefined' && Hls.isSupported()) {
        // Android / Chrome Á≠â‰∏çÂéüÁîüÊîØÊåÅ HLS ÁöÑÊµèËßàÂô®ÔºåÁî® hls.js
        const hls = new Hls({
          xhrSetup: function(xhr) {
            // ‰∏çËÆæÁΩÆ withCredentialsÔºåÈÅøÂÖç CORS ÈóÆÈ¢ò
          }
        });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          video.play().catch(() => {});
        });
        hls.on(Hls.Events.ERROR, (event, data) => {
          if (data.fatal) {
            console.error('[‰∏ÄËµ∑ÁúãÁîµÂΩ±] HLS Ëá¥ÂëΩÈîôËØØ:', data.type, data.details);
            if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
              addWatchTogetherSystemMessage('ËßÜÈ¢ëÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞ùËØïÈáçÊñ∞ËøûÊé•...');
              hls.startLoad();
            } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
              addWatchTogetherSystemMessage('Â™í‰ΩìËß£Á†ÅÈîôËØØÔºåÂ∞ùËØïÊÅ¢Â§ç...');
              hls.recoverMediaError();
            } else {
              addWatchTogetherSystemMessage('ËßÜÈ¢ëÊí≠ÊîæÂ§±Ë¥•ÔºåËØ•Êí≠ÊîæÊ∫êÂèØËÉΩ‰∏çÂèØÁî®');
              hls.destroy();
              watchTogetherState.hlsInstance = null;
            }
          }
        });
        watchTogetherState.hlsInstance = hls;
        // hls.js ÁÆ°ÁêÜ crossOriginÔºå‰∏çÈúÄË¶ÅÊâãÂä®ËÆæÁΩÆ
        video.removeAttribute('crossorigin');
      } else if (isHls && video.canPlayType('application/vnd.apple.mpegurl')) {
        // iOS Safari ÂéüÁîüÊîØÊåÅ HLS
        video.src = url;
        video.addEventListener('loadedmetadata', () => {
          video.play().catch(() => {});
        }, { once: true });
      } else {
        // ÊôÆÈÄöËßÜÈ¢ëÊñá‰ª∂Ôºàmp4 Á≠âÔºâ
        video.crossOrigin = 'anonymous';
        video.src = url;

        // Â¶ÇÊûúËÆæÁΩÆ crossOrigin ÂêéÂä†ËΩΩÂ§±Ë¥•ÔºåÂéªÊéâ crossOrigin ÈáçËØï
        video.onerror = () => {
          if (video.crossOrigin) {
            console.warn('[‰∏ÄËµ∑ÁúãÁîµÂΩ±] Ë∑®ÂüüÂä†ËΩΩÂ§±Ë¥•ÔºåÂéªÊéâ crossOrigin ÈáçËØï');
            video.removeAttribute('crossorigin');
            video.src = url;
            video.onerror = null; // ÈÅøÂÖçÊó†ÈôêÈáçËØï
          }
        };
      }

      // ÂºÄÂßãÁõëÂê¨
      startWatchTogetherMonitoring();

      addWatchTogetherSystemMessage('ËßÜÈ¢ëÂ∑≤Âä†ËΩΩÔºåÂºÄÂßãËßÇÁúã');

      // ÊèêÁ§∫Áî®Êà∑ÊòØÂê¶‰øùÂ≠òÂà∞Êí≠ÊîæÂàóË°®
      if (!skipSavePrompt) {
        setTimeout(() => {
          const urlParts = url.split('/');
          const fileName = urlParts[urlParts.length - 1] || 'Âú®Á∫øËßÜÈ¢ë';
          promptSaveVideoToPlaylist(fileName);
        }, 1000);
      }
    }

    // ========== Êí≠ÊîæÂàóË°®ÂäüËÉΩ ==========

    // ÊèêÁ§∫‰øùÂ≠òËßÜÈ¢ëÂà∞Êí≠ÊîæÂàóË°®
    async function promptSaveVideoToPlaylist(defaultName) {
      const result = await showCustomConfirm('‰øùÂ≠òÂà∞Êí≠ÊîæÂàóË°®', 'ÊòØÂê¶Â∞ÜÂΩìÂâçËßÜÈ¢ë‰øùÂ≠òÂà∞Êí≠ÊîæÂàóË°®Ôºü');
      if (result) {
        openSaveVideoModal(defaultName);
      }
    }

    // ÊâìÂºÄ‰øùÂ≠òËßÜÈ¢ëÂØπËØùÊ°Ü
    function openSaveVideoModal(defaultName) {
      const input = document.getElementById('watch-together-video-name-input');
      input.value = defaultName.replace(/\.[^/.]+$/, ''); // ÁßªÈô§Êñá‰ª∂Êâ©Â±ïÂêç
      document.getElementById('watch-together-save-video-modal').classList.add('visible');
      input.focus();
    }

    // ‰øùÂ≠òËßÜÈ¢ëÂà∞Êí≠ÊîæÂàóË°®
    async function saveVideoToPlaylist() {
      const name = document.getElementById('watch-together-video-name-input').value.trim();
      if (!name) {
        await showCustomAlert('ÊèêÁ§∫', 'ËØ∑ËæìÂÖ•ËßÜÈ¢ëÂêçÁß∞');
        return;
      }

      const videoData = {
        name: name,
        timestamp: Date.now()
      };

      // ‰øùÂ≠òËßÜÈ¢ëÊñá‰ª∂ÊàñURL
      if (watchTogetherState.currentVideoFile) {
        // Êú¨Âú∞Êñá‰ª∂ - ËΩ¨‰∏∫base64Â≠òÂÇ®
        const reader = new FileReader();
        reader.onload = async (e) => {
          videoData.data = e.target.result;
          videoData.type = 'file';
          await db.watchTogetherPlaylist.add(videoData);
          await showCustomAlert('ÊàêÂäü', 'ËßÜÈ¢ëÂ∑≤‰øùÂ≠òÂà∞Êí≠ÊîæÂàóË°®');
          document.getElementById('watch-together-save-video-modal').classList.remove('visible');
        };
        reader.readAsDataURL(watchTogetherState.currentVideoFile);
      } else if (watchTogetherState.currentVideoUrl) {
        // URL
        videoData.data = watchTogetherState.currentVideoUrl;
        videoData.type = 'url';
        await db.watchTogetherPlaylist.add(videoData);
        await showCustomAlert('ÊàêÂäü', 'ËßÜÈ¢ëÂ∑≤‰øùÂ≠òÂà∞Êí≠ÊîæÂàóË°®');
        document.getElementById('watch-together-save-video-modal').classList.remove('visible');
      } else {
        await showCustomAlert('ÈîôËØØ', 'Êú™ÊâæÂà∞ËßÜÈ¢ëÊï∞ÊçÆ');
      }
    }

    // ÊâìÂºÄÊí≠ÊîæÂàóË°®
    async function openPlaylist() {
      await renderPlaylist();
      document.getElementById('watch-together-playlist-modal').classList.add('visible');
    }

    // Ê∏≤ÊüìÊí≠ÊîæÂàóË°®
    async function renderPlaylist() {
      const listEl = document.getElementById('watch-together-playlist-list');
      const videos = await db.watchTogetherPlaylist.orderBy('timestamp').reverse().toArray();

      if (videos.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ÊöÇÊó†ËßÜÈ¢ëÔºå‰∏ä‰º†ËßÜÈ¢ëÂêéÂèØ‰øùÂ≠òÂà∞ÂàóË°®</p>';
        return;
      }

      listEl.innerHTML = videos.map(video => `
        <div class="playlist-item" data-id="${video.id}">
          <div class="playlist-item-info">
            <div class="playlist-item-name">${video.name}</div>
            <div class="playlist-item-time">${new Date(video.timestamp).toLocaleString()}</div>
            <div class="playlist-item-type">${video.type === 'file' ? 'Êú¨Âú∞Êñá‰ª∂' : 'Âú®Á∫øËßÜÈ¢ë'}</div>
          </div>
          <div class="playlist-item-actions">
            <button class="playlist-play-btn" onclick="playFromPlaylist(${video.id})">Êí≠Êîæ</button>
            <button class="playlist-delete-btn" onclick="deleteFromPlaylist(${video.id})">Âà†Èô§</button>
          </div>
        </div>
      `).join('');
    }

    // ‰ªéÊí≠ÊîæÂàóË°®Êí≠ÊîæËßÜÈ¢ë
    window.playFromPlaylist = async function (id) {
      const video = await db.watchTogetherPlaylist.get(id);
      if (!video) {
        await showCustomAlert('ÈîôËØØ', 'Êú™ÊâæÂà∞ËßÜÈ¢ë');
        return;
      }

      document.getElementById('watch-together-playlist-modal').classList.remove('visible');

      if (video.type === 'file') {
        // ‰ªébase64ÊÅ¢Â§çÊñá‰ª∂
        const response = await fetch(video.data);
        const blob = await response.blob();
        const file = new File([blob], video.name, { type: blob.type });
        loadWatchTogetherVideo(file, true);
      } else if (video.type === 'url') {
        loadWatchTogetherVideoFromUrl(video.data, true);
      }
    };

    // ‰ªéÊí≠ÊîæÂàóË°®Âà†Èô§ËßÜÈ¢ë
    window.deleteFromPlaylist = async function (id) {
      const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Á°ÆÂÆöË¶Å‰ªéÊí≠ÊîæÂàóË°®‰∏≠Âà†Èô§Ëøô‰∏™ËßÜÈ¢ëÂêóÔºü');
      if (confirmed) {
        await db.watchTogetherPlaylist.delete(id);
        await renderPlaylist();
      }
    };

    // ========== Êí≠ÊîæÂàóË°®ÂäüËÉΩÁªìÊùü ==========

    // ÂºÄÂßãÁõëÂê¨ÔºàÊà™Âõæ+ËØ≠Èü≥ËØÜÂà´Ôºâ
    function startWatchTogetherMonitoring() {
      const video = document.getElementById('watch-together-video');

      // ÂêØÂä®ËØ≠Èü≥ËØÜÂà´ÔºàÂ¶ÇÊûúÂêØÁî®Ôºâ
      if (watchTogetherState.speechApi === 'whisper') {
        // ÂàùÂßãÂåñÈü≥È¢ë‰∏ä‰∏ãÊñá
        if (!watchTogetherState.audioContext) {
          watchTogetherState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        // ÂàõÂª∫Èü≥È¢ëÊ∫ê
        const source = watchTogetherState.audioContext.createMediaElementSource(video);
        const destination = watchTogetherState.audioContext.createMediaStreamDestination();
        source.connect(destination);
        source.connect(watchTogetherState.audioContext.destination);

        // ÂêØÂä® Whisper ÂΩïÈü≥
        startWhisperRecording(destination.stream);
      } else if (watchTogetherState.speechApi === 'none') {
        console.log('Â∑≤Á¶ÅÁî®ËØ≠Èü≥ËØÜÂà´');
      }

      // ÂêØÂä®Êà™ÂõæÂÆöÊó∂Âô®
      startCaptureTimer();
    }

    // WhisperÂΩïÈü≥
    function startWhisperRecording(stream) {
      if (!MediaRecorder.isTypeSupported('audio/webm')) {
        console.warn('ÊµèËßàÂô®‰∏çÊîØÊåÅMediaRecorder');
        return;
      }

      const mediaRecorder = new MediaRecorder(stream);
      watchTogetherState.mediaRecorder = mediaRecorder;
      watchTogetherState.audioChunks = [];

      mediaRecorder.ondataavailable = (event) => {
        watchTogetherState.audioChunks.push(event.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(watchTogetherState.audioChunks, { type: 'audio/webm' });
        watchTogetherState.audioChunks = [];

        // ÂèëÈÄÅÂà∞Whisper API
        const transcript = await transcribeWithWhisper(audioBlob);
        if (transcript) {
          addWatchTogetherContextMessage('ËØ≠Èü≥ËØÜÂà´', transcript);
        }

        // ÁªßÁª≠ÂΩïÂà∂
        if (watchTogetherState.isActive && watchTogetherState.mediaRecorder) {
          watchTogetherState.audioChunks = [];
          watchTogetherState.mediaRecorder.start();
          setTimeout(() => {
            if (watchTogetherState.mediaRecorder && watchTogetherState.mediaRecorder.state === 'recording') {
              watchTogetherState.mediaRecorder.stop();
            }
          }, watchTogetherState.captureInterval * 1000);
        }
      };

      mediaRecorder.start();
      setTimeout(() => {
        if (mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        }
      }, watchTogetherState.captureInterval * 1000);
    }

    // Whisper APIËΩ¨ÂΩï
    async function transcribeWithWhisper(audioBlob) {
      try {
        const formData = new FormData();
        formData.append('file', audioBlob, 'audio.webm');
        formData.append('model', 'whisper-1');

        const response = await fetch(watchTogetherState.whisperUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${watchTogetherState.whisperKey}`
          },
          body: formData
        });

        if (!response.ok) {
          throw new Error('Whisper APIË∞ÉÁî®Â§±Ë¥•');
        }

        const data = await response.json();
        return data.text;
      } catch (error) {
        console.error('WhisperËΩ¨ÂΩïÂ§±Ë¥•:', error);
        return null;
      }
    }

    // ÂêØÂä®Êà™ÂõæÂÆöÊó∂Âô®
    function startCaptureTimer() {
      if (watchTogetherState.captureTimer) {
        clearInterval(watchTogetherState.captureTimer);
      }

      watchTogetherState.captureTimer = setInterval(() => {
        captureVideoFrame();
      }, watchTogetherState.captureInterval * 1000);
    }

    // Êà™ÂèñËßÜÈ¢ëÁîªÈù¢
    function captureVideoFrame() {
      const video = document.getElementById('watch-together-video');
      if (!video || video.paused) return;

      // Ê£ÄÊü•ËßÜÈ¢ëÂ∞∫ÂØ∏
      if (!video.videoWidth || !video.videoHeight) {
        console.warn('ËßÜÈ¢ëÂ∞∫ÂØ∏Êó†ÊïàÔºåË∑≥ËøáÊú¨Ê¨°Êà™Âõæ');
        return;
      }

      try {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        const imageData = canvas.toDataURL('image/jpeg', 0.6);
        const currentTime = formatVideoTime(video.currentTime);

        console.log(`‚úÖ ËßÜÈ¢ëÊà™ÂõæÂ∑≤ÊçïËé∑: ${currentTime}, Â§ßÂ∞è: ${(imageData.length / 1024).toFixed(2)}KB`);
        addWatchTogetherContextMessage('ËßÜÈ¢ëÊà™Âõæ', `[${currentTime}]`, imageData);
      } catch (error) {
        console.error('‚ùå ËßÜÈ¢ëÊà™ÂõæÂ§±Ë¥•ÔºàÂèØËÉΩÊòØË∑®ÂüüÈôêÂà∂Ôºâ:', error.message);
        // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊ¨°Â§±Ë¥•ÔºåÁªôÁî®Êà∑ÊèêÁ§∫
        if (!watchTogetherState.corsWarningShown) {
          watchTogetherState.corsWarningShown = true;
          addWatchTogetherSystemMessage('‚ö†Ô∏è ËßÜÈ¢ëÊà™ÂõæÂäüËÉΩÂèóÈôêÔºåËØ•ËßÜÈ¢ëÊ∫ê‰∏çÊîØÊåÅÂÜÖÂÆπËØÜÂà´');
        }
      }
    }

    // Ê†ºÂºèÂåñÊó∂Èó¥
    function formatVideoTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);

      if (h > 0) {
        return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
      } else {
        return `${m}:${s.toString().padStart(2, '0')}`;
      }
    }

    // Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ
    function addWatchTogetherSystemMessage(text) {
      const messagesDiv = document.getElementById('watch-together-chat-messages');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'watch-together-system-message';
      msgDiv.textContent = text;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Ê∑ªÂä†‰∏ä‰∏ãÊñáÊ∂àÊÅØÔºà‰∏çÊòæÁ§∫Ôºå‰ΩÜ‰ºöÂèëÁªôAIÔºâ
    function addWatchTogetherContextMessage(type, content, imageData = null) {
      watchTogetherState.messages.push({
        role: 'system',
        type: type,
        content: content,
        imageData: imageData,
        timestamp: Date.now()
      });

      // Ê†πÊçÆÁ±ªÂûãÊ∏ÖÁêÜË∂ÖÂá∫ÈôêÂà∂ÁöÑÂéÜÂè≤ËÆ∞ÂΩï
      if (type === 'ËßÜÈ¢ëÊà™Âõæ') {
        const screenshots = watchTogetherState.messages.filter(m => m.role === 'system' && m.type === 'ËßÜÈ¢ëÊà™Âõæ');
        if (screenshots.length > watchTogetherState.maxScreenshots) {
          // ÊâæÂà∞ÊúÄÊóßÁöÑÊà™ÂõæÂπ∂Âà†Èô§
          const oldestScreenshot = screenshots[0];
          const index = watchTogetherState.messages.indexOf(oldestScreenshot);
          if (index !== -1) {
            watchTogetherState.messages.splice(index, 1);
          }
        }
      } else if (type === 'ËØ≠Èü≥ËØÜÂà´') {
        const audios = watchTogetherState.messages.filter(m => m.role === 'system' && m.type === 'ËØ≠Èü≥ËØÜÂà´');
        if (audios.length > watchTogetherState.maxAudios) {
          // ÊâæÂà∞ÊúÄÊóßÁöÑËØ≠Èü≥Âπ∂Âà†Èô§
          const oldestAudio = audios[0];
          const index = watchTogetherState.messages.indexOf(oldestAudio);
          if (index !== -1) {
            watchTogetherState.messages.splice(index, 1);
          }
        }
      }

      // ÈôêÂà∂ÂØπËØùÊ∂àÊÅØÊï∞ÈáèÔºàÁî®Êà∑ÂíåÂä©ÊâãÁöÑÊ∂àÊÅØÔºâ
      const dialogMessages = watchTogetherState.messages.filter(m => m.role === 'user' || m.role === 'assistant');
      if (dialogMessages.length > watchTogetherState.maxMessages) {
        // ÊâæÂà∞ÊúÄÊóßÁöÑÂØπËØùÊ∂àÊÅØÂπ∂Âà†Èô§
        const oldestDialog = dialogMessages[0];
        const index = watchTogetherState.messages.indexOf(oldestDialog);
        if (index !== -1) {
          watchTogetherState.messages.splice(index, 1);
        }
      }
    }

    // ÂèëÈÄÅÁî®Êà∑Ê∂àÊÅØÔºà‰∏çË∞ÉÁî®APIÔºâ
    function sendWatchTogetherUserMessage() {
      const input = document.getElementById('watch-together-chat-input');
      const text = input.value.trim();

      if (!text) return;

      input.value = '';

      // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
      watchTogetherState.messages.push({
        role: 'user',
        content: text,
        timestamp: Date.now()
      });

      // Ê∏ÖÁêÜË∂ÖÂá∫ÈôêÂà∂ÁöÑÂØπËØùÊ∂àÊÅØ
      const dialogMessages = watchTogetherState.messages.filter(m => m.role === 'user' || m.role === 'assistant');
      if (dialogMessages.length > watchTogetherState.maxMessages) {
        const oldestDialog = dialogMessages[0];
        const index = watchTogetherState.messages.indexOf(oldestDialog);
        if (index !== -1) {
          watchTogetherState.messages.splice(index, 1);
        }
      }

      renderWatchTogetherMessages();
    }

    // Ë∞ÉÁî®API
    async function callWatchTogetherAPI() {
      if (!watchTogetherState.isActive) return;

      const chat = state.chats[watchTogetherState.chatId];
      const video = document.getElementById('watch-together-video');
      const isOnlineMode = watchTogetherState.mode === 'online';

      // Á¶ÅÁî®ÊåâÈíÆ
      document.getElementById('watch-together-call-api-btn').disabled = true;
      document.getElementById('watch-together-chat-send').disabled = true;

      // ÊòæÁ§∫"Ê≠£Âú®ËæìÂÖ•‰∏≠"
      const chatNameElement = document.getElementById('watch-together-chat-name');
      const originalName = chatNameElement.textContent;
      chatNameElement.textContent = 'Ê≠£Âú®ËæìÂÖ•‰∏≠...';

      try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
          alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•Âπ∂ÈÄâÊã©Ê®°Âûã„ÄÇ');
          return;
        }

        const currentTime = video.currentTime ? formatVideoTime(video.currentTime) : '0:00';
        const now = new Date();
        const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai';
        const currentDateTime = now.toLocaleString('zh-CN', {
          timeZone: selectedTimeZone,
          dateStyle: 'full',
          timeStyle: 'short'
        });

        // ÊûÑÂª∫Âü∫Á°ÄÁ≥ªÁªüÊèêÁ§∫ËØç
        let basePrompt = `# Ê†∏ÂøÉ‰ªªÂä°
‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑‰∏ÄËµ∑ËßÇÁúãËßÜÈ¢ë„ÄÇÂΩìÂâçÊó∂Èó¥Ôºö${currentDateTime}ÔºåËßÜÈ¢ëÊí≠ÊîæÊó∂Èó¥Ôºö${currentTime}„ÄÇ

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.aiPersona}

# Áî®Êà∑ÁöÑËßíËâ≤
${chat.settings.myPersona || 'ÊôÆÈÄöÁî®Êà∑'}
`;

        // ‰∏ñÁïå‰π¶
        let worldBookContent = '';
        let allWorldBookIds = [...(chat.settings.linkedWorldBookIds || [])];
        state.worldBooks.forEach(wb => {
          if (wb.isGlobal && !allWorldBookIds.includes(wb.id)) {
            allWorldBookIds.push(wb.id);
          }
        });

        if (allWorldBookIds.length > 0) {
          const linkedContents = allWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            if (!worldBook || !Array.isArray(worldBook.content)) return '';

            const formattedEntries = worldBook.content
              .filter(entry => entry.enabled !== false)
              .map(entry => {
                let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;
                entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
                return entryString;
              }).join('');

            return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
          }).filter(Boolean).join('');

          if (linkedContents) {
            worldBookContent = `# ‰∏ñÁïå‰π¶ËÆæÂÆö (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑÂü∫Á°ÄËÆæÂÆöÔºå‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà„ÄÇ
${linkedContents}
`;
          }
        }

        // ÈïøÊúüËÆ∞ÂøÜ
        let longTermMemoryContext = '';
        if (chat.longTermMemory && chat.longTermMemory.length > 0) {
          longTermMemoryContext = `\n# ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)\n`;
          longTermMemoryContext += chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
          longTermMemoryContext += '\n';
        }

        // ÊåÇËΩΩËÅäÂ§©ËÆ∞ÂΩï
        let linkedMemoryContext = '';
        const memoryCount = chat.settings.linkedMemoryCount || 10;
        if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
          const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== watchTogetherState.chatId);

          if (idsToMount.length > 0) {
            linkedMemoryContext += `\n# ÂèÇËÄÉËÆ∞ÂøÜ (ÂÖ∂‰ªñËÅäÂ§©ÁöÑËÆ∞ÂøÜ)\n`;

            for (const id of idsToMount) {
              const linkedChat = state.chats[id];
              if (!linkedChat) continue;

              const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
              linkedMemoryContext += `\n## ${prefix}"${linkedChat.name}"ÁöÑËÆ∞ÂøÜ:\n`;

              const recentHistory = linkedChat.history.slice(-memoryCount);
              const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));

              if (filteredHistory.length > 0) {
                filteredHistory.forEach(msg => {
                  const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (msg.senderName || linkedChat.name);
                  let contentText = String(msg.content);
                  if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                  } else if (msg.type === 'voice_message') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                  }
                  linkedMemoryContext += `${sender}: ${contentText}\n`;
                });
              } else {
                linkedMemoryContext += "(ÊöÇÊó†ËÆ∞ÂΩï)\n";
              }
            }
          }
        }

        // ËßÜÈ¢ëÂÜÖÂÆπ‰∏ä‰∏ãÊñá
        let videoContext = '\n# ËßÜÈ¢ëÂÜÖÂÆπ\n';

        // ÊúÄËøëÁöÑËØ≠Èü≥ËØÜÂà´ÂÜÖÂÆπ
        const recentSpeech = watchTogetherState.messages
          .filter(m => m.role === 'system' && m.type === 'ËØ≠Èü≥ËØÜÂà´')
          .slice(-watchTogetherState.maxAudios);

        if (recentSpeech.length > 0) {
          videoContext += '## ËßÜÈ¢ë‰∏≠ÁöÑÂØπËØùÔºàÊúÄËøëÂê¨Âà∞ÁöÑÔºâ:\n';
          recentSpeech.forEach(s => {
            videoContext += `- ${s.content}\n`;
          });
        }

        // ÊúÄËøëÁöÑÊà™Âõæ
        const recentScreenshots = watchTogetherState.messages
          .filter(m => m.role === 'system' && m.type === 'ËßÜÈ¢ëÊà™Âõæ')
          .slice(-watchTogetherState.maxScreenshots);

        if (recentScreenshots.length > 0) {
          videoContext += '\n## ËßÜÈ¢ëÁîªÈù¢ÔºàÊúÄËøëÊà™ÂõæÔºâ:\n';
          recentScreenshots.forEach(s => {
            videoContext += `- ${s.content}\n`;
          });
        }

        // ÁªÑÂêàÂÆåÊï¥Á≥ªÁªüÊèêÁ§∫
        let systemPrompt = basePrompt + worldBookContent + longTermMemoryContext + linkedMemoryContext + videoContext;

        // Ê†πÊçÆÊ®°ÂºèÊ∑ªÂä†Ê†ºÂºèÊåá‰ª§
        if (isOnlineMode) {
          // Á∫ø‰∏äÊ®°ÂºèÔºö‰ΩøÁî®JSONÊï∞ÁªÑÊ†ºÂºèÔºàÂíåÂçïËÅä‰∏ÄÊ†∑Ôºâ
          systemPrompt += `
# „Äê„Äê„ÄêÁ∫ø‰∏äËÅäÂ§©Ê®°Âºè - ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÈìÅÂæã„Äë„Äë„Äë

## Ê†∏ÂøÉËßÑÂàôÔºö
1. **ËøôÊòØÁúüÂÆûÁöÑÂú®Á∫øÊñáÂ≠óËÅäÂ§©**ÔºåÂ∞±ÂÉèQQ„ÄÅÂæÆ‰ø°‰∏ÄÊ†∑„ÄÇ
2. **„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ªª‰ΩïÂΩ¢ÂºèÁöÑ"Á∫ø‰∏ãÊèèÂÜô"**Ôºö
   - Á¶ÅÊ≠¢ÊèèÂÜôÂä®‰ΩúÔºàÂ¶ÇÔºö*Á¨ë‰∫ÜÁ¨ë*„ÄÅ*ÁÇπÁÇπÂ§¥*Ôºâ
   - Á¶ÅÊ≠¢ÊèèÂÜôË°®ÊÉÖÔºàÂ¶ÇÔºöÂ•πÂæÆÁ¨ëÁùÄ„ÄÅ‰ªñÁö±‰∫ÜÁö±ÁúâÔºâ
   - Á¶ÅÊ≠¢ÊèèÂÜôÁéØÂ¢ÉÔºàÂ¶ÇÔºöÈò≥ÂÖâÊ¥íÂú®Á™óÂè∞‰∏äÔºâ
   - Á¶ÅÊ≠¢‰ΩøÁî®‰ªª‰ΩïÊ†áÁÇπÁ¨¶Âè∑Êù•Ë°®Á§∫Âä®‰ΩúÔºàÂ¶ÇÔºö*„ÄÅÔºàÔºâ„ÄÅ„Äê„ÄëÁ≠âÔºâ
3. **‰Ω†Âè™ËÉΩÊâìÂ≠ó**ÔºåÂ∞±ÂÉèÁúü‰∫∫Âú®ÊâãÊú∫‰∏äËÅäÂ§©‰∏ÄÊ†∑„ÄÇ
4. ‰Ω†ÂèØ‰ª•Áî®Ë°®ÊÉÖÁ¨¶Âè∑„ÄÅÁΩëÁªúÁî®ËØ≠„ÄÅÂè£ËØ≠ÂåñË°®ËææÔºå‰ΩÜ**ÁªùÂØπ‰∏çËÉΩ**Êúâ‰ªª‰Ωï"ÊóÅÁôΩ"Êàñ"Âú∫ÊôØÊèèÂÜô"„ÄÇ

## ËæìÂá∫Ê†ºÂºèÈìÅÂæãÔºö
‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†‰ª£Ë°®‰Ω†ÂèëÈÄÅÁöÑ‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ

### ÂèØÁî®ÁöÑÊ∂àÊÅØÁ±ªÂûãÔºö
- **Á∫ØÊñáÂ≠óÊ∂àÊÅØ**: \`{"type": "text", "content": "‰Ω†Ë¶ÅÊâìÁöÑÂ≠ó"}\`

### Ê≠£Á°ÆÁ§∫‰æãÔºö
\`\`\`json
[
  {"type": "text", "content": "ÂìáËøô‰∏™ÈïúÂ§¥Â•ΩÁæéÂïäÔºÅ"},
  {"type": "text", "content": "‰Ω†Ê≥®ÊÑèÂà∞ÂàöÊâçÈÇ£‰∏™ÁªÜËäÇ‰∫ÜÂêó"},
  {"type": "text", "content": "ÊàëÂ•ΩÂñúÊ¨¢ËøôÊÆµ"}
]
\`\`\`

### ÈîôËØØÁ§∫‰æãÔºàÁªùÂØπÁ¶ÅÊ≠¢ÔºâÔºö
‚ùå \`{"type": "text", "content": "*Á¨ë‰∫ÜÁ¨ë* Á°ÆÂÆûÂæà‰∏çÈîôÂë¢"}\`  
‚ùå \`{"type": "text", "content": "ÔºàÊ≠™Â§¥ÊÄùËÄÉÔºâÂóØ...Ëøô‰∏™Âú∞Êñπ..."}\`  
‚ùå \`{"type": "text", "content": "Â•πÈú≤Âá∫‰∫ÜÂºÄÂøÉÁöÑÁ¨ëÂÆπÔºöËøô‰∏™..."}\`  

Áé∞Âú®ÔºåËØ∑ÂÉèÁúü‰∫∫Âú®ÊâãÊú∫‰∏äËÅäÂ§©‰∏ÄÊ†∑ÔºåÁ∫ØÊñáÂ≠óÊâìÂ≠óÂõûÂ§çÁî®Êà∑„ÄÇÂèØ‰ª•ÂèëÂ§öÊù°Ê∂àÊÅØ„ÄÇ
`;
        } else {
          // Á∫ø‰∏ãÊ®°ÂºèÔºöÂçïÊù°ÊñáÊú¨
          systemPrompt += `
# ‰Ω†ÁöÑ‰ªªÂä°
ËØ∑Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºåÁªìÂêàËßÜÈ¢ëÂÜÖÂÆπËá™ÁÑ∂Âú∞ÂõûÂ§çÁî®Êà∑„ÄÇ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÔºåÂπ∂‰ΩìÁé∞Âá∫ÂØπËßÜÈ¢ëÂÜÖÂÆπÁöÑÁêÜËß£„ÄÇ
Áõ¥Êé•ÂõûÂ§çÊñáÊú¨Âç≥ÂèØÔºå‰∏çÈúÄË¶ÅJSONÊ†ºÂºè„ÄÇ
`;
        }

        // ÊûÑÂª∫Ê∂àÊÅØÂéÜÂè≤
        const maxMemory = watchTogetherState.maxMessages || 20;
        const historyMessages = watchTogetherState.messages
          .filter(m => m.role === 'user' || m.role === 'assistant')
          .slice(-maxMemory)
          .map(m => ({
            role: m.role,
            content: m.content
          }));

        // Ëé∑ÂèñÊúÄÊñ∞Êà™Âõæ
        const latestScreenshot = watchTogetherState.messages
          .filter(m => m.role === 'system' && m.type === 'ËßÜÈ¢ëÊà™Âõæ' && m.imageData)
          .slice(-1)[0];

        // Â¶ÇÊûúÊúâÊà™ÂõæÔºåÊääÂÆÉÈôÑÂä†Âà∞ÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ‰∏äÔºàÁ±ª‰ººËßÜÈ¢ëÈÄöËØùÁöÑÊñπÂºèÔºâ
        if (latestScreenshot && historyMessages.length > 0) {
          const lastUserMsgIndex = historyMessages.map((m, i) => m.role === 'user' ? i : -1).filter(i => i >= 0).pop();

          if (lastUserMsgIndex !== undefined) {
            const lastUserMsg = historyMessages[lastUserMsgIndex];
            // Â∞ÜÊñáÊú¨Ê∂àÊÅØËΩ¨Êç¢‰∏∫Â§öÊ®°ÊÄÅÊ∂àÊÅØ
            historyMessages[lastUserMsgIndex] = {
              role: 'user',
              content: [
                { type: 'text', text: typeof lastUserMsg.content === 'string' ? lastUserMsg.content : 'Áî®Êà∑Ê∂àÊÅØ' },
                { type: 'image_url', image_url: { url: latestScreenshot.imageData } }
              ]
            };
            console.log(`üì∏ Â∑≤Â∞ÜËßÜÈ¢ëÊà™ÂõæÈôÑÂä†Âà∞Áî®Êà∑Ê∂àÊÅØ: ${latestScreenshot.content}`);
          }
        } else if (latestScreenshot && historyMessages.length === 0) {
          // Â¶ÇÊûúÊ≤°ÊúâÂéÜÂè≤Ê∂àÊÅØÔºåÊääÊà™Âõæ‰Ωú‰∏∫Á¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
          historyMessages.push({
            role: 'user',
            content: [
              { type: 'text', text: `ÂΩìÂâçËßÜÈ¢ëÁîªÈù¢ ${latestScreenshot.content}` },
              { type: 'image_url', image_url: { url: latestScreenshot.imageData } }
            ]
          });
          console.log(`üì∏ Â∑≤Â∞ÜËßÜÈ¢ëÊà™Âõæ‰Ωú‰∏∫È¶ñÊù°Ê∂àÊÅØÂèëÈÄÅ: ${latestScreenshot.content}`);
        } else {
          console.log('üì≠ ÊöÇÊó†ËßÜÈ¢ëÊà™ÂõæÂèØÂèëÈÄÅ');
        }

        const messagesPayload = [
          { role: 'system', content: systemPrompt },
          ...historyMessages
        ];

        // Ë∞ÉÁî®API
        const apiResponse = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: messagesPayload,
            temperature: state.globalSettings.apiTemperature || 0.8
          })
        });

        if (!apiResponse.ok) {
          const errorData = await apiResponse.json().catch(() => ({}));
          const errorMsg = errorData.error?.message || errorData.message || `HTTP ${apiResponse.status}`;
          throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${errorMsg}`);
        }

        const data = await apiResponse.json();
        let reply = data.choices[0].message.content.trim();

        // ÁßªÈô§ÂèØËÉΩÁöÑ‰ª£Á†ÅÂùóÊ†áËÆ∞
        reply = reply.replace(/^```json\s*/i, '').replace(/^```\s*/m, '').replace(/```\s*$/m, '');

        if (isOnlineMode) {
          // Á∫ø‰∏äÊ®°ÂºèÔºöËß£ÊûêJSONÊï∞ÁªÑÔºåAIÂèØ‰ª•ÂèëÈÄÅÂ§öÊù°Ê∂àÊÅØ
          try {
            const parsed = JSON.parse(reply);
            if (Array.isArray(parsed)) {
              // ‰∏∫ÊØèÊù°Ê∂àÊÅØÊ∑ªÂä†Âà∞ÂéÜÂè≤
              parsed.forEach(item => {
                if (item.type === 'text' && item.content) {
                  watchTogetherState.messages.push({
                    role: 'assistant',
                    content: item.content.trim(),
                    timestamp: Date.now()
                  });
                }
              });
            } else {
              // Â¶ÇÊûú‰∏çÊòØÊï∞ÁªÑÔºåÂΩì‰ΩúÂçïÊù°Ê∂àÊÅØ
              watchTogetherState.messages.push({
                role: 'assistant',
                content: reply,
                timestamp: Date.now()
              });
            }
          } catch (e) {
            // JSONËß£ÊûêÂ§±Ë¥•ÔºåÂΩì‰ΩúÁ∫ØÊñáÊú¨
            console.error('JSONËß£ÊûêÂ§±Ë¥•:', e);
            watchTogetherState.messages.push({
              role: 'assistant',
              content: reply,
              timestamp: Date.now()
            });
          }
        } else {
          // Á∫ø‰∏ãÊ®°ÂºèÔºöÁõ¥Êé•Ê∑ªÂä†ÂçïÊù°ÊñáÊú¨Ê∂àÊÅØ
          // Â∞ùËØïËß£ÊûêJSONÊ†ºÂºèÔºàÂÖºÂÆπÊüê‰∫õÊ®°ÂûãÂèØËÉΩËøîÂõûJSONÔºâ
          try {
            const parsed = JSON.parse(reply);
            if (Array.isArray(parsed) && parsed[0]) {
              if (parsed[0].type === 'text' || parsed[0].type === 'offline_text') {
                reply = parsed[0].content;
              }
            }
          } catch (e) {
            // ‰øùÊåÅÂéüÊ†∑
          }

          watchTogetherState.messages.push({
            role: 'assistant',
            content: reply,
            timestamp: Date.now()
          });
        }

        // Ê∏ÖÁêÜË∂ÖÂá∫ÈôêÂà∂ÁöÑÂØπËØùÊ∂àÊÅØ
        const dialogMessages = watchTogetherState.messages.filter(m => m.role === 'user' || m.role === 'assistant');
        if (dialogMessages.length > watchTogetherState.maxMessages) {
          // ËÆ°ÁÆóÈúÄË¶ÅÂà†Èô§ÁöÑÊï∞Èáè
          const deleteCount = dialogMessages.length - watchTogetherState.maxMessages;
          for (let i = 0; i < deleteCount; i++) {
            const oldestDialog = watchTogetherState.messages.find(m => m.role === 'user' || m.role === 'assistant');
            const index = watchTogetherState.messages.indexOf(oldestDialog);
            if (index !== -1) {
              watchTogetherState.messages.splice(index, 1);
            }
          }
        }

        renderWatchTogetherMessages();

      } catch (error) {
        console.error('AIË∞ÉÁî®Â§±Ë¥•:', error);
        addWatchTogetherSystemMessage('AIË∞ÉÁî®Â§±Ë¥•Ôºö' + error.message);

        // ÊòæÁ§∫ÈîôËØØÂºπÁ™ó
        let errorDetail = error.message;
        if (error.message.includes('Ê®°Âûã') || error.message.includes('vision') || error.message.includes('image')) {
          errorDetail += '\n\nÊèêÁ§∫ÔºöÂΩìÂâçÊ®°ÂûãÂèØËÉΩ‰∏çÊîØÊåÅËßÜËßâÂäüËÉΩÔºàÂõæÁâáËØÜÂà´Ôºâ„ÄÇÂª∫ËÆÆ‰ΩøÁî®ÊîØÊåÅËßÜËßâÁöÑÊ®°ÂûãÔºåÂ¶ÇÔºögpt-4o„ÄÅclaude-3„ÄÅgemini-pro-vision Á≠â„ÄÇ';
        }
        alert('ËßÇÂΩ±AIË∞ÉÁî®Â§±Ë¥•\n\n' + errorDetail);
      } finally {
        // ÊÅ¢Â§çÂéüÂêçÂ≠ó
        const chat = state.chats[watchTogetherState.chatId];
        const chatNameElement = document.getElementById('watch-together-chat-name');
        if (chat) {
          chatNameElement.textContent = chat.name;
        }

        document.getElementById('watch-together-call-api-btn').disabled = false;
        document.getElementById('watch-together-chat-send').disabled = false;
      }
    }

    // Ê∏≤ÊüìÊ∂àÊÅØ
    function renderWatchTogetherMessages() {
      const messagesDiv = document.getElementById('watch-together-chat-messages');
      messagesDiv.innerHTML = '';

      const chat = state.chats[watchTogetherState.chatId];
      const defaultAvatar = 'https://i.postimg.cc/y8xWzCqj/anime-boy.jpg';
      const userAvatar = chat.settings?.myAvatar || defaultAvatar;
      const aiAvatar = chat.settings?.aiAvatar || defaultAvatar;

      watchTogetherState.messages
        .filter(m => m.role !== 'system')
        .forEach(msg => {
          const msgDiv = document.createElement('div');
          msgDiv.className = `watch-together-message ${msg.role}`;

          const avatar = document.createElement('img');
          avatar.className = 'watch-together-message-avatar';
          avatar.src = msg.role === 'user' ? userAvatar : aiAvatar;

          const content = document.createElement('div');
          content.className = 'watch-together-message-content';
          content.textContent = msg.content;

          // Ê∑ªÂä†ÈïøÊåâÁõëÂê¨Âô®
          addLongPressListener(content, () => showWatchTogetherMessageActions(msg.timestamp));

          msgDiv.appendChild(avatar);
          msgDiv.appendChild(content);
          messagesDiv.appendChild(msgDiv);
        });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // ========== ËßÇÂΩ±Ê∂àÊÅØËèúÂçï ==========
    let activeWatchTogetherMessageTimestamp = null;

    function showWatchTogetherMessageActions(timestamp) {
      activeWatchTogetherMessageTimestamp = timestamp;
      const message = watchTogetherState.messages.find(m => m.timestamp === timestamp);
      if (!message) return;

      document.getElementById('message-actions-modal').classList.add('visible');

      // ÊòæÁ§∫ÈúÄË¶ÅÁöÑÊåâÈíÆ
      document.getElementById('edit-message-btn').style.display = 'block';
      document.getElementById('edit-message-btn').textContent = 'ÁºñËæë';
      document.getElementById('copy-message-btn').style.display = 'block';
      document.getElementById('recall-message-btn').style.display = 'block';
      document.getElementById('recall-message-btn').textContent = message.role === 'assistant' ? 'ÈáçËØ¥' : 'Âà†Èô§';

      // ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÊåâÈíÆ
      document.getElementById('copy-timestamp-btn').style.display = 'none';
      document.getElementById('translate-message-btn').style.display = 'none';
      document.getElementById('publish-to-announcement-btn').style.display = 'none';
      document.getElementById('quote-message-btn').style.display = 'none';
      document.getElementById('forward-message-btn').style.display = 'none';
      document.getElementById('select-message-btn').style.display = 'none';
    }

    function closeWatchTogetherMessageActions() {
      document.getElementById('message-actions-modal').classList.remove('visible');
      activeWatchTogetherMessageTimestamp = null;
      document.getElementById('recall-message-btn').textContent = 'Êí§Âõû';
    }

    function restoreNormalMessageActionsFromWatchTogether() {
      // ÊÅ¢Â§çÊâÄÊúâÊ≠£Â∏∏Ê∂àÊÅØËèúÂçïÊåâÈíÆÁöÑÊòæÁ§∫Áä∂ÊÄÅ
      document.getElementById('edit-message-btn').style.display = 'block';
      document.getElementById('copy-message-btn').style.display = 'block';
      document.getElementById('copy-timestamp-btn').style.display = 'block';
      document.getElementById('translate-message-btn').style.display = 'block';
      document.getElementById('recall-message-btn').style.display = 'block';
      document.getElementById('quote-message-btn').style.display = 'block';
      document.getElementById('forward-message-btn').style.display = 'block';
      document.getElementById('select-message-btn').style.display = 'block';
      document.getElementById('recall-message-btn').textContent = 'Êí§Âõû';

      // ÈáçÁΩÆactiveWatchTogetherMessageTimestamp
      activeWatchTogetherMessageTimestamp = null;
    }
    // ========== ËßÇÂΩ±Ê∂àÊÅØËèúÂçïÁªìÊùü ==========

    // Âä†ËΩΩËÆæÁΩÆ
    function loadWatchTogetherSettings() {
      const chat = state.chats[watchTogetherState.chatId];
      const settings = chat.watchTogetherSettings || {};

      document.getElementById('watch-together-mode-select').value = settings.mode || 'online';
      document.getElementById('watch-together-interval-input').value = settings.captureInterval || 5;
      document.getElementById('watch-together-speech-api-select').value = settings.speechApi || 'none';
      document.getElementById('watch-together-whisper-key').value = settings.whisperKey || '';
      document.getElementById('watch-together-whisper-url').value = settings.whisperUrl || 'https://api.openai.com/v1/audio/transcriptions';
      document.getElementById('watch-together-max-screenshots').value = settings.maxScreenshots || 10;
      document.getElementById('watch-together-max-audios').value = settings.maxAudios || 10;
      document.getElementById('watch-together-max-messages').value = settings.maxMessages || 20;

      const whisperConfig = document.getElementById('watch-together-whisper-config');
      whisperConfig.style.display = (settings.speechApi === 'whisper') ? 'block' : 'none';
    }

    // ‰øùÂ≠òËÆæÁΩÆ
    async function saveWatchTogetherSettings() {
      const chat = state.chats[watchTogetherState.chatId];

      chat.watchTogetherSettings = {
        mode: document.getElementById('watch-together-mode-select').value,
        captureInterval: parseInt(document.getElementById('watch-together-interval-input').value) || 5,
        speechApi: document.getElementById('watch-together-speech-api-select').value,
        whisperKey: document.getElementById('watch-together-whisper-key').value,
        whisperUrl: document.getElementById('watch-together-whisper-url').value,
        maxScreenshots: parseInt(document.getElementById('watch-together-max-screenshots').value) || 10,
        maxAudios: parseInt(document.getElementById('watch-together-max-audios').value) || 10,
        maxMessages: parseInt(document.getElementById('watch-together-max-messages').value) || 20
      };

      watchTogetherState.mode = chat.watchTogetherSettings.mode;
      watchTogetherState.captureInterval = chat.watchTogetherSettings.captureInterval;
      watchTogetherState.speechApi = chat.watchTogetherSettings.speechApi;
      watchTogetherState.whisperKey = chat.watchTogetherSettings.whisperKey;
      watchTogetherState.whisperUrl = chat.watchTogetherSettings.whisperUrl;
      watchTogetherState.maxScreenshots = chat.watchTogetherSettings.maxScreenshots;
      watchTogetherState.maxAudios = chat.watchTogetherSettings.maxAudios;
      watchTogetherState.maxMessages = chat.watchTogetherSettings.maxMessages;

      // ÈáçÂêØÁõëÂê¨
      if (watchTogetherState.videoUrl) {
        stopMonitoring();
        startWatchTogetherMonitoring();
      }

      // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
      await db.chats.put(chat);
    }

    // ÂÅúÊ≠¢ÁõëÂê¨
    function stopMonitoring() {
      if (watchTogetherState.captureTimer) {
        clearInterval(watchTogetherState.captureTimer);
        watchTogetherState.captureTimer = null;
      }

      if (watchTogetherState.speechRecognition) {
        watchTogetherState.speechRecognition.stop();
        watchTogetherState.speechRecognition = null;
      }

      if (watchTogetherState.mediaRecorder) {
        if (watchTogetherState.mediaRecorder.state === 'recording') {
          watchTogetherState.mediaRecorder.stop();
        }
        watchTogetherState.mediaRecorder = null;
      }

      if (watchTogetherState.audioContext) {
        watchTogetherState.audioContext.close();
        watchTogetherState.audioContext = null;
      }
    }

    // ÂÅúÊ≠¢ËßÇÂΩ±
    function stopWatchTogether() {
      stopMonitoring();

      // ÈîÄÊØÅ HLS ÂÆû‰æã
      if (watchTogetherState.hlsInstance) {
        watchTogetherState.hlsInstance.destroy();
        watchTogetherState.hlsInstance = null;
      }

      const video = document.getElementById('watch-together-video');
      video.pause();
      video.removeAttribute('crossorigin');
      video.src = '';

      if (watchTogetherState.videoUrl && watchTogetherState.videoUrl.startsWith('blob:')) {
        URL.revokeObjectURL(watchTogetherState.videoUrl);
      }

      document.getElementById('watch-together-video').style.display = 'none';
      document.getElementById('watch-together-placeholder').style.display = 'block';
      document.getElementById('watch-together-modal').classList.remove('visible');

      // ÊÅ¢Â§çÊ≠£Â∏∏ÁöÑÊ∂àÊÅØËèúÂçï
      restoreNormalMessageActionsFromWatchTogether();

      watchTogetherState.isActive = false;
      watchTogetherState.videoUrl = null;
      watchTogetherState.messages = [];
    }

    // ========== ÂΩ±ËßÜÊêúÁ¥¢ÂäüËÉΩ ==========

    // ËµÑÊ∫êÁ´ôÈÖçÁΩÆ
    const movieApiSources = [
      {
        name: 'ÊúÄÂ§ßËµÑÊ∫ê',
        url: 'https://api.apibdzy.com/api.php/provide/vod/',
        params: { ac: 'detail', wd: '' }
      },
      {
        name: 'OKËµÑÊ∫ê',
        url: 'https://cj.okzy.tv/inc/apijson_vod.php',
        params: { wd: '' }
      },
      {
        name: 'ÈáèÂ≠êËµÑÊ∫ê',
        url: 'https://cj.lziapi.com/api.php/provide/vod/',
        params: { ac: 'detail', wd: '' }
      },
      {
        name: 'ÈùûÂá°ËµÑÊ∫ê',
        url: 'https://cj.ffzyapi.com/api.php/provide/vod/',
        params: { ac: 'detail', wd: '' }
      },
      {
        name: 'Á∫¢ÁâõËµÑÊ∫ê',
        url: 'https://www.hongniuzy2.com/api.php/provide/vod/',
        params: { ac: 'detail', wd: '' }
      }
    ];

    // ÊêúÁ¥¢ÂΩ±ËßÜ
    async function searchMovies(keyword) {
      const statusDiv = document.getElementById('watch-together-search-status');
      const resultsDiv = document.getElementById('watch-together-search-results');

      statusDiv.textContent = 'Ê≠£Âú®ÊêúÁ¥¢‰∏≠...';
      resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">ÊêúÁ¥¢‰∏≠ÔºåËØ∑Á®çÂÄô...</div>';

      const searchBtn = document.getElementById('watch-together-search-btn');
      searchBtn.disabled = true;
      searchBtn.textContent = 'ÊêúÁ¥¢‰∏≠...';

      const allResults = [];
      let successCount = 0;
      let failCount = 0;

      // Âπ∂ÂèëÊêúÁ¥¢ÊâÄÊúâËµÑÊ∫êÁ´ô
      const searchPromises = movieApiSources.map(async (source) => {
        try {
          const params = new URLSearchParams({ ...source.params, wd: keyword });
          const url = `${source.url}?${params.toString()}`;

          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Accept': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();

          // Ëß£ÊûêÊï∞ÊçÆ
          let movies = [];
          if (data.list && Array.isArray(data.list)) {
            movies = data.list;
          } else if (data.data && Array.isArray(data.data)) {
            movies = data.data;
          }

          // ‰∏∫ÊØè‰∏™ÁªìÊûúÊ∑ªÂä†Êù•Ê∫ê‰ø°ÊÅØ
          movies.forEach(movie => {
            movie._source = source.name;
          });

          successCount++;
          return movies;

        } catch (error) {
          console.error(`${source.name} ÊêúÁ¥¢Â§±Ë¥•:`, error);
          failCount++;
          return [];
        }
      });

      // Á≠âÂæÖÊâÄÊúâÊêúÁ¥¢ÂÆåÊàê
      const results = await Promise.all(searchPromises);
      results.forEach(movies => {
        allResults.push(...movies);
      });

      // Êõ¥Êñ∞Áä∂ÊÄÅ
      searchBtn.disabled = false;
      searchBtn.textContent = 'ÊêúÁ¥¢';

      if (allResults.length === 0) {
        statusDiv.textContent = `ÊêúÁ¥¢ÂÆåÊàêÔºöÊú™ÊâæÂà∞"${keyword}"Áõ∏ÂÖ≥ÁöÑÂΩ±ËßÜËµÑÊ∫ê (ÊàêÂäü:${successCount} Â§±Ë¥•:${failCount})`;
        resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÁªìÊûúÔºåËØ∑Â∞ùËØïÂÖ∂‰ªñÂÖ≥ÈîÆËØç</div>';
        return;
      }

      statusDiv.textContent = `ÊêúÁ¥¢ÂÆåÊàêÔºöÊâæÂà∞ ${allResults.length} ‰∏™ÁªìÊûú (ÊàêÂäü:${successCount} Â§±Ë¥•:${failCount})`;

      // Ê∏≤ÊüìÊêúÁ¥¢ÁªìÊûú
      renderSearchResults(allResults);
    }

    // Ê∏≤ÊüìÊêúÁ¥¢ÁªìÊûú
    function renderSearchResults(movies) {
      const resultsDiv = document.getElementById('watch-together-search-results');
      resultsDiv.innerHTML = '';

      movies.forEach(movie => {
        const movieCard = document.createElement('div');
        movieCard.style.cssText = 'border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; cursor: pointer; transition: all 0.2s;';
        movieCard.addEventListener('mouseenter', () => {
          movieCard.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
          movieCard.style.borderColor = '#667eea';
        });
        movieCard.addEventListener('mouseleave', () => {
          movieCard.style.boxShadow = 'none';
          movieCard.style.borderColor = '#e0e0e0';
        });

        // Ê†áÈ¢òÂíåÊù•Ê∫ê
        const header = document.createElement('div');
        header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;';
        header.innerHTML = `
          <h3 style="margin: 0; font-size: 16px; color: #333;">${escapeHTML(movie.vod_name || movie.name || 'Êú™Áü•ÂΩ±Áâá')}</h3>
          <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${movie._source}</span>
        `;
        movieCard.appendChild(header);

        // ‰ø°ÊÅØ
        const info = document.createElement('div');
        info.style.cssText = 'color: #666; font-size: 13px; line-height: 1.6; margin-bottom: 10px;';
        const year = movie.vod_year || movie.year || '';
        const type = movie.type_name || movie.vod_class || movie.type || '';
        const area = movie.vod_area || movie.area || '';
        const actor = movie.vod_actor || movie.actor || '';
        const director = movie.vod_director || movie.director || '';

        let infoHtml = [];
        if (year) infoHtml.push(`Âπ¥‰ªΩ: ${year}`);
        if (type) infoHtml.push(`Á±ªÂûã: ${type}`);
        if (area) infoHtml.push(`Âú∞Âå∫: ${area}`);
        if (director) infoHtml.push(`ÂØºÊºî: ${director}`);
        if (actor) infoHtml.push(`‰∏ªÊºî: ${actor.substring(0, 50)}${actor.length > 50 ? '...' : ''}`);

        info.innerHTML = infoHtml.join(' | ');
        movieCard.appendChild(info);

        // Êí≠ÊîæÊåâÈíÆ
        const playBtn = document.createElement('button');
        playBtn.textContent = 'ÈÄâÊã©Êí≠ÊîæÊ∫ê';
        playBtn.style.cssText = 'background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px;';
        playBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          showPlaySources(movie);
        });
        movieCard.appendChild(playBtn);

        resultsDiv.appendChild(movieCard);
      });
    }

    // ÊòæÁ§∫Êí≠ÊîæÊ∫êÈÄâÊã©
    function showPlaySources(movie) {
      const resultsDiv = document.getElementById('watch-together-search-results');
      resultsDiv.innerHTML = '';

      // ËøîÂõûÊåâÈíÆ
      const backBtn = document.createElement('button');
      backBtn.innerHTML = '&lt; ËøîÂõûÊêúÁ¥¢ÁªìÊûú';
      backBtn.style.cssText = 'margin-bottom: 20px; padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer;';
      backBtn.addEventListener('click', () => {
        const keyword = document.getElementById('watch-together-search-input').value.trim();
        if (keyword) searchMovies(keyword);
      });
      resultsDiv.appendChild(backBtn);

      // ÂΩ±Áâá‰ø°ÊÅØ
      const movieInfo = document.createElement('div');
      movieInfo.style.cssText = 'background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;';
      movieInfo.innerHTML = `
        <h2 style="margin: 0 0 10px 0; font-size: 18px;">${escapeHTML(movie.vod_name || movie.name || 'Êú™Áü•ÂΩ±Áâá')}</h2>
        <p style="margin: 0; color: #666; font-size: 13px; line-height: 1.6;">${escapeHTML(movie.vod_content || movie.content || movie.vod_blurb || 'ÊöÇÊó†ÁÆÄ‰ªã')}</p>
      `;
      resultsDiv.appendChild(movieInfo);

      // Ëß£ÊûêÊí≠ÊîæÂú∞ÂùÄ
      const playUrlStr = movie.vod_play_url || movie.play_url || movie.vod_url || '';
      if (!playUrlStr) {
        resultsDiv.innerHTML += '<div style="text-align: center; padding: 40px; color: #999;">ËØ•ÂΩ±ÁâáÊöÇÊó†ÂèØÁî®Êí≠ÊîæÊ∫ê</div>';
        return;
      }

      // Ëß£ÊûêÊí≠ÊîæÊ∫êÔºàÊ†ºÂºè: Êí≠ÊîæÁªÑ$ÂêçÁß∞$URL#ÂêçÁß∞$URLÔºâ
      const playGroups = playUrlStr.split('$$$');

      playGroups.forEach((group, groupIndex) => {
        const episodes = group.split('#').filter(ep => ep.trim());

        if (episodes.length === 0) return;

        const groupDiv = document.createElement('div');
        groupDiv.style.cssText = 'margin-bottom: 20px;';

        const groupTitle = document.createElement('h3');
        groupTitle.textContent = `Êí≠ÊîæÊ∫ê ${groupIndex + 1}`;
        groupTitle.style.cssText = 'margin: 0 0 10px 0; font-size: 15px; color: #333;';
        groupDiv.appendChild(groupTitle);

        const episodesGrid = document.createElement('div');
        episodesGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;';

        episodes.forEach(episode => {
          const parts = episode.split('$');
          const episodeName = parts[0] || 'Êí≠Êîæ';
          const episodeUrl = parts[1] || parts[0];

          if (!episodeUrl) return;

          const episodeBtn = document.createElement('button');
          episodeBtn.textContent = episodeName;
          episodeBtn.style.cssText = 'padding: 10px; background: white; border: 1px solid #d0d0d0; border-radius: 4px; cursor: pointer; font-size: 13px; transition: all 0.2s;';
          episodeBtn.addEventListener('mouseenter', () => {
            episodeBtn.style.background = '#667eea';
            episodeBtn.style.color = 'white';
            episodeBtn.style.borderColor = '#667eea';
          });
          episodeBtn.addEventListener('mouseleave', () => {
            episodeBtn.style.background = 'white';
            episodeBtn.style.color = '#333';
            episodeBtn.style.borderColor = '#d0d0d0';
          });
          episodeBtn.addEventListener('click', () => {
            playMovieUrl(episodeUrl, `${movie.vod_name || movie.name} - ${episodeName}`);
          });

          episodesGrid.appendChild(episodeBtn);
        });

        groupDiv.appendChild(episodesGrid);
        resultsDiv.appendChild(groupDiv);
      });
    }

    // Êí≠ÊîæÂΩ±Áâá
    function playMovieUrl(url, title) {
      console.log('ÂáÜÂ§áÊí≠Êîæ:', url);

      // ÂÖ≥Èó≠ÊêúÁ¥¢ÂºπÁ™ó
      document.getElementById('watch-together-search-modal').classList.remove('visible');

      // Âä†ËΩΩËßÜÈ¢ë
      loadWatchTogetherVideoFromUrl(url);

      // ÊòæÁ§∫ÊèêÁ§∫
      addWatchTogetherSystemMessage(`Ê≠£Âú®Âä†ËΩΩ: ${title}`);
    }

    // Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ
    function addWatchTogetherSystemMessage(text) {
      const messagesDiv = document.getElementById('watch-together-chat-messages');
      const msgDiv = document.createElement('div');
      msgDiv.style.cssText = 'text-align: center; color: #999; font-size: 12px; padding: 10px; margin: 5px 0;';
      msgDiv.textContent = text;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // ========== ÂΩ±ËßÜÊêúÁ¥¢ÂäüËÉΩÁªìÊùü ==========
    // ========== ‰∏ÄËµ∑ÁúãÁîµÂΩ±ÂäüËÉΩÁªìÊùü ==========


    document.getElementById('add-quick-reply-btn').addEventListener('click', addNewQuickReply);



    document.getElementById('minimize-char-music-btn').addEventListener('click', minimizeCharMusicPlayer);


    document.getElementById('char-music-restore-btn').addEventListener('click', restoreCharMusicPlayer);


    makeDraggable(document.getElementById('char-music-restore-btn'), document.getElementById('char-music-restore-btn'));

    document.getElementById('imgbb-enable-switch').addEventListener('change', (e) => {
      document.getElementById('imgbb-settings-details').style.display = e.target.checked ? 'block' : 'none';
    });

    document.getElementById('imgbb-key-toggle').addEventListener('click', function () {
      const input = document.getElementById('imgbb-api-key');
      if (input.type === 'password') {
        input.type = 'text';
        this.textContent = 'üòå';
      } else {
        input.type = 'password';
        this.textContent = 'üßê';
      }
    });
    document.getElementById('catbox-enable-switch').addEventListener('change', (e) => {
      document.getElementById('catbox-settings-details').style.display = e.target.checked ? 'block' : 'none';
    });

    document.getElementById('catbox-key-toggle').addEventListener('click', function () {
      const input = document.getElementById('catbox-userhash');
      if (input.type === 'password') {
        input.type = 'text';
        this.textContent = 'üòå';
      } else {
        input.type = 'password';
        this.textContent = 'üßê';
      }
    });
    const biliSearchBtn = document.getElementById('char-bilibili-search-btn');
    if (biliSearchBtn) {
      biliSearchBtn.addEventListener('click', handleCharBilibiliSearch);
      console.log("BÁ´ôÊêúÁ¥¢ÊåâÈíÆÂ∑≤ÁªëÂÆö"); // Ë∞ÉËØïÊó•Âøó
    } else {
      console.error("Êâæ‰∏çÂà∞BÁ´ôÊêúÁ¥¢ÊåâÈíÆ (char-bilibili-search-btn)ÔºåËØ∑Ê£ÄÊü•HTML ID");
    }
    const regenBiliBtn = document.getElementById('regenerate-char-bilibili-btn');
    if (regenBiliBtn) {
      regenBiliBtn.addEventListener('click', handleGenerateSimulatedBilibili);
    }
    // 2. ÁªëÂÆöÂõûËΩ¶ÈîÆÊêúÁ¥¢
    const biliInput = document.getElementById('char-bilibili-search-input');
    if (biliInput) {
      biliInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleCharBilibiliSearch();
      });
    }
    const ghSwitch = document.getElementById('github-enable-switch');
    if (ghSwitch) {
      ghSwitch.addEventListener('change', (e) => {
        document.getElementById('github-settings-details').style.display = e.target.checked ? 'block' : 'none';
      });
    }

    // GitHub ÊåâÈíÆÂäüËÉΩÁªëÂÆö
    const ghUploadBtn = document.getElementById('github-upload-btn');
    if (ghUploadBtn) {
      const uploadHandler = () => uploadToGitHub(false);
      ghUploadBtn.addEventListener('click', uploadHandler);
      ghUploadBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        uploadHandler();
      }, { passive: false });
    }

    const ghUploadLargeBtn = document.getElementById('github-upload-large-btn');
    if (ghUploadLargeBtn) {
      const uploadLargeHandler = () => uploadToGitHubLargeData(false);
      ghUploadLargeBtn.addEventListener('click', uploadLargeHandler);
      ghUploadLargeBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        uploadLargeHandler();
      }, { passive: false });
    }

    const ghDownloadBtn = document.getElementById('github-download-btn');
    if (ghDownloadBtn) {
      ghDownloadBtn.addEventListener('click', restoreFromGitHub);
      ghDownloadBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        restoreFromGitHub();
      }, { passive: false });
    }
    const ghTokenToggle = document.getElementById('github-token-toggle');
    if (ghTokenToggle) {
      ghTokenToggle.addEventListener('click', function () {
        const input = document.getElementById('github-token');
        if (input.type === 'password') {
          input.type = 'text';
          this.textContent = 'üòå'; // ÁùÅÁúº
        } else {
          input.type = 'password';
          this.textContent = 'üßê'; // Èó≠Áúº
        }
      });
    }
    document.getElementById('toggle-reading-fullscreen-btn').addEventListener('click', toggleReadingFullscreen);

    // ========================================
    // ‚ñº‚ñº‚ñº ‰Ω†ÁîªÊàëÁåúÂäüËÉΩÔºàÂú®DOMContentLoadedÂÜÖÈÉ®‰ª•ËÆøÈóÆstateÔºâ‚ñº‚ñº‚ñº
    // ========================================

    /**
     * ÊâìÂºÄ‰Ω†ÁîªÊàëÁåúApp
     */
    function openDrawAndGuess() {
      // ÈáçÁΩÆÊâÄÊúâUIÂà∞ÂàùÂßãÁä∂ÊÄÅ
      document.getElementById('draw-guess-interactive-area').style.display = 'none';
      document.getElementById('draw-guess-welcome-text').style.display = 'block';
      document.getElementById('draw-guess-studio').style.display = 'none';
      document.getElementById('draw-guess-bottom-bar').style.display = 'none';
      document.getElementById('start-draw-guess-game-btn').textContent = 'ÂºÄÂßãÊ∏∏Êàè';
      document.getElementById('draw-guess-dialogue-box').textContent = '';
      document.getElementById('draw-guess-input').value = '';
      document.getElementById('draw-guess-action-bar').style.display = 'none';

      // ÈáçÁΩÆÊâÄÊúâÊ∏∏ÊàèÁä∂ÊÄÅ
      drawGuessState.isActive = false;
      drawGuessState.partnerId = null;
      drawGuessState.history = [];
      drawGuessState.isAiResponding = false;
      drawGuessState.messageManager = { isOpen: false, mode: null, selectedTimestamps: new Set() };

      showScreen('draw-guess-screen');
    }

    // ÊåÇËΩΩÂà∞ÂÖ®Â±ÄÂØπË±°Ôºå‰ΩøHTMLÁöÑonclickÂèØ‰ª•Ë∞ÉÁî®
    window.openDrawAndGuess = openDrawAndGuess;

    /**
     * ÁªòÂõæÊùøÂØπË±°
     */
    const drawingBoard = {
      canvas: null,
      ctx: null,
      isDrawing: false,
      lastX: 0,
      lastY: 0,
      history: [],
      tool: 'pen',
      color: '#000000',
      brushSize: 5,
      penType: 'pen',

      init(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.canvas.width = this.canvas.offsetWidth;
        this.canvas.height = this.canvas.offsetHeight;
        this.history = [];
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.saveState();
        this.addEventListeners();
      },

      addEventListeners() {
        this.handleDown = this.handleDown.bind(this);
        this.handleMove = this.handleMove.bind(this);
        this.handleUp = this.handleUp.bind(this);

        this.canvas.addEventListener('mousedown', this.handleDown);
        this.canvas.addEventListener('mousemove', this.handleMove);
        this.canvas.addEventListener('mouseup', this.handleUp);
        this.canvas.addEventListener('mouseleave', this.handleUp);

        this.canvas.addEventListener('touchstart', this.handleDown, { passive: false });
        this.canvas.addEventListener('touchmove', this.handleMove, { passive: false });
        this.canvas.addEventListener('touchend', this.handleUp);
      },

      getCoords(e) {
        const rect = this.canvas.getBoundingClientRect();
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        return {
          x: clientX - rect.left,
          y: clientY - rect.top
        };
      },

      handleDown(e) {
        e.preventDefault();
        this.isDrawing = true;
        const { x, y } = this.getCoords(e);
        [this.lastX, this.lastY] = [x, y];
        this.ctx.beginPath();
        this.ctx.moveTo(x, y);
      },

      handleMove(e) {
        if (!this.isDrawing) return;
        e.preventDefault();
        const { x, y } = this.getCoords(e);
        this.drawLine(this.lastX, this.lastY, x, y);
        [this.lastX, this.lastY] = [x, y];
      },

      handleUp() {
        if (!this.isDrawing) return;
        this.isDrawing = false;
        this.ctx.closePath();
        this.saveState();
      },

      drawLine(x1, y1, x2, y2) {
        this.ctx.beginPath();

        if (this.tool === 'eraser') {
          this.ctx.globalCompositeOperation = 'destination-out';
          this.ctx.strokeStyle = 'rgba(0,0,0,1)';
        } else {
          this.ctx.globalCompositeOperation = 'source-over';
          this.ctx.strokeStyle = this.color;
        }

        this.ctx.lineWidth = this.brushSize;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';

        switch (this.penType) {
          case 'pencil':
            this.ctx.globalAlpha = 0.4;
            this.ctx.lineWidth = this.brushSize * 0.5;
            break;
          case 'watercolor':
            this.ctx.globalAlpha = 0.2;
            break;
          case 'brush':
            this.ctx.globalAlpha = 0.8;
            this.ctx.lineWidth = Math.random() * (this.brushSize - 2) + 2;
            break;
          case 'calligraphy':
            this.ctx.globalAlpha = 1;
            const distance = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            this.ctx.lineWidth = Math.max(this.brushSize - distance / 2, 1);
            break;
          case 'pen':
          default:
            this.ctx.globalAlpha = 1;
            break;
        }

        this.ctx.moveTo(x1, y1);
        this.ctx.lineTo(x2, y2);
        this.ctx.stroke();
        this.ctx.globalAlpha = 1.0;
      },

      saveState() {
        if (this.history.length >= 20) {
          this.history.shift();
        }
        this.history.push(this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height));
      },

      undo() {
        if (this.history.length > 1) {
          this.history.pop();
          this.ctx.putImageData(this.history[this.history.length - 1], 0, 0);
        } else {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          this.history = [];
          this.saveState();
        }
      },

      setTool(tool) {
        this.tool = tool;
        document.getElementById('pen-settings').style.display = tool === 'pen' ? 'block' : 'none';
      },

      setColor(color) {
        this.color = color;
      },

      setSize(size) {
        this.brushSize = size;
      },

      setPenType(type) {
        this.penType = type;
      },

      clearCanvas() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.history = [];
        this.saveState();
      }
    };

    /**
     * ÈÄâÊã©ËßíËâ≤Âπ∂ÂºÄÂßãÊ∏∏Êàè
     */
    async function setupDrawAndGuessSession(characterId) {
      if (!characterId) return;

      drawGuessState.isActive = true;
      drawGuessState.partnerId = characterId;
      drawGuessState.history = [];

      const chat = state.chats[characterId];
      if (!chat) return;

      const userAvatar = chat.settings.myAvatar || defaultAvatar;
      const userNickname = chat.settings.myNickname || 'Êàë';
      const charAvatar = chat.settings.aiAvatar || defaultAvatar;
      const charNickname = chat.name;

      document.getElementById('draw-guess-user-avatar').src = userAvatar;
      document.getElementById('draw-guess-user-name').textContent = userNickname;
      document.getElementById('draw-guess-char-avatar').src = charAvatar;
      document.getElementById('draw-guess-char-name').textContent = charNickname;

      document.getElementById('draw-guess-interactive-area').style.display = 'flex';
      document.getElementById('draw-guess-welcome-text').style.display = 'none';
      document.getElementById('draw-guess-bottom-bar').style.display = 'block';

      showScreen('draw-guess-screen');

      await triggerDrawAndGuessAiResponse(true);
      document.getElementById('draw-guess-action-bar').style.display = 'flex';
    }

    /**
     * ÂèëÈÄÅÊ∂àÊÅØ
     */
    function sendDrawGuessMessage() {
      const input = document.getElementById('draw-guess-input');
      const content = input.value.trim();
      if (!content || !drawGuessState.partnerId) return;

      const chat = state.chats[drawGuessState.partnerId];
      if (!chat) return;

      const userMessage = {
        sender: chat.settings.myNickname || 'Êàë',
        content: content,
        timestamp: Date.now()
      };

      drawGuessState.history.push(userMessage);
      appendDrawGuessMessage(userMessage);

      input.value = '';
      handleDrawGuessInput();
    }

    /**
     * Ê∑ªÂä†Ê∂àÊÅØÂà∞ÂØπËØùÊ°Ü
     */
    function appendDrawGuessMessage(msg) {
      const dialogueBox = document.getElementById('draw-guess-dialogue-box');
      dialogueBox.removeAttribute('data-placeholder');

      const p = document.createElement('p');
      p.textContent = `${msg.sender}: ${msg.content}`;
      p.style.margin = '4px 0';
      p.style.color = 'var(--text-primary)';
      p.dataset.timestamp = msg.timestamp;
      dialogueBox.appendChild(p);
      dialogueBox.scrollTop = dialogueBox.scrollHeight;
      return p;
    }

    /**
     * Â§ÑÁêÜËæìÂÖ•Ê°ÜÂèòÂåñ
     */
    function handleDrawGuessInput() {
      const input = document.getElementById('draw-guess-input');
      const actionBar = document.getElementById('draw-guess-action-bar');
      if (input.value.trim()) {
        actionBar.style.display = 'flex';
      } else {
        actionBar.style.display = 'none';
      }
    }

    /**
     * ÈáçËØ¥ÂäüËÉΩ
     */
    async function handleDrawGuessResay() {
      const chat = state.chats[drawGuessState.partnerId];
      if (!chat) return;

      const userNickname = chat.settings.myNickname || 'Êàë';
      const lastAiMsgIndex = drawGuessState.history.findLastIndex(msg => msg.sender !== userNickname);

      if (lastAiMsgIndex === -1) {
        alert("ËøòÊ≤°ÊúâAIÁöÑÂõûÂ§çÂèØ‰æõÈáçËØ¥„ÄÇ");
        return;
      }

      let firstAiMsgIndex = lastAiMsgIndex;
      while (firstAiMsgIndex > 0 && drawGuessState.history[firstAiMsgIndex - 1].sender !== userNickname) {
        firstAiMsgIndex--;
      }

      drawGuessState.history.splice(firstAiMsgIndex);

      const dialogueBox = document.getElementById('draw-guess-dialogue-box');
      dialogueBox.innerHTML = '';
      drawGuessState.history.forEach(appendDrawGuessMessage);
    }

    /**
     * AIÁªòÁîªÂä®Áîª
     */
    async function playAiDrawingAnimation(paths) {
      const ctx = drawingBoard.ctx;
      if (!ctx) return;

      drawingBoard.canvas.classList.remove('active');
      drawingBoard.canvas.style.pointerEvents = 'none';

      for (const path of paths) {
        const points = path.points;
        if (!points || points.length < 2) continue;

        ctx.strokeStyle = path.color || '#000000';
        ctx.lineWidth = path.size || 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        ctx.beginPath();
        ctx.moveTo(points[0][0], points[0][1]);

        for (let i = 1; i < points.length; i++) {
          ctx.lineTo(points[i][0], points[i][1]);
          ctx.stroke();
          await new Promise(resolve => setTimeout(resolve, 50));
        }

        drawingBoard.saveState();
        await new Promise(resolve => setTimeout(resolve, Math.random() * 500 + 200));
      }

      drawingBoard.canvas.classList.add('active');
      drawingBoard.canvas.style.pointerEvents = 'auto';
    }

    /**
     * AIÂÜ≥ÂÆöË¶ÅÁîª‰ªÄ‰πà
     */
    async function decideAiDrawing(retryCount = 0) {
      if (retryCount > 2) {
        throw new Error("AIËøûÁª≠Â§öÊ¨°Êú™ËÉΩÁîüÊàêÊúâÊïàÁöÑÁªòÁîªÊï∞ÊçÆÔºåËØ∑Ê£ÄÊü•PromptÊàñAPIÊ®°Âûã„ÄÇ");
      }

      const chat = state.chats[drawGuessState.partnerId];
      const { proxyUrl, apiKey, model } = state.apiConfig;

      const mainChatHistory = chat.history.slice(-5).map(msg => `${msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : chat.name}: ${String(msg.content)}`).join('\\n');
      const drawGuessHistory = drawGuessState.history.map(msg => `${msg.sender}: ${msg.content}`).join('\\n');

      const systemPrompt = `# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑Áé©"‰Ω†ÁîªÊàëÁåú"Ê∏∏ÊàèÔºåÁé∞Âú®ËΩÆÂà∞‰Ω†ÁîªÁîª‰∫Ü„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÔºö
1. Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÅ‰Ω†‰ª¨ÁöÑÂØπËØùÂéÜÂè≤ÔºåÊÉ≥‰∏Ä‰∏™„ÄêÁÆÄÂçï„ÄÅÂèØ‰ª•Áî®Âá†Á¨îÁîªÂá∫Êù•„ÄëÁöÑÁâ©‰ΩìÊàñÊ¶ÇÂøµ„ÄÇ
2. Â∞ÜËøô‰∏™Áâ©‰ΩìÁöÑÁªòÁîªËøáÁ®ãÔºåÊèèËø∞Êàê‰∏Ä‰∏™Áî±ÂùêÊ†áÂíåÈ¢úËâ≤ÁªÑÊàêÁöÑJSONÊï∞ÊçÆ„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1. **‰∏ªÈ¢òÁÆÄÂçï**: ÂøÖÈ°ªÈÄâÊã©ÈùûÂ∏∏ÁÆÄÂçïÁöÑ„ÄÅËÉΩÁî®Âá†Á¨îÁ∫øÊù°Â∞±ÂãæÂãíÂá∫ËΩÆÂªìÁöÑÁâ©‰Ωì„ÄÇ‰æãÂ¶ÇÔºöËãπÊûú„ÄÅÂ§™Èò≥„ÄÅÁà±ÂøÉ„ÄÅÈ±º„ÄÅÁå´ÁöÑÁÆÄÁ¨îÁîªËΩÆÂªì„ÄÅÊàøÂ≠ê„ÄÇ
2. **ÁªòÁîªÁÆÄÊ¥Å**: Êï¥‰∏™ÁªòÁîªËøáÁ®ãÁöÑ„ÄêÊÄªÁ¨îÁîªÊï∞ÔºàpathsÊï∞ÁªÑÁöÑÈïøÂ∫¶Ôºâ‰∏çËÉΩË∂ÖËøá15Á¨î„Äë„ÄÇ
3. **Ê†ºÂºèÈìÅÂæã**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°„ÄÇÊ†ºÂºèÂ¶Ç‰∏ã:
{
  "topic": "‰Ω†ÁîªÁöÑËøô‰∏™‰∏úË•øÁöÑ‰∏≠ÊñáÂêçÔºå‰æãÂ¶ÇÔºö‰∏ÄÂè™Áå´",
  "paths": [
    { "color": "#000000", "size": 3, "points": [[x1, y1], [x2, y2], [x3, y3]] },
    { "color": "#ff3b30", "size": 5, "points": [[x4, y4], [x5, y5]] }
  ]
}

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†‰ª¨Âú®‰∏ªËÅäÂ§©ÈáåÁöÑÂØπËØù**: ${mainChatHistory || 'Êó†'}
- **‰Ω†‰ª¨Âú®Ëøô‰∏™Ê∏∏ÊàèÈáåÁöÑÂØπËØù**: ${drawGuessHistory || 'Êó†'}

Áé∞Âú®ÔºåËØ∑ÊûÑÊÄù‰∏Ä‰∏™ÁÆÄÂçïÁöÑÁâ©‰ΩìÔºåÂπ∂ÁîüÊàêÂÆÉÁöÑÁªòÁîªË∑ØÂæÑJSON„ÄÇ`;

      let messagesForApi;
      if (retryCount > 0) {
        messagesForApi = [{ role: 'user', content: `‰Ω†‰∏äÊ¨°ÁöÑÂõûÂ§çÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑‰∏•Ê†ºÈÅµÂÆà"Ê†ºÂºèÈìÅÂæã"ÔºåÂè™ËøîÂõû‰∏Ä‰∏™Á∫ØÁ≤πÁöÑJSONÂØπË±°Ôºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïÈ¢ùÂ§ñÁöÑÊñáÂ≠ó„ÄÇÁé∞Âú®ËØ∑ÈáçÊñ∞ÁîüÊàê„ÄÇ` }];
      } else {
        messagesForApi = [{ role: 'user', content: "ËΩÆÂà∞‰Ω†Áîª‰∫ÜÔºåËØ∑ÂÜ≥ÂÆöË¶ÅÁîª‰ªÄ‰πàÂπ∂ÁªôÂá∫ÁªòÁîªÊï∞ÊçÆ„ÄÇ" }];
      }

      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini
        ? await fetch(geminiConfig.url, geminiConfig.data)
        : await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
          body: JSON.stringify({ model, messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi], temperature: 1.0, response_format: { "type": "json_object" } })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);
      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      try {
        const parsedJson = robustJsonParse(aiResponseContent);
        if (!parsedJson || !parsedJson.topic || !Array.isArray(parsedJson.paths)) {
          throw new Error('Ëß£ÊûêÂá∫ÁöÑJSONÁº∫Â∞ëÂøÖË¶ÅÁöÑtopicÊàñpathsÂ≠óÊÆµ„ÄÇ');
        }
        return parsedJson;
      } catch (e) {
        console.error(`AIÁªòÁîªÊï∞ÊçÆËß£ÊûêÂ§±Ë¥• (Á¨¨ ${retryCount + 1} Ê¨°Â∞ùËØï):`, e);
        console.error("AIÂéüÂßãËøîÂõûÂÜÖÂÆπ:", aiResponseContent);
        return decideAiDrawing(retryCount + 1);
      }
    }

    /**
     * ËΩÆÂà∞AIÁîªÁîª
     */
    async function handleAiTurnToDraw() {
      if (drawGuessState.isAiResponding) return;

      await showCustomAlert("ËØ∑Á®çÂÄô...", "ÂØπÊñπÊ≠£Âú®ÊÄùËÄÉË¶ÅÁîª‰ªÄ‰πà...");

      try {
        document.getElementById('draw-guess-welcome-text').style.display = 'none';
        document.getElementById('draw-guess-studio').style.display = 'flex';
        document.getElementById('drawing-canvas').classList.add('active');

        drawingBoard.ctx.clearRect(0, 0, drawingBoard.canvas.width, drawingBoard.canvas.height);
        drawingBoard.history = [];
        drawingBoard.saveState();

        const drawingData = await decideAiDrawing();
        if (!drawingData || !drawingData.paths) throw new Error("AIÊú™ËÉΩÂÜ≥ÂÆöË¶ÅÁîª‰ªÄ‰πàÊàñËøîÂõû‰∫ÜÊó†ÊïàÁöÑÁªòÁîªÊï∞ÊçÆ„ÄÇ");

        await playAiDrawingAnimation(drawingData.paths);

        await showCustomAlert("‰ªñÁîªÂÆåÂï¶ÔºÅ", "Âø´Âú®‰∏äÈù¢ÁöÑÂØπËØùÊ°ÜÈáåÁåúÁåúÁúã‰ªñÁîªÁöÑÊòØ‰ªÄ‰πàÂêßÔºÅ");

        const hiddenMessageForAi = {
          role: 'system',
          content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöÁîªÂÆå‰∫Ü‰∏ÄÂπÖÂÖ≥‰∫é"${drawingData.topic}"ÁöÑÁîª„ÄÇÁé∞Âú®ËΩÆÂà∞Áî®Êà∑ÁåúÊµã‰∫ÜÔºåËØ∑Ê†πÊçÆTAÁöÑÁåúÊµãÁªôÂá∫ÂõûÂ∫î„ÄÇ]`,
          timestamp: Date.now(),
          isHidden: true
        };
        const chat = state.chats[drawGuessState.partnerId];
        chat.history.push(hiddenMessageForAi);
        await db.chats.put(chat);

      } catch (error) {
        console.error("AIÁªòÁîªÊµÅÁ®ãÂá∫Èîô:", error);
        await showCustomAlert("Âá∫Èîô‰∫Ü", `AIÂú®ÁªòÁîªÊó∂ÈÅáÂà∞‰∫ÜÈóÆÈ¢ò: ${error.message}`);
        document.getElementById('draw-guess-studio').style.display = 'flex';
        document.getElementById('draw-guess-welcome-text').style.display = 'none';
      }
    }

    /**
     * AIÂá∫È¢òÂäüËÉΩ
     */
    async function handleGetTopicFromAi() {
      if (!drawGuessState.partnerId) return;

      const chat = state.chats[drawGuessState.partnerId];
      const { proxyUrl, apiKey, model } = state.apiConfig;
      const userNickname = chat.settings.myNickname || 'Êàë';

      // Ëé∑Âèñ‰∏ä‰∏ãÊñá‰ø°ÊÅØ
      const aiPersona = chat.settings.aiPersona || '‰∏Ä‰∏™ÂèãÂ•ΩÁöÑÂØπËØù‰ºô‰º¥';
      const myPersona = chat.settings.myPersona || 'Áî®Êà∑';

      const worldBookContext = (chat.settings.linkedWorldBookIds || []).map(bookId =>
        state.worldBooks.find(wb => wb.id === bookId)
      ).filter(Boolean).map(book =>
        `## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`
      ).join('\n');

      const longTermMemory = chat.longTermMemory && chat.longTermMemory.length > 0
        ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n')
        : '';

      const shortTermMemory = chat.history.slice(-10).map(msg =>
        `${msg.role === 'user' ? userNickname : chat.name}: ${String(msg.content)}`
      ).join('\n');

      let systemPrompt;
      if (drawGuessState.mode === 'online') {
        systemPrompt = `‰Ω†Áé∞Âú®ÊâÆÊºî: ${chat.name}
‰Ω†ÁöÑ‰∫∫ËÆæ: ${aiPersona}

Áî®Êà∑Âêç: ${userNickname}
Áî®Êà∑‰∫∫ËÆæ: ${myPersona}

‰Ω†Ê≠£Âú®ÈÄöËøá„ÄêÁ∫ø‰∏äËÅäÂ§©„ÄëÂíå${userNickname}Áé©"‰Ω†ÁîªÊàëÁåú"Ê∏∏Êàè„ÄÇÁî®Êà∑ËÆ©‰Ω†Âá∫‰∏Ä‰∏™ÁªòÁîªÈ¢òÁõÆ„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
‰∏ñÁïåËßÇ: ${worldBookContext || 'ÔºàÊöÇÊó†Ôºâ'}
ÈïøÊúüËÆ∞ÂøÜ: ${longTermMemory || 'ÔºàÊöÇÊó†Ôºâ'}
ÊúÄËøëÂØπËØù: ${shortTermMemory || 'ÔºàÊöÇÊó†Ôºâ'}

# Ë¶ÅÊ±Ç
1. ÁªôÁî®Êà∑Âá∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑÁªòÁîªÈ¢òÁõÆÔºàÂèØ‰ª•Áî®ÁÆÄÁ¨îÁîªÁîªÂá∫Êù•ÁöÑÁâ©‰ΩìÊàñÊ¶ÇÂøµÔºâ
2. Áî®Ëá™ÁÑ∂ÁöÑÁ∫ø‰∏äËÅäÂ§©ÊñπÂºèÈÇÄËØ∑TAÁîª
3. ÂèØ‰ª•ÂàÜÊàêÂ§öÊù°Ê∂àÊÅØÔºåÊØèÊù°‰∏çË∂ÖËøá30Â≠ó
4. ‰∏çË¶ÅÊúâ‰ªª‰ΩïÁ∫ø‰∏ãÂä®‰ΩúÊèèÂÜô

ËØ∑Áõ¥Êé•ÂõûÂ§ç‰Ω†ÊÉ≥ËØ¥ÁöÑÂÜÖÂÆπÔºåÂ¶ÇÊûúÊúâÂ§öÊù°Ê∂àÊÅØÁî®Êç¢Ë°åÁ¨¶ÂàÜÈöî„ÄÇÊ†ºÂºè‰æãÂ¶ÇÔºö
"ËØ∂ÔºÅ"
"ÊàëÊÉ≥Âà∞‰∏Ä‰∏™ÁÆÄÂçïÁöÑ~"
"‰Ω†Êù•Áîª‰∏Ä‰∏™ËãπÊûúÂêßÔºÅ"`;
      } else {
        systemPrompt = `‰Ω†Ê≠£Âú®Âíå${userNickname}Áé©"‰Ω†ÁîªÊàëÁåú"Ê∏∏Êàè„ÄÇËØ∑ÁªôÁî®Êà∑Âá∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑÁªòÁîªÈ¢òÁõÆÔºà‰∏Ä‰∏™ÂèØ‰ª•Áî®ÁÆÄÁ¨îÁîªÁîªÂá∫Êù•ÁöÑÁâ©‰ΩìÊàñÊ¶ÇÂøµÔºâÔºåÂπ∂Áî®‰∏ÄÂè•ËØùÂêëTAÂèëÂá∫ÈÇÄËØ∑„ÄÇ

‰Ω†ÁöÑ‰∫∫ËÆæ: ${aiPersona}
Áî®Êà∑‰∫∫ËÆæ: ${myPersona}

‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá:
‰∏ñÁïåËßÇ: ${worldBookContext || 'ÔºàÊöÇÊó†Ôºâ'}
ÈïøÊúüËÆ∞ÂøÜ: ${longTermMemory || 'ÔºàÊöÇÊó†Ôºâ'}
ÊúÄËøëÂØπËØù: ${shortTermMemory || 'ÔºàÊöÇÊó†Ôºâ'}

ËØ∑Áõ¥Êé•ÂõûÂ§çÔºåÊ†ºÂºè‰æãÂ¶ÇÔºö"Êù•ÔºåÁîª‰∏Ä‰∏™ËãπÊûúÂêßÔºÅ"`;
      }

      const messagesForApi = [{ role: 'user', content: "ËØ∑ÁªôÊàëÂá∫‰∏™È¢òÂêß" }];

      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      try {
        const response = isGemini
          ? await fetch(geminiConfig.url, geminiConfig.data)
          : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ model, messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi] })
          });

        if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);
        const data = await response.json();
        const aiTopic = getGeminiResponseText(data);

        // Â§ÑÁêÜÂõûÂ§çÔºàÁ∫ø‰∏äÊ®°ÂºèÊîØÊåÅÂ§öÊù°Ê∂àÊÅØÔºâ
        if (drawGuessState.mode === 'online') {
          const messages = aiTopic.split('\n').filter(msg => msg.trim());
          for (const msgContent of messages) {
            const aiMessage = {
              sender: chat.name,
              content: msgContent.trim(),
              timestamp: Date.now()
            };
            drawGuessState.history.push(aiMessage);
            appendDrawGuessMessage(aiMessage);
            if (messages.length > 1) {
              await new Promise(resolve => setTimeout(resolve, 300));
            }
          }
        } else {
          const aiMessage = {
            sender: chat.name,
            content: aiTopic,
            timestamp: Date.now()
          };
          drawGuessState.history.push(aiMessage);
          appendDrawGuessMessage(aiMessage);
        }

      } catch (error) {
        console.error("AIÂá∫È¢òÂ§±Ë¥•:", error);
        await showCustomAlert("Âá∫È¢òÂ§±Ë¥•", `Êó†Ê≥ïËé∑ÂèñÈ¢òÁõÆ: ${error.message}`);
      }
    }

    /**
     * Ëß¶ÂèëAIÂìçÂ∫î
     */
    async function triggerDrawAndGuessAiResponse(isInitial = false, imageBase64 = null) {
      if (drawGuessState.isAiResponding || !drawGuessState.isActive || !drawGuessState.partnerId) return;

      drawGuessState.isAiResponding = true;

      const dialogueBox = document.getElementById('draw-guess-dialogue-box');
      if (dialogueBox.childElementCount === 0) {
        dialogueBox.setAttribute('data-placeholder', 'ÂØπÊñπÊ≠£Âú®ÊÄùËÄÉ...');
      }

      try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) throw new Error('APIÊú™ÈÖçÁΩÆ');

        const chat = state.chats[drawGuessState.partnerId];
        const userNickname = chat.settings.myNickname || 'Êàë';

        // ÊûÑÂª∫Êõ¥ÂÆåÊï¥ÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ

        // 1. ÂèåÊñπ‰∫∫ËÆæ
        const aiPersona = chat.settings.aiPersona || '‰∏Ä‰∏™ÂèãÂ•ΩÁöÑÂØπËØù‰ºô‰º¥';
        const myPersona = chat.settings.myPersona || 'Áî®Êà∑';

        // 2. ‰∏ñÁïå‰π¶
        const worldBookContext = (chat.settings.linkedWorldBookIds || []).map(bookId =>
          state.worldBooks.find(wb => wb.id === bookId)
        ).filter(Boolean).map(book =>
          `## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`
        ).join('\n');

        // 3. ÈïøÊúüËÆ∞ÂøÜ
        const longTermMemory = chat.longTermMemory && chat.longTermMemory.length > 0
          ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n')
          : '';

        // 4. Áü≠ÊúüËÆ∞ÂøÜÔºà‰∏ªËÅäÂ§©ÊúÄËøëÁöÑÂØπËØùÔºâ
        const shortTermMemory = chat.history.slice(-15).map(msg =>
          `${msg.role === 'user' ? userNickname : chat.name}: ${String(msg.content)}`
        ).join('\n');

        // 5. ÊåÇËΩΩÁöÑËÅäÂ§©ËÆ∞ÂΩï
        let linkedChatsContext = '';
        if (chat.settings.linkedChatIds && chat.settings.linkedChatIds.length > 0) {
          const linkedMemories = [];
          for (const linkedId of chat.settings.linkedChatIds) {
            const linkedChat = state.chats[linkedId];
            if (linkedChat && linkedChat.history.length > 0) {
              const recentMessages = linkedChat.history.slice(-5).map(msg =>
                `${msg.role === 'user' ? userNickname : linkedChat.name}: ${String(msg.content)}`
              ).join('\n');
              linkedMemories.push(`\n### ÂÖ≥ËÅîËÅäÂ§©ËÆ∞ÂΩïÔºàÊù•Ëá™ ${linkedChat.name}Ôºâ:\n${recentMessages}`);
            }
          }
          linkedChatsContext = linkedMemories.join('\n');
        }

        // 6. Ê∏∏ÊàèÂÜÖÂØπËØùÂéÜÂè≤
        const drawGuessHistory = drawGuessState.history.map(msg => `${msg.sender}: ${msg.content}`).join('\n');

        const canvasContentDescription = imageBase64 ? "(Áî®Êà∑ÂàöÂàöÁîªÂÆå‰∫Ü‰∏ÄÂπÖÁîªÔºåÂõæÁâáÂÜÖÂÆπÂ¶Ç‰∏ãÔºåËØ∑‰Ω†ÁåúÊµã„ÄÇ)" : "(ÂΩìÂâçÁîªÊùø‰∏∫Á©∫)";

        let systemPrompt;

        if (drawGuessState.mode === 'online') {
          // Á∫ø‰∏äÊ®°ÂºèÔºöÊó†Á∫ø‰∏ãÊèèÂÜôÔºåÊîØÊåÅÂ§öÊù°Ê∂àÊÅØ
          let finalInstruction;
          if (isInitial) {
            finalInstruction = 'ËøôÊòØ‰Ω†‰ª¨Á¨¨‰∏ÄÊ¨°Âú®Á∫ø‰∏äÊâìÂºÄËøô‰∏™Ê∏∏Êàè„ÄÇËØ∑‰Ω†‰∏ªÂä®ËØ¥Âá†Âè•ËØùÔºåÊØîÂ¶ÇÊâì‰∏™ÊãõÂëº„ÄÅË°®ËææÂØπÊ∏∏ÊàèÁöÑÊúüÂæÖ„ÄÅÊàñËÄÖÊèêËÆÆÊ∏∏ÊàèËßÑÂàô„ÄÇ';
          } else if (imageBase64) {
            finalInstruction = 'Áî®Êà∑ÂàöÂàöÂú®Á∫ø‰∏äÂèëÊù•‰∫Ü‰∏ÄÂπÖÁîª„ÄÇËØ∑‰Ω†Ê†πÊçÆÂõæÁâáÂÜÖÂÆπ„ÄÅ‰Ω†ÁöÑ‰∫∫ËÆæÂíåÂØπËØùÂéÜÂè≤ÔºåÂºÄÂßã‰Ω†ÁöÑÁåúÊµã„ÄÇ‰Ω†ÂèØ‰ª•ÂÖàÊèèËø∞‰Ω†ÁúãÂà∞‰∫Ü‰ªÄ‰πàÔºåÁÑ∂ÂêéÊèêÂá∫ÂèØËÉΩÁöÑÁ≠îÊ°à„ÄÇ';
          } else {
            finalInstruction = 'ËØ∑Ê†πÊçÆÂØπËØùÂéÜÂè≤Ëá™ÁÑ∂ÂõûÂ∫î„ÄÇ';
          }

          systemPrompt = `# ‰Ω†ÁöÑË∫´‰ªΩ
‰Ω†Áé∞Âú®ÊâÆÊºî: ${chat.name}
‰Ω†ÁöÑ‰∫∫ËÆæ: ${aiPersona}

# Áî®Êà∑ÁöÑË∫´‰ªΩ
Áî®Êà∑Âêç: ${userNickname}
Áî®Êà∑‰∫∫ËÆæ: ${myPersona}

# ÂΩìÂâçÊÉÖÂÜµ
‰Ω†Ê≠£Âú®ÈÄöËøá„ÄêÁ∫ø‰∏äËÅäÂ§©„ÄëÂíå${userNickname}Áé©"‰Ω†ÁîªÊàëÁåú"Ê∏∏Êàè„ÄÇËøôÊòØ‰∏Ä‰∏™Á∫ø‰∏ä‰∫íÂä®Ôºå‰Ω†‰ª¨‰∏çÂú®Âêå‰∏Ä‰∏™Âú∞ÁÇπ„ÄÇ
ÁîªÊùøÂÜÖÂÆπ: ${canvasContentDescription}

# „ÄêÂØπËØùËäÇÂ•èÈìÅÂæãÔºàËá≥ÂÖ≥ÈáçË¶ÅÔºÅÔºâ„Äë
‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊ®°ÊãüÁúü‰∫∫Âú®Á∫øËÅäÂ§©ÁöÑÊâìÂ≠ó‰π†ÊÉØ„ÄÇ**ÁªùÂØπ‰∏çË¶Å‰∏ÄÊ¨°ÊÄßÂèëÈÄÅ‰∏ÄÂ§ßÊÆµÊñáÂ≠óÔºÅ** ‰Ω†Â∫îËØ•Â∞Ü‰Ω†ÊÉ≥ËØ¥ÁöÑËØùÔºåÊãÜÂàÜÊàê„ÄêÂ§öÊù°„ÄÅÁÆÄÁü≠ÁöÑ„ÄëÊ∂àÊÅØÊù•ÂèëÈÄÅÔºåÊØèÊù°Ê∂àÊÅØÊúÄÂ•Ω‰∏çË¶ÅË∂ÖËøá30‰∏™Â≠ó„ÄÇËøô‰ºöËÆ©ÂØπËØùÁúãËµ∑Êù•Êõ¥Ëá™ÁÑ∂„ÄÅÊõ¥ÁúüÂÆû„ÄÇ

‰∏æ‰æãÔºö
- ‚ùå ÈîôËØØÔºö"ÂìáÔºÅ‰Ω†ÁîªÁöÑËøô‰∏™ÁúüÊúâÊÑèÊÄùÔºåËÆ©ÊàëÊÉ≥ÊÉ≥...Ëøô‰∏™ÂúÜÂúÜÁöÑÂΩ¢Áä∂ÔºåËøòÊúâ‰∏äÈù¢ÁöÑÂ∞èÁÇπÔºå‰ºö‰∏ç‰ºöÊòØ‰∏Ä‰∏™ËãπÊûúÔºü‰∏çÂØπÔºåÊÑüËßâÊõ¥ÂÉèÊòØ‰∏Ä‰∏™Â§™Èò≥Âë¢ÔºÅ"
- ‚úÖ Ê≠£Á°ÆÔºö
  Ê∂àÊÅØ1: "ÂìáÔºÅ‰Ω†ÁîªÁöÑËøô‰∏™ÁúüÊúâÊÑèÊÄù"
  Ê∂àÊÅØ2: "ËÆ©ÊàëÊÉ≥ÊÉ≥..."
  Ê∂àÊÅØ3: "Ëøô‰∏™ÂúÜÂúÜÁöÑÂΩ¢Áä∂"
  Ê∂àÊÅØ4: "ËøòÊúâ‰∏äÈù¢ÁöÑÂ∞èÁÇπ"
  Ê∂àÊÅØ5: "‰ºö‰∏ç‰ºöÊòØ‰∏Ä‰∏™ËãπÊûúÔºü"
  Ê∂àÊÅØ6: "‰∏çÂØπÔºåÊÑüËßâÊõ¥ÂÉèÊòØ‰∏Ä‰∏™Â§™Èò≥Âë¢ÔºÅ"

# Ê†∏ÂøÉËßÑÂàô
1. **„ÄêÁ∫ø‰∏äÂú∫ÊôØ„Äë**: ‰Ω†‰ª¨Âú®Á∫ø‰∏äËÅäÂ§©Ôºå‰∏çÂú®Âêå‰∏Ä‰∏™Âú∞ÁÇπ„ÄÇ„ÄêÁ¶ÅÊ≠¢„ÄëÂá∫Áé∞‰ªª‰ΩïÁ∫ø‰∏ãËßÅÈù¢ÁöÑÊèèÂÜôÔºåÂ¶Ç"Ëµ∞ËøáÊù•"„ÄÅ"ÊãøËµ∑Á¨î"„ÄÅ"ÁúãÂêë‰Ω†"Á≠âÂä®‰ΩúÊèèËø∞„ÄÇ
2. **„ÄêÁ∫ØÊñáÂ≠ó‰∫§ÊµÅ„Äë**: ‰Ω†Âè™ËÉΩÈÄöËøáÊñáÂ≠óË°®ËææÔºåÂèØ‰ª•‰ΩøÁî®ËØ≠Ê∞îËØç„ÄÅË°®ÊÉÖÁ¨¶Âè∑Ôºå‰ΩÜ‰∏çËÉΩÊèèËø∞ËÇ¢‰ΩìÂä®‰ΩúÊàñË°®ÊÉÖ„ÄÇ
3. **„ÄêÂ§öÊù°Ê∂àÊÅØ„Äë**: ‰Ω†ÁöÑÂõûÂ§çÂ∫îËØ•Ëá™ÁÑ∂Âú∞ÊãÜÂàÜÊàêÂ§öÊù°Ê∂àÊÅØÔºåÂ∞±ÂÉèÁúü‰∫∫Âú®Á∫øËÅäÂ§©Êó∂ÁöÑËäÇÂ•è„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá

## ‰∏ñÁïåËßÇËÆæÂÆö
${worldBookContext || 'ÔºàÊöÇÊó†Ôºâ'}

## ÈïøÊúüËÆ∞ÂøÜÔºà‰Ω†‰ª¨‰πãÈó¥ÁöÑÈáçË¶ÅËÆ∞ÂøÜÔºâ
${longTermMemory || 'ÔºàÊöÇÊó†Ôºâ'}
${linkedChatsContext}

## Áü≠ÊúüËÆ∞ÂøÜÔºà‰Ω†‰ª¨ÊúÄËøëÂú®‰∏ªËÅäÂ§©ÁöÑÂØπËØùÔºâ
${shortTermMemory || 'ÔºàÊöÇÊó†Ôºâ'}

## Ê∏∏ÊàèÂÜÖÂØπËØùÔºàÊú¨Ê¨°Ê∏∏Êàè‰∏≠ÁöÑÂØπËØùÔºâ
${drawGuessHistory || 'ÔºàÊ∏∏ÊàèÂàöÂºÄÂßãÔºâ'}

# ‰Ω†ÁöÑ‰ªªÂä°
${finalInstruction}

ËØ∑Áõ¥Êé•ÂõûÂ§ç‰Ω†ÊÉ≥ËØ¥ÁöÑÂÜÖÂÆπÔºåÂ∞Ü‰Ω†ÁöÑËØùËá™ÁÑ∂Âú∞ÂàÜÊàêÂ§öÊù°Ê∂àÊÅØ„ÄÇÊØèÊù°Ê∂àÊÅØ‰πãÈó¥Áî®Êç¢Ë°åÁ¨¶Ôºà\nÔºâÂàÜÈöî„ÄÇ‰∏çË¶ÅÂä†‰ªª‰ΩïJSONÊ†ºÂºèÊàñÂâçÁºÄÂêéÁºÄ„ÄÇ`;
        } else {
          // Á∫ø‰∏ãÊ®°ÂºèÔºö‰øùÁïôÂéüÊúâÁöÑÊèêÁ§∫ËØçÔºàÊúâÁ∫ø‰∏ãÊèèÂÜôÔºâ
          let finalInstruction;
          if (isInitial) {
            finalInstruction = 'ËøôÊòØ‰Ω†‰ª¨Á¨¨‰∏ÄÊ¨°ÊâìÂºÄËøô‰∏™Ê∏∏Êàè„ÄÇËØ∑‰Ω†‰∏ªÂä®ËØ¥Âá†Âè•ËØùÔºåÊØîÂ¶ÇÊâì‰∏™ÊãõÂëº„ÄÅË°®ËææÂØπÊ∏∏ÊàèÁöÑÊúüÂæÖ„ÄÅÊàñËÄÖÂà∂ÂÆöÊ∏∏ÊàèËßÑÂàôÔºåÊù•ÂºÄÂêØËøôÂú∫Ê∏∏Êàè„ÄÇ';
          } else if (imageBase64) {
            finalInstruction = 'Áî®Êà∑ÂàöÂàöÁîªÂÆå‰∫Ü‰∏ÄÂπÖÁîªÔºåÂõæÁâáÂÜÖÂÆπÂ∑≤Êèê‰æõ„ÄÇËØ∑‰Ω†Ê†πÊçÆÂõæÁâáÂÜÖÂÆπ„ÄÅ‰Ω†ÁöÑ‰∫∫ËÆæÂíåÂØπËØùÂéÜÂè≤ÔºåÂºÄÂßã‰Ω†ÁöÑÁåúÊµã„ÄÇ‰Ω†ÁöÑÁåúÊµãËøáÁ®ãÂ∫îËØ•ÂÉèÁúü‰∫∫‰∏ÄÊ†∑ÔºåÂèØ‰ª•ÂÖàÊèèËø∞‰Ω†ÁúãÂà∞‰∫Ü‰ªÄ‰πàÔºåÁÑ∂ÂêéÊèêÂá∫ÂèØËÉΩÁöÑÁ≠îÊ°àÔºåÂèØ‰ª•ÊòØÂØπÁöÑ‰πüÂèØ‰ª•ÊòØÈîôÁöÑ„ÄÇ';
          } else {
            finalInstruction = 'ËØ∑Ê†πÊçÆÂØπËØùÂéÜÂè≤Ëá™ÁÑ∂ÂõûÂ∫î„ÄÇ';
          }

          systemPrompt = `# ‰Ω†ÁöÑË∫´‰ªΩ
‰Ω†Áé∞Âú®ÊâÆÊºî: ${chat.name}
‰Ω†ÁöÑ‰∫∫ËÆæ: ${aiPersona}

# Áî®Êà∑ÁöÑË∫´‰ªΩ
Áî®Êà∑Âêç: ${userNickname}
Áî®Êà∑‰∫∫ËÆæ: ${myPersona}

# ÂΩìÂâçÊÉÖÂÜµ
‰Ω†Ê≠£Âú®Âíå${userNickname}Áé©"‰Ω†ÁîªÊàëÁåú"Ê∏∏Êàè„ÄÇ
ÁîªÊùøÂÜÖÂÆπ: ${canvasContentDescription}

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá

## ‰∏ñÁïåËßÇËÆæÂÆö
${worldBookContext || 'ÔºàÊöÇÊó†Ôºâ'}

## ÈïøÊúüËÆ∞ÂøÜÔºà‰Ω†‰ª¨‰πãÈó¥ÁöÑÈáçË¶ÅËÆ∞ÂøÜÔºâ
${longTermMemory || 'ÔºàÊöÇÊó†Ôºâ'}
${linkedChatsContext}

## Áü≠ÊúüËÆ∞ÂøÜÔºà‰Ω†‰ª¨ÊúÄËøëÂú®‰∏ªËÅäÂ§©ÁöÑÂØπËØùÔºâ
${shortTermMemory || 'ÔºàÊöÇÊó†Ôºâ'}

## Ê∏∏ÊàèÂÜÖÂØπËØùÔºàÊú¨Ê¨°Ê∏∏Êàè‰∏≠ÁöÑÂØπËØùÔºâ
${drawGuessHistory || 'ÔºàÊ∏∏ÊàèÂàöÂºÄÂßãÔºâ'}

# ‰Ω†ÁöÑ‰ªªÂä°
${finalInstruction}

ËØ∑Áõ¥Êé•ÂõûÂ§çÔºå‰∏çË¶ÅÂä†‰ªª‰ΩïÂâçÁºÄÊàñÂêéÁºÄ„ÄÇ`;
        }

        let messagesForApi = imageBase64
          ? [{ role: 'user', content: [{ type: 'text', text: '‰Ω†ÁúãÊàëÁîª‰∫Ü‰ªÄ‰πàÔºü' }, { type: 'image_url', image_url: { url: imageBase64 } }] }]
          : [{ role: 'user', content: drawGuessState.history.length > 0 ? drawGuessState.history[drawGuessState.history.length - 1].content : 'ÂºÄÂßãÊ∏∏ÊàèÂêß' }];

        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

        const response = isGemini
          ? await fetch(geminiConfig.url, geminiConfig.data)
          : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ model, messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi] })
          });

        if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);
        const data = await response.json();
        const aiReply = getGeminiResponseText(data);

        // Â§ÑÁêÜAIÂõûÂ§ç
        if (drawGuessState.mode === 'online') {
          // Á∫ø‰∏äÊ®°ÂºèÔºöÊãÜÂàÜÊàêÂ§öÊù°Ê∂àÊÅØ
          const messages = aiReply.split('\n').filter(msg => msg.trim());

          for (const msgContent of messages) {
            const aiMessage = {
              sender: chat.name,
              content: msgContent.trim(),
              timestamp: Date.now()
            };
            drawGuessState.history.push(aiMessage);
            appendDrawGuessMessage(aiMessage);

            // Ê∑ªÂä†Áü≠ÊöÇÂª∂ËøüÔºåÊ®°ÊãüÊâìÂ≠óÊïàÊûú
            if (messages.length > 1) {
              await new Promise(resolve => setTimeout(resolve, 300));
            }
          }
        } else {
          // Á∫ø‰∏ãÊ®°ÂºèÔºö‰øùÊåÅÂéüÊúâÈÄªËæëÔºàÂçïÊù°Ê∂àÊÅØÔºâ
          const aiMessage = {
            sender: chat.name,
            content: aiReply,
            timestamp: Date.now()
          };
          drawGuessState.history.push(aiMessage);
          appendDrawGuessMessage(aiMessage);
        }

      } catch (error) {
        console.error("AIÂìçÂ∫îÂ§±Ë¥•:", error);
        await showCustomAlert("AIÂìçÂ∫îÂ§±Ë¥•", `Êó†Ê≥ïËé∑ÂèñÂõûÂ§ç: ${error.message}`);
      } finally {
        drawGuessState.isAiResponding = false;
        dialogueBox.removeAttribute('data-placeholder');
      }
    }

    /**
     * Êèê‰∫§Áîª‰ΩúËÆ©AIÁåú
     */
    async function submitDrawingToAi() {
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      tempCanvas.width = drawingBoard.canvas.width;
      tempCanvas.height = drawingBoard.canvas.height;
      tempCtx.fillStyle = '#FFFFFF';
      tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

      if (drawingBoard.canvas.toDataURL() === tempCanvas.toDataURL()) {
        alert("ÁîªÊùø‰∏äËøòÊ≤°ÊúâÂÜÖÂÆπÂì¶ÔºåÂø´Êù•ÁîªÁÇπ‰ªÄ‰πàÂêßÔºÅ");
        return;
      }

      const chat = state.chats[drawGuessState.partnerId];
      if (chat) {
        await showCustomAlert("Êèê‰∫§ÊàêÂäü", `Â∑≤ÁªèÊää‰Ω†ÁöÑÁîª‰ΩúÊèê‰∫§Áªô"${chat.name}"‰∫ÜÔºÅ\\nTAÊ≠£Âú®Âä™ÂäõÁåúÊµã‰∏≠...`);
      }

      const drawingBase64 = drawingBoard.canvas.toDataURL('image/png');
      await triggerDrawAndGuessAiResponse(false, drawingBase64);

      drawingBoard.ctx.clearRect(0, 0, drawingBoard.canvas.width, drawingBoard.canvas.height);
      drawingBoard.history = [];
      drawingBoard.saveState();
      document.getElementById('start-draw-guess-game-btn').textContent = 'Êèê‰∫§Áîª‰Ωú';
    }

    /**
     * ÊâìÂºÄÊ∂àÊÅØÁÆ°ÁêÜÂºπÁ™ó
     */
    function openDrawGuessMessageManager(mode) {
      const modal = document.getElementById('draw-guess-message-manager-modal');
      const titleEl = document.getElementById('draw-guess-manager-title');
      const confirmBtn = document.getElementById('draw-guess-manager-confirm-btn');
      const listEl = document.getElementById('draw-guess-manager-list');
      listEl.innerHTML = '';

      titleEl.textContent = mode === 'edit' ? 'ÈÄâÊã©Ë¶ÅÁºñËæëÁöÑÊ∂àÊÅØ' : 'ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊ∂àÊÅØ';
      confirmBtn.textContent = mode === 'edit' ? 'ÂºÄÂßãÁºñËæë' : 'Á°ÆËÆ§Âà†Èô§';
      confirmBtn.classList.toggle('btn-danger', mode === 'delete');

      drawGuessState.history.forEach(msg => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.timestamp = msg.timestamp;
        item.innerHTML = `
      <div class="checkbox"></div>
      <div class="info" style="display: block;">
        <p style="margin:0; font-weight:500;">${msg.sender}:</p>
        <p style="margin:0; color: #8a8a8a;">${msg.content.substring(0, 30)}...</p>
      </div>
    `;
        listEl.appendChild(item);
      });

      drawGuessState.messageManager.mode = mode;
      drawGuessState.messageManager.selectedTimestamps.clear();
      modal.classList.add('visible');
    }

    /**
     * Â§ÑÁêÜÊ∂àÊÅØÁÆ°ÁêÜÁ°ÆËÆ§
     */
    async function handleMessageManagerConfirm() {
      const { mode, selectedTimestamps } = drawGuessState.messageManager;
      if (selectedTimestamps.size === 0) {
        alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ");
        return;
      }

      if (mode === 'delete') {
        drawGuessState.history = drawGuessState.history.filter(m => !selectedTimestamps.has(m.timestamp));
        const dialogueBox = document.getElementById('draw-guess-dialogue-box');
        dialogueBox.innerHTML = '';
        drawGuessState.history.forEach(appendDrawGuessMessage);
      } else if (mode === 'edit') {
        if (selectedTimestamps.size > 1) {
          alert("ÁºñËæëÊ®°Âºè‰∏ãÂè™ËÉΩÈÄâÊã©‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ");
          return;
        }
        const timestampToEdit = [...selectedTimestamps][0];
        const msgIndex = drawGuessState.history.findIndex(m => m.timestamp === timestampToEdit);
        if (msgIndex > -1) {
          const currentContent = drawGuessState.history[msgIndex].content;
          const newContent = await showCustomPrompt('ÁºñËæëÊ∂àÊÅØ', '', currentContent, 'textarea');
          if (newContent !== null) {
            drawGuessState.history[msgIndex].content = newContent.trim();
            const dialogueBox = document.getElementById('draw-guess-dialogue-box');
            dialogueBox.innerHTML = '';
            drawGuessState.history.forEach(appendDrawGuessMessage);
          }
        }
      }

      document.getElementById('draw-guess-message-manager-modal').classList.remove('visible');
      drawGuessState.messageManager.selectedTimestamps.clear();
    }

    /**
     * ÂàùÂßãÂåñ"‰Ω†ÁîªÊàëÁåú"‰∫ã‰ª∂ÁõëÂê¨Âô®
     */
    function initDrawAndGuessListeners() {
      // ËÆæÁΩÆÊåâÈíÆ
      const settingsBtn = document.getElementById('draw-guess-settings-btn');
      if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
          // ÊâìÂºÄËÆæÁΩÆÂºπÁ™ó
          const modal = document.getElementById('draw-guess-settings-modal');
          const onlineRadio = document.getElementById('draw-guess-mode-online');
          const offlineRadio = document.getElementById('draw-guess-mode-offline');

          // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ®°Âºè
          if (drawGuessState.mode === 'online') {
            onlineRadio.checked = true;
          } else {
            offlineRadio.checked = true;
          }

          modal.classList.add('visible');
        });
      }

      // ËÆæÁΩÆÂºπÁ™ó - ‰øùÂ≠òÊåâÈíÆ
      const settingsSaveBtn = document.getElementById('draw-guess-settings-save-btn');
      if (settingsSaveBtn) {
        settingsSaveBtn.addEventListener('click', () => {
          const onlineRadio = document.getElementById('draw-guess-mode-online');
          drawGuessState.mode = onlineRadio.checked ? 'online' : 'offline';

          document.getElementById('draw-guess-settings-modal').classList.remove('visible');
          console.log('Ê∏∏ÊàèÊ®°ÂºèÂ∑≤ÂàáÊç¢‰∏∫:', drawGuessState.mode);
        });
      }

      // ËÆæÁΩÆÂºπÁ™ó - ÂèñÊ∂àÊåâÈíÆ
      const settingsCancelBtn = document.getElementById('draw-guess-settings-cancel-btn');
      if (settingsCancelBtn) {
        settingsCancelBtn.addEventListener('click', () => {
          document.getElementById('draw-guess-settings-modal').classList.remove('visible');
        });
      }

      // ÈÄâÊã©ËßíËâ≤ÊåâÈíÆ
      const selectCharBtn = document.getElementById('draw-guess-select-char-btn');
      if (selectCharBtn) {
        selectCharBtn.addEventListener('click', async () => {
          const characters = Object.values(state.chats).filter(chat => !chat.isGroup);
          if (characters.length === 0) {
            alert("ËøòÊ≤°ÊúâÂèØ‰ª•‰∏ÄËµ∑Áé©ÁöÑËßíËâ≤Âì¶~");
            return;
          }

          const options = characters.map(char => ({ text: char.name, value: char.id }));
          const selectedId = await showChoiceModal('ÈÄâÊã©Ê∏∏Êàè‰ºô‰º¥', options);
          if (selectedId) {
            await setupDrawAndGuessSession(selectedId);
          }
        });
      }

      // ÂºÄÂßãÊ∏∏Êàè/Êèê‰∫§Áîª‰ΩúÊåâÈíÆ
      const startBtn = document.getElementById('start-draw-guess-game-btn');
      if (startBtn) {
        startBtn.addEventListener('click', async () => {
          if (!drawGuessState.isActive) return;

          const btnText = startBtn.textContent;
          if (btnText === 'ÂºÄÂßãÊ∏∏Êàè') {
            document.getElementById('draw-guess-studio').style.display = 'flex';
            document.getElementById('draw-guess-welcome-text').style.display = 'none';
            drawingBoard.init('drawing-canvas');
            document.getElementById('drawing-canvas').classList.add('active');
            startBtn.textContent = 'Êèê‰∫§Áîª‰Ωú';
          } else if (btnText === 'Êèê‰∫§Áîª‰Ωú') {
            await submitDrawingToAi();
          }
        });
      }

      // ÂèëÈÄÅÊ∂àÊÅØÊåâÈíÆ
      const sendBtn = document.getElementById('draw-guess-send-btn');
      if (sendBtn) {
        sendBtn.addEventListener('click', sendDrawGuessMessage);
      }

      // ËæìÂÖ•Ê°ÜÂõûËΩ¶ÂèëÈÄÅ
      const input = document.getElementById('draw-guess-input');
      if (input) {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') sendDrawGuessMessage();
        });
        input.addEventListener('input', handleDrawGuessInput);
      }

      // AIÂá∫È¢òÊåâÈíÆ
      const getTopicBtn = document.getElementById('draw-guess-get-topic-btn');
      if (getTopicBtn) {
        getTopicBtn.addEventListener('click', handleGetTopicFromAi);
      }

      // ËΩÆÂà∞AIÁîªÁîªÊåâÈíÆ
      const aiTurnBtn = document.getElementById('draw-guess-ai-turn-btn');
      if (aiTurnBtn) {
        aiTurnBtn.addEventListener('click', handleAiTurnToDraw);
      }

      // È¢úËâ≤ÈÄâÊã©
      document.querySelectorAll('.color-dot').forEach(dot => {
        dot.addEventListener('click', () => {
          document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
          dot.classList.add('active');
          const color = dot.dataset.color;
          drawingBoard.setColor(color);
          document.getElementById('custom-color-input').value = color;
        });
      });

      // Ëá™ÂÆö‰πâÈ¢úËâ≤ÈÄâÊã©Âô®
      const customColorInput = document.getElementById('custom-color-input');
      if (customColorInput) {
        customColorInput.addEventListener('change', (e) => {
          const color = e.target.value;
          drawingBoard.setColor(color);
          document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
        });
      }

      // Â∑•ÂÖ∑ÊåâÈíÆ
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tool = btn.dataset.tool;
          if (tool === 'undo') {
            drawingBoard.undo();
          } else if (tool === 'clear') {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÁîªÊùøÂêóÔºü')) {
              drawingBoard.clearCanvas();
            }
          } else {
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            drawingBoard.setTool(tool);
          }
        });
      });

      // ÁîªÁ¨îÂ§ßÂ∞è
      const sizeSlider = document.getElementById('brush-size-slider');
      const sizeInput = document.getElementById('brush-size-input');
      if (sizeSlider && sizeInput) {
        sizeSlider.addEventListener('input', (e) => {
          const size = parseInt(e.target.value);
          sizeInput.value = size;
          drawingBoard.setSize(size);
        });
        sizeInput.addEventListener('change', (e) => {
          const size = parseInt(e.target.value);
          sizeSlider.value = size;
          drawingBoard.setSize(size);
        });
      }

      // ÁîªÁ¨îÁ±ªÂûã
      const penTypeSelect = document.getElementById('pen-type-select');
      if (penTypeSelect) {
        penTypeSelect.addEventListener('change', (e) => {
          drawingBoard.setPenType(e.target.value);
        });
      }

      // Êìç‰ΩúÊ†èÊåâÈíÆ
      const actionBar = document.getElementById('draw-guess-action-bar');
      if (actionBar) {
        actionBar.addEventListener('click', async (e) => {
          const btn = e.target.closest('.action-bar-btn');
          if (!btn) return;

          const action = btn.dataset.action;
          if (action === 'reply') {
            await triggerDrawAndGuessAiResponse();
          } else if (action === 'delete') {
            openDrawGuessMessageManager('delete');
          } else if (action === 'edit') {
            openDrawGuessMessageManager('edit');
          } else if (action === 'resay') {
            await handleDrawGuessResay();
          }
        });
      }

      // Ê∂àÊÅØÁÆ°ÁêÜÂºπÁ™ó
      const managerCancelBtn = document.getElementById('draw-guess-manager-cancel-btn');
      const managerConfirmBtn = document.getElementById('draw-guess-manager-confirm-btn');
      const managerSelectAll = document.getElementById('draw-guess-manager-select-all');

      if (managerCancelBtn) {
        managerCancelBtn.addEventListener('click', () => {
          document.getElementById('draw-guess-message-manager-modal').classList.remove('visible');
          drawGuessState.messageManager.selectedTimestamps.clear();
        });
      }

      if (managerConfirmBtn) {
        managerConfirmBtn.addEventListener('click', handleMessageManagerConfirm);
      }

      if (managerSelectAll) {
        managerSelectAll.addEventListener('change', (e) => {
          const isChecked = e.target.checked;
          document.querySelectorAll('#draw-guess-manager-list .contact-picker-item').forEach(item => {
            item.classList.toggle('selected', isChecked);
            const timestamp = parseFloat(item.dataset.timestamp);
            if (isChecked) {
              drawGuessState.messageManager.selectedTimestamps.add(timestamp);
            } else {
              drawGuessState.messageManager.selectedTimestamps.delete(timestamp);
            }
          });
        });
      }

      // Ê∂àÊÅØÂàóË°®ÁÇπÂáªÈÄâÊã©
      const managerList = document.getElementById('draw-guess-manager-list');
      if (managerList) {
        managerList.addEventListener('click', (e) => {
          const item = e.target.closest('.contact-picker-item');
          if (item) {
            const timestamp = parseFloat(item.dataset.timestamp);
            if (drawGuessState.messageManager.mode === 'edit') {
              document.querySelectorAll('#draw-guess-manager-list .contact-picker-item.selected').forEach(el => el.classList.remove('selected'));
              drawGuessState.messageManager.selectedTimestamps.clear();
            }
            item.classList.toggle('selected');
            if (drawGuessState.messageManager.selectedTimestamps.has(timestamp)) {
              drawGuessState.messageManager.selectedTimestamps.delete(timestamp);
            } else {
              drawGuessState.messageManager.selectedTimestamps.add(timestamp);
            }
          }
        });
      }
    }

    // ÂàùÂßãÂåñ‰Ω†ÁîªÊàëÁåúÂäüËÉΩ
    initDrawAndGuessListeners();

    // ‚ñ≤‚ñ≤‚ñ≤ ‰Ω†ÁîªÊàëÁåúÂäüËÉΩÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

    // 2. ÁªëÂÆöÁ°ÆËÆ§ÂíåÂèñÊ∂àÊåâÈíÆ‰∫ã‰ª∂ (ËØ∑Â∞ÜÊ≠§ÊÆµ‰ª£Á†ÅÊîæÂú® init() ÂáΩÊï∞‰∏≠ÔºåÊàñËÄÖËÑöÊú¨Â∫ïÈÉ®ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âå∫Âüü)
    document.addEventListener('DOMContentLoaded', () => {
      // ... ÂÖ∂‰ªñÂàùÂßãÂåñ‰ª£Á†Å ...

      // ÁªëÂÆö‰∫≤Â±ûÂç°ÂºπÁ™óÊåâÈíÆ
      const cancelBtn = document.getElementById('cancel-kinship-creation-btn');
      const confirmBtn = document.getElementById('confirm-kinship-creation-btn');
      const modal = document.getElementById('kinship-creation-modal');

      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          modal.classList.remove('visible');
        });
      }

      if (confirmBtn) {
        confirmBtn.addEventListener('click', async () => {
          if (!selectedKinshipCharId) {
            return alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÁªëÂÆöÂØπË±°ÔºÅ");
          }

          const limitInput = document.getElementById('kinship-limit-input');
          const limit = parseFloat(limitInput.value);

          if (isNaN(limit) || limit <= 0) {
            return alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈ¢ùÂ∫¶ÔºÅ");
          }

          // Ë∞ÉÁî®ÂéüÊúâÁöÑÂèëÈÄÅÈÄªËæë
          await sendKinshipRequest(selectedKinshipCharId, limit);

          // ÂÖ≥Èó≠ÂºπÁ™ó
          modal.classList.remove('visible');

          // Â¶ÇÊûúÂΩìÂâç‰∏çÂú®ËØ•ËÅäÂ§©ÔºåÊèêÁ§∫Ë∑≥ËΩ¨
          if (state.activeChatId !== selectedKinshipCharId) {
            // sendKinshipRequest ÂÜÖÈÉ®Â∑≤ÁªèÂ§ÑÁêÜ‰∫ÜË∑≥ËΩ¨ÊàñËøΩÂä†Ê∂àÊÅØ
          }
        });
      }
    });
    const kinshipCancelBtn = document.getElementById('cancel-kinship-creation-btn');
    if (kinshipCancelBtn) {
      // ÂÖàÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÁõëÂê¨Âô®ÔºåÈò≤Ê≠¢ÈáçÂ§ç
      const newCancelBtn = kinshipCancelBtn.cloneNode(true);
      kinshipCancelBtn.parentNode.replaceChild(newCancelBtn, kinshipCancelBtn);

      newCancelBtn.addEventListener('click', () => {
        document.getElementById('kinship-creation-modal').classList.remove('visible');
      });
    }

    // ÁªëÂÆöÁ°ÆËÆ§Ëµ†ÈÄÅ/Áî≥ËØ∑ÊåâÈíÆ
    const kinshipConfirmBtn = document.getElementById('confirm-kinship-creation-btn');
    if (kinshipConfirmBtn) {
      const newConfirmBtn = kinshipConfirmBtn.cloneNode(true);
      kinshipConfirmBtn.parentNode.replaceChild(newConfirmBtn, kinshipConfirmBtn);

      newConfirmBtn.addEventListener('click', async () => {
        if (!selectedKinshipCharId) {
          return alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÂØπË±°ÔºÅ");
        }

        const limitInput = document.getElementById('kinship-limit-input');
        const limit = parseFloat(limitInput.value);

        if (isNaN(limit) || limit <= 0) {
          return alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈ¢ùÂ∫¶ÔºàÂøÖÈ°ªÂ§ß‰∫é0ÔºâÔºÅ");
        }

        // --- Êñ∞Â¢ûÔºöËé∑ÂèñÈÄâÊã©ÁöÑÁ±ªÂûã ---
        const typeRadio = document.querySelector('input[name="kinship-type"]:checked');
        const type = typeRadio ? typeRadio.value : 'grant'; // ÈªòËÆ§‰∏∫Ëµ†ÈÄÅ

        // Ë∞ÉÁî®ÂèëÈÄÅÈÄªËæëÔºå‰º†ÂÖ• type
        await sendKinshipRequest(selectedKinshipCharId, limit, type);

        document.getElementById('kinship-creation-modal').classList.remove('visible');

        const actionText = type === 'grant' ? "Ëµ†ÈÄÅ" : "Áî≥ËØ∑";
        await showCustomAlert(`${actionText}ÊàêÂäü`, `‰∫≤Â±ûÂç°${actionText}Â∑≤ÂèëÈÄÅÁªôÂØπÊñπ„ÄÇ`);
      });
    }
    document.getElementById('char-wallet-content').addEventListener('click', async (e) => {
      if (e.target.classList.contains('unbind-kinship-btn')) {
        e.stopPropagation();
        const chatId = e.target.dataset.chatId;

        // 1. ÂÖàËé∑ÂèñÈí±ÂåÖÊï∞ÊçÆÔºåÂà§Êñ≠ÊòØË∞ÅÁªôË∞ÅÂºÄÁöÑÂç°
        const wallet = await db.userWallet.get('main');
        const card = wallet?.kinshipCards?.find(c => c.chatId === chatId);

        if (!card) {
          // Âç°‰∏çÂ≠òÂú®ÔºàÂèØËÉΩÊï∞ÊçÆÈîô‰π±ÔºâÔºåÁªô‰∏™ÈªòËÆ§ÊèêÁ§∫
          alert("Êú™ÊâæÂà∞ËØ•‰∫≤Â±ûÂç°ËÆ∞ÂΩï");
          return;
        }

        // 2. Ê†πÊçÆÁ±ªÂûãÂÜ≥ÂÆöÊñáÊ°à
        // Â¶ÇÊûúÊ≤°Êúâ type Â≠óÊÆµÔºàÊóßÊï∞ÊçÆÔºâÔºåÈªòËÆ§ËÆ§‰∏∫ÊòØ 'out' (ÊàëÈÄÅTA)
        const isMyGift = (card.type === 'out' || !card.type);

        let title = "";
        let message = "";
        let confirmText = "";

        if (isMyGift) {
          title = "Êî∂Âõû‰∫≤Â±ûÂç°";
          message = "Á°ÆÂÆöË¶ÅÂÅúÊ≠¢‰∏∫ TA ‰π∞ÂçïÂêóÔºü\nÊî∂ÂõûÂêéÔºåÂØπÊñπÂ∞ÜÊó†Ê≥ïÂÜç‰ΩøÁî®ÊÇ®ÁöÑÈ¢ùÂ∫¶Ê∂àË¥π„ÄÇ";
          confirmText = "Á°ÆËÆ§Êî∂Âõû";
        } else {
          title = "ÈÄÄËøò‰∫≤Â±ûÂç°";
          message = "Á°ÆÂÆöË¶ÅËß£ÁªëËøôÂº†‰∫≤Â±ûÂç°ÂêóÔºü\nËß£ÁªëÂêéÔºåÊÇ®Â∞ÜÊó†Ê≥ïÂÜç‰ΩøÁî® TA ÁöÑÈ¢ùÂ∫¶Ê∂àË¥π„ÄÇ";
          confirmText = "Á°ÆËÆ§ÈÄÄËøò";
        }

        const confirmed = await showCustomConfirm(
          title,
          message,
          { confirmButtonClass: 'btn-danger', confirmText: confirmText }
        );

        if (confirmed) {
          try {
            if (wallet && wallet.kinshipCards) {
              // ËøáÊª§ÊéâÂΩìÂâçËßíËâ≤ÁöÑÂç°
              wallet.kinshipCards = wallet.kinshipCards.filter(c => c.chatId !== chatId);
              await db.userWallet.put(wallet);

              await showCustomAlert("ÊàêÂäü", "‰∫≤Â±ûÂç°Â∑≤Ëß£Áªë„ÄÇ");

              // Âà∑Êñ∞ÁïåÈù¢
              renderCharWallet();

              // 3. ÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØÈÄöÁü•AI (Ê†πÊçÆÊñπÂêë‰∏çÂêåÔºåÈÄöÁü•ÂÜÖÂÆπ‰πü‰∏çÂêå)
              const chat = state.chats[chatId];
              if (chat) {
                let sysContent = "";
                if (isMyGift) {
                  sysContent = '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Â∑≤Êî∂Âõû‰∫ÜÁªô‰Ω†ÁöÑ‰∫≤Â±ûÂç°È¢ùÂ∫¶Ôºå‰Ω†Êó†Ê≥ïÂÜç‰ΩøÁî®‰ª£‰ªòÂäüËÉΩ‰∫Ü„ÄÇ]';
                } else {
                  sysContent = '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑‰∏ªÂä®ÈÄÄËøò/Ëß£Áªë‰∫Ü‰Ω†Ëµ†ÈÄÅÁöÑ‰∫≤Â±ûÂç°Ôºå‰∏çÂÜç‰ΩøÁî®‰Ω†ÁöÑÈí±‰∫Ü„ÄÇ]';
                }

                chat.history.push({
                  role: 'system',
                  content: sysContent,
                  timestamp: Date.now(),
                  isHidden: true
                });
                await db.chats.put(chat);
              }
            }
          } catch (error) {
            console.error(error);
            alert("Ëß£ÁªëÂ§±Ë¥•");
          }
        }
      }
    });
    const alipayScreen = document.getElementById('alipay-screen');
    if (alipayScreen) {
      alipayScreen.addEventListener('click', async (e) => {
        // Ê£ÄÊü•ÁÇπÂáªÁöÑÊòØ‰∏çÊòØËß£ÁªëÊåâÈíÆ
        if (e.target.classList.contains('alipay-unbind-btn')) {
          e.stopPropagation();

          const chatId = e.target.dataset.chatId;
          const chat = state.chats[chatId];
          const charName = chat ? chat.name : 'ËØ•ËßíËâ≤';

          // 1. Ëé∑ÂèñÈí±ÂåÖÊï∞ÊçÆÂà§Êñ≠ÊñπÂêë
          const wallet = await db.userWallet.get('main');
          const card = wallet?.kinshipCards?.find(c => c.chatId === chatId);

          if (!card) return;

          // 2. Âä®ÊÄÅÁîüÊàêÊñáÊ°à
          const isMyGift = (card.type === 'out' || !card.type);

          let title = "";
          let message = "";
          let confirmText = "";

          if (isMyGift) {
            title = "ÁªàÊ≠¢Ëµ†‰∫à";
            message = `Á°ÆÂÆöË¶ÅÂÅúÊ≠¢Ëµ†‰∫à‚Äú${charName}‚Äù‰∫≤Â±ûÂç°ÂêóÔºü\nËß£ÁªëÂêéÔºåÂØπÊñπÂ∞ÜÊó†Ê≥ïÂÜç‰ΩøÁî®ËØ•È¢ùÂ∫¶„ÄÇ`;
            confirmText = "Á°ÆËÆ§Êî∂Âõû";
          } else {
            title = "Ëß£Áªë‰∫≤Â±ûÂç°";
            message = `Á°ÆÂÆöË¶ÅËß£Áªë‚Äú${charName}‚ÄùËµ†ÈÄÅÁöÑ‰∫≤Â±ûÂç°ÂêóÔºü\nËß£ÁªëÂêéÔºåÊÇ®Â∞ÜÂ§±ÂéªËØ•Ê∂àË¥πÈ¢ùÂ∫¶„ÄÇ`;
            confirmText = "Á°ÆËÆ§Ëß£Áªë";
          }

          const confirmed = await showCustomConfirm(
            title,
            message,
            { confirmButtonClass: 'btn-danger', confirmText: confirmText }
          );

          if (confirmed) {
            try {
              if (wallet && wallet.kinshipCards) {
                // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§ËØ•Âç°Áâá
                wallet.kinshipCards = wallet.kinshipCards.filter(c => c.chatId !== chatId);
                await db.userWallet.put(wallet);

                await showCustomAlert("ÊàêÂäü", "Â∑≤ÊàêÂäüËß£Áªë‰∫≤Â±ûÂç°„ÄÇ");

                // Âà∑Êñ∞ÊîØ‰ªòÂÆùÁïåÈù¢
                openAlipayScreen();

                // 3. ÈÄöÁü• AI
                if (chat) {
                  let sysContent = "";
                  if (isMyGift) {
                    sysContent = '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Â∑≤Âú®ÊîØ‰ªòÂÆùÁ´ØÂçïÊñπÈù¢Êî∂Âõû‰∫ÜÁªô‰Ω†ÁöÑ‰∫≤Â±ûÂç°ÊéàÊùÉ„ÄÇ]';
                  } else {
                    sysContent = '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Â∑≤Âú®ÊîØ‰ªòÂÆùÁ´Ø‰∏ªÂä®ÈÄÄËøò/Ëß£Áªë‰∫Ü‰Ω†Ëµ†ÈÄÅÁöÑ‰∫≤Â±ûÂç°„ÄÇ]';
                  }

                  chat.history.push({
                    role: 'system',
                    content: sysContent,
                    timestamp: Date.now(),
                    isHidden: true
                  });
                  await db.chats.put(chat);
                }
              }
            } catch (error) {
              console.error(error);
              alert("Ëß£ÁªëÊìç‰ΩúÂ§±Ë¥•");
            }
          }
        }
      });
    }
    document.getElementById('export-appearance-btn').addEventListener('click', exportAppearanceSettings);
    // --- To-Do List Events ---
    const todoBtn = document.getElementById('open-todo-list-btn');
    if (todoBtn) todoBtn.addEventListener('click', openTodoList);

    document.getElementById('todo-list-back-btn').addEventListener('click', () => showScreen('chat-interface-screen'));

    document.getElementById('todo-prev-day-btn').addEventListener('click', () => changeTodoDate(-1));

    document.getElementById('todo-next-day-btn').addEventListener('click', () => changeTodoDate(1));

    document.getElementById('add-todo-btn').addEventListener('click', () => openTodoEditor(null));

    document.getElementById('cancel-todo-editor-btn').addEventListener('click', () => {
      document.getElementById('todo-editor-modal').classList.remove('visible');
    });

    document.getElementById('save-todo-btn').addEventListener('click', saveTodo);
    const todoDateDisplay = document.getElementById('todo-current-date-display');
    if (todoDateDisplay) {
      // 1. Âä®ÊÄÅÂàõÂª∫‰∏Ä‰∏™ÈöêËóèÁöÑ input[type="date"]
      const datePicker = document.createElement('input');
      datePicker.type = 'date';
      // ÈöêËóèÂÆÉÔºå‰ΩÜ‰øùÊåÅÂèØ‰∫§‰∫íÊÄß
      datePicker.style.cssText = 'position:absolute; visibility:hidden; width:0; height:0; top:0; left:0;';
      todoDateDisplay.parentNode.appendChild(datePicker); // ÊèíÂÖ•Âà∞ÂØºËà™Ê†èÈáå

      // 2. ÁÇπÂáªÊñáÂ≠ó -> Ëß¶ÂèëÈÄâÊã©Âô®
      todoDateDisplay.addEventListener('click', () => {
        // Â∞ÜÂΩìÂâçÊòæÁ§∫ÁöÑÊó•ÊúüÂêåÊ≠•ÁªôÈÄâÊã©Âô®
        datePicker.value = getTodoDateString(currentTodoDate);

        // Â∞ùËØïÂºπÂá∫ÂéüÁîüÊó•ÊúüÈù¢Êùø
        try {
          datePicker.showPicker(); // Áé∞‰ª£ÊµèËßàÂô® (Chrome 99+, Safari 15+)
        } catch (e) {
          datePicker.click(); // ÊóßÁâàÂÖºÂÆπ
        }
      });

      // 3. ÁõëÂê¨Êó•ÊúüÊîπÂèò
      datePicker.addEventListener('change', (e) => {
        if (e.target.value) {
          // Ëß£Êûê YYYY-MM-DD (ÈÅøÂÖçÁõ¥Êé• new Date() Â∏¶Êù•ÁöÑÊó∂Âå∫ÂÅèÂ∑ÆÈóÆÈ¢ò)
          const [y, m, d] = e.target.value.split('-').map(Number);
          // ÊûÑÈÄ†Êú¨Âú∞Êó∂Èó¥ÂØπË±°
          currentTodoDate = new Date(y, m - 1, d);

          // Âà∑Êñ∞ÁïåÈù¢
          updateTodoDateDisplay();
          renderTodoList();
        }
      });
    }
    // Á±ªÂûãÈÄâÊã©Âô®ÁÇπÂáª‰∫ã‰ª∂
    const typeOptions = document.querySelectorAll('.todo-type-option');
    typeOptions.forEach(opt => {
      opt.addEventListener('click', () => {
        typeOptions.forEach(o => o.classList.remove('active'));
        opt.classList.add('active');
      });
    });
    // --- Âú® init() ÂáΩÊï∞ÂÜÖÈÉ®ÁöÑ‰∫ã‰ª∂ÁªëÂÆöÂå∫ÂüüÊ∑ªÂä† ---

    // 1. ÈïøÊúüËÆ∞ÂøÜÂàóË°®ÊªöÂä®ÁõëÂê¨
    const memoryListContainer = document.getElementById('memory-list-container');
    if (memoryListContainer) {
      memoryListContainer.addEventListener('scroll', () => {
        const { scrollTop, scrollHeight, clientHeight } = memoryListContainer;
        // Ë∑ùÁ¶ªÂ∫ïÈÉ® 50px Êó∂Ëß¶ÂèëÂä†ËΩΩ
        if (scrollHeight - scrollTop <= clientHeight + 50) {
          loadMoreMemories();
        }
      });
    }

    // 2. ÂæÖÂäû‰∫ãÈ°πÂàóË°®ÊªöÂä®ÁõëÂê¨
    const todoListContainer = document.getElementById('todo-list-container');
    if (todoListContainer) {
      todoListContainer.addEventListener('scroll', () => {
        const { scrollTop, scrollHeight, clientHeight } = todoListContainer;
        if (scrollHeight - scrollTop <= clientHeight + 50) {
          loadMoreTodos();
        }
      });
    }
    // ÁªëÂÆöÈÇÆÁÆ±Â∫ïÈÉ®ÊåâÈíÆ‰∫ã‰ª∂
    const deleteSelectedBtn = document.getElementById('mail-delete-selected-btn');
    if (deleteSelectedBtn) {
      deleteSelectedBtn.addEventListener('click', executeBatchDeleteEmails);
    }

    const selectAllBtn = document.getElementById('mail-select-all-btn');
    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', handleSelectAllEmails);
    }
    document.getElementById('manage-rules-btn').addEventListener('click', toggleRuleManagementMode);
    document.getElementById('import-rules-btn').addEventListener('click', () => {
      document.getElementById('import-rules-input').click();
    });
    document.getElementById('import-rules-input').addEventListener('change', handleRulesImport);

    // 2. Â∫ïÈÉ®Êìç‰ΩúÊ†èÊåâÈíÆ
    document.getElementById('select-all-rules-checkbox').addEventListener('change', handleSelectAllRules);
    document.getElementById('export-selected-rules-btn').addEventListener('click', exportSelectedRules);
    document.getElementById('delete-selected-rules-btn').addEventListener('click', deleteSelectedRules);
    // ... Âú® init() ÂáΩÊï∞ÂÜÖ ...
    const redditSearchBtn = document.getElementById('char-reddit-search-btn');
    if (redditSearchBtn) {
      redditSearchBtn.addEventListener('click', () => {
        const query = document.getElementById('char-reddit-search-input').value.trim();
        handleRedditSearch(query);
      });
    }

    // ÁªëÂÆöÂõûËΩ¶ÊêúÁ¥¢
    const redditInput = document.getElementById('char-reddit-search-input');
    if (redditInput) {
      redditInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const query = e.target.value.trim();
          handleRedditSearch(query);
        }
      });
    }
    const regenRedditBtn = document.getElementById('regenerate-char-reddit-btn');
    if (regenRedditBtn) {
      regenRedditBtn.addEventListener('click', handleGenerateSimulatedReddit);
    }
    document.getElementById('nai-preset-select').addEventListener('change', handleNaiPresetChange);
    document.getElementById('save-nai-preset-btn').addEventListener('click', () => handleSaveNaiPreset(false));
    document.getElementById('update-nai-preset-btn').addEventListener('click', () => handleSaveNaiPreset(true));
    document.getElementById('delete-nai-preset-btn').addEventListener('click', handleDeleteNaiPreset);
    document.getElementById('bind-nai-preset-btn').addEventListener('click', openNaiBindingModal);

    document.getElementById('save-nai-binding-btn').addEventListener('click', saveNaiBinding);
    document.getElementById('cancel-nai-binding-btn').addEventListener('click', () => {
      document.getElementById('nai-binding-modal').classList.remove('visible');
    });
    document.getElementById('manage-quick-reply-categories-btn').addEventListener('click', openQuickReplyCategoryManager);

    // 2. ÁªëÂÆöÂàÜÁ±ªÁÆ°ÁêÜÂô®ÂÜÖÁöÑÊåâÈíÆ
    document.getElementById('add-new-quick-reply-category-btn').addEventListener('click', addNewQuickReplyCategory);
    document.getElementById('close-quick-reply-category-manager-btn').addEventListener('click', () => {
      document.getElementById('quick-reply-category-manager-modal').classList.remove('visible');
      renderQuickReplyList(true); // ÂÖ≥Èó≠Êó∂Âà∑Êñ∞‰∏ªÂàóË°®ÁöÑTabs
    });
    // --- Sticker Batch Move (Ë°®ÊÉÖÂåÖÊâπÈáèÁßªÂä®) ---
    const stickerMoveBtn = document.getElementById('move-selected-stickers-btn');
    if (stickerMoveBtn) {
      stickerMoveBtn.addEventListener('click', executeBatchMoveStickers);
    }

    // --- Quick Reply Management (Âø´Êç∑ÂõûÂ§çÁÆ°ÁêÜ) ---
    const batchQuickReplyBtn = document.getElementById('batch-quick-reply-btn');
    if (batchQuickReplyBtn) {
      batchQuickReplyBtn.addEventListener('click', toggleQuickReplyManagementMode);
    }

    const selectAllQuickRepliesCb = document.getElementById('select-all-quick-replies-checkbox');
    if (selectAllQuickRepliesCb) {
      selectAllQuickRepliesCb.addEventListener('change', handleSelectAllQuickReplies);
    }

    const moveQuickRepliesBtn = document.getElementById('move-selected-quick-replies-btn');
    if (moveQuickRepliesBtn) {
      moveQuickRepliesBtn.addEventListener('click', executeBatchMoveQuickReplies);
    }

    const deleteQuickRepliesBtn = document.getElementById('delete-selected-quick-replies-btn');
    if (deleteQuickRepliesBtn) {
      deleteQuickRepliesBtn.addEventListener('click', executeBatchDeleteQuickReplies);
    }



    initLockScreen();
    checkForUpdates();
    updateLockedFeatureUI();
    initSystemNotification();
    initializeBackgroundKeepAlive();
    bindBackgroundKeepAliveEvents();
    loadBackgroundKeepAliveSettings();
    loadShoppingCart(); // Âä†ËΩΩË¥≠Áâ©ËΩ¶Êï∞ÊçÆ
    showScreen('home-screen');
  }

  init();
});



// Êñ∞Â¢ûÔºöÂ§ÑÁêÜÁî®Êà∑ÊãçËá™Â∑±ÁöÑÂäüËÉΩ
async function handleUserPatSelf(chatId) {
  const chat = state.chats[chatId];
  if (!chat) return;

  const phoneScreen = document.getElementById('phone-screen');
  phoneScreen.classList.remove('pat-animation');
  void phoneScreen.offsetWidth;
  phoneScreen.classList.add('pat-animation');

  const myNickname = getDisplayNameInGroup(chat, state.qzoneSettings.nickname);

  // ÂºπÂá∫ËæìÂÖ•Ê°ÜËÆ©Áî®Êà∑ËæìÂÖ•ÊãçËá™Â∑±ÁöÑÂêéÁºÄ
  const suffix = await showCustomPrompt(
    `‰Ω†Êãç‰∫ÜÊãçËá™Â∑±`,
    "ËæìÂÖ•Êãç‰∏ÄÊãçÂêéÁºÄ",
    "",
    "text"
  );

  if (suffix === null) return;

  // ÂàõÂª∫ÂèØËßÅÁöÑÊãç‰∏ÄÊãçÊ∂àÊÅØ
  const visibleMessageContent = `${myNickname} Êãç‰∫ÜÊãçËá™Â∑± ${suffix.trim()}`;
  const visibleMessage = {
    role: 'system',
    type: 'pat_message',
    content: visibleMessageContent,
    timestamp: Date.now()
  };
  chat.history.push(visibleMessage);

  // ÂàõÂª∫ÈöêËóèÁöÑÁ≥ªÁªüÊèêÁ§∫ÔºåËÆ©AIÁü•ÈÅìÁî®Êà∑Êãç‰∫ÜËá™Â∑±
  const hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Ôºà${myNickname}ÔºâÂàöÂàöÊãç‰∫ÜÊãçËá™Â∑±${suffix.trim()}„ÄÇ‰Ω†ÂèØ‰ª•ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫îÊàñËØÑËÆ∫„ÄÇ]`;
  const hiddenMessage = {
    role: 'system',
    content: hiddenMessageContent,
    timestamp: Date.now() + 1,
    isHidden: true
  };
  chat.history.push(hiddenMessage);

  await db.chats.put(chat);
  if (state.activeChatId === chatId) {
    appendMessage(visibleMessage, chat);
  }
  await renderChatList();
}

// ========================================
// ËßÜÈ¢ëÈÄöËØù‰ºòÂåñÂäüËÉΩ
// ========================================

// ÊëÑÂÉèÂ§¥Áõ∏ÂÖ≥ÂèòÈáè
let cameraStream = null;
let captureInterval = null;
let lastCapturedImage = null;

// ÊèêÂèñÂØπËØùÂÜÖÂÆπÔºàÂè™‰øùÁïôÂºïÂè∑ÂÜÖÁöÑÊñáÊú¨Ôºâ
function extractDialogueOnly(text) {
  if (!text) return text;

  // ÊîØÊåÅÁöÑÂºïÂè∑Á±ªÂûãÔºöÂ∞ΩÂèØËÉΩÂÖ®Èù¢ÁöÑÂºïÂè∑Ê†ºÂºè
  const quotePatterns = [
    /"([^"]*)"/g,        // Ëã±ÊñáÂèåÂºïÂè∑
    /'([^']*)'/g,        // Ëã±ÊñáÂçïÂºïÂè∑
    /„Äå([^„Äç]*)„Äç/g,     // ‰∏≠ÊñáÁõ¥ËßíÂºïÂè∑
    /„Äé([^„Äè]*)„Äè/g,     // ‰∏≠ÊñáÁõ¥ËßíÂèåÂºïÂè∑
    /"([^"]*)"/g,        // ‰∏≠ÊñáÂèåÂºïÂè∑
    /'([^']*)'/g,        // ‰∏≠ÊñáÂçïÂºïÂè∑
    /‚Äπ([^‚Ä∫]*)‚Ä∫/g,        // Âçï‰π¶ÂêçÂè∑
    /¬´([^¬ª]*)¬ª/g,        // Âèå‰π¶ÂêçÂè∑
    /‚Äö([^']*)'/g,        // Âæ∑ËØ≠ÂçïÂºïÂè∑
    /‚Äû([^"]*)"/g,        // Âæ∑ËØ≠ÂèåÂºïÂè∑
    /„Äê([^„Äë]*)„Äë/g,     // ÊñπÊã¨Âè∑ÔºàÈÉ®ÂàÜÂú∫ÊôØÁî®‰ΩúÂØπËØùÔºâ
    /„Äé([^„Äè]*)„Äè/g      // ÁπÅ‰Ωì‰∏≠ÊñáÂºïÂè∑
  ];

  let dialogues = [];

  // ÊèêÂèñÊâÄÊúâÂºïÂè∑ÂÜÖÁöÑÂÜÖÂÆπ
  for (const pattern of quotePatterns) {
    // ÈáçÁΩÆÊ≠£ÂàôË°®ËææÂºèÁöÑlastIndexÔºåÈÅøÂÖçÁä∂ÊÄÅÊ±°Êüì
    const regex = new RegExp(pattern.source, pattern.flags);
    let match;
    while ((match = regex.exec(text)) !== null) {
      if (match[1] && match[1].trim()) {
        const dialogue = match[1].trim();
        // ÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†Áõ∏ÂêåÁöÑÂØπËØùÁâáÊÆµ
        if (!dialogues.includes(dialogue)) {
          dialogues.push(dialogue);
        }
      }
    }
  }

  // Â¶ÇÊûúÊâæÂà∞‰∫ÜÂºïÂè∑ÂÜÖÂÆπÔºåËøîÂõûÂºïÂè∑ÂÜÖÂÆπÔºàÂè™ËØªÂØπËØùÔºâ
  if (dialogues.length > 0) {
    console.log('[ÂØπËØùÊèêÂèñ] ÊàêÂäüÊèêÂèñÂà∞ ' + dialogues.length + ' ÊÆµÂØπËØù');
    return dialogues.join(' ');
  }

  // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞‰ªª‰ΩïÂºïÂè∑ÔºåËøîÂõûÂéüÊñáÔºà‰øùËØÅTTSËÉΩÊ≠£Â∏∏Â∑•‰ΩúÔºâ
  console.log('[ÂØπËØùÊèêÂèñ] Êú™ÊâæÂà∞ÂºïÂè∑ÔºåËøîÂõûÂéüÊñá');
  return text;
}

// Ëé∑ÂèñÂ§ÑÁêÜÂêéÁöÑTTSÊñáÊú¨
window.getProcessedTTSText = function (originalText, chatId) {
  if (!originalText) return '';

  // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®‰∫Ü"‰ªÖËØªÂèñÂØπËØù"ÂäüËÉΩ
  if (typeof state !== 'undefined' && state.chats && state.chats[chatId]) {
    const chat = state.chats[chatId];
    if (chat.videoOptimization && chat.videoOptimization.ttsDialogueOnly) {
      // extractDialogueOnly ‰ºöËøîÂõûÂºïÂè∑ÂÜÖÂÆπÊàñÂéüÊñáÔºå‰∏ç‰ºöËøîÂõûÁ©∫
      return extractDialogueOnly(originalText);
    }
  }

  return originalText;
};

// ÂàùÂßãÂåñËßÜÈ¢ëÈÄöËØù‰ºòÂåñ‰∫ã‰ª∂ÁõëÂê¨
function initVideoOptimization() {
  // ËßÜÈ¢ëÈÄöËØù‰ºòÂåñÂºÄÂÖ≥
  const enableSwitch = document.getElementById('enable-video-optimization-switch');
  const configContainer = document.getElementById('video-optimization-config-container');

  if (enableSwitch) {
    enableSwitch.addEventListener('change', function () {
      if (this.checked) {
        configContainer.style.display = 'block';
      } else {
        configContainer.style.display = 'none';
      }
    });
  }

  // ÂØπÊñπËßÜÈ¢ëÂõæÁâá - Êú¨Âú∞‰∏ä‰º†
  const remoteVideoInput = document.getElementById('remote-video-input');
  if (remoteVideoInput) {
    remoteVideoInput.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (event) {
          const imgUrl = event.target.result;
          document.getElementById('remote-video-preview').src = imgUrl;
          document.getElementById('remote-video-preview').style.display = 'block';
          document.getElementById('remote-video-placeholder').style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // ÂØπÊñπËßÜÈ¢ëÂõæÁâá - URL‰∏ä‰º†
  const remoteVideoUrlBtn = document.getElementById('remote-video-url-btn');
  const remoteVideoUrlInput = document.getElementById('remote-video-url-input');
  if (remoteVideoUrlBtn && remoteVideoUrlInput) {
    remoteVideoUrlBtn.addEventListener('click', function () {
      const url = remoteVideoUrlInput.value.trim();
      if (url) {
        document.getElementById('remote-video-preview').src = url;
        document.getElementById('remote-video-preview').style.display = 'block';
        document.getElementById('remote-video-placeholder').style.display = 'none';
      }
    });

    remoteVideoUrlInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        remoteVideoUrlBtn.click();
      }
    });
  }

  // ÊàëÊñπËßÜÈ¢ëÂõæÁâá - Êú¨Âú∞‰∏ä‰º†
  const localVideoInput = document.getElementById('local-video-input');
  if (localVideoInput) {
    localVideoInput.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (event) {
          const imgUrl = event.target.result;
          document.getElementById('local-video-preview').src = imgUrl;
          document.getElementById('local-video-preview').style.display = 'block';
          document.getElementById('local-video-placeholder').style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // ÊàëÊñπËßÜÈ¢ëÂõæÁâá - URL‰∏ä‰º†
  const localVideoUrlBtn = document.getElementById('local-video-url-btn');
  const localVideoUrlInput = document.getElementById('local-video-url-input');
  if (localVideoUrlBtn && localVideoUrlInput) {
    localVideoUrlBtn.addEventListener('click', function () {
      const url = localVideoUrlInput.value.trim();
      if (url) {
        document.getElementById('local-video-preview').src = url;
        document.getElementById('local-video-preview').style.display = 'block';
        document.getElementById('local-video-placeholder').style.display = 'none';
      }
    });

    localVideoUrlInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        localVideoUrlBtn.click();
      }
    });
  }

  // ÂØπÊñπËßÜÈ¢ëÂõæÁâá - ÈáçÁΩÆÊåâÈíÆ
  const remoteVideoResetBtn = document.getElementById('remote-video-reset-btn');
  if (remoteVideoResetBtn) {
    remoteVideoResetBtn.addEventListener('click', function () {
      document.getElementById('remote-video-preview').src = '';
      document.getElementById('remote-video-preview').style.display = 'none';
      document.getElementById('remote-video-placeholder').style.display = 'flex';
      document.getElementById('remote-video-url-input').value = '';
      const remoteVideoInput = document.getElementById('remote-video-input');
      if (remoteVideoInput) remoteVideoInput.value = '';
    });
  }

  // ÊàëÊñπËßÜÈ¢ëÂõæÁâá - ÈáçÁΩÆÊåâÈíÆ
  const localVideoResetBtn = document.getElementById('local-video-reset-btn');
  if (localVideoResetBtn) {
    localVideoResetBtn.addEventListener('click', function () {
      document.getElementById('local-video-preview').src = '';
      document.getElementById('local-video-preview').style.display = 'none';
      document.getElementById('local-video-placeholder').style.display = 'flex';
      document.getElementById('local-video-url-input').value = '';
      const localVideoInput = document.getElementById('local-video-input');
      if (localVideoInput) localVideoInput.value = '';
    });
  }

  // ÁúüÂÆûÊëÑÂÉèÂ§¥ÂºÄÂÖ≥
  const enableRealCameraSwitch = document.getElementById('enable-real-camera-switch');
  const cameraIntervalSetting = document.getElementById('camera-interval-setting');
  if (enableRealCameraSwitch) {
    enableRealCameraSwitch.addEventListener('change', function () {
      if (this.checked) {
        cameraIntervalSetting.style.display = 'block';
      } else {
        cameraIntervalSetting.style.display = 'none';
        stopCamera();
      }
    });
  }

  // ÂêéÁΩÆÊëÑÂÉèÂ§¥ÂºÄÂÖ≥ - ÈÄöËØù‰∏≠ÂÆûÊó∂ÂàáÊç¢
  const enableRearCameraSwitch = document.getElementById('enable-rear-camera-switch');
  if (enableRearCameraSwitch) {
    enableRearCameraSwitch.addEventListener('change', async function () {
      // Â¶ÇÊûúÊ≠£Âú®ÈÄöËØù‰∏≠‰∏îÊëÑÂÉèÂ§¥Â∑≤ÂêØÂä®ÔºåÂÆûÊó∂ÂàáÊç¢
      if (cameraStream && videoCallState && videoCallState.isActive) {
        stopCamera();
        const facingMode = this.checked ? 'environment' : 'user';
        const success = await startCamera(facingMode);
        if (success) {
          const chat = state.chats[videoCallState.activeChatId];
          const interval = (chat && chat.videoOptimization && chat.videoOptimization.cameraInterval) || 5;
          startCameraCapture(interval);
        }
      }
    });
  }

  // ÁÇπÂáªÂ∞èÂ±è‰∫íÊç¢‰ΩçÁΩÆ
  const localVideoSmall = document.getElementById('local-video-small');
  if (localVideoSmall) {
    localVideoSmall.addEventListener('click', swapVideoPosition);
  }
}

// ‰∫íÊç¢ËßÜÈ¢ë‰ΩçÁΩÆ
function swapVideoPosition() {
  const remoteImg = document.getElementById('remote-video-img');
  const localImg = document.getElementById('local-video-img');

  const tempSrc = remoteImg.src;
  remoteImg.src = localImg.src;
  localImg.src = tempSrc;
}

// Âä†ËΩΩËßÜÈ¢ëÈÄöËØù‰ºòÂåñËÆæÁΩÆ
window.loadVideoOptimizationSettings = function (chat) {
  if (!chat) return;

  const settings = chat.videoOptimization || {};

  const enableSwitch = document.getElementById('enable-video-optimization-switch');
  const configContainer = document.getElementById('video-optimization-config-container');
  if (enableSwitch) {
    enableSwitch.checked = settings.enabled || false;
    configContainer.style.display = settings.enabled ? 'block' : 'none';
  }

  if (settings.remoteVideoUrl) {
    document.getElementById('remote-video-preview').src = settings.remoteVideoUrl;
    document.getElementById('remote-video-preview').style.display = 'block';
    document.getElementById('remote-video-placeholder').style.display = 'none';
    document.getElementById('remote-video-url-input').value = settings.remoteVideoUrl;
  } else {
    document.getElementById('remote-video-preview').style.display = 'none';
    document.getElementById('remote-video-placeholder').style.display = 'flex';
    document.getElementById('remote-video-url-input').value = '';
  }

  if (settings.localVideoUrl) {
    document.getElementById('local-video-preview').src = settings.localVideoUrl;
    document.getElementById('local-video-preview').style.display = 'block';
    document.getElementById('local-video-placeholder').style.display = 'none';
    document.getElementById('local-video-url-input').value = settings.localVideoUrl;
  } else {
    document.getElementById('local-video-preview').style.display = 'none';
    document.getElementById('local-video-placeholder').style.display = 'flex';
    document.getElementById('local-video-url-input').value = '';
  }

  // Âä†ËΩΩÁúüÂÆûÊëÑÂÉèÂ§¥ËÆæÁΩÆ
  const enableRealCameraSwitch = document.getElementById('enable-real-camera-switch');
  const cameraIntervalSetting = document.getElementById('camera-interval-setting');
  const cameraIntervalInput = document.getElementById('camera-capture-interval');

  if (enableRealCameraSwitch) {
    enableRealCameraSwitch.checked = settings.enableRealCamera || false;
    cameraIntervalSetting.style.display = settings.enableRealCamera ? 'block' : 'none';
  }

  if (cameraIntervalInput) {
    cameraIntervalInput.value = settings.cameraInterval || 5;
  }

  // Âä†ËΩΩÂêéÁΩÆÊëÑÂÉèÂ§¥ËÆæÁΩÆ
  const enableRearCameraSwitch = document.getElementById('enable-rear-camera-switch');
  if (enableRearCameraSwitch) {
    enableRearCameraSwitch.checked = settings.useRearCamera || false;
  }

  // Âä†ËΩΩ‰ªÖËØªÂèñÂØπËØùËÆæÁΩÆ
  const ttsDialogueOnlySwitch = document.getElementById('tts-dialogue-only-switch');
  if (ttsDialogueOnlySwitch) {
    ttsDialogueOnlySwitch.checked = settings.ttsDialogueOnly || false;
  }
};

// ‰øùÂ≠òËßÜÈ¢ëÈÄöËØù‰ºòÂåñËÆæÁΩÆ
window.saveVideoOptimizationSettings = function (chat) {
  if (!chat) return;

  const enableSwitch = document.getElementById('enable-video-optimization-switch');
  const remoteVideoPreview = document.getElementById('remote-video-preview');
  const localVideoPreview = document.getElementById('local-video-preview');
  const enableRealCameraSwitch = document.getElementById('enable-real-camera-switch');
  const cameraIntervalInput = document.getElementById('camera-capture-interval');
  const ttsDialogueOnlySwitch = document.getElementById('tts-dialogue-only-switch');

  chat.videoOptimization = {
    enabled: enableSwitch ? enableSwitch.checked : false,
    remoteVideoUrl: remoteVideoPreview.style.display === 'block' ? remoteVideoPreview.src : '',
    localVideoUrl: localVideoPreview.style.display === 'block' ? localVideoPreview.src : '',
    enableRealCamera: enableRealCameraSwitch ? enableRealCameraSwitch.checked : false,
    useRearCamera: document.getElementById('enable-rear-camera-switch') ? document.getElementById('enable-rear-camera-switch').checked : false,
    cameraInterval: cameraIntervalInput ? parseInt(cameraIntervalInput.value) || 5 : 5,
    ttsDialogueOnly: ttsDialogueOnlySwitch ? ttsDialogueOnlySwitch.checked : false
  };

  // ‰∏çÈúÄË¶ÅÂú®ËøôÈáåputÂà∞Êï∞ÊçÆÂ∫ìÔºåÂõ†‰∏∫Ë∞ÉÁî®Êñπ‰ºöÁªü‰∏Ä‰øùÂ≠ò
};

// Â∫îÁî®ËßÜÈ¢ëÈÄöËØù‰ºòÂåñÂà∞ËßÜÈ¢ëÁïåÈù¢
window.applyVideoOptimizationToCall = async function (chat) {
  const videoDisplayArea = document.getElementById('video-display-area');
  const avatarArea = document.querySelector('.video-call-avatar-area');

  if (!chat || !chat.videoOptimization || !chat.videoOptimization.enabled) {
    videoDisplayArea.style.display = 'none';
    if (avatarArea) avatarArea.style.display = 'flex';
    stopCamera();
    return;
  }

  const settings = chat.videoOptimization;
  if (settings.remoteVideoUrl || settings.localVideoUrl || settings.enableRealCamera) {
    videoDisplayArea.style.display = 'block';
    if (avatarArea) avatarArea.style.display = 'none';

    if (settings.remoteVideoUrl) {
      document.getElementById('remote-video-img').src = settings.remoteVideoUrl;
    }

    // Â§ÑÁêÜÊàëÊñπÁîªÈù¢ÔºöÁúüÂÆûÊëÑÂÉèÂ§¥ÊàñÈùôÊÄÅÂõæÁâá
    const localImg = document.getElementById('local-video-img');
    const localVideo = document.getElementById('local-camera-video');

    if (settings.enableRealCamera) {
      // ‰ΩøÁî®ÁúüÂÆûÊëÑÂÉèÂ§¥
      localImg.style.display = 'none';
      localVideo.style.display = 'block';

      const facingMode = settings.useRearCamera ? 'environment' : 'user';
      const success = await startCamera(facingMode);
      if (success) {
        // ÂêØÂä®ÂÆöÊó∂Êà™Âõæ
        const interval = settings.cameraInterval || 5;
        startCameraCapture(interval);
      }
    } else if (settings.localVideoUrl) {
      // ‰ΩøÁî®ÈùôÊÄÅÂõæÁâá
      localVideo.style.display = 'none';
      localImg.style.display = 'block';
      localImg.src = settings.localVideoUrl;
      stopCamera();
    }
  } else {
    videoDisplayArea.style.display = 'none';
    if (avatarArea) avatarArea.style.display = 'flex';
    stopCamera();
  }
};

// ÂêØÂä®ÊëÑÂÉèÂ§¥
async function startCamera(useFacingMode) {
  try {
    const facing = useFacingMode || 'user';
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: facing
      },
      audio: false
    });

    cameraStream = stream;
    const videoElement = document.getElementById('local-camera-video');
    if (videoElement) {
      videoElement.srcObject = stream;
    }

    // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
    updateCameraStatus(true, 'ÊëÑÂÉèÂ§¥Â∑≤ÂêØÂä®');

    return true;
  } catch (error) {
    console.error('Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥:', error);
    updateCameraStatus(false, 'ÊëÑÂÉèÂ§¥ÂêØÂä®Â§±Ë¥•: ' + error.message);
    return false;
  }
}

// ÂÅúÊ≠¢ÊëÑÂÉèÂ§¥
function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }

  if (captureInterval) {
    clearInterval(captureInterval);
    captureInterval = null;
  }

  const videoElement = document.getElementById('local-camera-video');
  if (videoElement) {
    videoElement.srcObject = null;
  }

  updateCameraStatus(false, 'ÊëÑÂÉèÂ§¥Â∑≤ÂÅúÊ≠¢');
}

// Êõ¥Êñ∞ÊëÑÂÉèÂ§¥Áä∂ÊÄÅÊòæÁ§∫
function updateCameraStatus(isActive, message) {
  const statusDiv = document.getElementById('camera-status');
  const statusIcon = document.getElementById('camera-status-icon');
  const statusText = document.getElementById('camera-status-text');

  if (statusDiv && statusIcon && statusText) {
    statusDiv.style.display = 'block';
    statusIcon.style.background = isActive ? '#4cd964' : '#ccc';
    statusText.textContent = message;
  }
}

// Êà™ÂèñÊëÑÂÉèÂ§¥ÁîªÈù¢
function captureCameraFrame() {
  const videoElement = document.getElementById('local-camera-video');
  if (!videoElement || !cameraStream) return null;

  const canvas = document.createElement('canvas');
  canvas.width = videoElement.videoWidth;
  canvas.height = videoElement.videoHeight;

  const ctx = canvas.getContext('2d');
  ctx.drawImage(videoElement, 0, 0);

  // ËΩ¨Êç¢‰∏∫base64
  const imageData = canvas.toDataURL('image/jpeg', 0.8);
  lastCapturedImage = imageData;

  return imageData;
}

// ÂêØÂä®ÂÆöÊó∂Êà™Âõæ
function startCameraCapture(intervalSeconds) {
  if (captureInterval) {
    clearInterval(captureInterval);
  }

  // Á´ãÂç≥Êà™Âèñ‰∏ÄÊ¨°
  captureCameraFrame();

  // ÂÆöÊó∂Êà™Âèñ
  captureInterval = setInterval(() => {
    captureCameraFrame();
    console.log('Â∑≤Êà™ÂèñÊëÑÂÉèÂ§¥ÁîªÈù¢');
  }, intervalSeconds * 1000);
}

// Ëé∑ÂèñÊúÄÊñ∞Êà™Âõæ
window.getLastCameraCapture = function () {
  return lastCapturedImage;
};

// Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function () {
  initVideoOptimization();
});

// Â¶ÇÊûúDOMContentLoadedÂ∑≤ÁªèËß¶ÂèëÔºåÁ´ãÂç≥ÂàùÂßãÂåñ
if (document.readyState === 'complete' || document.readyState === 'interactive') {
  setTimeout(initVideoOptimization, 1);
}

// ========== ÁúüÂÆûËØ≠Èü≥ÂΩïÂà∂ÂäüËÉΩÔºàÂ∏¶ËØ≠Èü≥ËØÜÂà´Ôºâ ==========
(function () {
  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;
  let recordingStream = null;
  let recognition = null;
  let recognizedText = '';
  let recordingStartTime = 0;

  // ÂàùÂßãÂåñÂΩïÈü≥ÊåâÈíÆ
  function initVoiceRecording() {
    const voiceRecordBtn = document.getElementById('voice-record-btn');
    if (!voiceRecordBtn) {
      console.warn('ÂΩïÈü≥ÊåâÈíÆÊú™ÊâæÂà∞');
      return;
    }

    voiceRecordBtn.addEventListener('click', toggleRecording);

    // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅËØ≠Èü≥ËØÜÂà´
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      console.warn('ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´API');
    }
  }

  // ÂàáÊç¢ÂΩïÈü≥Áä∂ÊÄÅ
  async function toggleRecording() {
    if (isRecording) {
      stopRecording();
    } else {
      await startRecording();
    }
  }

  // ÂºÄÂßãÂΩïÈü≥
  async function startRecording() {
    try {
      // ËØ∑Ê±ÇÈ∫¶ÂÖãÈ£éÊùÉÈôê
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recordingStream = stream;

      // ÂàõÂª∫MediaRecorder
      const options = { mimeType: 'audio/webm' };
      if (!MediaRecorder.isTypeSupported(options.mimeType)) {
        options.mimeType = 'audio/mp4';
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options.mimeType = '';
        }
      }

      mediaRecorder = new MediaRecorder(stream, options);
      audioChunks = [];
      recognizedText = '';
      recordingStartTime = Date.now();

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          audioChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });

        // Á≠âÂæÖËØ≠Èü≥ËØÜÂà´ÂÆåÊàêÔºàÂÖ≥ÈîÆ‰øÆÂ§çÔºöÁªôÁßªÂä®Á´ØChromeË∂≥Â§üÊó∂Èó¥Ôºâ
        if (recognition) {
          await new Promise((resolve) => {
            let resolved = false;
            const safeResolve = () => {
              if (!resolved) {
                resolved = true;
                resolve();
              }
            };

            // ÁõëÂê¨ËØÜÂà´ÁªìÊùü‰∫ã‰ª∂
            const originalOnEnd = recognition.onend;
            recognition.onend = () => {
              console.log('ËØ≠Èü≥ËØÜÂà´Â∑≤ÂÆåÊàê');
              if (originalOnEnd) originalOnEnd();
              safeResolve();
            };

            // ËÆæÁΩÆË∂ÖÊó∂‰øùÊä§ÔºàÁßªÂä®Á´ØÁªô5ÁßíÔºåÊ°åÈù¢Á´Ø3ÁßíÔºâ
            const isMobileChrome = /Android.*Chrome/.test(navigator.userAgent);
            const timeout = isMobileChrome ? 5000 : 3000;
            
            setTimeout(() => {
              console.log('ËØÜÂà´Á≠âÂæÖË∂ÖÊó∂Ôºå‰ΩøÁî®ÂΩìÂâçÁªìÊûú');
              try {
                recognition.stop();
              } catch (e) {
                console.log('ÂÅúÊ≠¢ËØÜÂà´Êó∂Âá∫Èîô:', e);
              }
              safeResolve();
            }, timeout);

            // Â¶ÇÊûúÂ∑≤ÁªèÊúâËØÜÂà´ÁªìÊûúÔºåÂèØ‰ª•ÊèêÂâçÁªìÊùü
            if (recognizedText.trim()) {
              console.log('Â∑≤ÊúâËØÜÂà´ÁªìÊûúÔºåÊèêÂâçÁªìÊùüÁ≠âÂæÖ');
              setTimeout(() => {
                try {
                  recognition.stop();
                } catch (e) {
                  console.log('ÂÅúÊ≠¢ËØÜÂà´Êó∂Âá∫Èîô:', e);
                }
                safeResolve();
              }, 1000); // Áªô1ÁßíÁºìÂÜ≤ÔºåÁ°Æ‰øùÊúÄÂêéÁöÑÁªìÊûú‰πüËÉΩÊî∂Âà∞
            }
          });
        }

        // Áé∞Âú®Â§ÑÁêÜÂΩïÂà∂ÁöÑÈü≥È¢ëÔºàÊ≠§Êó∂recognizedTextÂ∫îËØ•Â∑≤ÁªèÊúâÂÄº‰∫ÜÔºâ
        await handleRecordedAudio(audioBlob);

        // Ê∏ÖÁêÜËµÑÊ∫ê
        if (recordingStream) {
          recordingStream.getTracks().forEach(track => track.stop());
          recordingStream = null;
        }
      };

      // ÂêØÂä®ËØ≠Èü≥ËØÜÂà´
      startSpeechRecognition();

      mediaRecorder.start();
      isRecording = true;
      updateRecordButtonUI(true);

      console.log('ÂºÄÂßãÂΩïÈü≥ÂíåËØ≠Èü≥ËØÜÂà´...');
    } catch (error) {
      console.error('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£é:', error);
      alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ÊùÉÈôêËÆæÁΩÆ');
    }
  }

  // ÂêØÂä®ËØ≠Èü≥ËØÜÂà´
  function startSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      console.warn('ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´');
      return;
    }

    recognition = new SpeechRecognition();
    
    // Ê£ÄÊµãÊòØÂê¶ÊòØÁßªÂä®Á´ØChromeÔºàÁßªÂä®Á´Ø‰ΩøÁî®Êõ¥Á®≥ÂÆöÁöÑËÆæÁΩÆÔºâ
    const isMobileChrome = /Android.*Chrome/.test(navigator.userAgent);
    
    if (isMobileChrome) {
      // ÁßªÂä®Á´ØChromeÔºö‰ΩøÁî®ÈùûËøûÁª≠Ê®°ÂºèÔºåÊõ¥Á®≥ÂÆö
      recognition.continuous = false;
      recognition.interimResults = false;
      console.log('Ê£ÄÊµãÂà∞ÁßªÂä®Á´ØChromeÔºå‰ΩøÁî®‰ºòÂåñËÆæÁΩÆ');
    } else {
      // Ê°åÈù¢Á´ØÊàñÂÖ∂‰ªñÊµèËßàÂô®Ôºö‰ΩøÁî®ËøûÁª≠Ê®°Âºè
      recognition.continuous = true;
      recognition.interimResults = true;
    }
    
    recognition.lang = 'zh-CN'; // ËÆæÁΩÆËØ≠Ë®Ä‰∏∫‰∏≠Êñá

    recognition.onresult = (event) => {
      let interimTranscript = '';
      let finalTranscript = '';

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          finalTranscript += transcript;
        } else {
          interimTranscript += transcript;
        }
      }

      // Êõ¥Êñ∞ËØÜÂà´ÊñáÊú¨
      if (finalTranscript) {
        recognizedText += finalTranscript;
      }

      console.log('ËØÜÂà´‰∏≠:', recognizedText + interimTranscript);
    };

    recognition.onerror = (event) => {
      console.error('ËØ≠Èü≥ËØÜÂà´ÈîôËØØ:', event.error);
      if (event.error === 'no-speech') {
        console.log('Ê≤°ÊúâÊ£ÄÊµãÂà∞ËØ≠Èü≥');
      } else if (event.error === 'network' || event.error === 'aborted') {
        console.log('ÁΩëÁªúÈóÆÈ¢òÊàñËØÜÂà´Ë¢´‰∏≠Êñ≠');
      }
    };

    recognition.onend = () => {
      console.log('ËØ≠Èü≥ËØÜÂà´ÁªìÊùüÔºåÂΩìÂâçËØÜÂà´ÊñáÊú¨:', recognizedText);
    };

    try {
      recognition.start();
      console.log('ËØ≠Èü≥ËØÜÂà´Â∑≤ÂêØÂä®');
    } catch (error) {
      console.error('ÂêØÂä®ËØ≠Èü≥ËØÜÂà´Â§±Ë¥•:', error);
    }
  }

  // ÂÅúÊ≠¢ÂΩïÈü≥
  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      isRecording = false;
      updateRecordButtonUI(false);
      console.log('ÂÅúÊ≠¢ÂΩïÈü≥');
    }
  }

  // Êõ¥Êñ∞ÂΩïÈü≥ÊåâÈíÆUI
  function updateRecordButtonUI(recording) {
    const voiceRecordBtn = document.getElementById('voice-record-btn');
    if (!voiceRecordBtn) return;

    if (recording) {
      voiceRecordBtn.style.color = '#ff3b30';
      voiceRecordBtn.style.backgroundColor = '#ffe5e5';
      voiceRecordBtn.title = 'ÂÅúÊ≠¢ÂΩïÈü≥';
    } else {
      voiceRecordBtn.style.color = '';
      voiceRecordBtn.style.backgroundColor = '';
      voiceRecordBtn.title = 'ÂΩïÈü≥';
    }
  }

  // ÊòæÁ§∫ËØ≠Èü≥ÊñáÂ≠óÁ°ÆËÆ§ÂØπËØùÊ°Ü
  function showVoiceTextConfirmDialog(recognizedText, audioBlob) {
    return new Promise((resolve) => {
      // ÂàõÂª∫ÂØπËØùÊ°Ü
      const dialog = document.createElement('div');
      dialog.className = 'voice-text-confirm-dialog';
      dialog.innerHTML = `
        <div class="voice-text-confirm-overlay"></div>
        <div class="voice-text-confirm-content">
          <div class="voice-text-confirm-header">
            <h3>ËØ≠Èü≥ËØÜÂà´ÁªìÊûú</h3>
            <p class="voice-text-hint">ËØ∑Á°ÆËÆ§Êàñ‰øÆÊîπËØÜÂà´ÁöÑÊñáÂ≠óÂêéÂèëÈÄÅ</p>
          </div>
          <div class="voice-text-confirm-body">
            <textarea class="voice-text-input" placeholder="Êú™ËØÜÂà´Âà∞ËØ≠Èü≥ÂÜÖÂÆπÔºåËØ∑ÊâãÂä®ËæìÂÖ•...">${escapeHTML(recognizedText)}</textarea>
          </div>
          <div class="voice-text-confirm-footer">
            <button class="voice-text-cancel-btn">ÂèñÊ∂à</button>
            <button class="voice-text-send-btn">ÂèëÈÄÅ</button>
          </div>
        </div>
      `;

      document.body.appendChild(dialog);

      // ËÅöÁÑ¶Âà∞ÊñáÊú¨Ê°Ü
      const textarea = dialog.querySelector('.voice-text-input');
      setTimeout(() => {
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
      }, 100);

      // ÂèñÊ∂àÊåâÈíÆ
      dialog.querySelector('.voice-text-cancel-btn').addEventListener('click', () => {
        document.body.removeChild(dialog);
        resolve(null);
      });

      // ÂèëÈÄÅÊåâÈíÆ
      dialog.querySelector('.voice-text-send-btn').addEventListener('click', () => {
        const finalText = textarea.value.trim();
        document.body.removeChild(dialog);
        resolve(finalText);
      });

      // ÁÇπÂáªÈÅÆÁΩ©Â±ÇÂÖ≥Èó≠
      dialog.querySelector('.voice-text-confirm-overlay').addEventListener('click', () => {
        document.body.removeChild(dialog);
        resolve(null);
      });

      // ÊîØÊåÅCtrl+EnterÂèëÈÄÅ
      textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
          const finalText = textarea.value.trim();
          document.body.removeChild(dialog);
          resolve(finalText);
        }
      });
    });
  }

  // Â§ÑÁêÜÂΩïÂà∂ÁöÑÈü≥È¢ë
  async function handleRecordedAudio(audioBlob) {
    if (!state.activeChatId) {
      alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©');
      return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°ÜÔºåËÆ©Áî®Êà∑Á°ÆËÆ§Êàñ‰øÆÊîπËØÜÂà´ÁöÑÊñáÂ≠ó
    const confirmedText = await showVoiceTextConfirmDialog(recognizedText, audioBlob);

    if (confirmedText === null) {
      console.log('Áî®Êà∑ÂèñÊ∂àÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØ');
      return;
    }

    // Â¶ÇÊûúÁî®Êà∑Ê≤°ÊúâËæìÂÖ•‰ªª‰ΩïÊñáÂ≠óÔºå‰ΩøÁî®ÈªòËÆ§ÊñáÂ≠ó
    const finalText = confirmedText || '[ËØ≠Èü≥Ê∂àÊÅØ]';

    // ËΩ¨Êç¢‰∏∫base64
    const reader = new FileReader();
    reader.onloadend = async () => {
      const base64Audio = reader.result;

      // ËÆ°ÁÆóÂÆûÈôÖÈü≥È¢ëÊó∂Èïø
      const actualDuration = Math.round((Date.now() - recordingStartTime) / 1000);
      const duration = Math.max(1, actualDuration);

      // ÂàõÂª∫ËØ≠Èü≥Ê∂àÊÅØ
      const msg = {
        role: 'user',
        type: 'voice_message',
        content: finalText, // ‰ΩøÁî®ËØÜÂà´ÊàñÁî®Êà∑‰øÆÊîπÂêéÁöÑÊñáÂ≠ó
        audioData: base64Audio, // ÁúüÂÆûÈü≥È¢ëÊï∞ÊçÆ
        audioMimeType: audioBlob.type,
        audioDuration: duration,
        timestamp: Date.now()
      };

      // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
      chat.history.push(msg);
      await db.chats.put(chat);

      // Ê∏≤ÊüìÊ∂àÊÅØ
      appendMessage(msg, chat);
      renderChatList();

      console.log('ËØ≠Èü≥Ê∂àÊÅØÂ∑≤ÂèëÈÄÅÔºåÊñáÂ≠óÂÜÖÂÆπ:', finalText);
    };

    reader.readAsDataURL(audioBlob);
  }

  // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initVoiceRecording);
  } else {
    initVoiceRecording();
  }

  // ÂØºÂá∫Âà∞ÂÖ®Â±Ä
  window.voiceRecording = {
    startRecording,
    stopRecording,
    isRecording: () => isRecording
  };
})();


// ========================================
// ÊèêÁ§∫ËØçÁÆ°ÁêÜÂô® UI ‰∫§‰∫í
// ========================================

let currentEditingSceneId = null;

// ÂàùÂßãÂåñÊèêÁ§∫ËØçÁÆ°ÁêÜÂô®UI
function initPromptManagerUI() {
  renderPromptScenes();

  // ÊâìÂºÄÊèêÁ§∫ËØçÁÆ°ÁêÜÂô®ÊåâÈíÆÔºàÂú®APIËÆæÁΩÆ‰∏≠Ôºâ
  const openBtn = document.getElementById('open-prompt-manager-btn');
  if (openBtn) {
    const openPromptManagerHandler = () => {
      // ÊöÇÊó∂ÈîÅÂÆöÊèêÁ§∫ËØçÁÆ°ÁêÜÂäüËÉΩ
      showCustomAlert(
        'ÂäüËÉΩÂºÄÂèë‰∏≠',
        'Ëá™ÂÆö‰πâÊèêÁ§∫ËØçÂäüËÉΩÊ≠£Âú®ÈáçÊûÑ‰∏≠ÔºåÊöÇÊó∂Êó†Ê≥ï‰ΩøÁî®„ÄÇ\n\nÂΩìÂâçÊâÄÊúâÂØπËØùÈÉΩ‰ΩøÁî®ÂÜÖÁΩÆÁöÑÈªòËÆ§ÊèêÁ§∫ËØç„ÄÇ\n\nÈ¢ÑËÆ°Âú®‰∏ã‰∏™ÁâàÊú¨‰∏≠ÂÆåÊàêÈõÜÊàê„ÄÇ'
      );
      // showScreen('prompt-manager-screen'); // ÊöÇÊó∂Ê≥®ÈáäÊéâ
    };
    openBtn.addEventListener('click', openPromptManagerHandler);
    openBtn.addEventListener('touchend', (e) => {
      e.preventDefault();
      openPromptManagerHandler();
    }, { passive: false });
  }

  // ÊåÅ‰πÖÂåñÂ≠òÂÇ®Ê£ÄÊü•ÊåâÈíÆ
  const storagePersistBtn = document.getElementById('check-storage-persistence-btn');
  if (storagePersistBtn) {
    const storagePersistHandler = async () => {
      const infoDiv = document.getElementById('storage-persistence-info');
      infoDiv.style.display = 'block';
      infoDiv.innerHTML = '<span style="color:#999;">Ê£ÄÊü•‰∏≠...</span>';

      try {
        const persisted = await window.checkStoragePersistence();
        const estimate = await window.getStorageEstimate();

        let html = '';

        // ÊåÅ‰πÖÂåñÁä∂ÊÄÅ
        if (persisted === true) {
          html += '<div style="margin-bottom:8px;">üõ°Ô∏è <strong style="color:#34c759;">Â∑≤ÂêØÁî®ÊåÅ‰πÖÂåñ‰øùÊä§</strong><br><span style="font-size:12px;">ÊµèËßàÂô®‰∏ç‰ºöËá™Âä®Ê∏ÖÈô§Êú¨Á´ôÊï∞ÊçÆ</span></div>';
        } else if (persisted === false) {
          html += '<div style="margin-bottom:8px;">‚ö†Ô∏è <strong style="color:#ff9500;">Êú™Ëé∑ÂæóÊåÅ‰πÖÂåñ‰øùÊä§</strong><br><span style="font-size:12px;">ÊµèËßàÂô®ÂèØËÉΩÂú®Â≠òÂÇ®ÂéãÂäõ‰∏ãËá™Âä®Ê∏ÖÈô§Êï∞ÊçÆÔºåÂª∫ËÆÆÂÆöÊúüÂ§á‰ªΩ</span></div>';
          html += '<button id="request-persist-btn" style="margin:6px 0 10px;padding:6px 14px;border:none;border-radius:8px;background:#007aff;color:#fff;font-size:13px;cursor:pointer;">ËØ∑Ê±ÇÊåÅ‰πÖÂåñ‰øùÊä§</button>';
        } else {
          html += '<div style="margin-bottom:8px;">‚ùì <strong style="color:#999;">ÊµèËßàÂô®‰∏çÊîØÊåÅÊåÅ‰πÖÂåñÂ≠òÂÇ® API</strong></div>';
        }

        // Â≠òÂÇ®Áî®Èáè
        if (estimate) {
          const usageMB = (estimate.usage / 1024 / 1024).toFixed(1);
          const quotaMB = (estimate.quota / 1024 / 1024).toFixed(0);
          const percent = estimate.usagePercent;
          const barColor = percent > 80 ? '#ff3b30' : percent > 50 ? '#ff9500' : '#34c759';
          html += '<div style="margin-top:4px;">';
          html += `üì¶ Â∑≤Áî® <strong>${usageMB} MB</strong> / ${quotaMB} MBÔºà${percent}%Ôºâ`;
          html += `<div style="margin-top:6px;height:6px;background:#e0e0e0;border-radius:3px;overflow:hidden;">`;
          html += `<div style="height:100%;width:${Math.min(percent, 100)}%;background:${barColor};border-radius:3px;transition:width 0.3s;"></div>`;
          html += '</div></div>';
        }

        infoDiv.innerHTML = html;

        // ÁªëÂÆöÊâãÂä®ËØ∑Ê±ÇÊåâÈíÆ
        const requestBtn = document.getElementById('request-persist-btn');
        if (requestBtn) {
          const requestPersistHandler = async () => {
            try {
              const granted = await navigator.storage.persist();
              if (granted) {
                await showCustomAlert('ÊàêÂäü', 'Â∑≤Ëé∑ÂæóÊåÅ‰πÖÂåñÂ≠òÂÇ®‰øùÊä§ÔºåÊµèËßàÂô®‰∏ç‰ºöËá™Âä®Ê∏ÖÈô§Êï∞ÊçÆ„ÄÇ');
              } else {
                await showCustomAlert('ÊèêÁ§∫', 'ÊµèËßàÂô®ÊãíÁªù‰∫ÜËØ∑Ê±Ç„ÄÇ\n\nÂª∫ËÆÆÔºöÂ∞ÜÊú¨Á´ôÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπïÔºàPWAÂÆâË£ÖÔºâÊàñÂºÄÂêØÈÄöÁü•ÊùÉÈôêÔºåÂèØÊèêÈ´òÊéàÊùÉÊ¶ÇÁéá„ÄÇ');
              }
              // Âà∑Êñ∞ÊòæÁ§∫
              storagePersistBtn.click();
            } catch (err) {
              await showCustomAlert('ÈîôËØØ', 'ËØ∑Ê±ÇÂ§±Ë¥•: ' + err.message);
            }
          };
          requestBtn.addEventListener('click', requestPersistHandler);
          requestBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            requestPersistHandler();
          }, { passive: false });
        }
      } catch (error) {
        infoDiv.innerHTML = '<span style="color:#ff3b30;">Ê£ÄÊü•Â§±Ë¥•: ' + error.message + '</span>';
      }
    };
    storagePersistBtn.addEventListener('click', storagePersistHandler);
    storagePersistBtn.addEventListener('touchend', (e) => {
      e.preventDefault();
      storagePersistHandler();
    }, { passive: false });
  }

  // ÂØºÂá∫ÊåâÈíÆ
  document.getElementById('prompt-export-btn').addEventListener('click', () => {
    promptManager.exportPrompts();
    showCustomAlert('ÂØºÂá∫ÊàêÂäü', 'ÊèêÁ§∫ËØçÂ∑≤ÂØºÂá∫‰∏∫JSONÊñá‰ª∂');
  });

  // ÂØºÂÖ•ÊåâÈíÆ
  document.getElementById('prompt-import-btn').addEventListener('click', () => {
    document.getElementById('prompt-import-input').click();
  });

  // ÂØºÂÖ•Êñá‰ª∂ÈÄâÊã©
  document.getElementById('prompt-import-input').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      await promptManager.importPrompts(file);
      renderPromptScenes();
      await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', 'ÊèêÁ§∫ËØçÂ∑≤ÊàêÂäüÂØºÂÖ•');
    } catch (error) {
      await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `ÈîôËØØ: ${error.message}`);
    }

    // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©
    e.target.value = '';
  });

  // ÈáçÁΩÆÊåâÈíÆ
  document.getElementById('prompt-reset-btn').addEventListener('click', async () => {
    const confirmed = confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÊèêÁ§∫ËØç‰∏∫ÈªòËÆ§ÂÄºÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ');
    if (!confirmed) return;

    if (promptManager.resetToDefaults()) {
      renderPromptScenes();
      await showCustomAlert('ÈáçÁΩÆÊàêÂäü', 'ÊâÄÊúâÊèêÁ§∫ËØçÂ∑≤ÊÅ¢Â§ç‰∏∫ÈªòËÆ§ÂÄº');
    } else {
      await showCustomAlert('ÈáçÁΩÆÂ§±Ë¥•', 'Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
  });
}

// Ê∏≤ÊüìÂú∫ÊôØÂàóË°®
function renderPromptScenes() {
  const container = document.getElementById('prompt-scenes-container');
  container.innerHTML = '';

  const scenes = promptManager.getAllScenes();
  const customPrompts = promptManager.loadCustomPrompts();
  const defaultPrompts = promptManager.getDefaultPrompts();

  // ÊåâÁ±ªÂà´ÂàÜÁªÑ
  const categories = {};
  scenes.forEach(scene => {
    if (!categories[scene.category]) {
      categories[scene.category] = [];
    }
    categories[scene.category].push(scene);
  });

  // Ê∏≤ÊüìÊØè‰∏™Á±ªÂà´
  Object.keys(categories).forEach(category => {
    const categoryDiv = document.createElement('div');
    categoryDiv.className = 'prompt-category';

    const headerDiv = document.createElement('div');
    headerDiv.className = 'prompt-category-header';
    headerDiv.style.display = 'flex';
    headerDiv.style.justifyContent = 'space-between';
    headerDiv.style.alignItems = 'center';

    const titleSpan = document.createElement('span');
    titleSpan.textContent = category;
    headerDiv.appendChild(titleSpan);

    // ÂàÜÁ±ªÊìç‰ΩúÊåâÈíÆÂÆπÂô®
    const categoryActionsDiv = document.createElement('div');
    categoryActionsDiv.style.display = 'flex';
    categoryActionsDiv.style.gap = '8px';

    // ÂØºÂá∫ÊåâÈíÆ
    const exportCategoryBtn = document.createElement('button');
    exportCategoryBtn.textContent = 'ÂØºÂá∫';
    exportCategoryBtn.className = 'category-action-btn';
    exportCategoryBtn.onclick = (e) => {
      e.stopPropagation();
      promptManager.exportCategory(category);
    };

    // ÂØºÂÖ•ÊåâÈíÆ
    const importCategoryBtn = document.createElement('button');
    importCategoryBtn.textContent = 'ÂØºÂÖ•';
    importCategoryBtn.className = 'category-action-btn';
    importCategoryBtn.onclick = async (e) => {
      e.stopPropagation();
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (event) => {
        const file = event.target.files[0];
        if (file) {
          try {
            await promptManager.importCategory(file, category);
            renderPromptScenes();
            await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `${category}ÁöÑÊèêÁ§∫ËØçÂ∑≤ÊàêÂäüÂØºÂÖ•`);
          } catch (error) {
            await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', error.message);
          }
        }
      };
      input.click();
    };

    // ÈáçÁΩÆÊåâÈíÆ
    const resetCategoryBtn = document.createElement('button');
    resetCategoryBtn.textContent = 'ÈáçÁΩÆ';
    resetCategoryBtn.className = 'category-action-btn';
    resetCategoryBtn.onclick = async (e) => {
      e.stopPropagation();
      const confirmed = confirm(`Á°ÆÂÆöË¶ÅÈáçÁΩÆ"${category}"ÂàÜÁ±ªÁöÑÊâÄÊúâÊèêÁ§∫ËØçÂêóÔºü`);
      if (confirmed) {
        categories[category].forEach(scene => {
          promptManager.resetScene(scene.id);
        });
        renderPromptScenes();
        await showCustomAlert('ÈáçÁΩÆÊàêÂäü', `${category}ÁöÑÊèêÁ§∫ËØçÂ∑≤ÊÅ¢Â§ç‰∏∫ÈªòËÆ§ÂÄº`);
      }
    };

    categoryActionsDiv.appendChild(exportCategoryBtn);
    categoryActionsDiv.appendChild(importCategoryBtn);
    categoryActionsDiv.appendChild(resetCategoryBtn);
    headerDiv.appendChild(categoryActionsDiv);

    categoryDiv.appendChild(headerDiv);

    const listDiv = document.createElement('div');
    listDiv.className = 'prompt-scene-list';

    categories[category].forEach(scene => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'prompt-scene-item';

      const nameSpan = document.createElement('span');
      nameSpan.className = 'prompt-scene-name';
      nameSpan.textContent = scene.name;

      const statusSpan = document.createElement('span');
      statusSpan.className = 'prompt-scene-status';

      // Ê£ÄÊü•ÊòØÂê¶ÊúâËá™ÂÆö‰πâÊèêÁ§∫ËØçÔºàÂØπÊØîÈªòËÆ§ÂÄºÔºâ
      const keys = scene.id.split('.');
      let customValue = customPrompts?.prompts;
      let defaultValue = defaultPrompts.prompts;

      for (const key of keys) {
        customValue = customValue?.[key];
        defaultValue = defaultValue?.[key];
      }

      // Âè™ÊúâÂΩìËá™ÂÆö‰πâÂÄºÂ≠òÂú®‰∏î‰∏éÈªòËÆ§ÂÄº‰∏çÂêåÊó∂ÔºåÊâçÊòæÁ§∫"Â∑≤Ëá™ÂÆö‰πâ"
      const isCustomized = customValue &&
        customValue.trim() &&
        customValue !== defaultValue;

      if (isCustomized) {
        statusSpan.textContent = 'Â∑≤Ëá™ÂÆö‰πâ';
        statusSpan.classList.add('custom');
      } else {
        statusSpan.textContent = '‰ΩøÁî®ÈªòËÆ§';
      }

      const editBtn = document.createElement('button');
      editBtn.className = 'prompt-edit-btn';
      editBtn.textContent = 'ÁºñËæë';
      editBtn.onclick = () => openPromptEditor(scene.id, scene.name);

      itemDiv.appendChild(nameSpan);
      itemDiv.appendChild(statusSpan);
      itemDiv.appendChild(editBtn);
      listDiv.appendChild(itemDiv);
    });

    categoryDiv.appendChild(listDiv);
    container.appendChild(categoryDiv);
  });
}
// ÊâìÂºÄÊèêÁ§∫ËØçÁºñËæëÂô®
function openPromptEditor(sceneId, sceneName) {
  currentEditingSceneId = sceneId;

  const modal = document.getElementById('prompt-editor-modal');
  const title = document.getElementById('prompt-editor-title');
  const textarea = document.getElementById('prompt-editor-textarea');

  title.textContent = `ÁºñËæëÊèêÁ§∫ËØç - ${sceneName}`;

  // Ëé∑ÂèñÂΩìÂâçÊèêÁ§∫ËØçÔºà‰ºòÂÖàËá™ÂÆö‰πâÔºåÂê¶ÂàôÈªòËÆ§Ôºâ
  const currentPrompt = promptManager.getPrompt(sceneId);
  textarea.value = currentPrompt;

  modal.style.display = 'flex';

  // Ëá™Âä®ËÅöÁÑ¶
  setTimeout(() => textarea.focus(), 100);
}

// ÂÖ≥Èó≠ÊèêÁ§∫ËØçÁºñËæëÂô®
function closePromptEditor() {
  const modal = document.getElementById('prompt-editor-modal');
  modal.style.display = 'none';
  currentEditingSceneId = null;
}

// ‰øùÂ≠òÊèêÁ§∫ËØçÁºñËæë
async function savePromptEdit() {
  if (!currentEditingSceneId) return;

  const textarea = document.getElementById('prompt-editor-textarea');
  const newPrompt = textarea.value;

  // Âä†ËΩΩÊàñÂàõÂª∫Ëá™ÂÆö‰πâÊèêÁ§∫ËØçÂØπË±°
  let customPrompts = promptManager.loadCustomPrompts() || promptManager.getDefaultPrompts();

  // Ê†πÊçÆË∑ØÂæÑËÆæÁΩÆÂÄº
  const keys = currentEditingSceneId.split('.');
  let target = customPrompts.prompts;

  for (let i = 0; i < keys.length - 1; i++) {
    if (!target[keys[i]]) {
      target[keys[i]] = {};
    }
    target = target[keys[i]];
  }

  target[keys[keys.length - 1]] = newPrompt;

  // ‰øùÂ≠ò
  if (promptManager.saveCustomPrompts(customPrompts)) {
    closePromptEditor();
    renderPromptScenes();
    await showCustomAlert('‰øùÂ≠òÊàêÂäü', 'ÊèêÁ§∫ËØçÂ∑≤‰øùÂ≠ò');
  } else {
    await showCustomAlert('‰øùÂ≠òÂ§±Ë¥•', 'Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
  }
}

// Âú®È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initPromptManagerUI);
} else {
  initPromptManagerUI();
}


// ========================================
// ÊèêÁ§∫ËØçËé∑ÂèñËæÖÂä©ÂáΩÊï∞
// ========================================

// Ê≥®ÊÑèÔºöÁî±‰∫éÊèêÁ§∫ËØçÂåÖÂê´Â§ßÈáèÊ®°ÊùøÂèòÈáèÔºà${...}ÔºâÔºå
// Êàë‰ª¨ÈááÁî®‰ª•‰∏ãÁ≠ñÁï•Ôºö
// 1. Â¶ÇÊûúÁî®Êà∑Ê≤°ÊúâËá™ÂÆö‰πâÔºåÁõ¥Êé•‰ΩøÁî®‰ª£Á†Å‰∏≠ÁöÑÂéüÂßãÊèêÁ§∫ËØçÔºà‰øùÊåÅÁé∞ÊúâÈÄªËæëÔºâ
// 2. Â¶ÇÊûúÁî®Êà∑Ëá™ÂÆö‰πâ‰∫ÜÔºåÂàô‰ΩøÁî®Ëá™ÂÆö‰πâÁöÑÊèêÁ§∫ËØç
// 3. Ëá™ÂÆö‰πâÊèêÁ§∫ËØç‰∏≠ÁöÑÂèòÈáè‰ºöÂú®ËøêË°åÊó∂Ë¢´ÊõøÊç¢

// Ê£ÄÊü•ÊòØÂê¶ÊúâËá™ÂÆö‰πâÊèêÁ§∫ËØç
function hasCustomPrompt(scenePath) {
  const custom = promptManager.loadCustomPrompts();
  if (!custom) return false;

  const keys = scenePath.split('.');
  let value = custom.prompts;
  for (const key of keys) {
    value = value?.[key];
  }

  return value && value.trim().length > 0;
}

// Ëé∑ÂèñËá™ÂÆö‰πâÊèêÁ§∫ËØçÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
function getCustomPromptIfExists(scenePath) {
  if (!hasCustomPrompt(scenePath)) {
    return null;
  }
  return promptManager.getPrompt(scenePath);
}

