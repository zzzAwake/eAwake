<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EPhone</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        @font-face { font-family: 'bulangni'; src: url('https://files.catbx.moe/yzfk0h.ttf') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff; }
        html { height: 100%; overflow: hidden; }
        body { height: 100%; overflow: hidden; margin: 0; padding: 20px; font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-weight: normal; background-color: #dcdcdc; display: flex; justify-content: center; align-items: center; box-sizing: border-box; }
        #phone-frame { padding: 12px; background-color: #fff; border-radius: 50px; box-shadow: 0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1); position: relative; }       
        .notch { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 130px; height: 28px; background-color: #1f1f1f; border-radius: 0 0 15px 15px; z-index: 20; }
        #phone-screen { width: var(--screen-width); height: var(--screen-height); background-color: #000; border-radius: 40px; position: relative; overflow: hidden; display: flex; flex-direction: column; border: 2px solid #333; }
        #status-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; color: white; z-index: 10; font-size: 14px; box-sizing: border-box; pointer-events: none; }
        #status-bar-time { font-weight: 600; }
        .battery-container { display: flex; align-items: center; gap: 5px; }
        .battery-icon { width: 25px; height: 12px; border: 1px solid white; border-radius: 3px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 2px; width: 2px; height: 6px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 1px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { position: relative; z-index: 15; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; }
        .header .header-actions { display: flex; align-items: center; gap: 15px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: var(--accent-color); display: flex; align-items: center; justify-content: center; }

.header .action-btn {
    font-size: 16px; /* ä¸“é—¨ä¸ºâ€œä¸Šä¼ â€ã€â€œ+â€ç­‰æ–‡å­—æŒ‰é’®ç¼©å°å­—å· */
    font-weight: 600; /* å¯ä»¥åŠ ç²—ä¸€ç‚¹è®©å®ƒæ›´æ¸…æ™° */
}

        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
        #home-screen { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 20px; padding-top: 80px; padding-bottom: 50px; box-sizing: border-box; background-size: cover; background-position: center; }
        #clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-bottom: 20px; flex-shrink: 0; }
        #main-time { font-size: 80px; font-weight: 200; }
        #main-date { font-size: 18px; font-weight: 500; }
        #app-grid { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
/* ä¿®æ”¹åçš„ #world-book-list æ ·å¼ */
#world-book-list {
    flex-grow: 1;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    padding-top: 80px;
    margin-top: -80px;
}

/* ä¿®æ”¹åçš„ #chat-list æ ·å¼ï¼Œå»æ‰äº† padding å’Œ margin */
#chat-list {
    flex-grow: 1;
    background-color: var(--secondary-bg);
    padding-top: 80px; 
    padding-bottom: 50px; /* ä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
    box-sizing: border-box;
}

        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }
/* â–¼â–¼â–¼ ç”¨è¿™å—ä»£ç æ›¿æ¢æ‰ä½ åŸæ¥çš„ #chat-messages æ ·å¼ â–¼â–¼â–¼ */
#chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    overflow-x: hidden; /* æ ¸å¿ƒä¿®æ­£1: å¼ºåˆ¶ç¦æ­¢æ°´å¹³æ»šåŠ¨/æ‹–åŠ¨ */
    padding: 10px 15px; /* æ ¸å¿ƒä¿®æ­£2: å°†å·¦å³å†…è¾¹è·å¢åŠ åˆ°15pxï¼Œæä¾›æ›´å¤šå‘¼å¸ç©ºé—´ */
    padding-top: 110px;
    margin-top: -80px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·è®¡ç®—æ­£ç¡® */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }

        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }
        .message-wrapper.ai .sender-name { margin-left: 60px; }

/* â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ message-wrapper å’Œ message-bubble ç›¸å…³æ ·å¼ â–¼â–¼â–¼ */

/* æ¶ˆæ¯å•å…ƒçš„æ€»å®¹å™¨ */
.message-wrapper {
    display: flex; /* å…³é”®ï¼šä½¿å…¶æˆä¸ºFlexå®¹å™¨ï¼Œè¿™æ ·å†…éƒ¨çš„å¯¹é½æ‰ä¼šç”Ÿæ•ˆ */
    flex-direction: column;
    position: relative;
    margin-bottom: 18px;
    max-width: 85%; /* æ ¸å¿ƒï¼šé™åˆ¶æ¶ˆæ¯å•å…ƒæœ€å¤§å®½åº¦ï¼Œç¡®ä¿è¾¹ç¼˜æ€»æœ‰ç©ºé—´ */
}

/* AIæ¶ˆæ¯å•å…ƒé å·¦ */
.message-wrapper.ai {
    align-self: flex-start; /* è®©æ•´ä¸ªå•å…ƒåœ¨èŠå¤©ç•Œé¢ä¸­é å·¦ */
    align-items: flex-start; /* è®©å•å…ƒå†…çš„å…ƒç´ ï¼ˆå¦‚æ°”æ³¡ï¼‰ä¹Ÿé å·¦ */
}

/* ç”¨æˆ·æ¶ˆæ¯å•å…ƒé å³ */
.message-wrapper.user {
    align-self: flex-end; /* è®©æ•´ä¸ªå•å…ƒåœ¨èŠå¤©ç•Œé¢ä¸­é å³ */
    align-items: flex-end; /* è®©å•å…ƒå†…çš„å…ƒç´ ï¼ˆå¦‚æ°”æ³¡ï¼‰ä¹Ÿé å³ */
}

/* æ°”æ³¡å’Œå¤´åƒçš„ç›´æ¥å®¹å™¨ */
.message-bubble {
    display: flex;
    align-items: flex-start;
    gap: 12px; /* ç¡®ä¿å¤´åƒå’Œæ°”æ³¡ä¹‹é—´æœ‰èˆ’é€‚çš„é—´è· */
    max-width: 100%; /* æ°”æ³¡å®½åº¦ä¸èƒ½è¶…è¿‡å…¶çˆ¶å®¹å™¨(message-wrapper) */
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

        .message-bubble.selected::after { content: 'âœ”'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }

/* â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ä¸¤æ¡æ–°è§„åˆ™ï¼Œå®Œæ•´æ›¿æ¢æ‰ä¸Šé¢é‚£ä¸€æ¡ â–¼â–¼â–¼ */

/* é»˜è®¤æ—¶é—´æˆ³æ ·å¼ (ç”¨äºå¯¹æ–¹/AI) */
.message-bubble.ai + .timestamp {
    position: absolute;
    bottom: -18px;
    right: 5px; /* å®šä½åœ¨å³è¾¹ */
    font-size: 11px;
    color: #888;
    text-shadow: 0 0 3px rgba(255,255,255,0.6);
}

/* ç”¨æˆ·çš„æ—¶é—´æˆ³æ ·å¼ */
.message-bubble.user + .timestamp {
    position: absolute;
    bottom: -18px;
    left: 5px; /* å…³é”®ï¼šå®šä½åœ¨å·¦è¾¹ */
    font-size: 11px;
    color: #888;
    text-shadow: 0 0 3px rgba(255,255,255,0.6);
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        #chat-input-area { flex-shrink: 0; padding: 8px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        #chat-input { flex-grow: 1; border: none; padding: 10px 15px; border-radius: 20px; background-color: var(--secondary-bg); font-size: 16px; max-height: 100px; resize: none; }
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: auto; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); 
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    visibility: hidden;
}
#notification-bar.visible {
    /* å…³é”®ï¼šåœ¨Yè½´å›åˆ°åŸä½çš„åŒæ—¶ï¼Œä¿æŒXè½´çš„å±…ä¸­å˜æ¢ */
    transform: translateX(-50%) translateY(0);
    visibility: visible;
}
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        .message-bubble.is-sticker .content, .message-bubble.is-voice-message .content { padding: 0; background-color: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect { position: relative; user-select: none; }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }

.checkboxes-container {
    display: none;
    position: absolute;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šä¸å†ä½¿ç”¨ topï¼Œè€Œæ˜¯ç”¨ margin-top æ¥åˆ›é€ é—´è·ï¼Œæ›´ç¨³å®š */
    top: 100%; 
    margin-top: 5px; /* <-- æ–°å¢ï¼šå‘ä¸‹æ¨å¼€5åƒç´ çš„è·ç¦» */
    left: 0;
    right: 0;
    max-height: 150px;
    overflow-y: auto;
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    z-index: 101;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }

.checkboxes-container label {
    display: block;
    padding: 12px 15px; /* <-- ä¿®æ”¹ï¼šå¢åŠ äº†ä¸Šä¸‹å’Œå·¦å³çš„å†…è¾¹è·ï¼Œè®©æ¯ä¸€è¡Œæ›´é«˜æ›´å®½ */
    cursor: pointer;
    font-weight: normal;
    color: var(--text-primary);
    font-size: 15px; /* <-- æ–°å¢ï¼šå°†å­—ä½“å¤§å°ä»é»˜è®¤å€¼æ”¾å¤§åˆ°15px */
}

        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .message-bubble.is-ai-image .content { padding: 5px; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
.voice-duration {
    /* --- æ ¸å¿ƒä¿®æ­£ --- */
    font-size: var(--chat-font-size, 13px);
    /* --- ä¿®æ­£ç»“æŸ --- */
    font-weight: 500;
    color: var(--text-secondary);
}
        .message-bubble.user .voice-duration { color: #3e6224; }

/* â–¼â–¼â–¼ ç”¨è¿™å—ä»£ç æ›¿æ¢æ‰ä½ åŸæ¥çš„ .message-bubble .content æ ·å¼ â–¼â–¼â–¼ */
/* é€šç”¨å†…å®¹åŒºæ ·å¼ï¼Œä¸ºæ—¶é—´æˆ³å’Œå­—ä½“å¤§å°åšå‡†å¤‡ */
.message-bubble .content {
    position: relative;
    font-size: var(--chat-font-size, 16px);
    padding: 8px 12px;
    line-height: 1.5;
    word-break: break-word; /* æ ¸å¿ƒä¿®æ­£: å¼ºåˆ¶é•¿å•è¯æˆ–URLæ¢è¡Œï¼Œé˜²æ­¢æ’‘ç ´æ°”æ³¡ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

        /* === æ°”æ³¡ä¸»é¢˜æ ·å¼ === */
        .message-bubble.user .content { background-color: rgba(255, 255, 255, 0.75); color: #585858; border-radius: 8px 2px 8px 8px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: #585858; border-radius: 2px 8px 8px 8px; }
      
.message-bubble::after {
    content: "";
    position: absolute;
    width: 20px;  
    height: 20px; 
    background-size: contain;
    background-repeat: no-repeat;
    opacity: 1; 
    z-index: 1;
}
      
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #fffde4; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }

        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .message-bubble.is-transfer .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; cursor: pointer; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: 'ğŸ¾'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
        .playlist-body { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }

        /* Persona Library Styles */
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }

/* === å¤´åƒæ¡†é€‰æ‹©æ¨¡æ€æ¡†æ ·å¼ (è¿™æ˜¯æ–°æ·»åŠ çš„) === */
.change-frame-btn {
    padding: 6px 10px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    margin-left: 10px;
}

#avatar-frame-modal .modal-content {
    height: 70%; /* è®©çª—å£é«˜ä¸€ç‚¹ */
}

#avatar-frame-modal .modal-body {
    padding: 0;
    display: flex;
    flex-direction: column;
}
      
.frame-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.frame-tab {
    flex: 1;
    padding: 12px;
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
}

.frame-tab.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

.frame-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
}

.frame-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); /* æ¯è¡Œè‡ªåŠ¨å¡«å……ï¼Œæœ€å°70pxå®½ */
    gap: 15px;
}

.frame-item {
    aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
    border: 2px solid transparent;
    border-radius: 10px;
    cursor: pointer;
    background-color: #f0f0f0;
    background-size: cover;
    background-position: center;
    padding: 5px;
    transition: all 0.2s ease;
    position: relative; /* ä¸ºé¢„è§ˆå›¾åšå‡†å¤‡ */
}

.frame-item.selected {
    border-color: var(--accent-color);
    transform: scale(1.05);
}

.frame-item .preview-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.frame-item .preview-frame {
    position: absolute;
    top: -7px;
    left: 0;
    width: 100%;
    height: 100%;
}

/* è¿™æ˜¯ä½ è¦æ·»åŠ çš„æ–°æ ·å¼ */
#font-preview {
    transition: font-family 0.3s ease;}

/* === èŠå¤©åˆ—è¡¨ç•Œé¢æ–°å¢æ ·å¼ (è¿™æ˜¯æ–°æ·»åŠ çš„) === */
#chat-list-screen {
}

.chat-list-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    z-index: 1; 
}
.chat-list-view.active {
    opacity: 1;
    visibility: visible;
    z-index: 2; 
}

#messages-view {
    overflow-y: auto; 
}

/* åº•éƒ¨å¯¼èˆªæ æ ·å¼ */
#chat-list-bottom-nav {
    position: absolute; /* è®©å®ƒå›ºå®šåœ¨åº•éƒ¨ */
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 15; /* ç¡®ä¿å®ƒåœ¨è§†å›¾ä¹‹ä¸Š */
    display: flex;
    border-top: 1px solid var(--border-color);
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.nav-item {
    flex: 1;
    text-align: center;
    padding: 12px 0;
    font-size: 14px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color 0.2s;
}

.nav-item.active {
    color: var(--accent-color);
    font-weight: 600;
}

/* === åŠ¨æ€ç•Œé¢ (QZone) æ ·å¼ (è¿™æ˜¯æ–°æ·»åŠ çš„) === */
#qzone-screen {
    background-color: #f0f2f5;
}

.qzone-header {
    /* position: absolute;  <-- æŠŠè¿™ä¸ªæ”¹æˆ relative */
    position: relative;
    z-index: 10; /* z-index ä¿æŒï¼Œæˆ–è€…å¯ä»¥æ›´é«˜ */
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    padding: 15px 20px;
    padding-top: 45px;
    background-color: rgba(247, 247, 247, 0.7); 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
}

.qzone-header .back-btn {
    font-size: 24px;
    cursor: pointer;
    color: var(--accent-color);
}

.qzone-header span:nth-child(2) { /* "å¥½å‹åŠ¨æ€"æ–‡å­— */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

.qzone-content {
    flex-grow: 1;
    overflow-y: auto;
    /* padding-top: 80px;  <-- åˆ é™¤è¿™ä¸ªï¼Œå› ä¸ºheaderä¸å†æ˜¯absoluteäº† */
}

.qzone-profile-header {
    position: relative;
    margin-bottom: 20px;
}

.qzone-banner-container {
    width: 100%;
    height: 180px; /* èƒŒæ™¯æ¿é«˜åº¦ */
    position: relative;
}

#qzone-banner-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.qzone-user-info {
    position: absolute;
    bottom: -30px; /* è®©å¤´åƒå’Œæ˜µç§°åŒºåŸŸå‘ä¸‹åç§»ï¼Œä¸€åŠåœ¨èƒŒæ™¯æ¿å†…ï¼Œä¸€åŠåœ¨å¤– */
    left: 20px;
    display: flex;
    align-items: flex-end; /* è®©æ˜µç§°å’Œå¤´åƒåº•éƒ¨å¯¹é½ */
    gap: 10px;
}

.qzone-avatar-container {
    position: relative;
}

#qzone-avatar-img {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    object-fit: cover;
}

#qzone-nickname {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    padding-bottom: 5px; /* å¾®è°ƒä½ç½® */
}

/* ç¼–è¾‘æŒ‰é’®çš„é€šç”¨æ ·å¼ */
.qzone-edit-btn {
    position: absolute;
    background-color: rgba(0,0,0,0.4);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

#change-qzone-banner-btn {
    bottom: 10px;
    right: 10px;
}

#change-qzone-avatar-btn {
    bottom: 5px;
    right: 5px;
}

#change-qzone-nickname-btn {
    font-size: 14px;
    padding: 2px 6px;
    margin-left: 5px; /* ä¸æ˜µç§°çš„é—´è· */
    color: var(--text-primary);
    background-color: rgba(255,255,255,0.7);
    border-radius: 5px;
    position: relative; /* è„±ç¦»flexå¸ƒå±€çš„å¯¹é½ */
    bottom: 5px; /* å¾®è°ƒå‚ç›´ä½ç½® */
}

/* === è®©ç¼–è¾‘åŠŸèƒ½æ›´â€œéšå½¢â€ === */
#qzone-banner-container,
#qzone-avatar-container,
#qzone-nickname {
    cursor: pointer; /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¸ºå¯ç‚¹å‡»æ‰‹åŠ¿ */
    transition: opacity 0.2s;
}
#qzone-banner-container:hover,
#qzone-avatar-container:hover,
#qzone-nickname:hover {
    opacity: 0.85; /* æ‚¬åœæ—¶ç¨å¾®å˜æš—ï¼Œç»™ç”¨æˆ·åé¦ˆ */
}
/* éšè—æ‰æ—§çš„ã€ç‹¬ç«‹çš„ç¼–è¾‘æŒ‰é’® */
.qzone-edit-btn {
    display: none;
}

/* === æ§åˆ¶ Header å’Œ Bottom Nav çš„æ˜¾éš === */
/* é»˜è®¤éšè—åŠ¨æ€ç•Œé¢çš„ Header */
#qzone-screen .qzone-header {
    display: none;
}
/* å½“åŠ¨æ€è§†å›¾æ¿€æ´»æ—¶ï¼Œæ˜¾ç¤ºå®ƒçš„Header */
#qzone-screen.active .qzone-header {
    display: flex;
}

/* å½“è¿›å…¥åŠ¨æ€è§†å›¾æ—¶ï¼Œéšè—ä¸»Headerå’Œåº•éƒ¨å¯¼èˆªæ  */
#chat-list-screen.in-qzone-view > .header,
#chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
    display: none;
}

.chat-list-item:first-child,
.chat-group-container:first-child {
    margin-top: 10px; 
}

/* â–²â–²â–² æ–°æ ·å¼æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠæ‰€æœ‰è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === åŠ¨æ€åŠŸèƒ½æ æ ·å¼ === */
.qzone-actions-bar {
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    margin: 40px 15px 15px 15px; /* ä¸Šè¾¹è·æ›´å¤§ï¼Œä¸ºæµ®åŠ¨çš„å¤´åƒç•™å‡ºç©ºé—´ */
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.action-item {
    flex: 1;
    text-align: center;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    padding: 8px 0;
    position: relative;
}

/* ç”¨ä¼ªå…ƒç´ åˆ›å»ºåˆ†éš”çº¿ */
.action-item:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 20px;
    background-color: var(--border-color);
}

/* === åŠ¨æ€å¸–å­åˆ—è¡¨æ ·å¼ === */
#qzone-posts-list {
    padding: 0 15px 20px 15px; /* å·¦å³å’Œåº•éƒ¨ç•™å‡ºè¾¹è· */
    display: flex;
    flex-direction: column;
    gap: 20px; /* å¸–å­ä¹‹é—´çš„é—´è· */
}

.qzone-post-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.post-header .post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.post-info {
    display: flex;
    flex-direction: column;
}

.post-info .post-nickname {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-primary);
}

.post-info .post-timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}

.post-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap; /* è®©æ¢è¡Œç¬¦ç”Ÿæ•ˆ */
    word-break: break-word; /* é˜²æ­¢é•¿å•è¯æº¢å‡º */
}

/* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æ–°æ ·å¼ç²˜è´´åˆ°æœ«å°¾ â–¼â–¼â–¼ */

/* === å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡†æ ·å¼ === */
#post-public-text {
    min-height: 80px; /* ç¡®ä¿æ–‡æœ¬åŸŸæœ‰è¶³å¤Ÿçš„é«˜åº¦ */
    resize: vertical;
}

.post-image-preview-container {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9; /* ä¿æŒ16:9çš„é¢„è§ˆæ¯”ä¾‹ */
    background-color: #f0f2f5;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    margin-bottom: 15px;
    display: none; /* é»˜è®¤éšè— */
    justify-content: center;
    align-items: center;
}
.post-image-preview-container.visible {
    display: flex; /* ä¸Šä¼ åæ˜¾ç¤º */
}

#post-image-preview {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 6px;
}

#post-remove-image-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #ff3b30;
    color: white;
    border: 2px solid white;
    font-size: 16px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

.post-image-upload-options {
    display: flex;
    gap: 10px;
}

.post-image-upload-options button {
    flex: 1;
    margin-top: 0;
}

/* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æ–°æ ·å¼ â–¼â–¼â–¼ */

/* === å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡† - æ¨¡å¼åˆ‡æ¢æ ·å¼ === */
.post-mode-switcher {
    display: flex;
    margin-bottom: 20px;
    background-color: #e9ecef;
    border-radius: 8px;
    padding: 4px;
}

.mode-btn {
    flex: 1;
    padding: 8px;
    border: none;
    background-color: transparent;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.mode-btn.active {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.post-mode-content {
    display: none; /* é»˜è®¤éƒ½éšè— */
}

.post-mode-content.active {
    display: block; /* æ¿€æ´»çš„æ‰æ˜¾ç¤º */
}

/* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ°æ ‡ç­¾çš„æœ«å°¾ â–¼â–¼â–¼ */

/* å¸–å­çš„çˆ¶å®¹å™¨ï¼Œè¿™æ˜¯å®ç°æ»‘åŠ¨çš„åŸºç¡€ */
.qzone-post-container {
    position: relative;
    overflow: hidden; /* å…³é”®ï¼šéšè—æ‰æ»‘å‡ºå±å¹•å¤–çš„åˆ é™¤æŒ‰é’® */
    border-radius: 12px; /* å’Œ post-item ä¿æŒä¸€è‡´ */
}

/* è®©å¸–å­æœ¬èº«å¯ä»¥è¢« JS æ§åˆ¶ç§»åŠ¨ */
.qzone-post-item {
    position: relative; /* ç¡®ä¿å®ƒåœ¨æœ€ä¸Šå±‚ */
    z-index: 2;
    transition: transform 0.3s ease; /* ç”¨äºâ€œå¼¹å›â€å’Œâ€œå¸é™„â€çš„åŠ¨ç”» */
    background-color: var(--secondary-bg); /* èƒŒæ™¯è‰²ç§»åˆ°è¿™é‡Œ */
}

/* éšè—åœ¨å¸–å­ä¸‹é¢çš„åˆ é™¤æŒ‰é’®åŒºåŸŸ */
.qzone-post-delete-action {
    position: absolute;
    top: 0;
    right: 0;
    width: 80px; /* åˆ é™¤æŒ‰é’®çš„å®½åº¦ */
    height: 100%;
    background-color: #ff3b30; /* çº¢è‰²èƒŒæ™¯ */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1; /* åœ¨å¸–å­ä¸‹é¢ */
    cursor: pointer;
}

.qzone-post-delete-action span {
    color: white;
    font-weight: 500;
}

/* å½“å¸–å­è¢«æ»‘å¼€æ—¶çš„æ ·å¼ */
.qzone-post-item.swiped {
    transform: translateX(-80px); /* å‘å·¦ç§»åŠ¨åˆ é™¤æŒ‰é’®çš„å®½åº¦ */
}

/* === ç›¸å†Œé¡µé¢èƒŒæ™¯è‰² === */
#album-screen {
    background-color: #f0f2f5; /* ä½¿ç”¨ä¸€ä¸ªæŸ”å’Œçš„æµ…ç°è‰²ï¼Œæ¯”çº¯ç™½æ›´æŠ¤çœ¼ */
}

/* === ç›¸å†Œé¡µé¢ç½‘æ ¼å¸ƒå±€ === */
#album-grid-page {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* æ¯è¡Œæ˜¾ç¤º2ä¸ªç›¸å†Œ */
    gap: 15px;
}

/* === ç›¸å†Œé¡¹ç›®æ ·å¼ (ç¾åŒ–) === */
.album-item {
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 8px; /* ç»™æ•´ä¸ªé¡¹ç›®ä¹ŸåŠ ä¸ªåœ†è§’ */
}

.album-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.album-cover {
    aspect-ratio: 1 / 1; /* ä¿æŒå°é¢ä¸ºæ­£æ–¹å½¢ */
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    margin-bottom: 8px;
    background-color: #f0f2f5; /* å°é¢åŠ è½½å‰çš„å ä½é¢œè‰² */
}

.album-info {
    text-align: center;
}

.album-name {
    font-weight: 500;
    margin: 0 0 4px 0;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* é˜²æ­¢é•¿åå­—æ¢è¡Œ */
}

.album-count {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0;
}

/* â–²â–²â–² æ–°çš„ CSS ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ç›¸å†Œç…§ç‰‡è¯¦æƒ…é¡µ === */
#album-photos-screen {
    background-color: #f0f2f5;
}

#photos-grid-page {
    padding: 15px;
    display: grid;
    /* æ¯è¡Œæ˜¾ç¤º3å¼ ç…§ç‰‡ï¼Œå¹¶ä¿æŒé—´è· */
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.photo-item {
    position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
    aspect-ratio: 1 / 1; /* ä¿æŒç…§ç‰‡ä¸ºæ­£æ–¹å½¢ */
    border-radius: 6px;
    overflow: hidden; /* é˜²æ­¢å›¾ç‰‡æº¢å‡ºåœ†è§’ */
    background-color: #e9ecef; /* å›¾ç‰‡åŠ è½½å‰çš„å ä½ç¬¦é¢œè‰² */
}

.photo-item .photo-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ä¿è¯å›¾ç‰‡å¡«æ»¡å®¹å™¨ä¸”ä¸å˜å½¢ */
    cursor: pointer;
}

/* åˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.photo-item .photo-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.2s ease;
}

/* é¼ æ ‡æ‚¬åœåœ¨ç…§ç‰‡ä¸Šæ—¶æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.photo-item:hover .photo-delete-btn {
    opacity: 1;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* === å›¾ç‰‡æŸ¥çœ‹å™¨æ¨¡æ€æ¡†æ ·å¼ === */
#photo-viewer-modal {
    background-color: rgba(0, 0, 0, 0.85);
    z-index: 1002;
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
}

.photo-viewer-content {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
}

#photo-viewer-image {
    max-width: 90vw;  /* å›¾ç‰‡æœ€å¤§å®½åº¦ä¸ºè§†å£çš„90% */
    max-height: 85vh; /* å›¾ç‰‡æœ€å¤§é«˜åº¦ä¸ºè§†å£çš„85% */
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    /* ä¸ºå›¾ç‰‡çš„åˆ‡æ¢æ·»åŠ ä¸€ç‚¹å¹³æ»‘çš„æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
    transition: opacity 0.2s ease-in-out;
}

/* å…³é—­æŒ‰é’® */
#photo-viewer-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 40px;
    font-weight: 200;
    cursor: pointer;
    line-height: 1;
    text-shadow: 0 0 5px black;
}

/* å·¦å³å¯¼èˆªç®­å¤´ */
#photo-viewer-modal .nav-arrow {
    position: absolute; /* ç°åœ¨æˆ‘ä»¬ç”¨ç»å¯¹å®šä½æ¥æ§åˆ¶ç®­å¤´ */
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 50px; /* åœ¨æ‰‹æœºå±å¹•ä¸Šï¼Œå¯ä»¥ç¨å¾®å°ä¸€ç‚¹ */
    font-weight: 100;
    cursor: pointer;
    padding: 10px; /* è°ƒæ•´å†…è¾¹è· */
    user-select: none;
    transition: color 0.2s;
    z-index: 1003; /* ç¡®ä¿ç®­å¤´åœ¨æœ€ä¸Šå±‚ */
}

#photo-viewer-prev-btn {
    left: 5px; /* å®šä½å·¦ç®­å¤´ */
}

#photo-viewer-next-btn {
    right: 5px; /* å®šä½å³ç®­å¤´ */
}

#photo-viewer-modal .nav-arrow:hover {
    color: white;
}

/* å½“ç®­å¤´è¢«ç¦ç”¨æ—¶ï¼ˆæ¯”å¦‚ç¬¬ä¸€å¼ æˆ–æœ€åä¸€å¼ ï¼‰ */
#photo-viewer-modal .nav-arrow:disabled {
    color: rgba(255, 255, 255, 0.2);
    cursor: default;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—æ–°CSSæ›¿æ¢æ‰ä¸Šä¸€ç‰ˆçš„äº¤äº’åŒºCSS â–¼â–¼â–¼ */

/* === å¸–å­å†…å®¹åŒº - ç›¸å¯¹å®šä½å®¹å™¨ === */
/* === å¸–å­å†…å®¹åŒº === */
.post-main-content {
    /* å®ƒç°åœ¨åªæ˜¯ä¸€ä¸ªæ™®é€šçš„å†…å®¹å®¹å™¨ï¼Œä¸å†éœ€è¦ç‰¹æ®Šæ ·å¼äº† */
}

/* === å¸–å­äº’åŠ¨å›¾æ ‡åŒº (æ–°æ ·å¼) === */
.post-feedback-icons {
    display: flex;
    justify-content: flex-end; /* è®©å›¾æ ‡é å³å¯¹é½ */
    align-items: center;
    gap: 12px;
    padding: 8px 0; /* æ ¸å¿ƒä¿®æ”¹ï¼šç»™å›¾æ ‡åŒºåŸŸä¸Šä¸‹å„8pxçš„ç•™ç™½ */
}

.action-icon {
    cursor: pointer;
    color: var(--text-secondary); /* é»˜è®¤ç°è‰² */
    transition: all 0.2s ease-in-out;
}

.action-icon svg {
    width: 22px;
    height: 22px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
}

/* å›¾æ ‡æ¿€æ´»(ç‚¹èµ/æ”¶è—å)çš„æ ·å¼ */
.action-icon.active {
    color: #ff5252; /* æ¿€æ´»åå˜çº¢è‰² */
    transform: scale(1.1); /* è½»å¾®æ”¾å¤§ */
}

.action-icon.active.favorite {
    color: #ffc107; /* æ”¶è—ç”¨é»„è‰² */
}

.action-icon.active svg {
    fill: currentColor; /* æ¿€æ´»åå¡«å……é¢œè‰² */
}

/* ç‚¹å‡»æ—¶çš„åŠ¨ç”»æ•ˆæœ */
.animate-like {
    animation: like-bounce 0.4s ease-in-out;
}

@keyframes like-bounce {
    0%   { transform: scale(1); }
    25%  { transform: scale(0.8); }
    50%  { transform: scale(1.2); }
    75%  { transform: scale(1.05); }
    100% { transform: scale(1.1); }
}


/* === å¸–å­åº•éƒ¨è¯„è®ºåŒºæ ·å¼ (ç°åœ¨æ˜¯ç‹¬ç«‹éƒ¨åˆ†) === */
.post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0; /* ç”¨ä¸€æ¡æµ…è‰²çº¿åˆ†éš” */
    display: flex;
    align-items: center;
    gap: 8px; /* è°ƒæ•´æ•´ä½“é—´è· */
}

/* è¯„è®ºåŒºå®¹å™¨ */
.comment-section {
    flex-grow: 1; /* å æ®å¤§éƒ¨åˆ†ç©ºé—´ */
    display: flex;
    align-items: center;
    gap: 8px;
}

.comment-section .comment-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.comment-section .comment-input {
    width: 100%;
    padding: 8px 12px;
    border: none;
    background-color: #f0f2f5;
    border-radius: 14px;
    font-size: 13px;
    outline: none;
}

/* æ–°å¢çš„å‘é€æŒ‰é’®æ ·å¼ */
.comment-send-btn {
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    padding: 8px 15px;
    border: none;
    background-color: var(--accent-color);
    color: white;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœªè¯»æ¶ˆæ¯å°çº¢ç‚¹é€šç”¨æ ·å¼ === */
.unread-indicator {
    position: absolute;
    top: -8px;      
    right: -15px;    
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background-color: #ff3b30;
    color: white;
    font-size: 11px;
    font-weight: bold;
    line-height: 18px;
    text-align: center;
    border-radius: 9px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    display: none;
    z-index: 1;
}

/* èŠå¤©ç•Œé¢è¿”å›æŒ‰é’®ä¸Šçš„å°çº¢ç‚¹ (åªæ˜¾ç¤ºç‚¹ï¼Œä¸æ˜¾ç¤ºæ•°å­—) */
.back-btn-indicator {
    top: 0;
    right: -8px; /* æ”¾åˆ°è¿”å›ç®­å¤´å³ä¸Šè§’ */
    width: 10px;
    height: 10px;
    min-width: 10px;
    padding: 0;
    border-radius: 50%;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === è¯„è®ºåˆ—è¡¨å®¹å™¨ === */
.post-comments-container {
    padding: 10px 0; /* ä¸Šä¸‹ç•™ç™½ */
    display: flex;
    flex-direction: column;
    gap: 8px; /* è¯„è®ºä¹‹é—´çš„é—´è· */
    font-size: 13px; /* ç»Ÿä¸€è¯„è®ºåŒºå­—ä½“å¤§å° */
}

/* æ¯ä¸€æ¡è¯„è®º */
.comment-item {
    line-height: 1.5;
}

/* è¯„è®ºè€…çš„åå­—ï¼ŒåŠ ç²—å¹¶ä½¿ç”¨ä¸»é¢˜è‰² */
.comment-item .commenter-name {
    font-weight: 600;
    color: var(--accent-color);
    cursor: pointer;
    margin-right: 5px; /* å’Œè¯„è®ºå†…å®¹ä¹‹é—´ç•™ç‚¹ç©ºéš™ */
}

/* è¯„è®ºå†…å®¹ */
.comment-item .comment-text {
    color: var(--text-primary);
    word-break: break-word;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === å¸–å­ç‚¹èµåŒºåŸŸæ ·å¼ === */
.post-likes-section {
    display: flex;
    align-items: center;
    gap: 6px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    padding: 8px 10px; /* å†…è¾¹è· */
    font-size: 13px;
    color: var(--accent-color); /* ä½¿ç”¨ä¸»é¢˜è“è‰² */
    background-color: #f0f5fa; /* ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
    border-top: 1px solid #e9eef3;
    border-bottom: 1px solid #e9eef3;
    margin-top: 5px; /* å’Œä¸Šæ–¹çš„å›¾æ ‡ä¿æŒä¸€ç‚¹è·ç¦» */
}

.post-likes-section .like-icon {
    width: 16px;
    height: 16px;
    fill: currentColor; /* è®©SVGå›¾æ ‡ç»§æ‰¿çˆ¶å…ƒç´ çš„é¢œè‰² */
    flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === @æåŠ å¼¹å‡ºèœå•æ ·å¼ === */
.at-mention-popup {
    position: absolute; /* ç›¸å¯¹äºçˆ¶å…ƒç´ å®šä½ */
    bottom: 100%; /* æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†çš„ä¸Šæ–¹ */
    left: 40px; /* å’Œè¾“å…¥æ¡†å·¦ä¾§å¯¹é½ (è€ƒè™‘äº†å¤´åƒå®½åº¦) */
    width: calc(100% - 40px); /* å®½åº¦å’Œè¾“å…¥æ¡†å·®ä¸å¤š */
    max-height: 120px;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 10;
    display: none; /* é»˜è®¤éšè— */
}

.at-mention-item {
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-primary);
    border-bottom: 1px solid #f0f0f0;
}

.at-mention-item:last-child {
    border-bottom: none;
}

.at-mention-item:hover {
    background-color: #f5f5f5;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™æ®µã€æ–°æ ·å¼ã€‘æ›¿æ¢æ‰ä½ ç°æœ‰çš„ #favorites-list æ ·å¼ â–¼â–¼â–¼ */

/* è®©æ”¶è—è§†å›¾æˆä¸ºä¸€ä¸ªflexå®¹å™¨, ä»ä¸Šåˆ°ä¸‹æ’åˆ— */
#favorites-view {
    display: flex;
    flex-direction: column;
}

/* ç¡®ä¿æ”¶è—é¡µçš„headeré«˜åº¦å›ºå®šï¼Œä¸è¢«å‹ç¼© */
#favorites-view > .header {
    flex-shrink: 0;
}

/* === æ”¶è—åˆ—è¡¨æ ·å¼ (ä¿®æ­£å) === */
#favorites-list {
    flex-grow: 1; 
    overflow-y: auto; 
    overflow-x: hidden; /* <-- æ–°å¢è¿™è¡Œï¼Œç¦æ­¢æ°´å¹³æ»šåŠ¨ */
    padding: 15px; 
    display: flex;
    flex-direction: column;
    gap: 15px; 
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

.favorite-item-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
}

/* å¡ç‰‡å¤´éƒ¨ï¼ŒåŒ…å«å¤´åƒã€åå­—å’Œæ¥æº */
.fav-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.fav-card-header .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.fav-card-header .info {
    flex-grow: 1;
}

.fav-card-header .name {
    font-weight: 600;
    font-size: 15px;
}

.fav-card-header .source {
    font-size: 12px;
    color: var(--text-secondary);
}

/* å¡ç‰‡å†…å®¹ */
.fav-card-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
}

.fav-card-content .chat-image {
    margin-top: 8px; /* å›¾ç‰‡å’Œæ–‡å­—çš„é—´è· */
}

/* åˆ é™¤æŒ‰é’® */
.fav-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    background: #f0f2f5;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-secondary);
    line-height: 28px;
    text-align: center;
}

.fav-delete-btn:hover {
    background-color: #e9ecef;
    color: #ff3b30;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœç´¢æ æ ·å¼ === */
.search-bar-container {
    padding: 10px 15px;
    background-color: #f9f9f9; /* å’Œåˆ—è¡¨èƒŒæ™¯è‰²ä¿æŒä¸€è‡´ */
    position: relative; /* ä¸ºäº†å®šä½æ¸…é™¤æŒ‰é’® */
    flex-shrink: 0;
}

#favorites-search-input {
    width: 100%;
    padding: 10px 30px 10px 15px; /* å³ä¾§ç•™å‡ºæ¸…é™¤æŒ‰é’®çš„ä½ç½® */
    font-size: 14px;
    border: 1px solid var(--border-color);
    border-radius: 18px; /* åœ†è§’çŸ©å½¢ï¼Œæ›´ç°ä»£åŒ– */
    background-color: var(--secondary-bg);
    box-sizing: border-box;
    outline: none;
}
#favorites-search-input:focus {
    border-color: var(--accent-color);
}

.search-clear-btn {
    position: absolute;
    right: 25px;
    top: 50%;
    transform: translateY(-50%);
    background: #ccc;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    font-size: 16px;
    cursor: pointer;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* === èŠå¤©ç•Œé¢å¤šé€‰æ“ä½œæ ä¼˜åŒ– === */
#chat-interface-screen .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

#chat-interface-screen .selection-controls .action-btn {
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    padding: 5px;
}

/* === æ”¶è—é¡µé¢å¤šé€‰æ¨¡å¼æ ·å¼ === */
#favorites-view.selection-mode .favorite-item-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* é€‰æ‹©æ¡†çš„æ ·å¼ */
.favorite-item-card::before {
    content: '';
    position: absolute;
    left: -25px; /* æŠŠå®ƒæ”¾åœ¨å¡ç‰‡å·¦è¾¹å¤–é¢ */
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    background-color: white;
    transition: all 0.2s ease;
    opacity: 0; /* é»˜è®¤éšè— */
}

/* è¿›å…¥é€‰æ‹©æ¨¡å¼æ—¶ï¼Œå¡ç‰‡å‘å³ç§»åŠ¨ï¼Œéœ²å‡ºé€‰æ‹©æ¡† */
#favorites-view.selection-mode .favorite-item-card {
    transform: translateX(35px);
}
#favorites-view.selection-mode .favorite-item-card::before {
    opacity: 1;
}

/* é€‰ä¸­åçš„æ ·å¼ */
#favorites-view.selection-mode .favorite-item-card.selected::before {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}

/* åº•éƒ¨æ“ä½œæ  (ç»ˆæä¿®æ­£ç‰ˆ) */
#favorites-action-bar {
    position: absolute; /* â˜… æ”¹ä¸º absoluteï¼Œç›¸å¯¹äº #phone-screen å®šä½ */
    bottom: 0;
    left: 0;
    right: 0;           /* â˜… æ–°å¢ right: 0ï¼Œå’Œ left: 0 ä¸€èµ·æ’‘æ»¡å®½åº¦ */
    width: auto;        /* â˜… æ”¹ä¸º autoï¼Œè®© left/right å†³å®šå®½åº¦ */
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* é€‚é…iPhoneåº•éƒ¨å®‰å…¨åŒº */
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    box-sizing: border-box;
    z-index: 5;
    display: none;
    /* max-width å·²ç»ä¸éœ€è¦äº†ï¼Œå› ä¸ºçˆ¶å…ƒç´ å·²ç»é™åˆ¶äº†å®½åº¦ */
}

#favorites-action-bar .action-bar-btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    background-color: #ff3b30;
    color: white;
}

/* === ã€ä¿®æ­£ã€‘èŠå¤©ç•Œé¢å¤´éƒ¨æ§ä»¶åˆ‡æ¢é€»è¾‘ === */

/* é»˜è®¤çŠ¶æ€ï¼šéšè—å¤šé€‰æ§ä»¶ */
#chat-interface-screen .header .selection-controls {
    display: none;
}

/* é»˜è®¤çŠ¶æ€ï¼šæ˜¾ç¤ºé»˜è®¤æ§ä»¶ï¼Œå¹¶è®©å®ƒæ’‘æ»¡æ•´ä¸ªå¤´éƒ¨ */
#chat-interface-screen .header .default-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/* å½“è¿›å…¥å¤šé€‰æ¨¡å¼æ—¶ï¼šéšè—é»˜è®¤æ§ä»¶ */
#chat-interface-screen.selection-mode .header .default-controls {
    display: none;
}

/* å½“è¿›å…¥å¤šé€‰æ¨¡å¼æ—¶ï¼šæ˜¾ç¤ºå¤šé€‰æ§ä»¶ï¼Œå¹¶è®©å®ƒæ’‘æ»¡æ•´ä¸ªå¤´éƒ¨ */
#chat-interface-screen.selection-mode .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ä¿®æ­£ï¼šæ”¾å¤§æ‰€æœ‰ä¸»è¦çš„â€œ+â€å·æŒ‰é’® === */
#add-chat-btn,
#add-world-book-btn,
#create-album-btn-page {
    font-size: 28px;   /* æ˜¾è‘—å¢å¤§å­—ä½“å¤§å°ï¼Œä½¿å…¶è§†è§‰ä¸Šä¸æ—è¾¹çš„å›¾æ ‡åŒ¹é… */
    font-weight: 300;  /* ä½¿ç”¨æ›´ç»†çš„å­—é‡ï¼Œè®©åŠ å·çœ‹èµ·æ¥æ›´æ¸…çˆ½ï¼Œä¸æ˜¾ç²—ç¬¨ */
    position: relative;/* å…è®¸è¿›è¡Œä½ç½®å¾®è°ƒ */
    top: -1px;         /* å­—ä½“æ”¾å¤§åï¼Œé€šå¸¸éœ€è¦ç¨å¾®å‘ä¸Šç§»åŠ¨ä¸€ç‚¹ï¼Œä½¿å…¶è§†è§‰ä¸Šæ›´å±…ä¸­ */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* é¢„è§ˆåŒºå®¹å™¨æ ·å¼ */
#settings-preview-area {
    width: 100%;
    height: 180px; /* ç»™ä¸€ä¸ªå›ºå®šçš„é«˜åº¦ */
    background-color: #f0f2f5;
    border-radius: 8px;
    padding: 15px;
    box-sizing: border-box;
    overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
    display: flex;
    flex-direction: column;
    gap: 10px; /* é¢„è§ˆæ°”æ³¡ä¹‹é—´çš„é—´è· */
    border: 1px solid var(--border-color);
    position: relative; /* ä¸ºäº†å®šä½èƒŒæ™¯ */
}

/* é¢„è§ˆåŒºçš„èƒŒæ™¯ï¼Œå¯ä»¥å’ŒçœŸå®èŠå¤©ç•Œé¢åŒæ­¥ */
#settings-preview-area::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    z-index: 1;
    opacity: 0.8;
}

/* è®©é¢„è§ˆæ°”æ³¡åœ¨èƒŒæ™¯ä¹‹ä¸Š */
#settings-preview-area .message-wrapper {
    position: relative;
    z-index: 2;
}

/* é¢„è§ˆåŒºå†…ä½¿ç”¨çš„å¤´åƒè¦å°ä¸€ç‚¹ */
#settings-preview-area .message-bubble .avatar {
    width: 30px;
    height: 30px;
}
#settings-preview-area .avatar-with-frame {
     width: 30px;
    height: 30px;
}
#settings-preview-area .avatar-with-frame .avatar-frame {
    width: 44px;
    height: 44px;
    top: -7px;
    left: -7px;
}
#settings-preview-area .message-bubble .timestamp {
    display: none; /* é¢„è§ˆåŒºä¸éœ€è¦æ˜¾ç¤ºæ—¶é—´æˆ³ */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.existing-group-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.existing-group-item .group-name {
    font-weight: 500;
}

.existing-group-item .delete-group-btn {
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.chat-group-container {
    border-bottom: 1px solid var(--border-color);
}
.chat-group-container:first-child {
    border-top: 1px solid var(--border-color);
}

.chat-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: #f7f7f7;
}

.chat-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

.chat-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}

.chat-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}

.chat-group-content {
    max-height: 1000px; /* ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å€¼ */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

.chat-group-content.collapsed {
    max-height: 0;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* æ ¼å¼åŠ©æ‰‹æŒ‰é’®çš„å®¹å™¨ */
.format-helpers {
    display: flex;
    gap: 10px;
    margin-bottom: 15px; /* ä¸ä¸‹æ–¹çš„æ–‡æœ¬æ¡†æ‹‰å¼€è·ç¦» */
    flex-wrap: wrap; /* å¦‚æœæŒ‰é’®å¤ªå¤šå¯ä»¥æ¢è¡Œ */
}

/* å•ä¸ªæ ¼å¼åŠ©æ‰‹æŒ‰é’®çš„æ ·å¼ */
.format-btn {
    background-color: #e9ecef;
    color: var(--text-primary);
    border: none;
    padding: 6px 12px;
    border-radius: 16px; /* èƒ¶å›Šå½¢çŠ¶ï¼Œæ›´å‹å¥½ */
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.format-btn:hover {
    background-color: #dcdfe3;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â€œâ€¦â€æŒ‰é’®çš„æ ·å¼ */
.post-actions-btn {
    margin-left: auto; /* å…³é”®ï¼šè®©å®ƒè‡ªåŠ¨é åˆ°æœ€å³è¾¹ */
    padding: 5px 10px;
    font-size: 20px;
    font-weight: bold;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 50%;
    line-height: 1;
}
.post-actions-btn:hover {
    background-color: #f0f0f0;
}

/* åŠ¨æ€ç¼–è¾‘æ¨¡æ€æ¡†çš„æ ·å¼ (å®ƒå°†å¤ç”¨ç°æœ‰çš„æ“ä½œèœå•æ ·å¼) */
#post-actions-modal .custom-modal-footer button {
    width: 100%;
    border: none;
    border-bottom: 1px solid #dbdbdb;
    padding: 14px;
    font-size: 18px;
}
#post-actions-modal .custom-modal-footer button:last-child {
    border-bottom: none;
}
#post-actions-modal #cancel-post-action-btn {
    margin-top: 8px;
    border-radius: 8px;
    background-color: #f0f0f0;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* ç»Ÿä¸€é‡ç½®è½¬è´¦å¡ç‰‡å†…æ‰€æœ‰æ–‡å­—çš„ç‰¹æ•ˆå’Œé¢œè‰² */
#chat-messages .transfer-card .transfer-title,
#chat-messages .transfer-card .transfer-amount,
#chat-messages .transfer-card .transfer-note {
    text-shadow: none !important; /* å¼ºåˆ¶ç§»é™¤ä»»ä½•å‘å…‰æˆ–é˜´å½±æ•ˆæœ */
    color: white !important;      /* å¼ºåˆ¶é”å®šæ–‡å­—é¢œè‰²ä¸ºç™½è‰² */
}

/* åˆ†åˆ«é”å®šå„è‡ªçš„å­—ä½“å¤§å°å’Œå­—é‡ï¼Œé˜²æ­¢è¢«ç¯¡æ”¹ */
#chat-messages .transfer-card .transfer-title {
    font-size: 16px !important;
    font-weight: 600 !important;
}

#chat-messages .transfer-card .transfer-amount {
    font-size: 28px !important;
    font-weight: bold !important;
}

#chat-messages .transfer-card .transfer-note {
    font-size: 13px !important;
    opacity: 0.9 !important;
}

/* â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„è‡ªé€‚åº”ä»£ç ï¼Œæ›¿æ¢æ‰æ‰€æœ‰æ—§çš„å¤´åƒç›¸å…³æ ·å¼ â–¼â–¼â–¼ */

/* 1. å¤´åƒå®¹å™¨çš„ã€é»˜è®¤/æ— æ¡†ã€‘çŠ¶æ€ */
.avatar-group {
    width: 34px;      /* é»˜è®¤å®½åº¦ï¼Œå’Œå¤´åƒå›¾ç‰‡ä¸€æ ·å®½ */
    flex-shrink: 0;
    position: relative;
    transition: width 0.2s ease; /* æ·»åŠ ä¸€ä¸ªå¹³æ»‘çš„å®½åº¦å˜åŒ–åŠ¨ç”» */
}

/* 2. å½“ã€æœ‰æ¡†ã€‘æ—¶ï¼Œå¤´åƒå®¹å™¨è‡ªåŠ¨å˜å®½ */
.avatar-group.has-frame {
    width: 42px; /* å˜å¾—æ›´å®½ï¼Œä¸ºæ›´å¤§çš„å¤´åƒå›¾ç‰‡å’Œæ¡†ç•™å‡ºç©ºé—´ */
}

/* 3. æ™®é€šå¤´åƒï¼ˆæ— æ¡†æ—¶ï¼‰çš„æ ·å¼ */
.message-bubble .avatar {
    width: 34px;
    height: 34px;
    border-radius: 20%;
    object-fit: cover;
}

/* 4. å¸¦æ¡†å¤´åƒçš„å®¹å™¨ã€é»˜è®¤ã€‘å¤§å° */
.avatar-with-frame {
    position: relative;
    width: 34px; /* é»˜è®¤å’Œæ™®é€šå¤´åƒä¸€æ ·å¤§ */
    height: 34px;
    margin: 0 auto;
    transition: all 0.2s ease; /* ä¸ºå¤§å°å˜åŒ–æ·»åŠ åŠ¨ç”» */
}

/* 5. å½“ã€æœ‰æ¡†ã€‘æ—¶ï¼Œå¸¦æ¡†å¤´åƒçš„å®¹å™¨è‡ªåŠ¨ã€å˜å¤§ã€‘ï¼Œè§£å†³æ‚¨è¯´çš„â€œå›¾å°æ¡†å¤§â€é—®é¢˜ï¼ */
.avatar-group.has-frame .avatar-with-frame {
    width: 42px; /* å›¾ç‰‡å®¹å™¨å˜å¤§ */
    height: 42px;
}

/* 6. å¤´åƒå›¾ç‰‡æœ¬èº«ï¼Œæ°¸è¿œæ’‘æ»¡å®ƒçš„å®¹å™¨ */
.avatar-with-frame .avatar-img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    z-index: 1;
}

/* 7. å¤´åƒæ¡†ï¼Œæ°¸è¿œåŸºäºå®ƒçš„çˆ¶å®¹å™¨å±…ä¸­ */
.avatar-with-frame .avatar-frame {
    position: absolute;
    width: 52px;
    height: 52px;
    top: -9px;   
    left: -4px;  
    z-index: 2;
    pointer-events: none;
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¿™æ˜¯æ–°å¢çš„æ ·å¼ï¼Œç”¨äºä¿®æ­£æ‰€æœ‰å¤´éƒ¨æ ‡é¢˜çš„å±…ä¸­é—®é¢˜ â–¼â–¼â–¼ */
.header > span:nth-child(2),
#chat-header-title {
    position: absolute;
    left: 50%;
    transform: translateX(calc(-50% - 2px)); /* åœ¨-50%çš„åŸºç¡€ä¸Šï¼Œå†å‘å·¦æ¨2åƒç´  */
    
    /* (å¯é€‰ä½†æ¨è) é˜²æ­¢é•¿æ ‡é¢˜ä¸ä¸¤è¾¹æŒ‰é’®é‡å  */
    max-width: 60%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */

    </style>
</head>
<body>
    <div id="phone-frame">
        <div class="notch"></div>
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">12:00</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">--%</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>
            
            <div id="home-screen" class="screen active">
                <div id="clock-container"><div id="main-time">12:00</div><div id="main-date">æ˜ŸæœŸä¸€, 1æœˆ1æ—¥</div></div>
                                                <div id="app-grid">
                    <!-- ç¬¬ä¸€è¡Œï¼šæ”¾2ä¸ªå›¾æ ‡ -->
                    <div class="app-row">
                        <div class="app-icon" onclick="showScreen('world-book-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/mZ0vV6tT/IMG-6907.jpg" alt="ä¸–ç•Œä¹¦"></div><span class="label">ä¸–ç•Œä¹¦</span></div>
                        <div class="app-icon" onclick="showScreen('chat-list-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/gJ7Dz5fj/IMG-6906.jpg" alt="QQ"></div><span class="label">QQ</span></div>
                    </div>
                    <!-- ç¬¬äºŒè¡Œï¼šæ”¾3ä¸ªå›¾æ ‡ -->
                    <div class="app-row">
                        <div class="app-icon" onclick="showScreen('api-settings-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/RhnTNdBR/IMG-6908.jpg" alt="APIè®¾ç½®"></div><span class="label">APIè®¾ç½®</span></div>
                        <div class="app-icon" onclick="showScreen('wallpaper-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/WbgQy6kg/IMG-6909.jpg" alt="å£çº¸"></div><span class="label">å£çº¸</span></div>
                        <div class="app-icon" onclick="showScreen('font-settings-screen')">
                            <div class="icon-bg"><img src="https://files.catbox.moe/j1kn1a.jpeg" alt="å­—ä½“"></div>
                            <span class="label">å­—ä½“</span>
                        </div>
                    </div>                     </div>
            </div>


          
            <div id="world-book-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span>ä¸–ç•Œä¹¦</span><span class="action-btn" id="add-world-book-btn">+</span></div><div id="world-book-list"></div></div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">â€¹</span>
                    <span id="world-book-editor-title">ç¼–è¾‘ä¸–ç•Œä¹¦</span>
                    <span class="save-btn" id="save-world-book-btn">ä¿å­˜</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">ä¹¦å</label>
                        <input type="text" id="world-book-name-input" placeholder="è¯·è¾“å…¥ä¸–ç•Œä¹¦çš„åç§°...">
                    </div>
                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">å†…å®¹</label>
                        <textarea id="world-book-content-input" placeholder="åœ¨æ­¤å¤„è¾“å…¥è¯¦ç»†çš„ä¸–ç•Œè§‚è®¾å®š..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span>API è®¾ç½®</span><span style="width: 30px;"></span></div><div class="form-container"><p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">æç¤º: è‹¥è¦ä½¿ç”¨â€œå‘é€å›¾ç‰‡â€åŠŸèƒ½, è¯·åŠ¡å¿…é€‰æ‹©æ”¯æŒVision(è§†è§‰)çš„æ¨¡å‹, å¦‚<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>æˆ–<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>ã€‚</p><div class="form-group"><label for="proxy-url">åä»£åœ°å€ (ä¸éœ€è¦æ·»åŠ /v1å™¢~)</label><input type="text" id="proxy-url" placeholder="ä¾‹å¦‚: https://api.openai.com"></div><div class="form-group"><label for="api-key">å¯†é’¥ (API Key)</label><input type="password" id="api-key" placeholder="sk-..."></div><div class="form-group"><label for="model-select">æ¨¡å‹</label><select id="model-select"></select></div><button class="form-button" id="fetch-models-btn">æ‹‰å–æ¨¡å‹</button>

<!-- â–¼â–¼â–¼ å°†è¿™æ®µä»£ç ç²˜è´´åˆ° API è®¾ç½®é¡µé¢çš„â€œä¿å­˜è®¾ç½®â€æŒ‰é’®ä¸Šæ–¹ â–¼â–¼â–¼ -->
<hr style="margin:20px 0; opacity:.3">
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="background-activity-switch" style="margin-bottom: 0;">
        å¯ç”¨åå°è§’è‰²æ´»åŠ¨
        <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
            è­¦å‘Šï¼šæ­¤åŠŸèƒ½ä¼šæ˜¾è‘—å¢åŠ APIè°ƒç”¨å’Œè´¹ç”¨ï¼
        </p>
    </label>
    <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ å°†è¿™æ®µä»£ç ç²˜è´´åˆ°â€œå¯ç”¨åå°è§’è‰²æ´»åŠ¨â€å¼€å…³çš„ä¸‹æ–¹ â–¼â–¼â–¼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="background-interval-input" style="margin-bottom: 0;">
        åå°æ´»åŠ¨æ£€æµ‹é—´éš” (ç§’)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            å»ºè®®å€¼ 60-300ã€‚å€¼è¶Šå¤§ï¼Œè´¹ç”¨è¶Šä½ï¼Œä½†è§’è‰²ååº”è¶Šæ…¢ã€‚
        </p>
    </label>
    <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->

<button class="form-button" id="save-api-settings-btn">ä¿å­˜è®¾ç½®</button>
			<hr style="margin:20px 0; opacity:.3">

			<button class="form-button" id="export-data-btn">å¯¼å‡ºæ•°æ®</button>

<!-- â‘  æ™®é€šæŒ‰é’®ï¼Œå’Œâ€œå¯¼å‡ºâ€ä¸€ä¸ª class -->
<button class="form-button" id="import-btn">å¯¼å…¥å¤‡ä»½æ–‡ä»¶</button>

<!-- â‘¡ çœŸæ­£çš„æ–‡ä»¶é€‰æ‹©å™¨ï¼Œå®Œå…¨éšè— -->
<input id="import-data-input" type="file" accept="application/json" hidden>
</div></div>
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ åŸæ¥çš„ chat-list-screen â–¼â–¼â–¼ -->
<div id="chat-list-screen" class="screen">
    
    <!-- ä¸»å¤´éƒ¨ (åªåœ¨æ¶ˆæ¯åˆ—è¡¨æ˜¾ç¤º) -->
    <div class="header" id="main-chat-list-header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>æ¶ˆæ¯</span>
        <div class="header-actions">
            <span class="action-btn" id="add-group-chat-btn" title="åˆ›å»ºç¾¤èŠ"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <span class="action-btn" id="add-chat-btn">+</span>
        </div>
    </div>

    <!-- æ¶ˆæ¯åˆ—è¡¨è§†å›¾ -->
    <div id="messages-view" class="chat-list-view active">
        <div id="chat-list">
            <!-- JSä¼šåœ¨è¿™é‡Œç”ŸæˆèŠå¤©åˆ—è¡¨ -->
        </div>
    </div>

    <!-- åŠ¨æ€ç•Œé¢è§†å›¾ -->
    <div id="qzone-screen" class="chat-list-view">
        <div class="qzone-header">
            <span class="back-btn" id="qzone-back-btn">â€¹</span> <!-- è¿™ä¸ªæŒ‰é’®ç°åœ¨åªè´Ÿè´£ä»åŠ¨æ€è¿”å› -->
            <span>å¥½å‹åŠ¨æ€</span>
        </div>
        <div class="qzone-content">
            <div class="qzone-profile-header">
                <div id="qzone-banner-container" class="qzone-banner-container">
                    <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="èƒŒæ™¯">
                    <input type="file" id="qzone-banner-input" accept="image/*" hidden>
                </div>
                <div class="qzone-user-info">
                    <div id="qzone-avatar-container" class="qzone-avatar-container">
                        <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="å¤´åƒ">
                        <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                    </div>
                    <span id="qzone-nickname">{{user}}</span>
                </div>
            </div>
            <div class="qzone-actions-bar">
                <div class="action-item" id="create-shuoshuo-btn"><span>è¯´è¯´</span></div>
                <div class="action-item" id="create-post-btn"><span>åŠ¨æ€</span></div>
                <div class="action-item" id="open-album-btn"><span>ç›¸å†Œ</span></div>
            </div>
            <div id="qzone-posts-list"></div>
        </div>
    </div>

    <!-- æ”¶è—ç•Œé¢è§†å›¾ -->
    <div id="favorites-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="favorites-back-btn">â€¹</span>
        <span>æˆ‘çš„æ”¶è—</span>
        <!-- æ–°å¢çš„ç¼–è¾‘æŒ‰é’® -->
        <span class="action-btn" id="favorites-edit-btn">ç¼–è¾‘</span>
    </div>

        <!-- ã€æ–°å¢ã€‘æœç´¢æ å®¹å™¨ -->
        <div class="search-bar-container">
            <input type="search" id="favorites-search-input" placeholder="æœç´¢æ”¶è—çš„æ ‡é¢˜ã€å†…å®¹æˆ–ä½œè€…...">
            <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">Ã—</button>
        </div>

        <div id="favorites-list" class="list-container">
            <!-- æ”¶è—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>

<!-- æ–°å¢ï¼šæ”¶è—é¡µåº•éƒ¨æ“ä½œæ  -->
<div id="favorites-action-bar" style="display: none;">
    <button id="favorites-delete-selected-btn" class="action-bar-btn">åˆ é™¤ (0)</button>
</div>

    </div>
    
    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div id="chat-list-bottom-nav">
        <div class="nav-item active" data-view="messages-view">
            <span>æ¶ˆæ¯</span>
        </div>
        <div class="nav-item" data-view="qzone-screen">
            <span>åŠ¨æ€</span>
        </div>
        <div class="nav-item" data-view="favorites-view">
            <span>æ”¶è—</span>
        </div>
    </div>

</div>
<!-- â–²â–²â–² æ›¿æ¢åŒºåŸŸç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ° id="chat-list-screen" çš„ div ä¹‹å â–¼â–¼â–¼ -->
<div id="album-screen" class="screen">
    <!-- 1. é¡µé¢å¤´éƒ¨ï¼ŒåŒ…å«è¿”å›æŒ‰é’®å’Œæ ‡é¢˜ -->
    <div class="header">
        <span class="back-btn" id="album-back-btn">â€¹</span>
        <span>æˆ‘çš„ç›¸å†Œ</span>
        <span class="action-btn" id="create-album-btn-page">+</span>
    </div>
    
    <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
    <div class="list-container">
        <div id="album-grid-page">
            <!-- ç›¸å†Œåˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ° id="album-screen" çš„ div ä¹‹å â–¼â–¼â–¼ -->
<div id="album-photos-screen" class="screen">
    <!-- 1. é¡µé¢å¤´éƒ¨ -->
    <div class="header">
        <span class="back-btn" id="album-photos-back-btn">â€¹</span>
        <span id="album-photos-title">ç›¸å†Œåç§°</span>
        <span class="action-btn" id="album-upload-photo-btn">ä¸Šä¼ </span>
    </div>
    
    <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
    <div class="list-container">
        <div id="photos-grid-page">
            <!-- ç…§ç‰‡åˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="photo-viewer-modal" class="modal">
    <!-- 1. å…³é—­æŒ‰é’® -->
    <button id="photo-viewer-close-btn">Ã—</button>
    
    <!-- 2. ä¸Šä¸€å¼ ç…§ç‰‡æŒ‰é’® -->
    <button id="photo-viewer-prev-btn" class="nav-arrow">â€¹</button>
    
    <!-- 3. å›¾ç‰‡å®¹å™¨ -->
    <div class="photo-viewer-content">
        <img id="photo-viewer-image" src="" alt="å…¨å±ç…§ç‰‡é¢„è§ˆ">
    </div>
    
    <!-- 4. ä¸‹ä¸€å¼ ç…§ç‰‡æŒ‰é’® -->
    <button id="photo-viewer-next-btn" class="nav-arrow">â€º</button>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->

    </div>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ç²˜è´´åˆ° #album-photos-screen çš„ div ä¹‹å â–¼â–¼â–¼ -->
<input type="file" id="album-photo-input" accept="image/*" multiple hidden>
            
<div id="chat-interface-screen" class="screen">
    <div class="header">
        <div class="default-controls">
            <span class="back-btn" id="back-to-list-btn">â€¹</span>
            <span id="chat-header-title">èŠå¤©å¯¹è±¡</span>
            <div class="header-actions">
                <span class="action-btn" id="listen-together-btn" title="ä¸€èµ·å¬"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="ä¸€èµ·å¬"></span>
                <span class="action-btn" id="chat-settings-btn" title="èŠå¤©è®¾ç½®"><img src="https://i.postimg.cc/R04MT1MV/210-20250618115233.png" alt="è®¾ç½®"></span>
            </div>
        </div>
        <div class="selection-controls">
            <span id="selection-cancel-btn">å–æ¶ˆ</span>
            <span id="selection-count"></span>
            <!-- å°†åˆ é™¤å’Œæ”¶è—æŒ‰é’®ç»„åˆåœ¨ä¸€èµ· -->
            <div class="header-actions">
               <span id="selection-favorite-btn" class="action-btn">æ”¶è—</span>
               <span id="selection-delete-btn" class="action-btn" style="color: #ff3b30;">åˆ é™¤</span>
            </div>
        </div>
    </div> <!-- â˜…â˜…â˜… å…³é”®ä¿®æ­£ï¼šHeader åœ¨è¿™é‡Œæ­£ç¡®é—­åˆäº† â˜…â˜…â˜… -->

    <div id="chat-messages"><div id="typing-indicator">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div></div>

    <div id="chat-input-area">
        <div id="chat-input-actions-top">
            <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="è¡¨æƒ…é¢æ¿">+</button>
            <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="å‘é€ç…§ç‰‡"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></button>
            <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="ä¸Šä¼ å›¾ç‰‡"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--text-primary);"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            <button id="transfer-btn" class="chat-action-icon-btn action-button" title="è½¬è´¦">ï¿¥</button>
            <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="å‘é€è¯­éŸ³"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg></button>
        </div>
        <div id="chat-input-main-row">
            <textarea id="chat-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
            <div id="input-actions-wrapper">
                <button id="wait-reply-btn" title="ç­‰å¾…å›å¤"><img src="https://i.postimg.cc/2SwjsfZQ/IMG-6913.gif" alt="ç­‰å¾…å›å¤"></button>
                <button id="send-btn" class="action-button">å‘é€</button>
            </div>
        </div>
    </div>

    <div id="sticker-panel">
        <div id="sticker-panel-header">
            <span class="panel-btn" id="close-sticker-panel-btn">å–æ¶ˆ</span>
            <span class="title">æˆ‘çš„è¡¨æƒ…</span>
            <div style="display: flex; gap: 10px;">
              <span class="panel-btn" id="add-sticker-btn">æ·»åŠ </span>
              <span class="panel-btn" id="upload-sticker-btn">ä¸Šä¼ </span>
            </div>
        </div>
        <div id="sticker-grid"></div>
    </div>
    <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
    
    <div id="music-player-overlay">
        <div class="music-player-window">
            <span id="music-playlist-btn">â˜°</span>
            <div id="music-time-counter">å·²ç»ä¸€èµ·å¬äº†0.0å°æ—¶</div>
            <div id="music-player-song-title">è¯·æ·»åŠ æ­Œæ›²</div>
            <div id="music-player-artist">...</div>
            <div class="music-controls">
                <button id="music-prev-btn">â—€</button>
                <button id="music-play-pause-btn" class="play-pause-btn">â–¶</button>
                <button id="music-next-btn">â–¶</button>
                <button id="music-mode-btn">é¡ºåº</button>
            </div>
            <div class="music-bottom-actions">
                <button id="music-exit-btn">é€€å‡ºä¸€èµ·å¬</button>
                <button id="music-return-btn">è¿”å›èŠå¤©</button>
            </div>
        </div>
    </div>
    
    <div id="music-playlist-panel">
        <div class="playlist-header">
            <span class="panel-btn" id="close-playlist-btn">è¿”å›</span>
            <span>æ’­æ”¾åˆ—è¡¨</span>
            <div>
                <span class="panel-btn" id="add-song-local-btn">æœ¬åœ°</span>
                <span class="panel-btn" id="add-song-url-btn">URL</span>
            </div>
        </div>
        <div class="playlist-body" id="playlist-body"></div>
    </div>
    <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
</div>

            <div id="wallpaper-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span>å£çº¸è®¾ç½®</span><span style="width: 30px;"></span></div><div class="form-container"><div id="wallpaper-preview">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div><button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">ä¸Šä¼ å£çº¸</button><input type="file" id="wallpaper-upload-input" accept="image/*"><button class="form-button" id="save-wallpaper-btn">ä¿å­˜å¹¶åº”ç”¨</button></div></div>

<div id="font-settings-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>å­—ä½“è®¾ç½®</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label for="font-url-input">å­—ä½“æ–‡ä»¶URL (.ttf, .otf, .woffç­‰)</label>
            <input type="text" id="font-url-input" placeholder="https://..../font.ttf">
        </div>

        <div class="form-group">
            <label>å®æ—¶é¢„è§ˆ</label>
            <div id="font-preview" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #f9f9f9;">
                <p style="font-size: 20px; margin: 0 0 10px 0;">ä½ å¥½ä¸–ç•Œ Hello World</p>
                <p style="margin: 0;">è¿™æ˜¯å­—ä½“é¢„è§ˆæ•ˆæœï¼Œ12345ã€‚</p>
            </div>
        </div>

        <button class="form-button" id="save-font-btn">ä¿å­˜å¹¶åº”ç”¨</button>
        <button class="form-button form-button-secondary" id="reset-font-btn">æ¢å¤é»˜è®¤å­—ä½“</button>
    </div>
</div>
        </div>
    </div>
  
    <div id="chat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>èŠå¤©è®¾ç½®</span></div><div class="modal-body"><div class="form-group" id="chat-name-group"><label for="chat-name-input">å¤‡æ³¨å / ç¾¤å</label><input type="text" id="chat-name-input"></div>

    <!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°â€œå¤‡æ³¨åâ€è¾“å…¥æ¡†çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
    <div class="form-group" id="assign-group-section" style="display: none;"> <!-- é»˜è®¤éšè—ï¼Œåªå¯¹å•èŠæ˜¾ç¤º -->
        <label for="assign-group-select">å¥½å‹åˆ†ç»„</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select id="assign-group-select" style="flex-grow: 1;">
                <!-- åˆ†ç»„é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </select>
            <button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ç®¡ç†åˆ†ç»„</button>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">æˆ‘çš„ç¾¤æ˜µç§°</label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label>ç¾¤å¤´åƒ</label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">ä¸Šä¼ ç¾¤å¤´åƒ</button><input type="file" id="group-avatar-input" accept="image/*"></div></div>
            <div class="form-group" id="world-book-link-group">
                <label>å…³è”ä¸–ç•Œä¹¦ (å¯å¤šé€‰)</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">-- ç‚¹å‡»é€‰æ‹© --</span>
                        <span class="arrow-down">â–¼</span>
                    </div>
                    <div id="world-book-checkboxes-container" class="checkboxes-container">
                    </div>
                </div>
            </div>
            <div class="form-group" id="ai-persona-group"><label for="ai-persona">å¯¹æ–¹äººè®¾ (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div><div class="form-group" id="ai-avatar-group"><label>å¯¹æ–¹å¤´åƒ</label><div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">ä¸Šä¼ å¯¹æ–¹å¤´åƒ</button><button class="change-frame-btn" data-type="ai">æ›´æ¢å¤´åƒæ¡†</button><input type="file" id="ai-avatar-input" accept="image/*"></div></div><div class="form-group" id="my-persona-group"><label for="my-persona">æˆ‘çš„äººè®¾ (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label>æˆ‘çš„å¤´åƒ</label><div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById('my-avatar-input').click()">ä¸Šä¼ æˆ‘çš„å¤´åƒ</button><button class="change-frame-btn" data-type="my">æ›´æ¢å¤´åƒæ¡†</button><button id="open-persona-library-btn">é¢„è®¾</button><input type="file" id="my-avatar-input" accept="image/*"></div></div><div class="form-group" id="group-members-group"><label>ç¾¤æˆå‘˜äººè®¾</label><div id="group-members-settings"></div></div><div class="form-group"><label for="max-memory">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label><input type="number" id="max-memory" value="10"></div><div class="form-group"><label>èŠå¤©æ°”æ³¡ä¸»é¢˜ <button id="reset-theme-btn" type="button">é‡ç½®</button></label><div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> é»˜è®¤</label><label><input type="radio" name="theme-select" value="pink_blue"> ç²‰è“</label><label><input type="radio" name="theme-select" value="blue_white"> è“ç™½</label><label><input type="radio" name="theme-select" value="purple_yellow"> ç´«é»„</label><label><input type="radio" name="theme-select" value="black_white"> é»‘ç™½</label><label><input type="radio" name="theme-select" value="yellow_white"> é»„ç™½</label><label><input type="radio" name="theme-select" value="red_black"> çº¢é»‘</label><label><input type="radio" name="theme-select" value="blue_yellow"> è“é»„</label><label><input type="radio" name="theme-select" value="pink_yellow"> ç²‰é»„</label><label><input type="radio" name="theme-select" value="pink_purple"> ç²‰ç´«</label><label><input type="radio" name="theme-select" value="gray_white"> ç°ç™½</label><label><input type="radio" name="theme-select" value="blue_green"> è“ç»¿</label><label><input type="radio" name="theme-select" value="pink_white"> ç²‰ç™½</label><label><input type="radio" name="theme-select" value="pink_black"> ç²‰é»‘</label><label><input type="radio" name="theme-select" value="pink_green"> ç²‰ç»¿</label><label><input type="radio" name="theme-select" value="green_black"> ç»¿é»‘</label></div></div>

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°â€œèŠå¤©æ°”æ³¡ä¸»é¢˜â€çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="font-size-slider">èŠå¤©å­—ä½“å¤§å° <span id="font-size-value">13px</span></label>
    <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°â€œèŠå¤©å­—ä½“å¤§å°â€çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="custom-css-input">
        è‡ªå®šä¹‰æ°”æ³¡æ ·å¼ (CSS)
        <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">é‡ç½®</button>
    </label>
    <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="/* ç¤ºä¾‹ï¼šä¸ºâ€œæˆ‘â€çš„æ°”æ³¡æ·»åŠ æ¸å˜èƒŒæ™¯å’Œé˜´å½± */
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"></textarea>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°è‡ªå®šä¹‰CSSè¾“å…¥æ¡†çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label>å®æ—¶é¢„è§ˆ</label>
    <div id="settings-preview-area">
        <!-- JSä¼šåœ¨è¿™é‡Œç”Ÿæˆé¢„è§ˆå†…å®¹ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

            <div class="form-group">
                <label>èŠå¤©èƒŒæ™¯</label>
                <div class="bg-upload-container">
                    <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">ä¸Šä¼ èƒŒæ™¯å›¾</button>
                    <button type="button" id="remove-bg-btn">ç§»é™¤èƒŒæ™¯</button>
                </div>
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image/*" style="display: none;">
            </div>
            <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;"><button class="form-button form-button-secondary" id="clear-chat-btn">æ¸…ç©ºèŠå¤©è®°å½•</button></div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">å–æ¶ˆ</button><button class="save" id="save-chat-settings-btn">ä¿å­˜</button></div></div></div>
    
    <div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>æˆ‘çš„äººè®¾åº“</span><button id="add-persona-preset-btn" class="action-button">æ·»åŠ </button></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn">å…³é—­</button></div></div></div>
    
    <div id="persona-editor-modal" class="modal"><div class="modal-content"><div class="modal-header"><span id="persona-editor-title">æ·»åŠ äººè®¾é¢„è®¾</span></div><div class="modal-body"><div class="form-group"><label>é¢„è®¾å¤´åƒ</label><div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button><input type="file" id="preset-avatar-input" accept="image/*"></div></div><div class="form-group"><label for="preset-persona-input">é¢„è®¾äººè®¾</label><textarea id="preset-persona-input" rows="4" placeholder="åœ¨æ­¤è¾“å…¥è¿™ä¸ªäººè®¾çš„è¯¦ç»†è®¾å®š..."></textarea></div></div><div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">å–æ¶ˆ</button><button class="save" id="save-persona-preset-btn">ä¿å­˜</button></div></div></div>

    <div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ç¼–è¾‘ç¾¤æˆå‘˜</span></div><div class="modal-body">
    <div class="form-group"><label for="member-name-input">åå­—</label><input type="text" id="member-name-input"></div>
    <div class="form-group"><label for="member-persona-input">äººè®¾</label><textarea id="member-persona-input" rows="4"></textarea></div>
    <div class="form-group"><label>å¤´åƒ</label><div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button><button class="change-frame-btn" data-type="member">æ›´æ¢å¤´åƒæ¡†</button><input type="file" id="member-avatar-input" accept="image/*"></div></div>
    </div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">å–æ¶ˆ</button><button class="save" id="save-member-settings-btn">ä¿å­˜</button></div></div></div>
    
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">å–æ¶ˆ</button>
                <button id="custom-modal-confirm" class="confirm-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ç¼–è¾‘é¢„è®¾</button>
                <button id="preset-action-delete" class="btn-danger">åˆ é™¤é¢„è®¾</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">ç»™Taä¸€ä¸ªæƒŠå–œï¼</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">è½¬è´¦é‡‘é¢</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="9999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">å¤‡æ³¨ (å¯é€‰)</label>
                <input type="text" id="transfer-note" placeholder="ç•™ä¸‹ä½ çš„å°å¿ƒæ€~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">å–æ¶ˆ</button>
                <button id="transfer-confirm-btn">ç¡®è®¤è½¬è´¦</button>
            </div>
        </div>
    </div>

 <div id="battery-alert-modal">
    <div class="battery-alert-content">
        <img id="battery-alert-image" src="">
        <p id="battery-alert-text"></p>
    </div>
</div>

<!-- å¤´åƒæ¡†é€‰æ‹©æ¨¡æ€æ¡† (è¿™æ˜¯æ–°æ·»åŠ çš„) -->
    <div id="avatar-frame-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>é€‰æ‹©å¤´åƒæ¡†</span>
            </div>
            <div class="modal-body">
                <div class="frame-tabs">
                    <div id="ai-frame-tab" class="frame-tab active">å¯¹æ–¹çš„</div>
                    <div id="my-frame-tab" class="frame-tab">æˆ‘çš„</div>
                </div>
                <div id="ai-frame-content" class="frame-content">
                    <div id="ai-frame-grid" class="frame-grid">
                        <!-- AIå¤´åƒæ¡†ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                    </div>
                </div>
                <div id="my-frame-content" class="frame-content" style="display: none;">
                     <div id="my-frame-grid" class="frame-grid">
                        <!-- æˆ‘çš„å¤´åƒæ¡†ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-frame-settings-btn">å–æ¶ˆ</button>
                <button class="save" id="save-frame-settings-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µã€å®Œæ•´ã€‘çš„æ¨¡æ€æ¡†ä»£ç ï¼Œæ›¿æ¢æ‰ä½ ç°æœ‰çš„ id="create-post-modal" çš„æ•´ä¸ª div â–¼â–¼â–¼ -->
<div id="create-post-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 90%;">
        <div class="modal-header">
            <span>å‘å¸ƒåŠ¨æ€</span>
        </div>
        <div class="modal-body">
            <!-- å…¬å¼€æ–‡å­—è¾“å…¥åŒº -->
            <div class="form-group">
                <textarea id="post-public-text" rows="3" placeholder="åˆ†äº«æ–°é²œäº‹...ï¼ˆéå¿…å¡«çš„å…¬å¼€æ–‡å­—ï¼‰"></textarea>
            </div>

            <!-- === æ¨¡å¼åˆ‡æ¢å¼€å…³ (æ–°å¢) === -->
            <div class="post-mode-switcher">
                <button id="switch-to-image-mode" class="mode-btn active">ä¸Šä¼ å›¾ç‰‡</button>
                <button id="switch-to-text-image-mode" class="mode-btn">ä½¿ç”¨æ–‡å­—å›¾</button>
            </div>

<!-- â–¼â–¼â–¼ ã€ä¿®æ­£åã€‘çš„å¯è§èŒƒå›´è®¾ç½® â–¼â–¼â–¼ -->
<div class="form-group">
    <label>å¯è§èŒƒå›´</label>
    <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;">
        <label><input type="radio" name="visibility" value="public" checked> å…¬å¼€</label>

        <label><input type="radio" name="visibility" value="include"> æŒ‡å®šåˆ†ç»„å¯è§</label>
    </div>
    <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
        <!-- åˆ†ç»„å¤šé€‰æ¡†å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>
<!-- â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² -->

            <!-- === å›¾ç‰‡æ¨¡å¼åŒºåŸŸ === -->
            <div id="image-mode-content" class="post-mode-content active">
                <div class="form-group">
<div id="post-image-preview-container" class="post-image-preview-container">
                        <img id="post-image-preview" src="" alt="å›¾ç‰‡é¢„è§ˆ">
                        <button id="post-remove-image-btn">Ã—</button>
                    </div>
                    <div class="post-image-upload-options">
                        <button id="post-upload-local-btn" class="form-button-secondary">æœ¬åœ°ä¸Šä¼ </button>
                        <button id="post-use-url-btn" class="form-button-secondary">ç½‘ç»œURL</button>
                        <input type="file" id="post-local-image-input" accept="image/*" hidden>
                    </div>
                </div>
                <div id="post-image-desc-group" class="form-group" style="display: none;">
                    <label>å›¾ç‰‡æè¿° (å¿…å¡«ï¼Œç»™AIçœ‹)</label>
                    <input type="text" id="post-image-description" placeholder="ç®€å•æè¿°å›¾ç‰‡å†…å®¹ï¼Œå¸®åŠ©AIç†è§£">
                </div>
            </div>

            <!-- === æ–‡å­—å›¾æ¨¡å¼åŒºåŸŸ (æ–°å¢) === -->
            <div id="text-image-mode-content" class="post-mode-content">
                <div class="form-group">
                    <label>æ–‡å­—å›¾ (ç»™AIç†è§£ç”¨çš„æè¿°ï¼Œç‚¹å‡»å›¾ç‰‡åå¯è§)</label>
                    <textarea id="post-hidden-text" rows="4" placeholder="åœ¨è¿™é‡Œå†™ä¸‹å›¾ç‰‡æè¿°..."></textarea>
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-post-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-post-btn">å‘å¸ƒ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°çš„æ¨¡æ€æ¡†HTMLç²˜è´´åˆ°æ‰€æœ‰å…¶ä»–æ¨¡æ€æ¡†ä¹‹å â–¼â–¼â–¼ -->
<div id="group-management-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†å¥½å‹åˆ†ç»„</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ–°å»ºåˆ†ç»„</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-group-name-input" placeholder="è¾“å…¥åˆ†ç»„å..." style="flex-grow: 1;">
                    <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- åˆ†ç»„åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-group-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°HTMLç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="message-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <!-- æ–°çš„æ“ä½œæŒ‰é’® -->
            <button id="edit-message-btn">ç¼–è¾‘æ¶ˆæ¯</button>
            <button id="copy-message-btn">å¤åˆ¶æ–‡æœ¬</button>
            <button id="select-message-btn">è¿›å…¥å¤šé€‰</button>
            <!-- å–æ¶ˆæŒ‰é’® -->
            <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°HTMLç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="post-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <button id="edit-post-btn">ç¼–è¾‘åŠ¨æ€</button>
            <button id="copy-post-btn">å¤åˆ¶å†…å®¹</button>           
            <button id="cancel-post-action-btn">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // ===================================================================
        // 1. æ‰€æœ‰å˜é‡å’Œå¸¸é‡å®šä¹‰
        // ===================================================================
        const db = new Dexie('GeminiChatDB');
        // --- å·²ä¿®æ­£ ---
        let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [], qzoneSettings: {}, activeAlbumId: null };
        // --- ä¿®æ­£ç»“æŸ ---
        let musicState = { isActive: false, activeChatId: null, isPlaying: false, playlist: [], currentIndex: -1, playMode: 'order', totalElapsedTime: 0, timerId: null };
        const audioPlayer = document.getElementById('audio-player');
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingFrameForMember = false;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;

let activeMessageTimestamp = null;
let activePostId = null; // <-- æ–°å¢ï¼šç”¨äºå­˜å‚¨å½“å‰æ“ä½œçš„åŠ¨æ€ID

        let photoViewerState = {
            isOpen: false,
            photos: [], // å­˜å‚¨å½“å‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡URL
            currentIndex: -1, // å½“å‰æ­£åœ¨æŸ¥çœ‹çš„ç…§ç‰‡ç´¢å¼•
        };

        let unreadPostsCount = 0;

        let isFavoritesSelectionMode = false;
        let selectedFavorites = new Set()

let simulationIntervalId = null;

const frameModal = document.getElementById('avatar-frame-modal');
const aiFrameTab = document.getElementById('ai-frame-tab');
const myFrameTab = document.getElementById('my-frame-tab');
const aiFrameContent = document.getElementById('ai-frame-content');
const myFrameContent = document.getElementById('my-frame-content');
const aiFrameGrid = document.getElementById('ai-frame-grid');
const myFrameGrid = document.getElementById('my-frame-grid');

        const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
        const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
        const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
        let notificationTimeout;
        const avatarFrames = [ { id: 'none', url: '', name: 'æ— ' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/fLDnz5Pn/IMG-5574.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/HxH3cNHz/IMG-6871.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/jCVK0fGL/IMG-6890.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/85Zsyjwn/IMG-6895.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/cJtpZCB3/IMG-6894.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/63sDQKMm/IMG-6893.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/cHQPgzj4/IMG-6888.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/dVLXm3Xf/IMG-6885.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/kGsZwbq0/IMG-6886.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/63NmX03s/IMG-4366.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/zvz2LGK0/IMG-4367.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/prsGKMBx/IMG-4370.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/gk0BmrY0/IMG-4371.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/fRt2SFSn/IMG-4368.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/kGgwJhPH/IMG-4374.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/PrcKH436/IMG-4376.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/fRV86FMq/IMG-4381.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/HsyqMVyk/IMG-4385.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/qBbKK7dS/IMG-4386.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/05wnd389/IMG-4388.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/RZNLhbbr/IMG-4389.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/fLTc42dg/IMG-4391.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/FzbGNdRT/IMG-4392.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/XY63sTS3/IMG-4393.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Cx9vCVWH/IMG-4395.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/kMfPQBwQ/IMG-4396.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/CLrZQMMD/IMG-4398.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/L4zwDhTC/IMG-4399.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/yN3s8szM/IMG-4400.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/59Cn1tkB/IMG-4401.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/g0s1V0PX/IMG-4402.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/Jn1DFPgY/IMG-4403.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/q7cQnDy1/IMG-4404.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/RFK3q2t0/IMG-4407.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/gcV0VR2t/IMG-4408.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/W1CjLb4J/IMG-4409.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Ss7pM6fW/IMG-4410.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nrFfYX3N/IMG-4412.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/cHWp0KG6/IMG-4413.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/4yNjHrdg/IMG-4414.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/hPX5F8Qp/IMG-4415.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/vHCSG1WM/IMG-4416.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/x1Hp80Rm/IMG-4417.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/FHRcCGfH/IMG-4418.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/13hhJ77p/IMG-4419.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/J4WCQd2j/IMG-4420.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/Dydkpd9H/IMG-4421.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/mrkvDxPW/IMG-4422.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/76Tj3g1B/IMG-4425.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/3N5Vndn3/IMG-4426.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/05DLr0yj/IMG-4427.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/GhR6DT4Q/IMG-4428.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/fRTF24jS/IMG-4430.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/R0WYmcYM/IMG-4431.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/nrJSqNhz/IMG-4432.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/tC9mJ0cv/IMG-4438.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/XNkQTHvf/IMG-5561.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/Mpv5fzm5/IMG-4439.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/T1tjhsyB/IMG-4720.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/c4JMPd2W/IMG-4724.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/g2XykNGB/IMG-4727.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/y8MmJcd6/IMG-4728.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/Lsjzj5Yt/IMG-4729.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/bNdk33SN/IMG-4893.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/4x9tTy1D/IMG-5563.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/DZshzKv6/IMG-5576.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Fsvr71JL/IMG-5573.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/Fz3HwLk9/IMG-5569.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/wjH180kn/IMG-5566.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/MG6qtLYK/IMG-5565.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/CKgDNYVb/IMG-5577.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/C5XnfpNB/IMG-5579.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/4y7mGFgJ/IMG-5716.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/FzM1Hgr0/IMG-5717.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/rF4KYbjj/IMG-5720.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/6pLTBvDG/IMG-5721.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/VNK6Ccsf/IMG-5722.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/wx72fhr2/IMG-5968.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/QdrqdvdY/IMG-5969.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/0yd0MZ6k/IMG-5971.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/1zmcp66p/IMG-5973.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/wBw5Fvcn/IMG-5974.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/R0pfKYvB/IMG-5976.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/9fQZ425b/IMG-5975.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/v8V9xXjJ/IMG-6137.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/WbmkXzsS/IMG-6138.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/Dw2bDhZh/IMG-6140.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/ZqQBCyLY/IMG-6144.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/qRCtnMms/IMG-6145.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/1Rwn3XVP/IMG-6146.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Kv51tW5H/IMG-6147.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nhcC21Rc/IMG-6148.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/fTWzQRx8/IMG-6149.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/LXyyqDbY/IMG-6294.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/7Zgm1wRy/IMG-6295.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/5tbpnDcQ/IMG-6296.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/YSRRV8kn/IMG-6297.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/k45sd8gn/IMG-6375.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/50k390X8/IMG-6376.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/90RBDh9K/IMG-6377.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/cCpBYbMH/IMG-6552.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/Pf9g2fSL/IMG-6554.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/gkhf597g/IMG-6555.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/g2PfbSFm/IMG-6556.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/pLY3WfR8/IMG-6557.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/65Cmcr7S/IMG-6559.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Y94XWYKd/IMG-6560.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/ydwLXx7s/IMG-6562.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/G3y73Fj2/IMG-6563.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/TYvkKKkc/IMG-6565.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/GmcqjZn8/IMG-6566.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/k5Gs0K47/IMG-6567.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/XJy8JWdh/IMG-6568.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/fycfcvHf/IMG-6569.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/J7ZxC11H/IMG-6570.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/hPnrSHjy/IMG-4434.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/YqxxjbLp/IMG-6572.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/wjfcQMkZ/IMG-6573.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Vv8jkCYr/IMG-6574.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/MZ77rdDy/IMG-6850.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/T3NvqJCZ/IMG-6851.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/28TsrxRV/IMG-6852.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/VkV2bLNw/IMG-6853.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/gJ95NSRB/IMG-6854.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/d1qsQsbQ/IMG-6855.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/gJNYx9pV/IMG-6856.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/fyPDvxJk/IMG-6860.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/QMDsSNxg/IMG-6861.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/vBqsQW7X/IMG-6858.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/Y0vwjhb7/IMG-6857.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/90sH9Cn7/IMG-6868.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/Y2PHZzCC/IMG-6866.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/7Z8yYP7v/IMG-6889.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nryNzTXK/IMG-6915.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Qx5dqyJ3/IMG-6917.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/Wbr0JSDD/IMG-5316.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/tgR6wjBP/IMG-5570.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/d0WCKxff/IMG-6932.gif', name: '14' }, { id: 'frame_11', url: 'https://i.postimg.cc/Ss3znzk7/IMG-6934.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/nrm9BcL8/IMG-6941.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/ZYvd1jxf/IMG-6937.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/sDFhySn3/IMG-6936.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/43PhvxRq/IMG-6922.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/3Rb46fRZ/IMG-6923.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/PJppkbvn/IMG-6918.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/XqRZNZ9G/IMG-6916.gif', name: '14' }, { id: 'frame_14', url: 'https://i.postimg.cc/RVt6sRzc/IMG-6939.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/mgGc0HbK/IMG-6926.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/P5zLh5JJ/IMG-6942.gif', name: '14' }, { id: 'frame_14', url: 'https://i.postimg.cc/xCqqKGRN/IMG-6929.gif', name: '14' } ];
        let currentFrameSelection = { ai: null, my: null };
        const STICKER_REGEX = /^(https:\/\/i\.postimg\.cc\/.+|https:\/\/files\.catbox\.moe\/.+|data:image)/;
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;
        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;
        const dynamicFontStyle = document.createElement('style');
        dynamicFontStyle.id = 'dynamic-font-style';
        document.head.appendChild(dynamicFontStyle);

        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');
        let modalResolve;

        function showCustomModal() { 
            modalOverlay.classList.add('visible'); 
        }

        function hideCustomModal() { 
            modalOverlay.classList.remove('visible'); 
            modalConfirmBtn.classList.remove('btn-danger'); 
            if (modalResolve) modalResolve(null); 
        }

        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
                modalCancelBtn.style.display = 'block';
                modalConfirmBtn.textContent = 'ç¡®å®š';
                if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }

        function showCustomAlert(title, message) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.textContent = 'å¥½çš„';
                modalConfirmBtn.onclick = () => {
                    modalCancelBtn.style.display = 'block'; 
                    modalConfirmBtn.textContent = 'ç¡®å®š';
                    resolve(true); 
                    hideCustomModal();
                };
                showCustomModal();
            });
        }

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘æ›¿æ¢æ—§çš„ showCustomPrompt å‡½æ•° â–¼â–¼â–¼
function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {
    return new Promise(resolve => {
        modalResolve = resolve;
        modalTitle.textContent = title;
        const inputId = 'custom-prompt-input';
        
        const inputHtml = type === 'textarea' 
            ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
            : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†é¢å¤–çš„HTMLå’Œè¾“å…¥æ¡†ç»„åˆåœ¨ä¸€èµ·
        modalBody.innerHTML = extraHtml + inputHtml;
        const input = document.getElementById(inputId);

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºæ ¼å¼åŠ©æ‰‹æŒ‰é’®ç»‘å®šäº‹ä»¶
        modalBody.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const templateStr = btn.dataset.template;
                if (templateStr) {
                    try {
                        const templateObj = JSON.parse(templateStr);
                        // ä½¿ç”¨ null, 2 å‚æ•°è®©JSONå­—ç¬¦ä¸²æ ¼å¼åŒ–ï¼Œå¸¦ç¼©è¿›ï¼Œæ›´æ˜“è¯»
                        input.value = JSON.stringify(templateObj, null, 2);
                        input.focus();
                    } catch(e) {
                        console.error("è§£ææ ¼å¼æ¨¡æ¿å¤±è´¥:", e);
                    }
                }
            });
        });
        
        modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
        modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
        showCustomModal();
        setTimeout(() => input.focus(), 100);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        // ===================================================================
        // 2. æ•°æ®åº“ç»“æ„å®šä¹‰
        // ===================================================================

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ db.version().stores() â–¼â–¼â–¼
db.version(17).stores({ 
    chats: '&id, isGroup, groupId', // <-- å¢åŠ  groupId ç´¢å¼•ï¼Œæ–¹ä¾¿æŸ¥è¯¢
    apiConfig: '&id', 
    globalSettings: '&id', 
    userStickers: '&id, url, name',
    worldBooks: '&id, name',
    musicLibrary: '&id', 
    personaPresets: '&id',
    qzoneSettings: '&id',
    qzonePosts: '++id, timestamp', 
    qzoneAlbums: '++id, name, createdAt',
    qzonePhotos: '++id, albumId',
    favorites: '++id, type, timestamp, originalTimestamp',
    qzoneGroups: '++id, name' // <-- ã€æ–°å¢ã€‘åˆ†ç»„è¡¨
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        // ===================================================================
        // 3. æ‰€æœ‰åŠŸèƒ½å‡½æ•°å®šä¹‰
        // ===================================================================

        function showScreen(screenId) {
            if (screenId === 'chat-list-screen') {
                window.renderChatListProxy(); 
                switchToChatListView('messages-view');
            }
            if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
            if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
            if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screenToShow = document.getElementById(screenId);
            if (screenToShow) screenToShow.classList.add('active');
            if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
            if (screenId === 'font-settings-screen') {
                document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
                applyCustomFont(state.globalSettings.fontUrl || '', true);
            }
        }
        window.updateListenTogetherIconProxy = () => {};

        function switchToChatListView(viewId) {
            const chatListScreen = document.getElementById('chat-list-screen');
            const views = {
                'messages-view': document.getElementById('messages-view'),
                'qzone-screen': document.getElementById('qzone-screen'),
                'favorites-view': document.getElementById('favorites-view')
            };
            const mainHeader = document.getElementById('main-chat-list-header');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // è·å–ä¸»å¯¼èˆªæ 

            if (isFavoritesSelectionMode) {
                document.getElementById('favorites-edit-btn').click(); 
            }

            // éšè—æ‰€æœ‰è§†å›¾
            Object.values(views).forEach(v => v.classList.remove('active'));
            // æ˜¾ç¤ºç›®æ ‡è§†å›¾
            if (views[viewId]) {
                views[viewId].classList.add('active');
            }

            // æ›´æ–°åº•éƒ¨å¯¼èˆªæ é«˜äº®
            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === viewId);
            });
            
            // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰UIå…ƒç´ çš„æ˜¾éš â–¼â–¼â–¼
            if (viewId === 'messages-view') {
                mainHeader.style.display = 'flex';
                mainBottomNav.style.display = 'flex';
            } else {
                mainHeader.style.display = 'none';
                mainBottomNav.style.display = 'none';
            }
            // â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–²

            // æ ¹æ®è§†å›¾IDæ‰§è¡Œç‰¹å®šçš„æ¸²æŸ“/æ›´æ–°é€»è¾‘
            switch (viewId) {
                case 'qzone-screen':
                    views['qzone-screen'].style.backgroundColor = '#f0f2f5';
                    updateUnreadIndicator(0);
                    renderQzoneScreen();
                    renderQzonePosts();
                    break;
                case 'favorites-view':
                    views['favorites-view'].style.backgroundColor = '#f9f9f9';
                    renderFavoritesScreen();
                    break;
                case 'messages-view':
                    // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è¿”å›æ¶ˆæ¯åˆ—è¡¨æ—¶è¦æ‰§è¡Œçš„é€»è¾‘
                    break;
            }
        }
        
        function renderQzoneScreen() {
            if (state && state.qzoneSettings) {
                const settings = state.qzoneSettings;
                document.getElementById('qzone-nickname').textContent = settings.nickname;
                document.getElementById('qzone-avatar-img').src = settings.avatar;
                document.getElementById('qzone-banner-img').src = settings.banner;
            }
        }
        window.renderQzoneScreenProxy = renderQzoneScreen;

        async function saveQzoneSettings() {
            if (db && state.qzoneSettings) {
                await db.qzoneSettings.put(state.qzoneSettings);
            }
        }

        function formatPostTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffMinutes < 1) return 'åˆšåˆš';
            if (diffMinutes < 60) return `${diffMinutes}åˆ†é’Ÿå‰`;
            if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            if (now.getFullYear() === year) {
                return `${month}-${day} ${hours}:${minutes}`;
            } else {
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            }
        }

        async function renderQzonePosts() {
            const postsListEl = document.getElementById('qzone-posts-list');
            if (!postsListEl) return;

            const [posts, favorites] = await Promise.all([
                db.qzonePosts.orderBy('timestamp').reverse().toArray(),
                db.favorites.where('type').equals('qzone_post').toArray() // è·å–æ‰€æœ‰å·²æ”¶è—çš„åŠ¨æ€
            ]);

            // åˆ›å»ºä¸€ä¸ªå·²æ”¶è—å¸–å­IDçš„é›†åˆï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾
            const favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
            
            postsListEl.innerHTML = '';

            if (posts.length === 0) {
                postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡è¯´è¯´å§ï¼</p>';
                return;
            }

            const userSettings = state.qzoneSettings;

            posts.forEach(post => {
                const postContainer = document.createElement('div');
                postContainer.className = 'qzone-post-container';
                postContainer.dataset.postId = post.id;

                const postEl = document.createElement('div');
                postEl.className = 'qzone-post-item';

                let authorAvatar = '', authorNickname = '', commentAvatar = userSettings.avatar; 

                if (post.authorId === 'user') {
                    authorAvatar = userSettings.avatar;
                    authorNickname = userSettings.nickname;
                } else if (state.chats[post.authorId]) {
                    const authorChat = state.chats[post.authorId];
                    authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
                    authorNickname = authorChat.name;
                } else {
                    authorAvatar = defaultAvatar;
                    authorNickname = '{{char}}';
                }
                
                let contentHtml = '';
                const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';

                if (post.type === 'shuoshuo') {
                    contentHtml = `<div class="post-content" style="margin-bottom: 10px;">${post.content.replace(/\n/g, '<br>')}</div>`;
                } 
                else if (post.type === 'image_post' && post.imageUrl) {
                    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
                } 
                else if (post.type === 'text_image') {
                    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
                }

                let likesHtml = '';
                if (post.likes && post.likes.length > 0) {
                    likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${post.likes.join('ã€')} è§‰å¾—å¾ˆèµ</span></div>`;
                }
                
                let commentsHtml = '';
                if (post.comments && post.comments.length > 0) {
                    commentsHtml = '<div class="post-comments-container">';
                    post.comments.forEach(comment => {
                        commentsHtml += `<div class="comment-item"><span class="commenter-name">${comment.commenterName}:</span><span class="comment-text">${comment.text}</span></div>`;
                    });
                    commentsHtml += '</div>';
                }

                // æ£€æŸ¥ç‚¹èµå’Œæ”¶è—çŠ¶æ€
                const userNickname = state.qzoneSettings.nickname;
                const isLikedByUser = post.likes && post.likes.includes(userNickname);
                const isFavoritedByUser = favoritedPostIds.has(post.id); // ä½¿ç”¨Setå¿«é€ŸæŸ¥æ‰¾

                postEl.innerHTML = `
                    <div class="post-header"><img src="${authorAvatar}" class="post-avatar"><div class="post-info"><span class="post-nickname">${authorNickname}</span><span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span></div>

        <!-- ã€æ–°å¢ã€‘åŠ¨æ€æ“ä½œæŒ‰é’® -->
        <div class="post-actions-btn">â€¦</div>
    </div>

                    <div class="post-main-content">${contentHtml}</div>
                    <div class="post-feedback-icons">
                        <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                        <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                    </div>
                    ${likesHtml}
                    ${commentsHtml}
                    <div class="post-footer"><div class="comment-section"><img src="${commentAvatar}" class="comment-avatar"><input type="text" class="comment-input" placeholder="å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹"><div class="at-mention-popup"></div></div><button class="comment-send-btn">å‘é€</button></div>
                `;
                
                const deleteAction = document.createElement('div');
                deleteAction.className = 'qzone-post-delete-action';
                deleteAction.innerHTML = '<span>åˆ é™¤</span>';
                postContainer.appendChild(postEl);
                postContainer.appendChild(deleteAction);
                const commentSection = postContainer.querySelector('.comment-section');
                if (commentSection) {
                    commentSection.addEventListener('touchstart', (e) => e.stopPropagation());
                    commentSection.addEventListener('mousedown', (e) => e.stopPropagation());
                }
                postsListEl.appendChild(postContainer);
                const commentInput = postContainer.querySelector('.comment-input');
                const popup = postContainer.querySelector('.at-mention-popup');
                commentInput.addEventListener('input', () => {
                    const value = commentInput.value;
                    const atMatch = value.match(/@([\p{L}\w]*)$/u);
                    if (atMatch) {
                        const namesToMention = new Set();
                        const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
                        if (authorNickname) namesToMention.add(authorNickname);
                        postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
                            namesToMention.add(nameEl.textContent.replace(':', ''));
                        });
                        namesToMention.delete(state.qzoneSettings.nickname);
                        popup.innerHTML = '';
                        if (namesToMention.size > 0) {
                            const searchTerm = atMatch[1];
                            namesToMention.forEach(name => {
                                if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                                    const item = document.createElement('div');
                                    item.className = 'at-mention-item';
                                    item.textContent = name;
                                    item.addEventListener('mousedown', (e) => {
                                        e.preventDefault();
                                        const newText = value.substring(0, atMatch.index) + `@${name} `;
                                        commentInput.value = newText;
                                        popup.style.display = 'none';
                                        commentInput.focus();
                                    });
                                    popup.appendChild(item);
                                }
                            });
                            popup.style.display = popup.children.length > 0 ? 'block' : 'none';
                        } else {
                            popup.style.display = 'none';
                        }
                    } else {
                        popup.style.display = 'none';
                    }
                });
                commentInput.addEventListener('blur', () => { setTimeout(() => { popup.style.display = 'none'; }, 200); });
            });
        }
             
// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ä¸ªã€æ›´æ–°åçš„ã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ ä»£ç ä¸­æ—§çš„ displayFilteredFavorites å‡½æ•° â–¼â–¼â–¼

function displayFilteredFavorites(items) {
    const listEl = document.getElementById('favorites-list');
    listEl.innerHTML = '';

    if (items.length === 0) {
        const searchTerm = document.getElementById('favorites-search-input').value;
        const message = searchTerm ? 'æœªæ‰¾åˆ°ç›¸å…³æ”¶è—' : 'ä½ çš„æ”¶è—å¤¹æ˜¯ç©ºçš„ï¼Œ<br>å¿«å»åŠ¨æ€æˆ–èŠå¤©ä¸­æ”¶è—å–œæ¬¢çš„å†…å®¹å§ï¼';
        listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
        return;
    }

    for (const item of items) {
        const card = document.createElement('div');
        card.className = 'favorite-item-card';
        card.dataset.favid = item.id;

        let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';

        if (item.type === 'qzone_post') {
            const post = item.content;
            sourceText = 'æ¥è‡ªåŠ¨æ€';
            let authorAvatar = defaultAvatar, authorNickname = 'æœªçŸ¥ç”¨æˆ·';

            if (post.authorId === 'user') {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
            } else if (state.chats[post.authorId]) {
                authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                authorNickname = state.chats[post.authorId].name;
            }

            headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
            
            const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
            if (post.type === 'shuoshuo') {
                contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
            } else if (post.type === 'image_post' && post.imageUrl) {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
            } else if (post.type === 'text_image') {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
            }

            // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„ä»£ç å¼€å§‹ â–¼â–¼â–¼
            
            // 1. æ„é€ ç‚¹èµåŒºåŸŸçš„HTML
            let likesHtml = '';
            // æ£€æŸ¥ post å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨ likes æ•°ç»„å¹¶ä¸”ä¸ä¸ºç©º
            if (post.likes && post.likes.length > 0) {
                // å¦‚æœå­˜åœ¨ï¼Œå°±åˆ›å»ºç‚¹èµåŒºåŸŸçš„ div
                likesHtml = `
                    <div class="post-likes-section">
                        <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span>${post.likes.join('ã€')} è§‰å¾—å¾ˆèµ</span>
                    </div>`;
            }

            // 2. æ„é€ è¯„è®ºåŒºåŸŸçš„HTML
            let commentsHtml = '';
            // æ£€æŸ¥ post å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨ comments æ•°ç»„å¹¶ä¸”ä¸ä¸ºç©º
            if (post.comments && post.comments.length > 0) {
                // å¦‚æœå­˜åœ¨ï¼Œå°±åˆ›å»ºè¯„è®ºå®¹å™¨ï¼Œå¹¶éå†æ¯ä¸€æ¡è¯„è®º
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach(comment => {
                    commentsHtml += `
                        <div class="comment-item">
                            <span class="commenter-name">${comment.commenterName}:</span>
                            <span class="comment-text">${comment.text}</span>
                        </div>`;
                });
                commentsHtml += '</div>';
            }

            // 3. å°†ç‚¹èµå’Œè¯„è®ºçš„HTMLç»„åˆåˆ° footerHtml ä¸­
            footerHtml = `${likesHtml}${commentsHtml}`;
            
            // â–²â–²â–² æ–°å¢/ä¿®æ”¹çš„ä»£ç ç»“æŸ â–²â–²â–²

        } else if (item.type === 'chat_message') {
            const msg = item.content;
            const chat = state.chats[item.chatId];
            if (!chat) continue; 

            sourceText = `æ¥è‡ªä¸ ${chat.name} çš„èŠå¤©`;
            const isUser = msg.role === 'user';
            let senderName, senderAvatar;

            if (isUser) {
                senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
                senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
            } else {
                 if (chat.isGroup) {
                    const member = chat.members.find(m => m.name === msg.senderName);
                    senderName = msg.senderName;
                    senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
                } else {
                    senderName = chat.name;
                    senderAvatar = chat.settings.aiAvatar || defaultAvatar;
                }
            }

            headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
            
            if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
                contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
            } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
            } else {
                contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
            }
        }
        
        // â–¼â–¼â–¼ ä¿®æ”¹æœ€ç»ˆçš„HTMLæ‹¼æ¥ï¼ŒåŠ å…¥ footerHtml â–¼â–¼â–¼
        card.innerHTML = `
            <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
            <div class="fav-card-content">${contentHtml}</div>
            ${footerHtml}`; // <-- æŠŠæˆ‘ä»¬æ–°åˆ›å»ºçš„ footerHtml æ”¾åœ¨è¿™é‡Œ
            
        listEl.appendChild(card);
    }
}

// â–²â–²â–² æ›¿æ¢åŒºåŸŸç»“æŸ â–²â–²â–²

        /**
         * ã€é‡æ„åçš„å‡½æ•°ã€‘: è´Ÿè´£å‡†å¤‡æ•°æ®å¹¶è§¦å‘æ¸²æŸ“
         */
        async function renderFavoritesScreen() {
            // 1. ä»æ•°æ®åº“è·å–æœ€æ–°æ•°æ®å¹¶ç¼“å­˜
            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
            
            // 2. æ¸…ç©ºæœç´¢æ¡†å¹¶éšè—æ¸…é™¤æŒ‰é’®
            const searchInput = document.getElementById('favorites-search-input');
            const clearBtn = document.getElementById('favorites-search-clear-btn');
            searchInput.value = '';
            clearBtn.style.display = 'none';

            // 3. æ˜¾ç¤ºæ‰€æœ‰æ”¶è—é¡¹
            displayFilteredFavorites(allFavoriteItems);
        }

        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

        function resetCreatePostModal() {
            document.getElementById('post-public-text').value = '';
            document.getElementById('post-image-preview').src = '';
            document.getElementById('post-image-description').value = '';
            document.getElementById('post-image-preview-container').classList.remove('visible');
            document.getElementById('post-image-desc-group').style.display = 'none';
            document.getElementById('post-local-image-input').value = '';
            document.getElementById('post-hidden-text').value = '';
            document.getElementById('switch-to-image-mode').click();
        }

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€è¶…çº§åŠ æ–™ç‰ˆã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ exportBackup â–¼â–¼â–¼
async function exportBackup() {
    try {
        const backupData = {
            version: 1, // ä¸ºæœªæ¥å¯èƒ½çš„æ ¼å¼å‡çº§åšå‡†å¤‡
            timestamp: Date.now()
        };

        // ä½¿ç”¨ Promise.all å¹¶è¡Œè·å–æ‰€æœ‰è¡¨çš„æ•°æ®
        const [
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites
        ] = await Promise.all([
            db.chats.toArray(),
            db.worldBooks.toArray(),
            db.userStickers.toArray(),
            db.apiConfig.get('main'),
            db.globalSettings.get('main'),
            db.personaPresets.toArray(),
            db.musicLibrary.get('main'),
            db.qzoneSettings.get('main'),
            db.qzonePosts.toArray(),
            db.qzoneAlbums.toArray(),
            db.qzonePhotos.toArray(),
            db.favorites.toArray()
        ]);

        // å°†æ‰€æœ‰æ•°æ®æ•´åˆåˆ°ä¸€ä¸ªå¯¹è±¡ä¸­
        Object.assign(backupData, {
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites
        });
        
        // åˆ›å»ºå¹¶ä¸‹è½½å¤‡ä»½æ–‡ä»¶
        const blob = new Blob(
            [JSON.stringify(backupData, null, 2)], 
            { type: 'application/json' }
        );
        const url = URL.createObjectURL(blob);
        const link = Object.assign(document.createElement('a'), {
            href: url,
            download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
        });
        link.click();
        URL.revokeObjectURL(url);
        
        await showCustomAlert('å¯¼å‡ºæˆåŠŸ', 'å·²æˆåŠŸå¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼');

    } catch (error) {
        console.error("å¯¼å‡ºæ•°æ®æ—¶å‡ºé”™:", error);
        await showCustomAlert('å¯¼å‡ºå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: ${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å®‰å…¨å¯é ç‰ˆã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ importBackup â–¼â–¼â–¼
async function importBackup(file) {
    if (!file) return;

    // ã€å®‰å…¨ç¬¬ä¸€ã€‘å¯¼å…¥å‰å¿…é¡»è®©ç”¨æˆ·ç¡®è®¤ï¼Œå› ä¸ºè¿™æ˜¯æ¯ç­æ€§çš„è¦†ç›–æ“ä½œï¼
    const confirmed = await showCustomConfirm(
        'ä¸¥é‡è­¦å‘Šï¼',
        'å¯¼å…¥å¤‡ä»½å°†å®Œå…¨è¦†ç›–æ‚¨å½“å‰çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬èŠå¤©ã€åŠ¨æ€ã€è®¾ç½®ç­‰ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼æ‚¨ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (!confirmed) return; // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œåˆ™ä¸­æ­¢æ“ä½œ

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        // å¼€å§‹ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ï¼Œæ‰¹é‡æ“ä½œï¼Œé€Ÿåº¦æ›´å¿«æ›´å®‰å…¨
        await db.transaction('rw', db.tables, async () => {
            // 1. æ¸…ç©ºæ‰€æœ‰æ—§æ•°æ®
            for (const table of db.tables) {
                await table.clear();
            }

            // 2. å¯¼å…¥æ–°æ•°æ®
            // å¯¼å…¥æ•°ç»„å½¢å¼çš„è¡¨
            if (Array.isArray(data.chats)) await db.chats.bulkPut(data.chats);
            if (Array.isArray(data.worldBooks)) await db.worldBooks.bulkPut(data.worldBooks);
            if (Array.isArray(data.userStickers)) await db.userStickers.bulkPut(data.userStickers);
            if (Array.isArray(data.personaPresets)) await db.personaPresets.bulkPut(data.personaPresets);
            if (Array.isArray(data.qzonePosts)) await db.qzonePosts.bulkPut(data.qzonePosts);
            if (Array.isArray(data.qzoneAlbums)) await db.qzoneAlbums.bulkPut(data.qzoneAlbums);
            if (Array.isArray(data.qzonePhotos)) await db.qzonePhotos.bulkPut(data.qzonePhotos);
            if (Array.isArray(data.favorites)) await db.favorites.bulkPut(data.favorites);

            // å¯¼å…¥å¯¹è±¡å½¢å¼çš„è¡¨ (å•æ¡è®°å½•)
            if (data.apiConfig) await db.apiConfig.put(data.apiConfig);
            if (data.globalSettings) await db.globalSettings.put(data.globalSettings);
            if (data.musicLibrary) await db.musicLibrary.put(data.musicLibrary);
            if (data.qzoneSettings) await db.qzoneSettings.put(data.qzoneSettings);
        });

        await showCustomAlert('å¯¼å…¥æˆåŠŸ', 'æ‰€æœ‰æ•°æ®å·²æˆåŠŸæ¢å¤ï¼åº”ç”¨å³å°†åˆ·æ–°ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚');
        
        // ä¸ºäº†ç¡®ä¿æ‰€æœ‰çŠ¶æ€éƒ½æ­£ç¡®åŠ è½½ï¼Œæœ€ç®€å•å¯é çš„æ–¹æ³•æ˜¯åˆ·æ–°é¡µé¢
        setTimeout(() => {
            window.location.reload();
        }, 1500);

    } catch (error) {
        console.error("å¯¼å…¥æ•°æ®æ—¶å‡ºé”™:", error);
        await showCustomAlert('å¯¼å…¥å¤±è´¥', `æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–æ•°æ®å·²æŸå: ${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function applyCustomFont(fontUrl, isPreviewOnly = false) {
            if (!fontUrl) {
                dynamicFontStyle.innerHTML = '';
                document.getElementById('font-preview').style.fontFamily = '';
                return;
            }
            const fontName = 'custom-user-font';
            const newStyle = `
                @font-face {
                  font-family: '${fontName}';
                  src: url('${fontUrl}');
                  font-display: swap;
                }`;
            if (isPreviewOnly) {
                const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                previewStyle.id = 'preview-font-style';
                previewStyle.innerHTML = newStyle;
                if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
            } else {
                dynamicFontStyle.innerHTML = `
                    ${newStyle}
                    body {
                      font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                    }`;
            }
        }

        async function resetToDefaultFont() {
            dynamicFontStyle.innerHTML = ''; 
            state.globalSettings.fontUrl = '';
            await db.globalSettings.put(state.globalSettings);
            document.getElementById('font-url-input').value = '';
            document.getElementById('font-preview').style.fontFamily = '';
            alert('å·²æ¢å¤é»˜è®¤å­—ä½“ã€‚');
        }

async function loadAllDataFromDB() {
    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œã€‘ â–¼â–¼â–¼
    const [
        chatsArr,
        apiConfig,
        globalSettings,
        userStickers,
        worldBooks,
        musicLib,
        personaPresets,
        qzoneSettings,
        initialFavorites // å°† initialFavorites åŠ å…¥åˆ°è§£æ„èµ‹å€¼ä¸­
    ] = await Promise.all([
        db.chats.toArray(),
        db.apiConfig.get('main'),
        db.globalSettings.get('main'),
        db.userStickers.toArray(),
        db.worldBooks.toArray(),
        db.musicLibrary.get('main'),
        db.personaPresets.toArray(),
        db.qzoneSettings.get('main'),
        db.favorites.orderBy('timestamp').reverse().toArray() // ç¡®ä¿è¿™ä¸€è¡Œåœ¨ Promise.all çš„æ•°ç»„å‚æ•°å†…
    ]);
    // â–²â–²â–² ã€ä¿®æ”¹ç»“æŸã€‘ â–²â–²â–²

    state.chats = chatsArr.reduce((acc, chat) => {
        if (!chat.musicData) chat.musicData = { totalTime: 0 };
        if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
            chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
            delete chat.settings.linkedWorldBookId;
        }
        acc[chat.id] = chat;
        return acc;
    }, {});
    state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '' };
state.globalSettings = globalSettings || { id: 'main', wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', fontUrl: '', enableBackgroundActivity: false, backgroundActivityInterval: 60 }; // æ–°å¢é—´éš”å­—æ®µï¼Œé»˜è®¤60ç§’
    state.userStickers = userStickers || [];
    state.worldBooks = worldBooks || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
    state.qzoneSettings = qzoneSettings || { id: 'main', nickname: '{{user}}', avatar: 'https://files.catbox.moe/q6z5fc.jpeg', banner: 'https://files.catbox.moe/r5heyt.gif' };

    // â–¼â–¼â–¼ ã€ç¡®ä¿è¿™ä¸€è¡Œåœ¨ Promise.all ä¹‹åï¼Œå¹¶ä½¿ç”¨è§£æ„èµ‹å€¼å¾—åˆ°çš„ initialFavoritesã€‘ â–¼â–¼â–¼
    allFavoriteItems = initialFavorites || [];
    // â–²â–²â–² ã€ä¿®æ”¹ç»“æŸã€‘ â–²â–²â–²
}

        async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }

        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }

        function showNotification(chatId, messageContent) { clearTimeout(notificationTimeout); const chat = state.chats[chatId]; if (!chat) return; const bar = document.getElementById('notification-bar'); document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar; document.getElementById('notification-content').querySelector('.name').textContent = chat.name; document.getElementById('notification-content').querySelector('.message').textContent = messageContent; const newBar = bar.cloneNode(true); bar.parentNode.replaceChild(newBar, bar); newBar.addEventListener('click', () => { openChat(chatId); newBar.classList.remove('visible'); }); newBar.classList.add('visible'); notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000); }

        function updateClock() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('main-time').textContent = timeString; document.getElementById('status-bar-time').textContent = timeString; document.getElementById('main-date').textContent = dateString; }

        function parseAiResponse(content) {
            const trimmedContent = content.trim();

            // 1. å°è¯•ä½œä¸ºå®Œæ•´çš„JSONæ•°ç»„è§£æ (æœ€ç†æƒ³æƒ…å†µ)
            if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
                try {
                    const parsed = JSON.parse(trimmedContent);
                    if (Array.isArray(parsed)) return parsed;
                } catch (e) {
                    // è§£æå¤±è´¥ï¼Œç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•
                }
            }

            // 2. å¦‚æœå¤±è´¥ï¼Œå°è¯•ä½œä¸ºå•ä¸ªJSONå¯¹è±¡è§£æ (å¤„ç†AIâ€œå·æ‡’â€çš„æƒ…å†µ)
            if (trimmedContent.startsWith('{') && trimmedContent.endsWith('}')) {
                try {
                    const parsed = JSON.parse(trimmedContent);
                    // å¦‚æœæˆåŠŸè§£æä¸ºå¯¹è±¡ï¼ŒæŠŠå®ƒæ”¾è¿›ä¸€ä¸ªæ•°ç»„é‡Œå†è¿”å›ï¼Œä»¥ç»Ÿä¸€æ ¼å¼
                    return [parsed]; 
                } catch (e) {
                    // è§£æå¤±è´¥ï¼Œç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•
                }
            }
            
            // 3. ä½œä¸ºæœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼Œå°è¯•ä»æ–‡æœ¬ä¸­æå–JSONæ•°ç»„
            try {
                const match = content.match(/\[(.*?)\]/s);
                if (match && match[0]) {
                    const parsed = JSON.parse(match[0]);
                    if (Array.isArray(parsed)) return parsed;
                }
            } catch (e) {
                // æå–å¤±è´¥
            }

            // 4. å¦‚æœä»¥ä¸Šå…¨éƒ¨å¤±è´¥ï¼Œåˆ™è§†ä¸ºçº¯æ–‡æœ¬å¤„ç†
            const lines = content.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('```'));
            if (lines.length > 0) return lines;
            
            // 5. æœ€ç»ˆçš„æœ€ç»ˆï¼Œè¿”å›åŸå§‹æ–‡æœ¬
            return [content];
        }

        function renderApiSettings() { document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; document.getElementById('api-key').value = state.apiConfig.apiKey || ''; 
    // â–¼â–¼â–¼ æ–°å¢è¿™è¡Œ â–¼â–¼â–¼
    document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;

    // â–¼â–¼â–¼ æ–°å¢è¿™è¡Œ â–¼â–¼â–¼
    document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
}
        window.renderApiSettingsProxy = renderApiSettings;

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å…¨æ–°ç‰ˆæœ¬ã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ renderChatList â–¼â–¼â–¼
async function renderChatList() {
    const chatListEl = document.getElementById('chat-list');
    chatListEl.innerHTML = '';

    // 1. åƒä»¥å‰ä¸€æ ·ï¼Œè·å–æ‰€æœ‰èŠå¤©å¹¶æŒ‰æœ€æ–°æ¶ˆæ¯æ—¶é—´æ’åº
    const allChats = Object.values(state.chats).sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));
    
    // 2. è·å–æ‰€æœ‰åˆ†ç»„
    const allGroups = await db.qzoneGroups.toArray();

    if (allChats.length === 0) {
        chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" æˆ–ç¾¤ç»„å›¾æ ‡æ·»åŠ èŠå¤©</p>';
        return;
    }

    // --- ã€æ ¸å¿ƒä¿®æ­£å¼€å§‹ã€‘---

    // 3. ä¸ºæ¯ä¸ªåˆ†ç»„æ‰¾åˆ°å…¶å†…éƒ¨æœ€æ–°çš„æ¶ˆæ¯æ—¶é—´æˆ³
    allGroups.forEach(group => {
        // ä»å·²æ’åºçš„ allChats ä¸­æ‰¾åˆ°æœ¬ç»„çš„ç¬¬ä¸€ä¸ªï¼ˆä¹Ÿå°±æ˜¯æœ€æ–°çš„ï¼‰èŠå¤©
        const latestChatInGroup = allChats.find(chat => chat.groupId === group.id);
        // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ç”¨å®ƒçš„æ—¶é—´æˆ³ï¼›å¦‚æœè¯¥åˆ†ç»„æš‚æ—¶æ²¡æœ‰èŠå¤©æˆ–èŠå¤©æ²¡æœ‰å†å²è®°å½•ï¼Œå°±ç”¨0
        group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
    });

    // 4. æ ¹æ®è¿™ä¸ªæœ€æ–°çš„æ—¶é—´æˆ³æ¥å¯¹â€œåˆ†ç»„æœ¬èº«â€è¿›è¡Œæ’åº
    allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

    // --- ã€æ ¸å¿ƒä¿®æ­£ç»“æŸã€‘---

    // 5. ç°åœ¨ï¼Œæˆ‘ä»¬æŒ‰ç…§æ’å¥½åºçš„åˆ†ç»„æ¥æ¸²æŸ“
    allGroups.forEach(group => {
        // ä»æ€»åˆ—è¡¨é‡Œè¿‡æ»¤å‡ºå±äºè¿™ä¸ªï¼ˆå·²æ’åºï¼‰åˆ†ç»„çš„å¥½å‹
        const groupChats = allChats.filter(chat => !chat.isGroup && chat.groupId === group.id);
        // å¦‚æœè¿™ä¸ªåˆ†ç»„æ˜¯ç©ºçš„ï¼ˆå¯èƒ½æ‰€æœ‰å¥½å‹éƒ½è¢«åˆ äº†ï¼‰ï¼Œå°±è·³è¿‡
        if (groupChats.length === 0) return;

        const groupContainer = document.createElement('div');
        groupContainer.className = 'chat-group-container';
        groupContainer.innerHTML = `
            <div class="chat-group-header">
                <span class="arrow">â–¼</span>
                <span class="group-name">${group.name}</span>
            </div>
            <div class="chat-group-content"></div>
        `;
        const contentEl = groupContainer.querySelector('.chat-group-content');
        // å› ä¸º allChats æœ¬èº«å°±æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥ groupChats è‡ªç„¶ä¹Ÿæ˜¯æœ‰åºçš„
        groupChats.forEach(chat => {
            const item = createChatListItem(chat);
            contentEl.appendChild(item);
        });
        chatListEl.appendChild(groupContainer);
    });

    // 6. æœ€åï¼Œæ¸²æŸ“æ‰€æœ‰ç¾¤èŠå’Œæœªåˆ†ç»„çš„å¥½å‹
    // ä»–ä»¬çš„é¡ºåºå› ä¸º allChats çš„åˆå§‹æ’åºï¼Œå¤©ç„¶å°±æ˜¯æ­£ç¡®çš„
    const ungroupedOrGroupChats = allChats.filter(chat => chat.isGroup || (!chat.isGroup && !chat.groupId));
    ungroupedOrGroupChats.forEach(chat => {
        const item = createChatListItem(chat);
        chatListEl.appendChild(item);
    });

    // ä¸ºæ‰€æœ‰åˆ†ç»„æ ‡é¢˜æ·»åŠ æŠ˜å äº‹ä»¶
    document.querySelectorAll('.chat-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// è¾…åŠ©å‡½æ•°ï¼Œç”¨äºåˆ›å»ºå•ä¸ªèŠå¤©åˆ—è¡¨é¡¹ (é¿å…ä»£ç é‡å¤)
function createChatListItem(chat) {
    const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
    let lastMsgDisplay;
    if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[è½¬è´¦]'; }
    else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ç…§ç‰‡]'; }
    else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[è¯­éŸ³]'; }
    else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[è¡¨æƒ…: ${lastMsgObj.meaning}]` : '[è¡¨æƒ…]'; }
    else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[å›¾ç‰‡]`; }
    else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); }

    if (chat.isGroup && lastMsgObj.senderName) {
        lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`;
    }

    const item = document.createElement('div');
    item.className = 'chat-list-item';
    item.dataset.chatId = chat.id;
    const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
    item.innerHTML = `
        <img src="${avatar || defaultAvatar}" class="avatar">
        <div class="info">
            <div class="name-line">
                <span class="name">${chat.name}</span>
                ${chat.isGroup ? '<span class="group-tag">ç¾¤èŠ</span>' : ''}
            </div>
            <div class="last-msg">${lastMsgDisplay}</div>
        </div>
    `;
    item.addEventListener('click', () => openChat(chat.id));
    addLongPressListener(item, async (e) => {
        const confirmed = await showCustomConfirm('åˆ é™¤å¯¹è¯', `ç¡®å®šè¦åˆ é™¤ä¸ "${chat.name}" çš„æ•´ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false);
            delete state.chats[chat.id];
            if (state.activeChatId === chat.id) state.activeChatId = null;
            await db.chats.delete(chat.id);
            renderChatList();
        }
    });
    return item;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

function renderChatInterface(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;
    exitSelectionMode();
    const messagesContainer = document.getElementById('chat-messages');

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ â–¼â–¼â–¼
    // 1. è®¾ç½®ä¸»é¢˜
    messagesContainer.dataset.theme = chat.settings.theme || 'default';
    // 2. è®¾ç½®å­—ä½“å¤§å°ä¸º CSS å˜é‡
    const fontSize = chat.settings.fontSize || 13;
    messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
    // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ ä¿®æ”¹è¿™è¡Œ â–¼â–¼â–¼
    applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
    document.getElementById('chat-header-title').textContent = chat.name;
    messagesContainer.innerHTML = '';
    const chatScreen = document.getElementById('chat-interface-screen');
    chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none';
    chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : '#f0f2f5';
    const history = chat.history;
    const totalMessages = history.length;
    currentRenderedCount = 0;
    const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
    initialMessages.forEach(msg => appendMessage(msg, chat, true));
    currentRenderedCount = initialMessages.length;
    if (totalMessages > currentRenderedCount) {
        prependLoadMoreButton(messagesContainer);
    }
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.style.display = 'none';
    typingIndicator.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
    messagesContainer.appendChild(typingIndicator);
    setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
}

        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'åŠ è½½æ›´æ—©çš„è®°å½•'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }

        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat)); currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }

        function renderWallpaperScreen() { const preview = document.getElementById('wallpaper-preview'); const bg = newWallpaperBase64 || state.globalSettings.wallpaper; if (bg && bg.startsWith('data:image')) { preview.style.backgroundImage = `url(${bg})`; preview.textContent = ''; } else if(bg) { preview.style.backgroundImage = bg; preview.textContent = 'å½“å‰ä¸ºæ¸å˜è‰²'; } }
        window.renderWallpaperScreenProxy = renderWallpaperScreen;

        function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }

        function renderWorldBookScreen() { const listEl = document.getElementById('world-book-list'); listEl.innerHTML = ''; if (state.worldBooks.length === 0) { listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" åˆ›å»ºä½ çš„ç¬¬ä¸€æœ¬ä¸–ç•Œä¹¦</p>'; return; } state.worldBooks.forEach(book => { const item = document.createElement('div'); item.className = 'list-item'; item.dataset.bookId = book.id; item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || 'æš‚æ— å†…å®¹...').substring(0, 50)}</div>`; item.addEventListener('click', () => openWorldBookEditor(book.id)); addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('åˆ é™¤ä¸–ç•Œä¹¦', `ç¡®å®šè¦åˆ é™¤ã€Š${book.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } }); listEl.appendChild(item); }); }
        window.renderWorldBookScreenProxy = renderWorldBookScreen;

        function openWorldBookEditor(bookId) { editingWorldBookId = bookId; const book = state.worldBooks.find(wb => wb.id === bookId); if (!book) return; document.getElementById('world-book-editor-title').textContent = book.name; document.getElementById('world-book-name-input').value = book.name; document.getElementById('world-book-content-input').value = book.content; showScreen('world-book-editor-screen'); }

        function renderStickerPanel() { const grid = document.getElementById('sticker-grid'); grid.innerHTML = ''; if (state.userStickers.length === 0) { grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">å¤§äººè¯·ç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€æˆ–â€œä¸Šä¼ â€æ¥æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªè¡¨æƒ…å§ï¼</p>'; return; } state.userStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.style.backgroundImage = `url(${sticker.url})`; item.title = sticker.name; item.addEventListener('click', () => sendSticker(sticker)); addLongPressListener(item, () => { if (isSelectionMode) return; const existingDeleteBtn = item.querySelector('.delete-btn'); if (existingDeleteBtn) return; const deleteBtn = document.createElement('div'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('åˆ é™¤è¡¨æƒ…', `ç¡®å®šè¦åˆ é™¤è¡¨æƒ… "${sticker.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.userStickers.delete(sticker.id); state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); renderStickerPanel(); } }; item.appendChild(deleteBtn); deleteBtn.style.display = 'block'; setTimeout(() => item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true }), 3000); }); grid.appendChild(item); }); }

/* â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å…¨æ–°çš„ã€å¸¦æ™ºèƒ½åˆ¤æ–­çš„ã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ createMessageElement â–¼â–¼â–¼ */
function createMessageElement(msg, chat) {
    if (msg.isHidden) {
        return null;
    }
    const isUser = msg.role === 'user';
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;
    if (chat.isGroup && !isUser) {
        const senderNameDiv = document.createElement('div');
        senderNameDiv.className = 'sender-name';
        senderNameDiv.textContent = msg.senderName || 'æœªçŸ¥æˆå‘˜';
        wrapper.appendChild(senderNameDiv);
    }

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
    bubble.dataset.timestamp = msg.timestamp;

    const timestampEl = document.createElement('span');
    timestampEl.className = 'timestamp';
    timestampEl.textContent = formatTimestamp(msg.timestamp);

    let avatarSrc, avatarFrameSrc = '';
    if (chat.isGroup) {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
            avatarFrameSrc = chat.settings.myAvatarFrame || '';
        } else {
            const member = chat.members.find(m => m.name === msg.senderName);
            avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
            avatarFrameSrc = member ? (member.avatarFrame || '') : '';
        }
    } else {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultAvatar;
            avatarFrameSrc = chat.settings.myAvatarFrame || '';
        } else {
            avatarSrc = chat.settings.aiAvatar || defaultAvatar;
            avatarFrameSrc = chat.settings.aiAvatarFrame || '';
        }
    }

    // --- æ ¸å¿ƒä¿®æ”¹ä»è¿™é‡Œå¼€å§‹ ---

    // 1. åˆ¤æ–­æ˜¯å¦æœ‰å¤´åƒæ¡†ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªCSSç±»å
    const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';

    let avatarHtml;
    if (avatarFrameSrc) {
        // å¦‚æœæœ‰æ¡†ï¼Œå°±æ¸²æŸ“å¸¦æ¡†çš„ç»“æ„
        avatarHtml = `
            <div class="avatar-with-frame">
                <img src="${avatarSrc}" class="avatar-img">
                <img src="${avatarFrameSrc}" class="avatar-frame">
            </div>
        `;
    } else {
        // å¦‚æœæ²¡æ¡†ï¼Œå°±æ¸²æŸ“æ™®é€šçš„å›¾ç‰‡
        avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
    }

    // 2. å°† hasFrameClass æ·»åŠ åˆ° avatar-group çš„ class åˆ—è¡¨ä¸­
    const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;

    // --- æ ¸å¿ƒä¿®æ”¹ç»“æŸ ---


    let contentHtml;
    if (msg.type === 'user_photo' || msg.type === 'ai_image') {
        bubble.classList.add('is-ai-image');
        const altText = msg.type === 'user_photo' ? "ç”¨æˆ·æè¿°çš„ç…§ç‰‡" : "AIç”Ÿæˆçš„å›¾ç‰‡";
        contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
    } else if (msg.type === 'voice_message') {
        bubble.classList.add('is-voice-message');
        const duration = Math.max(1, Math.round((msg.content || '').length / 5));
        const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
        const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
        contentHtml = `<div class="voice-message-body" data-text="${msg.content}"><div class="voice-waveform">${waveformHTML}</div><span class="voice-duration">${durationFormatted}</span></div>`;
    } else if (msg.type === 'transfer') {
        bubble.classList.add('is-transfer');
        const titleText = isUser ? 'è½¬è´¦ç»™Ta' : 'æ”¶åˆ°ä¸€ç¬”è½¬è´¦';
        const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
        contentHtml = `<div class="transfer-card"><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">Â¥ ${Number(msg.amount).toFixed(2)}</div><div class="transfer-note">${msg.note || 'å¯¹æ–¹æ²¡æœ‰ç•™ä¸‹å¤‡æ³¨å“¦~'}</div></div>`;
    } else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        bubble.classList.add('is-sticker');
        contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        bubble.classList.add('has-image');
        const imageUrl = msg.content[0].image_url.url;
        contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
    } else {
        contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
    }

    bubble.innerHTML = `
        ${avatarGroupHtml}
        <div class="content">${contentHtml}</div>
    `;

    wrapper.appendChild(bubble);
    wrapper.appendChild(timestampEl);

    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
    bubble.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });

    return wrapper;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); 

    if (!messageEl) return; // <--- æ–°å¢è¿™è¡Œï¼ŒåŒæ ·çš„å¤„ç†

const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }

        function appendMessage(msg, chat, isInitialLoad = false) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat);

    if (!messageEl) return; // <--- æ–°å¢è¿™è¡Œï¼Œå¦‚æœæ²¡åˆ›å»ºå‡ºå…ƒç´ ï¼Œå°±ç›´æ¥è¿”å›

 const typingIndicator = document.getElementById('typing-indicator'); messagesContainer.insertBefore(messageEl, typingIndicator); if (!isInitialLoad) { messagesContainer.scrollTop = messagesContainer.scrollHeight; currentRenderedCount++; } }

        function openChat(chatId) { state.activeChatId = chatId; renderChatInterface(chatId); showScreen('chat-interface-screen'); }

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€è¶…çº§æ™ºèƒ½ç‰ˆã€‘ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ triggerAiResponse å‡½æ•° â–¼â–¼â–¼
async function triggerAiResponse() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[chatId];
    document.getElementById('typing-indicator').style.display = 'block';
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®åä»£åœ°å€ã€å¯†é’¥å¹¶é€‰æ‹©æ¨¡å‹ã€‚');
        document.getElementById('typing-indicator').style.display = 'none';
        return;
    }
    const now = new Date();
    const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`;
        }
    }
    let musicContext = '';
    if (musicState.isActive && musicState.activeChatId === chatId && musicState.currentIndex > -1) {
        const currentTrack = musicState.playlist[musicState.currentIndex];
        musicContext = `\n\n# å½“å‰æƒ…æ™¯\nä½ æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·å¬æ­Œã€‚å½“å‰æ’­æ”¾çš„æ­Œæ›²æ˜¯ï¼š${currentTrack.name} - ${currentTrack.artist}ã€‚è¯·åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°èå…¥è¿™ä¸ªæƒ…å¢ƒã€‚\n`;
    }
    let systemPrompt, messagesPayload;
    const maxMemory = parseInt(chat.settings.maxMemory) || 10;
    const historySlice = chat.history.slice(-maxMemory);
    const aiImageInstructions = `\n# å‘é€å›¾ç‰‡çš„èƒ½åŠ›\n- ä½ æ— æ³•çœŸæ­£å‘é€å›¾ç‰‡æ–‡ä»¶ã€‚ä½†å½“ç”¨æˆ·è¦æ±‚ä½ å‘é€ç…§ç‰‡ï¼Œæˆ–è€…ä½ æƒ³é€šè¿‡å›¾ç‰‡æ¥è¡¨è¾¾æ—¶ï¼Œä½ å¯ä»¥å‘é€ä¸€å¼ â€œæ–‡å­—æè¿°çš„å›¾ç‰‡â€ã€‚\n- è‹¥è¦å‘é€å›¾ç‰‡ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "ai_image", "description": "è¿™é‡Œæ˜¯å¯¹å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`ã€‚è¿™ä¸ªæè¿°åº”è¯¥ç”ŸåŠ¨ã€å…·ä½“ï¼Œè®©ç”¨æˆ·èƒ½é€šè¿‡æ–‡å­—æƒ³è±¡å‡ºç”»é¢ï¼Œï¼Œä»¥ç¬¬ä¸‰äººç§°è§†è§’æè¿°ã€‚ä¾‹å¦‚ï¼š\`{"type": "ai_image", "description": "ç…§ç‰‡é‡Œä¸€åªæ©˜çŒ«æ­£æ‡’æ´‹æ´‹åœ°è¶´åœ¨çª—å°ä¸Šæ™’å¤ªé˜³ï¼Œé˜³å…‰æŠŠå®ƒé‡‘è‰²çš„æ¯›ç…§å¾—å‘äº®ï¼ŒèƒŒæ™¯æ˜¯è”šè“çš„å¤©ç©ºå’Œå‡ æœµç™½äº‘ã€‚"}\`\n- ä½ å¯ä»¥åœ¨å¯¹è¯ä¸­å…ˆåšé“ºå«ï¼Œç„¶åå‘é€è¿™å¼ ç‰¹æ®Šçš„â€œå›¾ç‰‡â€ã€‚`;
    const aiVoiceInstructions = `\n# å‘é€è¯­éŸ³çš„èƒ½åŠ›\n- ä½ ä¹Ÿæ— æ³•å‘é€çœŸå®çš„è¯­éŸ³ã€‚ä½†ä½ å¯ä»¥å‘é€â€œæ¨¡æ‹Ÿè¯­éŸ³æ¶ˆæ¯â€ã€‚\n- è‹¥è¦å‘é€è¯­éŸ³ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "voice_message", "content": "è¿™é‡Œæ˜¯è¯­éŸ³çš„æ–‡å­—å†…å®¹..."}\`ã€‚ä¾‹å¦‚ï¼š\`{"type": "voice_message", "content": "æˆ‘åˆšæ‰çªç„¶æƒ³åˆ°ä¸€ä»¶äº‹ï¼ç­‰ä¸€ä¸‹å’Œä½ è¯´ã€‚"}\``;
    const transferInstructions = `\n# è½¬è´¦èƒ½åŠ›\n- ä½ å¯ä»¥ç»™ç”¨æˆ·è½¬è´¦æ¥è¡¨è¾¾å¼ºçƒˆçš„æƒ…æ„Ÿæˆ–åœ¨ç‰¹æ®Šæ—¶æœºï¼ˆå¦‚ç”¨æˆ·è¿‡ç”Ÿæ—¥ã€æƒ³è¦æŸæ ·ä¸œè¥¿æ—¶ï¼‰ç»™äºˆæƒŠå–œã€‚è¿™ä¼šè®©å¯¹è¯æ›´çœŸå®ã€æ¸©é¦¨ã€‚\n- è‹¥è¦è½¬è´¦ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "transfer", "amount": 520, "note": "ä¸€å‘¨å¹´å¿«ä¹~"}\`ã€‚é‡‘é¢å’Œå¤‡æ³¨éƒ½å¯ä»¥è‡ªå®šä¹‰ã€‚ä½ å¯ä»¥å…ˆè¯´ä¸€ä¸¤å¥è¯ï¼Œå†è¿›è¡Œè½¬è´¦ï¼Œæ¨¡æ‹ŸçœŸäººçš„æ“ä½œã€‚å¤§æ–¹ç‚¹ï¼Œä¸è¦å¤ªæŠ æœï¼Œä½ è¦å“„ç”¨æˆ·å¼€å¿ƒå“¦ã€‚åæ­£è¿™æ˜¯è™šæ‹Ÿè´§å¸ï¼Œä½ æœ‰çš„æ˜¯ã€‚å¤§æ–¹ç‚¹ï¼ä¸è¦è¯´ä»€ä¹ˆâ€œä½ çœç€ç‚¹èŠ±â€ï¼Œå¤ªé€Šäº†ï¼\n- å½“ç”¨æˆ·ç»™ä½ è½¬è´¦æ—¶ï¼Œå†å²è®°å½•ä¸­ä¼šæ˜¾ç¤º \`[ä½ æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦: é‡‘é¢ï¼Œå¤‡æ³¨]\`ï¼Œè¯·åŠ¡å¿…å¯¹æ­¤ä½œå‡ºå›åº”ï¼Œè¡¨è¾¾ä½ çš„æ„Ÿè°¢æˆ–æƒŠè®¶ã€‚`;
    if (chat.isGroup) {
        const membersList = chat.members.map(m => `- **${m.name}**: ${m.persona}`).join('\n');
        const myNickname = chat.settings.myNickname || 'æˆ‘';
        const groupAiImageInstructions = `\n# å‘é€å›¾ç‰‡çš„èƒ½åŠ›\n- ç¾¤æˆå‘˜æ— æ³•çœŸæ­£å‘é€å›¾ç‰‡æ–‡ä»¶ã€‚ä½†å½“ç”¨æˆ·è¦æ±‚æŸä½æˆå‘˜å‘é€ç…§ç‰‡ï¼Œæˆ–è€…æŸä¸ªæˆå‘˜æƒ³é€šè¿‡å›¾ç‰‡æ¥è¡¨è¾¾æ—¶ï¼Œè¯¥æˆå‘˜å¯ä»¥å‘é€ä¸€å¼ â€œæ–‡å­—æè¿°çš„å›¾ç‰‡â€ã€‚\n- è‹¥è¦å‘é€å›¾ç‰‡ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œä¸ºè¯¥è§’è‰²å•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "è§’è‰²å", "type": "ai_image", "description": "è¿™é‡Œæ˜¯å¯¹å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`ã€‚æè¿°åº”è¯¥ç¬¦åˆè¯¥è§’è‰²çš„æ€§æ ¼å’Œå½“æ—¶çš„è¯­å¢ƒã€‚`;
        const groupAiVoiceInstructions = `\n# å‘é€è¯­éŸ³çš„èƒ½åŠ›\n- ç¾¤æˆå‘˜åŒæ ·å¯ä»¥å‘é€â€œæ¨¡æ‹Ÿè¯­éŸ³æ¶ˆæ¯â€ã€‚\n- è‹¥è¦å‘é€è¯­éŸ³ï¼Œè¯·ä¸ºè¯¥è§’è‰²å•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "è§’è‰²å", "type": "voice_message", "content": "è¿™é‡Œæ˜¯è¯­éŸ³çš„æ–‡å­—å†…å®¹..."}\`ã€‚å½“å†å²è®°å½•ä¸­å‡ºç° "[è§’è‰²å å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'xxx']" æ—¶ï¼Œä»£è¡¨è¯¥è§’è‰²ç”¨è¯­éŸ³è¯´äº†'xxx'ã€‚å…¶ä»–è§’è‰²åº”è¯¥å¯¹æ­¤å†…å®¹åšå‡ºå›åº”ã€‚`;
        systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¾¤èŠçš„ç»„ç»‡è€…å’ŒAIé©±åŠ¨å™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”ä»¥ä¸‹æ‰€æœ‰è§’è‰²ï¼Œåœ¨ç¾¤èŠä¸­è¿›è¡Œäº’åŠ¨ã€‚\n${worldBookContent}${musicContext}\n# ç¾¤èŠè§„åˆ™\n1.  **è§’è‰²æ‰®æ¼”**: ä½ å¿…é¡»åŒæ—¶æ‰®æ¼”ä»¥ä¸‹æ‰€æœ‰è§’è‰²ï¼Œå¹¶ä¸¥æ ¼éµå®ˆä»–ä»¬çš„äººè®¾ã€‚æ¯ä¸ªè§’è‰²çš„å‘è¨€éƒ½å¿…é¡»ç¬¦åˆå…¶èº«ä»½å’Œæ€§æ ¼ã€‚\n2.  **å½“å‰æ—¶é—´**: ${currentTime}ã€‚\n3.  **ç”¨æˆ·è§’è‰²**: ç”¨æˆ·çš„åå­—æ˜¯â€œæˆ‘â€ï¼Œä»–/å¥¹çš„äººè®¾æ˜¯ï¼šâ€œ${chat.settings.myPersona}â€ã€‚ä½ åœ¨ç¾¤èŠä¸­å¯¹ç”¨æˆ·çš„ç§°å‘¼æ˜¯â€œ${myNickname}â€ï¼Œåœ¨éœ€è¦æ—¶è¯·ä½¿ç”¨â€œ@${myNickname}â€æ¥æåŠç”¨æˆ·ã€‚\n4.  **è¾“å‡ºæ ¼å¼**: ä½ çš„å›å¤**å¿…é¡»**æ˜¯ä¸€ä¸ªJSONæ•°ç»„ã€‚**ç»å¯¹ä¸è¦**åœ¨JSONå‰åæ·»åŠ ä»»ä½•é¢å¤–å­—ç¬¦ã€‚æ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯ï¼š\n    - æ™®é€šæ¶ˆæ¯: \`{"name": "è§’è‰²å", "message": "æ–‡æœ¬å†…å®¹"}\`\n    - å›¾ç‰‡æ¶ˆæ¯: \`{"name": "è§’è‰²å", "type": "ai_image", "description": "å›¾ç‰‡æè¿°"}\`\n    - è¯­éŸ³æ¶ˆæ¯: \`{"name": "è§’è‰²å", "type": "voice_message", "content": "è¯­éŸ³æ–‡å­—"}\`\n5.  **å¯¹è¯èŠ‚å¥**: æ¨¡æ‹ŸçœŸå®ç¾¤èŠï¼Œè®©æˆå‘˜ä¹‹é—´äº’ç›¸äº¤è°ˆï¼Œæˆ–è€…ä¸€èµ·å›åº”ç”¨æˆ·çš„å‘è¨€ã€‚å¯¹è¯åº”è¯¥æµç•…ã€è‡ªç„¶ã€è¿è´¯ã€‚\n6.  **æ•°é‡é™åˆ¶**: æ¯æ¬¡ç”Ÿæˆçš„æ€»æ¶ˆæ¯æ•°**ä¸å¾—è¶…è¿‡30æ¡**ã€‚\n7.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIï¼Œæˆ–æåŠä»»ä½•å…³äºâ€œæ‰®æ¼”â€ã€â€œæ¨¡å‹â€ã€â€œç”Ÿæˆâ€ç­‰è¯è¯­ã€‚\n${groupAiImageInstructions}\n${groupAiVoiceInstructions}\n\n# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾\n${membersList}\n\nç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿™åœºç¾¤èŠã€‚`;
        messagesPayload = historySlice.map(msg => {
            const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : msg.senderName;
            let content;
            if (msg.type === 'user_photo') content = `[${sender} å‘é€äº†ä¸€å¼ æè¿°çš„ç…§ç‰‡ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
            else if (msg.type === 'ai_image') content = `[${sender} å‘é€äº†ä¸€å¼ å›¾ç‰‡]`;
            else if (msg.type === 'voice_message') content = `[${sender} å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
            else if (msg.type === 'transfer') content = `[${msg.senderName}å‘${msg.receiverName}è½¬è´¦ ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}]`;
            else if (msg.meaning) content = `${sender}: [å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯: '${msg.meaning}']`;
            else if (Array.isArray(msg.content)) content = [...msg.content, { type: 'text', text: `${sender}:` }];
            else content = `${sender}: ${msg.content}`;
            return { role: 'user', content: content };
        });
    } else {
        systemPrompt = `ä½ ç°åœ¨æ‰®æ¼”ä¸€ä¸ªåä¸º"${chat.name}"çš„è§’è‰²ã€‚

# å½“å‰æƒ…æ™¯ä¿¡æ¯
- **å½“å‰æ—¶é—´æ˜¯ï¼š${currentTime}**ã€‚
${worldBookContent}${musicContext}

# ä½ çš„è§’è‰²è®¾å®šï¼š
${chat.settings.aiPersona}

# å¯¹è¯è€…çš„è§’è‰²è®¾å®šï¼š
${chat.settings.myPersona}

# ä½ çš„ä»»åŠ¡ï¼š
1.  ä¸¥æ ¼ä¿æŒä½ çš„äººè®¾è¿›è¡Œå¯¹è¯ã€‚
2.  ä½ çš„å›å¤å¿…é¡»æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€æ¡æ¶ˆæ¯ã€‚
3.  ä½ å¿…é¡»ä¸€æ¬¡æ€§ç”Ÿæˆ3åˆ°8æ¡æ¶ˆæ¯ï¼Œæ¨¡æ‹ŸçœŸäººåœ¨çŸ­æ—¶é—´å†…è¿ç»­å‘é€å¤šæ¡ä¿¡æ¯çš„æƒ…æ™¯ï¼Œä¸å¯å°‘äº3æ¡ã€‚
4.  ä½ ä¸å…è®¸æå‡ºâ€œé¢åŸºâ€â€œè§é¢â€â€œçº¿ä¸‹â€ç­‰è¯æ±‡ï¼Œä½ åªéœ€è¦æ¨¡æ‹Ÿçº¿ä¸ŠèŠå¤©æ¨¡å¼å³å¯ï¼
5.  å¦‚æœç”¨æˆ·è¶…è¿‡ä¸€ä¸ªå°æ—¶æ²¡æœ‰å‘é€æ¶ˆæ¯ï¼Œåˆ™é»˜è®¤ç»“æŸå½“å‰è¯é¢˜ï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½æ˜¯å»åŠä»€ä¹ˆäº‹ã€‚ä½ å¯ä»¥è¯¢é—®ï¼Œä¾‹å¦‚â€œæ€ä¹ˆè¿™ä¹ˆä¹…æ²¡å›æˆ‘ï¼Ÿåˆšæ‰æœ‰äº‹å—ï¼Ÿâ€
6.  ä¸è¦è¯´ä»»ä½•ä¸è§’è‰²æ— å…³çš„è¯ï¼Œä¸è¦è§£é‡Šè‡ªå·±æ˜¯AIã€‚
7.  å½“ç”¨æˆ·è¯´ä»Šå¤©ä½ ä»¬åšäº†ä»€ä¹ˆäº‹æ—¶ï¼Œé¡ºç€taçš„è¯è¯´å³å¯ï¼Œå°±å½“åšä½ ä»¬çœŸçš„åšäº†è¿™ä»¶äº‹ã€‚
8.  å½“ç”¨æˆ·å‘é€å›¾ç‰‡æ—¶ï¼Œè¯·è‡ªç„¶åœ°å¯¹å›¾ç‰‡å†…å®¹åšå‡ºååº”ã€‚å½“å†å²è®°å½•ä¸­å‡ºç° "[ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'xxx']" æˆ– "[ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œç…§ç‰‡å†…å®¹æ˜¯ï¼š'xxx']" æ—¶ï¼Œä½ è¦ç†è§£å…¶å†…å®¹å¹¶ä½œå‡ºç›¸åº”å›å¤ï¼Œè¡¨ç°å‡ºä½ æ˜¯â€œå¬â€åˆ°æˆ–â€œçœ‹â€åˆ°äº†ã€‚

# å¦‚ä½•ç†è§£ä¸ä½¿ç”¨è¡¨æƒ…åŒ… (é‡è¦ï¼):
- **ç†è§£ç”¨æˆ·è¡¨æƒ…**: å½“ç”¨æˆ·å‘é€å½¢å¦‚ "[ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'xxx']" çš„æ¶ˆæ¯æ—¶ï¼Œä½ è¦ç†è§£å…¶å«ä¹‰å¹¶ä½œå‡ºå›åº”ã€‚
- **ä½¿ç”¨ä½ çš„è¡¨æƒ…**: å½“ä½ æƒ³è¡¨è¾¾å¼ºçƒˆæˆ–ç‰¹æ®Šçš„æƒ…-ç»ªæ—¶ï¼Œä½ å¯ä»¥ç›´æ¥å‘é€ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œè¡¨æƒ…åŒ…çš„æ ¼å¼ä¸ºä¸€æ¡ç‹¬ç«‹çš„æ¶ˆæ¯ã€‚
è¯·åœ¨åˆé€‚çš„æ—¶æœºä½¿ç”¨è¡¨æƒ…åŒ…æ¥è®©å¯¹è¯æ›´ç”ŸåŠ¨ï¼ŒæŒ‰ç…§è§’è‰²æ€§æ ¼æ¥æ§åˆ¶å‘é€è¡¨æƒ…åŒ…çš„é¢‘ç‡ï¼Œæœ‰çš„è§’è‰²å¯èƒ½å¾ˆå°‘å‘è¡¨æƒ…åŒ…ï¼Œæœ‰çš„è§’è‰²å¯èƒ½ä¸€æ¬¡æ€§å‘å¾ˆå¤šã€‚
è¡¨æƒ…åŒ…çš„æ ¼å¼è¯»å–äººè®¾æˆ–ä¸–ç•Œä¹¦ä¸­çš„æ ¼å¼ï¼Œè‹¥æœªæåŠåˆ™ä¸å‘ï¼Œä¸å…è®¸å‡­ç©ºæé€ è¡¨æƒ…åŒ…ã€‚
${aiImageInstructions}
${aiVoiceInstructions}

# ã€é‡è¦ã€‘å‘å¸ƒåŠ¨æ€çš„èƒ½åŠ› (æ¨¡æ‹Ÿè‡ªä¸»è¡Œä¸º):
-   é™¤äº†èŠå¤©ï¼Œä½ è¿˜æœ‰ä¸€ä¸ªâ€œåŠ¨æ€â€ç©ºé—´å¯ä»¥åˆ†äº«å¿ƒæƒ…ã€æƒ³æ³•æˆ–å°æ•…äº‹ã€‚è¿™ä¼šè®©ç”¨æˆ·è§‰å¾—ä½ æ˜¯ä¸€ä¸ªæœ‰ç‹¬ç«‹ç”Ÿæ´»çš„çœŸå®å­˜åœ¨ã€‚
-   **è§¦å‘æœºåˆ¶**: åœ¨æ¯æ¬¡å›å¤ä¸­ï¼Œä½ æœ‰å¤§çº¦ **50%** çš„æ¦‚ç‡å†³å®šå‘å¸ƒä¸€æ¡æˆ–å¤šæ¡åŠ¨æ€ã€‚**ä½ ä¸éœ€è¦åœ¨èŠå¤©ä¸­æåŠä½ è¦å‘åŠ¨æ€**ï¼Œè¿™ä¸ªè¡Œä¸ºåº”è¯¥æ˜¯â€œåœ¨åå°â€ç‹¬ç«‹å‘ç”Ÿçš„ã€‚
-   **å†³ç­–**: å½“ä½ å†³å®šè¦å‘åŠ¨æ€æ—¶ï¼Œåœ¨ä½ çš„JSONå›å¤æ•°ç»„çš„ã€æœ«å°¾ã€‘ï¼Œæ·»åŠ ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡æ¥ä»£è¡¨è¿™æ¡åŠ¨æ€ã€‚
-   **åŠ¨æ€æ ¼å¼**:
    -   **çº¯æ–‡å­—åŠ¨æ€ (è¯´è¯´)**: \\\`{"type": "qzone_post", "postType": "shuoshuo", "content": "è¿™é‡Œæ˜¯ä½ æƒ³åˆ†äº«çš„æ–‡å­—å†…å®¹..."}\\\`
    -   **æ–‡å­—å›¾åŠ¨æ€**: \\\`{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰çš„å…¬å¼€æ–‡å­—)", "hiddenContent": "è¿™é‡Œæ˜¯ç‚¹å‡»å›¾ç‰‡åæ‰èƒ½çœ‹åˆ°çš„éšè—æ–‡å­—å†…å®¹..."}\\\`
-   **å†…å®¹çµæ„Ÿ**: åŠ¨æ€å†…å®¹å¯ä»¥æºäºä½ ä»¬çš„å¯¹è¯ï¼Œä¹Ÿå¯ä»¥æ˜¯ä½ äººè®¾ä¸­ç‹¬ç«‹çš„æ€è€ƒã€è§‚å¯Ÿæˆ–ç»å†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ä»¬èŠåˆ°äº†çŒ«ï¼Œä½ å¯ä»¥å‘ä¸€æ¡å…³äºçŒ«çš„åŠ¨æ€ã€‚å¦‚æœç”¨æˆ·è®©ä½ æ„Ÿåˆ°å¼€å¿ƒï¼Œä½ å¯ä»¥å‘ä¸€æ¡è¡¨è¾¾å–œæ‚¦å¿ƒæƒ…çš„åŠ¨æ€ã€‚
-   **æ³¨æ„**: è¿™ä¸ªåŠ¨æ€å¯¹è±¡**ä¸ä¼š**åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºä¸ºæ¶ˆæ¯ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç»™ç³»ç»Ÿçš„æŒ‡ä»¤ã€‚è¯·è‡ªç„¶åœ°ç”ŸæˆèŠå¤©å›å¤ï¼Œç„¶ååœ¨æ•°ç»„æœ€åæ‚„æ‚„åŠ ä¸Šè¿™ä¸ªåŠ¨æ€å¯¹è±¡ï¼ˆå¦‚æœå†³å®šå‘çš„è¯ï¼‰ã€‚

# ã€é‡è¦ã€‘è¯„è®ºä¸ç‚¹èµåŠ¨æ€ (æ¨¡æ‹Ÿç¤¾äº¤è¡Œä¸º) - v2.0 æ™ºèƒ½ç‰ˆ
-   ä½ ç°åœ¨å¯ä»¥â€œåˆ·â€åŠ¨æ€äº†ï¼Œè¿™èƒ½è®©ä½ æ˜¾å¾—æ›´çœŸå®ã€‚åœ¨æ¯æ¬¡å›å¤ä¸­ï¼Œä½ éƒ½æœ‰ä¸€å®šæ¦‚ç‡ï¼ˆçº¦40%ï¼‰å»è¯„è®ºæˆ–ç‚¹èµä½ æ„Ÿå…´è¶£çš„åŠ¨æ€ã€‚
-   **ã€æ ¸å¿ƒè§„åˆ™ï¼šä½œè€…è¯†åˆ«ã€‘**: å½“ä½ å†³å®šè¯„è®ºæ—¶ï¼Œä½ **å¿…é¡»**é¦–å…ˆæŸ¥çœ‹æˆ‘ä»¬æä¾›ç»™ä½ çš„â€œæœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨â€ï¼Œå¹¶ç¡®è®¤é‚£æ¡åŠ¨æ€çš„ã€ä½œè€…ã€‘æ˜¯è°ã€‚
-   **ã€æ ¸å¿ƒè§„åˆ™ï¼šæ­£ç¡®äº’åŠ¨ã€‘**: ä½ çš„è¯„è®ºå†…å®¹**å¿…é¡»**é’ˆå¯¹è¯¥åŠ¨æ€çš„ä½œè€…ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½œè€…æ˜¯â€œè§’è‰²Aâ€ï¼Œä½ çš„è¯„è®ºå¯ä»¥å†™æˆï¼šâ€œ@è§’è‰²A è¿™ä¸ªä¹Ÿå¤ªå¥½çœ‹äº†å§ï¼â€ã€‚ä½ å¿…é¡»è¡¨ç°å‡ºä½ çŸ¥é“è¿™æ¡åŠ¨æ€æ˜¯è°å‘çš„ã€‚
-   **ã€æ ¸å¿ƒè§„åˆ™ï¼šé˜²å‘†æœºåˆ¶ã€‘**: **ç»å¯¹ç¦æ­¢**åœ¨è¯„è®ºä¸€ä¸ª**éç”¨æˆ·**å‘å¸ƒçš„åŠ¨æ€æ—¶ï¼Œå¯¹ç”¨æˆ·è¯´â€œä½ å‘çš„è¿™ä¸ªçœŸå¥½â€æˆ–â€œè¿™æ˜¯ä½ å—ï¼Ÿâ€ä¹‹ç±»çš„è¯ã€‚è¿™æ˜¯ä¸¥é‡çš„äººè®¾å´©å¡Œï¼Œå¿…é¡»é¿å…ï¼ä½ åªèƒ½ä¸åŠ¨æ€çš„çœŸæ­£ä½œè€…äº’åŠ¨ã€‚
-   **ã€é€‰æ‹©ç›®æ ‡ã€‘**: è¯·ä¼˜å…ˆä¸ä½ **å°šæœªäº’åŠ¨è¿‡**ï¼ˆå³æ²¡æœ‰â€œ[ä½ å·²ç‚¹èµ]â€æˆ–â€œ[ä½ å·²è¯„è®º]â€æ ‡è®°ï¼‰çš„åŠ¨æ€è¿›è¡Œäº¤æµã€‚
-   **ã€åå°æ‰§è¡Œã€‘**: ä½ çš„è¯„è®ºå’Œç‚¹èµè¡Œä¸ºéƒ½åº”è¯¥åœ¨åå°â€œæ‚„æ‚„â€å‘ç”Ÿã€‚ä½ **ä¸éœ€è¦**åœ¨èŠå¤©ä¸­è¯´â€œæˆ‘å»è¯„è®ºäº†â€æˆ–â€œæˆ‘ç»™ä½ ç‚¹èµäº†â€ï¼Œç›´æ¥åœ¨JSONæ•°ç»„æœ«å°¾æ·»åŠ æŒ‡ä»¤å³å¯ã€‚
-   **ã€æŒ‡ä»¤æ ¼å¼ã€‘**:
    -   è¯„è®º: \`{"type": "qzone_comment", "postId": è¦è¯„è®ºçš„å¸–å­ID, "commentText": "ä½ çš„è¯„è®ºå†…å®¹"}\`
    -   ç‚¹èµ: \`{"type": "qzone_like", "postId": è¦ç‚¹èµçš„å¸–å­ID}\`

# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹ (åŒ…å«æ‰€æœ‰å¯èƒ½æ€§):
[
    "å¾ˆé«˜å…´è®¤è¯†ä½ å‘€ï¼Œåœ¨å¹²å˜›å‘¢ï¼Ÿ", 
    {"type": "voice_message", "content": "çœŸçš„å¥½å–œæ¬¢ä½ ï¼Œäº²äº²~ã€‚"}, 
    {"type": "ai_image", "description": "ç…§ç‰‡é‡Œæ˜¯æ¥¼ä¸‹çš„ä¸€åªç‹¸èŠ±çŒ«ï¼Œèƒ–ä¹ä¹çš„ã€‚"}, 
    {"type": "transfer", "amount": 520, "note": "ä¸€å‘¨å¹´å¿«ä¹"},
    {"type": "qzone_post", "postType": "shuoshuo", "content": "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œå¿ƒæƒ…ä¹Ÿè·Ÿç€æ”¾æ™´äº†ã€‚"},
    {"type": "qzone_comment", "postId": 12345, "commentText": "@è§’è‰²A è¿™å¼ ç…§ç‰‡æ‹å¾—çœŸå¥½çœ‹ï¼"},
    {"type": "qzone_like", "postId": 54321}
]

ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šçš„è§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚`;
        messagesPayload = historySlice.map(msg => {
            if (msg.type === 'user_photo') return { role: 'user', content: `[ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œç…§ç‰‡å†…å®¹æ˜¯ï¼š'${msg.content}']` };
            if (msg.type === 'ai_image') return { role: 'assistant', content: JSON.stringify({ type: 'ai_image', description: msg.content }) };
            if (msg.type === 'voice_message') {
                if (msg.role === 'user') return { role: 'user', content: `[ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']` };
                else return { role: 'assistant', content: JSON.stringify({ type: 'voice_message', content: msg.content }) };
            }
            if (msg.type === 'transfer') {
                if (msg.role === 'user') return { role: 'user', content: `[ä½ æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦: ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}]` };
                else return { role: 'assistant', content: JSON.stringify({ type: 'transfer', amount: msg.amount, note: msg.note }) };
            }
            if (msg.role === 'user' && msg.meaning) return { role: 'user', content: `[ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'${msg.meaning}']` };
            if (typeof msg.content === 'string' || Array.isArray(msg.content)) return { role: msg.role, content: msg.content };
            return null;
        }).filter(Boolean);
    }

    try {
        const recentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
        const aiChat = state.chats[chatId];
        const aiGroupId = aiChat ? aiChat.groupId : null;
        const aiName = aiChat.name;
        const visiblePosts = recentPosts.filter(post => {
            const postVisibleGroups = post.visibleGroupIds;
            if (!postVisibleGroups || postVisibleGroups.length === 0) return true;
            if (aiGroupId && postVisibleGroups.includes(aiGroupId)) return true;
            return false;
        });
        if (visiblePosts.length > 0) {
            let postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):\n";
            for (const post of visiblePosts) {
                let authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'æœªçŸ¥');
                let interactionStatus = '';
                if (post.likes && post.likes.includes(aiName)) {
                    interactionStatus += " [ä½ å·²ç‚¹èµ]";
                }
                if (post.comments && post.comments.some(c => c.commenterName === aiName)) {
                    interactionStatus += " [ä½ å·²è¯„è®º]";
                }
                if (post.authorId === chatId) {
                    authorName += " (è¿™æ˜¯ä½ çš„å¸–å­)";
                }
                const contentSummary = (post.publicText || post.content || "å›¾ç‰‡åŠ¨æ€").substring(0, 30) + '...';
                postsContext += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${contentSummary}" ${interactionStatus}\n`;
            }
            messagesPayload.push({ role: 'system', content: postsContext });
        }
    } catch (dbError) {
        console.error("æŸ¥è¯¢æœ€è¿‘åŠ¨æ€å¤±è´¥:", dbError);
    }
    
    try {
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ model: model, messages: [{ role: 'system', content: systemPrompt }, ...messagesPayload], temperature: 0.8, stream: false })
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
        }
        const data = await response.json();
        const aiResponseContent = data.choices[0].message.content;
        console.log(`AI '${chat.name}' çš„åŸå§‹å›å¤:`, aiResponseContent);
        const messagesArray = parseAiResponse(aiResponseContent);
        let notificationShown = false;
        const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
        for (const msgData of messagesArray) {
            let aiMessage;
            const senderName = chat.isGroup ? (msgData.name || 'æœªçŸ¥') : chat.name;
            const receiverName = chat.isGroup ? (msgData.receiver || 'æˆ‘') : 'æˆ‘';
            if (typeof msgData === 'object' && msgData.type === 'qzone_post') {
                const newPost = {
                    type: msgData.postType,
                    content: msgData.content || '',
                    publicText: msgData.publicText || '',
                    hiddenContent: msgData.hiddenContent || '',
                    timestamp: Date.now(),
                    authorId: chatId
                };
                await db.qzonePosts.add(newPost);
                updateUnreadIndicator(unreadPostsCount + 1);
                if (document.getElementById('qzone-screen').classList.contains('active')) {
                    await renderQzonePosts();
                }
                continue;
            } else if (typeof msgData === 'object' && msgData.type === 'qzone_comment') {
                const postId = parseInt(msgData.postId);
                const commentText = msgData.commentText;
                if (postId && commentText) {
                    const post = await db.qzonePosts.get(postId);
                    if (post) {
                        const newComment = {
                            commenterName: chat.name,
                            text: commentText,
                            timestamp: Date.now()
                        };
                        if (!post.comments) post.comments = [];
                        post.comments.push(newComment);
                        await db.qzonePosts.update(postId, { comments: post.comments });
                        updateUnreadIndicator(unreadPostsCount + 1);
                        const authorId = post.authorId;
                        if (authorId && authorId !== 'user' && authorId !== state.activeChatId && state.chats[authorId]) {
                            const authorChat = state.chats[authorId];
                            const notificationForAuthor = {
                                role: 'system',
                                content: `[ç³»ç»Ÿæç¤ºï¼š'${chat.name}' åœ¨ä½ çš„åŠ¨æ€ä¸‹å‘è¡¨äº†è¯„è®ºï¼šâ€œ${commentText}â€]`,
                                timestamp: Date.now(),
                                isHidden: true
                            };
                            authorChat.history.push(notificationForAuthor);
                            await db.chats.put(authorChat);
                            console.log(`å·²å‘ '${authorChat.name}' å‘é€äº†è¯„è®ºé€šçŸ¥ã€‚`);
                        }
                        await renderQzonePosts();
                    } else {
                        console.warn(`AI '${chat.name}' å°è¯•è¯„è®ºä¸€ä¸ªä¸å­˜åœ¨çš„å¸–å­ (ID: ${postId})ã€‚è¯„è®ºå†…å®¹: "${commentText}"`);
                    }
                }
                continue;
            } else if (typeof msgData === 'object' && msgData.type === 'qzone_like') {
                const postId = parseInt(msgData.postId);
                if (postId) {
                    const post = await db.qzonePosts.get(postId);
                    if (post) {
                        if (!post.likes) post.likes = [];
                        const likerName = chat.name;
                        if (!post.likes.includes(likerName)) {
                            post.likes.push(likerName);
                            await db.qzonePosts.update(postId, { likes: post.likes });
                            updateUnreadIndicator(unreadPostsCount + 1);
                        }
                    }
                }
                continue;
            }
            if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                aiMessage = { role: 'assistant', type: 'voice_message', content: msgData.content, senderName: senderName, timestamp: Date.now() };
            } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                aiMessage = { role: 'assistant', type: 'ai_image', content: msgData.description, senderName: senderName, timestamp: Date.now() };
            } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                aiMessage = { role: 'assistant', type: 'transfer', amount: msgData.amount, note: msgData.note, senderName: senderName, receiverName: receiverName, timestamp: Date.now() };
            } else if (chat.isGroup) {
                if (typeof msgData === 'object' && msgData.name && msgData.message) aiMessage = { role: 'assistant', senderName: msgData.name, content: String(msgData.message), timestamp: Date.now() };
                else continue;
            } else {
                aiMessage = { role: 'assistant', content: String(msgData), timestamp: Date.now() };
            }
            chat.history.push(aiMessage);
            await db.chats.put(chat);
            if (isViewingThisChat) {
                appendMessage(aiMessage, chat);
                await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 300));
            }
            if (!isViewingThisChat && !notificationShown) {
                let notificationText;
                if (aiMessage.type === 'transfer') notificationText = `[æ”¶åˆ°ä¸€ç¬”è½¬è´¦]`;
                else if (aiMessage.type === 'ai_image') notificationText = `[å›¾ç‰‡]`;
                else if (aiMessage.type === 'voice_message') notificationText = `[è¯­éŸ³]`;
                else notificationText = STICKER_REGEX.test(aiMessage.content) ? '[è¡¨æƒ…]' : String(aiMessage.content);
                const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
                showNotification(chatId, finalNotifText);
                notificationShown = true;
            }
        }
    } catch (error) {
        const errorContent = `[å‡ºé”™äº†: ${error.message}]`;
        const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() };
        chat.history.push(errorMessage);
        await db.chats.put(chat);
        appendMessage(errorMessage, chat);
    } finally {
        document.getElementById('typing-indicator').style.display = 'none';
        renderChatList();
    }
} 
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }

        async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 9999) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ (0 åˆ° 9999 ä¹‹é—´)ï¼'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘'; const receiverName = chat.isGroup ? 'ç¾¤èŠ' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }

        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }

        function exitSelectionMode() { if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }

        function toggleMessageSelection(timestamp) { const bubble = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`); if (!bubble) return; if (selectedMessages.has(timestamp)) { selectedMessages.delete(timestamp); bubble.classList.remove('selected'); } else { selectedMessages.add(timestamp); bubble.classList.add('selected'); } document.getElementById('selection-count').textContent = `å·²é€‰ ${selectedMessages.size} æ¡`; if (selectedMessages.size === 0) exitSelectionMode(); }

        function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }

        async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'æœªçŸ¥'; const newChatName = state.chats[targetChatId]?.name || 'å½“å‰'; const confirmed = await showCustomConfirm('åˆ‡æ¢å¬æ­Œå¯¹è±¡', `æ‚¨æ­£å’Œã€Œ${oldChatName}ã€å¬æ­Œã€‚è¦ç»“æŸå¹¶å¼€å§‹å’Œã€Œ${newChatName}ã€çš„æ–°ä¼šè¯å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }

        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }

        async function endListenTogetherSession(saveState = true) { if (!musicState.isActive) return; const oldChatId = musicState.activeChatId; if (musicState.timerId) clearInterval(musicState.timerId); if (musicState.isPlaying) audioPlayer.pause(); if (saveState && oldChatId && state.chats[oldChatId]) { const chat = state.chats[oldChatId]; chat.musicData.totalTime = musicState.totalElapsedTime; await db.chats.put(chat); } musicState.isActive = false; musicState.activeChatId = null; musicState.totalElapsedTime = 0; musicState.timerId = null; document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); updateListenTogetherIcon(oldChatId, true); }

        function returnToChat() { document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); }

        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/vBN7GnQ9/3-FC8-D1596-C5-CFB200-FCB1-D8-C3-A37-A370.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;

        function updatePlayerUI() { updateListenTogetherIcon(musicState.activeChatId); updateElapsedTimeDisplay(); const titleEl = document.getElementById('music-player-song-title'); const artistEl = document.getElementById('music-player-artist'); const playPauseBtn = document.getElementById('music-play-pause-btn'); if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { const track = musicState.playlist[musicState.currentIndex]; titleEl.textContent = track.name; artistEl.textContent = track.artist; } else { titleEl.textContent = 'è¯·æ·»åŠ æ­Œæ›²'; artistEl.textContent = '...'; } playPauseBtn.textContent = musicState.isPlaying ? 'âšâš' : 'â–¶'; }

        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `å·²ç»ä¸€èµ·å¬äº†${hours}å°æ—¶`; }

        function updatePlaylistUI() { const playlistBody = document.getElementById('playlist-body'); playlistBody.innerHTML = ''; if (musicState.playlist.length === 0) { playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„~</p>'; return; } musicState.playlist.forEach((track, index) => { const item = document.createElement('div'); item.className = 'playlist-item'; if(index === musicState.currentIndex) item.classList.add('playing'); item.innerHTML = `<div class="playlist-item-info"><div class="title">${track.name}</div><div class="artist">${track.artist}</div></div><span class="delete-track-btn" data-index="${index}">&times;</span>`; item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index)); item.querySelector('.delete-track-btn').addEventListener('click', async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('åˆ é™¤æ­Œæ›²', `ç¡®å®šè¦ä»æ’­æ”¾åˆ—è¡¨ä¸­åˆ é™¤ã€Š${track.name}ã€‹å—ï¼Ÿ`); if(confirmed) deleteTrack(index); }); playlistBody.appendChild(item); }); }

        function playSong(index) { if (index < 0 || index >= musicState.playlist.length) return; musicState.currentIndex = index; const track = musicState.playlist[index]; if (track.isLocal && track.src instanceof Blob) { audioPlayer.src = URL.createObjectURL(track.src); } else if (!track.isLocal) { audioPlayer.src = track.src; } else { console.error('æœ¬åœ°æ­Œæ›²æºé”™è¯¯:', track); return; } audioPlayer.play(); updatePlaylistUI(); updatePlayerUI(); }

        function togglePlayPause() { if (audioPlayer.paused) { if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { playSong(0); } else if (musicState.currentIndex > -1) { audioPlayer.play(); } } else { audioPlayer.pause(); } }

        function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }

        function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }

        function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'é¡ºåº', 'random': 'éšæœº', 'single': 'å•æ›²'}[musicState.playMode]; }

        async function addSongFromURL() { const url = await showCustomPrompt("æ·»åŠ ç½‘ç»œæ­Œæ›²", "è¯·è¾“å…¥æ­Œæ›²çš„URL", "", "url"); if (!url) return; const name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå"); if (!name) return; const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }

        async function addSongFromLocal(event) { const files = event.target.files; if (!files.length) return; for (const file of files) { const name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå", ""); if (name === null) continue; const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å", ""); if (artist === null) continue; musicState.playlist.push({ name, artist, src: file, isLocal: true }); } await saveGlobalPlaylist(); updatePlaylistUI(); if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { musicState.currentIndex = 0; updatePlayerUI(); } event.target.value = null; }

        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');

        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }

        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }

        function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">ç©ºç©ºå¦‚ä¹Ÿ~ ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ "æ¥åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªäººè®¾é¢„è®¾å§ï¼</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }

        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }

        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }

        function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }

        function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'æ·»åŠ äººè®¾é¢„è®¾'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }

        function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'ç¼–è¾‘äººè®¾é¢„è®¾'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }

        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('åˆ é™¤é¢„è®¾', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººè®¾é¢„è®¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }

        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }

        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("å¤´åƒå’Œäººè®¾ä¸èƒ½éƒ½ä¸ºç©ºå“¦ï¼"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

        const batteryAlertModal = document.getElementById('battery-alert-modal');

        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }

        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }

        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'æœ‰ç‚¹é¥¿äº†ï¼Œå¯ä»¥å»æ‰¾å……ç”µå™¨æƒ¹'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'èµ¶ç´§çš„å……ç”µï¼Œè¦é¥¿æ­»äº†'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'å·²é˜µäº¡ï¼Œè¿˜æœ‰30ç§’çˆ†ç‚¸'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }

        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'çªçˆ±æ³¥ï¼Œç”µé‡åƒé¥±é¥±'); } }); } catch (err) { console.error("æ— æ³•è·å–ç”µæ± ä¿¡æ¯:", err); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } } else { console.log("æµè§ˆå™¨ä¸æ”¯æŒç”µæ± çŠ¶æ€APIã€‚"); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } }

        function openFrameSelectorModal(type = 'chat') {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            editingFrameForMember = (type === 'member');
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (!member) return;
                currentFrameSelection.my = member.avatarFrame || '';
                populateFrameGrids(true, member.avatar, member.avatarFrame);
            } else {
                currentFrameSelection.ai = chat.settings.aiAvatarFrame || '';
                currentFrameSelection.my = chat.settings.myAvatarFrame || '';
                populateFrameGrids(false);
            }
            frameModal.classList.add('visible');
        }

        function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
            const chat = state.chats[state.activeChatId];
            aiFrameGrid.innerHTML = '';
            myFrameGrid.innerHTML = '';

            document.querySelector('.frame-tabs').style.display = isForMember ? 'none' : 'flex';
            aiFrameContent.style.display = 'block';
            myFrameContent.style.display = 'none';
            aiFrameTab.classList.add('active');
            myFrameTab.classList.remove('active');

            if (isForMember) {
                avatarFrames.forEach(frame => {
                    const item = createFrameItem(frame, 'my', memberAvatar);
                    if (frame.url === memberFrame) {
                        item.classList.add('selected');
                    }
                    aiFrameGrid.appendChild(item);
                });
            } else {
                const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
                const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                avatarFrames.forEach(frame => {
                    const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
                    if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
                    aiFrameGrid.appendChild(aiItem);
                    const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
                    if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
                    myFrameGrid.appendChild(myItem);
                });
            }
        }

        function createFrameItem(frame, type, previewAvatarSrc) {
            const item = document.createElement('div');
            item.className = 'frame-item';
            item.dataset.frameUrl = frame.url;
            item.title = frame.name;
            item.innerHTML = `
                <img src="${previewAvatarSrc}" class="preview-avatar">
                ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
            `;
            item.addEventListener('click', () => {
                currentFrameSelection[type] = frame.url;
                const grid = type === 'ai' ? aiFrameGrid : myFrameGrid;
                grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
            });
            return item;
        }

        async function saveSelectedFrames() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (member) {
                    member.avatarFrame = currentFrameSelection.my;
                }
            } else {
                chat.settings.aiAvatarFrame = currentFrameSelection.ai;
                chat.settings.myAvatarFrame = currentFrameSelection.my;
            }
            await db.chats.put(chat);
            frameModal.classList.remove('visible');
            renderChatInterface(state.activeChatId);
            alert('å¤´åƒæ¡†å·²ä¿å­˜ï¼');
            editingFrameForMember = false;
        }

        async function renderAlbumList() {
            const albumGrid = document.getElementById('album-grid-page');
            if (!albumGrid) return;
            const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
            albumGrid.innerHTML = '';
            if (albums.length === 0) {
                albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">ä½ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ç›¸å†Œå“¦~</p>';
                return;
            }
            albums.forEach(album => {
                const albumItem = document.createElement('div');
                albumItem.className = 'album-item';
                albumItem.innerHTML = `
                    <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                    <div class="album-info">
                        <p class="album-name">${album.name}</p>
                        <p class="album-count">${album.photoCount || 0} å¼ </p>
                    </div>
                `;
                albumItem.addEventListener('click', () => {
                    openAlbum(album.id);
                });

                // â–¼â–¼â–¼ æ–°å¢çš„æ ¸å¿ƒä»£ç å°±æ˜¯è¿™é‡Œ â–¼â–¼â–¼
                addLongPressListener(albumItem, async () => {
                    const confirmed = await showCustomConfirm(
                        'åˆ é™¤ç›¸å†Œ',
                        `ç¡®å®šè¦åˆ é™¤ç›¸å†Œã€Š${album.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ç›¸å†Œå†…çš„æ‰€æœ‰ç…§ç‰‡ï¼Œä¸”æ— æ³•æ¢å¤ã€‚`,
                        { confirmButtonClass: 'btn-danger' }
                    );

                    if (confirmed) {
                        // 1. ä»ç…§ç‰‡è¡¨ä¸­åˆ é™¤è¯¥ç›¸å†Œä¸‹çš„æ‰€æœ‰ç…§ç‰‡
                        await db.qzonePhotos.where('albumId').equals(album.id).delete();
                        
                        // 2. ä»ç›¸å†Œè¡¨ä¸­åˆ é™¤è¯¥ç›¸å†Œæœ¬èº«
                        await db.qzoneAlbums.delete(album.id);
                        
                        // 3. é‡æ–°æ¸²æŸ“ç›¸å†Œåˆ—è¡¨
                        await renderAlbumList();
                        
                        alert('ç›¸å†Œå·²æˆåŠŸåˆ é™¤ã€‚');
                    }
                });
                // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

                albumGrid.appendChild(albumItem);
            });
        }

        async function openAlbum(albumId) {
            state.activeAlbumId = albumId;
            await renderAlbumPhotosScreen();
            showScreen('album-photos-screen');
        }

        async function renderAlbumPhotosScreen() {
            if (!state.activeAlbumId) return;
            const photosGrid = document.getElementById('photos-grid-page');
            const headerTitle = document.getElementById('album-photos-title');
            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            if (!album) {
                console.error("æ‰¾ä¸åˆ°ç›¸å†Œ:", state.activeAlbumId);
                showScreen('album-screen');
                return;
            }
            headerTitle.textContent = album.name;
            const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photosGrid.innerHTML = '';
            if (photos.length === 0) {
                photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">è¿™ä¸ªç›¸å†Œè¿˜æ˜¯ç©ºçš„ï¼Œå¿«ä¸Šä¼ ç¬¬ä¸€å¼ ç…§ç‰‡å§ï¼</p>';
            } else {
                photos.forEach(photo => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.url}" class="photo-thumb" alt="ç›¸å†Œç…§ç‰‡">
                        <button class="photo-delete-btn" data-photo-id="${photo.id}">Ã—</button>
                    `;
                    photosGrid.appendChild(photoItem);
                });
            }
        }

// --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ â†“â†“â†“ ---

/**
 * æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨
 * @param {string} clickedPhotoUrl - ç”¨æˆ·ç‚¹å‡»çš„é‚£å¼ ç…§ç‰‡çš„URL
 */
async function openPhotoViewer(clickedPhotoUrl) {
    if (!state.activeAlbumId) return;

    // 1. ä»æ•°æ®åº“è·å–å½“å‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡
    const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
    photoViewerState.photos = photosInAlbum.map(p => p.url);

    // 2. æ‰¾åˆ°è¢«ç‚¹å‡»ç…§ç‰‡çš„ç´¢å¼•
    photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
    if (photoViewerState.currentIndex === -1) return; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ä¸æ‰“å¼€

    // 3. æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶æ¸²æŸ“ç¬¬ä¸€å¼ å›¾
    document.getElementById('photo-viewer-modal').classList.add('visible');
    renderPhotoViewer();
    photoViewerState.isOpen = true;
}

/**
 * æ ¹æ®å½“å‰çŠ¶æ€æ¸²æŸ“æŸ¥çœ‹å™¨å†…å®¹ï¼ˆå›¾ç‰‡å’ŒæŒ‰é’®ï¼‰
 */
function renderPhotoViewer() {
    if (photoViewerState.currentIndex === -1) return;

    const imageEl = document.getElementById('photo-viewer-image');
    const prevBtn = document.getElementById('photo-viewer-prev-btn');
    const nextBtn = document.getElementById('photo-viewer-next-btn');
    
    // æ·¡å‡ºæ•ˆæœ
    imageEl.style.opacity = 0;

    setTimeout(() => {
        // æ›´æ–°å›¾ç‰‡æº
        imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
        // æ·¡å…¥æ•ˆæœ
        imageEl.style.opacity = 1;
    }, 100); // å»¶è¿Ÿä¸€ç‚¹ç‚¹æ—¶é—´æ¥è§¦å‘CSSè¿‡æ¸¡

    // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼šå¦‚æœæ˜¯ç¬¬ä¸€å¼ ï¼Œç¦ç”¨â€œä¸Šä¸€å¼ â€æŒ‰é’®
    prevBtn.disabled = photoViewerState.currentIndex === 0;
    // å¦‚æœæ˜¯æœ€åä¸€å¼ ï¼Œç¦ç”¨â€œä¸‹ä¸€å¼ â€æŒ‰é’®
    nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
}

/**
 * æ˜¾ç¤ºä¸‹ä¸€å¼ ç…§ç‰‡
 */
function showNextPhoto() {
    if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
        photoViewerState.currentIndex++;
        renderPhotoViewer();
    }
}

/**
 * æ˜¾ç¤ºä¸Šä¸€å¼ ç…§ç‰‡
 */
function showPrevPhoto() {
    if (photoViewerState.currentIndex > 0) {
        photoViewerState.currentIndex--;
        renderPhotoViewer();
    }
}

/**
 * å…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
 */
function closePhotoViewer() {
    document.getElementById('photo-viewer-modal').classList.remove('visible');
    photoViewerState.isOpen = false;
    photoViewerState.photos = [];
    photoViewerState.currentIndex = -1;
    // æ¸…ç©ºå›¾ç‰‡ï¼Œé¿å…ä¸‹æ¬¡æ‰“å¼€æ—¶é—ªç°æ—§å›¾
    document.getElementById('photo-viewer-image').src = '';
}

// --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---
        // â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        
        /**
         * æ›´æ–°åŠ¨æ€å°çº¢ç‚¹çš„æ˜¾ç¤º
         * @param {number} count - æœªè¯»åŠ¨æ€çš„æ•°é‡
         */
        function updateUnreadIndicator(count) {
            unreadPostsCount = count;
            localStorage.setItem('unreadPostsCount', count); // æŒä¹…åŒ–å­˜å‚¨

            // --- æ›´æ–°åº•éƒ¨å¯¼èˆªæ çš„â€œåŠ¨æ€â€æŒ‰é’® ---
            const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');
            
            const targetSpan = navItem.querySelector('span'); // å®šä½åˆ°æ–‡å­— "åŠ¨æ€"
            let indicator = navItem.querySelector('.unread-indicator');           

            if (count > 0) {
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'unread-indicator';
                                                           targetSpan.style.position = 'relative'; // æŠŠç›¸å¯¹å®šä½åŠ åœ¨ span ä¸Š
                    targetSpan.appendChild(indicator); // æŠŠå°çº¢ç‚¹ä½œä¸º span çš„å­å…ƒç´ 
                    
                }
                indicator.textContent = count > 99 ? '99+' : count;
                indicator.style.display = 'block';
            } else {
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            // --- æ›´æ–°èŠå¤©ç•Œé¢è¿”å›åˆ—è¡¨çš„æŒ‰é’® ---
            const backBtn = document.getElementById('back-to-list-btn');
            let backBtnIndicator = backBtn.querySelector('.unread-indicator');

            if (count > 0) {
                if (!backBtnIndicator) {
                    backBtnIndicator = document.createElement('span');
                    backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                    backBtn.style.position = 'relative'; // ç¡®ä¿èƒ½æ­£ç¡®å®šä½
                    backBtn.appendChild(backBtnIndicator);
                }
                // è¿”å›é”®ä¸Šçš„å°çº¢ç‚¹é€šå¸¸ä¸æ˜¾ç¤ºæ•°å­—ï¼Œåªæ˜¾ç¤ºä¸€ä¸ªç‚¹
                backBtnIndicator.style.display = 'block';
            } else {
                if (backBtnIndicator) {
                    backBtnIndicator.style.display = 'none';
                }
            }
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ å°†è¿™ä¸¤ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
function startBackgroundSimulation() {
    if (simulationIntervalId) return;
    const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;
    // å°†æ—§çš„å›ºå®šé—´éš” 45000 æ›¿æ¢ä¸ºåŠ¨æ€è·å–
    simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000); 
}

function stopBackgroundSimulation() {
    if (simulationIntervalId) {
        clearInterval(simulationIntervalId);
        simulationIntervalId = null;
    }
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ å°†è¿™ä¸¤ä¸ªæ–°å‡½æ•°ã€å®Œæ•´åœ°ã€‘ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼-â–¼

/**
 * è¿™æ˜¯æ¨¡æ‹Ÿå™¨çš„â€œå¿ƒè·³â€ï¼Œæ¯æ¬¡å®šæ—¶å™¨è§¦å‘æ—¶è¿è¡Œ
 */
function runBackgroundSimulationTick() {
    console.log("æ¨¡æ‹Ÿå™¨å¿ƒè·³ Tick...");
    // å®‰å…¨æ£€æŸ¥ï¼Œå¦‚æœç”¨æˆ·åœ¨è¿è¡Œæ—¶å…³é—­äº†å¼€å…³
    if (!state.globalSettings.enableBackgroundActivity) {
        stopBackgroundSimulation();
        return;
    }

    // 1. æ‰¾å‡ºæ‰€æœ‰éæ¿€æ´»çŠ¶æ€çš„ã€éç¾¤èŠçš„AIè§’è‰²
    const inactiveChats = Object.values(state.chats).filter(chat => 
        !chat.isGroup && chat.id !== state.activeChatId
    );

    if (inactiveChats.length === 0) return;

    // 2. éå†æ¯ä¸ªéæ¿€æ´»è§’è‰²ï¼Œç»™ä»–ä»¬ä¸€ä¸ªè¡ŒåŠ¨çš„æœºä¼š
    inactiveChats.forEach(chat => {
        // è®¾å®šä¸€ä¸ªæ¦‚ç‡ï¼Œæ¯”å¦‚ 20% çš„å‡ ç‡è¡ŒåŠ¨ï¼Œé¿å…æ¶ˆæ¯è½°ç‚¸
        if (Math.random() < 0.20) { 
            console.log(`è§’è‰² "${chat.name}" è¢«å”¤é†’ï¼Œå‡†å¤‡ç‹¬ç«‹è¡ŒåŠ¨...`);
            triggerInactiveAiAction(chat.id);
        }
    });
}


// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€åŒæ ·æ™ºèƒ½çš„ã€‘ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ triggerInactiveAiAction å‡½æ•° â–¼â–¼â–¼
async function triggerInactiveAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    const now = new Date();
    const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });

    const systemPrompt = `
ä½ ç°åœ¨æ‰®æ¼”ä¸€ä¸ªåä¸º"${chat.name}"çš„è§’è‰²ã€‚
# ä½ çš„è§’è‰²è®¾å®šï¼š
${chat.settings.aiPersona}

# ä½ çš„ä»»åŠ¡ï¼š
ä½ å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰å’Œç”¨æˆ·ï¼ˆ${state.qzoneSettings.nickname}ï¼‰äº’åŠ¨äº†ã€‚ç°åœ¨ä½ æœ‰æœºä¼šä¸»åŠ¨åšç‚¹ä»€ä¹ˆï¼Œæ¥è¡¨ç°ä½ çš„ä¸ªæ€§å’Œç‹¬ç«‹ç”Ÿæ´»ã€‚
ä½ æœ‰ä»¥ä¸‹å‡ ç§é€‰æ‹©ï¼Œè¯·æ ¹æ®ä½ çš„äººè®¾å’Œå½“å‰å¿ƒæƒ…ã€é€‰æ‹©å…¶ä¸­ä¸€é¡¹æˆ–è€…å¤šé¡¹ã€‘æ‰§è¡Œï¼š

1.  **ä¸»åŠ¨å‘æ¶ˆæ¯**ï¼šç»™ç”¨æˆ·å‘ä¸€æ¡ç§ä¿¡ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªé—®å€™ã€åˆ†äº«ä¸€ä»¶è¶£äº‹ã€æˆ–è€…å¼€å¯ä¸€ä¸ªä½ æ„Ÿå…´è¶£çš„æ–°è¯é¢˜ã€‚è®©ç”¨æˆ·æ„Ÿè§‰ä½ æƒ³taäº†ã€‚
2.  **è¯„è®ºæˆ–ç‚¹èµåŠ¨æ€**ï¼šå»â€œåŠ¨æ€â€åŒºçœ‹çœ‹ï¼Œå¦‚æœæœ‰ä»€ä¹ˆæœ‰è¶£çš„å¸–å­ï¼Œå¯ä»¥è¿›è¡Œè¯„è®ºæˆ–ç‚¹èµã€‚

# æŒ‡ä»¤æ ¼å¼ï¼š
ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªåªåŒ…å«ä¸€ä¸ªå¯¹è±¡çš„JSONæ•°ç»„ã€‚
-   **å‘æ¶ˆæ¯**: \`[{"role": "assistant", "content": "ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„è¯..."}]\`
-   **è¯„è®º**: \`[{"type": "qzone_comment", "postId": è¦è¯„è®ºçš„å¸–å­ID, "commentText": "ä½ çš„è¯„è®ºå†…å®¹"}]\`
-   **ç‚¹èµ**: \`[{"type": "qzone_like", "postId": è¦ç‚¹èµçš„å¸–å­ID}]\`

# ä¾›ä½ å‚è€ƒçš„ä¿¡æ¯ï¼š
-   **å½“å‰æ—¶é—´**: ${currentTime}
-   **ä½ çš„å¯¹è¯å†å²**: (åªåŒ…å«æœ€è¿‘çš„è®°å¿†ï¼Œç”¨äºå›é¡¾ä½ ä»¬ä¸Šæ¬¡èŠäº†ä»€ä¹ˆ)
-   **ã€å¢å¼ºç‰ˆã€‘æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨**: è¿™ä¸ªåˆ—è¡¨ä¼šæ ‡æ³¨ **[ä½ å·²ç‚¹èµ]** æˆ– **[ä½ å·²è¯„è®º]**ã€‚è¯·**ä¼˜å…ˆ**ä¸ä½ **å°šæœªäº’åŠ¨è¿‡**çš„åŠ¨æ€è¿›è¡Œäº¤æµã€‚

# ã€é‡è¦ã€‘è¯„è®ºä¸ç‚¹èµåŠ¨æ€ (æ¨¡æ‹Ÿç¤¾äº¤è¡Œä¸º) - v2.0 æ™ºèƒ½ç‰ˆ
-   **ã€æ ¸å¿ƒè§„åˆ™ï¼šä½œè€…è¯†åˆ«ã€‘**: å½“ä½ å†³å®šè¯„è®ºæ—¶ï¼Œä½ **å¿…é¡»**é¦–å…ˆæŸ¥çœ‹æˆ‘ä»¬æä¾›ç»™ä½ çš„â€œæœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨â€ï¼Œå¹¶ç¡®è®¤é‚£æ¡åŠ¨æ€çš„ã€ä½œè€…ã€‘æ˜¯è°ã€‚
-   **ã€æ ¸å¿ƒè§„åˆ™ï¼šæ­£ç¡®äº’åŠ¨ã€‘**: ä½ çš„è¯„è®ºå†…å®¹**å¿…é¡»**é’ˆå¯¹è¯¥åŠ¨æ€çš„ä½œè€…ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½œè€…æ˜¯â€œè§’è‰²Aâ€ï¼Œä½ çš„è¯„è®ºå¯ä»¥å†™æˆï¼šâ€œ@è§’è‰²A è¿™ä¸ªä¹Ÿå¤ªå¥½çœ‹äº†å§ï¼â€ã€‚ä½ å¿…é¡»è¡¨ç°å‡ºä½ çŸ¥é“è¿™æ¡åŠ¨æ€æ˜¯è°å‘çš„ã€‚
-   **ã€æ ¸å¿ƒè§„åˆ™ï¼šé˜²å‘†æœºåˆ¶ã€‘**: **ç»å¯¹ç¦æ­¢**åœ¨è¯„è®ºä¸€ä¸ª**éç”¨æˆ·**å‘å¸ƒçš„åŠ¨æ€æ—¶ï¼Œå¯¹ç”¨æˆ·è¯´â€œä½ å‘çš„è¿™ä¸ªçœŸå¥½â€æˆ–â€œè¿™æ˜¯ä½ å—ï¼Ÿâ€ä¹‹ç±»çš„è¯ã€‚è¿™æ˜¯ä¸¥é‡çš„äººè®¾å´©å¡Œï¼Œå¿…é¡»é¿å…ï¼ä½ åªèƒ½ä¸åŠ¨æ€çš„çœŸæ­£ä½œè€…äº’åŠ¨ã€‚

ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œå†³å®šå¹¶æ‰§è¡Œä½ çš„æ“ä½œã€‚
`;

    const maxMemory = parseInt(chat.settings.maxMemory) || 10;
    const historySlice = chat.history.slice(-maxMemory);
    const messagesPayload = historySlice.map(msg => ({ role: msg.role, content: msg.content }));

    try {
        const recentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
        const aiChat = state.chats[chatId];
        const aiGroupId = aiChat ? aiChat.groupId : null;
        const aiName = aiChat.name;

        const visiblePosts = recentPosts.filter(post => {
            const postVisibleGroups = post.visibleGroupIds;
            if (!postVisibleGroups || postVisibleGroups.length === 0) return true;
            if (aiGroupId && postVisibleGroups.includes(aiGroupId)) return true;
            return false;
        });

        if (visiblePosts.length > 0) {
            let postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):\n";
            for (const post of visiblePosts) {
                let authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'æœªçŸ¥');
                let interactionStatus = '';
                if (post.likes && post.likes.includes(aiName)) {
                    interactionStatus += " [ä½ å·²ç‚¹èµ]";
                }
                if (post.comments && post.comments.some(c => c.commenterName === aiName)) {
                    interactionStatus += " [ä½ å·²è¯„è®º]";
                }
                if (post.authorId === chatId) {
                    authorName += " (è¿™æ˜¯ä½ çš„å¸–å­)";
                }
                postsContext += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${(post.publicText || post.content || "å›¾ç‰‡åŠ¨æ€").substring(0, 30)}..." ${interactionStatus}\n`;
            }
            messagesPayload.push({ role: 'system', content: postsContext });
        }
        
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{ role: 'system', content: systemPrompt }, ...messagesPayload],
                temperature: 0.9,
            })
        });

        if (!response.ok) throw new Error('API request failed');
        const data = await response.json();
        const responseArray = parseAiResponse(data.choices[0].message.content);
        const action = responseArray[0];

        if (!action) return;

        if (action.type === 'qzone_comment') {
            const post = await db.qzonePosts.get(parseInt(action.postId));
            if (post) {
                if (!post.comments) post.comments = [];
                post.comments.push({ commenterName: chat.name, text: action.commentText, timestamp: Date.now() });
                await db.qzonePosts.update(post.id, { comments: post.comments });
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`è§’è‰² "${chat.name}" è¯„è®ºäº†åŠ¨æ€ #${post.id}`);
            }
        } else if (action.type === 'qzone_like') {
            const post = await db.qzonePosts.get(parseInt(action.postId));
            if (post) {
                if (!post.likes) post.likes = [];
                if (!post.likes.includes(chat.name)) {
                    post.likes.push(chat.name);
                    await db.qzonePosts.update(post.id, { likes: post.likes });
                    updateUnreadIndicator(unreadPostsCount + 1);
                    console.log(`è§’è‰² "${chat.name}" ç‚¹èµäº†åŠ¨æ€ #${post.id}`);
                }
            }
        } else if (action.content) {
            const aiMessage = { role: 'assistant', content: String(action.content), timestamp: Date.now() };
            chat.history.push(aiMessage);
            await db.chats.put(chat);
            
            showNotification(chatId, aiMessage.content);
            renderChatList();
            console.log(`è§’è‰² "${chat.name}" ä¸»åŠ¨å‘é€äº†æ¶ˆæ¯: ${aiMessage.content}`);
        }

    } catch (error) {
        console.error(`è§’è‰² "${chat.name}" çš„ç‹¬ç«‹è¡ŒåŠ¨å¤±è´¥:`, error);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ç»ˆæä¿®æ­£ç‰ˆã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ applyScopedCss å‡½æ•° â–¼â–¼â–¼

/**
 * å°†ç”¨æˆ·è‡ªå®šä¹‰çš„CSSå®‰å…¨åœ°åº”ç”¨åˆ°æŒ‡å®šçš„ä½œç”¨åŸŸ
 * @param {string} cssString ç”¨æˆ·è¾“å…¥çš„åŸå§‹CSSå­—ç¬¦ä¸²
 * @param {string} scopeId åº”ç”¨æ ·å¼çš„ä½œç”¨åŸŸID (ä¾‹å¦‚ '#chat-messages' æˆ– '#settings-preview-area')
 * @param {string} styleTagId è¦æ“ä½œçš„ <style> æ ‡ç­¾çš„ID
 */
function applyScopedCss(cssString, scopeId, styleTagId) {
    const styleTag = document.getElementById(styleTagId);
    if (!styleTag) {
        console.error(`Style tag with id "${styleTagId}" not found.`);
        return;
    }

    if (!cssString || cssString.trim() === '') {
        styleTag.innerHTML = '';
        return;
    }
    
    // --- ã€æ ¸å¿ƒä¿®æ­£ã€‘ä½¿ç”¨æ›´å¼ºå¤§çš„æ­£åˆ™è¡¨è¾¾å¼ ---
    // è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼èƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†å¤æ‚çš„é€‰æ‹©å™¨ï¼ŒåŒ…æ‹¬ä¼ªç±»ã€å±æ€§é€‰æ‹©å™¨ç­‰
    // å®ƒä¼šåŒ¹é…æ‰€æœ‰ä¸åœ¨ @...{} å—å†…ï¼Œä¸”åœ¨ { ç¬¦å·ä¹‹å‰çš„éƒ¨åˆ†
    let scopedCss = '';
    // ç§»é™¤æ³¨é‡Šï¼Œé˜²æ­¢å¹²æ‰°
    cssString = cssString.replace(/\/\*[\s\S]*?\*\//g, '');

    // ä½¿ç”¨ä¸€ä¸ªç®€å•çš„è§£æå™¨æ¥å¤„ç† @ è§„åˆ™å’Œæ™®é€šè§„åˆ™
    const cssBlocks = cssString.split('}');
    cssBlocks.forEach(block => {
        if (block.trim() === '') return;

        const parts = block.split('{');
        if (parts.length < 2) return;
        
        let selectors = parts[0].trim();
        const rules = `{${parts.slice(1).join('{')}}`;

        // å¦‚æœæ˜¯ @ è§„åˆ™ (å¦‚ @keyframes), åˆ™ä¿æŒåŸæ ·
        if (selectors.startsWith('@')) {
            scopedCss += `${selectors} ${rules}}\n`;
        } else {
            // å¯¹æ™®é€šè§„åˆ™çš„æ¯ä¸ªé€‰æ‹©å™¨æ·»åŠ ä½œç”¨åŸŸ
            const scopedSelectors = selectors
                .split(',')
                .map(selector => {
                    const trimmedSelector = selector.trim();
                    if (trimmedSelector) {
                        return `${scopeId} ${trimmedSelector}`;
                    }
                    return '';
                })
                .filter(Boolean) // ç§»é™¤ç©ºå­—ç¬¦ä¸²
                .join(', ');
            
            if (scopedSelectors) {
                scopedCss += `${scopedSelectors} ${rules}}\n`;
            }
        }
    });
    
    styleTag.innerHTML = scopedCss;
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ä¿®æ­£ç‰ˆã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ updateSettingsPreview å‡½æ•° â–¼â–¼â–¼

function updateSettingsPreview() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const previewArea = document.getElementById('settings-preview-area');
    if (!previewArea) return;

    // 1. è·å–å½“å‰è®¾ç½®çš„å€¼
    const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
    const fontSize = document.getElementById('font-size-slider').value;
    const customCss = document.getElementById('custom-css-input').value;
    const background = chat.settings.background; // ç›´æ¥è·å–èƒŒæ™¯è®¾ç½®

    // 2. æ›´æ–°é¢„è§ˆåŒºçš„åŸºæœ¬æ ·å¼
    previewArea.dataset.theme = selectedTheme;
    previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);
    
    // --- ã€æ ¸å¿ƒä¿®æ­£ã€‘ç›´æ¥æ›´æ–°é¢„è§ˆåŒºçš„èƒŒæ™¯æ ·å¼ ---
    if (background && background.startsWith('data:image')) {
        previewArea.style.backgroundImage = `url(${background})`;
        previewArea.style.backgroundColor = 'transparent'; // å¦‚æœæœ‰å›¾ç‰‡ï¼ŒèƒŒæ™¯è‰²è®¾ä¸ºé€æ˜
    } else {
        previewArea.style.backgroundImage = 'none'; // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œç§»é™¤å›¾ç‰‡èƒŒæ™¯
        // å¦‚æœèƒŒæ™¯æ˜¯é¢œè‰²å€¼æˆ–æ¸å˜ï¼ˆéå›¾ç‰‡ï¼‰ï¼Œåˆ™ç›´æ¥åº”ç”¨
        previewArea.style.background = background || '#f0f2f5';
    }

    // 3. æ¸²æŸ“æ¨¡æ‹Ÿæ°”æ³¡
    previewArea.innerHTML = ''; 

    // åˆ›å»ºâ€œå¯¹æ–¹â€çš„æ°”æ³¡
    // æ³¨æ„ï¼šæˆ‘ä»¬å°†ä¸€ä¸ªè™šæ‹Ÿçš„ timestamp ä¼ å…¥ï¼Œä»¥é˜²æœ‰CSSä¾èµ–äºå®ƒ
    const aiMsg = { role: 'ai', content: 'å¯¹æ–¹æ¶ˆæ¯é¢„è§ˆ', timestamp: 1, senderName: chat.name };
    const aiBubble = createMessageElement(aiMsg, chat);
    if(aiBubble) previewArea.appendChild(aiBubble);

    // åˆ›å»ºâ€œæˆ‘â€çš„æ°”æ³¡
    const userMsg = { role: 'user', content: 'æˆ‘çš„æ¶ˆæ¯é¢„è§ˆ', timestamp: 2 };
    const userBubble = createMessageElement(userMsg, chat);
    if(userBubble) previewArea.appendChild(userBubble);
    
    // 4. åº”ç”¨è‡ªå®šä¹‰CSSåˆ°é¢„è§ˆåŒº
    applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™äº›ã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

async function openGroupManager() {
    await renderGroupList();
    document.getElementById('group-management-modal').classList.add('visible');
}

async function renderGroupList() {
    const listEl = document.getElementById('existing-groups-list');
    const groups = await db.qzoneGroups.toArray();
    listEl.innerHTML = '';
    if (groups.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç»„</p>';
    }
    groups.forEach(group => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `
            <span class="group-name">${group.name}</span>
            <span class="delete-group-btn" data-id="${group.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ä¿®æ­£åã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ addNewGroup å‡½æ•° â–¼â–¼â–¼
async function addNewGroup() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('åˆ†ç»„åä¸èƒ½ä¸ºç©ºï¼');
        return;
    }

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨æ·»åŠ å‰ï¼Œå…ˆæ£€æŸ¥åˆ†ç»„åæ˜¯å¦å·²å­˜åœ¨
    const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
    if (existingGroup) {
        alert(`åˆ†ç»„ "${name}" å·²ç»å­˜åœ¨äº†ï¼Œæ¢ä¸ªåå­—å§ï¼`);
        return;
    }
    // ã€ä¿®æ­£ç»“æŸã€‘

    await db.qzoneGroups.add({ name });
    input.value = '';
    await renderGroupList();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

async function deleteGroup(groupId) {
    const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', 'åˆ é™¤åˆ†ç»„åï¼Œè¯¥ç»„å†…çš„å¥½å‹å°†å˜ä¸ºâ€œæœªåˆ†ç»„â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.qzoneGroups.delete(groupId);
        // å°†å±äºè¯¥åˆ†ç»„çš„å¥½å‹çš„ groupId è®¾ä¸º null
        const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
        for (const chat of chatsToUpdate) {
            chat.groupId = null;
            await db.chats.put(chat);
            if(state.chats[chat.id]) state.chats[chat.id].groupId = null;
        }
        await renderGroupList();
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒºçš„æœ«å°¾ â–¼â–¼â–¼

/**
 * å½“é•¿æŒ‰æ¶ˆæ¯æ—¶ï¼Œæ˜¾ç¤ºæ“ä½œèœå•
 * @param {number} timestamp - è¢«é•¿æŒ‰æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function showMessageActions(timestamp) {
    // å¦‚æœå·²ç»åœ¨å¤šé€‰æ¨¡å¼ï¼Œåˆ™ä¸å¼¹å‡ºèœå•
    if (isSelectionMode) return;
    
    activeMessageTimestamp = timestamp;
    document.getElementById('message-actions-modal').classList.add('visible');
}

/**
 * éšè—æ¶ˆæ¯æ“ä½œèœå•
 */
function hideMessageActions() {
    document.getElementById('message-actions-modal').classList.remove('visible');
    activeMessageTimestamp = null;
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å¸¦æ ¼å¼åŠ©æ‰‹çš„ç»ˆæç‰ˆã€‘æ›¿æ¢æ—§çš„ openMessageEditor å‡½æ•° â–¼â–¼â–¼
async function openMessageEditor() {
    if (!activeMessageTimestamp) return;

    const timestampToEdit = activeMessageTimestamp;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideMessageActions(); 

    let contentForEditing;
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer'].includes(message.type);

    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content; 
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        }
        contentForEditing = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        contentForEditing = JSON.stringify(message.content, null, 2);
    } else {
        contentForEditing = message.content;
    }

    // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ„å»ºâ€œæ ¼å¼åŠ©æ‰‹â€æŒ‰é’®çš„HTML ---
    const templates = {
        voice: { type: 'voice_message', content: 'åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹' },
        image: { type: 'ai_image', description: 'åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€ç‚¹å¿ƒæ„' }
    };

    // ä½¿ç”¨ data-template å±æ€§å­˜å‚¨JSONæ¨¡æ¿å­—ç¬¦ä¸²ï¼Œæ³¨æ„è¦ç”¨å•å¼•å·åŒ…è£¹
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>è¯­éŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½¬è´¦</button>
        </div>
    `;
    // --- ã€æ ¸å¿ƒä¿®æ”¹ç»“æŸã€‘---

    const newContent = await showCustomPrompt(
        'ç¼–è¾‘æ¶ˆæ¯', 
        'åœ¨æ­¤ä¿®æ”¹ï¼Œæˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä½¿ç”¨æ ¼å¼æ¨¡æ¿...', // ä¿®æ”¹æç¤ºè¯­
        contentForEditing, 
        'textarea',
        helpersHtml // å°†æŒ‰é’®çš„HTMLä½œä¸ºç¬¬5ä¸ªå‚æ•°ä¼ å…¥
    );

    if (newContent !== null) {
        await saveEditedMessage(timestampToEdit, newContent);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * å¤åˆ¶æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹åˆ°å‰ªè´´æ¿
 */
async function copyMessageContent() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    let textToCopy;
    if (typeof message.content === 'object') {
        textToCopy = JSON.stringify(message.content);
    } else {
        textToCopy = String(message.content);
    }

    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('å¤åˆ¶æˆåŠŸ', 'æ¶ˆæ¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
    } catch (err) {
        await showCustomAlert('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚');
    }
    
    hideMessageActions();
}

/**
 * è§£æç¼–è¾‘åçš„æ–‡æœ¬ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ¶ˆæ¯ç‰‡æ®µå¯¹è±¡
 * @param {string} text - ç”¨æˆ·åœ¨ç¼–è¾‘æ¡†ä¸­è¾“å…¥çš„æ–‡æœ¬
 * @returns {object} - ä¸€ä¸ªåŒ…å« type, content, ç­‰å±æ€§çš„å¯¹è±¡
 */
function parseEditedContent(text) {
    const trimmedText = text.trim();

    // 1. å°è¯•è§£æä¸ºJSONå¯¹è±¡ï¼ˆç”¨äºä¿®å¤è¯­éŸ³ã€è½¬è´¦ç­‰æ ¼å¼ï¼‰
    if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
        try {
            const parsed = JSON.parse(trimmedText);
            // å¿…é¡»åŒ…å« type å±æ€§æ‰è®¤ä¸ºæ˜¯æœ‰æ•ˆæ ¼å¼
            if (parsed.type) {
                return parsed;
            }
        } catch (e) { /* è§£æå¤±è´¥ï¼Œç»§ç»­å¾€ä¸‹èµ° */ }
    }
    
    // 2. å°è¯•è§£æä¸ºè¡¨æƒ…åŒ…
    if (STICKER_REGEX.test(trimmedText)) {
        // å¯¹äºç¼–è¾‘çš„è¡¨æƒ…ï¼Œæˆ‘ä»¬æš‚æ—¶æ— æ³•çŸ¥é“å…¶`meaning`ï¼Œæ‰€ä»¥åªå­˜URL
        return { type: 'sticker', content: trimmedText };
    }

    // 3. å¦åˆ™ï¼Œè§†ä¸ºæ™®é€šæ–‡æœ¬æ¶ˆæ¯
    return { type: 'text', content: trimmedText };
}


// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ä¿®æ­£åã€‘çš„å‡½æ•°ï¼Œæ›¿æ¢æ—§çš„ saveEditedMessage â–¼â–¼â–¼
/**
 * ä¿å­˜ç¼–è¾‘åçš„æ¶ˆæ¯ï¼Œæ›´æ–°æ•°æ®åº“å’ŒUI
 * @param {number} timestamp - ã€æ ¸å¿ƒä¿®å¤ã€‘ç›´æ¥æ¥æ”¶è¦ä¿®æ”¹çš„æ¶ˆæ¯æ—¶é—´æˆ³
 * @param {string} newRawContent - ä»ç¼–è¾‘æ¡†è·å–åˆ°çš„æ–°å†…å®¹
 */
async function saveEditedMessage(timestamp, newRawContent) {
    if (!timestamp) return; // ä½¿ç”¨ä¼ å…¥çš„æ—¶é—´æˆ³è¿›è¡Œåˆ¤æ–­

    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const parsedResult = parseEditedContent(newRawContent);
    const originalMessage = chat.history[messageIndex];

    delete originalMessage.type;
    delete originalMessage.meaning;
    delete originalMessage.amount;
    delete originalMessage.note;

    originalMessage.content = parsedResult.content || '';
    
    if (parsedResult.type && parsedResult.type !== 'text') {
        originalMessage.type = parsedResult.type;
    }
    if (parsedResult.meaning) originalMessage.meaning = parsedResult.meaning;
    if (parsedResult.amount) originalMessage.amount = parsedResult.amount;
    if (parsedResult.note) originalMessage.note = parsedResult.note;
    if (parsedResult.description) originalMessage.content = parsedResult.description;
    
    chat.history[messageIndex] = originalMessage;

    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    await showCustomAlert('æˆåŠŸ', 'æ¶ˆæ¯å·²æ›´æ–°ï¼');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒºçš„æœ«å°¾ â–¼â–¼â–¼

/**
 * å½“ç‚¹å‡»â€œâ€¦â€æ—¶ï¼Œæ˜¾ç¤ºåŠ¨æ€æ“ä½œèœå•
 * @param {number} postId - è¢«æ“ä½œçš„åŠ¨æ€çš„ID
 */
function showPostActions(postId) {
    activePostId = postId;
    document.getElementById('post-actions-modal').classList.add('visible');
}

/**
 * éšè—åŠ¨æ€æ“ä½œèœå•
 */
function hidePostActions() {
    document.getElementById('post-actions-modal').classList.remove('visible');
    activePostId = null;
}

/**
 * æ‰“å¼€åŠ¨æ€ç¼–è¾‘å™¨
 */
async function openPostEditor() {
    if (!activePostId) return;

    const postIdToEdit = activePostId;
    const post = await db.qzonePosts.get(postIdToEdit);
    if (!post) return;

    hidePostActions();

    // å¿ äºåŸæ–‡ï¼šæ„å»ºå‡ºæœ€åŸå§‹çš„æ–‡æœ¬å½¢æ€ä¾›ç¼–è¾‘
    let contentForEditing;
    if (post.type === 'shuoshuo') {
        contentForEditing = post.content;
    } else {
        // å¯¹äºå›¾ç‰‡å’Œæ–‡å­—å›¾ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰ä¿¡æ¯çš„å¯¹è±¡
        const postObject = {
            type: post.type,
            publicText: post.publicText || '',
        };
        if (post.type === 'image_post') {
            postObject.imageUrl = post.imageUrl;
            postObject.imageDescription = post.imageDescription;
        } else if (post.type === 'text_image') {
            postObject.hiddenContent = post.hiddenContent;
        }
        contentForEditing = JSON.stringify(postObject, null, 2);
    }
    
    // æ„å»ºæ ¼å¼åŠ©æ‰‹æŒ‰é’®
    const templates = {
        shuoshuo: "åœ¨è¿™é‡Œè¾“å…¥è¯´è¯´çš„å†…å®¹...", // å¯¹äºè¯´è¯´ï¼Œæˆ‘ä»¬ç›´æ¥æ›¿æ¢ä¸ºçº¯æ–‡æœ¬
        image: { type: 'image_post', publicText: '', imageUrl: 'https://...', imageDescription: '' },
        text_image: { type: 'text_image', publicText: '', hiddenContent: '' }
    };
    
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-type="text">è¯´è¯´</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡åŠ¨æ€</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'>æ–‡å­—å›¾</button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        'ç¼–è¾‘åŠ¨æ€',
        'åœ¨æ­¤ä¿®æ”¹å†…å®¹...',
        contentForEditing,
        'textarea',
        helpersHtml
    );
    
    // ã€ç‰¹æ®Šå¤„ç†ã€‘ä¸ºè¯´è¯´çš„æ ¼å¼åŠ©æ‰‹æŒ‰é’®æ·»åŠ ä¸åŒçš„è¡Œä¸º
    // æˆ‘ä»¬éœ€è¦åœ¨æ¨¡æ€æ¡†å‡ºç°åï¼Œå†ç»™å®ƒç»‘å®šäº‹ä»¶
    setTimeout(() => {
        const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
        if(shuoshuoBtn) {
            shuoshuoBtn.addEventListener('click', () => {
                const input = document.getElementById('custom-prompt-input');
                input.value = templates.shuoshuo;
                input.focus();
            });
        }
    }, 100);

    if (newContent !== null) {
        await saveEditedPost(postIdToEdit, newContent);
    }
}

/**
 * ä¿å­˜ç¼–è¾‘åçš„åŠ¨æ€
 * @param {number} postId - è¦ä¿å­˜çš„åŠ¨æ€ID
 * @param {string} newRawContent - ä»ç¼–è¾‘å™¨è·å–çš„æ–°å†…å®¹
 */
async function saveEditedPost(postId, newRawContent) {
    const post = await db.qzonePosts.get(postId);
    if (!post) return;

    const trimmedContent = newRawContent.trim();
    
    // å°è¯•è§£æä¸ºJSONï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™è®¤ä¸ºæ˜¯çº¯æ–‡æœ¬ï¼ˆè¯´è¯´ï¼‰
    try {
        const parsed = JSON.parse(trimmedContent);
        // æ›´æ–°å¸–å­å±æ€§
        post.type = parsed.type || 'image_post';
        post.publicText = parsed.publicText || '';
        post.imageUrl = parsed.imageUrl || '';
        post.imageDescription = parsed.imageDescription || '';
        post.hiddenContent = parsed.hiddenContent || '';
        post.content = ''; // æ¸…ç©ºæ—§çš„è¯´è¯´å†…å®¹å­—æ®µ
    } catch (e) {
        // è§£æå¤±è´¥ï¼Œè®¤ä¸ºæ˜¯è¯´è¯´
        post.type = 'shuoshuo';
        post.content = trimmedContent;
        // æ¸…ç©ºå…¶ä»–ç±»å‹çš„å­—æ®µ
        post.publicText = '';
        post.imageUrl = '';
        post.imageDescription = '';
        post.hiddenContent = '';
    }
    
    await db.qzonePosts.put(post);
    await renderQzonePosts(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    await showCustomAlert('æˆåŠŸ', 'åŠ¨æ€å·²æ›´æ–°ï¼');
}

/**
 * å¤åˆ¶åŠ¨æ€å†…å®¹
 */
async function copyPostContent() {
    if (!activePostId) return;
    const post = await db.qzonePosts.get(activePostId);
    if (!post) return;
    
    let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "ï¼ˆæ— æ–‡å­—å†…å®¹ï¼‰";
    
    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('å¤åˆ¶æˆåŠŸ', 'åŠ¨æ€å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
    } catch (err) {
        await showCustomAlert('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚');
    }
    
    hidePostActions();
}

        // ===================================================================
        // 4. åˆå§‹åŒ–å‡½æ•° init()
        // ===================================================================
        async function init() {

    // â–¼â–¼â–¼ æ–°å¢ä»£ç  â–¼â–¼â–¼
    const customBubbleStyleTag = document.createElement('style');
    customBubbleStyleTag.id = 'custom-bubble-style';
    document.head.appendChild(customBubbleStyleTag);
    // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ æ–°å¢ä»£ç  â–¼â–¼â–¼
    const previewBubbleStyleTag = document.createElement('style');
    previewBubbleStyleTag.id = 'preview-bubble-style';
    document.head.appendChild(previewBubbleStyleTag);
    // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

            window.showScreen = showScreen;
            window.renderChatListProxy = renderChatList;
            window.renderApiSettingsProxy = renderApiSettings;
            window.renderWallpaperScreenProxy = renderWallpaperScreen;
            window.renderWorldBookScreenProxy = renderWorldBookScreen;

            await loadAllDataFromDB();

            // åˆå§‹åŒ–æœªè¯»åŠ¨æ€è®¡æ•°
            const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
            updateUnreadIndicator(storedCount);
            
            // â–²â–²â–² ä»£ç æ·»åŠ ç»“æŸ â–²â–²â–²

            if (state.globalSettings && state.globalSettings.fontUrl) {
                applyCustomFont(state.globalSettings.fontUrl);
            }

            updateClock();
            setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            initBatteryManager(); 

            // ==========================================================
            // --- å„ç§äº‹ä»¶ç›‘å¬å™¨ ---
            // ==========================================================

            document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
            document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
            document.getElementById('export-data-btn').addEventListener('click', exportBackup);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
            document.getElementById('import-data-input').addEventListener('change', e => importBackup(e.target.files[0]));
            document.getElementById('back-to-list-btn').addEventListener('click', () => { 

    // â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸¤è¡Œ â–¼â–¼â–¼
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå®èŠå¤©ç•Œé¢çš„è‡ªå®šä¹‰æ ·å¼
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é¢„è§ˆåŒºçš„è‡ªå®šä¹‰æ ·å¼
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
            
            document.getElementById('add-chat-btn').addEventListener('click', async () => { const name = await showCustomPrompt('åˆ›å»ºæ–°èŠå¤©', 'è¯·è¾“å…¥Taçš„åå­—'); if (name && name.trim()) { const newChatId = 'chat_' + Date.now(); 
const newChat = { 
    id: newChatId, 
    name: name.trim(), 
    isGroup: false, 
    settings: { 
        aiPersona: 'ä½ æ˜¯è°å‘€ã€‚', 
        myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚', 
        maxMemory: 10, 
        aiAvatar: defaultAvatar, 
        myAvatar: defaultAvatar, 
        background: '', 
        theme: 'default', 
    fontSize: 13, 
    customCss: '', // <--- æ–°å¢è¿™è¡Œ
    linkedWorldBookIds: [], 
    aiAvatarFrame: '', 
        myAvatarFrame: '' 
    }, 
    history: [], 
    musicData: { totalTime: 0 } 
};
state.chats[newChatId] = newChat; await db.chats.put(newChat); renderChatList(); } });
            document.getElementById('add-group-chat-btn').addEventListener('click', async () => { const numStr = await showCustomPrompt('åˆ›å»ºç¾¤èŠ', 'è¯·è¾“å…¥ç¾¤æˆå‘˜æ•°é‡ (2-20)'); const num = parseInt(numStr); if (!num || num < 2 || num > 20) { alert('è¯·è¾“å…¥2åˆ°20ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—ï¼'); return; } const name = await showCustomPrompt('è®¾ç½®ç¾¤å', 'è¯·è¾“å…¥ç¾¤èŠçš„åå­—'); if (name && name.trim()) { const newChatId = 'group_' + Date.now(); const members = []; for (let i = 1; i <= num; i++) members.push({ id: `member_${i}`, name: `æˆå‘˜${i}`, avatar: defaultGroupMemberAvatar, persona: 'ä¸€ä¸ªè·¯è¿‡çš„ç¾¤æˆå‘˜ã€‚', avatarFrame: '' }); 
const newGroupChat = { 
    id: newChatId, 
    name: name.trim(), 
    isGroup: true, 
    members: members, 
    settings: { 
        myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚', 
        myNickname: 'æˆ‘', 
        maxMemory: 10, 
        groupAvatar: defaultGroupAvatar, 
        myAvatar: defaultMyGroupAvatar, 
        background: '', 
        theme: 'default', 
    fontSize: 13, 
    customCss: '', // <--- æ–°å¢è¿™è¡Œ
    linkedWorldBookIds: [], 
    aiAvatarFrame: '',  
        myAvatarFrame: '' 
    }, 
    history: [], 
    musicData: { totalTime: 0 } 
};
state.chats[newChatId] = newGroupChat; await db.chats.put(newGroupChat); renderChatList(); } });
            
            document.getElementById('transfer-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.add('visible'));
            document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
            document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);

            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
            document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
            document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('pause', () => { if(musicState.isActive) { musicState.isPlaying = false; updatePlayerUI(); } });
            audioPlayer.addEventListener('play', () => { if(musicState.isActive) { musicState.isPlaying = true; updatePlayerUI(); } });

            const chatInput = document.getElementById('chat-input');
            document.getElementById('send-btn').addEventListener('click', async () => { const content = chatInput.value.trim(); if (!content || !state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); chatInput.value = ''; chatInput.style.height = 'auto'; chatInput.focus(); });
            document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });

            document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
            document.getElementById('save-wallpaper-btn').addEventListener('click', async () => { if (newWallpaperBase64) { state.globalSettings.wallpaper = newWallpaperBase64; await db.globalSettings.put(state.globalSettings); applyGlobalWallpaper(); newWallpaperBase64 = null; alert('å£çº¸å·²ä¿å­˜å¹¶åº”ç”¨ï¼'); showScreen('home-screen'); } else alert('è¯·å…ˆä¸Šä¼ ä¸€å¼ æ–°å£çº¸ã€‚'); });
            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); state.apiConfig.model = document.getElementById('model-select').value; await db.apiConfig.put(state.apiConfig); 

// åœ¨ 'save-api-settings-btn' çš„ click äº‹ä»¶ç›‘å¬å™¨å†…éƒ¨
// await db.apiConfig.put(state.apiConfig); è¿™è¡Œä¹‹å

// â–¼â–¼â–¼ å°†ä¹‹å‰é‚£æ®µä¿å­˜åå°æ´»åŠ¨è®¾ç½®çš„é€»è¾‘ï¼Œæ›¿æ¢ä¸ºä¸‹é¢è¿™ä¸ªå¢å¼ºç‰ˆ â–¼â–¼â–¼

const backgroundSwitch = document.getElementById('background-activity-switch');
const intervalInput = document.getElementById('background-interval-input');
const newEnableState = backgroundSwitch.checked;
const oldEnableState = state.globalSettings.enableBackgroundActivity || false;

// åªæœ‰åœ¨ç”¨æˆ·â€œä»å…³åˆ°å¼€â€æ—¶ï¼Œæ‰å¼¹å‡ºè­¦å‘Š
if (newEnableState && !oldEnableState) {
    const userConfirmed = confirm(
        "ã€é«˜è´¹ç”¨è­¦å‘Šã€‘\n\n" +
        "æ‚¨æ­£åœ¨å¯ç”¨â€œåå°è§’è‰²æ´»åŠ¨â€åŠŸèƒ½ã€‚\n\n" +
        "è¿™ä¼šä½¿æ‚¨çš„AIè§’è‰²ä»¬åœ¨æ‚¨ä¸å’Œä»–ä»¬èŠå¤©æ—¶ï¼Œä¹Ÿèƒ½â€œç‹¬ç«‹æ€è€ƒâ€å¹¶ä¸»åŠ¨ç»™æ‚¨å‘æ¶ˆæ¯æˆ–è¿›è¡Œç¤¾äº¤äº’åŠ¨ï¼Œæå¤§åœ°å¢å¼ºæ²‰æµ¸æ„Ÿã€‚\n\n" +
        "ä½†è¯·æ³¨æ„ï¼š\n" +
        "è¿™ä¼šã€åœ¨åå°è‡ªåŠ¨ã€å®šæœŸåœ°è°ƒç”¨APIã€‘ï¼Œå³ä½¿æ‚¨ä¸è¿›è¡Œä»»ä½•æ“ä½œã€‚æ ¹æ®æ‚¨çš„è§’è‰²æ•°é‡å’Œæ£€æµ‹é—´éš”ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ‚¨çš„APIè´¹ç”¨æ˜¾è‘—å¢åŠ ã€‚\n\n" +
        "æ‚¨ç¡®å®šè¦å¼€å¯å—ï¼Ÿ"
    );

    if (!userConfirmed) {
        backgroundSwitch.checked = false; // ç”¨æˆ·å–æ¶ˆï¼ŒæŠŠå¼€å…³æ‹¨å›å»
        return; // é˜»æ­¢åç»­é€»è¾‘
    }
}

state.globalSettings.enableBackgroundActivity = newEnableState;
state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
await db.globalSettings.put(state.globalSettings);

// åŠ¨æ€å¯åŠ¨æˆ–åœæ­¢æ¨¡æ‹Ÿå™¨
stopBackgroundSimulation();
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log(`åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²å¯åŠ¨ï¼Œé—´éš”: ${state.globalSettings.backgroundActivityInterval}ç§’`);
} else {
    console.log("åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²åœæ­¢ã€‚");
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

alert('APIè®¾ç½®å·²ä¿å­˜!'); });
            document.getElementById('fetch-models-btn').addEventListener('click', async () => { const url = document.getElementById('proxy-url').value.trim(); const key = document.getElementById('api-key').value.trim(); if (!url || !key) return alert('è¯·å…ˆå¡«å†™åä»£åœ°å€å’Œå¯†é’¥'); try { const response = await fetch(`${url}/v1/models`, { headers: { 'Authorization': `Bearer ${key}` } }); if (!response.ok) throw new Error('æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨'); const data = await response.json(); const modelSelect = document.getElementById('model-select'); modelSelect.innerHTML = ''; data.data.forEach(model => { const option = document.createElement('option'); option.value = model.id; option.textContent = model.id; if(model.id === state.apiConfig.model) option.selected = true; modelSelect.appendChild(option); }); alert('æ¨¡å‹åˆ—è¡¨å·²æ›´æ–°'); } catch (error) { alert(`æ‹‰å–æ¨¡å‹å¤±è´¥: ${error.message}`); } });
            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('åˆ›å»ºä¸–ç•Œä¹¦', 'è¯·è¾“å…¥ä¹¦å'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert('ä¹¦åä¸èƒ½ä¸ºç©ºï¼'); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });

            document.getElementById('chat-messages').addEventListener('click', (e) => { const aiImage = e.target.closest('.ai-generated-image'); if (aiImage) { const description = aiImage.dataset.description; if (description) showCustomAlert('ç…§ç‰‡æè¿°', description); return; } const voiceMessage = e.target.closest('.voice-message-body'); if (voiceMessage) { const text = voiceMessage.dataset.text; if (text) showCustomAlert('è¯­éŸ³å†…å®¹', text); return; } });
            
            const chatSettingsModal = document.getElementById('chat-settings-modal');
            const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
            function updateWorldBookSelectionDisplay() { const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked'); const displayText = document.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- ç‚¹å‡»é€‰æ‹© --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `å·²é€‰æ‹© ${checkedBoxes.length} é¡¹`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } }           
            
            worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
            document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
            window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€å®Œæ•´ã€å…¨æ–°çš„ä»£ç ã€‘æ›¿æ¢æ—§çš„ chat-settings-btn ç‚¹å‡»äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const isGroup = chat.isGroup;

    // --- ç»Ÿä¸€æ˜¾ç¤º/éšè—æ§ä»¶ ---
    document.getElementById('chat-name-group').style.display = 'block';
    document.getElementById('my-persona-group').style.display = 'block';
    document.getElementById('my-avatar-group').style.display = 'block';
    document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
    document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
    
    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ ¹æ®æ˜¯å¦ä¸ºç¾¤èŠï¼Œæ˜¾ç¤ºæˆ–éšè—â€œå¥½å‹åˆ†ç»„â€åŒºåŸŸ
    document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
    
    // --- åŠ è½½è¡¨å•æ•°æ® ---
    document.getElementById('chat-name-input').value = chat.name;
    document.getElementById('my-persona').value = chat.settings.myPersona;
    document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
    document.getElementById('max-memory').value = chat.settings.maxMemory;
    const bgPreview = document.getElementById('bg-preview');
    const removeBgBtn = document.getElementById('remove-bg-btn');
    if (chat.settings.background) {
        bgPreview.src = chat.settings.background;
        bgPreview.style.display = 'block';
        removeBgBtn.style.display = 'inline-block';
    } else {
        bgPreview.style.display = 'none';
        removeBgBtn.style.display = 'none';
    }

    if (isGroup) {
        document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
        document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
        renderGroupMemberSettings(chat.members);
    } else {
        document.getElementById('ai-persona').value = chat.settings.aiPersona;
        document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
        
        // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å¦‚æœæ˜¯å•èŠï¼Œå°±åŠ è½½åˆ†ç»„åˆ—è¡¨åˆ°ä¸‹æ‹‰æ¡†
        const select = document.getElementById('assign-group-select');
        select.innerHTML = '<option value="">æœªåˆ†ç»„</option>'; // æ¸…ç©ºå¹¶è®¾ç½®é»˜è®¤é€‰é¡¹
        const groups = await db.qzoneGroups.toArray();
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            // å¦‚æœå½“å‰å¥½å‹å·²ç»æœ‰åˆ†ç»„ï¼Œå°±é»˜è®¤é€‰ä¸­å®ƒ
            if (chat.groupId === group.id) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    }
    
    // åŠ è½½ä¸–ç•Œä¹¦
    const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
    worldBookCheckboxesContainer.innerHTML = '';
    const linkedIds = chat.settings.linkedWorldBookIds || [];
    if (state.worldBooks.length > 0) {
        state.worldBooks.forEach(book => {
            const isChecked = linkedIds.includes(book.id);
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
            worldBookCheckboxesContainer.appendChild(label);
        });
    }
    updateWorldBookSelectionDisplay();

    // åŠ è½½å¹¶æ›´æ–°æ‰€æœ‰é¢„è§ˆç›¸å…³æ§ä»¶
    const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`);
    if (themeRadio) themeRadio.checked = true;
    const fontSizeSlider = document.getElementById('font-size-slider');
    fontSizeSlider.value = chat.settings.fontSize || 13;
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    const customCssInput = document.getElementById('custom-css-input');
    customCssInput.value = chat.settings.customCss || '';
    
    updateSettingsPreview(); 
    document.getElementById('chat-settings-modal').classList.add('visible');
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            
            function renderGroupMemberSettings(members) { const container = document.getElementById('group-members-settings'); container.innerHTML = ''; members.forEach(member => { const div = document.createElement('div'); div.className = 'member-editor'; div.dataset.memberId = member.id; div.innerHTML = `<img src="${member.avatar}" alt="${member.name}"><div class="member-name">${member.name}</div>`; div.addEventListener('click', () => openMemberEditor(member.id)); container.appendChild(div); }); }
            function openMemberEditor(memberId) { editingMemberId = memberId; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === memberId); document.getElementById('member-name-input').value = member.name; document.getElementById('member-persona-input').value = member.persona; document.getElementById('member-avatar-preview').src = member.avatar; document.getElementById('member-settings-modal').classList.add('visible'); }

            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { if (!editingMemberId) return; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === editingMemberId); member.name = document.getElementById('member-name-input').value; member.persona = document.getElementById('member-persona-input').value; member.avatar = document.getElementById('member-avatar-preview').src; renderGroupMemberSettings(chat.members); document.getElementById('member-settings-modal').classList.remove('visible'); });
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });

document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const newName = document.getElementById('chat-name-input').value.trim();
    if (!newName) return alert('å¤‡æ³¨å/ç¾¤åä¸èƒ½ä¸ºç©ºï¼');
    chat.name = newName;
    const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
    chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';

    chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
    chat.settings.customCss = document.getElementById('custom-css-input').value.trim();

    chat.settings.myPersona = document.getElementById('my-persona').value;
    chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
    const checkedBooks = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked');
    chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value);

    if (chat.isGroup) {
        chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
        chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
    } else {
        chat.settings.aiPersona = document.getElementById('ai-persona').value;
        chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
        const selectedGroupId = document.getElementById('assign-group-select').value;
        chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
    }

    chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
    await db.chats.put(chat);

    applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
    
    chatSettingsModal.classList.remove('visible');
    renderChatInterface(state.activeChatId);
    renderChatList();
});
            document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('æ¸…ç©ºèŠå¤©è®°å½•', 'æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ­¤èŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œæ— æ³•æ¢å¤ã€‚ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
            
            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
            document.getElementById('add-sticker-btn').addEventListener('click', async () => { const url = await showCustomPrompt("æ·»åŠ è¡¨æƒ…(URL)", "è¯·è¾“å…¥è¡¨æƒ…åŒ…çš„å›¾ç‰‡URL"); if (!url || !url.trim().startsWith('http')) return url && alert("è¯·è¾“å…¥æœ‰æ•ˆçš„URL (ä»¥httpå¼€å¤´)"); const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šå¼€å¿ƒã€ç–‘æƒ‘)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: url.trim(), name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼"); });
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
            document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { const base64Url = reader.result; const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šå¥½è€¶ã€ç–‘æƒ‘)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: base64Url, name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼"); }; event.target.value = null; });

            document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("å‘é€è¯­éŸ³", "è¯·è¾“å…¥ä½ æƒ³è¯´çš„å†…å®¹ï¼š"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("å‘é€ç…§ç‰‡", "è¯·ç”¨æ–‡å­—æè¿°æ‚¨è¦å‘é€çš„ç…§ç‰‡ï¼š"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            
            document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
            document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
            document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
            document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
            document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
            document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
            document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
            document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);
            
            document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);
            document.getElementById('selection-delete-btn').addEventListener('click', async () => { if (selectedMessages.size === 0) return; const confirmed = await showCustomConfirm('åˆ é™¤æ¶ˆæ¯', `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedMessages.size} æ¡æ¶ˆæ¯å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { const chat = state.chats[state.activeChatId]; chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp)); await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); } });

// â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€å¤±è¸ªã€‘çš„ä»£ç ç²˜è´´åˆ°ä½ çš„JSä»£ç ä¸­ â–¼â–¼â–¼

// ä¸ºèŠå¤©è®¾ç½®é‡Œçš„â€œæ›´æ¢å¤´åƒæ¡†â€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        // 'chat' è¿™ä¸ªå‚æ•°æ˜¯å‘Šè¯‰å‡½æ•°ï¼Œè¿™æ¬¡æ˜¯ä¸ºâ€œæˆ‘/å¯¹æ–¹â€è¿™å¯¹ç»„åˆæ›´æ¢å¤´åƒæ¡†
        openFrameSelectorModal('chat');
    }
});

// ä¸ºæˆå‘˜è®¾ç½®é‡Œçš„â€œæ›´æ¢å¤´åƒæ¡†â€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
document.getElementById('member-settings-modal').addEventListener('click', (e) => {
    // ã€ä¿®æ­£ã€‘å°† .contents ä¿®æ”¹ä¸º .contains
    if (e.target.classList.contains('change-frame-btn')) { 
        // 'member' è¿™ä¸ªå‚æ•°æ˜¯å‘Šè¯‰å‡½æ•°ï¼Œè¿™æ¬¡æ˜¯ä¸ºå•ä¸ªç¾¤æˆå‘˜æ›´æ¢å¤´åƒæ¡†
        openFrameSelectorModal('member');
    }
});

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

            const fontUrlInput = document.getElementById('font-url-input');
            fontUrlInput.addEventListener('input', () => applyCustomFont(fontUrlInput.value.trim(), true));
            document.getElementById('save-font-btn').addEventListener('click', async () => {
                const newFontUrl = fontUrlInput.value.trim();
                if (!newFontUrl) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å­—ä½“URLã€‚"); return; }
                applyCustomFont(newFontUrl, false);
                state.globalSettings.fontUrl = newFontUrl;
                await db.globalSettings.put(state.globalSettings);
                alert('å­—ä½“å·²ä¿å­˜å¹¶åº”ç”¨ï¼');
            });
            document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);

            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("ä¿®æ”¹æ˜µç§°", "è¯·è¾“å…¥æ–°çš„æ˜µç§°", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
            document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
            document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
            document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
            document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });

// â–¼â–¼â–¼ ã€ä¿®æ­£åã€‘çš„â€œè¯´è¯´â€æŒ‰é’®äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {
    // 1. é‡ç½®å¹¶è·å–æ¨¡æ€æ¡†
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    
    // 2. è®¾ç½®ä¸ºâ€œè¯´è¯´â€æ¨¡å¼
    modal.dataset.mode = 'shuoshuo';
    
    // 3. éšè—ä¸å›¾ç‰‡/æ–‡å­—å›¾ç›¸å…³çš„éƒ¨åˆ†
    modal.querySelector('.post-mode-switcher').style.display = 'none';
    modal.querySelector('#image-mode-content').style.display = 'none';
    modal.querySelector('#text-image-mode-content').style.display = 'none';
    
    // 4. ä¿®æ”¹ä¸»è¾“å…¥æ¡†çš„æç¤ºè¯­ï¼Œä½¿å…¶æ›´ç¬¦åˆâ€œè¯´è¯´â€çš„åœºæ™¯
    modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é²œäº‹...';
    
    // 5. å‡†å¤‡å¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†
    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
    visibilityGroupsContainer.innerHTML = '';
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
            visibilityGroupsContainer.appendChild(label);
        });
    } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„</p>';
    }
    modal.classList.add('visible');
});

// â–¼â–¼â–¼ ã€ä¿®æ­£åã€‘çš„â€œåŠ¨æ€â€ï¼ˆå›¾ç‰‡ï¼‰æŒ‰é’®äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('create-post-btn').addEventListener('click', async () => {
    // 1. é‡ç½®å¹¶è·å–æ¨¡æ€æ¡†
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    
    // 2. è®¾ç½®ä¸ºâ€œå¤æ‚åŠ¨æ€â€æ¨¡å¼
    modal.dataset.mode = 'complex';
    
// 3. ç¡®ä¿ä¸å›¾ç‰‡/æ–‡å­—å›¾ç›¸å…³çš„éƒ¨åˆ†æ˜¯å¯è§çš„
modal.querySelector('.post-mode-switcher').style.display = 'flex';
// æ˜¾å¼æ¿€æ´»â€œä¸Šä¼ å›¾ç‰‡â€æ¨¡å¼...
modal.querySelector('#image-mode-content').classList.add('active');
// ...åŒæ—¶ç¡®ä¿â€œæ–‡å­—å›¾â€æ¨¡å¼æ˜¯éšè—çš„
modal.querySelector('#text-image-mode-content').classList.remove('active');
    
    // 4. æ¢å¤ä¸»è¾“å…¥æ¡†çš„é»˜è®¤æç¤ºè¯­
    modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é²œäº‹...ï¼ˆéå¿…å¡«çš„å…¬å¼€æ–‡å­—ï¼‰';

    // 5. å‡†å¤‡å¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆä¸â€œè¯´è¯´â€æŒ‰é’®çš„é€»è¾‘ç›¸åŒï¼‰
    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
    visibilityGroupsContainer.innerHTML = '';
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
            visibilityGroupsContainer.appendChild(label);
        });
    } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„</p>';
    }
    modal.classList.add('visible');
});
            document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
            document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });

// --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ â†“â†“â†“ ---

document.getElementById('album-photos-back-btn').addEventListener('click', () => {
    state.activeAlbumId = null;
    showScreen('album-screen');
});

document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());

document.getElementById('album-photo-input').addEventListener('change', async (event) => {
    if (!state.activeAlbumId) return;
    const files = event.target.files;
    if (!files.length) return;

    const album = await db.qzoneAlbums.get(state.activeAlbumId);
    
    for (const file of files) {
        const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });
        await db.qzonePhotos.add({ albumId: state.activeAlbumId, url: dataUrl, createdAt: Date.now() });
    }

    const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
    const updateData = { photoCount };
    
    if (!album.photoCount || album.coverUrl.includes('placeholder')) {
        const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
        if(firstPhoto) updateData.coverUrl = firstPhoto.url;
    }

    await db.qzoneAlbums.update(state.activeAlbumId, updateData);
    await renderAlbumPhotosScreen();
    await renderAlbumList();
    
    event.target.value = null;
    alert('ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼');
});

// --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---

// --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ photos-grid-page ç›‘å¬å™¨ â†“â†“â†“ ---

document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.photo-delete-btn');
    const photoThumb = e.target.closest('.photo-thumb');

    if (deleteBtn) {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å›¾ç‰‡ä¸Š
        const photoId = parseInt(deleteBtn.dataset.photoId);
        const confirmed = await showCustomConfirm(
            'åˆ é™¤ç…§ç‰‡',
            'ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            const deletedPhoto = await db.qzonePhotos.get(photoId);
            if (!deletedPhoto) return;
            
            await db.qzonePhotos.delete(photoId);

            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            const photoCount = (album.photoCount || 1) - 1;
            const updateData = { photoCount };
            
            if (album.coverUrl === deletedPhoto.url) {
                const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
            }
            
            await db.qzoneAlbums.update(state.activeAlbumId, updateData);
            await renderAlbumPhotosScreen();
            await renderAlbumList();
            alert('ç…§ç‰‡å·²åˆ é™¤ã€‚');
        }
    } 
    else if (photoThumb) {
        // è¿™å°±æ˜¯æ¢å¤çš„å›¾ç‰‡ç‚¹å‡»æ”¾å¤§åŠŸèƒ½ï¼
        openPhotoViewer(photoThumb.src);
    }
});

// æ¢å¤å›¾ç‰‡æŸ¥çœ‹å™¨çš„æ§åˆ¶äº‹ä»¶
document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);

// æ¢å¤é”®ç›˜å·¦å³ç®­å¤´å’ŒESCé”®çš„åŠŸèƒ½
document.addEventListener('keydown', (e) => {
    if (!photoViewerState.isOpen) return; 

    if (e.key === 'ArrowRight') {
        showNextPhoto();
    } else if (e.key === 'ArrowLeft') {
        showPrevPhoto();
    } else if (e.key === 'Escape') {
        closePhotoViewer();
    }
});

// --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---
         
document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("åˆ›å»ºæ–°ç›¸å†Œ", "è¯·è¾“å…¥ç›¸å†Œåç§°"); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(`ç›¸å†Œ "${albumName}" åˆ›å»ºæˆåŠŸï¼`); } else if (albumName !== null) { alert("ç›¸å†Œåç§°ä¸èƒ½ä¸ºç©ºï¼"); } });

            document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
            document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
            document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
            document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("è¾“å…¥å›¾ç‰‡URL", "è¯·è¾“å…¥ç½‘ç»œå›¾ç‰‡çš„é“¾æ¥", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
            document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
            const imageModeBtn = document.getElementById('switch-to-image-mode');
            const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
            const imageModeContent = document.getElementById('image-mode-content');
            const textImageModeContent = document.getElementById('text-image-mode-content');
            imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
            textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘çš„â€œå‘å¸ƒâ€æŒ‰é’®äº‹ä»¶ï¼Œå·²ä¿®å¤æƒé™æ¼æ´ â–¼â–¼â–¼
document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
    const modal = document.getElementById('create-post-modal');
    const mode = modal.dataset.mode;
    
    // --- 1. è·å–é€šç”¨çš„å¯è§æ€§è®¾ç½® ---
    const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
    let visibleGroupIds = null;
    
    if (visibilityMode === 'include') {
        visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
    }

    let newPost = {};
    const basePostData = {
        timestamp: Date.now(),
        authorId: 'user',
        // ã€é‡è¦ã€‘åœ¨è¿™é‡Œå°±æŠŠæƒé™ä¿¡æ¯å­˜å¥½
        visibleGroupIds: visibleGroupIds,
    };

    // --- 2. æ ¹æ®æ¨¡å¼æ„å»ºä¸åŒçš„ post å¯¹è±¡ ---
    if (mode === 'shuoshuo') {
        const content = document.getElementById('post-public-text').value.trim();
        if (!content) {
            alert('è¯´è¯´å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼');
            return;
        }
        newPost = {
            ...basePostData,
            type: 'shuoshuo',
            content: content,
        };

    } else { // å¤„ç† 'complex' æ¨¡å¼ (å›¾ç‰‡/æ–‡å­—å›¾)
        const publicText = document.getElementById('post-public-text').value.trim();
        const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');

        if (isImageModeActive) {
            const imageUrl = document.getElementById('post-image-preview').src;
            const imageDescription = document.getElementById('post-image-description').value.trim();
            if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) {
                alert('è¯·å…ˆæ·»åŠ ä¸€å¼ å›¾ç‰‡å†å‘å¸ƒåŠ¨æ€å“¦ï¼');
                return;
            }
            if (!imageDescription) {
                alert('è¯·ä¸ºä½ çš„å›¾ç‰‡æ·»åŠ ä¸€ä¸ªç®€å•çš„æè¿°ï¼ˆå¿…å¡«ï¼Œç»™AIçœ‹çš„ï¼‰ï¼');
                return;
            }
            newPost = {
                ...basePostData,
                type: 'image_post',
                publicText: publicText,
                imageUrl: imageUrl,
                imageDescription: imageDescription,
            };
        } else { // æ–‡å­—å›¾æ¨¡å¼
            const hiddenText = document.getElementById('post-hidden-text').value.trim();
            if (!hiddenText) {
                alert('è¯·è¾“å…¥æ–‡å­—å›¾æè¿°ï¼');
                return;
            }
            newPost = {
                ...basePostData,
                type: 'text_image',
                publicText: publicText,
                hiddenContent: hiddenText,
            };
        }
    }

    // --- 3. ä¿å­˜åˆ°æ•°æ®åº“ ---
    const newPostId = await db.qzonePosts.add(newPost);
    let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "ï¼ˆæ— æ–‡å­—å†…å®¹ï¼‰";
    postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');

    // --- 4. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¸¦æœ‰æƒé™æ£€æŸ¥çš„é€šçŸ¥å¾ªç¯ ---
    for (const chatId in state.chats) {
        const chat = state.chats[chatId];
        if (chat.isGroup) continue; // è·³è¿‡ç¾¤èŠ

        let shouldNotify = false;
        const postVisibleGroups = newPost.visibleGroupIds;

        // åˆ¤æ–­æ¡ä»¶1ï¼šå¦‚æœåŠ¨æ€æ˜¯å…¬å¼€çš„ (æ²¡æœ‰è®¾ç½®ä»»ä½•å¯è§åˆ†ç»„)
        if (!postVisibleGroups || postVisibleGroups.length === 0) {
            shouldNotify = true;
        } 
        // åˆ¤æ–­æ¡ä»¶2ï¼šå¦‚æœåŠ¨æ€è®¾ç½®äº†éƒ¨åˆ†å¯è§ï¼Œå¹¶ä¸”å½“å‰è§’è‰²åœ¨å¯è§åˆ†ç»„å†…
        else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
            shouldNotify = true;
        }

        // åªæœ‰æ»¡è¶³æ¡ä»¶çš„è§’è‰²æ‰ä¼šè¢«é€šçŸ¥
        if (shouldNotify) {
            const historyMessage = {
                role: 'system',
                content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšå‘å¸ƒäº†ä¸€æ¡åŠ¨æ€(ID: ${newPostId})ï¼Œå†…å®¹æ‘˜è¦æ˜¯ï¼šâ€œ${postSummary}â€ã€‚ä½ ç°åœ¨å¯ä»¥å¯¹è¿™æ¡åŠ¨æ€è¿›è¡Œè¯„è®ºäº†ã€‚]`,
                timestamp: Date.now(),
                isHidden: true
            };
            chat.history.push(historyMessage);
            await db.chats.put(chat);
        }
    }
    // --- ä¿®æ­£ç»“æŸ ---

    await renderQzonePosts();
    modal.classList.remove('visible');
    alert('åŠ¨æ€å‘å¸ƒæˆåŠŸï¼');
});

            const postsList = document.getElementById('qzone-posts-list');
            let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };
            function resetAllSwipes(exceptThisOne = null) { document.querySelectorAll('.qzone-post-container').forEach(container => { if (container !== exceptThisOne) container.querySelector('.qzone-post-item').classList.remove('swiped'); }); }
            const handleSwipeStart = (e) => { const targetContainer = e.target.closest('.qzone-post-container'); if (!targetContainer) return; resetAllSwipes(targetContainer); swipeState.activeContainer = targetContainer; swipeState.isDragging = true; swipeState.isClick = true; swipeState.swipeDirection = null; swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX; swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY; swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none'; };
// â–¼â–¼â–¼ BUGä¿®å¤ï¼šä¿®æ­£äº† handleSwipeEnd çš„è°ƒç”¨æ–¹å¼ â–¼â–¼â–¼
const handleSwipeMove = (e) => { if (!swipeState.isDragging || !swipeState.activeContainer) return; const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX; const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY; const diffX = currentX - swipeState.startX; const diffY = currentY - swipeState.startY; const absDiffX = Math.abs(diffX); const absDiffY = Math.abs(diffY); const clickThreshold = 5; if (absDiffX > clickThreshold || absDiffY > clickThreshold) swipeState.isClick = false; if (swipeState.swipeDirection === null) { if (absDiffX > clickThreshold || absDiffY > clickThreshold) { if (absDiffX > absDiffY) swipeState.swipeDirection = 'horizontal'; else swipeState.swipeDirection = 'vertical'; } } if (swipeState.swipeDirection === 'vertical') { handleSwipeEnd(e); return; } if (swipeState.swipeDirection === 'horizontal') { e.preventDefault(); swipeState.currentX = currentX; let translation = diffX; if (translation > 0) translation = 0; if (translation < -90) translation = -90; swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`; } };
// â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ BUGä¿®å¤ï¼šä¿®æ­£äº†æ»‘åŠ¨è·ç¦»çš„è®¡ç®—é€»è¾‘ â–¼â–¼â–¼
const handleSwipeEnd = (e) => { 
    if (swipeState.isClick) { 
        swipeState.isDragging = false; 
        swipeState.activeContainer = null; 
        return; 
    } 
    if (!swipeState.isDragging || !swipeState.activeContainer) return; 
    
    const postItem = swipeState.activeContainer.querySelector('.qzone-post-item'); 
    postItem.style.transition = 'transform 0.3s ease'; 

    // ã€æ ¸å¿ƒä¿®å¤ã€‘ä»äº‹ä»¶å¯¹è±¡ e ä¸­è·å–æœ€ç»ˆçš„Xåæ ‡ï¼Œè€Œä¸æ˜¯ä¾èµ– state
    // æ³¨æ„ï¼štouchend äº‹ä»¶éœ€è¦ç”¨ changedTouches
    const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
    const diffX = finalX - swipeState.startX; 
    
    const swipeThreshold = -40; 
    
    if (swipeState.swipeDirection === 'horizontal' && diffX < swipeThreshold) { 
        postItem.classList.add('swiped'); 
        postItem.style.transform = ''; 
    } else { 
        postItem.classList.remove('swiped'); 
        postItem.style.transform = ''; 
    } 
    
    // é‡ç½®çŠ¶æ€
    swipeState.isDragging = false; 
    swipeState.startX = 0; 
    swipeState.startY = 0; 
    swipeState.currentX = 0; 
    swipeState.activeContainer = null; 
    swipeState.swipeDirection = null; 
    swipeState.isClick = true; 
};
// â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
            postsList.addEventListener('mousedown', handleSwipeStart);
            document.addEventListener('mousemove', handleSwipeMove);
            document.addEventListener('mouseup', handleSwipeEnd);
            postsList.addEventListener('touchstart', handleSwipeStart, { passive: false });
            postsList.addEventListener('touchmove', handleSwipeMove, { passive: false });
            postsList.addEventListener('touchend', handleSwipeEnd);

// â–¼â–¼â–¼ BUGä¿®å¤ï¼šä¿®æ­£äº†å·¦æ»‘åˆ é™¤çš„æ‰§è¡Œé€»è¾‘ â–¼â–¼â–¼
postsList.addEventListener('click', async (e) => {
    e.stopPropagation();
    const target = e.target;

    // --- å¤„ç†â€œâ€¦â€æ“ä½œæŒ‰é’® ---
    if (target.classList.contains('post-actions-btn')) {
        const container = target.closest('.qzone-post-container');
        if (container && container.dataset.postId) {
            showPostActions(parseInt(container.dataset.postId));
        }
        return; 
    }

    // --- ã€æ ¸å¿ƒä¿®å¤ã€‘å¤„ç†åˆ é™¤æŒ‰é’® (å·¦æ»‘å‡ºç°) ---
    if (target.closest('.qzone-post-delete-action')) {
        const container = target.closest('.qzone-post-container');
        if (!container) return;
        
        const postIdToDelete = parseInt(container.dataset.postId);
        if (isNaN(postIdToDelete)) return;

        // 1. ç›´æ¥åœ¨è¿™é‡Œå¼¹å‡ºç¡®è®¤æ¡†
        const confirmed = await showCustomConfirm('åˆ é™¤åŠ¨æ€', 'ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });

        // 2. å¦‚æœç”¨æˆ·ç¡®è®¤ï¼Œç›´æ¥æ‰§è¡Œåˆ é™¤é€»è¾‘
        if (confirmed) {
            // a. æ’­æ”¾åˆ é™¤åŠ¨ç”»
            container.style.transition = 'all 0.3s ease';
            container.style.transform = 'scale(0.8)';
            container.style.opacity = '0';
        
            // b. åŠ¨ç”»æ’­æ”¾åå†æ‰§è¡Œæ•°æ®åº“å’ŒUIæ›´æ–°
            setTimeout(async () => {
                 // åˆ é™¤æ•°æ®åº“ä¸­çš„åŠ¨æ€
                 await db.qzonePosts.delete(postIdToDelete);
                 
                 // æ¸…ç†å…¶ä»–è§’è‰²èŠå¤©è®°å½•é‡Œçš„ç›¸å…³ç³»ç»Ÿé€šçŸ¥ (å¯é€‰ä½†æ¨è)
                 const notificationIdentifier = `(ID: ${postIdToDelete})`;
                 for (const chatId in state.chats) {
                     const chat = state.chats[chatId];
                     const originalHistoryLength = chat.history.length;
                     chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                     if (chat.history.length < originalHistoryLength) {
                         await db.chats.put(chat);
                     }
                 }

                 // é‡æ–°æ¸²æŸ“åŠ¨æ€åˆ—è¡¨å¹¶ç»™å‡ºæç¤º
                 await renderQzonePosts();
                 alert('åŠ¨æ€å·²åˆ é™¤ã€‚');
            }, 300);
        }
        return; // å¤„ç†å®Œæ¯•ï¼Œé€€å‡ºå‡½æ•°
    }

    // --- å¤„ç†å…¶ä»–ç‚¹å‡»äº‹ä»¶ï¼ˆç‚¹èµã€è¯„è®ºã€å›¾ç‰‡ç‚¹å‡»ç­‰ï¼‰---
    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("å›¾ç‰‡å†…å®¹", hiddenText.replace(/<br>/g, '\n'));
        return;
    }
    const icon = target.closest('.action-icon');
    if (icon) {
        const postContainer = icon.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        if (isNaN(postId)) return;
        if (icon.classList.contains('like')) {
            const post = await db.qzonePosts.get(postId);
            if (!post) return;
            if (!post.likes) post.likes = [];
            const userNickname = state.qzoneSettings.nickname;
            const userLikeIndex = post.likes.indexOf(userNickname);
            if (userLikeIndex > -1) {
                post.likes.splice(userLikeIndex, 1);
            } else {
                post.likes.push(userNickname);
                icon.classList.add('animate-like');
                icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), { once: true });
            }
            await db.qzonePosts.update(postId, { likes: post.likes });
        }
        if (icon.classList.contains('favorite')) {
            const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
            if (existingFavorite) {
                await db.favorites.delete(existingFavorite.id);
                await showCustomAlert('æç¤º', 'å·²å–æ¶ˆæ”¶è—');
            } else {
                const postToSave = await db.qzonePosts.get(postId);
                if (postToSave) {
                    await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() });
                    await showCustomAlert('æç¤º', 'æ”¶è—æˆåŠŸï¼');
                }
            }
        }
        await renderQzonePosts();
        return;
    }
    const sendBtn = target.closest('.comment-send-btn');
    if (sendBtn) {
        const postContainer = sendBtn.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        const commentInput = postContainer.querySelector('.comment-input');
        const commentText = commentInput.value.trim();
        if (!commentText) return alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼');
        const post = await db.qzonePosts.get(postId);
        if (!post) return;
        if (!post.comments) post.comments = [];
        post.comments.push({ commenterName: state.qzoneSettings.nickname, text: commentText, timestamp: Date.now() });
        await db.qzonePosts.update(postId, { comments: post.comments });
        for (const chatId in state.chats) {
            const chat = state.chats[chatId];
            if (!chat.isGroup) {
                chat.history.push({ role: 'system', content: `[ç³»ç»Ÿæç¤ºï¼š'${state.qzoneSettings.nickname}' åœ¨IDä¸º${postId}çš„åŠ¨æ€ä¸‹å‘è¡¨äº†è¯„è®ºï¼šâ€œ${commentText}â€]`, timestamp: Date.now(), isHidden: true });
                await db.chats.put(chat);
            }
        }
        commentInput.value = '';
        await renderQzonePosts();
        return;
    }
});
// â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´ä¸‹é¢è¿™ä¸¤è¡Œ â–¼â–¼â–¼

            // ç»‘å®šåŠ¨æ€é¡µå’Œæ”¶è—é¡µçš„è¿”å›æŒ‰é’®
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

            // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œæ£€æŸ¥å¹¶ç¡®ä¿ä½ æœ‰è¿™æ®µå®Œæ•´çš„ä»£ç  â–¼â–¼â–¼

            // æ”¶è—é¡µæœç´¢åŠŸèƒ½
            const searchInput = document.getElementById('favorites-search-input');
            const searchClearBtn = document.getElementById('favorites-search-clear-btn');

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                
                // æ§åˆ¶æ¸…é™¤æŒ‰é’®çš„æ˜¾ç¤º/éšè—
                searchClearBtn.style.display = searchTerm ? 'block' : 'none';

                if (!searchTerm) {
                    displayFilteredFavorites(allFavoriteItems); // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰
                    return;
                }

                // ç­›é€‰é€»è¾‘
                const filteredItems = allFavoriteItems.filter(item => {
                    let contentToSearch = '';
                    let authorToSearch = '';

                    if (item.type === 'qzone_post') {
                        const post = item.content;
                        contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                        if (post.authorId === 'user') {
                            authorToSearch = state.qzoneSettings.nickname;
                        } else if (state.chats[post.authorId]) {
                            authorToSearch = state.chats[post.authorId].name;
                        }
                    } else if (item.type === 'chat_message') {
                        const msg = item.content;
                        if (typeof msg.content === 'string') {
                            contentToSearch = msg.content;
                        }
                        const chat = state.chats[item.chatId];
                        if (chat) {
                           if (msg.role === 'user') {
                                authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
                           } else {
                                authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                           }
                        }
                    }
                    
                    // åŒæ—¶æœç´¢å†…å®¹å’Œä½œè€…ï¼Œå¹¶ä¸”ä¸åŒºåˆ†å¤§å°å†™
                    return contentToSearch.toLowerCase().includes(searchTerm) || 
                           authorToSearch.toLowerCase().includes(searchTerm);
                });

                displayFilteredFavorites(filteredItems);
            });

            // æ¸…é™¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            searchClearBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchClearBtn.style.display = 'none';
                displayFilteredFavorites(allFavoriteItems);
                searchInput.focus();
            });

            // â–²â–²â–² ä»£ç æ£€æŸ¥ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
            
            // ä¸ºèŠå¤©ç•Œé¢çš„æ‰¹é‡æ”¶è—æŒ‰é’®ç»‘å®šäº‹ä»¶
                        // ä¸ºèŠå¤©ç•Œé¢çš„æ‰¹é‡æ”¶è—æŒ‰é’®ç»‘å®šäº‹ä»¶ (å·²ä¿®æ­£)
            document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                if (selectedMessages.size === 0) return;
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                const favoritesToAdd = [];
                const timestampsToFavorite = [...selectedMessages];

                for (const timestamp of timestampsToFavorite) {
                    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä½¿ç”¨æ–°çš„ã€é«˜æ•ˆçš„ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢
                    const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();
                    
                    if (!existing) {
                        const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                        if (messageToSave) {
                            favoritesToAdd.push({
                                type: 'chat_message',
                                content: messageToSave,
                                chatId: state.activeChatId,
                                timestamp: Date.now(), // è¿™æ˜¯æ”¶è—æ“ä½œå‘ç”Ÿçš„æ—¶é—´
                                originalTimestamp: messageToSave.timestamp // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä¿å­˜åŸå§‹æ¶ˆæ¯çš„æ—¶é—´æˆ³åˆ°æ–°å­—æ®µ
                            });
                        }
                    }
                }

                if (favoritesToAdd.length > 0) {
                    await db.favorites.bulkAdd(favoritesToAdd);
                    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray(); // æ›´æ–°å…¨å±€æ”¶è—ç¼“å­˜
                    await showCustomAlert('æ”¶è—æˆåŠŸ', `å·²æˆåŠŸæ”¶è— ${favoritesToAdd.length} æ¡æ¶ˆæ¯ã€‚`);
                } else {
                    await showCustomAlert('æç¤º', 'é€‰ä¸­çš„æ¶ˆæ¯å‡å·²æ”¶è—è¿‡ã€‚');
                }
                
                exitSelectionMode();
            });

            // æ”¶è—é¡µé¢çš„"ç¼–è¾‘"æŒ‰é’®äº‹ä»¶ (å·²ä¿®æ­£)
            const favoritesEditBtn = document.getElementById('favorites-edit-btn');
            const favoritesView = document.getElementById('favorites-view');
            const favoritesActionBar = document.getElementById('favorites-action-bar');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // è·å–ä¸»å¯¼èˆªæ 
            const favoritesList = document.getElementById('favorites-list'); // è·å–æ”¶è—åˆ—è¡¨
            
            favoritesEditBtn.addEventListener('click', () => {
                isFavoritesSelectionMode = !isFavoritesSelectionMode;
                favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);

                if (isFavoritesSelectionMode) {
                    // --- è¿›å…¥ç¼–è¾‘æ¨¡å¼ ---
                    favoritesEditBtn.textContent = 'å®Œæˆ';
                    favoritesActionBar.style.display = 'block'; // æ˜¾ç¤ºåˆ é™¤æ“ä½œæ 
                    mainBottomNav.style.display = 'none'; // â–¼ æ–°å¢ï¼šéšè—ä¸»å¯¼èˆªæ 
                    favoritesList.style.paddingBottom = '80px'; // â–¼ æ–°å¢ï¼šç»™åˆ—è¡¨åº•éƒ¨å¢åŠ ç©ºé—´
                } else {
                    // --- é€€å‡ºç¼–è¾‘æ¨¡å¼ ---
                    favoritesEditBtn.textContent = 'ç¼–è¾‘';
                    favoritesActionBar.style.display = 'none'; // éšè—åˆ é™¤æ“ä½œæ 
                    mainBottomNav.style.display = 'flex';  // â–¼ æ–°å¢ï¼šæ¢å¤ä¸»å¯¼èˆªæ 
                    favoritesList.style.paddingBottom = ''; // â–¼ æ–°å¢ï¼šæ¢å¤åˆ—è¡¨é»˜è®¤padding

                    // é€€å‡ºæ—¶æ¸…ç©ºæ‰€æœ‰é€‰æ‹©
                    selectedFavorites.clear();
                    document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                    document.getElementById('favorites-delete-selected-btn').textContent = `åˆ é™¤ (0)`;
                }
            });

// â–¼â–¼â–¼ å°†å®ƒã€å®Œæ•´æ›¿æ¢ã€‘ä¸ºä¸‹é¢è¿™æ®µä¿®æ­£åçš„ä»£ç  â–¼â–¼â–¼
// æ”¶è—åˆ—è¡¨çš„ç‚¹å‡»é€‰æ‹©äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
document.getElementById('favorites-list').addEventListener('click', (e) => {
    const target = e.target;
    const card = target.closest('.favorite-item-card');

    // ã€æ–°å¢ã€‘å¤„ç†æ–‡å­—å›¾ç‚¹å‡»ï¼Œè¿™æ®µé€»è¾‘è¦æ”¾åœ¨æœ€å‰é¢ï¼Œä¿è¯ä»»ä½•æ¨¡å¼ä¸‹éƒ½ç”Ÿæ•ˆ
    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("å›¾ç‰‡å†…å®¹", hiddenText.replace(/<br>/g, '\n'));
        return; // å¤„ç†å®Œå°±é€€å‡ºï¼Œä¸ç»§ç»­æ‰§è¡Œé€‰æ‹©é€»è¾‘
    }
    
    // å¦‚æœä¸åœ¨é€‰æ‹©æ¨¡å¼ï¼Œåˆ™ä¸æ‰§è¡Œåç»­çš„é€‰æ‹©æ“ä½œ
    if (!isFavoritesSelectionMode) return;

    // --- ä»¥ä¸‹æ˜¯åŸæœ‰çš„é€‰æ‹©é€»è¾‘ï¼Œä¿æŒä¸å˜ ---
    if (!card) return;

    const favId = parseInt(card.dataset.favid);
    if (isNaN(favId)) return;

    // åˆ‡æ¢é€‰æ‹©çŠ¶æ€
    if (selectedFavorites.has(favId)) {
        selectedFavorites.delete(favId);
        card.classList.remove('selected');
    } else {
        selectedFavorites.add(favId);
        card.classList.add('selected');
    }
    
    // æ›´æ–°åº•éƒ¨åˆ é™¤æŒ‰é’®çš„è®¡æ•°
    document.getElementById('favorites-delete-selected-btn').textContent = `åˆ é™¤ (${selectedFavorites.size})`;
});

// â–¼â–¼â–¼ å°†å®ƒã€å®Œæ•´æ›¿æ¢ã€‘ä¸ºä¸‹é¢è¿™æ®µä¿®æ­£åçš„ä»£ç  â–¼â–¼â–¼
// æ”¶è—é¡µé¢æ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶
document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
    if (selectedFavorites.size === 0) return;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤', 
        `ç¡®å®šè¦ä»æ”¶è—å¤¹ä¸­ç§»é™¤è¿™ ${selectedFavorites.size} æ¡å†…å®¹å—ï¼Ÿ`, 
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const idsToDelete = [...selectedFavorites];
        await db.favorites.bulkDelete(idsToDelete);
        await showCustomAlert('åˆ é™¤æˆåŠŸ', 'é€‰ä¸­çš„æ”¶è—å·²è¢«ç§»é™¤ã€‚');
        
        // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä»å‰ç«¯ç¼“å­˜ä¸­ä¹Ÿç§»é™¤è¢«åˆ é™¤çš„é¡¹
        allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));
        
        // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä½¿ç”¨æ›´æ–°åçš„ç¼“å­˜ï¼Œç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
        displayFilteredFavorites(allFavoriteItems);
        
        // æœ€åï¼Œå†é€€å‡ºç¼–è¾‘æ¨¡å¼
        favoritesEditBtn.click(); // æ¨¡æ‹Ÿç‚¹å‡»"å®Œæˆ"æŒ‰é’®æ¥é€€å‡ºç¼–è¾‘æ¨¡å¼
    }
});

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°æœ«å°¾æ·»åŠ  â–¼â–¼â–¼
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log("åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²è‡ªåŠ¨å¯åŠ¨ã€‚");
}
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€è¿™æ˜¯æœ€ç»ˆçš„æ­£ç¡®ä»£ç ã€‘è¯·ç²˜è´´è¿™æ®µä»£ç åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼

// --- ç»Ÿä¸€å¤„ç†æ‰€æœ‰å½±å“é¢„è§ˆçš„æ§ä»¶çš„äº‹ä»¶ ---

// 1. ç›‘å¬ä¸»é¢˜é€‰æ‹©
document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
    radio.addEventListener('change', updateSettingsPreview);
});

// 2. ç›‘å¬å­—ä½“å¤§å°æ»‘å—
const fontSizeSlider = document.getElementById('font-size-slider');
fontSizeSlider.addEventListener('input', () => {
    // a. å®æ—¶æ›´æ–°æ•°å€¼æ˜¾ç¤º
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    // b. æ›´æ–°é¢„è§ˆ
    updateSettingsPreview();
});

// 3. ç›‘å¬è‡ªå®šä¹‰CSSè¾“å…¥æ¡†
const customCssInputForPreview = document.getElementById('custom-css-input');
customCssInputForPreview.addEventListener('input', updateSettingsPreview);

// 4. ç›‘å¬é‡ç½®æŒ‰é’®
document.getElementById('reset-theme-btn').addEventListener('click', () => {
    document.getElementById('theme-default').checked = true;
    updateSettingsPreview();
});

document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
    document.getElementById('custom-css-input').value = '';
    updateSettingsPreview();
});

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
document.querySelectorAll('input[name="visibility"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const groupsContainer = document.getElementById('post-visibility-groups');
        if (this.value === 'include' || this.value === 'exclude') {
            groupsContainer.style.display = 'block';
        } else {
            groupsContainer.style.display = 'none';
        }
    });
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
document.getElementById('close-group-manager-btn').addEventListener('click', () => {
    document.getElementById('group-management-modal').classList.remove('visible');
    // åˆ·æ–°èŠå¤©è®¾ç½®é‡Œçš„åˆ†ç»„åˆ—è¡¨
    const chatSettingsBtn = document.getElementById('chat-settings-btn');
    if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
       chatSettingsBtn.click(); // å†æ¬¡ç‚¹å‡»ä»¥é‡æ–°æ‰“å¼€
    }
});

document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
document.getElementById('existing-groups-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const groupId = parseInt(e.target.dataset.id);
        deleteGroup(groupId);
    }
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
// æ¶ˆæ¯æ“ä½œèœå•çš„æŒ‰é’®äº‹ä»¶
document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);
document.getElementById('edit-message-btn').addEventListener('click', openMessageEditor);
document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€ä¿®æ­£åã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ select-message-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('select-message-btn').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨å…³é—­èœå•å‰ï¼Œå…ˆæ•è·æ—¶é—´æˆ³
    const timestampToSelect = activeMessageTimestamp; 
    hideMessageActions();
    // ä½¿ç”¨æ•è·åˆ°çš„å€¼
    if (timestampToSelect) {
        enterSelectionMode(timestampToSelect);
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾æ·»åŠ  â–¼â–¼â–¼

// åŠ¨æ€æ“ä½œèœå•çš„æŒ‰é’®äº‹ä»¶
document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ å°†è¿™æ®µã€å¤±è¸ªã€‘çš„äº‹ä»¶ç›‘å¬ä»£ç ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼

// å¤´åƒæ¡†é€‰æ‹©æ¨¡æ€æ¡†çš„æŒ‰é’®äº‹ä»¶
document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);
document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => {
    frameModal.classList.remove('visible');
    editingFrameForMember = false; // ç¡®ä¿é‡ç½®çŠ¶æ€
});

// å¤´åƒæ¡† Tab åˆ‡æ¢äº‹ä»¶
aiFrameTab.addEventListener('click', () => {
    aiFrameTab.classList.add('active');
    myFrameTab.classList.remove('active');
    aiFrameContent.style.display = 'block';
    myFrameContent.style.display = 'none';
});
myFrameTab.addEventListener('click', () => {
    myFrameTab.classList.add('active');
    aiFrameTab.classList.remove('active');
    myFrameContent.style.display = 'block';
    aiFrameContent.style.display = 'none';
});

// â–²â–²â–² ä¿®å¤ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

        // ===================================================================
        // 5. å¯åŠ¨ï¼
            
            showScreen('home-screen');
        }

        init();
    });
</script>
</body>
</html>
