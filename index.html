<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <script>
      // === å…³é”®æ ·å¼é¢„åŠ è½½å™¨ï¼ˆé˜»æ­¢ FOUCï¼‰===
      (function() {
        // 1. åŒæ­¥åº”ç”¨ä¸»é¢˜åˆ°æ‰€æœ‰å¿…è¦å…ƒç´ 
        const theme = localStorage.getItem('ephone-theme');
        const isDark = theme === 'dark';
        
        if (isDark) {
          // æ·»åŠ åˆ° html, body (phoneScreen åœ¨ DOMContentLoaded åæ‰å­˜åœ¨ï¼Œé€šè¿‡ CSS å¤„ç†)
          document.documentElement.classList.add('dark-mode');
          // body å¯èƒ½è¿˜ä¸å­˜åœ¨ï¼Œä½¿ç”¨ DOMContentLoaded å‰çš„æŠ€å·§
          const style = document.createElement('style');
          style.textContent = 'body { background-color: #121212; }';
          document.head.appendChild(style);
        }
        
        // 2. åŒæ­¥åº”ç”¨å¸ƒå±€å°ºå¯¸
        try {
          const cache = localStorage.getItem('ephone-layout-cache');
          if (cache) {
            const layout = JSON.parse(cache);
            const style = document.documentElement.style;
            if (layout.screenWidth) style.setProperty('--screen-width', layout.screenWidth + 'px');
            if (layout.screenHeight) style.setProperty('--screen-height', layout.screenHeight + 'px');
            if (layout.phoneOffset !== undefined) style.setProperty('--phone-offset', layout.phoneOffset + 'px');
          }
        } catch (e) {
          console.warn('Layout cache parse error:', e);
        }

        // 3. é¢„åŠ è½½é¢æ¿å¯è§æ€§ï¼ˆé¿å…é—ªçƒï¼‰
        try {
          const settings = localStorage.getItem('ephone-panel-visibility');
          if (settings) {
            const config = JSON.parse(settings);
            if (config.showPhoneSizePanel === false) {
              // é€šè¿‡ CSS éšè—é¢æ¿
              const style = document.createElement('style');
              style.id = 'preload-panel-hidden';
              style.textContent = '#phone-size-control-panel { display: none !important; }';
              document.head.appendChild(style);
            }
          }
        } catch (e) {
          console.warn('Panel visibility cache parse error:', e);
        }
      })();
    </script>

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />

    <!-- 1. (æ ¸å¿ƒ) ä¸ºè‹¹æœè®¾å¤‡è®¾ç½®ä¸»å±å¹•å›¾æ ‡ -->
    <link
      rel="apple-touch-icon"
      href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg"
    />
    <link
      rel="apple-touch-icon"
      sizes="167x167"
      href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg"
    />

    <!-- 2. (æ ¸å¿ƒ) é“¾æ¥åˆ°manifestæ–‡ä»¶ -->
    <link rel="manifest" href="manifest.json" />

    <!-- 3. (æ ¸å¿ƒ) å‘Šè¯‰è‹¹æœè®¾å¤‡ï¼Œè¿™æ˜¯ä¸€ä¸ªWebåº”ç”¨ï¼Œå¯ä»¥å…¨å±æ˜¾ç¤º -->
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <!-- 4. (æ ¸å¿ƒ) è®¾ç½®è‹¹æœè®¾å¤‡å…¨å±æ¨¡å¼ä¸‹çš„çŠ¶æ€æ æ ·å¼ -->
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <!-- 5. (å¯é€‰) è®¾ç½®åº”ç”¨åœ¨ä¸»å±å¹•ä¸Šæ˜¾ç¤ºçš„æ ‡é¢˜ -->
    <meta name="apple-mobile-web-app-title" content="EPhoneï¼ˆå…”kæœºç‰ˆï¼‰" />

    <!-- 6. (å…¼å®¹) ä¸ºéƒ¨åˆ†å®‰å“æµè§ˆå™¨æä¾›æ”¯æŒ -->
    <meta name="mobile-web-app-capable" content="yes" />

    <!-- 7. (å¤‡ç”¨) æ ‡å‡†æµè§ˆå™¨é¡µç­¾å›¾æ ‡ -->
    <link
      rel="icon"
      type="image/png"
      href="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg"
    />

    <title>EPhoneï¼ˆå…”kæœºç‰ˆï¼‰</title>

    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script src="https://phoebeboo.github.io/mewoooo/pp.js" defer></script>
    <script src="main-app.js" defer></script>
    <script src="game-hall.js" defer></script>
    <script src="forum.js" defer></script>
    <script src="lovers-space.js" defer></script>
    <script src="taobao.js" defer></script>
    <script src="weibo.js" defer></script>
    <script src="date.js" defer></script>
    <script src="studio.js" defer></script>
    <script src="sw.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/darkreader@4.9.84/darkreader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="tukey-accounting.js" defer></script>
    <script src="kk-checkin.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="avatar-frames.js"></script>

    <style></style>

    <style id="custom-theme-style"></style>
    <style id="phone-frame-style">
      :root {
        --screen-width: 365px;
        --screen-height: 680px;
        --secondary-bg: #ffffff;
        --border-color: #e0e0e0;
        --text-primary: #1f1f1f;
        --text-secondary: #8a8a8a;
        --accent-color: #007bff;
        --phone-offset: 15px;
        --phone-offset-x: 0;
        --phone-offset-y: var(--phone-offset, 0);
      }
      html {
        height: 100%;
        overflow: hidden;
        background-color: #dcdcdc;
      }
      body {
        height: 100%;
        overflow: hidden;
        margin: 0;
        padding:
          max(20px, env(safe-area-inset-top))
          max(20px, env(safe-area-inset-right))
          max(20px, env(safe-area-inset-bottom))
          max(20px, env(safe-area-inset-left));
        font-family:
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          Helvetica,
          Arial,
          sans-serif;
        font-weight: normal;
        background-color: #dcdcdc;
        display: flex;
        justify-content: center;
        align-items: center;
        box-sizing: border-box;
        transition: background-color 0.3s ease;
      }
      :root.dark-mode {
        --secondary-bg: #101010;
        --border-color: rgba(255, 255, 255, 0.18);
        --text-primary: #f5f5f5;
        --text-secondary: #b3b3b3;
        --accent-color: #57a9ff;
      }
      html.dark-mode {
        background-color: #121212;
      }
      body.dark-mode {
        background-color: #121212;
      }
      :root.dark-mode #phone-screen,
      html.dark-mode #phone-screen,
      body.dark-mode #phone-screen {
        background-color: #000;
      }
      #phone-frame {
        margin-top: var(--phone-offset, 0);
        padding: 12px;
        background-color: #fff;
        border-radius: 50px;
        box-shadow:
          0 20px 50px rgba(0, 0, 0, 0.25),
          inset 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        transition: background-color 0.3s ease;
      }
      body.dark-mode #phone-frame {
        background-color: #2a2a2a;
        box-shadow:
          0 0 25px rgba(220, 235, 255, 0.18),
          0 0 200px rgba(220, 235, 255, 0.06),
          0 0 260px rgba(220, 235, 255, 0.04),
          0 0 0 1px rgba(255, 255, 255, 0.1),
          0 40px 80px rgba(0, 0, 0, 0.95),
          inset 0 1px 2px rgba(255, 255, 255, 0.2);
      }
      .notch {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        width: 130px;
        height: 28px;
        background-color: #1f1f1f;
        border-radius: 0 0 15px 15px;
        z-index: 20;
      }
      #phone-screen {
        width: var(--screen-width);
        height: var(--screen-height);
        background-color: #000;
        border-radius: 40px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 2px solid #333;
      }
    </style>
  </head>
  <body>
    <div id="phone-frame">
      <div class="notch"></div>
      <div id="phone-screen">
      <div id="status-bar">
        <span id="status-bar-time">12:00</span>
        <div id="status-bar-battery" class="battery-container">
          <span class="battery-text">--%</span>
          <div class="battery-icon">
            <div class="battery-level"></div>
          </div>
        </div>
      </div>
      <div id="notification-bar">
        <img id="notification-avatar" src="" />
        <!-- è¿™é‡Œå°±æ˜¯å¤´åƒ -->
        <div id="notification-content">
          <div class="name"></div>
          <!-- åå­— -->
          <div class="message"></div>
          <!-- æ¶ˆæ¯ -->
        </div>
      </div>

      <div id="video-call-floating-bubble" style="display: none">
        <img id="video-floating-avatar" src="" />
      </div>

      <div id="floating-lyrics-bar">
        <span id="floating-lyric-text">â™ª</span>

        <div
          id="lyrics-settings-btn"
          style="
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
          "
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="3"></circle>
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
            ></path>
          </svg>
        </div>
        <span class="close-btn">Ã—</span>
      </div>

      <div id="lock-screen-background-blur" style="display: none"></div>

      <div id="home-screen" class="screen active">
        <div id="desktop-edit-done-btn">å®Œæˆ</div>
        <div class="home-screen-slider">
          <!-- ç¬¬ä¸€é¡µï¼ŒæŠŠåŸæ¥çš„å†…å®¹éƒ½æ”¾è¿›æ¥ -->
          <div class="home-page">
            <div id="main-content-area">
              <div id="profile-widget">
                <img
                  id="profile-banner-img"
                  src="https://i.postimg.cc/k495F4W5/profile-banner.jpg"
                  class="editable-image"
                />

                <div class="profile-avatar-container">
                  <img
                    id="profile-avatar-img"
                    src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg"
                    class="editable-image"
                  />

                  <img
                    id="profile-avatar-frame"
                    class="weibo-avatar-frame"
                    src=""
                    style="display: none"
                  />
                </div>

                <div class="profile-info">
                  <p id="profile-username" class="editable-text">ä½ çš„æ˜µç§°</p>
                  <p id="profile-sub-username" class="editable-text">
                    @your_id
                  </p>
                  <p id="profile-bio" class="editable-text">
                    ç‚¹å‡»è¿™é‡Œç¼–è¾‘ä½ çš„ä¸ªæ€§ç­¾å
                  </p>
                  <p
                    id="profile-location"
                    class="editable-text"
                    data-placeholder="ç‚¹å‡»ç¼–è¾‘åœ°ç‚¹"
                  >
                    <svg
                      width="12"
                      height="12"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                    >
                      <path
                        d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"
                      ></path>
                    </svg>
                    <span>ç‚¹å‡»ç¼–è¾‘åœ°ç‚¹</span>
                  </p>
                </div>
              </div>
              <div id="desktop-layout">
                <div id="desktop-widget-column">
                  <div class="custom-widget-container">
                    <div
                      id="widget-bubble-1"
                      class="widget-bubble editable-text"
                      contenteditable="true"
                    >
                      ç‚¹å‡»ç¼–è¾‘æ–‡å­—
                    </div>
                    <div class="widget-circle-uploader">
                      <img
                        id="widget-image-1"
                        src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg"
                        class="editable-image"
                        title="ç‚¹å‡»æ›´æ¢å›¾ç‰‡"
                      />
                    </div>
                    <div
                      id="widget-subtext-1"
                      class="widget-subtext editable-text"
                      contenteditable="true"
                    >
                      ç‚¹å‡»ç¼–è¾‘æ–‡å­—
                    </div>
                  </div>
                  <div class="custom-widget-container">
                    <div
                      id="widget-bubble-2"
                      class="widget-bubble editable-text"
                      contenteditable="true"
                    >
                      ç‚¹å‡»ç¼–è¾‘æ–‡å­—
                    </div>
                    <div class="widget-circle-uploader">
                      <img
                        id="widget-image-2"
                        src="https://i.postimg.cc/k495F4W5/profile-banner.jpg"
                        class="editable-image"
                        title="ç‚¹å‡»æ›´æ¢å›¾ç‰‡"
                      />
                    </div>
                    <div
                      id="widget-subtext-2"
                      class="widget-subtext editable-text"
                      contenteditable="true"
                    >
                      ç‚¹å‡»ç¼–è¾‘æ–‡å­—
                    </div>
                  </div>
                </div>
                <div id="desktop-app-container">
                  <div
                    class="desktop-app-icon"
                    onclick="showScreen('chat-list-screen')"
                  >
                    <div class="icon-bg-desktop">
                      <img
                        id="icon-img-qq"
                        src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg"
                        alt="QQ"
                      />
                    </div>
                    <span class="label">QQ</span>
                  </div>
                  <div
                    class="desktop-app-icon"
                    onclick="showScreen('world-book-screen')"
                  >
                    <div class="icon-bg-desktop">
                      <img
                        id="icon-img-world-book"
                        src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg"
                        alt="ä¸–ç•Œä¹¦"
                      />
                    </div>
                    <span class="label">ä¸–ç•Œä¹¦</span>
                  </div>
                  <div id="check-phone-btn" class="desktop-app-icon">
                    <div class="icon-bg-desktop">
                      <img
                        id="icon-img-check-phone"
                        src="https://i.postimg.cc/RVwpwr0r/IMG-8348.jpg"
                        alt="æŸ¥æ‰‹æœº"
                      />
                    </div>
                    <span class="label">æŸ¥æ‰‹æœº</span>
                  </div>
                  <div class="desktop-app-icon" id="weibo-app-icon">
                    <div class="icon-bg-desktop">
                      <img
                        id="icon-img-weibo"
                        src="https://i.postimg.cc/PqBY5wBq/weibo-icon.png"
                        alt="å¾®åš"
                      />
                    </div>
                    <span class="label">å¾®åš</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- æ–°å¢çš„ç¬¬äºŒé¡µï¼Œç°åœ¨æ˜¯è‡ªå®šä¹‰å¸ƒå±€ -->
          <div class="home-page">
            <!-- å·¦åŠè¾¹çš„å¤´åƒå°ç»„ä»¶ -->
            <div id="second-page-left-widget" class="custom-widget-container">
              <div class="widget-circle-uploader">
                <img
                  id="widget-image-3"
                  src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg"
                  class="editable-image"
                  title="ç‚¹å‡»æ›´æ¢å›¾ç‰‡"
                />
              </div>

              <div
                id="second-page-bubble"
                class="widget-bubble editable-text"
                contenteditable="true"
              >
                ç‚¹å‡»ç¼–è¾‘æ–‡å­—
              </div>

              <div id="new-bubbles-container">
                <div
                  id="flat-capsule-bubble"
                  class="widget-bubble editable-text"
                  contenteditable="true"
                >
                  å¯ç¼–è¾‘
                </div>
                <div
                  id="circular-bubble"
                  class="widget-bubble editable-text"
                  contenteditable="true"
                >
                  æ–‡å­—
                </div>
              </div>
            </div>
            <!-- å³ä¸Šè§’çš„ä¸¤ä¸ªå¹¶æ’å›¾æ ‡ -->
            <div id="second-page-top-right-apps">
              <div
                class="desktop-app-icon"
                onclick="showScreen('forum-screen')"
              >
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-forum"
                    src="https://i.postimg.cc/pr0T3WfC/douban-icon.png"
                    alt="åœˆå­"
                  />
                </div>
                <span class="label">åœˆå­</span>
              </div>
              <div class="desktop-app-icon" id="lovers-space-app-icon">
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-lovers-space"
                    src="https://i.postimg.cc/d1wZ39xW/lovers-space-icon.png"
                    alt="æƒ…ä¾£ç©ºé—´"
                  />
                </div>
                <span class="label">æƒ…ä¾£ç©ºé—´</span>
              </div>

              <div
                id="second-page-x-social-app"
                class="desktop-app-icon"
                onclick="showScreen('x-social-screen')"
              >
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-x-social"
                    src="https://i.postimg.cc/8P1H0vQ8/x-logo.png"
                    alt="Xç¤¾äº¤"
                  />
                </div>
                <span class="label">Xç¤¾äº¤</span>
              </div>
              <div style="position: absolute; top: 100px; right: 85px">
                <div
                  class="desktop-app-icon"
                  onclick="showScreen('game-hall-screen')"
                >
                  <div class="icon-bg-desktop">
                    <img
                      id="icon-img-game-hall"
                      src="https://i.postimg.cc/P5gL5z2g/game-controller-icon.png"
                      alt="æ¸¸æˆå¤§å…"
                    />
                  </div>
                  <span class="label">æ¸¸æˆå¤§å…</span>
                </div>
              </div>
            </div>
            <!-- === æ–°ç‰ˆå“åº”å¼é€æ˜éŸ³ä¹ç»„ä»¶ === -->
            <div class="middle-layout-container">
              <div id="glass-music-widget">
                <div class="widget-main-row">
                  <!-- å·¦ä¾§ï¼šé•¿æ–¹å½¢åœ†è§’å›¾ç‰‡ -->
                  <div class="rect-cover-wrapper">
                    <img
                      id="music-rect-img"
                      src="https://i.postimg.cc/k495F4W5/profile-banner.jpg"
                      class="editable-image cover-img"
                      title="ç‚¹å‡»æ›´æ¢å°é¢"
                    />
                  </div>

                  <!-- å³ä¾§ï¼šé€æ˜æ°´æ™¶å”±ç‰‡ (é‡å ) -->
                  <div class="glass-record-wrapper">
                    <div class="glass-disc">
                      <!-- å”±ç‰‡ä¸­é—´çš„å›¾ç‰‡ -->
                      <img
                        id="music-record-img"
                        src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg"
                        class="editable-image disc-center-img"
                        title="ç‚¹å‡»æ›´æ¢å”±ç‰‡å›¾ç‰‡"
                      />
                      <!-- å”±ç‰‡çš„é«˜å…‰çº¹ç† -->
                      <div class="disc-highlight"></div>
                    </div>
                  </div>
                </div>

                <!-- ä¸‹æ–¹ï¼šæ–‡å­—å’ŒéŸ³æµª -->
                <div class="widget-footer-row">
                  <div
                    id="music-text-line"
                    class="music-title-text editable-text"
                    contenteditable="true"
                  >
                    ç‚¹å‡»ç¼–è¾‘æ­Œå
                  </div>
                  <!-- å¾‹åŠ¨éŸ³æµª (å·²å¢åŠ æ¡æ•°ä»¥å˜å®½) -->
                  <div class="music-wave-bars" id="custom-wide-wave">
                    <i></i><i></i><i></i><i></i><i></i> <i></i><i></i><i></i
                    ><i></i><i></i> <i></i><i></i><i></i><i></i><i></i> <i></i
                    ><i></i><i></i><i></i><i></i>
                  </div>
                </div>
              </div>
            </div>

            <div id="new-custom-widget">
              <!-- ç”¨ä¸€ä¸ªæ–°çš„å®¹å™¨æŠŠæœˆä»½å’Œå¤´åƒåŒ…èµ·æ¥ -->
              <div id="new-widget-header">
                <!-- åŠ ä¸Šäº† contenteditable å’Œ classï¼Œç°åœ¨å¯ä»¥éšä¾¿æ”¹å®ƒäº†ï¼Œå†™æ•°å­—ã€æ–‡å­—éƒ½å¯ä»¥ -->
                <div
                  id="widget-month-display"
                  class="editable-text"
                  contenteditable="true"
                >
                  12
                </div>

                <img
                  id="new-widget-avatar"
                  src="https://i.postimg.cc/qRqpK5kP/anime-avatar.jpg"
                  class="editable-image"
                />
              </div>
              <div
                id="new-widget-text-1"
                class="new-widget-text editable-text"
                contenteditable="true"
              >
                å¯ç¼–è¾‘æ–‡å­—
              </div>
              <div class="new-widget-divider"></div>
              <div
                id="new-widget-text-2"
                class="new-widget-text editable-text"
                contenteditable="true"
              >
                å¯ç¼–è¾‘æ–‡å­—
              </div>
              <div class="new-widget-divider"></div>
              <div
                id="new-widget-text-3"
                class="new-widget-text editable-text"
                contenteditable="true"
              >
                å¯ç¼–è¾‘æ–‡å­—
              </div>
            </div>
            <div style="position: absolute; bottom: 105px; left: 35px">
              <div class="desktop-app-icon" id="taobao-app-icon">
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-taobao"
                    src="https://i.postimg.cc/k47tXg1j/taologo.png"
                    alt="æ¡ƒå®"
                  />
                </div>
                <span
                  class="label"
                  style="
                    color: white;
                    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                  "
                  >æ¡ƒå®</span
                >
              </div>
            </div>
            <div style="position: absolute; bottom: 105px; left: 120px">
              <div class="desktop-app-icon" id="date-a-live-app-icon">
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-date-a-live"
                    src="https://i.postimg.cc/W36mYgP5/DAL-icon.jpg"
                    alt="çº¦ä¼šå¤§ä½œæˆ˜"
                  />
                </div>
                <span
                  class="label"
                  style="
                    color: white;
                    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                  "
                  >çº¦ä¼šå¤§ä½œæˆ˜</span
                >
              </div>
            </div>
            <div style="position: absolute; bottom: 15px; left: 120px">
              <div class="desktop-app-icon" id="kk-checkin-app-icon">
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-kk-checkin"
                    src="https://i.postimg.cc/MGwrL0nf/kitty.png"
                    alt="kkæŸ¥å²—"
                  />
                </div>
                <span
                  class="label"
                  style="
                    color: white;
                    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                  "
                  >kkæŸ¥å²—</span
                >
              </div>
            </div>
            <div style="position: absolute; bottom: 15px; left: 35px">
              <div class="desktop-app-icon" id="tukey-accounting-app-icon">
                <div class="icon-bg-desktop">
                  <img
                    id="icon-img-tukey-accounting"
                    src="https://i.postimg.cc/k4fZKVXP/tu-tu.png"
                    alt="å…”å…”è®°è´¦"
                  />
                </div>
                <span
                  class="label"
                  style="
                    color: white;
                    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                  "
                  >å…”å…”è®°è´¦</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- åº•éƒ¨ Dock æ ä¿æŒä¸å˜ -->
        <div id="desktop-dock">
          <div
            class="desktop-app-icon"
            onclick="showScreen('api-settings-screen')"
          >
            <div class="icon-bg-desktop">
              <img
                id="icon-img-api-settings"
                src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg"
                alt="APIè®¾ç½®"
              />
            </div>
            <span class="label">APIè®¾ç½®</span>
          </div>

          <div class="desktop-app-icon" id="studio-app-icon">
            <div class="icon-bg-desktop">
              <!-- è¿™é‡Œçš„ id="icon-img-studio" å¿…é¡»ä¿ç•™ï¼Œç”¨äºJSè¯†åˆ«æ›´æ¢å›¾æ ‡ -->
              <img
                id="icon-img-studio"
                src="https://i.postimg.cc/W3sLz11s/clapperboard-icon.png"
                alt="å°å‰§åœº"
              />
            </div>
            <!-- lrqå°å‰§åœº -->
            <span class="label">lrqå°å‰§åœº</span>
          </div>

          <div
            class="desktop-app-icon"
            onclick="showScreen('font-settings-screen')"
          >
            <div class="icon-bg-desktop">
              <img
                id="icon-img-font"
                src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg"
                alt="å­—ä½“"
              />
            </div>
            <span class="label">å­—ä½“</span>
          </div>
          <div
            class="desktop-app-icon"
            onclick="showScreen('wallpaper-screen')"
          >
            <div class="icon-bg-desktop">
              <img
                id="icon-img-wallpaper"
                src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg"
                alt="å¤–è§‚è®¾ç½®"
              />
            </div>
            <span class="label">å¤–è§‚è®¾ç½®</span>
          </div>
        </div>

        <!-- å°åœ†ç‚¹ -->
        <div class="pagination-dots">
          <span class="dot active"></span>
          <span class="dot"></span>
        </div>
      </div>

      <div id="weibo-screen" class="screen">
        <!-- è¿™ä¸ªå®¹å™¨å°†å­˜æ”¾å¾®åšçš„æ‰€æœ‰é¡µé¢ -->
        <div id="weibo-page-container">
          <!-- é¡µé¢1: æˆ‘çš„ä¸»é¡µ (å·²æ”¹é€ ) -->
          <div id="weibo-my-profile-view" class="weibo-view active">
            <!-- å¤´éƒ¨  -->
            <div class="header">
              <span class="back-btn" onclick="showScreen('home-screen')">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>æˆ‘çš„ä¸»é¡µ</span>
              <div class="header-actions">
                <!-- æ–°çš„ç§ä¿¡æŒ‰é’® -->
                <span class="action-btn" id="weibo-my-dms-btn" title="æˆ‘çš„ç§ä¿¡">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                    ></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                  </svg>
                </span>

                <!-- æ–°å¢â€œç¼–è¾‘â€æŒ‰é’® -->
                <span
                  class="action-btn"
                  id="edit-weibo-profile-btn"
                  title="ç¼–è¾‘èµ„æ–™"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M12 20h9"></path>
                    <path
                      d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                    ></path>
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="create-weibo-post-btn"
                  style="font-size: 28px; font-weight: 300"
                  >+</span
                >
              </div>
            </div>
            <!-- ä¸»é¡µå†…å®¹åŒº -->
            <div id="weibo-profile-page">
              <div class="weibo-profile-header">
                <img
                  id="weibo-background-img"
                  src="https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg"
                  class="weibo-background"
                />

                <div class="weibo-avatar-container">
                  <img
                    id="weibo-avatar-img"
                    src="https://files.catbox.moe/q6z5fc.jpeg"
                    class="weibo-avatar"
                  />

                  <img
                    id="weibo-avatar-frame"
                    class="weibo-avatar-frame"
                    src=""
                    style="display: none"
                  />
                </div>

                <div class="weibo-nickname" id="weibo-nickname">ä½ çš„æ˜µç§°</div>

                <div id="weibo-user-profession-display">ç‚¹å‡»è®¾ç½®èŒä¸š</div>

                <div class="weibo-stats">
                  <div id="weibo-following-btn" class="weibo-stat-item">
                    <span id="weibo-following-count" class="weibo-stat-number"
                      >0</span
                    >
                    <span class="weibo-stat-label">å…³æ³¨</span>
                  </div>
                  <div id="weibo-posts-item" class="weibo-stat-item">
                    <span id="weibo-posts-count" class="weibo-stat-number"
                      >0</span
                    >
                    <span class="weibo-stat-label">å¾®åš</span>
                  </div>
                  <div id="weibo-fans-item" class="weibo-stat-item">
                    <span id="weibo-fans-count" class="weibo-stat-number"
                      >0</span
                    >
                    <span class="weibo-stat-label">ç²‰ä¸</span>
                  </div>
                </div>
              </div>
              <div
                id="my-weibo-feed-list"
                style="
                  padding: 15px;
                  display: flex;
                  flex-direction: column;
                  gap: 15px;
                "
              ></div>
            </div>
          </div>

          <!-- é¡µé¢2: å…³æ³¨çš„äºº (ä¿æŒä¸å˜) -->
          <div id="weibo-following-view" class="weibo-view">
            <div class="header">
              <span class="back-btn" onclick="showScreen('home-screen')">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>å…³æ³¨çš„äºº</span>
              <span
                class="action-btn"
                id="clear-following-feed-btn"
                style="font-size: 16px; font-weight: 500"
                >æ¸…ç©º</span
              >
            </div>
            <div
              id="weibo-following-feed-list"
              style="
                flex-grow: 1;
                overflow-y: auto;
                padding: 15px;
                display: flex;
                flex-direction: column;
                gap: 15px;
              "
            >
              <!-- å…³æ³¨çš„äººçš„å¾®åšåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
          </div>

          <!-- é¡µé¢3: çƒ­æœ (ä¿æŒä¸å˜) -->
          <div id="weibo-hot-search-view" class="weibo-view">
            <div class="header">
              <span class="back-btn" onclick="showScreen('home-screen')">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>çƒ­æœ</span>
              <div class="header-actions">
                <span
                  class="action-btn"
                  id="generate-hot-search-btn"
                  title="ç”Ÿæˆçƒ­æœ"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                  </svg>
                </span>
              </div>
            </div>
            <div
              id="weibo-hot-search-list"
              style="flex-grow: 1; overflow-y: auto"
            >
              <p style="text-align: center; color: #8a8a8a; margin-top: 50px">
                ç‚¹å‡»å³ä¸Šè§’æ”¾å¤§é•œç”Ÿæˆçƒ­æœ
              </p>
            </div>
          </div>

          <!-- é¡µé¢4: å¹¿åœº (ä¿æŒä¸å˜) -->
          <div id="weibo-plaza-view" class="weibo-view">
            <div class="header">
              <span class="back-btn" onclick="showScreen('home-screen')">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>å¹¿åœº</span>
              <div class="header-actions">
                <span
                  class="action-btn"
                  id="generate-plaza-feed-btn"
                  title="ç”Ÿæˆå¹¿åœºåŠ¨æ€"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                  </svg>
                </span>
              </div>
            </div>
            <div
              id="weibo-plaza-feed-list"
              style="flex-grow: 1; overflow-y: auto; padding: 0"
            >
              <p style="text-align: center; color: #8a8a8a; margin-top: 50px">
                ç‚¹å‡»å³ä¸Šè§’æ”¾å¤§é•œç”Ÿæˆå¹¿åœºåŠ¨æ€
              </p>
            </div>
          </div>

          <!-- é¡µé¢5: çƒ­æœè¯¦æƒ…é¡µ (ä¿æŒä¸å˜) -->
          <div id="weibo-hottopic-feed-view" class="weibo-view">
            <div class="header">
              <span class="back-btn" id="back-from-hottopic-btn">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span id="weibo-hottopic-title">çƒ­æœè¯é¢˜</span>
              <div class="header-actions">
                <span
                  class="action-btn"
                  id="refresh-hottopic-feed-btn"
                  title="æ¢ä¸€æ‰¹"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                  </svg>
                </span>
              </div>
            </div>
            <div
              id="weibo-hottopic-feed-list"
              style="flex-grow: 1; overflow-y: auto; padding: 0"
            >
              <!-- çƒ­æœå¾®åšåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <div id="weibo-bottom-nav">
          <div class="weibo-nav-item" data-view="weibo-hot-search-view">
            çƒ­æœ
          </div>
          <div class="weibo-nav-item" data-view="weibo-plaza-view">å¹¿åœº</div>
          <div class="weibo-nav-item" data-view="weibo-following-view">
            å…³æ³¨çš„äºº
          </div>
          <div class="weibo-nav-item active" data-view="weibo-my-profile-view">
            æˆ‘çš„å¾®åš
          </div>
        </div>
      </div>

      <div id="world-book-screen" class="screen">
        <div class="header">
          <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
          <span>ä¸–ç•Œä¹¦</span>
          <div class="header-actions">
            <span
              class="action-btn"
              id="import-world-book-btn"
              title="å¯¼å…¥ä¸–ç•Œä¹¦"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </span>

            <span
              class="action-btn"
              id="manage-categories-in-edit-mode-btn"
              style="display: none"
              title="ç®¡ç†åˆ†ç±»"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                ></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
            </span>

            <span
              class="action-btn btn-danger"
              id="world-book-delete-selected-btn"
              style="display: none"
              title="åˆ é™¤å·²é€‰"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="3 6 5 6 21 6"></polyline>
                <path
                  d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                ></path>
              </svg>
              <span
                id="world-book-delete-count"
                style="font-size: 12px; margin-left: 2px"
              ></span>
              <!-- ç”¨äºæ˜¾ç¤ºæ•°é‡ -->
            </span>

            <span class="action-btn" id="toggle-world-book-edit-mode-btn"
              >ç¼–è¾‘æ¨¡å¼</span
            >

            <span class="action-btn" id="add-world-book-btn">+</span>
          </div>
        </div>
        <div id="world-book-list"></div>
      </div>

      <div id="world-book-editor-screen" class="screen">
        <div class="header">
          <span class="back-btn" onclick="showScreen('world-book-screen')"
            >â€¹</span
          >
          <span id="world-book-editor-title">ç¼–è¾‘ä¸–ç•Œä¹¦</span>
          <span class="save-btn" id="save-world-book-btn">ä¿å­˜</span>
        </div>
        <div class="form-container">
          <div class="form-group">
            <label for="world-book-name-input">ä¹¦å</label>
            <input
              type="text"
              id="world-book-name-input"
              placeholder="è¯·è¾“å…¥ä¸–ç•Œä¹¦çš„åç§°..."
            />
          </div>

          <div class="form-group">
            <label for="world-book-category-select">åˆ†ç±»</label>
            <select id="world-book-category-select">
              <!-- é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </select>
          </div>

          <div class="form-group" style="height: 100%">
            <label for="world-book-content-input">å†…å®¹</label>
            <textarea
              id="world-book-content-input"
              placeholder="åœ¨æ­¤å¤„è¾“å…¥è¯¦ç»†çš„ä¸–ç•Œè§‚è®¾å®š..."
            ></textarea>
          </div>
        </div>
      </div>

      <div id="api-settings-screen" class="screen moe-theme">
        <div class="header">
          <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
          <span> APIè®¾ç½® </span>
          <span style="width: 30px"></span>
        </div>

        <!-- å†…å®¹æ»šåŠ¨åŒºåŸŸ -->
        <div class="form-container">
          <!-- 1. äº‘ç«¯å¤§è„‘å¡ç‰‡ -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">â˜ï¸</span>
              <h3>API è¿æ¥</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label>åä»£åœ°å€ (Proxy)</label>
                <input
                  type="text"
                  id="proxy-url"
                  placeholder="https://api.openai.com"
                  class="moe-input"
                />
              </div>
              <div class="form-group">
                <label>å¯†é’¥ (Key)</label>
                <input
                  type="password"
                  id="api-key"
                  placeholder="sk-..."
                  class="moe-input"
                />
              </div>
              <div class="form-group">
                <label>æ¨¡å‹é€‰æ‹© (æ‰‹åŠ¨è¾“å…¥ æˆ– æ‹‰å–åé€‰æ‹©)</label>
                <!-- 1. è¿™é‡Œçš„ id="model-select" æ˜¯çœŸæ­£çš„è¾“å…¥æ¡†ï¼Œä¿å­˜æ—¶åªçœ‹å®ƒçš„å€¼ -->
                <input
                  type="text"
                  id="model-select"
                  class="moe-input"
                  placeholder="å¦‚ gpt-4o, claude-3-5-sonnet"
                />
                <select
                  id="fetched-model-list"
                  class="moe-input"
                  style="
                    margin-top: 5px;
                    display: none;
                    border: 1px dashed var(--accent-color);
                  "
                  onchange="
                    document.getElementById('model-select').value = this.value
                  "
                >
                  <option value="">â–¼ ç‚¹å‡»æ­¤å¤„é€‰æ‹©å·²æ‹‰å–çš„æ¨¡å‹</option>
                </select>
              </div>
              <div class="form-group">
                <label>é¢„è®¾é…ç½®</label>
                <div class="bubble-preset-manager">
                  <select id="api-preset-select" class="moe-input"></select>
                  <button id="manage-api-presets-btn" class="moe-btn-small">
                    ç®¡ç†
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label
                  >æ¸©åº¦ (éšæœºæ€§):
                  <span
                    id="temperature-value"
                    style="color: var(--accent-color)"
                    >0.8</span
                  ></label
                >
                <input
                  type="range"
                  id="temperature-slider"
                  min="0"
                  max="2"
                  step="0.1"
                  value="0.8"
                  class="moe-slider"
                />
              </div>
              <button id="fetch-models-btn" class="moe-btn-secondary">
                ğŸ“¡ æ‹‰å–æ¨¡å‹åˆ—è¡¨
              </button>
            </div>
          </div>

          <!-- 2. è¯­éŸ³åˆæˆå¡ç‰‡ -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">ğŸ—£ï¸</span>
              <h3>Minimax è¯­éŸ³</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label>Group ID</label>
                <input type="text" id="minimax-group-id" class="moe-input" />
              </div>
              <div class="form-group">
                <label>API Key</label>
                <input type="password" id="minimax-api-key" class="moe-input" />
              </div>
              <div class="form-group">
                <label>æœåŠ¡åŒºåŸŸ</label>
                <select id="minimax-provider-select" class="moe-input">
                  <option value="cn">å›½å†…ç‰ˆ</option>
                  <option value="io">æµ·å¤–ç‰ˆ</option>
                </select>
              </div>
              <div class="form-group">
                <label>è¯­éŸ³æ¨¡å‹</label>
                <select
                  id="minimax-speech-model-select"
                  class="moe-input"
                ></select>
              </div>
              <button
                id="fetch-minimax-speech-models-btn"
                class="moe-btn-secondary"
              >
                ğŸµ æ‹‰å–è¯­éŸ³æ¨¡å‹
              </button>
            </div>
          </div>

          <!-- 3. åå°æ´»åŠ¨å¡ç‰‡ -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">ğŸ¤–</span>
              <h3>è§’è‰²åå°æ´»åŠ¨</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label class="toggle-switch-label">
                  <span class="toggle-switch-text">å¯ç”¨åå°æ´»åŠ¨</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="background-activity-switch" />
                    <span class="slider"></span>
                  </label>
                </label>
              </div>
              <div
                class="form-group"
                style="
                  margin-top: 15px;
                  padding-top: 15px;
                  border-top: 1px dashed #eee;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <div>
                  <span class="toggle-switch-text" style="font-weight: bold"
                    >å¼€å¯ç³»ç»Ÿå¼¹çª—</span
                  >
                  <!-- â–¼â–¼â–¼ ä¿®æ”¹åçš„å¸ƒå±€ï¼šå°†æŒ‰é’®å’Œæç¤ºè¯­æ”¾åœ¨ä¸€è¡Œï¼Œæ ·å¼æ›´ç²¾è‡´ â–¼â–¼â–¼ -->
                  <div
                    style="
                      font-size: 12px;
                      color: #888;
                      margin-top: 6px;
                      display: flex;
                      align-items: center;
                    "
                  >
                    <span>iOSéœ€æ·»åŠ åˆ°ä¸»å±å¹•ï¼Œå®‰å“éœ€æˆæƒ</span>
                    <button
                      id="check-notification-perm-btn"
                      style="
                        margin-left: 10px;
                        padding: 2px 10px;
                        background-color: rgba(0, 123, 255, 0.1);
                        color: #007bff;
                        border: 1px solid rgba(0, 123, 255, 0.2);
                        border-radius: 12px;
                        font-size: 11px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 3px;
                      "
                    >
                      <span>ğŸ”</span> æ£€æµ‹æƒé™
                    </button>
                    <button
                      id="test-system-notification-btn"
                      style="
                        margin-left: 5px;
                        padding: 2px 10px;
                        background-color: rgba(40, 167, 69, 0.1);
                        color: #28a745;
                        border: 1px solid rgba(40, 167, 69, 0.2);
                        border-radius: 12px;
                        font-size: 11px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 3px;
                      "
                    >
                      <span>ğŸ””</span> æµ‹è¯•å‘é€
                    </button>
                  </div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="system-notification-switch" />
                  <span class="slider"></span>
                </label>
              </div>
              <div
                id="background-activity-details"
                style="display: none; margin-top: 10px"
              >
                <div class="form-group">
                  <label>æ£€æµ‹é—´éš” (ç§’)</label>
                  <input
                    type="number"
                    id="background-interval-input"
                    min="30"
                    value="60"
                    class="moe-input center-text"
                  />
                </div>
                <div class="form-group">
                  <label>è§’è‰²é¢‘ç‡è®¾ç½®</label>
                  <div
                    id="background-activity-char-list"
                    class="moe-list-box"
                  ></div>
                  <div class="moe-btn-group">
                    <button id="bg-select-all-chars" class="moe-btn-mini">
                      å…¨é€‰
                    </button>
                    <button id="bg-deselect-all-chars" class="moe-btn-mini">
                      å…¨ä¸é€‰
                    </button>
                  </div>
                </div>
                <div class="form-group">
                  <label>è®¾ç½®é¢‘ç‡</label>
                  <div class="moe-btn-group">
                    <button class="moe-btn-mini bg-freq-btn" data-freq="low">
                      ä½
                    </button>
                    <button class="moe-btn-mini bg-freq-btn" data-freq="medium">
                      ä¸­
                    </button>
                    <button class="moe-btn-mini bg-freq-btn" data-freq="high">
                      é«˜
                    </button>
                    <button class="moe-btn-mini bg-freq-btn" data-freq="none">
                      å…³é—­
                    </button>
                  </div>
                </div>
              </div>
              <div class="moe-divider"></div>
              <div class="form-group">
                <label>æ‹‰é»‘å†·é™æœŸ (å°æ—¶)</label>
                <input
                  type="number"
                  id="block-cooldown-input"
                  min="0.1"
                  step="0.1"
                  value="1"
                  class="moe-input center-text"
                />
              </div>
            </div>
          </div>

          <!-- 4. å›¾åƒç”Ÿæˆå¡ç‰‡ -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">ğŸ¨</span>
              <h3>NovelAI ç”Ÿå›¾</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label class="toggle-switch-label">
                  <span class="toggle-switch-text">å¯ç”¨å›¾åƒç”Ÿæˆ</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="novelai-switch" />
                    <span class="slider"></span>
                  </label>
                </label>
              </div>
              <div id="novelai-details" style="display: none; margin-top: 10px">
                <div class="form-group">
                  <label>æ¨¡å‹</label>
                  <select id="novelai-model" class="moe-input">
                    <option value="nai-diffusion-4-curated-preview">
                      V4.5 Curated
                    </option>
                    <option value="nai-diffusion-4-5-full">V4.5 Full</option>
                    <option value="nai-diffusion-3">V3 Anime</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>API Key</label>
                  <div style="position: relative">
                    <input
                      type="password"
                      id="novelai-api-key"
                      class="moe-input"
                    />
                    <span
                      id="novelai-key-toggle"
                      style="
                        position: absolute;
                        right: 10px;
                        top: 10px;
                        cursor: pointer;
                      "
                      >ğŸ‘€</span
                    >
                  </div>
                </div>
                <div class="moe-btn-group">
                  <button
                    type="button"
                    id="novelai-settings-btn"
                    class="moe-btn-secondary"
                  >
                    è®¾ç½®
                  </button>
                  <button
                    type="button"
                    id="novelai-test-btn"
                    class="moe-btn-secondary"
                  >
                    æµ‹è¯•
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- 4.5. Pollinations ç”Ÿå›¾å¡ç‰‡ (æ–°å¢) -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">ğŸŒ¸</span>
              <h3>Pollinations ç”Ÿå›¾</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label>API Key (å¯é€‰ï¼Œç”¨äºé«˜çº§åŠŸèƒ½/å»æ°´å°)</label>
                <input
                  type="password"
                  id="pollinations-api-key"
                  placeholder="Bearer ..."
                  class="moe-input"
                />
                <p style="font-size: 12px; color: #888; margin-top: 5px">
                  * å¦‚æœç•™ç©ºï¼Œå°†ä½¿ç”¨å…è´¹å…¬å¼€æ¥å£ (å¯èƒ½åŒ…å«æ°´å°æˆ–å—é™)ã€‚
                </p>
              </div>
            </div>
          </div>

          <!-- 5. å­˜å‚¨ä¸å¤‡ä»½å¡ç‰‡ -->
          <div class="moe-card">
            <div class="moe-card-header">
              <span class="icon">ğŸ’¾</span>
              <h3>å­˜å‚¨ä¸å¤‡ä»½</h3>
            </div>
            <div class="moe-card-body">
              <div class="form-group">
                <label
                  >å›¾ç‰‡å‹ç¼©è´¨é‡:
                  <span id="image-quality-value">0.7</span></label
                >
                <input
                  type="range"
                  id="image-quality-slider"
                  min="0.1"
                  max="1.0"
                  step="0.1"
                  value="0.7"
                  class="moe-slider"
                />
              </div>
              <button class="moe-btn-secondary" id="compress-all-images-btn">
                ğŸ“‰ ä¸€é”®å‹ç¼©å›¾ç‰‡
              </button>
              <p
                id="image-data-size-display"
                style="
                  text-align: center;
                  font-size: 12px;
                  color: #aaa;
                  margin-top: 5px;
                "
              >
                ...
              </p>

              <div class="moe-divider"></div>

              <h4
                style="
                  font-size: 14px;
                  margin-bottom: 10px;
                  color: var(--accent-color);
                "
              >
                â˜ï¸ GitHub äº‘å¤‡ä»½
              </h4>
              <div class="form-group">
                <input
                  type="password"
                  id="github-token"
                  placeholder="Token"
                  class="moe-input"
                  style="margin-bottom: 5px"
                />
                <input
                  type="text"
                  id="github-username"
                  placeholder="ç”¨æˆ·å"
                  class="moe-input"
                  style="margin-bottom: 5px"
                />
                <input
                  type="text"
                  id="github-repo"
                  placeholder="ä»“åº“å"
                  class="moe-input"
                  style="margin-bottom: 5px"
                />
                <input
                  type="text"
                  id="github-path"
                  placeholder="è·¯å¾„ (å¯é€‰)"
                  class="moe-input"
                />
              </div>
              <div class="form-group">
                <label class="toggle-switch-label">
                  <span class="toggle-switch-text">è‡ªåŠ¨å¤‡ä»½ </span>
                  <input type="checkbox" id="github-auto-backup-switch" />
                  <span class="toggle-switch-slider"></span>
                </label>
              </div>
              <!-- åœ¨ github-path è¾“å…¥æ¡†ä¸‹æ–¹æ’å…¥ -->
              <div class="form-group" style="margin-top: 5px">
                <label>è‡ªåŠ¨å¤‡ä»½æ¨¡å¼</label>
                <div style="display: flex; gap: 10px">
                  <select
                    id="github-backup-mode"
                    class="moe-input"
                    style="flex: 1"
                  >
                    <option value="full">å…¨é‡</option>
                    <option value="stream">æµå¼ (åˆ†ç‰‡/ç¨³å®š)</option>
                  </select>
                  <input
                    type="number"
                    id="github-backup-interval"
                    class="moe-input"
                    style="width: 80px"
                    placeholder="åˆ†é’Ÿ"
                    value="30"
                    min="5"
                  />
                  <span style="align-self: center; font-size: 12px; color: #888"
                    >åˆ†é’Ÿ</span
                  >
                </div>
              </div>

              <div class="moe-btn-group">
                <button id="manual-github-backup-btn" class="moe-btn-secondary">
                  â˜ï¸ ä¸Šä¼  (å…¨é‡)
                </button>
                <button
                  id="manual-github-restore-btn"
                  class="moe-btn-secondary"
                >
                  ğŸ“¥ æ¢å¤ (å…¨é‡)
                </button>
              </div>
              <div class="moe-btn-group" style="margin-top: 10px">
                <button
                  id="git-stream-upload-btn"
                  class="moe-btn-secondary"
                  style="background-color: #6f42c1; color: white"
                >
                  ğŸŒŠ Gitæµå¼ä¸Šä¼ 
                </button>
                <button
                  id="git-stream-restore-btn"
                  class="moe-btn-secondary"
                  style="background-color: #6f42c1; color: white"
                >
                  ğŸ£ Gitæµå¼å¯¼å…¥
                </button>
              </div>
              <p style="font-size: 12px; color: #999; margin-top: 5px">
                *
                æµå¼æ¨¡å¼ä¼šå°†æ•°æ®æ‹†åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶(æŒ‰è¡¨)ä¸Šä¼ ï¼Œè§£å†³å¤§æ–‡ä»¶å¯¼è‡´å´©æºƒçš„é—®é¢˜ã€‚
              </p>

              <div class="moe-divider"></div>

              <h4
                style="
                  font-size: 14px;
                  margin-bottom: 10px;
                  color: var(--accent-color);
                "
              >
                ğŸ“¦ æœ¬åœ°å¤‡ä»½
              </h4>
              <div class="moe-btn-group">
                <button class="moe-btn-secondary" id="export-data-btn">
                  å¯¼å‡º
                </button>
                <button class="moe-btn-secondary" id="import-btn">å¯¼å…¥</button>
                <button class="moe-btn-secondary" id="export-data-stream-btn">
                  æµå¼å¯¼å‡º
                </button>
              </div>
              <button
                class="moe-btn-secondary"
                id="advanced-transfer-btn"
                style="margin-top: 8px; width: 100%"
              >
                é«˜çº§å¯¼å…¥/å¯¼å‡º
              </button>

              <div class="moe-divider"></div>
              <button class="moe-btn-danger" id="clear-orphaned-data-btn">
                ğŸ§¹ æ¸…ç†å¤±æ•ˆæ•°æ®
              </button>
              <div class="moe-divider"></div>
              <button
                class="moe-btn-secondary"
                id="repair-data-btn"
                style="
                  background-color: #ff9800;
                  color: white;
                  margin-bottom: 10px;
                  width: 100%;
                  font-weight: bold;
                "
              >
                ğŸ”§ ä¸€é”®ä¿®å¤ (ä¿®å¤æ•°æ®ç»“æ„é”™è¯¯)
              </button>
              <button
                class="moe-btn-danger"
                id="factory-reset-btn"
                style="
                  background-color: #c82333;
                  margin-top: 10px;
                  width: 100%;
                  font-weight: bold;
                "
              >
                ğŸ§¨ åˆå§‹åŒ– (æ¸…ç©ºå…¨éƒ¨æ•°æ®)
              </button>
            </div>
          </div>

          <div style="text-align: center; margin-bottom: 15px; margin-top: 5px">
            <a
              href="https://jcny642xl7ll.feishu.cn/wiki/KGsnwECKji2xdxkCqDbcZNOnndd"
              target="_blank"
              style="
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 10px 20px;
                background-color: rgba(255, 255, 255, 0.9);
                color: var(--accent-color, #007bff);
                text-decoration: none;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                border: 1px solid rgba(0, 0, 0, 0.05);
                transition: transform 0.2s;
              "
            >
              <span>ğŸ“–</span> å…”kå†™çš„ä¸€äº›æ•™ç¨‹
            </a>
          </div>

          <div style="margin: 10px 0; text-align: center">
            <button
              onclick="window.openBugStation()"
              style="
                background: #fff0f6;
                color: #eb2f96;
                border: 2px dashed #ffadd2;
                border-radius: 15px;
                padding: 8px 20px;
                font-size: 13px;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                gap: 5px;
              "
            >
              ğŸš‘ æŠ¥é”™æ€¥æ•‘ç«™
              <span style="font-size: 10px; opacity: 0.7">(ç‚¹æˆ‘å¤åˆ¶é”™è¯¯)</span>
            </button>
          </div>

          <!-- åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢è¢«æ‚¬æµ®æŒ‰é’®é®æŒ¡ -->
          <div style="height: 80px"></div>
        </div>

        <!-- â˜…â˜…â˜… èŒç³»æ‚¬æµ®ä¿å­˜æŒ‰é’® â˜…â˜…â˜… -->
        <button id="save-api-settings-btn" class="moe-fab-save">
          ğŸ’¾<span style="font-size: 12px; display: block; margin-top: -2px"
            >ä¿å­˜</span
          >
        </button>

        <!-- éšè—çš„ input -->
        <input
          id="import-data-input"
          type="file"
          accept="application/json"
          hidden
        />
      </div>

      <div id="chat-list-screen" class="screen">
        <!-- ä¸»å¤´éƒ¨ (åªåœ¨æ¶ˆæ¯åˆ—è¡¨æ˜¾ç¤º) -->
        <div class="header" id="main-chat-list-header">
          <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
          <span id="chat-list-title">æ¶ˆæ¯</span>
          <div class="header-actions">
            <span class="action-btn" id="add-group-chat-btn" title="åˆ›å»ºç¾¤èŠ">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M21 21L19 19"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>

            <span
              class="action-btn"
              id="import-character-card-btn"
              title="å¯¼å…¥è§’è‰²å¡"
            >
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </span>

            <span class="action-btn" id="add-chat-btn">+</span>
          </div>
        </div>

        <!-- æ¶ˆæ¯åˆ—è¡¨è§†å›¾ -->
        <div id="messages-view" class="chat-list-view active">
          <div id="chat-list">
            <!-- JSä¼šåœ¨è¿™é‡Œç”ŸæˆèŠå¤©åˆ—è¡¨ -->
          </div>
        </div>

        <!-- åŠ¨æ€ç•Œé¢è§†å›¾ -->
        <div id="qzone-screen" class="chat-list-view">
          <div class="qzone-header">
            <span class="back-btn" id="qzone-back-btn">â€¹</span>
            <!-- è¿™ä¸ªæŒ‰é’®ç°åœ¨åªè´Ÿè´£ä»åŠ¨æ€è¿”å› -->
            <span>å¥½å‹åŠ¨æ€</span>

            <div class="header-actions">
              <span
                class="action-btn"
                id="clear-qzone-posts-btn"
                title="æ¸…ç©ºåŠ¨æ€"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                  />
                </svg>
              </span>
            </div>
          </div>
          <div class="qzone-content">
            <div class="qzone-profile-header">
              <div id="qzone-banner-container" class="qzone-banner-container">
                <img
                  id="qzone-banner-img"
                  src="https://files.catbox.moe/r5heyt.gif"
                  alt="èƒŒæ™¯"
                />
                <input
                  type="file"
                  id="qzone-banner-input"
                  accept="image/*"
                  hidden
                />
              </div>
              <div class="qzone-user-info">
                <div id="qzone-avatar-container" class="qzone-avatar-container">
                  <img
                    id="qzone-avatar-img"
                    src="https://files.catbox.moe/q6z5fc.jpeg"
                    alt="å¤´åƒ"
                  />
                  <input
                    type="file"
                    id="qzone-avatar-input"
                    accept="image/*"
                    hidden
                  />
                </div>
                <span id="qzone-nickname">{{user}}</span>
              </div>
            </div>
            <div class="qzone-actions-bar">
              <div class="action-item" id="create-shuoshuo-btn">
                <span>è¯´è¯´</span>
              </div>
              <div class="action-item" id="create-post-btn">
                <span>åŠ¨æ€</span>
              </div>
              <div class="action-item" id="open-album-btn">
                <span>ç›¸å†Œ</span>
              </div>
            </div>
            <div id="qzone-posts-list"></div>
          </div>
        </div>

        <!-- æ”¶è—ç•Œé¢è§†å›¾ -->
        <div id="favorites-view" class="chat-list-view">
          <div class="header">
            <span class="back-btn" id="favorites-back-btn">â€¹</span>
            <span>æˆ‘çš„æ”¶è—</span>
            <!-- æ–°å¢çš„ç¼–è¾‘æŒ‰é’® -->
            <span class="action-btn" id="favorites-edit-btn">ç¼–è¾‘</span>
          </div>

          <!-- æœç´¢æ å®¹å™¨ -->
          <div class="search-bar-container">
            <input
              type="search"
              id="favorites-search-input"
              placeholder="æœç´¢æ”¶è—çš„æ ‡é¢˜ã€å†…å®¹æˆ–ä½œè€…..."
            />
            <button
              id="favorites-search-clear-btn"
              class="search-clear-btn"
              style="display: none"
            >
              Ã—
            </button>
          </div>

          <div id="favorites-list" class="list-container">
            <!-- æ”¶è—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>

          <!-- æ–°å¢ï¼šæ”¶è—é¡µåº•éƒ¨æ“ä½œæ  -->
          <div id="favorites-action-bar" style="display: none">
            <button id="favorites-delete-selected-btn" class="action-bar-btn">
              åˆ é™¤ (0)
            </button>
          </div>
        </div>

        <div id="memories-view" class="chat-list-view">
          <div class="header">
            <span class="back-btn" id="memories-back-btn">â€¹</span>
            <span>æˆ‘ä»¬çš„å›å¿†</span>
            <span class="action-btn" id="add-countdown-btn">+</span>
          </div>
          <div
            id="memories-list"
            class="list-container"
            style="
              padding: 15px;
              display: flex;
              flex-direction: column;
              gap: 15px;
            "
          >
            <!-- å›å¿†å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <div id="chat-list-bottom-nav">
          <div class="nav-item active" data-view="messages-view">
            <span>æ¶ˆæ¯</span>
          </div>
          <div class="nav-item" data-view="qzone-screen">
            <span>åŠ¨æ€</span>
          </div>

          <div class="nav-item" data-view="memories-view">
            <span>å›å¿†</span>
          </div>

          <div class="nav-item" data-view="favorites-view">
            <span>æ”¶è—</span>
          </div>
        </div>
      </div>

      <div id="album-screen" class="screen">
        <!-- 1. é¡µé¢å¤´éƒ¨ï¼ŒåŒ…å«è¿”å›æŒ‰é’®å’Œæ ‡é¢˜ -->
        <div class="header">
          <span class="back-btn" id="album-back-btn">â€¹</span>
          <span>æˆ‘çš„ç›¸å†Œ</span>
          <span class="action-btn" id="create-album-btn-page">+</span>
        </div>

        <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
        <div class="list-container">
          <div id="album-grid-page">
            <!-- ç›¸å†Œåˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
        </div>
      </div>

      <div id="album-photos-screen" class="screen">
        <!-- 1. é¡µé¢å¤´éƒ¨ -->
        <div class="header">
          <span class="back-btn" id="album-photos-back-btn">â€¹</span>
          <span id="album-photos-title">ç›¸å†Œåç§°</span>
          <span class="action-btn" id="album-upload-photo-btn">ä¸Šä¼ </span>
        </div>

        <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
        <div class="list-container">
          <div id="photos-grid-page">
            <!-- ç…§ç‰‡åˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>

          <div id="photo-viewer-modal" class="modal">
            <!-- 1. å…³é—­æŒ‰é’® -->
            <button id="photo-viewer-close-btn">Ã—</button>

            <!-- 2. ä¸Šä¸€å¼ ç…§ç‰‡æŒ‰é’® -->
            <button id="photo-viewer-prev-btn" class="nav-arrow">â€¹</button>

            <!-- 3. å›¾ç‰‡å®¹å™¨ -->
            <div class="photo-viewer-content">
              <img id="photo-viewer-image" src="" alt="å…¨å±ç…§ç‰‡é¢„è§ˆ" />
            </div>

            <!-- 4. ä¸‹ä¸€å¼ ç…§ç‰‡æŒ‰é’® -->
            <button id="photo-viewer-next-btn" class="nav-arrow">â€º</button>
          </div>
        </div>
      </div>

      <input
        type="file"
        id="album-photo-input"
        accept="image/*"
        multiple
        hidden
      />

      <div id="chat-interface-screen" class="screen">
        <div class="header">
          <!-- é»˜è®¤æ§ä»¶ï¼šåŒ…å«æ ‡é¢˜ã€çŠ¶æ€æ å’Œå¸¸è§„æŒ‰é’® -->
          <div class="default-controls">
            <span class="back-btn" id="back-to-list-btn">â€¹</span>

            <!-- æ ‡é¢˜å’ŒçŠ¶æ€çš„å®¹å™¨ -->
            <div id="chat-header-title-wrapper">
              <div id="chat-header-main-line">
                <span id="chat-header-title">èŠå¤©å¯¹è±¡</span>
                <!-- ã€å…¨æ–°ã€‘ç¾¤å…¬å‘ŠæŒ‰é’® -->
                <span id="group-announcement-btn" title="ç¾¤å…¬å‘Š">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="3"
                      y="3"
                      width="18"
                      height="18"
                      rx="2"
                      ry="2"
                    ></rect>
                    <line x1="7" y1="15" x2="17" y2="15"></line>
                  </svg>
                </span>
              </div>
              <div id="chat-header-status">
                <span class="status-dot"></span>
                <span class="status-text">åœ¨çº¿</span>
              </div>
            </div>

            <div class="header-actions">
              <!-- å¿ƒå£°æŒ‰é’® -->
              <span
                class="action-btn"
                id="char-heart-btn"
                title="å¿ƒå£°"
                style="display: none; cursor: pointer"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="#ff4d6d"
                  stroke="#ffc3d0"
                  stroke-width="1.5"
                >
                  <path
                    d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
                  />
                </svg>
              </span>
              <span class="action-btn" id="listen-together-btn" title="ä¸€èµ·å¬"
                ><img
                  src="https://i.postimg.cc/CxjpF6gK/yi-qi-ting.png"
                  alt="ä¸€èµ·å¬"
              /></span>
              <span class="action-btn" id="chat-settings-btn" title="èŠå¤©è®¾ç½®"
                ><img
                  src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png"
                  alt="è®¾ç½®"
              /></span>
            </div>
          </div>

          <!-- å¤šé€‰æ¨¡å¼æ§ä»¶ -->
          <div class="selection-controls">
            <span id="selection-cancel-btn">å–æ¶ˆ</span>
            <span id="selection-count"></span>
            <div class="header-actions">
              <span id="selection-favorite-btn" class="action-btn">æ”¶è—</span>
              <span id="selection-share-btn" class="action-btn">åˆ†äº«</span>
              <span
                id="selection-delete-btn"
                class="action-btn"
                style="color: #ff3b30"
                >åˆ é™¤</span
              >
            </div>
          </div>
        </div>

        <div
          id="chat-pet-container"
          style="
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 10;
          "
        >
          <div
            id="chat-pet"
            style="
              display: none;
              position: absolute;
              cursor: grab;
              user-select: none;
              pointer-events: all;
              font-size: 80px;
              line-height: 1;
              text-align: center;
            "
          >
            <!-- å® ç‰©ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
          </div>
        </div>

        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ (ä¿æŒä¸å˜) -->
        <div id="chat-messages">
          <div id="typing-indicator">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ (è¿™æ˜¯ä¿®æ”¹åçš„æœ€ç»ˆç‰ˆæœ¬) -->
        <div id="chat-input-area">
          <div id="reply-preview-bar">
            <div class="reply-preview-content">
              <div class="sender">å›å¤ xxx:</div>
              <div class="text">è¢«å¼•ç”¨çš„æ¶ˆæ¯å†…å®¹...</div>
            </div>
            <span id="cancel-reply-btn">Ã—</span>
          </div>

          <div id="chat-input-actions-top">
            <button
              id="open-sticker-panel-btn"
              class="chat-action-icon-btn action-button"
              title="è¡¨æƒ…é¢æ¿"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>

            <!-- â€œé‡æ–°ç”Ÿæˆå›å¤â€æŒ‰é’®çš„æ–°å®¶ -->
            <button id="reroll-btn" class="action-button" title="é‡æ–°ç”Ÿæˆå›å¤">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </button>

            <button
              id="quick-reply-btn"
              class="chat-action-icon-btn action-button"
              title="å¿«æ·å›å¤"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <!-- æ°”æ³¡è½®å»“ -->
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
                <!-- é‡Œé¢çš„ä¸¤è¡Œæ–‡å­—çº¿ï¼Œä»£è¡¨é¢„è®¾å†…å®¹ -->
                <line x1="8" y1="9" x2="16" y2="9"></line>
                <line x1="8" y1="13" x2="14" y2="13"></line>
              </svg>
            </button>

            <button
              id="send-photo-btn"
              class="chat-action-icon-btn action-button"
              title="å‘é€ç…§ç‰‡"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                />
                <circle cx="12" cy="13" r="4" />
              </svg>
            </button>
            <button
              id="upload-image-btn"
              class="chat-action-icon-btn action-button"
              title="ä¸Šä¼ å›¾ç‰‡"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <button
              id="transfer-btn"
              class="chat-action-icon-btn action-button"
              title="è½¬è´¦"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M7 4L12 12L17 4M12 12V20M8 10H16M8 13H16"></path>
              </svg>
            </button>
            <button
              id="voice-message-btn"
              class="chat-action-icon-btn action-button"
              title="å‘é€è¯­éŸ³"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
                />
                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                <path d="M12 19v4" />
                <path d="M8 23h8" />
              </svg>
            </button>
            <button
              id="send-waimai-request-btn"
              class="chat-action-icon-btn action-button"
              title="å‘èµ·å¤–å–è¯·æ±‚"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" />
                <line x1="3" y1="6" x2="21" y2="6" />
                <path d="M16 10a4 4 0 0 1-8 0" />
              </svg>
            </button>
            <button
              id="video-call-btn"
              class="chat-action-icon-btn action-button"
              title="è§†é¢‘é€šè¯"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
              </svg>
            </button>
            <button
              id="group-video-call-btn"
              class="chat-action-icon-btn action-button"
              title="ç¾¤è§†é¢‘é€šè¯"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </button>
            <button
              id="send-poll-btn"
              class="chat-action-icon-btn action-button"
              title="å‘èµ·æŠ•ç¥¨"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M8 6h10" />
                <path d="M6 6h.01" />
                <path d="M8 12h10" />
                <path d="M6 12h.01" />
                <path d="M8 18h10" />
                <path d="M6 18h.01" />
              </svg>
            </button>
            <button
              id="share-link-btn"
              class="chat-action-icon-btn action-button"
              title="åˆ†äº«é“¾æ¥"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"
                ></path>
                <path
                  d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"
                ></path>
              </svg>
            </button>

            <button
              id="send-location-btn"
              class="chat-action-icon-btn action-button"
              title="å‘é€å®šä½"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
            </button>

            <!-- æ—¶é—´è½´/å­˜æ¡£æŒ‰é’® (æ”¾å…¥å·¥å…·æ ) -->
            <button
              id="timeline-branch-btn"
              class="chat-action-icon-btn action-button"
              title="æ—¶é—´è½´/å­˜æ¡£"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <!-- è¿™æ˜¯ä¸€ä¸ªåˆ†å‰çº¿çš„å›¾æ ‡ -->
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 21v-6"></path>
                <path d="M12 9V3"></path>
                <path
                  d="M7 3.3a9.8 9.8 0 0 0-4.7 8.7c0 5.5 4.5 10 10 10s10-4.5 10-10a9.8 9.8 0 0 0-4.7-8.7"
                ></path>
              </svg>
            </button>

            <button
              id="open-tarot-btn"
              class="chat-action-icon-btn action-button"
              title="å¡”ç½—å åœ"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <!-- èƒŒæ™¯å·¦ä¾§å¡ç‰Œ -->
                <path
                  d="M7 6.5L4 7.5V17.5L7 16.5V6.5Z"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linejoin="round"
                />
                <!-- èƒŒæ™¯å³ä¾§å¡ç‰Œ -->
                <path
                  d="M17 6.5L20 7.5V17.5L17 16.5V6.5Z"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linejoin="round"
                />
                <!-- å‰æ–¹ä¸­å¿ƒå¡ç‰Œ -->
                <rect
                  x="7"
                  y="5"
                  width="10"
                  height="15"
                  rx="1.5"
                  stroke="currentColor"
                  stroke-width="2.6"
                />
                <!-- ä¸­å¿ƒå¡ç‰Œçš„æ˜Ÿæ˜Ÿ -->
                <path
                  d="M12 9.5L13.12 11.79L15.61 12.17L13.8 13.92L14.24 16.4L12 15.2L9.76 16.4L10.2 13.92L8.39 12.17L10.88 11.79L12 9.5Z"
                  fill="currentColor"
                />
              </svg>
            </button>

            <button
              id="pet-action-btn"
              class="chat-action-icon-btn action-button"
              title="æˆ‘çš„å® ç‰©"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <!-- ä¸»ä½“è½®å»“: è€³æœµä¸å¯¹ç§°ï¼Œè¥é€ æ­ªå¤´æ•ˆæœ -->
                <path
                  d="M3.5 14.5C3.5 20.5 20.5 20.5 20.5 14.5C20.5 9 17.5 5.5 12.5 8.7C6.5 4.5 3.5 9 3.5 14.5Z"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <!-- çœ¼ç› -->
                <circle cx="8.5" cy="15" r="1.5" fill="currentColor" />
                <circle cx="15.5" cy="15" r="1.5" fill="currentColor" />
                <!-- å·¦è¾¹ä¸¤æ ¹å°èƒ¡é¡» -->
                <path
                  d="M4.5 14.3L2.5 13.3"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linecap="round"
                />
                <path
                  d="M4.5 15.7L2.5 16.7"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linecap="round"
                />
                <!-- å³è¾¹ä¸¤æ ¹å°èƒ¡é¡» -->
                <path
                  d="M19.5 14.3L21.5 13.3"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linecap="round"
                />
                <path
                  d="M19.5 15.7L21.5 16.7"
                  stroke="currentColor"
                  stroke-width="2.6"
                  stroke-linecap="round"
                />
              </svg>
            </button>
            <!-- æå…‰å¤šåª’ä½“æŒ‰é’® (å·²æ”¹ä¸ºå•è‰²) -->
            <button
              id="aurora-media-btn"
              class="chat-action-icon-btn action-button"
              title="æ¼«æ¸¸å…±èµ (è§†é¢‘/å°è¯´)"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 3C7.03 3 3 7.03 3 12C3 16.97 7.03 21 12 21C16.97 21 21 16.97 21 12C21 7.03 16.97 3 12 3Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M15 9L9 15M9 9L15 15"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M12 8V16"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>
          <div id="chat-input-main-row">
            <textarea
              id="chat-input"
              rows="1"
              placeholder="è¾“å…¥æ¶ˆæ¯..."
            ></textarea>
            <div id="input-actions-wrapper">
              <button id="wait-reply-btn" title="ç­‰å¾…å›å¤">
                <img
                  src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png"
                  alt="ç­‰å¾…å›å¤"
                />
              </button>
              <button id="send-btn" class="action-button">å‘é€</button>
            </div>
          </div>
        </div>

        <div id="chat-lock-overlay">
          <div id="chat-lock-content"></div>
        </div>

        <div id="sticker-panel">
          <div id="sticker-panel-header">
            <span class="panel-btn" id="close-sticker-panel-btn">å–æ¶ˆ</span>
            <span class="title">è¡¨æƒ…åŒ…</span>
            <!-- â€œç¼–è¾‘â€å’Œâ€œå®Œæˆâ€æŒ‰é’® -->
            <div style="display: flex; gap: 10px">
              <span class="panel-btn" id="edit-user-stickers-btn">ç¼–è¾‘</span>
              <span
                class="panel-btn"
                id="done-user-stickers-btn"
                style="display: none"
                >å®Œæˆ</span
              >
              <span class="panel-btn" id="add-sticker-btn">æ·»åŠ </span>
              <span class="panel-btn" id="upload-sticker-btn">ä¸Šä¼ </span>
            </div>
          </div>
          <div id="sticker-grid"></div>

          <!-- åœ¨ #sticker-panel ä¸­ï¼Œæ‰¾åˆ° id="sticker-panel-footer" -->

          <div id="sticker-category-tabs">
            <!-- åˆ†ç±»èƒ¶å›Šå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>

          <div id="sticker-panel-footer" style="display: none">
            <!-- ç§»åŠ¨è¡¨æƒ…æŒ‰é’® -->
            <button id="move-selected-stickers-btn">ç§»åŠ¨åˆ°åˆ†ç±»...</button>
            <!-- åˆ é™¤è¡¨æƒ…æŒ‰é’® -->
            <button id="delete-selected-user-stickers-btn">åˆ é™¤å·²é€‰ (0)</button>
          </div>
        </div>

        <input
          type="file"
          id="sticker-upload-input"
          accept="image/*"
          style="display: none"
          multiple
        />
        <input
          type="file"
          id="image-upload-input"
          accept="image/*"
          style="display: none"
        />

        <!-- éŸ³ä¹æ’­æ”¾å™¨ (ä¿æŒä¸å˜) -->
        <div id="music-player-overlay">
          <div class="music-player-window">
            <!-- 1. é¡¶éƒ¨å¤´åƒåŒºåŸŸ -->
            <div id="music-avatars-container">
              <img id="music-char-avatar" src="" alt="è§’è‰²å¤´åƒ" />
              <svg id="heartbeat-line" viewBox="0 0 80 30">
                <path
                  class="heartbeat-path"
                  d="M 5 15 Q 20 0 30 15 T 55 15 L 75 15"
                ></path>
                <path
                  class="heartbeat-heart"
                  d="M 0 -2 a 2 2 0 0 1 4 0 v 2 a 2 2 0 0 1 -4 0 z"
                ></path>
              </svg>
              <img id="music-user-avatar" src="" alt="ç”¨æˆ·å¤´åƒ" />
            </div>

            <div id="music-time-counter">å·²ç»ä¸€èµ·å¬äº†0.0å°æ—¶</div>

            <!-- 2. é¡¶éƒ¨æ“ä½œæŒ‰é’® -->
            <div class="music-player-top-actions">
              <div class="top-left-cluster">
                <button id="music-return-btn">â€¹</button>
                <button id="music-exit-btn">Ã—</button>
              </div>
              <span id="music-playlist-btn">â˜°</span>
            </div>

            <!-- 3. å°é¢å’Œæ­Œè¯çš„åˆ‡æ¢å®¹å™¨ -->
            <div id="music-display-area">
              <img
                id="music-album-cover"
                src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png"
                alt="æ­Œæ›²å°é¢"
              />
              <div id="music-lyrics-container">
                <div id="music-lyrics-list">
                  <div class="lyric-line">â™ª æš‚æ— æ­Œè¯ â™ª</div>
                </div>
              </div>
            </div>

            <!-- 4. æ­Œæ›²ä¿¡æ¯ -->
            <div id="music-player-song-title">è¯·æ·»åŠ æ­Œæ›²</div>
            <div id="music-player-artist">...</div>

            <!-- 5. æ’­æ”¾æ§åˆ¶åŒº (ä¿æŒä¸å˜) -->
            <div class="music-player-controls-wrapper">
              <div class="music-progress-bar-container">
                <div id="music-current-time" class="time-display">0:00</div>
                <div class="progress-bar">
                  <div id="music-progress-fill" class="progress-bar-fill"></div>
                </div>
                <div id="music-total-time" class="time-display">0:00</div>
              </div>
              <div class="music-controls">
                <button id="music-prev-btn">â—€</button>
                <button id="music-play-pause-btn" class="play-pause-btn">
                  â–¶
                </button>
                <button id="music-next-btn">â–¶</button>
                <button id="music-mode-btn">é¡ºåº</button>
                <button id="toggle-lyrics-bar-btn" title="æ¡Œé¢æ­Œè¯">
                  æ‚¬æµ®
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="music-playlist-panel">
        <div class="playlist-header">
          <span class="panel-btn" id="close-playlist-btn">è¿”å›</span>
          <span>æ’­æ”¾åˆ—è¡¨</span>
          <div>
            <span
              class="panel-btn"
              id="delete-expired-songs-btn"
              title="æ¸…ç†å¤±æ•ˆçš„æœç´¢æ­Œæ›²"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M3 6H5H21"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>
            <span class="panel-btn" id="add-song-local-btn">æœ¬åœ°</span>
            <span class="panel-btn" id="add-song-url-btn">URL</span>
            <span class="panel-btn" id="add-song-search-btn">æœç´¢</span>
          </div>
        </div>

        <div class="playlist-body" id="playlist-body"></div>
      </div>
      <input
        type="file"
        id="local-song-upload-input"
        accept="audio/*"
        multiple
        style="display: none"
      />
      <input
        type="file"
        id="lrc-upload-input"
        accept=".lrc"
        style="display: none"
      />
    </div>

    <!-- å¤–è§‚è®¾ç½®é¡µé¢ (å·²ä¿®å¤IDå’Œå¸ƒå±€) -->
    <div id="wallpaper-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>å¤–è§‚è®¾ç½®</span>
        <span style="width: 30px"></span>
      </div>

      <!-- å†…å®¹æ»šåŠ¨åŒºåŸŸ -->
      <div class="form-container settings-scroll-container">
        <!-- 1. é”å±ä¸å®‰å…¨å¡ç‰‡ -->
        <div class="settings-group-card">
          <div class="settings-section-title">ğŸ”’ é”å±ä¸å®‰å…¨</div>

          <div class="setting-row">
            <label class="setting-label">å¯ç”¨é”å±ç•Œé¢</label>
            <label class="toggle-switch-label">
              <input type="checkbox" id="enable-lock-screen-toggle" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>

          <div class="setting-item">
            <label>é”å±å¯†ç  (ç•™ç©ºåˆ™æ— )</label>
            <input
              type="text"
              id="password-set-input"
              class="moe-input"
              placeholder="è®¾ç½®è§£é”å¯†ç "
            />
          </div>

          <div class="setting-item">
            <label>é”å±å£çº¸</label>
            <div class="preview-upload-box">
              <div id="lockscreen-wallpaper-preview" class="mini-preview">
                é¢„è§ˆ
              </div>
              <button
                class="upload-btn-pill"
                onclick="
                  document
                    .getElementById('lockscreen-wallpaper-upload-input')
                    .click()
                "
              >
                æ›´æ¢å£çº¸
              </button>
            </div>
            <input
              type="file"
              id="lockscreen-wallpaper-upload-input"
              accept="image/*"
              hidden
            />
          </div>
        </div>
        <!-- 5. é«˜çº§ç¾åŒ– (CSS) å¡ç‰‡ -->
        <div class="settings-group-card">
          <div class="settings-section-title">è‡ªå®šä¹‰cssç¾åŒ– (CSS)</div>

          <div class="setting-item">
            <div style="display: flex; gap: 5px; margin-bottom: 5px">
              <select
                id="theme-selector"
                class="moe-input select"
                style="flex: 1"
              ></select>
              <button id="rename-theme-btn" class="btn-icon">âœï¸</button>
              <button id="delete-theme-btn" class="btn-icon danger">ğŸ—‘ï¸</button>
            </div>
            <textarea
              id="theme-css-editor"
              class="moe-input code-area"
              rows="6"
              placeholder="åœ¨æ­¤è¾“å…¥CSSä»£ç ..."
            ></textarea>
            <div class="css-actions">
              <button id="apply-theme-btn" class="upload-btn-pill primary">
                åº”ç”¨
              </button>
              <button id="save-theme-btn" class="upload-btn-pill">ä¿å­˜</button>
              <button id="save-as-new-theme-btn" class="upload-btn-pill">
                å¦å­˜ä¸º
              </button>
              <button id="export-theme-btn" class="upload-btn-pill secondary">
                å¯¼å‡º
              </button>
              <button id="import-theme-btn" class="upload-btn-pill secondary">
                å¯¼å…¥
              </button>
              <button
                id="reset-theme-css-btn"
                class="upload-btn-pill danger"
                style="background-color: #ff3b30; color: white"
              >
                é‡ç½®
              </button>
              <button
                id="manage-char-css-btn"
                class="upload-btn-pill"
                style="background-color: #ff9800; color: white"
              >
                æ¸…ç†è§’è‰²CSS
              </button>
              <input
                type="file"
                id="import-theme-input"
                accept=".json, .txt, .css, .docx"
                hidden
              />
            </div>
          </div>
        </div>

        <!-- 2. ä¸»å±å¹•è§†è§‰å¡ç‰‡ -->
        <div class="settings-group-card">
          <div class="settings-section-title">ğŸ“± ä¸»å±å¹•è§†è§‰</div>

          <div class="setting-row">
            <label class="setting-label">æ˜¾ç¤ºçŠ¶æ€æ </label>
            <label class="toggle-switch-label">
              <input type="checkbox" id="show-status-bar-toggle" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>

          <div class="setting-row">
            <label class="setting-label">å¤œé—´æ¨¡å¼</label>
            <label class="toggle-switch-label">
              <!-- â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šID æ”¹å› theme-toggle-switchï¼Œè§£å†³æŠ¥é”™ â˜…â˜…â˜… -->
              <input type="checkbox" id="theme-toggle-switch" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>

          <div class="setting-row">
            <label class="setting-label">å»é™¤æ–‡å­—é˜´å½±</label>
            <label class="toggle-switch-label">
              <input type="checkbox" id="remove-home-font-shadow-toggle" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>

          <div class="setting-item">
            <label>ä¸»å±å¹•å£çº¸</label>
            <div class="preview-upload-box">
              <div id="wallpaper-preview" class="mini-preview">é¢„è§ˆ</div>
              <button
                class="upload-btn-pill"
                onclick="
                  document.getElementById('wallpaper-upload-input').click()
                "
              >
                æ›´æ¢å£çº¸
              </button>
            </div>
            <input
              type="file"
              id="wallpaper-upload-input"
              accept="image/*"
              hidden
            />
          </div>

          <div class="setting-item">
            <label>å›¾æ ‡/ç»„ä»¶å­—ä½“é¢œè‰²</label>
            <div class="color-picker-wrapper">
              <!-- 1. é¢œè‰²é€‰æ‹©å™¨ (ä¿æŒåŸID) -->
              <input
                type="color"
                id="home-icon-widget-text-color-picker"
                value="#FFFFFF"
              />

              <!-- 2. æ–‡æœ¬è¾“å…¥æ¡†ï¼Œå…è®¸æ‰‹åŠ¨è¾“å…¥é¢œè‰²ä»£ç  -->
              <input
                type="text"
                id="home-icon-widget-text-color-input"
                placeholder="#FFFFFF"
                maxlength="7"
                spellcheck="false"
              />
            </div>
          </div>

          <!-- ä¸»å±å¹•é¢„è®¾éƒ¨åˆ† -->
          <div class="setting-item">
            <label>ä¸»å±å¹•é¢„è®¾ç®¡ç†</label>
            <div
              class="preset-manager-container"
              style="margin-top: 5px; border: none; padding: 0"
            >
              <div class="form-group">
                <select
                  id="home-preset-selector"
                  class="moe-input select"
                ></select>
                <div class="preset-manager-controls compact">
                  <button
                    id="apply-home-preset-btn"
                    class="preset-btn-capsule preset-btn-apply"
                    disabled
                  >
                    åº”ç”¨
                  </button>
                  <button
                    id="save-home-preset-btn"
                    class="preset-btn-capsule preset-btn-save"
                  >
                    ä¿å­˜å½“å‰
                  </button>
                  <button
                    id="update-home-preset-btn"
                    class="preset-btn-capsule preset-btn-secondary"
                    disabled
                  >
                    æ›´æ–°
                  </button>
                  <button
                    id="rename-home-preset-btn"
                    class="preset-btn-capsule preset-btn-secondary"
                    disabled
                  >
                    é‡å‘½å
                  </button>
                  <button
                    id="delete-home-preset-btn"
                    class="preset-btn-capsule preset-btn-delete"
                    disabled
                  >
                    åˆ é™¤
                  </button>
                  <button
                    id="import-home-preset-btn"
                    class="preset-btn-capsule preset-btn-secondary"
                  >
                    å¯¼å…¥
                  </button>
                  <button
                    id="export-home-preset-btn"
                    class="preset-btn-capsule preset-btn-secondary"
                    disabled
                  >
                    å¯¼å‡º
                  </button>
                  <input
                    type="file"
                    id="import-home-preset-input"
                    accept=".json"
                    hidden
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- â˜…â˜…â˜… æ–°å¢ï¼šè·¯äººå¤´åƒåº“å¡ç‰‡ â˜…â˜…â˜… -->
        <div class="settings-group-card">
          <div class="settings-section-title">ğŸ‘¥ å…¨å±€è·¯äººå¤´åƒåº“</div>
          <div class="setting-item">
            <label>ç”¨äºç”ŸæˆéšæœºNPCã€è¯„è®ºåŒºçš„å¤´åƒ</label>
            <div class="moe-btn-group">
              <button
                id="manage-passerby-avatars-btn"
                class="moe-btn-secondary"
              >
                ğŸ“‚ ç®¡ç†å›¾åº“
              </button>
              <button id="add-passerby-avatar-btn" class="moe-btn-secondary">
                â• æ·»åŠ å¤´åƒ
              </button>
            </div>
          </div>
        </div>

        <!-- 3. App å›¾æ ‡ä¸åç§°å¡ç‰‡ -->
        <div class="settings-group-card">
          <div class="settings-section-title">ğŸ¨ å›¾æ ‡ä¸åç§°</div>
          <div class="setting-item">
            <label>App å›¾æ ‡å®šåˆ¶</label>
            <div id="icon-settings-grid" class="icon-grid-compact">
              <!-- JSç”Ÿæˆ -->
            </div>
          </div>

          <div class="setting-item">
            <label>App åç§°å®šåˆ¶</label>
            <div id="icon-rename-grid" class="name-grid-compact">
              <!-- JSç”Ÿæˆ -->
            </div>
            <button
              class="form-button-secondary small-btn"
              id="reset-app-names-btn"
            >
              æ¢å¤é»˜è®¤åå­—
            </button>
          </div>
        </div>

        <!-- 4. å£°éŸ³ä¸èƒŒæ™¯å¡ç‰‡ -->
        <div class="settings-group-card">
          <div class="settings-section-title">ğŸµ å£°éŸ³ä¸èƒŒæ™¯</div>

          <div class="setting-item">
            <label>æ¥ç”µé“ƒå£° URL</label>
            <input
              type="text"
              id="ringtone-url-input"
              class="moe-input"
              placeholder="éŸ³é¢‘é“¾æ¥..."
            />
          </div>

          <div class="setting-item">
            <label>æç¤ºéŸ³ URL</label>
            <input
              type="text"
              id="notification-sound-url-input"
              class="moe-input"
              placeholder="éŸ³é¢‘é“¾æ¥..."
            />
          </div>

          <div class="setting-item">
            <label>å…¨å±€èŠå¤©èƒŒæ™¯</label>
            <div class="preview-upload-box">
              <!-- â˜…â˜…â˜… ä¿®æ”¹ç‚¹ï¼šåˆ é™¤äº† landscape ç±»åï¼Œç°åœ¨å®ƒæ˜¯ç«–å±çš„äº† â˜…â˜…â˜… -->
              <div id="global-bg-preview" class="mini-preview">é¢„è§ˆ</div>
              <div class="btn-col">
                <button
                  class="upload-btn-pill"
                  onclick="
                    document.getElementById('global-bg-upload-input').click()
                  "
                >
                  ä¸Šä¼ èƒŒæ™¯
                </button>
                <button
                  class="upload-btn-pill danger"
                  id="remove-global-bg-btn"
                >
                  ç§»é™¤èƒŒæ™¯
                </button>
              </div>
            </div>
            <input
              type="file"
              id="global-bg-upload-input"
              accept="image/*"
              hidden
            />
            <button
              class="form-button-secondary small-btn danger-text"
              id="clear-all-single-bgs-btn"
              style="margin-top: 10px"
            >
              ä¸€é”®æ¸…ç©ºæ‰€æœ‰å•äººèŠå¤©èƒŒæ™¯
            </button>
          </div>
        </div>

        <!-- åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢è¢«ä¿å­˜æŒ‰é’®é®æŒ¡ -->
        <div style="height: 80px"></div>
      </div>

      <!-- â˜…â˜…â˜… æ‚¬æµ®ä¿å­˜æŒ‰é’® â˜…â˜…â˜… -->
      <button id="save-wallpaper-btn" class="moe-fab-save">
        ğŸ’¾<span style="font-size: 12px; display: block; margin-top: -2px"
          >ä¿å­˜</span
        >
      </button>
    </div>

    <!-- åˆ†äº«é“¾æ¥åŠŸèƒ½ HTML -->
    <div id="browser-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="browser-back-btn">â€¹</span>
        <span id="browser-title"></span>
        <span style="width: 30px"></span>
      </div>
      <div id="browser-content" class="list-container">
        <!-- æ–‡ç« å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <div id="font-settings-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>å­—ä½“é¢„è®¾</span>
        <span style="width: 30px"></span>
        <!-- ä¿ç•™è¿™ä¸ªå ä½ç¬¦ï¼Œè®©æ ‡é¢˜èƒ½å®Œç¾å±…ä¸­ -->
      </div>
      <div class="form-container" style="gap: 20px">
        <p
          style="
            font-size: 13px;
            color: #ff6b6b;
            background-color: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 107, 107, 0.2);
            text-align: center;
            width: 100%;
            box-sizing: border-box;
          "
        >
          å­—ä½“å¤ªå¤§äº†å¯¼å…¥æœ¬åœ°å­—ä½“ä¼šé—ªé€€ï¼æœ€å¥½ç”¨urlã€‚
        </p>
        <!-- å­—ä½“é¢„è®¾å¡æ§½çš„å®¹å™¨ -->
        <div id="font-preset-container">
          <!-- 5ä¸ªå¡æ§½å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>

        <!-- å…¨å±€å­—ä½“é¢„è§ˆåŒº -->
        <div class="form-group" style="width: 100%">
          <label>å½“å‰å…¨å±€å­—ä½“é¢„è§ˆ</label>
          <div id="font-preview">
            <p style="font-size: 20px; margin: 0 0 10px 0">
              ä½ å¥½ä¸–ç•Œ Hello World
            </p>
            <p style="margin: 0">è¿™æ˜¯å…¨å±€å­—ä½“é¢„è§ˆæ•ˆæœï¼Œ12345ã€‚</p>
          </div>
        </div>

        <button class="form-button form-button-secondary" id="reset-font-btn">
          æ¢å¤é»˜è®¤å­—ä½“
        </button>
      </div>
    </div>

    <!-- è¿™ä¸ªæ˜¯éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨ï¼Œç”¨æ¥å¤„ç†æœ¬åœ°ä¸Šä¼  -->
    <input
      type="file"
      id="font-preset-local-upload"
      accept=".ttf,.otf,.woff,.woff2"
      style="display: none"
    />

    <!-- â€œæŸ¥è§’è‰²æ‰‹æœºâ€åŠŸèƒ½çš„æ‰€æœ‰HTMLç•Œé¢ -->

    <!-- 1. è§’è‰²é€‰æ‹©å±å¹• (ä¿æŒä¸å˜) -->
    <div id="character-selection-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>é€‰æ‹©è¦æŸ¥çœ‹çš„æ‰‹æœº</span>
        <span style="width: 30px"></span>
      </div>
      <div id="character-selection-list" class="list-container"></div>
    </div>

    <div id="character-phone-container" class="screen">
      <div class="character-phone-frame">
        <div class="character-phone-notch"></div>
        <div class="character-phone-inner-screen">
          <!-- 1. è§’è‰²æ‰‹æœºçš„ä¸»ç•Œé¢ -->
          <div id="character-phone-screen" class="character-phone-page active">
            <div class="header character-phone-header">
              <span
                class="back-btn"
                data-target-screen="character-selection-screen"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span id="character-phone-owner-name"></span>
              <div class="header-actions">
                <span
                  class="action-btn"
                  id="clear-character-data-btn"
                  title="æ¸…ç©ºå…¨éƒ¨æ•°æ®"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-character-data-btn"
                  title="åˆ·æ–°å…¨éƒ¨æ•°æ®"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M23 4v6h-6M1 20v-6h6" />
                    <path
                      d="M3.51 9a9 9 0 0114.85-3.36L20.5 10M3.5 14a9 9 0 0114.85 3.36L20.5 14"
                    />
                  </svg>
                </span>
              </div>
            </div>

            <!-- è¿™æ˜¯å·¦ä¸Šè§’çš„å°ç»„ä»¶ -->
            <div id="char-phone-widget-1" class="char-phone-widget">
              <img id="char-phone-widget-img-1" src="" />
            </div>
            <!-- è¿™æ˜¯å³ä¸‹è§’çš„å°ç»„ä»¶ -->
            <div id="char-phone-widget-2" class="char-phone-widget">
              <img id="char-phone-widget-img-2" src="" />
            </div>

            <div
              id="character-app-grid"
              class="app-grid-standard"
              style="padding-top: 60px"
            ></div>
          </div>

          <!-- 2. è§’è‰²æ‰‹æœº - èŠå¤©åˆ—è¡¨ -->
          <div
            id="character-chat-list-screen"
            class="character-phone-page"
            style="display: flex; flex-direction: column; height: 100%"
          >
            <div class="header character-phone-header" style="flex-shrink: 0">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>æ¶ˆæ¯</span>
              <div class="header-actions">
                <!-- â˜… æ–°å¢ï¼šæ¶ˆæ¯é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                <span
                  class="action-btn"
                  id="clear-npc-chats-btn"
                  title="æ¸…ç©ºæ‰€æœ‰NPCèŠå¤©"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-chat-message-btn"
                  title="ç”Ÿæˆæ–°èŠå¤©"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                    />
                  </svg>
                </span>
              </div>
            </div>

            <div
              id="character-chat-list"
              class="list-container"
              style="
                padding: 0;
                flex-grow: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
              "
            ></div>
          </div>

          <!-- 3. è§’è‰²æ‰‹æœº - å…·ä½“èŠå¤©è®°å½• -->
          <div id="character-chat-history-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span
                class="back-btn"
                data-target-page="character-chat-list-screen"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span id="character-chat-with-name"></span>
            </div>
            <div
              id="character-chat-history-messages"
              class="list-container"
              style="
                padding: 15px;
                display: flex;
                flex-direction: column;
                gap: 15px;
                background-color: #e5ddd5;
              "
            ></div>
          </div>

          <!-- 4. è§’è‰²æ‰‹æœº - è´­ç‰©è½¦ -->
          <div id="character-shopping-cart-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>è´­ç‰©è½¦</span>
              <div class="header-actions">
                <!-- â˜… æ–°å¢ï¼šè´­ç‰©è½¦é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                <span
                  class="action-btn"
                  id="clear-cart-items-btn"
                  title="æ¸…ç©ºè´­ç‰©è½¦"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-cart-item-btn"
                  title="æ·»åŠ æ–°å•†å“"
                >
                  <svg
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-shopping-cart-list" class="list-container"></div>
          </div>

          <!-- 5. è§’è‰²æ‰‹æœº - å¤‡å¿˜å½• -->
          <div id="character-memos-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>å¤‡å¿˜å½•</span>
              <div class="header-actions">
                <!-- â˜… æ–°å¢ï¼šå¤‡å¿˜å½•é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                <span
                  class="action-btn"
                  id="clear-memos-btn"
                  title="æ¸…ç©ºå¤‡å¿˜å½•"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-memo-btn"
                  title="å†™æ–°å¤‡å¿˜å½•"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                    />
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-memos-list" class="list-container"></div>
          </div>

          <!-- 6. è§’è‰²æ‰‹æœº - æµè§ˆå™¨ -->
          <div id="character-browser-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>æµè§ˆå™¨</span>
              <div class="header-actions">
                <!-- â˜… æ–°å¢ï¼šæµè§ˆå™¨é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                <span
                  class="action-btn"
                  id="clear-browser-history-btn"
                  title="æ¸…ç©ºå†å²è®°å½•"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-browser-history-btn"
                  title="ç”Ÿæˆæ–°å†å²"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"
                    ></path>
                    <path
                      d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"
                    ></path>
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-browser-list" class="list-container"></div>
          </div>

          <!-- 7. è§’è‰²æ‰‹æœº - æµè§ˆå™¨æœç´¢ç»“æœè¯¦æƒ… -->
          <div
            id="character-browser-detail-screen"
            class="character-phone-page"
          >
            <div class="header character-phone-header">
              <span
                class="back-btn"
                data-target-page="character-browser-screen"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span id="character-browser-detail-title">æœç´¢ç»“æœ</span>
            </div>
            <div
              id="character-browser-detail-content"
              class="list-container"
              style="padding: 15px; line-height: 1.7"
            ></div>
          </div>

          <!-- 8. è§’è‰²æ‰‹æœº - ç›¸å†Œ -->
          <div id="character-album-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>ç›¸å†Œ</span>
              <div class="header-actions">
                <!-- â˜… æ–°å¢ï¼šç›¸å†Œé¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                <span
                  class="action-btn"
                  id="clear-album-photos-btn"
                  title="æ¸…ç©ºç›¸å†Œ"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-album-photo-btn"
                  title="ç”Ÿæˆæ–°ç…§ç‰‡"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="3"
                      y="3"
                      width="18"
                      height="18"
                      rx="2"
                      ry="2"
                    ></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-album-grid" class="list-container"></div>
          </div>

          <!-- 9. è§’è‰²æ‰‹æœº - é“¶è¡Œ -->
          <div id="character-bank-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>é’±åŒ…</span>
              <div class="header-actions">
                <!-- â˜… æ–°å¢ï¼šé’±åŒ…é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                <span
                  class="action-btn"
                  id="clear-bank-transactions-btn"
                  title="æ¸…ç©ºäº¤æ˜“è®°å½•"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-bank-transaction-btn"
                  title="ç”Ÿæˆæ–°äº¤æ˜“"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path
                      d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                    ></path>
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-bank-details" class="list-container"></div>
          </div>

          <!-- 10. è§’è‰²æ‰‹æœº - è¡ŒåŠ¨è½¨è¿¹ -->
          <div id="character-trajectory-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>è¶³è¿¹</span>
              <div class="header-actions">
                <!-- â˜… æ–°å¢ï¼šè¶³è¿¹é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                <span
                  class="action-btn"
                  id="clear-trajectory-btn"
                  title="æ¸…ç©ºè¶³è¿¹"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-trajectory-btn"
                  title="ç”Ÿæˆæ–°è¶³è¿¹"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"
                    ></path>
                    <circle cx="12" cy="10" r="3"></circle>
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-trajectory-list" class="list-container"></div>
          </div>

          <!-- 11. è§’è‰²æ‰‹æœº - APPä½¿ç”¨è®°å½• -->
          <div id="character-app-usage-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>å±å¹•ä½¿ç”¨æ—¶é—´</span>
              <div class="header-actions">
                <!-- â˜… æ–°å¢ï¼šä½¿ç”¨è®°å½•é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                <span
                  class="action-btn"
                  id="clear-app-usage-btn"
                  title="æ¸…ç©ºè®°å½•"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-app-usage-btn"
                  title="ç”Ÿæˆæ–°è®°å½•"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"
                    ></path>
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-app-usage-list" class="list-container"></div>
          </div>

          <!-- 12. è§’è‰²æ‰‹æœº - æ—¥è®° -->
          <div id="character-diary-screen" class="character-phone-page">
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>æ—¥è®°</span>
              <div class="header-actions">
                <!-- â˜… æ–°å¢ï¼šæ—¥è®°é¡µçš„åˆ é™¤æŒ‰é’® â˜… -->
                <span
                  class="action-btn"
                  id="clear-diary-entries-btn"
                  title="æ¸…ç©ºæ—¥è®°"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                    />
                  </svg>
                </span>
                <span
                  class="action-btn"
                  id="generate-diary-entry-btn"
                  title="å†™æ–°æ—¥è®°"
                >
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                    />
                  </svg>
                </span>
              </div>
            </div>
            <div id="character-diary-list" class="list-container"></div>
          </div>

          <div
            id="character-phone-appearance-screen"
            class="character-phone-page"
          >
            <div class="header character-phone-header">
              <span class="back-btn" data-target-page="character-phone-screen">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </span>
              <span>å¤–è§‚è®¾ç½®</span>
              <span style="width: 30px"></span>
            </div>
            <!-- å¤ç”¨ä½ å·²æœ‰çš„.form-containeræ ·å¼ï¼Œæ–¹ä¾¿æ»šåŠ¨å’Œå¸ƒå±€ -->
            <div class="form-container" style="padding: 15px; gap: 25px">
              <!-- å£çº¸è®¾ç½®åŒº -->
              <div>
                <label style="font-weight: 500; color: var(--text-secondary)"
                  >æ‰‹æœºå£çº¸</label
                >
                <div
                  id="char-phone-wallpaper-preview"
                  class="wallpaper-preview"
                  style="
                    height: 240px;
                    width: 135px;
                    margin: 10px auto;
                    border-radius: 12px;
                  "
                >
                  ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ 
                </div>
                <button
                  id="upload-char-phone-wallpaper-btn"
                  class="form-button"
                >
                  ä¸Šä¼ å£çº¸
                </button>
                <button
                  id="remove-char-phone-wallpaper-btn"
                  class="form-button form-button-secondary"
                  style="margin-top: 10px"
                >
                  ç§»é™¤å£çº¸
                </button>
              </div>

              <hr style="width: 100%; opacity: 0.2" />

              <div>
                <label style="font-weight: 500; color: var(--text-secondary)"
                  >App å†…å£çº¸</label
                >
                <div
                  id="char-phone-app-wallpaper-preview"
                  class="wallpaper-preview"
                  style="
                    height: 240px;
                    width: 135px;
                    margin: 10px auto;
                    border-radius: 12px;
                  "
                >
                  ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ 
                </div>
                <button
                  id="upload-char-phone-app-wallpaper-btn"
                  class="form-button"
                >
                  ä¸Šä¼  App å†…å£çº¸
                </button>
                <button
                  id="remove-char-phone-app-wallpaper-btn"
                  class="form-button form-button-secondary"
                  style="margin-top: 10px"
                >
                  ç§»é™¤ App å†…å£çº¸
                </button>
              </div>

              <hr style="width: 100%; opacity: 0.2" />

              <!-- Appå›¾æ ‡è®¾ç½®åŒº -->
              <div>
                <label style="font-weight: 500; color: var(--text-secondary)"
                  >App å›¾æ ‡</label
                >
                <div
                  id="char-phone-icon-settings-grid"
                  style="
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 20px;
                    margin-top: 15px;
                    text-align: center;
                  "
                >
                  <!-- Appå›¾æ ‡è®¾ç½®å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
              </div>

              <hr style="width: 100%; opacity: 0.2" />
              <!-- æ¡Œé¢å°ç»„ä»¶è®¾ç½®åŒº -->
              <div>
                <label style="font-weight: 500; color: var(--text-secondary)"
                  >æ¡Œé¢å°ç»„ä»¶</label
                >
                <!-- å°ç»„ä»¶1: å·¦ä¸Šè§’ -->
                <div class="form-group" style="margin-top: 15px">
                  <label>å·¦ä¸Šè§’å°ç»„ä»¶</label>
                  <div class="avatar-upload">
                    <img
                      id="char-phone-widget-preview-1"
                      class="wallpaper-preview"
                      style="height: 100px; width: 100px; margin-bottom: 0"
                    />
                    <div
                      style="display: flex; flex-direction: column; gap: 8px"
                    >
                      <button
                        class="form-button-secondary"
                        id="upload-widget-1-btn"
                        style="margin-top: 0"
                      >
                        ä¸Šä¼ å›¾ç‰‡
                      </button>
                      <button
                        class="form-button-secondary"
                        id="remove-widget-1-btn"
                        style="
                          margin-top: 0;
                          border-color: #ff3b30;
                          color: #ff3b30;
                        "
                      >
                        ç§»é™¤å›¾ç‰‡
                      </button>
                    </div>
                  </div>
                </div>
                <!-- å°ç»„ä»¶2: å³ä¸‹è§’ -->
                <div class="form-group" style="margin-top: 15px">
                  <label>å³ä¸‹è§’å°ç»„ä»¶</label>
                  <div class="avatar-upload">
                    <img
                      id="char-phone-widget-preview-2"
                      class="wallpaper-preview"
                      style="height: 100px; width: 100px; margin-bottom: 0"
                    />
                    <div
                      style="display: flex; flex-direction: column; gap: 8px"
                    >
                      <button
                        class="form-button-secondary"
                        id="upload-widget-2-btn"
                        style="margin-top: 0"
                      >
                        ä¸Šä¼ å›¾ç‰‡
                      </button>
                      <button
                        class="form-button-secondary"
                        id="remove-widget-2-btn"
                        style="
                          margin-top: 0;
                          border-color: #ff3b30;
                          color: #ff3b30;
                        "
                      >
                        ç§»é™¤å›¾ç‰‡
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <hr style="width: 100%; opacity: 0.2; margin-top: 25px" />
              <div class="preset-manager-container">
                <div style="width: 100%; text-align: left; margin-bottom: 15px">
                  <label style="font-weight: 500; color: var(--text-secondary)"
                    >å¤–è§‚é¢„è®¾</label
                  >
                </div>
                <div class="form-group">
                  <select
                    id="char-phone-preset-selector"
                    class="form-group select"
                  ></select>
                  <div class="preset-manager-controls">
                    <!-- ç‹¬å ä¸€è¡Œçš„åº”ç”¨æŒ‰é’® -->
                    <button
                      id="apply-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-apply"
                      disabled
                    >
                      åº”ç”¨
                    </button>

                    <!-- 2x2 ç½‘æ ¼æŒ‰é’® -->
                    <button
                      id="save-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-save"
                    >
                      ä¿å­˜
                    </button>
                    <button
                      id="update-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-secondary"
                      disabled
                    >
                      æ›´æ–°
                    </button>
                    <button
                      id="rename-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-secondary"
                      disabled
                    >
                      é‡å‘½å
                    </button>
                    <button
                      id="import-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-secondary"
                    >
                      å¯¼å…¥
                    </button>
                    <button
                      id="export-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-secondary"
                      disabled
                    >
                      å¯¼å‡º
                    </button>
                    <button
                      id="delete-char-phone-preset-btn"
                      class="preset-btn-capsule preset-btn-delete"
                      disabled
                    >
                      åˆ é™¤
                    </button>

                    <input
                      type="file"
                      id="import-char-phone-preset-input"
                      accept=".json"
                      hidden
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨ï¼Œç”¨äºå¤„ç†ä¸Šä¼  -->
          <input
            type="file"
            id="char-phone-wallpaper-upload-input"
            accept="image/*"
            hidden
          />
          <input
            type="file"
            id="char-phone-icon-upload-input"
            accept="image/*"
            hidden
          />

          <input
            type="file"
            id="char-phone-widget-1-upload-input"
            accept="image/*"
            hidden
          />
          <input
            type="file"
            id="char-phone-widget-2-upload-input"
            accept="image/*"
            hidden
          />
          <input
            type="file"
            id="char-phone-app-wallpaper-upload-input"
            accept="image/*"
            hidden
          />
        </div>
      </div>
    </div>
    <!-- â€œæŸ¥æ‰‹æœºâ€åŠŸèƒ½-ç”ŸæˆèŠå¤©å¯¹è±¡é€‰æ‹©å¼¹çª— -->
    <div id="chat-gen-selector-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>é€‰æ‹©èŠå¤©å¯¹è±¡</span>
        </div>
        <div
          class="modal-body"
          style="padding: 0; display: flex; flex-direction: column"
        >
          <!-- é¡¶éƒ¨ï¼šéšæœºé€‰é¡¹ -->
          <div
            style="
              padding: 15px;
              border-bottom: 1px solid var(--border-color);
              background: var(--secondary-bg);
            "
          >
            <label class="toggle-switch-label" style="margin: 0">
              <span class="toggle-switch-text" style="font-weight: bold"
                >ğŸ² éšæœºç”Ÿæˆ (AIå†³å®š)</span
              >
              <input type="checkbox" id="chat-gen-random-checkbox" checked />
              <span class="toggle-switch-slider"></span>
            </label>
            <p
              style="
                font-size: 12px;
                color: var(--text-secondary);
                margin-top: 5px;
                margin-bottom: 0;
              "
            >
              å…³é—­åå¯æŒ‡å®šä¸‹æ–¹ç‰¹å®šè§’è‰²/NPCã€‚
            </p>
          </div>

          <!-- åˆ—è¡¨ï¼šç‰¹å®šè§’è‰²é€‰æ‹© -->
          <div
            id="chat-gen-list"
            class="contact-picker-list"
            style="flex-grow: 1; opacity: 0.5; pointer-events: none"
          >
            <!-- åˆ—è¡¨é¡¹ç”±JSç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-chat-gen-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-chat-gen-btn">å¼€å§‹ç”Ÿæˆ</button>
        </div>
      </div>
    </div>

    <div id="generation-overlay" class="modal">
      <div class="loading-content">
        <!-- è¿™æ˜¯ä¸€ä¸ªç²‰è‰²çš„çŒ«çˆªçˆª -->
        <div class="cat-paw">
          <div class="pad main"></div>
          <div class="pad toe t1"></div>
          <div class="pad toe t2"></div>
          <div class="pad toe t3"></div>
        </div>
        <p id="generation-text">å°‘å¥³ç¥ˆç¥·ä¸­...</p>
      </div>
    </div>

    <!-- é€‰æ‹©è”ç³»äººä»¥åˆ›å»ºç¾¤èŠçš„å±å¹• -->
    <div id="contact-picker-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="cancel-contact-picker-btn">å–æ¶ˆ</span>
        <span>é€‰æ‹©è”ç³»äºº</span>
        <span class="save-btn" id="confirm-contact-picker-btn">å®Œæˆ(0)</span>
      </div>
      <div class="list-container" id="contact-picker-list">
        <!-- è”ç³»äººåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ç¾¤æˆå‘˜ç®¡ç†å±å¹• -->
    <div id="member-management-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-member-management">â€¹</span>
        <span>ç¾¤æˆå‘˜ç®¡ç†</span>
        <span style="width: 30px"></span>
      </div>
      <div class="list-container" id="member-management-list">
        <!-- ç°æœ‰æˆå‘˜åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div id="member-management-actions">
        <button id="add-existing-contact-btn">ä»å¥½å‹åˆ—è¡¨æ·»åŠ </button>
        <button id="create-new-member-btn">åˆ›å»ºç¾¤å†…æ–°æˆå‘˜</button>
        <button id="ai-generate-members-btn">âœ¨ AI ç”Ÿæˆæˆå‘˜</button>
      </div>
    </div>

    <!-- å¾®åšç”¨æˆ·äººè®¾ä¸èŒä¸šè®¾ç½®æ¨¡æ€æ¡† -->
    <div id="weibo-user-settings-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>æˆ‘çš„å¾®åšè®¾å®š</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>é¢„è®¾æ–¹æ¡ˆ</label>
            <div class="bubble-preset-manager">
              <!-- å¤ç”¨ç°æœ‰æ ·å¼ -->
              <select
                id="weibo-user-preset-select"
                class="form-group select"
              ></select>
              <button id="manage-weibo-user-presets-btn" class="action-btn">
                ç®¡ç†
              </button>
            </div>
          </div>
          <div class="form-group">
            <label for="weibo-user-profession-modal-input"
              >èŒä¸š (æ˜¾ç¤ºåœ¨æ˜µç§°ä¸‹æ–¹)</label
            >
            <input
              type="text"
              id="weibo-user-profession-modal-input"
              placeholder="ä¾‹å¦‚ï¼šèŒä¸šç”µç«é€‰æ‰‹ã€ç¾å¦†åšä¸»"
            />
          </div>
          <div class="form-group">
            <label for="weibo-user-persona-modal-input"
              >éšè—äººè®¾ (ä»…ä¾›AIç”Ÿæˆè¯„è®ºæ—¶å‚è€ƒ)</label
            >
            <textarea
              id="weibo-user-persona-modal-input"
              rows="4"
              placeholder="ä¾‹å¦‚ï¼šæ€§æ ¼é«˜å†·ï¼Œå°‘ä¸ç²‰ä¸äº’åŠ¨ï¼Œåªå›å¤èµåŠ©å•†çš„è¯„è®ºã€‚"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-weibo-user-settings-btn">
            å–æ¶ˆ
          </button>
          <button class="save" id="save-weibo-user-settings-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div id="weibo-action-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span id="weibo-action-modal-title">æ‰§è¡Œæ“ä½œ</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="weibo-action-actor-select">é€‰æ‹©æ“ä½œè€… (Actor)</label>
            <select
              id="weibo-action-actor-select"
              class="form-group select"
            ></select>
          </div>
          <div class="form-group">
            <label>é€‰æ‹©æ“ä½œç±»å‹</label>

            <div id="weibo-action-type-select" style="text-align: left">
              <label
                ><input
                  type="radio"
                  name="weibo_action_type"
                  value="post"
                  checked
                />
                å‘å¸ƒä¸€æ¡æ–°å¾®åš</label
              >
              <label
                ><input
                  type="radio"
                  name="weibo_action_type"
                  value="comment_plaza"
                />
                è¯„è®ºå¹¿åœºæœ€æ–°å¾®åš</label
              >

              <label
                ><input
                  type="radio"
                  name="weibo_action_type"
                  value="comment_user"
                />
                è¯„è®ºç”¨æˆ·æœ€æ–°å¾®åš</label
              >
            </div>
          </div>
          <div class="form-group">
            <label for="weibo-action-prompt-input"
              >å…³äº... (å¯é€‰, ç®€è¦æç¤º)</label
            >
            <textarea
              id="weibo-action-prompt-input"
              rows="2"
              placeholder="ä¾‹å¦‚ï¼šä»Šå¤©æ¯”èµ›èµ¢äº†å¾ˆå¼€å¿ƒ or å›åº”æœ€è¿‘çš„çƒ­æœ"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-weibo-action-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-weibo-action-btn">æ‰§è¡Œ</button>
        </div>
      </div>
    </div>

    <div id="char-sticker-manager-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-sticker-manager">â€¹</span>
        <span id="sticker-manager-title">è¡¨æƒ…åŒ…ç®¡ç†</span>
        <!-- åœ¨è¿™é‡Œæ·»åŠ â€œç¼–è¾‘/å®Œæˆâ€æŒ‰é’® -->
        <div class="header-actions">
          <span class="action-btn" id="edit-char-stickers-btn">ç¼–è¾‘</span>
          <span
            class="action-btn"
            id="done-char-stickers-btn"
            style="display: none"
            >å®Œæˆ</span
          >
        </div>
      </div>
      <input
        type="file"
        id="char-sticker-upload-input"
        accept="image/*"
        style="display: none"
        multiple
      />
      <div
        class="modal-body"
        style="padding: 0; display: flex; flex-direction: column; flex-grow: 1"
      >
        <!-- é¡µç­¾åˆ‡æ¢ -->
        <div class="frame-tabs">
          <div id="sticker-tab-exclusive" class="frame-tab active">
            ä¸“å±è¡¨æƒ…
          </div>
          <div id="sticker-tab-common" class="frame-tab">é€šç”¨è¡¨æƒ…</div>
        </div>

        <!-- ä¸“å±è¡¨æƒ…å†…å®¹åŒº -->
        <div id="sticker-content-exclusive" class="frame-content active">
          <div class="sticker-panel-header" style="justify-content: flex-end">
            <div style="display: flex; gap: 10px">
              <span class="panel-btn" id="add-exclusive-sticker-btn"
                >æ‰¹é‡æ·»åŠ </span
              >
              <span class="panel-btn" id="upload-exclusive-sticker-btn"
                >æœ¬åœ°ä¸Šä¼ </span
              >
            </div>
          </div>
          <div id="exclusive-sticker-grid" class="sticker-grid"></div>
        </div>

        <!-- é€šç”¨è¡¨æƒ…å†…å®¹åŒº -->
        <div id="sticker-content-common" class="frame-content">
          <div class="sticker-panel-header" style="justify-content: flex-end">
            <div style="display: flex; gap: 10px">
              <span class="panel-btn" id="add-common-sticker-btn"
                >æ‰¹é‡æ·»åŠ </span
              >
              <span class="panel-btn" id="upload-common-sticker-btn"
                >æœ¬åœ°ä¸Šä¼ </span
              >
            </div>
          </div>
          <div id="common-sticker-grid" class="sticker-grid"></div>
        </div>
      </div>
      <!-- ç”¨äºæ‰¹é‡åˆ é™¤çš„æ“ä½œæ  -->
      <div id="char-sticker-footer" style="display: none">
        <button id="delete-selected-char-stickers-btn">åˆ é™¤å·²é€‰ (0)</button>
      </div>
    </div>

    <!-- æ¥ç”µè¯·æ±‚æ¨¡æ€æ¡† -->
    <div id="incoming-call-modal" class="modal">
      <div class="incoming-call-content">
        <img id="caller-avatar" class="caller-avatar" src="" />
        <div id="caller-name" class="caller-name"></div>
        <div class="caller-text">é‚€è¯·ä½ è§†é¢‘é€šè¯</div>
        <div class="incoming-call-actions">
          <div class="action-button-wrapper">
            <button
              id="decline-call-btn"
              class="call-action-btn decline"
            ></button>
            <span>æ‹’ç»</span>
          </div>
          <div class="action-button-wrapper">
            <button
              id="accept-call-btn"
              class="call-action-btn accept"
            ></button>
            <span>æ¥å¬</span>
          </div>
        </div>
      </div>
    </div>

    <div id="music-search-results-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>æœç´¢ç»“æœ</span>
        </div>
        <div class="modal-body" id="search-results-list" style="padding: 0">
          <!-- æœç´¢ç»“æœå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="cancel-music-search-btn"
            style="width: 100%"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <div id="video-call-screen" class="screen">
      <!-- è¿™ä¸ª screen åŒæ—¶ä¸ºä¸¤ç§æ¨¡å¼æœåŠ¡ -->

      <!-- ======================================================= -->
      <!-- æ¨¡å¼ä¸€ï¼šå…¨æ–°çš„ã€å¯è§†åŒ–ã€‘è§†é¢‘é€šè¯ç•Œé¢ -->
      <!-- ======================================================= -->
      <div id="visual-call-interface" style="display: none">
        <!-- é»˜è®¤éšè— -->
        <!-- 1. è§†é¢‘èƒŒæ™¯å±‚ (å¤§å›¾å’Œå°å›¾éƒ½åœ¨è¿™é‡Œ) -->
        <div class="video-background">
          <!-- å¤§å›¾å®¹å™¨ -->
          <div id="video-main-view" class="video-container">
            <img src="" alt="ä¸»è§†é¢‘ç”»é¢" />
            <video
              id="video-main-stream"
              autoplay
              playsinline
              muted
              style="
                display: none;
                width: 100%;
                height: 100%;
                object-fit: cover;
              "
            ></video>
          </div>
          <!-- å°å›¾å®¹å™¨ (ç”»ä¸­ç”») -->
          <div id="video-pip-view" class="video-container pip">
            <img src="" alt="å°çª—è§†é¢‘ç”»é¢" />
            <video
              id="video-pip-stream"
              autoplay
              playsinline
              muted
              style="
                display: none;
                width: 100%;
                height: 100%;
                object-fit: cover;
                transform: scaleX(-1);
              "
            ></video>
          </div>
        </div>

        <!-- 2. é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="video-call-top-bar">
          <button class="video-minimize-btn" onclick="minimizeVideoCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="4 14 10 14 10 20"></polyline>
              <polyline points="20 10 14 10 14 4"></polyline>
            </svg>
          </button>

          <span id="visual-call-timer">00:00</span>
        </div>

        <!-- 3. èŠå¤©æ°”æ³¡æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="video-call-messages-visual" class="video-call-main">
          <!-- èŠå¤©æ°”æ³¡ä¼šç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘ä»£ç ï¼Œæ›¿æ¢æ‰ id="visual-call-interface" é‡Œé¢é‚£ä¸ªæ—§çš„ video-call-controls çš„ div â–¼â–¼â–¼ -->
        <div class="video-call-controls">
          <!-- é‡-rollæŒ‰é’® -->
          <button
            id="reroll-call-btn"
            class="control-btn reroll-btn"
            title="é‡æ–°ç”Ÿæˆ"
          ></button>
          <button
            id="flip-real-camera-btn"
            class="control-btn"
            style="
              display: none;
              background-image: url(&quot;https://api.iconify.design/ion:camera-reverse-outline.svg?color=white&quot;);
              background-size: 60%;
              background-repeat: no-repeat;
              background-position: center;
            "
            title="ç¿»è½¬å‰åé•œå¤´"
          ></button>
          <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘å‘è¨€æŒ‰é’® -->
          <button
            id="user-speak-btn-visual"
            class="control-btn speak-btn"
            title="å‘è¨€"
          ></button>
          <!-- åˆ‡æ¢é•œå¤´æŒ‰é’® -->
          <button
            id="switch-camera-btn"
            class="control-btn switch-camera-btn"
            title="åˆ‡æ¢é•œå¤´"
          ></button>
          <!-- æŒ‚æ–­æŒ‰é’® -->
          <button
            id="hang-up-btn-visual"
            class="control-btn hangup-btn"
          ></button>
        </div>
        <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
      </div>

      <!-- ======================================================= -->

      <!-- ======================================================= -->
      <div id="text-call-interface" style="display: none">
        <!-- é»˜è®¤éšè— -->
        <div class="video-call-top-bar">
          <button class="video-minimize-btn" onclick="minimizeVideoCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="4 14 10 14 10 20"></polyline>
              <polyline points="20 10 14 10 14 4"></polyline>
            </svg>
          </button>
          <!-- â–²â–²â–² -->
          <span id="call-timer">00:00</span>
        </div>
        <div class="video-call-avatar-area">
          <div id="participant-avatars-grid">
            <!-- JSä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆå¤´åƒ -->
          </div>
        </div>
        <div id="video-call-main" class="video-call-main">
          <!-- å¯¹è¯å†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="video-call-controls">
          <!-- ã€æ–°å¢ã€‘ä¸ºæ—§æ¨¡å¼ä¹ŸåŠ ä¸Šé‡rollæŒ‰é’® -->
          <button
            id="reroll-call-btn-text"
            class="control-btn reroll-btn"
            title="é‡æ–°ç”Ÿæˆ"
          ></button>
          <button id="user-speak-btn" class="control-btn speak-btn"></button>
          <button id="hang-up-btn" class="control-btn hangup-btn"></button>
          <button
            id="join-call-btn"
            class="control-btn join-btn"
            style="display: none"
          ></button>
        </div>
      </div>
    </div>

    <!-- æ­£åœ¨å‘¼å«ç•Œé¢ -->
    <div id="outgoing-call-screen" class="screen">
      <div class="outgoing-call-content">
        <img id="outgoing-call-avatar" class="caller-avatar" src="" />
        <div id="outgoing-call-name" class="caller-name"></div>
        <div class="caller-text">æ­£åœ¨å‘¼å«...</div>
        <div class="outgoing-call-actions">
          <button id="cancel-call-btn" class="call-action-btn decline"></button>
          <span>å–æ¶ˆ</span>
        </div>
      </div>
    </div>

    <!-- é€šè¯è®°å½•é¡µé¢ -->
    <div id="call-history-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="call-history-back-btn">â€¹</span>
        <span id="call-history-title">é€šè¯è®°å½•</span>
        <span style="width: 30px"></span>
        <!-- å ä½ç¬¦ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­ -->
      </div>
      <div
        id="call-history-list"
        class="list-container"
        style="padding: 15px; display: flex; flex-direction: column; gap: 15px"
      >
        <!-- é€šè¯è®°å½•å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <div id="chat-search-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="search-back-btn">â€¹</span>
        <span>æŸ¥æ‰¾èŠå¤©è®°å½•</span>
        <span style="width: 30px"></span>
        <!-- å ä½ç¬¦ -->
      </div>
      <div class="form-container" style="padding-bottom: 0">
        <!-- æœç´¢æ¡ä»¶è¾“å…¥åŒº -->
        <div class="form-group">
          <label for="keyword-search-input">å…³é”®è¯</label>
          <input
            type="text"
            id="keyword-search-input"
            placeholder="è¾“å…¥è¦æŸ¥æ‰¾çš„å…³é”®è¯..."
          />
        </div>
        <div class="form-group">
          <label for="sender-search-select">äººç‰©</label>
          <select id="sender-search-select">
            <!-- é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </select>
        </div>
        <div class="form-group">
          <label for="date-search-input">æ—¥æœŸ</label>
          <input type="date" id="date-search-input" />
        </div>
        <button class="form-button" id="perform-search-btn">å¼€å§‹æŸ¥æ‰¾</button>

        <!-- æœç´¢ç»“æœæ˜¾ç¤ºåŒº -->
        <div
          id="chat-search-results-list"
          class="list-container"
          style="margin-top: 15px; padding: 0"
        >
          <!-- æœç´¢ç»“æœå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
      </div>
    </div>

    <div id="lock-screen" class="screen">
      <div id="lock-clock-container">
        <div id="lock-main-time">12:00</div>
        <div id="lock-main-date">æ˜ŸæœŸä¸€, 1æœˆ1æ—¥</div>
      </div>
      <div id="unlock-hint">å‘ä¸Šè½»æ‰«ä»¥è§£é”</div>
    </div>

    <div id="password-modal-overlay" class="modal">
      <div class="password-modal-content">
        <p>è¯·è¾“å…¥å¯†ç </p>
        <input type="password" id="password-input-field" maxlength="20" />
        <div class="password-actions">
          <button id="password-cancel-btn">å–æ¶ˆ</button>
          <button id="password-confirm-btn">è¿›å…¥</button>
        </div>
      </div>
    </div>

    <div id="lovers-space-screen" class="screen">
      <!-- å¤´éƒ¨ -->
      <div id="ls-header">
        <div class="ls-header-overlay"></div>
        <div class="ls-header-top-bar">
          <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
          <span id="ls-char-name"></span>
          <div class="header-actions">
            <span class="action-btn" id="ls-settings-btn" title="ç©ºé—´è®¾ç½®">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="3"></circle>
                <path
                  d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                ></path>
              </svg>
            </span>
            <span class="action-btn" id="ls-change-bg-btn" title="æ›´æ¢èƒŒæ™¯">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
            </span>
            <span class="action-btn" id="ls-switch-char-btn">åˆ‡æ¢</span>
          </div>
        </div>
        <div class="ls-avatar-and-counter-wrapper">
          <div class="ls-header-avatars">
            <img id="ls-user-avatar" src="" />
            <span class="heart-icon">â¤</span>
            <img id="ls-char-avatar" src="" />
          </div>
          <div id="ls-days-counter"></div>
        </div>
      </div>

      <div id="ls-tab-bar">
        <div
          class="ls-tab-item active"
          data-view="ls-moments-view"
          title="è¯´è¯´"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
            ></path>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-album-view" title="ç›¸å†Œ">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-letters-view" title="æƒ…ä¹¦">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
            ></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-shares-view" title="åˆ†äº«">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-questions-view" title="æé—®">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-diary-view" title="æ—¥è®°">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-pomodoro-view" title="ç•ªèŒ„é’Ÿ">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="ls-tab-item" data-view="ls-activity-view" title="ä»Šæ—¥è¶³è¿¹">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </div>
      </div>

      <!-- å†…å®¹æ˜¾ç¤ºåŒºåŸŸ -->
      <div id="ls-content-area">
        <div id="ls-moments-view" class="ls-view active">
          <div id="ls-moments-list"></div>
          <button id="ls-add-moment-btn" class="ls-fab-btn">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <line
                x1="12"
                y1="5"
                x2="12"
                y2="19"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
              <line
                x1="5"
                y1="12"
                x2="19"
                y2="12"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>
        <div id="ls-album-view" class="ls-view">
          <div id="ls-album-list"></div>
          <button id="ls-add-album-btn" class="ls-fab-btn">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <line
                x1="12"
                y1="5"
                x2="12"
                y2="19"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
              <line
                x1="5"
                y1="12"
                x2="19"
                y2="12"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div id="ls-letters-view" class="ls-view">
          <div id="ls-letters-list"></div>
          <button id="ls-add-letter-btn" class="ls-fab-btn">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <line
                x1="12"
                y1="5"
                x2="12"
                y2="19"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
              <line
                x1="5"
                y1="12"
                x2="19"
                y2="12"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div id="ls-shares-view" class="ls-view">
          <div id="ls-shares-list"></div>
        </div>
        <div id="ls-questions-view" class="ls-view">
          <div id="ls-questions-list"></div>
          <button id="ls-add-question-btn" class="ls-fab-btn">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <line
                x1="12"
                y1="5"
                x2="12"
                y2="19"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
              <line
                x1="5"
                y1="12"
                x2="19"
                y2="12"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div id="ls-diary-view" class="ls-view">
          <!-- æ—¥å†å’Œå¿ƒæƒ…ç½å­çš„å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>

        <!-- â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬ä¸ºç•ªèŒ„é’Ÿå‡†å¤‡çš„å…¨æ–°ç•Œé¢ â˜…â˜…â˜… -->
        <div id="ls-pomodoro-view" class="ls-view">
          <!-- ç•ªèŒ„é’Ÿä¸»é¡µï¼Œæ˜¾ç¤ºå†å²è®°å½•å’Œå¼€å§‹æŒ‰é’® -->
          <div id="ls-pomodoro-home">
            <div id="ls-pomodoro-start-btn-container">
              <div id="ls-pomodoro-start-icon">ï¼‹</div>
              <p>å¼€å¯æ–°çš„ä¸“æ³¨æ—¶å…‰</p>
            </div>
            <div id="ls-pomodoro-history-list">
              <!-- å†å²è®°å½•ä¼šç”±JSç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
          </div>
          <div id="ls-pomodoro-timer-active" style="display: none">
            <div class="pomodoro-char-avatar-container">
              <img id="pomodoro-char-avatar" src="" />
              <div id="pomodoro-char-log"></div>
            </div>
            <div class="pomodoro-timer-display">
              <div id="pomodoro-current-task"></div>
              <div id="pomodoro-time">25:00</div>
            </div>
            <div
              class="pomodoro-controls"
              style="display: flex; gap: 15px; margin-top: 20px"
            >
              <!-- æ–°çš„èŒç³»éŸ³ä¹æŒ‰é’® -->
              <button id="pomodoro-music-btn" title="éŸ³ä¹æ­Œå•">
                <!-- è¿™é‡Œç”¨ä¸€ä¸ªSVGå›¾æ ‡ä»£æ›¿ç®€å•çš„éŸ³ç¬¦å­—ç¬¦ï¼Œæ›´ç²¾è‡´ -->
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M9 18V5l12-2v13"></path>
                  <circle cx="6" cy="18" r="3"></circle>
                  <circle cx="18" cy="16" r="3"></circle>
                </svg>
              </button>
              <button
                id="pomodoro-pause-btn"
                style="background-color: #ffca28; color: #fff"
              >
                æš‚åœ / ä¼‘æ¯
              </button>
              <button id="pomodoro-end-btn">ç»“æŸä¸“æ³¨</button>
            </div>
          </div>
        </div>
        <div id="ls-activity-view" class="ls-view">
          <!-- ä»Šæ—¥è¶³è¿¹çš„å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
      </div>
    </div>

    <!-- èŠå¤©è®¾ç½®å¼¹çª— (èŒç³»å¸ƒå±€ - åŠŸèƒ½æ•´åˆç‰ˆ) -->
    <div id="chat-settings-modal" class="modal">
      <div class="modal-content moe-settings-content">
        <div class="modal-header moe-modal-header">
          <span>âœ¨ èŠå¤©è®¾ç½® âœ¨</span>
        </div>

        <div class="modal-body moe-settings-body">
          <!-- ============================== -->
          <!-- 1. åŸºç¡€èµ„æ–™å¡ç‰‡ -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card">
            <div class="settings-section-title">ğŸ“ åŸºç¡€èµ„æ–™</div>
            <div class="form-group" id="chat-name-group">
              <label>è§’è‰²çœŸå /ç¾¤èŠåç§°(AIåªè®¤è¿™ä¸ªï¼Œä¿®æ”¹ä¼šå½±å“è®°å¿†)</label>
              <input type="text" id="chat-name-input" class="moe-input" />
            </div>
            <!-- æ–°å¢çš„å¤‡æ³¨åè¾“å…¥æ¡†ï¼Œé»˜è®¤éšè—ï¼ŒJSé‡Œæ§åˆ¶æ˜¾ç¤º -->
            <div
              class="form-group"
              id="chat-remark-group"
              style="display: none"
            >
              <label>å¤‡æ³¨å (ä»…æ˜¾ç¤ºç”¨ï¼ŒAIä¸çŸ¥é“)</label>
              <input
                type="text"
                id="chat-remark-input"
                class="moe-input"
                placeholder="è®¾ç½®ä¸€ä¸ªå¤‡æ³¨..."
              />
            </div>

            <div
              class="form-group"
              id="assign-group-section"
              style="display: none"
            >
              <label for="assign-group-select">å¥½å‹åˆ†ç»„</label>
              <div class="input-with-btn-row">
                <select id="assign-group-select" class="moe-input"></select>
                <button id="manage-groups-btn" class="moe-btn-small">
                  ç®¡ç†
                </button>
              </div>
            </div>

            <div class="form-group" id="my-group-nickname-group">
              <label for="my-group-nickname-input">æˆ‘çš„ç¾¤æ˜µç§°</label>
              <input
                type="text"
                id="my-group-nickname-input"
                class="moe-input"
              />
            </div>

            <!-- å¤´åƒåŒºåŸŸ (å¹¶æ’å¸ƒå±€) -->
            <div class="moe-grid-row">
              <!-- å¯¹æ–¹/ç¾¤å¤´åƒ -->
              <div class="form-group" id="ai-avatar-group">
                <label>å¯¹æ–¹å¤´åƒ</label>
                <div class="avatar-upload-column">
                  <img id="ai-avatar-preview" class="preview-img" />
                  <div class="btn-stack">
                    <button
                      onclick="
                        document.getElementById('ai-avatar-input').click()
                      "
                      class="moe-btn-mini"
                    >
                      ä¸Šä¼ 
                    </button>
                    <button
                      class="change-frame-btn moe-btn-mini"
                      data-type="ai"
                    >
                      ç›¸æ¡†
                    </button>
                    <button
                      id="manage-ai-avatar-library-btn"
                      class="moe-btn-mini"
                    >
                      å›¾åº“
                    </button>
                  </div>
                  <input
                    type="file"
                    id="ai-avatar-input"
                    accept="image/*"
                    hidden
                  />
                </div>
              </div>

              <div
                class="form-group"
                id="group-avatar-group"
                style="display: none"
              >
                <label>ç¾¤å¤´åƒ</label>
                <div class="avatar-upload-column">
                  <img id="group-avatar-preview" class="preview-img" />
                  <div class="btn-stack">
                    <button
                      onclick="
                        document.getElementById('group-avatar-input').click()
                      "
                      class="moe-btn-mini"
                    >
                      ä¸Šä¼ 
                    </button>
                  </div>
                  <input
                    type="file"
                    id="group-avatar-input"
                    accept="image/*"
                    hidden
                  />
                </div>
              </div>

              <!-- æˆ‘çš„å¤´åƒ -->
              <div class="form-group" id="my-avatar-group">
                <label>æˆ‘çš„å¤´åƒ</label>
                <div class="avatar-upload-column">
                  <img id="my-avatar-preview" class="preview-img" />
                  <div class="btn-stack">
                    <button
                      onclick="
                        document.getElementById('my-avatar-input').click()
                      "
                      class="moe-btn-mini"
                    >
                      ä¸Šä¼ 
                    </button>
                    <button
                      class="change-frame-btn moe-btn-mini"
                      data-type="my"
                    >
                      ç›¸æ¡†
                    </button>
                    <button id="open-persona-library-btn" class="moe-btn-mini">
                      é¢„è®¾
                    </button>
                  </div>
                  <input
                    type="file"
                    id="my-avatar-input"
                    accept="image/*"
                    hidden
                  />
                </div>
              </div>
            </div>

            <!-- æ›¿æ¢åŸæ¥çš„ id="couple-avatar-group" -->
            <div class="form-group" id="couple-avatar-group">
              <div class="moe-divider"></div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                "
              >
                <label class="toggle-switch-label" style="margin: 0">
                  <span
                    class="toggle-switch-text"
                    style="font-weight: 600; color: #ff6b81"
                    >â¤ï¸ æƒ…ä¾£å¤´åƒæ¨¡å¼</span
                  >
                  <input type="checkbox" id="couple-avatar-toggle" />
                  <span class="toggle-switch-slider"></span>
                </label>

                <!-- ä¿®æ”¹åçš„æŒ‰é’®æ ·å¼ -->
                <button
                  id="manage-couple-avatar-library-btn"
                  class="moe-btn-secondary"
                  style="
                    margin: 0;
                    padding: 4px 12px;
                    font-size: 12px;
                    background-color: #fff0f3;
                    color: #ff6b81;
                    border: 1px solid #ffc2d1;
                    border-radius: 15px;
                  "
                >
                  ğŸ“‚ ç®¡ç†æƒ…å¤´åº“
                </button>
              </div>

              <div
                id="couple-avatar-desc-container"
                style="
                  display: none;
                  margin-top: 10px;
                  background: #fff0f3;
                  padding: 8px;
                  border-radius: 8px;
                "
              >
                <label
                  style="
                    font-size: 12px;
                    color: #ff8fa3;
                    display: block;
                    margin-bottom: 4px;
                  "
                  >å½“å‰æƒ…å¤´æè¿° (AIä¾æ®)</label
                >
                <input
                  type="text"
                  id="couple-avatar-description"
                  class="moe-input"
                  style="background: #fff; border-color: #ffc2d1"
                  placeholder="ä¾‹å¦‚ï¼šä¸€åªå°çŒ«åœ¨çœ‹æœˆäº®"
                />
              </div>
            </div>
          </div>

          <!-- ============================== -->
          <!-- 2. äººè®¾ä¸è®°å¿†å¡ç‰‡ -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card">
            <div class="settings-section-title">ğŸ§  AIå¤§è„‘ä¸è®¾å®š</div>

            <div class="form-group" id="ai-persona-group">
              <label for="ai-persona">å¯¹æ–¹äººè®¾ (Persona)</label>
              <textarea id="ai-persona" rows="3" class="moe-input"></textarea>
            </div>
            <div class="form-group" id="my-persona-group">
              <label for="my-persona">æˆ‘çš„äººè®¾ (My Persona)</label>
              <textarea id="my-persona" rows="3" class="moe-input"></textarea>
            </div>

            <div class="form-group" id="group-members-group">
              <label>ç¾¤æˆå‘˜è®¾å®š</label>
              <div
                id="group-members-settings"
                class="moe-list-box"
                style="margin-bottom: 10px"
              ></div>
              <button id="manage-members-btn" class="moe-btn-secondary">
                ğŸ‘¥ ç®¡ç†ç¾¤æˆå‘˜
              </button>
            </div>

            <!-- â˜…â˜…â˜… ä¿®æ”¹ç‚¹ï¼šå°†NPCåº“å’Œè¡¨æƒ…åŒ…å¹¶æ’æ”¾åœ¨è¿™é‡Œ â˜…â˜…â˜… -->
            <div style="display: flex; gap: 10px; margin-top: 15px">
              <!-- NPCåº“æŒ‰é’® -->
              <div id="npc-library-group" style="flex: 1">
                <button
                  id="manage-npcs-btn"
                  class="moe-btn-secondary"
                  style="margin-top: 0; width: 100%"
                >
                  ğŸ¤– NPCåº“
                </button>
              </div>
              <!-- è¡¨æƒ…åŒ…æŒ‰é’® -->
              <div id="char-sticker-group" style="flex: 1">
                <button
                  id="manage-char-stickers-btn"
                  class="moe-btn-secondary"
                  style="margin-top: 0; width: 100%"
                >
                  ğŸ˜¶ è¡¨æƒ…åŒ…
                </button>
              </div>
            </div>

            <!-- å¾®åšè®¾å®š -->
            <div class="form-group" id="weibo-profession-group">
              <div class="moe-divider"></div>
              <label>å¾®åšèŒä¸š</label>
              <input
                type="text"
                id="weibo-profession-input"
                class="moe-input"
                placeholder="ä¾‹å¦‚ï¼šç”µç«é€‰æ‰‹"
              />
            </div>
            <div class="form-group" id="weibo-instruction-group">
              <label>å¾®åšæŒ‡ä»¤ (AIå‘å¾®åšæ—¶çš„è¡Œä¸ºå‡†åˆ™)</label>
              <textarea
                id="weibo-instruction-input"
                rows="2"
                class="moe-input"
                placeholder="ä¾‹å¦‚ï¼šæ€§æ ¼é«˜å†·ï¼Œå°‘ä¸ç²‰ä¸äº’åŠ¨"
              ></textarea>
            </div>

            <!-- å…³è”è®¾å®š -->
            <div class="moe-divider"></div>
            <div class="form-group" id="world-book-link-group">
              <label>å…³è”ä¸–ç•Œä¹¦ (å¤šé€‰)</label>
              <div class="custom-multiselect">
                <div class="select-box moe-input">
                  <span class="selected-options-text">-- ç‚¹å‡»é€‰æ‹© --</span>
                  <span class="arrow-down">â–¼</span>
                </div>
                <div
                  id="world-book-checkboxes-container"
                  class="checkboxes-container"
                ></div>
              </div>
            </div>

            <div class="form-group" id="memory-link-group">
              <label>è®°å¿†äº’é€š (é€‰æ‹©è¦é“¾æ¥çš„èŠå¤©)</label>
              <div class="custom-multiselect" id="memory-link-multiselect">
                <div class="select-box moe-input">
                  <span class="selected-options-text">-- ç‚¹å‡»é€‰æ‹© --</span>
                  <span class="arrow-down">â–¼</span>
                </div>
                <div
                  id="memory-link-checkboxes-container"
                  class="checkboxes-container"
                ></div>
              </div>
              <div
                style="
                  margin-top: 8px;
                  display: flex;
                  align-items: center;
                  gap: 10px;
                  background: #f9f9f9;
                  padding: 8px;
                  border-radius: 8px;
                "
              >
                <label style="margin: 0; font-size: 13px; color: #666"
                  >äº’é€šæ¡æ•°:</label
                >
                <input
                  type="number"
                  id="link-memory-depth-input"
                  value="5"
                  min="1"
                  max="20"
                  class="moe-input"
                  style="width: 80px; text-align: center"
                />
              </div>
            </div>

            <!-- åŸæœ‰ä»£ç  -->
            <div class="form-group">
              <label for="max-memory">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label>
              <input
                type="number"
                id="max-memory"
                value="10"
                class="moe-input"
              />
            </div>

            <div class="form-group">
              <label>å›å¤æ¡æ•°åŒºé—´ (Min - Max)</label>
              <div style="display: flex; gap: 10px; align-items: center">
                <input
                  type="number"
                  id="min-reply-count-input"
                  class="moe-input"
                  min="1"
                  placeholder="æœ€å°"
                  style="text-align: center"
                />
                <span>è‡³</span>
                <input
                  type="number"
                  id="max-reply-count-input"
                  class="moe-input"
                  min="1"
                  placeholder="æœ€å¤§"
                  style="text-align: center"
                />
                <span>æ¡</span>
              </div>
              <p style="font-size: 12px; color: #999; margin-top: 5px">
                å»ºè®®è®¾ç½®: å•èŠ 2-5ï¼Œç¾¤èŠ 3-8ã€‚
              </p>
            </div>

            <div class="info-tags">
              <span class="tag"
                >æ€»æ¶ˆæ¯:
                <span id="total-message-count-display">-- æ¡</span></span
              >
              <span class="tag"
                >token:
                <span id="context-token-count-display">-- Tokens</span></span
              >
            </div>
          </div>

          <!-- ============================== -->
          <!-- 3. ç©æ³•æ¨¡å¼å¡ç‰‡ -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card">
            <div class="settings-section-title">ğŸ® ç©æ³•ä¸æ¨¡å¼</div>

            <!-- çº¿ä¸‹æ¨¡å¼ -->
            <div class="form-group" id="offline-mode-section">
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">çº¿ä¸‹æ¨¡å¼ (Online Dating)</span>
                <input type="checkbox" id="offline-mode-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
            </div>
            <div
              id="offline-mode-details"
              class="moe-details-box"
              style="display: none"
            >
              <div class="form-group">
                <label>é¢„è®¾ç®¡ç†</label>
                <div class="input-with-btn-row">
                  <select id="offline-preset-select" class="moe-input"></select>
                  <button id="manage-offline-presets-btn" class="moe-btn-small">
                    ç®¡ç†
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>åœºæ™¯æç¤ºè¯ (Prompt)</label>
                <textarea
                  id="offline-prompt-input"
                  rows="3"
                  class="moe-input"
                  placeholder="ä¾‹å¦‚ï¼šä½ æ­£åœ¨ä¸€å®¶å®‰é™çš„å’–å•¡é¦†..."
                ></textarea>
              </div>
              <div class="form-group">
                <label>æ–‡é£è¦æ±‚ (Style)</label>
                <textarea
                  id="offline-style-input"
                  rows="2"
                  class="moe-input"
                  placeholder="ä¾‹å¦‚ï¼šè¯¦ç»†æå†™åŠ¨ä½œç¥æ€..."
                ></textarea>
              </div>
              <div class="form-group">
                <label>æœŸæœ›å­—æ•°</label>
                <input
                  type="number"
                  id="offline-word-count-input"
                  value="300"
                  class="moe-input"
                />
              </div>
              <div
                class="form-group"
                style="border-top: 1px dashed #ddd; padding-top: 10px"
              >
                <label class="toggle-switch-label" style="margin: 0">
                  <span class="toggle-switch-text" style="font-size: 13px"
                    >æ¯è½®è‡ªåŠ¨ç”Ÿå›¾ (NovelAI)</span
                  >
                  <input type="checkbox" id="offline-novelai-toggle" />
                  <span
                    class="toggle-switch-slider"
                    style="transform: scale(0.8)"
                  ></span>
                </label>
              </div>
            </div>

            <!-- èŠå¤©æ€»ç»“ -->
            <div class="form-group">
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">é•¿æœŸè®°å¿†æ€»ç»“</span>
                <input type="checkbox" id="summary-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
            </div>
            <div
              id="summary-details-container"
              class="moe-details-box"
              style="display: none"
            >
              <div class="form-group">
                <label>æ€»ç»“æ¨¡å¼</label>
                <div style="display: flex; gap: 20px; margin-top: 5px">
                  <label
                    ><input
                      type="radio"
                      name="summary-mode"
                      value="auto"
                      checked
                    />
                    è‡ªåŠ¨æ€»ç»“</label
                  >
                  <label
                    ><input type="radio" name="summary-mode" value="manual" />
                    æ‰‹åŠ¨æ€»ç»“</label
                  >
                </div>
              </div>
              <div class="form-group">
                <label>è§¦å‘æ¡æ•°</label>
                <input
                  type="number"
                  id="summary-count-input"
                  value="20"
                  min="5"
                  class="moe-input"
                />
              </div>
              <div class="form-group">
                <label>æ€»ç»“æç¤ºè¯</label>
                <textarea
                  id="summary-prompt-input"
                  rows="3"
                  class="moe-input"
                ></textarea>
              </div>
              <div class="moe-btn-group">
                <button id="view-summaries-btn" class="moe-btn-secondary">
                  æŸ¥çœ‹/ç®¡ç†æ€»ç»“
                </button>
                <button id="manual-summary-btn" class="moe-btn-secondary">
                  ç«‹å³æ‰‹åŠ¨æ€»ç»“
                </button>
              </div>
            </div>

            <!-- ç»­ç«èŠ± -->
            <div class="form-group" id="streak-settings-section">
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">ç»­ç«èŠ±ç³»ç»Ÿ</span>
                <input type="checkbox" id="streak-enabled-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
              <button
                id="open-intimacy-panel-btn"
                class="moe-btn-secondary"
                style="display: none; margin-bottom: 10px"
              >
                ğŸ… æŸ¥çœ‹äº²å¯†å…³ç³»é¢æ¿
              </button>

              <div
                id="streak-details-container"
                class="moe-details-box"
                style="display: none"
              >
                <div class="moe-grid-row">
                  <div class="form-group">
                    <label>åˆå§‹å¤©æ•°</label>
                    <input
                      type="number"
                      id="streak-initial-days-input"
                      class="moe-input"
                    />
                  </div>
                  <div class="form-group">
                    <label>ç†„ç­è§„åˆ™</label>
                    <select
                      id="streak-extinguish-threshold-select"
                      class="moe-input"
                    >
                      <option value="1">1å¤©ä¸èŠç†„ç­</option>
                      <option value="3">3å¤©ä¸èŠç†„ç­</option>
                      <option value="7">7å¤©ä¸èŠç†„ç­</option>
                      <option value="-1">æ°¸ä¸ç†„ç­</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label>ç‚¹äº®å›¾æ ‡ URL (å¯é€‰)</label>
                  <input
                    type="text"
                    id="streak-lit-icon-url"
                    class="moe-input"
                    placeholder="é»˜è®¤: ğŸ”¥"
                  />
                </div>
                <div class="form-group">
                  <label>ç†„ç­å›¾æ ‡ URL (å¯é€‰)</label>
                  <input
                    type="text"
                    id="streak-extinguished-icon-url"
                    class="moe-input"
                    placeholder="é»˜è®¤: ğŸ§Š"
                  />
                </div>
                <div class="form-group">
                  <label>å­—ä½“é¢œè‰²</label>
                  <input
                    type="color"
                    id="streak-font-color-picker"
                    class="moe-input"
                    style="height: 40px; padding: 2px"
                  />
                </div>
              </div>
            </div>

            <!-- ç¾¤èŠåå° -->
            <div
              class="form-group"
              id="group-background-activity-group"
              style="display: none"
            >
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">ç¾¤èŠåå°å®æ—¶æ´»åŠ¨</span>
                <input type="checkbox" id="group-background-activity-switch" />
                <span class="toggle-switch-slider"></span>
              </label>
              <div
                id="group-background-interval-settings"
                class="moe-details-box"
                style="display: none"
              >
                <label>æ´»åŠ¨é—´éš” (ç§’)</label>
                <input
                  type="number"
                  id="group-background-interval-input"
                  min="60"
                  value="120"
                  class="moe-input"
                />
              </div>
            </div>

            <div class="form-group">
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">å®æ—¶æ—¶é—´æ„ŸçŸ¥</span>
                <input type="checkbox" id="time-perception-toggle" checked />
                <span class="toggle-switch-slider"></span>
              </label>
              <div
                id="custom-time-container"
                style="display: none; margin-top: 5px"
              >
                <label>è‡ªå®šä¹‰æ—¶é—´</label>
                <input
                  type="datetime-local"
                  id="custom-time-input"
                  class="moe-input"
                />
              </div>
            </div>
          </div>

          <!-- ============================== -->
          <!-- 4. è¯­éŸ³ä¸è§†é¢‘å¡ç‰‡ -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card">
            <div class="settings-section-title">ğŸ“ è¯­éŸ³ä¸è§†é¢‘</div>

            <div class="form-group" id="minimax-voice-id-group">
              <label>Minimax è¯­éŸ³ID</label>
              <input
                type="text"
                id="minimax-voice-id-input"
                class="moe-input"
                placeholder="ä¾‹å¦‚ï¼šmale-01"
              />
            </div>

            <div class="form-group" id="minimax-language-boost-group">
              <label for="minimax-language-boost-select"
                >Minimax è¯­è¨€å¢å¼º</label
              >
              <p
                style="
                  font-size: 12px;
                  font-weight: normal;
                  color: #999;
                  margin-top: 5px;
                  margin-bottom: 10px;
                "
              >
                å¢å¼ºå¯¹ç‰¹å®šè¯­è¨€æˆ–æ–¹è¨€çš„è¯†åˆ«èƒ½åŠ›ã€‚é€šå¸¸é€‰æ‹©â€œè‡ªåŠ¨åˆ¤æ–­â€å³å¯ã€‚
              </p>
              <select id="minimax-language-boost-select">
                <option value="">æ—  (é»˜è®¤)</option>
                <option value="auto">è‡ªåŠ¨åˆ¤æ–­</option>
                <option value="Chinese">ä¸­æ–‡æ™®é€šè¯</option>
                <option value="Chinese,Yue">ç²¤è¯­</option>
                <option value="English">è‹±è¯­</option>
                <option value="Japanese">æ—¥è¯­</option>
                <option value="Korean">éŸ©è¯­</option>
                <option value="French">æ³•è¯­</option>
                <option value="Spanish">è¥¿ç­ç‰™è¯­</option>
                <option value="Arabic">é˜¿æ‹‰ä¼¯è¯­</option>
                <option value="Russian">ä¿„è¯­</option>
                <option value="Portuguese">è‘¡è„ç‰™è¯­</option>
                <option value="German">å¾·è¯­</option>
                <option value="Turkish">åœŸè€³å…¶è¯­</option>
                <option value="Dutch">è·å…°è¯­</option>
                <option value="Ukrainian">ä¹Œå…‹å…°è¯­</option>
                <option value="Vietnamese">è¶Šå—è¯­</option>
                <option value="Indonesian">å°å°¼è¯­</option>
                <option value="Italian">æ„å¤§åˆ©è¯­</option>
                <option value="Thai">æ³°è¯­</option>
                <option value="Polish">æ³¢å…°è¯­</option>
                <option value="Romanian">ç½—é©¬å°¼äºšè¯­</option>
                <option value="Greek">å¸Œè…Šè¯­</option>
                <option value_="">--- å…¶ä»– ---</option>
                <option value="Czech">æ·å…‹è¯­</option>
                <option value="Finnish">èŠ¬å…°è¯­</option>
                <option value="Hindi">å°åœ°è¯­</option>
                <option value="Bulgarian">ä¿åŠ åˆ©äºšè¯­</option>
                <option value="Danish">ä¸¹éº¦è¯­</option>
                <option value="Hebrew">å¸Œä¼¯æ¥è¯­</option>
                <option value="Malay">é©¬æ¥è¯­</option>
                <option value="Persian">æ³¢æ–¯è¯­</option>
                <option value="Slovak">æ–¯æ´›ä¼å…‹è¯­</option>
                <option value="Swedish">ç‘å…¸è¯­</option>
                <option value="Croatian">å…‹ç½—åœ°äºšè¯­</option>
                <option value="Filipino">è²å¾‹å®¾è¯­</option>
                <option value="Hungarian">åŒˆç‰™åˆ©è¯­</option>
                <option value="Norwegian">æŒªå¨è¯­</option>
                <option value="Slovenian">æ–¯æ´›æ–‡å°¼äºšè¯­</option>
                <option value="Catalan">åŠ æ³°ç½—å°¼äºšè¯­</option>
                <option value="Nynorsk">æ–°æŒªå¨è¯­</option>
                <option value="Tamil">æ³°ç±³å°”è¯­</option>
                <option value="Afrikaans">å—éè¯­</option>
              </select>
            </div>

            <div class="form-group" id="minimax-speed-group">
              <label>è¯­éŸ³è¯­é€Ÿ: <span id="minimax-speed-value">1.0</span></label>
              <input
                type="range"
                id="minimax-speed-slider"
                min="0.5"
                max="2"
                step="0.1"
                value="1.0"
                class="moe-slider"
              />
            </div>

            <div class="form-group" id="video-call-settings-group">
              <div class="moe-divider"></div>
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">å¯è§†åŒ–è§†é¢‘é€šè¯ç•Œé¢</span>
                <input type="checkbox" id="visual-video-call-switch" />
                <span class="toggle-switch-slider"></span>
              </label>

              <div
                id="video-call-image-uploads"
                class="moe-details-box"
                style="display: none"
              >
                <div class="moe-grid-row">
                  <div class="center-text">
                    <label>å¯¹æ–¹ç”»é¢</label>
                    <div
                      class="video-preview-box"
                      onclick="
                        document
                          .getElementById('char-video-image-input')
                          .click()
                      "
                    >
                      <img
                        id="char-video-image-preview"
                        src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png"
                      />
                      <span>ç‚¹å‡»ä¸Šä¼ </span>
                    </div>
                    <input
                      type="file"
                      id="char-video-image-input"
                      accept="image/*"
                      hidden
                    />
                  </div>
                  <div class="center-text">
                    <label>æˆ‘çš„ç”»é¢</label>
                    <div
                      class="video-preview-box"
                      onclick="
                        document
                          .getElementById('user-video-image-input')
                          .click()
                      "
                    >
                      <img
                        id="user-video-image-preview"
                        src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png"
                      />
                      <span>ç‚¹å‡»ä¸Šä¼ </span>
                    </div>
                    <input
                      type="file"
                      id="user-video-image-input"
                      accept="image/*"
                      hidden
                    />
                  </div>
                </div>
              </div>
              <label
                class="toggle-switch-label"
                style="
                  margin-top: 10px;
                  border-top: 1px dashed #eee;
                  padding-top: 10px;
                "
              >
                <span class="toggle-switch-text">æˆ‘çš„ç”»é¢ä½¿ç”¨çœŸå®æ‘„åƒå¤´</span>
                <input type="checkbox" id="user-real-camera-switch" />
                <span class="toggle-switch-slider"></span>
              </label>

              <label class="toggle-switch-label" style="margin-top: 10px">
                <span class="toggle-switch-text">å¼€å¯è¯­éŸ³æ¥å…¥</span>
                <input type="checkbox" id="video-call-voice-access-switch" />
                <span class="toggle-switch-slider"></span>
              </label>
            </div>
          </div>

          <!-- ============================== -->
          <!-- 5. è§†è§‰ç¾åŒ–å¡ç‰‡ -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card">
            <div class="settings-section-title">ğŸ¨ è§†è§‰ç¾åŒ–</div>

            <div class="form-group">
              <label>èŠå¤©èƒŒæ™¯</label>
              <div class="bg-upload-container">
                <div class="bg-preview-wrapper">
                  <img
                    id="bg-preview"
                    class="bg-preview-img"
                    style="width: 100px; height: 150px; border-radius: 10px"
                  />
                  <button
                    id="remove-bg-btn"
                    style="
                      position: absolute;
                      top: -5px;
                      right: -5px;
                      width: 20px;
                      height: 20px;
                      border-radius: 50%;
                      background: red;
                      color: white;
                      border: none;
                      cursor: pointer;
                    "
                  >
                    Ã—
                  </button>
                </div>
                <button
                  onclick="document.getElementById('bg-input').click()"
                  class="moe-btn-small"
                  style="width: auto"
                >
                  ä¸Šä¼ 
                </button>
                <input type="file" id="bg-input" accept="image/*" hidden />
              </div>
            </div>

            <div class="form-group">
              <label>æ°”æ³¡ä¸»é¢˜</label>
              <div
                class="theme-selector"
                style="display: flex; flex-wrap: wrap; gap: 10px"
              >
                <!-- åŸç”Ÿå•é€‰æŒ‰é’®ï¼ŒJSä¼šå¡«å……æˆ–ä¿æŒåŸæ · -->
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="default"
                    id="theme-default"
                  />
                  é»˜è®¤</label
                >
                <label
                  ><input type="radio" name="theme-select" value="pink_blue" />
                  ç²‰è“</label
                >
                <label
                  ><input type="radio" name="theme-select" value="blue_white" />
                  è“ç™½</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="purple_yellow"
                  />
                  ç´«é»„</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="black_white"
                  />
                  é»‘ç™½</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="yellow_white"
                  />
                  é»„ç™½</label
                >
                <label
                  ><input type="radio" name="theme-select" value="red_black" />
                  çº¢é»‘</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="blue_yellow"
                  />
                  è“é»„</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="pink_yellow"
                  />
                  ç²‰é»„</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="pink_purple"
                  />
                  ç²‰ç´«</label
                >
                <label
                  ><input type="radio" name="theme-select" value="gray_white" />
                  ç°ç™½</label
                >
                <label
                  ><input type="radio" name="theme-select" value="blue_green" />
                  è“ç»¿</label
                >
                <label
                  ><input type="radio" name="theme-select" value="pink_white" />
                  ç²‰ç™½</label
                >
                <label
                  ><input type="radio" name="theme-select" value="pink_black" />
                  ç²‰é»‘</label
                >
                <label
                  ><input type="radio" name="theme-select" value="pink_green" />
                  ç²‰ç»¿</label
                >
                <label
                  ><input
                    type="radio"
                    name="theme-select"
                    value="green_black"
                  />
                  ç»¿é»‘</label
                >
              </div>
              <button
                id="reset-theme-btn"
                class="moe-btn-mini"
                style="width: auto; margin-top: 5px"
              >
                æ¢å¤é»˜è®¤ä¸»é¢˜
              </button>
            </div>

            <div class="form-group">
              <label>å­—ä½“å¤§å°: <span id="font-size-value">13px</span></label>
              <input
                type="range"
                id="font-size-slider"
                min="12"
                max="20"
                step="1"
                class="moe-slider"
              />
            </div>

            <div class="form-group">
              <label>æ°”æ³¡æ ·å¼é¢„è®¾</label>
              <div class="input-with-btn-row">
                <select
                  id="bubble-style-preset-select"
                  class="moe-input"
                ></select>
                <button id="manage-bubble-presets-btn" class="moe-btn-small">
                  ç®¡ç†
                </button>
              </div>
              <div class="moe-btn-group">
                <button id="export-bubble-preset-btn" class="moe-btn-mini">
                  å¯¼å‡º
                </button>
                <button id="import-bubble-preset-btn" class="moe-btn-mini">
                  å¯¼å…¥
                </button>
              </div>
              <input
                type="file"
                id="import-bubble-preset-input"
                accept=".json, .txt, .css, .docx"
                hidden
              />
            </div>

            <div class="form-group">
              <label
                >è‡ªå®šä¹‰CSS
                <button
                  id="reset-custom-css-btn"
                  class="moe-btn-mini"
                  style="margin-left: 5px; padding: 2px 6px"
                >
                  é‡ç½®
                </button></label
              >
              <textarea
                id="custom-css-input"
                rows="4"
                class="moe-input code-area"
                placeholder="/* åœ¨æ­¤è¾“å…¥è‡ªå®šä¹‰CSSä»£ç  */"
              ></textarea>
            </div>

            <div class="form-group">
              <label>å®æ—¶é¢„è§ˆ</label>
              <div id="settings-preview-area" class="preview-box"></div>
            </div>

            <!-- NAIå‡ºå›¾è®¾ç½® -->
            <div
              class="form-group"
              id="nai-character-settings-group"
              style="display: none"
            >
              <div class="moe-divider"></div>
              <label>NovelAI å‡ºå›¾ (å•èŠ)</label>
              <div style="display: flex; gap: 15px; margin: 10px 0">
                <label
                  ><input
                    type="radio"
                    name="nai-prompt-source"
                    value="system"
                    checked
                  />
                  ç³»ç»Ÿé»˜è®¤</label
                >
                <label
                  ><input
                    type="radio"
                    name="nai-prompt-source"
                    value="character"
                  />
                  è§’è‰²ä¸“å±</label
                >
              </div>
              <button id="character-nai-prompts-btn" class="moe-btn-secondary">
                é…ç½®è§’è‰²ä¸“å±æç¤ºè¯
              </button>
            </div>

            <div
              class="form-group"
              id="group-nai-settings-group"
              style="display: none"
            >
              <div class="moe-divider"></div>
              <label>NovelAI å‡ºå›¾ (ç¾¤èŠ)</label>
              <div style="display: flex; gap: 15px; margin: 10px 0">
                <label
                  ><input
                    type="radio"
                    name="group-nai-prompt-source"
                    value="system"
                    checked
                  />
                  ç³»ç»Ÿé»˜è®¤</label
                >
                <label
                  ><input
                    type="radio"
                    name="group-nai-prompt-source"
                    value="character"
                  />
                  è§’è‰²ä¸“å±</label
                >
              </div>
              <button
                id="group-character-nai-prompts-btn"
                class="moe-btn-secondary"
              >
                é…ç½®è§’è‰²ä¸“å±æç¤ºè¯
              </button>
            </div>
          </div>

          <!-- ============================== -->
          <!-- 6. æ•°æ®ä¸æ“ä½œå¡ç‰‡ -->
          <!-- ============================== -->
          <div class="settings-group-card moe-card">
            <div class="settings-section-title">ğŸ’¾ æ•°æ®ä¸æ“ä½œ</div>

            <div class="moe-btn-group">
              <button id="import-chat-history-btn" class="moe-btn-secondary">
                å¯¼å…¥èŠå¤©è®°å½•
              </button>
              <button id="export-chat-history-btn" class="moe-btn-secondary">
                å¯¼å‡ºèŠå¤©è®°å½•
              </button>
            </div>
            <input
              type="file"
              id="import-chat-history-input"
              accept="application/json"
              hidden
            />

            <button
              id="search-chat-btn"
              class="moe-btn-secondary"
              style="margin-top: 10px"
            >
              ğŸ” æŸ¥æ‰¾èŠå¤©å†…å®¹
            </button>

            <div class="moe-divider"></div>

            <div class="moe-btn-group">
              <button id="clear-chat-btn" class="moe-btn-danger">
                ğŸ§¹ æ¸…ç©ºèŠå¤©
              </button>
              <button id="block-chat-btn" class="moe-btn-danger">
                ğŸš« æ‹‰é»‘å¯¹æ–¹
              </button>
            </div>
          </div>

          <!-- åº•éƒ¨å«é«˜ï¼Œé˜²æ­¢è¢«æ‚¬æµ®æŒ‰é’®é®æŒ¡ -->
          <div style="height: 80px"></div>
        </div>

        <!-- æ‚¬æµ®ä¿å­˜æŒ‰é’® (FAB) -->
        <div
          class="modal-footer"
          style="
            border: none;
            padding: 0;
            position: absolute;
            bottom: 0;
            width: 100%;
            pointer-events: none;
          "
        >
          <!-- å–æ¶ˆæŒ‰é’®æ”¾å·¦è¾¹ -->
          <button
            id="cancel-chat-settings-btn"
            class="moe-fab-cancel"
            style="pointer-events: auto"
          >
            âŒ<span style="font-size: 10px; display: block">å–æ¶ˆ</span>
          </button>

          <!-- ä¿å­˜æŒ‰é’®æ”¾å³è¾¹ -->
          <button
            id="save-chat-settings-btn"
            class="moe-fab-save"
            style="pointer-events: auto"
          >
            ğŸ’¾<span style="font-size: 10px; display: block">ä¿å­˜</span>
          </button>
        </div>
      </div>
    </div>

    <div id="persona-library-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>æˆ‘çš„äººè®¾åº“</span
          ><button id="add-persona-preset-btn" class="action-button">
            æ·»åŠ 
          </button>
        </div>
        <div class="modal-body"><div id="persona-library-grid"></div></div>
        <div class="modal-footer">
          <button class="cancel" id="close-persona-library-btn">å…³é—­</button>
        </div>
      </div>
    </div>

    <div id="persona-editor-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span id="persona-editor-title">æ·»åŠ äººè®¾é¢„è®¾</span>
        </div>
        <div class="modal-body">
          <!-- NPCåå­—è¾“å…¥æ¡† -->
          <div class="form-group" id="npc-editor-name-group">
            <label for="npc-editor-name-input">NPC åå­—</label>
            <input type="text" id="npc-editor-name-input" />
          </div>
          <div class="form-group">
            <label>å¤´åƒ</label>
            <div class="avatar-upload">
              <img id="preset-avatar-preview" />
              <button
                onclick="document.getElementById('preset-avatar-input').click()"
              >
                ä¸Šä¼ å¤´åƒ
              </button>

              <button
                id="persona-editor-change-frame-btn"
                class="change-frame-btn"
                data-type="member"
              >
                æ›´æ¢å¤´åƒæ¡†
              </button>
              <input type="file" id="preset-avatar-input" accept="image/*" />
            </div>
          </div>
          <div class="form-group">
            <label for="preset-persona-input">äººè®¾</label>
            <textarea
              id="preset-persona-input"
              rows="4"
              placeholder="åœ¨æ­¤è¾“å…¥è¿™ä¸ªäººè®¾çš„è¯¦ç»†è®¾å®š..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-persona-editor-btn">å–æ¶ˆ</button>
          <button class="save" id="save-persona-preset-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div id="member-settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><span>ç¼–è¾‘ç¾¤æˆå‘˜</span></div>
        <div class="modal-body">
          <div class="form-group">
            <label for="member-name-input">åå­—</label
            ><input type="text" id="member-name-input" />
          </div>
          <div class="form-group">
            <label for="member-persona-input">äººè®¾</label
            ><textarea id="member-persona-input" rows="4"></textarea>
          </div>

          <div class="form-group">
            <label>å¤´åƒ</label>
            <div class="avatar-upload">
              <img id="member-avatar-preview" />
              <button
                onclick="document.getElementById('member-avatar-input').click()"
              >
                ä¸Šä¼ å¤´åƒ
              </button>
              <!-- æ›´æ¢å¤´åƒæ¡†æŒ‰é’® -->
              <button
                id="member-editor-change-frame-btn"
                class="change-frame-btn"
              >
                æ›´æ¢å¤´åƒæ¡†
              </button>
              <input
                type="file"
                id="member-avatar-input"
                accept="image/*"
                hidden
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-member-settings-btn">å–æ¶ˆ</button
          ><button class="save" id="save-member-settings-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div id="custom-modal-overlay">
      <div id="custom-modal">
        <div class="custom-modal-header" id="custom-modal-title"></div>
        <div class="custom-modal-body" id="custom-modal-body"></div>
        <div class="custom-modal-footer">
          <button id="custom-modal-cancel">å–æ¶ˆ</button>
          <button id="custom-modal-confirm" class="confirm-btn">ç¡®å®š</button>
        </div>
      </div>
    </div>

    <div id="preset-actions-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-footer">
          <button id="preset-action-edit">ç¼–è¾‘é¢„è®¾</button>
          <button id="preset-action-delete" class="btn-danger">åˆ é™¤é¢„è®¾</button>
          <button
            id="preset-action-cancel"
            style="
              margin-top: 8px;
              border-radius: 8px;
              background-color: #f0f0f0;
            "
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <div id="transfer-modal">
      <div class="transfer-content">
        <div class="transfer-header">ç»™Taä¸€ä¸ªæƒŠå–œï¼</div>
        <div class="transfer-input-group">
          <label for="transfer-amount">è½¬è´¦é‡‘é¢</label>
          <input
            type="number"
            id="transfer-amount"
            placeholder="0.00"
            min="0"
            max="9999999999999"
            step="0.01"
          />
        </div>
        <div class="transfer-input-group">
          <label for="transfer-note">å¤‡æ³¨ (å¯é€‰)</label>
          <input
            type="text"
            id="transfer-note"
            placeholder="ç•™ä¸‹ä½ çš„å°å¿ƒæ€~"
            maxlength="20"
          />
        </div>
        <div class="transfer-actions">
          <button id="transfer-cancel-btn">å–æ¶ˆ</button>
          <button id="transfer-confirm-btn">ç¡®è®¤è½¬è´¦</button>
        </div>
      </div>
    </div>

    <div id="battery-alert-modal">
      <div class="battery-alert-content">
        <img id="battery-alert-image" src="" />
        <p id="battery-alert-text"></p>
      </div>
    </div>

    <audio id="audio-player" style="display: none"></audio>

    <audio id="dating-bgm-player" loop></audio>

    <audio id="tts-audio-player" style="display: none"></audio>

    <audio id="ringtone-player" loop></audio>
    <audio id="notification-sound-player" preload="auto"></audio>
    <audio
      id="strong-keep-alive-player"
      loop
      src="https://files.catbox.moe/7jn7bp.mp3"
    ></audio>

    <div id="create-post-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 90%">
        <div class="modal-header">
          <span id="create-post-modal-title">å‘å¸ƒåŠ¨æ€</span>
          <!-- ä½¿ç”¨IDæ–¹ä¾¿JSä¿®æ”¹æ ‡é¢˜ -->
        </div>
        <div class="modal-body">
          <!-- å…¬å¼€æ–‡å­—è¾“å…¥åŒº -->
          <div class="form-group">
            <textarea
              id="post-public-text"
              rows="3"
              placeholder="åˆ†äº«æ–°é²œäº‹..."
            ></textarea>
          </div>

          <!-- æ¨¡å¼åˆ‡æ¢å¼€å…³ -->
          <div class="post-mode-switcher">
            <button id="switch-to-image-mode" class="mode-btn active">
              ä¸Šä¼ å›¾ç‰‡
            </button>
            <button id="switch-to-text-image-mode" class="mode-btn">
              ä½¿ç”¨æ–‡å­—å›¾
            </button>
          </div>

          <!-- å›¾ç‰‡æ¨¡å¼åŒºåŸŸ -->
          <div id="image-mode-content" class="post-mode-content active">
            <div class="form-group">
              <div
                id="post-image-preview-container"
                class="post-image-preview-container"
              >
                <img id="post-image-preview" src="" alt="å›¾ç‰‡é¢„è§ˆ" />
                <button id="post-remove-image-btn">Ã—</button>
              </div>
              <div class="post-image-upload-options">
                <button
                  id="post-upload-local-btn"
                  class="form-button-secondary"
                >
                  æœ¬åœ°ä¸Šä¼ 
                </button>
                <button id="post-use-url-btn" class="form-button-secondary">
                  ç½‘ç»œURL
                </button>
                <input
                  type="file"
                  id="post-local-image-input"
                  accept="image/*"
                  hidden
                />
              </div>
            </div>
            <!-- è¿™ä¸ªæ˜¯ç»™AIçœ‹çš„å›¾ç‰‡æè¿°ï¼Œåœ¨å¾®åšæ¨¡å¼ä¸‹æˆ‘ä»¬ä¼šç”¨JSéšè—å®ƒ -->
            <div
              id="post-image-desc-group"
              class="form-group"
              style="display: none"
            >
              <label>å›¾ç‰‡æè¿° (å¿…å¡«ï¼Œç»™AIçœ‹)</label>
              <input
                type="text"
                id="post-image-description"
                placeholder="ç®€å•æè¿°å›¾ç‰‡å†…å®¹ï¼Œå¸®åŠ©AIç†è§£"
              />
            </div>
          </div>

          <!-- æ–‡å­—å›¾æ¨¡å¼åŒºåŸŸ -->
          <div id="text-image-mode-content" class="post-mode-content">
            <div class="form-group">
              <label>æ–‡å­—å›¾ (ç»™AIç†è§£ç”¨çš„æè¿°ï¼Œç‚¹å‡»å›¾ç‰‡åå¯è§)</label>
              <textarea
                id="post-hidden-text"
                rows="4"
                placeholder="åœ¨è¿™é‡Œå†™ä¸‹å›¾ç‰‡æè¿°..."
              ></textarea>
            </div>
          </div>

          <div class="form-group" id="post-visibility-group">
            <label>å¯è§èŒƒå›´</label>
            <div style="display: flex; gap: 20px; margin-bottom: 10px">
              <label
                ><input type="radio" name="visibility" value="all" checked />
                æ‰€æœ‰äººå¯è§</label
              >
              <label
                ><input type="radio" name="visibility" value="groups" />
                ä»…åˆ†ç»„å¯è§</label
              >
            </div>
            <div
              id="post-visibility-groups"
              style="
                display: none;
                max-height: 120px;
                overflow-y: auto;
                background-color: #f0f2f5;
                padding: 10px;
                border-radius: 8px;
              "
            >
              <!-- åˆ†ç»„çš„å¤šé€‰æ¡†ä¼šç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
          </div>

          <!-- è¿™ä¸ªæ˜¯åŠ¨æ€åŠŸèƒ½çš„è¯„è®ºå¼€å…³ï¼Œåœ¨å¾®åšæ¨¡å¼ä¸‹æˆ‘ä»¬ä¼šç”¨JSéšè—å®ƒ -->
          <div
            class="form-group"
            id="post-comments-toggle-group"
            style="margin-top: 15px"
          >
            <label for="post-comments-toggle" class="toggle-switch-label">
              <span class="toggle-switch-text">å…è®¸è§’è‰²çœ‹è§è¯„è®ºåŒº</span>
              <input type="checkbox" id="post-comments-toggle" checked />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-create-post-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-create-post-btn">å‘å¸ƒ</button>
        </div>
      </div>
    </div>

    <!-- NovelAI ç”Ÿæˆè®¾ç½®å¼¹çª— -->
    <div id="novelai-settings-modal" class="modal" style="display: none">
      <div
        class="modal-content"
        style="max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto"
      >
        <div class="modal-header">
          <span>NovelAI ç”Ÿæˆè®¾ç½®</span>
          <span
            class="close"
            id="close-novelai-settings"
            style="
              cursor: pointer;
              float: right;
              font-size: 28px;
              font-weight: bold;
            "
            >&times;</span
          >
        </div>
        <div class="modal-body" style="padding: 20px">
          <div class="form-group">
            <label style="color: #333">å›¾åƒå°ºå¯¸ï¼ˆopluså¯æ— é™å‡ºå°å›¾ï¼‰</label>
            <select
              id="nai-resolution"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            >
              <optgroup label="å°">
                <option value="512x768">çºµå‘ (512x768)</option>
                <option value="768x512">æ¨ªå‘ (768x512)</option>
                <option value="640x640">æ­£æ–¹å½¢ (640x640)</option>
              </optgroup>
              <optgroup label="æ­£å¸¸">
                <option value="832x1216">ç«–å›¾ (832x1216)</option>
                <option value="1216x832">æ¨ªå›¾ (1216x832)</option>
                <option value="1024x1024" selected>æ–¹å›¾ (1024x1024)</option>
              </optgroup>
              <optgroup label="å£çº¸">
                <option value="1088x1920">çºµå‘ (1088x1920)</option>
                <option value="1920x1088">é£æ™¯ (1920x1088)</option>
              </optgroup>
            </select>
            <small style="color: #666"
              >å»ºè®®ä½¿ç”¨å®˜æ–¹æ”¯æŒçš„æ ‡å‡†å°ºå¯¸ä»¥è·å¾—æœ€ä½³æ•ˆæœ</small
            >
          </div>

          <div class="form-group">
            <label style="color: #333">é‡‡æ ·æ­¥æ•° (Steps)</label>
            <input
              type="number"
              id="nai-steps"
              value="28"
              min="1"
              max="50"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            />
            <small style="color: #666"
              >æ¨èå€¼: 28 (å€¼è¶Šé«˜è´¨é‡è¶Šå¥½ä½†è€—æ—¶è¶Šé•¿)</small
            >
          </div>

          <div class="form-group">
            <label style="color: #333">æç¤ºè¯ç›¸å…³æ€§ (CFG Scale)</label>
            <input
              type="number"
              id="nai-cfg-scale"
              value="5"
              min="1"
              max="20"
              step="0.5"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            />
            <small style="color: #666"
              >æ¨èå€¼: 5 (æ§åˆ¶å›¾åƒä¸æç¤ºè¯çš„ç›¸å…³ç¨‹åº¦)</small
            >
          </div>

          <div class="form-group">
            <label style="color: #333">é‡‡æ ·å™¨ (Sampler)</label>
            <select
              id="nai-sampler"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            >
              <option value="k_euler">Euler</option>
              <option value="k_euler_ancestral" selected>
                Euler Ancestral
              </option>
              <option value="k_dpmpp_2s_ancestral">DPM++ 2S Ancestral</option>
              <option value="k_dpmpp_2m">DPM++ 2M</option>
              <option value="k_dpmpp_sde">DPM++ SDE</option>
              <option value="ddim">DDIM</option>
            </select>
          </div>

          <div class="form-group">
            <label style="color: #333">éšæœºç§å­ (Seed)</label>
            <input
              type="number"
              id="nai-seed"
              value="-1"
              min="-1"
              max="9999999999"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            />
            <small style="color: #666"
              >-1 è¡¨ç¤ºéšæœºï¼Œå›ºå®šç§å­å¯å¤ç°ç›¸åŒå›¾åƒ</small
            >
          </div>

          <div class="form-group">
            <label style="color: #333">è´Ÿé¢æç¤ºè¯é¢„è®¾ (UC Preset)</label>
            <select
              id="nai-uc-preset"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            >
              <option value="0">Preset 0 - Heavy</option>
              <option value="1" selected>Preset 1 - Light</option>
              <option value="2">Preset 2 - Human Focus</option>
              <option value="3">Preset 3 - None</option>
            </select>
          </div>

          <div class="form-group">
            <label style="color: #333">è´¨é‡æ ‡ç­¾</label>
            <div style="display: flex; align-items: center; gap: 10px">
              <input
                type="checkbox"
                id="nai-quality-toggle"
                checked
                style="width: auto"
              />
              <span style="color: #666; font-size: 14px"
                >è‡ªåŠ¨æ·»åŠ è´¨é‡æå‡æ ‡ç­¾</span
              >
            </div>
          </div>

          <div class="form-group">
            <label style="color: #333">SMEA (æå‡ç»†èŠ‚)</label>
            <div style="display: flex; align-items: center; gap: 10px">
              <input
                type="checkbox"
                id="nai-smea"
                checked
                style="width: auto"
              />
              <span style="color: #666; font-size: 14px">å¯ç”¨SMEAå¢å¼º</span>
            </div>
          </div>

          <div class="form-group">
            <label style="color: #333">SMEA DYN (åŠ¨æ€ä¼˜åŒ–)</label>
            <div style="display: flex; align-items: center; gap: 10px">
              <input type="checkbox" id="nai-smea-dyn" style="width: auto" />
              <span style="color: #666; font-size: 14px">å¯ç”¨åŠ¨æ€SMEA</span>
            </div>
          </div>

          <div class="form-group">
            <label style="color: #333">é»˜è®¤æ­£é¢æç¤ºè¯</label>
            <textarea
              id="nai-default-positive"
              rows="3"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
                resize: vertical;
              "
              placeholder="masterpiece, best quality, 1girl, beautiful..."
            >
masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style</textarea
            >
            <small style="color: #666"
              >æ­¤æç¤ºè¯å°†åœ¨ç”Ÿæˆæ—¶è‡ªåŠ¨ä½¿ç”¨ï¼ˆå¦‚æœæµ‹è¯•å¼¹çª—ä¸­æœªå¡«å†™ï¼‰</small
            >
          </div>

          <div class="form-group">
            <label style="color: #333">é»˜è®¤è´Ÿé¢æç¤ºè¯</label>
            <textarea
              id="nai-default-negative"
              rows="3"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
                resize: vertical;
              "
              placeholder="lowres, bad anatomy, bad hands, text, error..."
            >
lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry</textarea
            >
          </div>

          <div
            class="form-group"
            style="
              border-top: 1px solid #ddd;
              padding-top: 15px;
              margin-top: 15px;
            "
          >
            <label style="color: #333">ğŸŒ CORS ä»£ç†è®¾ç½®</label>
            <select
              id="nai-cors-proxy"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            >
              <option value="">âŒ ç›´è¿ï¼ˆæ— ä»£ç†ï¼‰</option>
              <option value="https://corsproxy.io/?" selected>
                âœ… corsproxy.ioï¼ˆæ¨èï¼‰
              </option>
              <option value="https://api.allorigins.win/raw?url=">
                allorigins.win
              </option>
              <option value="https://cors-anywhere.herokuapp.com/">
                cors-anywhereï¼ˆéœ€æ¿€æ´»ï¼‰
              </option>
              <option value="custom">ğŸ”§ è‡ªå®šä¹‰ä»£ç†</option>
            </select>
            <small style="color: #e74c3c; display: block; margin-top: 8px">
              âš ï¸ æœ¬åœ°è¿è¡Œä¼šé‡åˆ°CORSè·¨åŸŸé—®é¢˜ï¼Œéœ€ä½¿ç”¨ä»£ç†ã€‚æ¨èä½¿ç”¨ corsproxy.io
            </small>
          </div>

          <div
            id="nai-custom-proxy-group"
            class="form-group"
            style="display: none"
          >
            <label style="color: #333">è‡ªå®šä¹‰ä»£ç†åœ°å€</label>
            <input
              type="text"
              id="nai-custom-proxy-url"
              placeholder="https://your-proxy.com/?"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 8px;
                width: 100%;
                border-radius: 4px;
              "
            />
            <small style="color: #666"
              >ä»£ç†URLåº”ä»¥ / æˆ– ? ç»“å°¾ï¼Œä¾‹å¦‚ï¼šhttps://proxy.com/?</small
            >
          </div>
        </div>
        <div class="modal-footer">
          <button
            id="reset-nai-settings-btn"
            class="form-button form-button-secondary"
            style="margin-right: 10px"
          >
            æ¢å¤é»˜è®¤
          </button>
          <button
            id="save-nai-settings-btn"
            class="form-button form-button-secondary"
          >
            ä¿å­˜è®¾ç½®
          </button>
        </div>
      </div>
    </div>

    <!-- NovelAI æµ‹è¯•ç”Ÿæˆå¼¹çª— -->
    <div id="novelai-test-modal" class="modal" style="display: none">
      <div
        class="modal-content"
        style="max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto"
      >
        <div class="modal-header">
          <span>ğŸ–¼ï¸ NovelAI æµ‹è¯•ç”Ÿæˆ</span>
          <span
            class="close"
            id="close-novelai-test"
            style="
              cursor: pointer;
              float: right;
              font-size: 28px;
              font-weight: bold;
            "
            >&times;</span
          >
        </div>
        <div class="modal-body" style="padding: 20px">
          <div class="form-group">
            <label style="color: #333"
              >æ­£é¢æç¤ºè¯ï¼ˆæ­¤å¤„æç¤ºè¯ä»…ç”¨äºè¯¥å¼¹çª—æµ‹è¯•ï¼‰</label
            >
            <textarea
              id="nai-test-prompt"
              rows="4"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 10px;
                width: 100%;
                border-radius: 4px;
                resize: vertical;
              "
              placeholder="1girl, solo, long hair, blue eyes, smile..."
            >
1girl, solo, long hair, blue eyes, smile, outdoors, cherry blossoms, spring</textarea
            >
          </div>

          <div class="form-group">
            <label style="color: #333">è´Ÿé¢æç¤ºè¯ï¼ˆå¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰</label>
            <textarea
              id="nai-test-negative"
              rows="3"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 10px;
                width: 100%;
                border-radius: 4px;
                resize: vertical;
              "
              placeholder="ç•™ç©ºå°†ä½¿ç”¨è®¾ç½®ä¸­çš„é»˜è®¤è´Ÿé¢æç¤ºè¯"
            ></textarea>
          </div>

          <div style="text-align: center; margin: 20px 0">
            <button
              id="nai-generate-btn"
              style="
                background-color: #007bff;
                color: white;
                border: none;
                padding: 12px 30px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                font-weight: bold;
              "
            >
              ç”Ÿæˆå›¾åƒ
            </button>
          </div>

          <div
            id="nai-test-status"
            style="
              text-align: center;
              color: #666;
              margin: 15px 0;
              display: none;
            "
          >
            æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...
          </div>

          <div id="nai-test-result" style="display: none; margin-top: 20px">
            <div style="font-weight: bold; color: #333; margin-bottom: 10px">
              ç”Ÿæˆç»“æœï¼š
            </div>
            <div
              style="
                text-align: center;
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                border: 1px solid #e9ecef;
              "
            >
              <img
                id="nai-result-image"
                style="
                  max-width: 100%;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                "
              />
            </div>
            <div style="margin-top: 10px; text-align: center">
              <button
                id="nai-download-btn"
                class="form-button-secondary"
                style="margin: 0"
              >
                ä¸‹è½½å›¾åƒ
              </button>
            </div>
          </div>

          <div
            id="nai-test-error"
            style="
              display: none;
              margin-top: 15px;
              padding: 12px;
              background: #f8d7da;
              color: #721c24;
              border-radius: 6px;
              border: 1px solid #f5c6cb;
            "
          ></div>
        </div>
        <div class="modal-footer">
          <button id="close-nai-test-btn" class="form-button">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- è§’è‰²ä¸“å±NAIå‡ºå›¾è®¾ç½®å¼¹çª— -->
    <div id="character-nai-prompts-modal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <span>è§’è‰²ä¸“å±NAIæç¤ºè¯é…ç½®</span>
          <span
            class="close"
            id="close-character-nai-prompts"
            style="
              cursor: pointer;
              float: right;
              font-size: 28px;
              font-weight: bold;
            "
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <p
            style="
              font-size: 13px;
              color: #666;
              margin-bottom: 20px;
              background-color: #f0f8ff;
              padding: 12px;
              border-radius: 6px;
              border-left: 3px solid #007bff;
            "
          >
            ğŸ’¡ è¿™é‡Œé…ç½®çš„æç¤ºè¯ä»…ç”¨äºå½“å‰è§’è‰²çš„NAIå‡ºå›¾ï¼Œä¸å½±å“å…¶ä»–è§’è‰²æˆ–ç³»ç»Ÿè®¾ç½®
          </p>

          <div class="form-group">
            <label
              for="character-nai-positive"
              style="color: #333; font-weight: 600"
            >
              æ­£é¢æç¤ºè¯ (Positive Prompt)
            </label>
            <textarea
              id="character-nai-positive"
              rows="4"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 10px;
                width: 100%;
                border-radius: 4px;
                resize: vertical;
                font-size: 13px;
              "
              placeholder="ä¾‹å¦‚: masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style"
            ></textarea>
            <small
              style="
                display: block;
                color: #666;
                font-size: 12px;
                margin-top: 5px;
              "
            >
              æè¿°ä½ å¸Œæœ›ç”Ÿæˆçš„å›¾åƒé£æ ¼ï¼Œå¯å¡«å…¥ç”»å¸ˆä¸²
            </small>
          </div>

          <div class="form-group">
            <label
              for="character-nai-negative"
              style="color: #333; font-weight: 600"
            >
              è´Ÿé¢æç¤ºè¯ (Negative Prompt)
            </label>
            <textarea
              id="character-nai-negative"
              rows="4"
              style="
                background-color: #f8f9fa;
                color: #333;
                border: 1px solid #ccc;
                padding: 10px;
                width: 100%;
                border-radius: 4px;
                resize: vertical;
                font-size: 13px;
              "
              placeholder="ä¾‹å¦‚: lowres, bad anatomy, bad hands, text, error, missing fingers"
            ></textarea>
            <small
              style="
                display: block;
                color: #666;
                font-size: 12px;
                margin-top: 5px;
              "
            >
              æè¿°ä½ å¸Œæœ›é¿å…çš„å…ƒç´ 
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button
            id="reset-character-nai-prompts-btn"
            class="form-button form-button-secondary"
            style="margin-right: 10px"
          >
            æ¸…ç©ºé…ç½®
          </button>
          <button
            id="save-character-nai-prompts-btn"
            class="form-button form-button-secondary"
          >
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>

    <div id="group-management-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>ç®¡ç†å¥½å‹åˆ†ç»„</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>æ–°å»ºåˆ†ç»„</label>
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                id="new-group-name-input"
                placeholder="è¾“å…¥åˆ†ç»„å..."
                style="flex-grow: 1"
              />
              <button
                id="add-new-group-btn"
                class="form-button"
                style="width: auto; margin-top: 0; padding: 0 15px"
              >
                æ·»åŠ 
              </button>
            </div>
          </div>
          <hr style="opacity: 0.2" />
          <div
            id="existing-groups-list"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <!-- åˆ†ç»„åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="save" id="close-group-manager-btn" style="width: 100%">
            å®Œæˆ
          </button>
        </div>
      </div>
    </div>

    <div id="message-actions-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-footer">
          <!-- æ–°çš„æ“ä½œæŒ‰é’® -->
          <button
            id="reroll-nai-btn"
            style="display: none; background-color: #e3f2fd; color: #1976d2"
          >
            ğŸ¨ é‡ç»˜å›¾ç‰‡
          </button>
          <!-- æ–°å¢è¿™è¡Œ -->
          <button id="edit-message-btn">ç¼–è¾‘æ¶ˆæ¯</button>
          <button id="copy-message-btn">å¤åˆ¶æ–‡æœ¬</button>
          <button id="recall-message-btn">æ’¤å›</button>
          <button id="quote-message-btn">å¼•ç”¨</button>
          <button id="select-message-btn">è¿›å…¥å¤šé€‰</button>
          <!-- å–æ¶ˆæŒ‰é’® -->
          <button
            id="cancel-message-action-btn"
            style="
              margin-top: 8px;
              border-radius: 8px;
              background-color: #f0f0f0;
            "
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <div id="post-actions-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-footer">
          <button id="edit-post-btn">ç¼–è¾‘åŠ¨æ€</button>
          <button id="copy-post-btn">å¤åˆ¶å†…å®¹</button>
          <button id="cancel-post-action-btn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- å¯è§†åŒ–æ¶ˆæ¯ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div id="message-editor-modal" class="modal">
      <div class="modal-content" style="height: 75%">
        <div class="modal-header">
          <span>ç¼–è¾‘ä¸æ‹†åˆ†æ¶ˆæ¯</span>
        </div>
        <div class="modal-body" id="message-editor-body">
          <!-- ç¼–è¾‘å™¨å®¹å™¨ï¼ŒJSä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆæ–‡æœ¬æ¡† -->
          <div id="message-editor-container"></div>
          <!-- æ·»åŠ æ–°æ¶ˆæ¯çš„æŒ‰é’® -->
          <button
            id="add-message-editor-block-btn"
            class="form-button form-button-secondary"
            style="margin-top: 15px"
          >
            [+] æ·»åŠ ä¸‹ä¸€æ¡æ¶ˆæ¯
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-advanced-editor-btn">å–æ¶ˆ</button>
          <button class="save" id="save-advanced-editor-btn">ä¿å­˜æ›´æ”¹</button>
        </div>
      </div>
    </div>

    <!-- ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚æ¨¡æ€æ¡† -->
    <div id="waimai-request-modal" class="modal">
      <div class="modal-content" style="width: 290px">
        <div class="modal-header">
          <span>å‘èµ·å¤–å–ä»£ä»˜</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="waimai-product-info">å•†å“ä¿¡æ¯</label>
            <input
              type="text"
              id="waimai-product-info"
              placeholder="ä¾‹å¦‚ï¼šä¸€æ¯æ¨æç”˜éœ²"
            />
          </div>
          <div class="form-group">
            <label for="waimai-amount">ä»£ä»˜é‡‘é¢ (å…ƒ)</label>
            <input
              type="number"
              id="waimai-amount"
              placeholder="ä¾‹å¦‚ï¼š21"
              min="0"
              step="0.01"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="waimai-cancel-btn">å–æ¶ˆ</button>
          <button class="save" id="waimai-confirm-btn">å‘èµ·è¯·æ±‚</button>
        </div>
      </div>
    </div>

    <!-- æ–°å»ºçº¦å®š/å€’è®¡æ—¶æ¨¡æ€æ¡† -->
    <div id="create-countdown-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>æ–°å»ºçº¦å®š</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="countdown-title-input">çº¦å®šæ ‡é¢˜</label>
            <input
              type="text"
              id="countdown-title-input"
              placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç”Ÿæ—¥"
            />
          </div>
          <div class="form-group">
            <label for="countdown-date-input">çº¦å®šæ—¥æœŸä¸æ—¶é—´</label>
            <input
              type="datetime-local"
              id="countdown-date-input"
              style="
                width: 95%;
                padding: 8px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
              "
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-create-countdown-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-create-countdown-btn">
            ä¿å­˜çº¦å®š
          </button>
        </div>
      </div>
    </div>

    <!-- ã€å…¨æ–°ã€‘å‘çº¢åŒ…æ¨¡æ€æ¡† -->
    <div id="red-packet-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>å‘çº¢åŒ…</span>
        </div>
        <div class="modal-body" style="padding: 0">
          <!-- 1. é¡µç­¾åˆ‡æ¢ -->
          <div class="frame-tabs">
            <div id="rp-tab-group" class="frame-tab active">æ‹¼æ‰‹æ°”çº¢åŒ…</div>
            <div id="rp-tab-direct" class="frame-tab">ä¸“å±çº¢åŒ…</div>
          </div>

          <!-- 2. æ‹¼æ‰‹æ°”çº¢åŒ…å†…å®¹åŒº -->
          <div
            id="rp-content-group"
            class="frame-content"
            style="padding: 20px 15px"
          >
            <div class="form-group">
              <label>æ€»é‡‘é¢ (å…ƒ)</label>
              <input type="number" id="rp-group-amount" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>çº¢åŒ…ä¸ªæ•°</label>
              <input
                type="number"
                id="rp-group-count"
                placeholder="å¡«å†™çº¢åŒ…ä¸ªæ•°"
              />
            </div>
            <div class="form-group">
              <label>ç¥ç¦è¯­</label>
              <input
                type="text"
                id="rp-group-greeting"
                placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼"
              />
            </div>
            <p
              id="rp-group-total"
              style="
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                margin: 10px 0;
              "
            >
              Â¥ 0.00
            </p>
            <button id="send-group-packet-btn" class="form-button">
              å¡é’±è¿›çº¢åŒ…
            </button>
          </div>

          <!-- 3. ä¸“å±çº¢åŒ…å†…å®¹åŒº -->
          <div
            id="rp-content-direct"
            class="frame-content"
            style="display: none; padding: 20px 15px"
          >
            <div class="form-group">
              <label>å‘é€ç»™</label>
              <select id="rp-direct-receiver"></select>
            </div>
            <div class="form-group">
              <label>é‡‘é¢ (å…ƒ)</label>
              <input type="number" id="rp-direct-amount" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>ç¥ç¦è¯­</label>
              <input
                type="text"
                id="rp-direct-greeting"
                placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼"
              />
            </div>
            <p
              id="rp-direct-total"
              style="
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                margin: 10px 0;
              "
            >
              Â¥ 0.00
            </p>
            <button id="send-direct-packet-btn" class="form-button">
              å¡é’±è¿›çº¢åŒ…
            </button>
          </div>
        </div>
        <div class="modal-footer" style="justify-content: center">
          <button class="cancel" id="cancel-red-packet-btn" style="width: 100%">
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <!--ã€å…¨æ–°ã€‘çº¢åŒ…è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="red-packet-details-modal" class="modal">
      <div
        class="modal-content"
        style="width: 280px; height: auto; background-color: #f7f7f7"
      >
        <div
          class="modal-header"
          style="
            background-color: #f96259;
            color: white;
            border-bottom: none;
            padding-bottom: 5px;
          "
        >
          <div style="text-align: center; width: 100%">
            <div id="rp-details-sender" style="font-size: 16px"></div>
            <div style="font-size: 13px; opacity: 0.8">çš„çº¢åŒ…</div>
          </div>
        </div>
        <div class="modal-body" style="padding: 15px">
          <p
            id="rp-details-greeting"
            style="
              text-align: center;
              font-size: 20px;
              color: #333;
              margin: 0 0 20px 0;
            "
          ></p>
          <div
            id="rp-details-my-amount"
            style="text-align: center; display: none; margin-bottom: 20px"
          >
            <span style="font-size: 40px; font-weight: bold; color: #e44d44"
              >0.00</span
            >
            <span style="font-size: 18px; color: #e44d44">å…ƒ</span>
          </div>
          <div
            id="rp-details-summary"
            style="
              font-size: 13px;
              color: #8a8a8a;
              border-top: 1px solid #e0e0e0;
              padding-top: 10px;
            "
          ></div>
          <div
            id="rp-details-list"
            style="max-height: 150px; overflow-y: auto; margin-top: 10px"
          >
            <!-- é¢†å–è¯¦æƒ…å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="save" id="close-rp-details-btn" style="width: 100%">
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- åˆ›å»ºæŠ•ç¥¨æ¨¡æ€æ¡† -->
    <div id="create-poll-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>å‘èµ·æŠ•ç¥¨</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="poll-question-input">æŠ•ç¥¨é—®é¢˜</label>
            <textarea
              id="poll-question-input"
              rows="2"
              placeholder="ä¾‹å¦‚ï¼šä»Šæ™šæˆ‘ä»¬çœ‹ä»€ä¹ˆç”µå½±ï¼Ÿ"
            ></textarea>
          </div>
          <div class="form-group">
            <label>æŠ•ç¥¨é€‰é¡¹ (è‡³å°‘2é¡¹)</label>
            <div
              id="poll-options-container"
              style="display: flex; flex-direction: column; gap: 8px"
            >
              <!-- æŠ•ç¥¨é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <button
              id="add-poll-option-btn"
              class="form-button form-button-secondary"
              style="margin-top: 12px"
            >
              + æ·»åŠ é€‰é¡¹
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-create-poll-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-create-poll-btn">å‘èµ·æŠ•ç¥¨</button>
        </div>
      </div>
    </div>

    <!-- AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="ai-avatar-library-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="ai-avatar-library-title">å¯¹æ–¹çš„å¤´åƒåº“</span>
          <button id="add-ai-avatar-btn" class="action-button">æ·»åŠ </button>
        </div>
        <div class="modal-body" style="padding: 15px">
          <div
            id="ai-avatar-library-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
              gap: 15px;
            "
          >
            <!-- å¤´åƒåº“å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-ai-avatar-library-btn"
            style="width: 100%"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·åˆ†äº«é“¾æ¥æ¨¡æ€æ¡† -->
    <div id="share-link-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>åˆ†äº«é“¾æ¥</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="link-title-input">æ ‡é¢˜</label>
            <input
              type="text"
              id="link-title-input"
              placeholder="è¾“å…¥æ–‡ç« æˆ–é“¾æ¥çš„æ ‡é¢˜"
            />
          </div>
          <div class="form-group">
            <label for="link-description-input">æ‘˜è¦ (å¯é€‰)</label>
            <textarea
              id="link-description-input"
              rows="2"
              placeholder="ç®€å•æè¿°ä¸€ä¸‹é“¾æ¥å†…å®¹"
            ></textarea>
          </div>
          <div class="form-group">
            <label for="link-source-input">æ¥æºåç§° (å¯é€‰)</label>
            <input
              type="text"
              id="link-source-input"
              placeholder="ä¾‹å¦‚ï¼šçŸ¥ä¹æ—¥æŠ¥ã€Bç«™"
            />
          </div>
          <div class="form-group">
            <label for="link-content-input"
              >å®Œæ•´å†…å®¹ (å¯é€‰ï¼Œç”¨äºæµè§ˆå™¨å†…æ˜¾ç¤º)</label
            >
            <textarea
              id="link-content-input"
              rows="4"
              placeholder="ç²˜è´´æˆ–è¾“å…¥å®Œæ•´çš„æ–‡ç« å†…å®¹"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-share-link-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-share-link-btn">åˆ†äº«</button>
        </div>
      </div>
    </div>

    <!-- è½¬è´¦æ“ä½œå¼¹çª— -->
    <div id="transfer-actions-modal" class="modal">
      <div class="transfer-actions-content">
        <div class="transfer-actions-header">è¯·é€‰æ‹©æ“ä½œ</div>
        <div class="transfer-actions-body">
          <p>
            ä½ æ”¶åˆ°äº†æ¥è‡ª
            <strong id="transfer-sender-name"></strong> çš„ä¸€ç¬”è½¬è´¦ã€‚
          </p>
        </div>
        <div class="transfer-actions-footer">
          <button id="transfer-action-decline" class="action-btn decline">
            æ®‹å¿æ‹’ç»
          </button>
          <button id="transfer-action-accept" class="action-btn accept">
            å¼€å¿ƒæ”¶ä¸‹
          </button>
        </div>
        <button id="transfer-action-cancel" class="cancel-btn">Ã—</button>
      </div>
    </div>

    <!-- é€šè¯è®°å½•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="call-transcript-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="transcript-modal-title">é€šè¯è¯¦æƒ…</span>
        </div>
        <div
          class="modal-body"
          id="transcript-modal-body"
          style="background-color: #f0f2f5"
        >
          <!-- é€šè¯æ–‡å­—è®°å½•å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="delete-transcript-btn"
            style="
              background-color: #ff3b30;
              color: white;
              border-color: #ff3b30;
            "
          >
            åˆ é™¤è®°å½•
          </button>
          <button
            class="save"
            id="close-transcript-modal-btn"
            style="width: 100%"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- åˆ†äº«ç›®æ ‡é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
    <div id="share-target-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="share-target-modal-title">åˆ†äº«åˆ°...</span>
        </div>
        <div class="modal-body" id="share-target-list" style="padding: 0">
          <!-- èŠå¤©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-share-target-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-share-target-btn">ç¡®è®¤åˆ†äº«</button>
        </div>
      </div>
    </div>

    <!-- åˆ†äº«è®°å½•æŸ¥çœ‹å™¨æ¨¡æ€æ¡† -->
    <div id="shared-history-viewer-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span id="shared-history-viewer-title">èŠå¤©è®°å½•</span>
        </div>
        <div
          class="modal-body"
          id="shared-history-viewer-content"
          style="background-color: #f0f2f5"
        >
          <!-- åˆ†äº«çš„èŠå¤©è®°å½•æ°”æ³¡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-shared-history-viewer-btn"
            style="width: 100%"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- ä¸–ç•Œä¹¦åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="world-book-category-manager-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>ç®¡ç†ä¸–ç•Œä¹¦åˆ†ç±»</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>æ–°å»ºåˆ†ç±»</label>
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                id="new-category-name-input"
                placeholder="è¾“å…¥åˆ†ç±»å..."
                style="flex-grow: 1"
              />
              <button
                id="add-new-category-btn"
                class="form-button"
                style="width: auto; margin-top: 0; padding: 0 15px"
              >
                æ·»åŠ 
              </button>
            </div>
          </div>
          <hr style="opacity: 0.2" />
          <div
            id="existing-categories-list"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <!-- åˆ†ç±»åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-category-manager-btn"
            style="width: 100%"
          >
            å®Œæˆ
          </button>
        </div>
      </div>
    </div>

    <!-- è§’è‰²ä¸“å±NPCåº“ç®¡ç†ç•Œé¢ -->
    <div id="npc-management-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-npc-management">â€¹</span>
        <span id="npc-management-title">NPC åº“ç®¡ç†</span>
        <span class="action-btn" id="add-new-npc-btn">+</span>
      </div>
      <div class="list-container" id="npc-management-list">
        <!-- NPCåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <!-- 1. è®ºå›ä¸»å±å¹• (æ˜¾ç¤ºæ‰€æœ‰å°ç»„) -->
    <div id="forum-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>åœˆå­</span>
        <div class="header-actions">
          <span
            class="action-btn filter-btn"
            id="forum-filter-btn"
            title="ç­›é€‰"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polygon
                points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"
              ></polygon>
            </svg>
          </span>
          <span class="action-btn" id="open-forum-bookshelf-btn" title="ä¹¦æ¶">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              width="22"
              height="22"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M4 3h12.5a1.5 1.5 0 0 1 1.5 1.5V21" />
              <path d="M4 21V4.5A1.5 1.5 0 0 1 5.5 3H18" />
              <path d="M9 7h6" />
              <path d="M9 11h6" />
              <path d="M9 15h6" />
              <path d="M4 21h16" />
            </svg>
          </span>

          <span
            class="action-btn"
            id="create-group-btn"
            style="font-size: 28px; font-weight: 300"
            >+</span
          >
        </div>
      </div>
      <div
        id="forum-group-list"
        class="list-container"
        style="
          padding: 15px;
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          align-content: start;
        "
      >
        <!-- å°ç»„åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <div id="group-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-to-forum-list">â€¹</span>
        <span id="group-screen-title">å°ç»„åç§°</span>
        <div class="header-actions">
          <span
            class="action-btn filter-btn"
            id="group-filter-btn"
            title="ç­›é€‰"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polygon
                points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"
              ></polygon>
            </svg>
          </span>

          <span
            class="action-btn"
            id="generate-group-content-btn"
            title="ç”Ÿæˆå†…å®¹"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
            </svg>
          </span>
          <span
            class="action-btn"
            id="create-forum-post-btn"
            style="font-size: 28px; font-weight: 300"
            >+</span
          >
        </div>
      </div>
      <!-- åŒäººæ–‡åˆ›ä½œæ§åˆ¶å° (æ— æŒ‰é’®ç‰ˆ) -->
      <div id="fanfic-preference-bar" style="display: none">
        <!-- 1. é¡¶éƒ¨æ ‡é¢˜æ  -->
        <div id="fanfic-bar-header">
          <span class="bar-title">ğŸª„ åŒäººåˆ›ä½œæ§åˆ¶å°</span>
          <span id="fanfic-bar-toggle-icon">â–¼</span>
        </div>

        <!-- 2. å¯æŠ˜å çš„å†…å®¹åŒºåŸŸ -->
        <div id="fanfic-bar-content">
          <!-- é¢„è®¾ç®¡ç† -->
          <div class="fanfic-row presets-row">
            <select id="fanfic-preset-select">
              <option value="">-- è¯»å–é…ç½® --</option>
            </select>
            <button id="save-fanfic-preset-btn" class="mini-btn">ä¿å­˜</button>
            <button id="delete-fanfic-preset-btn" class="mini-btn danger">
              åˆ é™¤
            </button>
          </div>

          <!-- CP é€‰æ‹© -->
          <div class="fanfic-row cp-row">
            <select id="fanfic-char1-select"></select>
            <span class="cp-symbol">Ã—</span>
            <select id="fanfic-char2-select"></select>
          </div>

          <!-- æ ¸å¿ƒå‚æ•° -->
          <div class="fanfic-row params-row">
            <div class="input-group">
              <label>æœŸæœ›å­—æ•°</label>
              <input
                type="text"
                id="fanfic-wordcount-input"
                placeholder="ä¾‹: 3000å­—"
              />
            </div>
            <div class="input-group">
              <label>æ–‡ç« ç±»å‹</label>
              <input
                type="text"
                id="fanfic-type-input"
                placeholder="ä¾‹: ç”œæ–‡/ABO"
              />
            </div>
            <div class="input-group">
              <label>ç¯‡å¹…</label>
              <select id="fanfic-length-select">
                <option value="short">çŸ­ç¯‡</option>
                <option value="long">é•¿ç¯‡è¿è½½</option>
              </select>
            </div>
          </div>

          <!-- å†™ä½œè§„èŒƒ -->
          <div class="fanfic-row full-width">
            <label>æ–‡é£ / å†™ä½œè§„èŒƒ</label>
            <input
              type="text"
              id="fanfic-style-input"
              placeholder="ä¾‹: å¿ƒç†æå†™ç»†è…»ï¼Œç¬¬ä¸€äººç§°..."
            />
          </div>

          <!-- ä¸–ç•Œè§‚ -->
          <div class="fanfic-row full-width">
            <label>ä¸–ç•Œè§‚ / å‰§æƒ…æ¢—æ¦‚</label>
            <textarea
              id="fanfic-worldview-input"
              rows="2"
              placeholder="åœ¨è¿™é‡Œè¾“å…¥èƒŒæ™¯è®¾å®š..."
            ></textarea>
          </div>
        </div>
      </div>

      <div id="group-post-list" class="list-container" style="padding-top: 0">
        <!-- å¸–å­åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <!-- 3. å•ä¸ªå¸–å­é¡µé¢ (æ˜¾ç¤ºå¸–å­å†…å®¹å’Œè¯„è®º) -->
    <div id="post-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-to-group-screen">â€¹</span>
        <span>å¸–å­è¯¦æƒ…</span>
        <div class="header-actions">
          <span class="action-btn" id="repost-to-chat-btn">è½¬è½½</span>
        </div>
      </div>
      <div
        id="post-detail-content"
        class="list-container"
        style="padding: 20px"
      >
        <!-- å¸–å­å’Œè¯„è®ºå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
      <!-- å¸–å­é¡µçš„è¯„è®ºè¾“å…¥æ¡† -->
      <div
        id="post-comment-input-area"
        class="chat-input-area"
        style="visibility: visible"
      >
        <div class="chat-input-main-row">
          <textarea
            id="post-comment-input"
            rows="1"
            placeholder="å‘å¸ƒä½ çš„è¯„è®º..."
          ></textarea>
          <button id="send-post-comment-btn" class="action-button">å‘é€</button>
        </div>
      </div>
    </div>

    <div id="forum-bookshelf-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-forum-bookshelf">?</span>
        <span>åœˆå­ä¹¦æ¶</span>
      </div>
      <div
        id="forum-bookshelf-list"
        class="list-container forum-bookshelf-list"
        style="padding-top: 0"
      >
        <!-- è¿½æ›´çš„é•¿ç¯‡ä¼šåœ¨è¿™é‡Œå±•ç¤º -->
      </div>
    </div>

    <div id="forum-series-detail-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-series-detail">?</span>
        <span id="forum-series-detail-title">è¿è½½è¯¦æƒ…</span>
        <div class="header-actions">
          <span class="action-btn" id="series-next-chapter-btn">è¿½æ›´</span>
        </div>
      </div>
      <div
        id="forum-series-meta"
        class="list-container"
        style="padding-top: 0"
      ></div>
      <div
        id="forum-series-chapter-list"
        class="list-container forum-series-chapter-list"
        style="padding-top: 0"
      ></div>
    </div>

    <div id="forum-filter-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 60%">
        <div class="modal-header">
          <span>æŒ‰åˆ†ç±»ç­›é€‰</span>
        </div>
        <div class="modal-body">
          <div id="forum-filter-category-list">
            <!-- åˆ†ç±»æ ‡ç­¾å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
        </div>
        <div class="modal-footer" style="justify-content: space-between">
          <button class="cancel" id="reset-forum-filter-btn" style="width: 30%">
            é‡ç½®
          </button>
          <button
            class="cancel"
            id="cancel-forum-filter-btn"
            style="width: 30%"
          >
            å–æ¶ˆ
          </button>
          <button class="save" id="apply-forum-filter-btn" style="width: 30%">
            åº”ç”¨
          </button>
        </div>
      </div>
    </div>

    <!-- è‡ªå®šä¹‰å¤´åƒæ¡†ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="custom-frame-manager-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>ç®¡ç†æˆ‘çš„å¤´åƒæ¡†</span>
          <button id="upload-custom-frame-btn" class="action-button">
            ä¸Šä¼ 
          </button>
        </div>
        <div class="modal-body" style="padding: 15px">
          <div
            id="custom-frame-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
              gap: 15px;
            "
          >
            <!-- è‡ªå®šä¹‰å¤´åƒæ¡†å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="save" id="close-frame-manager-btn" style="width: 100%">
            å…³é—­
          </button>
        </div>
      </div>
    </div>
    <input
      type="file"
      id="custom-frame-upload-input"
      accept="image/png, image/gif"
      hidden
      multiple
    />

    <!-- å¤´åƒæ¡†é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="avatar-frame-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>é€‰æ‹©å¤´åƒæ¡†</span>

          <button id="manage-custom-frames-btn" class="action-button">
            ç®¡ç†
          </button>
        </div>
        <div class="modal-body" style="padding: 15px">
          <div id="avatar-frame-grid" class="frame-grid">
            <!-- å¤´åƒæ¡†é€‰é¡¹ï¼ˆåŒ…æ‹¬â€œæ— â€å’Œè‡ªå®šä¹‰çš„ï¼‰ä¼šåœ¨è¿™é‡Œç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-frame-settings-btn">å–æ¶ˆ</button>
          <button class="save" id="save-frame-settings-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div id="send-location-modal" class="modal">
      <div
        class="modal-content"
        style="width: 300px; height: auto; max-height: 80%"
      >
        <div class="modal-header">
          <span>å‘é€å®šä½ä¸è½¨è¿¹</span>
        </div>
        <div class="modal-body" style="padding-bottom: 5px">
          <!-- æ ¸å¿ƒä¿¡æ¯ -->
          <div class="form-group">
            <label for="user-location-input">æˆ‘çš„ä½ç½® (èµ·ç‚¹)</label>
            <input
              type="text"
              id="user-location-input"
              placeholder="ä¾‹å¦‚ï¼šå¸‚ä¸­å¿ƒçš„å’–å•¡é¦†"
            />
          </div>
          <div class="form-group">
            <label for="ai-location-input">Taçš„ä½ç½® (ç»ˆç‚¹)</label>
            <input
              type="text"
              id="ai-location-input"
              placeholder="ä¾‹å¦‚ï¼šæµ·è¾¹çš„ç¯å¡”"
            />
          </div>
          <div class="form-group">
            <label for="distance-input">ç›¸è·</label>
            <input
              type="text"
              id="distance-input"
              placeholder="ä¾‹å¦‚ï¼šçº¦5å…¬é‡Œ (å¿…å¡«)"
            />
          </div>

          <hr style="opacity: 0.2" />

          <!-- è¡ŒåŠ¨è½¨è¿¹è¾“å…¥åŒº -->
          <div class="form-group">
            <label>è¡ŒåŠ¨è½¨è¿¹ (å¯é€‰ï¼ŒæŒ‰é¡ºåºå¡«å†™)</label>
            <div
              id="trajectory-points-container"
              style="display: flex; flex-direction: column; gap: 8px"
            >
              <!-- JSä¼šåœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ è¾“å…¥æ¡† -->
            </div>
            <button
              id="add-trajectory-point-btn"
              class="form-button form-button-secondary"
              style="margin-top: 12px"
            >
              + æ·»åŠ é€”ç»ç‚¹
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="location-cancel-btn">å–æ¶ˆ</button>
          <button class="save" id="location-confirm-btn">å‘é€</button>
        </div>
      </div>
    </div>

    <!-- ç²˜è´´æ‚¬æµ®æ­Œè¯æ è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="lyrics-settings-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>æ‚¬æµ®æ­Œè¯è®¾ç½®</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="lyrics-font-size-slider"
              >å­—ä½“å¤§å°: <span id="lyrics-font-size-value">14px</span></label
            >
            <input
              type="range"
              id="lyrics-font-size-slider"
              min="12"
              max="24"
              value="14"
              style="width: 100%"
            />
          </div>
          <div class="form-group">
            <label for="lyrics-bg-opacity-slider"
              >èƒŒæ™¯ä¸é€æ˜åº¦: <span id="lyrics-bg-opacity-value">0%</span></label
            >
            <input
              type="range"
              id="lyrics-bg-opacity-slider"
              min="0"
              max="100"
              value="0"
              style="width: 100%"
            />
          </div>
          <div class="form-group">
            <label for="lyrics-font-color-picker">å­—ä½“é¢œè‰²</label>
            <input
              type="color"
              id="lyrics-font-color-picker"
              value="#FFFFFF"
              style="width: 100%; height: 40px"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="reset-lyrics-settings-btn">
            æ¢å¤é»˜è®¤
          </button>
          <button class="save" id="close-lyrics-settings-btn">å®Œæˆ</button>
        </div>
      </div>
    </div>
    <div id="music-source-selector-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>é€‰æ‹©æœç´¢æº</span>
        </div>
        <div class="modal-body" style="text-align: left; padding: 20px">
          <!-- â–¼â–¼â–¼ ä¿®æ”¹/æ–°å¢éƒ¨åˆ†å¼€å§‹ â–¼â–¼â–¼ -->
          <label style="display: block; margin-bottom: 15px; cursor: pointer">
            <input type="radio" name="search-source" value="all" checked />
            èšåˆæœç´¢ (ç½‘æ˜“äº‘ + QQéŸ³ä¹)
          </label>
          <label style="display: block; margin-bottom: 15px; cursor: pointer">
            <input type="radio" name="search-source" value="netease" /> ä»…ç½‘æ˜“äº‘
            (vkeysæ¥å£)
          </label>
          <label style="display: block; margin-bottom: 15px; cursor: pointer">
            <input type="radio" name="search-source" value="tencent" /> ä»…QQéŸ³ä¹
            (vkeysæ¥å£)
          </label>
          <!-- æ–°å¢ GD éŸ³ä¹å°çš„é€‰é¡¹ -->
          <label
            style="
              display: block;
              cursor: pointer;
              color: #ff5722;
              font-weight: bold;
            "
          >
            <input type="radio" name="search-source" value="gdstudio" />
            GDéŸ³ä¹å° (æ¨è)
          </label>
          <!-- â–²â–²â–² ä¿®æ”¹/æ–°å¢éƒ¨åˆ†ç»“æŸ â–²â–²â–² -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-source-select-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-source-select-btn">å¼€å§‹æœç´¢</button>
        </div>
      </div>
    </div>

    <div id="weibo-following-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>å…³æ³¨åˆ—è¡¨</span>
        </div>
        <div class="modal-body" style="padding: 0">
          <div id="weibo-following-list-container">
            <!-- å…³æ³¨åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-following-list-btn"
            style="width: 100%"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- å¡”ç½—ç‰Œå åœä¸»æ¨¡æ€æ¡† -->
    <div id="tarot-divination-modal" class="modal">
      <div class="modal-content" style="height: 85%; width: 95%">
        <!-- 1. å åœè®¾ç½®ç•Œé¢ -->
        <div id="tarot-setup-view">
          <div class="modal-header">
            <span>å¡”ç½—ç‰Œå åœ</span>
            <div>
              <span
                id="tarot-history-btn"
                class="action-btn"
                style="font-size: 16px"
                >å†å²</span
              >
              <span
                id="close-tarot-modal-btn"
                class="action-btn"
                style="font-size: 16px"
                >å…³é—­</span
              >
            </div>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="tarot-question-input">æ‚¨çš„é—®é¢˜æˆ–å…³æ³¨ç‚¹</label>
              <textarea
                id="tarot-question-input"
                rows="2"
                placeholder="ä¾‹å¦‚ï¼šæˆ‘è¿‘æœŸçš„æ¡ƒèŠ±è¿å¦‚ä½•ï¼Ÿ"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="tarot-spread-select">é€‰æ‹©ç‰Œé˜µ</label>
              <select id="tarot-spread-select">
                <option value="single">å•å¼ ç‰Œ - å¿«é€ŸæŒ‡å¼•</option>
                <option value="three_past_present_future">
                  ä¸‰å¼ ç‰Œ - è¿‡å»/ç°åœ¨/æœªæ¥
                </option>
                <option value="three_situation_challenge_advice">
                  ä¸‰å¼ ç‰Œ - æƒ…å¢ƒ/æŒ‘æˆ˜/å»ºè®®
                </option>
                <option value="celtic_cross">
                  å‡¯å°”ç‰¹åå­— - æ·±åº¦åˆ†æ (10å¼ ç‰Œ)
                </option>
              </select>
            </div>
            <div class="form-group">
              <label>ç‰Œé¢æ–¹å‘</label>
              <div style="display: flex; gap: 20px">
                <label
                  ><input
                    type="radio"
                    name="tarot-orientation"
                    value="upright"
                    checked
                  />
                  ä»…æ­£ä½</label
                >
                <label
                  ><input
                    type="radio"
                    name="tarot-orientation"
                    value="reversed"
                  />
                  åŒ…å«é€†ä½</label
                >
              </div>
            </div>
            <button
              id="draw-tarot-cards-btn"
              class="form-button"
              style="margin-top: 20px"
            >
              æ´—ç‰Œå¹¶æŠ½ç‰Œ
            </button>
          </div>
        </div>

        <!-- 2. å åœç»“æœç•Œé¢ (é»˜è®¤éšè—) -->
        <div
          id="tarot-result-view"
          style="
            display: none;
            height: 100%;
            display: flex;
            flex-direction: column;
          "
        >
          <div class="modal-header">
            <span
              id="back-to-tarot-setup-btn"
              class="action-btn"
              style="font-size: 16px"
              >è¿”å›</span
            >
            <span>å åœç»“æœ</span>
          </div>
          <div class="modal-body" id="tarot-result-display">
            <!-- ç»“æœå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
          <div class="modal-footer">
            <button id="send-tarot-result-btn" class="save" style="width: 100%">
              å‘ç»™å¡”ç½—å¸ˆè§£è¯»
            </button>
          </div>
        </div>

        <!-- 3. å†å²è®°å½•ç•Œé¢ (é»˜è®¤éšè—) -->
        <div
          id="tarot-history-view"
          style="
            display: none;
            height: 100%;
            display: flex;
            flex-direction: column;
          "
        >
          <div class="modal-header">
            <span
              id="back-to-tarot-main-btn"
              class="action-btn"
              style="font-size: 16px"
              >è¿”å›</span
            >
            <span>å åœå†å²</span>
          </div>
          <div class="modal-body" id="tarot-history-list">
            <!-- å†å²è®°å½•å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
        </div>
      </div>
    </div>

    <!-- 2. åˆ‡æ¢è§’è‰²çš„å¼¹çª— -->
    <div id="ls-char-selector-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>é€‰æ‹©ç©ºé—´</span>
        </div>
        <div class="modal-body" id="ls-char-selector-list" style="padding: 0">
          <!-- è§’è‰²åˆ—è¡¨ä¼šç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="ls-cancel-switch-char-btn"
            style="width: 100%"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <!-- 3. å‘å¸ƒè¯´è¯´çš„å¼¹çª— -->
    <div id="ls-create-moment-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>æƒ³å¯¹Taè¯´...</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <textarea
              id="ls-moment-content-input"
              rows="5"
              placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ ä»¬çš„ç§å¯†è¯è¯­..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-cancel-moment-btn">å–æ¶ˆ</button>
          <button class="save" id="ls-confirm-moment-btn">å‘å¸ƒ</button>
        </div>
      </div>
    </div>

    <!-- 4. åˆ›å»ºç›¸å†Œ/ä¸Šä¼ ç…§ç‰‡çš„å¼¹çª— (è¿™æ˜¯ä¿®æ”¹åçš„ç‰ˆæœ¬) -->
    <div id="ls-create-album-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <!-- æ ‡é¢˜å·²ä¿®æ”¹ -->
          <span id="ls-album-modal-title">ä¸Šä¼ ç…§ç‰‡</span>
        </div>
        <div class="modal-body">
          <!-- æ–°å¢ï¼šæ¨¡å¼åˆ‡æ¢å¼€å…³ (å¤ç”¨åŠ¨æ€çš„æ ·å¼) -->
          <div class="post-mode-switcher">
            <button id="ls-switch-to-image-mode" class="mode-btn active">
              ä¸Šä¼ å›¾ç‰‡
            </button>
            <button id="ls-switch-to-text-image-mode" class="mode-btn">
              ä½¿ç”¨æ–‡å­—å›¾
            </button>
          </div>

          <!-- æ¨¡å¼1: ä¸Šä¼ å›¾ç‰‡ -->
          <div id="ls-image-mode-content" class="post-mode-content active">
            <div class="form-group">
              <label>é€‰æ‹©ç…§ç‰‡ (ä»…é™å•å¼ )</label>
              <div id="ls-photo-preview-container"></div>
              <button
                class="form-button form-button-secondary"
                id="ls-select-photos-btn"
              >
                é€‰æ‹©ç…§ç‰‡
              </button>
              <!-- å…³é”®ï¼šè¿™é‡Œçš„ input ç§»é™¤äº† multiple å±æ€§ï¼Œç°åœ¨åªèƒ½å•é€‰ -->
              <input type="file" id="ls-photo-input" accept="image/*" hidden />
            </div>
            <div class="form-group">
              <label>å›¾ç‰‡æè¿° (å¿…å¡«)</label>
              <textarea
                id="ls-photo-desc-input"
                rows="3"
                placeholder="ä¸ºè¿™å¼ ç…§ç‰‡å†™ä¸‹æ³¨è„š..."
              ></textarea>
            </div>
          </div>

          <!-- æ¨¡å¼2: ä½¿ç”¨æ–‡å­—å›¾ -->
          <div
            id="ls-text-image-mode-content"
            class="post-mode-content"
            style="display: none"
          >
            <div class="form-group">
              <label>æ–‡å­—å›¾æè¿° (å¿…å¡«)</label>
              <textarea
                id="ls-text-image-desc-input"
                rows="5"
                placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å¿ƒæƒ…æˆ–æ•…äº‹..."
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-cancel-album-btn">å–æ¶ˆ</button>
          <button class="save" id="ls-confirm-album-btn">ç¡®è®¤ä¸Šä¼ </button>
        </div>
      </div>
    </div>

    <!-- æƒ…ä¾£ç©ºé—´-å†™æƒ…ä¹¦/å›ä¿¡çš„å¼¹çª— -->
    <div id="ls-create-letter-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span id="ls-letter-modal-title">ç»™Taå†™ä¸€å°ä¿¡</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="ls-letter-recipient-input">æ”¶ä¿¡äºº</label>
            <!-- æ”¶ä¿¡äººé€šå¸¸æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç¦ç”¨è¿™ä¸ªè¾“å…¥æ¡† -->
            <input type="text" id="ls-letter-recipient-input" disabled />
          </div>
          <div class="form-group">
            <label for="ls-letter-content-input">æƒ…ä¹¦å†…å®¹</label>
            <textarea
              id="ls-letter-content-input"
              rows="8"
              placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å¿ƒæ„..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-cancel-letter-btn">å–æ¶ˆ</button>
          <button class="save" id="ls-confirm-letter-btn">å¯„å‡º</button>
        </div>
      </div>
    </div>

    <!-- æƒ…ä¾£ç©ºé—´-æƒ…ä¹¦æŸ¥çœ‹å™¨ -->
    <div id="ls-letter-viewer-modal" class="modal">
      <div class="ls-letter-viewer-content">
        <!-- å¤´éƒ¨ï¼šæ”¶ä¿¡äººä¿¡æ¯ -->
        <div class="letter-viewer-header">
          <img id="ls-viewer-recipient-avatar" class="meta-avatar" />
          <div class="recipient-info">
            <div class="label">To my dear:</div>
            <div id="ls-viewer-recipient-name" class="name"></div>
          </div>
        </div>
        <!-- ä¸­é—´ï¼šä¿¡ä»¶æ­£æ–‡ -->
        <div id="ls-viewer-body" class="letter-viewer-body">
          <!-- JSä¼šåœ¨è¿™é‡Œå¡«å……ä¿¡ä»¶å†…å®¹ -->
        </div>
        <!-- åº•éƒ¨ï¼šå‘ä¿¡äººä¿¡æ¯å’Œæ“ä½œæŒ‰é’® -->
        <div class="letter-viewer-footer">
          <div class="sender-info">
            <div id="ls-viewer-sender-name"></div>
            <div id="ls-viewer-timestamp" class="timestamp"></div>
          </div>
          <div class="letter-actions">
            <button id="ls-close-letter-viewer-btn">å…³é—­</button>
            <button id="ls-reply-letter-btn" class="primary">å›ä¿¡</button>
          </div>
        </div>
      </div>
    </div>

    <!-- æƒ…ä¾£ç©ºé—´è®¾ç½®å¼¹çª— -->
    <div id="ls-settings-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>æƒ…ä¾£ç©ºé—´è®¾ç½®</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="ls-start-date-input">æˆ‘ä»¬åœ¨ä¸€èµ·çš„ç¬¬ä¸€å¤©</label>
            <input
              type="date"
              id="ls-start-date-input"
              style="width: 100%; padding: 10px; box-sizing: border-box"
            />
          </div>

          <hr style="opacity: 0.2; margin: 20px 0" />
          <div class="form-group">
            <label>å±é™©æ“ä½œ</label>
            <div style="display: flex; gap: 10px">
              <button
                id="ls-cancel-space-btn"
                class="form-button form-button-secondary"
                style="
                  background-color: #ffe5e5;
                  color: #ff3b30;
                  border-color: #ffc2d1;
                  flex: 1;
                  margin: 0;
                "
              >
                å–æ¶ˆç©ºé—´
              </button>
              <button
                id="ls-disconnect-space-btn"
                class="form-button form-button-secondary"
                style="
                  background-color: #ff3b30;
                  color: white;
                  border-color: #ff3b30;
                  flex: 1;
                  margin: 0;
                "
              >
                è§£é™¤å…³ç³»
              </button>
            </div>
            <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px">
              <strong>å–æ¶ˆç©ºé—´</strong>:
              å°†ç©ºé—´å˜ä¸ºæœªå¯ç”¨çŠ¶æ€ï¼Œä½†ä¿ç•™æ‰€æœ‰æ•°æ®ã€‚ä¸ä¼šé€šçŸ¥å¯¹æ–¹ã€‚<br />
              <strong>è§£é™¤å…³ç³»</strong>:
              åŒæ ·ä¼šå–æ¶ˆç©ºé—´ï¼Œä½†ä¼šé€šçŸ¥å¯¹æ–¹å…³ç³»å·²è§£é™¤ï¼Œå¯¹æ–¹ä¼šå¯¹æ­¤å‘è¡¨æ„è§ã€‚
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-settings-cancel-btn">å–æ¶ˆ</button>
          <button class="save" id="ls-settings-save-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- æƒ…ä¾£ç©ºé—´-æé—®å¼¹çª— -->
    <div id="ls-ask-question-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>å‘èµ·ä¸€ä¸ªæé—®</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <textarea
              id="ls-question-content-input"
              rows="5"
              placeholder="å‘Taæä¸ªé—®é¢˜å§..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-cancel-ask-btn">å–æ¶ˆ</button>
          <button class="save" id="ls-confirm-ask-btn">å‘Taæé—®</button>
        </div>
      </div>
    </div>

    <!-- æƒ…ä¾£ç©ºé—´-å›ç­”å¼¹çª— -->
    <div id="ls-answer-question-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>å›ç­”Taçš„é—®é¢˜</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>é—®é¢˜ï¼š</label>
            <p
              id="ls-answer-question-text"
              style="
                background-color: #f0f2f5;
                padding: 10px;
                border-radius: 8px;
              "
            ></p>
          </div>
          <div class="form-group">
            <label for="ls-answer-content-input">ä½ çš„å›ç­”ï¼š</label>
            <textarea
              id="ls-answer-content-input"
              rows="5"
              placeholder="è®¤çœŸå›ç­”å“¦..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-cancel-answer-btn">å–æ¶ˆ</button>
          <button class="save" id="ls-confirm-answer-btn">ç¡®è®¤å›ç­”</button>
        </div>
      </div>
    </div>

    <!-- 1. è¿™æ˜¯æ’­æ”¾å™¨ä¸“å±çš„éŸ³é¢‘å¼•æ“ -->
    <audio id="ls-audio-player" style="display: none"></audio>

    <!-- 2. è¿™æ˜¯æ’­æ”¾å™¨çš„ä¸»çª—å£ç•Œé¢ -->
    <div id="ls-music-player-overlay" class="modal">
      <div class="music-player-window">
        <!-- å°é¢å’Œæ­Œè¯çš„åˆ‡æ¢å®¹å™¨ -->
        <div
          id="ls-display-area"
          style="
            width: 192px;
            height: 192px;
            margin-bottom: 20px;
            cursor: pointer;
          "
        >
          <!-- æ­Œæ›²å°é¢ -->
          <img
            id="ls-album-cover"
            src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png"
            alt="æ­Œæ›²å°é¢"
            style="
              width: 100%;
              height: 100%;
              border-radius: 12px;
              box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            "
          />

          <!-- æ­Œè¯å®¹å™¨ -->
          <div
            id="ls-lyrics-container"
            style="
              display: none;
              width: 100%;
              height: 100%;
              overflow: hidden;
              text-align: center;
              color: #333;
              font-weight: 500;
            "
          >
            <div id="ls-lyrics-list" style="transition: transform 0.5s ease">
              <!-- æ­Œè¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
          </div>
        </div>

        <!-- æ­Œæ›²ä¿¡æ¯ -->
        <div id="ls-song-title" style="font-size: 18px; font-weight: 600">
          æš‚æ— æ­Œæ›²
        </div>
        <div
          id="ls-artist"
          style="font-size: 14px; color: #666; margin-bottom: 15px"
        >
          ...
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="music-progress-bar-container" style="width: 100%">
          <div id="ls-current-time" class="time-display">0:00</div>
          <div class="progress-bar" id="ls-progress-bar">
            <div id="ls-progress-fill" class="progress-bar-fill"></div>
          </div>
          <div id="ls-total-time" class="time-display">0:00</div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="music-controls" style="margin-bottom: 15px">
          <button id="ls-prev-btn">â—€</button>
          <button id="ls-play-pause-btn" class="play-pause-btn">â–¶</button>
          <button id="ls-next-btn">â–¶</button>
        </div>

        <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
        <div class="music-bottom-actions" style="width: 100%">
          <button
            id="ls-playlist-btn"
            style="
              background-color: rgba(0, 123, 255, 0.1);
              color: var(--accent-color);
              margin-right: 5px;
            "
          >
            æ’­æ”¾åˆ—è¡¨
          </button>
          <button
            id="ls-close-player-btn"
            style="
              background-color: rgba(0, 0, 0, 0.05);
              color: #333;
              margin-left: 5px;
            "
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- 3. è¿™æ˜¯æ’­æ”¾åˆ—è¡¨çš„ä¾§æ»‘é¢æ¿ -->
    <div id="ls-music-playlist-panel" class="music-playlist-panel">
      <div class="playlist-header">
        <span class="panel-btn" id="ls-close-playlist-btn">è¿”å›</span>
        <span>æ’­æ”¾åˆ—è¡¨</span>
        <span
          class="panel-btn"
          id="ls-clear-playlist-btn"
          style="color: #ff3b30"
          >æ¸…ç©º</span
        >
      </div>
      <div class="playlist-body" id="ls-playlist-body">
        <!-- æ’­æ”¾åˆ—è¡¨å†…å®¹ä¼šåœ¨è¿™é‡Œç”Ÿæˆ -->
      </div>
    </div>

    <!-- æƒ…ä¾£ç•ªèŒ„é’Ÿ-è®¾ç½®å¼¹çª— -->
    <div id="ls-pomodoro-setup-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>æ–°çš„ä¸“æ³¨æ—¶å…‰</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="pomodoro-task-input">ä¸“æ³¨ä»»åŠ¡</label>
            <input
              type="text"
              id="pomodoro-task-input"
              placeholder="ä¾‹å¦‚ï¼šå­¦ä¹ JSã€å®Œæˆå·¥ä½œæŠ¥å‘Š"
            />
          </div>
          <div class="form-group">
            <label for="pomodoro-duration-input">ä¸“æ³¨æ—¶é•¿ (åˆ†é’Ÿ)</label>
            <input
              type="number"
              id="pomodoro-duration-input"
              value="25"
              min="1"
            />
          </div>
          <div class="form-group">
            <label>è®¡æ—¶æ¨¡å¼</label>
            <div style="display: flex; gap: 20px">
              <label
                ><input
                  type="radio"
                  name="pomodoro-mode"
                  value="countdown"
                  checked
                />
                å€’è®¡æ—¶</label
              >
              <label
                ><input type="radio" name="pomodoro-mode" value="countup" />
                æ­£è®¡æ—¶</label
              >
            </div>
          </div>
          <div class="form-group">
            <label for="pomodoro-talk-interval-input"
              >è§’è‰²é¼“åŠ±é—´éš” (åˆ†é’Ÿ, 0ä¸ºä¸è‡ªåŠ¨é¼“åŠ±)</label
            >
            <input
              type="number"
              id="pomodoro-talk-interval-input"
              value="5"
              min="0"
            />
          </div>
          <div class="form-group">
            <label>èƒŒæ™¯éŸ³ä¹ (BGM)</label>
            <select
              id="pomodoro-bgm-source-select"
              style="
                width: 100%;
                padding: 8px;
                border-radius: 6px;
                border: 1px solid #ccc;
                margin-bottom: 10px;
              "
            >
              <option value="none">ğŸ”• é™éŸ³ / ä¸æ’­æ”¾</option>
              <option value="global">ğŸµ ä¸€èµ·å¬æ’­æ”¾åˆ—è¡¨</option>
              <option value="custom">ğŸ“‚ è‡ªå®šä¹‰ç•ªèŒ„é’Ÿæ­Œå•</option>
            </select>

            <!-- è‡ªå®šä¹‰æ­Œå•ç®¡ç†é¢æ¿ (é»˜è®¤éšè—) -->
            <div
              id="pomodoro-custom-playlist-panel"
              style="
                display: none;
                background: #f5f5f5;
                padding: 10px;
                border-radius: 8px;
              "
            >
              <div
                id="pomodoro-custom-list"
                style="
                  max-height: 100px;
                  overflow-y: auto;
                  margin-bottom: 8px;
                  font-size: 13px;
                "
              >
                <p style="color: #999; text-align: center; margin: 10px 0">
                  æš‚æ— æ­Œæ›²
                </p>
              </div>
              <div style="display: flex; gap: 5px">
                <button
                  id="pomo-add-bgm-local"
                  class="form-button-secondary"
                  style="margin: 0; padding: 5px 10px; font-size: 12px"
                >
                  + æœ¬åœ°
                </button>
                <button
                  id="pomo-add-bgm-url"
                  class="form-button-secondary"
                  style="margin: 0; padding: 5px 10px; font-size: 12px"
                >
                  + URL
                </button>
                <button
                  id="pomo-clear-bgm"
                  class="form-button-secondary"
                  style="
                    margin: 0;
                    padding: 5px 10px;
                    font-size: 12px;
                    color: #ff3b30;
                    border-color: #ff3b30;
                  "
                >
                  æ¸…ç©º
                </button>
              </div>
              <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
              <input
                type="file"
                id="pomo-bgm-file-input"
                accept="audio/*"
                multiple
                style="display: none"
              />
            </div>
          </div>

          <div class="form-group">
            <label>è‡ªå®šä¹‰èƒŒæ™¯ (å¯é€‰)</label>
            <div style="display: flex; gap: 10px; align-items: center">
              <input
                type="text"
                id="pomodoro-bg-url-input"
                placeholder="ç²˜è´´å›¾ç‰‡URL"
                style="flex-grow: 1"
              />
              <button
                id="pomodoro-bg-local-upload-btn"
                class="form-button-secondary"
                style="margin: 0; padding: 12px; width: auto"
              >
                æœ¬åœ°ä¸Šä¼ 
              </button>
            </div>
            <input
              type="file"
              id="pomodoro-bg-file-input"
              accept="image/*"
              hidden
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="pomodoro-cancel-setup-btn">å–æ¶ˆ</button>
          <button class="save" id="pomodoro-confirm-setup-btn">å¼€å§‹ä¸“æ³¨</button>
        </div>
      </div>
    </div>

    <!-- æƒ…ä¾£ç•ªèŒ„é’Ÿ-å†å²è¯¦æƒ…å¼¹çª— -->
    <div id="ls-pomodoro-history-viewer-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="pomodoro-history-viewer-title">ä¸“æ³¨è®°å½•</span>
        </div>
        <div class="modal-body" id="pomodoro-history-viewer-content">
          <!-- èŠå¤©è®°å½•ä¼šç”±JSç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="pomodoro-close-history-viewer-btn"
            style="width: 100%"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- 1. å°ç»„ç¼–è¾‘å™¨å¼¹çª— (ç”¨äºä¿®æ”¹å°ç»„ä¿¡æ¯å’Œä¸–ç•Œè§‚) -->
    <div id="forum-group-editor-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>ç¼–è¾‘å°ç»„ä¿¡æ¯</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="group-editor-name-input">å°ç»„åç§°</label>
            <input type="text" id="group-editor-name-input" />
          </div>
          <div class="form-group">
            <label for="group-editor-desc-input">å°ç»„ç®€ä»‹</label>
            <input type="text" id="group-editor-desc-input" />
          </div>
          <div class="form-group">
            <label for="group-editor-icon-input">å°ç»„å›¾æ ‡ (Emoji)</label>
            <input type="text" id="group-editor-icon-input" />
          </div>
          <div class="form-group">
            <label for="group-editor-categories-input"
              >å°ç»„åˆ†ç±» (ç”¨#å·åˆ†éš”, ä¾‹å¦‚: #ç§‘å¹» #æœªæ¥)</label
            >
            <input
              type="text"
              id="group-editor-categories-input"
              placeholder="ä¾‹å¦‚: #ç§‘å¹» #æœªæ¥"
            />
          </div>
          <div class="form-group">
            <label for="group-editor-worldview-input"
              >å°ç»„ä¸–ç•Œè§‚ (ä¾›AIç”Ÿæˆå†…å®¹æ—¶å‚è€ƒ)</label
            >
            <textarea
              id="group-editor-worldview-input"
              rows="5"
              placeholder="è¯¦ç»†æè¿°è¿™ä¸ªå°ç»„ç‹¬ç‰¹çš„èƒŒæ™¯è®¾å®š..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-group-editor-btn">å–æ¶ˆ</button>
          <button class="save" id="save-group-editor-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- 2. åˆ†ç±»ç®¡ç†å¼¹çª— -->
    <div id="forum-category-manager-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>ç®¡ç†åœˆå­åˆ†ç±»</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>æ–°å»ºåˆ†ç±»</label>
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                id="new-forum-category-name-input"
                placeholder="è¾“å…¥åˆ†ç±»åï¼Œæ— éœ€å¸¦'#'..."
                style="flex-grow: 1"
              />
              <button
                id="add-new-forum-category-btn"
                class="form-button"
                style="width: auto; margin-top: 0; padding: 0 15px"
              >
                æ·»åŠ 
              </button>
            </div>
          </div>
          <hr style="opacity: 0.2" />
          <div
            id="existing-forum-categories-list"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <!-- åˆ†ç±»åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-forum-category-manager-btn"
            style="width: 100%"
          >
            å®Œæˆ
          </button>
        </div>
      </div>
    </div>

    <div id="aurora-setup-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>æ¼«æ¸¸å…±èµ</span>
          <span
            id="open-aurora-bookshelf-btn"
            class="action-btn"
            style="font-size: 14px"
            >ğŸ“š ä¹¦æ¶</span
          >
        </div>
        <div class="modal-body">
          <!-- 1. åå­—è¾“å…¥ -->
          <div class="form-group">
            <label for="aurora-title-input">æ¼«æ¸¸ä¸»é¢˜ / ä½œå“åç§°</label>
            <input
              type="text"
              id="aurora-title-input"
              placeholder="ä¾‹å¦‚ï¼šé›¨å¤œè°ˆå¿ƒã€æ³°å¦å°¼å…‹å·..."
            />
          </div>

          <!-- 2. ç±»å‹é€‰æ‹© -->
          <div class="form-group">
            <label>æ¨¡å¼é€‰æ‹©</label>
            <div style="display: flex; gap: 15px; flex-wrap: wrap">
              <label
                ><input type="radio" name="aurora-mode" value="video" checked />
                çœ‹è§†é¢‘</label
              >
              <label
                ><input type="radio" name="aurora-mode" value="text" />
                è¯»å°è¯´</label
              >
              <!-- æ–°å¢è‡ªå®šä¹‰é€‰é¡¹ -->
              <label
                ><input type="radio" name="aurora-mode" value="custom" />
                è‡ªå®šä¹‰(éŸ³ç”»)</label
              >
            </div>
          </div>

          <!-- 3. è§†é¢‘æ¨¡å¼è¾“å…¥åŒº -->
          <div id="aurora-video-inputs" class="aurora-input-group">
            <div class="form-group">
              <label>è§†é¢‘æ–‡ä»¶ (mp4, webm)</label>
              <input type="file" id="aurora-video-file" accept="video/*,.mkv" />
            </div>
            <div class="form-group">
              <label>å­—å¹•æ–‡ä»¶ (å¯é€‰ .srt, .vtt)</label>
              <input
                type="file"
                id="aurora-sub-file-video"
                accept=".srt,.vtt,.lrc"
              />
              <!-- â˜…â˜…â˜… æ–°å¢ï¼šå­—å¹•URLè¾“å…¥æ¡† â˜…â˜…â˜… -->
              <input
                type="text"
                id="aurora-sub-url-video"
                placeholder="æˆ–ç²˜è´´å­—å¹•é“¾æ¥ (SRT/VTT/LRC)"
                style="margin-top: 5px"
              />
            </div>
          </div>

          <div
            id="aurora-text-inputs"
            class="aurora-input-group"
            style="display: none"
          >
            <div class="form-group">
              <label>å°è¯´/æ–‡æœ¬æ–‡ä»¶ (.txt)</label>
              <input type="file" id="aurora-text-file" accept=".txt" />
              <!-- â˜…â˜…â˜… æ–°å¢ï¼šå°è¯´URLè¾“å…¥æ¡† â˜…â˜…â˜… -->
              <input
                type="text"
                id="aurora-text-url"
                placeholder="æˆ–ç²˜è´´txtæ–‡ä»¶é“¾æ¥"
                style="margin-top: 5px"
              />
            </div>
          </div>

          <!-- 5. è‡ªå®šä¹‰æ¨¡å¼è¾“å…¥åŒº -->
          <div
            id="aurora-custom-inputs"
            class="aurora-input-group"
            style="display: none"
          >
            <div class="form-group">
              <label>èƒŒæ™¯å›¾ç‰‡ (jpg, png, gif)</label>
              <input type="file" id="aurora-custom-img" accept="image/*" />
            </div>
            <div class="form-group">
              <label>éŸ³é¢‘æ–‡ä»¶ (mp3, wav, m4a)</label>
              <input type="file" id="aurora-custom-audio" accept="audio/*" />
            </div>
            <div class="form-group">
              <label>å­—å¹•æ–‡ä»¶ (å¯é€‰ .srt, .vtt)</label>
              <input
                type="file"
                id="aurora-sub-file-custom"
                accept=".srt,.vtt,.lrc"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-aurora-setup">å–æ¶ˆ</button>
          <button class="save" id="confirm-aurora-setup">å¼€å§‹æ¼«æ¸¸</button>
        </div>
      </div>
    </div>

    <!-- æ¼«æ¸¸æ’­æ”¾å™¨å¼¹çª— (å·²ä¿®å¤å…³é—­æŒ‰é’®æ¶ˆå¤±é—®é¢˜) -->
    <div
      id="aurora-player-overlay"
      style="
        display: none;
        position: absolute;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        width: 320px;
        height: 400px;
        background: #000;
        border-radius: 12px;
        z-index: 9999;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        flex-direction: column;
        overflow: hidden;
      "
    >
      <!-- é¡¶éƒ¨æ‹–æ‹½æ¡ -->
      <div
        id="aurora-drag-handle"
        style="
          width: 100%;
          height: 40px;
          flex-shrink: 0;
          padding: 0 10px;
          background: linear-gradient(90deg, #e0c3fc 0%, #8ec5fc 100%);
          cursor: grab;
          display: flex;
          align-items: center;
          justify-content: space-between;
          z-index: 100;
          box-sizing: border-box; /* â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢å†…å®¹è¢«æŒ¤å‡ºå®¹å™¨ â˜…â˜…â˜… */
        "
      >
        <span
          style="
            font-size: 14px;
            color: #333;
            font-weight: 800;
            pointer-events: none;
          "
          >âœ¨ æ¼«æ¸¸</span
        >

        <!-- å­—å·è°ƒæ•´ä¸å…³é—­æŒ‰é’®ç»„ -->
        <div style="display: flex; gap: 10px; align-items: center">
          <button
            id="aurora-font-down"
            style="
              background: rgba(255, 255, 255, 0.4);
              border: 1px solid rgba(0, 0, 0, 0.1);
              border-radius: 4px;
              padding: 2px 8px;
              font-weight: bold;
              cursor: pointer;
              color: #333;
              font-size: 12px;
            "
          >
            A-
          </button>
          <button
            id="aurora-font-up"
            style="
              background: rgba(255, 255, 255, 0.4);
              border: 1px solid rgba(0, 0, 0, 0.1);
              border-radius: 4px;
              padding: 2px 8px;
              font-weight: bold;
              cursor: pointer;
              color: #333;
              font-size: 12px;
            "
          >
            A+
          </button>
          <!-- å…³é—­æŒ‰é’®ï¼šåŠ å¤§å­—å·ï¼Œå¢åŠ ç‚¹å‡»åŒºåŸŸ -->
          <span
            id="aurora-close-player"
            style="
              cursor: pointer;
              font-weight: 900;
              color: #333;
              font-size: 24px;
              line-height: 1;
              padding: 0 5px;
            "
            >Ã—</span
          >
        </div>
      </div>

      <!-- å†…å®¹åŒº -->
      <div
        id="aurora-content-area"
        style="
          width: 100%;
          flex-grow: 1;
          position: relative;
          background: #000;
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
        "
      >
        <!-- è§†é¢‘æ’­æ”¾å™¨ -->
        <video
          id="aurora-video-element"
          style="width: 100%; height: 100%; object-fit: contain; display: none"
          playsinline
          webkit-playsinline
        ></video>

        <!-- æ–‡æœ¬é˜…è¯»å™¨ -->
        <div
          id="aurora-text-viewer"
          style="
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 15px;
            box-sizing: border-box;
            font-size: 16px;
            line-height: 1.8;
            color: #e0e0e0;
            font-family: sans-serif;
          "
        >
          <div id="aurora-text-body" style="white-space: pre-wrap"></div>
        </div>

        <!-- è‡ªå®šä¹‰éŸ³ç”»æ’­æ”¾å™¨ -->
        <div
          id="aurora-custom-viewer"
          style="display: none; width: 100%; height: 100%; position: relative"
        >
          <img
            id="aurora-custom-bg-img"
            style="width: 100%; height: 100%; display: block; object-fit: cover"
          />
          <div
            id="aurora-custom-subtitle-display"
            style="
              position: absolute;
              bottom: 10%;
              left: 0;
              width: 100%;
              text-align: center;
              color: white;
              text-shadow:
                0 2px 4px black,
                0 0 4px black;
              font-size: 16px;
              padding: 0 10px;
              pointer-events: none;
              font-weight: 500;
              z-index: 20;
            "
          ></div>
          <audio
            id="aurora-custom-audio-element"
            controls
            style="
              width: 100%;
              height: 40px;
              opacity: 0;
              position: absolute;
              bottom: 0;
              left: 0;
              z-index: 30;
            "
          ></audio>
        </div>
      </div>

      <!-- åº•éƒ¨æ  -->
      <div
        style="
          padding: 5px 12px;
          height: 28px;
          flex-shrink: 0;
          font-size: 12px;
          color: #888;
          background: #121212;
          border-top: 1px solid #333;
          display: flex;
          align-items: center;
          justify-content: space-between;
        "
      >
        <span
          id="aurora-playing-title"
          style="
            max-width: 50%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
          "
          >æœªæ’­æ”¾</span
        >
        <span
          id="aurora-save-book-btn"
          style="
            cursor: pointer;
            display: none;
            color: #d4af37;
            font-weight: bold;
          "
          >ğŸ“¥ å­˜å…¥ä¹¦æ¶</span
        >
        <span id="aurora-info-status">ç­‰å¾…ä¸­...</span>
      </div>

      <!-- æ‰‹æœºç«¯è§¦æ‘¸ç¼©æ”¾æ‰‹æŸ„ -->
      <div
        id="aurora-resize-handle"
        style="
          position: absolute;
          bottom: 0;
          right: 0;
          width: 30px;
          height: 30px;
          background: linear-gradient(135deg, transparent 50%, #8ec5fc 50%);
          cursor: nwse-resize;
          z-index: 101;
          touch-action: none;
        "
      ></div>
    </div>

    <!-- å¤å¤ä¹¦æ¶ç•Œé¢ -->
    <div id="aurora-bookshelf-screen" class="screen">
      <div
        class="header"
        style="
          background-color: #3e2723 !important;
          color: #e0c097 !important;
          border-bottom: 1px solid #5d4037;
        "
      >
        <span class="back-btn" id="back-from-bookshelf" style="color: #e0c097"
          >â€¹</span
        >
        <span
          style="
            font-family: &quot;serif&quot;;
            font-weight: bold;
            letter-spacing: 2px;
          "
          >è—ä¹¦é˜</span
        >
        <span style="width: 30px"></span>
      </div>
      <!-- ä¹¦æ¶èƒŒæ™¯å®¹å™¨ -->
      <div id="bookshelf-container">
        <!-- ä¹¦ç±å°†ç”±JSç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <div id="game-hall-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>æ¸¸æˆå¤§å…</span>
        <span style="width: 30px"></span>
        <!-- å ä½ç¬¦ -->
      </div>
      <div class="list-container" style="padding: 20px">
        <p style="text-align: center; color: var(--text-secondary)">
          é€‰æ‹©ä¸€ä¸ªæ¸¸æˆå¼€å§‹å§ï¼
        </p>
        <div id="game-hall-grid">
          <!-- æ¸¸æˆåˆ—è¡¨å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
          <div class="game-card" data-game="werewolf">
            <div class="game-icon">ğŸº</div>
            <div class="game-info">
              <div class="game-title">ç‹¼äººæ€</div>
              <div class="game-desc">é€»è¾‘ä¸è°è¨€çš„å¯¹å†³</div>
            </div>
          </div>
          <div class="game-card" data-game="sea-turtle-soup">
            <div class="game-icon">ğŸ¢</div>
            <div class="game-info">
              <div class="game-title">æµ·é¾Ÿæ±¤</div>
              <div class="game-desc">æ­å¼€æƒ…æ™¯çš„çœŸç›¸</div>
            </div>
          </div>
          <div class="game-card" data-game="script-kill">
            <div class="game-icon">ğŸ“œ</div>
            <div class="game-info">
              <div class="game-title">å‰§æœ¬æ€</div>
              <div class="game-desc">æ‰®æ¼”è§’è‰²ï¼Œæ¢å¯»è°œæ¡ˆ</div>
            </div>
          </div>
          <div class="game-card" data-game="guess-what">
            <div class="game-icon">ğŸ—£ï¸</div>
            <div class="game-info">
              <div class="game-title">ä½ è¯´æˆ‘çŒœ</div>
              <div class="game-desc">è€ƒéªŒé»˜å¥‘çš„æ—¶å€™åˆ°äº†</div>
            </div>
          </div>
          <div class="game-card" data-game="ludo">
            <div class="game-icon">ğŸ²</div>
            <div class="game-info">
              <div class="game-title">å¿ƒåŠ¨é£è¡Œæ£‹</div>
              <div class="game-desc">å’ŒTaæ¥ä¸€åœºåªå±äºä½ ä»¬çš„å†’é™©</div>
            </div>
          </div>

          <div class="game-card" data-game="undercover">
            <div class="game-icon">ğŸ•µï¸</div>
            <div class="game-info">
              <div class="game-title">è°æ˜¯å§åº•</div>
              <div class="game-desc">è¯­è¨€çš„ä¼ªè£…ï¼Œé€»è¾‘çš„é™·é˜±</div>
            </div>
          </div>

          <p
            style="
              grid-column: 1 / -1;
              text-align: center;
              color: var(--text-secondary);
              font-size: 14px;
              margin-top: 20px;
            "
          >
            æ›´å¤šæ¸¸æˆæ­£åœ¨ç«é€Ÿå¼€å‘ä¸­...
          </p>
        </div>
      </div>
    </div>

    <!-- 1. ç‹¼äººæ€æ¸¸æˆè®¾ç½®å±å¹• -->
    <div id="werewolf-setup-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>ç‹¼äººæ€ - æ¸¸æˆè®¾ç½®</span>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label for="werewolf-player-count">é€‰æ‹©æ¸¸æˆäººæ•°</label>
          <select id="werewolf-player-count">
            <option value="6">6äººå±€ (2ç‹¼, 2æ°‘, é¢„è¨€å®¶, å®ˆå«)</option>
            <option value="9">9äººå±€ (3ç‹¼, 3æ°‘, é¢„è¨€å®¶, å¥³å·«, çŒäºº)</option>
            <option value="12">
              12äººå±€ (4ç‹¼, 4æ°‘, é¢„è¨€å®¶, å¥³å·«, çŒäºº, ç™½ç—´)
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>é‚€è¯·ç©å®¶ (ä½ å·²è‡ªåŠ¨åŠ å…¥)</label>
          <div
            id="werewolf-player-selection"
            class="list-container"
            style="
              height: 300px;
              border: 1px solid var(--border-color);
              border-radius: 8px;
            "
          >
            <!-- ç©å®¶é€‰æ‹©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <button id="start-werewolf-game-btn" class="form-button">
          å¼€å§‹æ¸¸æˆ
        </button>
      </div>
    </div>

    <!-- 2. ç‹¼äººæ€æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="werewolf-game-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-werewolf-game-btn">â€¹ é€€å‡º</span>
        <span id="werewolf-game-title">ç‹¼äººæ€</span>
        <span class="action-btn" id="werewolf-my-role-btn">æˆ‘çš„èº«ä»½</span>
      </div>
      <!-- æ¸¸æˆä¸»å†…å®¹åŒº -->
      <div id="werewolf-game-content">
        <!-- ç©å®¶åº§ä½åŒº -->
        <div id="werewolf-players-grid">
          <!-- ç©å®¶å¤´åƒå’ŒçŠ¶æ€å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <!-- æ¸¸æˆæ—¥å¿—/ä¿¡æ¯åŒº -->
        <div id="werewolf-log-container">
          <div id="werewolf-game-log">
            <!-- æ¸¸æˆè¿‡ç¨‹ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
          </div>
        </div>
        <!-- ç©å®¶æ“ä½œåŒº -->
        <div id="werewolf-action-area">
          <!-- ç©å®¶çš„æŒ‰é’®ä¼šæ ¹æ®æ¸¸æˆé˜¶æ®µæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
      </div>
    </div>

    <!-- ç‹¼äººæ€æ¸¸æˆç»“ç®—å¡ç‰‡ -->
    <div id="werewolf-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div
          class="modal-body"
          id="werewolf-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="repost-summary-btn">å‘é€å¤ç›˜åˆ°èŠå¤©</button>
          <button class="save" id="back-to-hall-btn">è¿”å›å¤§å…</button>
        </div>
      </div>
    </div>

    <!-- ç‹¼äººæ€å¤ç›˜å‘é€ç›®æ ‡é€‰æ‹©å™¨ -->
    <div id="werewolf-target-picker-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>é€‰æ‹©è¦å‘é€çš„ç©å®¶</span>
        </div>
        <div class="modal-body" id="werewolf-target-list" style="padding: 0">
          <!-- ç©å®¶åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button
            id="wt-select-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            å…¨é€‰
          </button>
          <button
            id="wt-deselect-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            å…¨ä¸é€‰
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="wt-cancel-btn">å–æ¶ˆ</button>
          <button class="save" id="wt-confirm-btn">ç¡®è®¤å‘é€</button>
        </div>
      </div>
    </div>

    <!-- 1. æµ·é¾Ÿæ±¤æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="sea-turtle-soup-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-sts-game-btn">â€¹ é€€å‡º</span>
        <span>æµ·é¾Ÿæ±¤</span>
        <span class="action-btn" id="reveal-sts-answer-btn">æ­æ™“ç­”æ¡ˆ</span>
      </div>
      <div
        id="sts-game-content"
        style="
          display: flex;
          flex-direction: column;
          height: 100%;
          overflow: hidden;
          padding: 10px;
          box-sizing: border-box;
        "
      >
        <!-- ç©å®¶åº§ä½åŒº -->
        <div
          id="sts-players-grid"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
            padding: 10px;
            flex-shrink: 0;
          "
        >
          <!-- ç©å®¶å¤´åƒå’ŒçŠ¶æ€å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <!-- æ¸¸æˆæ—¥å¿—/ä¿¡æ¯åŒº -->
        <div
          id="sts-log-container"
          style="
            flex-grow: 1;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            margin: 10px 0;
            min-height: 0;
          "
        >
          <div id="sts-game-log">
            <!-- æ¸¸æˆè¿‡ç¨‹ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
          </div>
        </div>

        <div
          id="sts-action-area"
          class="chat-input-area"
          style="visibility: visible"
        >
          <div class="chat-input-main-row">
            <textarea
              id="sts-question-input"
              rows="1"
              placeholder="è¾“å…¥é—®é¢˜æˆ–ç­”æ¡ˆ..."
            ></textarea>
            <!-- æ–°å¢â€œçŒœç­”æ¡ˆâ€æŒ‰é’® -->
            <button
              id="guess-sts-answer-btn"
              class="action-button"
              style="background-color: #ff9800"
            >
              çŒœç­”æ¡ˆ
            </button>
            <button id="send-sts-question-btn" class="action-button">
              æé—®
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. æµ·é¾Ÿæ±¤æ¸¸æˆè®¾ç½®æ¨¡æ€æ¡† -->
    <div id="sea-turtle-soup-setup-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 85%">
        <div class="modal-header">
          <span>æµ·é¾Ÿæ±¤ - æ¸¸æˆè®¾ç½®</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>é‚€è¯·ç©å®¶ (ä½ å·²è‡ªåŠ¨åŠ å…¥)</label>
            <div
              id="sts-player-selection"
              class="list-container"
              style="
                height: 200px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
              "
            >
              <!-- ç©å®¶é€‰æ‹©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
          <div class="form-group">
            <label>è°æ¥å‡ºé¢˜ï¼Ÿ</label>
            <select id="sts-riddle-provider-select">
              <option value="user">æˆ‘æ¥å‡ºé¢˜</option>
              <option value="random_ai">éšæœºä¸€ä½AI</option>
            </select>
          </div>
          <!-- ç”¨æˆ·å‡ºé¢˜çš„è¾“å…¥åŒº (é»˜è®¤éšè—) -->
          <div id="sts-user-riddle-input-area" style="display: none">
            <div class="form-group">
              <label for="sts-user-riddle-surface">è°œé¢</label>
              <textarea
                id="sts-user-riddle-surface"
                rows="2"
                placeholder="ä¾‹å¦‚ï¼šä¸€ä¸ªç”·äººèµ°è¿›é…’å§ï¼Œè¦äº†ä¸€æ¯æ°´..."
              ></textarea>
            </div>
            <div class="form-group">
              <label for="sts-user-riddle-answer">è°œåº• (å®Œæ•´æ•…äº‹)</label>
              <textarea
                id="sts-user-riddle-answer"
                rows="4"
                placeholder="ä¾‹å¦‚ï¼šç”·äººåœ¨æ‰“å—ï¼Œä»–æƒ³å–æ°´æ­¢å—..."
              ></textarea>
            </div>
          </div>
          <!-- AIå‡ºé¢˜çš„è¾“å…¥åŒº (é»˜è®¤éšè—) -->
          <div id="sts-ai-riddle-input-area" style="display: none">
            <div class="form-group">
              <label for="sts-ai-riddle-type">è°œé¢˜ç±»å‹ (å¯é€‰)</label>
              <input
                type="text"
                id="sts-ai-riddle-type"
                placeholder="ä¾‹å¦‚ï¼šææ€–ã€æ¸©æƒ…ã€è„‘æ´ã€ç»å…¸"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-sts-setup-btn">å–æ¶ˆ</button>
          <button class="save" id="start-sts-game-btn">å¼€å§‹æ¸¸æˆ</button>
        </div>
      </div>
    </div>

    <!-- 1. æµ·é¾Ÿæ±¤æ¸¸æˆç»“ç®—å¡ç‰‡ -->
    <div id="sts-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div
          class="modal-body"
          id="sts-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="share-sts-summary-btn">åˆ†äº«å¤ç›˜</button>
          <button class="save" id="back-to-hall-from-sts-btn">è¿”å›å¤§å…</button>
        </div>
      </div>
    </div>

    <!-- 2. æµ·é¾Ÿæ±¤å¤ç›˜å‘é€ç›®æ ‡é€‰æ‹©å™¨ -->
    <div id="sts-share-target-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>é€‰æ‹©è¦åˆ†äº«çš„ç©å®¶</span>
        </div>
        <div class="modal-body" id="sts-share-target-list" style="padding: 0">
          <!-- ç©å®¶åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button
            id="sts-select-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            å…¨é€‰
          </button>
          <button
            id="sts-deselect-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            å…¨ä¸é€‰
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="sts-cancel-share-btn">å–æ¶ˆ</button>
          <button class="save" id="sts-confirm-share-btn">ç¡®è®¤åˆ†äº«</button>
        </div>
      </div>
    </div>

    <!-- 1. å‰§æœ¬æ€æ¸¸æˆè®¾ç½®å±å¹• -->
    <div id="script-kill-setup-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>å‰§æœ¬æ€ - æ¸¸æˆè®¾ç½®</span>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label>é€‰æ‹©å‰§æœ¬</label>
          <div style="display: flex; gap: 10px">
            <select
              id="script-kill-script-select"
              style="flex-grow: 1"
            ></select>
            <button
              id="manage-custom-scripts-btn"
              class="form-button-secondary"
              style="margin-top: 0; padding: 0 15px"
            >
              ç®¡ç†
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>é‚€è¯·ç©å®¶ (ä½ å·²è‡ªåŠ¨åŠ å…¥)</label>
          <div
            id="script-kill-player-selection"
            class="list-container"
            style="
              height: 300px;
              border: 1px solid var(--border-color);
              border-radius: 8px;
            "
          >
            <!-- ç©å®¶é€‰æ‹©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="form-group">
          <label class="toggle-switch-label">
            <span class="toggle-switch-text"
              >è‡ªç”±é€‰æ‹©è§’è‰² (å…³é—­åˆ™éšæœºåˆ†é…)</span
            >
            <input type="checkbox" id="script-kill-free-choice-toggle" />
            <span class="toggle-switch-slider"></span>
          </label>
        </div>
        <button id="start-script-kill-game-btn" class="form-button">
          å¼€å§‹æ¸¸æˆ
        </button>
      </div>
    </div>

    <!-- 2. å‰§æœ¬æ€æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="script-kill-game-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-script-kill-game-btn">â€¹ é€€å‡º</span>
        <span id="script-kill-game-title">å‰§æœ¬æ€</span>
        <div class="header-actions">
          <span class="action-btn" id="script-kill-my-role-btn">æˆ‘çš„è§’è‰²</span>
          <span class="action-btn" id="script-kill-all-evidence-btn"
            >å…¬å…±çº¿ç´¢</span
          >
        </div>
      </div>
      <div id="script-kill-game-content">
        <div id="script-kill-players-grid">
          <!-- ç©å®¶å¤´åƒå’ŒçŠ¶æ€å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div id="script-kill-log-container">
          <div id="script-kill-game-log">
            <!-- æ¸¸æˆè¿‡ç¨‹ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
          </div>
        </div>
        <div id="script-kill-action-area">
          <!-- ç©å®¶çš„æŒ‰é’®ä¼šæ ¹æ®æ¸¸æˆé˜¶æ®µæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
      </div>
    </div>

    <!-- å‰§æœ¬æ€è‡ªå®šä¹‰å‰§æœ¬ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="script-kill-manager-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>ç®¡ç†è‡ªå®šä¹‰å‰§æœ¬</span>
          <div class="header-actions">
            <button
              id="import-script-btn"
              class="action-button"
              style="font-size: 14px"
            >
              å¯¼å…¥
            </button>

            <button
              id="open-sk-ai-generator-btn"
              class="action-button"
              style="font-size: 14px"
            >
              AIç”Ÿæˆ
            </button>

            <button id="add-new-script-btn" class="action-button">æ·»åŠ </button>
          </div>
        </div>

        <div class="modal-body" id="custom-scripts-list" style="padding: 0">
          <!-- è‡ªå®šä¹‰å‰§æœ¬åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-script-manager-btn"
            style="width: 100%"
          >
            å®Œæˆ
          </button>
        </div>
      </div>
    </div>

    <!-- 1. å‰§æœ¬ç¼–è¾‘å™¨ä¸»å¼¹çª— (å¯è§†åŒ–ç‰ˆ) -->
    <div id="script-kill-editor-modal" class="modal">
      <div class="modal-content" style="height: 90%">
        <div class="modal-header">
          <span id="script-editor-title">å‰§æœ¬ç¼–è¾‘å™¨</span>
        </div>
        <div
          class="modal-body"
          style="display: flex; flex-direction: column; gap: 15px"
        >
          <!-- åŸºç¡€ä¿¡æ¯ -->
          <div class="form-group">
            <label for="script-name-input">å‰§æœ¬åç§°</label>
            <input type="text" id="script-name-input" />
          </div>
          <div class="form-group">
            <label for="script-background-input">æ•…äº‹èƒŒæ™¯</label>
            <textarea id="script-background-input" rows="3"></textarea>
          </div>

          <hr style="opacity: 0.2" />

          <!-- è§’è‰²è®¾å®šåŒº -->
          <div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              "
            >
              <label style="margin: 0; font-weight: 600">è§’è‰²è®¾å®š</label>
              <button
                id="sk-add-role-btn"
                class="form-button-secondary"
                style="margin: 0; padding: 5px 15px"
              >
                + æ·»åŠ è§’è‰²
              </button>
            </div>
            <div id="sk-roles-container" class="sk-item-container">
              <!-- è§’è‰²å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
          </div>

          <!-- çº¿ç´¢å¡åŒº -->
          <div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              "
            >
              <label style="margin: 0; font-weight: 600">çº¿ç´¢å¡</label>
              <button
                id="sk-add-clue-btn"
                class="form-button-secondary"
                style="margin: 0; padding: 5px 15px"
              >
                + æ·»åŠ çº¿ç´¢
              </button>
            </div>
            <div id="sk-clues-container" class="sk-item-container">
              <!-- çº¿ç´¢å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
          </div>

          <!-- æœ€ç»ˆçœŸç›¸äº’åŠ¨ -->
          <div class="form-group">
            <label for="sk-truth-input">æœ€ç»ˆçœŸç›¸</label>
            <textarea id="sk-truth-input" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-script-editor-btn">å–æ¶ˆ</button>
          <button class="save" id="save-script-btn">ä¿å­˜å‰§æœ¬</button>
        </div>
      </div>
    </div>

    <!-- 2. ç”¨äºç¼–è¾‘å•ä¸ªè§’è‰²/çº¿ç´¢çš„å­å¼¹çª— -->
    <div id="sk-item-editor-modal" class="modal" style="z-index: 1003">
      <div class="modal-content" style="height: auto; max-height: 85%">
        <div class="modal-header">
          <span id="sk-item-editor-title"></span>
        </div>
        <div class="modal-body">
          <!-- è§’è‰²ç¼–è¾‘å­—æ®µ (é»˜è®¤éšè—) -->
          <div id="sk-role-editor-fields" style="display: none">
            <div class="form-group">
              <label for="sk-role-name-input">è§’è‰²åç§°</label>
              <input type="text" id="sk-role-name-input" />
            </div>
            <div class="form-group">
              <label for="sk-role-desc-input">è§’è‰²ä»‹ç»</label>
              <textarea id="sk-role-desc-input" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label for="sk-role-storyline-input"
                >æ•…äº‹çº¿ (æ¡ˆå‘æ—¶é—´æ®µçš„è¯¦ç»†è¡ŒåŠ¨è½¨è¿¹)</label
              >
              <textarea id="sk-role-storyline-input" rows="5"></textarea>
            </div>
            <div class="form-group">
              <label for="sk-role-tasks-input">ç§˜å¯†ä»»åŠ¡</label>
              <textarea id="sk-role-tasks-input" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">æ˜¯å‡¶æ‰‹</span>
                <input type="checkbox" id="sk-role-killer-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
            </div>
          </div>
          <!-- çº¿ç´¢ç¼–è¾‘å­—æ®µ (é»˜è®¤éšè—) -->
          <div id="sk-clue-editor-fields" style="display: none">
            <div class="form-group">
              <label for="sk-clue-owner-select">çº¿ç´¢å½’å±</label>
              <select id="sk-clue-owner-select">
                <!-- é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
              </select>
            </div>
            <div class="form-group">
              <label for="sk-clue-desc-input">çº¿ç´¢æè¿°</label>
              <textarea id="sk-clue-desc-input" rows="4"></textarea>
            </div>
            <div class="form-group">
              <label class="toggle-switch-label">
                <span class="toggle-switch-text">æ˜¯å…³é”®çº¿ç´¢</span>
                <input type="checkbox" id="sk-clue-key-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="sk-item-editor-cancel-btn">å–æ¶ˆ</button>
          <button class="save" id="sk-item-editor-save-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- 4. è§’è‰²èº«ä»½å¡æ¨¡æ€æ¡† -->
    <div id="script-kill-role-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="sk-role-name">ä½ çš„è§’è‰²</span>
        </div>
        <div
          class="modal-body"
          id="sk-role-details"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- è§’è‰²ä»‹ç»ã€ä»»åŠ¡ç­‰å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button class="save" id="close-sk-role-modal-btn" style="width: 100%">
            æˆ‘å·²äº†è§£
          </button>
        </div>
      </div>
    </div>

    <!-- 5. ä¸ªäººçº¿ç´¢æ¿æ¨¡æ€æ¡† -->
    <div id="script-kill-evidence-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>æˆ‘çš„çº¿ç´¢æ¿</span>
        </div>
        <div
          class="modal-body"
          id="sk-evidence-list"
          style="
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
          "
        >
          <!-- æœåˆ°çš„çº¿ç´¢å¡ç‰‡ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-sk-evidence-modal-btn"
            style="width: 100%"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- 6. æŠ•ç¥¨æ¨¡æ€æ¡† -->
    <div id="script-kill-vote-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 70%">
        <div class="modal-header">
          <span id="sk-vote-title">æœ€ç»ˆæŠ•ç¥¨</span>
        </div>
        <div
          class="modal-body"
          id="sk-vote-options-list"
          style="text-align: left; padding: 20px"
        >
          <!-- æŠ•ç¥¨é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-sk-vote-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-sk-vote-btn">ç¡®è®¤æŠ•ç¥¨</button>
        </div>
      </div>
    </div>
    <!-- å‰§æœ¬æ€æ¸¸æˆç»“ç®—å¡ç‰‡ -->
    <div id="script-kill-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div
          class="modal-body"
          id="script-kill-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="repost-sk-summary-btn">
            è½¬å‘å¤ç›˜åˆ°å•èŠ
          </button>
          <button class="save" id="back-to-hall-from-sk-btn">è¿”å›å¤§å…</button>
        </div>
      </div>
    </div>

    <!-- å‰§æœ¬æ€å¤ç›˜å‘é€ç›®æ ‡é€‰æ‹©å™¨ -->
    <div id="script-kill-target-picker-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>é€‰æ‹©è¦è½¬å‘çš„ç©å®¶</span>
        </div>
        <div class="modal-body" id="script-kill-target-list" style="padding: 0">
          <!-- ç©å®¶åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button
            id="sk-select-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            å…¨é€‰
          </button>
          <button
            id="sk-deselect-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            å…¨ä¸é€‰
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="sk-cancel-share-btn">å–æ¶ˆ</button>
          <button class="save" id="sk-confirm-share-btn">ç¡®è®¤è½¬å‘</button>
        </div>
      </div>
    </div>

    <div id="sk-ai-generator-modal" class="modal">
      <div class="modal-content" style="height: 90%">
        <div class="modal-header">
          <span>AI å‰§æœ¬ç”Ÿæˆå™¨</span>
        </div>
        <div
          class="modal-body"
          style="display: flex; flex-direction: column; gap: 15px"
        >
          <div class="form-group">
            <label for="sk-ai-elements-input">æ ¸å¿ƒè¦ç´  (ç”¨é€—å·åˆ†éš”)</label>
            <input
              type="text"
              id="sk-ai-elements-input"
              placeholder="ä¾‹å¦‚ï¼šç°ä»£, è°‹æ€, æš´é£é›ªå±±åº„, é—äº§"
            />
          </div>

          <div class="form-group">
            <label for="sk-ai-player-count-input"
              >ç©å®¶äººæ•° (åŒ…å«å‡¶æ‰‹, å»ºè®®4-8äºº)</label
            >
            <input
              type="number"
              id="sk-ai-player-count-input"
              value="5"
              min="3"
              max="12"
              style="
                width: 100%;
                box-sizing: border-box;
                padding: 10px;
                border-radius: 6px;
                border: 1px solid var(--border-color);
              "
            />
          </div>

          <div class="form-group">
            <label for="sk-ai-summary-input">å‰§æƒ…æ¢—æ¦‚ (å¯é€‰)</label>
            <textarea
              id="sk-ai-summary-input"
              rows="4"
              placeholder="å¯ä»¥å†™ä¸€ä¸ªç®€å•çš„æ•…äº‹å¤§çº²ï¼Œå¸®åŠ©AIæ›´å¥½åœ°ç†è§£ä½ çš„æƒ³æ³•..."
            ></textarea>
          </div>
          <button id="sk-trigger-ai-generation-btn" class="form-button">
            å¼€å§‹ç”Ÿæˆ
          </button>

          <hr style="opacity: 0.2; margin: 5px 0" />

          <div
            class="form-group"
            style="
              flex-grow: 1;
              min-height: 0;
              display: flex;
              flex-direction: column;
            "
          >
            <label>AI ç”Ÿæˆç»“æœé¢„è§ˆ</label>
            <div
              id="sk-ai-result-preview"
              style="
                flex-grow: 1;
                overflow-y: auto;
                background: #f0f2f5;
                padding: 10px;
                border-radius: 8px;
                white-space: pre-wrap;
                line-height: 1.6;
                color: #555;
              "
            >
              ç‚¹å‡»â€œå¼€å§‹ç”Ÿæˆâ€åï¼Œç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="sk-ai-generator-cancel-btn">å…³é—­</button>
          <!-- è¿™ä¸ªä¿å­˜æŒ‰é’®åˆå§‹æ˜¯ç¦ç”¨çš„ï¼Œç”ŸæˆæˆåŠŸåæ‰ä¼šæ¿€æ´» -->
          <button class="save" id="sk-ai-generator-save-btn" disabled>
            ä¿å­˜å‰§æœ¬
          </button>
        </div>
      </div>
    </div>

    <!-- 1. â€œä½ è¯´æˆ‘çŒœâ€æ¸¸æˆè®¾ç½®å±å¹• -->
    <div id="guess-what-setup-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>ä½ è¯´æˆ‘çŒœ - æ¸¸æˆè®¾ç½®</span>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label>é‚€è¯·ä¸€ä½ç©ä¼´</label>
          <div
            id="guess-what-player-selection"
            class="list-container"
            style="
              height: 200px;
              border: 1px solid var(--border-color);
              border-radius: 8px;
            "
          >
            <!-- ç©å®¶é€‰æ‹©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="form-group">
          <label>é€‰æ‹©æ¸¸æˆæ¨¡å¼</label>
          <div style="display: flex; gap: 20px">
            <label
              ><input
                type="radio"
                name="guess_what_mode"
                value="ai_guesses"
                checked
              />
              æˆ‘å‡ºé¢˜ï¼ŒAIçŒœ</label
            >
            <label
              ><input
                type="radio"
                name="guess_what_mode"
                value="user_guesses"
              />
              AIå‡ºé¢˜ï¼Œæˆ‘çŒœ</label
            >
          </div>
        </div>
        <!-- "æˆ‘å‡ºé¢˜"æ¨¡å¼ä¸‹çš„è¾“å…¥æ¡† -->
        <div class="form-group" id="user-word-input-container">
          <label for="guess-what-user-word">è¯·è¾“å…¥ä½ è¦å‡ºçš„è¯</label>
          <input
            type="text"
            id="guess-what-user-word"
            placeholder="ä¾‹å¦‚ï¼šè‹¹æœã€æµæµªåœ°çƒ..."
          />
        </div>
        <button id="start-guess-what-game-btn" class="form-button">
          å¼€å§‹æ¸¸æˆ
        </button>
      </div>
    </div>

    <!-- 2. â€œä½ è¯´æˆ‘çŒœâ€æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="guess-what-game-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-guess-what-game-btn">â€¹ é€€å‡º</span>
        <span id="guess-what-game-title">ä½ è¯´æˆ‘çŒœ</span>
        <span class="action-btn" id="give-up-guess-what-btn">æ”¾å¼ƒ</span>
      </div>
      <!-- æ¸¸æˆä¸»å†…å®¹åŒº -->
      <div
        id="guess-what-game-content"
        style="
          display: flex;
          flex-direction: column;
          height: 100%;
          overflow: hidden;
          padding: 10px;
          box-sizing: border-box;
        "
      >
        <!-- æ¸¸æˆæ—¥å¿—/ä¿¡æ¯åŒº -->
        <div
          id="guess-what-log-container"
          style="
            flex-grow: 1;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            margin: 10px 0;
            min-height: 0;
          "
        >
          <div id="guess-what-game-log">
            <!-- æ¸¸æˆè¿‡ç¨‹ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
          </div>
        </div>
        <!-- ç©å®¶æ“ä½œåŒº -->
        <div
          id="guess-what-action-area"
          class="chat-input-area"
          style="visibility: visible"
        >
          <div class="chat-input-main-row">
            <textarea
              id="guess-what-user-input"
              rows="1"
              placeholder="è¾“å…¥æç¤ºæˆ–çŒœæµ‹..."
            ></textarea>
            <button id="send-guess-what-input-btn" class="action-button">
              å‘é€
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- â€œä½ è¯´æˆ‘çŒœâ€æ¸¸æˆç»“ç®—å¡ç‰‡ -->
    <div id="guess-what-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div
          class="modal-body"
          id="guess-what-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="forward-guess-what-summary-btn">
            è½¬å‘ç»™Ta
          </button>
          <button class="save" id="close-guess-what-summary-btn">
            è¿”å›å¤§å…
          </button>
        </div>
      </div>
    </div>

    <!-- 1. é£è¡Œæ£‹æ¸¸æˆè®¾ç½®å±å¹• -->
    <div id="ludo-setup-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>å¿ƒåŠ¨é£è¡Œæ£‹ - æ¸¸æˆè®¾ç½®</span>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label>é€‰æ‹©ä¸€ä½ç©ä¼´</label>
          <!-- é‚€è¯·åˆ—è¡¨ï¼Œæˆ‘ä»¬ä¼šç”¨JSæ¥å¡«å…… -->
          <div
            id="ludo-player-selection"
            class="list-container"
            style="
              height: 200px;
              border: 1px solid var(--border-color);
              border-radius: 8px;
            "
          ></div>
        </div>

        <div class="form-group">
          <label>é€‰æ‹©é—®é¢˜åº“</label>
          <div style="display: flex; align-items: center; gap: 10px">
            <select
              id="ludo-question-bank-select"
              style="flex-grow: 1"
            ></select>
            <button
              id="manage-ludo-question-banks-btn"
              class="form-button-secondary"
              style="margin-top: 0; padding: 12px; width: auto"
            >
              ç®¡ç†é¢˜åº“
            </button>
          </div>
        </div>

        <button id="start-ludo-game-btn" class="form-button">å¼€å§‹æ¸¸æˆ</button>
      </div>
    </div>

    <!-- 2. é£è¡Œæ£‹æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="ludo-game-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-ludo-game-btn">â€¹ é€€å‡º</span>
        <span>å¿ƒåŠ¨é£è¡Œæ£‹</span>
        <!-- è¿™é‡Œå¯ä»¥æ”¾ä¸€ä¸ªé‡ç½®æ¸¸æˆçš„æŒ‰é’® -->
        <span class="action-btn" id="restart-ludo-game-btn" title="é‡æ–°å¼€å§‹">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
        </span>
      </div>
      <!-- æ¸¸æˆä¸»å†…å®¹åŒº -->
      <div id="ludo-game-content">
        <!-- æ£‹ç›˜åŒºåŸŸ -->
        <div id="ludo-board-container">
          <div id="ludo-board">
            <!-- æ£‹ç›˜æ ¼å­å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
          <!-- ç©å®¶æ£‹å­ -->
          <div id="ludo-user-piece" class="ludo-piece user"></div>
          <div id="ludo-char-piece" class="ludo-piece char"></div>
        </div>

        <!-- æ¸¸æˆæ—¥å¿—åŒºåŸŸ -->
        <div id="ludo-log-container">
          <div id="ludo-game-log"></div>
        </div>

        <!-- ç©å®¶æ“ä½œåŒº -->
        <div id="ludo-action-area"></div>
      </div>
    </div>

    <!-- å¾®åšç§ä¿¡åˆ—è¡¨é¡µé¢ -->
    <div id="weibo-dm-list-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-dm-list">â€¹</span>
        <span id="weibo-dm-list-title">ç²‰ä¸ç§ä¿¡</span>
        <!-- è¿™æ˜¯ä½ è¦æ±‚çš„â€œç»§ç»­ç”Ÿæˆâ€æŒ‰é’® -->
        <div class="header-actions">
          <span
            class="action-btn"
            id="generate-more-dms-btn"
            title="ç»§ç»­ç”Ÿæˆç§ä¿¡"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
            </svg>
          </span>

          <!-- â€œæ¸…ç©ºå…¨éƒ¨â€æŒ‰é’® -->
          <span class="action-btn" id="clear-all-dms-btn" title="æ¸…ç©ºå…¨éƒ¨ç§ä¿¡">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
              />
            </svg>
          </span>
        </div>
      </div>
      <div id="weibo-dm-list" class="list-container" style="padding: 0">
        <!-- ç§ä¿¡åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <div id="weibo-dm-detail-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-dm-detail">â€¹</span>
        <span id="weibo-dm-detail-title"></span>
        <span style="width: 30px"></span>
        <!-- å ä½ç¬¦ -->
      </div>
      <div
        id="weibo-dm-messages"
        class="list-container"
        style="
          display: flex;
          flex-direction: column;
          gap: 15px;
          padding: 15px;
          background-color: #f0f2f5;
        "
      >
        <!-- èŠå¤©æ°”æ³¡å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- index.html -->

    <div id="taobao-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>æ¡ƒå®</span>
        <div class="header-actions">
          <span
            class="action-btn"
            id="clear-taobao-products-btn"
            style="font-size: 16px; font-weight: 500"
            >æ¸…ç©º</span
          >
          <span class="action-btn" id="add-product-btn" title="æ·»åŠ å•†å“"
            >+</span
          >
        </div>
      </div>

      <!-- 1. é¡¶éƒ¨é¡µç­¾å¯¼èˆª (å·²åŠ å…¥â€œé¥¿äº†ä¹ˆâ€) -->
      <div class="taobao-tabs">
        <button class="taobao-tab active" data-view="products-view">
          é¦–é¡µ
        </button>

        <button class="taobao-tab" data-view="eleme-view">é¥¿äº†ä¹ˆ</button>

        <button class="taobao-tab" data-view="cart-view">
          è´­ç‰©è½¦<span id="cart-item-count-badge" style="display: none">0</span>
        </button>
        <button class="taobao-tab" data-view="orders-view">æˆ‘çš„è®¢å•</button>
        <button class="taobao-tab" data-view="my-view">æˆ‘çš„</button>
      </div>

      <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
      <div class="taobao-content">
        <!-- â€œé¦–é¡µâ€è§†å›¾ (ä¿æŒä¸å˜) -->
        <div id="products-view" class="taobao-view active">
          <div class="taobao-search-bar">
            <input
              type="search"
              id="product-search-input"
              placeholder="æœä¸€æœï¼Œè®©AIä¸ºä½ åˆ›é€ å¥½ç‰©ï¼"
            />
            <button id="product-search-btn">æœç´¢</button>
          </div>
          <div id="product-category-tabs"></div>
          <div id="product-grid" class="product-grid"></div>
        </div>

        <div id="eleme-view" class="taobao-view">
          <div class="taobao-search-bar">
            <!-- æ–°å¢ï¼šè¿™æ˜¯ç¬¬ä¸€è¡Œçš„â€œæœç´¢â€ç»„ -->
            <div class="eleme-search-group">
              <input
                type="search"
                id="eleme-search-input"
                placeholder="æƒ³åƒç‚¹ä»€ä¹ˆï¼Ÿè®©AIå¸®ä½ æ‰¾ï¼"
              />
              <button id="eleme-search-btn">æœç´¢</button>
            </div>

            <!-- æ–°å¢ï¼šè¿™æ˜¯ç¬¬äºŒè¡Œçš„â€œåŠŸèƒ½â€ç»„ -->
            <div class="eleme-actions-group">
              <button
                id="eleme-add-manual-btn"
                class="header-actions"
                title="æ‰‹åŠ¨æ·»åŠ ç¾é£Ÿ"
              >
                +
              </button>
              <button
                id="eleme-generate-ai-btn"
                class="header-actions"
                title="AIç”Ÿæˆç¾é£Ÿ"
              >
                âœ¨
              </button>
              <button id="eleme-clear-all-btn" class="header-btn">ğŸ—‘ï¸</button>
            </div>
          </div>

          <div id="eleme-grid" class="product-grid">
            <!-- ç¾é£Ÿåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
        </div>

        <!-- â€œè´­ç‰©è½¦â€è§†å›¾ -->
        <div id="cart-view" class="taobao-view">
          <div id="cart-item-list"></div>
          <div id="cart-checkout-bar" style="display: none">
            <div class="total-price">
              åˆè®¡: <span id="cart-total-price">Â¥ 0.00</span>
            </div>
            <div style="display: flex; gap: 10px">
              <button id="share-cart-to-char-btn">åˆ†äº«ç»™Taä»£ä»˜</button>
              <button id="buy-for-char-btn">ä¸ºTaè´­ä¹°</button>
              <button id="checkout-btn">ç»“ç®—(0)</button>
            </div>
          </div>
        </div>

        <!-- â€œæˆ‘çš„è®¢å•â€è§†å›¾ -->
        <div id="orders-view" class="taobao-view">
          <div id="order-list" class="order-list"></div>
        </div>

        <!-- â€œæˆ‘çš„â€è§†å›¾ -->
        <div id="my-view" class="taobao-view">
          <div id="user-balance-container">
            <p>æˆ‘çš„ä½™é¢</p>
            <h2 id="user-balance-display">Â¥ 0.00</h2>
            <button id="top-up-btn" class="form-button">ç»™é’±åŒ…å……ç‚¹é’±</button>
          </div>
          <div
            id="balance-details-list"
            class="order-list"
            style="padding: 0 15px"
          ></div>
        </div>
      </div>
    </div>

    <div id="product-detail-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>å•†å“è¯¦æƒ…</span>
        </div>
        <div class="modal-body" id="product-detail-body">
          <!-- è¯¦æƒ…å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <!-- è¯„ä»·åŒºåŸŸ -->
        <div id="product-reviews-section">
          <h3>å®è´è¯„ä»·</h3>
          <div id="product-reviews-list"></div>
          <button
            id="generate-reviews-btn"
            class="form-button form-button-secondary"
          >
            âœ¨ AIç”Ÿæˆè¯„ä»·
          </button>
        </div>

        <div class="modal-footer">
          <button class="cancel" id="close-product-detail-btn">å…³é—­</button>
          <button class="save" id="detail-add-to-cart-btn">åŠ å…¥è´­ç‰©è½¦</button>
        </div>
      </div>
    </div>

    <!-- 2. æ·»åŠ å•†å“çš„æ–¹å¼é€‰æ‹©å¼¹çª— -->
    <div id="add-product-choice-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-header">é€‰æ‹©æ·»åŠ æ–¹å¼</div>
        <div class="custom-modal-footer">
          <button id="add-product-manual-btn">æ‰‹åŠ¨æ·»åŠ </button>
          <button id="add-product-link-btn">è¯†åˆ«é“¾æ¥</button>
          <button id="add-product-ai-btn">AIç”Ÿæˆ</button>
          <button
            id="cancel-add-choice-btn"
            style="
              margin-top: 8px;
              border-radius: 8px;
              background-color: #f0f0f0;
            "
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <!-- 3. æ‰‹åŠ¨æ·»åŠ /ç¼–è¾‘å•†å“å¼¹çª— -->
    <div id="product-editor-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span id="product-editor-title">æ·»åŠ æ–°å•†å“</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="product-name-input">å•†å“åç§°</label>
            <input type="text" id="product-name-input" />
          </div>
          <div class="form-group">
            <label for="product-price-input">ä»·æ ¼ (å…ƒ)</label>
            <input type="number" id="product-price-input" />
          </div>
          <div class="form-group">
            <label for="product-image-input">å›¾ç‰‡ URL</label>
            <input type="text" id="product-image-input" />
          </div>
          <div class="form-group">
            <label for="product-category-input">åˆ†ç±» (é€‰å¡«)</label>
            <input
              type="text"
              id="product-category-input"
              placeholder="ä¾‹å¦‚ï¼šè¡£æœ, é›¶é£Ÿ..."
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-product-editor-btn">å–æ¶ˆ</button>
          <button class="save" id="save-product-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- 4. è¯†åˆ«é“¾æ¥å¼¹çª— -->
    <div id="add-from-link-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>ç²˜è´´åˆ†äº«æ–‡æ¡ˆ</span>
        </div>
        <div class="modal-body">
          <textarea
            id="link-paste-area"
            rows="6"
            placeholder="è¯·åœ¨è¿™é‡Œç²˜è´´å®Œæ•´çš„æ·˜å®æˆ–æ‹¼å¤šå¤šåˆ†äº«æ–‡æ¡ˆ..."
          ></textarea>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-link-paste-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-link-paste-btn">è¯†åˆ«</button>
        </div>
      </div>
    </div>

    <!-- ç‰©æµè¯¦æƒ…é¡µé¢ -->
    <div id="logistics-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="logistics-back-btn">â€¹</span>
        <span>ç‰©æµè¯¦æƒ…</span>
        <span style="width: 30px"></span>
        <!-- å ä½ç¬¦ï¼Œè®©æ ‡é¢˜å±…ä¸­ -->
      </div>
      <div id="logistics-content-area" class="list-container">
        <!-- ç‰©æµä¿¡æ¯å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <!-- 1. â€œè°æ˜¯å§åº•â€æ¸¸æˆè®¾ç½®å±å¹• -->
    <div id="undercover-setup-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('game-hall-screen')">â€¹</span>
        <span>è°æ˜¯å§åº• - æ¸¸æˆè®¾ç½®</span>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label>é‚€è¯·æ¨¡å¼</label>
          <div style="display: flex; gap: 20px">
            <label style="cursor: pointer"
              ><input
                type="radio"
                name="undercover_invite_mode"
                value="manual"
                checked
              />
              æ‰‹åŠ¨é‚€è¯·</label
            >
            <label style="cursor: pointer"
              ><input
                type="radio"
                name="undercover_invite_mode"
                value="random"
              />
              éšæœºé‚€è¯·</label
            >
          </div>
        </div>

        <!-- éšæœºé‚€è¯·çš„é€‰é¡¹ -->
        <div id="undercover-random-invite-options" style="display: none">
          <div class="form-group">
            <label for="undercover-random-player-count"
              >ä½ æƒ³é‚€è¯·å‡ ä½AI/NPCï¼Ÿ (ä¸å«ä½ è‡ªå·±)</label
            >
            <input
              type="number"
              id="undercover-random-player-count"
              min="2"
              max="15"
              value="5"
              style="width: 100%; box-sizing: border-box; padding: 10px"
            />
          </div>
        </div>

        <!-- æ‰‹åŠ¨é‚€è¯·çš„é€‰é¡¹ -->
        <div id="undercover-manual-invite-options">
          <div class="form-group">
            <label>è¯·å‹¾é€‰è¦é‚€è¯·çš„ç©å®¶</label>
            <div
              id="undercover-player-selection"
              class="list-container"
              style="
                height: 350px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
              "
            >
              <!-- ç©å®¶é€‰æ‹©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
        </div>

        <button id="start-undercover-game-btn" class="form-button">
          å¼€å§‹æ¸¸æˆ
        </button>
        <p
          style="
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 15px;
          "
        >
          æ¸¸æˆæœ€å°‘éœ€è¦3äººã€‚<br />
          3-5äººå±€ï¼š1å§åº•<br />
          6-8äººå±€ï¼š1å§åº•, 1ç™½æ¿<br />
          9äººåŠä»¥ä¸Šï¼š2å§åº•, 1ç™½æ¿
        </p>
      </div>
    </div>

    <!-- 2. â€œè°æ˜¯å§åº•â€æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="undercover-game-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-undercover-game-btn">â€¹ é€€å‡º</span>
        <span id="undercover-game-title">è°æ˜¯å§åº•</span>
        <span class="action-btn" id="undercover-my-word-btn">æˆ‘çš„è¯è¯­</span>
      </div>
      <!-- æ¸¸æˆä¸»å†…å®¹åŒº -->
      <div
        id="undercover-game-content"
        style="
          display: flex;
          flex-direction: column;
          height: 100%;
          overflow: hidden;
          padding: 10px;
          box-sizing: border-box;
        "
      >
        <!-- ç©å®¶åº§ä½åŒº -->
        <div
          id="undercover-players-grid"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 15px;
            padding: 10px;
            flex-shrink: 0;
          "
        >
          <!-- ç©å®¶å¤´åƒå’ŒçŠ¶æ€å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <!-- æ¸¸æˆæ—¥å¿—/ä¿¡æ¯åŒº -->
        <div
          id="undercover-log-container"
          style="
            flex-grow: 1;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            margin: 10px 0;
            min-height: 0;
          "
        >
          <div id="undercover-game-log">
            <!-- æ¸¸æˆè¿‡ç¨‹ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
          </div>
        </div>
        <!-- ç©å®¶æ“ä½œåŒº -->
        <div
          id="undercover-action-area"
          style="
            flex-shrink: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            min-height: 50px;
          "
        >
          <!-- ç©å®¶çš„æŒ‰é’®ä¼šæ ¹æ®æ¸¸æˆé˜¶æ®µæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
      </div>
    </div>

    <div id="undercover-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div
          class="modal-body"
          id="undercover-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <!-- â€œåˆ†äº«å¤ç›˜â€æŒ‰é’® -->
          <button class="cancel" id="repost-undercover-summary-btn">
            åˆ†äº«å¤ç›˜åˆ°å•èŠ
          </button>
          <button class="save" id="back-to-hall-from-undercover-btn">
            è¿”å›å¤§å…
          </button>
        </div>
      </div>
    </div>

    <!-- 1. Userç§ä¿¡åˆ—è¡¨é¡µé¢ -->
    <div id="user-dm-list-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-user-dm-list">â€¹</span>
        <span>æˆ‘çš„ç§ä¿¡</span>
        <div class="header-actions">
          <!-- è¿™ä¸ªæŒ‰é’®ç”¨äºè®©AIç”Ÿæˆæ–°çš„ç²‰ä¸ç§ä¿¡ -->
          <span
            class="action-btn"
            id="generate-new-user-dms-btn"
            title="ç”Ÿæˆæ–°ç§ä¿¡"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
            </svg>
          </span>
          <!-- è¿™ä¸ªæŒ‰é’®ç”¨äºæ¸…ç©ºæ‰€æœ‰ç§ä¿¡ -->
          <span
            class="action-btn"
            id="clear-all-user-dms-btn"
            title="æ¸…ç©ºæ‰€æœ‰ç§ä¿¡"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
              />
            </svg>
          </span>
        </div>
      </div>
      <div
        id="user-dm-list-container"
        class="list-container"
        style="padding: 0"
      >
        <!-- ç§ä¿¡åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <!-- 2. Userç§ä¿¡è¯¦æƒ…é¡µé¢ (ä¸ç²‰ä¸èŠå¤©) -->
    <div id="user-dm-detail-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-user-dm-detail">â€¹</span>
        <span id="user-dm-detail-title"></span>
        <!-- ç²‰ä¸åå­— -->
        <span style="width: 30px"></span>
        <!-- å ä½ç¬¦ -->
      </div>
      <div
        id="user-dm-messages-container"
        class="list-container"
        style="
          display: flex;
          flex-direction: column;
          gap: 15px;
          padding: 15px;
          background-color: #f0f2f5;
        "
      >
        <!-- èŠå¤©æ°”æ³¡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
      <!-- èŠå¤©è¾“å…¥æ¡† -->

      <div id="user-dm-input-area" class="chat-input-area">
        <div class="chat-input-main-row">
          <textarea
            id="user-dm-input"
            rows="1"
            placeholder="å’Œç²‰ä¸èŠç‚¹ä»€ä¹ˆ..."
          ></textarea>

          <div id="input-actions-wrapper">
            <!-- è¿™æ˜¯æ–°åŠ çš„â€œè§¦å‘AIå›åº”â€æŒ‰é’® -->
            <button
              id="user-dm-trigger-ai-btn"
              class="action-button chat-action-icon-btn"
              title="è®©å¯¹æ–¹å…ˆè¯´"
            >
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
              </svg>
            </button>
            <!-- è¿™æ˜¯æ–°åŠ çš„â€œé‡Rollâ€æŒ‰é’® -->
            <button
              id="user-dm-reroll-btn"
              class="action-button chat-action-icon-btn"
              title="é‡æ–°ç”Ÿæˆå›å¤"
            >
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </button>

            <button id="user-dm-send-btn" class="action-button">å‘é€</button>
          </div>
        </div>
      </div>
    </div>

    <!-- è§’è‰²å¾®åšä¸»é¡µå±å¹• -->
    <div id="weibo-char-profile-screen" class="screen">
      <!-- å¤´éƒ¨ï¼ŒåŒ…å«è¿”å›æŒ‰é’®å’Œè§’è‰²åå­— -->
      <div class="header">
        <span class="back-btn" id="back-from-char-profile">â€¹</span>
        <span id="weibo-char-profile-title">è§’è‰²ä¸»é¡µ</span>
        <div class="header-actions">
          <span
            class="action-btn"
            id="edit-char-weibo-profile-btn"
            title="ç¼–è¾‘è§’è‰²èµ„æ–™"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 20h9"></path>
              <path
                d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
              ></path>
            </svg>
          </span>
        </div>
      </div>
      <!-- è§’è‰²ä¸»é¡µçš„å†…å®¹åŒº -->
      <div id="weibo-char-profile-page" class="weibo-profile-page">
        <!-- å¤ç”¨ä¸ªäººä¸»é¡µçš„æ»šåŠ¨æ ·å¼ -->
        <div class="weibo-profile-header">
          <img
            id="weibo-char-background-img"
            src="https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg"
            class="weibo-background"
          />
          <div class="weibo-avatar-container">
            <img
              id="weibo-char-avatar-img"
              src="https://files.catbox.moe/q6z5fc.jpeg"
              class="weibo-avatar"
            />
            <img
              id="weibo-char-avatar-frame"
              class="weibo-avatar-frame"
              src=""
              style="display: none"
            />
          </div>
          <div class="weibo-nickname" id="weibo-char-nickname">è§’è‰²æ˜µç§°</div>
          <div id="weibo-char-profession-display">è§’è‰²èŒä¸š</div>

          <div class="weibo-stats">
            <div
              id="weibo-char-following-item"
              class="weibo-stat-item"
              style="cursor: pointer"
            >
              <span id="weibo-char-following-count" class="weibo-stat-number"
                >0</span
              >
              <span class="weibo-stat-label">å…³æ³¨</span>
            </div>
            <div id="weibo-char-posts-item" class="weibo-stat-item">
              <span id="weibo-char-posts-count" class="weibo-stat-number"
                >0</span
              >
              <span class="weibo-stat-label">å¾®åš</span>
            </div>
            <div
              id="weibo-char-fans-item"
              class="weibo-stat-item"
              style="cursor: pointer"
            >
              <span id="weibo-char-fans-count" class="weibo-stat-number"
                >0</span
              >
              <span class="weibo-stat-label">ç²‰ä¸</span>
            </div>
          </div>
        </div>
        <div
          id="char-weibo-feed-list"
          style="
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
          "
        >
          <!-- è§’è‰²çš„å¾®åšåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
      </div>
    </div>

    <!-- è§’è‰²å¾®åšèµ„æ–™ç¼–è¾‘å¼¹çª— -->
    <div id="char-weibo-editor-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>ç¼–è¾‘è§’è‰²å¾®åšèµ„æ–™</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>å¾®åšå¤´åƒ</label>
            <div class="avatar-upload">
              <img id="char-weibo-editor-avatar-preview" />
              <button
                onclick="
                  document
                    .getElementById('char-weibo-editor-avatar-input')
                    .click()
                "
              >
                ä¸Šä¼ å¤´åƒ
              </button>
              <button class="change-frame-btn" data-type="char-weibo">
                æ›´æ¢å¤´åƒæ¡†
              </button>
              <input
                type="file"
                id="char-weibo-editor-avatar-input"
                accept="image/*"
                hidden
              />
            </div>
          </div>
          <div class="form-group">
            <label for="char-weibo-editor-nickname-input">å¾®åšæ˜µç§°</label>
            <input type="text" id="char-weibo-editor-nickname-input" />
          </div>
          <div class="form-group">
            <label>å¾®åšèƒŒæ™¯</label>
            <div class="avatar-upload">
              <img
                id="char-weibo-editor-bg-preview"
                style="width: 120px; height: 67.5px; border-radius: 8px"
              />
              <button
                onclick="
                  document.getElementById('char-weibo-editor-bg-input').click()
                "
              >
                ä¸Šä¼ èƒŒæ™¯
              </button>
              <input
                type="file"
                id="char-weibo-editor-bg-input"
                accept="image/*"
                hidden
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-char-weibo-editor-btn">å–æ¶ˆ</button>
          <button class="save" id="save-char-weibo-editor-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div id="date-a-live-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>çº¦ä¼šå¤§ä½œæˆ˜</span>
        <div class="header-actions">
          <!-- â€œ+â€å·æŒ‰é’® -->
          <span
            class="action-btn"
            id="create-dating-scene-btn"
            title="åˆ›å»ºæ–°åœºæ™¯"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </span>

          <span class="action-btn" id="dating-history-btn" title="å†å²çº¦ä¼š">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
              <polyline points="3 3 3 8 8 8" />
              <path d="M12 6V12L16 14" />
            </svg>
          </span>
          <span
            class="action-btn"
            id="refresh-dating-scene-btn"
            title="åˆ·æ–°åœºæ™¯"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
          </span>
        </div>
      </div>
      <div id="dating-scene-content" class="list-container">
        <!-- çº¦ä¼šåœºæ™¯å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <!-- å® ç‰©åŠŸèƒ½æ¨¡æ€æ¡† -->
    <div id="pet-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 85%">
        <div class="modal-header">
          <span id="pet-modal-title">æˆ‘çš„å® ç‰©</span>
        </div>
        <div class="modal-body">
          <!-- å® ç‰©ä¿¡æ¯é¢„è§ˆåŒº -->
          <div
            id="pet-preview-area"
            style="text-align: center; margin-bottom: 20px"
          >
            <div
              id="pet-preview-display"
              style="
                font-size: 60px;
                line-height: 1;
                margin-bottom: 10px;
                cursor: pointer;
              "
              title="ç‚¹å‡»æ›´æ¢å›¾ç‰‡"
            ></div>
            <strong id="pet-preview-name" style="font-size: 18px"></strong>
            <p
              id="pet-preview-type"
              style="
                font-size: 14px;
                color: var(--text-secondary);
                margin: 5px 0;
              "
            ></p>
          </div>

          <!-- å® ç‰©æ•°å€¼æ˜¾ç¤ºåŒº -->
          <div id="pet-stats-area" style="display: none">
            <div id="pet-hunger-bar" class="stat-bar-container">
              <span class="stat-label">é¥±é£Ÿåº¦</span>
              <div class="stat-bar"><div class="stat-bar-fill">100%</div></div>
            </div>
            <div id="pet-happiness-bar" class="stat-bar-container">
              <span class="stat-label">å¿ƒæƒ…å€¼</span>
              <div class="stat-bar"><div class="stat-bar-fill">100%</div></div>
            </div>
            <div id="pet-intimacy-user-bar" class="stat-bar-container">
              <span class="stat-label">å¯¹ä½ çš„äº²å¯†åº¦</span>
              <div class="stat-bar"><div class="stat-bar-fill">50%</div></div>
            </div>
            <div id="pet-intimacy-char-bar" class="stat-bar-container">
              <span class="stat-label">å¯¹Taçš„äº²å¯†åº¦</span>
              <div class="stat-bar"><div class="stat-bar-fill">50%</div></div>
            </div>
          </div>

          <!-- äº’åŠ¨æŒ‰é’®åŒº (å·²æ–°å¢â€œå¯¹è¯â€æŒ‰é’®) -->
          <div
            id="pet-interaction-area"
            style="
              display: flex;
              justify-content: center;
              gap: 15px;
              margin-bottom: 20px;
              padding-bottom: 15px;
              border-bottom: 1px solid var(--border-color);
            "
          >
            <button class="form-button-secondary" data-action="feed">
              å–‚é£Ÿ
            </button>
            <button class="form-button-secondary" data-action="play">
              ç©è€
            </button>
            <button class="form-button-secondary" data-action="touch">
              æŠšæ‘¸
            </button>
            <button class="form-button-secondary" data-action="chat">
              å¯¹è¯
            </button>
          </div>

          <!-- è®¾ç½®åŒº -->
          <div class="form-group">
            <label for="pet-type-input">ç§ç±» (è‡ªç”±å¡«å†™)</label>
            <input
              type="text"
              id="pet-type-input"
              placeholder="ä¾‹å¦‚: å°çŒ«, ä»“é¼ , å¤ªé˜³èŠ±..."
            />
          </div>
          <div class="form-group">
            <label for="pet-name-input">æ˜µç§°</label>
            <input
              type="text"
              id="pet-name-input"
              placeholder="ç»™å®ƒèµ·ä¸ªåå­—å§"
            />
          </div>
          <div class="form-group">
            <label for="pet-image-input">åˆå§‹æ ·å­ (Emoji æˆ– å›¾ç‰‡URL)</label>
            <input
              type="text"
              id="pet-image-input"
              placeholder="è¾“å…¥ä¸€ä¸ª Emoji æ¯”å¦‚ ğŸˆ æˆ–å›¾ç‰‡é“¾æ¥"
            />
          </div>
          <!-- äººè®¾è¾“å…¥æ¡† -->
          <div class="form-group">
            <label for="pet-persona-input">å® ç‰©äººè®¾ä¸èƒŒæ™¯</label>
            <textarea
              id="pet-persona-input"
              rows="3"
              placeholder="æè¿°ä¸€ä¸‹å®ƒçš„æ€§æ ¼å’Œæ•…äº‹ï¼ŒAIä¼šæ ¹æ®è¿™ä¸ªæ¥æ‰®æ¼”å®ƒã€‚"
            ></textarea>
          </div>
          <div class="form-group">
            <label class="toggle-switch-label">
              <span>åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤º</span>
              <input type="checkbox" id="pet-display-toggle" />
              <span class="toggle-switch-slider"></span>
            </label>
          </div>
          <div id="pet-position-controls" style="display: none">
            <div class="form-group">
              <label for="pet-size-slider"
                >å¤§å°: <span id="pet-size-value">100px</span></label
              >
              <input
                type="range"
                id="pet-size-slider"
                min="30"
                max="200"
                value="100"
                style="width: 100%"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="pet-abandon-btn"
            style="
              background-color: #ffdde5;
              color: #ff3b30;
              border-color: #ffc2d1;
            "
          >
            æ”¾ç”Ÿå® ç‰©
          </button>

          <button class="cancel" id="pet-modal-cancel-btn">å–æ¶ˆ</button>
          <button class="save" id="pet-modal-save-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <input
      type="file"
      id="pet-custom-image-input"
      accept="image/*"
      style="display: none"
    />
    <!-- å® ç‰©èŠå¤©æ¨¡æ€æ¡† -->
    <div id="pet-chat-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span id="pet-chat-title">å’Œå® ç‰©çš„å¯¹è¯</span>
        </div>
        <div
          id="pet-chat-messages"
          class="modal-body"
          style="
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            gap: 15px;
          "
        >
          <!-- å® ç‰©èŠå¤©è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
        <!-- å¤ç”¨ä¸»èŠå¤©è¾“å…¥æ¡†çš„æ ·å¼ -->
        <div
          id="pet-chat-input-area"
          class="chat-input-area"
          style="border-top: 1px solid var(--border-color)"
        >
          <div class="chat-input-main-row">
            <textarea
              id="pet-chat-input"
              rows="1"
              placeholder="å’Œå®ƒè¯´ç‚¹ä»€ä¹ˆ..."
            ></textarea>
            <button id="send-to-pet-btn" class="action-button">å‘é€</button>
          </div>
        </div>
      </div>
    </div>

    <div id="weibo-char-selector-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>é€‰æ‹©ç”Ÿæˆå†…å®¹çš„ä¸»è§’</span>
        </div>
        <div
          class="modal-body"
          id="weibo-char-selector-list"
          style="padding: 0; overflow-y: auto"
        >
          <!-- è§’è‰²åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer" style="justify-content: space-between">
          <button
            id="weibo-select-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            å…¨é€‰
          </button>
          <button
            id="weibo-deselect-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            å…¨ä¸é€‰
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="weibo-cancel-char-select-btn">å–æ¶ˆ</button>
          <button class="save" id="weibo-confirm-char-select-btn">ç¡®è®¤</button>
        </div>
      </div>
    </div>

    <!-- æƒ…ä¾£ç©ºé—´-æƒ…ç»ªæ—¥è®°ç¼–è¾‘å¼¹çª— -->
    <div id="ls-diary-editor-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span id="ls-diary-editor-title">è®°å½•ä»Šå¤©çš„å¿ƒæƒ…</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>é€‰æ‹©ä¸€ä¸ªè¡¨æƒ…ä»£è¡¨ä»Šå¤©çš„å¿ƒæƒ…</label>
            <div
              id="ls-emoji-selector"
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                font-size: 24px;
                cursor: pointer;
                justify-content: center;
                padding: 10px 0;
              "
            >
              <!-- Emojiå°†ç”±JSç”Ÿæˆ -->
            </div>
          </div>
          <div class="form-group">
            <label for="ls-diary-content-input">å†™ä¸‹ä½ çš„æ—¥è®°</label>
            <textarea
              id="ls-diary-content-input"
              rows="6"
              placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆç‰¹åˆ«çš„äº‹å—..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="ls-cancel-diary-btn">å–æ¶ˆ</button>
          <button class="save" id="ls-save-diary-btn">ä¿å­˜æ—¥è®°</button>
        </div>
      </div>
    </div>

    <!-- æƒ…ä¾£ç©ºé—´-æ—¥è®°æŸ¥çœ‹å¼¹çª— -->
    <div id="ls-diary-viewer-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span id="ls-diary-viewer-title">æŸ¥çœ‹æ—¥è®°</span>
        </div>
        <div
          id="ls-diary-viewer-body"
          class="modal-body"
          style="display: flex; flex-direction: column; gap: 20px"
        >
          <!-- æ—¥è®°å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="ls-close-diary-viewer-btn"
            style="width: 100%"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- æƒ…ä¾£ç©ºé—´ - æ¯æ—¥è¶³è¿¹æ—¥å†å¼¹çª— -->
    <div id="ls-activity-calendar-modal" class="modal">
      <div class="modal-content" style="max-width: 380px">
        <div class="modal-header">
          <span id="ls-activity-calendar-title">ğŸ’• è¶³è¿¹æ—¥å† ğŸ’•</span>
        </div>
        <div class="modal-body" id="ls-activity-calendar-body"></div>
      </div>
    </div>

    <div id="summary-viewer-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span id="summary-viewer-title">èŠå¤©æ€»ç»“</span>
        </div>
        <div class="modal-body" id="summary-list" style="padding: 15px">
          <!-- æ€»ç»“åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer" style="display: flex; gap: 10px">
          <!-- â€œå…¨éƒ¨ç²¾ç®€â€æŒ‰é’® -->
          <button
            class="form-button-secondary"
            id="concise-all-summaries-btn"
            style="flex: 1; margin: 0"
          >
            å…¨éƒ¨ç²¾ç®€
          </button>
          <button
            class="save"
            id="close-summary-viewer-btn"
            style="flex: 1; margin: 0"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- AIç”Ÿæˆå•†å“ç»“æœ/é€‰æ‹©å¼¹çª— -->
    <div id="ai-generated-products-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span id="ai-products-modal-title">AIä¸ºä½ ç”Ÿæˆäº†ä»¥ä¸‹å®è´</span>
        </div>
        <div class="modal-body" style="padding: 15px">
          <div id="ai-product-results-grid" class="product-grid"></div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-ai-products-modal-btn"
            style="width: 100%"
          >
            å®Œæˆ
          </button>
        </div>
      </div>
    </div>

    <!-- é£è¡Œæ£‹é—®é¢˜åº“ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="ludo-qbank-manager-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>ç®¡ç†é—®é¢˜åº“</span>

          <div class="header-actions">
            <span
              class="action-btn"
              id="import-ludo-qbank-btn"
              title="å¯¼å…¥é¢˜åº“"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </span>
            <span
              class="action-btn"
              id="add-ludo-qbank-btn"
              style="font-size: 16px"
              >æ–°å»º</span
            >
          </div>
        </div>
        <div class="modal-body" id="ludo-qbank-list" style="padding: 0">
          <!-- é—®é¢˜åº“åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button class="save" id="close-qbank-manager-btn" style="width: 100%">
            å®Œæˆ
          </button>
        </div>
      </div>
    </div>

    <!-- é£è¡Œæ£‹é—®é¢˜ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div id="ludo-question-editor-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span class="back-btn" id="back-to-qbank-manager-btn">â€¹</span>
          <span id="ludo-question-editor-title">ç¼–è¾‘é—®é¢˜</span>
          <span
            class="action-btn"
            id="add-ludo-question-btn"
            style="font-size: 28px; font-weight: 300"
            >+</span
          >
        </div>
        <div class="modal-body" id="ludo-question-list" style="padding: 10px">
          <!-- é—®é¢˜åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
      </div>
    </div>

    <!-- é£è¡Œæ£‹å•ä¸ªé—®é¢˜ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div id="ludo-single-question-editor-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span id="ludo-single-question-title">ç¼–è¾‘é—®é¢˜</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="ludo-question-text-input">é—®é¢˜å†…å®¹</label>
            <textarea id="ludo-question-text-input" rows="4"></textarea>
          </div>
          <div class="form-group">
            <label>é—®é¢˜ç±»å‹</label>
            <div style="display: flex; gap: 20px">
              <label
                ><input
                  type="radio"
                  name="ludo_question_type"
                  value="both_answer"
                  checked
                />
                å…±åŒå›ç­”</label
              >
              <label
                ><input
                  type="radio"
                  name="ludo_question_type"
                  value="single_answer"
                />
                ä¸€äººå›ç­”,ä¸€äººè¯„ä»·</label
              >
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-single-question-btn">å–æ¶ˆ</button>
          <button class="save" id="save-single-question-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- é£è¡Œæ£‹æ¸¸æˆç»“ç®—å¡ç‰‡ -->
    <div id="ludo-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div
          class="modal-body"
          id="ludo-summary-content"
          style="text-align: left; line-height: 1.7"
        >
          <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="share-ludo-summary-btn">åˆ†äº«ç»™Ta</button>
          <button class="save" id="back-to-hall-from-ludo-btn">è¿”å›å¤§å…</button>
        </div>
      </div>
    </div>
    <!-- â€œè°æ˜¯å§åº•â€æ¸¸æˆç»“ç®—å¡ç‰‡ -->
    <div id="undercover-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span>æ¸¸æˆç»“ç®—</span>
        </div>
        <div
          class="modal-body"
          id="undercover-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- ç»“ç®—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <!-- â€œåˆ†äº«å¤ç›˜â€æŒ‰é’® -->
          <button class="cancel" id="repost-undercover-summary-btn">
            åˆ†äº«å¤ç›˜åˆ°å•èŠ
          </button>
          <button class="save" id="back-to-hall-from-undercover-btn">
            è¿”å›å¤§å…
          </button>
        </div>
      </div>
    </div>

    <!-- â€œè°æ˜¯å§åº•â€å¤ç›˜å‘é€ç›®æ ‡é€‰æ‹©å™¨ -->
    <div id="undercover-target-picker-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>é€‰æ‹©è¦å‘é€çš„ç©å®¶</span>
        </div>
        <div class="modal-body" id="undercover-target-list" style="padding: 0">
          <!-- ç©å®¶åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button
            id="uc-select-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            å…¨é€‰
          </button>
          <button
            id="uc-deselect-all-btn"
            class="form-button-secondary"
            style="width: 45%; margin: 0"
          >
            å…¨ä¸é€‰
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="uc-cancel-share-btn">å–æ¶ˆ</button>
          <button class="save" id="uc-confirm-share-btn">ç¡®è®¤å‘é€</button>
        </div>
      </div>
    </div>

    <!-- ç¾¤å…¬å‘Šæ¨¡æ€æ¡† -->
    <div id="group-announcement-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>ç¾¤å…¬å‘Š</span>
        </div>
        <div class="modal-body" id="announcement-content-area">
          <!-- å…¬å‘Šå†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer" id="announcement-footer">
          <!-- æŒ‰é’®å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>
    <!-- å¿ƒå£°é¢æ¿æ ·å¼ç¼–è¾‘å™¨å¼¹çª— -->
    <div id="inner-voice-editor-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>ç¼–è¾‘å¿ƒå£°é¢æ¿æ ·å¼</span>
        </div>
        <div class="modal-body">
          <!-- === æ›¿æ¢å¼€å§‹ï¼šè‡ªå®šä¹‰å¿ƒå£°å­—æ®µ === -->
          <div class="form-group">
            <label>è‡ªå®šä¹‰å¿ƒå£°å­—æ®µ (æ ‡ç­¾å + AIç”ŸæˆæŒ‡ä»¤)</label>
            <div style="font-size: 12px; color: #666; margin-bottom: 10px">
              å·¦è¾¹å¡«æ˜¾ç¤ºçš„æ ‡é¢˜ï¼Œå³è¾¹å¡«ç»™AIçš„å…·ä½“è¦æ±‚ã€‚
            </div>

            <!-- å­—æ®µ 1: clothing -->
            <div style="display: flex; gap: 5px; margin-bottom: 8px">
              <input
                type="text"
                id="iv-label-clothing"
                placeholder="æ ‡é¢˜ (å¦‚: æœè£…)"
                class="moe-input"
                style="flex: 1"
              />
              <textarea
                id="iv-prompt-clothing"
                rows="1"
                placeholder="æŒ‡ä»¤ (å¦‚: æè¿°ä½ ç°åœ¨çš„ç©¿ç€)"
                class="moe-input"
                style="flex: 2; resize: vertical"
              ></textarea>
            </div>

            <!-- å­—æ®µ 2: behavior -->
            <div style="display: flex; gap: 5px; margin-bottom: 8px">
              <input
                type="text"
                id="iv-label-behavior"
                placeholder="æ ‡é¢˜ (å¦‚: è¡Œä¸º)"
                class="moe-input"
                style="flex: 1"
              />
              <textarea
                id="iv-prompt-behavior"
                rows="1"
                placeholder="æŒ‡ä»¤ (å¦‚: æè¿°ä½ çš„åŠ¨ä½œç¥æ€)"
                class="moe-input"
                style="flex: 2; resize: vertical"
              ></textarea>
            </div>

            <!-- å­—æ®µ 3: thoughts -->
            <div style="display: flex; gap: 5px; margin-bottom: 8px">
              <input
                type="text"
                id="iv-label-thoughts"
                placeholder="æ ‡é¢˜ (å¦‚: å¿ƒå£°)"
                class="moe-input"
                style="flex: 1"
              />
              <textarea
                id="iv-prompt-thoughts"
                rows="1"
                placeholder="æŒ‡ä»¤ (å¦‚: æè¿°ä½ çš„å†…å¿ƒæƒ³æ³•)"
                class="moe-input"
                style="flex: 2; resize: vertical"
              ></textarea>
            </div>

            <!-- å­—æ®µ 4: naughty -->
            <div style="display: flex; gap: 5px; margin-bottom: 8px">
              <input
                type="text"
                id="iv-label-naughty"
                placeholder="æ ‡é¢˜ (å¦‚: åå¿ƒæ€)"
                class="moe-input"
                style="flex: 1"
              />
              <textarea
                id="iv-prompt-naughty"
                rows="1"
                placeholder="æŒ‡ä»¤ (å¦‚: æè¿°ä½ çš„è…¹é»‘æƒ³æ³•)"
                class="moe-input"
                style="flex: 2; resize: vertical"
              ></textarea>
            </div>
          </div>
          <hr style="opacity: 0.2" />
          <!-- === æ›¿æ¢ç»“æŸ === -->

          <hr style="opacity: 0.2" />
          <!-- === æ–°å¢ç»“æŸ === -->
          <!-- å¡ç‰‡èƒŒæ™¯é¢œè‰² -->
          <div class="form-group">
            <label for="iv-card-bg-color">å¡ç‰‡èƒŒæ™¯é¢œè‰²</label>
            <input
              type="color"
              id="iv-card-bg-color"
              value="#FFFFFF"
              style="width: 100%; height: 40px"
            />
          </div>
          <!-- å¡ç‰‡é€æ˜åº¦ -->
          <div class="form-group">
            <label for="iv-opacity-slider"
              >å¡ç‰‡èƒŒæ™¯é€æ˜åº¦: <span id="iv-opacity-value">70%</span></label
            >
            <input
              type="range"
              id="iv-opacity-slider"
              min="0"
              max="1"
              step="0.05"
              value="0.7"
              style="width: 100%"
            />
          </div>
          <hr style="opacity: 0.2" />
          <!-- å››ä¸ªæ ‡ç­¾çš„èƒŒæ™¯è‰² -->
          <div class="form-group">
            <label for="iv-color-clothing">â€œæœè£…â€æ ‡ç­¾èƒŒæ™¯è‰²</label>
            <input
              type="color"
              id="iv-color-clothing"
              value="#f0a1a8"
              style="width: 100%; height: 40px"
            />
          </div>
          <div class="form-group">
            <label for="iv-color-behavior">â€œè¡Œä¸ºâ€æ ‡ç­¾èƒŒæ™¯è‰²</label>
            <input
              type="color"
              id="iv-color-behavior"
              value="#81c784"
              style="width: 100%; height: 40px"
            />
          </div>
          <div class="form-group">
            <label for="iv-color-thoughts">â€œå¿ƒå£°â€æ ‡ç­¾èƒŒæ™¯è‰²</label>
            <input
              type="color"
              id="iv-color-thoughts"
              value="#64b5f6"
              style="width: 100%; height: 40px"
            />
          </div>
          <div class="form-group">
            <label for="iv-color-naughty">â€œåå¿ƒæ€â€æ ‡ç­¾èƒŒæ™¯è‰²</label>
            <input
              type="color"
              id="iv-color-naughty"
              value="#ba68c8"
              style="width: 100%; height: 40px"
            />
          </div>

          <hr style="opacity: 0.2; margin: 20px 0" />
          <div class="form-group">
            <label for="iv-icon-color">å›¾æ ‡é¢œè‰²</label>
            <input
              type="color"
              id="iv-icon-color"
              value="#ff8a80"
              style="width: 100%; height: 40px"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="iv-editor-cancel-btn">å–æ¶ˆ</button>
          <button class="save" id="iv-editor-save-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- AIç”Ÿæˆç¾¤æˆå‘˜æ¨¡æ€æ¡† -->
    <div id="ai-generate-members-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>AI ç”Ÿæˆç¾¤æˆå‘˜</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="ai-member-count-input">ç”Ÿæˆäººæ•° (1-20)</label>
            <input
              type="number"
              id="ai-member-count-input"
              value="3"
              min="1"
              max="20"
            />
          </div>
          <div class="form-group">
            <label for="ai-member-prompt-input">è¦æ±‚ (å¯é€‰ï¼ŒAIä¼šå‚è€ƒ)</label>
            <textarea
              id="ai-member-prompt-input"
              rows="4"
              placeholder="ä¾‹å¦‚ï¼šä¸€ç¾¤å–œæ¬¢æˆ·å¤–æ¢é™©çš„å¤§å­¦ç”Ÿï¼Œæ€§æ ¼å„å¼‚..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-ai-generate-members-btn">
            å–æ¶ˆ
          </button>
          <button class="save" id="confirm-ai-generate-members-btn">
            å¼€å§‹ç”Ÿæˆ
          </button>
        </div>
      </div>
    </div>

    <!-- çº¦ä¼šé‚€è¯·ä¸æ”¯ä»˜æ¨¡æ€æ¡† -->
    <div id="dating-payment-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span id="dating-modal-title">å‘èµ·çº¦ä¼šé‚€è¯·</span>
        </div>
        <div class="modal-body" style="text-align: center">
          <p>ä½ é€‰æ‹©çš„çº¦ä¼šæ˜¯ï¼š</p>
          <h3
            id="dating-modal-scene-name"
            style="color: var(--accent-color); margin: 10px 0"
          ></h3>
          <p id="dating-modal-scene-cost" style="font-weight: bold"></p>
          <hr style="opacity: 0.2; margin: 20px 0" />
          <p>ç”±è°æ¥ä¹°å•å‘¢ï¼Ÿ</p>
          <div
            id="dating-payment-options"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <!-- æ”¯ä»˜é€‰é¡¹æŒ‰é’®å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="dating-cancel-btn" style="width: 100%">
            ä¸‹æ¬¡å†è¯´
          </button>
        </div>
      </div>
    </div>

    <!-- çº¦ä¼šè§’è‰²é€‰æ‹©å¼¹çª— -->
    <div id="dating-char-selector-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>é€‰æ‹©çº¦ä¼šå¯¹è±¡</span>
        </div>
        <div
          class="modal-body"
          id="dating-char-selector-list"
          style="padding: 0"
        >
          <!-- è§’è‰²åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="dating-cancel-char-select-btn"
            style="width: 100%"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <div id="dating-game-screen" class="screen">
      <!-- 1. åŠ¨æ€èƒŒæ™¯å›¾ (æœ€åº•å±‚) -->
      <div id="dating-game-background"></div>

      <!-- 2. è§’è‰²ç«‹ç»˜å®¹å™¨ (ä¸­é—´å±‚) -->
      <div id="dating-game-sprite-container">
        <img id="dating-game-sprite" src="" />
      </div>

      <!-- 3. UIè¦†ç›–å±‚ (æœ€é¡¶å±‚, åŒ…å«å¤´éƒ¨/æ–‡æœ¬æ¡†/é€‰é¡¹) -->
      <div class="dating-game-ui-overlay">
        <div class="header">
          <span class="back-btn" id="end-date-btn">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M15 18l-6-6 6-6" />
            </svg>
          </span>

          <span id="dating-game-char-name"></span>
          <div class="header-actions">
            <!-- å¿ƒå½¢æ•°å€¼æ¡ -->
            <div id="dating-values-container">
              <div id="romance-value" class="value-display">
                <!-- æˆ‘ä»¬ä¼šç”¨JSåœ¨è¿™é‡Œç”Ÿæˆ5ä¸ªç²‰è‰²å¿ƒå½¢ -->
              </div>
              <div id="lust-value" class="value-display">
                <!-- æˆ‘ä»¬ä¼šç”¨JSåœ¨è¿™é‡Œç”Ÿæˆ5ä¸ªé»„è‰²å¿ƒå½¢ -->
              </div>
            </div>
            <span class="action-btn" id="dating-bgm-btn" title="èƒŒæ™¯éŸ³ä¹">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
              </svg>
            </span>
            <span
              class="action-btn"
              id="dating-game-settings-btn"
              title="åœºæ™¯è®¾ç½®"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="3"></circle>
                <path
                  d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                ></path>
              </svg>
            </span>
            <span
              class="action-btn"
              id="dating-game-reroll-btn"
              title="é‡Rollå›åº”"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </span>
          </div>
        </div>

        <!-- 3b. åº•éƒ¨æ–‡æœ¬æ¡† -->
        <div class="dating-game-textbox">
          <p id="dating-game-text-content">çº¦ä¼šå³å°†å¼€å§‹...</p>
        </div>
        <div id="dating-completion-bar-container">
          <div id="dating-completion-bar-fill"></div>
          <span id="dating-completion-text">0%</span>
        </div>
        <!-- 3c. ç©å®¶æ“ä½œåŒº -->
        <div id="dating-game-choices" class="dating-game-choices">
          <!-- é€‰é¡¹æŒ‰é’®å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
      </div>
    </div>
    <!-- â–¼â–¼â–¼ å…¨æ–°ï¼šçº¦ä¼šBGMæ§åˆ¶é¢æ¿ â–¼â–¼â–¼ -->
    <div id="dating-bgm-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>é€‰æ‹©èƒŒæ™¯éŸ³ä¹</span>
        </div>
        <div class="modal-body" style="padding: 15px">
          <!-- æ§åˆ¶æŒ‰é’® -->
          <div
            class="bgm-controls"
            style="display: flex; gap: 10px; margin-bottom: 15px"
          >
            <button
              id="dating-bgm-random-btn"
              class="form-button-secondary"
              style="flex: 1; margin: 0"
            >
              éšæœºæ’­æ”¾
            </button>
            <button
              id="dating-bgm-stop-btn"
              class="form-button-secondary"
              style="
                flex: 1;
                margin: 0;
                background-color: #ffe5e5;
                color: #ff3b30;
                border-color: #ffc2d1;
              "
            >
              åœæ­¢æ’­æ”¾
            </button>
          </div>
          <!-- éŸ³é‡æ§åˆ¶ -->
          <div class="form-group">
            <label for="dating-bgm-volume-slider"
              >éŸ³é‡: <span id="dating-bgm-volume-value">100%</span></label
            >
            <input
              type="range"
              id="dating-bgm-volume-slider"
              min="0"
              max="1"
              step="0.05"
              value="1"
              style="width: 100%"
            />
          </div>
          <hr style="opacity: 0.2" />
          <!-- æ­Œæ›²åˆ—è¡¨ -->
          <div
            id="dating-bgm-playlist"
            class="list-container"
            style="padding: 0; height: calc(100% - 130px)"
          >
            <!-- æ›²åº“å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="save" id="dating-bgm-close-btn" style="width: 100%">
            å…³é—­
          </button>
        </div>
      </div>
    </div>
    <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

    <!-- å€Ÿé’±å¯¹è±¡é€‰æ‹©å¼¹çª—ï¼ˆå¸¦æ»šåŠ¨å’Œå¤´åƒï¼‰ -->
    <div id="borrow-money-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>å‘è°å€Ÿé’±ï¼Ÿ</span>
        </div>
        <div
          class="modal-body"
          id="borrow-money-char-list"
          style="padding: 0; overflow-y: auto"
        >
          <!-- å€Ÿé’±å¯¹è±¡åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="borrow-money-cancel-btn"
            style="width: 100%"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <div id="dating-game-settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>çº¦ä¼šåœºæ™¯è®¾ç½®</span>
        </div>
        <div class="modal-body">
          <!-- é¢„è®¾ç®¡ç† (ä¿æŒä¸å˜) -->
          <div class="form-group">
            <label>é¢„è®¾æ–¹æ¡ˆ</label>
            <div class="bubble-preset-manager">
              <select
                id="dating-preset-select"
                class="form-group select"
              ></select>
              <button id="manage-dating-presets-btn" class="action-btn">
                ç®¡ç†
              </button>
            </div>
          </div>

          <hr style="opacity: 0.2" />

          <!-- ç«‹ç»˜ç»„é€‰æ‹©å™¨-->
          <div class="form-group">
            <label>é€‰æ‹©è§’è‰²ç«‹ç»˜ç»„</label>
            <div class="bubble-preset-manager">
              <select id="dating-sprite-group-select" class="form-group select">
                <option value="">-- ä¸ä½¿ç”¨ç«‹ç»˜ --</option>
                <!-- ç«‹ç»˜ç»„å°†ç”±JSåŠ¨æ€å¡«å…… -->
              </select>
              <button id="manage-sprite-groups-btn" class="action-btn">
                ç®¡ç†ç«‹ç»˜ç»„
              </button>
            </div>
          </div>

          <hr style="opacity: 0.2" />

          <!-- æ ¸å¿ƒè®¾ç½® (ä¿æŒä¸å˜) -->
          <div class="form-group">
            <label for="dating-prompt-input">åœºæ™¯/è§’è‰²æç¤ºè¯ (Prompt)</label>
            <textarea
              id="dating-prompt-input"
              rows="4"
              placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªå‚²å¨‡ä½†å†…å¿ƒæ¸©æŸ”çš„å°‘å¥³ï¼Œåœ¨æµ·è¾¹å¯¹ç”¨æˆ·çš„è¡¨ç™½æ„Ÿåˆ°ä¸çŸ¥æ‰€æª..."
            ></textarea>
          </div>
          <div class="form-group">
            <label for="dating-style-input">æ–‡é£ (Style)</label>
            <textarea
              id="dating-style-input"
              rows="3"
              placeholder="ä¾‹å¦‚ï¼šè¯·ä½¿ç”¨ç»†è…»çš„å¿ƒç†æå†™å’Œä¼˜ç¾çš„é£æ™¯æå†™..."
            ></textarea>
          </div>
          <div class="form-group">
            <label>çº¦ä¼šèƒŒæ™¯å›¾</label>
            <div class="bg-upload-container">
              <button
                class="form-button-secondary"
                onclick="
                  document.getElementById('dating-bg-upload-input').click()
                "
                style="margin-top: 0"
              >
                ä¸Šä¼ å›¾ç‰‡
              </button>
              <input
                type="text"
                id="dating-bg-url-input"
                placeholder="æˆ–ç²˜è´´ç½‘ç»œå›¾ç‰‡URL"
                style="flex-grow: 1"
              />
            </div>
            <input
              type="file"
              id="dating-bg-upload-input"
              accept="image/*"
              hidden
            />
          </div>
          <hr style="opacity: 0.2; margin: 15px 0" />

          <div class="form-group">
            <label>é¢å¤–æŒ‚è½½ä¸–ç•Œä¹¦ (æœ¬æ¬¡çº¦ä¼š)</label>
            <!-- å¤ç”¨ä¸»è®¾ç½®çš„æ ·å¼ï¼Œéå¸¸æ–¹ä¾¿ -->
            <div class="custom-multiselect" id="dating-wb-multiselect">
              <div class="select-box moe-input">
                <span class="selected-options-text"
                  >-- ç‚¹å‡»é€‰æ‹©é¢å¤–ä¸–ç•Œè§‚ --</span
                >
                <span class="arrow-down">â–¼</span>
              </div>
              <!-- æ³¨æ„è¿™ä¸ªå®¹å™¨çš„ ID æ˜¯æ–°çš„ï¼Œé˜²æ­¢å†²çª -->
              <div
                id="dating-wb-checkboxes-container"
                class="checkboxes-container"
              >
                <!-- é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-dating-settings-btn">å–æ¶ˆ</button>
          <button class="save" id="save-dating-settings-btn">åº”ç”¨å¹¶ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- 1. ç«‹ç»˜ç»„ç®¡ç†å¼¹çª— -->
    <div id="sprite-group-manager-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>ç®¡ç†ç«‹ç»˜ç»„</span>
          <span
            class="action-btn"
            id="create-new-sprite-group-btn"
            style="font-size: 16px"
            >æ–°å»º</span
          >
        </div>
        <div
          class="modal-body"
          id="sprite-group-list-container"
          style="padding: 0"
        >
          <!-- ç«‹ç»˜ç»„åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-sprite-group-manager-btn"
            style="width: 100%"
          >
            å®Œæˆ
          </button>
        </div>
      </div>
    </div>

    <!-- 2. ç«‹ç»˜ç»„ç¼–è¾‘å™¨å¼¹çª— -->
    <div id="sprite-editor-modal" class="modal">
      <div class="modal-content" style="height: 90%">
        <div class="modal-header">
          <span id="sprite-editor-title">ç¼–è¾‘ç«‹ç»˜ç»„</span>
        </div>
        <div class="modal-body" id="sprite-editor-body">
          <div class="form-group">
            <label for="sprite-group-name-input">ç«‹ç»˜ç»„åç§°</label>
            <input
              type="text"
              id="sprite-group-name-input"
              placeholder="ä¾‹å¦‚ï¼šæ—¥å¸¸ã€æˆ˜æ–—ã€å®³ç¾..."
            />
          </div>
          <hr style="opacity: 0.2" />
          <label>ç«‹ç»˜åˆ—è¡¨</label>
          <div
            id="sprite-list-editor"
            style="
              display: flex;
              flex-direction: column;
              gap: 15px;
              margin-top: 10px;
            "
          >
            <!-- å•ä¸ªç«‹ç»˜çš„ç¼–è¾‘å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
          <button
            id="add-new-sprite-btn"
            class="form-button form-button-secondary"
            style="margin-top: 20px"
          >
            + æ·»åŠ ä¸€ä¸ªæ–°ç«‹ç»˜
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-sprite-editor-btn">å–æ¶ˆ</button>
          <button class="save" id="save-sprite-editor-btn">ä¿å­˜ç«‹ç»˜ç»„</button>
        </div>
      </div>
    </div>

    <!-- çº¦ä¼šç»“ç®—å¡ç‰‡ -->
    <div id="dating-summary-overlay" class="modal">
      <div class="dating-summary-card">
        <div class="dating-summary-card-inner">
          <!-- å¡ç‰‡æ­£é¢ -->
          <div class="card-front">
            <img id="summary-card-avatar" src="" alt="è§’è‰²å¤´åƒ" />
            <h2 id="summary-card-rating"></h2>
            <p class="summary-card-tip">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹å®Œæ•´çº¦ä¼šè®°å½•</p>
            <div class="summary-card-actions">
              <button id="summary-share-btn">åˆ†äº«ç»™Ta</button>
              <button id="summary-close-btn">å…³é—­</button>
            </div>
          </div>
          <!-- å¡ç‰‡èƒŒé¢ -->
          <div class="card-back">
            <div class="card-back-header">
              <span>å®Œæ•´çº¦ä¼šè®°å½•</span>
              <button id="summary-flip-back-btn">è¿”å›</button>
            </div>
            <div id="summary-card-history" class="card-back-content">
              <!-- çº¦ä¼šå†å²è®°å½•å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <input
      type="file"
      id="dating-summary-image-upload"
      accept="image/*"
      hidden
    />

    <div id="tukey-accounting-screen" class="screen">
      <!-- 1. é¡µé¢å¤´éƒ¨ (ä¿æŒä¸å˜) -->
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span id="tukey-header-title">è®°è´¦ç¾¤èŠ</span>
        <span style="width: 30px"></span>
      </div>

      <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ (ä¿æŒä¸å˜) -->
      <div class="tukey-content">
        <!-- è§†å›¾1: é’±åŒ… (è¿™æ˜¯æˆ‘ä»¬è¦ä¿®æ”¹çš„æ ¸å¿ƒ) -->
        <div id="tukey-wallet-view" class="tukey-view">
          <div id="wallet-summary-card">
            <div class="summary-item net-assets">
              <span class="label">å‡€èµ„äº§</span>
              <span class="value" id="net-assets-value">Â¥ 0.00</span>
            </div>
            <div class="summary-details">
              <div class="summary-item">
                <span class="label">æ€»èµ„äº§</span>
                <span class="value" id="total-assets-value">Â¥ 0.00</span>
              </div>
              <div class="summary-item">
                <span class="label">æ€»è´Ÿå€º</span>
                <span class="value" id="total-liabilities-value">Â¥ 0.00</span>
              </div>
            </div>
          </div>
          <div id="wallet-accounts-list">
            <!-- è´¦æˆ·åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
          <button
            id="add-new-account-fab"
            class="ls-fab-btn"
            title="æ·»åŠ æ–°è´¦æˆ·"
          >
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <line
                x1="12"
                y1="5"
                x2="12"
                y2="19"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
              <line
                x1="5"
                y1="12"
                x2="19"
                y2="12"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>

        <div id="tukey-reports-view" class="tukey-view">
          <!-- 1. æŠ¥è¡¨æ§åˆ¶/ç­›é€‰åŒºåŸŸ -->
          <div class="report-controls">
            <select id="report-account-filter">
              <!-- è´¦æˆ·é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </select>
            <select id="report-month-filter">
              <!-- æœˆä»½é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </select>
            <select id="report-type-filter">
              <option value="daily_details">æ¯æ—¥æ˜ç»†</option>
              <option value="monthly_summary">æœˆåº¦ç»Ÿè®¡</option>
            </select>
          </div>

          <!-- 2. æŠ¥è¡¨å†…å®¹æ˜¾ç¤ºåŒºåŸŸ -->
          <div id="report-display-area">
            <!-- è§†å›¾åˆ‡æ¢å®¹å™¨ -->
            <div id="daily-report-view" class="report-view active">
              <!-- æ¯æ—¥æ˜ç»†å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
              <p class="report-placeholder">æ­£åœ¨åŠ è½½æŠ¥è¡¨...</p>
            </div>
            <div id="monthly-report-view" class="report-view">
              <!-- æœˆåº¦ç»Ÿè®¡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
              <div id="monthly-summary-card">
                <!-- æœˆåº¦æ€»æ”¶æ”¯ -->
              </div>
              <div class="chart-container">
                <h3>æ”¯å‡ºåˆ†ç±»å æ¯”</h3>
                <canvas id="category-pie-chart"></canvas>
              </div>
              <div class="chart-container">
                <h3>æœˆåº¦æ”¯å‡ºè¶‹åŠ¿</h3>
                <canvas id="expenditure-line-chart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div id="tukey-group-chat-view" class="tukey-view active">
          <!-- è¿™ä¸ªå®¹å™¨ä¼šåœ¨æ²¡æœ‰ç¾¤èŠæ—¶æ˜¾ç¤º -->
          <div id="tukey-no-group-placeholder">
            <p>ä½ è¿˜æ²¡æœ‰åˆ›å»ºè®°è´¦ç¾¤èŠå“¦</p>
            <button id="tukey-create-group-btn" class="form-button">
              ç«‹å³åˆ›å»º
            </button>
          </div>

          <div id="tukey-group-chat-container" style="display: none">
            <div id="tukey-group-chat-header">
              <span id="tukey-group-name">ç¾¤èŠåç§°</span>
              <button id="tukey-group-settings-btn" title="ç¾¤èŠè®¾ç½®">âš™ï¸</button>
            </div>

            <!-- è®°è´¦å’Œå›å¤å†å²è®°å½• -->
            <div id="tukey-records-list">
              <!-- JSä¼šåœ¨è¿™é‡Œæ¸²æŸ“å†…å®¹ -->
            </div>

            <!-- è®°è´¦è¾“å…¥åŒºåŸŸ -->
            <div id="tukey-record-input-area">
              <button id="tukey-add-record-btn">+</button>
            </div>

            <div id="tukey-record-input-card">
              <div class="card-header">
                <button class="close-card-btn">Ã—</button>
                <div class="type-selector">
                  <button class="type-btn active" data-type="expense">
                    æ”¯å‡º
                  </button>
                  <button class="type-btn" data-type="income">æ”¶å…¥</button>
                </div>
              </div>
              <div class="card-body">
                <!-- é‡‘é¢å’Œå¤‡æ³¨è¾“å…¥åŒºåŸŸ -->
                <div class="input-fields">
                  <div class="amount-input-wrapper">
                    <span class="currency-symbol">Â¥</span>
                    <input
                      type="number"
                      id="tukey-card-amount-input"
                      placeholder="0.00"
                    />
                    <!-- å·²é€‰åˆ†ç±»æ˜¾ç¤ºåŒº -->
                    <div id="tukey-card-selected-category">
                      <img src="" alt="" />
                      <span>è¯·é€‰æ‹©åˆ†ç±»</span>
                    </div>
                  </div>
                  <input
                    type="text"
                    id="tukey-card-remarks-input"
                    placeholder="ç‚¹å‡»è¾“å…¥å¤‡æ³¨..."
                  />
                </div>
                <!-- åˆ†ç±»ç½‘æ ¼ -->
                <div class="category-grid">
                  <!-- åˆ†ç±»å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
              </div>
              <div class="card-footer">
                <!-- è´¦æˆ·å’Œæ—¶é—´é€‰æ‹©å™¨ -->
                <div class="additional-options">
                  <div class="option-item">
                    <label for="tukey-card-account-select">è´¦æˆ·</label>
                    <select id="tukey-card-account-select">
                      <!-- è´¦æˆ·å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                    </select>
                  </div>
                  <div class="option-item">
                    <label for="tukey-card-time-input">æ—¶é—´</label>
                    <input type="datetime-local" id="tukey-card-time-input" />
                  </div>
                </div>
                <button id="tukey-save-from-card-btn">ä¿ å­˜</button>
              </div>
            </div>
          </div>
        </div>

        <div id="tukey-settings-view" class="tukey-view">
          <div class="form-container" style="padding-top: 20px">
            <!-- 1. ä¸ªäººèµ„æ–™è®¾ç½® -->
            <div class="form-group">
              <label>æˆ‘çš„ä¸ªäººèµ„æ–™</label>
              <div class="avatar-upload">
                <img
                  id="tukey-user-avatar-preview"
                  src="https://i.postimg.cc/PxZrFFFL/o-o-1.jpg"
                />
                <button
                  onclick="
                    document.getElementById('tukey-user-avatar-input').click()
                  "
                >
                  ä¸Šä¼ æˆ‘çš„å¤´åƒ
                </button>
                <input
                  type="file"
                  id="tukey-user-avatar-input"
                  accept="image/*"
                  hidden
                />
              </div>
            </div>
            <div class="form-group">
              <label for="tukey-user-name-input">ç”¨æˆ·å</label>
              <input
                type="text"
                id="tukey-user-name-input"
                placeholder="è¾“å…¥ä½ åœ¨ç¾¤èŠä¸­æ˜¾ç¤ºçš„æ˜µç§°"
              />
            </div>
            <div class="form-group">
              <label for="tukey-user-profession-input">èŒä¸š (é€‰å¡«)</label>
              <input
                type="text"
                id="tukey-user-profession-input"
                placeholder="ä½ çš„èŒä¸šï¼Œä¼šå±•ç¤ºç»™ç¾¤å‹"
              />
            </div>

            <hr style="opacity: 0.2; margin: 20px 0" />

            <!-- 2. åŒæ­¥è®¾ç½® -->
            <div class="form-group">
              <label for="sync-to-taobao-toggle" class="toggle-switch-label">
                <span class="toggle-switch-text">
                  åŒæ­¥è‡³æ¡ƒå®ä½™é¢
                  <p
                    style="
                      font-size: 12px;
                      font-weight: normal;
                      color: #999;
                      margin-top: 5px;
                    "
                  >
                    å¼€å¯åï¼Œæ‰€æœ‰è®°è´¦è®°å½•å°†åŒæ­¥å½±å“æ¡ƒå®çš„ä½™é¢å’Œæ”¶æ”¯æ˜ç»†ã€‚
                  </p>
                </span>
                <input type="checkbox" id="sync-to-taobao-toggle" />
                <span class="toggle-switch-slider"></span>
              </label>
            </div>

            <hr style="opacity: 0.2; margin: 20px 0" />

            <!-- 3. å¯¼å‡ºè®¾ç½® (æ–°å¢) -->
            <div class="form-group">
              <label>æ•°æ®å¯¼å‡º</label>
              <button
                id="export-tukey-report-btn"
                class="form-button form-button-secondary"
              >
                å¯¼å‡ºè´¦å•ä¸º Excel
              </button>
            </div>

            <button class="form-button" id="save-tukey-settings-btn">
              ä¿å­˜æ‰€æœ‰è®¾ç½®
            </button>
          </div>
        </div>
      </div>

      <!-- 3. åº•éƒ¨å¯¼èˆªæ  (ä¿æŒä¸å˜) -->
      <div id="tukey-bottom-nav">
        <div class="tukey-nav-item" data-view="tukey-wallet-view">
          <svg width="24" height="24" viewBox="0 0 1024 1024">
            <path
              d="M517.7 660c-4 26.6-19.2 46.3-37.3 46.3H290.1c-21.2 0-38.4-27-38.4-60.3V435.3c0-33.3 17.2-60.3 38.4-60.3h190.3c17.6 0 32.5 18.7 37 44.1"
              fill="#BAF4EA"
            ></path>
            <path
              d="M668.7 761.8H321.6c-54 0-97.9-43.9-97.9-97.9V419.6c0-54 43.9-97.9 97.9-97.9h347.1c43.8 0 82.6 29.5 94.4 71.6 4.1 14.9-4.6 30.3-19.5 34.5-14.9 4.1-30.3-4.6-34.5-19.5-5-18-21.6-30.6-40.4-30.6H321.6c-23.1 0-41.9 18.8-41.9 41.9v244.3c0 23.1 18.8 41.9 41.9 41.9h347.1c19.5 0 36.3-13.2 40.8-32.2 3.6-15 18.7-24.3 33.7-20.8 15 3.6 24.3 18.7 20.8 33.7-5 21.1-17.1 40.2-34.1 53.8-17.3 13.9-39 21.5-61.2 21.5z"
              fill="#2D5B56"
            ></path>
            <path
              d="M719.9 614.4H641c-39.9 0-72.6-32.7-72.6-72.6 0-39.9 32.7-72.6 72.6-72.6h78.9c39.9 0 72.6 32.7 72.6 72.6 0 39.9-32.7 72.6-72.6 72.6z"
              fill="#BAF4EA"
            ></path>
            <path
              d="M719.9 642.4H641c-55.5 0-100.6-45.1-100.6-100.6 0-55.5 45.1-100.6 100.6-100.6h78.9c55.5 0 100.6 45.1 100.6 100.6 0 55.4-45.2 100.6-100.6 100.6zM641 497.1c-24.6 0-44.6 20-44.6 44.6s20 44.6 44.6 44.6h78.9c24.6 0 44.6-20 44.6-44.6s-20-44.6-44.6-44.6H641z"
              fill="#2D5B56"
            ></path>
            <path
              d="M650.1 542.4m-0.4 0a0.4 0.4 0 1 0 0.8 0 0.4 0.4 0 1 0-0.8 0Z"
              fill="#FFFFFF"
            ></path>
            <path
              d="M650.1 570.8c-15.7 0-28.4-12.7-28.4-28.4s12.7-28.4 28.4-28.4 28.4 12.7 28.4 28.4-12.7 28.4-28.4 28.4z m0-56c-15.2 0-27.6 12.4-27.6 27.6s12.4 27.6 27.6 27.6 27.6-12.4 27.6-27.6-12.4-27.6-27.6-27.6z"
              fill="#2D5B56"
            ></path>
            <path
              d="M155.2 152.2c12 0 21.7 9.7 21.7 21.7s-9.7 21.7-21.7-21.7-21.7-9.7-21.7-21.7 9.7-21.7 21.7-21.7m0-40c-34 0-61.7 27.7-61.7 61.7s27.7 61.7 61.7 61.7 61.7-27.7 61.7-61.7-27.7-61.7-61.7-61.7zM162.7 956.8h-0.2c-8.3-0.1-14.9-6.9-14.8-15.2l1-69.5c0.1-8.2 6.8-14.8 15-14.8h0.2c8.3 0.1 14.9 6.9 14.8 15.2l-1 69.5c-0.1 8.2-6.8 14.8-15 14.8z"
              fill="#2D5B56"
            ></path>
            <path
              d="M212.9 907.5v0.2c-0.1 8.3-6.9 14.9-15.2 14.8l-69.5-1c-8.2-0.1-14.8-6.8-14.8-15v-0.2c0.1-8.3 6.9-14.9 15.2-14.8l69.5 1c8.3 0.2 14.8 6.9 14.8 15z"
              fill="#2D5B56"
            ></path>
            <path
              d="M895.4 905.5m-30.9 0a30.9 30.9 0 1 0 61.8 0 30.9 30.9 0 1 0-61.8 0Z"
              fill="#2D5B56"
            ></path>
            <path
              d="M121.4 613.5m-20.7 0a20.7 20.7 0 1 0 41.4 0 20.7 20.7 0 1 0-41.4 0Z"
              fill="#2D5B56"
            ></path>
            <path
              d="M861.5 115.5v30.8M861.5 156.3c-5.5 0-10-4.5-10-10v-30.8c0-5.5 4.5-10 10-10s10 4.5 10 10v30.8c0 5.5-4.5 10-10 10zM804.8 172.2h30.8M835.6 182.2h-30.8c-5.5 0-10-4.5-10-10s4.5-10 10-10h30.8c5.5 0 10 4.5 10 10s-4.5 10-10 10zM887.4 172.2h30.8M918.2 182.2h-30.8c-5.5 0-10-4.5-10-10s4.5-10 10-10h30.8c5.5 0 10 4.5 10 10s-4.5 10-10 10z"
              fill="#2D5B56"
            ></path>
            <path
              d="M821.4 212.3l21.8-21.8M821.4 222.3c-2.6 0-5.1-1-7.1-2.9-3.9-3.9-3.9-10.2 0-14.1l21.8-21.8c3.9-3.9 10.2-3.9 14.1 0 3.9 3.9 3.9 10.2 0 14.1l-21.8 21.8c-1.8 1.9-4.4 2.9-7 2.9z"
              fill="#2D5B56"
            ></path>
            <path
              d="M879.8 153.9l21.8-21.8M879.8 163.9c-2.6 0-5.1-1-7.1-2.9-3.9-3.9-3.9-10.2 0-14.1l21.8-21.8c3.9-3.9 10.2-3.9 14.1 0 3.9 3.9 3.9 10.2 0 14.1L886.9 161c-2 1.9-4.5 2.9-7.1 2.9z"
              fill="#2D5B56"
            ></path>
            <path
              d="M901.6 212.3l-21.8-21.8M901.6 222.3c-2.6 0-5.1-1-7.1-2.9l-21.8-21.8c-3.9-3.9-3.9-10.2 0-14.1 3.9-3.9 10.2-3.9 14.1 0l21.8 21.8c3.9 3.9 3.9 10.2 0 14.1-1.9 1.9-4.5 2.9-7 2.9z"
              fill="#2D5B56"
            ></path>
            <path
              d="M843.2 153.9l-21.8-21.8M843.2 163.9c-2.6 0-5.1-1-7.1-2.9l-21.8-21.8c-3.9-3.9-3.9-10.2 0-14.1 3.9-3.9 10.2-3.9 14.1 0l21.8 21.8c3.9 3.9 3.9 10.2 0 14.1-1.9 1.9-4.4 2.9-7 2.9z"
              fill="#2D5B56"
            ></path>
          </svg>
          <span>é’±åŒ…</span>
        </div>
        <div class="tukey-nav-item" data-view="tukey-reports-view">
          <svg width="24" height="24" viewBox="0 0 1024 1024">
            <path
              d="M692.24 787.29h-175.3a24.65 24.65 0 0 1 0-49.3h175.3a24.65 24.65 0 0 1 0 49.3z"
              fill="#303030"
              p-id="13093"
            ></path>
            <path
              d="M692.24 186.92v89.18H336.29v463.27h-89.34V186.92h445.29z"
              fill="#279ACC"
              p-id="13094"
            ></path>
            <path
              d="M810.83 869.58H322.21V660.12a24.65 24.65 0 0 1 49.3 0v160.16h390V318.74h-390v148.19a24.65 24.65 0 1 1-49.3 0V269.44h488.62z"
              fill="#303030"
              p-id="13095"
            ></path>
            <path
              d="M346.86 767H225.28V166.87H713.9v127.22a24.65 24.65 0 1 1-49.29 0v-77.93h-390v501.55h72.28a24.65 24.65 0 1 1 0 49.29z"
              fill="#303030"
              p-id="13096"
            ></path>
            <path
              d="M751.63 395.07m-78.65 0a78.65 78.65 0 1 0 157.3 0 78.65 78.65 0 1 0-157.3 0Z"
              fill="#279ACC"
              p-id="13097"
            ></path>
            <path
              d="M317.28 626.59a24.65 24.65 0 0 1-17.42-42.07l89.58-89.59c10.84-10.85 25-16.36 40.58-16.34a55.34 55.34 0 0 1 39.89 18l64.43 69.85 150.17-148a24.65 24.65 0 0 1 34.63 35.08l-150 148.05a49.43 49.43 0 0 1-71-1.66L433.68 530a6.42 6.42 0 0 0-4.65-2.1 5.84 5.84 0 0 0-4.73 1.91l-89.59 89.59a24.58 24.58 0 0 1-17.43 7.19z"
              fill="#303030"
              p-id="13098"
            ></path>
            <path
              d="M751.63 481.75a86.67 86.67 0 1 1 86.67-86.67 86.77 86.77 0 0 1-86.67 86.67z m0-124A37.38 37.38 0 1 0 789 395.08a37.42 37.42 0 0 0-37.37-37.38z"
              fill="#303030"
              p-id="13099"
            ></path>
          </svg>
          <span>æŠ¥è¡¨</span>
        </div>
        <div class="tukey-nav-item active" data-view="tukey-group-chat-view">
          <svg width="24" height="24" viewBox="0 0 1024 1024">
            <path
              d="M134.588 151C118.247 151 105 164.247 105 180.584v557.964c0 16.339 13.255 29.584 29.599 29.584h155.746l31.872 99.6c2.489 7.777 8.981 9.197 14.504 3.169l94.146-102.769h457.72c16.341 0 29.59-13.247 29.59-29.584V180.584c0-16.339-13.248-29.584-29.588-29.584H134.588z"
              fill="#0FC8B2"
              p-id="32320"
            ></path>
            <path
              d="M511.213 422c19.045 0 34.484 15.44 34.484 34.486s-15.44 34.483-34.484 34.483c-19.046 0-34.485-15.438-34.485-34.483 0-19.046 15.439-34.486 34.485-34.486z m-199.727 0c19.046 0 34.483 15.44 34.483 34.486s-15.437 34.483-34.483 34.483S277 475.531 277 456.486C277 437.44 292.44 422 311.486 422z m399.454 0c19.045 0 34.485 15.439 34.485 34.484 0 19.046-15.439 34.483-34.485 34.483-19.045 0-34.485-15.438-34.485-34.483 0-19.045 15.44-34.484 34.485-34.484z"
              fill="#FFFFFF"
              p-id="32321"
            ></path>
          </svg>
          <span>è®°è´¦ç¾¤èŠ</span>
        </div>
        <div class="tukey-nav-item" data-view="tukey-settings-view">
          <svg width="24" height="24" viewBox="0 0 1024 1024">
            <path
              d="M785.749333 564.770133a231.150933 231.150933 0 0 0 47.035734-258.730666l-145.476267 145.442133a41.5744 41.5744 0 0 1-58.811733 0l-55.876267-55.876267a41.5744 41.5744 0 0 1 0-58.811733l145.476267-145.476267a230.843733 230.843733 0 0 0-305.834667 305.664l-263.509333 263.406934a41.5744 41.5744 0 0 0 0 58.811733l55.842133 55.842133a41.5744 41.5744 0 0 0 58.811733 0l263.406934-263.3728a230.638933 230.638933 0 0 0 258.730666-47.069866l0.170667 0.170666z"
              fill="#FFFFFF"
              p-id="33627"
            ></path>
            <path
              d="M435.2 214.084267a264.977067 264.977067 0 0 1 297.028267-53.828267 34.133333 34.133333 0 0 1 10.001066 55.227733l-145.476266 145.442134a7.441067 7.441067 0 0 0 0 10.581333l55.876266 55.842133a7.441067 7.441067 0 0 0 10.5472 0l145.476267-145.476266a34.133333 34.133333 0 0 1 55.227733 10.069333 265.216 265.216 0 0 1-54.033066 296.96 34.474667 34.474667 0 0 1-3.208534 2.833067l-0.238933 0.170666-3.925333 3.822934a264.704 264.704 0 0 1-262.144 57.7536l-5.290667-1.8432-247.5008 247.534933a75.707733 75.707733 0 0 1-102.741333 4.027733l-4.334934-4.027733-55.876266-55.842133a75.707733 75.707733 0 0 1 0-107.1104l247.7056-247.569067-1.809067-5.2224a265.216 265.216 0 0 1 57.719467-262.075733l6.997333-7.2704z m211.285333-7.850667a196.539733 196.539733 0 0 0-163.0208 56.1152 196.983467 196.983467 0 0 0-40.072533 220.535467 34.133333 34.133333 0 0 1-6.9632 38.229333l-263.5776 263.406933a7.441067 7.441067 0 0 0 0 10.513067l55.876267 55.876267a7.441067 7.441067 0 0 0 10.5472 0l263.406933-263.406934a34.133333 34.133333 0 0 1 38.229333-6.929066 196.5056 196.5056 0 0 0 220.501334-40.072534l1.9456-1.7408 4.334933-4.5056a196.8128 196.8128 0 0 0 50.107733-156.672l-1.058133-7.304533-105.301333 105.335467a75.707733 75.707733 0 0 1-102.741334 4.027733l-4.334933-4.027733-55.876267-55.876267a75.707733 75.707733 0 0 1 0-107.076267l105.3696-105.3696-7.3728-1.058133z"
              fill="#222222"
              p-id="33628"
            ></path>
            <path
              d="M284.8768 690.858667a34.133333 34.133333 0 0 1 48.298667 48.264533l-61.781334 61.7472a34.133333 34.133333 0 1 1-48.264533-48.264533l61.781333-61.781334z"
              fill="#009898"
              p-id="33629"
            ></path>
          </svg>
          <span>è®¾ç½®</span>
        </div>
      </div>
    </div>

    <!-- ... </div> æ ‡ç­¾æ¥è‡ª id="tukey-accounting-screen" -->

    <!-- å…”kè®°è´¦å¯¼å‡ºé€‰é¡¹æ¨¡æ€æ¡† -->
    <div id="tukey-export-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 70%">
        <div class="modal-header">
          <span>é€‰æ‹©è¦å¯¼å‡ºçš„è´¦æˆ·</span>
        </div>
        <div class="modal-body">
          <div id="tukey-export-account-list" class="contact-picker-list">
            <!-- è´¦æˆ·åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-tukey-export-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-tukey-export-btn">ç¡®è®¤å¯¼å‡º</button>
        </div>
      </div>
    </div>

    <!-- 1. æŸ¥å²— - è§’è‰²é€‰æ‹©å±å¹• -->
    <div id="kk-char-selection-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>è¦æŸ¥è°çš„å²—ï¼Ÿ</span>
        <span style="width: 30px"></span>
      </div>
      <div id="kk-char-selection-list" class="list-container">
        <!-- è§’è‰²åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- 2. æŸ¥å²— - æˆ¿å±‹æ€»è§ˆå±å¹• -->
    <div id="kk-house-view-screen" class="screen">
      <div id="kk-house-background"></div>
      <div
        class="header"
        style="
          background: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.6),
            transparent
          );
          border-bottom: none;
        "
      >
        <span class="back-btn" id="kk-back-from-house-view">â€¹</span>
        <span id="kk-house-owner-name"></span>
        <!-- æ ‡é¢˜ä¼šè‡ªåŠ¨å±…ä¸­ -->

        <div class="header-actions">
          <!-- è¿™é‡Œåªä¿ç•™â€œç»§ç»­ç¿»æ‰¾â€å’Œâ€œé‡æ–°ç¿»æ‰¾â€ -->
          <span class="action-btn" id="kk-continue-search-btn" title="ç»§ç»­ç¿»æ‰¾">
            <svg
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </span>
          <span class="action-btn" id="kk-reset-search-btn" title="é‡æ–°ç¿»æ‰¾">
            <svg
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
              ></path>
              <path d="M3 3v5h5"></path>
            </svg>
          </span>
        </div>
      </div>
      <div
        id="kk-scene-toolbar"
        style="
          position: absolute;
          top: 110px;
          right: 20px;
          display: flex;
          flex-direction: column;
          gap: 16px;
          z-index: 10;
        "
      >
        <!-- è¡£æŸœæŒ‰é’® -->
        <!-- é‡ç‚¹ä¿®å¤ï¼šåŠ äº† box-shadow: none ç­‰é‡ç½®å±æ€§ï¼Œé˜²æ­¢æ—§æ ·å¼å¹²æ‰° -->
        <div
          id="kk-wardrobe-btn"
          title="æŸ¥çœ‹è¡£æŸœ"
          style="
            width: 48px;
            height: 48px;
            border-radius: 50%;
            /* å¼ºåˆ¶é‡ç½®æ—§æ ·å¼ */
            margin: 0;
            padding: 0;
            /* æ°´æ™¶æœå†»é£æ ¼æ ¸å¿ƒ */
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6); /* å”¯ä¸€ä¿ç•™çš„é«˜å…‰è¾¹æ¡† */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); /* æŸ”å’ŒæŠ•å½± */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #ff9a9e; /* æ¨±èŠ±ç²‰å›¾æ ‡ */
            transition: transform 0.2s;
          "
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="filter: drop-shadow(0 2px 4px rgba(255, 154, 158, 0.3))"
          >
            <path
              d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"
            ></path>
          </svg>
        </div>

        <!-- ç›‘æ§æŒ‰é’® -->
        <div
          id="kk-surveillance-icon"
          title="æŸ¥çœ‹ç›‘æ§"
          style="
            width: 48px;
            height: 48px;
            border-radius: 50%;
            /* å¼ºåˆ¶é‡ç½®æ—§æ ·å¼ */
            position: static;
            top: auto;
            left: auto;
            /* æ°´æ™¶æœå†»é£æ ¼æ ¸å¿ƒ */
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #ff9a9e; /* æ¨±èŠ±ç²‰å›¾æ ‡ */
            transition: transform 0.2s;
          "
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="filter: drop-shadow(0 2px 4px rgba(255, 154, 158, 0.3))"
          >
            <path d="M23 7l-7 5 7 5V7z"></path>
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
          </svg>
        </div>
      </div>

      <div id="kk-house-info-panel">
        <h2 id="kk-house-location"></h2>
        <p id="kk-house-description"></p>
        <div id="kk-house-areas">
          <!-- æˆ¿å±‹åŒºåŸŸæŒ‰é’®å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- 3. æŸ¥å²— - åŒºåŸŸæ¢ç´¢å±å¹• -->
    <div id="kk-area-view-screen" class="screen">
      <div id="kk-area-background"></div>
      <div
        class="header"
        style="
          background: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.6),
            transparent
          );
          border-bottom: none;
        "
      >
        <span class="back-btn" id="kk-back-from-area-view">â€¹</span>
        <span id="kk-area-name"></span>
        <span style="width: 30px"></span>
      </div>
      <div class="kk-item-list-container">
        <h3 id="kk-area-description"></h3>
        <p class="kk-instruction-text">ç‚¹å‡»ä¸‹æ–¹ç‰©å“è¿›è¡Œç¿»æ‰¾ï¼š</p>
        <div id="kk-area-items-grid">
          <!-- å¯ç¿»æ‰¾ç‰©å“å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>
    <!-- kkæŸ¥å²—-ç›‘æ§å±å¹• -->
    <div id="kk-monitor-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="kk-back-from-monitor">â€¹</span>
        <span id="kk-monitor-title">ç›‘æ§ä¸­å¿ƒ</span>
        <div class="header-actions">
          <!-- åˆ·æ–°ç›‘æ§æŒ‰é’®ï¼šç»Ÿä¸€æˆåˆ·æ–°ç®­å¤´ -->
          <span
            class="action-btn"
            id="kk-refresh-monitor-btn"
            title="åˆ·æ–°ç›‘æ§ç”»é¢"
          >
            <svg
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M23 4v6h-6"></path>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
          </span>
        </div>
      </div>
      <div id="kk-monitor-grid" class="list-container">
        <!-- ç›‘æ§ç”»é¢å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <!-- 4. æŸ¥å²— - ç”µè„‘å±å¹• (æ¨¡æ€æ¡†) -->
    <div id="kk-computer-modal" class="modal">
      <div
        class="modal-content"
        style="
          width: 95%;
          height: 90%;
          max-width: 500px;
          background-color: #e0e0e0;
        "
      >
        <div class="modal-header" id="kk-computer-header">
          <span>çš„ç”µè„‘</span>
          <span id="close-kk-computer-modal" style="cursor: pointer">Ã—</span>
        </div>
        <div class="modal-body" id="kk-computer-desktop">
          <!-- ç”µè„‘æ¡Œé¢å›¾æ ‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- 6. æŸ¥å²— - æ–‡ä»¶æµè§ˆå™¨æ¨¡æ€æ¡† -->
    <div id="kk-file-explorer-modal" class="modal" style="z-index: 1003">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>ç§äººæ–‡ä»¶</span>
        </div>
        <div class="modal-body" id="kk-file-list">
          <!-- æ–‡ä»¶åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="close-file-explorer-modal-btn">
            å…³é—­
          </button>
        </div>
      </div>
    </div>
    <!-- KKæŸ¥å²— - æ²‰æµ¸å¼è¡£å¸½é—´å±å¹• -->
    <div id="kk-wardrobe-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="kk-back-from-wardrobe">â€¹</span>
        <span>Taçš„è¡£å¸½é—´</span>
        <div class="header-actions">
          <!-- æ–°å¢ï¼šæ·»åŠ è¡£æœæŒ‰é’® -->
          <span
            class="action-btn"
            id="kk-wardrobe-add-btn"
            title="æ·»ç½®æ–°è¡£"
            style="font-size: 24px; font-weight: 300; margin-right: 10px"
            >+</span
          >
          <span
            class="action-btn"
            id="kk-wardrobe-refresh-btn"
            title="é‡ç½®è¡£æŸœ (æ¸…ç©ºé‡æ¥)"
            >â†»</span
          >
        </div>
      </div>

      <!-- è¡£æŸœä¸»åŒºåŸŸ -->
      <div id="wardrobe-container">
        <!-- å·¦ä¾§/é¡¶éƒ¨ï¼šæ­é…é¢„è§ˆä¸è§’è‰²ç«‹ç»˜åŒº -->
        <div id="wardrobe-preview-area">
          <img id="wardrobe-char-avatar" src="" alt="è§’è‰²" />

          <!-- æ–°å¢ï¼šç”¨äºæ˜¾ç¤ºè§’è‰²å¯¹è¡£æœçœ‹æ³•çš„æ°”æ³¡ (é»˜è®¤æ˜¾ç¤ºæç¤º) -->
          <div
            id="wardrobe-comment-bubble"
            style="
              display: block;
              background: #fff;
              padding: 10px;
              border-radius: 12px;
              margin: 10px;
              font-size: 13px;
              color: #555;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
              min-height: 40px;
              position: relative;
            "
          >
            <span class="content">ç‚¹å‡»ä¸‹é¢çš„è¡£æœï¼Œçœ‹çœ‹æˆ‘æ€ä¹ˆè¯´~</span>
            <!-- å°ä¸‰è§’ -->
            <div
              style="
                position: absolute;
                bottom: -6px;
                left: 20px;
                width: 0;
                height: 0;
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-top: 6px solid #fff;
              "
            ></div>
          </div>

          <!-- è¿™é‡Œçš„æ°”æ³¡ç”¨äºæ˜¾ç¤ºè¯•ç©¿åçš„ååº” (ä¿ç•™åŸæœ‰) -->
          <div id="wardrobe-reaction-bubble" style="display: none">
            <div class="content"></div>
          </div>

          <!-- å½“å‰é€‰ä¸­çš„æ­é…å±•ç¤º -->
          <div id="current-outfit-display">
            <div
              class="outfit-slot"
              data-type="ä¸Šè£…"
              data-placeholder="ä¸Šè¡£"
            ></div>
            <div
              class="outfit-slot"
              data-type="ä¸‹è£…"
              data-placeholder="ä¸‹è£…"
            ></div>
            <div
              class="outfit-slot"
              data-type="é…é¥°"
              data-placeholder="é…é¥°"
            ></div>
            <div
              class="outfit-slot"
              data-type="ç‰¹æ®Š"
              data-placeholder="ç‰¹æ®Š"
            ></div>
          </div>

          <button id="wardrobe-try-on-btn" class="form-button" disabled>
            è®©Taç©¿ä¸Š
          </button>
        </div>

        <!-- å³ä¾§/åº•éƒ¨ï¼šè¡£æœåº“å­˜åˆ—è¡¨ -->
        <div id="wardrobe-inventory-area">
          <div class="wardrobe-tabs">
            <div class="wardrobe-tab active" data-cat="ä¸Šè£…">ä¸Šè£…</div>
            <div class="wardrobe-tab" data-cat="ä¸‹è£…">ä¸‹è£…</div>
            <div class="wardrobe-tab" data-cat="é…é¥°">é…é¥°</div>
            <div class="wardrobe-tab" data-cat="ç‰¹æ®Š">ç‰¹æ®Š</div>
          </div>
          <div id="wardrobe-grid" class="wardrobe-grid">
            <!-- è¡£æœå¡ç‰‡ç”±JSç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>

    <!-- çº¦ä¼šå†å²è®°å½•ç•Œé¢ -->
    <div id="dating-history-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="dating-history-back-btn">â€¹</span>
        <span>å†å²çº¦ä¼š</span>
        <span style="width: 30px"></span>
        <!-- å ä½ç¬¦ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­ -->
      </div>
      <div id="dating-history-list" class="list-container">
        <!-- å†å²çº¦ä¼šå¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <div id="create-dating-scene-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>åˆ›å»ºçº¦ä¼šåœºæ™¯</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="scene-name-input">åœºæ™¯åç§°</label>
            <input
              type="text"
              id="scene-name-input"
              placeholder="ä¾‹å¦‚ï¼šæœˆå…‰ä¸‹çš„æµ·æ»©æ¼«æ­¥"
            />
          </div>
          <div class="form-group">
            <label for="scene-image-url-input">å›¾ç‰‡ URL (å¯é€‰)</label>
            <!-- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ›´æ–°äº† placeholder æç¤ºæ–‡å­— â˜…â˜…â˜… -->
            <input
              type="text"
              id="scene-image-url-input"
              placeholder="ç•™ç©ºåˆ™ç”±AIæ ¹æ®åœºæ™¯åç”Ÿæˆå›¾ç‰‡..."
            />
          </div>
          <div class="form-group">
            <label for="scene-cost-input">èŠ±è´¹ (é‡‘å¸)</label>
            <input
              type="number"
              id="scene-cost-input"
              placeholder="ä¾‹å¦‚ï¼š520"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-create-scene-btn">å–æ¶ˆ</button>
          <button class="save" id="save-custom-scene-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div id="sticker-category-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 70%">
        <div class="modal-header">
          <span>ç§»åŠ¨è¡¨æƒ…åˆ°åˆ†ç±»</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>é€‰æ‹©ä¸€ä¸ªç°æœ‰åˆ†ç±»</label>
            <div
              id="sticker-category-list"
              style="
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 5px;
              "
            >
              <!-- åˆ†ç±»åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
          <p
            style="
              text-align: center;
              color: var(--text-secondary);
              margin: 10px 0;
            "
          >
            æˆ–
          </p>
          <div class="form-group">
            <label for="new-sticker-category-input">åˆ›å»ºä¸€ä¸ªæ–°åˆ†ç±»</label>
            <input
              type="text"
              id="new-sticker-category-input"
              placeholder="è¾“å…¥æ–°åˆ†ç±»çš„åç§°..."
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-sticker-category-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-sticker-category-btn">
            ç¡®è®¤ç§»åŠ¨
          </button>
        </div>
      </div>
    </div>

    <div id="advanced-transfer-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>é«˜çº§å¯¼å…¥ / å¯¼å‡º</span>
        </div>
        <div class="modal-body">
          <h4>é€‰æ‹©è¦å¯¼å‡ºçš„å†…å®¹</h4>

          <!-- App æ•°æ®å¯¼å‡ºåŒº -->
          <div class="form-group">
            <label>å…¨å±€Appæ•°æ® (å¤šé€‰)</label>
            <div
              id="export-apps-list"
              style="
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid var(--border-color);
                padding: 10px;
                border-radius: 8px;
              "
            >
              <!-- App å¤šé€‰æ¡†å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
          </div>

          <!-- è§’è‰²æ•°æ®å¯¼å‡ºåŒº -->
          <div class="form-group">
            <label
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span>è§’è‰²æ•°æ® (å¤šé€‰,qqåŠ¨æ€ä»€ä¹ˆçš„)</span>
              <label
                style="font-size: 13px; font-weight: normal; cursor: pointer"
              >
                <input
                  type="checkbox"
                  id="select-all-characters-checkbox"
                  style="vertical-align: middle; margin-right: 4px"
                />
                å…¨é€‰/å…¨ä¸é€‰
              </label>
            </label>
            <div
              id="export-characters-list"
              style="
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid var(--border-color);
                padding: 10px;
                border-radius: 8px;
              "
            >
              <!-- è§’è‰²å¤šé€‰æ¡†å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
          </div>
          <button id="export-selected-data-btn" class="form-button">
            å¯¼å‡ºé€‰ä¸­é¡¹
          </button>

          <hr style="margin: 20px 0" />

          <h4>å…¼å®¹æ€§æ“ä½œ</h4>
          <p style="font-size: 13px; color: #666">
            ä»å…¶ä»–ç‰ˆæœ¬å¯¼å…¥æ•°æ®ï¼Œæˆ–å°†æ•°æ®å¯¼å‡ºä¸ºå…¼å®¹æ ¼å¼ã€‚
          </p>

          <button
            id="import-from-330-btn"
            class="form-button"
            style="background-color: #28a745; margin-bottom: 10px"
          >
            ğŸ“¥ å…¼å®¹330æ ¼å¼å¯¼å…¥
          </button>

          <button
            id="export-for-330-btn"
            class="form-button"
            style="background-color: #6f42c1"
          >
            ğŸš€ å…¼å®¹330æ•°æ®å¯¼å‡º
          </button>

          <hr style="margin: 20px 0" />

          <h4>å¯¼å…¥è¡¥å……æ•°æ®</h4>
          <p style="font-size: 13px; color: #666">
            å¯¼å…¥å°†ä»¥ã€è¡¥å……å’Œè¦†ç›–ã€‘çš„æ–¹å¼è¿›è¡Œï¼Œä¸ä¼šåˆ é™¤æ‚¨ç°æœ‰çš„å…¶ä»–æ•°æ®ã€‚è¿™å¯ä»¥ç”¨æ¥åˆå¹¶æ•°æ®æˆ–æ¢å¤å•ä¸ªè§’è‰²çš„å¤‡ä»½ã€‚
          </p>
          <button
            id="import-chunked-data-btn"
            class="form-button form-button-secondary"
          >
            é€‰æ‹©æ–‡ä»¶å¹¶å¯¼å…¥
          </button>
          <input
            id="import-chunked-data-input"
            type="file"
            accept="application/json"
            hidden
          />
        </div>
        <div class="modal-footer">
          <button class="cancel" id="close-advanced-transfer-btn">å…³é—­</button>
        </div>
      </div>
    </div>

    <input
      id="import-from-330-input"
      type="file"
      accept="application/json"
      hidden
    />

    <div id="intimacy-panel" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>äº²å¯†å…³ç³»</span>
          <span
            id="close-intimacy-panel"
            class="close-btn"
            style="cursor: pointer"
            >&times;</span
          >
        </div>
        <div class="modal-body" id="intimacy-panel-body">
          <div id="intimacy-display">
            <p>å½“å‰äº²å¯†å€¼</p>
            <h2 id="intimacy-score-display">--</h2>
          </div>
          <div id="intimacy-details">
            <div class="detail-item">
              <span>ğŸ”¥ ç«èŠ±å¤©æ•°</span>
              <span id="intimacy-streak-days">-- å¤©</span>
            </div>
            <div class="detail-item">
              <span>ğŸ’¬ ä»Šæ—¥æ¶ˆæ¯</span>
              <span id="intimacy-today-msgs">-- æ¡</span>
            </div>
            <div class="detail-item">
              <span>ğŸ“ˆ ç´¯è®¡æ¶ˆæ¯</span>
              <span id="intimacy-total-msgs">-- æ¡</span>
            </div>
          </div>
          <div id="intimacy-symbol-unlocks">
            <h3>äº²å¯†å¾½ç« </h3>
            <div id="symbol-list-container">
              <!-- JSä¼šåœ¨è¿™é‡Œç”Ÿæˆæ‰€æœ‰å¯è§£é”çš„å¾½ç«  -->
            </div>
          </div>
          <div id="intimacy-records">
            <h3>è§£é”è®°å½•</h3>
            <div id="unlocked-symbols-record">
              <!-- JSä¼šåœ¨è¿™é‡Œç”Ÿæˆå·²è§£é”å¾½ç« çš„è®°å½• -->
              <p>æš‚æ— è®°å½•</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="studio-screen" class="screen">
      <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>å°å‰§åœº</span>
        <div class="header-actions">
          <span
            class="action-btn"
            id="import-studio-script-btn"
            style="font-size: 14px; margin-right: 5px"
            >å¯¼å…¥</span
          >

          <span class="action-btn" id="add-studio-script-btn">æ–°å¢å‰§æœ¬</span>
          <span class="action-btn" id="studio-history-btn">æ•…äº‹è®°å½•</span>
        </div>
      </div>
      <div id="studio-script-list" class="list-container">
        <!-- å‰§æœ¬åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>

      <input
        type="file"
        id="studio-import-input"
        accept=".json"
        style="display: none"
      />
    </div>

    <!-- 2. å°å‰§åœºå‰§æœ¬ç¼–è¾‘å™¨ -->
    <div id="studio-editor-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-studio-editor">â€¹</span>
        <span id="studio-editor-title">ç¼–è¾‘å‰§æœ¬</span>
        <div class="header-actions">
          <span class="action-btn" id="ai-generate-script-btn">AIè¡¥å……</span>
          <span class="save-btn" id="save-studio-script-btn">ä¿å­˜</span>
        </div>
      </div>
      <div class="form-container">
        <div class="form-group">
          <label for="studio-name-input">å‰§æœ¬åç§°</label>
          <input
            type="text"
            id="studio-name-input"
            placeholder="ç»™ä½ çš„å‰§æœ¬èµ·ä¸ªåå­—..."
          />
        </div>
        <div class="form-group">
          <label for="studio-background-input">æ•…äº‹èƒŒæ™¯</label>
          <textarea
            id="studio-background-input"
            rows="4"
            placeholder="æè¿°æ•…äº‹å‘ç”Ÿçš„æ—¶ä»£ã€åœ°ç‚¹å’ŒåŸºæœ¬æƒ…å¢ƒ..."
          ></textarea>
        </div>
        <div class="form-group">
          <label for="studio-goal-input">æ•…äº‹ç›®æ ‡</label>
          <textarea
            id="studio-goal-input"
            rows="3"
            placeholder="æè¿°è¾¾æˆä»€ä¹ˆæ¡ä»¶ç®—æ¼”ç»æˆåŠŸï¼Œä¾‹å¦‚ï¼šæ‰¾åˆ°çœŸå‡¶ã€æˆåŠŸé€ƒè„±..."
          ></textarea>
        </div>
        <div class="form-group">
          <label for="studio-opening-remark-input">å¼€åœºç™½ (å¯é€‰)</label>
          <textarea
            id="studio-opening-remark-input"
            rows="3"
            placeholder="è¿™æ˜¯å‰§æœ¬å¼€å§‹æ—¶å±•ç¤ºçš„ç¬¬ä¸€æ®µæ–‡å­—ï¼Œç”¨äºè¥é€ æ°›å›´æˆ–å¼•å…¥åœºæ™¯..."
          ></textarea>
        </div>
        <div class="form-group">
          <label for="studio-char1-identity-input">äººç‰©1 èº«ä»½èƒŒæ™¯</label>
          <textarea
            id="studio-char1-identity-input"
            rows="4"
            placeholder="æè¿°äººç‰©1çš„èº«ä»½ã€ä¸ä»–äººçš„å…³ç³»ã€ç§˜å¯†ä»»åŠ¡ç­‰..."
          ></textarea>
        </div>
        <div class="form-group">
          <label for="studio-char2-identity-input">äººç‰©2 èº«ä»½èƒŒæ™¯</label>
          <textarea
            id="studio-char2-identity-input"
            rows="4"
            placeholder="æè¿°äººç‰©2çš„èº«ä»½ã€ä¸ä»–äººçš„å…³ç³»ã€ç§˜å¯†ä»»åŠ¡ç­‰..."
          ></textarea>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px">
          <button
            id="export-studio-script-btn"
            class="form-button form-button-secondary"
            style="flex: 1; margin: 0"
          >
            å¯¼å‡ºå‰§æœ¬
          </button>

          <button
            id="delete-studio-script-btn"
            class="form-button form-button-secondary"
            style="
              background-color: #ff3b30;
              color: white;
              border-color: #ff3b30;
              flex: 1;
              margin: 0;
            "
          >
            åˆ é™¤å‰§æœ¬
          </button>
        </div>
      </div>
    </div>

    <!-- 3. å°å‰§åœºè§’è‰²æ‰®æ¼”ç•Œé¢ -->
    <div id="studio-play-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="exit-studio-play-btn">â€¹</span>
        <span id="studio-play-title">å‰§æœ¬åç§°</span>
        <div class="header-actions">
          <span class="action-btn" id="reroll-studio-play-btn">åˆ·æ–°</span>
        </div>
      </div>
      <div id="studio-play-messages" class="chat-messages">
        <!-- æ¼”ç»è¿‡ç¨‹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
      <div id="studio-play-input-area" class="chat-input-area">
        <div class="chat-input-main-row">
          <textarea
            id="studio-play-input"
            rows="1"
            placeholder="ä½ çš„è¡ŒåŠ¨/å¯¹è¯..."
          ></textarea>
          <button id="send-studio-play-action-btn" class="action-button">
            å‘é€
          </button>
        </div>
      </div>
    </div>

    <!-- 4. è§’è‰²é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="studio-role-selection-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>é€‰æ‹©è§’è‰²ä¸èº«ä»½</span>
        </div>
        <div class="modal-body">
          <!-- è§’è‰²1 -->
          <div class="form-group">
            <label>äººç‰©1</label>
            <p id="studio-role1-desc" class="role-description"></p>
            <!-- æ–°å¢ï¼šç”±è°æ‰®æ¼” -->
            <div class="player-selection-group">
              <label
                ><input type="radio" name="player-role1" value="user" checked />
                ç”±æˆ‘æ‰®æ¼”</label
              >
              <label
                ><input type="radio" name="player-role1" value="ai" />
                ç”±AIæ‰®æ¼”</label
              >
            </div>
            <!-- ä¿®æ”¹ï¼šä¸‹æ‹‰æ¡†ç°åœ¨åªé€‰æ‹©èº«ä»½ -->
            <label
              style="
                font-size: 13px;
                color: var(--text-secondary);
                margin-top: 10px;
              "
              >ä½¿ç”¨æ­¤èº«ä»½:</label
            >
            <select id="studio-role1-identity-select"></select>
          </div>

          <hr style="opacity: 0.2; margin: 15px 0" />

          <!-- è§’è‰²2 -->
          <div class="form-group">
            <label>äººç‰©2</label>
            <p id="studio-role2-desc" class="role-description"></p>
            <!-- æ–°å¢ï¼šç”±è°æ‰®æ¼” -->
            <div class="player-selection-group">
              <label
                ><input type="radio" name="player-role2" value="user" />
                ç”±æˆ‘æ‰®æ¼”</label
              >
              <label
                ><input type="radio" name="player-role2" value="ai" />
                ç”±AIæ‰®æ¼”</label
              >
            </div>
            <!-- ä¿®æ”¹ï¼šä¸‹æ‹‰æ¡†ç°åœ¨åªé€‰æ‹©èº«ä»½ -->
            <label
              style="
                font-size: 13px;
                color: var(--text-secondary);
                margin-top: 10px;
              "
              >ä½¿ç”¨æ­¤èº«ä»½:</label
            >
            <select id="studio-role2-identity-select"></select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-role-selection-btn">å–æ¶ˆ</button>
          <button class="save" id="confirm-role-selection-btn">è¿›å…¥å‰§æœ¬</button>
        </div>
      </div>
    </div>

    <!-- 5. æ¼”ç»æˆåŠŸ/ç»“æŸæ¨¡æ€æ¡† -->
    <div id="studio-summary-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span id="studio-summary-title">æ¼”ç»æˆåŠŸï¼</span>
        </div>
        <div
          class="modal-body"
          id="studio-summary-content"
          style="white-space: pre-wrap; line-height: 1.7"
        >
          <!-- æ•…äº‹ç›®æ ‡å’Œæ€»ç»“å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="generate-novel-btn">ç”Ÿæˆå°è¯´</button>
          <button class="save" id="close-studio-summary-btn">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- 6. å°è¯´åˆ†äº«æ¨¡æ€æ¡† -->
    <div id="studio-novel-share-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span>ç”Ÿæˆçš„å°è¯´</span>
        </div>
        <div
          class="modal-body"
          id="studio-novel-content"
          style="
            white-space: pre-wrap;
            line-height: 1.7;
            text-align: left;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
          "
        >
          <!-- å°è¯´å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="share-novel-btn">åˆ†äº«ç»™è§’è‰²</button>
          <button class="save" id="close-novel-share-btn">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- å°å‰§åœº - æ•…äº‹è®°å½•å±å¹• -->
    <div id="studio-history-screen" class="screen">
      <div class="header">
        <span class="back-btn" id="back-from-studio-history">â€¹</span>
        <span>æ•…äº‹è®°å½•</span>
        <span style="width: 30px"></span>
        <!-- å ä½ç¬¦ -->
      </div>
      <div id="studio-history-list" class="list-container">
        <!-- æ•…äº‹è®°å½•åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <div id="account-editor-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 85%">
        <div class="modal-header">
          <span id="account-editor-title">æ·»åŠ æ–°è´¦æˆ·</span>
        </div>
        <div class="modal-body">
          <!-- æ ¸å¿ƒä¿®æ”¹1ï¼šè¿™æ˜¯å…¨æ–°çš„è´¦æˆ·ç±»å‹é€‰æ‹©è§†å›¾ï¼Œé»˜è®¤éšè— -->
          <div id="account-type-selection-view">
            <!-- JSä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆæ‰€æœ‰è´¦æˆ·ç±»å‹ -->
          </div>

          <!-- æ ¸å¿ƒä¿®æ”¹2ï¼šå°†åŸæœ‰çš„è¡¨å•åŒ…è£¹èµ·æ¥ï¼Œé»˜è®¤éšè— -->
          <div id="account-editor-form" style="display: none">
            <div class="form-group">
              <label for="account-category-select">è´¦æˆ·å¤§ç±»</label>
              <select id="account-category-select"></select>
            </div>
            <div class="form-group">
              <label for="account-type-select">è´¦æˆ·ç±»å‹</label>
              <select id="account-type-select"></select>
            </div>
            <div class="form-group">
              <label for="account-name-input">è´¦æˆ·åç§°</label>
              <input
                type="text"
                id="account-name-input"
                placeholder="ä¾‹å¦‚ï¼šå·¥èµ„å¡, é›¶é’±"
              />
            </div>
            <div class="form-group">
              <label for="account-balance-input">è´¦æˆ·ä½™é¢</label>
              <input
                type="number"
                id="account-balance-input"
                placeholder="0.00"
              />
            </div>
            <div class="form-group">
              <label for="account-remarks-input">å¤‡æ³¨ (å¯é€‰)</label>
              <textarea id="account-remarks-input" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-account-editor-btn">å–æ¶ˆ</button>
          <!-- ä¿å­˜æŒ‰é’®åˆå§‹æ—¶éšè—ï¼Œé€‰æ‹©ç±»å‹åæ˜¾ç¤º -->
          <button class="save" id="save-account-btn" style="display: none">
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>

    <!-- 1. åˆ›å»º/ç®¡ç†è®°è´¦ç¾¤èŠçš„å¼¹çª— (æ·»åŠ è§£æ•£æŒ‰é’®) -->
    <div id="tukey-group-manager-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span id="tukey-group-manager-title">åˆ›å»ºè®°è´¦ç¾¤èŠ</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="tukey-group-name-input">ç¾¤èŠåç§°</label>
            <input
              type="text"
              id="tukey-group-name-input"
              placeholder="ç»™ä½ çš„ç¾¤èŠèµ·ä¸ªåå§"
            />
          </div>
          <div class="form-group">
            <label>é€‰æ‹©ç¾¤æˆå‘˜ (å‹¾é€‰=æ‹‰äººï¼Œå–æ¶ˆå‹¾é€‰=è¸¢äºº)</label>
            <div id="tukey-member-picker-list" class="contact-picker-list">
              <!-- è§’è‰²åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <!-- è§£æ•£æŒ‰é’® (é»˜è®¤éšè—) -->
          <button
            class="form-button-secondary"
            id="tukey-disband-group-btn"
            style="
              background-color: #ffe5e5;
              color: #ff3b30;
              border-color: #ffc2d1;
              display: none;
              margin-right: auto;
            "
          >
            è§£æ•£ç¾¤èŠ
          </button>

          <button class="cancel" id="tukey-cancel-group-manager-btn">
            å–æ¶ˆ
          </button>
          <button class="save" id="tukey-save-group-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- 2. ç¾¤èŠAIå›å¤è®¾ç½®çš„å¼¹çª— -->
    <div id="tukey-reply-settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>AIå›å¤è®¾ç½®</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="tukey-reply-threshold-input"
              >æ¯è®°è´¦ ____ æ¡åï¼ŒAIè¿›è¡Œå›å¤ï¼š</label
            >
            <input
              type="number"
              id="tukey-reply-threshold-input"
              min="1"
              value="1"
            />
          </div>
          <hr style="opacity: 0.2" />
          <div class="form-group">
            <label>é€‰æ‹©å›å¤æ¨¡å¼ï¼š</label>
            <div
              class="theme-selector"
              style="flex-direction: column; align-items: flex-start; gap: 10px"
            >
              <label
                ><input
                  type="radio"
                  name="tukey-reply-mode"
                  value="all"
                  checked
                />
                æ‰€æœ‰æˆå‘˜éƒ½å›å¤</label
              >
              <label
                ><input type="radio" name="tukey-reply-mode" value="random" />
                éšæœºé€‰æ‹©æˆå‘˜å›å¤</label
              >
              <label
                ><input type="radio" name="tukey-reply-mode" value="specific" />
                æŒ‡å®šæˆå‘˜å›å¤</label
              >
            </div>
          </div>
          <div id="tukey-specific-reply-options" style="display: none">
            <div class="form-group">
              <label for="tukey-random-count-input"
                >éšæœºå›å¤äººæ•° (å½“é€‰æ‹©â€œéšæœºâ€æ—¶):</label
              >
              <input
                type="number"
                id="tukey-random-count-input"
                min="1"
                value="2"
              />
            </div>
            <div class="form-group">
              <label>æŒ‡å®šå›å¤çš„æˆå‘˜ (å½“é€‰æ‹©â€œæŒ‡å®šâ€æ—¶):</label>
              <div
                id="tukey-specific-member-picker-list"
                class="contact-picker-list"
                style="max-height: 150px"
              >
                <!-- æˆå‘˜åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="tukey-cancel-reply-settings-btn">
            å–æ¶ˆ
          </button>
          <button class="save" id="tukey-save-reply-settings-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- 3. æ–°å»º/ç¼–è¾‘è®°è´¦è®°å½•çš„å¼¹çª— -->
    <div id="tukey-record-editor-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 90%">
        <div class="modal-header">
          <span id="tukey-record-editor-title">è®°ä¸€ç¬”</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>ç±»å‹</label>
            <div class="tukey-type-selector">
              <button class="type-btn active" data-type="expense">æ”¯å‡º</button>
              <button class="type-btn" data-type="income">æ”¶å…¥</button>
            </div>
          </div>
          <div class="form-group">
            <label for="tukey-record-amount-input">é‡‘é¢</label>
            <input
              type="number"
              id="tukey-record-amount-input"
              placeholder="0.00"
            />
          </div>
          <div class="form-group">
            <label for="tukey-record-category-select">åˆ†ç±»</label>
            <select id="tukey-record-category-select">
              <!-- åˆ†ç±»å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </select>
          </div>
          <div class="form-group">
            <label for="tukey-record-account-select">è´¦æˆ·</label>
            <select id="tukey-record-account-select">
              <!-- è´¦æˆ·å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </select>
          </div>
          <div class="form-group">
            <label for="tukey-record-time-input">æ—¶é—´</label>
            <input type="datetime-local" id="tukey-record-time-input" />
          </div>
          <div class="form-group">
            <label for="tukey-record-remarks-input">å¤‡æ³¨ (å¯é€‰)</label>
            <textarea id="tukey-record-remarks-input" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="tukey-cancel-record-editor-btn">
            å–æ¶ˆ
          </button>
          <button class="save" id="tukey-save-record-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- 4. æŸ¥å²— - ç”µè„‘å±å¹• (æ¨¡æ€æ¡†) -->
    <div id="kk-computer-modal" class="modal">
      <div
        class="modal-content"
        style="
          width: 95%;
          height: 90%;
          max-width: 500px;
          background-color: #e0e0e0;
          background-image: url(&quot;https://i.postimg.cc/k495F4W5/profile-banner.jpg&quot;);
          background-size: cover;
          background-position: center;
        "
      >
        <div
          class="modal-header"
          id="kk-computer-header"
          style="
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            text-shadow: 0 1px 2px black;
          "
        >
          <span>çš„ç”µè„‘</span>
          <span id="close-kk-computer-modal" style="cursor: pointer">Ã—</span>
        </div>
        <div class="modal-body" id="kk-computer-desktop">
          <!-- ç”µè„‘æ¡Œé¢å›¾æ ‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- 6. æŸ¥å²— - æ–‡ä»¶æµè§ˆå™¨æ¨¡æ€æ¡† -->
    <div id="kk-file-explorer-modal" class="modal" style="z-index: 1003">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>ç§äººæ–‡ä»¶</span>
        </div>
        <div class="modal-body" id="kk-file-list">
          <!-- æ–‡ä»¶åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="close-file-explorer-modal-btn">
            å…³é—­
          </button>
        </div>
      </div>
    </div>
    <!-- â€œkkæŸ¥å²—â€æ–‡ä»¶æŸ¥çœ‹å™¨å¼¹çª—-->
    <div id="kk-file-viewer-modal" class="modal" style="z-index: 1004">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="kk-file-viewer-title"></span>
          <span
            id="close-kk-file-viewer-btn"
            style="cursor: pointer; font-size: 24px"
            >&times;</span
          >
        </div>
        <div
          class="modal-body"
          style="padding: 15px; background-color: #f0f2f5; overflow-y: auto"
        >
          <!-- ä½¿ç”¨ <pre> æ ‡ç­¾å¯ä»¥æ›´å¥½åœ°ä¿ç•™åŸæ–‡çš„æ¢è¡Œå’Œæ ¼å¼ -->
          <pre
            id="kk-file-viewer-content"
            style="
              white-space: pre-wrap;
              word-wrap: break-word;
              font-family: inherit;
              font-size: 14px;
            "
          ></pre>
        </div>
      </div>
    </div>
    <!-- Steamæ¸¸æˆåº“å¼¹çª— â–¼â–¼â–¼ -->
    <div id="kk-steam-modal" class="modal" style="z-index: 1003">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>Steam æ¸¸æˆåº“</span>
          <div class="header-actions">
            <span
              class="action-btn"
              id="kk-generate-more-games-btn"
              title="ç”Ÿæˆæ›´å¤šæ¸¸æˆ"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </span>
          </div>
        </div>
        <div class="modal-body" id="kk-steam-games-list">
          <!-- æ¸¸æˆåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="close-kk-steam-modal-btn">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- å¿«æ·å›å¤ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="quick-reply-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>å¿«æ·å›å¤</span>
          <div class="header-actions">
            <!-- é¡¶éƒ¨æ“ä½œæŒ‰é’® -->
            <span
              class="action-btn"
              id="import-quick-reply-btn"
              title="å¯¼å…¥"
              style="font-size: 14px"
              >å¯¼å…¥</span
            >
            <span
              class="action-btn"
              id="export-quick-reply-btn"
              title="å¯¼å‡º"
              style="font-size: 14px"
              >å¯¼å‡º</span
            >
            <span
              class="action-btn"
              id="add-quick-reply-btn"
              style="font-size: 24px"
              >+</span
            >
          </div>
        </div>
        <div
          class="modal-body"
          id="quick-reply-list"
          style="padding: 0; overflow-y: auto"
        >
          <!-- åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-footer">
          <button class="save" id="close-quick-reply-btn" style="width: 100%">
            å…³é—­
          </button>
        </div>
      </div>
    </div>
    <!-- éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨ -->
    <input type="file" id="import-quick-reply-input" accept=".json" hidden />

    <!-- æ—¶é—´è½´/å­˜æ¡£ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="branching-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>æ—¶é—´è½´ç®¡ç†</span>
          <div class="header-actions">
            <button
              id="create-branch-btn"
              class="action-button"
              style="font-size: 14px"
            >
              + æ–°å­˜æ¡£
            </button>
          </div>
        </div>
        <div
          class="modal-body"
          style="padding: 0; display: flex; flex-direction: column"
        >
          <!-- é¡¶éƒ¨æ“ä½œåŒº -->
          <div
            style="
              padding: 15px;
              border-bottom: 1px solid var(--border-color);
              text-align: center;
            "
          >
            <button
              id="restart-chat-btn"
              class="form-button"
              style="background-color: #ff9800; color: white; margin-bottom: 0"
            >
              ğŸ”„ é‡å¼€æ–°å‰§æƒ… (æ¸…ç©ºå½“å‰)
            </button>
            <p
              style="
                font-size: 12px;
                color: #999;
                margin-top: 8px;
                margin-bottom: 0;
              "
            >
              é‡å¼€å‰å»ºè®®å…ˆç‚¹å‡»å³ä¸Šè§’ä¿å­˜å½“å‰è¿›åº¦
            </p>
          </div>

          <!-- å­˜æ¡£åˆ—è¡¨ -->
          <div
            id="branch-list"
            class="list-container"
            style="flex-grow: 1; background-color: var(--secondary-bg)"
          >
            <!-- å­˜æ¡£é¡¹å°†ç”±JSç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-branching-modal-btn"
            style="width: 100%"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>
    <!-- KKæŸ¥å²—ç‰©å“è¯¦æƒ…ä¸“ç”¨å¼¹çª— -->
    <div id="kk-item-share-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 80%">
        <div class="modal-header">
          <span id="kk-item-share-title">ç‰©å“è¯¦æƒ…</span>
        </div>
        <!-- å†…å®¹æ˜¾ç¤ºåŒº -->
        <div class="modal-body" style="padding: 15px">
          <div
            id="kk-item-share-content"
            style="
              text-align: left;
              white-space: pre-wrap;
              background: #f9f9f9;
              padding: 15px;
              border-radius: 8px;
              font-size: 14px;
              line-height: 1.6;
              border: 1px solid #eee;
              color: #333;
            "
          ></div>
        </div>
        <!-- æŒ‰é’®åŒº -->
        <div class="modal-footer" style="display: flex; gap: 10px">
          <button
            class="form-button-secondary"
            id="kk-item-share-close-btn"
            style="flex: 1; margin: 0"
          >
            å…³é—­
          </button>
          <button
            class="form-button"
            id="kk-item-share-confirm-btn"
            style="
              flex: 1;
              margin: 0;
              background-color: #ff9800;
              border-color: #ff9800;
            "
          >
            ğŸ“¤ åˆ†äº«ç»™Ta
          </button>
        </div>
      </div>
    </div>
    <!-- ç•ªèŒ„é’Ÿæš‚åœä¼‘æ¯èŠå¤©å¼¹çª— -->
    <div id="pomodoro-break-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>â˜• ä¼‘æ¯æ—¶é—´</span>
          <span
            id="close-pomodoro-break-btn"
            style="cursor: pointer; font-size: 20px"
            >Ã—</span
          >
        </div>
        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
        <div class="modal-body" id="pomodoro-break-messages">
          <div
            style="
              text-align: center;
              color: #999;
              font-size: 13px;
              margin-top: 10px;
            "
          >
            ç´¯äº†å—ï¼Ÿå’Œæˆ‘èŠèŠå§~
          </div>
        </div>
        <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
        <div class="chat-input-area">
          <div class="chat-input-main-row">
            <textarea
              id="pomodoro-break-input"
              rows="1"
              placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
            ></textarea>
            <button id="pomodoro-break-send-btn" class="action-button">
              å‘é€
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- æƒ…ä¾£å¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="couple-avatar-library-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>æƒ…ä¾£å¤´åƒåº“</span>
          <button id="add-couple-avatar-btn" class="action-button">æ·»åŠ </button>
        </div>
        <div class="modal-body" style="padding: 15px; background: #f5f5f5">
          <div
            id="couple-avatar-library-list"
            style="display: flex; flex-direction: column; gap: 15px"
          >
            <!-- æƒ…å¤´åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-couple-avatar-library-btn"
            style="width: 100%"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>
    <!-- æ›¿æ¢åŸæ¥çš„ id="add-couple-avatar-modal" -->
    <div id="add-couple-avatar-modal" class="modal" style="z-index: 1002">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>æ·»åŠ æƒ…ä¾£å¤´åƒ</span>
        </div>
        <div class="modal-body">
          <div
            class="moe-grid-row"
            style="
              margin-bottom: 15px;
              display: flex;
              justify-content: space-around;
            "
          >
            <!-- ä½ çš„å¤´åƒ -->
            <div class="form-group" style="text-align: center; width: 45%">
              <label style="font-size: 12px; color: #666">æˆ‘çš„å¤´åƒ</label>
              <div
                class="avatar-upload"
                style="width: 80px; height: 80px; margin: 5px auto"
              >
                <img
                  id="new-couple-my-avatar-preview"
                  src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png"
                  style="
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    border-radius: 12px;
                    border: 1px dashed #ccc;
                  "
                />
                <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
                <input
                  type="file"
                  id="new-couple-my-avatar-input"
                  accept="image/*"
                  hidden
                />
              </div>
              <!-- è¿™é‡Œçš„æŒ‰é’®ç°åœ¨æœ‰ ID äº† -->
              <button
                id="upload-couple-my-btn"
                class="moe-btn-mini"
                style="width: 100%"
              >
                ä¸Šä¼ /URL
              </button>
            </div>

            <!-- å¯¹æ–¹å¤´åƒ -->
            <div class="form-group" style="text-align: center; width: 45%">
              <label style="font-size: 12px; color: #666">å¯¹æ–¹å¤´åƒ</label>
              <div
                class="avatar-upload"
                style="width: 80px; height: 80px; margin: 5px auto"
              >
                <img
                  id="new-couple-char-avatar-preview"
                  src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png"
                  style="
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    border-radius: 12px;
                    border: 1px dashed #ccc;
                  "
                />
                <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
                <input
                  type="file"
                  id="new-couple-char-avatar-input"
                  accept="image/*"
                  hidden
                />
              </div>
              <!-- è¿™é‡Œçš„æŒ‰é’®ç°åœ¨æœ‰ ID äº† -->
              <button
                id="upload-couple-char-btn"
                class="moe-btn-mini"
                style="width: 100%"
              >
                ä¸Šä¼ /URL
              </button>
            </div>
          </div>

          <div class="form-group">
            <label>æƒ…å¤´æè¿° (é‡è¦ï¼šAIå°†æ ¹æ®æ­¤æè¿°é€‰æ‹©å¤´åƒ)</label>
            <textarea
              id="new-couple-desc-input"
              rows="3"
              class="moe-input"
              placeholder="ä¾‹å¦‚ï¼šç”œèœœçš„æ‹¥æŠ±ï¼Œæˆ‘åœ¨å·¦è¾¹æŠ±ç€ä½ ..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-add-couple-avatar-btn">å–æ¶ˆ</button>
          <button class="save" id="save-couple-avatar-btn">ä¿å­˜</button>
        </div>
      </div>
    </div>
    <!-- â˜…â˜…â˜… æ–°å¢ï¼šè·¯äººå¤´åƒåº“ç®¡ç†å¼¹çª— â˜…â˜…â˜… -->
    <div id="passerby-avatar-manager-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>è·¯äººå¤´åƒåº“ (<span id="passerby-count">0</span>)</span>
          <div class="header-actions">
            <button
              id="bulk-add-passerby-btn"
              class="action-button"
              style="font-size: 14px"
            >
              æ‰¹é‡æ·»åŠ 
            </button>
          </div>
        </div>
        <div
          class="modal-body"
          style="padding: 15px; background-color: #f5f5f5"
        >
          <div
            id="passerby-avatar-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
              gap: 10px;
            "
          >
            <!-- JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-passerby-manager-btn"
            style="width: 100%"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>
    <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ æ§ä»¶ -->
    <input
      type="file"
      id="passerby-upload-input"
      accept="image/*"
      multiple
      hidden
    />

    <div id="bug-report-modal" class="modal">
      <div class="modal-content" style="height: 70%; max-height: 600px">
        <!-- å¤´éƒ¨ -->
        <div class="modal-header">
          <span>ğŸ© æŠ¥é”™æ€¥æ•‘ç«™</span>
          <button
            class="nurse-btn nurse-btn-clear"
            onclick="window.clearBugReport()"
          >
            ğŸ§¹ æ¸…æ‰«
          </button>
        </div>

        <!-- å†…å®¹åŒº -->
        <div
          class="modal-body"
          style="
            padding: 15px;
            background: #fff0f6;
            display: flex;
            flex-direction: column;
          "
        >
          <p style="font-size: 12px; color: #eb2f96; margin-bottom: 5px">
            ğŸ‘‡ å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·å¤åˆ¶ä¸‹æ–¹çš„çº¢å­—å‘ç»™å¼€å‘è€…ï¼š
          </p>
          <textarea id="error-log-viewer" readonly></textarea>
        </div>

        <!-- åº•éƒ¨æŒ‰é’® -->
        <div
          class="modal-footer"
          style="background: #fff0f6; justify-content: space-between"
        >
          <button
            class="nurse-btn nurse-btn-close"
            onclick="window.closeBugStation()"
          >
            å…³ é—­
          </button>
          <button
            class="nurse-btn nurse-btn-copy"
            onclick="window.copyBugReport()"
          >
            ğŸ“‹ ä¸€é”®å¤åˆ¶æŠ¥é”™
          </button>
        </div>
      </div>
    </div>
    <!-- [æ–°] èŒç³»ç•ªèŒ„é’ŸéŸ³ä¹æ§åˆ¶é¢æ¿ -->
    <div id="pomodoro-music-modal" class="modal">
      <div
        class="modal-content moe-music-modal-content"
        style="height: 65%; width: 320px; padding: 0"
      >
        <!-- å¤´éƒ¨ -->
        <div class="moe-music-header">
          <span>âœ¨ ä¸“æ³¨æ—‹å¾‹ âœ¨</span>
        </div>

        <div
          class="modal-body"
          style="
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
          "
        >
          <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šå”±ç‰‡æœºæ’­æ”¾å™¨ -->
          <div class="pomo-player-container">
            <div class="pomo-disc-wrapper">
              <div id="pomo-disc-anim" class="pomo-disc">
                <!-- å°é¢å›¾ -->
                <img
                  id="pomo-music-cover"
                  src="https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png"
                />
              </div>
            </div>

            <div class="pomo-track-info">
              <h3 id="pomo-music-title">æœªæ’­æ”¾</h3>
              <p id="pomo-music-artist">ç‚¹å‡»æ’­æ”¾å¼€å§‹ä¸“æ³¨</p>
            </div>

            <div class="pomo-controls-row">
              <button class="pomo-ctrl-btn" id="pomo-music-prev" title="ä¸Šä¸€é¦–">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polygon points="19 20 9 12 19 4 19 20"></polygon>
                  <line x1="5" y1="19" x2="5" y2="5"></line>
                </svg>
              </button>

              <button class="pomo-play-btn" id="pomo-music-play">
                <!-- æ’­æ”¾å›¾æ ‡ -->
                <svg
                  id="pomo-icon-play"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  stroke="none"
                >
                  <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                <!-- æš‚åœå›¾æ ‡ (é»˜è®¤éšè—) -->
                <svg
                  id="pomo-icon-pause"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  stroke="none"
                  style="display: none"
                >
                  <rect x="6" y="4" width="4" height="16"></rect>
                  <rect x="14" y="4" width="4" height="16"></rect>
                </svg>
              </button>

              <button class="pomo-ctrl-btn" id="pomo-music-next" title="ä¸‹ä¸€é¦–">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polygon points="5 4 15 12 5 20 5 4"></polygon>
                  <line x1="19" y1="5" x2="19" y2="19"></line>
                </svg>
              </button>
            </div>
          </div>

          <!-- ä¸‹åŠéƒ¨åˆ†ï¼šæ’­æ”¾åˆ—è¡¨ -->
          <div id="pomo-music-list" class="pomo-playlist">
            <!-- JSç”Ÿæˆåˆ—è¡¨é¡¹ -->
          </div>
        </div>

        <div class="modal-footer" style="border: none; padding: 10px 20px 20px">
          <button
            class="save"
            id="close-pomo-music-modal"
            style="
              width: 100%;
              border-radius: 20px;
              background: #e0e0e0;
              color: #666;
              border: none;
            "
          >
            æ”¶èµ·é¢æ¿
          </button>
        </div>
      </div>
    </div>
    <!-- åœ¨ body ç»“æŸæ ‡ç­¾å‰ï¼Œå…¶ä»– modal çš„æ—è¾¹æ·»åŠ  -->

    <!-- æƒ…ä¾£ç©ºé—´-ç…§ç‰‡è¯¦æƒ…ä¸è¯„è®ºå¼¹çª— (èŒç³»å‡çº§ç‰ˆ) -->
    <div id="ls-photo-detail-modal" class="modal">
      <div class="modal-content ls-photo-modal-content">
        <!-- 1. é¡¶éƒ¨æ ‡é¢˜æ  -->
        <div class="ls-photo-modal-header">
          <span>âœ¨ ç”œèœœç¬é—´ âœ¨</span>
          <span id="ls-photo-detail-close-btn" class="close-btn">Ã—</span>
        </div>

        <!-- 2. ä¸­é—´æ»šåŠ¨åŒºåŸŸ -->
        <div class="ls-photo-modal-body">
          <!-- å›¾ç‰‡å±•ç¤ºåŒº (ç±»ä¼¼æ‹ç«‹å¾—é£æ ¼) -->
          <div class="ls-polaroid-container">
            <div class="ls-photo-wrapper">
              <img id="ls-photo-detail-img" src="" alt="ç…§ç‰‡" />
            </div>
            <div id="ls-photo-detail-desc" class="ls-photo-desc"></div>
            <div id="ls-photo-detail-meta" class="ls-photo-date"></div>
          </div>

          <!-- è¯„è®ºåŒºæ ‡é¢˜ -->
          <div class="ls-comments-section-title">
            <span class="icon">ğŸ’¬</span> æ‚„æ‚„è¯
          </div>

          <!-- è¯„è®ºåˆ—è¡¨ -->
          <div id="ls-photo-comments-list" class="ls-comments-list">
            <!-- JSç”Ÿæˆè¯„è®º -->
          </div>
        </div>

        <!-- 3. åº•éƒ¨è¾“å…¥æ  -->
        <div class="ls-photo-modal-footer">
          <input
            type="text"
            id="ls-photo-comment-input"
            placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•( â€¢Ì€ Ï‰ â€¢Ì )âœ§..."
          />
          <button id="ls-photo-comment-send-btn">å‘é€</button>
        </div>
      </div>
    </div>
    <!-- æƒ…ä¾£ç©ºé—´ - åˆ†äº«è¯¦æƒ…ä¸“ç”¨å¼¹çª— (Ver 2.0 èŒç³»ç‰ˆ) -->
    <div id="ls-share-detail-modal" class="modal">
      <div class="modal-content ls-share-card-container">
        <!-- 1. é¡¶éƒ¨è£…é¥°åŒº -->
        <div class="ls-share-header-bg"></div>

        <!-- 2. å¤´åƒä¸å¾½ç«  (æ ¸å¿ƒè§†è§‰) -->
        <div class="ls-share-avatar-wrapper">
          <img id="ls-share-char-avatar" src="" class="ls-share-avatar-img" />
          <!-- ç±»å‹å¾½ç«  -->
          <div class="ls-share-badge" id="ls-share-badge-icon">ğŸ¬</div>
        </div>

        <!-- 3. å†…å®¹åŒºåŸŸ -->
        <div class="ls-share-content-body">
          <!-- æ¨èè¯­æ°”æ³¡ (åƒæ˜¯åœ¨è¯´è¯) -->
          <div class="ls-share-speech-bubble">
            <div class="bubble-arrow"></div>
            <p id="ls-share-thoughts">åœ¨è¿™é‡Œæ˜¾ç¤º TA çš„æ„Ÿæƒ³...</p>
          </div>

          <!-- ä½œå“ä¿¡æ¯å¡ç‰‡ -->
          <div class="ls-share-info-box">
            <h3 id="ls-share-detail-title">ä½œå“æ ‡é¢˜</h3>
            <span class="ls-share-pill" id="ls-share-type-text">ç”µå½±</span>
            <div class="ls-share-divider"></div>
            <div class="ls-share-summary-text" id="ls-share-summary">
              è¿™é‡Œæ˜¯ä½œå“çš„ç®€ä»‹å†…å®¹...
            </div>
          </div>
        </div>

        <!-- 4. åº•éƒ¨æŒ‰é’® -->
        <div class="ls-share-footer-action">
          <button id="ls-share-detail-close-btn">æ”¶åˆ°å®‰åˆ© (oÂ´Ï‰`o)ï¾‰</button>
        </div>
      </div>
    </div>
    <!-- è«å…°è¿ªé£å¨ƒå¨ƒæœºå……å€¼å¼¹çª— -->
    <div id="claw-machine-modal" class="modal">
      <!-- å®¹å™¨èƒŒæ™¯æ”¹ä¸ºé€æ˜ï¼Œå»é™¤é»˜è®¤é˜´å½± -->
      <div
        class="modal-content"
        style="
          background: transparent;
          box-shadow: none;
          border: none;
          padding: 0;
          width: 380px;
          height: 720px;
          overflow: visible;
          display: flex;
          justify-content: center;
        "
      >
        <div id="claw-machine-body" class="morandi-style">
          <!-- â˜…â˜…â˜… é¡¶éƒ¨åŠŸèƒ½æ ï¼šå·¦å…³é—­ã€ä¸­æ ‡é¢˜ã€å³åˆ·æ–° â˜…â˜…â˜… -->
          <div class="machine-header-bar">
            <!-- å·¦ä¾§ï¼šå…³é—­æŒ‰é’® (ç§»åˆ°è¿™é‡Œï¼Œè¿œç¦»åˆ·æ–°) -->
            <div class="action-group left">
              <button
                id="close-claw-machine"
                class="icon-btn close-header-btn"
                title="é€€å‡ºå¨ƒå¨ƒæœº"
              >
                âœ•
              </button>
            </div>

            <!-- ä¸­é—´ï¼šæ ‡é¢˜ + è®¾ç½®æŒ‰é’® -->
            <div class="title-group">
              <div class="header-title">âœ¨ LUCK BOX âœ¨</div>
              <button
                id="claw-manage-btn"
                class="icon-btn settings-btn"
                title="ç®¡ç†å¨ƒå¨ƒåº“"
              >
                âš™ï¸
              </button>
            </div>

            <!-- å³ä¾§ï¼šåˆ·æ–°æŒ‰é’® -->
            <div class="action-group right">
              <button
                id="claw-restart-btn"
                class="icon-btn refresh-btn"
                title="åˆ·æ–°/æ¢ä¸€æ‰¹"
              >
                â†»
              </button>
            </div>
          </div>

          <!-- æ¦‚ç‡ä»ªè¡¨ç›˜ -->
          <div class="prob-dashboard">
            <div class="pie-chart-wrapper">
              <div id="prob-pie-chart" class="pie-chart"></div>
              <div class="pie-hole"></div>
            </div>
            <div id="prob-legend" class="chart-legend"></div>
          </div>

          <!-- ç»ç’ƒä»“ -->
          <div class="machine-window glass-effect">
            <div class="reflection-light"></div>
            <div id="machine-claw">
              <div class="claw-line"></div>
              <div class="claw-hand">
                <div class="claw-finger left"></div>
                <div class="claw-finger right"></div>
              </div>
            </div>
            <div id="doll-pool"></div>
            <div class="machine-chute">PUT</div>
          </div>

          <!-- æ§åˆ¶å° -->
          <div class="machine-controls glass-effect">
            <div class="control-group">
              <div class="joystick-base">
                <div id="machine-joystick" class="joystick-stick">
                  <div class="joystick-ball"></div>
                </div>
              </div>
            </div>
            <div class="display-screen">
              <span class="label">COINS</span>
              <span id="claw-machine-balance" class="value">0.00</span>
            </div>
            <div class="btn-group">
              <button id="claw-grab-btn" class="pearl-btn">GO</button>
            </div>
          </div>

          <div class="machine-base"></div>

          <!-- æ³¨æ„ï¼šåŸæ¥çš„åº•éƒ¨æ‚¬æµ®å…³é—­æŒ‰é’®ä»£ç å·²ç»åˆ é™¤äº† -->
        </div>
      </div>
    </div>
    <div id="doll-manager-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>ç®¡ç†å¨ƒå¨ƒå›¾é‰´</span>
          <div class="header-actions">
            <button id="add-doll-btn" class="action-button">æ·»åŠ </button>
            <button
              id="reset-dolls-btn"
              class="action-button"
              style="margin-right: 5px"
            >
              é‡ç½®é»˜è®¤
            </button>
          </div>
        </div>
        <div class="modal-body" style="background: #f5f5f5; padding: 15px">
          <div
            id="doll-manager-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
              gap: 10px;
            "
          >
            <!-- JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="save" id="close-doll-manager-btn" style="width: 100%">
            å®Œæˆ
          </button>
        </div>
      </div>
    </div>
    <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ æ§ä»¶ -->
    <input
      type="file"
      id="doll-upload-input"
      accept="image/*"
      multiple
      hidden
    />

    <div id="inner-voice-modal" class="modal">
      <!-- å¿ƒå£°ä¸»é¢æ¿ -->
      <div
        id="inner-voice-main-panel"
        class="modal-content"
        style="
          width: 90%;
          max-width: 340px;
          height: auto;
          max-height: 80%;
          background-color: #fffafb;
          border: 1px solid #ffe4e1;
        "
      >
        <div
          class="modal-header"
          style="
            border-bottom: 1px solid #ffe4e1;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <span
            id="close-inner-voice-modal"
            style="cursor: pointer; font-size: 24px"
            >Ã—</span
          >

          <div style="display: flex; align-items: center; gap: 15px">
            <span
              id="inner-voice-edit-btn"
              style="cursor: pointer"
              title="ç¼–è¾‘å¿ƒå£°é¢æ¿"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M12 20h9"></path>
                <path
                  d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                ></path>
              </svg>
            </span>
            <span
              id="change-inner-voice-bg-btn"
              style="cursor: pointer"
              title="æ›´æ¢èƒŒæ™¯"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
            </span>
            <span id="inner-voice-history-btn" style="cursor: pointer">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
            </span>
          </div>
        </div>

        <div class="modal-body" style="padding: 15px">
          <!-- å¤´åƒå’Œåå­—ä¿¡æ¯ç°åœ¨æ˜¯ç‹¬ç«‹çš„ã€å¯å®šä½çš„å…ƒç´  -->
          <!-- è§’è‰²å¤´åƒ -->
          <div id="inner-voice-avatar-wrapper">
            <img id="inner-voice-avatar" src="" />
            <!-- ä¸ºå¤´åƒæ¡†é¢„ç•™çš„ä½ç½® -->
            <img id="inner-voice-avatar-frame" src="" style="display: none" />
          </div>

          <!-- è§’è‰²åå­— -->
          <div id="inner-voice-char-info">
            <div id="inner-voice-char-name"></div>
          </div>

          <!-- é¢†å…»äººä¿¡æ¯ï¼ˆå¤´åƒ+åå­—ï¼‰-->
          <div id="inner-voice-adopter-info">
            <img id="inner-voice-adopter-avatar" src="" />
            <span id="inner-voice-adopter-name"></span>
          </div>

          <!-- å¿ƒå£°å†…å®¹ -->
          <div
            id="inner-voice-content-area"
            style="display: flex; flex-direction: column; gap: 15px"
          >
            <div>
              <strong style="color: #e57373">æœè£…:</strong>
              <p
                id="inner-voice-clothing"
                style="margin: 5px 0 0 0; line-height: 1.6; color: #555"
              ></p>
            </div>
            <div>
              <strong style="color: #81c784">è¡Œä¸º:</strong>
              <p
                id="inner-voice-behavior"
                style="margin: 5px 0 0 0; line-height: 1.6; color: #555"
              ></p>
            </div>
            <div>
              <strong style="color: #64b5f6">å¿ƒå£°:</strong>
              <p
                id="inner-voice-thoughts"
                style="margin: 5px 0 0 0; line-height: 1.6; color: #555"
              ></p>
            </div>
            <div>
              <strong style="color: #ba68c8">åå¿ƒæ€:</strong>
              <p
                id="inner-voice-naughty-thoughts"
                style="margin: 5px 0 0 0; line-height: 1.6; color: #555"
              ></p>
            </div>
          </div>
        </div>
      </div>

      <!-- å†å²è®°å½•é¢æ¿ (ä¿æŒä¸å˜) -->
      <div
        id="inner-voice-history-panel"
        class="modal-content"
        style="
          width: 90%;
          max-width: 340px;
          height: 80%;
          background-color: #f5f5f5;
          display: none;
          flex-direction: column;
        "
      >
        <div
          class="modal-header"
          style="border-bottom: 1px solid #ddd; justify-content: space-between"
        >
          <span
            id="back-from-history-btn"
            style="
              cursor: pointer;
              font-size: 16px;
              font-weight: 600;
              color: var(--accent-color);
            "
            >è¿”å›</span
          >
          <span>å†å²å¿ƒå£°</span>
          <span
            id="clear-all-history-btn"
            style="cursor: pointer; font-size: 14px; color: #ff3b30"
            >å…¨éƒ¨æ¸…ç©º</span
          >
        </div>
        <div
          class="modal-body"
          id="inner-voice-history-list"
          style="padding: 0"
        >
          <!-- å†å²è®°å½•ä¼šç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
      </div>
    </div>

    <script>
      (function () {
        window.errorLogs = [];

        // === æ ¸å¿ƒé€»è¾‘ï¼šåªæŠ“é”™è¯¯ ===
        function captureError(source, msg) {
          const time = new Date().toLocaleTimeString();
          const logLine = `â° [${time}] ${source}\nâŒ ${msg}\n----------------------------------\n`;
          window.errorLogs.push(logLine);

          // å®æ—¶æ›´æ–°UI
          const textarea = document.getElementById("error-log-viewer");
          if (textarea) {
            textarea.value = window.errorLogs.join("");
            textarea.scrollTop = textarea.scrollHeight;
          }
        }

        // 1. åŠ«æŒ console.error (ä»£ç é‡Œä¸»åŠ¨æ‰“å°çš„çº¢å­—)
        const originalError = console.error;
        console.error = function (...args) {
          // å°†å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œé˜²æ­¢æ˜¾ç¤º [object Object]
          const msg = args
            .map((a) => {
              try {
                return typeof a === "object" ? JSON.stringify(a) : String(a);
              } catch (e) {
                return String(a);
              }
            })
            .join(" ");
          captureError("Console Error", msg);
          originalError.apply(console, args);
        };

        // 2. æ•è·è¿è¡Œæ—¶çš„å´©æºƒ (è¯­æ³•é”™è¯¯ã€æœªå®šä¹‰å˜é‡ç­‰)
        window.addEventListener("error", function (event) {
          captureError(
            "System Crash",
            `${event.message}\nğŸ“ ä½ç½®: ${event.filename}:${event.lineno}`,
          );
        });

        // 3. æ•è· Promise æŠ¥é”™ (APIè¯·æ±‚å¤±è´¥ç­‰)
        window.addEventListener("unhandledrejection", function (event) {
          let reason = event.reason;
          if (typeof reason === "object")
            reason = reason.message || JSON.stringify(reason);
          captureError("Unhandled Promise", reason);
        });
      })();

      // æ‰“å¼€é¢æ¿
      window.openBugStation = function () {
        const modal = document.getElementById("bug-report-modal");
        const textarea = document.getElementById("error-log-viewer");
        const emptyTip = "âœ¨ ä¸€åˆ‡æ­£å¸¸ï¼æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•æŠ¥é”™ (å¥½è€¶ï¼)";

        if (window.errorLogs.length === 0) {
          textarea.value = emptyTip;
          textarea.style.color = "#52c41a"; // ç»¿è‰²
          textarea.style.textAlign = "center";
          textarea.style.paddingTop = "50px";
        } else {
          textarea.value = window.errorLogs.join("");
          textarea.style.color = "#ff4d4f"; // çº¢è‰²
          textarea.style.textAlign = "left";
          textarea.style.paddingTop = "15px";
        }

        modal.classList.add("visible");
      };

      // å¤åˆ¶
      window.copyBugReport = function () {
        const textarea = document.getElementById("error-log-viewer");
        if (textarea.value.includes("ä¸€åˆ‡æ­£å¸¸")) {
          alert("æ²¡æœ‰æŠ¥é”™ï¼Œä¸ç”¨å¤åˆ¶å•¦~");
          return;
        }
        textarea.select();
        document.execCommand("copy");
        alert("ğŸ’‰ æŠ¥é”™ä¿¡æ¯å·²å¤åˆ¶ï¼å¿«å‘ç»™å¼€å‘è€…æ€¥æ•‘ï¼");
      };

      // æ¸…ç©º
      window.clearBugReport = function () {
        window.errorLogs = [];
        window.openBugStation(); // åˆ·æ–°æ˜¾ç¤º
      };

      // å…³é—­
      window.closeBugStation = function () {
        document.getElementById("bug-report-modal").classList.remove("visible");
      };
      const TAROT_DECK = [
        {
          name: "æ„šäºº",
          upright: "å¼€å§‹, å¤©çœŸ, è‡ªå‘æ€§, è‡ªç”±ç²¾ç¥",
          reversed: "å¤©çœŸ, é²è½, æ‰¿æ‹…é£é™©",
        },
        {
          name: "é­”æœ¯å¸ˆ",
          upright: "æ˜¾åŒ–, è¶³æ™ºå¤šè°‹, åŠ›é‡, çµæ„Ÿè¡ŒåŠ¨",
          reversed: "æ“çºµ, è®¡åˆ’ä¸å‘¨, æœªè¢«åˆ©ç”¨çš„å¤©èµ‹",
        },
        {
          name: "å¥³ç¥­å¸",
          upright: "ç›´è§‰, ç¥åœ£å¥³æ€§, æ½œæ„è¯†, ç¥ç§˜",
          reversed: "ç§˜å¯†, è„±ç¦»ç›´è§‰, å‹æŠ‘çš„æ„Ÿæƒ…",
        },
        {
          name: "çš‡å",
          upright: "ç”Ÿè‚², å¥³æ€§æ°”è´¨, ç¾ä¸½, è‡ªç„¶, ä¸°å¯Œ",
          reversed: "åˆ›é€ åŠ›å—é˜», ä¾èµ–ä»–äºº",
        },
        {
          name: "çš‡å¸",
          upright: "æƒå¨, çˆ¶äº²å½¢è±¡, ç»“æ„, ç¨³å›ºæ§åˆ¶",
          reversed: "æ§åˆ¶æ¬², åƒµåŒ–, ç¼ºä¹çºªå¾‹",
        },
        {
          name: "æ•™çš‡",
          upright: "ç²¾ç¥æ™ºæ…§, å®—æ•™ä¿¡ä»°, ä¼ ç»Ÿ, åˆ¶åº¦",
          reversed: "ä¸ªäººä¿¡ä»°, æŒ‘æˆ˜ä¼ ç»Ÿ, å¢¨å®ˆæˆè§„",
        },
        {
          name: "æ‹äºº",
          upright: "çˆ±, å’Œè°, å…³ç³», ä»·å€¼è§‚å¯¹é½, é€‰æ‹©",
          reversed: "ä¸å’Œè°, å¤±è¡¡, ä»·å€¼è§‚é”™ä½",
        },
        {
          name: "æˆ˜è½¦",
          upright: "æ§åˆ¶, æ„å¿—åŠ›, èƒœåˆ©, æ–­è¨€, å†³å¿ƒ",
          reversed: "ç¼ºä¹æ§åˆ¶å’Œæ–¹å‘, ä¾µç•¥æ€§",
        },
        {
          name: "åŠ›é‡",
          upright: "åŠ›é‡, å‹‡æ°”, åŒæƒ…, ä¸“æ³¨, è€å¿ƒ",
          reversed: "å†…åœ¨åŠ›é‡, è‡ªæˆ‘æ€€ç–‘, ç²¾åŠ›ä¸è¶³",
        },
        {
          name: "éšå£«",
          upright: "çµé­‚æ¢ç´¢, å†…çœ, å­¤ç‹¬, å†…åœ¨å¼•å¯¼",
          reversed: "å­¤ç«‹, å­¤ç‹¬, é€€ç¼©",
        },
        {
          name: "å‘½è¿ä¹‹è½®",
          upright: "å¥½è¿, å› æœæŠ¥åº”, ç”Ÿå‘½å‘¨æœŸ, è½¬æŠ˜ç‚¹",
          reversed: "åè¿æ°”, æŠµæŠ—æ”¹å˜, æ‰“ç ´å¾ªç¯",
        },
        {
          name: "æ­£ä¹‰",
          upright: "æ­£ä¹‰, å…¬å¹³, çœŸç†, å› æœ, æ³•å¾‹",
          reversed: "ä¸å…¬å¹³, ç¼ºä¹è´£ä»»æ„Ÿ, ä¸è¯šå®",
        },
        {
          name: "å€’åŠäºº",
          upright: "æš‚åœ, é™åˆ¶, æ”¾æ‰‹, ç‰ºç‰², æ–°è§†è§’",
          reversed: "æ‹–å»¶, æ¯«æ— æ„ä¹‰çš„ç‰ºç‰², åœæ»",
        },
        {
          name: "æ­»ç¥",
          upright: "ç»“æŸ, æ”¹å˜, è½¬å˜, è¿‡æ¸¡",
          reversed: "æŠµæŠ—æ”¹å˜, æ— æ³•å‰è¿›, åœæ»",
        },
        {
          name: "èŠ‚åˆ¶",
          upright: "å¹³è¡¡, é€‚åº¦, è€å¿ƒ, ç›®æ ‡",
          reversed: "å¤±è¡¡, è¿‡åº¦, é‡æ–°è°ƒæ•´",
        },
        {
          name: "æ¶é­”",
          upright: "æŸç¼š, æˆç˜¾, æ¶ˆæ, å”¯ç‰©ä¸»ä¹‰",
          reversed: "æŒ£è„±æŸç¼š, é‡Šæ”¾, æ¢å¤æ§åˆ¶",
        },
        {
          name: "é«˜å¡”",
          upright: "çªå˜, å‰§å˜, æ··ä¹±, å¯ç¤º, è§‰é†’",
          reversed: "é¿å…ç¾éš¾, å®³æ€•æ”¹å˜",
        },
        {
          name: "æ˜Ÿæ˜Ÿ",
          upright: "å¸Œæœ›, ä¿¡å¿µ, ç›®æ ‡, æ›´æ–°, çµæ€§",
          reversed: "ç¼ºä¹ä¿¡å¿µ, ç»æœ›, ä¸ä¸“æ³¨",
        },
        {
          name: "æœˆäº®",
          upright: "å¹»è§‰, ææƒ§, ç„¦è™‘, æ½œæ„è¯†, ç›´è§‰",
          reversed: "é‡Šæ”¾ææƒ§, å‹æŠ‘çš„æƒ…æ„Ÿ, å†…å¿ƒå›°æƒ‘",
        },
        {
          name: "å¤ªé˜³",
          upright: "ç§¯æ, ä¹è¶£, æ¸©æš–, æˆåŠŸ, æ´»åŠ›",
          reversed: "å†…å¿ƒå¹¼ç¨š, è¿‡äºä¹è§‚, æ²®ä¸§",
        },
        {
          name: "å®¡åˆ¤",
          upright: "å®¡åˆ¤, é‡ç”Ÿ, å†…å¿ƒå¬å”¤, èµ¦å…",
          reversed: "è‡ªæˆ‘æ€€ç–‘, æ— è§†å¬å”¤",
        },
        {
          name: "ä¸–ç•Œ",
          upright: "å®Œæˆ, æ•´åˆ, æˆå°±, æ—…è¡Œ",
          reversed: "å¯»æ±‚ä¸ªäººç»“æŸ, èµ°æ·å¾„, æ‹–å»¶",
        },
        {
          name: "æƒæ–ACE",
          upright: "çµæ„Ÿ, æ–°æœºä¼š, æˆé•¿, æ½œåŠ›",
          reversed: "ç¼ºä¹åŠ¨åŠ›, é”™è¿‡æœºä¼š, æ‹–å»¶",
        },
        {
          name: "æƒæ–äºŒ",
          upright: "æœªæ¥è§„åˆ’, è¿›æ­¥, å†³ç­–, ç¦»å¼€å®¶",
          reversed: "ææƒ§æœªçŸ¥, ç¼ºä¹è§„åˆ’, å®³æ€•æ”¹å˜",
        },
        {
          name: "æƒæ–ä¸‰",
          upright: "æ‰©å¼ , æˆé•¿, è¿œè§, æµ·å¤–æœºä¼š",
          reversed: "è®¡åˆ’å—æŒ«, ç¼ºä¹è¿œè§, å»¶è¯¯",
        },
        {
          name: "æƒæ–å››",
          upright: "åº†ç¥, å’Œè°, å©šå§», å›å®¶, ç¨³å®š",
          reversed: "ä¸å’Œè°, è¿‡æ¸¡, ç¼ºä¹æ”¯æŒ",
        },
        {
          name: "æƒæ–äº”",
          upright: "å†²çª, åˆ†æ­§, ç«äº‰, ç´§å¼ ",
          reversed: "å†²çªé¿å…, å°Šé‡å·®å¼‚",
        },
        {
          name: "æƒæ–å…­",
          upright: "æˆåŠŸ, å…¬ä¼—è®¤å¯, èƒœåˆ©, è¿›æ­¥",
          reversed: "è‡ªè´Ÿ, ç¼ºä¹è®¤å¯, æƒ©ç½š",
        },
        {
          name: "æƒæ–ä¸ƒ",
          upright: "æŒ‘æˆ˜, ç«äº‰, ä¿æŠ¤, åšæŒ",
          reversed: "æ”¾å¼ƒ, ä¸çŸ¥æ‰€æª, è¿‡åº¦ä¿æŠ¤",
        },
        {
          name: "æƒæ–å…«",
          upright: "é€Ÿåº¦, è¡ŒåŠ¨, ç©ºä¸­æ—…è¡Œ, è¿åŠ¨, å¿«é€Ÿå†³ç­–",
          reversed: "å»¶è¯¯, æŒ«æŠ˜, æŠµåˆ¶æ”¹å˜",
        },
        {
          name: "æƒæ–ä¹",
          upright: "éŸ§æ€§, å‹‡æ°”, åšæŒ, ç•Œé™",
          reversed: "å†…å¿ƒæŒ£æ‰, åæ‰§, é˜²å¾¡æ€§",
        },
        {
          name: "æƒæ–å",
          upright: "è´Ÿæ‹…, è´£ä»», åŠªåŠ›å·¥ä½œ, å‹åŠ›",
          reversed: "å¸ä¸‹è´Ÿæ‹…, å§”æ´¾, é‡Šæ”¾",
        },
        {
          name: "æƒæ–ä¾ä»",
          upright: "çµæ„Ÿ, æƒ³æ³•, å‘ç°, è‡ªç”±ç²¾ç¥",
          reversed: "ä¸åˆ‡å®é™…çš„æƒ³æ³•, æ‹–å»¶, åˆ›é€ åŠ›å—é˜»",
        },
        {
          name: "æƒæ–éª‘å£«",
          upright: "èƒ½é‡, æ¿€æƒ…, æ¬²æœ›, è¡ŒåŠ¨, å†’é™©",
          reversed: "æ„¤æ€’, å†²åŠ¨, é²è½",
        },
        {
          name: "æƒæ–ç‹å",
          upright: "å‹‡æ°”, è‡ªä¿¡, ç‹¬ç«‹, ç¤¾äº¤è´è¶",
          reversed: "è‡ªæˆ‘å°Šé‡, è‡ªä¿¡, å†…å‘",
        },
        {
          name: "æƒæ–å›½ç‹",
          upright: "å¤©ç”Ÿçš„é¢†è¢–, è¿œè§, ä¼ä¸šå®¶, è£èª‰",
          reversed: "å†²åŠ¨, ä»“ä¿ƒ, æ— æƒ…çš„",
        },
        {
          name: "åœ£æ¯ACE",
          upright: "çˆ±, æ–°å…³ç³», åŒæƒ…, åˆ›é€ åŠ›",
          reversed: "è‡ªæˆ‘çˆ±, ç›´è§‰, å‹æŠ‘çš„æƒ…æ„Ÿ",
        },
        {
          name: "åœ£æ¯äºŒ",
          upright: "ç»Ÿä¸€çš„çˆ±, ä¼™ä¼´å…³ç³», ç›¸äº’å¸å¼•",
          reversed: "åˆ†æ‰‹, ä¸å’Œè°, ä¸ä¿¡ä»»",
        },
        {
          name: "åœ£æ¯ä¸‰",
          upright: "åº†ç¥, å‹è°Š, åˆ›é€ åŠ›, åˆä½œ",
          reversed: "ç‹¬ç«‹, ç‹¬å¤„, 'ä¸‰äººè¡Œ'",
        },
        {
          name: "åœ£æ¯å››",
          upright: "æ²‰æ€, æ–­å¼€è¿æ¥, å†·æ¼ , é‡æ–°è¯„ä¼°",
          reversed: "é€€ç¼©, å­¤åƒ», é”™è¿‡æœºä¼š",
        },
        {
          name: "åœ£æ¯äº”",
          upright: "é—æ†¾, å¤±è´¥, å¤±æœ›, æ‚²è§‚ä¸»ä¹‰",
          reversed: "ä¸ªäººæŒ«æŠ˜, è‡ªæˆ‘å®½æ•, å‰è¿›",
        },
        {
          name: "åœ£æ¯å…­",
          upright: "é‡æ¸©è¿‡å», ç«¥å¹´è®°å¿†, å¤©çœŸ, å–œæ‚¦",
          reversed: "æ´»åœ¨è¿‡å», ä¸æ„¿åŸè°…, ç¼ºä¹ç©ä¹",
        },
        {
          name: "åœ£æ¯ä¸ƒ",
          upright: "æœºä¼š, é€‰æ‹©, å¹»æƒ³, å¹»è§‰",
          reversed: "ä¸€è‡´æ€§, å¹»æƒ³, è¿‡å¤šé€‰æ‹©",
        },
        {
          name: "åœ£æ¯å…«",
          upright: "å¤±æœ›, æ”¾å¼ƒ, é€€ç¼©, é€ƒé¿ä¸»ä¹‰",
          reversed: "å°è¯•æ–°äº‹ç‰©, å†·æ¼ , ææƒ§æ”¹å˜",
        },
        {
          name: "åœ£æ¯ä¹",
          upright: "æ»¡è¶³, æ»¡æ„, æ„Ÿæ¿€, æ„¿æœ›æˆçœŸ",
          reversed: "ä¸æ»¡è¶³, å”¯ç‰©ä¸»ä¹‰, ä¸æ»¡",
        },
        {
          name: "åœ£æ¯å",
          upright: "ç¥åœ£çš„çˆ±, å’Œè°å…³ç³», å®¶åº­, ä¸€è‡´æ€§",
          reversed: "è„±èŠ‚, å¯¹é½é”™è¯¯, æŒ£æ‰çš„å…³ç³»",
        },
        {
          name: "åœ£æ¯ä¾ä»",
          upright: "åˆ›æ„æœºä¼š, ç›´è§‰ä¿¡æ¯, å¥½å¥‡å¿ƒ",
          reversed: "æ–°çš„æƒ³æ³•, æ€€ç–‘, åˆ›é€ åŠ›å—é˜»",
        },
        {
          name: "åœ£æ¯éª‘å£«",
          upright: "åˆ›é€ åŠ›, æµªæ¼«, é­…åŠ›, æƒ³è±¡åŠ›",
          reversed: "ä¸åˆ‡å®é™…, å«‰å¦’, æƒ…ç»ªæ³¢åŠ¨",
        },
        {
          name: "åœ£æ¯ç‹å",
          upright: "å¯Œæœ‰åŒæƒ…å¿ƒ, å…³æ€€, ç›´è§‰, å¹³é™",
          reversed: "å†…åœ¨æ„Ÿå—, è‡ªæˆ‘ç…§é¡¾, è‡ªçˆ±, å…±æƒ…",
        },
        {
          name: "åœ£æ¯å›½ç‹",
          upright: "æƒ…ç»ªå¹³è¡¡, åŒæƒ…, å¤–äº¤",
          reversed: "è‡ªæˆ‘åŒæƒ…, å†…åœ¨çœŸç†, æƒ…ç»ªä¸ç¨³å®š",
        },
        {
          name: "å®å‰‘ACE",
          upright: "çªç ´, æ–°æƒ³æ³•, å¤´è„‘æ¸…æ™°, æˆåŠŸ",
          reversed: "å†…å¿ƒæ¸…æ™°, é‡æ–°æ€è€ƒä¸€ä¸ªæƒ³æ³•, æ··ä¹±",
        },
        {
          name: "å®å‰‘äºŒ",
          upright: "è‰°éš¾çš„é€‰æ‹©, æœªçŸ¥çš„åæœ, åƒµå±€",
          reversed: "ä¼˜æŸ”å¯¡æ–­, å›°æƒ‘, ä¿¡æ¯è¿‡è½½",
        },
        {
          name: "å®å‰‘ä¸‰",
          upright: "å¿ƒç¢, æ‚²ä¼¤, æ‹’ç», åˆ†ç¦»",
          reversed: "é‡Šæ”¾ç—›è‹¦, ä¹è§‚, å®½æ•",
        },
        {
          name: "å®å‰‘å››",
          upright: "ä¼‘æ¯, æ”¾æ¾, æ²‰æ€, æ¢å¤",
          reversed: "ç²¾ç–²åŠ›å°½, å€¦æ€ , åœæ»",
        },
        {
          name: "å®å‰‘äº”",
          upright: "å†²çª, åˆ†æ­§, ç«äº‰, å¤±è´¥",
          reversed: "å’Œè§£, è¿‡å»çš„åŸè°…",
        },
        {
          name: "å®å‰‘å…­",
          upright: "è¿‡æ¸¡, æ”¹å˜, ä»ªå¼, æ”¾ä¸‹",
          reversed: "ä¸ªäººè¿‡æ¸¡, æŠµæŠ—æ”¹å˜, æœªå®Œæˆçš„äº‹",
        },
        {
          name: "å®å‰‘ä¸ƒ",
          upright: "èƒŒå›, æ¬ºéª—, èµ°æ·å¾„, é¬¼ç¥Ÿ",
          reversed: "å†’åé¡¶æ›¿ç»¼åˆç—‡, æ¬ºéª—, å®ˆç§˜",
        },
        {
          name: "å®å‰‘å…«",
          upright: "è´Ÿé¢æƒ³æ³•, è‡ªæˆ‘å¼ºåŠ çš„é™åˆ¶, ç›‘ç¦",
          reversed: "è‡ªæˆ‘é™åˆ¶çš„ä¿¡å¿µ, é‡Šæ”¾, æ€æƒ³å¼€æ”¾",
        },
        {
          name: "å®å‰‘ä¹",
          upright: "ç„¦è™‘, æ‹…å¿§, ææƒ§, æŠ‘éƒ, å™©æ¢¦",
          reversed: "å†…å¿ƒæŒ£æ‰, æ·±åº¦ææƒ§, é‡Šæ”¾å¿§è™‘",
        },
        {
          name: "å®å‰‘å",
          upright: "ç—›è‹¦çš„ç»“å±€, æ·±åº¦åˆ›ä¼¤, èƒŒå›, æŸå¤±",
          reversed: "æ¢å¤, æŠµæŠ—ç»“å±€, æ— æ³•æ”¾æ‰‹",
        },
        {
          name: "å®å‰‘ä¾ä»",
          upright: "æ–°æƒ³æ³•, å¥½å¥‡å¿ƒ, è¿½æ±‚çœŸç†",
          reversed: "è‡ªè¨€è‡ªè¯­, å…¨èƒ½é€‰æ‰‹, ä»“ä¿ƒ",
        },
        {
          name: "å®å‰‘éª‘å£«",
          upright: "é›„å¿ƒå‹ƒå‹ƒ, è¡ŒåŠ¨å¯¼å‘, è¿½æ±‚ç›®æ ‡",
          reversed: "ä¸å®‰, å†²åŠ¨, å€¦æ€ ",
        },
        {
          name: "å®å‰‘ç‹å",
          upright: "ç‹¬ç«‹çš„, æ— åè§çš„åˆ¤æ–­, æ¸…æ™°çš„ç•Œé™",
          reversed: "è¿‡äºæƒ…ç»ªåŒ–, è½»æ˜“å—å½±å“, åˆ»è–„",
        },
        {
          name: "å®å‰‘å›½ç‹",
          upright: "ç²¾ç¥æ¸…æ™°, æ™ºæ…§, æƒå¨, çœŸç†",
          reversed: "å®‰é™çš„åŠ›é‡, å†…åœ¨çœŸç†, æ»¥ç”¨æƒåŠ›",
        },
        {
          name: "æ˜Ÿå¸ACE",
          upright: "æ˜¾åŒ–, æ–°çš„è´¢åŠ¡æœºä¼š, ç¹è£",
          reversed: "æœºä¼šä¸§å¤±, ç¼ºä¹è§„åˆ’å’Œè¿œè§",
        },
        {
          name: "æ˜Ÿå¸äºŒ",
          upright: "å¤šä»»åŠ¡, é€‚åº”æ€§, æ—¶é—´ç®¡ç†",
          reversed: "é‡æ–°è°ƒæ•´ä¼˜å…ˆçº§, è¿‡åº¦æŠ•å…¥",
        },
        {
          name: "æ˜Ÿå¸ä¸‰",
          upright: "å›¢é˜Ÿåˆä½œ, åˆä½œ, å­¦ä¹ , å®æ–½",
          reversed: "ä¸å’Œè°, å›¢é˜Ÿå†…éƒ¨å†²çª, è®¡åˆ’ä¸å‘¨",
        },
        {
          name: "æ˜Ÿå¸å››",
          upright: "èŠ‚çº¦, å®‰å…¨, ä¿å®ˆ, ç¨€ç¼ºå¿ƒæ€",
          reversed: "è¿‡åº¦æ¶ˆè´¹, è´ªå©ª, è‡ªæˆ‘ä¿æŠ¤",
        },
        {
          name: "æ˜Ÿå¸äº”",
          upright: "è´¢åŠ¡æŸå¤±, è´«å›°, å­¤ç«‹, å¿§è™‘",
          reversed: "ä»è´¢åŠ¡æŸå¤±ä¸­æ¢å¤, ç²¾ç¥è´«å›°",
        },
        {
          name: "æ˜Ÿå¸å…­",
          upright: "ç»™äºˆ, æ¥å—, åˆ†äº«è´¢å¯Œ, æ…·æ…¨",
          reversed: "è‡ªç§, å€ºåŠ¡, å•æ–¹é¢ç»™äºˆ",
        },
        {
          name: "æ˜Ÿå¸ä¸ƒ",
          upright: "é•¿æœŸçœ¼å…‰, å¯æŒç»­çš„ç»“æœ, æŠ•èµ„",
          reversed: "ç¼ºä¹é•¿æœŸçœ¼å…‰, æˆåŠŸå—é™",
        },
        {
          name: "æ˜Ÿå¸å…«",
          upright: "å­¦å¾’, é‡å¤, æŒæ¡, æŠ€èƒ½å‘å±•",
          reversed: "è‡ªæˆ‘å‘å±•, å®Œç¾ä¸»ä¹‰, éƒ¨ç½²ä¸å½“",
        },
        {
          name: "æ˜Ÿå¸ä¹",
          upright: "ä¸°å¯Œ, å¥¢å, è‡ªç»™è‡ªè¶³, è´¢åŠ¡ç‹¬ç«‹",
          reversed: "è‡ªæˆ‘ä»·å€¼, è¿‡åº¦æŠ•èµ„äºå·¥ä½œ",
        },
        {
          name: "æ˜Ÿå¸å",
          upright: "è´¢å¯Œ, è´¢åŠ¡å®‰å…¨, å®¶åº­, é—äº§",
          reversed: "è´¢åŠ¡å¤±è´¥, è´Ÿæ‹…, é—äº§ä¸§å¤±",
        },
        {
          name: "æ˜Ÿå¸ä¾ä»",
          upright: "æ˜¾åŒ–, è´¢åŠ¡æœºä¼š, æŠ€èƒ½å‘å±•",
          reversed: "ç¼ºä¹è¿›æ­¥, æ‹–å»¶, å­¦ä¼šæ–°æŠ€èƒ½",
        },
        {
          name: "æ˜Ÿå¸éª‘å£«",
          upright: "åŠªåŠ›å·¥ä½œ, ç”Ÿäº§åŠ›, æ—¥å¸¸, ä¿å®ˆ",
          reversed: "è‡ªæˆ‘çºªå¾‹, æ— èŠ, æ„Ÿè§‰'å¡ä½'",
        },
        {
          name: "æ˜Ÿå¸ç‹å",
          upright: "å…»è‚², åŠ¡å®, è´¢åŠ¡å®‰å…¨, å·¥ä½œä¸å®¶åº­çš„å¹³è¡¡",
          reversed: "è´¢åŠ¡ç‹¬ç«‹, è‡ªæˆ‘ç…§é¡¾, å·¥ä½œä¸å®¶åº­çš„ä¸å¹³è¡¡",
        },
        {
          name: "æ˜Ÿå¸å›½ç‹",
          upright: "è´¢å¯Œ, å•†ä¸š, é¢†å¯¼åŠ›, å®‰å…¨, çºªå¾‹",
          reversed: "è´¢åŠ¡ä¸ç§°èŒ, è¿‡æ—¶, å›ºæ‰§",
        },
      ];

      const BUILT_IN_SCRIPTS = [
        {
          id: "built_in_1",
          name: "åŠå…¬å®¤ç–‘äº‘",
          storyBackground:
            "æ·±å¤œï¼Œé¡¶çº§äº’è”ç½‘å…¬å¸â€œæ¯”ç‰¹æ— é™â€ç¯ç«é€šæ˜ã€‚ä»¥è‹›åˆ»é—»åçš„é¡¹ç›®æ€»ç›‘ç‹å¼ºï¼Œè¢«å‘ç°æ­»åœ¨è‡ªå·±çš„åº§ä½ä¸Šï¼Œæ­»å› ä¸ºè¯ç‰©ä¸­æ¯’ã€‚è­¦æ–¹åˆæ­¥é”å®šäº†å½“æ™šè¿˜åœ¨å…¬å¸çš„äº”ä½å«Œç–‘äººï¼Œæ¯ä¸ªäººä¼¼ä¹éƒ½ä¸æ­»è€…æœ‰ç€åƒä¸ä¸‡ç¼•çš„è”ç³»ã€‚åœ¨è¿™åº§æ¬²æœ›ä¸ä»£ç äº¤ç»‡çš„é’¢é“æ£®æ—é‡Œï¼Œè°çš„ç§˜å¯†è¢«æ°¸è¿œåŸ‹è‘¬ï¼Œè°çš„åŒæ‰‹æ²¾æŸ“äº†ç½ªæ¶ï¼Ÿ",
          roles: [
            {
              name: "ææ€",
              description:
                "å…¬å¸æ–°æ™‹çš„å¤©æ‰ç¨‹åºå‘˜ï¼ŒæŠ€æœ¯è¿‡ç¡¬ï¼Œä½†æ€§æ ¼å†…å‘ï¼Œä¸å–„è¨€è¾ã€‚",
              storyline: `ä»Šå¤©æ˜¯é¡¹ç›®ä¸Šçº¿çš„æœ€åæœŸé™ï¼Œæˆ‘è¢«ç‹æ€»ç›‘é€¼ç€åŠ ç­åˆ°æ·±å¤œã€‚\n**æ™šä¸Š8:00**ï¼šç‹æ€»ç›‘æŠŠæˆ‘å«è¿›ä»–åŠå…¬å®¤ï¼Œå› ä¸ºä¸€ä¸ªå¾®ä¸è¶³é“çš„bugå¯¹æˆ‘ç ´å£å¤§éª‚ï¼Œç”šè‡³æ’•æ‰äº†æˆ‘çš„ç»©æ•ˆè¯„ä¼°æŠ¥å‘Šï¼Œè¯´æˆ‘â€œä¸åˆæ ¼â€ã€‚æˆ‘æ°”å¾—æµ‘èº«å‘æŠ–ï¼Œå’Œä»–å¤§åµäº†ä¸€æ¶ï¼Œç„¶åæ‘”é—¨è€Œå‡ºã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘å›åˆ°å·¥ä½ï¼Œè¶Šæƒ³è¶Šæ°”ï¼Œæ‰“å¼€ç”µè„‘å†™äº†ä¸€å°è¾èŒä¿¡ï¼Œä½†è¿˜æ²¡å‘é€ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘èµ·èº«å»èŒ¶æ°´é—´å€’æ°´ï¼Œè·¯è¿‡æ€»ç›‘åŠå…¬å®¤æ—¶ï¼Œçœ‹åˆ°äººäº‹ä¸»ç®¡é™ˆé™ç«¯ç€ä¸€æ¯å’–å•¡èµ°äº†è¿›å»ã€‚æˆ‘å½“æ—¶æ²¡å¤ªåœ¨æ„ã€‚\n**æ™šä¸Š9:30**ï¼šæˆ‘æœ‰ç‚¹é¥¿ï¼Œç‚¹äº†ä¸€ä»½å¤–å–ã€‚ç­‰å¤–å–çš„æ—¶å€™ï¼Œæˆ‘çœ‹åˆ°è®¾è®¡å¸ˆå­™ä¼Ÿé¬¼é¬¼ç¥Ÿç¥Ÿåœ°ä»èŒ¶æ°´é—´çš„æ–¹å‘èµ°å‡ºæ¥ï¼Œæ‰‹é‡Œå¥½åƒæ”¥ç€ä»€ä¹ˆä¸œè¥¿ã€‚\n**æ™šä¸Š10:00**ï¼šå¤–å–åˆ°äº†ï¼Œæˆ‘åƒå®Œå¤–å–ç»§ç»­æ”¹bugï¼Œç›´åˆ°è¢«å‘ç°å°¸ä½“çš„æƒŠå«å£°æ‰“æ–­ã€‚`,
              tasks:
                "1. éšè—ä½ ä¸ç‹å¼ºæ€»ç›‘å‘ç”Ÿè¿‡æ¿€çƒˆäº‰åµï¼Œå¹¶è¢«ä»–è¯„ä¸ºâ€œä¸åˆæ ¼â€çš„äº‹å®ã€‚\n2. ä½ çš„é¦–è¦ç›®æ ‡æ˜¯è‡ªä¿ï¼Œæ‰¾åˆ°è¯æ®è¯æ˜ä½ ç¦»å¼€åå¦æœ‰å…¶äººè¿›å…¥è¿‡åŠå…¬å®¤ã€‚\n3. ä½ æ€€ç–‘é™ˆé™å’Œå­™ä¼Ÿï¼Œå°è¯•æ‰¾å‡ºä»–ä»¬çš„å¯ç–‘ä¹‹å¤„ã€‚",
              isKiller: false,
            },
            {
              name: "èµµå¨œ",
              description:
                "å…¬å¸çš„å¸‚åœºéƒ¨ç»ç†ï¼Œèƒ½åŠ›å‡ºä¼—ï¼Œæ˜¯å…¸å‹çš„èŒåœºå¥³å¼ºäººï¼Œé‡å¿ƒå‹ƒå‹ƒã€‚",
              storyline: `ä»Šæ™šæœ¬ä¸éœ€è¦æˆ‘åŠ ç­ï¼Œä½†æˆ‘ä¸ºäº†å‡†å¤‡ä¸€ä¸ªé‡è¦çš„ç«æ ‡æ–¹æ¡ˆï¼Œä¸»åŠ¨ç•™äº†ä¸‹æ¥ã€‚\n**æ™šä¸Š7:30**ï¼šæˆ‘åœ¨è‡ªå·±çš„åŠå…¬å®¤æ•´ç†èµ„æ–™ï¼Œæ— æ„ä¸­å‘ç°äº†ç‹å¼ºæŒªç”¨é¡¹ç›®å…¬æ¬¾çš„è¯æ®ã€‚æˆ‘ç«‹åˆ»èµ·è‰äº†ä¸€å°åŒ¿åä¸¾æŠ¥é‚®ä»¶ï¼Œå‡†å¤‡å‘ç»™æ€»éƒ¨ã€‚\n**æ™šä¸Š8:10**ï¼šæˆ‘å¬åˆ°éš”å£æ€»ç›‘åŠå…¬å®¤ä¼ æ¥æ¿€çƒˆçš„äº‰åµå£°ï¼Œå¥½åƒæ˜¯ææ€åœ¨å’Œç‹å¼ºåµæ¶ã€‚\n**æ™šä¸Š8:45**ï¼šæˆ‘éœ€è¦ä¸€äº›æ•°æ®ï¼Œå°±å»æ‰¾ç‹å¼ºç­¾å­—ã€‚è¿›ä»–åŠå…¬å®¤æ—¶ï¼Œä»–æ­£åœ¨å–å’–å•¡ï¼Œè„¸è‰²å¾ˆå·®ã€‚æˆ‘æŠŠæ–‡ä»¶ç»™ä»–ï¼Œä»–å¾ˆä¸è€çƒ¦åœ°ç­¾äº†å­—ã€‚æˆ‘æ³¨æ„åˆ°ä»–æ¡Œä¸Šæ”¾ç€ä¸€ç“¶æ²¡è´´æ ‡ç­¾çš„è¯ç“¶ã€‚\n**æ™šä¸Š9:15**ï¼šæˆ‘å›åˆ°è‡ªå·±åŠå…¬å®¤ï¼Œæ€è€ƒç€ä¸¾æŠ¥é‚®ä»¶çš„äº‹æƒ…ã€‚æˆ‘æ‹…å¿ƒè¿™ä¼šå½±å“å…¬å¸å£°èª‰ï¼Œæœ€ç»ˆè¿˜æ˜¯æ²¡æœ‰å‘é€ã€‚\n**æ™šä¸Š10:15**ï¼šæˆ‘å‡†å¤‡ä¸‹ç­ï¼Œè·¯è¿‡æ€»ç›‘åŠå…¬å®¤æ—¶ï¼Œå‘ç°é—¨è™šæ©ç€ï¼Œé‡Œé¢å¾ˆå®‰é™ã€‚æˆ‘æ²¡æœ‰è¿›å»çœ‹ï¼Œç›´æ¥ç¦»å¼€äº†å…¬å¸ã€‚`,
              tasks:
                "1. ä½ çš„é¦–è¦ä»»åŠ¡æ˜¯æ‰¾å‡ºçœŸå‡¶ï¼Œæ´—æ¸…è‡ªå·±çš„å«Œç–‘ï¼Œç¡®ä¿å…¬å¸ä¸‘é—»ä¸è¢«æ›å…‰ï¼Œä»¥å…å½±å“ä½ çš„èŒä¸šå‰é€”ã€‚\n2. éšè—ä½ å‘ç°ç‹å¼ºæŒªç”¨å…¬æ¬¾å¹¶å‡†å¤‡ä¸¾æŠ¥ä»–çš„äº‹å®ã€‚\n3. ä½ çœ‹åˆ°ä»–æ¡Œä¸Šçš„è¯ç“¶ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡è¦çº¿ç´¢ï¼Œä½ éœ€è¦å¼•å¯¼å¤§å®¶æ³¨æ„åˆ°è¿™ä¸€ç‚¹ã€‚",
              isKiller: false,
            },
            {
              name: "å­™ä¼Ÿ",
              description:
                "å…¬å¸çš„èµ„æ·±UIè®¾è®¡å¸ˆï¼Œä¹Ÿæ˜¯ç‹å¼ºçš„è€éƒ¨ä¸‹ï¼Œè¡¨é¢å¯¹ä»–æ¯•æ­æ¯•æ•¬ã€‚",
              storyline: `æˆ‘æ¨é€äº†ç‹å¼ºï¼ä»–å…‹æ‰£äº†æˆ‘ä»¬å›¢é˜Ÿè¾›è¾›è‹¦è‹¦åšå®Œçš„é¡¹ç›®å¥–é‡‘ï¼Œè‡ªå·±å´æ‹¿äº†å¤§å¤´ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘å€Ÿå£åŠ ç­ï¼Œå®é™…ä¸Šæ˜¯æƒ³æ½œå…¥ç‹å¼ºçš„åŠå…¬å®¤ï¼Œæ‰¾åˆ°ä»–å…‹æ‰£å¥–é‡‘çš„è¯æ®ã€‚æˆ‘çœ‹åˆ°é™ˆé™ç«¯ç€å’–å•¡è¿›å»åä¸ä¹…å°±å‡ºæ¥äº†ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘ç¡®è®¤ç‹å¼ºåŠå…¬å®¤æ²¡äººæ³¨æ„ï¼Œå°±å·å·æºœäº†è¿›å»ã€‚æˆ‘çœ‹åˆ°ä»–è¶´åœ¨æ¡Œä¸Šç¡ç€äº†ï¼Œæ—è¾¹æ˜¯é‚£æ¯å‡ ä¹æ²¡å–çš„å’–å•¡ã€‚æˆ‘åœ¨ä»–æŠ½å±‰é‡Œç¿»æ‰¾ï¼Œæœç„¶æ‰¾åˆ°äº†ä¸€ä»½å†…éƒ¨å¥–é‡‘åˆ†é…è¡¨ï¼Œè¯å®äº†ä»–ä¸­é¥±ç§å›Šã€‚æˆ‘ç”¨æ‰‹æœºæ‹äº†ä¸‹æ¥ã€‚\n**æ™šä¸Š9:30**ï¼šæˆ‘æ‹¿ç€è¯æ®æ‚„æ‚„ç¦»å¼€åŠå…¬å®¤ï¼Œå‡†å¤‡å»èŒ¶æ°´é—´å¤„ç†ä¸€ä¸‹ã€‚è¿™æ—¶è¿é¢æ’ä¸Šäº†å»å€’æ°´çš„ææ€ï¼Œæˆ‘å“äº†ä¸€è·³ï¼Œèµ¶ç´§æŠŠæ‰‹æœºè—è¿›å£è¢‹é‡Œã€‚\n**æ™šä¸Š10:00å**ï¼šæˆ‘ä¸€ç›´åœ¨è‡ªå·±çš„å·¥ä½ä¸Šï¼Œç›˜ç®—ç€æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªè¯æ®è®©ä»–èº«è´¥åè£‚ã€‚`,
              tasks:
                "1. éšè—ä½ æ›¾æ½œå…¥æ€»ç›‘åŠå…¬å®¤å¹¶å·æ‹è¯æ®çš„äº‹å®ã€‚\n2. ç‹å¼ºæ­»äº†å¯¹ä½ æœ‰åˆ©ï¼Œä½ éœ€è¦å¼•å¯¼å¤§å®¶æ€€ç–‘å…¶ä»–æœ‰åŠ¨æœºçš„äººï¼Œæ¯”å¦‚ä¸ä»–äº‰åµçš„ææ€ã€‚\n3. ä¿æŠ¤å¥½ä½ æ‰‹æœºé‡Œçš„ç…§ç‰‡è¯æ®ï¼Œè¿™æ˜¯ä½ çš„æŠ¤èº«ç¬¦ã€‚",
              isKiller: false,
            },
            {
              name: "é™ˆé™",
              description: "å…¬å¸çš„äººäº‹ä¸»ç®¡ï¼Œå¤–è¡¨æ¸©æŸ”ä½“è´´ï¼Œå–„äºå¤„ç†äººé™…å…³ç³»ã€‚",
              storyline: `æˆ‘æ›¾æ˜¯ç‹å¼ºç§˜å¯†çš„æƒ…äººï¼Œä»–æ‰¿è¯ºè¿‡ä¼šå’Œå¦»å­ç¦»å©šå¨¶æˆ‘ã€‚ä½†æœ€è¿‘ï¼Œæˆ‘å‘ç°ä»–ä¸ºäº†æ”€é™„ä¸€ä¸ªå¯Œå®¶å¥³ï¼Œå‡†å¤‡æŠ›å¼ƒæˆ‘ã€‚æ›´è®©æˆ‘ææƒ§çš„æ˜¯ï¼Œä»–æ‰‹æœºé‡Œå­˜ç€æˆ‘ä»¬å¤§é‡çš„ç§å¯†ç…§ç‰‡å’Œè§†é¢‘ï¼Œå¦‚æœæ›å…‰ï¼Œæˆ‘çš„èŒä¸šç”Ÿæ¶¯å°±å…¨æ¯äº†ã€‚\n**æ™šä¸Š8:45**ï¼šæˆ‘çŸ¥é“ç‹å¼ºæœ‰å–å’–å•¡çš„ä¹ æƒ¯ã€‚æˆ‘æå‰å‡†å¤‡äº†å¼ºæ•ˆå®‰çœ è¯ï¼Œç£¨æˆç²‰æœ«ï¼Œè—åœ¨èº«ä¸Šã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘ä»¥å…³å¿ƒä»–ä¸ºç”±ï¼Œä¸ºä»–å†²äº†ä¸€æ¯å’–å•¡ï¼Œå¹¶å°†å®‰çœ è¯å…¨éƒ¨å€’äº†è¿›å»ï¼Œç„¶åç«¯è¿›äº†ä»–çš„åŠå…¬å®¤ã€‚ä»–å½“æ—¶æ­£åœ¨å¤„ç†æ–‡ä»¶ï¼Œæ²¡æœ‰æ€€ç–‘ï¼Œå–äº†ä¸€å¤§å£ã€‚\n**æ™šä¸Š9:10**ï¼šæˆ‘å€Ÿå£ç¦»å¼€ï¼Œåœ¨å¤–é¢è§‚å¯Ÿã€‚ä¸ä¸€ä¼šå„¿ï¼Œå°±çœ‹åˆ°ä»–è¶´åœ¨æ¡Œä¸Šç¡ç€äº†ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘è¿”å›åŠå…¬å®¤ï¼Œæƒ³æ‰¾åˆ°ä»–çš„æ‰‹æœºåˆ é™¤èµ„æ–™ã€‚ä½†æˆ‘æ€ä¹ˆä¹Ÿæ‰¾ä¸åˆ°ä»–çš„æ‰‹æœºã€‚æ­¤æ—¶æˆ‘å‘ç°ä»–å·²ç»æ²¡äº†å‘¼å¸ï¼Œæˆ‘å“åäº†ï¼Œæ…Œä¹±ä¸­ï¼Œæˆ‘ä¸å°å¿ƒå°†ä»–æ¡Œä¸Šçš„ä¸€æ¡é¡¹é“¾ï¼ˆä»–å‡†å¤‡é€ç»™é‚£ä¸ªå¯Œå®¶å¥³çš„ï¼‰ç¢°æ‰ï¼Œæ‰è¿›äº†æˆ‘çš„æ‰‹æåŒ…é‡Œã€‚\n**æ™šä¸Š9:40**ï¼šæˆ‘æƒŠæ…Œå¤±æªåœ°é€ƒç¦»äº†åŠå…¬å®¤ï¼Œå›åˆ°è‡ªå·±çš„å·¥ä½å‡è£…åŠ ç­ï¼Œå¿ƒä¹±å¦‚éº»ã€‚`,
              tasks: `ã€ä½ çš„æ ¸å¿ƒä»»åŠ¡ã€‘\nè¯·éšè—ä½ ä¸ºäº†é”€æ¯è¯æ®è€Œå¤±æ‰‹ç”¨å®‰çœ è¯æ¯’æ€ç‹å¼ºçš„äº‹å®ã€‚ä½ æ˜¯æœ¬æ¡ˆçš„å”¯ä¸€çœŸå‡¶ã€‚\n\nã€ä½ çš„è¡ŒåŠ¨æŒ‡å—ã€‘\n1. å«ç¥¸ä»–äººã€‚ä½ å¯ä»¥åˆ©ç”¨ä½ çœ‹åˆ°çš„ã€å¬åˆ°çš„ä¿¡æ¯ï¼Œå°†å«Œç–‘å¼•å‘ææ€æˆ–å­™ä¼Ÿã€‚\n2. ä½ åŒ…é‡Œçš„é¡¹é“¾æ˜¯å®šæ—¶ç‚¸å¼¹ï¼Œæƒ³åŠæ³•åˆç†è§£é‡Šå®ƒçš„æ¥å†ï¼Œæˆ–è€…ç¥ä¸çŸ¥é¬¼ä¸è§‰åœ°å¤„ç†æ‰å®ƒã€‚\n3. ä½ çš„ç›®æ ‡æ˜¯è¯¯å¯¼æ‰€æœ‰äººï¼Œè®©ä»–ä»¬æŠ•å‡ºé”™è¯¯çš„å‡¶æ‰‹ã€‚`,
              isKiller: true,
            },
            {
              name: "å‘¨æ¯…",
              description: "å…¬å¸å¤§æ¥¼çš„å¤œç­ä¿å®‰ï¼Œçœ‹èµ·æ¥å¿ åšè€å®ï¼Œä½†è§‚å¯ŸåŠ›æ•é”ã€‚",
              storyline: `ä½œä¸ºä¿å®‰ï¼Œæˆ‘è´Ÿè´£å¤§æ¥¼å¤œé—´çš„å®‰å…¨å·¡é€»ã€‚\n**æ™šä¸Š8:10**ï¼šæˆ‘å·¡é€»åˆ°18æ¥¼ï¼Œå¬åˆ°æ€»ç›‘åŠå…¬å®¤é‡Œæœ‰æ¿€çƒˆçš„äº‰åµå£°ï¼Œå¥½åƒæ˜¯é‚£ä¸ªå«ææ€çš„ç¨‹åºå‘˜ï¼Œæˆ‘æ²¡æ•¢é è¿‘ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘çœ‹åˆ°äººäº‹ä¸»ç®¡é™ˆé™ç«¯ç€æ¯å’–å•¡è¿›äº†æ€»ç›‘åŠå…¬å®¤ï¼Œå‡ åˆ†é’Ÿåå°±å‡ºæ¥äº†ï¼Œçœ‹èµ·æ¥æœ‰ç‚¹ç´§å¼ ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘çœ‹åˆ°UIè®¾è®¡å¸ˆå­™ä¼Ÿï¼Œåƒåšè´¼ä¸€æ ·æºœè¿›äº†æ€»ç›‘åŠå…¬å®¤ã€‚\n**æ™šä¸Š9:40**ï¼šæˆ‘åˆçœ‹åˆ°é™ˆé™ä»æ€»ç›‘åŠå…¬å®¤å‡ºæ¥ï¼Œè¿™æ¬¡å¥¹è„¸è‰²æƒ¨ç™½ï¼Œè„šæ­¥åŒ†å¿™ï¼Œå¥½åƒä¸¢äº†é­‚ä¸€æ ·ã€‚æˆ‘è§‰å¾—å¾ˆå¥‡æ€ªï¼Œä½†æ²¡æ•¢å¤šé—®ã€‚\n**æ™šä¸Š10:30**ï¼šæˆ‘è¿›è¡Œä¾‹è¡Œæ£€æŸ¥ï¼Œå‘ç°æ€»ç›‘åŠå…¬å®¤çš„é—¨æ²¡å…³ï¼Œè¿›å»ä¸€çœ‹ï¼Œå‘ç°ç‹æ€»ç›‘å·²ç»â€¦â€¦æˆ‘ç«‹åˆ»æŠ¥äº†è­¦ã€‚`,
              tasks:
                "1. ä½ æ˜¯æœ¬æ¡ˆæœ€é‡è¦çš„ç›®å‡»è¯äººï¼Œä½ çš„ä»»åŠ¡æ˜¯è¯šå®ã€å‡†ç¡®åœ°å‘å¤§å®¶æä¾›ä½ çœ‹åˆ°çš„æ—¶é—´çº¿ç´¢ã€‚\n2. ä½ è§‰å¾—é™ˆé™çš„è¡Œä¸ºæœ€å¯ç–‘ï¼Œä½ éœ€è¦é‡ç‚¹è§‚å¯Ÿå¥¹ï¼Œå¹¶å‘å¤§å®¶è¯´æ˜ä½ çš„æ€€ç–‘ã€‚\n3. æ‰¾å‡ºå¯¹å…¬å¸æœ€æœ‰åˆ©çš„çœŸç›¸ï¼Œé¿å…äº‹ä»¶æ‰©å¤§åŒ–ã€‚",
              isKiller: false,
            },
          ],
          clues: [
            {
              owner: "ææ€",
              description:
                "ä¸€å¼ è¢«æ‰æˆä¸€å›¢ã€ä¸¢åœ¨åƒåœ¾æ¡¶é‡Œçš„ç»©æ•ˆè¯„ä¼°æŠ¥å‘Šï¼Œä¸Šé¢æœ‰ç‹å¼ºé¾™é£å‡¤èˆçš„ç­¾åå’Œâ€œä¸åˆæ ¼ï¼Œå»ºè®®è¾é€€â€çš„æ‰¹æ³¨ã€‚",
            },
            {
              owner: "èµµå¨œ",
              description:
                "ä½ çš„ç”µè„‘é‡Œæœ‰ä¸€å°æœªå‘é€çš„é‚®ä»¶ï¼Œæ”¶ä»¶äººæ˜¯é›†å›¢æ€»éƒ¨çºªæ£€å§”ï¼Œæ ‡é¢˜æ˜¯â€œå…³äºæ¯”ç‰¹æ— é™é¡¹ç›®æ€»ç›‘ç‹å¼ºæ¶‰å«Œä¸¥é‡èŒåŠ¡ä¾µå çš„å®åä¸¾æŠ¥â€ã€‚",
            },
            {
              owner: "å­™ä¼Ÿ",
              description:
                "ä½ çš„æ‰‹æœºç›¸å†Œé‡Œæœ‰ä¸€å¼ ç…§ç‰‡ï¼Œå†…å®¹æ˜¯ä¸€ä»½å†…éƒ¨å¥–é‡‘åˆ†é…è¡¨ï¼Œè¡¨æ ¼æ˜¾ç¤ºé¡¹ç›®æ€»å¥–é‡‘çš„70%éƒ½æµå‘äº†ç‹å¼ºçš„ä¸ªäººè´¦æˆ·ã€‚",
            },
            {
              owner: "é™ˆé™",
              description:
                "åœ¨ä½ çš„æ‰‹æåŒ…å¤¹å±‚é‡Œï¼Œå‘ç°äº†ä¸€æ¡ä»·å€¼ä¸è²çš„é’»çŸ³é¡¹é“¾ï¼ŒåŒ…è£…ç›’è¿˜åœ¨ï¼Œä½†æ²¡æœ‰è´ºå¡ã€‚",
              isKey: true,
            },
            {
              owner: "å‘¨æ¯…",
              description:
                "ä¸€ä»½ä¿å®‰å·¡é€»æ—¥å¿—ï¼Œæ¸…æ™°åœ°è®°å½•äº†ä½ åœ¨ä¸åŒæ—¶é—´ç‚¹çœ‹åˆ°ä¸åŒäººè¿›å‡ºæ€»ç›‘åŠå…¬å®¤çš„æƒ…å†µã€‚",
            },
            {
              owner: "å…¬å…±",
              description:
                "åœ¨èŒ¶æ°´é—´åƒåœ¾æ¡¶é‡Œå‘ç°ä¸€ä¸ªç©ºçš„å®‰çœ è¯è¯ç“¶ï¼Œä¸Šé¢çš„æ ‡ç­¾è¢«æ’•æ‰äº†ã€‚",
            },
            {
              owner: "å…¬å…±",
              description:
                "åœ¨æ­»è€…åŠå…¬æ¡Œä¸‹å‘ç°ä¸€éƒ¨æ‰‹æœºï¼Œä½†ä¸æ˜¯æ­»è€…å¸¸ç”¨çš„é‚£éƒ¨ï¼Œæ‰‹æœºå·²ç»æ²¡ç”µäº†ã€‚",
            },
          ],
          truth:
            "å‡¶æ‰‹æ˜¯äººäº‹ä¸»ç®¡é™ˆé™ã€‚å¥¹ä¸æ€»ç›‘ç‹å¼ºæœ‰ç§æƒ…ï¼Œä½†ç‹å¼ºè¿‘æœŸä¸ºäº†åˆ©ç›Šæƒ³å’Œå¥¹åˆ†æ‰‹å¹¶å¨¶ä¸€ä½å¯Œå®¶å¥³ã€‚å½“æ™šï¼Œé™ˆé™åœ¨ç‹å¼ºçš„å’–å•¡é‡Œä¸‹äº†è¿‡é‡å®‰çœ è¯ï¼Œæƒ³è®©ä»–ç¡ç€åå·èµ°ä»–æ‰‹æœºé‡Œå­˜æœ‰çš„ä¸¤äººäº²å¯†ç…§ç‰‡ã€‚ä½†ç”±äºè¯é‡è¿‡å¤§ï¼Œç‹å¼ºæ„å¤–æ­»äº¡ã€‚é™ˆé™åœ¨æ…Œä¹±ä¸­æ²¡æ‰¾åˆ°æ‰‹æœºï¼Œåè€Œä¸å°å¿ƒå°†ç‹å¼ºå‡†å¤‡é€ç»™å¯Œå®¶å¥³çš„é¡¹é“¾ç¢°è¿›äº†è‡ªå·±çš„åŒ…é‡Œã€‚",
        },
        // --- ã€å…¨æ–°å‰§æœ¬1ï¼šæ·±æµ·é—ä¹¦ã€‘ ---
        {
          id: "built_in_2",
          name: "æ·±æµ·é—ä¹¦",
          storyBackground:
            "åœ¨ä¸ä¸–éš”ç»çš„â€œå›å“å²›â€ä¸Šï¼Œè‘—åçš„æµ·æ´‹å­¦å®¶æåšå£«è¢«å‘ç°æ­»åœ¨è‡ªå·±åé”çš„ä¹¦æˆ¿ä¸­ï¼Œæ¡Œä¸Šæ”¾ç€ä¸€å°æ‰“å°çš„é—ä¹¦ï¼Œæ­»å› ä¸ºæ°°åŒ–ç‰©ä¸­æ¯’ã€‚ä¸€åœºçªå¦‚å…¶æ¥çš„é£æš´åˆ‡æ–­äº†å²›ä¸Šä¸å¤–ç•Œçš„æ‰€æœ‰è”ç³»ï¼Œå°†å‰©ä¸‹çš„å››ä¸ªäººå›°åœ¨äº†è¿™åº§å­¤å²›ä¸Šï¼šæåšå£«çš„å¾—æ„é—¨ç”Ÿã€ä¸€ä½ç«äº‰å¯¹æ‰‹ã€ä¸€ä½æ²‰é»˜å¯¡è¨€çš„æŠ€æœ¯å‘˜ï¼Œä»¥åŠä¸€ä½ä¸è¯·è‡ªæ¥çš„è®°è€…ã€‚",
          roles: [
            {
              name: "é«˜è¿œ",
              description: "æåšå£«çš„å­¦ç”Ÿï¼Œæ‰åæ¨ªæº¢ä½†é‡å¿ƒå‹ƒå‹ƒã€‚",
              storyline: `æˆ‘ä¸€ç›´è§‰å¾—è€å¸ˆçªƒå–äº†æˆ‘çš„ç ”ç©¶æˆæœã€‚ä»Šæ™šï¼Œæˆ‘æœ¬æƒ³å’Œä»–æ‘Šç‰Œã€‚\n**æ™šä¸Š7:00**ï¼šæˆ‘å’Œè€å¸ˆåœ¨å®éªŒå®¤å¤§åµä¸€æ¶ï¼Œä»–æ‰¿è®¤å‚è€ƒäº†æˆ‘çš„æ•°æ®ï¼Œä½†æ‹’ç»å…¬å¼€æ‰¿è®¤ã€‚æˆ‘æ„¤æ€’åœ°ç¦»å¼€ã€‚\n**æ™šä¸Š8:00**ï¼šæˆ‘å›åˆ°å®¿èˆï¼Œè¶Šæƒ³è¶Šæ°”ã€‚æˆ‘åˆ©ç”¨æƒé™ï¼Œè¿œç¨‹åˆ é™¤äº†éƒ¨åˆ†å¯¹ä»–æœ‰åˆ©ã€å¯¹æˆ‘ä¸åˆ©çš„æ ¸å¿ƒå®éªŒæ•°æ®ï¼Œæƒ³è®©ä»–æ— æ³•å‘å¸ƒè®ºæ–‡ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘å»é£Ÿå ‚åƒé¥­ï¼Œçœ‹åˆ°æŠ€æœ¯å‘˜é™ˆé»˜åœ¨è°ƒè¯•ç›‘æ§è®¾å¤‡ï¼Œä»–çœ‹èµ·æ¥å¿ƒäº‹é‡é‡ã€‚\n**æ™šä¸Š9:45**ï¼šæˆ‘çœ‹åˆ°è®°è€…å¼ è±åœ¨æåšå£«ä¹¦æˆ¿é—¨å£å¾˜å¾Šï¼Œä¼¼ä¹æƒ³è¿›å»ä½†åˆä¸æ•¢ã€‚`,
              tasks:
                "1. éšè—ä½ å’Œè€å¸ˆçš„å­¦æœ¯çº çº·ä»¥åŠä½ åˆ é™¤æ•°æ®çš„è¡Œä¸ºã€‚\n2. ä½ è®¤ä¸ºè‡ªå·±çš„å‰é€”å—åˆ°äº†å¨èƒï¼Œå¿…é¡»æ‰¾åˆ°çœŸå‡¶æ¥æ´—æ¸…å«Œç–‘ã€‚\n3. å¼•å¯¼å¤§å®¶æ€€ç–‘å…¶ä»–æœ‰åŠ¨æœºçš„äººã€‚",
              isKiller: false,
            },
            {
              name: "æ—é›ª",
              description: "å¦ä¸€ä½æµ·æ´‹å­¦å®¶ï¼Œä¸æåšå£«æ˜¯é•¿æœŸçš„ç«äº‰å¯¹æ‰‹ã€‚",
              storyline: `æˆ‘å’Œæåšå£«åœ¨ç«äº‰ä¸€ä¸ªé‡è¦çš„å›½é™…ç§‘ç ”åŸºé‡‘ã€‚æˆ‘çŸ¥é“ä»–è¿™æ¬¡çš„ç ”ç©¶æœ‰é‡å¤§çªç ´ã€‚\n**æ™šä¸Š7:30**ï¼šæˆ‘å»æ‰¾æåšå£«ï¼Œå¸Œæœ›ä»–èƒ½åˆ†äº«ä¸€äº›æ•°æ®ï¼Œè¢«ä»–æ— æƒ…æ‹’ç»äº†ã€‚æˆ‘ä»¬ä¸æ¬¢è€Œæ•£ã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘åœ¨è‡ªå·±çš„æˆ¿é—´é‡Œæ•´ç†èµ„æ–™ï¼Œå¬åˆ°å¤–é¢æœ‰å¥‡æ€ªçš„ç”µæµå£°ï¼Œå¥½åƒæ˜¯åœç”µäº†ä¸€ç¬é—´åˆæ¢å¤äº†ã€‚\n**æ™šä¸Š9:10**ï¼šæˆ‘å£æ¸´å»å¨æˆ¿å€’æ°´ï¼Œçœ‹åˆ°é«˜è¿œç¥è‰²æ…Œå¼ åœ°ä»æœºæˆ¿çš„æ–¹å‘å‡ºæ¥ã€‚\n**æ™šä¸Š10:00**ï¼šæˆ‘ç»è¿‡ä¹¦æˆ¿æ—¶ï¼Œé—»åˆ°ä¸€è‚¡æ·¡æ·¡çš„æä»å‘³ï¼ˆæ°°åŒ–ç‰©çš„å…¸å‹æ°”å‘³ï¼‰ï¼Œä½†æˆ‘å½“æ—¶ä»¥ä¸ºæ˜¯å®éªŒå®¤çš„åŒ–å­¦å“å‘³é“ï¼Œæ²¡æœ‰åœ¨æ„ã€‚`,
              tasks:
                "1. æåšå£«çš„æ­»å¯¹ä½ çš„åŸºé‡‘ç”³è¯·æœ‰åˆ©ï¼Œè¿™æ˜¯ä½ çš„å«Œç–‘ç‚¹ï¼Œä½ éœ€è¦æ’‡æ¸…å…³ç³»ã€‚\n2. éšè—ä½ æ›¾ç§ä¸‹æ‰¾ä»–ç´¢è¦æ•°æ®è¢«æ‹’çš„äº‹å®ã€‚\n3. ä½ é—»åˆ°çš„æä»å‘³æ˜¯å…³é”®çº¿ç´¢ï¼Œéœ€è¦è®©å¤§å®¶çŸ¥é“ã€‚",
              isKiller: false,
            },
            {
              name: "é™ˆé»˜",
              description: "ç ”ç©¶ç«™çš„æŠ€æœ¯å‘˜ï¼Œæ€§æ ¼å†…å‘ï¼Œæš—æ‹ç€æåšå£«ã€‚",
              storyline: `æˆ‘æ·±çˆ±ç€æåšå£«ï¼Œä½†å¥¹ä¼¼ä¹å¯¹æˆ‘æ¯«ä¸åœ¨æ„ã€‚æˆ‘æŒç®¡ç€æ•´ä¸ªç ”ç©¶ç«™çš„è®¾å¤‡å’Œç›‘æ§ã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘æ¥åˆ°é«˜è¿œçš„è¯·æ±‚ï¼Œä»–è®©æˆ‘â€œä¸å°å¿ƒâ€è®©ç›‘æ§ç³»ç»Ÿæ–­ç”µä¸€åˆ†é’Ÿã€‚æˆ‘è™½ç„¶è§‰å¾—å¥‡æ€ªï¼Œä½†å› ä¸ºä»–ç­”åº”å¸®æˆ‘å‘æåšå£«è¯´å¥½è¯ï¼Œæˆ‘è¿˜æ˜¯ç…§åšäº†ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘çœ‹åˆ°æåšå£«æŠŠè‡ªå·±é”åœ¨ä¹¦æˆ¿é‡Œï¼Œç¥æƒ…æ‚²ä¼¤ã€‚æˆ‘å¾ˆéš¾è¿‡ï¼Œä½†ä¸æ•¢æ‰“æ‰°ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘çœ‹åˆ°è®°è€…å¼ è±è¯•å›¾æ’¬ä¹¦æˆ¿çš„é—¨é”ï¼Œè¢«æˆ‘å‘ç°åä»–æ…Œå¿™èµ°å¼€äº†ã€‚\n**æ™šä¸Š10:30**ï¼šæˆ‘è¶Šæƒ³è¶Šä¸å¯¹åŠ²ï¼Œç”¨å¤‡ç”¨é’¥åŒ™æ‰“å¼€äº†ä¹¦æˆ¿çš„é—¨ï¼Œå‘ç°äº†åšå£«çš„å°¸ä½“ã€‚`,
              tasks:
                "1. éšè—ä½ æ›¾å—é«˜è¿œæŒ‡ä½¿ï¼Œäººä¸ºåˆ¶é€ ç›‘æ§æ–­ç”µçš„äº‹å®ã€‚\n2. ä½ æœ‰å¤‡ç”¨é’¥åŒ™ï¼Œè¿™è®©ä½ æœ‰é‡å¤§å«Œç–‘ï¼Œä½ éœ€è¦æ‰¾åˆ°åˆç†çš„è§£é‡Šã€‚\n3. ä½ æ€€ç–‘è®°è€…å¼ è±æœ‰ä¸è½¨è¡Œä¸ºã€‚",
              isKiller: false,
            },
            {
              name: "å¼ è±",
              description: "ä¸€ä½è¿½è¸ªå­¦æœ¯ä¸‘é—»çš„è®°è€…ï¼Œç§˜å¯†ç™»å²›ã€‚",
              storyline: `æˆ‘æ”¶åˆ°çº¿æŠ¥ï¼Œç§°æåšå£«çš„ç ”ç©¶æ¶‰å«Œé€ å‡ï¼Œæˆ‘æ˜¯æ¥è°ƒæŸ¥çœŸç›¸çš„ã€‚ä»Šæ™šæ˜¯æœ€å¥½çš„æœºä¼šã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘ç»•åˆ°æåšå£«ä¹¦æˆ¿çš„çª—å¤–ï¼Œçœ‹åˆ°å¥¹æ­£åœ¨ç”µè„‘å‰æ‰“å­—ï¼Œä¼¼ä¹åœ¨å†™ç€ä»€ä¹ˆé‡è¦çš„ä¸œè¥¿ã€‚æˆ‘ç”¨é•¿ç„¦ç›¸æœºæ‹ä¸‹äº†å‡ å¼ æ¨¡ç³Šçš„ç…§ç‰‡ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘å°è¯•ä»æ­£é—¨è¿›å…¥ä¹¦æˆ¿ï¼Œæƒ³æ‰¾å¥¹å½“é¢å¯¹è´¨ï¼Œä½†é—¨è¢«åé”äº†ã€‚æˆ‘è¯•å›¾ç”¨é“ä¸å¼€é”ï¼Œç»“æœè¢«æŠ€æœ¯å‘˜é™ˆé»˜æ’è§äº†ï¼Œæˆ‘åªå¥½å‡è£…è·¯è¿‡ç¦»å¼€ã€‚\n**æ™šä¸Š9:50**ï¼šæˆ‘å›åˆ°è‡ªå·±çš„ä½å¤„ï¼Œæ”¾å¤§ç›¸æœºé‡Œçš„ç…§ç‰‡ï¼Œå‘ç°å¥¹æ‰“å­—çš„å†…å®¹ä¼¼ä¹æ˜¯ä¸€å°é—ä¹¦ï¼Œä½†å†…å®¹å¾ˆå¥‡æ€ªï¼Œå¥½åƒåœ¨æš—ç¤ºä»€ä¹ˆã€‚æˆ‘è¿˜æ‹åˆ°å¥¹æ¡Œä¸Šæœ‰ä¸€ä¸ªé¥æ§å™¨ä¸€æ ·çš„ä¸œè¥¿ã€‚`,
              tasks:
                "1. éšè—ä½ è®°è€…çš„èº«ä»½å’Œä½ ç™»å²›çš„çœŸå®ç›®çš„ã€‚\n2. ä½ æ‹åˆ°çš„ç…§ç‰‡æ˜¯å…³é”®è¯æ®ï¼Œä½†ç›´æ¥æ‹¿å‡ºæ¥ä¼šæš´éœ²ä½ è‡ªå·±ã€‚ä½ éœ€è¦å·§å¦™åœ°å¼•å¯¼å¤§å®¶å‘ç°é—ä¹¦å’Œé¥æ§å™¨çš„é—®é¢˜ã€‚\n3. ä½ æ˜¯å¤–æ¥è€…ï¼Œå«Œç–‘æœ€å¤§ï¼Œå¿…é¡»å°½å¿«æ‰¾åˆ°å‡¶æ‰‹ã€‚",
              isKiller: true,
            },
          ],
          clues: [
            {
              owner: "é«˜è¿œ",
              description:
                "ä½ çš„ç”µè„‘å›æ”¶ç«™é‡Œæœ‰ä¸€ä»½æœªå‘é€çš„é‚®ä»¶ï¼Œå†…å®¹æ˜¯å‘ç«äº‰å¯¹æ‰‹çš„å…¬å¸æŠ•é€’ç®€å†ï¼Œå¹¶é™„è¨€å¯ä»¥æä¾›â€œæ¯”ç‰¹æ— é™â€çš„æ ¸å¿ƒä»£ç ã€‚",
            },
            {
              owner: "æ—é›ª",
              description:
                "åœ¨ä½ çš„æŠ½å±‰é‡Œï¼Œå‘ç°äº†ä¸€ç“¶æ ‡ç­¾è¢«æ’•æ‰çš„åŒ–å­¦è¯•å‰‚ï¼Œç»è¿‡æ£€éªŒï¼Œæ˜¯æ— æ¯’çš„è¥å…»æ¶²ã€‚",
            },
            {
              owner: "é™ˆé»˜",
              description:
                "ä¸€å¼ å·¥ä½œæ—¥å¿—ï¼Œä¸Šé¢å†™ç€â€œ20:30-20:31ï¼Œ18æ¥¼ä¸œåŒºæœåŠ¡å™¨æ„å¤–é‡å¯ï¼ŒåŸå› æ’æŸ¥ä¸­â€ã€‚",
            },
            {
              owner: "å¼ è±",
              description:
                "ä½ çš„ç›¸æœºé‡Œæœ‰å¤šå¼ ç…§ç‰‡ï¼Œå…¶ä¸­ä¸€å¼ æ¸…æ™°åœ°æ‹åˆ°æ­»è€…ç”µè„‘å±å¹•ä¸Šçš„é—ä¹¦å†…å®¹ï¼Œå¦ä¸€å¼ æ¨¡ç³Šåœ°æ‹åˆ°äº†æ¡Œä¸Šçš„ä¸€ä¸ªå°å‹é¥æ§è£…ç½®ã€‚",
              isKey: true,
            },
            {
              owner: "å…¬å…±",
              description:
                "æ­»è€…æ‰‹è¾¹çš„å’–å•¡æ¯é‡Œæ£€æµ‹å‡ºé«˜æµ“åº¦çš„æ°°åŒ–ç‰©ï¼Œä½†å¥‡æ€ªçš„æ˜¯ï¼Œå’–å•¡åŸºæœ¬æ²¡å–ã€‚",
            },
            {
              owner: "å…¬å…±",
              description:
                "ä¹¦æˆ¿çš„é€šé£å£å†…ä¾§ï¼Œå‘ç°ä¸€ä¸ªè¢«æ”¹è£…è¿‡çš„ã€è¿æ¥ç€å°å‹é›¾åŒ–å–·å˜´çš„é¥æ§é¦™è–°æœºï¼Œé‡Œé¢æ®‹ç•™æœ‰æ°°åŒ–ç‰©æ¶²ä½“ã€‚",
            },
            {
              owner: "å…¬å…±",
              description:
                "æ­»è€…çš„ç”µè„‘æµè§ˆå™¨å†å²æ˜¾ç¤ºï¼Œå¥¹åœ¨æ­»å‰æœ€åä¸€ä¸ªè®¿é—®çš„é¡µé¢æ˜¯å¥¹å·²æ•…ä¸ˆå¤«çš„çºªå¿µç½‘ç«™ã€‚",
            },
          ],
          truth:
            "å‡¶æ‰‹æ˜¯è®°è€…å¼ è±ã€‚ä»–å¹¶éæƒ³æ€æ­»æåšå£«ï¼Œè€Œæ˜¯æƒ³åˆ¶é€ æ··ä¹±ä»¥çªƒå–å­¦æœ¯é€ å‡çš„è¯æ®ã€‚ä»–æå‰åœ¨ä¹¦æˆ¿çš„é€šé£å£å®‰è£…äº†é¥æ§æ¯’æ°”è£…ç½®ï¼Œè®¡åˆ’åœ¨é‡‡è®¿æ—¶å¦‚æœæåšå£«ä¸é…åˆï¼Œå°±å°‘é‡é‡Šæ”¾è®©å¥¹æ˜è¿·ã€‚ä½†ä»–æ²¡æƒ³åˆ°ï¼Œå½“æ™šæåšå£«å› ä¸ºæ€å¿µäº¡å¤«è€Œæƒ…ç»ªä½è½ï¼Œæ­£åœ¨å†™ä¸€å°çœŸçš„é—ä¹¦ã€‚å¼ è±åœ¨çª—å¤–çœ‹åˆ°é—ä¹¦ï¼Œè¯¯ä»¥ä¸ºæ—¶æœºå·²åˆ°ï¼Œä¾¿æŒ‰ä¸‹äº†é¥æ§å™¨ï¼Œå¯¼è‡´æåšå£«å¸å…¥è¿‡é‡æ¯’æ°”èº«äº¡ã€‚ä»–ä¹‹åå°è¯•è¿›å…¥æˆ¿é—´å–å›è£…ç½®æœªæœã€‚",
        },
        // --- ã€å…¨æ–°å‰§æœ¬2ï¼šå¤å ¡é­…å½±ã€‘ ---
        {
          id: "built_in_3",
          name: "å¤å ¡é­…å½±",
          storyBackground:
            "åœ¨æµ“é›¾ç¬¼ç½©çš„åè¿œå¤å ¡é‡Œï¼Œå¯Œæœ‰è€Œå¤æ€ªçš„ä¼¯çˆµè¢«å‘ç°æ­»åœ¨åé”çš„ä¹¦æˆ¿ä¸­ï¼Œèƒ¸å£æ’ç€ä¸€æŠŠå¤è‘£æ‹†ä¿¡åˆ€ã€‚çŒ›çƒˆçš„æš´é£é›¨åˆ‡æ–­äº†åŸå ¡ä¸å¤–ç•Œçš„å”¯ä¸€æ¡¥æ¢ï¼Œæ‰€æœ‰äººéƒ½è¢«å›°äºæ­¤ï¼šä¼¯çˆµå¹´è½»è²Œç¾çš„å¦»å­ã€ä¸ä»–ç´ æœ‰å«Œéš™çš„ä¾„å­ã€è´Ÿå€ºç´¯ç´¯çš„ç§äººåŒ»ç”Ÿï¼Œä»¥åŠä¸€ä½è¢«è¯·æ¥è¿›è¡Œé™ç¥ä¼šçš„å¥³å·«ã€‚",
          roles: [
            {
              name: "å®‰å¨œ",
              description:
                "ä¼¯çˆµçš„å¹´è½»å¦»å­ï¼Œè¢«å¤–ç•Œä¼ è¨€æ˜¯ä¸ºäº†è´¢äº§æ‰å«ç»™å¹´è¿ˆçš„ä¼¯çˆµã€‚",
              storyline: `æˆ‘å—å¤Ÿäº†è¿™æ®µæ²¡æœ‰çˆ±æƒ…çš„å©šå§»ã€‚æˆ‘çˆ±ä¸Šäº†ä¾„å­çˆ±å¾·åï¼Œæˆ‘ä»¬è®¡åˆ’ç§å¥”ã€‚\n**æ™šä¸Š8:00**ï¼šæˆ‘å’Œçˆ±å¾·ååœ¨èŠ±å›­ç§˜å¯†ä¼šé¢ï¼Œå•†é‡ç§å¥”çš„ç»†èŠ‚ã€‚æˆ‘å‘Šè¯‰ä»–ï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€æ¡å¯ä»¥é€šå¾€ä¹¦æˆ¿çš„å¯†é“ã€‚\n**æ™šä¸Š9:00**ï¼šä¼¯çˆµæŠŠæˆ‘å«åˆ°ä¹¦æˆ¿ï¼Œå†æ¬¡å› ä¸ºæˆ‘è´­ä¹°å¥¢ä¾ˆå“çš„äº‹ä¸æˆ‘äº‰åµï¼Œå¹¶å¨èƒè¦ä¿®æ”¹é—å˜±ï¼Œå‰¥å¤ºæˆ‘çš„ç»§æ‰¿æƒã€‚æˆ‘æ„¤æ€’åœ°ç¦»å¼€ã€‚\n**æ™šä¸Š9:30**ï¼šæˆ‘å›åˆ°æˆ¿é—´ï¼Œæ”¶æ‹¾å¥½æˆ‘çš„ç å®å‡†å¤‡ç¦»å¼€ã€‚æ­¤æ—¶æˆ‘å¬åˆ°æ¥¼ä¸‹ä¼ æ¥ä¸€å£°å¥³äººçš„å°–å«ï¼Œä½†å¾ˆå¿«å°±æ¶ˆå¤±äº†ã€‚\n**æ™šä¸Š10:00**ï¼šæˆ‘ä»æˆ¿é—´çš„å¯†é“å…¥å£è¿›å…¥ï¼Œæƒ³å»ä¹¦æˆ¿å·èµ°é—å˜±ã€‚å½“æˆ‘ä»ä¹¦æˆ¿çš„å£ç‚‰åèµ°å‡ºæ¥æ—¶ï¼Œå‘ç°ä¼¯çˆµå·²ç»å€’åœ¨è¡€æ³Šé‡Œã€‚æˆ‘å“åäº†ï¼Œç«‹åˆ»åŸè·¯è¿”å›ï¼Œä¸æ•¢å£°å¼ ã€‚`,
              tasks:
                "1. éšè—ä½ å’Œçˆ±å¾·åçš„ç§æƒ…ä»¥åŠç§å¥”è®¡åˆ’ã€‚\n2. éšè—ä½ æ›¾é€šè¿‡å¯†é“è¿›å…¥æ¡ˆå‘ç°åœºçš„äº‹å®ã€‚\n3. ä½ è®¤ä¸ºå‡¶æ‰‹æ˜¯å…¶ä»–äººï¼Œéœ€è¦å°½å¿«æ‰¾åˆ°è¯æ®æ´—è„±å«Œç–‘ã€‚",
              isKiller: false,
            },
            {
              name: "çˆ±å¾·å",
              description:
                "ä¼¯çˆµçš„ä¾„å­ï¼Œæ”¾è¡ä¸ç¾ï¼Œæ˜¯åŸå ¡çš„æ³•å®šç»§æ‰¿äººï¼Œä½†ä¸ä¼¯çˆµå…³ç³»æ¶åŠ£ã€‚",
              storyline: `æˆ‘æ€¥éœ€ç”¨é’±ï¼Œä½†è€å®¶ä¼™ä¸€åˆ†é’±éƒ½ä¸è‚¯ç»™æˆ‘ã€‚æˆ‘ä»Šæ™šå‡†å¤‡å·ç‚¹ä¸œè¥¿å»å–ã€‚\n**æ™šä¸Š8:00**ï¼šæˆ‘å’Œå®‰å¨œåœ¨èŠ±å›­è§é¢ï¼Œå¥¹å‘Šè¯‰æˆ‘ä¸€æ¡é€šå¾€ä¹¦æˆ¿çš„å¯†é“ï¼Œè¿™æ­£åˆæˆ‘æ„ã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘çœ‹åˆ°åŒ»ç”Ÿé©¬ä¸è¡Œè‰²åŒ†åŒ†åœ°è¿›äº†ä¼¯çˆµçš„ä¹¦æˆ¿ã€‚\n**æ™šä¸Š9:10**ï¼šæˆ‘å‡†å¤‡é€šè¿‡å®‰å¨œå‘Šè¯‰æˆ‘çš„å¯†é“è¿›å…¥ä¹¦æˆ¿ï¼Œä½†åœ¨å¯†é“å£å¬åˆ°äº†é‡Œé¢æœ‰å¥‡æ€ªçš„å“åŠ¨ï¼Œæˆ‘å®³æ€•è¢«å‘ç°ï¼Œå°±é€€äº†å›æ¥ã€‚\n**æ™šä¸Š9:40**ï¼šæˆ‘åœ¨èµ°å»Šé‡Œé‡åˆ°äº†å¥³å·«ç½—å…°å¥³å£«ï¼Œå¥¹è­¦å‘Šæˆ‘ä»Šæ™šåŸå ¡ä¼šæœ‰è¡€å…‰ä¹‹ç¾ï¼Œè®©æˆ‘ä¸è¦ä¹±èµ°åŠ¨ã€‚å¥¹çš„çœ¼ç¥å¾ˆå¥‡æ€ªï¼Œè®©æˆ‘ä¸å¯’è€Œæ —ã€‚`,
              tasks:
                "1. éšè—ä½ è®¡åˆ’å·çªƒä»¥åŠçŸ¥é“å¯†é“çš„äº‹å®ã€‚\n2. ä¼¯çˆµæ­»äº†ï¼Œä½ æ˜¯æœ€å¤§å—ç›Šäººï¼Œä½ çš„å«Œç–‘æœ€å¤§ã€‚ä½ éœ€è¦å°†å«Œç–‘è½¬ç§»åˆ°ä»–äººèº«ä¸Šï¼Œæ¯”å¦‚åŒ»ç”Ÿæˆ–è¡Œä¸ºè¯¡å¼‚çš„å¥³å·«ã€‚\n3. ä½ éœ€è¦æ‰¾åˆ°å¯¹ä½ æœ‰åˆ©çš„è¯æ®ã€‚",
              isKiller: false,
            },
            {
              name: "é©¬ä¸åŒ»ç”Ÿ",
              description: "ä¼¯çˆµçš„ç§äººåŒ»ç”Ÿï¼ŒåŒ»æœ¯é«˜æ˜ï¼Œä½†æ·±é™·èµŒåšå€ºåŠ¡ã€‚",
              storyline: `æˆ‘æ¬ äº†ä¼¯çˆµä¸€å¤§ç¬”é’±ï¼Œä»–æ‹¿èµ°äº†æˆ‘çš„è¡ŒåŒ»æ‰§ç…§ä½œä¸ºæŠµæŠ¼ï¼Œå¹¶å¨èƒå¦‚æœæˆ‘è¿˜ä¸ä¸Šé’±ï¼Œå°±è®©æˆ‘èº«è´¥åè£‚ã€‚\n**æ™šä¸Š8:30**ï¼šæˆ‘å»æ‰¾ä¼¯çˆµï¼Œæ³æ±‚ä»–å†å®½é™æˆ‘ä¸€æ®µæ—¶é—´ã€‚ä»–ä¸ä»…æ‹’ç»äº†ï¼Œè¿˜ç¾è¾±äº†æˆ‘ä¸€ç•ªã€‚æˆ‘ç»æœ›åœ°ç¦»å¼€ã€‚\n**æ™šä¸Š9:00**ï¼šæˆ‘å›åˆ°æˆ‘çš„æˆ¿é—´ï¼Œå‡†å¤‡äº†ä¸€äº›å¼ºæ•ˆé•‡å®šå‰‚ï¼Œæˆ‘è®¡åˆ’è®©ä»–ç¡ç€ï¼Œç„¶åå·å›æˆ‘çš„è¡ŒåŒ»æ‰§ç…§ã€‚\n**æ™šä¸Š9:20**ï¼šæˆ‘å†æ¬¡æ¥åˆ°ä¹¦æˆ¿é—¨å£ï¼Œå´å¬åˆ°é‡Œé¢å®‰å¨œå’Œä¼¯çˆµåœ¨æ¿€çƒˆäº‰åµã€‚æˆ‘åªå¥½æš‚æ—¶æ”¾å¼ƒè®¡åˆ’ï¼Œèº²åœ¨é™„è¿‘è§‚å¯Ÿã€‚\n**æ™šä¸Š9:40å**ï¼šæˆ‘çœ‹åˆ°å®‰å¨œæ°”å†²å†²åœ°ç¦»å¼€åï¼Œå°±å†ä¹Ÿæ²¡äººè¿›å‡ºè¿‡ä¹¦æˆ¿ã€‚æˆ‘å› ä¸ºå®³æ€•ä¸€ç›´æ²¡æ•¢åŠ¨æ‰‹ï¼Œç›´åˆ°å°¸ä½“è¢«å‘ç°ã€‚`,
              tasks:
                "1. éšè—ä½ æ¬ ä¸‹å·¨é¢èµŒå€ºå¹¶è¢«ä¼¯çˆµå¨èƒçš„äº‹å®ã€‚\n2. éšè—ä½ å‡†å¤‡äº†é•‡å®šå‰‚å¹¶è®¡åˆ’å·ä¸œè¥¿çš„æ„å›¾ã€‚\n3. ä½ æ˜¯æœ€åä¸€ä¸ªè§åˆ°ä¼¯çˆµçš„äººä¹‹ä¸€ï¼Œä½ éœ€è¦è¯æ˜ä½ ç¦»å¼€åè¿˜æœ‰ä½œæ¡ˆæ—¶é—´ã€‚",
              isKiller: false,
            },
            {
              name: "ç½—å…°å¥³å£«",
              description:
                "è‘—åçš„çµåª’ã€å¥³å·«ï¼Œè¢«ä¼¯çˆµè¯·æ¥è¿›è¡Œé™ç¥ä¼šï¼Œä¸åŸå ¡çš„â€œå¹½çµâ€å¯¹è¯ã€‚",
              storyline: `æˆ‘æ˜¯ä¸ªéª—å­ã€‚ä¼¯çˆµå‘ç°äº†æˆ‘çš„ç§˜å¯†ï¼Œå¹¶ä»¥æ­¤æ•²è¯ˆæˆ‘ï¼Œè®©æˆ‘å…è´¹ä¸ºä»–â€œæœåŠ¡â€ã€‚\n**æ™šä¸Š9:10**ï¼šä¼¯çˆµæŠŠæˆ‘å«åˆ°ä¹¦æˆ¿ï¼Œå†æ¬¡å¨èƒæˆ‘ï¼Œè¯´å¦‚æœä»Šæ™šçš„é™ç¥ä¼šä¸èƒ½è®©ä»–æ»¡æ„ï¼Œå°±è¦æ­ç©¿æˆ‘çš„ä¸€åˆ‡ã€‚æˆ‘æ„Ÿåˆ°å‰æ‰€æœªæœ‰çš„ææƒ§ã€‚\n**æ™šä¸Š9:30**ï¼šæˆ‘å€Ÿå£å‡†å¤‡ä»ªå¼ï¼Œç‹¬è‡ªç•™åœ¨ä¹¦æˆ¿ã€‚ä¼¯çˆµèƒŒå¯¹ç€æˆ‘ï¼Œåœ¨æ¬£èµä¸€å¹…ç”»ã€‚æˆ‘çœ‹åˆ°æ¡Œä¸Šæœ‰ä¸€æŠŠé”‹åˆ©çš„æ‹†ä¿¡åˆ€ï¼Œä¸€æ—¶å†²åŠ¨ï¼Œæ‹¿èµ·åˆ€ä»èƒŒååˆºå‘äº†ä»–ã€‚ä»–å½“åœºå€’ä¸‹ã€‚æˆ‘å‘å‡ºä¸€å£°çŸ­ä¿ƒçš„å°–å«ï¼Œä½†ç«‹åˆ»æ‚ä½äº†å˜´ã€‚\n**æ™šä¸Š9:35**ï¼šæˆ‘æ…Œä¹±åœ°å°†ä¹¦æˆ¿é—¨ä»å†…åé”ï¼Œç„¶åä»å¢™è§’çš„ä¹¦æ¶åé¢å¯åŠ¨äº†å¯†é“ï¼ˆè¿™æ˜¯æˆ‘ä¹‹å‰å·å·å‘ç°çš„ï¼‰ï¼Œé€ƒç¦»äº†ç°åœºã€‚åœ¨å¯†é“ä¸­ï¼Œæˆ‘çš„ä¸€ç‰‡è•¾ä¸è¢–å£è¢«æŒ‚æ‰äº†ã€‚\n**æ™šä¸Š9:40**ï¼šæˆ‘ä»å¯†é“å‡ºæ¥ï¼Œé‡åˆ°äº†çˆ±å¾·åï¼Œæˆ‘æ•…ä½œç¥ç§˜åœ°è­¦å‘Šä»–æœ‰è¡€å…‰ä¹‹ç¾ï¼Œä»¥æ©é¥°æˆ‘çš„æ…Œå¼ ã€‚`,
              tasks:
                "1. ä½ æ˜¯çœŸå‡¶ï¼ä½ çš„ä»»åŠ¡æ˜¯éšè—ä¸€åˆ‡ï¼Œå°†ç½ªè¡Œå«ç¥¸ç»™ä»–äººã€‚\n2. åˆ©ç”¨ä½ â€œå¥³å·«â€çš„èº«ä»½ï¼Œç¼–é€ ä¸€äº›é¬¼ç¥ä¹‹è¯´æ¥æ··æ·†è§†å¬ã€‚\n3. çˆ±å¾·åå’Œå®‰å¨œéƒ½çŸ¥é“å¯†é“ï¼Œè¿™æ˜¯å«ç¥¸ä»–ä»¬çš„å¥½æœºä¼šã€‚é©¬ä¸åŒ»ç”Ÿæœ‰å¼ºçƒˆçš„åŠ¨æœºï¼Œä¹Ÿå¯ä»¥åŠ ä»¥åˆ©ç”¨ã€‚",
              isKiller: true,
            },
          ],
          clues: [
            {
              owner: "å®‰å¨œ",
              description:
                "ä½ çš„ç å®ç›’é‡Œæœ‰ä¸€å¼ å•ç¨‹çš„ç«è½¦ç¥¨ï¼Œç›®çš„åœ°æ˜¯å·´é»ï¼Œæ—¶é—´æ˜¯æ˜å¤©ä¸€æ—©ã€‚",
            },
            {
              owner: "çˆ±å¾·å",
              description:
                "ä½ çš„å£è¢‹é‡Œæœ‰ä¸€å¼ å½“ç¥¨ï¼Œä¸Šé¢æ˜¯ä¸€æšå±äºä¼¯çˆµå®¶æ—çš„å¤è‘£æ€€è¡¨ã€‚",
            },
            {
              owner: "é©¬ä¸åŒ»ç”Ÿ",
              description:
                "ä½ çš„è¯ç®±é‡Œæœ‰ä¸€ç“¶å‡ ä¹æ»¡è£…çš„å¼ºæ•ˆé•‡å®šå‰‚ï¼Œä»¥åŠä¸€å¼ ä¼¯çˆµå†™çš„ã€è¦æ±‚ä½ ä¸€å‘¨å†…è¿˜æ¸…10ä¸‡è‹±é•‘æ¬ æ¬¾çš„å­—æ¡ã€‚",
            },
            {
              owner: "ç½—å…°å¥³å£«",
              description:
                "ä½ çš„é•¿è£™è¢–å£å¤„æœ‰ä¸€å—æ˜æ˜¾çš„æ’•è£‚ç—•è¿¹ï¼Œä¼¼ä¹æ˜¯è¢«ä»€ä¹ˆä¸œè¥¿æŒ‚åçš„ã€‚",
              isKey: true,
            },
            {
              owner: "å…¬å…±",
              description:
                "åœ¨ä¹¦æˆ¿å£ç‚‰åé¢å‘ç°ä¸€ä¸ªéšè”½çš„æŒ‰é’®ï¼ŒæŒ‰ä¸‹åï¼Œæ—è¾¹çš„ä¸€æ•´é¢ä¹¦æ¶ä¼šæ—‹è½¬æ‰“å¼€ï¼Œéœ²å‡ºä¸€æ¡é€šå¾€æ¥¼ä¸Šèµ°å»Šçš„å¯†é“ã€‚",
            },
            {
              owner: "å…¬å…±",
              description: "åœ¨å¯†é“çš„åœ°æ¿ä¸Šï¼Œå‘ç°äº†ä¸€å°ç‰‡é»‘è‰²çš„è•¾ä¸å¸ƒæ–™ã€‚",
            },
            {
              owner: "å…¬å…±",
              description:
                "ä¼¯çˆµçš„ä¹¦æ¡Œä¸Šæ‘Šå¼€ç€ä¸€æœ¬å…³äºâ€œçµåª’ä¸æ¬ºè¯ˆâ€çš„ä¹¦ï¼Œå…¶ä¸­ä¸€é¡µç”¨çº¢ç¬”åœˆå‡ºäº†â€œç½—å…°å¥³å£«â€çš„åå­—ã€‚",
            },
          ],
          truth:
            "å‡¶æ‰‹æ˜¯å¥³å·«ç½—å…°å¥³å£«ã€‚ä¼¯çˆµå‘ç°äº†å¥¹æ˜¯ä¸ªéª—å­å¹¶ä»¥æ­¤æ•²è¯ˆå¥¹ã€‚å½“æ™šï¼Œä¼¯çˆµå†æ¬¡å¨èƒå¥¹ï¼Œç½—å…°åœ¨ææƒ§å’Œæ„¤æ€’ä¹‹ä¸‹ï¼Œç”¨æ‹†ä¿¡åˆ€ä»èƒŒåæ€å®³äº†ä¼¯ä¸»ã€‚å¥¹çŸ¥é“åŸå ¡çš„å¯†é“ï¼Œäºæ˜¯åé”æˆ¿é—¨ï¼Œé€šè¿‡å¯†é“é€ƒç¦»ï¼Œä¼ªé€ äº†å¯†å®¤æ€äººæ¡ˆã€‚ä½†æ…Œä¹±ä¸­ï¼Œå¥¹çš„ä¸€ç‰‡è•¾fä¸è¢–å£æŒ‚åœ¨äº†å¯†é“é‡Œï¼Œæˆä¸ºäº†å…³é”®è¯æ®ã€‚",
        },
      ];

      /**
       * ã€å…¨æ–°ã€‘ä»ä¸€ä¸ªå·²é¢†å®Œçš„çº¢åŒ…ä¸­æ‰¾å‡ºâ€œæ‰‹æ°”ç‹â€
       * @param {object} packet - å·²é¢†å®Œçš„çº¢åŒ…æ¶ˆæ¯å¯¹è±¡
       * @returns {object|null} - è¿”å›æ‰‹æ°”ç‹çš„ä¿¡æ¯ { name, amount }ï¼Œæˆ– null
       */
      function findLuckyKing(packet) {
        const claimedBy = packet.claimedBy || {};
        const claimedEntries = Object.entries(claimedBy);

        // å¦‚æœçº¢åŒ…æ˜¯â€œæ‹¼æ‰‹æ°”â€ç±»å‹ï¼Œå¹¶ä¸”æœ‰è¶…è¿‡1ä¸ªäººé¢†å–
        if (packet.packetType === "lucky" && claimedEntries.length > 1) {
          let luckyKing = { name: "", amount: -1 };
          claimedEntries.forEach(([name, amount]) => {
            if (amount > luckyKing.amount) {
              luckyKing = { name, amount };
            }
          });
          return luckyKing;
        }
        return null; // å¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™æ²¡æœ‰æ‰‹æ°”ç‹
      }

      // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
      window.state = {
        chats: {},
        activeChatId: null,
        globalSettings: {},
        apiConfig: {},
        userStickers: [],
        worldBooks: [],
        personaPresets: [],
        qzoneSettings: {},
        activeAlbumId: null,
      };

      const defaultAvatar = "https://i.postimg.cc/PxZrFFFL/o-o-1.jpg";
      const defaultMyGroupAvatar = "https://i.postimg.cc/cLPP10Vm/4.jpg";
      const defaultGroupMemberAvatar = "https://i.postimg.cc/VkQfgzGJ/1.jpg";
      const defaultGroupAvatar =
        "https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg";

      const GEMINI_API_URL =
        "https://generativelanguage.googleapis.com/v1beta/models";
      // geminiå¦‚æœæ˜¯å¤šä¸ªå¯†é’¥, é‚£ä¹ˆéšæœºè·å–ä¸€ä¸ª
      function getRandomValue(str) {
        // æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«é€—å·
        if (str.includes(",")) {
          // ç”¨é€—å·åˆ†éš”å­—ç¬¦ä¸²å¹¶ç§»é™¤å¤šä½™ç©ºæ ¼
          const arr = str.split(",").map((item) => item.trim());
          // ç”Ÿæˆéšæœºç´¢å¼• (0 åˆ° arr.length-1)
          const randomIndex = Math.floor(Math.random() * arr.length);
          // è¿”å›éšæœºå…ƒç´ 
          return arr[randomIndex];
        }
        // æ²¡æœ‰é€—å·åˆ™ç›´æ¥è¿”å›åŸå­—ç¬¦ä¸²
        return str;
      }
      function isImage(text, content) {
        let currentImageData = content.image_url.url;
        // æå–Base64æ•°æ®ï¼ˆå»æ‰å‰ç¼€ï¼‰
        const base64Data = currentImageData.split(",")[1];
        // æ ¹æ®å›¾ç‰‡ç±»å‹è·å–MIMEç±»å‹
        const mimeType = currentImageData.match(/^data:(.*);base64/)[1];
        return [
          { text: `${text.text}ç”¨æˆ·å‘ä½ å‘é€äº†ä¸€å¼ å›¾ç‰‡` },
          {
            inline_data: {
              mime_type: mimeType,
              data: base64Data,
            },
          },
        ];
      }

      function extractArray(text) {
        // æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ï¼šåŒ¹é…å¼€å¤´çš„æ—¶é—´æˆ³éƒ¨åˆ†å’Œåç»­çš„JSONæ•°ç»„
        const pattern = /^\(Timestamp: (\d+)\)(.*)$/s;
        const match = text.match(pattern);

        if (match) {
          const timestampPart = `(Timestamp: ${match[1]}) `;
          const jsonPart = match[2].trim();

          try {
            // å°è¯•è§£æJSONéƒ¨åˆ†
            const parsedJson = JSON.parse(jsonPart);
            // éªŒè¯è§£æç»“æœæ˜¯å¦ä¸ºæ•°ç»„
            if (Array.isArray(parsedJson)) {
              return [timestampPart, parsedJson[0]];
            }
          } catch (error) {
            // è§£æå¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡æœ¬
          }
        }

        // ä¸åŒ¹é…æ ¼å¼æˆ–è§£æå¤±è´¥æ—¶è¿”å›åŸå€¼
        return text;
      }
      function transformChatData(item) {
        let type = {
          send_and_recall: "æ’¤å›äº†æ¶ˆæ¯",
          update_status: "æ›´æ–°äº†çŠ¶æ€",
          change_music: "åˆ‡æ¢äº†æ­Œæ›²",
          create_memory: "è®°å½•äº†å›å¿†",
          create_countdown: "åˆ›å»ºäº†çº¦å®š/å€’è®¡æ—¶",
          text: "å‘é€äº†æ–‡æœ¬",
          sticker: "å‘é€äº†è¡¨æƒ…",
          ai_image: "å‘é€äº†å›¾ç‰‡",
          voice_message: "å‘é€äº†è¯­éŸ³",
          transfer: "å‘èµ·äº†è½¬è´¦",
          waimai_request: "å‘èµ·äº†å¤–å–è¯·æ±‚",
          waimai_response: {
            paid: "å›åº”äº†å¤–å–-åŒæ„",
            rejected: "å›åº”äº†å¤–å–-æ‹’ç»",
          },
          video_call_request: "å‘èµ·äº†è§†é¢‘é€šè¯",
          video_call_response: {
            accept: "å›åº”äº†è§†é¢‘é€šè¯-æ¥å—",
            reject: "å›åº”äº†è§†é¢‘é€šè¯-æ‹’ç»",
          },
          qzone_post: {
            shuoshuo: "å‘å¸ƒäº†è¯´è¯´",
            text_image: "å‘å¸ƒäº†æ–‡å­—å›¾",
          },
          qzone_comment: "è¯„è®ºäº†åŠ¨æ€",
          qzone_like: "ç‚¹èµäº†åŠ¨æ€",
          pat_user: "æ‹ä¸€æ‹äº†ç”¨æˆ·",
          block_user: "æ‹‰é»‘äº†ç”¨æˆ·",
          friend_request_response: "å›åº”äº†å¥½å‹ç”³è¯·",
          change_avatar: "æ›´æ¢äº†å¤´åƒ",
          share_link: "åˆ†äº«äº†é“¾æ¥",
          accept_transfer: "å›åº”äº†è½¬è´¦-æ¥å—",
          decline_transfer: "å›åº”äº†è½¬è´¦-æ‹’ç»/é€€æ¬¾",
          quote_reply: "å¼•ç”¨äº†å›å¤",
          text: "",
        };
        let res = extractArray(item.content);

        if (Array.isArray(res)) {
          let obj = res[1];
          let itemType = obj.type;
          let time = res[0];
          let text = type[itemType];
          if (text) {
            if (itemType === "sticker") {
              return [{ text: `${time}[${text}] å«ä¹‰æ˜¯:${obj.meaning}` }];
            } else if (itemType === "send_and_recall") {
              return [{ text: `${time}[${text}] ${obj.content}` }];
            } else if (itemType === "update_status") {
              return [
                {
                  text: `${time}[${text}] ${obj.status_text}(${obj.is_busy ? "å¿™ç¢Œ/ç¦»å¼€" : "ç©ºé—²"})`,
                },
              ];
            } else if (itemType === "change_music") {
              return [
                {
                  text: `${time}[${text}] ${obj.change_music}, æ­Œåæ˜¯:${obj.song_name}`,
                },
              ];
            } else if (itemType === "create_memory") {
              return [{ text: `${time}[${text}] ${obj.description}` }];
            } else if (itemType === "create_countdown") {
              return [{ text: `${time}[${text}] ${obj.title}(${obj.date})` }];
            } else if (itemType === "ai_image") {
              return [
                { text: `${time}[${text}] å›¾ç‰‡æè¿°æ˜¯:${obj.description}` },
              ];
            } else if (itemType === "voice_message") {
              return [{ text: `${time}[${text}] ${obj.content}` }];
            } else if (itemType === "transfer") {
              return [
                {
                  text: `${time}[${text}] é‡‘é¢æ˜¯:${obj.amount} å¤‡æ³¨æ˜¯:${obj.amount}`,
                },
              ];
            } else if (itemType === "waimai_request") {
              return [
                {
                  text: `${time}[${text}] é‡‘é¢æ˜¯:${obj.amount} å•†å“æ˜¯:${obj.productInfo}`,
                },
              ];
            } else if (itemType === "waimai_response") {
              return [
                {
                  text: `${time}[${text[obj.status]}] ${obj.status === "paid" ? "åŒæ„" : "æ‹’ç»"}`,
                },
              ];
            } else if (itemType === "video_call_request") {
              return [{ text: `${time}[${text}]` }];
            } else if (itemType === "video_call_request") {
              return [
                {
                  text: `${time}[${text[obj.decision]}] ${obj.decision === "accept" ? "åŒæ„" : "æ‹’ç»"}`,
                },
              ];
            } else if (itemType === "qzone_post") {
              return [
                {
                  text: `${time}[${text[obj.postType]}] ${
                    obj.postType === "shuoshuo"
                      ? `${obj.content}`
                      : `å›¾ç‰‡æè¿°æ˜¯:${obj.hiddenContent} ${obj.publicText ? `æ–‡æ¡ˆæ˜¯: ${obj.publicText}` : ""}`
                  }`,
                },
              ];
            } else if (itemType === "qzone_comment") {
              return [
                {
                  text: `${time}[${text}] è¯„è®ºçš„idæ˜¯: ${obj.postId} è¯„è®ºçš„å†…å®¹æ˜¯: ${obj.commentText}`,
                },
              ];
            } else if (itemType === "qzone_like") {
              return [{ text: `${time}[${text}] ç‚¹èµçš„idæ˜¯: ${obj.postId}` }];
            } else if (itemType === "pat_user") {
              return [
                { text: `${time}[${text}] ${obj.suffix ? obj.suffix : ""}` },
              ];
            } else if (itemType === "block_user") {
              return [{ text: `${time}[${text}]` }];
            } else if (itemType === "friend_request_response") {
              return [
                {
                  text: `${time}[${text}] ç»“æœæ˜¯:${obj.decision === "accept" ? "åŒæ„" : "æ‹’ç»"}`,
                },
              ];
            } else if (itemType === "change_avatar") {
              return [{ text: `${time}[${text}] å¤´åƒåæ˜¯:${obj.name}` }];
            } else if (itemType === "share_link") {
              return [
                {
                  text: `${time}[${text}] æ–‡ç« æ ‡é¢˜æ˜¯:${obj.title}  æ–‡ç« æ‘˜è¦æ˜¯:${obj.description} æ¥æºç½‘ç«™åæ˜¯:${obj.source_name} æ–‡ç« æ­£æ–‡æ˜¯:${obj.content}`,
                },
              ];
            } else if (itemType === "accept_transfer") {
              return [{ text: `${time}[${text}]` }];
            } else if (itemType === "accept_transfer") {
              return [{ text: `${time}[${text}]` }];
            } else if (itemType === "quote_reply") {
              return [
                { text: `${time}[${text}] å¼•ç”¨çš„å†…å®¹æ˜¯:${obj.reply_content}` },
              ];
            } else if (itemType === "text") {
              return [{ text: `${time}${obj.content}` }];
            }
          }

          // (ä¾‹å¦‚ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæˆ–è€…ä¸€ä¸ªAIè¿”å›çš„ã€æˆ‘ä»¬ä¸è®¤è¯†çš„JSONå¯¹è±¡)
          if (typeof res !== "string") {
            // æˆ‘ä»¬å°±å¼ºåˆ¶ä½¿ç”¨æœ€åŸå§‹ã€æœ€å®‰å…¨çš„ item.content å­—ç¬¦ä¸²
            res = item.content;
          }

          return [{ text: String(res || "") }];
        }
      }

      /**
       * ã€å·²ä¿®å¤ Gemini ç›´è¿é—®é¢˜ã€‘æ„å»º Gemini API è¯·æ±‚æ•°æ®
       * ä¿®å¤å†…å®¹ï¼š
       * 1. è‡ªåŠ¨åˆå¹¶è¿ç»­çš„ç›¸åŒè§’è‰²æ¶ˆæ¯ (è§£å†³ context ä¸¢å¤±å’Œ 400 é”™è¯¯)
       * 2. æ™ºèƒ½å»é‡ System Prompt (è§£å†³é‡å¤ç”Ÿæˆå’Œå¿½ç•¥ç”¨æˆ·è¾“å…¥)
       * 3. ç¡®ä¿ contents ä¸ä¸ºç©º (è§£å†³åŠŸèƒ½æ€§ 400 é”™è¯¯)
       */
      window.toGeminiRequestData = function (
        model,
        apiKey,
        systemInstruction,
        messagesForDecision,
        isGemini,
        temperature,
      ) {
        if (!isGemini) {
          return undefined;
        }

        let roleType = {
          user: "user",
          assistant: "model",
          system: "user", // System æ¶ˆæ¯åœ¨ Gemini ä¸­é€šå¸¸ä½œä¸º User æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†æˆ– SystemInstruction
        };

        // --- 1. é¢„å¤„ç†æ¶ˆæ¯åˆ—è¡¨ ---
        let processedMessages = [...messagesForDecision];
        let finalSystemInstruction = systemInstruction;

        // åœºæ™¯Aï¼šèŠå¤©æ¨¡å¼
        // å¦‚æœæ¶ˆæ¯åˆ—è¡¨å¾ˆé•¿ï¼Œä¸”æœ€åä¸€æ¡æ¶ˆæ¯çš„å†…å®¹ç­‰äº System Instruction
        // è¯´æ˜è¿™æ˜¯ triggerAiResponse è‡ªåŠ¨è¿½åŠ çš„ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒç§»é™¤ï¼Œé˜²æ­¢é‡å¤å’Œè¦†ç›–ç”¨æˆ·è¾“å…¥
        if (finalSystemInstruction && processedMessages.length > 1) {
          const lastMsg = processedMessages[processedMessages.length - 1];
          if (
            lastMsg.role === "system" &&
            lastMsg.content === finalSystemInstruction
          ) {
            processedMessages.pop();
          }
        }
        // åœºæ™¯Bï¼šåŠŸèƒ½ç”Ÿæˆæ¨¡å¼ (å¦‚æŸ¥æ‰‹æœºã€ç”Ÿæˆå›¾ç‰‡æè¿°)
        // è¿™ç§æƒ…å†µä¸‹ messagesForDecision é€šå¸¸åªåŒ…å«ä¸€æ¡ä¸ System Instruction ç›¸åŒçš„æ¶ˆæ¯
        // ä¸ºäº†é¿å… contents ä¸ºç©º (å¯¼è‡´400)ï¼Œæˆ‘ä»¬æ¸…ç©º systemInstruction å­—æ®µï¼Œè®©è¿™æ¡æ¶ˆæ¯ä½œä¸ºå”¯ä¸€çš„ User æ¶ˆæ¯å‘é€
        else if (processedMessages.length === 1 && finalSystemInstruction) {
          if (processedMessages[0].content === finalSystemInstruction) {
            finalSystemInstruction = ""; // æ¸…ç©ºç³»ç»ŸæŒ‡ä»¤ï¼Œä¾é  contents é‡Œçš„æ¶ˆæ¯
          }
        }

        // --- 2. æ„å»º contents æ•°ç»„ (æ ¸å¿ƒï¼šåˆå¹¶è¿ç»­è§’è‰²) ---
        const contents = [];
        let currentTurn = null;

        processedMessages.forEach((item) => {
          const targetRole = roleType[item.role] || "user";

          // å¤„ç†æ¶ˆæ¯å†…å®¹ï¼Œå…¼å®¹å¤šæ¨¡æ€ (å›¾ç‰‡) å’Œçº¯æ–‡æœ¬
          let parts = [];
          if (Array.isArray(item.content)) {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾ç‰‡
            const hasImage = item.content.some(
              (sub) => sub.type === "image_url",
            );
            if (hasImage) {
              parts = isImage(item.content[0], item.content[1]);
            } else {
              // çº¯æ–‡æœ¬æ•°ç»„è½¬å­—ç¬¦ä¸²
              parts = [{ text: JSON.stringify(item.content) }];
            }
          } else {
            // æ™®é€šå­—ç¬¦ä¸²
            const textVal = String(item.content || "");
            if (textVal.trim() === "") return; // è·³è¿‡ç©ºæ¶ˆæ¯
            parts = [{ text: textVal }];
          }

          if (parts.length === 0) return;

          // ã€å…³é”®é€»è¾‘ã€‘å¦‚æœå½“å‰æ¶ˆæ¯è§’è‰²ä¸ä¸Šä¸€æ¡ç›¸åŒï¼Œåˆ™åˆå¹¶åˆ°ä¸Šä¸€æ¡çš„ parts ä¸­
          // è¿™è®© Gemini èƒ½å¤ŸåŒæ—¶çœ‹åˆ° [ç”¨æˆ·è¾“å…¥] å’Œ [ç³»ç»Ÿè¡¥å……çš„Context]ï¼Œè€Œä¸ä¼šæŠŠå®ƒä»¬å½“æˆä¸¤è½®å¯¹è¯
          if (currentTurn && currentTurn.role === targetRole) {
            currentTurn.parts.push(...parts);
          } else {
            // å¦åˆ™ï¼Œå¼€å§‹æ–°çš„ä¸€è½®
            if (currentTurn) contents.push(currentTurn);
            currentTurn = {
              role: targetRole,
              parts: [...parts],
            };
          }
        });

        // æ¨å…¥æœ€åä¸€è½®
        if (currentTurn) contents.push(currentTurn);

        // --- 3. æœ€åçš„å…œåº•æ£€æŸ¥ ---
        // Gemini è¦æ±‚ contents ä¸èƒ½ä¸ºç©ºã€‚å¦‚æœç»è¿‡è¿‡æ»¤åä¸ºç©ºï¼Œå¿…é¡»è¡¥æ•‘ã€‚
        if (contents.length === 0) {
          if (finalSystemInstruction) {
            // å¦‚æœæœ‰ç³»ç»ŸæŒ‡ä»¤ï¼Œå°±æŠŠå®ƒæŒªåˆ° contents é‡Œä½œä¸º User æ¶ˆæ¯
            contents.push({
              role: "user",
              parts: [{ text: finalSystemInstruction }],
            });
            finalSystemInstruction = ""; // é¿å…é‡å¤
          } else {
            // å®åœ¨æ²¡ä¸œè¥¿å‘äº†ï¼Œå‘ä¸ªç©ºæ ¼é˜²æ­¢æŠ¥é”™ (æç½•è§æƒ…å†µ)
            contents.push({ role: "user", parts: [{ text: " " }] });
          }
        }

        // --- 4. ç»„è£…è¯·æ±‚ä½“ ---
        const body = {
          contents: contents,
          generationConfig: {
            temperature: parseFloat(temperature) || 0.8,
          },
        };

        // åªæœ‰å½“ systemInstruction ä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ è¯¥å­—æ®µ
        if (finalSystemInstruction && finalSystemInstruction.trim()) {
          body.systemInstruction = {
            parts: [{ text: finalSystemInstruction }],
          };
        }

        return {
          url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${getRandomValue(
            apiKey,
          )}`,
          data: {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          },
        };
      };
      document.addEventListener("DOMContentLoaded", () => {
        // ===================================================================
        // 1. æ‰€æœ‰å˜é‡å’Œå¸¸é‡å®šä¹‰
        // ===================================================================
        // å® ç‰©æ•°å€¼è¡°å‡ç›¸å…³çš„å…¨å±€å˜é‡å’Œå¸¸é‡
        const PET_DECAY_INTERVAL = 60 * 60 * 1000; // æ¯60åˆ†é’Ÿè¡°å‡ä¸€æ¬¡
        const PET_DECAY_AMOUNT = {
          // æ¯æ¬¡è¡°å‡çš„æ•°å€¼
          hunger: 5,
          happiness: 3,
        };
        let petDecayTimer = null; // ç”¨äºç®¡ç†è¡°å‡è®¡æ—¶å™¨çš„å…¨å±€å˜é‡
        let pieChartInstance = null;
        let lineChartInstance = null;

        const CHAR_PHONE_APPS = [
          {
            id: "chat",
            name: "å¾®ä¿¡",
            screen: "character-chat-list-screen",
            svg: `<svg viewBox="0 0 24 24" fill="#4CAF50"><path d="M12 2C6.48 2 2 6.48 2 12c0 2.94 1.28 5.58 3.34 7.42c-.22 1.4-.89 3.1-1.25 3.82c-.36.72.48 1.39 1.05.94c.82-.67 2.43-1.88 3.3-2.58C9.44 21.78 10.68 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2zm3.5 10.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5s1.5.67 1.5 1.5s-.67 1.5-1.5 1.5zm-7 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5s1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/></svg>`,
          },
          {
            id: "cart",
            name: "è´­ç‰©è½¦",
            screen: "character-shopping-cart-screen",
            svg: `<svg viewBox="0 0 24 24" fill="#F44336"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2s-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2s2-.9 2-2s-.9-2-2-2zm-15-14h3.27l.94 2H20c.69 0 1.25.56 1.25 1.25c0 .09-.02.18-.04.27l-3.58 6.49c-.25.44-.73.74-1.26.74H8.52l-.94-2H4.27V4H2V2h3.27z"/></svg>`,
          },
          {
            id: "memos",
            name: "å¤‡å¿˜å½•",
            screen: "character-memos-screen",
            svg: `<svg viewBox="0 0 24 24" fill="#FFC107"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>`,
          },
          {
            id: "browser",
            name: "æµè§ˆå™¨",
            screen: "character-browser-screen",
            svg: `<svg viewBox="0 0 24 24" fill="#2196F3"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1.5-12.5l3 7.5 7.5-3-7.5-3z"/></svg>`,
          },
          {
            id: "album",
            name: "ç›¸å†Œ",
            screen: "character-album-screen",
            svg: `<svg viewBox="0 0 24 24" fill="#8BC34A"><path d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11-4l2.03 2.71L16 11l4 5H8l3-4zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2z"/></svg>`,
          },
          {
            id: "bank",
            name: "é’±åŒ…",
            screen: "character-bank-screen",
            svg: `<svg viewBox="0 0 24 24" fill="#E91E63"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>`,
          },
          {
            id: "trajectory",
            name: "è¶³è¿¹",
            screen: "character-trajectory-screen",
            svg: `<svg viewBox="0 0 24 24" fill="#795548"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`,
          },
          {
            id: "app_usage",
            name: "ä½¿ç”¨è®°å½•",
            screen: "character-app-usage-screen",
            svg: `<svg viewBox="0 0 24 24" fill="#607D8B"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8s8 3.58 8 8s-3.58 8-8 8zm.5-13H11v6l5.25 3.15l.75-1.23l-4.5-2.67z"/></svg>`,
          },
          {
            id: "diary",
            name: "æ—¥è®°",
            screen: "character-diary-screen",
            svg: `<svg viewBox="0 0 24 24" fill="#009688"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83l3.75 3.75 1.83-1.83z"/></svg>`,
          },
          // è¿™å°±æ˜¯æˆ‘ä»¬æ–°åŠ çš„App
          {
            id: "appearance",
            name: "å¤–è§‚è®¾ç½®",
            screen: "character-phone-appearance-screen",
            svg: `<svg viewBox="0 0 24 24" fill="#9C27B0"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.17 14.34c-.21.21-.46.32-.71.32s-.5-.11-.71-.32l-1.41-1.41c-.2-.2-.31-.45-.31-.71 0-.26.11-.51.31-.71l1.41-1.41c.2-.2.45-.31.71-.31s.51.11.71.31l1.41 1.41c.4.4.4 1.04 0 1.41l-1.41 1.41zm3.34-5.34c-.21.21-.46.32-.71.32s-.5-.11-.71-.32L11.41 8.5c-.2-.2-.31-.45-.31-.71 0-.26.11-.51.31-.71l1.41-1.41c.2-.2.45-.31.71-.31s.51.11.71.31l1.41 1.41c.4.4.4 1.04 0 1.41l-1.41 1.41zm3.34 5.34c-.21.21-.46.32-.71.32s-.5-.11-.71-.32l-1.41-1.41c-.4-.4-.4-1.04 0-1.41l1.41-1.41c.2-.2.45-.31.71-.31s.51.11.71.31l1.41 1.41c.2.2.31.45.31.71 0 .26-.11.51-.31.71l-1.41 1.41z"/></svg>`,
          },
        ];

        const BLOCKED_API_SITES = [
          "api.pisces.ink",
          "aiapi.qzz.io",
          "api520.pro",
          "api521.pro",
          "api522.pro",
        ];

        // --- å·²ä¿®æ­£ ---

        // --- ä¿®æ­£ç»“æŸ ---
        let isUserStickerSelectionMode = false;
        let activeStickerCategoryId = "uncategorized";
        let userStickerCategories = []; // ç”¨äºç¼“å­˜ç”¨æˆ·çš„æ‰€æœ‰åˆ†ç±»

        let isCharStickerSelectionMode = false;
        let selectedCharStickers = new Set();

        let selectedUserStickers = new Set();
        let isLocked = false;
        let newLockscreenWallpaperBase64 = null;
        let newGlobalBgBase64 = null; // ç”¨äºæš‚å­˜æ–°çš„å…¨å±€èŠå¤©èƒŒæ™¯
        let newAppWallpaperBase64 = null;
        window.state.musicState = {
          isActive: false,
          activeChatId: null,
          isPlaying: false,
          playlist: [],
          currentIndex: -1,
          playMode: "order",
          totalElapsedTime: 0,
          timerId: null,

          parsedLyrics: [], // å½“å‰æ­Œæ›²è§£æåçš„æ­Œè¯æ•°ç»„
          currentLyricIndex: -1, // å½“å‰é«˜äº®çš„æ­Œè¯è¡Œç´¢å¼•
        };

        let isWorldBookEditMode = false;
        let selectedWorldBooks = new Set();

        let lyricsBarSettings = {
          fontSize: 14,
          bgOpacity: 0,
          fontColor: "#FFFFFF",
          showOnClose: true, // ã€é—®é¢˜4éœ€è¦ã€‘é»˜è®¤å¼€å¯
        };

        const audioPlayer = document.getElementById("audio-player");
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let isInnerVoiceHistoryOpen = false; // ç”¨äºè·Ÿè¸ªå†å²é¢æ¿æ˜¯å¦æ‰“å¼€

        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;
        let activeCharPhonePresetId = null; // ç”¨äºè¿½è¸ªè§’è‰²æ‰‹æœºå¤–è§‚é¢„è®¾çš„é€‰æ‹©
        let activeCharacterPhoneId = null;
        let waimaiTimers = {}; // ç”¨äºå­˜å‚¨å¤–å–å€’è®¡æ—¶
        let editingSpriteGroupId = null;
        let activeMessageTimestamp = null;

        let currentReplyContext = null; // <--- æ–°å¢è¿™è¡Œï¼Œç”¨æ¥å­˜å‚¨å½“å‰æ­£åœ¨å¼•ç”¨çš„æ¶ˆæ¯ä¿¡æ¯
        let currentSearchKeyword = ""; // ç”¨äºåœ¨æœç´¢ç»“æœä¸­é«˜äº®å…³é”®è¯
        let activePostId = null; // <-- æ–°å¢ï¼šç”¨äºå­˜å‚¨å½“å‰æ“ä½œçš„åŠ¨æ€ID

        // ä¸€ä¸ªç®€å•çš„ç½‘ç»œè¯·æ±‚å‡½æ•°
        if (typeof Http_Get_External === "undefined") {
          window.Http_Get_External = function (url) {
            return new Promise((resolve) => {
              fetch(url)
                .then((res) => res.json().catch(() => res.text()))
                .then(resolve)
                .catch(() => resolve(null));
            });
          };
        }
        async function Http_Get(url) {
          return await Http_Get_External(url);
        }

        // æ£€æŸ¥éŸ³é¢‘é“¾æ¥æ˜¯å¦çœŸçš„å¯ä»¥æ’­æ”¾
        function checkAudioAvailability(url) {
          return new Promise((resolve) => {
            const tester = new Audio();
            tester.addEventListener("loadedmetadata", () => resolve(true), {
              once: true,
            });
            tester.addEventListener("error", () => resolve(false), {
              once: true,
            });
            tester.src = url;
          });
        }

        /**
         * ç§»é™¤æ‰€æœ‰ä»£ç†ï¼Œç›´æ¥è¯·æ±‚ä½ æ‰¾åˆ°çš„ vkeys.cn API
         */
        async function searchNeteaseMusic(name, singer) {
          try {
            let searchTerm = name.replace(/\s/g, "");
            if (singer) {
              searchTerm += ` ${singer.replace(/\s/g, "")}`;
            }

            const apiUrl = `https://api.vkeys.cn/v2/music/netease?word=${encodeURIComponent(searchTerm)}`;

            console.log("æ­£åœ¨å°è¯•ç›´æ¥è¯·æ±‚:", apiUrl); // æ·»åŠ ä¸€æ¡æ—¥å¿—ï¼Œæ–¹ä¾¿æˆ‘ä»¬è°ƒè¯•

            const response = await fetch(apiUrl);

            if (!response.ok) {
              throw new Error(
                `API request failed with status ${response.status}: ${response.statusText}`,
              );
            }

            const result = await response.json();

            if (
              result.code !== 200 ||
              !result.data ||
              result.data.length === 0
            ) {
              console.log("vkeys APIè¿”å›æ— ç»“æœ:", result);
              return [];
            }

            return result.data
              .map((song) => ({
                name: song.song,
                artist: song.singer,
                id: song.id,
                cover:
                  song.cover ||
                  "https://i.postimg.cc/pT2xKzP-album-cover-placeholder.png",
                source: "netease",
              }))
              .slice(0, 15);
          } catch (e) {
            // å¦‚æœè¿™æ¬¡è¿˜å¤±è´¥ï¼Œè¯·æŠŠæµè§ˆå™¨F12æ§åˆ¶å°é‡Œçš„çº¢è‰²é”™è¯¯ä¿¡æ¯å®Œæ•´åœ°æˆªå›¾ç»™æˆ‘
            console.error("ã€vkeys API ç›´è¿ã€‘æœç´¢å¤±è´¥:", e);
            await showCustomAlert(
              "ç½‘æ˜“äº‘æ¥å£ç›´è¿å¤±è´¥",
              `å¦‚æœæµè§ˆå™¨æ§åˆ¶å°(F12)æç¤ºCORSé”™è¯¯ï¼Œè¯´æ˜æ­¤APIç¦æ­¢ç›´æ¥è®¿é—®ã€‚é”™è¯¯: ${e.message}`,
            );
            return [];
          }
        }
        /**
         * ã€å…¨æ–°ã€‘ä» GD éŸ³ä¹å°æœç´¢æ­Œæ›²åˆ—è¡¨ (èšåˆæœç´¢)
         */
        async function searchGdstudioMusic(name) {
          try {
            const searchTerm = name.replace(/\s/g, "");
            // åŒæ—¶è¯·æ±‚ç½‘æ˜“äº‘å’ŒQQéŸ³ä¹æºï¼Œç„¶ååˆå¹¶ç»“æœ
            const [neteaseResults, tencentResults] = await Promise.all([
              Http_Get(
                `https://music-api.gdstudio.xyz/api.php?btwaf=9018895&types=search&source=netease&name=${encodeURIComponent(
                  searchTerm,
                )}&count=10&pages=1`,
              ),
              Http_Get(
                `https://music-api.gdstudio.xyz/api.php?btwaf=9018895&types=search&source=tencent&name=${encodeURIComponent(
                  searchTerm,
                )}&count=10&pages=1`,
              ),
            ]);

            const combined = [
              ...(neteaseResults || []),
              ...(tencentResults || []),
            ];

            if (!combined.length) return [];

            // å¯¹ç»“æœè¿›è¡Œå»é‡å’Œæ ¼å¼åŒ–
            const uniqueSongs = new Map();
            combined.forEach((song) => {
              if (song && song.id && !uniqueSongs.has(song.id)) {
                uniqueSongs.set(song.id, {
                  name: song.name,
                  artist:
                    song.artist?.map((a) => a.name).join(" / ") ||
                    song.artist?.[0] ||
                    "æœªçŸ¥è‰ºæœ¯å®¶",
                  id: song.id,
                  // pic_id æ˜¯ä¸ºäº†è·å–ä¸“è¾‘å›¾ï¼Œid æ˜¯ä¸ºäº†è·å–æ­Œæ›²å’Œæ­Œè¯
                  pic_id: song.pic_id || song.album?.id,
                  lyric_id: song.lyric_id || song.id,
                  cover:
                    song.pic ||
                    "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png",
                  // è¿™é‡Œçš„ source æ˜¯ç»™ GD API å†…éƒ¨ä½¿ç”¨çš„ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªæ–°å­—æ®µæ¥æ ‡è®° API æä¾›å•†
                  originalSource: song.source,
                  apiProvider: "gdstudio", // æ ‡è®°è¿™æ˜¯æ¥è‡ªGDéŸ³ä¹å°çš„ç»“æœ
                });
              }
            });

            return Array.from(uniqueSongs.values());
          } catch (e) {
            console.error("ã€GD éŸ³ä¹å°ã€‘æœç´¢APIå¤±è´¥:", e);
            return [];
          }
        }

        /**
         * ä»QQéŸ³ä¹æœç´¢æ­Œæ›²åˆ—è¡¨
         */
        async function searchTencentMusic(name) {
          try {
            name = name.replace(/\s/g, "");
            const result = await Http_Get(
              `https://api.vkeys.cn/v2/music/tencent?word=${encodeURIComponent(name)}`,
            );
            if (!result?.data?.length) return [];
            return result.data
              .map((song) => ({
                name: song.song,
                artist: song.singer,
                id: song.id,
                cover:
                  song.cover ||
                  "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png",
                source: "tencent", // æ ‡è®°æ¥æº
              }))
              .slice(0, 5); // åªå–å‰5æ¡ç»“æœ
          } catch (e) {
            console.error("QQéŸ³ä¹æœç´¢APIå¤±è´¥:", e);
            return [];
          }
        }

        async function addSongFromSearch() {
          const source = await showSearchSourceSelector();
          if (!source) return;

          const searchTerm = await showCustomPrompt(
            "æœç´¢æ­Œæ›²",
            "è¯·è¾“å…¥ æ­Œå æˆ– æ­Œå-æ­Œæ‰‹",
          );
          if (!searchTerm || !searchTerm.trim()) return;

          await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨æœç´¢æ­Œæ›²èµ„æº...");

          let musicName = searchTerm.trim();
          let singerName = "";
          if (searchTerm.includes("-") || searchTerm.includes("â€“")) {
            const parts = searchTerm.split(/[-â€“]/);
            musicName = parts[0].trim();
            singerName = parts.slice(1).join(" ").trim();
          }

          let combinedResults = [];

          // â–¼â–¼â–¼ ä¿®æ”¹/æ–°å¢éƒ¨åˆ†å¼€å§‹ â–¼â–¼â–¼
          if (source === "gdstudio") {
            // å¦‚æœé€‰æ‹© "GDéŸ³ä¹å°"ï¼Œè°ƒç”¨æˆ‘ä»¬æ–°å¢çš„å‡½æ•°
            combinedResults = await searchGdstudioMusic(musicName);
          } else if (source === "all") {
            // èšåˆæœç´¢ (vkeysæ¥å£)
            const [neteaseResults, tencentResults] = await Promise.all([
              searchNeteaseMusic(musicName, singerName),
              searchTencentMusic(musicName),
            ]);
            combinedResults = [...neteaseResults, ...tencentResults];
          } else if (source === "netease") {
            // ä»…ç½‘æ˜“äº‘ (vkeysæ¥å£)
            combinedResults = await searchNeteaseMusic(musicName, singerName);
          } else if (source === "tencent") {
            // ä»…QQéŸ³ä¹ (vkeysæ¥å£)
            combinedResults = await searchTencentMusic(musicName);
          }
          // â–²â–²â–² ä¿®æ”¹/æ–°å¢éƒ¨åˆ†ç»“æŸ â–²â–²â–²

          if (combinedResults.length === 0) {
            await showCustomAlert(
              "æ— ç»“æœ",
              "æŠ±æ­‰ï¼Œåœ¨æ‰€é€‰æ¥æºä¸­æœªèƒ½æ‰¾åˆ°ç›¸å…³æ­Œæ›²ã€‚",
            );
            return;
          }

          const modal = document.getElementById("music-search-results-modal");
          const listEl = document.getElementById("search-results-list");
          listEl.innerHTML = "";

          combinedResults.forEach((song) => {
            const item = document.createElement("div");
            item.className = "search-result-item";
            item.dataset.songJson = JSON.stringify(song);

            // â–¼â–¼â–¼ ä¿®æ”¹/æ–°å¢éƒ¨åˆ†å¼€å§‹ â–¼â–¼â–¼
            // æ ¹æ® API æä¾›å•†æ˜¾ç¤ºä¸åŒçš„æ¥æºæ ‡ç­¾
            let sourceLabel = "";
            if (song.apiProvider === "gdstudio") {
              sourceLabel = "GDéŸ³ä¹å°";
            } else if (song.source === "netease") {
              sourceLabel = "ç½‘æ˜“äº‘";
            } else if (song.source === "tencent") {
              sourceLabel = "QQéŸ³ä¹";
            }

            item.innerHTML = `
                        <div class="title">${song.name}</div>
                        <div class="artist">${song.artist} <span class="source">${sourceLabel}</span></div>
                    `;
            // â–²â–²â–² ä¿®æ”¹/æ–°å¢éƒ¨åˆ†ç»“æŸ â–²â–²â–²
            listEl.appendChild(item);
          });

          modal.classList.add("visible");
        }

        async function handleSearchResultClick(songData) {
          const modal = document.getElementById("music-search-results-modal");
          modal.classList.remove("visible");

          await showCustomAlert(
            "è¯·ç¨å€™...",
            `æ­£åœ¨è·å–ã€Š${songData.name}ã€‹çš„æ’­æ”¾é“¾æ¥...`,
          );

          let playableResult = null;
          // å…¼å®¹ä¸¤ç§ source å­—æ®µ
          let finalSource = songData.originalSource || songData.source;

          // --- æ ¸å¿ƒé€»è¾‘åˆ†æ”¯ï¼šæ ¹æ® apiProvider è°ƒç”¨ä¸åŒçš„æ¥å£ ---
          if (songData.apiProvider === "gdstudio") {
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šå°† btwaf ä» 9018895 æ¢æˆ 20639888ï¼â–¼â–¼â–¼
            const gdApiUrl = `https://music-api.gdstudio.xyz/api.php?btwaf=20639888&types=url&source=${finalSource}&id=${songData.id}&br=320`;
            // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹ç»“æŸ â–²â–²â–²

            const result = await Http_Get(gdApiUrl);
            console.log("GD éŸ³ä¹å°è·å–é“¾æ¥è¿”å›:", result); // åŠ ä¸Šæ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•

            // å…¼å®¹ GD API å¯èƒ½çš„ä¸¤ç§è¿”å›æ ¼å¼ï¼Œå¹¶æ£€æŸ¥URLæ˜¯å¦ä¸ºç©º
            const songUrl = (result?.url || result?.data?.url || "").trim();

            if (songUrl && (await checkAudioAvailability(songUrl))) {
              playableResult = {
                url: songUrl,
                id: songData.id,
                source: finalSource,
                apiProvider: "gdstudio",
              };
            } else {
              console.warn("GD éŸ³ä¹å°è·å–é“¾æ¥å¤±è´¥æˆ–é“¾æ¥æ— æ•ˆ:", result);
            }
          } else {
            // --- è¿™æ˜¯ä½ åŸæ¥ä½¿ç”¨ vkeys.cn çš„é€»è¾‘ï¼Œä¿æŒä¸å˜ ---
            const primaryApiUrl =
              finalSource === "netease"
                ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
                : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
            let primaryResult = await Http_Get(primaryApiUrl);
            if (
              primaryResult?.data?.url &&
              (await checkAudioAvailability(primaryResult.data.url))
            ) {
              playableResult = {
                url: primaryResult.data.url,
                id: songData.id,
                source: finalSource,
              };
            }

            if (!playableResult) {
              await showCustomAlert(
                "è¯·ç¨å€™...",
                "ä¸»éŸ³æºè·å–å¤±è´¥ï¼Œæ­£åœ¨å°è¯•å¤‡ç”¨éŸ³æº...",
              );
              const fallbackSource =
                finalSource === "netease" ? "tencent" : "netease";
              const fallbackResults =
                fallbackSource === "tencent"
                  ? await searchTencentMusic(songData.name)
                  : await searchNeteaseMusic(songData.name, songData.artist);

              if (fallbackResults.length > 0) {
                const fallbackApiUrl =
                  fallbackSource === "netease"
                    ? `https://api.vkeys.cn/v2/music/netease?id=${fallbackResults[0].id}`
                    : `https://api.vkeys.cn/v2/music/tencent?id=${fallbackResults[0].id}`;
                const fallbackResult = await Http_Get(fallbackApiUrl);
                if (
                  fallbackResult?.data?.url &&
                  (await checkAudioAvailability(fallbackResult.data.url))
                ) {
                  playableResult = {
                    url: fallbackResult.data.url,
                    id: fallbackResults[0].id,
                    source: fallbackSource,
                  };
                  finalSource = fallbackSource;
                }
              }
            }
          }

          if (!playableResult) {
            await showCustomAlert(
              "è·å–å¤±è´¥",
              "æ— æ³•è·å–è¯¥æ­Œæ›²çš„æœ‰æ•ˆæ’­æ”¾é“¾æ¥ã€‚å¯èƒ½æ˜¯æ­Œæ›²éœ€è¦VIPæˆ–åœ°åŒºé™åˆ¶ã€‚",
            );
            return;
          }

          // è·å–æ­Œè¯ (ç°åœ¨ä¼šæ ¹æ® apiProvider è°ƒç”¨æ­£ç¡®çš„æ¥å£)
          const lrcContent =
            (await getLyricsForSong(
              playableResult.id,
              playableResult.source,
              playableResult.apiProvider,
            )) || "";

          // è·å–ä¸“è¾‘å›¾ (åªæœ‰ GD æºæ‰éœ€è¦é¢å¤–è·å–)
          let coverUrl = songData.cover;
          if (playableResult.apiProvider === "gdstudio" && songData.pic_id) {
            const picApiUrl = `https://music-api.gdstudio.xyz/api.php?btwaf=20639888&types=pic&source=${playableResult.source}&id=${songData.pic_id}&size=500`;
            const picResult = await Http_Get(picApiUrl);
            if (picResult && picResult.url) {
              coverUrl = picResult.url;
            }
          }

          // æ„å»ºæ°¸ä¹…ä¿å­˜çš„æ­Œæ›²å¯¹è±¡
          const newSong = {
            name: songData.name,
            artist: songData.artist,
            src: playableResult.url,
            cover: coverUrl,
            isLocal: false,
            lrcContent: lrcContent,
            isTemporary: false,
            addedTimestamp: Date.now(),
            musicId: playableResult.id,
            musicSource: finalSource,
            apiProvider: playableResult.apiProvider,
          };

          state.musicState.playlist.push(newSong);

          await saveGlobalPlaylist();

          updatePlaylistUI();

          if (state.musicState.currentIndex === -1) {
            state.musicState.currentIndex =
              state.musicState.playlist.length - 1;
            loadSong(state.musicState.currentIndex);
          } else {
            await showCustomAlert(
              "æ·»åŠ æˆåŠŸ",
              `ã€Š${songData.name}ã€‹å·²ä¿å­˜ï¼Œé“¾æ¥å¤±æ•ˆæ—¶ä¼šè‡ªåŠ¨æ›´æ–°ã€‚`,
            );
          }

          try {
            if (state.activeChatId) {
              const chat = state.chats[state.activeChatId];
              if (chat) {
                const hiddenMessage = {
                  role: "system",
                  content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ·»åŠ äº†æ­Œæ›²ã€Š${songData.name}ã€‹åˆ°åˆ—è¡¨ã€‚]`,
                  timestamp: Date.now(),
                  isHidden: true,
                };
                chat.history.push(hiddenMessage);
                await db.chats.put(chat);
              }
            }
          } catch (e) {}
        }

        async function getLyricsForSong(songId, source, apiProvider) {
          let url = "";
          // â–¼â–¼â–¼ ä¿®æ”¹/æ–°å¢éƒ¨åˆ†å¼€å§‹ â–¼â–¼â–¼
          if (apiProvider === "gdstudio") {
            // å¦‚æœæ˜¯GDéŸ³ä¹å°çš„ç»“æœï¼Œä½¿ç”¨GDçš„æ­Œè¯API
            url = `https://music-api.gdstudio.xyz/api.php?btwaf=20639888&types=lyric&source=${source}&id=${songId}`;
          } else {
            // å¦åˆ™ï¼Œä½¿ç”¨åŸæ¥çš„vkeysæ¥å£
            url =
              source === "netease"
                ? `https://api.vkeys.cn/v2/music/netease/lyric?id=${songId}`
                : `https://api.vkeys.cn/v2/music/tencent/lyric?id=${songId}`;
          }

          const response = await Http_Get(url);

          // å…¼å®¹ä¸¤ç§APIçš„è¿”å›æ ¼å¼
          const responseData = response?.data || response;

          if (responseData) {
            const lrc = responseData.lrc || responseData.lyric || "";
            const tlyric = responseData.tlyric || responseData.trans || "";
            return tlyric ? lrc + "\n" + tlyric : lrc;
          }
          // â–²â–²â–² ä¿®æ”¹/æ–°å¢éƒ¨åˆ†ç»“æŸ â–²â–²â–²
          return "";
        }

        /**
         * æ˜¾ç¤ºæœç´¢æºé€‰æ‹©å¼¹çª—ï¼Œå¹¶è¿”å›ç”¨æˆ·çš„é€‰æ‹©
         * @returns {Promise<string|null>} è¿”å› 'all', 'netease', 'tencent', æˆ– null
         */
        function showSearchSourceSelector() {
          return new Promise((resolve) => {
            const modal = document.getElementById(
              "music-source-selector-modal",
            );
            const confirmBtn = document.getElementById(
              "confirm-source-select-btn",
            );
            const cancelBtn = document.getElementById(
              "cancel-source-select-btn",
            );

            // æ˜¾ç¤ºå¼¹çª—
            modal.classList.add("visible");

            // å®šä¹‰ç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const onConfirm = () => {
              const selectedSource = document.querySelector(
                'input[name="search-source"]:checked',
              ).value;
              cleanup();
              resolve(selectedSource); // è¿”å›ç”¨æˆ·çš„é€‰æ‹©
            };

            // å®šä¹‰å–æ¶ˆæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const onCancel = () => {
              cleanup();
              resolve(null); // ç”¨æˆ·å–æ¶ˆï¼Œè¿”å› null
            };

            // æ¸…ç†å‡½æ•°ï¼Œç”¨äºç§»é™¤äº‹ä»¶ç›‘å¬å¹¶éšè—å¼¹çª—
            const cleanup = () => {
              modal.classList.remove("visible");
              confirmBtn.removeEventListener("click", onConfirm);
              cancelBtn.removeEventListener("click", onCancel);
            };

            // ç»‘å®šäº‹ä»¶
            confirmBtn.addEventListener("click", onConfirm);
            cancelBtn.addEventListener("click", onCancel);
          });
        }

        /**
         * æ ¹æ®æ­Œåå’Œæ­Œæ‰‹è‡ªåŠ¨æœç´¢å¹¶æ’­æ”¾æ­Œæ›²
         * @param {string} name - æ­Œæ›²å
         * @param {string} artist - æ­Œæ‰‹å
         */
        async function searchAndPlaySong(name, artist) {
          // å¼¹å‡ºæç¤ºï¼Œå‘Šè¯‰ç”¨æˆ·æˆ‘ä»¬æ­£åœ¨åšä»€ä¹ˆ
          await showCustomAlert(
            "è¯·ç¨å€™...",
            `AIä¸ºä½ åˆ†äº«äº†ã€Š${name}ã€‹ï¼Œæ­£åœ¨åŠªåŠ›å¯»æ‰¾æ’­æ”¾èµ„æº...`,
          );

          let songData = null;

          // ç­–ç•¥1ï¼šä¼˜å…ˆç”¨ç½‘æ˜“äº‘æœç´¢ (é€šå¸¸ç»“æœæ›´å‡†)
          const neteaseResults = await searchNeteaseMusic(name, artist);
          if (neteaseResults.length > 0) {
            songData = neteaseResults[0]; // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ç”¨ç¬¬ä¸€ä¸ªç»“æœ
          }
          // ç­–ç•¥2ï¼šå¦‚æœç½‘æ˜“äº‘æ‰¾ä¸åˆ°ï¼Œå†ç”¨QQéŸ³ä¹æœä¸€æ¬¡
          else {
            const tencentResults = await searchTencentMusic(name);
            if (tencentResults.length > 0) {
              songData = tencentResults[0]; // ç”¨QQéŸ³ä¹çš„ç¬¬ä¸€ä¸ªç»“æœ
            }
          }

          // å¦‚æœä¸¤ä¸ªå¹³å°éƒ½æ²¡æ‰¾åˆ°ï¼Œå°±å‘Šè¯‰ç”¨æˆ·å¹¶é€€å‡º
          if (!songData) {
            await showCustomAlert(
              "æ‰¾ä¸åˆ°æ­Œæ›²",
              `æŠ±æ­‰ï¼Œåœ¨ç½‘æ˜“äº‘å’ŒQQéŸ³ä¹éƒ½æ²¡èƒ½æ‰¾åˆ°ã€Š${name}ã€‹çš„å¯æ’­æ”¾èµ„æºã€‚`,
            );
            return;
          }

          // åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€é¦–æ­Œçš„åŸºæœ¬ä¿¡æ¯ (id, source, name, artist)
          // ä¸‹é¢çš„é€»è¾‘å°±æ˜¯è°ƒç”¨APIè·å–çœŸå®çš„æ’­æ”¾é“¾æ¥

          const apiUrl =
            songData.source === "netease"
              ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
              : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;

          const result = await Http_Get(apiUrl);

          // æ£€æŸ¥è·å–åˆ°çš„é“¾æ¥æ˜¯å¦çœŸçš„èƒ½æ’­æ”¾
          if (
            !result?.data?.url ||
            !(await checkAudioAvailability(result.data.url))
          ) {
            await showCustomAlert(
              "è·å–å¤±è´¥",
              `æ‰¾åˆ°äº†ã€Š${name}ã€‹ï¼Œä½†æ— æ³•è·å–æœ‰æ•ˆçš„æ’­æ”¾é“¾æ¥ã€‚`,
            );
            return;
          }

          // è·å–æ­Œè¯
          const lrcContent =
            (await getLyricsForSong(songData.id, songData.source)) || "";

          // å‡†å¤‡æ–°çš„æ­Œæ›²å¯¹è±¡ï¼Œå‡†å¤‡æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨
          const newSong = {
            name: songData.name,
            artist: songData.artist,
            src: result.data.url, // ä½¿ç”¨æˆ‘ä»¬åˆšåˆšè·å–åˆ°çš„çœŸå®ã€å¯æ’­æ”¾çš„URLï¼
            cover: songData.cover,
            isLocal: false,
            lrcContent: lrcContent,
            isTemporary: true, // æ ‡è®°ä¸ºä¸´æ—¶æ­Œæ›²ï¼Œ24å°æ—¶åå¯èƒ½ä¼šå¤±æ•ˆ
            addedTimestamp: Date.now(),
          };

          // æ£€æŸ¥æ’­æ”¾åˆ—è¡¨é‡Œæ˜¯ä¸æ˜¯å·²ç»æœ‰è¿™é¦–æ­Œäº†
          const existingIndex = state.musicState.playlist.findIndex(
            (t) => t.name === newSong.name && t.artist === newSong.artist,
          );
          if (existingIndex !== -1) {
            // å¦‚æœæœ‰ï¼Œç›´æ¥æ’­æ”¾å®ƒ
            playSong(existingIndex);
          } else {
            // å¦‚æœæ²¡æœ‰ï¼Œå°±æ·»åŠ åˆ°åˆ—è¡¨æœ«å°¾å†æ’­æ”¾
            state.musicState.playlist.push(newSong);
            updatePlaylistUI(); // åˆ·æ–°æ’­æ”¾åˆ—è¡¨ç•Œé¢
            playSong(state.musicState.playlist.length - 1);
          }

          // å¦‚æœâ€œä¸€èµ·å¬â€åŠŸèƒ½æ˜¯å…³é—­çš„ï¼Œå°±è‡ªåŠ¨æ‰“å¼€å®ƒ
          if (!state.musicState.isActive) {
            startListenTogetherSession(state.activeChatId);
          } else {
            // å¦‚æœå·²ç»æ˜¯æ‰“å¼€çš„ï¼Œå°±ç›´æ¥æ˜¾ç¤ºæ’­æ”¾å™¨çª—å£
            document
              .getElementById("music-player-overlay")
              .classList.add("visible");
          }
        }

        let photoViewerState = {
          isOpen: false,
          photos: [], // å­˜å‚¨å½“å‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡URL
          currentIndex: -1, // å½“å‰æ­£åœ¨æŸ¥çœ‹çš„ç…§ç‰‡ç´¢å¼•
        };

        let unreadPostsCount = 0;

        let isFavoritesSelectionMode = false;
        let selectedFavorites = new Set();

        let simulationIntervalId = null;

        let currentFrameSelection = { type: null, url: "", target: null };

        let notificationTimeout;

        const THEME_CSS_TEMPLATE = `
			/*
			  EPhone ç¾åŒ–ä»£ç æ¨¡æ¿
			  ä½¿ç”¨æ–¹æ³•:
			  1. ä¿®æ”¹ä¸‹é¢çš„é¢œè‰²ä»£ç æˆ–å›¾ç‰‡URLã€‚
			  2. ä¸éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†å¯ä»¥åˆ é™¤æˆ–ä¿æŒä¸å˜ã€‚
			  3. é¢œè‰²ä»£ç æ ¼å¼ä¸º #RRGGBB (ä¾‹å¦‚ #FFFFFF æ˜¯ç™½è‰²)ã€‚
			  4. å›¾ç‰‡URLéœ€è¦æ˜¯ç½‘ç»œç›´é“¾ã€‚
			*/

			/* === 1. æ‰‹æœºå£³ä¸åˆ˜æµ·é¢œè‰² === */
			#phone-frame {
			  background-color: #f0f0f0; /* æ‰‹æœºå£³é¢œè‰² */
			}
			.notch {
			  background-color: #1a1a1a; /* é¡¶éƒ¨â€œåˆ˜æµ·â€é¢œè‰² */
			}
			        #clock-container {  color: white;  }


			/* === 1.5. å…¨å±€ä¸»é¢˜è‰² (é‡è¦ï¼) === */
			/* è¿™ä¸ªé¢œè‰²å†³å®šäº†å¤§éƒ¨åˆ†æŒ‰é’®ã€é“¾æ¥å’Œé«˜äº®æ–‡æœ¬çš„é¢œè‰²ã€‚*/
			:root {
			  --accent-color: #007bff; /* é»˜è®¤æ˜¯è“è‰² */
			}

			/* === 2. èŠå¤©ç•Œé¢é¡¶éƒ¨å’Œåº•éƒ¨çš„å›¾ç‰‡æŒ‰é’®æ›¿æ¢ === */
			/* â€œä¸€èµ·å¬â€æŒ‰é’® (æ­£å¸¸çŠ¶æ€) */
			#listen-together-btn img[src*="8kYShvrJ/90-UI-2.png"] {
			  content: url('åœ¨è¿™é‡Œç²˜è´´ä½ çš„â€œæ­£å¸¸çŠ¶æ€â€å›¾ç‰‡URL');
			}
			/* â€œä¸€èµ·å¬â€æŒ‰é’® (æ’­æ”¾ä¸­çŠ¶æ€) */
			#listen-together-btn img[src*="D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png"] {
			  content: url('åœ¨è¿™é‡Œç²˜è´´ä½ çš„â€œæ’­æ”¾ä¸­â€å›¾ç‰‡URL');
			}
			/* â€œèŠå¤©è®¾ç½®â€æŒ‰é’® */
			#chat-settings-btn img {
			  content: url('https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png');
			}
			/* â€œè§¦å‘APIå›å¤â€æŒ‰é’® */
			#wait-reply-btn img {
			  content: url('https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png');
			}
			/* â€œå‘é€â€æŒ‰é’® (è®¾ä¸ºå›¾ç‰‡å½¢å¼) */
			#send-btn {
			  background-image: url('åœ¨è¿™é‡Œç²˜è´´ä½ çš„å‘é€æŒ‰é’®å›¾ç‰‡URL');
			  background-size: contain;
			  background-repeat: no-repeat;
			  background-position: center;
			  width: 50px; /* æ ¹æ®ä½ çš„å›¾ç‰‡è°ƒæ•´å®½åº¦ */
			}

			/* â€œé‡æ–°ç”Ÿæˆå›å¤â€æŒ‰é’® */
			#reroll-btn {
			    background-color: rgba(255, 255, 255, 0.6);
			    color: var(--text-primary); /* ä½¿ç”¨å…¨å±€ä¸»é¢˜çš„ä¸»æ–‡æœ¬é¢œè‰² */
			}

			/* === 3. é¡¶éƒ¨æ ä¸åº•éƒ¨æ é¢œè‰² === */
			.header, .qzone-header {
			  background-color: rgba(240, 240, 240, 0.8); /* é¡¶éƒ¨æ èƒŒæ™¯è‰² (å¸¦ä¸€ç‚¹é€æ˜) */
			  color: #333333; /* é¡¶éƒ¨æ æ–‡å­—é¢œè‰² */
			}
			#chat-list-bottom-nav {
			  background-color: rgba(245, 245, 245, 0.85); /* åº•éƒ¨å¯¼èˆªæ èƒŒæ™¯è‰² */
			}
			.nav-item {
			  color: #8a8a8a; /* åº•éƒ¨å¯¼èˆªæ æœªé€‰ä¸­é¡¹çš„é¢œè‰² */
			}
			.nav-item.active {
			  color: #007bff; /* åº•éƒ¨å¯¼èˆªæ é€‰ä¸­é¡¹çš„é¢œè‰² */
			}

			/* === 4. å„ç•Œé¢èƒŒæ™¯è‰² === */
			#chat-list-screen, #qzone-screen .qzone-content, #memories-view {
			  background-color: #f0f2f5 !important; /* åˆ—è¡¨é¡µä¸»èƒŒæ™¯è‰² */
			}

			/* === 5. èŠå¤©è¾“å…¥åŒºåº•éƒ¨åŠŸèƒ½æ SVGå›¾æ ‡æ›¿æ¢ === */
			/* æç¤º: ä½ éœ€è¦å°†ä½ çš„SVGä»£ç è½¬æ¢ä¸ºURLç¼–ç æ ¼å¼ã€‚
			   å¯ä»¥ä½¿ç”¨åœ¨çº¿å·¥å…·æœç´¢ "SVG to Data URI" æ¥å®Œæˆè½¬æ¢ã€‚
			   ç„¶åæ›¿æ¢æ‰ä¸‹é¢çš„ url('...') éƒ¨åˆ†ã€‚ */

			.chat-action-icon-btn {
			  background-color: rgba(255, 255, 255, 0.5); /* å›¾æ ‡æŒ‰é’®çš„èƒŒæ™¯è‰² */
			  border: 1px solid rgba(0,0,0,0.05); /* å›¾æ ‡æŒ‰é’®çš„è¾¹æ¡† */
			}

			/* è¡¨æƒ…é¢æ¿(+)æŒ‰é’® */
			#open-sticker-panel-btn svg { display: none; /* éšè—åŸå§‹SVG */ }
			#open-sticker-panel-btn {
			  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>');
			  background-size: 60%;
			  background-position: center;
			  background-repeat: no-repeat;
			}

			/* å‘é€ç…§ç‰‡(æ—§)æŒ‰é’® */
			#send-photo-btn svg { display: none; /* éšè—åŸå§‹SVG */ }
			#send-photo-btn {
			  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>');
			  background-size: 60%;
			  background-position: center;
			  background-repeat: no-repeat;
			}

			/* ä¸Šä¼ å›¾ç‰‡(æ–°)æŒ‰é’® */
			#upload-image-btn svg { display: none; }
			#upload-image-btn {
			  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: black;"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
			  background-size: 60%;
			  background-position: center;
			  background-repeat: no-repeat;
			}

			/* è½¬è´¦(ï¿¥)æŒ‰é’® */
			#transfer-btn svg { display: none; }
			#transfer-btn {
			  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 4L12 12L17 4M12 12V20M8 10H16M8 13H16"></path></svg>');
			  background-size: 60%;
			  background-position: center;
			  background-repeat: no-repeat;
			}

			/* è¯­éŸ³æŒ‰é’® */
			#voice-message-btn svg { display: none; }
			#voice-message-btn {
			  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg>');
			  background-size: 60%;
			  background-position: center;
			  background-repeat: no-repeat;
			}

			/* å¤–å–æŒ‰é’® */
			#send-waimai-request-btn svg { display: none; }
			#send-waimai-request-btn {
			  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>');
			  background-size: 60%;
			  background-position: center;
			  background-repeat: no-repeat;
			}

			/* è§†é¢‘é€šè¯æŒ‰é’® */
			#video-call-btn svg { display: none; }
			#video-call-btn {
			  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>');
			  background-size: 60%;
			  background-position: center;
			  background-repeat: no-repeat;
			}

			/* ç¾¤è§†é¢‘é€šè¯æŒ‰é’® */
			#group-video-call-btn svg { display: none; }
			#group-video-call-btn {
			  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>');
			  background-size: 60%;
			  background-position: center;
			  background-repeat: no-repeat;
			}

			/* æŠ•ç¥¨æŒ‰é’® */
			#send-poll-btn svg { display: none; }
			#send-poll-btn {
			  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10"/><path d="M6 6h.01"/><path d="M8 12h10"/><path d="M6 12h.01"/><path d="M8 18h10"/><path d="M6 18h.01"/></svg>');
			  background-size: 60%;
			  background-position: center;
			  background-repeat: no-repeat;
			}

			/* åˆ†äº«é“¾æ¥æŒ‰é’® */
			#share-link-btn svg { display: none; }
			#share-link-btn {
			  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>');
			  background-size: 60%;
			  background-position: center;
			  background-repeat: no-repeat;
			}

			/* å‘é€å®šä½æŒ‰é’® (å·²ä¿®å¤) */
			#send-location-btn svg { display: none; } /* éšè—æŒ‰é’®å†…éƒ¨åŸå§‹çš„SVGå›¾æ ‡ */
			#send-location-btn {
			  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>');
			  background-size: 60%;
			  background-position: center;
			  background-repeat: no-repeat;
			}


			/* === 6. æ›´å¤šç•Œé¢èƒŒæ™¯è‰² === */
			/* é€‚ç”¨äºæ‰€æœ‰è®¾ç½®ã€ç¼–è¾‘ã€é€‰æ‹©ç­‰äºŒçº§é¡µé¢ */
			#api-settings-screen,
			#font-settings-screen,
			#wallpaper-screen,
			#world-book-screen,
			#world-book-editor-screen,
			#contact-picker-screen,
			#member-management-screen,
			#album-screen,
			#album-photos-screen,
			#call-history-screen,
			#chat-search-screen,
			#browser-screen {
			  /* è¿™é‡Œä¸å†è®¾ç½®èƒŒæ™¯è‰²ï¼Œè®©å®ƒè‡ªç„¶ç»§æ‰¿å¤œé—´æ¨¡å¼çš„é¢œè‰² */
			}


			/* === 7. å›å¿†å¡ç‰‡ç¾åŒ– === */
			.memory-card {
			  background-color: #fffaf0 !important; /* å¡ç‰‡ä¸»èƒŒæ™¯è‰² */
			  border-left-color: #ffb74d !important; /* å·¦ä¾§è£…é¥°æ¡é¢œè‰² */
			  box-shadow: 0 2px 6px rgba(0,0,0,0.07) !important;
			}
			.memory-card .header .author {
			  color: #d98100 !important; /* ä½œè€…/æ ‡é¢˜æ–‡å­—é¢œè‰² */
			}
			.memory-card .header .date {
			  color: #a1887f !important; /* æ—¥æœŸæ–‡å­—é¢œè‰² */
			}
			.memory-card .content {
			  color: #5d4037 !important; /* å†…å®¹æ–‡å­—é¢œè‰² */
			}
			`;

        const DEFAULT_APP_ICONS = {
          "world-book": "https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg",
          qq: "https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg",
          "api-settings": "https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg",
          wallpaper: "https://i.postimg.cc/T1j03pQr/IMG-6440.jpg",
          font: "https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",
          "check-phone": "https://i.postimg.cc/RVwpwr0r/IMG-8348.jpg",
          weibo: "https://i.postimg.cc/PqBY5wBq/weibo-icon.png",
          forum: "https://i.postimg.cc/pr0T3WfC/douban-icon.png",
          "lovers-space": "https://i.postimg.cc/d1wZ39xW/lovers-space-icon.png",
          "game-hall": "https://i.postimg.cc/P5gL5z2g/game-controller-icon.png",
          "x-social": "https://i.postimg.cc/8P1H0vQ8/x-logo.png",
          taobao: "https://i.postimg.cc/k47tXg1j/taologo.png",
          "date-a-live": "https://i.postimg.cc/Kjdss1j9/1761142686734.png",
          "tukey-accounting": "https://i.postimg.cc/k4fZKVXP/tu-tu.png",
          "kk-checkin": "https://i.postimg.cc/MGwrL0nf/kitty.png",
          studio: "https://i.postimg.cc/W3sLz11s/clapperboard-icon.png",
        };

        const DEFAULT_APP_LABELS = {
          qq: "QQ",
          "world-book": "ä¸–ç•Œä¹¦",
          "api-settings": "APIè®¾ç½®",
          wallpaper: "å¤–è§‚è®¾ç½®",
          font: "å­—ä½“",
          "check-phone": "æŸ¥æ‰‹æœº",
          weibo: "å¾®åš",
          forum: "åœˆå­",
          "lovers-space": "æƒ…ä¾£ç©ºé—´",
          "game-hall": "æ¸¸æˆå¤§å…",
          "x-social": "Xç¤¾äº¤",
          taobao: "æ¡ƒå®",
          "date-a-live": "çº¦ä¼šå¤§ä½œæˆ˜",
          "tukey-accounting": "å…”å…”è®°è´¦",
          "kk-checkin": "kkæŸ¥å²—",
          studio: "lrqå°å‰§åœº",
        };
        const STICKER_REGEX =
          /^(data:image\/)|(https?:\/\/.*?\.(?:png|jpg|jpeg|gif|webp|svg|bmp|ico|tiff))|(https?:\/\/.*(?:catbox|postimg|imgbb|sinaimg|telegraph|wx[1-4])\..*)/i;
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;
        let lastKnownBatteryLevel = 1;
        let alertFlags = {
          hasShown40: false,
          hasShown20: false,
          hasShown10: false,
        };
        let batteryAlertTimeout;
        const dynamicFontStyle = document.createElement("style");
        dynamicFontStyle.id = "dynamic-font-style";
        document.head.appendChild(dynamicFontStyle);

        const modalOverlay = document.getElementById("custom-modal-overlay");
        const modalTitle = document.getElementById("custom-modal-title");
        const modalBody = document.getElementById("custom-modal-body");
        const modalConfirmBtn = document.getElementById("custom-modal-confirm");
        const modalCancelBtn = document.getElementById("custom-modal-cancel");
        let modalResolve;

        function showCustomModal() {
          modalOverlay.classList.add("visible");
        }

        function hideCustomModal() {
          modalOverlay.classList.remove("visible");
          modalConfirmBtn.classList.remove("btn-danger");
          if (modalResolve) modalResolve(null);
        }

        window.showCustomConfirm = function (title, message, options = {}) {
          return new Promise((resolve) => {
            modalResolve = resolve;
            modalTitle.textContent = title;
            modalBody.innerHTML = `<p>${message}</p>`;
            modalCancelBtn.style.display = "block";
            modalConfirmBtn.textContent = "ç¡®å®š";
            if (options.confirmButtonClass)
              modalConfirmBtn.classList.add(options.confirmButtonClass);
            modalConfirmBtn.onclick = () => {
              resolve(true);
              hideCustomModal();
            };
            modalCancelBtn.onclick = () => {
              resolve(false);
              hideCustomModal();
            };
            showCustomModal();
          });
        };

        window.showCustomAlert = function (title, message) {
          return new Promise((resolve) => {
            // 1. åªè¦ç³»ç»Ÿæƒ³å¼¹çª—ï¼Œç¬¬ä¸€ä»¶äº‹å°±æ˜¯å…³æ‰åŠ è½½åŠ¨ç”»ï¼
            const loadingOverlay =
              document.getElementById("generation-overlay");
            if (loadingOverlay) {
              loadingOverlay.classList.remove("visible");
            }

            // 2. æ­£å¸¸çš„å¼¹çª—é€»è¾‘
            modalResolve = resolve;
            modalTitle.textContent = title;
            modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
            modalCancelBtn.style.display = "none";
            modalConfirmBtn.textContent = "å¥½çš„";

            // 3. å¼ºè¡Œæé«˜å¼¹çª—å±‚çº§ï¼Œç¡®ä¿å®ƒå‹åœ¨ä¸€åˆ‡ä¹‹ä¸Š
            document.getElementById("custom-modal-overlay").style.zIndex =
              "9999";

            modalConfirmBtn.onclick = () => {
              modalCancelBtn.style.display = "block";
              modalConfirmBtn.textContent = "ç¡®å®š";
              document.getElementById("custom-modal-overlay").style.zIndex = ""; // æ¢å¤å±‚çº§
              resolve(true);
              hideCustomModal();
            };
            showCustomModal();
          });
        };

        /**
         * ã€å…¨æ–°ã€‘ä¸€ä¸ªä¸“é—¨æ¸…é™¤HTMLæ ‡ç­¾å’Œä»£ç çš„å‡½æ•°
         * @param {string} text - åŒ…å«HTMLæˆ–ä»£ç çš„åŸå§‹æ–‡æœ¬
         * @returns {string} - æ¸…ç†åçš„çº¯æ–‡æœ¬
         */
        function stripHtmlAndCode(text) {
          if (!text || typeof text !== "string") {
            return ""; // å¦‚æœè¾“å…¥ä¸ºç©ºæˆ–ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
          }
          // 1. ç§»é™¤æ‰€æœ‰HTMLæ ‡ç­¾ (ä¾‹å¦‚ <b>, <div>)
          let cleanedText = text.replace(/<\/?[^>]+(>|$)/g, "");

          // 2. ç§»é™¤æ‰€æœ‰Markdownä»£ç å— (ä¾‹å¦‚ ```code``` æˆ– `code`)
          cleanedText = cleanedText.replace(/```[\s\S]*?```/g, ""); // ç§»é™¤å¤šè¡Œä»£ç å—
          cleanedText = cleanedText.replace(/`[^`]*`/g, ""); // ç§»é™¤è¡Œå†…ä»£ç 

          // 3. å°†HTMLå®ä½“ (ä¾‹å¦‚ &lt; &gt;) è½¬æ¢å›æ­£å¸¸å­—ç¬¦ (< >)
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = cleanedText;

          return tempDiv.textContent || tempDiv.innerText || "";
        }

        window.showCustomPrompt = function (
          title,
          placeholder,
          initialValue = "",
          type = "text",
          extraHtml = "",
        ) {
          return new Promise((resolve) => {
            modalResolve = resolve;
            modalTitle.textContent = title;
            const inputId = "custom-prompt-input";

            const inputHtml =
              type === "textarea"
                ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
                : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;

            modalBody.innerHTML = extraHtml + inputHtml;
            const input = document.getElementById(inputId);

            modalBody.querySelectorAll(".format-btn").forEach((btn) => {
              btn.addEventListener("click", () => {
                const templateStr = btn.dataset.template;
                if (templateStr) {
                  try {
                    const templateObj = JSON.parse(templateStr);
                    // ä½¿ç”¨ null, 2 å‚æ•°è®©JSONå­—ç¬¦ä¸²æ ¼å¼åŒ–ï¼Œå¸¦ç¼©è¿›ï¼Œæ›´æ˜“è¯»
                    input.value = JSON.stringify(templateObj, null, 2);
                    input.focus();
                  } catch (e) {
                    console.error("è§£ææ ¼å¼æ¨¡æ¿å¤±è´¥:", e);
                  }
                }
              });
            });

            modalConfirmBtn.onclick = () => {
              resolve(input.value);
              hideCustomModal();
            };
            modalCancelBtn.onclick = () => {
              resolve(null);
              hideCustomModal();
            };
            document.getElementById("custom-modal-overlay").style.zIndex =
              "10005";
            showCustomModal();
            setTimeout(() => input.focus(), 100);
          });
        };

        /**
         * ã€å…¨æ–°ã€‘ä»ä¸€ä¸ªæ•°ç»„ä¸­éšæœºè·å–ä¸€ä¸ªå…ƒç´ 
         * @param {Array} arr - ç›®æ ‡æ•°ç»„
         * @returns {*} - æ•°ç»„ä¸­çš„ä¸€ä¸ªéšæœºå…ƒç´ 
         */
        function getRandomItem(arr) {
          // å®‰å…¨æ£€æŸ¥ï¼Œå¦‚æœæ•°ç»„ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
          if (!arr || arr.length === 0) return "";
          // è¿”å›ä¸€ä¸ªéšæœºç´¢å¼•å¯¹åº”çš„å…ƒç´ 
          return arr[Math.floor(Math.random() * arr.length)];
        }

        // ===================================================================
        // 2. æ•°æ®åº“ç»“æ„å®šä¹‰
        // ===================================================================

        // main-app.js
        // === ä¿®æ”¹å¼€å§‹ï¼šåŠ¨æ€æ•°æ®åº“ä¸éªŒè¯ ===
        var db; // å£°æ˜å…¨å±€å˜é‡ï¼Œä½†ä¸åˆå§‹åŒ–
        const APP_SECRET = "EPHONE_2026_SUPER_SECRET_KEY_V1"; // å¿…é¡»ä¸æœºå™¨äººä¸€è‡´

        // HMAC-SHA256 éªŒè¯å‡½æ•°
        function verifyLogin(uid, pwd) {
          if (!uid || !pwd) return false;

          // 1. è®¡ç®— HMAC-SHA256 (å¾—åˆ°åŸå§‹æ•°æ®)
          const rawHash = CryptoJS.HmacSHA256(uid.trim(), APP_SECRET);

          // 2. è½¬ä¸º Base64 å­—ç¬¦ä¸² (å¤©ç„¶åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—)
          let base64 = CryptoJS.enc.Base64.stringify(rawHash);

          // 3. æˆªå–å‰ 12 ä½ (å¢åŠ é•¿åº¦)
          let generated = base64.substring(0, 12);

          // 4. å¼ºåˆ¶æ’å…¥ç‰¹æ®Šç¬¦å· (å¢å¼ºå¤æ‚åº¦)
          // å°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°ç»„è¿›è¡Œæ›¿æ¢
          let chars = generated.split("");
          chars[2] = "@"; // ç¬¬3ä½å¼ºåˆ¶å˜ä¸º @
          chars[7] = "!"; // ç¬¬8ä½å¼ºåˆ¶å˜ä¸º !

          // é‡æ–°ç»„åˆ
          const correctPassword = chars.join("");

          // console.log("æ­£ç¡®å¯†ç åº”ä¸º:", correctPassword); // è°ƒè¯•ç”¨ï¼Œä¸Šçº¿å¯æ³¨é‡Š
          return pwd.trim() === correctPassword;
        }

        // åŠ¨æ€åˆå§‹åŒ–æ•°æ®åº“å‡½æ•°
        function initDatabase(userId) {
          // æ•°æ®åº“åå¸¦ä¸Šç”¨æˆ·IDï¼Œå®ç°æ¯ä¸ªäººæ•°æ®éš”ç¦»
          db = new Dexie("GeminiChatDB");
          db.version(62).stores({
            // ç‰ˆæœ¬å·ä» 51 å‡çº§åˆ° 52
            chats:
              "&id, isGroup, groupId, ownerId, isPinned, characterPhoneData, latestInnerVoice, innerVoiceHistory, loversSpaceData.emotionDiaries, settings.summary, settings.weiboNickname, settings.innerVoiceHideHeaderBorder, settings.innerVoiceAdopterLabelFormat, interactionStats, unlockedSymbols, settings.selectedIntimacyBadge",
            apiConfig: "&id",
            globalSettings: "&id, activeThemeId",
            userStickers: "&id, url, name, categoryId",
            userStickerCategories: "++id, &name",
            charStickers: "&id, url, name",
            worldBooks: "&id, name, categoryId",
            worldBookCategories: "++id, name",
            musicLibrary: "&id",
            personaPresets: "&id",
            qzoneSettings: "&id",
            qzonePosts: "++id, authorId, timestamp",
            qzoneAlbums: "++id, name, createdAt",
            qzonePhotos: "++id, albumId",
            favorites: "++id, type, timestamp, originalTimestamp",
            qzoneGroups: "++id, name",
            memories: "++id, chatId, timestamp, type, targetDate",
            callRecords: "++id, chatId, timestamp, customName",
            customAvatarFrames: "&id, name, url",
            themes: "++id, name, css",
            apiPresets: "++id, name, proxyUrl",
            bubbleStylePresets: "++id, name, css",
            fontPresets: "&id, name, url",
            homeScreenPresets: "++id, name",
            weiboPosts: "++id, authorId, timestamp",
            forumGroups: "++id, name, worldview, *categories",
            forumPosts:
              "++id, groupId, timestamp, *categories, seriesId, lengthType, chapterIndex",
            forumComments: "++id, postId, timestamp",
            forumCategories: "++id, name",
            forumSeries:
              "++id, groupId, isFollowed, updatedAt, bookshelfAddedAt",
            forumChapters: "++id, seriesId, chapterIndex, createdAt, postId",
            tarotReadings: "++id, timestamp",
            pomodoroSessions: "++id, chatId, startTime",
            scriptKillScripts: "++id, name, isBuiltIn",
            taobaoProducts: "++id, name, category",
            taobaoOrders: "++id, productId, timestamp",
            taobaoCart: "++id, productId",
            userWalletTransactions: "++id, timestamp",
            charPhonePresets: "++id, name",
            ludoQuestionBanks: "++id, name",
            ludoQuestions: "++id, bankId, text, type",
            datingScenes: "&uid, imageUrl",
            datingPresets: "++id, name, settings.spriteGroupId",
            datingSpriteGroups: "++id, name",
            datingSprites: "++id, groupId, description, url",
            datingHistory: "++id, characterId, timestamp",
            offlinePresets: "++id, name",
            elemeFoods: "++id, name, category",
            elemeOrders: "++id, recipientId, timestamp",
            studioScripts: "++id, name",
            studioHistory: "++id, timestamp",
            tukeyAccounts: "++id, category, type", // è¿™æ˜¯ä½ å·²æœ‰çš„ï¼Œä¿æŒä¸å˜
            tukeyAccountingGroups: "&id", // è®°è´¦ç¾¤èŠè®¾ç½® (id, name, members, replySettings)
            tukeyAccountingRecords:
              "++id, groupId, timestamp, isRepliedTo, accountId",
            tukeyAccountingReplies: "++id, recordId, charId", // AIçš„å›å¤è®°å½•
            tukeyUserSettings: "&id",
            tukeyCustomConfig: "&id",
            auroraBooks: "++id, title, content, addedAt",
            passerbyAvatars: "++id, url",
            clawMachineDolls: "++id, url",
          });
          // åˆ°è¿™é‡ŒåŠ ä¸‹é¢ä¸‰è¡Œ
          window.db = db;
          console.log(`[System] å·²åŠ è½½ç”¨æˆ· ${userId} çš„æ•°æ®åº“`);
        }
        // === ä¿®æ”¹ç»“æŸ ===

        // ===================================================================
        // 3. æ‰€æœ‰åŠŸèƒ½å‡½æ•°å®šä¹‰
        // ===================================================================

        /**
         * åˆ‡æ¢è¯­éŸ³æ¶ˆæ¯çš„æ–‡å­—æ˜¾ç¤º/éšè—
         * @param {HTMLElement} bubble - è¢«ç‚¹å‡»çš„è¯­éŸ³æ¶ˆæ¯çš„ .message-bubble å…ƒç´ 
         */
        function toggleVoiceTranscript(bubble) {
          if (!bubble) return;

          const transcriptEl = bubble.querySelector(".voice-transcript");
          if (!transcriptEl) return;

          // æ ¸å¿ƒé€»è¾‘ï¼šç›´æ¥æ£€æŸ¥æ–‡å­—åŒºåŸŸå½“å‰æ˜¯ä¸æ˜¯æ˜¾ç¤ºçŠ¶æ€
          const isCurrentlyExpanded = transcriptEl.style.display === "block";

          if (isCurrentlyExpanded) {
            // å¦‚æœæ˜¯å±•å¼€çš„ï¼Œå°±ç›´æ¥æ”¶èµ·æ¥
            transcriptEl.style.display = "none";
          } else {
            // å¦‚æœæ˜¯æ”¶èµ·çš„ï¼Œå°±æ‰§è¡Œå±•å¼€æµç¨‹

            // 1. å…ˆæ˜¾ç¤ºä¸€ä¸ªâ€œæ­£åœ¨è½¬å†™â€çš„æç¤ºï¼Œç»™ç”¨æˆ·å³æ—¶åé¦ˆ
            transcriptEl.textContent = "æ­£åœ¨è½¬æ–‡å­—...";
            transcriptEl.style.display = "block";

            // 2. æ¨¡æ‹Ÿä¸€ä¸ªçŸ­æš‚çš„â€œè¯†åˆ«â€è¿‡ç¨‹
            setTimeout(() => {
              // å†æ¬¡æ£€æŸ¥å…ƒç´ æ˜¯å¦è¿˜åœ¨é¡µé¢ä¸Šï¼Œé˜²æ­¢ç”¨æˆ·åˆ‡æ¢èŠå¤©å¯¼è‡´é”™è¯¯
              if (document.body.contains(transcriptEl)) {
                // è·å–å¹¶æ˜¾ç¤ºçœŸæ­£çš„è½¬å†™æ–‡å­—
                const voiceText = bubble.dataset.voiceText || "(æ— æ³•è¯†åˆ«)";
                transcriptEl.textContent = voiceText;
              }
            }, 300); // 300æ¯«ç§’çš„å»¶è¿Ÿï¼Œæ„Ÿè§‰æ›´çµæ•
          }
        }

        /**
         * ã€V2æ™ºèƒ½ç‰ˆã€‘åº”ç”¨æŒ‡å®šçš„ä¸»é¢˜ï¼Œå¹¶æ™ºèƒ½åˆ·æ–°å½“å‰æ‰“å¼€çš„ä»»ä½•ç•Œé¢
         * @param {string} theme - 'light' æˆ– 'dark'
         */
        function applyTheme(theme) {
          const phoneScreen = document.getElementById("phone-screen");
          const toggleSwitch = document.getElementById("theme-toggle-switch");

          const isDark = theme === "dark";

          // æ ¸å¿ƒæ“ä½œï¼šä¸ºæ‰‹æœºå±å¹•æ·»åŠ æˆ–ç§»é™¤ .dark-mode ç±»
          phoneScreen.classList.toggle("dark-mode", isDark);

          // åŒæ­¥å¼€å…³çš„çŠ¶æ€
          if (toggleSwitch) {
            toggleSwitch.checked = isDark;
          }

          // ä¿å­˜ç”¨æˆ·çš„é€‰æ‹©
          localStorage.setItem("ephone-theme", theme);

          // ä¸å†åªå…³å¿ƒèŠå¤©ç•Œé¢ï¼Œè€Œæ˜¯æ‰¾å‡ºå½“å‰ç©¶ç«Ÿæ˜¯å“ªä¸ªç•Œé¢å¤„äºæ¿€æ´»çŠ¶æ€
          const activeScreen = document.querySelector(".screen.active");
          if (!activeScreen) return; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±é€€å‡º

          // æ ¹æ®å½“å‰æ¿€æ´»çš„ç•Œé¢IDï¼Œè°ƒç”¨å®ƒä¸“å±çš„åˆ·æ–°å‡½æ•°
          switch (activeScreen.id) {
            case "chat-interface-screen":
              if (state.activeChatId) {
                renderChatInterface(state.activeChatId);
              }
              break;
            case "wallpaper-screen":
              // å¤–è§‚è®¾ç½®é¡µä¹Ÿéœ€è¦é‡æ–°æ¸²æŸ“æ¥åº”ç”¨æ–°ä¸»é¢˜
              renderWallpaperScreen();
              break;
            case "font-settings-screen":
              // å­—ä½“é¢„è®¾é¡µåŒæ ·éœ€è¦
              renderFontPresets();
              break;
            // å¦‚æœæœªæ¥è¿˜æœ‰å…¶ä»–é¡µé¢éœ€è¦é€‚é…ï¼Œåœ¨è¿™é‡Œæ·»åŠ  case å³å¯
          }
        }

        /**
         * å½“ç”¨æˆ·ç‚¹å‡»å¼€å…³æ—¶ï¼Œåˆ‡æ¢å½“å‰çš„ä¸»é¢˜
         */
        function toggleTheme() {
          const toggleSwitch = document.getElementById("theme-toggle-switch");
          // ç›´æ¥æ ¹æ®å¼€å…³çš„é€‰ä¸­çŠ¶æ€æ¥å†³å®šæ–°ä¸»é¢˜
          const newTheme = toggleSwitch.checked ? "dark" : "light";
          applyTheme(newTheme);
        }
        /**
         * ã€å…¨æ–°ã€‘åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼Œé¢„åŠ è½½æ‰€æœ‰å·²ä¿å­˜çš„å­—ä½“é¢„è®¾
         */
        async function loadAllFontPresetsOnStartup() {
          console.log("æ­£åœ¨é¢„åŠ è½½æ‰€æœ‰å­—ä½“é¢„è®¾...");
          const presets = await db.fontPresets.toArray();
          if (presets && presets.length > 0) {
            presets.forEach((preset) => {
              // æˆ‘ä»¬å¤ç”¨å·²æœ‰çš„ loadFontForPreview å‡½æ•°æ¥åŠ è½½æ¯ä¸ªå­—ä½“
              loadFontForPreview(preset);
            });
            console.log(`æˆåŠŸé¢„åŠ è½½äº† ${presets.length} ä¸ªå­—ä½“ã€‚`);
          }
        }

        /**
         * æ¸²æŸ“å­—ä½“é¢„è®¾çš„10ä¸ªå¡æ§½
         */
        async function renderFontPresets() {
          const container = document.getElementById("font-preset-container");
          container.innerHTML = ""; // æ¸…ç©ºæ—§å†…å®¹

          // 1. ä»æ•°æ®åº“è¯»å–æ‰€æœ‰å·²ä¿å­˜çš„é¢„è®¾ï¼Œå¹¶ç¡®ä¿å®ƒæ˜¯ä¸€ä¸ªæ•°ç»„
          const presets = (await db.fontPresets.toArray()) || [];

          // æˆ‘ä»¬ä¸å†ä¾èµ– presets çš„é•¿åº¦æ¥å¾ªç¯ï¼Œè€Œæ˜¯æ— æ¡ä»¶åœ°å¾ªç¯10æ¬¡ï¼Œåˆ›å»º10ä¸ªå¡æ§½ã€‚
          for (let i = 0; i < 10; i++) {
            const slot = document.createElement("div");
            slot.className = "font-preset-slot";

            // 3. åœ¨å¾ªç¯å†…éƒ¨ï¼Œå†åˆ¤æ–­å½“å‰ç´¢å¼• i æ˜¯å¦åœ¨å·²ä¿å­˜çš„ presets æ•°ç»„ä¸­æœ‰å¯¹åº”çš„æ•°æ®ã€‚
            const preset = presets[i];

            if (preset) {
              // å¦‚æœè¿™ä¸ªå¡æ§½æœ‰æ•°æ®ï¼Œå°±æ¸²æŸ“æˆâ€œå·²å¡«å……â€çš„æ ·å¼
              slot.innerHTML = `
			                <div class="font-preview-text" data-preset-id="${preset.id}">Abc ä½ å¥½</div>
			                <div class="font-preset-info">åç§°: ${preset.name}</div>
			                <div class="font-preset-actions">
			                    <button class="preset-btn apply-btn" data-preset-id="${preset.id}">åº”ç”¨</button>
			                    <button class="preset-btn delete-btn delete" data-preset-id="${preset.id}">åˆ é™¤</button>
			                </div>
			            `;
            } else {
              // å¦‚æœè¿™ä¸ªå¡æ§½åœ¨æ•°æ®åº“ä¸­æ²¡æœ‰å¯¹åº”çš„æ•°æ®ï¼Œå°±æ¸²æŸ“æˆâ€œç©ºå¡æ§½â€çš„æ ·å¼
              slot.classList.add("empty");
              slot.innerHTML = `
			                <div class="font-preset-info">å¡æ§½ ${i + 1} ä¸ºç©º</div>
			                <div class="font-preset-actions">
			                    <button class="preset-btn secondary upload-url-btn" data-slot-index="${i}">URLä¸Šä¼ </button>
			                    <button class="preset-btn secondary upload-local-btn" data-slot-index="${i}">æœ¬åœ°ä¸Šä¼ </button>
			                </div>
			            `;
            }
            // 4. å°†åˆ›å»ºå¥½çš„å¡æ§½ï¼ˆæ— è®ºç©ºçš„è¿˜æ˜¯æ»¡çš„ï¼‰æ·»åŠ åˆ°å®¹å™¨ä¸­
            container.appendChild(slot);
          }

          // 5. é¢„è§ˆå­—ä½“å’Œç»‘å®šäº‹ä»¶çš„é€»è¾‘ä¿æŒä¸å˜
          presets.forEach((preset) => {
            if (preset) {
              loadFontForPreview(preset);
            }
          });

          addFontPresetButtonListeners();
        }

        /**
         * ä¸ºå•ä¸ªé¢„è®¾åŠ è½½å­—ä½“ä»¥ä¾›é¢„è§ˆ
         * @param {object} preset - å­—ä½“é¢„è®¾å¯¹è±¡ {id, name, url}
         */
        function loadFontForPreview(preset) {
          const styleId = `font-style-${preset.id}`;
          if (document.getElementById(styleId)) return;

          const style = document.createElement("style");
          style.id = styleId;

          // ç›´æ¥åˆ›å»ºä¸€æ¡é«˜ä¼˜å…ˆçº§çš„CSSè§„åˆ™æ¥åº”ç”¨å­—ä½“
          style.innerHTML = `
			        @font-face {
			            font-family: 'preset-${preset.id}';
			            src: url('${preset.url}');
			            font-display: swap;
			        }

			        .font-preview-text[data-preset-id="${preset.id}"] {
			            font-family: 'preset-${preset.id}', sans-serif !important;
			        }
			    `;

          document.head.appendChild(style);
        }

        /**
         * ä¸ºé¢„è®¾å¡æ§½ä¸­çš„æ‰€æœ‰æŒ‰é’®ç»Ÿä¸€æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
         */
        function addFontPresetButtonListeners() {
          document.querySelectorAll(".upload-url-btn").forEach((btn) => {
            btn.onclick = () =>
              handleUploadFontUrl(parseInt(btn.dataset.slotIndex));
          });
          document.querySelectorAll(".upload-local-btn").forEach((btn) => {
            btn.onclick = () =>
              handleUploadFontLocal(parseInt(btn.dataset.slotIndex));
          });
          document.querySelectorAll(".apply-btn").forEach((btn) => {
            btn.onclick = () => applyFontPreset(btn.dataset.presetId);
          });
          document.querySelectorAll(".delete-btn").forEach((btn) => {
            btn.onclick = () => deleteFontPreset(btn.dataset.presetId);
          });
        }

        /**
         * å¤„ç†é€šè¿‡URLä¸Šä¼ å­—ä½“
         * @param {number} slotIndex - å¡æ§½çš„ç´¢å¼• (0-4)
         */
        async function handleUploadFontUrl(slotIndex) {
          const url = await showCustomPrompt(
            "å­—ä½“URL",
            "è¯·è¾“å…¥å­—ä½“çš„ç½‘ç»œé“¾æ¥(.ttf, .otfç­‰)",
          );
          if (!url || !url.trim().startsWith("http")) {
            if (url !== null) alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„URLï¼");
            return;
          }
          const name = await showCustomPrompt(
            "å­—ä½“å‘½å",
            "è¯·ä¸ºè¿™ä¸ªå­—ä½“èµ·ä¸ªåå­—",
          );
          if (!name || !name.trim()) {
            if (name !== null) alert("åå­—ä¸èƒ½ä¸ºç©ºï¼");
            return;
          }
          await saveFontPreset(slotIndex, name.trim(), url.trim());
        }

        /**
         * å¤„ç†é€šè¿‡æœ¬åœ°æ–‡ä»¶ä¸Šä¼ å­—ä½“
         * @param {number} slotIndex - å¡æ§½çš„ç´¢å¼• (0-4)
         */
        function handleUploadFontLocal(slotIndex) {
          const input = document.getElementById("font-preset-local-upload");
          input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const name = await showCustomPrompt(
              "å­—ä½“å‘½å",
              "è¯·ä¸ºè¿™ä¸ªå­—ä½“èµ·ä¸ªåå­—",
              file.name.replace(/\.[^/.]+$/, ""),
            );
            if (!name || !name.trim()) {
              if (name !== null) alert("åå­—ä¸èƒ½ä¸ºç©ºï¼");
              return;
            }

            // ä½¿ç”¨FileReaderå°†å­—ä½“æ–‡ä»¶è½¬ä¸ºBase64 Data URL
            const reader = new FileReader();
            reader.onload = async (event) => {
              await saveFontPreset(slotIndex, name.trim(), event.target.result);
            };

            reader.readAsDataURL(file);
          };
          input.click(); // è§¦å‘æ–‡ä»¶é€‰æ‹©æ¡†
        }
        async function saveFontPreset(slotIndex, name, url) {
          try {
            const presets = await db.fontPresets.toArray();
            const newPreset = { id: "font_" + Date.now(), name, url };
            presets.splice(slotIndex, 0, newPreset);

            // å°† slice(0, 5) ä¿®æ”¹ä¸º slice(0, 10)
            const presetsToSave = presets.slice(0, 10);

            await db.transaction("rw", db.fontPresets, async () => {
              await db.fontPresets.clear();
              await db.fontPresets.bulkPut(presetsToSave);
            });

            await renderFontPresets();
            alert(`å­—ä½“ "${name}" å·²æˆåŠŸä¿å­˜åˆ°å¡æ§½ ${slotIndex + 1}ï¼`);
          } catch (error) {
            console.error("ä¿å­˜å­—ä½“é¢„è®¾å¤±è´¥:", error);
            alert(
              `ä¿å­˜å­—ä½“å¤±è´¥ï¼Œæ•°æ®å·²è‡ªåŠ¨å›æ»šï¼Œä½ ä¹‹å‰çš„å­—ä½“æ•°æ®æ˜¯å®‰å…¨çš„ã€‚é”™è¯¯: ${error.message}`,
            );
            await renderFontPresets();
          }
        }

        /**
         * åˆ é™¤ä¸€ä¸ªå­—ä½“é¢„è®¾
         * @param {string} presetId - è¦åˆ é™¤çš„é¢„è®¾çš„ID
         */
        async function deleteFontPreset(presetId) {
          const preset = await db.fontPresets.get(presetId);
          if (!preset) return;
          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            `ç¡®å®šè¦åˆ é™¤å­—ä½“ "${preset.name}" å—ï¼Ÿ`,
            {
              confirmButtonClass: "btn-danger",
            },
          );
          if (confirmed) {
            await db.fontPresets.delete(presetId);

            // ä»DOMä¸­ç§»é™¤å¯¹åº”çš„é¢„è§ˆæ ·å¼
            const styleTag = document.getElementById(`font-style-${presetId}`);
            if (styleTag) styleTag.remove();

            await renderFontPresets();
          }
        }

        /**
         * åº”ç”¨ä¸€ä¸ªå­—ä½“é¢„è®¾ä¸ºå…¨å±€å­—ä½“
         * @param {string} presetId - è¦åº”ç”¨çš„é¢„è®¾çš„ID
         */
        async function applyFontPreset(presetId) {
          const preset = await db.fontPresets.get(presetId);
          if (preset) {
            // è°ƒç”¨ä½ å·²æœ‰çš„å…¨å±€å­—ä½“åº”ç”¨å‡½æ•°
            applyCustomFont(preset.url, false);
            // ä¿å­˜åˆ°å…¨å±€è®¾ç½®
            state.globalSettings.fontUrl = preset.url;
            await db.globalSettings.put(state.globalSettings);
            alert(`å·²å°†å…¨å±€å­—ä½“æ›´æ¢ä¸º "${preset.name}"ï¼`);
          }
        }

        /**
         * å¤„ç†ç”¨æˆ·é€‰æ‹©çš„è§’è‰²å¡æ–‡ä»¶
         * @param {File} file - ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶å¯¹è±¡
         */
        async function handleCharacterImport(file) {
          if (!file) return;

          try {
            let characterData;
            let avatarBase64;

            if (file.name.toLowerCase().endsWith(".png")) {
              // å¦‚æœæ˜¯PNGæ–‡ä»¶ï¼Œè°ƒç”¨PNGè§£æå‡½æ•°
              const result = await parseCharPng(file);
              characterData = result.characterData;
              avatarBase64 = result.avatarBase64;
            } else if (file.name.toLowerCase().endsWith(".json")) {
              // å¦‚æœæ˜¯JSONæ–‡ä»¶ï¼Œè°ƒç”¨JSONè§£æå‡½æ•°
              characterData = await parseCharJson(file);
              // JSONå¡é€šå¸¸ä¸åŒ…å«å›¾ç‰‡ï¼Œæˆ‘ä»¬ç»™ä¸€ä¸ªé»˜è®¤å¤´åƒ
              avatarBase64 = defaultAvatar;
            } else {
              alert("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·é€‰æ‹© .png æˆ– .json æ–‡ä»¶ã€‚");
              return;
            }

            if (characterData) {
              // æˆåŠŸè§£æå‡ºæ•°æ®åï¼Œè°ƒç”¨åˆ›å»ºå‡½æ•°
              await createCharacterFromData(characterData, avatarBase64);
            }
          } catch (error) {
            console.error("å¯¼å…¥è§’è‰²å¡å¤±è´¥:", error);
            alert(`å¯¼å…¥å¤±è´¥: ${error.message}`);
          }
        }

        /**
         * è§£æSillyTavernçš„PNGè§’è‰²å¡ï¼Œé€šè¿‡å­—èŠ‚çº§æ“ä½œå½»åº•è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜ã€‚
         * @param {File} file - PNGæ–‡ä»¶
         * @returns {Promise<{characterData: object, avatarBase64: string}>}
         */
        async function parseCharPng(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const arrayBuffer = e.target.result;
              const dataView = new DataView(arrayBuffer);

              if (
                dataView.getUint32(0) !== 0x89504e47 ||
                dataView.getUint32(4) !== 0x0d0a1a0a
              ) {
                return reject(new Error("æ–‡ä»¶ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„PNGå›¾ç‰‡ã€‚"));
              }

              let offset = 8;
              let characterJson = null;

              while (offset < dataView.byteLength) {
                const length = dataView.getUint32(offset);
                const type = String.fromCharCode(
                  dataView.getUint8(offset + 4),
                  dataView.getUint8(offset + 5),
                  dataView.getUint8(offset + 6),
                  dataView.getUint8(offset + 7),
                );

                if (type === "tEXt") {
                  const chunkData = new Uint8Array(
                    arrayBuffer,
                    offset + 8,
                    length,
                  );

                  // 1. å…ˆç”¨ä¸€ä¸ªç®€å•çš„ç¼–ç å°†å­—èŠ‚è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œä»¥ä¾¿æŸ¥æ‰¾å…³é”®å­— "chara"
                  let text = "";
                  for (let i = 0; i < chunkData.length; i++) {
                    text += String.fromCharCode(chunkData[i]);
                  }

                  // 2. æ£€æŸ¥å…³é”®å­—æ˜¯å¦å­˜åœ¨
                  const keyword = "chara" + String.fromCharCode(0);
                  if (text.startsWith(keyword)) {
                    // 3. æå–å‡ºå…³é”®å­—åé¢çš„ Base64 ç¼–ç çš„å­—ç¬¦ä¸²
                    const base64Data = text.substring(keyword.length);
                    try {
                      // 4. ä½¿ç”¨ atob() è§£ç  Base64ï¼Œå¾—åˆ°ä¸€ä¸ªâ€œäºŒè¿›åˆ¶å­—ç¬¦ä¸²â€
                      const binaryString = atob(base64Data);

                      // 5. å°†è¿™ä¸ªâ€œäºŒè¿›åˆ¶å­—ç¬¦ä¸²â€é‡æ–°è½¬æ¢ä¸ºåŸå§‹çš„ UTF-8 å­—èŠ‚æ•°ç»„
                      const bytes = new Uint8Array(binaryString.length);
                      for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                      }

                      // 6. ä½¿ç”¨ TextDecoder å°†è¿™ä¸ªçº¯å‡€çš„ UTF-8 å­—èŠ‚æ•°ç»„è§£ç ä¸ºæ­£ç¡®çš„å­—ç¬¦ä¸²
                      const decodedJsonString = new TextDecoder("utf-8").decode(
                        bytes,
                      );

                      // 7. è§£ææœ€ç»ˆçš„JSONå­—ç¬¦ä¸²
                      characterJson = JSON.parse(decodedJsonString);
                      break;
                    } catch (e) {
                      return reject(
                        new Error(
                          "è§£æå›¾ç‰‡å†…åµŒçš„è§’è‰²æ•°æ®å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ•°æ®æŸåã€‚",
                        ),
                      );
                    }
                  }
                }

                if (type === "IEND") break;
                offset += 12 + length;
              }

              if (characterJson) {
                const imageReader = new FileReader();
                imageReader.onload = (imgEvent) => {
                  resolve({
                    characterData: characterJson,
                    avatarBase64: imgEvent.target.result,
                  });
                };
                imageReader.onerror = () =>
                  reject(new Error("è¯»å–å›¾ç‰‡ä½œä¸ºå¤´åƒå¤±è´¥ã€‚"));
                imageReader.readAsDataURL(file);
              } else {
                reject(
                  new Error("åœ¨è¿™å¼ PNGå›¾ç‰‡ä¸­æ²¡æœ‰æ‰¾åˆ°SillyTavernè§’è‰²æ•°æ®ã€‚"),
                );
              }
            };
            reader.onerror = () => reject(new Error("è¯»å–PNGæ–‡ä»¶å¤±è´¥ã€‚"));
            reader.readAsArrayBuffer(file);
          });
        }

        /**
         * ã€ä¿®æ­£ç‰ˆã€‘è§£æJSONè§’è‰²å¡ï¼Œå¼ºåˆ¶ä½¿ç”¨UTF-8ç¼–ç 
         * @param {File} file - JSONæ–‡ä»¶
         * @returns {Promise<object>}
         */
        async function parseCharJson(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                // å…ˆè¯»å–ä¸ºArrayBufferï¼Œå†ç”¨TextDecoderæŒ‡å®šUTF-8è§£ç 
                const arrayBuffer = e.target.result;
                const textDecoder = new TextDecoder("utf-8");
                const jsonString = textDecoder.decode(arrayBuffer);
                const data = JSON.parse(jsonString);
                // å…¼å®¹ä¸¤ç§å¯èƒ½çš„æ ¼å¼
                resolve(data.data || data);
              } catch (error) {
                reject(new Error("è§£æJSONæ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–ç¼–ç ã€‚"));
              }
            };
            reader.onerror = () => reject(new Error("è¯»å–JSONæ–‡ä»¶å¤±è´¥ã€‚"));
            // è¯»å–ä¸ºArrayBufferè€Œä¸æ˜¯Text
            reader.readAsArrayBuffer(file);
          });
        }

        /**
         * æ ¹æ®è§£æå‡ºçš„æ•°æ®åˆ›å»ºæ–°è§’è‰²å’Œä¸–ç•Œä¹¦ã€‚
         * è¿™ä¸ªç‰ˆæœ¬å°†ä¼˜å…ˆæŸ¥æ‰¾æ‚¨æä¾›çš„ character_book æ ‡å‡†æ ¼å¼ã€‚
         * @param {object} data - ä»å¡ç‰‡è§£æå‡ºçš„æœ€åŸå§‹çš„JSONæ•°æ®
         * @param {string} avatarBase64 - è§’è‰²çš„å¤´åƒå›¾ç‰‡ (Base64)
         */
        async function createCharacterFromData(data, avatarBase64) {
          // æ­¥éª¤ 1: ç¡®å®šæ ¸å¿ƒè§’è‰²æ•°æ® (ä¸å˜)
          const charData = data.data || data;
          const characterName = charData.name
            ? charData.name.trim()
            : "æœªå‘½åè§’è‰²";

          // æ­¥éª¤ 2: åˆ›å»ºæ–°çš„èŠå¤©å¯¹è±¡ (ä¸å˜)
          const newChatId = "chat_" + Date.now();

          const newChat = {
            id: newChatId,
            name: characterName,
            isGroup: false,
            isPinned: false,
            history: [],
            unreadCount: 0,
            musicData: { totalTime: 0 },
            npcLibrary: [],
            relationship: {
              status: "friend",
              blockedTimestamp: null,
              applicationReason: "",
            },
            status: { text: "åœ¨çº¿", lastUpdate: Date.now(), isBusy: false },
            weiboDms: [],
            loversSpaceData: null,
            settings: {
              aiPersona: charData.description || "è¯¥è§’è‰²æ²¡æœ‰æè¿°ã€‚",
              myPersona: "æˆ‘æ˜¯è°å‘€ã€‚",
              maxMemory: 10,
              aiAvatar: avatarBase64,
              myAvatar: defaultAvatar,
              background: "",
              theme: "default",
              fontSize: 13,
              customCss: "",
              linkedWorldBookIds: [],
              aiAvatarLibrary: [],
              stickerLibrary: [],
              summary: {
                enabled: false,
                mode: "auto",
                count: 20,
                prompt:
                  "è¯·ä½ ä»¥ç¬¬ä¸‰äººç§°çš„è§†è§’ï¼Œå®¢è§‚ã€å†·é™ã€ä¸å¸¦ä»»ä½•æ„Ÿæƒ…è‰²å½©åœ°æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„æ ¸å¿ƒäº‹ä»¶å’Œä¿¡æ¯ã€‚ç¦æ­¢è¿›è¡Œä»»ä½•è§’è‰²æ‰®æ¼”æˆ–æ·»åŠ ä¸»è§‚è¯„è®ºã€‚",
                lastSummaryIndex: -1,
              },
              linkedMemories: [],
              offlineMode: {
                enabled: false,
                prompt: "",
                style: "",
                wordCount: 300,
                presets: [],
              },
              timePerceptionEnabled: true,
              customTime: "",
              isCoupleAvatar: false,
              coupleAvatarDescription: "",
              weiboProfession: "",
              weiboInstruction: "",
              visualVideoCallEnabled: false,
              charVideoImage: "",
              userVideoImage: "",
              videoCallVoiceAccess: false,
              petAdopted: false,
              pet: null,
            },
            characterPhoneData: {
              lastGenerated: null,
              chats: {},
              shoppingCart: [],
              memos: [],
              browserHistory: [],
              photoAlbum: [],
              bank: { balance: 0, transactions: [] },
              trajectory: [],
              appUsage: [],
              diary: [],
            },
          };

          await db.chats.put(newChat);
          state.chats[newChatId] = newChat;

          // é‡æ„ä¸–ç•Œä¹¦æŸ¥æ‰¾é€»è¾‘
          console.log("å¼€å§‹æ£€æµ‹ä¸–ç•Œä¹¦æ•°æ®...");
          let worldBookFound = false;

          // ç­–ç•¥ä¸€ï¼šã€æœ€é«˜ä¼˜å…ˆçº§ã€‘æŸ¥æ‰¾æä¾›çš„ character_book æ ‡å‡†æ ¼å¼
          if (
            charData.character_book &&
            charData.character_book.entries &&
            Array.isArray(charData.character_book.entries) &&
            charData.character_book.entries.length > 0
          ) {
            console.log(
              `æ£€æµ‹åˆ°æœ€æ–°çš„ character_book æ ¼å¼ (${charData.character_book.entries.length}æ¡)ï¼Œå¼€å§‹å¯¼å…¥...`,
            );
            const newCategory = { name: characterName };
            const newCategoryId = await db.worldBookCategories.add(newCategory);

            await saveWorldBookEntriesFromArray(
              charData.character_book.entries,
              newCategoryId,
            );
            worldBookFound = true;
          }

          // ç­–ç•¥äºŒï¼šå…¼å®¹æ—§çš„ world_entries æ ¼å¼
          else if (
            charData.world_entries &&
            Array.isArray(charData.world_entries) &&
            charData.world_entries.length > 0
          ) {
            console.log(
              `æ£€æµ‹åˆ°æ—§ç‰ˆ world_entries æ ¼å¼ (${charData.world_entries.length}æ¡)ï¼Œå¼€å§‹å¯¼å…¥...`,
            );
            const newCategory = { name: characterName };
            const newCategoryId = await db.worldBookCategories.add(newCategory);
            await saveWorldBookEntriesFromArray(
              charData.world_entries,
              newCategoryId,
            );
            worldBookFound = true;
          }

          // ç­–ç•¥ä¸‰ï¼šå…¼å®¹æ›´æ—§çš„ data.world æ ¼å¼
          else if (
            data.world &&
            typeof data.world === "string" &&
            data.world.trim()
          ) {
            console.log("æ£€æµ‹åˆ°å¤–å±‚ world å­—æ®µæ ¼å¼ï¼Œå¼€å§‹å¯¼å…¥...");
            const newCategory = { name: characterName };
            const newCategoryId = await db.worldBookCategories.add(newCategory);
            await parseAndSaveWorldBooks(data.world, newCategoryId);
            worldBookFound = true;
          }

          // ç­–ç•¥å››ï¼šæœ€åçš„å…¼å®¹æ‰‹æ®µ world_info
          else if (
            charData.world_info &&
            typeof charData.world_info === "string" &&
            charData.world_info.trim()
          ) {
            console.log("æ£€æµ‹åˆ°æ—§ç‰ˆ world_info å­—æ®µæ ¼å¼ï¼Œå¼€å§‹å¯¼å…¥...");
            const newCategory = { name: characterName };
            const newCategoryId = await db.worldBookCategories.add(newCategory);
            await parseAndSaveWorldBooks(charData.world_info, newCategoryId);
            worldBookFound = true;
          }

          if (!worldBookFound) {
            console.log("è¯Šæ–­ï¼šåœ¨æ­¤è§’è‰²å¡ä¸­æœªæ‰¾åˆ°ä»»ä½•å¯è¯†åˆ«çš„ä¸–ç•Œä¹¦å­—æ®µã€‚");
          }

          // æ­¥éª¤ 4: åˆ·æ–°UI (ä¸å˜)
          await renderChatList();
          await showCustomAlert(
            "å¯¼å…¥æˆåŠŸï¼",
            `è§’è‰²â€œ${characterName}â€å·²æˆåŠŸåˆ›å»ºï¼`,
          );
        }

        /**
         * ä»SillyTavernçš„ world_entries æˆ– character_book.entries æ•°ç»„ç›´æ¥åˆ›å»ºä¸–ç•Œä¹¦
         * @param {Array<object>} entriesArray - åŒ…å«ä¸–ç•Œä¹¦æ¡ç›®çš„æ•°ç»„
         * @param {number} categoryId - è¿™äº›ä¸–ç•Œä¹¦æ‰€å±çš„åˆ†ç±»ID
         */
        async function saveWorldBookEntriesFromArray(entriesArray, categoryId) {
          const newBooks = [];

          for (const entry of entriesArray) {
            // ä¼˜å…ˆä½¿ç”¨ comment å­—æ®µä½œä¸ºæ ‡é¢˜ï¼Œå¦‚æœå®ƒå­˜åœ¨ä¸”ä¸ä¸ºç©ºã€‚
            // å¦åˆ™ï¼Œå†å°è¯•ä½¿ç”¨ keys æ•°ç»„ã€‚
            // å¦‚æœéƒ½æ²¡æœ‰ï¼Œå°±ç»™ä¸€ä¸ªé»˜è®¤åå­—ã€‚
            const entryName =
              entry.comment && entry.comment.trim()
                ? entry.comment.trim()
                : entry.keys && entry.keys.length > 0
                  ? entry.keys.join(", ")
                  : "æœªå‘½åæ¡ç›®";

            // æ£€æŸ¥æ¡ç›®æ˜¯å¦æœ‰æ•ˆ (æœ‰åå­—ã€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ˜¯å¯ç”¨çš„)
            // (typeof entry.enabled === 'undefined' || entry.enabled) æ˜¯ä¸ºäº†å…¼å®¹æ²¡æœ‰ enabled å­—æ®µçš„å¡ç‰‡
            if (
              entryName !== "æœªå‘½åæ¡ç›®" &&
              entry.content &&
              (typeof entry.enabled === "undefined" || entry.enabled)
            ) {
              newBooks.push({
                id: "wb_" + Date.now() + Math.random(),
                name: entryName, // ä½¿ç”¨æˆ‘ä»¬æ™ºèƒ½è·å–åˆ°çš„åå­—
                content: entry.content,
                categoryId: categoryId,
              });
            }
          }

          if (newBooks.length > 0) {
            await db.worldBooks.bulkAdd(newBooks);
            // ç¡®ä¿ state.worldBooks ä¹Ÿè¢«æ›´æ–°ï¼Œä»¥ä¾¿UIèƒ½ç«‹å³æ˜¾ç¤º
            const allBooks = await db.worldBooks.toArray();
            state.worldBooks = allBooks;
            console.log(
              `æˆåŠŸå¯¼å…¥ ${newBooks.length} ä¸ªä¸–ç•Œä¹¦æ¡ç›®åˆ°åˆ†ç±»ID: ${categoryId}`,
            );
          }
        }

        function getEventCoords(e) {
          // å¦‚æœæ˜¯è§¦æ‘¸äº‹ä»¶ï¼Œå°±ä» e.touches[0] è·å–
          if (e.touches && e.touches[0]) {
            return { x: e.touches[0].pageX, y: e.touches[0].pageY };
          }
          // å¦åˆ™ï¼Œå°±æ˜¯é¼ æ ‡äº‹ä»¶ï¼Œç›´æ¥ä» e è·å–
          return { x: e.pageX, y: e.pageY };
        }

        function showScreen(screenId) {
          if (
            !document
              .getElementById("logistics-screen")
              .classList.contains("active")
          ) {
            logisticsUpdateTimers.forEach((timerId) => clearTimeout(timerId));
            logisticsUpdateTimers = [];
          }

          if (screenId === "chat-list-screen") {
            renderChatList();
            switchToChatListView("messages-view");
          }
          if (screenId === "api-settings-screen") {
            renderApiSettings();
          }
          if (screenId === "wallpaper-screen") {
            renderWallpaperScreen();
          }
          if (screenId === "world-book-screen") {
            renderWorldBookScreen();
          }

          document
            .querySelectorAll(".screen")
            .forEach((s) => s.classList.remove("active"));
          const screenToShow = document.getElementById(screenId);
          if (screenToShow) {
            screenToShow.classList.add("active");
          }

          if (screenId === "chat-interface-screen") {
            updateListenTogetherIcon(state.activeChatId);
          }

          if (screenId === "font-settings-screen") {
            document.getElementById("font-preview").style.fontFamily = "";
            applyCustomFont(state.globalSettings.fontUrl || "", true);
            renderFontPresets();
          }
        }
        window.showScreen = showScreen; // ç¡®ä¿ showScreen è‡ªå·±ä¹Ÿæ˜¯å…¨å±€çš„

        window.updateListenTogetherIconProxy = () => {};

        function switchToChatListView(viewId) {
          const chatListScreen = document.getElementById("chat-list-screen");
          const views = {
            "messages-view": document.getElementById("messages-view"),
            "qzone-screen": document.getElementById("qzone-screen"),
            "favorites-view": document.getElementById("favorites-view"),
            "memories-view": document.getElementById("memories-view"), // <-- æ–°å¢è¿™ä¸€è¡Œ
          };
          const mainHeader = document.getElementById("main-chat-list-header");
          const mainBottomNav = document.getElementById("chat-list-bottom-nav"); // è·å–ä¸»å¯¼èˆªæ 

          if (isFavoritesSelectionMode) {
            document.getElementById("favorites-edit-btn").click();
          }

          // éšè—æ‰€æœ‰è§†å›¾
          Object.values(views).forEach((v) => v.classList.remove("active"));
          // æ˜¾ç¤ºç›®æ ‡è§†å›¾
          if (views[viewId]) {
            views[viewId].classList.add("active");
          }

          // æ›´æ–°åº•éƒ¨å¯¼èˆªæ é«˜äº®
          document
            .querySelectorAll("#chat-list-bottom-nav .nav-item")
            .forEach((item) => {
              item.classList.toggle("active", item.dataset.view === viewId);
            });

          // ç»Ÿä¸€ç®¡ç†æ‰€æœ‰UIå…ƒç´ çš„æ˜¾éš
          if (viewId === "messages-view") {
            mainHeader.style.display = "flex";
            mainBottomNav.style.display = "flex";
          } else {
            mainHeader.style.display = "none";
            mainBottomNav.style.display = "none";
          }

          if (viewId !== "memories-view") {
            activeCountdownTimers.forEach((timerId) => clearInterval(timerId));
            activeCountdownTimers = [];
          }

          // æ ¹æ®è§†å›¾IDæ‰§è¡Œç‰¹å®šçš„æ¸²æŸ“/æ›´æ–°é€»è¾‘
          switch (viewId) {
            case "qzone-screen":
              views["qzone-screen"].style.backgroundColor = "#f0f2f5";
              updateUnreadIndicator(0);
              renderQzoneScreen();
              renderQzonePosts();
              break;
            case "favorites-view":
              views["favorites-view"].style.backgroundColor = "#f9f9f9";
              renderFavoritesScreen();
              break;
            case "messages-view":
              // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è¿”å›æ¶ˆæ¯åˆ—è¡¨æ—¶è¦æ‰§è¡Œçš„é€»è¾‘
              break;
          }
        }

        function renderQzoneScreen() {
          if (state && state.qzoneSettings) {
            const settings = state.qzoneSettings;
            document.getElementById("qzone-nickname").textContent =
              settings.nickname;
            document.getElementById("qzone-avatar-img").src = settings.avatar;
            document.getElementById("qzone-banner-img").src = settings.banner;
          }
        }
        window.renderQzoneScreenProxy = renderQzoneScreen;

        async function saveQzoneSettings() {
          if (db && state.qzoneSettings) {
            await db.qzoneSettings.put(state.qzoneSettings);
          }
        }

        function formatPostTimestamp(timestamp) {
          if (!timestamp) return "";
          const now = new Date();
          const date = new Date(timestamp);
          const diffSeconds = Math.floor((now - date) / 1000);
          const diffMinutes = Math.floor(diffSeconds / 60);
          const diffHours = Math.floor(diffMinutes / 60);
          if (diffMinutes < 1) return "åˆšåˆš";
          if (diffMinutes < 60) return `${diffMinutes}åˆ†é’Ÿå‰`;
          if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          if (now.getFullYear() === year) {
            return `${month}-${day} ${hours}:${minutes}`;
          } else {
            return `${year}-${month}-${day} ${hours}:${minutes}`;
          }
        }

        async function renderQzonePosts() {
          const postsListEl = document.getElementById("qzone-posts-list");
          if (!postsListEl) return;

          const [posts, favorites] = await Promise.all([
            db.qzonePosts.orderBy("timestamp").reverse().toArray(),
            db.favorites.where("type").equals("qzone_post").toArray(),
          ]);

          const favoritedPostIds = new Set(
            favorites.map((fav) => fav.content.id),
          );

          postsListEl.innerHTML = "";

          if (posts.length === 0) {
            postsListEl.innerHTML =
              '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡è¯´è¯´å§ï¼</p>';
            return;
          }

          const userSettings = state.qzoneSettings;

          // 1. åœ¨æ¸²æŸ“æ‰€æœ‰å¸–å­ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰AIè§’è‰²åå­—çš„é›†åˆ(Set)ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾ã€‚
          const allAiCharacterNames = new Set(
            Object.values(state.chats)
              .filter((chat) => !chat.isGroup)
              .map((chat) => chat.name),
          );

          posts.forEach((post) => {
            const postContainer = document.createElement("div");
            postContainer.className = "qzone-post-container";
            postContainer.dataset.postId = post.id;

            const postEl = document.createElement("div");
            postEl.className = "qzone-post-item";

            let authorAvatar = "",
              authorNickname = "",
              commentAvatar = userSettings.avatar;

            if (post.authorId === "user") {
              authorAvatar = userSettings.avatar;
              authorNickname = userSettings.nickname;
            } else if (state.chats[post.authorId]) {
              const authorChat = state.chats[post.authorId];
              authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
              authorNickname = authorChat.name;
            } else {
              authorAvatar = defaultAvatar;
              authorNickname = "{{char}}";
            }

            let contentHtml = "";
            const publicTextHtml = post.publicText
              ? `<div class="post-content">${post.publicText.replace(/\n/g, "<br>")}</div>`
              : "";

            if (post.type === "shuoshuo") {
              contentHtml = `<div class="post-content" style="margin-bottom: 10px;">${post.content.replace(
                /\n/g,
                "<br>",
              )}</div>`;
            } else if (post.type === "image_post" && post.imageUrl) {
              contentHtml = publicTextHtml
                ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>`
                : `<img src="${post.imageUrl}" class="chat-image">`;
            } else if (post.type === "text_image") {
              contentHtml = publicTextHtml
                ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>`
                : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
            } else if (post.type === "realimag") {
              // RealImagçœŸå®å›¾ç‰‡åŠ¨æ€æ¸²æŸ“ï¼ˆæ”¯æŒå¤šå›¾å¸ƒå±€ï¼‰
              const imageUrls =
                post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);

              if (imageUrls.length > 0) {
                const imageCount = imageUrls.length;
                let imagesHtml = "";

                // ä½¿ç”¨ç»Ÿä¸€çš„å¤šå›¾å¸ƒå±€ï¼ˆåŒ…æ‹¬å•å¼ å›¾ç‰‡ï¼‰
                imagesHtml = `<div class="post-images-grid grid-${imageCount}">`;
                imageUrls.forEach((url, index) => {
                  imagesHtml += `<img src="${url}" class="realimag-image" alt="å›¾ç‰‡${
                    index + 1
                  }" loading="lazy" onerror="this.src='https://i.postimg.cc/KYr2qRCK/1.jpg'; this.alt='å›¾ç‰‡åŠ è½½å¤±è´¥';">`;
                });
                imagesHtml += "</div>";

                contentHtml = publicTextHtml
                  ? `${publicTextHtml}${imagesHtml}`
                  : imagesHtml;
              }
            } else if (post.type === "naiimag") {
              // NovelAIå›¾ç‰‡åŠ¨æ€æ¸²æŸ“ï¼ˆæ”¯æŒå¤šå›¾å¸ƒå±€ï¼Œæœ€å¤š2å¼ ï¼‰
              const imageUrls =
                post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);

              if (imageUrls.length > 0) {
                const imageCount = imageUrls.length;
                let imagesHtml = "";

                // ä½¿ç”¨ç»Ÿä¸€çš„å¤šå›¾å¸ƒå±€ï¼ˆåŒ…æ‹¬å•å¼ å›¾ç‰‡ï¼‰
                imagesHtml = `<div class="post-images-grid grid-${imageCount}">`;
                imageUrls.forEach((url, index) => {
                  imagesHtml += `<img src="${url}" class="naiimag-image" alt="å›¾ç‰‡${
                    index + 1
                  }" loading="lazy" onerror="this.src='https://i.postimg.cc/KYr2qRCK/1.jpg'; this.alt='å›¾ç‰‡åŠ è½½å¤±è´¥';">`;
                });
                imagesHtml += "</div>";

                contentHtml = publicTextHtml
                  ? `${publicTextHtml}${imagesHtml}`
                  : imagesHtml;
              }
            }

            let likesHtml = "";
            if (post.likes && post.likes.length > 0) {
              likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${post.likes.join(
                "ã€",
              )} è§‰å¾—å¾ˆèµ</span></div>`;
            }

            let commentsHtml = "";
            if (post.comments && post.comments.length > 0) {
              // 2. ä¿®æ”¹è¿™é‡Œçš„è¿‡æ»¤é€»è¾‘
              const commentsToShow =
                post.areCommentsVisible === false
                  ? post.comments.filter(
                      (comment) =>
                        // æ¡ä»¶1: è¯„è®ºè€…æ˜¯ä½ è‡ªå·±
                        comment.commenterName === userSettings.nickname ||
                        // æ¡ä»¶2: è¯„è®ºè€…çš„åå­—åœ¨æˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„AIè§’è‰²åå­—åˆ—è¡¨é‡Œ
                        allAiCharacterNames.has(comment.commenterName),
                    )
                  : post.comments; // å¦‚æœå¼€å…³æ˜¯å¼€çš„ï¼Œå°±æ˜¾ç¤ºæ‰€æœ‰è¯„è®º

              if (commentsToShow.length > 0) {
                commentsHtml = '<div class="post-comments-container">';
                commentsToShow.forEach((comment) => {
                  const originalIndex = post.comments.indexOf(comment);
                  let replyHtml = "";
                  if (comment.replyTo) {
                    replyHtml = `<span class="reply-text">å›å¤</span> <span class="reply-target-name">${comment.replyTo}</span>`;
                  }
                  commentsHtml += `
                                        <div class="comment-item" data-commenter-name="${comment.commenterName}">
                                            <span class="commenter-name">${comment.commenterName}</span>${replyHtml}:
                                            <span class="comment-text"> ${comment.text}</span>
                                            <span class="comment-delete-btn" data-comment-index="${originalIndex}">Ã—</span>
                                        </div>`;
                });
                commentsHtml += "</div>";
              }
            }

            const commentsAndFooterHtml = `
                            ${commentsHtml}
                            <div class="post-footer">
                                <div class="comment-section">
                                    <img src="${commentAvatar}" class="comment-avatar">
                                    <input type="text" class="comment-input" placeholder="å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹">
                                    <div class="at-mention-popup"></div>
                                </div>
                                <button class="comment-send-btn">å‘é€</button>
                            </div>
                        `;

            const userNickname = state.qzoneSettings.nickname;
            const isLikedByUser =
              post.likes && post.likes.includes(userNickname);
            const isFavoritedByUser = favoritedPostIds.has(post.id);

            postEl.innerHTML = `
                            <div class="post-header"><img src="${authorAvatar}" class="post-avatar"><div class="post-info"><span class="post-nickname">${authorNickname}</span><span class="post-timestamp">${formatPostTimestamp(
                              post.timestamp,
                            )}</span></div>
                                <div class="post-actions-btn">â€¦</div>
                            </div>
                            <div class="post-main-content">${contentHtml}</div>
                            <div class="post-feedback-icons">
                                <span class="action-icon like ${
                                  isLikedByUser ? "active" : ""
                                }"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                                <span class="action-icon favorite ${
                                  isFavoritedByUser ? "active" : ""
                                }"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                                <span class="action-icon summon-npc" data-post-id="${post.id}" data-author-id="${
                                  post.authorId
                                }" title="å¬å”¤NPCè¯„è®º"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></span>
                                </div>
                            ${likesHtml}
                            ${commentsAndFooterHtml}
                        `;

            const deleteAction = document.createElement("div");
            deleteAction.className = "qzone-post-delete-action";
            deleteAction.innerHTML = "<span>åˆ é™¤</span>";
            postContainer.appendChild(postEl);
            postContainer.appendChild(deleteAction);
            const commentSection =
              postContainer.querySelector(".comment-section");
            if (commentSection) {
              commentSection.addEventListener("touchstart", (e) =>
                e.stopPropagation(),
              );
              commentSection.addEventListener("mousedown", (e) =>
                e.stopPropagation(),
              );
            }
            postsListEl.appendChild(postContainer);
            const commentInput = postContainer.querySelector(".comment-input");
            if (commentInput) {
              const popup = postContainer.querySelector(".at-mention-popup");
              commentInput.addEventListener("input", () => {
                const value = commentInput.value;
                const atMatch = value.match(/@([\p{L}\w]*)$/u);
                if (atMatch) {
                  const namesToMention = new Set();
                  const authorNickname =
                    postContainer.querySelector(".post-nickname")?.textContent;
                  if (authorNickname) namesToMention.add(authorNickname);
                  postContainer
                    .querySelectorAll(".commenter-name")
                    .forEach((nameEl) => {
                      namesToMention.add(nameEl.textContent.replace(":", ""));
                    });
                  namesToMention.delete(state.qzoneSettings.nickname);
                  popup.innerHTML = "";
                  if (namesToMention.size > 0) {
                    const searchTerm = atMatch[1];
                    namesToMention.forEach((name) => {
                      if (
                        name.toLowerCase().includes(searchTerm.toLowerCase())
                      ) {
                        const item = document.createElement("div");
                        item.className = "at-mention-item";
                        item.textContent = name;
                        item.addEventListener("mousedown", (e) => {
                          e.preventDefault();
                          const newText =
                            value.substring(0, atMatch.index) + `@${name} `;
                          commentInput.value = newText;
                          popup.style.display = "none";
                          commentInput.focus();
                        });
                        popup.appendChild(item);
                      }
                    });
                    popup.style.display =
                      popup.children.length > 0 ? "block" : "none";
                  } else {
                    popup.style.display = "none";
                  }
                } else {
                  popup.style.display = "none";
                }
              });
              commentInput.addEventListener("blur", () => {
                setTimeout(() => {
                  popup.style.display = "none";
                }, 200);
              });
            }
          });
        }

        async function renderFollowingFeed() {
          const feedListEl = document.getElementById(
            "weibo-following-feed-list",
          );
          if (!feedListEl) return;

          // 1. ä»æ•°æ®åº“è·å–æ‰€æœ‰åŠ¨æ€
          const allPosts = await db.qzonePosts
            .orderBy("timestamp")
            .reverse()
            .toArray();

          // 2. ç­›é€‰å‡ºä½œè€…ä¸æ˜¯ 'user' çš„åŠ¨æ€
          const followingPosts = allPosts.filter(
            (post) => post.authorId !== "user",
          );

          feedListEl.innerHTML = ""; // æ¸…ç©ºæ—§å†…å®¹

          if (followingPosts.length === 0) {
            feedListEl.innerHTML =
              '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">ä½ å…³æ³¨çš„äººè¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•åŠ¨æ€å“¦ã€‚</p>';
            return;
          }

          // 3. éå†ç­›é€‰åçš„åŠ¨æ€ï¼Œå¹¶æ¸²æŸ“å®ƒä»¬
          //    ã€æç¤ºã€‘è¿™é‡Œåˆ›å»ºå•ä¸ªåŠ¨æ€HTMLçš„é€»è¾‘ï¼Œå¯ä»¥å®Œå…¨å¤åˆ¶ `renderQzonePosts` å‡½æ•°é‡Œçš„ forEach å¾ªç¯å†…éƒ¨çš„ä»£ç ã€‚
          //    ä½ åªéœ€è¦æŠŠç›®æ ‡å®¹å™¨ä» `postsListEl` æ”¹ä¸º `feedListEl` å³å¯ã€‚
          followingPosts.forEach((post) => {});
        }

        function displayFilteredFavorites(items) {
          const listEl = document.getElementById("favorites-list");
          listEl.innerHTML = "";

          if (items.length === 0) {
            const searchTerm = document.getElementById(
              "favorites-search-input",
            ).value;
            const message = searchTerm
              ? "æœªæ‰¾åˆ°ç›¸å…³æ”¶è—"
              : "ä½ çš„æ”¶è—å¤¹æ˜¯ç©ºçš„ï¼Œ<br>å¿«å»åŠ¨æ€æˆ–èŠå¤©ä¸­æ”¶è—å–œæ¬¢çš„å†…å®¹å§ï¼";
            listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
            return;
          }

          for (const item of items) {
            const card = document.createElement("div");
            card.className = "favorite-item-card";
            card.dataset.favid = item.id;

            let headerHtml = "",
              contentHtml = "",
              sourceText = "",
              footerHtml = "";

            if (item.type === "qzone_post") {
              const post = item.content;
              sourceText = "æ¥è‡ªåŠ¨æ€";
              let authorAvatar = defaultAvatar,
                authorNickname = "æœªçŸ¥ç”¨æˆ·";

              if (post.authorId === "user") {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
              } else if (state.chats[post.authorId]) {
                authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                authorNickname = state.chats[post.authorId].name;
              }

              headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;

              const publicTextHtml = post.publicText
                ? `<div class="post-content">${post.publicText.replace(/\n/g, "<br>")}</div>`
                : "";
              if (post.type === "shuoshuo") {
                contentHtml = `<div class="post-content">${post.content.replace(/\n/g, "<br>")}</div>`;
              } else if (post.type === "image_post" && post.imageUrl) {
                contentHtml = publicTextHtml
                  ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>`
                  : `<img src="${post.imageUrl}" class="chat-image">`;
              } else if (post.type === "text_image") {
                contentHtml = publicTextHtml
                  ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>`
                  : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
              } else if (post.type === "realimag") {
                // RealImagçœŸå®å›¾ç‰‡åŠ¨æ€æ¸²æŸ“ï¼ˆæ”¯æŒå¤šå›¾å¸ƒå±€ï¼‰
                const imageUrls =
                  post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);

                if (imageUrls.length > 0) {
                  const imageCount = imageUrls.length;
                  let imagesHtml = "";

                  // ä½¿ç”¨ç»Ÿä¸€çš„å¤šå›¾å¸ƒå±€ï¼ˆåŒ…æ‹¬å•å¼ å›¾ç‰‡ï¼‰
                  imagesHtml = `<div class="post-images-grid grid-${imageCount}">`;
                  imageUrls.forEach((url, index) => {
                    imagesHtml += `<img src="${url}" class="realimag-image" alt="å›¾ç‰‡${
                      index + 1
                    }" loading="lazy" onerror="this.src='https://i.postimg.cc/KYr2qRCK/1.jpg'; this.alt='å›¾ç‰‡åŠ è½½å¤±è´¥';">`;
                  });
                  imagesHtml += "</div>";

                  contentHtml = publicTextHtml
                    ? `${publicTextHtml}${imagesHtml}`
                    : imagesHtml;
                }
              } else if (post.type === "naiimag") {
                // NovelAIå›¾ç‰‡åŠ¨æ€æ¸²æŸ“ï¼ˆæ”¯æŒå¤šå›¾å¸ƒå±€ï¼Œæœ€å¤š2å¼ ï¼‰
                const imageUrls =
                  post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);

                if (imageUrls.length > 0) {
                  const imageCount = imageUrls.length;
                  let imagesHtml = "";

                  // ä½¿ç”¨ç»Ÿä¸€çš„å¤šå›¾å¸ƒå±€ï¼ˆåŒ…æ‹¬å•å¼ å›¾ç‰‡ï¼‰
                  imagesHtml = `<div class="post-images-grid grid-${imageCount}">`;
                  imageUrls.forEach((url, index) => {
                    imagesHtml += `<img src="${url}" class="naiimag-image" alt="å›¾ç‰‡${
                      index + 1
                    }" loading="lazy" onerror="this.src='https://i.postimg.cc/KYr2qRCK/1.jpg'; this.alt='å›¾ç‰‡åŠ è½½å¤±è´¥';">`;
                  });
                  imagesHtml += "</div>";

                  contentHtml = publicTextHtml
                    ? `${publicTextHtml}${imagesHtml}`
                    : imagesHtml;
                }
              }

              // 1. æ„é€ ç‚¹èµåŒºåŸŸçš„HTML
              let likesHtml = "";
              // æ£€æŸ¥ post å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨ likes æ•°ç»„å¹¶ä¸”ä¸ä¸ºç©º
              if (post.likes && post.likes.length > 0) {
                // å¦‚æœå­˜åœ¨ï¼Œå°±åˆ›å»ºç‚¹èµåŒºåŸŸçš„ div
                likesHtml = `
			                    <div class="post-likes-section">
			                        <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
			                        <span>${post.likes.join("ã€")} è§‰å¾—å¾ˆèµ</span>
			                    </div>`;
              }

              // 2. æ„é€ è¯„è®ºåŒºåŸŸçš„HTML
              let commentsHtml = "";
              // æ£€æŸ¥ post å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨ comments æ•°ç»„å¹¶ä¸”ä¸ä¸ºç©º
              if (post.comments && post.comments.length > 0) {
                // å¦‚æœå­˜åœ¨ï¼Œå°±åˆ›å»ºè¯„è®ºå®¹å™¨ï¼Œå¹¶éå†æ¯ä¸€æ¡è¯„è®º
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach((comment) => {
                  commentsHtml += `
			                        <div class="comment-item">
			                            <span class="commenter-name">${comment.commenterName}:</span>
			                            <span class="comment-text">${comment.text}</span>
			                        </div>`;
                });
                commentsHtml += "</div>";
              }

              // 3. å°†ç‚¹èµå’Œè¯„è®ºçš„HTMLç»„åˆåˆ° footerHtml ä¸­
              footerHtml = `${likesHtml}${commentsHtml}`;
            } else if (item.type === "chat_message") {
              const msg = item.content;
              const chat = state.chats[item.chatId];
              if (!chat) continue;

              sourceText = `æ¥è‡ªä¸ ${chat.name} çš„èŠå¤©`;
              const isUser = msg.role === "user";
              let senderName, senderAvatar;

              if (isUser) {
                // ç”¨æˆ·æ¶ˆæ¯çš„é€»è¾‘ä¿æŒä¸å˜
                senderName = chat.isGroup
                  ? chat.settings.myNickname || "æˆ‘"
                  : "æˆ‘";
                senderAvatar =
                  chat.settings.myAvatar ||
                  (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                //...
              } else {
                // AI/æˆå‘˜æ¶ˆæ¯
                if (chat.isGroup) {
                  const member = chat.members.find(
                    (m) => m.originalName === msg.senderName,
                  );

                  // å¦‚æœæ‰¾åˆ°äº†æˆå‘˜ä¿¡æ¯ï¼Œå°±ç”¨ä»–çš„â€œç¾¤æ˜µç§°â€ï¼›å¦‚æœæ²¡æ‰¾åˆ°ï¼ˆæ¯”å¦‚æˆå‘˜è¢«è¸¢äº†ï¼‰ï¼Œå°±è¿˜æ˜¯ç”¨æ¶ˆæ¯é‡Œçš„åå­—ä½œä¸ºå¤‡ç”¨ã€‚
                  senderDisplayName = member
                    ? member.groupNickname
                    : msg.senderName || "æœªçŸ¥æˆå‘˜";

                  senderAvatar = member
                    ? member.avatar
                    : defaultGroupMemberAvatar;
                } else {
                  // å•èŠçš„é€»è¾‘ä¿æŒä¸å˜
                  senderName = chat.name;
                  senderAvatar = chat.settings.aiAvatar || defaultAvatar;
                }
              }

              // åç»­æ‹¼æ¥ headerHtml å’Œ contentHtml çš„é€»è¾‘éƒ½ä¿æŒä¸å˜
              headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;

              if (
                typeof msg.content === "string" &&
                STICKER_REGEX.test(msg.content)
              ) {
                contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
              } else if (
                Array.isArray(msg.content) &&
                msg.content[0]?.type === "image_url"
              ) {
                contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
              } else {
                const messageText = String(msg.content || "");
                // ä¾¦æµ‹æ ¼å¼ï¼š[sticker:åå­—]
                const stickerMatch = messageText.match(
                  /\[sticker:\s*(.+?)\s*\]/i,
                );

                if (stickerMatch) {
                  // å¦‚æœåŒ¹é…æˆåŠŸï¼Œæå–å‡ºåå­—
                  const stickerName = stickerMatch[1].trim();
                  // åœ¨æ‰€æœ‰å¯èƒ½çš„è¡¨æƒ…åº“é‡ŒæŸ¥æ‰¾ï¼ˆç”¨æˆ·çš„ã€è§’è‰²çš„ä¸“å±ã€è§’è‰²çš„é€šç”¨ï¼‰
                  const allStickers = [
                    ...state.userStickers,
                    ...state.charStickers,
                    ...(chat.settings.stickerLibrary || []),
                  ];
                  const foundSticker = allStickers.find(
                    (s) => s.name === stickerName,
                  );

                  if (foundSticker) {
                    // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±æ˜¾ç¤ºå›¾ç‰‡ï¼
                    bubble.classList.add("is-sticker");
                    contentHtml = `<img src="${foundSticker.url}" alt="${foundSticker.name}" class="sticker-image">`;
                  } else {
                    // å¦‚æœæ²¡æ‰¾åˆ°ï¼ˆæ¯”å¦‚AIè‡ªå·±ç¼–äº†ä¸ªåå­—ï¼‰ï¼Œå°±è¿˜æ˜¯æŒ‰æ™®é€šæ–‡å­—æ˜¾ç¤º
                    contentHtml = messageText.replace(/\n/g, "<br>");
                  }
                } else {
                  // å¦‚æœä¸åŒ¹é…ï¼Œå°±æ˜¯æ™®é€šçš„æ–‡æœ¬æ¶ˆæ¯
                  contentHtml = messageText.replace(/\n/g, "<br>");
                }
              }
            }

            card.innerHTML = `
			            <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
			            <div class="fav-card-content">${contentHtml}</div>
			            ${footerHtml}`;

            listEl.appendChild(card);
          }
        }

        /**
         * è´Ÿè´£å‡†å¤‡æ•°æ®å¹¶è§¦å‘æ¸²æŸ“
         */
        async function renderFavoritesScreen() {
          // 1. ä»æ•°æ®åº“è·å–æœ€æ–°æ•°æ®å¹¶ç¼“å­˜
          allFavoriteItems = await db.favorites
            .orderBy("timestamp")
            .reverse()
            .toArray();

          // 2. æ¸…ç©ºæœç´¢æ¡†å¹¶éšè—æ¸…é™¤æŒ‰é’®
          const searchInput = document.getElementById("favorites-search-input");
          const clearBtn = document.getElementById(
            "favorites-search-clear-btn",
          );
          searchInput.value = "";
          clearBtn.style.display = "none";

          // 3. æ˜¾ç¤ºæ‰€æœ‰æ”¶è—é¡¹
          displayFilteredFavorites(allFavoriteItems);
        }

        function resetCreatePostModal() {
          document.getElementById("post-public-text").value = "";
          document.getElementById("post-image-preview").src = "";
          document.getElementById("post-image-description").value = "";
          document
            .getElementById("post-image-preview-container")
            .classList.remove("visible");
          document.getElementById("post-image-desc-group").style.display =
            "none";
          document.getElementById("post-local-image-input").value = "";
          document.getElementById("post-hidden-text").value = "";

          const imageModeBtn = document.getElementById("switch-to-image-mode");
          const textImageModeBtn = document.getElementById(
            "switch-to-text-image-mode",
          );
          const imageModeContent =
            document.getElementById("image-mode-content");
          const textImageModeContent = document.getElementById(
            "text-image-mode-content",
          );

          imageModeBtn.classList.add("active");
          textImageModeBtn.classList.remove("active");
          imageModeContent.classList.add("active");
          textImageModeContent.classList.remove("active");
        }

        async function exportBackup() {
          try {
            const backupData = {
              version: 1,
              timestamp: Date.now(),
            };

            const [
              chats,
              worldBooks,
              userStickers,
              charStickers,
              apiConfig,
              globalSettings,
              personaPresets,
              musicLibrary,
              qzoneSettings,
              qzonePosts,
              qzoneAlbums,
              qzonePhotos,
              favorites,
              qzoneGroups,
              memories,
              worldBookCategories,
              callRecords,
              customAvatarFrames,
              themes,
              apiPresets,
              bubbleStylePresets,
              fontPresets,
              homeScreenPresets,
              datingScenes,
              datingPresets,
              datingSpriteGroups,
              datingSprites,
              datingHistory,
              pomodoroSessions,
              ludoQuestionBanks,
              ludoQuestions,
              scriptKillScripts,
              taobaoProducts,
              taobaoOrders,
              taobaoCart,
              userWalletTransactions,
              userStickerCategories,
            ] = await Promise.all([
              db.chats.toArray(),
              db.worldBooks.toArray(),
              db.userStickers.toArray(),
              db.charStickers.toArray(), // <--- æ–°å¢çš„è¿™ä¸€è¡Œï¼
              db.apiConfig.get("main"),
              db.globalSettings.get("main"),
              db.personaPresets.toArray(),
              db.musicLibrary.get("main"),
              db.qzoneSettings.get("main"),
              db.qzonePosts.toArray(),
              db.qzoneAlbums.toArray(),
              db.qzonePhotos.toArray(),
              db.favorites.toArray(),
              db.qzoneGroups.toArray(),
              db.memories.toArray(),
              db.worldBookCategories.toArray(),
              db.callRecords.toArray(),
              db.customAvatarFrames.toArray(),
              db.themes.toArray(),
              db.apiPresets.toArray(),
              db.bubbleStylePresets.toArray(),
              db.fontPresets.toArray(),
              db.homeScreenPresets.toArray(),
              db.datingScenes.toArray(),
              db.datingPresets.toArray(),
              db.datingSpriteGroups.toArray(),
              db.datingSprites.toArray(),
              db.datingHistory.toArray(),
              db.pomodoroSessions.toArray(),
              db.ludoQuestionBanks.toArray(),
              db.ludoQuestions.toArray(),
              db.scriptKillScripts.toArray(),
              db.taobaoProducts.toArray(),
              db.taobaoOrders.toArray(),
              db.taobaoCart.toArray(),
              db.userWalletTransactions.toArray(),
              db.userStickerCategories.toArray(),
            ]);

            Object.assign(backupData, {
              chats,
              worldBooks,
              userStickers,
              charStickers,
              apiConfig,
              globalSettings,
              personaPresets,
              musicLibrary,
              qzoneSettings,
              qzonePosts,
              qzoneAlbums,
              qzonePhotos,
              favorites,
              qzoneGroups,
              memories,
              worldBookCategories,
              callRecords,
              customAvatarFrames,
              themes,
              apiPresets,
              bubbleStylePresets,
              fontPresets,
              homeScreenPresets,
              datingScenes,
              datingPresets,
              datingSpriteGroups,
              datingSprites,
              datingHistory,
              pomodoroSessions,
              ludoQuestionBanks,
              ludoQuestions,
              scriptKillScripts,
              taobaoProducts,
              taobaoOrders,
              taobaoCart,
              userWalletTransactions,
              userStickerCategories,
            });

            backupData.homeScreenState = {
              // --- 1. ä¸ªäººèµ„æ–™å¡ ---
              "profile-banner-img":
                document.getElementById("profile-banner-img")?.src || "",
              "profile-avatar-img":
                document.getElementById("profile-avatar-img")?.src || "",
              homeAvatarFrame:
                document.getElementById("profile-avatar-frame")?.src || "",
              "profile-username":
                document.getElementById("profile-username")?.textContent ||
                "ä½ çš„æ˜µç§°",
              "profile-sub-username":
                document.getElementById("profile-sub-username")?.textContent ||
                "@your_id",
              "profile-bio":
                document.getElementById("profile-bio")?.textContent ||
                "ç‚¹å‡»è¿™é‡Œç¼–è¾‘ä½ çš„ä¸ªæ€§ç­¾å",
              "profile-location":
                document.getElementById("profile-location")?.innerHTML || "",

              // --- 2. ç¬¬ä¸€é¡µå°ç»„ä»¶ (ä¿æŒä¸å˜) ---
              "widget-bubble-1":
                document.getElementById("widget-bubble-1")?.textContent ||
                "ç‚¹å‡»ç¼–è¾‘æ–‡å­—",
              "widget-image-1":
                document.getElementById("widget-image-1")?.src || "",
              "widget-subtext-1":
                document.getElementById("widget-subtext-1")?.textContent ||
                "ç‚¹å‡»ç¼–è¾‘æ–‡å­—",
              "widget-bubble-2":
                document.getElementById("widget-bubble-2")?.textContent ||
                "ç‚¹å‡»ç¼–è¾‘æ–‡å­—",
              "widget-image-2":
                document.getElementById("widget-image-2")?.src || "",
              "widget-subtext-2":
                document.getElementById("widget-subtext-2")?.textContent ||
                "ç‚¹å‡»ç¼–è¾‘æ–‡å­—",

              // --- 3. ç¬¬äºŒé¡µï¼šå·¦ä¾§ç»„åˆ (å›¾ç‰‡ + æ°”æ³¡) ---
              "widget-image-3":
                document.getElementById("widget-image-3")?.src || "",
              "second-page-bubble":
                document.getElementById("second-page-bubble")?.textContent ||
                "ç‚¹å‡»ç¼–è¾‘æ–‡å­—",
              "flat-capsule-bubble":
                document.getElementById("flat-capsule-bubble")?.textContent ||
                "å¯ç¼–è¾‘",
              "circular-bubble":
                document.getElementById("circular-bubble")?.textContent ||
                "æ–‡å­—",

              // --- 4. ç¬¬äºŒé¡µï¼šé€æ˜éŸ³ä¹ç»„ä»¶ (æ ¸å¿ƒæ–°å¢) ---
              "music-rect-img":
                document.getElementById("music-rect-img")?.src || "",
              "music-record-img":
                document.getElementById("music-record-img")?.src || "",
              "music-text-line":
                document.getElementById("music-text-line")?.textContent ||
                "ç‚¹å‡»ç¼–è¾‘æ­Œå",

              // --- 5. ç¬¬äºŒé¡µï¼šæœˆä»½/å¤´åƒç»„åˆç»„ä»¶ (æ ¸å¿ƒæ–°å¢) ---
              "widget-month-display":
                document.getElementById("widget-month-display")?.textContent ||
                "12",
              "new-widget-avatar":
                document.getElementById("new-widget-avatar")?.src || "",
              "new-widget-text-1":
                document.getElementById("new-widget-text-1")?.textContent ||
                "å¯ç¼–è¾‘æ–‡å­—",
              "new-widget-text-2":
                document.getElementById("new-widget-text-2")?.textContent ||
                "å¯ç¼–è¾‘æ–‡å­—",
              "new-widget-text-3":
                document.getElementById("new-widget-text-3")?.textContent ||
                "å¯ç¼–è¾‘æ–‡å­—",

              // --- å…¨å±€è®¾ç½® ---
              appIcons: { ...state.globalSettings.appIcons },
              appLabels: { ...state.globalSettings.appLabels },
              wallpaper: state.globalSettings.wallpaper,
              lockscreenWallpaper: state.globalSettings.lockscreenWallpaper,
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const link = Object.assign(document.createElement("a"), {
              href: url,
              download: `EPhone-Full-Backup-${new Date().toISOString().split("T")[0]}.json`,
            });
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            await showCustomAlert("å¯¼å‡ºæˆåŠŸ", "å·²æˆåŠŸå¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼");
          } catch (error) {
            console.error("å¯¼å‡ºæ•°æ®æ—¶å‡ºé”™:", error);
            await showCustomAlert(
              "å¯¼å‡ºå¤±è´¥",
              `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: ${error.message}`,
            );
          }
        }

        let githubBackupTimer = null;

        /**
         * è·å–å®Œæ•´çš„å¤‡ä»½æ•°æ®å¯¹è±¡ (ä¸è§¦å‘ä¸‹è½½)
         */
        async function getFullBackupData() {
          const backupData = {
            version: 1,
            timestamp: Date.now(),
            deviceCode: getDeviceCode(), // è®°å½•æ¥æºè®¾å¤‡
          };

          // è·å–æ‰€æœ‰æ•°æ®è¡¨
          const [
            chats,
            worldBooks,
            userStickers,
            charStickers,
            apiConfig,
            globalSettings,
            personaPresets,
            musicLibrary,
            qzoneSettings,
            qzonePosts,
            qzoneAlbums,
            qzonePhotos,
            favorites,
            qzoneGroups,
            memories,
            worldBookCategories,
            callRecords,
            customAvatarFrames,
            themes,
            apiPresets,
            bubbleStylePresets,
            fontPresets,
            homeScreenPresets,
            datingScenes,
            datingPresets,
            datingSpriteGroups,
            datingSprites,
            datingHistory,
            pomodoroSessions,
            ludoQuestionBanks,
            ludoQuestions,
            scriptKillScripts,
            taobaoProducts,
            taobaoOrders,
            taobaoCart,
            userWalletTransactions,
            userStickerCategories,
          ] = await Promise.all([
            db.chats.toArray(),
            db.worldBooks.toArray(),
            db.userStickers.toArray(),
            db.charStickers.toArray(),
            db.apiConfig.get("main"),
            db.globalSettings.get("main"),
            db.personaPresets.toArray(),
            db.musicLibrary.get("main"),
            db.qzoneSettings.get("main"),
            db.qzonePosts.toArray(),
            db.qzoneAlbums.toArray(),
            db.qzonePhotos.toArray(),
            db.favorites.toArray(),
            db.qzoneGroups.toArray(),
            db.memories.toArray(),
            db.worldBookCategories.toArray(),
            db.callRecords.toArray(),
            db.customAvatarFrames.toArray(),
            db.themes.toArray(),
            db.apiPresets.toArray(),
            db.bubbleStylePresets.toArray(),
            db.fontPresets.toArray(),
            db.homeScreenPresets.toArray(),
            db.datingScenes.toArray(),
            db.datingPresets.toArray(),
            db.datingSpriteGroups.toArray(),
            db.datingSprites.toArray(),
            db.datingHistory.toArray(),
            db.pomodoroSessions.toArray(),
            db.ludoQuestionBanks.toArray(),
            db.ludoQuestions.toArray(),
            db.scriptKillScripts.toArray(),
            db.taobaoProducts.toArray(),
            db.taobaoOrders.toArray(),
            db.taobaoCart.toArray(),
            db.userWalletTransactions.toArray(),
            db.userStickerCategories.toArray(),
          ]);

          // ç»„è£…æ•°æ®
          Object.assign(backupData, {
            chats,
            worldBooks,
            userStickers,
            charStickers,
            apiConfig,
            globalSettings,
            personaPresets,
            musicLibrary,
            qzoneSettings,
            qzonePosts,
            qzoneAlbums,
            qzonePhotos,
            favorites,
            qzoneGroups,
            memories,
            worldBookCategories,
            callRecords,
            customAvatarFrames,
            themes,
            apiPresets,
            bubbleStylePresets,
            fontPresets,
            homeScreenPresets,
            datingScenes,
            datingPresets,
            datingSpriteGroups,
            datingSprites,
            datingHistory,
            pomodoroSessions,
            ludoQuestionBanks,
            ludoQuestions,
            scriptKillScripts,
            taobaoProducts,
            taobaoOrders,
            taobaoCart,
            userWalletTransactions,
            userStickerCategories,
          });

          // è¿™é‡Œçœç•¥äº† homeScreenState çš„è¯¦ç»†æŠ“å–ï¼Œå› ä¸ºå®ƒä¾èµ– DOM å…ƒç´ ï¼Œ
          // è‡ªåŠ¨å¤‡ä»½æ—¶å¯èƒ½ä¸åœ¨ä¸»å±å¹•ã€‚ä¸ºäº†å®‰å…¨èµ·è§ï¼Œè¿™é‡Œä»…ä¿å­˜ globalSettings é‡Œçš„ widgetDataã€‚
          // å¦‚æœéœ€è¦å®Œæ•´è¿˜åŸUIå¸ƒå±€ï¼Œæœ€å¥½åªåœ¨æ‰‹åŠ¨å¯¼å‡ºæ—¶åŒ…å« homeScreenStateã€‚

          return JSON.stringify(backupData, null, 2);
        }

        // æ”¯æŒå¤§æ–‡ä»¶è‡ªåŠ¨åˆ†ç‰‡ä¸Šä¼  + è‡ªåŠ¨å»é™¤æ•æ„ŸKeyé˜²æ­¢æŠ¥é”™
        async function uploadBackupToGitHub(isAuto = false) {
          let { githubToken, githubUsername, githubRepo, githubPath } =
            state.apiConfig;

          // 1. åŸºç¡€æ£€æŸ¥
          if (!githubToken || !githubUsername || !githubRepo) {
            if (!isAuto) alert("è¯·å…ˆåœ¨ API è®¾ç½®ä¸­å¡«å†™ GitHub é…ç½®ï¼");
            return;
          }
          githubToken = githubToken.trim();
          githubUsername = githubUsername.trim();
          githubRepo = githubRepo
            .trim()
            .replace(/\/$/, "")
            .split("/")
            .pop()
            .replace(".git", "");
          githubPath = (githubPath || "ephone_backup.json").trim();

          if (!isAuto)
            await showCustomAlert("å‡†å¤‡ä¸­...", "æ­£åœ¨æ‰“åŒ…å¹¶è®¡ç®—æ–‡ä»¶å¤§å°...");

          try {
            // 2. è·å–åŸå§‹ JSON æ•°æ®å­—ç¬¦ä¸²
            const rawJsonContent = await getFullBackupData();

            // GitHub ä¼šæ‹’ç»åŒ…å« API Key çš„æ–‡ä»¶ä¸Šä¼ ï¼Œæ‰€ä»¥å¿…é¡»åœ¨ä¸Šä¼ å‰æ¸…ç©ºå®ƒä»¬
            const backupObj = JSON.parse(rawJsonContent);

            if (backupObj.apiConfig) {
              // æ¸…ç©º OpenAI/API Key
              backupObj.apiConfig.apiKey = "";
              // æ¸…ç©º GitHub Token (æœ€å…³é”®ï¼Œä¸åˆ è¿™ä¸ªå¿…æŠ¥ secret detected)
              backupObj.apiConfig.githubToken = "";
              // æ¸…ç©º Minimax Key
              backupObj.apiConfig.minimaxApiKey = "";
            }

            // é‡æ–°è½¬æ¢å› JSON å­—ç¬¦ä¸²
            const jsonContent = JSON.stringify(backupObj, null, 2);

            // 3. è½¬æˆ Base64 (è§£å†³ä¸­æ–‡ä¹±ç )
            const fullBase64 = btoa(unescape(encodeURIComponent(jsonContent)));

            // è®¡ç®— Base64 å¤§å° (å­—èŠ‚)
            const totalSize = fullBase64.length;
            // è®¾å®šåˆ†ç‰‡é˜ˆå€¼ï¼š45MB
            const CHUNK_SIZE = 45 * 1024 * 1024;

            const totalChunks = Math.ceil(totalSize / CHUNK_SIZE);

            console.log(
              `[GitHub] æ–‡ä»¶å¤§å°: ${(totalSize / 1024 / 1024).toFixed(2)} MB, åˆ†ç‰‡æ•°: ${totalChunks}`,
            );

            // å¦‚æœåªæœ‰1ç‰‡ï¼Œèµ°æ™®é€šä¸Šä¼ ï¼›å¦‚æœå¤šç‰‡ï¼Œèµ°åˆ†ç‰‡ä¸Šä¼ 
            if (totalChunks === 1) {
              await uploadSingleFile(
                githubUsername,
                githubRepo,
                githubPath,
                githubToken,
                fullBase64,
                isAuto,
              );
            } else {
              if (!isAuto)
                await showCustomAlert(
                  "æ–‡ä»¶è¾ƒå¤§",
                  `å°†åˆ†ä¸º ${totalChunks} ä¸ªéƒ¨åˆ†ä¸Šä¼ ï¼Œè¯·è€å¿ƒç­‰å¾…...`,
                );

              for (let i = 0; i < totalChunks; i++) {
                const start = i * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, totalSize);
                const chunkContent = fullBase64.substring(start, end);

                const partName = `${githubPath}.${String(i + 1).padStart(3, "0")}`;

                if (!isAuto) {
                  console.log(`æ­£åœ¨ä¸Šä¼ åˆ†ç‰‡ ${i + 1}/${totalChunks} ...`);
                }

                await uploadSingleFile(
                  githubUsername,
                  githubRepo,
                  partName,
                  githubToken,
                  chunkContent,
                  isAuto,
                  true,
                );
              }

              const infoContent = btoa(
                `{"total_parts": ${totalChunks}, "timestamp": ${Date.now()}}`,
              );
              await uploadSingleFile(
                githubUsername,
                githubRepo,
                `${githubPath}.meta`,
                githubToken,
                infoContent,
                true,
                true,
              );
            }

            console.log("GitHub å¤‡ä»½å…¨éƒ¨å®Œæˆï¼");
            if (!isAuto) {
              await showCustomAlert(
                "ä¸Šä¼ æˆåŠŸ",
                `å¤‡ä»½å·²ä¸Šä¼ ã€‚(ä¸ºäº†å®‰å…¨ï¼Œäº‘ç«¯å¤‡ä»½å·²è‡ªåŠ¨ç§»é™¤API Keyï¼Œæ¢å¤æ—¶è¯·è®°å¾—é‡æ–°å¡«å†™)`,
              );
            }
          } catch (error) {
            console.error("GitHub å¤‡ä»½å¤±è´¥:", error);
            // å¦‚æœè¿˜æ˜¯æŠ¥ Bad credentialsï¼Œæç¤ºç”¨æˆ·æ£€æŸ¥ Token
            if (error.message.includes("Bad credentials")) {
              if (!isAuto)
                await showCustomAlert(
                  "è®¤è¯å¤±è´¥",
                  'GitHub Token æ— æ•ˆæˆ–è¿‡æœŸã€‚è¯·é‡æ–°ç”Ÿæˆ Token å¹¶ç¡®ä¿å‹¾é€‰äº† "repo" æƒé™ã€‚',
                );
            } else {
              if (!isAuto) await showCustomAlert("ä¸Šä¼ å¤±è´¥", error.message);
            }
          }
        }

        async function restoreBackupFromGitHub() {
          let { githubToken, githubUsername, githubRepo, githubPath } =
            state.apiConfig;

          // 1. åŸºç¡€æ£€æŸ¥
          if (!githubToken || !githubUsername || !githubRepo) {
            alert("è¯·å…ˆåœ¨ API è®¾ç½®ä¸­å¡«å†™ GitHub é…ç½®ï¼");
            return;
          }

          // 2. ç¡®è®¤æ“ä½œ
          const confirmed = await showCustomConfirm(
            "âš ï¸ é«˜èƒ½é¢„è­¦",
            "å³å°†ä» GitHub ä¸‹è½½å¤‡ä»½å¹¶ã€è¦†ç›–ã€‘å½“å‰æ‰€æœ‰æ•°æ®ï¼\n\nå¦‚æœ GitHub ä¸Šçš„å¤‡ä»½è¾ƒæ—§ï¼Œæ‚¨å½“å‰çš„æ–°æ•°æ®å°†ä¼šä¸¢å¤±ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ",
            { confirmButtonClass: "btn-danger" },
          );
          if (!confirmed) return;

          githubToken = githubToken.trim();
          githubUsername = githubUsername.trim();
          githubRepo = githubRepo
            .trim()
            .replace(/\/$/, "")
            .split("/")
            .pop()
            .replace(".git", "");
          githubPath = (githubPath || "ephone_backup.json").trim();

          await showCustomAlert(
            "æ­£åœ¨è¿æ¥...",
            "æ­£åœ¨æ£€æŸ¥ GitHub ä¸Šçš„å¤‡ä»½æ–‡ä»¶...",
          );

          try {
            let finalBase64String = "";

            // 3. ç­–ç•¥ Aï¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨åˆ†ç‰‡ç´¢å¼•æ–‡ä»¶ (.meta)
            const metaUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${githubPath}.meta`;
            let metaData = null;

            try {
              const metaRes = await fetch(metaUrl, {
                headers: { Authorization: `token ${githubToken}` },
              });
              if (metaRes.ok) {
                const metaJson = await metaRes.json();
                const metaContentStr = atob(
                  metaJson.content.replace(/\s/g, ""),
                );
                metaData = JSON.parse(metaContentStr);
              }
            } catch (e) {
              console.log("æœªæ‰¾åˆ° meta æ–‡ä»¶ï¼Œå°è¯•å•æ–‡ä»¶æ¨¡å¼ã€‚");
            }

            // 4. åˆ†æ”¯å¤„ç†ï¼šåˆ†ç‰‡ä¸‹è½½ vs å•æ–‡ä»¶ä¸‹è½½
            if (metaData && metaData.total_parts) {
              // === åˆ†ç‰‡æ¨¡å¼ (å¤„ç†è¶…å¤§æ–‡ä»¶) ===
              const totalParts = metaData.total_parts;
              const modalTitle = document.getElementById("custom-modal-title");

              for (let i = 1; i <= totalParts; i++) {
                if (modalTitle)
                  modalTitle.textContent = `æ­£åœ¨ä¸‹è½½åˆ†ç‰‡ ${i}/${totalParts}...`;

                const partName = `${githubPath}.${String(i).padStart(3, "0")}`;
                // è·å–åˆ†ç‰‡æ–‡ä»¶çš„ SHA ä¿¡æ¯
                const partInfoUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${partName}`;

                const partInfoRes = await fetch(partInfoUrl, {
                  headers: { Authorization: `token ${githubToken}` },
                });

                if (!partInfoRes.ok)
                  throw new Error(`è·å–åˆ†ç‰‡ ${partName} ä¿¡æ¯å¤±è´¥`);

                const partJson = await partInfoRes.json();

                // ç»Ÿä¸€ä½¿ç”¨ Blob API è·å–å†…å®¹ï¼Œé¿å… download_url çš„ CORS é—®é¢˜
                // æ— è®ºæ˜¯åˆ†ç‰‡è¿˜æ˜¯å•æ–‡ä»¶ï¼Œåªè¦ SHA å­˜åœ¨ï¼Œå°±ç”¨ Blob API
                const blobUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/git/blobs/${partJson.sha}`;
                const blobRes = await fetch(blobUrl, {
                  headers: { Authorization: `token ${githubToken}` },
                });

                if (!blobRes.ok)
                  throw new Error(`åˆ†ç‰‡ ${partName} å†…å®¹ä¸‹è½½å¤±è´¥`);

                const blobJson = await blobRes.json();
                finalBase64String += blobJson.content.replace(/\s/g, "");
              }
              console.log("æ‰€æœ‰åˆ†ç‰‡ä¸‹è½½å¹¶æ‹¼æ¥å®Œæˆã€‚");
            } else {
              // === å•æ–‡ä»¶æ¨¡å¼ ===
              // 1. å…ˆè·å–æ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆæ‹¿åˆ° shaï¼‰
              const singleUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${githubPath}`;
              const res = await fetch(singleUrl, {
                headers: { Authorization: `token ${githubToken}` },
              });

              if (!res.ok) {
                if (res.status === 404)
                  throw new Error("æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶ï¼è¯·æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦æ­£ç¡®ã€‚");
                throw new Error(`ä¸‹è½½å¤±è´¥: ${res.status}`);
              }

              const json = await res.json();

              if (json.content) {
                // æ–‡ä»¶è¾ƒå° (<1MB)ï¼ŒAPI ç›´æ¥è¿”å›äº† content
                finalBase64String = json.content.replace(/\s/g, "");
              } else if (json.sha) {
                // æ–‡ä»¶è¾ƒå¤§ (>1MB)ï¼ŒAPI æ²¡æœ‰ contentï¼Œä½†æœ‰ sha
                // ä½¿ç”¨ Blob API è·å–å†…å®¹ï¼ˆå®ƒæ”¯æŒ CORS å’Œ Tokenï¼‰
                console.log("æ–‡ä»¶å¤§äº1MBï¼Œæ­£åœ¨é€šè¿‡ Blob API ä¸‹è½½...");
                if (document.getElementById("custom-modal-title")) {
                  document.getElementById("custom-modal-title").textContent =
                    "æ­£åœ¨é€šè¿‡ Blob API ä¸‹è½½å¤§æ–‡ä»¶...";
                }

                const blobUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/git/blobs/${json.sha}`;
                const blobRes = await fetch(blobUrl, {
                  headers: { Authorization: `token ${githubToken}` },
                });

                if (!blobRes.ok)
                  throw new Error(`Blob API è¯·æ±‚å¤±è´¥: ${blobRes.status}`);

                const blobJson = await blobRes.json();
                finalBase64String = blobJson.content.replace(/\s/g, "");
              } else {
                throw new Error(
                  "æ— æ³•è·å–æ–‡ä»¶å†…å®¹: GitHub API æœªè¿”å› content æˆ– sha",
                );
              }
            }

            // 5. è§£ç ä¸æ¢å¤
            if (document.getElementById("custom-modal-title")) {
              document.getElementById("custom-modal-title").textContent =
                "æ­£åœ¨è§£ææ•°æ®(å¯èƒ½éœ€è¦å‡ ç§’)...";
            }

            // a. Base64 -> äºŒè¿›åˆ¶å­—ç¬¦ä¸²
            const binaryString = atob(finalBase64String);

            // b. äºŒè¿›åˆ¶å­—ç¬¦ä¸² -> Uint8Array -> UTF-8 å­—ç¬¦ä¸²
            // (è¿™ä¸€æ­¥æ˜¯ä¸ºäº†è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜)
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
              bytes[i] = binaryString.charCodeAt(i);
            }
            const decoder = new TextDecoder("utf-8");
            const jsonString = decoder.decode(bytes);

            // c. é¢„æ£€ JSON
            try {
              JSON.parse(jsonString);
            } catch (parseErr) {
              throw new Error(
                `JSONè§£æå¤±è´¥(æ–‡ä»¶å¯èƒ½ä¸å®Œæ•´): ${parseErr.message}`,
              );
            }

            // d. å¯¼å…¥
            const virtualFile = new File([jsonString], "github_restore.json", {
              type: "application/json",
            });
            hideCustomModal();
            await importBackup(virtualFile);
          } catch (error) {
            console.error("æ¢å¤å¤±è´¥:", error);
            // å¦‚æœæ˜¯ 403 é”™è¯¯ï¼Œé€šå¸¸æ˜¯ Token æƒé™é—®é¢˜
            let extraMsg = "";
            if (
              error.message.includes("403") ||
              error.message.includes("Failed to fetch")
            ) {
              extraMsg =
                "\n\n(æç¤ºï¼šè¿™å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œæˆ–è€…æ‚¨çš„ GitHub Token æ²¡æœ‰è¶³å¤Ÿçš„æƒé™è®¿é—®è¯¥ç§æœ‰ä»“åº“ã€‚)";
            }
            await showCustomAlert(
              "æ¢å¤å¤±è´¥",
              `é”™è¯¯ä¿¡æ¯: ${error.message}${extraMsg}`,
            );
          }
        }

        /**
         * è¾…åŠ©å‡½æ•°ï¼šä¸Šä¼ å•ä¸ªæ–‡ä»¶åˆ° GitHub
         * å¢å¼ºç‰ˆï¼šæ”¯æŒè·å–SHAä»¥è¦†ç›–æ–‡ä»¶ï¼Œå¤„ç†404æƒ…å†µ
         */
        async function uploadSingleFile(
          user,
          repo,
          path,
          token,
          contentBase64,
          isAuto,
        ) {
          const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;

          // 1. å°è¯•è·å–ç°æœ‰çš„ SHA (ç”¨äºè¦†ç›–)
          let sha = null;
          try {
            // è¿™é‡Œçš„ fetch å¯èƒ½ä¼šå› ä¸ºç½‘ç»œé—®é¢˜å¤±è´¥ï¼Œæ‰€ä»¥åŠ  try-catch
            const getRes = await fetch(apiUrl, {
              method: "GET",
              headers: { Authorization: `token ${token}` },
            });
            if (getRes.ok) {
              const json = await getRes.json();
              sha = json.sha;
            }
          } catch (e) {
            console.warn(
              `[Github] è·å–æ–‡ä»¶ SHA å¤±è´¥ (å¯èƒ½æ˜¯æ–°æ–‡ä»¶): ${path}`,
              e,
            );
            // å¿½ç•¥è·å–SHAçš„é”™è¯¯ï¼Œå‡è®¾æ˜¯æ–°æ–‡ä»¶ç»§ç»­å°è¯•ä¸Šä¼ 
          }

          // 2. å‡†å¤‡ä¸Šä¼ è¯·æ±‚ä½“
          const body = {
            message: `Backup ${new Date().toLocaleString()}`,
            content: contentBase64,
          };
          if (sha) body.sha = sha;

          // 3. æ‰§è¡Œä¸Šä¼  (PUT)
          const res = await fetch(apiUrl, {
            method: "PUT",
            headers: {
              Authorization: `token ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          });

          if (!res.ok) {
            const errText = await res.text();
            let errMsg = `Status ${res.status}`;
            try {
              const errJson = JSON.parse(errText);
              errMsg = errJson.message || errMsg;
            } catch (e) {}
            throw new Error(`GitHub API Error: ${errMsg}`);
          }
        }

        /**
         * ç®¡ç†è‡ªåŠ¨å¤‡ä»½å®šæ—¶å™¨ (å·²ä¿®æ”¹ï¼šæ”¯æŒè‡ªå®šä¹‰æ—¶é—´å’Œæ¨¡å¼)
         */
        function handleAutoBackupTimer() {
          // æ¸…é™¤æ—§å®šæ—¶å™¨
          if (githubBackupTimer) {
            clearInterval(githubBackupTimer);
            githubBackupTimer = null;
          }

          // å¦‚æœå¼€å¯äº†è‡ªåŠ¨å¤‡ä»½
          if (state.apiConfig && state.apiConfig.githubAutoBackup) {
            // è·å–é—´éš”æ—¶é—´ï¼Œé»˜è®¤ä¸º 30 åˆ†é’Ÿ
            const intervalMinutes = state.apiConfig.githubBackupInterval || 30;
            console.log(`å·²å¼€å¯ GitHub è‡ªåŠ¨å¤‡ä»½ (æ¯ ${intervalMinutes} åˆ†é’Ÿ)`);

            githubBackupTimer = setInterval(
              () => {
                // è·å–å¤‡ä»½æ¨¡å¼ï¼Œé»˜è®¤ä¸ºå…¨é‡
                const mode = state.apiConfig.githubBackupMode || "full";

                if (mode === "stream") {
                  // ä¼ å…¥ true è¡¨ç¤ºè¿™æ˜¯è‡ªåŠ¨å¤‡ä»½
                  uploadBackupToGitHubStream(true);
                } else {
                  uploadBackupToGitHub(true);
                }
              },
              intervalMinutes * 60 * 1000,
            );
          }
        }

        async function importBackup(file) {
          if (!file) return;

          const confirmed = await showCustomConfirm(
            "ä¸¥é‡è­¦å‘Šï¼",
            "å¯¼å…¥å¤‡ä»½å°†å®Œå…¨è¦†ç›–æ‚¨å½“å‰çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬èŠå¤©ã€è®¾ç½®ç­‰ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼æ‚¨ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ",
            { confirmButtonClass: "btn-danger" },
          );

          if (!confirmed) return;

          try {
            const text = await file.text();
            const data = JSON.parse(text);

            await db.transaction("rw", db.tables, async () => {
              // 1. æ¸…ç©ºæ‰€æœ‰ç°æœ‰è¡¨æ ¼
              for (const table of db.tables) {
                await table.clear();
              }

              // æ£€æŸ¥å¤‡ä»½æ–‡ä»¶ä¸­çš„æ¯ä¸€é¡¹æ•°æ®ï¼Œåªæœ‰å½“å½“å‰ä»£ç çš„æ•°æ®åº“é‡Œä¹Ÿå­˜åœ¨å¯¹åº”çš„è¡¨æ ¼æ—¶ï¼Œæ‰è¿›è¡Œå¯¼å…¥

              // å¯¼å…¥æ•°ç»„ç±»å‹çš„æ•°æ®
              const arrayTables = [
                "chats",
                "worldBooks",
                "userStickers",
                "charStickers",
                "personaPresets", // <--- åœ¨è¿™é‡ŒåŠ å…¥äº† 'charStickers'
                "qzonePosts",
                "qzoneAlbums",
                "qzonePhotos",
                "favorites",
                "qzoneGroups",
                "memories",
                "worldBookCategories",
                "callRecords",
                "customAvatarFrames",
                "themes",
                "apiPresets",
                "bubbleStylePresets",
                "fontPresets",
                "homeScreenPresets",
              ];

              // ä¸–ç•Œä¹¦æ ¼å¼å…¼å®¹è½¬æ¢ä»£ç 
              for (const tableName of arrayTables) {
                if (Array.isArray(data[tableName]) && db[tableName]) {
                  let itemsToPut = data[tableName];

                  // å½“å¤„ç†ä¸–ç•Œä¹¦è¡¨æ ¼æ—¶ï¼Œæ‰§è¡Œç‰¹åˆ«çš„è½¬æ¢æ“ä½œ
                  if (tableName === "worldBooks") {
                    console.log("æ­£åœ¨æ£€æŸ¥å¹¶è½¬æ¢ä¸–ç•Œä¹¦æ•°æ®æ ¼å¼ä»¥å…¼å®¹...");
                    itemsToPut.forEach((book) => {
                      // å¦‚æœ content æ˜¯æ•°ç»„ (åˆ«äººçš„æ ¼å¼)ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºå­—ç¬¦ä¸² (æˆ‘çš„æ ¼å¼)
                      if (Array.isArray(book.content)) {
                        console.log(
                          `æ£€æµ‹åˆ°æ•°ç»„æ ¼å¼çš„ä¸–ç•Œä¹¦: "${book.name}"ï¼Œæ­£åœ¨è½¬æ¢ä¸ºå­—ç¬¦ä¸²...`,
                        );

                        // å°†æ•°ç»„ä¸­çš„æ¯ä¸ªæ¡ç›®å¯¹è±¡è½¬æ¢ä¸ºæ ¼å¼åŒ–çš„å­—ç¬¦ä¸²
                        const convertedEntries = book.content.map((entry) => {
                          const stringParts = [];
                          if (entry.comment) {
                            stringParts.push(`[å¤‡æ³¨: ${entry.comment}]`);
                          }
                          if (entry.keys && entry.keys.length > 0) {
                            stringParts.push(
                              `[å…³é”®è¯: ${entry.keys.join(", ")}]`,
                            );
                          }
                          stringParts.push(entry.content); // æ¡ç›®ä¸»è¦å†…å®¹
                          return stringParts.join("\n"); // æ¯ä¸ªæ¡ç›®çš„å†…éƒ¨ç”¨æ¢è¡Œåˆ†éš”
                        });

                        // å°†æ‰€æœ‰è½¬æ¢åçš„æ¡ç›®å­—ç¬¦ä¸²ç”¨ä¸€ä¸ªæ˜æ˜¾çš„åˆ†éš”ç¬¦è¿æ¥èµ·æ¥
                        book.content = convertedEntries.join("\n\n---\n\n");
                      }
                    });
                  }

                  // è¿‡æ»¤å¹¶ä¿å­˜æ•°æ® (è¿™éƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜)
                  const validItems = itemsToPut.filter(
                    (item) =>
                      item &&
                      (typeof item.id === "undefined" ||
                        typeof item.id === "string" ||
                        typeof item.id === "number"),
                  );
                  if (validItems.length > 0) {
                    console.log(
                      `æ­£åœ¨å¯¼å…¥ ${validItems.length} æ¡æ•°æ®åˆ°è¡¨æ ¼: ${tableName}...`,
                    );
                    await db[tableName].bulkPut(validItems);
                  }
                } else {
                  console.log(
                    `è·³è¿‡å¯¼å…¥: ${tableName} (åœ¨å¤‡ä»½æ–‡ä»¶æˆ–å½“å‰æ•°æ®åº“ä¸­ä¸å­˜åœ¨)`,
                  );
                }
              }

              // å¯¼å…¥å¯¹è±¡ç±»å‹çš„æ•°æ®ï¼ˆé€šå¸¸æ˜¯è®¾ç½®ï¼‰
              const objectTables = [
                "apiConfig",
                "globalSettings",
                "musicLibrary",
                "qzoneSettings",
              ];
              for (const tableName of objectTables) {
                if (data[tableName] && db[tableName]) {
                  console.log(`æ­£åœ¨å¯¼å…¥è®¾ç½®: ${tableName}...`);
                  await db[tableName].put(data[tableName]);
                }
              }
            });

            // å¯¼å…¥ä¸»å±å¹•æ ·å¼çš„é€»è¾‘ä¿æŒä¸å˜ï¼Œå› ä¸ºå®ƒä¸ç›´æ¥æ“ä½œæ•°æ®åº“çš„å¤šä¸ªè¡¨
            if (data.homeScreenState) {
              const settings = (await db.globalSettings.get("main")) || {
                id: "main",
              };
              settings.widgetData = data.homeScreenState;
              if (data.homeScreenState.wallpaper)
                settings.wallpaper = data.homeScreenState.wallpaper;
              if (data.homeScreenState.lockscreenWallpaper)
                settings.lockscreenWallpaper =
                  data.homeScreenState.lockscreenWallpaper;
              if (data.homeScreenState.appIcons)
                settings.appIcons = data.homeScreenState.appIcons;
              await db.globalSettings.put(settings);
              console.log("å·²æˆåŠŸå¯¼å…¥ä¸»å±å¹•æ ·å¼æ•°æ®ã€‚");
            }

            await showCustomAlert(
              "å¯¼å…¥æˆåŠŸ",
              "æ‰€æœ‰æ•°æ®å·²æˆåŠŸæ¢å¤ï¼åº”ç”¨å³å°†åˆ·æ–°ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚",
            );

            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } catch (error) {
            console.error("å¯¼å…¥æ•°æ®æ—¶å‡ºé”™:", error);
            await showCustomAlert(
              "å¯¼å…¥å¤±è´¥",
              `æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–æ•°æ®å·²æŸå: ${error.message}`,
            );
          }
        }

        function applyCustomFont(fontUrl, isPreviewOnly = false) {
          if (!fontUrl) {
            // å¦‚æœæ²¡æœ‰æä¾›å­—ä½“é“¾æ¥ï¼ˆæ¯”å¦‚æ¢å¤é»˜è®¤ï¼‰ï¼Œå°±æ¸…ç©ºæ ·å¼
            dynamicFontStyle.innerHTML = "";
            document.getElementById("font-preview").style.fontFamily = "";
            return;
          }

          // è¿™æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„å†…éƒ¨åå­—
          const fontName = "custom-user-font";

          // è¿™æ˜¯å®šä¹‰å­—ä½“çš„æ ·å¼è§„åˆ™
          const newStyle = `
			        @font-face {
			          font-family: '${fontName}';
			          src: url('${fontUrl}');
			          font-display: swap;
			        }`;

          if (isPreviewOnly) {
            // å¦‚æœåªæ˜¯é¢„è§ˆï¼Œè¿™ä¸ªé€»è¾‘ä¿æŒä¸å˜
            const previewStyle =
              document.getElementById("preview-font-style") ||
              document.createElement("style");
            previewStyle.id = "preview-font-style";
            previewStyle.innerHTML = newStyle;
            if (!document.getElementById("preview-font-style"))
              document.head.appendChild(previewStyle);
            document.getElementById("font-preview").style.fontFamily =
              `'${fontName}', 'bulangni', sans-serif`;
          } else {
            // å¦‚æœæ˜¯å…¨å±€åº”ç”¨ï¼Œå°±åŒæ—¶å®šä¹‰å­—ä½“å¹¶å‘Šè¯‰æ•´ä¸ª body å»ä½¿ç”¨å®ƒ
            dynamicFontStyle.innerHTML = `
			            ${newStyle}
			            body {
			              font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
			            }`;
          }
        }

        async function resetToDefaultFont() {
          // 1. æ¸…é™¤å…¨å±€å­—ä½“æ ·å¼
          dynamicFontStyle.innerHTML = "";

          // 2. æ›´æ–°å¹¶ä¿å­˜è®¾ç½®
          state.globalSettings.fontUrl = "";
          await db.globalSettings.put(state.globalSettings);

          // 3. æ˜ç¡®åœ°å°†å…¨å±€é¢„è§ˆåŒºçš„å­—ä½“ä¹Ÿæ¢å¤ä¸ºé»˜è®¤
          const globalPreview = document.getElementById("font-preview");
          globalPreview.style.fontFamily = ""; // ç§»é™¤å†…è”æ ·å¼

          // 4. åº”ç”¨ä¸€ä¸‹ç©ºçš„å­—ä½“è®¾ç½®ï¼Œç¡®ä¿æ‰€æœ‰åœ°æ–¹éƒ½æ¢å¤
          applyCustomFont("", true);

          alert("å·²æ¢å¤é»˜è®¤å­—ä½“ã€‚");
        }

        async function loadAllDataFromDB() {
          const [
            chatsArr,
            apiConfig,
            globalSettings,
            userStickers,
            charStickers,
            worldBooks,
            musicLib,
            personaPresets,
            qzoneSettings,
            initialFavorites,
            apiPresets,
            bubbleStylePresets,
            datingScenes, // <--- åœ¨è¿™é‡Œæ–°å¢
            localUserStickerCategories,
            offlinePresetsFromDB,
          ] = await Promise.all([
            db.chats.toArray(),
            db.apiConfig.get("main"),
            db.globalSettings.get("main"),
            db.userStickers.toArray(),
            db.charStickers.toArray(),
            db.worldBooks.toArray(),
            db.musicLibrary.get("main"),
            db.personaPresets.toArray(),
            db.qzoneSettings.get("main"),
            db.favorites.orderBy("timestamp").reverse().toArray(),
            db.apiPresets.toArray(),
            db.bubbleStylePresets.toArray(),
            db.datingScenes.toArray(), // <--- åœ¨è¿™é‡Œæ–°å¢
            db.userStickerCategories.toArray(),
            db.offlinePresets.toArray(),
          ]);
          state.offlinePresets = offlinePresetsFromDB || [];
          state.chats = chatsArr.reduce((acc, chat) => {
            if (!chat.checkpoints) {
              chat.checkpoints = [];
            }

            // ä¸ºæ—§çš„ç¾¤èŠæ•°æ®å…¼å®¹ä¸“å±è¡¨æƒ…åº“
            if (
              chat.isGroup &&
              (!chat.settings || !chat.settings.stickerLibrary)
            ) {
              if (!chat.settings) chat.settings = {}; // ä»¥é˜²ä¸‡ä¸€è¿settingséƒ½æ²¡æœ‰
              chat.settings.stickerLibrary = [];
              console.log(
                `ä¸ºæ—§ç¾¤èŠ "${chat.name}" è¡¥å…¨äº†ä¸“å±è¡¨æƒ…åº“(stickerLibrary)å±æ€§ã€‚`,
              );
            }
            // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰ä¸“å±è¡¨æƒ…åº“çš„è§’è‰²æ·»åŠ ä¸€ä¸ªç©ºçš„è¡¨æƒ…åº“
            if (
              !chat.isGroup &&
              (!chat.settings || !chat.settings.stickerLibrary)
            ) {
              if (!chat.settings) chat.settings = {}; // ä»¥é˜²ä¸‡ä¸€è¿settingséƒ½æ²¡æœ‰
              chat.settings.stickerLibrary = [];
              console.log(
                `ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†ä¸“å±è¡¨æƒ…åº“(stickerLibrary)å±æ€§ã€‚`,
              );
            }

            if (typeof chat.unreadCount === "undefined") {
              chat.unreadCount = 0; // å¦‚æœè¿™ä¸ªèŠå¤©å¯¹è±¡æ²¡æœ‰ unreadCount å±æ€§ï¼Œå°±ç»™å®ƒåˆå§‹åŒ–ä¸º 0
            }

            // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰å¿ƒå£°èƒŒæ™¯çš„è§’è‰²æ·»åŠ ä¸€ä¸ªç©ºå­—ç¬¦ä¸²
            if (typeof chat.innerVoiceBackground === "undefined") {
              chat.innerVoiceBackground = "";
            }

            // â˜…â˜…â˜… è¿™å°±æ˜¯æœ¬æ¬¡æ–°å¢çš„å…¼å®¹æ€§ä»£ç ï¼ â˜…â˜…â˜…
            if (
              chat.settings &&
              typeof chat.settings.innerVoiceAdopterLabelFormat === "undefined"
            ) {
              chat.settings.innerVoiceAdopterLabelFormat = "é¢†å…»äºº: {{user}}";
            }
            // â˜…â˜…â˜… æ–°å¢ç»“æŸ â˜…â˜…â˜…

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¾¤èŠï¼Œå¹¶ä¸”å…¶æˆå‘˜å¯¹è±¡ä½¿ç”¨çš„æ˜¯æ—§çš„ `name` ç»“æ„
            if (
              chat.isGroup &&
              chat.members &&
              chat.members.length > 0 &&
              chat.members[0].name
            ) {
              console.log(
                `æ£€æµ‹åˆ°æ—§ç‰ˆç¾¤èŠæ•°æ® for "${chat.name}"ï¼Œæ­£åœ¨æ‰§è¡Œè¿ç§»...`,
              );
              chat.members.forEach((member) => {
                // å¦‚æœè¿™ä¸ªæˆå‘˜å¯¹è±¡æ²¡æœ‰ originalNameï¼Œè¯´æ˜æ˜¯æ—§æ•°æ®
                if (typeof member.originalName === "undefined") {
                  member.originalName = member.name; // å°†æ—§çš„ name ä½œä¸º originalName
                  member.groupNickname = member.name; // åŒæ—¶åˆ›å»ºä¸€ä¸ªåˆå§‹çš„ groupNickname
                  delete member.name; // åˆ é™¤æ—§çš„ã€æœ‰æ­§ä¹‰çš„ name å­—æ®µ
                  needsUpdate = true; // æ ‡è®°éœ€è¦å­˜å›æ•°æ®åº“
                }
              });
              console.log(`è¿ç§»å®Œæˆ for "${chat.name}"`);
            }

            // æ£€æŸ¥1ï¼šå¦‚æœæ˜¯ä¸€ä¸ªå•èŠï¼Œå¹¶ä¸”æ²¡æœ‰ status å±æ€§
            if (!chat.isGroup && !chat.status) {
              // å°±ä¸ºå®ƒè¡¥ä¸Šä¸€ä¸ªé»˜è®¤çš„ status å¯¹è±¡
              chat.status = {
                text: "åœ¨çº¿",
                lastUpdate: Date.now(),
                isBusy: false,
              };
              console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†statuså±æ€§ã€‚`);
            }

            // æ£€æŸ¥2ï¼šå…¼å®¹æœ€æ–°çš„â€œå…³ç³»â€åŠŸèƒ½
            if (!chat.isGroup && !chat.relationship) {
              // å¦‚æœæ˜¯å•èŠï¼Œä¸”æ²¡æœ‰ relationship å¯¹è±¡ï¼Œå°±è¡¥ä¸Šä¸€ä¸ªé»˜è®¤çš„
              chat.relationship = {
                status: "friend",
                blockedTimestamp: null,
                applicationReason: "",
              };
              console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº† relationship å±æ€§ã€‚`);
            }

            if (
              !chat.isGroup &&
              (!chat.settings || !chat.settings.aiAvatarLibrary)
            ) {
              if (!chat.settings) chat.settings = {}; // ä»¥é˜²ä¸‡ä¸€è¿settingséƒ½æ²¡æœ‰
              chat.settings.aiAvatarLibrary = [];
              console.log(
                `ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†aiAvatarLibraryå±æ€§ã€‚`,
              );
            }

            // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰æ€»ç»“è®¾ç½®çš„èŠå¤©æ·»åŠ é»˜è®¤å€¼
            if (!chat.settings.summary) {
              chat.settings.summary = {
                enabled: false,
                mode: "auto",
                count: 20,
                prompt:
                  "è¯·ä½ ä»¥ç¬¬ä¸‰äººç§°çš„è§†è§’ï¼Œå®¢è§‚ã€å†·é™ã€ä¸å¸¦ä»»ä½•æ„Ÿæƒ…è‰²å½©åœ°æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„æ ¸å¿ƒäº‹ä»¶å’Œä¿¡æ¯ã€‚ç¦æ­¢è¿›è¡Œä»»ä½•è§’è‰²æ‰®æ¼”æˆ–æ·»åŠ ä¸»è§‚è¯„è®ºã€‚",
                lastSummaryIndex: -1, // -1è¡¨ç¤ºä»æœªæ€»ç»“è¿‡
              };
            }

            // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰NPCåº“çš„å•èŠè§’è‰²æ·»åŠ ç©ºçš„NPCåº“
            if (!chat.isGroup && !chat.npcLibrary) {
              chat.npcLibrary = [];
              console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº† npcLibrary å±æ€§ã€‚`);
            }

            // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰å¾®åšè®¾ç½®çš„å•èŠè§’è‰²æ·»åŠ ç©ºçš„å¾®åšè®¾ç½®
            if (
              !chat.isGroup &&
              (!chat.settings.weiboProfession ||
                typeof chat.settings.weiboInstruction === "undefined")
            ) {
              chat.settings.weiboProfession = "";
              chat.settings.weiboInstruction = "";
              console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†å¾®åšè®¾ç½®å±æ€§ã€‚`);
            }

            if (!chat.musicData) chat.musicData = { totalTime: 0 };
            if (
              chat.settings &&
              chat.settings.linkedWorldBookId &&
              !chat.settings.linkedWorldBookIds
            ) {
              chat.settings.linkedWorldBookIds = [
                chat.settings.linkedWorldBookId,
              ];
              delete chat.settings.linkedWorldBookId;
            }

            // å…¼å®¹æ—§æ•°æ®ï¼Œä¸ºæ²¡æœ‰ isPinned å±æ€§çš„èŠå¤©æ·»åŠ é»˜è®¤å€¼
            if (typeof chat.isPinned === "undefined") {
              chat.isPinned = false;
            }

            // ç»Ÿä¸€ä¿®å¤å¹¶åˆå§‹åŒ–æ‰€æœ‰è§’è‰²çš„æ‰‹æœºæ•°æ®
            if (!chat.isGroup) {
              // ç¬¬ä¸€æ­¥ï¼šç¡®ä¿æœ€å¤–å±‚çš„ characterPhoneData å¯¹è±¡å­˜åœ¨
              if (!chat.characterPhoneData) {
                chat.characterPhoneData = {}; // å¦‚æœä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºä¸€ä¸ªç©ºçš„
              }

              // ç¬¬äºŒæ­¥ï¼šé€ä¸€æ£€æŸ¥å¹¶è¡¥å…¨æ‰€æœ‰APPçš„æ•°æ®ç»“æ„
              // è¿™æ ·æ— è®ºè§’è‰²å¤šè€ï¼Œéƒ½èƒ½ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½å­˜åœ¨
              if (!chat.characterPhoneData.widgets)
                chat.characterPhoneData.widgets = {};
              if (!chat.characterPhoneData.lastGenerated)
                chat.characterPhoneData.lastGenerated = null;
              if (!chat.characterPhoneData.chats)
                chat.characterPhoneData.chats = {};
              if (!chat.characterPhoneData.shoppingCart)
                chat.characterPhoneData.shoppingCart = [];
              if (!chat.characterPhoneData.memos)
                chat.characterPhoneData.memos = [];
              if (!chat.characterPhoneData.browserHistory)
                chat.characterPhoneData.browserHistory = [];
              if (!chat.characterPhoneData.photoAlbum)
                chat.characterPhoneData.photoAlbum = [];
              if (!chat.characterPhoneData.bank)
                chat.characterPhoneData.bank = { balance: 0, transactions: [] };
              if (!chat.characterPhoneData.trajectory)
                chat.characterPhoneData.trajectory = [];
              if (!chat.characterPhoneData.appUsage)
                chat.characterPhoneData.appUsage = [];
              if (!chat.characterPhoneData.diary)
                chat.characterPhoneData.diary = [];
              if (!chat.characterPhoneData.appWallpaper) {
                chat.characterPhoneData.appWallpaper = "";
              }
            }

            // å…¼å®¹æ—§æ•°æ®ï¼Œä¸ºæ²¡æœ‰åå°æ´»åŠ¨è®¾ç½®çš„ç¾¤èŠæ·»åŠ é»˜è®¤å€¼
            if (
              chat.isGroup &&
              (!chat.settings ||
                typeof chat.settings.backgroundActivity === "undefined")
            ) {
              if (!chat.settings) chat.settings = {}; // ä»¥é˜²ä¸‡ä¸€è¿settingséƒ½æ²¡æœ‰
              chat.settings.backgroundActivity = {
                enabled: false,
                interval: 120, // é»˜è®¤120ç§’
                lastActivityTimestamp: 0,
              };
            }

            // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰æƒ…ä¾£å¤´åƒè®¾ç½®çš„è§’è‰²æ·»åŠ é»˜è®¤å€¼
            if (typeof chat.settings.isCoupleAvatar === "undefined") {
              chat.settings.isCoupleAvatar = false;
              chat.settings.coupleAvatarDescription = "";
            }

            // 1. ä¸ºæ‰€æœ‰è§’è‰²ï¼ˆåŒ…æ‹¬æ–°æ—§æ•°æ®ï¼‰ç¡®ä¿æœ‰ petAdopted æ ‡å¿—
            if (
              !chat.isGroup &&
              typeof chat.settings.petAdopted === "undefined"
            ) {
              // å¦‚æœ pet å¯¹è±¡å·²å­˜åœ¨ï¼Œè¯´æ˜æ˜¯è€ç”¨æˆ·ï¼Œé»˜è®¤å·²é¢†å…»
              if (chat.settings.pet && chat.settings.pet.type !== "æ— ") {
                chat.settings.petAdopted = true;
              } else {
                // å¦‚æœæ²¡æœ‰ pet å¯¹è±¡ï¼Œè¯´æ˜æ˜¯æ–°ç”¨æˆ·æˆ–ä¹‹å‰å°±æ²¡ç”¨å® ç‰©ï¼Œé»˜è®¤æœªé¢†å…»
                chat.settings.petAdopted = false;
              }
              console.log(
                `ä¸ºè§’è‰² "${chat.name}" åˆå§‹åŒ–äº†å® ç‰©é¢†å…»çŠ¶æ€: ${chat.settings.petAdopted}`,
              );
            }

            // 2. å…¼å®¹æ—§çš„ pet å¯¹è±¡ï¼Œç¡®ä¿æ–°å­—æ®µå­˜åœ¨ï¼ˆè¿™æ®µä»£ç å’Œä¹‹å‰ä¸€æ ·ï¼Œä¿ç•™å³å¯ï¼‰
            if (!chat.isGroup && chat.settings.pet) {
              if (typeof chat.settings.pet.persona === "undefined") {
                chat.settings.pet.persona =
                  "ä¸€åªå¯çˆ±çš„å°å® ç‰©ï¼Œå¯¹ä¸–ç•Œå……æ»¡å¥½å¥‡ã€‚";
              }
              if (!chat.settings.pet.petChatHistory) {
                chat.settings.pet.petChatHistory = [];
              }
              if (!chat.settings.pet.status) {
                chat.settings.pet.status = {
                  hunger: 100,
                  happiness: 100,
                  intimacyToUser: 50,
                  intimacyToChar: 50,
                  lastUpdated: Date.now(),
                };
              } else {
                if (
                  typeof chat.settings.pet.status.intimacyToUser === "undefined"
                )
                  chat.settings.pet.status.intimacyToUser = 50;
                if (
                  typeof chat.settings.pet.status.intimacyToChar === "undefined"
                )
                  chat.settings.pet.status.intimacyToChar = 50;
                if (typeof chat.settings.pet.status.lastUpdated === "undefined")
                  chat.settings.pet.status.lastUpdated = Date.now();
              }
            }

            // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰è®°å¿†äº’é€šè®¾ç½®çš„èŠå¤©æ·»åŠ ä¸€ä¸ªç©ºçš„æ•°ç»„
            if (!chat.settings.linkedMemories) {
              chat.settings.linkedMemories = [];
            }

            // ä¸ºæ—§æ•°æ®æ·»åŠ é»˜è®¤çš„è®°å¿†æ¡æ•°è®¾ç½®
            if (typeof chat.settings.linkMemoryDepth === "undefined") {
              chat.settings.linkMemoryDepth = 5;
            }

            // å…¼å®¹çº¿ä¸‹æ¨¡å¼è®¾ç½®
            if (!chat.settings.offlineMode) {
              chat.settings.offlineMode = {
                enabled: false,
                prompt: "",
                style: "",
                wordCount: 300,
                presets: [],
              };
            }

            if (!chat.isGroup) {
              // åªä¸ºå•èŠè§’è‰²æ·»åŠ 
              if (!chat.characterPhoneData) {
                chat.characterPhoneData = {}; // ä»¥é˜²ä¸‡ä¸€è¿ characterPhoneData éƒ½æ²¡æœ‰
              }
              if (!chat.characterPhoneData.wallpaper) {
                chat.characterPhoneData.wallpaper = ""; // åˆå§‹åŒ–å£çº¸ä¸ºç©º
              }
              if (!chat.characterPhoneData.appIcons) {
                chat.characterPhoneData.appIcons = {}; // åˆå§‹åŒ–Appå›¾æ ‡ä¸ºç©ºå¯¹è±¡
              }
            }
            // ä¸ºæ—§è§’è‰²æ•°æ®å…¼å®¹å¾®åšç‹¬ç«‹è®¾ç½®
            if (!chat.isGroup) {
              if (!chat.settings.weiboNickname) {
                chat.settings.weiboNickname = chat.name; // é»˜è®¤ä½¿ç”¨è§’è‰²åä½œä¸ºå¾®åšæ˜µç§°
              }
              if (!chat.settings.weiboAvatar) {
                chat.settings.weiboAvatar = chat.settings.aiAvatar; // é»˜è®¤ä½¿ç”¨AIå¤´åƒ
              }
              if (!chat.settings.weiboAvatarFrame) {
                chat.settings.weiboAvatarFrame =
                  chat.settings.aiAvatarFrame || ""; // é»˜è®¤ä½¿ç”¨AIå¤´åƒæ¡†
              }
              if (!chat.settings.weiboBackground) {
                chat.settings.weiboBackground =
                  "https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg"; // ç»™ä¸€ä¸ªé»˜è®¤èƒŒæ™¯
              }
              // weiboProfession å’Œ weiboInstruction ä¹‹å‰å·²ç»å…¼å®¹è¿‡äº†ï¼Œè¿™é‡Œä¸ç”¨é‡å¤
            }
            // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰å¾®åšè®¾ç½®çš„å•èŠè§’è‰²æ·»åŠ ç©ºçš„å¾®åšè®¾ç½®
            if (
              !chat.isGroup &&
              (!chat.settings.weiboProfession ||
                typeof chat.settings.weiboInstruction === "undefined")
            ) {
              chat.settings.weiboProfession = "";
              chat.settings.weiboInstruction = "";
              console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†å¾®åšè®¾ç½®å±æ€§ã€‚`);
            }

            // ä¸ºæ—§è§’è‰²æ•°æ®å…¼å®¹å¾®åšç²‰ä¸/å…³æ³¨æ•°
            if (
              !chat.isGroup &&
              (typeof chat.settings.weiboFansCount === "undefined" ||
                typeof chat.settings.weiboFollowingCount === "undefined")
            ) {
              const initialStats = getInitialWeiboStats(chat);
              chat.settings.weiboFansCount = initialStats.fans;
              chat.settings.weiboFollowingCount = initialStats.following;
              console.log(`ä¸ºæ—§è§’è‰² "${chat.name}" åˆå§‹åŒ–äº†å¾®åšæ•°æ®ã€‚`);
            }

            if (
              !chat.isGroup &&
              (!chat.settings ||
                typeof chat.settings.minimaxVoiceId === "undefined")
            ) {
              if (!chat.settings) chat.settings = {};
              chat.settings.minimaxVoiceId = ""; // é»˜è®¤ä¸ºç©º
              console.log(
                `ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº† minimaxVoiceId å±æ€§ã€‚`,
              );
            }

            // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰ç«èŠ±è®¾ç½®çš„èŠå¤©æ·»åŠ é»˜è®¤å€¼
            if (!chat.settings.streak) {
              chat.settings.streak = {
                enabled: false,
                initialDays: 0, // ã€æ–°ã€‘ç”¨æˆ·å¡«å†™çš„åˆå§‹å¤©æ•°
                currentDays: 0, // å½“å‰çš„ç«èŠ±å¤©æ•°
                extinguishThreshold: 1, // ã€æ–°ã€‘ç†„ç­é˜ˆå€¼ï¼Œé»˜è®¤1å¤©
                lastInteractionDate: null, // ä¸Šæ¬¡äº’åŠ¨æ—¥æœŸ
              };
              console.log(
                `ä¸ºè§’è‰² "${chat.name}" è¡¥å…¨äº†å¢å¼ºç‰ˆç«èŠ±(streak)è®¾ç½®ã€‚`,
              );
            } else if (
              typeof chat.settings.streak.extinguishThreshold === "undefined"
            ) {
              // å…¼å®¹ä½ ä¸Šä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œä¸ºå®ƒä»¬ä¹ŸåŠ ä¸Šç†„ç­é˜ˆå€¼
              chat.settings.streak.extinguishThreshold = 1;
              console.log(`ä¸ºè§’è‰² "${chat.name}" çš„æ—§ç«èŠ±è®¾ç½®æ·»åŠ äº†ç†„ç­é˜ˆå€¼ã€‚`);
            }

            // å…¼å®¹æ—§çš„ç¾¤èŠæ•°æ®ï¼Œä¸ºå®ƒä»¬æ·»åŠ ç¾¤ä¸»ã€ç®¡ç†å‘˜å’Œå¤´è¡”å±æ€§
            if (chat.isGroup) {
              if (typeof chat.settings.groupAnnouncement === "undefined") {
                chat.settings.groupAnnouncement = "";
              }

              // å¦‚æœæ²¡æœ‰ownerIdï¼Œåˆ™é»˜è®¤åˆ›å»ºè€…ï¼ˆä¹Ÿå°±æ˜¯ä½ ï¼‰ä¸ºç¾¤ä¸»
              if (!chat.ownerId) {
                chat.ownerId = "user"; // æˆ‘ä»¬å‡è®¾ç”¨æˆ·çš„IDä¸º 'user'
              }
              // éå†æ‰€æœ‰æˆå‘˜ï¼Œä¸ºä»–ä»¬æ·»åŠ æ–°å±æ€§
              if (chat.members && Array.isArray(chat.members)) {
                chat.members.forEach((member) => {
                  if (typeof member.isAdmin === "undefined") {
                    member.isAdmin = false; // é»˜è®¤ä¸æ˜¯ç®¡ç†å‘˜
                  }
                  if (typeof member.groupTitle === "undefined") {
                    member.groupTitle = ""; // é»˜è®¤æ²¡æœ‰å¤´è¡”
                  }
                });
              }
              // ä¸ºç”¨æˆ·è‡ªå·±ä¹Ÿæ·»åŠ ç®¡ç†å‘˜å’Œå¤´è¡”çš„é»˜è®¤å±æ€§
              if (chat.settings) {
                if (typeof chat.settings.isUserAdmin === "undefined") {
                  chat.settings.isUserAdmin = false;
                }
                if (typeof chat.settings.myGroupTitle === "undefined") {
                  chat.settings.myGroupTitle = "";
                }
              }
            }

            // åœ¨ loadAllDataFromDB å‡½æ•°çš„ forEach å¾ªç¯å†…ï¼Œacc[chat.id] = chat; ä¹‹å‰æ·»åŠ ï¼š

            // ä¸ºæ—§æ•°æ®å…¼å®¹å¿ƒå£°é¢æ¿æ ·å¼è®¾ç½®
            if (!chat.settings.innerVoiceStyles) {
              chat.settings.innerVoiceStyles = {
                clothingColor: "#f0a1a8",
                behaviorColor: "#81c784",
                thoughtsColor: "#64b5f6",
                naughtyColor: "#ba68c8",
                cardBgColor: "#ffffff",
                cardOpacity: 0.7,
              };
            }
            // ä¸ºæ—§æ•°æ®å…¼å®¹å›¾æ ‡é¢œè‰²è®¾ç½®
            if (
              chat.settings.innerVoiceStyles &&
              typeof chat.settings.innerVoiceStyles.iconColor === "undefined"
            ) {
              chat.settings.innerVoiceStyles.iconColor = "#ff8a80"; // é»˜è®¤ç²‰çº¢è‰²
            }

            // å…¼å®¹äº²å¯†å€¼ç³»ç»Ÿï¼šä¸ºæ—§æ•°æ®æ·»åŠ äº’åŠ¨ç»Ÿè®¡å’Œå·²è§£é”å¾½ç« 
            if (!chat.interactionStats) {
              chat.interactionStats = {};
            }
            if (!chat.unlockedSymbols) {
              chat.unlockedSymbols = [];
            }

            // å…¼å®¹äº²å¯†å€¼ç³»ç»Ÿï¼šä¸ºæ—§æ•°æ®æ·»åŠ ä½©æˆ´å¾½ç« çš„å­—æ®µ
            if (
              chat.settings &&
              typeof chat.settings.selectedIntimacyBadge === "undefined"
            ) {
              chat.settings.selectedIntimacyBadge = ""; // é»˜è®¤ä¸ºç©ºï¼Œä¸ä½©æˆ´
            }

            if (!chat.isGroup && chat.settings) {
              if (typeof chat.settings.language_boost === "undefined") {
                chat.settings.language_boost = null; // é»˜è®¤ä¸ºnull
              }
              if (typeof chat.settings.speed === "undefined") {
                chat.settings.speed = 1.0; // é»˜è®¤ä¸º1.0
              }
            }
            // ä¸ºæ—§æ•°æ®è¡¥å…¨æƒ…ä¾£å¤´åƒåº“
            if (!chat.isGroup && !chat.settings.coupleAvatarLibrary) {
              chat.settings.coupleAvatarLibrary = [];
              console.log(
                `ä¸ºæ—§è§’è‰² "${chat.name}" è¡¥å…¨äº†æƒ…ä¾£å¤´åƒåº“(coupleAvatarLibrary)å±æ€§ã€‚`,
              );
            }
            acc[chat.id] = chat;
            return acc;
          }, {});

          state.apiConfig = apiConfig || {
            id: "main",
            proxyUrl: "",
            apiKey: "",
            model: "",
            temperature: 0.8, // æ–°å¢ï¼šä¸ºæ¸©åº¦è®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼ 0.8
            minimaxGroupId: "",
            minimaxApiKey: "",
            minimaxProvider: "cn",
            minimaxSpeechModel: "speech-01-turbo",
            pollinationsApiKey: "", // <--- æ–°å¢è¿™ä¸€è¡Œ
          };

          // å…¼å®¹æ—§æ•°æ®ï¼Œå¦‚æœåŠ è½½çš„è®¾ç½®é‡Œæ²¡æœ‰æ¸©åº¦ï¼Œä¹Ÿç»™ä¸€ä¸ªé»˜è®¤å€¼
          if (typeof state.apiConfig.temperature === "undefined") {
            state.apiConfig.temperature = 0.8;
          }

          state.globalSettings = globalSettings || {
            id: "main",
            quickReplies: ["ä½ å¥½", "ç»§ç»­", "æœ‰è¶£"],
            ringtoneUrl: "https://files.catbox.moe/3w7gla.mp3",
            notificationSoundUrl: "https://files.catbox.moe/k369mf.mp3", // <-- åœ¨è¿™é‡Œæ–°å¢è¿™ä¸€è¡Œ
            widgetData: {},
            wallpaper: "linear-gradient(135deg, #89f7fe, #66a6ff)",
            lockscreenWallpaper: "linear-gradient(135deg, #764ba2, #667eea)",
            password: "",
            fontUrl: "",
            enableBackgroundActivity: false,
            backgroundActivityInterval: 60,
            blockCooldownHours: 1,
            appIcons: { ...DEFAULT_APP_ICONS },
            appLabels: {},
            ringtoneUrl: "https://files.catbox.moe/3w7gla.mp3",
            notificationSoundUrl: "https://files.catbox.moe/k369mf.mp3",
            widgetData: {}, // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ–°å¢ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œç”¨æ¥å­˜æ”¾ä½ çš„è‡ªå®šä¹‰å†…å®¹
            // åœ¨ state.globalSettings çš„åˆå§‹åŒ–å¯¹è±¡é‡Œæ·»åŠ ï¼š
            homeAvatarFrame: "", // ä¸ºä¸»å±å¹•å¤´åƒæ¡†æ·»åŠ é»˜è®¤ç©ºå€¼

            globalChatBackground: "",
            homeIconWidgetTextColor: "#FFFFFF", // <-- ä¿®æ”¹è¿™é‡Œçš„åå­—
            imageCompressionQuality: 0.7,
            userBalance: 520,

            homeAvatarFrame: "", // ä¸ºä¸»å±å¹•å¤´åƒæ¡†æ·»åŠ é»˜è®¤ç©ºå€¼
          };
          // ç¡®ä¿å³ä½¿ä»æ—§æ•°æ®åº“åŠ è½½ï¼Œè¿™ä¸ªå±æ€§ä¹Ÿå­˜åœ¨
          if (!state.globalSettings.widgetData) {
            state.globalSettings.widgetData = {};
          }

          if (!state.globalSettings.homeIconWidgetTextColor) {
            // <-- ä¿®æ”¹è¿™é‡Œçš„åå­—
            state.globalSettings.homeIconWidgetTextColor = "#FFFFFF";
          }
          // å…¼å®¹å­—ä½“é˜´å½±è®¾ç½®
          if (
            typeof state.globalSettings.removeHomeFontShadow === "undefined"
          ) {
            state.globalSettings.removeHomeFontShadow = false;
          }

          // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœåŠ è½½çš„è®¾ç½®é‡Œæ²¡æœ‰appLabelsï¼Œå°±ç»™å®ƒä¸€ä¸ªç©ºå¯¹è±¡
          if (!state.globalSettings.appLabels) {
            state.globalSettings.appLabels = {};
          }

          if (
            typeof state.globalSettings.imageCompressionQuality === "undefined"
          ) {
            state.globalSettings.imageCompressionQuality = 0.7;
          }

          // åŠ è½½æ­Œè¯æ è®¾ç½®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤å€¼
          lyricsBarSettings =
            state.globalSettings.lyricsBarSettings || lyricsBarSettings;
          // å…¼å®¹æ—§æ•°æ®ï¼šåˆå§‹åŒ–å¿«æ·å›å¤ (é»˜è®¤ä¸ºç©º)
          if (!state.globalSettings.quickReplies) {
            state.globalSettings.quickReplies = [];
          }

          // åˆå¹¶å·²ä¿å­˜çš„å›¾æ ‡å’Œé»˜è®¤å›¾æ ‡ï¼Œé˜²æ­¢æ›´æ–°åæ—§æ•°æ®ä¸¢å¤±æ–°å›¾æ ‡
          state.globalSettings.appIcons = {
            ...DEFAULT_APP_ICONS,
            ...(state.globalSettings.appIcons || {}),
          };

          state.userStickers = userStickers || [];
          userStickerCategories = localUserStickerCategories || [];
          state.charStickers = charStickers || [];
          state.worldBooks = worldBooks || [];
          currentDatingScenes = datingScenes || [];
          // åŠ è½½æ’­æ”¾åˆ—è¡¨å¹¶æ³¨å…¥â€œéšå½¢â€ä¿æ´»éŸ³é¢‘
          window.state.musicState.playlist = musicLib?.playlist || [];

          const keepAliveUrl = "https://files.catbox.moe/7jn7bp.mp3";

          // æ£€æŸ¥åˆ—è¡¨ä¸­æ˜¯å¦å·²ç»æœ‰è¿™ä¸ªéŸ³é¢‘äº†
          const existingKeepAliveIndex =
            window.state.musicState.playlist.findIndex(
              (t) => t.src === keepAliveUrl,
            );

          // å¦‚æœå·²ç»å­˜åœ¨ï¼Œå…ˆåˆ æ‰æ—§çš„ï¼Œç¡®ä¿å®ƒæ°¸è¿œåœ¨ç¬¬ä¸€ä½ä¸”ä¿¡æ¯æœ€æ–°
          if (existingKeepAliveIndex > -1) {
            window.state.musicState.playlist.splice(existingKeepAliveIndex, 1);
          }

          // åˆ›å»ºä¿æ´»ä¸“ç”¨å¯¹è±¡
          const keepAliveTrack = {
            name: "ã€åå°ä¿æ´»æ¨¡å¼ã€‘(é™éŸ³)",
            artist: "ç‚¹å‡»æ’­æ”¾ä»¥ä¿æŒåå°è¿è¡Œ",
            src: keepAliveUrl,
            // ä½¿ç”¨ APIè®¾ç½® çš„å›¾æ ‡ä½œä¸ºå°é¢
            cover:
              "https://i.postimg.cc/y8YfDNNr/D9FD94FC0A3523D02D9EE3A7B0F57396.png",
            isLocal: false,
            lrcContent:
              "[00:00.00]âš ï¸ åå°ä¿æ´»è¿è¡Œä¸­...\n[00:02.00]æ­¤éŸ³é¢‘æ— å£°\n[00:05.00]ç”¨äºé˜²æ­¢APIè¯·æ±‚ä¸­æ–­\n[99:99.99]End",
            isTemporary: false,
            addedTimestamp: Date.now(),
            // â˜…â˜…â˜… æ ¸å¿ƒæ ‡è®°ï¼šè¿™æ˜¯ä¸€ä¸ªä¿æ´»éŸ³è½¨ â˜…â˜…â˜…
            isKeepAlive: true,
          };

          // å¼ºåˆ¶æ’åˆ°æ’­æ”¾åˆ—è¡¨çš„ç¬¬ 0 ä½
          window.state.musicState.playlist.unshift(keepAliveTrack);

          state.personaPresets = personaPresets || [];
          state.apiPresets = apiPresets || [];
          state.bubbleStylePresets = bubbleStylePresets || [];

          state.qzoneSettings = qzoneSettings || {
            id: "main",
            nickname: "{{user}}",
            avatar: "https://files.catbox.moe/q6z5fc.jpeg",
            banner: "https://files.catbox.moe/r5heyt.gif",
            weiboAvatar: "https://files.catbox.moe/q6z5fc.jpeg",
            weiboNickname: "ä½ çš„æ˜µç§°",
            weiboFansCount: "0",
            weiboBackground:
              "https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg",

            weiboUserProfession: "ç‚¹å‡»è®¾ç½®èŒä¸š",
            weiboUserPersona: "ä¸€ä¸ªæ™®é€šçš„å¾®åšç”¨æˆ·ã€‚",
            weiboUserPersonaPresets: [],
          };
          // å…¼å®¹æ—§æ•°æ®ï¼Œå¦‚æœåŠ è½½è¿›æ¥çš„æ•°æ®æ²¡æœ‰è¿™äº›æ–°å­—æ®µï¼Œå°±è¡¥ä¸Šé»˜è®¤å€¼
          if (!state.qzoneSettings.weiboAvatar)
            state.qzoneSettings.weiboAvatar =
              state.qzoneSettings.avatar ||
              "https://files.catbox.moe/q6z5fc.jpeg";
          if (!state.qzoneSettings.weiboNickname)
            state.qzoneSettings.weiboNickname =
              state.qzoneSettings.nickname || "ä½ çš„æ˜µç§°";
          if (!state.qzoneSettings.weiboFansCount)
            state.qzoneSettings.weiboFansCount = "0";
          if (!state.qzoneSettings.weiboBackground)
            state.qzoneSettings.weiboBackground =
              "https://i.postimg.cc/mk93Y3j1/weibo-bg-default.jpg";

          if (!state.qzoneSettings.weiboUserProfession)
            state.qzoneSettings.weiboUserProfession = "ç‚¹å‡»è®¾ç½®èŒä¸š";
          if (!state.qzoneSettings.weiboUserPersona)
            state.qzoneSettings.weiboUserPersona = "ä¸€ä¸ªæ™®é€šçš„å¾®åšç”¨æˆ·ã€‚";
          if (!state.qzoneSettings.weiboUserPersonaPresets)
            state.qzoneSettings.weiboUserPersonaPresets = [];

          if (!state.qzoneSettings.weiboAvatarFrame)
            state.qzoneSettings.weiboAvatarFrame = "";

          allFavoriteItems = initialFavorites || [];

          if (
            typeof state.globalSettings.notificationSoundUrl === "undefined"
          ) {
            state.globalSettings.notificationSoundUrl =
              "https://files.catbox.moe/k369mf.mp3";
          }
        }

        async function saveGlobalPlaylist() {
          // 1. åœ¨ä¿å­˜å‰ï¼Œå…ˆä»å½“å‰æ’­æ”¾åˆ—è¡¨ä¸­è¿‡æ»¤æ‰æ‰€æœ‰è¢«æ ‡è®°ä¸º isTemporary çš„æ­Œæ›²
          const permanentPlaylist = state.musicState.playlist.filter(
            (track) => !track.isTemporary,
          );

          // 2. åªå°†è¿™ä¸ªâ€œæ°¸ä¹…æ’­æ”¾åˆ—è¡¨â€ä¿å­˜åˆ°æ•°æ®åº“ä¸­
          await db.musicLibrary.put({
            id: "main",
            playlist: permanentPlaylist,
          });
          console.log("å·²å°†æ°¸ä¹…æ’­æ”¾åˆ—è¡¨ä¿å­˜åˆ°æ•°æ®åº“ã€‚");
        }

        function formatTimestamp(timestamp) {
          if (!timestamp) return "";
          const date = new Date(timestamp);
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          return `${hours}:${minutes}`;
        }
        /**
         * æ˜¾ç¤ºç³»ç»Ÿ/åº”ç”¨å†…é€šçŸ¥
         * @param {string} chatId - èŠå¤©ID
         * @param {string} messageContent - æ¶ˆæ¯å†…å®¹
         * @param {string} specificAvatarUrl - [æ–°å¢å‚æ•°] æŒ‡å®šçš„å…·ä½“å¤´åƒURLï¼ˆç”¨äºç¾¤èŠæ˜¾ç¤ºå‘è¨€äººå¤´åƒï¼‰
         */
        async function showNotification(
          chatId,
          messageContent,
          specificAvatarUrl = null,
        ) {
          // æ’­æ”¾éŸ³æ•ˆ
          playNotificationSound();

          // æ¸…é™¤æ—§çš„åº”ç”¨å†…é¡¶éƒ¨æ¨ªå¹…è®¡æ—¶å™¨
          clearTimeout(notificationTimeout);

          const chat = state.chats[chatId];
          if (!chat) return;

          // 1. å‡†å¤‡é€šçŸ¥æ•°æ®
          // é€»è¾‘ä¿®æ”¹ï¼šå¦‚æœä¼ å…¥äº† specificAvatarUrlï¼Œå°±ç›´æ¥ç”¨ï¼›å¦åˆ™æŒ‰åŸé€»è¾‘ï¼ˆç¾¤ç”¨ç¾¤å¤´åƒï¼Œå•èŠç”¨AIå¤´åƒï¼‰
          let avatarUrl = specificAvatarUrl;

          if (!avatarUrl) {
            avatarUrl = chat.isGroup
              ? chat.settings.groupAvatar || defaultGroupAvatar
              : chat.settings.aiAvatar || defaultAvatar;
          }

          const notifName =
            !chat.isGroup && chat.settings.remarkName
              ? chat.settings.remarkName
              : chat.name;

          // 2. æ£€æµ‹æ˜¯å¦éœ€è¦å‘é€ç³»ç»Ÿå¼¹çª— (åŸç”Ÿé€šçŸ¥)
          const isSystemNotifyEnabled =
            state.globalSettings.enableSystemNotifications === true;
          const hasPermission =
            "Notification" in window && Notification.permission === "granted";

          if (isSystemNotifyEnabled && hasPermission) {
            const isChatActive =
              document.getElementById("chat-interface-screen") &&
              document
                .getElementById("chat-interface-screen")
                .classList.contains("active") &&
              state.activeChatId === chatId;

            if (document.hidden || !isChatActive) {
              const options = {
                body: messageContent,
                icon: avatarUrl, // è¿™é‡Œä¹Ÿä¼šè‡ªåŠ¨ä½¿ç”¨æ­£ç¡®çš„å¤´åƒ
                tag: chatId,
                renotify: true,
                silent: true,
                badge:
                  "https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg",
              };

              try {
                if ("serviceWorker" in navigator) {
                  const reg = await navigator.serviceWorker.getRegistration();
                  if (reg) {
                    await reg.showNotification(notifName, options);
                  } else {
                    new Notification(notifName, options);
                  }
                } else {
                  new Notification(notifName, options);
                }
              } catch (e) {
                console.error("ç³»ç»Ÿé€šçŸ¥å‘é€å¤±è´¥:", e.message);
              }
            }
          }

          // 3. åº”ç”¨å†…é¡¶éƒ¨æ¨ªå¹… (ç½‘é¡µå†…å¼¹çª—)
          const bar = document.getElementById("notification-bar");
          const avatarImg = document.getElementById("notification-avatar");

          // è¿™é‡Œè®¾ç½®å›¾ç‰‡
          if (avatarImg) avatarImg.src = avatarUrl;

          const contentDiv = document.getElementById("notification-content");
          if (contentDiv) {
            contentDiv.querySelector(".name").textContent = notifName;
            contentDiv.querySelector(".message").textContent = messageContent;
          }

          if (bar) {
            const newBar = bar.cloneNode(true);
            bar.parentNode.replaceChild(newBar, bar);

            newBar.addEventListener("click", () => {
              openChat(chatId);
              newBar.classList.remove("visible");
            });

            newBar.classList.add("visible");
            notificationTimeout = setTimeout(() => {
              newBar.classList.remove("visible");
            }, 4000);
          }
        }

        /**
         * æ˜¾ç¤ºä¸€ä¸ªåŒ…å«å¤šä¸ªé€‰é¡¹çš„æ“ä½œèœå•æ¨¡æ€æ¡†
         * è¿™æ˜¯è®©å›¾ç‰‡ç¼–è¾‘æ—¶èƒ½å¤Ÿé€‰æ‹©â€œæœ¬åœ°ä¸Šä¼ â€æˆ–â€œURLâ€çš„å…³é”®å‡½æ•°ï¼
         * @param {string} title - æ¨¡æ€æ¡†çš„æ ‡é¢˜
         * @param {Array<object>} options - æŒ‰é’®é€‰é¡¹æ•°ç»„, e.g., [{ text: 'æŒ‰é’®æ–‡å­—', value: 'è¿”å›å€¼' }]
         * @returns {Promise<string|null>} - è¿”å›ç”¨æˆ·ç‚¹å‡»æŒ‰é’®çš„valueï¼Œå¦‚æœå–æ¶ˆåˆ™è¿”å›null
         */
        function showChoiceModal(title, options) {
          return new Promise((resolve) => {
            // å¤ç”¨ä½ ç°æœ‰çš„è‡ªå®šä¹‰æ¨¡æ€æ¡†
            const modal = document.getElementById("preset-actions-modal");
            const footer = modal.querySelector(".custom-modal-footer");

            // æ¸…ç©ºæ—§æŒ‰é’®å¹¶åŠ¨æ€åˆ›å»ºæ–°æŒ‰é’®
            footer.innerHTML = "";

            options.forEach((option) => {
              const button = document.createElement("button");
              button.textContent = option.text;
              button.onclick = () => {
                modal.classList.remove("visible");
                resolve(option.value); // è¿”å›è¢«ç‚¹å‡»æŒ‰é’®çš„å€¼
              };
              footer.appendChild(button);
            });

            // æ·»åŠ ä¸€ä¸ªæ ‡å‡†çš„å–æ¶ˆæŒ‰é’®
            const cancelButton = document.createElement("button");
            cancelButton.textContent = "å–æ¶ˆ";
            cancelButton.style.marginTop = "8px";
            cancelButton.style.borderRadius = "8px";
            cancelButton.style.backgroundColor = "#f0f0f0";
            cancelButton.onclick = () => {
              modal.classList.remove("visible");
              resolve(null); // ç”¨æˆ·å–æ¶ˆï¼Œè¿”å› null
            };
            footer.appendChild(cancelButton);
            modal.style.zIndex = "10005";
            modal.classList.add("visible");
          });
        }

        /**
         * ã€å…¨æ–°é‡æ„ã€‘æ£€æŸ¥å¹¶åˆ é™¤æ‰€æœ‰å¤±æ•ˆçš„APIæ­Œæ›²
         * æ ¸å¿ƒé€»è¾‘ï¼šä¸å†ä¾èµ–ä»»ä½•æ ‡ç­¾ï¼Œç›´æ¥æ ¹æ®é“¾æ¥ç‰¹å¾è¯†åˆ«éœ€è¦æ£€æŸ¥çš„æ­Œæ›²ã€‚
         */
        async function deleteExpiredSearchedSongs() {
          await showCustomAlert(
            "è¯·ç¨å€™...",
            "æ­£åœ¨æ£€æŸ¥æ’­æ”¾åˆ—è¡¨ä¸­æ‰€æœ‰åœ¨çº¿æ­Œæ›²çš„æœ‰æ•ˆæ€§...",
          );

          // 1. ä¸å†å¯»æ‰¾ isTemporary æ ‡ç­¾
          // è€Œæ˜¯ç›´æ¥æ‰¾å‡ºæ‰€æœ‰ src é“¾æ¥æ¥è‡ªäº API æœåŠ¡å™¨çš„æ­Œæ›²ã€‚
          // è¿™æ˜¯ä¸€ä¸ªç»å¯¹å¯é çš„è¯†åˆ«æ–¹æ³•ï¼Œæ— è®ºå®ƒæœ‰æ²¡æœ‰è¢«æ­£ç¡®ä¿å­˜ã€‚
          const songsToCheck = state.musicState.playlist.filter(
            (track) => track.src && track.src.includes("api.vkeys.cn"),
          );

          if (songsToCheck.length === 0) {
            await showCustomAlert("æç¤º", "æ’­æ”¾åˆ—è¡¨ä¸­æ²¡æœ‰éœ€è¦æ£€æŸ¥çš„åœ¨çº¿æ­Œæ›²ã€‚");
            return;
          }

          const songsToDelete = [];
          const twentyFourHoursAgo = Date.now() - 24 * 60 * 60 * 1000;

          // 2. å¯¹æ¯ä¸€é¦–è¯†åˆ«å‡ºçš„æ­Œæ›²ï¼Œè¿›è¡Œä¸¥æ ¼çš„â€œä½“æ£€â€
          await Promise.all(
            songsToCheck.map(async (track) => {
              // æ¡ä»¶1ï¼šæ£€æŸ¥é“¾æ¥æœ¬èº«æ˜¯å¦å·²ç»å¤±æ•ˆï¼ˆæ— æ³•æ’­æ”¾ï¼‰
              const isUrlInvalid = !(await checkAudioAvailability(track.src));

              // æ¡ä»¶2ï¼šæ£€æŸ¥æ·»åŠ æ—¶é—´æ˜¯å¦è¶…è¿‡24å°æ—¶ï¼ˆä½œä¸ºåŒé‡ä¿é™©ï¼‰
              const isOlderThan24h =
                track.addedTimestamp &&
                track.addedTimestamp < twentyFourHoursAgo;

              if (isUrlInvalid || isOlderThan24h) {
                songsToDelete.push(track);
                console.log(
                  `æ ‡è®°åˆ é™¤: ${track.name} (åŸå› : ${
                    isUrlInvalid ? "é“¾æ¥å¤±æ•ˆ" : ""
                  } ${isOlderThan24h ? "è¶…è¿‡24å°æ—¶" : ""})`,
                );
              }
            }),
          );

          // 3. æ ¹æ®æ£€æŸ¥ç»“æœè¿›è¡Œåé¦ˆå’Œæ“ä½œ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
          if (songsToDelete.length === 0) {
            await showCustomAlert(
              "æ£€æŸ¥å®Œæˆ",
              "æ’­æ”¾åˆ—è¡¨ä¸­çš„æ‰€æœ‰åœ¨çº¿æ­Œæ›²å½“å‰å‡æœ‰æ•ˆã€‚",
            );
            return;
          }

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤æ¸…ç†",
            `æ£€æµ‹åˆ° ${songsToDelete.length} é¦–å·²å¤±æ•ˆçš„åœ¨çº¿æ­Œæ›²ã€‚ç¡®å®šè¦å°†å®ƒä»¬ä»åˆ—è¡¨ä¸­ç§»é™¤å—ï¼Ÿ`,
            { confirmButtonClass: "btn-danger" },
          );

          if (!confirmed) return;

          // æ‰§è¡Œåˆ é™¤...
          const currentTrack =
            state.musicState.currentIndex > -1
              ? state.musicState.playlist[state.musicState.currentIndex]
              : null;
          state.musicState.playlist = state.musicState.playlist.filter(
            (track) => !songsToDelete.includes(track),
          );
          const newIndex = currentTrack
            ? state.musicState.playlist.findIndex(
                (t) =>
                  t.src === currentTrack.src && t.name === currentTrack.name,
              )
            : -1;

          if (newIndex === -1) {
            if (state.musicState.isPlaying) {
              audioPlayer.pause();
              audioPlayer.src = "";
            }
            state.musicState.isPlaying = false;
            if (state.musicState.playlist.length > 0) {
              playSong(0);
            } else {
              state.musicState.currentIndex = -1;
              updatePlayerUI();
            }
          } else {
            state.musicState.currentIndex = newIndex;
            updatePlayerUI();
          }

          await saveGlobalPlaylist();
          updatePlaylistUI();
          await showCustomAlert(
            "æ¸…ç†å®Œæˆ",
            `${songsToDelete.length} é¦–æ­Œæ›²å·²ä»åˆ—è¡¨ä¸­ç§»é™¤ã€‚`,
          );
        }

        /**
         * æ›´æ–°æ‰€æœ‰æ—¶é’Ÿï¼ˆçŠ¶æ€æ å’Œé”å±ï¼‰
         */
        function updateClock() {
          const now = new Date();
          const timeString = now.toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          });
          const dateString = now.toLocaleDateString("zh-CN", {
            weekday: "long",
            month: "long",
            day: "numeric",
          });

          // æ›´æ–°çŠ¶æ€æ æ—¶é’Ÿ (è¿™ä¸ªå…ƒç´ ä¸€ç›´å­˜åœ¨)
          const statusBarTime = document.getElementById("status-bar-time");
          if (statusBarTime) {
            statusBarTime.textContent = timeString;
          }

          // æ›´æ–°é”å±æ—¶é’Ÿ (åªæœ‰å½“é”å±å…ƒç´ å­˜åœ¨æ—¶æ‰æ›´æ–°ï¼Œé¿å…æŠ¥é”™)
          const lockTime = document.getElementById("lock-main-time");
          const lockDate = document.getElementById("lock-main-date");
          if (lockTime) {
            lockTime.textContent = timeString;
          }
          if (lockDate) {
            lockDate.textContent = dateString;
          }
        }

        /**
         * è§£æAIè¿”å›çš„ã€å¯èƒ½æ ¼å¼ä¸è§„èŒƒçš„å“åº”å†…å®¹
         * @param {string} content - AIè¿”å›çš„åŸå§‹å­—ç¬¦ä¸²
         * @returns {Array} - ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ¶ˆæ¯å¯¹è±¡æ•°ç»„
         */
        function parseAiResponse(content) {
          const trimmedContent = content.trim();

          // æ–¹æ¡ˆ1ï¼šã€æœ€ä¼˜å…ˆã€‘å°è¯•ä½œä¸ºæ ‡å‡†çš„ã€å•ä¸€çš„JSONæ•°ç»„è§£æ
          // è¿™æ˜¯æœ€ç†æƒ³ã€æœ€é«˜æ•ˆçš„æƒ…å†µ
          if (trimmedContent.startsWith("[") && trimmedContent.endsWith("]")) {
            try {
              const parsed = JSON.parse(trimmedContent);
              if (Array.isArray(parsed)) {
                console.log("è§£ææˆåŠŸï¼šæ ‡å‡†JSONæ•°ç»„æ ¼å¼ã€‚");
                return parsed;
              }
            } catch (e) {
              // å¦‚æœè§£æå¤±è´¥ï¼Œè¯´æ˜å®ƒè™½ç„¶çœ‹èµ·æ¥åƒä¸ªæ•°ç»„ï¼Œä½†å†…éƒ¨æ ¼å¼æœ‰é—®é¢˜ã€‚
              // æ­¤æ—¶æˆ‘ä»¬ä¸æŠ¥é”™ï¼Œè€Œæ˜¯ç»§ç»­å°è¯•ä¸‹é¢çš„â€œå¼ºåŠ›è§£æâ€æ–¹æ¡ˆã€‚
              console.warn("æ ‡å‡†JSONæ•°ç»„è§£æå¤±è´¥ï¼Œå°†å°è¯•å¼ºåŠ›è§£æ...");
            }
          }

          // æ–¹æ¡ˆ2ï¼šã€å¼ºåŠ›è§£æã€‘ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œä»æ··ä¹±çš„å­—ç¬¦ä¸²ä¸­æå–å‡ºæ‰€æœ‰ç‹¬ç«‹çš„JSONå¯¹è±¡
          // è¿™èƒ½å®Œç¾è§£å†³æ‚¨é‡åˆ°çš„ "(Timestamp: ...)[{...}](Timestamp: ...)[{...}]" è¿™ç§æ ¼å¼
          const jsonMatches = trimmedContent.match(/{[^{}]*}/g);

          if (jsonMatches) {
            const results = [];
            for (const match of jsonMatches) {
              try {
                // å°è¯•è§£ææ¯ä¸€ä¸ªè¢«æˆ‘ä»¬â€œæªâ€å‡ºæ¥çš„JSONå­—ç¬¦ä¸²
                const parsedObject = JSON.parse(match);
                results.push(parsedObject);
              } catch (e) {
                // å¦‚æœæŸä¸ªç‰‡æ®µä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œå°±å¿½ç•¥å®ƒï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª
                console.warn("è·³è¿‡ä¸€ä¸ªæ— æ•ˆçš„JSONç‰‡æ®µ:", match);
              }
            }

            // å¦‚æœæˆ‘ä»¬æˆåŠŸæå–å‡ºäº†è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆçš„JSONå¯¹è±¡ï¼Œå°±è¿”å›è¿™ä¸ªç»“æœ
            if (results.length > 0) {
              console.log("è§£ææˆåŠŸï¼šé€šè¿‡å¼ºåŠ›æå–æ¨¡å¼ã€‚");
              return results;
            }
          }

          // æ–¹æ¡ˆ3ï¼šã€æœ€ç»ˆå¤‡ç”¨ã€‘å¦‚æœä»¥ä¸Šæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥äº†ï¼Œè¯´æ˜AIè¿”å›çš„å¯èƒ½å°±æ˜¯çº¯æ–‡æœ¬
          // æˆ‘ä»¬å°†åŸå§‹çš„ã€æœªå¤„ç†çš„å†…å®¹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ ‡å‡†çš„æ–‡æœ¬æ¶ˆæ¯å¯¹è±¡è¿”å›ï¼Œç¡®ä¿ç¨‹åºä¸ä¼šå´©æºƒ
          console.error("æ‰€æœ‰è§£ææ–¹æ¡ˆå‡å¤±è´¥ï¼å°†è¿”å›åŸå§‹æ–‡æœ¬ã€‚");
          return [{ type: "text", content: content }];
        }
        /**
         * â€œæ‹‰å–â€å¹¶å¡«å……Minimaxè¯­éŸ³æ¨¡å‹çš„ä¸‹æ‹‰æ¡†
         */
        function fetchMinimaxSpeechModels() {
          const modelSelect = document.getElementById(
            "minimax-speech-model-select",
          );
          if (!modelSelect) return;
          modelSelect.innerHTML = ""; // æ¸…ç©ºæ—§é€‰é¡¹

          // ä»æ–‡æ¡£ä¸­è·å–çš„å®Œæ•´æ¨¡å‹åˆ—è¡¨
          const models = [
            "speech-2.6-hd",
            "speech-2.6-turbo",
            "speech-02-hd",
            "speech-02-turbo",
            "speech-01-hd",
            "speech-01-turbo",
          ];

          models.forEach((modelId) => {
            const option = document.createElement("option");
            option.value = modelId;
            option.textContent = modelId;
            modelSelect.appendChild(option);
          });

          // è‡ªåŠ¨é€‰ä¸­å½“å‰å·²ä¿å­˜çš„æ¨¡å‹ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ä¸€ä¸ªæ¨èçš„é»˜è®¤å€¼
          modelSelect.value =
            state.apiConfig.minimaxSpeechModel || "speech-01-turbo";

          alert("Minimax è¯­éŸ³æ¨¡å‹åˆ—è¡¨å·²æ›´æ–°ï¼");
        }
        // NovelAIè®¾ç½®ç›¸å…³å‡½æ•°ï¼ˆåŠ è½½ã€ä¿å­˜ã€é‡ç½®ï¼‰
        // NovelAIè®¾ç½®ç›¸å…³å‡½æ•°
        function loadNovelAISettings() {
          const settings = getNovelAISettings();
          document.getElementById("nai-resolution").value = settings.resolution;
          document.getElementById("nai-steps").value = settings.steps;
          document.getElementById("nai-cfg-scale").value = settings.cfg_scale;
          document.getElementById("nai-sampler").value = settings.sampler;
          document.getElementById("nai-seed").value = settings.seed;
          document.getElementById("nai-uc-preset").value = settings.uc_preset;
          document.getElementById("nai-quality-toggle").checked =
            settings.quality_toggle;
          document.getElementById("nai-smea").checked = settings.smea;
          document.getElementById("nai-smea-dyn").checked = settings.smea_dyn;
          document.getElementById("nai-default-positive").value =
            settings.default_positive;
          document.getElementById("nai-default-negative").value =
            settings.default_negative;
          document.getElementById("nai-cors-proxy").value = settings.cors_proxy;
          document.getElementById("nai-custom-proxy-url").value =
            settings.custom_proxy_url || "";

          // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰ä»£ç†è¾“å…¥æ¡†
          const customProxyGroup = document.getElementById(
            "nai-custom-proxy-group",
          );
          customProxyGroup.style.display =
            settings.cors_proxy === "custom" ? "block" : "none";
        }

        function saveNovelAISettings() {
          // ä¿å­˜API Keyå’Œæ¨¡å‹ç­‰åŸºç¡€é…ç½®
          const novelaiEnabled =
            document.getElementById("novelai-switch").checked;
          const novelaiModel = document.getElementById("novelai-model").value;
          const novelaiApiKey = document
            .getElementById("novelai-api-key")
            .value.trim();

          localStorage.setItem("novelai-enabled", novelaiEnabled);
          localStorage.setItem("novelai-model", novelaiModel);
          localStorage.setItem("novelai-api-key", novelaiApiKey);

          // ä¿å­˜é«˜çº§å‚æ•°é…ç½®
          const settings = {
            resolution: document.getElementById("nai-resolution").value,
            steps: parseInt(document.getElementById("nai-steps").value),
            cfg_scale: parseFloat(
              document.getElementById("nai-cfg-scale").value,
            ),
            sampler: document.getElementById("nai-sampler").value,
            seed: parseInt(document.getElementById("nai-seed").value),
            uc_preset: parseInt(document.getElementById("nai-uc-preset").value),
            quality_toggle:
              document.getElementById("nai-quality-toggle").checked,
            smea: document.getElementById("nai-smea").checked,
            smea_dyn: document.getElementById("nai-smea-dyn").checked,
            default_positive: document.getElementById("nai-default-positive")
              .value,
            default_negative: document.getElementById("nai-default-negative")
              .value,
            cors_proxy: document.getElementById("nai-cors-proxy").value,
            custom_proxy_url: document.getElementById("nai-custom-proxy-url")
              .value,
          };

          localStorage.setItem("novelai-settings", JSON.stringify(settings));
        }

        function resetNovelAISettings() {
          localStorage.removeItem("novelai-settings");
          loadNovelAISettings();
          alert("å·²æ¢å¤é»˜è®¤è®¾ç½®ï¼");
        }

        function getNovelAISettings() {
          const defaultSettings = {
            resolution: "1024x1024",
            steps: 28,
            cfg_scale: 5,
            sampler: "k_euler_ancestral",
            seed: -1,
            uc_preset: 1,
            quality_toggle: true,
            smea: true,
            smea_dyn: false,
            default_positive:
              "masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style",
            default_negative:
              "lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry",
            cors_proxy: "https://corsproxy.io/?",
            custom_proxy_url: "",
          };

          const saved = localStorage.getItem("novelai-settings");
          if (saved) {
            try {
              return { ...defaultSettings, ...JSON.parse(saved) };
            } catch (e) {
              return defaultSettings;
            }
          }
          return defaultSettings;
        }

        /**
         * æ ¹æ®è§’è‰²IDè·å–å¯¹åº”çš„NAIæç¤ºè¯é…ç½®
         * @param {string} chatId - èŠå¤©/è§’è‰²ID
         * @returns {Object} åŒ…å«æ­£é¢å’Œè´Ÿé¢æç¤ºè¯çš„å¯¹è±¡
         */
        function getCharacterNAIPrompts(chatId) {
          // è·å–ç³»ç»Ÿé»˜è®¤é…ç½®
          const systemSettings = getNovelAISettings();

          // å¦‚æœæ²¡æœ‰æŒ‡å®šè§’è‰²IDæˆ–è§’è‰²ä¸å­˜åœ¨ï¼Œè¿”å›ç³»ç»Ÿé…ç½®
          if (!chatId || !state.chats[chatId]) {
            console.log("âš ï¸ NAIæç¤ºè¯ï¼šæ²¡æœ‰è§’è‰²ï¼Œä½¿ç”¨ç³»ç»Ÿé…ç½®");
            return {
              positive: systemSettings.default_positive,
              negative: systemSettings.default_negative,
              source: "system",
            };
          }

          const chat = state.chats[chatId];
          const naiSettings = chat.settings.naiSettings || {};

          // é€‰è§’è‰²å°±ç”¨è§’è‰²çš„ï¼Œé€‰ç³»ç»Ÿå°±ç”¨ç³»ç»Ÿçš„ï¼Œå°±è¿™ä¹ˆç®€å•ï¼
          if (naiSettings.promptSource === "character") {
            console.log("âœ… NAIæç¤ºè¯ï¼šä½¿ç”¨è§’è‰²é…ç½®");
            console.log(
              "   æ­£é¢:",
              naiSettings.characterPositivePrompt || "(ç©º)",
            );
            console.log(
              "   è´Ÿé¢:",
              naiSettings.characterNegativePrompt || "(ç©º)",
            );

            return {
              positive: naiSettings.characterPositivePrompt || "",
              negative: naiSettings.characterNegativePrompt || "",
              source: "character",
            };
          } else {
            console.log("âœ… NAIæç¤ºè¯ï¼šä½¿ç”¨ç³»ç»Ÿé…ç½®");
            console.log("   æ­£é¢:", systemSettings.default_positive || "(ç©º)");
            console.log("   è´Ÿé¢:", systemSettings.default_negative || "(ç©º)");

            return {
              positive: systemSettings.default_positive,
              negative: systemSettings.default_negative,
              source: "system",
            };
          }
        }

        /**
         * ä¸ºæŒ‡å®šè§’è‰²ç”ŸæˆNovelAIå›¾åƒï¼ˆå°†æ¥èŠå¤©è°ƒç”¨æ—¶ä½¿ç”¨ï¼‰
         * @param {string} chatId - èŠå¤©/è§’è‰²ID
         * @param {string} customPrompt - å¯é€‰çš„è‡ªå®šä¹‰æ­£é¢æç¤ºè¯ï¼ˆå¦‚æœæä¾›åˆ™è¿½åŠ åˆ°é…ç½®çš„æç¤ºè¯åï¼‰
         * @returns {Promise<string>} è¿”å›ç”Ÿæˆçš„å›¾åƒBase64æ•°æ®URL
         */
        async function generateNovelAIImageForCharacter(
          chatId,
          customPrompt = "",
        ) {
          const apiKey = document
            .getElementById("novelai-api-key")
            .value.trim();
          const model = document.getElementById("novelai-model").value;

          if (!apiKey) {
            throw new Error("è¯·å…ˆé…ç½®NovelAI API Keyï¼");
          }

          // è·å–è§’è‰²çš„æç¤ºè¯é…ç½®
          const prompts = getCharacterNAIPrompts(chatId);

          // æ„å»ºæœ€ç»ˆçš„æç¤ºè¯ï¼ˆå¦‚æœæœ‰è‡ªå®šä¹‰æç¤ºè¯åˆ™è¿½åŠ ï¼‰
          let finalPrompt = prompts.positive;
          if (customPrompt) {
            finalPrompt = customPrompt + ", " + prompts.positive;
          }

          const negativePrompt = prompts.negative;

          console.log(
            `ğŸ“ ä½¿ç”¨${prompts.source === "character" ? "è§’è‰²ä¸“å±" : "ç³»ç»Ÿ"}æç¤ºè¯é…ç½®`,
          );
          console.log("æ­£é¢æç¤ºè¯:", finalPrompt);
          console.log("è´Ÿé¢æç¤ºè¯:", negativePrompt);

          const settings = getNovelAISettings();

          // åç»­çš„å›¾åƒç”Ÿæˆé€»è¾‘å°†åœ¨è¿™é‡Œå®ç°
          // è¿™ä¸ªå‡½æ•°é¢„ç•™ç»™å°†æ¥èŠå¤©ä¸­è°ƒç”¨NAIå‡ºå›¾åŠŸèƒ½ä½¿ç”¨
          return null;
        }

        // ç”ŸæˆNovelAIå›¾ç‰‡çš„ä¸»å‡½æ•°ï¼ˆå®Œæ•´ç‰ˆï¼‰
        async function generateNovelAIImage() {
          const apiKey = document
            .getElementById("novelai-api-key")
            .value.trim();
          const model = document.getElementById("novelai-model").value;
          const prompt = document
            .getElementById("nai-test-prompt")
            .value.trim();

          if (!apiKey) {
            alert("è¯·å…ˆé…ç½®NovelAI API Keyï¼");
            return;
          }

          if (!prompt) {
            alert("è¯·è¾“å…¥æç¤ºè¯ï¼");
            return;
          }

          const settings = getNovelAISettings();
          const negativePrompt = document
            .getElementById("nai-test-negative")
            .value.trim();

          const statusDiv = document.getElementById("nai-test-status");
          const resultDiv = document.getElementById("nai-test-result");
          const errorDiv = document.getElementById("nai-test-error");
          const generateBtn = document.getElementById("nai-generate-btn");

          statusDiv.style.display = "block";
          resultDiv.style.display = "none";
          errorDiv.style.display = "none";
          generateBtn.disabled = true;
          generateBtn.textContent = "ç”Ÿæˆä¸­...";

          try {
            const [width, height] = settings.resolution.split("x").map(Number);

            // V4/V4.5 å’Œ V3 ä½¿ç”¨ä¸åŒçš„è¯·æ±‚ä½“æ ¼å¼
            let requestBody;

            if (model.includes("nai-diffusion-4")) {
              // V4/V4.5 ä½¿ç”¨æ–°æ ¼å¼ (params_version: 3)
              requestBody = {
                input: prompt,
                model: model,
                action: "generate",
                parameters: {
                  params_version: 3, // V4å¿…é¡»ä½¿ç”¨ç‰ˆæœ¬3
                  width: width,
                  height: height,
                  scale: settings.cfg_scale,
                  sampler: settings.sampler,
                  steps: settings.steps,
                  seed:
                    settings.seed === -1
                      ? Math.floor(Math.random() * 9999999999)
                      : settings.seed,
                  n_samples: 1,
                  ucPreset: settings.uc_preset,
                  qualityToggle: settings.quality_toggle,
                  autoSmea: false,
                  dynamic_thresholding: false,
                  controlnet_strength: 1,
                  legacy: false,
                  add_original_image: true,
                  cfg_rescale: 0,
                  noise_schedule: "karras", // V4ä½¿ç”¨karras
                  legacy_v3_extend: false,
                  skip_cfg_above_sigma: null,
                  use_coords: false,
                  legacy_uc: false,
                  normalize_reference_strength_multiple: true,
                  inpaintImg2ImgStrength: 1,
                  characterPrompts: [],
                  // V4ä¸“ç”¨æç¤ºè¯æ ¼å¼
                  v4_prompt: {
                    caption: {
                      base_caption: prompt,
                      char_captions: [],
                    },
                    use_coords: false,
                    use_order: true,
                  },
                  // V4ä¸“ç”¨è´Ÿé¢æç¤ºè¯æ ¼å¼
                  v4_negative_prompt: {
                    caption: {
                      base_caption: negativePrompt,
                      char_captions: [],
                    },
                    legacy_uc: false,
                  },
                  negative_prompt: negativePrompt,
                  deliberate_euler_ancestral_bug: false,
                  prefer_brownian: true,
                  // æ³¨æ„ï¼šä¸åŒ…å« stream å‚æ•°ï¼Œä½¿ç”¨æ ‡å‡†ZIPå“åº”è€Œémsgpackæµ
                },
              };
            } else {
              // V3 åŠæ›´æ—©ç‰ˆæœ¬ä½¿ç”¨æ—§æ ¼å¼
              requestBody = {
                input: prompt,
                model: model,
                action: "generate",
                parameters: {
                  width: width,
                  height: height,
                  scale: settings.cfg_scale,
                  sampler: settings.sampler,
                  steps: settings.steps,
                  seed:
                    settings.seed === -1
                      ? Math.floor(Math.random() * 9999999999)
                      : settings.seed,
                  n_samples: 1,
                  ucPreset: settings.uc_preset,
                  qualityToggle: settings.quality_toggle,
                  sm: settings.smea,
                  sm_dyn: settings.smea_dyn,
                  dynamic_thresholding: false,
                  controlnet_strength: 1,
                  legacy: false,
                  add_original_image: false,
                  cfg_rescale: 0,
                  noise_schedule: "native",
                  negative_prompt: negativePrompt,
                },
              };
            }

            console.log("ğŸ“¤ å‘é€è¯·æ±‚åˆ° NovelAI API");
            console.log("ğŸ“Š ä½¿ç”¨æ¨¡å‹:", model);
            console.log("ğŸ“‹ è¯·æ±‚ä½“:", JSON.stringify(requestBody, null, 2));

            // æ ¹æ®æ¨¡å‹é€‰æ‹©ä¸åŒçš„APIç«¯ç‚¹
            let apiUrl;

            // V4/V4.5 æ¨¡å‹ä½¿ç”¨æµå¼ç«¯ç‚¹
            if (model.includes("nai-diffusion-4")) {
              // V4/V4.5 é»˜è®¤ä½¿ç”¨æµå¼ç«¯ç‚¹
              apiUrl = "https://image.novelai.net/ai/generate-image-stream";
            } else {
              // V3 åŠæ›´æ—©ç‰ˆæœ¬ä½¿ç”¨æ ‡å‡†ç«¯ç‚¹
              apiUrl = "https://image.novelai.net/ai/generate-image";
            }

            let corsProxy = settings.cors_proxy;

            // å¦‚æœé€‰æ‹©äº†è‡ªå®šä¹‰ä»£ç†ï¼Œä½¿ç”¨è‡ªå®šä¹‰URL
            if (corsProxy === "custom") {
              corsProxy = settings.custom_proxy_url || "";
            }

            // å¦‚æœæœ‰ä»£ç†ï¼Œæ·»åŠ åˆ°URLå‰é¢
            if (corsProxy && corsProxy !== "") {
              apiUrl = corsProxy + encodeURIComponent(apiUrl);
            }

            // Chromeæµè§ˆå™¨ä¸“ç”¨å¤„ç†ï¼šé¿å…headersä¸­åŒ…å«éISO-8859-1å­—ç¬¦
            const isChrome =
              /Chrome/.test(navigator.userAgent) &&
              !/Edg/.test(navigator.userAgent);
            let fetchOptions = {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + apiKey,
              },
              body: JSON.stringify(requestBody),
            };

            // é’ˆå¯¹Chromeæµè§ˆå™¨ï¼šç¡®ä¿æ‰€æœ‰headerå€¼éƒ½æ˜¯çº¯ASCII
            if (isChrome) {
              console.log("ğŸ”§ æ£€æµ‹åˆ°Chromeæµè§ˆå™¨ï¼Œå¯ç”¨headerså…¼å®¹æ€§å¤„ç†");
              const cleanHeaders = {};
              for (const [key, value] of Object.entries(fetchOptions.headers)) {
                // ç¡®ä¿headerå€¼åªåŒ…å«ASCIIå­—ç¬¦ï¼ˆISO-8859-1å…¼å®¹ï¼‰
                cleanHeaders[key] = value.replace(/[^\x00-\xFF]/g, "");
              }
              fetchOptions.headers = cleanHeaders;
            }

            const response = await fetch(apiUrl, fetchOptions);

            console.log("Response status:", response.status);
            console.log("Response headers:", [...response.headers.entries()]);

            if (!response.ok) {
              const errorText = await response.text();
              console.error("APIé”™è¯¯å“åº”:", errorText);
              throw new Error(`APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
            }

            // NovelAI APIè¿”å›çš„æ˜¯ZIPæ–‡ä»¶ï¼Œéœ€è¦è§£å‹
            const contentType = response.headers.get("content-type");
            console.log("Content-Type:", contentType);

            // æ£€æŸ¥æ˜¯å¦ä¸º SSE æµå¼å“åº”
            let zipBlob;
            if (contentType && contentType.includes("text/event-stream")) {
              console.log("æ£€æµ‹åˆ° SSE æµå¼å“åº”ï¼Œå¼€å§‹è§£æ...");
              statusDiv.textContent = "æ­£åœ¨æ¥æ”¶æµå¼æ•°æ®...";

              // è¯»å–æ•´ä¸ªæµ
              const text = await response.text();
              console.log("æ”¶åˆ° SSE æ•°æ®ï¼Œå¤§å°:", text.length);

              // è§£æ SSE æ ¼å¼ï¼Œæå–æœ€åçš„ data: è¡Œ
              const lines = text.trim().split("\n");
              let base64Data = null;

              for (let i = lines.length - 1; i >= 0; i--) {
                const line = lines[i].trim();
                if (line.startsWith("data: ") && line !== "data: [DONE]") {
                  const dataContent = line.substring(6); // ç§»é™¤ 'data: ' å‰ç¼€

                  // å°è¯•è§£æ JSON
                  try {
                    const jsonData = JSON.parse(dataContent);

                    // V4.5 æµå¼ç«¯ç‚¹ï¼ševent_type ä¸º "final" æ—¶åŒ…å«æœ€ç»ˆå›¾ç‰‡
                    if (jsonData.event_type === "final" && jsonData.image) {
                      base64Data = jsonData.image;
                      console.log("âœ… æ‰¾åˆ° final äº‹ä»¶çš„å›¾ç‰‡æ•°æ®");
                      break;
                    }

                    // å…¼å®¹å…¶ä»–æ ¼å¼
                    if (jsonData.data) {
                      base64Data = jsonData.data;
                      console.log("ä» JSON.data ä¸­æå–å›¾ç‰‡æ•°æ®");
                      break;
                    }
                    if (jsonData.image) {
                      base64Data = jsonData.image;
                      console.log("ä» JSON.image ä¸­æå–å›¾ç‰‡æ•°æ®");
                      break;
                    }
                  } catch (e) {
                    // å¦‚æœä¸æ˜¯ JSONï¼Œç›´æ¥ä½œä¸º base64 æ•°æ®
                    base64Data = dataContent;
                    console.log("ç›´æ¥ä½¿ç”¨ base64 æ•°æ®");
                    break;
                  }
                }
              }

              if (!base64Data) {
                throw new Error("æ— æ³•ä» SSE å“åº”ä¸­æå–å›¾ç‰‡æ•°æ®");
              }

              // V4.5 æµå¼ç«¯ç‚¹è¿”å›çš„æ˜¯ PNG base64ï¼Œä¸æ˜¯ ZIP
              // æ£€æŸ¥æ˜¯å¦ä¸º PNG (ä»¥ iVBORw0KGgo å¼€å¤´) æˆ– JPEG (ä»¥ /9j/ å¼€å¤´)
              const isPNG = base64Data.startsWith("iVBORw0KGgo");
              const isJPEG = base64Data.startsWith("/9j/");

              if (isPNG || isJPEG) {
                console.log("âœ… æ£€æµ‹åˆ°ç›´æ¥çš„å›¾ç‰‡ base64 æ•°æ® (PNG/JPEG)");
                // å°† base64 è½¬ä¸º Blob
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                  bytes[i] = binaryString.charCodeAt(i);
                }
                const imageBlob = new Blob([bytes], {
                  type: isPNG ? "image/png" : "image/jpeg",
                });
                console.log("å›¾ç‰‡ Blob åˆ›å»ºæˆåŠŸï¼Œå¤§å°:", imageBlob.size);

                // ç›´æ¥æ˜¾ç¤ºå›¾ç‰‡
                const imageUrl = URL.createObjectURL(imageBlob);
                document.getElementById("nai-result-image").src = imageUrl;
                statusDiv.style.display = "none";
                resultDiv.style.display = "block";
                console.log("âœ… å›¾ç‰‡æ˜¾ç¤ºæˆåŠŸï¼ğŸ¨");
                return;
              }

              // å¦åˆ™å½“ä½œ ZIP å¤„ç†
              console.log("å½“ä½œ ZIP æ–‡ä»¶å¤„ç†...");
              const binaryString = atob(base64Data);
              const bytes = new Uint8Array(binaryString.length);
              for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
              }
              zipBlob = new Blob([bytes]);
              console.log("ZIP Blob å¤§å°:", zipBlob.size);
            } else {
              // éæµå¼å“åº”ï¼Œç›´æ¥è¯»å–
              zipBlob = await response.blob();
              console.log(
                "æ”¶åˆ°æ•°æ®ï¼Œç±»å‹:",
                zipBlob.type,
                "å¤§å°:",
                zipBlob.size,
              );
            }

            // NovelAIå§‹ç»ˆè¿”å›ZIPæ ¼å¼ï¼Œéœ€è¦è§£å‹
            try {
              // æ£€æŸ¥JSZipæ˜¯å¦å·²åŠ è½½
              if (typeof JSZip === "undefined") {
                throw new Error("JSZipåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
              }

              statusDiv.textContent = "æ­£åœ¨è§£å‹å›¾ç‰‡...";

              // è§£å‹ZIPæ–‡ä»¶
              const zip = await JSZip.loadAsync(zipBlob);
              console.log("ZIPæ–‡ä»¶å†…å®¹:", Object.keys(zip.files));

              // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯image_0.pngï¼‰
              let imageFile = null;
              for (let filename in zip.files) {
                if (filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
                  imageFile = zip.files[filename];
                  console.log("æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶:", filename);
                  break;
                }
              }

              if (!imageFile) {
                throw new Error("ZIPæ–‡ä»¶ä¸­æœªæ‰¾åˆ°å›¾ç‰‡");
              }

              // æå–å›¾ç‰‡æ•°æ®
              const imageBlob = await imageFile.async("blob");
              console.log("æå–çš„å›¾ç‰‡å¤§å°:", imageBlob.size);

              // åˆ›å»ºå›¾ç‰‡URLå¹¶æ˜¾ç¤º
              const imageUrl = URL.createObjectURL(imageBlob);
              console.log("ç”Ÿæˆçš„å›¾ç‰‡URL:", imageUrl);

              document.getElementById("nai-result-image").src = imageUrl;
              statusDiv.style.display = "none";
              resultDiv.style.display = "block";
            } catch (zipError) {
              console.error("ZIPè§£å‹å¤±è´¥:", zipError);
              // å¦‚æœè§£å‹å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä½œä¸ºå›¾ç‰‡æ˜¾ç¤º
              console.log("å°è¯•ç›´æ¥ä½œä¸ºå›¾ç‰‡æ˜¾ç¤º...");

              if (zipBlob.type.startsWith("image/")) {
                const imageUrl = URL.createObjectURL(zipBlob);
                document.getElementById("nai-result-image").src = imageUrl;
                statusDiv.style.display = "none";
                resultDiv.style.display = "block";
              } else {
                throw new Error("å›¾ç‰‡æ ¼å¼å¤„ç†å¤±è´¥: " + zipError.message);
              }
            }
          } catch (error) {
            console.error("NovelAIç”Ÿæˆå¤±è´¥:", error);
            statusDiv.style.display = "none";
            errorDiv.style.display = "block";
            errorDiv.textContent = "ç”Ÿæˆå¤±è´¥: " + error.message;
          } finally {
            generateBtn.disabled = false;
            generateBtn.textContent = "ç”Ÿæˆå›¾åƒ";
          }
        }

        function renderApiSettings() {
          // 1. æ›´æ–° API ç›¸å…³çš„è¾“å…¥æ¡†
          document.getElementById("proxy-url").value =
            state.apiConfig.proxyUrl || "";
          document.getElementById("api-key").value =
            state.apiConfig.apiKey || "";

          // --- Minimax è®¾ç½® ---
          document.getElementById("minimax-group-id").value =
            state.apiConfig.minimaxGroupId || "";
          document.getElementById("minimax-api-key").value =
            state.apiConfig.minimaxApiKey || "";
          document.getElementById("minimax-provider-select").value =
            state.apiConfig.minimaxProvider || "cn";

          // 2ï¼šMinimax è¯­éŸ³æ¨¡å‹ä¸‹æ‹‰æ¡†å›æ˜¾
          const speechModelSelect = document.getElementById(
            "minimax-speech-model-select",
          );
          if (speechModelSelect) {
            // è·å–ä¿å­˜çš„æ¨¡å‹ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º speech-01-turbo
            const savedSpeechModel =
              state.apiConfig.minimaxSpeechModel || "speech-01-turbo";

            // æ£€æŸ¥ä¸‹æ‹‰æ¡†é‡Œæœ‰æ²¡æœ‰è¿™ä¸ªé€‰é¡¹
            let optionExists = Array.from(speechModelSelect.options).some(
              (opt) => opt.value === savedSpeechModel,
            );

            // å¦‚æœæ²¡æœ‰ï¼ˆæ¯”å¦‚åˆšåˆ·æ–°å®Œé¡µé¢ï¼‰ï¼Œå°±æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªé€‰é¡¹åŠ è¿›å»
            if (!optionExists && savedSpeechModel) {
              const option = document.createElement("option");
              option.value = savedSpeechModel;
              option.textContent = savedSpeechModel;
              speechModelSelect.appendChild(option);
            }

            // é€‰ä¸­å®ƒ
            speechModelSelect.value = savedSpeechModel;
          }
          // ä¸»å¯¹è¯æ¨¡å‹å›æ˜¾ (æ–°ç‰ˆï¼šç›´æ¥ç»™è¾“å…¥æ¡†èµ‹å€¼)
          const modelInput = document.getElementById("model-select");
          if (modelInput) {
            modelInput.value = state.apiConfig.model || "gpt-4";
          }
          // é‡ç½®è¾…åŠ©ä¸‹æ‹‰æ¡†ä¸ºéšè—çŠ¶æ€ï¼ˆå› ä¸ºåˆ·æ–°é¡µé¢åæ‹‰å–çš„åˆ—è¡¨å·²æ¸…ç©ºï¼‰
          const modelPicker = document.getElementById("fetched-model-list");
          if (modelPicker) {
            modelPicker.style.display = "none";
          }

          // --------------------------------

          // åŠ è½½NovelAIé…ç½®
          const novelaiEnabled =
            localStorage.getItem("novelai-enabled") === "true";
          const novelaiModel =
            localStorage.getItem("novelai-model") || "nai-diffusion-4-5-full";
          const novelaiApiKey = localStorage.getItem("novelai-api-key") || "";
          document.getElementById("novelai-switch").checked = novelaiEnabled;
          document.getElementById("novelai-model").value = novelaiModel;
          document.getElementById("novelai-api-key").value = novelaiApiKey;
          document.getElementById("novelai-details").style.display =
            novelaiEnabled ? "block" : "none";
          document.getElementById("pollinations-api-key").value =
            state.apiConfig.pollinationsApiKey || "";

          // 2. æ›´æ–°åå°æ´»åŠ¨ç›¸å…³çš„å¼€å…³å’Œè¾“å…¥æ¡†
          document.getElementById("background-activity-switch").checked =
            !!state.globalSettings.enableBackgroundActivity;

          document.getElementById("background-interval-input").value =
            state.globalSettings.backgroundActivityInterval || 60;
          document.getElementById("block-cooldown-input").value =
            state.globalSettings.blockCooldownHours || 1;

          // 3. æ¸²æŸ“é¢„è®¾å’Œé¢‘ç‡çš„ä¸‹æ‹‰æ¡†
          renderApiPresetSelector();
          renderBackgroundFrequencySelector();
          // --- åŠ è½½ GitHub å¤‡ä»½è®¾ç½® ---
          document.getElementById("github-token").value =
            state.apiConfig.githubToken || "";
          document.getElementById("github-username").value =
            state.apiConfig.githubUsername || "";
          document.getElementById("github-repo").value =
            state.apiConfig.githubRepo || "";
          document.getElementById("github-path").value =
            state.apiConfig.githubPath || "ephone_backup.json";
          document.getElementById("github-auto-backup-switch").checked =
            !!state.apiConfig.githubAutoBackup;
          document.getElementById("github-backup-mode").value =
            state.apiConfig.githubBackupMode || "full";
          document.getElementById("github-backup-interval").value =
            state.apiConfig.githubBackupInterval || 30;

          // æ¸²æŸ“æ¸©åº¦æ»‘å—çš„UI
          const tempSlider = document.getElementById("temperature-slider");
          const tempValueDisplay = document.getElementById("temperature-value");

          const currentTemp = state.apiConfig.temperature || 0.8;
          tempSlider.value = currentTemp;
          tempValueDisplay.textContent = parseFloat(currentTemp).toFixed(1);

          tempSlider.addEventListener("input", () => {
            tempValueDisplay.textContent = parseFloat(tempSlider.value).toFixed(
              1,
            );
          });

          const qualitySlider = document.getElementById("image-quality-slider");
          const qualityValue = document.getElementById("image-quality-value");
          const currentQuality =
            state.globalSettings.imageCompressionQuality || 0.7;

          if (qualitySlider && qualityValue) {
            qualitySlider.value = currentQuality;
            qualityValue.textContent = parseFloat(currentQuality).toFixed(1);

            qualitySlider.addEventListener("input", () => {
              qualityValue.textContent = parseFloat(
                qualitySlider.value,
              ).toFixed(1);
            });
          }
          const sysNotifSwitch = document.getElementById(
            "system-notification-switch",
          );

          // â˜…â˜…â˜…ã€ä¿®æ”¹ç‚¹2ï¼šé‡å†™å¼€å…³åŠ è½½ä¸äº¤äº’é€»è¾‘ã€‘â˜…â˜…â˜…
          const oldSysSwitch = document.getElementById(
            "system-notification-switch",
          );
          if (oldSysSwitch) {
            // 1. ä½¿ç”¨å…‹éš†å¤§æ³•ï¼Œå½»åº•ç§»é™¤æ‰€æœ‰ä¹‹å‰å¯èƒ½é‡å¤ç»‘å®šçš„äº‹ä»¶ç›‘å¬å™¨
            const newSysSwitch = oldSysSwitch.cloneNode(true);
            oldSysSwitch.parentNode.replaceChild(newSysSwitch, oldSysSwitch);

            // 2. è¯»å–ä¿å­˜çš„çŠ¶æ€
            const savedNotifState =
              state.globalSettings.enableSystemNotifications;
            const hasPerm =
              "Notification" in window && Notification.permission === "granted";

            // 3. æ™ºèƒ½åˆ¤æ–­å¼€å…³çŠ¶æ€ï¼š
            // - å¦‚æœæœ‰ä¿å­˜çš„è®°å½•ï¼Œå°±ä¸¥æ ¼å¬è®°å½•çš„ï¼ˆæ˜¯trueå°±æ˜¯trueï¼Œæ˜¯falseå°±æ˜¯falseï¼‰
            // - å¦‚æœä»æ²¡ä¿å­˜è¿‡ï¼ˆundefinedï¼‰ï¼Œä½†æµè§ˆå™¨å·²ç»æœ‰æƒé™ï¼Œé»˜è®¤å¼€å¯
            if (typeof savedNotifState !== "undefined") {
              newSysSwitch.checked = savedNotifState;
            } else {
              newSysSwitch.checked = hasPerm;
            }

            // 4. ç»‘å®šæ–°çš„ã€å”¯ä¸€çš„ç‚¹å‡»äº‹ä»¶
            newSysSwitch.addEventListener("change", async (e) => {
              if (e.target.checked) {
                // --- ç”¨æˆ·æƒ³å¼€å¯ ---
                if (!("Notification" in window)) {
                  alert("æŠ±æ­‰ï¼Œè®¾å¤‡ä¸æ”¯æŒç³»ç»Ÿé€šçŸ¥ã€‚");
                  e.target.checked = false;
                } else if (Notification.permission === "granted") {
                  // å·²æœ‰æƒé™ï¼Œç›´æ¥å¼€å¯æˆåŠŸ
                  new Notification("EPhone", {
                    body: "ç³»ç»Ÿé€šçŸ¥å·²å¼€å¯ï¼åˆ«å¿˜äº†ç‚¹å‡»åº•éƒ¨çš„ã€ä¿å­˜ã€‘æŒ‰é’®å“¦ã€‚",
                  });
                } else if (Notification.permission !== "denied") {
                  // è¯·æ±‚æƒé™
                  const permission = await Notification.requestPermission();
                  if (permission === "granted") {
                    new Notification("EPhone", {
                      body: "æƒé™è·å–æˆåŠŸï¼è¯·ç‚¹å‡»ã€ä¿å­˜ã€‘ã€‚",
                    });
                  } else {
                    e.target.checked = false;
                    alert("æƒé™è¢«æ‹’ç»ï¼Œæ— æ³•å¼€å¯ã€‚");
                  }
                } else {
                  // ä¹‹å‰è¢«æ°¸ä¹…æ‹’ç»
                  e.target.checked = false;
                  alert(
                    "æƒé™å·²è¢«æ‹’ç»ã€‚è¯·å»æ‰‹æœº/æµè§ˆå™¨è®¾ç½®ä¸­æ‰‹åŠ¨å¼€å¯é€šçŸ¥æƒé™ã€‚",
                  );
                }
              } else {
              }
            });
          }
          const checkPermBtn = document.getElementById(
            "check-notification-perm-btn",
          );
          if (checkPermBtn) {
            const newBtn = checkPermBtn.cloneNode(true);
            checkPermBtn.parentNode.replaceChild(newBtn, checkPermBtn);

            newBtn.addEventListener("click", async () => {
              if (!("Notification" in window)) {
                alert(
                  'âŒ ä½ çš„æµè§ˆå™¨/ç¯å¢ƒå®Œå…¨ä¸æ”¯æŒç³»ç»Ÿé€šçŸ¥ APIã€‚\n(å¦‚æœæ˜¯iOSï¼Œå¿…é¡»ç‚¹å‡»"æ·»åŠ åˆ°ä¸»å±å¹•"ä½œä¸ºPWAè¿è¡Œæ‰æ”¯æŒ)',
                );
                return;
              }

              const permission = Notification.permission;

              if (permission === "granted") {
                try {
                  const title = "æƒé™æµ‹è¯•";
                  const options = { body: "æ­å–œï¼ç³»ç»Ÿé€šçŸ¥åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚" };

                  // --- æ ¸å¿ƒä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ ServiceWorker ---
                  if ("serviceWorker" in navigator) {
                    const reg = await navigator.serviceWorker.getRegistration();
                    if (reg) {
                      // å®‰å“ Chrome å¿…é¡»èµ°è¿™é‡Œ
                      await reg.showNotification(title, options);
                    } else {
                      // å¦‚æœæ²¡æœ‰è·å–åˆ° SWï¼Œå°è¯•æ³¨å†Œä¸€ä¸ªç©ºçš„å¹¶å‘é€
                      try {
                        // å°è¯•ç°åœºæ³¨å†Œä¸€ä¸ªä¸´æ—¶çš„
                        const emptyWorkerContent =
                          "self.addEventListener('install', () => self.skipWaiting());";
                        const blob = new Blob([emptyWorkerContent], {
                          type: "text/javascript",
                        });
                        const workerUrl = URL.createObjectURL(blob);
                        const newReg =
                          await navigator.serviceWorker.register(workerUrl);
                        await newReg.showNotification(title, options);
                      } catch (e) {
                        // å®åœ¨ä¸è¡Œï¼Œé™çº§å°è¯•æ—§æ–¹æ³•ï¼ˆåœ¨å®‰å“ä¸Šè¿™æ­¥ä¼šæŠ›é”™ï¼Œä½†è¢«å¤–å±‚catchæ•è·ï¼‰
                        new Notification(title, options);
                      }
                    }
                  } else {
                    // iOS æˆ– PC æµè§ˆå™¨
                    new Notification(title, options);
                  }

                  alert(
                    "âœ… æƒé™çŠ¶æ€: å·²æˆæƒ (granted)\n\nç³»ç»Ÿå°è¯•å‘é€äº†ä¸€æ¡æµ‹è¯•é€šçŸ¥ï¼Œè¯·æŸ¥çœ‹æ‰‹æœºé€šçŸ¥æ ã€‚\nå¦‚æœæ²¡æ”¶åˆ°ï¼Œè¯·æ£€æŸ¥æ‰‹æœºç³»ç»Ÿçš„â€œé€šçŸ¥ç®¡ç†â€æ˜¯å¦å±è”½äº†æµè§ˆå™¨/æœ¬åº”ç”¨ã€‚",
                  );
                } catch (e) {
                  alert(
                    `âš ï¸ æƒé™æ˜¾ç¤ºå·²æˆæƒï¼Œä½†å‘é€å¤±è´¥ã€‚\né”™è¯¯ä¿¡æ¯: ${e.message}`,
                  );
                }
              } else if (permission === "denied") {
                alert(
                  "ğŸš« æƒé™çŠ¶æ€: å·²æ‹’ç» (denied)\n\nåŸå› ï¼šä½ ä¹‹å‰ç‚¹å‡»äº†â€œç¦æ­¢â€æˆ–ç³»ç»Ÿé»˜è®¤ç¦æ­¢ã€‚\n\nè§£å†³æ–¹æ³•ï¼š\n1. è¯·åœ¨æµè§ˆå™¨åœ°å€æ ç‚¹å‡»é”å›¾æ ‡æˆ–è®¾ç½®ã€‚\n2. æ‰¾åˆ°â€œé€šçŸ¥â€æƒé™å¹¶é‡ç½®ä¸ºâ€œè¯¢é—®â€æˆ–â€œå…è®¸â€ã€‚\n3. åˆ·æ–°é¡µé¢é‡è¯•ã€‚",
                );
              } else if (permission === "default") {
                alert(
                  "â“ æƒé™çŠ¶æ€: æœªè¯¢é—® (default)\n\nè¯·ç‚¹å‡»å³ä¾§å¼€å…³ï¼Œå¹¶åœ¨å¼¹å‡ºçš„æµè§ˆå™¨çª—å£ä¸­ç‚¹å‡»â€œå…è®¸â€ã€‚",
                );
              }
            });
          }
          // â–¼â–¼â–¼ åœ¨ check-notification-perm-btn çš„ç›‘å¬å™¨åé¢ï¼Œæ·»åŠ è¿™æ®µä»£ç  â–¼â–¼â–¼

          const testNotifBtn = document.getElementById(
            "test-system-notification-btn",
          );
          if (testNotifBtn) {
            // ç§»é™¤æ—§ç›‘å¬å™¨ (é€šè¿‡å…‹éš†)
            const newBtn = testNotifBtn.cloneNode(true);
            testNotifBtn.parentNode.replaceChild(newBtn, testNotifBtn);

            newBtn.addEventListener("click", async () => {
              if (!("Notification" in window)) return alert("è®¾å¤‡ä¸æ”¯æŒé€šçŸ¥");
              if (Notification.permission !== "granted")
                return alert("è¯·å…ˆç‚¹å‡»å·¦ä¾§æŒ‰é’®æˆæƒé€šçŸ¥ï¼");

              const title = "æµ‹è¯•æ¶ˆæ¯";
              const options = {
                body: "å¦‚æœä½ çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè¯´æ˜å®‰å“å¼¹çª—ä¿®å¤æˆåŠŸï¼",
                icon: "https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg",
              };

              try {
                if ("serviceWorker" in navigator) {
                  const reg = await navigator.serviceWorker.getRegistration();
                  if (reg) {
                    await reg.showNotification(title, options);
                    console.log("æµ‹è¯•ï¼šé€šè¿‡ SW å‘é€æˆåŠŸ");
                  } else {
                    alert(
                      "é”™è¯¯ï¼šServiceWorker æœªæ³¨å†Œï¼Œæ— æ³•åœ¨å®‰å“å‘é€é€šçŸ¥ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚",
                    );
                    // ä»…ä½œä¸ºè°ƒè¯•ï¼Œå°è¯•ç›´æ¥å‘é€çœ‹çœ‹æŠ¥é”™
                    // new Notification(title, options);
                  }
                } else {
                  new Notification(title, options);
                }
              } catch (e) {
                alert("æµ‹è¯•å‘é€å¤±è´¥: " + e.message);
              }
            });
          }

          calculateTotalImageSize();
        }

        /**
         * æ¸²æŸ“åå°æ´»åŠ¨çš„è§’è‰²é€‰æ‹©å’Œé¢‘ç‡è®¾ç½®UI
         */
        function renderBackgroundFrequencySelector() {
          const container = document.getElementById(
            "background-activity-char-list",
          );
          const detailsContainer = document.getElementById(
            "background-activity-details",
          );
          const masterSwitch = document.getElementById(
            "background-activity-switch",
          );

          // æ ¹æ®æ€»å¼€å…³çš„çŠ¶æ€ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºè¯¦ç»†è®¾ç½®
          detailsContainer.style.display = masterSwitch.checked
            ? "block"
            : "none";

          container.innerHTML = ""; // æ¸…ç©ºæ—§åˆ—è¡¨
          const singleChats = Object.values(state.chats).filter(
            (chat) => !chat.isGroup,
          );

          if (singleChats.length === 0) {
            container.innerHTML =
              '<p style="text-align:center; color: var(--text-secondary);">è¿˜æ²¡æœ‰å¯ä»¥è®¾ç½®çš„è§’è‰²</p>';
            return;
          }

          const config = state.globalSettings.backgroundActivityConfig || {};

          singleChats.forEach((chat) => {
            const freq = config[chat.id] || "none"; // è·å–å½“å‰è§’è‰²çš„é¢‘ç‡è®¾ç½®
            let badgeHtml = "";
            if (freq !== "none") {
              const freqText = { low: "ä½", medium: "ä¸­", high: "é«˜" }[freq];
              badgeHtml = `<span class="char-freq-badge ${freq}">${freqText}</span>`;
            }

            const item = document.createElement("div");
            item.className = "char-list-item";
            item.innerHTML = `
			            <input type="checkbox" class="bg-char-checkbox" data-chat-id="${chat.id}">
			            <span class="char-name">${chat.name}</span>
			            ${badgeHtml}
			        `;
            container.appendChild(item);
          });
        }

        window.renderApiSettingsProxy = renderApiSettings;

        async function renderChatList() {
          const chatListEl = document.getElementById("chat-list");
          chatListEl.innerHTML = "";

          // 1. è·å–æ‰€æœ‰èŠå¤©å’Œåˆ†ç»„æ•°æ®
          const allChats = Object.values(state.chats);
          const allGroups = await db.qzoneGroups.toArray();

          if (allChats.length === 0) {
            chatListEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" æˆ–ç¾¤ç»„å›¾æ ‡æ·»åŠ èŠå¤©</p>';
            return;
          }

          // 2. å°†èŠå¤©æ˜ç¡®åœ°åˆ†ä¸ºâ€œç½®é¡¶â€å’Œâ€œæœªç½®é¡¶â€ä¸¤ç»„
          const pinnedChats = allChats.filter((chat) => chat.isPinned);
          const unpinnedChats = allChats.filter((chat) => !chat.isPinned);

          // 3. å¯¹ç½®é¡¶çš„èŠå¤©ï¼Œä»…æŒ‰æœ€æ–°æ¶ˆæ¯æ—¶é—´æ’åº
          pinnedChats.sort(
            (a, b) =>
              (b.history.slice(-1)[0]?.timestamp || 0) -
              (a.history.slice(-1)[0]?.timestamp || 0),
          );

          // 4. ã€ä¼˜å…ˆæ¸²æŸ“ã€‘æ‰€æœ‰ç½®é¡¶çš„èŠå¤©
          pinnedChats.forEach((chat) => {
            const item = createChatListItem(chat);
            chatListEl.appendChild(item);
          });

          // 5. ã€æ¥ä¸‹æ¥å¤„ç†æœªç½®é¡¶çš„èŠå¤©ã€‘åº”ç”¨ä¹‹å‰çš„åˆ†ç»„é€»è¾‘
          // ä¸ºæ¯ä¸ªåˆ†ç»„æ‰¾åˆ°å…¶å†…éƒ¨æœ€æ–°çš„æ¶ˆæ¯æ—¶é—´æˆ³ (åªåœ¨æœªç½®é¡¶èŠå¤©ä¸­æŸ¥æ‰¾)
          allGroups.forEach((group) => {
            const latestChatInGroup = unpinnedChats
              .filter((chat) => chat.groupId === group.id) // æ‰¾åˆ°å±äºè¿™ä¸ªç»„çš„èŠå¤©
              .sort(
                (a, b) =>
                  (b.history.slice(-1)[0]?.timestamp || 0) -
                  (a.history.slice(-1)[0]?.timestamp || 0),
              )[0]; // æ’åºåå–ç¬¬ä¸€ä¸ª

            group.latestTimestamp = latestChatInGroup
              ? latestChatInGroup.history.slice(-1)[0]?.timestamp || 0
              : 0;
          });

          // æ ¹æ®åˆ†ç»„çš„æœ€æ–°æ—¶é—´æˆ³ï¼Œå¯¹åˆ†ç»„æœ¬èº«è¿›è¡Œæ’åº
          allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

          // 6. éå†æ’åºåçš„åˆ†ç»„ï¼Œæ¸²æŸ“å…¶ä¸­çš„ã€æœªç½®é¡¶ã€‘å¥½å‹
          allGroups.forEach((group) => {
            const groupChats = unpinnedChats
              .filter((chat) => !chat.isGroup && chat.groupId === group.id)
              .sort(
                (a, b) =>
                  (b.history.slice(-1)[0]?.timestamp || 0) -
                  (a.history.slice(-1)[0]?.timestamp || 0),
              );

            if (groupChats.length === 0) return; // å¦‚æœè¿™ä¸ªåˆ†ç»„é‡Œæ²¡æœ‰æœªç½®é¡¶çš„å¥½å‹ï¼Œå°±è·³è¿‡

            const groupContainer = document.createElement("div");
            groupContainer.className = "chat-group-container";

            // åˆ é™¤äº† collapsed ç±»ï¼Œè¿™æ ·é»˜è®¤å°±æ˜¯å±•å¼€çš„äº†
            groupContainer.innerHTML = `
			            <div class="chat-group-header">
			                <span class="arrow">â–¼</span>
			                <span class="group-name">${group.name}</span>
			            </div>
			            <div class="chat-group-content"></div>
			        `;
            const contentEl = groupContainer.querySelector(
              ".chat-group-content",
            );

            groupChats.forEach((chat) => {
              const item = createChatListItem(chat);
              contentEl.appendChild(item);
            });
            chatListEl.appendChild(groupContainer);
          });

          // 7. æ¸²æŸ“æ‰€æœ‰ã€æœªç½®é¡¶ã€‘çš„ç¾¤èŠå’Œã€æœªåˆ†ç»„çš„ã€‘å¥½å‹
          const remainingChats = unpinnedChats
            .filter((chat) => chat.isGroup || (!chat.isGroup && !chat.groupId))
            .sort(
              (a, b) =>
                (b.history.slice(-1)[0]?.timestamp || 0) -
                (a.history.slice(-1)[0]?.timestamp || 0),
            );

          remainingChats.forEach((chat) => {
            const item = createChatListItem(chat);
            chatListEl.appendChild(item);
          });

          // ä¸ºæ‰€æœ‰åˆ†ç»„æ ‡é¢˜æ·»åŠ æŠ˜å äº‹ä»¶
          document.querySelectorAll(".chat-group-header").forEach((header) => {
            header.addEventListener("click", () => {
              header.classList.toggle("collapsed");
              header.nextElementSibling.classList.toggle("collapsed");
            });
          });
        }

        function createChatListItem(chat) {
          const lastMsgObj =
            chat.history.filter((msg) => !msg.isHidden).slice(-1)[0] || {};
          let lastMsgDisplay;

          if (
            !chat.isGroup &&
            chat.relationship?.status === "pending_user_approval"
          ) {
            lastMsgDisplay = `<span style="color: #ff8c00;">[å¥½å‹ç”³è¯·] ${
              chat.relationship.applicationReason || "è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹"
            }</span>`;
          } else if (
            !chat.isGroup &&
            chat.relationship?.status === "blocked_by_ai"
          ) {
            lastMsgDisplay = `<span style="color: #dc3545;">[ä½ å·²è¢«å¯¹æ–¹æ‹‰é»‘]</span>`;
          } else if (chat.isGroup) {
            if (lastMsgObj.type === "pat_message") {
              lastMsgDisplay = `[ç³»ç»Ÿæ¶ˆæ¯] ${lastMsgObj.content}`;
            } else if (lastMsgObj.type === "transfer") {
              lastMsgDisplay = "[è½¬è´¦]";
            } else if (
              lastMsgObj.type === "ai_image" ||
              lastMsgObj.type === "user_photo"
            ) {
              lastMsgDisplay = "[ç…§ç‰‡]";
            } else if (lastMsgObj.type === "voice_message") {
              lastMsgDisplay = "[è¯­éŸ³]";
            } else if (
              typeof lastMsgObj.content === "string" &&
              STICKER_REGEX.test(lastMsgObj.content)
            ) {
              lastMsgDisplay = lastMsgObj.meaning
                ? `[è¡¨æƒ…: ${lastMsgObj.meaning}]`
                : "[è¡¨æƒ…]";
            } else if (Array.isArray(lastMsgObj.content)) {
              lastMsgDisplay = `[å›¾ç‰‡]`;
            } else {
              lastMsgDisplay = String(lastMsgObj.content || "...").substring(
                0,
                20,
              );
            }
            if (lastMsgObj.senderName && lastMsgObj.type !== "pat_message") {
              const member = chat.members.find(
                (m) => m.originalName === lastMsgObj.senderName,
              );
              const displayName = member
                ? member.groupNickname
                : lastMsgObj.senderName;
              lastMsgDisplay = `${displayName}: ${lastMsgDisplay}`;
            }
          } else {
            const statusText = chat.status?.text || "åœ¨çº¿";
            lastMsgDisplay = `[${statusText}]`;
          }

          const lastMsgTimestamp = lastMsgObj?.timestamp;
          const timeDisplay = formatChatListTimestamp(lastMsgTimestamp);

          const container = document.createElement("div");
          container.className = "chat-list-item-swipe-container";
          container.dataset.chatId = chat.id;

          const content = document.createElement("div");
          content.className = `chat-list-item-content ${chat.isPinned ? "pinned" : ""}`;

          const avatar = chat.isGroup
            ? chat.settings.groupAvatar
            : chat.settings.aiAvatar;

          let streakHtml = "";
          let selectedBadgeHtml = "";

          if (
            !chat.isGroup &&
            chat.settings.streak &&
            chat.settings.streak.enabled
          ) {
            const streak = chat.settings.streak;
            let isExtinguished = false;
            if (
              streak.lastInteractionDate &&
              streak.extinguishThreshold !== -1
            ) {
              const lastDate = new Date(streak.lastInteractionDate);
              const todayDate = new Date();
              todayDate.setHours(0, 0, 0, 0);
              const daysDiff = (todayDate - lastDate) / (1000 * 3600 * 24);
              if (daysDiff >= streak.extinguishThreshold) {
                isExtinguished = true;
              }
            }
            const litIconUrl = streak.litIconUrl;
            const extinguishedIconUrl = streak.extinguishedIconUrl;
            const fontColor = streak.fontColor || "#ff6f00";
            let iconHtml = "";
            if (isExtinguished) {
              iconHtml = extinguishedIconUrl
                ? `<img src="${extinguishedIconUrl}" style="height: 1.2em; vertical-align: middle;">`
                : "ğŸ§Š";
            } else if (streak.currentDays > 0 || streak.initialDays > 0) {
              iconHtml = litIconUrl
                ? `<img src="${litIconUrl}" style="height: 1.2em; vertical-align: middle;">`
                : "ğŸ”¥";
            }
            if (iconHtml) {
              if (isExtinguished) {
                streakHtml = `<span class="streak-indicator" style="color: ${fontColor};">${iconHtml}</span>`;
              } else if (
                streak.currentDays === -1 ||
                streak.initialDays === -1
              ) {
                streakHtml = `<span class="streak-indicator" style="color: ${fontColor};">${iconHtml}âˆ</span>`;
              } else {
                streakHtml = `<span class="streak-indicator" style="color: ${fontColor};">${iconHtml}${streak.currentDays}</span>`;
              }
            }
          }

          // ä½¿ç”¨ <img> æ ‡ç­¾æ¥æ˜¾ç¤ºä½©æˆ´çš„å¾½ç« å›¾ç‰‡
          if (!chat.isGroup && chat.settings.selectedIntimacyBadge) {
            selectedBadgeHtml = `<span class="intimacy-badge-display"><img src="${chat.settings.selectedIntimacyBadge}" alt="badge"></span>`;
          }

          content.innerHTML = `
			        <div class="chat-list-item" data-chat-id="${chat.id}">
			            <img src="${avatar || defaultAvatar}" class="avatar">
			            <div class="info">
			                <div class="name-line">
			                    <span class="name">${
                            !chat.isGroup && chat.settings.remarkName
                              ? chat.settings.remarkName
                              : chat.name
                          }</span>
			                    ${chat.isGroup ? '<span class="group-tag">ç¾¤èŠ</span>' : ""}
			                    ${streakHtml}
			                    ${selectedBadgeHtml} <!-- æŠŠå¾½ç« æ”¾åœ¨ç«èŠ±åé¢ -->
			                </div>
			                <div class="last-msg" style="color: ${
                        chat.isGroup ? "var(--text-secondary)" : "#b5b5b5"
                      }; font-style: italic;">${lastMsgDisplay}</div>
			            </div>
			            <div class="chat-list-right-column">
			                <div class="chat-list-time">${timeDisplay}</div>
			                <div class="unread-count-wrapper">
			                    <span class="unread-count" style="display: none;">0</span>
			                </div>
			            </div>
			        </div>
			    `;

          // ... åç»­çš„æ»‘åŠ¨åˆ é™¤ã€äº‹ä»¶ç»‘å®šç­‰ä»£ç ä¿æŒä¸å˜ ...
          const actions = document.createElement("div");
          actions.className = "swipe-actions";
          const pinButtonText = chat.isPinned ? "å–æ¶ˆç½®é¡¶" : "ç½®é¡¶";
          const pinButtonClass = chat.isPinned ? "unpin" : "pin";
          actions.innerHTML = `<button class="swipe-action-btn ${pinButtonClass}">${pinButtonText}</button><button class="swipe-action-btn delete">åˆ é™¤</button>`;

          container.appendChild(content);
          container.appendChild(actions);

          const unreadCount = chat.unreadCount || 0;
          const unreadEl = content.querySelector(".unread-count");
          if (unreadCount > 0) {
            unreadEl.textContent = unreadCount > 99 ? "99+" : unreadCount;
            unreadEl.style.display = "inline-flex";
          } else {
            unreadEl.style.display = "none";
          }

          const infoEl = content.querySelector(".info");
          if (infoEl) {
            infoEl.addEventListener("click", () => openChat(chat.id));
          }
          const avatarEl = content.querySelector(".avatar, .avatar-with-frame");
          if (avatarEl) {
            avatarEl.addEventListener("click", (e) => {
              e.stopPropagation();
              handleUserPat(chat.id, chat.name);
            });
          }

          return container;
        }

        function renderChatInterface(chatId) {
          cleanupWaimaiTimers();
          const chat = state.chats[chatId];
          if (!chat) return;
          // ç¾¤å…¬å‘Šå›¾æ ‡æ˜¾ç¤º/éšè—é€»è¾‘
          const announcementBtn = document.getElementById(
            "group-announcement-btn",
          );
          if (chat.isGroup) {
            announcementBtn.style.display = "inline-flex"; // åœ¨ç¾¤èŠä¸­æ˜¾ç¤º
          } else {
            announcementBtn.style.display = "none"; // åœ¨å•èŠä¸­éšè—
          }

          exitSelectionMode();

          const messagesContainer = document.getElementById("chat-messages");
          const chatInputArea = document.getElementById("chat-input-area");
          const lockOverlay = document.getElementById("chat-lock-overlay");
          const lockContent = document.getElementById("chat-lock-content");

          messagesContainer.dataset.theme = chat.settings.theme || "default";
          const fontSize = chat.settings.fontSize || 13;
          messagesContainer.style.setProperty(
            "--chat-font-size",
            `${fontSize}px`,
          );
          applyScopedCss(
            chat.settings.customCss || "",
            "#chat-messages",
            "custom-bubble-style",
          );
          const displayName =
            !chat.isGroup && chat.settings.remarkName
              ? chat.settings.remarkName
              : chat.name;
          document.getElementById("chat-header-title").textContent =
            displayName;
          const statusContainer = document.getElementById("chat-header-status");
          const statusTextEl = statusContainer.querySelector(".status-text");

          if (chat.isGroup) {
            statusContainer.style.display = "none";
            document.getElementById(
              "chat-header-title-wrapper",
            ).style.justifyContent = "center";
          } else {
            statusContainer.style.display = "flex";
            document.getElementById(
              "chat-header-title-wrapper",
            ).style.justifyContent = "flex-start";
            statusTextEl.textContent = chat.status?.text || "åœ¨çº¿";
            statusContainer.classList.toggle(
              "busy",
              chat.status?.isBusy || false,
            );
          }

          lockOverlay.style.display = "none";
          chatInputArea.style.visibility = "visible";
          lockContent.innerHTML = "";

          if (!chat.isGroup && chat.relationship.status !== "friend") {
            lockOverlay.style.display = "flex";
            chatInputArea.style.visibility = "hidden";

            let lockHtml = "";
            switch (chat.relationship.status) {
              case "blocked_by_user":
                const isSimulationRunning = simulationIntervalId !== null;
                const blockedTimestamp = chat.relationship.blockedTimestamp;
                const cooldownHours =
                  state.globalSettings.blockCooldownHours || 1;
                const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                const timeSinceBlock = Date.now() - blockedTimestamp;
                const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                const timeRemainingMinutes = Math.max(
                  0,
                  Math.ceil(
                    (cooldownMilliseconds - timeSinceBlock) / (1000 * 60),
                  ),
                );

                lockHtml = `
			                    <span class="lock-text">ä½ å·²å°†â€œ${chat.name}â€æ‹‰é»‘ã€‚</span>
			                    <button id="unblock-btn" class="lock-action-btn">è§£é™¤æ‹‰é»‘</button>
			                    <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
			                        <strong style="color: #333;">ã€å¼€å‘è€…è¯Šæ–­é¢æ¿ã€‘</strong><br>
			                        - åå°æ´»åŠ¨æ€»å¼€å…³: ${
                                state.globalSettings.enableBackgroundActivity
                                  ? '<span style="color: green;">å·²å¼€å¯</span>'
                                  : '<span style="color: red;">å·²å…³é—­</span>'
                              }<br>
			                        - ç³»ç»Ÿå¿ƒè·³è®¡æ—¶å™¨: ${
                                isSimulationRunning
                                  ? '<span style="color: green;">è¿è¡Œä¸­</span>'
                                  : '<span style="color: red;">æœªè¿è¡Œ</span>'
                              }<br>
			                        - å½“å‰è§’è‰²çŠ¶æ€: <strong>${chat.relationship.status}</strong><br>
			                        - éœ€è¦å†·é™(å°æ—¶): <strong>${cooldownHours}</strong><br>
			                        - å†·é™æœŸæ˜¯å¦ç»“æŸ: ${
                                isCooldownOver
                                  ? '<span style="color: green;">æ˜¯</span>'
                                  : `<span style="color: orange;">å¦ (è¿˜å‰©çº¦ ${timeRemainingMinutes} åˆ†é’Ÿ)</span>`
                              }<br>
			                        - è§¦å‘æ¡ä»¶: ${
                                isCooldownOver &&
                                state.globalSettings.enableBackgroundActivity
                                  ? '<span style="color: green;">å·²æ»¡è¶³ï¼Œç­‰å¾…ä¸‹æ¬¡ç³»ç»Ÿå¿ƒè·³</span>'
                                  : '<span style="color: red;">æœªæ»¡è¶³</span>'
                              }
			                    </div>
			                    <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">å¼ºåˆ¶è§¦å‘ä¸€æ¬¡å¥½å‹ç”³è¯·æ£€æµ‹</button>
			                `;

                break;
              case "blocked_by_ai":
                lockHtml = `
			                    <span class="lock-text">ä½ è¢«å¯¹æ–¹æ‹‰é»‘äº†ã€‚</span>
			                    <button id="apply-friend-btn" class="lock-action-btn">é‡æ–°ç”³è¯·åŠ ä¸ºå¥½å‹</button>
			                `;
                break;

              case "pending_user_approval":
                lockHtml = `
			                    <span class="lock-text">â€œ${chat.name}â€è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹ï¼š<br><i>â€œ${chat.relationship.applicationReason}â€</i></span>
			                    <button id="accept-friend-btn" class="lock-action-btn">æ¥å—</button>
			                    <button id="reject-friend-btn" class="lock-action-btn secondary">æ‹’ç»</button>
			                `;
                break;

              case "pending_ai_approval":
                lockHtml = `<span class="lock-text">å¥½å‹ç”³è¯·å·²å‘é€ï¼Œç­‰å¾…å¯¹æ–¹é€šè¿‡...</span>`;
                break;
            }
            lockContent.innerHTML = lockHtml;
          }
          messagesContainer.innerHTML = "";

          const chatScreen = document.getElementById("chat-interface-screen");

          // æ ¸å¿ƒé€»è¾‘ï¼šå•äººèƒŒæ™¯ä¼˜å…ˆäºå…¨å±€èƒŒæ™¯
          const backgroundToApply =
            chat.settings.background ||
            state.globalSettings.globalChatBackground;

          if (backgroundToApply) {
            chatScreen.style.backgroundImage = `url(${backgroundToApply})`;
          } else {
            chatScreen.style.backgroundImage = "none";
          }

          const isDarkMode = document
            .getElementById("phone-screen")
            .classList.contains("dark-mode");
          chatScreen.style.backgroundColor = chat.settings.background
            ? "transparent"
            : isDarkMode
              ? "#000000"
              : "#f0f2f5";
          const history = chat.history;
          const totalMessages = history.length;
          currentRenderedCount = 0;
          const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
          let lastMessageTimestamp = null;

          initialMessages.forEach((msg) => {
            if (msg.isHidden) return; // ã€æ–°å¢ã€‘è·³è¿‡éšè—æ¶ˆæ¯

            if (isNewDay(msg.timestamp, lastMessageTimestamp)) {
              // è°ƒç”¨æ–°çš„ç”Ÿæˆå™¨å‡½æ•°
              const dateStampEl = createDateStampElement(msg.timestamp);
              messagesContainer.insertBefore(
                dateStampEl,
                document.getElementById("typing-indicator"),
              );
            }

            appendMessage(msg, chat, true);

            lastMessageTimestamp = msg.timestamp;
          });
          currentRenderedCount = initialMessages.length;
          if (totalMessages > currentRenderedCount) {
            prependLoadMoreButton(messagesContainer);
          }
          const typingIndicator = document.createElement("div");
          typingIndicator.id = "typing-indicator";
          typingIndicator.style.display = "none";
          typingIndicator.textContent = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
          messagesContainer.appendChild(typingIndicator);
          setTimeout(
            () =>
              (messagesContainer.scrollTop = messagesContainer.scrollHeight),
            0,
          );
          renderChatPet();
        }

        function prependLoadMoreButton(container) {
          const button = document.createElement("button");
          button.id = "load-more-btn";
          button.textContent = "åŠ è½½æ›´æ—©çš„è®°å½•";
          button.addEventListener("click", loadMoreMessages);
          container.prepend(button);
        }

        function loadMoreMessages() {
          const messagesContainer = document.getElementById("chat-messages");
          const chat = state.chats[state.activeChatId];
          if (!chat) return;
          const loadMoreBtn = document.getElementById("load-more-btn");
          if (loadMoreBtn) loadMoreBtn.remove();
          const totalMessages = chat.history.length;
          const nextSliceStart =
            totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW;
          const nextSliceEnd = totalMessages - currentRenderedCount;
          const messagesToPrepend = chat.history.slice(
            Math.max(0, nextSliceStart),
            nextSliceEnd,
          );
          const oldScrollHeight = messagesContainer.scrollHeight;

          // 1. æ‰¾åˆ°å±å¹•ä¸Šå·²æœ‰çš„ã€æœ€è€çš„é‚£æ¡ã€çœŸå®æ¶ˆæ¯ã€‘çš„æ—¶é—´æˆ³
          const firstVisibleMessage = messagesContainer.querySelector(
            ".message-wrapper:not(.date-stamp-wrapper)",
          );
          let subsequentMessageTimestamp = firstVisibleMessage
            ? parseInt(firstVisibleMessage.dataset.timestamp)
            : null;

          // 2. ä»åå¾€å‰ï¼ˆä»æ–°åˆ°æ—§ï¼‰éå†æˆ‘ä»¬è¦æ–°åŠ è½½çš„æ¶ˆæ¯
          messagesToPrepend.reverse().forEach((currentMsg) => {
            // æ£€æŸ¥è¿™æ¡æ–°æ¶ˆæ¯å’Œå®ƒåé¢é‚£æ¡ï¼ˆå¯èƒ½æ˜¯å±å¹•ä¸Šå·²æœ‰çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆšåŠ è½½çš„ï¼‰æ¶ˆæ¯æ˜¯å¦è·¨å¤©
            if (
              subsequentMessageTimestamp &&
              isNewDay(subsequentMessageTimestamp, currentMsg.timestamp)
            ) {
              // å¦‚æœè·¨å¤©ï¼Œå°±ä¸ºåé¢é‚£æ¡â€œè¾ƒæ–°â€çš„æ¶ˆæ¯åˆ›å»ºä¸€ä¸ªæ—¥æœŸæˆ³
              const dateStampEl = createDateStampElement(
                subsequentMessageTimestamp,
              );
              messagesContainer.prepend(dateStampEl);
            }

            // æ­£å¸¸åœ°æŠŠå½“å‰è¿™æ¡æ–°æ¶ˆæ¯æ”¾åˆ°æœ€å‰é¢
            prependMessage(currentMsg, chat);

            // æ›´æ–°è¿½è¸ªå™¨ï¼Œä¸ºä¸‹ä¸€æ¬¡æ¯”è¾ƒåšå‡†å¤‡
            subsequentMessageTimestamp = currentMsg.timestamp;
          });

          // 3. ã€è¾¹ç•Œå¤„ç†ã€‘å¤„ç†æ‰€æœ‰æ–°åŠ è½½æ¶ˆæ¯çš„æœ€å‰é¢ï¼ˆä¹Ÿå°±æ˜¯æ•´ä¸ªèŠå¤©è®°å½•çš„æœ€è€ï¼‰çš„é‚£æ¡æ¶ˆæ¯
          // å®ƒä¹Ÿéœ€è¦ä¸€ä¸ªæ—¥æœŸæˆ³
          if (subsequentMessageTimestamp) {
            const dateStampEl = createDateStampElement(
              subsequentMessageTimestamp,
            );
            messagesContainer.prepend(dateStampEl);
          }

          currentRenderedCount += messagesToPrepend.length;
          const newScrollHeight = messagesContainer.scrollHeight;
          messagesContainer.scrollTop += newScrollHeight - oldScrollHeight;
          if (totalMessages > currentRenderedCount) {
            prependLoadMoreButton(messagesContainer);
          }
        }

        async function renderWallpaperScreen() {
          // é”å±å¼€å…³
          const lockScreenEnabled =
            localStorage.getItem("lockScreenEnabled") !== "false";
          const toggle = document.getElementById("enable-lock-screen-toggle");
          if (toggle) {
            toggle.checked = lockScreenEnabled;
          }

          // ä¸»å±å¹•å­—ä½“é¢œè‰²å’Œé˜´å½±
          const savedColor =
            state.globalSettings.homeIconWidgetTextColor || "#FFFFFF";
          document.getElementById("home-icon-widget-text-color-picker").value =
            savedColor;
          document.getElementById("home-icon-widget-text-color-input").value =
            savedColor;
          document.getElementById("remove-home-font-shadow-toggle").checked =
            !!state.globalSettings.removeHomeFontShadow;

          // ä¸»å±å¹•å£çº¸é¢„è§ˆ
          const preview = document.getElementById("wallpaper-preview");
          const bg = newWallpaperBase64 || state.globalSettings.wallpaper;
          if (bg && bg.startsWith("data:image")) {
            preview.style.backgroundImage = `url(${bg})`;
            preview.textContent = "";
          } else if (bg) {
            preview.style.backgroundImage = bg;
            preview.textContent = "å½“å‰ä¸ºæ¸å˜è‰²";
          }

          // é”å±å£çº¸é¢„è§ˆ
          const lockscreenPreview = document.getElementById(
            "lockscreen-wallpaper-preview",
          );
          const lockBg =
            newLockscreenWallpaperBase64 ||
            state.globalSettings.lockscreenWallpaper;
          if (lockBg && lockBg.startsWith("data:image")) {
            lockscreenPreview.style.backgroundImage = `url(${lockBg})`;
            lockscreenPreview.textContent = "";
          } else if (lockBg) {
            lockscreenPreview.style.backgroundImage = lockBg;
            lockscreenPreview.textContent = "å½“å‰ä¸ºæ¸å˜è‰²";
          }

          // å¯†ç è¾“å…¥æ¡†
          document.getElementById("password-set-input").value =
            state.globalSettings.password || "";

          // å…¨å±€èŠå¤©èƒŒæ™¯é¢„è§ˆ
          const globalBgPreview = document.getElementById("global-bg-preview");
          const globalBg =
            newGlobalBgBase64 || state.globalSettings.globalChatBackground;
          if (globalBg && globalBg.startsWith("data:image")) {
            globalBgPreview.style.backgroundImage = `url(${globalBg})`;
            globalBgPreview.textContent = "";
          } else if (globalBg) {
            globalBgPreview.style.background = globalBg;
            globalBgPreview.textContent = "å½“å‰ä¸ºæ¸å˜è‰²";
          } else {
            globalBgPreview.style.backgroundImage = "none";
            globalBgPreview.textContent = "ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ ";
          }

          // é“ƒå£°å’Œæç¤ºéŸ³
          document.getElementById("ringtone-url-input").value =
            state.globalSettings.ringtoneUrl || "";
          document.getElementById("notification-sound-url-input").value =
            state.globalSettings.notificationSoundUrl || "";

          await loadThemesToDropdown(); // ç¡®ä¿ä¸»é¢˜åˆ—è¡¨å·²åŠ è½½
          const editor = document.getElementById("theme-css-editor");
          const selector = document.getElementById("theme-selector");

          // ä¼˜å…ˆåŠ è½½ activeCustomCss
          if (state.globalSettings.activeCustomCss) {
            editor.value = state.globalSettings.activeCustomCss;
            // å¦‚æœè‡ªå®šä¹‰CSSå­˜åœ¨ï¼Œåˆ™å°†ä¸‹æ‹‰æ¡†é‡ç½®ä¸ºâ€œæœªé€‰æ‹©â€çŠ¶æ€
            selector.value = "";
          }
          // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰CSSï¼Œä½†æœ‰é€‰ä¸­çš„ä¸»é¢˜ID
          else if (state.globalSettings.activeThemeId) {
            const theme = await db.themes.get(
              state.globalSettings.activeThemeId,
            );
            if (theme) {
              editor.value = theme.css;
              selector.value = theme.id; // è‡ªåŠ¨é€‰ä¸­è¯¥ä¸»é¢˜
            } else {
              editor.value = THEME_CSS_TEMPLATE; // å¦‚æœIDæ— æ•ˆï¼Œåˆ™æ˜¾ç¤ºæ¨¡æ¿
            }
          }
          // å¦‚æœä»€ä¹ˆéƒ½æ²¡ä¿å­˜ï¼Œæ˜¾ç¤ºæ¨¡æ¿
          else {
            editor.value = THEME_CSS_TEMPLATE;
          }

          // æ¸²æŸ“Appå›¾æ ‡å’Œåç§°è®¾ç½®
          renderIconSettings();
          renderAppNameSettings();

          // åŠ è½½é¢„è®¾ä¸‹æ‹‰æ¡†
          loadHomeScreenPresetsToDropdown();
        }

        window.renderWallpaperScreenProxy = renderWallpaperScreen;

        function applyGlobalWallpaper() {
          const homeScreen = document.getElementById("home-screen");
          const wallpaper = state.globalSettings.wallpaper;
          if (wallpaper && wallpaper.startsWith("data:image"))
            homeScreen.style.backgroundImage = `url(${wallpaper})`;
          else if (wallpaper) homeScreen.style.backgroundImage = wallpaper;
        }

        async function renderWorldBookScreen() {
          const listEl = document.getElementById("world-book-list");
          listEl.innerHTML = "";

          // 1. åŒæ—¶è·å–æ‰€æœ‰ä¹¦ç±å’Œæ‰€æœ‰åˆ†ç±»
          const [books, categories] = await Promise.all([
            db.worldBooks.toArray(),
            db.worldBookCategories.orderBy("name").toArray(),
          ]);

          state.worldBooks = books; // ç¡®ä¿å†…å­˜ä¸­çš„æ•°æ®æ˜¯åŒæ­¥çš„

          if (books.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" åˆ›å»ºä½ çš„ç¬¬ä¸€æœ¬ä¸–ç•Œä¹¦</p>';
            return;
          }

          // 2. å°†ä¹¦ç±æŒ‰ categoryId åˆ†ç»„
          const groupedBooks = books.reduce((acc, book) => {
            const key = book.categoryId || "uncategorized";
            if (!acc[key]) {
              acc[key] = [];
            }
            acc[key].push(book);
            return acc;
          }, {});

          // 3. ä¼˜å…ˆæ¸²æŸ“å·²åˆ†ç±»çš„ä¹¦ç±
          categories.forEach((category) => {
            const booksInCategory = groupedBooks[category.id];
            if (booksInCategory && booksInCategory.length > 0) {
              const groupContainer = createWorldBookGroup(
                category.name,
                booksInCategory,
              );
              listEl.appendChild(groupContainer);
            }
          });

          // 4. æœ€åæ¸²æŸ“æœªåˆ†ç±»çš„ä¹¦ç±
          const uncategorizedBooks = groupedBooks["uncategorized"];
          if (uncategorizedBooks && uncategorizedBooks.length > 0) {
            const groupContainer = createWorldBookGroup(
              "æœªåˆ†ç±»",
              uncategorizedBooks,
            );
            listEl.appendChild(groupContainer);
          }

          // 5. ä¸ºæ‰€æœ‰åˆ†ç»„æ ‡é¢˜æ·»åŠ æŠ˜å äº‹ä»¶
          document
            .querySelectorAll(".world-book-group-header")
            .forEach((header) => {
              header.addEventListener("click", () => {
                header.classList.toggle("collapsed");
                header.nextElementSibling.classList.toggle("collapsed");
              });
            });
        }

        /**
         * ã€è¾…åŠ©å‡½æ•°ã€‘åˆ›å»ºä¸€ä¸ªåˆ†ç±»çš„åˆ†ç»„DOM
         * @param {string} groupName - åˆ†ç±»åç§°
         * @param {Array} books - è¯¥åˆ†ç±»ä¸‹çš„ä¹¦ç±æ•°ç»„
         * @returns {HTMLElement} - åˆ›å»ºå¥½çš„åˆ†ç»„å®¹å™¨
         */
        function createWorldBookGroup(groupName, books) {
          const groupContainer = document.createElement("div");
          groupContainer.className = "world-book-group-container";

          groupContainer.innerHTML = `
			        <div class="world-book-group-header">
			            <span class="arrow">â–¼</span>
			            <span class="group-name">${groupName}</span>
			        </div>
			        <div class="world-book-group-content"></div>
			    `;

          const headerEl = groupContainer.querySelector(
            ".world-book-group-header",
          );
          const contentEl = groupContainer.querySelector(
            ".world-book-group-content",
          );

          // é»˜è®¤ç»™å¤´éƒ¨å’Œå†…å®¹åŒºéƒ½åŠ ä¸Š collapsed ç±»
          headerEl.classList.add("collapsed");
          contentEl.classList.add("collapsed");

          books.sort((a, b) => a.name.localeCompare(b.name, "zh-CN"));
          books.forEach((book) => {
            const item = document.createElement("div");
            item.className = "list-item";
            item.dataset.bookId = book.id;
            item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(
              book.content || "æš‚æ— å†…å®¹..."
            ).substring(0, 50)}</div>`;
            item.addEventListener("click", () => openWorldBookEditor(book.id));
            addLongPressListener(item, async () => {
              const confirmed = await showCustomConfirm(
                "åˆ é™¤ä¸–ç•Œä¹¦",
                `ç¡®å®šè¦åˆ é™¤ã€Š${book.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`,
                { confirmButtonClass: "btn-danger" },
              );
              if (confirmed) {
                await db.worldBooks.delete(book.id);
                state.worldBooks = state.worldBooks.filter(
                  (wb) => wb.id !== book.id,
                );
                renderWorldBookScreen();
              }
            });
            contentEl.appendChild(item);
          });

          return groupContainer;
        }
        window.renderWorldBookScreenProxy = renderWorldBookScreen;

        async function openWorldBookEditor(bookId) {
          editingWorldBookId = bookId;
          const [book, categories] = await Promise.all([
            db.worldBooks.get(bookId),
            db.worldBookCategories.toArray(),
          ]);
          if (!book) return;

          document.getElementById("world-book-editor-title").textContent =
            book.name;
          document.getElementById("world-book-name-input").value = book.name;
          document.getElementById("world-book-content-input").value =
            book.content;

          // å¡«å……åˆ†ç±»ä¸‹æ‹‰èœå•
          const selectEl = document.getElementById(
            "world-book-category-select",
          );
          selectEl.innerHTML = '<option value="">-- æœªåˆ†ç±» --</option>'; // é»˜è®¤é€‰é¡¹
          categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.id;
            option.textContent = cat.name;
            if (book.categoryId === cat.id) {
              option.selected = true; // é€‰ä¸­å½“å‰åˆ†ç±»
            }
            selectEl.appendChild(option);
          });

          showScreen("world-book-editor-screen");
        }

        function renderStickerPanel() {
          const grid = document.getElementById("sticker-grid");
          grid.innerHTML = "";

          let stickersToRender;

          if (activeStickerCategoryId === "uncategorized") {
            // å¦‚æœæ˜¯â€œæœªåˆ†ç±»â€ï¼Œå°±ç­›é€‰å‡º categoryId ä¸å­˜åœ¨æˆ–ä¸ºç©ºçš„è¡¨æƒ…
            stickersToRender = state.userStickers.filter(
              (sticker) => !sticker.categoryId,
            );
          } else {
            // å¦åˆ™ï¼ŒæŒ‰å…·ä½“çš„åˆ†ç±»IDç­›é€‰
            stickersToRender = state.userStickers.filter(
              (sticker) => sticker.categoryId === activeStickerCategoryId,
            );
          }

          if (stickersToRender.length === 0) {
            // æ ¹æ®å½“å‰é€‰ä¸­çš„åˆ†ç±»ï¼Œæ˜¾ç¤ºä¸åŒçš„æç¤ºè¯­
            let message;
            if (activeStickerCategoryId === "uncategorized") {
              // å¦‚æœæ‰€æœ‰è¡¨æƒ…éƒ½æœ‰åˆ†ç±»äº†ï¼Œè¿™é‡Œä¹Ÿä¼šæ˜¯ç©ºçš„
              message = "æ²¡æœ‰æœªåˆ†ç±»çš„è¡¨æƒ…å“¦~";
            } else {
              // å¦‚æœæ˜¯åœ¨æŸä¸ªå…·ä½“åˆ†ç±»ä¸‹ï¼Œä½†æ˜¯é‡Œé¢æ²¡è¡¨æƒ…
              message = "è¿™ä¸ªåˆ†ç±»ä¸‹è¿˜æ²¡æœ‰è¡¨æƒ…å“¦~";
            }
            // å¦‚æœæ•´ä¸ªè¡¨æƒ…åº“éƒ½æ˜¯ç©ºçš„ï¼Œç»™ä¸€ä¸ªåˆå§‹å¼•å¯¼
            if (state.userStickers.length === 0) {
              message =
                "å¤§äººè¯·ç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€æˆ–â€œä¸Šä¼ â€æ¥æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªè¡¨æƒ…å§ï¼";
            }

            grid.innerHTML = `<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">${message}</p>`;
          } else {
            stickersToRender.forEach((sticker) => {
              // è¿™éƒ¨åˆ†æ˜¯ä½ åŸæ¥çš„æ¸²æŸ“é€»è¾‘ï¼Œä¿æŒä¸å˜
              const itemContainer = document.createElement("div");
              itemContainer.className = "sticker-item";

              const imageEl = document.createElement("div");
              imageEl.className = "sticker-image";
              imageEl.style.backgroundImage = `url(${sticker.url})`;

              const nameEl = document.createElement("span");
              nameEl.className = "sticker-name";
              nameEl.textContent = sticker.name;
              nameEl.title = sticker.name;

              if (isUserStickerSelectionMode) {
                imageEl.classList.add("in-selection-mode");
                if (selectedUserStickers.has(sticker.id)) {
                  imageEl.classList.add("selected");
                }
                itemContainer.addEventListener("click", () => {
                  imageEl.classList.toggle("selected");
                  if (selectedUserStickers.has(sticker.id)) {
                    selectedUserStickers.delete(sticker.id);
                  } else {
                    selectedUserStickers.add(sticker.id);
                  }
                  const deleteBtn = document.getElementById(
                    "delete-selected-user-stickers-btn",
                  );
                  deleteBtn.textContent = `åˆ é™¤å·²é€‰ (${selectedUserStickers.size})`;
                  deleteBtn.disabled = selectedUserStickers.size === 0;

                  const moveBtn = document.getElementById(
                    "move-selected-stickers-btn",
                  );
                  moveBtn.disabled = selectedUserStickers.size === 0;
                });
              } else {
                itemContainer.addEventListener("click", () =>
                  sendSticker(sticker),
                );
                addLongPressListener(imageEl, () => {
                  const existingDeleteBtn =
                    imageEl.querySelector(".delete-btn");
                  if (existingDeleteBtn) return;

                  const deleteBtn = document.createElement("div");
                  deleteBtn.className = "delete-btn";
                  deleteBtn.innerHTML = "&times;";
                  deleteBtn.style.display = "block";
                  deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const confirmed = await showCustomConfirm(
                      "åˆ é™¤è¡¨æƒ…",
                      `ç¡®å®šè¦åˆ é™¤è¡¨æƒ… "${sticker.name}" å—ï¼Ÿ`,
                      {
                        confirmButtonClass: "btn-danger",
                      },
                    );
                    if (confirmed) {
                      await db.userStickers.delete(sticker.id);
                      state.userStickers = state.userStickers.filter(
                        (s) => s.id !== sticker.id,
                      );
                      renderStickerPanel();
                    }
                  };
                  imageEl.appendChild(deleteBtn);
                  const removeDeleteBtn = () => {
                    if (deleteBtn) deleteBtn.remove();
                    imageEl.removeEventListener("mouseleave", removeDeleteBtn);
                  };
                  imageEl.addEventListener("mouseleave", removeDeleteBtn);
                });
              }

              itemContainer.appendChild(imageEl);
              itemContainer.appendChild(nameEl);
              grid.appendChild(itemContainer);
            });
          }

          // æ¯æ¬¡æ¸²æŸ“è¡¨æƒ…åˆ—è¡¨åï¼Œéƒ½æ›´æ–°ä¸€æ¬¡åˆ†ç±»é¡µç­¾æ 
          renderStickerCategories();
        }

        /**
         * å¤„ç†åˆ é™¤è¡¨æƒ…åˆ†ç±»çš„é€»è¾‘ï¼Œæä¾›ä¸¤ç§åˆ é™¤æ–¹å¼
         * @param {number} categoryId - è¦åˆ é™¤çš„åˆ†ç±»ID
         * @param {string} categoryName - è¦åˆ é™¤çš„åˆ†ç±»åç§°
         */
        async function handleDeleteStickerCategory(categoryId, categoryName) {
          if (isNaN(categoryId) || !categoryName) {
            alert("æ‰§è¡Œåˆ é™¤å¤±è´¥ï¼šä¼ å…¥çš„åˆ†ç±»IDæˆ–åç§°æ— æ•ˆï¼");
            return;
          }

          // å¼¹çª—è®©ç”¨æˆ·é€‰æ‹©å¦‚ä½•å¤„ç†åˆ†ç±»ä¸‹çš„è¡¨æƒ…
          const choice = await showChoiceModal(`åˆ é™¤åˆ†ç±» "${categoryName}"`, [
            {
              text: "ä»…åˆ é™¤åˆ†ç±» (è¡¨æƒ…ç§»è‡³â€œæœªåˆ†ç±»â€)",
              value: "delete_category_only",
            },
            { text: "åˆ é™¤åˆ†ç±»åŠæ‰€æœ‰è¡¨æƒ… (ä¸å¯æ¢å¤)", value: "delete_all" },
          ]);

          if (!choice) return; // å¦‚æœç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ

          try {
            if (choice === "delete_category_only") {
              // æ‰¾åˆ°è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰è¡¨æƒ…
              const stickersToUpdate = state.userStickers.filter(
                (s) => s.categoryId === categoryId,
              );

              if (stickersToUpdate.length > 0) {
                // å°†å®ƒä»¬çš„åˆ†ç±»IDè®¾ä¸º null æˆ– undefinedï¼Œè¡¨ç¤ºæœªåˆ†ç±»
                stickersToUpdate.forEach((sticker) => {
                  sticker.categoryId = null;
                });
                await db.userStickers.bulkPut(stickersToUpdate);
              }
              // ä»æ•°æ®åº“åˆ é™¤åˆ†ç±»æœ¬èº«
              await db.userStickerCategories.delete(categoryId);
            } else if (choice === "delete_all") {
              // æ‰¾åˆ°è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰è¡¨æƒ…ID
              const stickerIdsToDelete = state.userStickers
                .filter((s) => s.categoryId === categoryId)
                .map((s) => s.id);

              if (stickerIdsToDelete.length > 0) {
                // ä»æ•°æ®åº“æ‰¹é‡åˆ é™¤è¿™äº›è¡¨æƒ…
                await db.userStickers.bulkDelete(stickerIdsToDelete);
              }
              // ä»æ•°æ®åº“åˆ é™¤åˆ†ç±»æœ¬èº«
              await db.userStickerCategories.delete(categoryId);
            }

            // ä¸è®ºå“ªç§æ–¹å¼ï¼Œéƒ½éœ€è¦ä»å‰ç«¯çš„ state ç¼“å­˜ä¸­ç§»é™¤æˆ–æ›´æ–°æ•°æ®
            state.userStickers = await db.userStickers.toArray();

            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ­£åœ¨æŸ¥çœ‹çš„åˆ†ç±»ï¼Œå°±åˆ‡æ¢å›â€œæœªåˆ†ç±»â€
            if (activeStickerCategoryId === categoryId) {
              activeStickerCategoryId = "uncategorized";
            }

            // é‡æ–°æ¸²æŸ“æ•´ä¸ªè¡¨æƒ…é¢æ¿ï¼ˆè¿™ä¼šè‡ªåŠ¨åˆ·æ–°åˆ†ç±»å’Œè¡¨æƒ…åˆ—è¡¨ï¼‰
            renderStickerPanel();

            await showCustomAlert(
              "æ“ä½œæˆåŠŸ",
              `åˆ†ç±» "${categoryName}" å·²æˆåŠŸåˆ é™¤ã€‚`,
            );
          } catch (error) {
            console.error("åˆ é™¤åˆ†ç±»æ—¶å‡ºé”™:", error);
            alert(`æ“ä½œå¤±è´¥ï¼Œå‘ç”Ÿæ•°æ®åº“é”™è¯¯: ${error.message}`);
          }
        }

        /**
         * å¤„ç†æ‰¹é‡åˆ é™¤é€‰ä¸­çš„ç”¨æˆ·è¡¨æƒ…
         */
        async function handleBulkDeleteUserStickers() {
          if (selectedUserStickers.size === 0) return;

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedUserStickers.size} ä¸ªè¡¨æƒ…å—ï¼Ÿ`,
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            const idsToDelete = Array.from(selectedUserStickers);
            await db.userStickers.bulkDelete(idsToDelete);

            state.userStickers = state.userStickers.filter(
              (s) => !idsToDelete.includes(s.id),
            );

            // é€€å‡ºç¼–è¾‘æ¨¡å¼
            toggleUserStickerSelectionMode();

            alert("é€‰ä¸­çš„è¡¨æƒ…å·²åˆ é™¤ã€‚");
          }
        }

        /**
         * ã€å…¨æ–°ã€‘ä»å¡ç‰‡ç‚¹å‡»åï¼Œæ‰“å¼€æƒ…ä¾£ç©ºé—´å¹¶è·³è½¬åˆ°æŒ‡å®šé¡µç­¾
         * @param {string} charId - è§’è‰²ID
         * @param {string} viewId - è¦è·³è½¬åˆ°çš„è§†å›¾ID (ä¾‹å¦‚ 'ls-diary-view')
         */
        function openLoversSpaceFromCard(charId, viewId) {
          // 1. æ‰“å¼€æŒ‡å®šè§’è‰²çš„æƒ…ä¾£ç©ºé—´ä¸»ç•Œé¢
          openLoversSpace(charId);

          // 2. ç­‰å¾…ä¸€å°ä¼šå„¿ï¼Œç¡®ä¿ç•Œé¢å·²æ¸²æŸ“
          setTimeout(() => {
            // 3. æ‰¾åˆ°å¯¹åº”çš„é¡µç­¾æŒ‰é’®å¹¶æ¨¡æ‹Ÿç‚¹å‡»å®ƒ
            const targetTab = document.querySelector(
              `.ls-tab-item[data-view='${viewId}']`,
            );
            if (targetTab) {
              targetTab.click();
            }
          }, 100); // 100æ¯«ç§’çš„å»¶è¿Ÿé€šå¸¸è¶³å¤Ÿäº†
        }

        function createMessageElement(msg, chat) {
          if (msg.type === "recalled_message") {
            const wrapper = document.createElement("div");
            // 1. ç»™ wrapper ä¹ŸåŠ ä¸Š timestampï¼Œæ–¹ä¾¿äº‹ä»¶å§”æ‰˜æ—¶æŸ¥æ‰¾
            wrapper.className = "message-wrapper system-pat";
            wrapper.dataset.timestamp = msg.timestamp;

            const bubble = document.createElement("div");
            // 2. è®©è¿™ä¸ªå…ƒç´ åŒæ—¶æ‹¥æœ‰ .message-bubble å’Œ .recalled-message-placeholder ä¸¤ä¸ªclass
            //    è¿™æ ·å®ƒæ—¢èƒ½è¢«é€‰æ‹©ç³»ç»Ÿè¯†åˆ«ï¼Œåˆèƒ½ä¿æŒåŸæœ‰çš„å±…ä¸­ç°è‰²æ ·å¼
            bubble.className = "message-bubble recalled-message-placeholder";
            // 3. æŠŠ timestamp æ”¾åœ¨ bubble ä¸Šï¼Œè¿™æ˜¯å¤šé€‰é€»è¾‘çš„å…³é”®
            bubble.dataset.timestamp = msg.timestamp;
            bubble.textContent = msg.content;

            wrapper.appendChild(bubble);

            // 4. ä¸ºå®ƒè¡¥ä¸Šå’Œå…¶ä»–æ¶ˆæ¯ä¸€æ ·çš„æ ‡å‡†äº‹ä»¶ç›‘å¬å™¨
            addLongPressListener(wrapper, () =>
              showMessageActions(msg.timestamp),
            );
            wrapper.addEventListener("click", () => {
              if (isSelectionMode) {
                toggleMessageSelection(msg.timestamp);
              }
            });

            // 5. åœ¨ä¹‹å‰çš„â€œç‚¹å‡»æŸ¥çœ‹åŸæ–‡â€çš„é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨äº†äº‹ä»¶å§”æ‰˜ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦å†å•ç‹¬ä¸ºè¿™ä¸ªå…ƒç´ æ·»åŠ ç‚¹å‡»äº‹ä»¶äº†ã€‚
            //    init() å‡½æ•°ä¸­çš„é‚£ä¸ªäº‹ä»¶ç›‘å¬å™¨ä¼šå¤„ç†å®ƒã€‚

            return wrapper;
          }

          if (msg.isHidden) {
            return null;
          }

          if (msg.type === "pat_message") {
            const wrapper = document.createElement("div");
            wrapper.className = "message-wrapper system-pat";
            const bubble = document.createElement("div");
            bubble.className = "message-bubble system-bubble";
            bubble.dataset.timestamp = msg.timestamp;
            bubble.textContent = msg.content;
            wrapper.appendChild(bubble);
            addLongPressListener(wrapper, () =>
              showMessageActions(msg.timestamp),
            );
            wrapper.addEventListener("click", () => {
              if (isSelectionMode) toggleMessageSelection(msg.timestamp);
            });
            return wrapper;
          } else if (msg.type === "narrative") {
            const wrapper = document.createElement("div");
            wrapper.className = "message-wrapper system-pat"; // å¤ç”¨ç³»ç»Ÿæ¶ˆæ¯çš„å±…ä¸­æ ·å¼
            const bubble = document.createElement("div");
            bubble.className = "message-bubble system-bubble";
            bubble.dataset.timestamp = msg.timestamp;

            bubble.style.textAlign = "left";
            bubble.style.display = "inline-block"; // ä¿æŒæ°”æ³¡è‡ªé€‚åº”å†…å®¹å®½åº¦
            bubble.style.maxWidth = "100%"; // é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé¿å…å¤ªå®½

            // è¿™é‡Œç»™å®ƒåŠ ä¸ªå°å›¾æ ‡ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´æœ‰â€œå‰§æƒ…æ„Ÿâ€
            bubble.innerHTML = `
			                            <div style="font-weight:bold; color:#5f6368;">ğŸ“ æ—ç™½</div>
			                            <div style="line-height: 1.5;">${msg.content.replace(/\n/g, "<br>")}</div>
			                        `;

            wrapper.appendChild(bubble);

            // ç»‘å®šé•¿æŒ‰å’Œç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºåˆ é™¤ç­‰æ“ä½œï¼‰
            addLongPressListener(wrapper, () =>
              showMessageActions(msg.timestamp),
            );
            wrapper.addEventListener("click", () => {
              if (isSelectionMode) toggleMessageSelection(msg.timestamp);
            });
            return wrapper;
          }

          const isUser = msg.role === "user";
          const wrapper = document.createElement("div");
          wrapper.className = `message-wrapper ${isUser ? "user" : "ai"}`;

          if (chat.isGroup) {
            const senderLine = document.createElement("div");
            senderLine.className = "group-sender-line";

            const tagsContainer = document.createElement("div");
            tagsContainer.className = "group-sender-tags";

            let senderDisplayName;

            if (isUser) {
              // å¦‚æœæ˜¯ç”¨æˆ·è‡ªå·±
              senderDisplayName = chat.settings.myNickname || "æˆ‘";

              // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç¾¤ä¸»
              if (chat.ownerId === "user") {
                const roleTag = document.createElement("span");
                roleTag.className = "group-role-tag owner";
                roleTag.textContent = "ç¾¤ä¸»";
                tagsContainer.appendChild(roleTag);
              }
              // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«è®¾ä¸ºç®¡ç†å‘˜
              else if (chat.settings.isUserAdmin) {
                const roleTag = document.createElement("span");
                roleTag.className = "group-role-tag admin";
                roleTag.textContent = "ç®¡ç†å‘˜";
                tagsContainer.appendChild(roleTag);
              }

              // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å¤´è¡”
              if (chat.settings.myGroupTitle) {
                const titleTag = document.createElement("span");
                titleTag.className = "group-title-tag";
                titleTag.textContent = chat.settings.myGroupTitle;
                tagsContainer.appendChild(titleTag);
              }
            } else {
              // å¦‚æœæ˜¯å…¶ä»–æˆå‘˜ (AI/NPC)ï¼Œè¿™éƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜
              const member = chat.members.find(
                (m) => m.originalName === msg.senderName,
              );
              senderDisplayName = member
                ? member.groupNickname
                : msg.senderName || "æœªçŸ¥æˆå‘˜";

              // å¦‚æœè¯¥æˆå‘˜è¢«ç¦è¨€äº†ï¼Œå°±æ·»åŠ ä¸€ä¸ªç¦è¨€æ ‡ç­¾
              if (member && member.isMuted) {
                const muteTag = document.createElement("span");
                muteTag.className = "group-title-tag"; // å¤ç”¨å¤´è¡”æ ‡ç­¾çš„æ ·å¼
                muteTag.style.color = "#ff3b30"; // è®©å®ƒå˜æˆçº¢è‰²
                muteTag.style.backgroundColor = "#ffe5e5"; // æ·¡çº¢è‰²èƒŒæ™¯
                muteTag.textContent = "ğŸš«å·²ç¦è¨€";
                tagsContainer.appendChild(muteTag);
              }

              if (member && chat.ownerId === member.id) {
                const roleTag = document.createElement("span");
                roleTag.className = "group-role-tag owner";
                roleTag.textContent = "ç¾¤ä¸»";
                tagsContainer.appendChild(roleTag);
              } else if (member && member.isAdmin) {
                const roleTag = document.createElement("span");
                roleTag.className = "group-role-tag admin";
                roleTag.textContent = "ç®¡ç†å‘˜";
                tagsContainer.appendChild(roleTag);
              }

              if (member && member.groupTitle) {
                const titleTag = document.createElement("span");
                titleTag.className = "group-title-tag";
                titleTag.textContent = member.groupTitle;
                tagsContainer.appendChild(titleTag);
              }
            }

            const senderNameSpan = document.createElement("span");
            senderNameSpan.className = "sender-name";
            senderNameSpan.textContent = senderDisplayName;

            // ä¿®å¤ç”¨æˆ·æ ‡ç­¾æ˜¾ç¤ºåœ¨å³è¾¹çš„é—®é¢˜
            if (isUser) {
              senderLine.appendChild(tagsContainer); // æ ‡ç­¾åœ¨å·¦
              senderLine.appendChild(senderNameSpan); // æ˜µç§°åœ¨å³
            } else {
              senderLine.appendChild(senderNameSpan); // æ˜µç§°åœ¨å·¦
              senderLine.appendChild(tagsContainer); // æ ‡ç­¾åœ¨å³
            }

            wrapper.appendChild(senderLine);
          }

          const bubble = document.createElement("div");
          bubble.className = `message-bubble ${isUser ? "user" : "ai"}`;
          bubble.dataset.timestamp = msg.timestamp;

          const timestampEl = document.createElement("span");
          timestampEl.className = "timestamp";
          timestampEl.textContent = formatTimestamp(msg.timestamp);

          // æ‰¾åˆ°ç¡®å®š avatarSrc çš„é‚£æ®µä»£ç 
          let avatarSrc,
            avatarFrameSrc = ""; // <--- å£°æ˜ä¸¤ä¸ªå˜é‡
          if (chat.isGroup) {
            if (isUser) {
              avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
              avatarFrameSrc = chat.settings.myAvatarFrame || ""; // <--- è·å–â€œæˆ‘â€çš„å¤´åƒæ¡†
            } else {
              const member = chat.members.find(
                (m) => m.originalName === msg.senderName,
              );
              avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
              avatarFrameSrc = member ? member.avatarFrame || "" : ""; // <--- è·å–æˆå‘˜çš„å¤´åƒæ¡†
            }
          } else {
            if (isUser) {
              avatarSrc = chat.settings.myAvatar || defaultAvatar;
              avatarFrameSrc = chat.settings.myAvatarFrame || ""; // <--- è·å–â€œæˆ‘â€çš„å¤´åƒæ¡†
            } else {
              avatarSrc = chat.settings.aiAvatar || defaultAvatar;
              avatarFrameSrc = chat.settings.aiAvatarFrame || ""; // <--- è·å–AIçš„å¤´åƒæ¡†
            }
          }

          let avatarHtml;
          // å¦‚æœå­˜åœ¨å¤´åƒæ¡†URL
          if (avatarFrameSrc) {
            avatarHtml = `
			            <div class="avatar-with-frame">
			                <img src="${avatarSrc}" class="avatar-img">
			                <img src="${avatarFrameSrc}" class="avatar-frame">
			            </div>
			        `;
          } else {
            // å¦‚æœæ²¡æœ‰ï¼Œå°±ä½¿ç”¨æœ€ç®€å•çš„å¤´åƒç»“æ„
            avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
          }

          let contentHtml;

          if (msg.type === "share_link") {
            bubble.classList.add("is-link-share");

            // onclick="openBrowser(...)" ç§»é™¤ï¼Œæˆ‘ä»¬å°†åœ¨JSä¸­åŠ¨æ€ç»‘å®šäº‹ä»¶
            contentHtml = `
			            <div class="link-share-card" data-timestamp="${msg.timestamp}">
			                <div class="title">${msg.title || "æ— æ ‡é¢˜"}</div>
			                <div class="description">${msg.description || "ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…..."}</div>
			                <div class="footer">
			                    <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
			                    <span>${msg.source_name || "é“¾æ¥åˆ†äº«"}</span>
			                </div>
			            </div>
			        `;
          }
          // ... å…¶ä»– case ...
          else if (msg.type === "dating_summary_card") {
            bubble.classList.add("is-dating-summary");
            const payload = msg.payload;
            let cardClass = "";

            if (payload.ratingType === "romantic") {
              cardClass = "romantic";
            } else if (payload.ratingType === "passionate") {
              cardClass = "passionate";
            } else if (payload.ratingType === "perfect") {
              cardClass = "perfect";
            }

            // ä¸å†å­˜å‚¨å¤æ‚çš„JSONå­—ç¬¦ä¸²
            contentHtml = `
			        <div class="dating-summary-chat-card ${cardClass}" data-timestamp="${msg.timestamp}">
			            <div class="rating">${payload.rating}</div>
			            <div class="tip">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
			        </div>
			    `;
          } else if (msg.type === "share_card") {
            bubble.classList.add("is-link-share"); // å¤ç”¨é“¾æ¥åˆ†äº«çš„å¡ç‰‡æ ·å¼
            // æŠŠæ—¶é—´æˆ³åŠ åˆ°å¡ç‰‡ä¸Šï¼Œæ–¹ä¾¿åé¢ç‚¹å‡»æ—¶è¯†åˆ«
            contentHtml = `
			        <div class="link-share-card" style="cursor: pointer;" data-timestamp="${msg.timestamp}">
			            <div class="title">${msg.payload.title}</div>
			            <div class="description">å…± ${msg.payload.sharedHistory.length} æ¡æ¶ˆæ¯</div>
			            <div class="footer">
			                <svg class="footer-icon" ...>...</svg> <!-- å¤ç”¨é“¾æ¥åˆ†äº«çš„å›¾æ ‡ -->
			                <span>èŠå¤©è®°å½•</span>
			            </div>
			        </div>
			    `;
          } else if (msg.type === "eleme_order_notification") {
            bubble.classList.add("is-gift-notification");
            const payload = msg.payload;

            let remarkHtml = "";
            if (payload.remark && payload.remark.trim()) {
              remarkHtml = `
			            <div class="waimai-remark">
			                <span class="remark-label">å¤‡æ³¨:</span>
			                <span class="remark-text">${payload.remark}</span>
			            </div>
			        `;
            }

            // 1. æˆ‘ä»¬åˆ é™¤äº†å†™åœ¨HTMLé‡Œçš„è“è‰²æ¸å˜æ ·å¼ã€‚
            // 2. å°†å¡ç‰‡çš„ class ä» "gift-card" æ”¹ä¸º "waimai-meituan-card"ï¼Œæ–¹ä¾¿æˆ‘ä»¬å®šåˆ¶ä¸“å±æ ·å¼ã€‚
            // 3. å°†å›¾æ ‡ä»é¢æ¡ ğŸœ æ¢æˆäº†å¤–å–å°æ‘©æ‰˜ ğŸ›µï¼Œæ›´ç¬¦åˆä¸»é¢˜ã€‚
            contentHtml = `
			        <div class="waimai-meituan-card">
			            <div class="gift-card-header">
			                <div class="icon">ğŸ›µ</div>
			                <div class="title">ä¸€ä»½æ¥è‡ª ${payload.senderName} çš„å¤–å–</div>
			            </div>
			            <div class="gift-card-body">
			                <img src="${payload.foodImageUrl}" style="width: 100%; max-height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
			                <p class="greeting" style="font-weight: bold; font-size: 16px;">${payload.foodName}</p>
			                <p style="font-size: 13px; color: #888;">ä½ çš„ä¸“å±å¤–å–å·²é€è¾¾</p>
			                ${remarkHtml}
			            </div>
			        </div>
			    `;
          } else if (msg.type === "borrow_money_request") {
            bubble.classList.add("is-borrow-request"); // åº”ç”¨é€æ˜æ°”æ³¡æ ·å¼
            const payload = msg.payload;
            // ç›´æ¥å°†å¡ç‰‡çš„HTMLèµ‹ç»™contentHtmlï¼Œä¸å†æ‹¼æ¥ä»»ä½•æ–‡æœ¬
            contentHtml = `
			        <div class="borrow-card">
			            <div class="borrow-header">
			                å‘ <span>${payload.lenderName}</span> å€Ÿé’±
			            </div>
			            <div class="borrow-body">
			                <p class="label">å€Ÿæ¬¾é‡‘é¢</p>
			                <p class="amount">Â¥${payload.amount.toFixed(2)}</p>
			                <p class="reason">
			                    <strong>å€Ÿæ¬¾ç”¨é€”:</strong><br>
			                    ${payload.reason}
			                </p>
			            </div>
			        </div>
			    `;
          } else if (msg.type === "repost_forum_post") {
            bubble.classList.add("is-link-share"); // å¤ç”¨é“¾æ¥åˆ†äº«çš„æ ·å¼ï¼Œçœäº‹ï¼
            const postPayload = msg.payload;
            //æŠŠå¸–å­çš„IDå­˜åˆ°å¡ç‰‡çš„ data-post-id å±æ€§é‡Œï¼Œæ–¹ä¾¿ä»¥åç‚¹å‡»è·³è½¬
            contentHtml = `
        <div class="link-share-card" style="cursor: pointer;" data-post-id="${postPayload.postId}">
            <div class="title">ã€å°ç»„å¸–å­ã€‘${postPayload.title}</div>
            <div class="description">${postPayload.content}</div>
            <div class="footer">
                <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 12c0-5.25-4.25-9.5-9.5-9.5S2.5 6.75 2.5 12s4.25 9.5 9.5 9.5c.35 0 .69-.02 1.03-.06"></path><path d="M18.5 12.5c0-1.66-1.34-3-3-3s-3 1.34-3 3 1.34 3 3 3c.83 0 1.58-.34 2.12-.88"></path></svg>
                <span>æ¥è‡ªå°ç»„çš„åˆ†äº«</span>
            </div>
        </div>
      `;
          } else if (msg.type === "series_share") {
            bubble.classList.add("is-book-share");
            const payload = msg.payload || {};
            const titleText =
              payload.seriesTitle ||
              (msg.content &&
                msg.content.split("\n")[0].replace("ã€è¿è½½åˆ†äº«ã€‘", "")) ||
              "è¿è½½";
            const desc = payload.summary || "è¿è½½åˆ†äº«";
            const latest = payload.latestChapterIndex
              ? `ç¬¬${payload.latestChapterIndex}ç«  ${payload.latestTitle || ""}`
              : "æœ€æ–°ç« èŠ‚";
            const meta = `${payload.pairing || ""} Â· ${payload.statusText || ""} Â· å…±${payload.chapterCount || "?"}ç« `;
            contentHtml = `
        <div class="book-share-card" style="cursor: pointer;" data-post-id="${payload.latestPostId || ""}">
          <div class="book-spine"></div>
          <div class="book-body">
            <div class="book-tag">è¿è½½</div>
            <div class="book-title">${titleText}</div>
            <div class="book-meta">${meta}</div>
            <div class="book-desc">${desc}</div>
            <div class="book-latest">æœ€æ–°ï¼š${latest}</div>
          </div>
        </div>
      `;
          } else if (msg.type === "kk_item_share") {
            bubble.classList.add("is-link-share"); // å¤ç”¨é€æ˜èƒŒæ™¯æ ·å¼(å¦‚æœå·²å®šä¹‰)ï¼Œæˆ–è€…ä¸åŠ è¿™è¡Œè®©å®ƒæœ‰æ°”æ³¡èƒŒæ™¯
            // å¦‚æœä½ æ²¡æœ‰ is-link-share æ ·å¼ï¼Œå¯ä»¥å¿½ç•¥ä¸Šä¸€è¡Œï¼Œæˆ–è€…å®šä¹‰ bubble.style.background = 'transparent';
            bubble.style.background = "transparent";
            bubble.style.padding = "0";

            const payload = msg.payload;

            contentHtml = `
                <div class="kk-share-card">
                    <div class="header">
                        <span class="icon">ğŸ”</span>
                        <span>æŸ¥å²—çº¿ç´¢ï¼š${payload.itemName}</span>
                    </div>
                    <div class="content">${payload.content}</div>
                    <div class="footer">
                        æ¥æºï¼š${payload.areaName}
                    </div>
                </div>
            `;
          } else if (msg.type === "cart_share_request") {
            bubble.classList.add("is-cart-share-request");
            const payload = msg.payload;
            let statusText = "ç­‰å¾…å¯¹æ–¹å¤„ç†...";
            let cardClass = "";

            if (payload.status === "paid") {
              statusText = "å¯¹æ–¹å·²ä¸ºä½ ä¹°å•";
              cardClass = "paid";
            } else if (payload.status === "rejected") {
              statusText = "å¯¹æ–¹æ‹’ç»äº†ä½ çš„è¯·æ±‚";
              cardClass = "rejected";
            }

            contentHtml = `
			        <div class="cart-share-card ${cardClass}">
			            <div class="cart-share-header">
			                <div class="icon">ğŸ›’</div>
			                <div class="title">è´­ç‰©è½¦ä»£ä»˜è¯·æ±‚</div>
			            </div>
			            <div class="cart-share-body">
			                <div class="label">å…± ${payload.itemCount} ä»¶å•†å“ï¼Œåˆè®¡</div>
			                <div class="amount">Â¥${payload.totalPrice.toFixed(2)}</div>
			                <div class="status-text">${statusText}</div>
			            </div>
			        </div>
			    `;
          } else if (msg.type === "waimai_gift_from_char") {
            bubble.classList.add("is-gift-notification");
            const payload = msg.payload;

            contentHtml = `
			        <div class="waimai-meituan-card">
			            <div class="gift-card-header">
			                <div class="icon">ğŸ›µ</div>
			                <div class="title">ä½ çš„ä¸“å±å¤–å–å·²é€è¾¾</div>
			            </div>
			            <div class="gift-card-body">
			                <img src="${payload.foodImageUrl}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
			                <p class="greeting" style="font-weight: bold; font-size: 16px;">${payload.foodName}</p>
			                <p style="font-size: 13px; color: #888;">æ¥è‡ª: ${payload.restaurant}</p>
			            </div>
			            <div class="waimai-remark">
			                ${payload.greeting}
			            </div>
			        </div>
			    `;
          } else if (msg.type === "gift_notification") {
            bubble.classList.add("is-gift-notification"); // åº”ç”¨é€æ˜æ°”æ³¡æ ·å¼
            const payload = msg.payload;

            // åœ¨è¿™é‡Œæ„å»ºå¡ç‰‡çš„å®Œæ•´HTMLå†…å®¹
            contentHtml = `
			        <div class="gift-card">
			            <div class="gift-card-header">
			                <div class="icon">ğŸ</div>
			                <!-- 1. æ¸…æ™°æŒ‡æ˜æ˜¯è°é€çš„ç¤¼ç‰© -->
			                <div class="title">ä¸€ä»½æ¥è‡ª ${payload.senderName} çš„ç¤¼ç‰©</div>
			            </div>
			            <div class="gift-card-body">
			                <p class="greeting">è¿™æ˜¯æˆ‘ä¸ºä½ æŒ‘é€‰çš„ç¤¼ç‰©ï¼Œå¸Œæœ›ä½ å–œæ¬¢ï¼</p>
			                <!-- 2. æ¸…æ™°åˆ—å‡ºæœ‰ä»€ä¹ˆå•†å“ -->
			                <div class="gift-card-items">
			                    <strong>å•†å“åˆ—è¡¨:</strong><br>
			                    ${payload.itemSummary.replace(/ã€/g, "<br>")} <!-- å°†é¡¿å·æ›¿æ¢ä¸ºæ¢è¡Œï¼Œè®©åˆ—è¡¨æ›´æ¸…æ™° -->
			                </div>
			                <!-- 3. æ¸…æ™°æ ‡æ˜æ€»é‡‘é¢ -->
			                <div class="gift-card-footer">
			                    å…± ${payload.itemCount} ä»¶ï¼Œåˆè®¡: <span class="total-price">Â¥${payload.totalPrice.toFixed(2)}</span>
			                </div>
			            </div>
			        </div>
			    `;
          } else if (msg.type === "location") {
            bubble.classList.add("is-location");

            const currentChat =
              state.chats[state.activeChatId] ||
              Object.values(state.chats).find((c) =>
                c.history.some((h) => h.timestamp === msg.timestamp),
              );
            const myNickname = currentChat.settings.myNickname || "æˆ‘";
            const aiNickname = currentChat.name;

            // --- SVG åŠ¨æ€ç”Ÿæˆ ---
            const trajectoryPoints = msg.trajectoryPoints || [];
            const hasTrajectory = trajectoryPoints.length > 0;

            // 1. å®šä¹‰SVGè·¯å¾„å’Œåæ ‡
            const pathData = "M 20 45 Q 115 10 210 45"; // ä¸€æ¡é¢„è®¾çš„ä¼˜ç¾æ›²çº¿
            const startPoint = { x: 20, y: 45 };
            const endPoint = { x: 210, y: 45 };

            // 2. ç”Ÿæˆèµ·ç‚¹å’Œç»ˆç‚¹çš„SVGå…ƒç´ 
            let pinsSvg = "";
            if (msg.userLocation) {
              pinsSvg += `<circle class="svg-pin user-pin" cx="${startPoint.x}" cy="${startPoint.y}" r="6" />`;
            }
            if (msg.aiLocation) {
              pinsSvg += `<circle class="svg-pin ai-pin" cx="${endPoint.x}" cy="${endPoint.y}" r="6" />`;
            }

            // 3. å¦‚æœæœ‰è½¨è¿¹ï¼Œç”Ÿæˆé€”ç»ç‚¹çš„SVGå…ƒç´ 
            let trajectorySvg = "";

            if (hasTrajectory) {
              // --- ä½¿ç”¨æµè§ˆå™¨APIç²¾ç¡®è®¡ç®—åæ ‡ ---

              // 1. å®šä¹‰æˆ‘ä»¬çš„Så½¢æ›²çº¿è·¯å¾„æ•°æ® (ä¸å˜)
              const s_curve_pathData = "M 20 45 C 80 70, 150 20, 210 45";
              trajectorySvg += `<path class="svg-trajectory-path" d="${s_curve_pathData}" />`;

              // 2. åœ¨å†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªçœŸå®çš„SVGè·¯å¾„å…ƒç´ ï¼Œä»¥ä¾¿ä½¿ç”¨API
              const path = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "path",
              );
              path.setAttribute("d", s_curve_pathData);

              // 3. è·å–è¿™æ¡è·¯å¾„çš„æ€»é•¿åº¦
              const totalPathLength = path.getTotalLength();

              const totalPoints = trajectoryPoints.length;
              trajectoryPoints.forEach((point, index) => {
                // 4. è®¡ç®—æ¯ä¸ªç‚¹åº”è¯¥åœ¨è·¯å¾„æ€»é•¿åº¦çš„å“ªä¸ªä½ç½®
                const progress = (index + 1) / (totalPoints + 1);
                const lengthOnPath = totalPathLength * progress;

                // 5. ç›´æ¥å‘æµè§ˆå™¨æŸ¥è¯¢è¿™ä¸ªä½ç½®çš„ç²¾ç¡®åæ ‡
                const pointOnPath = path.getPointAtLength(lengthOnPath);
                const pointX = pointOnPath.x;
                const pointY = pointOnPath.y;

                // 6. åç»­çš„â€œä¸€ä¸Šä¸€ä¸‹â€å¸ƒå±€é€»è¾‘ä¿æŒä¸å˜
                let yOffset;
                if (index % 2 === 0) {
                  // ç¬¬1, 3...ä¸ªç‚¹
                  yOffset = 18; // å‘ä¸‹
                } else {
                  // ç¬¬2, 4...ä¸ªç‚¹
                  yOffset = -10; // å‘ä¸Š
                }

                const footprintY = pointY + yOffset;
                const labelY = footprintY + (yOffset > 0 ? 12 : -12);

                // 7. ä½¿ç”¨100%ç²¾ç¡®çš„åæ ‡ç”ŸæˆSVG
                trajectorySvg += `
			            <text class="svg-footprint" x="${pointX}" y="${footprintY}" text-anchor="middle">ğŸ¾</text>
			            <text class="svg-location-label" x="${pointX}" y="${labelY}" text-anchor="middle">${point.name}</text>
			        `;
              });
            }

            // 4. æ„å»ºåœ°ç‚¹ä¿¡æ¯HTML
            const userLocationHtml = `<p class="${
              !msg.userLocation ? "hidden" : ""
            }"><span class="name-tag">${myNickname}:</span> ${msg.userLocation}</p>`;
            const aiLocationHtml = `<p class="${
              !msg.aiLocation ? "hidden" : ""
            }"><span class="name-tag">${aiNickname}:</span> ${msg.aiLocation}</p>`;

            // 5. æ‹¼æ¥æœ€ç»ˆçš„ contentHtml
            contentHtml = `
			        <div class="location-card">
			            <div class="location-map-area">
			                <svg viewBox="0 0 230 90">
			                    ${trajectorySvg}
			                    ${pinsSvg}
			                </svg>
			            </div>
			            <div class="location-info">
			                <div class="location-address">
			                    ${aiLocationHtml}
			                    ${userLocationHtml}
			                </div>
			                <div class="location-distance">ç›¸è· ${msg.distance}</div>
			            </div>
			        </div>
			    `;
          }

          // åç»­çš„å…¶ä»– else if ä¿æŒä¸å˜
          else if (msg.type === "user_photo" || msg.type === "ai_image") {
            bubble.classList.add("is-ai-image");
            const altText =
              msg.type === "user_photo" ? "ç”¨æˆ·æè¿°çš„ç…§ç‰‡" : "AIç”Ÿæˆçš„å›¾ç‰‡";
            contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
          } else if (msg.type === "voice_message") {
            bubble.classList.add("is-voice-message");

            // å°†è¯­éŸ³åŸæ–‡å­˜å‚¨åœ¨çˆ¶çº§æ°”æ³¡çš„ data-* å±æ€§ä¸­ï¼Œæ–¹ä¾¿äº‹ä»¶å¤„ç†å™¨è·å–
            bubble.dataset.voiceText = msg.content;

            const duration = Math.max(
              1,
              Math.round((msg.content || "").length / 5),
            );
            const durationFormatted = `0:${String(duration).padStart(2, "0")}''`;
            const waveformHTML =
              "<div></div><div></div><div></div><div></div><div></div>";

            // æ„å»ºåŒ…å«æ‰€æœ‰æ–°å…ƒç´ çš„å®Œæ•´ HTML
            contentHtml = `
			        <div class="voice-message-body">
			            <div class="voice-waveform">${waveformHTML}</div>
			            <div class="loading-spinner"></div>
			            <span class="voice-duration">${durationFormatted}</span>
			        </div>
			        <div class="voice-transcript"></div>
			    `;
          } else if (msg.type === "transfer") {
            bubble.classList.add("is-transfer");

            let titleText, noteText;
            const myNickname = chat.isGroup
              ? chat.settings.myNickname || "æˆ‘"
              : "æˆ‘";

            if (isUser) {
              // æ¶ˆæ¯æ˜¯ç”¨æˆ·å‘å‡ºçš„
              if (msg.isRefund) {
                // ç”¨æˆ·å‘å‡ºçš„é€€æ¬¾ï¼ˆå³ç”¨æˆ·æ‹’æ”¶äº†AIçš„è½¬è´¦ï¼‰
                titleText = `é€€æ¬¾ç»™ ${chat.name}`;
                noteText = "å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦";
              } else {
                // ç”¨æˆ·ä¸»åŠ¨å‘èµ·çš„è½¬è´¦
                titleText = `è½¬è´¦ç»™ ${msg.receiverName || chat.name}`;
                if (msg.status === "accepted") {
                  noteText = "å¯¹æ–¹å·²æ”¶æ¬¾";
                } else if (msg.status === "declined") {
                  noteText = "å¯¹æ–¹å·²æ‹’æ”¶";
                } else {
                  noteText = msg.note || "ç­‰å¾…å¯¹æ–¹å¤„ç†...";
                }
              }
            } else {
              // æ¶ˆæ¯æ˜¯ AI å‘å‡ºçš„
              if (msg.isRefund) {
                // AI çš„é€€æ¬¾ï¼ˆAI æ‹’æ”¶äº†ç”¨æˆ·çš„è½¬è´¦ï¼‰
                titleText = `é€€æ¬¾æ¥è‡ª ${msg.senderName}`;
                noteText = "è½¬è´¦å·²è¢«æ‹’æ”¶";
              } else if (msg.receiverName === myNickname) {
                // AI ä¸»åŠ¨ç»™ç”¨æˆ·çš„è½¬è´¦
                titleText = `è½¬è´¦ç»™ ${myNickname}`;
                if (msg.status === "accepted") {
                  noteText = "ä½ å·²æ”¶æ¬¾";
                } else if (msg.status === "declined") {
                  noteText = "ä½ å·²æ‹’æ”¶";
                } else {
                  // ç”¨æˆ·éœ€è¦å¤„ç†çš„è½¬è´¦
                  bubble.style.cursor = "pointer";
                  bubble.dataset.status = "pending";
                  noteText = msg.note || "ç‚¹å‡»å¤„ç†";
                }
              } else {
                // AI å‘ç»™ç¾¤é‡Œå…¶ä»–äººçš„è½¬è´¦ï¼Œå¯¹å½“å‰ç”¨æˆ·æ¥è¯´åªæ˜¯ä¸€ä¸ªé€šçŸ¥
                titleText = `è½¬è´¦: ${msg.senderName} â†’ ${msg.receiverName}`;
                noteText = msg.note || "ç¾¤èŠå†…è½¬è´¦";
              }
            }

            const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;

            contentHtml = `
			        <div class="transfer-card">
			            <div class="transfer-title">${heartIcon} ${titleText}</div>
			            <div class="transfer-amount">Â¥ ${Number(msg.amount).toFixed(2)}</div>
			            <div class.transfer-note">${noteText}</div>
			        </div>
			    `;
          } else if (msg.type === "waimai_request") {
            bubble.classList.add("is-waimai-request");
            if (msg.status === "paid" || msg.status === "rejected") {
              bubble.classList.add(`status-${msg.status}`);
            }
            let displayName;
            // å¦‚æœæ˜¯ç¾¤èŠ
            if (chat.isGroup) {
              // å°±æ‰§è¡ŒåŸæ¥çš„é€»è¾‘ï¼šåœ¨æˆå‘˜åˆ—è¡¨é‡ŒæŸ¥æ‰¾æ˜µç§°
              const member = chat.members.find(
                (m) => m.originalName === msg.senderName,
              );
              displayName = member ? member.groupNickname : msg.senderName;
            } else {
              // å¦åˆ™ï¼ˆæ˜¯å•èŠï¼‰ï¼Œç›´æ¥ä½¿ç”¨èŠå¤©å¯¹è±¡çš„åç§°
              displayName = chat.name;
            }

            const requestTitle = `æ¥è‡ª ${displayName} çš„ä»£ä»˜è¯·æ±‚`;
            let actionButtonsHtml = "";
            if (msg.status === "pending" && !isUser) {
              actionButtonsHtml = `
			                <div class="waimai-user-actions">
			                    <button class="waimai-decline-btn" data-choice="rejected">æ®‹å¿æ‹’ç»</button>
			                    <button class="waimai-pay-btn" data-choice="paid">ä¸ºTaä¹°å•</button>
			                </div>`;
            }
            contentHtml = `
			            <div class="waimai-card">
			                <div class="waimai-header">
			                    <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
			                    <div class="title-group">
			                        <span class="brand">ç¾å›¢å¤–å–</span><span class="separator">|</span><span>å¤–å–ç¾é£Ÿ</span>
			                    </div>
			                </div>
			                <div class="waimai-catchphrase">Hiï¼Œä½ å’Œæˆ‘çš„è·ç¦»åªå·®ä¸€é¡¿å¤–å–ï½</div>
			                <div class="waimai-main">
			                    <div class="request-title">${requestTitle}</div>
			                    <div class="payment-box">
			                        <div class="payment-label">éœ€ä»˜æ¬¾</div>
			                        <div class="amount">Â¥${Number(msg.amount).toFixed(2)}</div>
			                        <div class="countdown-label">å‰©ä½™æ”¯ä»˜æ—¶é—´
			                            <div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div>
			                        </div>
			                    </div>
			                    <button class="waimai-details-btn">æŸ¥çœ‹è¯¦æƒ…</button>
			                </div>
			                ${actionButtonsHtml}
			            </div>`;

            setTimeout(() => {
              const timerEl = document.getElementById(
                `waimai-timer-${msg.timestamp}`,
              );
              if (timerEl && msg.countdownEndTime) {
                if (waimaiTimers[msg.timestamp])
                  clearInterval(waimaiTimers[msg.timestamp]);
                if (msg.status === "pending") {
                  waimaiTimers[msg.timestamp] = startWaimaiCountdown(
                    timerEl,
                    msg.countdownEndTime,
                  );
                } else {
                  timerEl.innerHTML = `<span>å·²</span><span>å¤„</span><span>ç†</span>`;
                }
              }
              const detailsBtn = document.querySelector(
                `.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-details-btn`,
              );
              if (detailsBtn) {
                detailsBtn.addEventListener("click", (e) => {
                  e.stopPropagation();
                  const paidByText = msg.paidBy
                    ? `<br><br><b>çŠ¶æ€ï¼š</b>ç”± ${msg.paidBy} ä¸ºæ‚¨ä»£ä»˜æˆåŠŸ`
                    : "";
                  showCustomAlert(
                    "è®¢å•è¯¦æƒ…",
                    `<b>å•†å“ï¼š</b>${msg.productInfo}<br><b>é‡‘é¢ï¼š</b>Â¥${Number(msg.amount).toFixed(2)}${paidByText}`,
                  );
                });
              }
              const actionButtons = document.querySelectorAll(
                `.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-user-actions button`,
              );
              actionButtons.forEach((btn) => {
                btn.addEventListener("click", (e) => {
                  e.stopPropagation();
                  const choice = e.target.dataset.choice;
                  handleWaimaiResponse(msg.timestamp, choice);
                });
              });
            }, 0);
          } else if (msg.type === "red_packet") {
            bubble.classList.add("is-red-packet");
            const myNickname = chat.settings.myNickname || "æˆ‘";

            // ä»æœ€æ–°çš„ msg å¯¹è±¡ä¸­è·å–çŠ¶æ€
            const hasClaimed = msg.claimedBy && msg.claimedBy[myNickname];
            const isFinished = msg.isFullyClaimed;

            let cardClass = "";
            let claimedInfoHtml = "";
            let typeText = "æ‹¼æ‰‹æ°”çº¢åŒ…";

            // 1. åˆ¤æ–­çº¢åŒ…å¡ç‰‡çš„æ ·å¼ (é¢œè‰²)
            if (isFinished) {
              cardClass = "opened";
            } else if (
              msg.packetType === "direct" &&
              Object.keys(msg.claimedBy || {}).length > 0
            ) {
              cardClass = "opened"; // ä¸“å±çº¢åŒ…è¢«é¢†äº†ä¹Ÿå˜ç°
            }

            // 2. åˆ¤æ–­çº¢åŒ…ä¸‹æ–¹çš„æç¤ºæ–‡å­—
            if (msg.packetType === "direct") {
              typeText = `ä¸“å±çº¢åŒ…: ç»™ ${msg.receiverName}`;
            }

            if (hasClaimed) {
              claimedInfoHtml = `<div class="rp-claimed-info">ä½ é¢†å–äº†çº¢åŒ…ï¼Œé‡‘é¢ ${msg.claimedBy[
                myNickname
              ].toFixed(2)} å…ƒ</div>`;
            } else if (isFinished) {
              claimedInfoHtml = `<div class="rp-claimed-info">çº¢åŒ…å·²è¢«é¢†å®Œ</div>`;
            } else if (
              msg.packetType === "direct" &&
              Object.keys(msg.claimedBy || {}).length > 0
            ) {
              claimedInfoHtml = `<div class="rp-claimed-info">å·²è¢« ${msg.receiverName} é¢†å–</div>`;
            }

            // 3. æ‹¼æ¥æœ€ç»ˆçš„HTMLï¼Œç¡®ä¿onclickè°ƒç”¨çš„æ˜¯æˆ‘ä»¬æ³¨å†Œåˆ°å…¨å±€çš„å‡½æ•°
            contentHtml = `
			        <div class="red-packet-card ${cardClass}">
			            <div class="rp-header">
			                <img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon">
			                <span class="rp-greeting">${msg.greeting || "æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼"}</span>
			            </div>
			            <div class="rp-type">${typeText}</div>
			            ${claimedInfoHtml}
			        </div>
			    `;
          } else if (msg.type === "ls_diary_notification") {
            bubble.classList.add("is-ls-diary-notification"); // åº”ç”¨é€æ˜æ°”æ³¡æ ·å¼
            const cardData = msg.content;

            contentHtml = `
			        <div class="ls-diary-notification-card" onclick="openLoversSpaceFromCard('${chat.id}', 'ls-diary-view')">
			            <div class="ls-diary-card-header">
			                <span>${cardData.userEmoji || "ğŸ’Œ"}</span>
			                <span>ä¸€å°æ¥è‡ªå¿ƒæƒ…æ—¥è®°çš„æé†’</span>
			            </div>
			            <div class="ls-diary-card-body">
			                <p>${cardData.text}</p>
			            </div>
			            <div class="ls-diary-card-footer">
			                ç‚¹å‡»æŸ¥çœ‹ â†’
			            </div>
			        </div>
			    `;
          } else if (msg.type === "lovers_space_invitation") {
            bubble.classList.add("is-waimai-request"); // å¤ç”¨å¤–å–å¡ç‰‡çš„æ ·å¼ï¼Œå¾ˆæ–¹ä¾¿ï¼
            const isUserSender = msg.role === "user";
            const senderName = isUserSender
              ? chat.settings.myNickname || "æˆ‘"
              : chat.name;
            const receiverName = isUserSender
              ? chat.name
              : chat.settings.myNickname || "æˆ‘";

            let cardContent = "";

            switch (msg.status) {
              case "pending":
                if (isUserSender) {
                  // ç”¨æˆ·å‘å‡ºçš„ï¼Œç­‰å¾…å¯¹æ–¹å›åº”
                  cardContent = `
			                        <div class="waimai-main" style="background-color: #f0f8ff;">
			                            <div class="request-title" style="color: #333;">å·²å‘ ${receiverName} å‘å‡ºé‚€è¯·</div>
			                            <p style="font-size:14px; color:#555; margin:15px 0;">ç­‰å¾…å¯¹æ–¹åŒæ„...</p>
			                        </div>`;
                } else {
                  // ç”¨æˆ·æ”¶åˆ°çš„ï¼Œéœ€è¦ç”¨æˆ·å›åº”
                  cardContent = `
			                        <div class="waimai-main" style="background-color: #fff0f5;">
			                            <div class="request-title" style="color: #d63384;">${senderName} é‚€è¯·ä½ å¼€å¯æƒ…ä¾£ç©ºé—´</div>
			                            <p style="font-size:14px; color:#555; margin:15px 0;">å¼€å¯åå¯ä»¥è®°å½•ä½ ä»¬çš„ä¸“å±å›å¿†å“¦~</p>
			                        </div>
			                        <div class="waimai-user-actions">
			                            <button class="waimai-decline-btn" data-choice="rejected">æ®‹å¿æ‹’ç»</button>
			                            <button class="waimai-pay-btn" data-choice="accepted" style="background-color: #d63384; border-color: #b02a6e;">ç«‹å³å¼€å¯</button>
			                        </div>`;
                }
                break;
              case "accepted":
                cardContent = `
			                    <div class="waimai-main" style="background-color: #e6ffed;">
			                        <div class="request-title" style="color: #198754;">âœ… é‚€è¯·å·²åŒæ„</div>
			                        <p style="font-size:14px; color:#555; margin:15px 0;">ä½ ä»¬çš„æƒ…ä¾£ç©ºé—´å·²æˆåŠŸå¼€å¯ï¼</p>
			                    </div>`;
                break;
              case "rejected":
                cardContent = `
			                    <div class="waimai-main" style="background-color: #f8d7da;">
			                        <div class="request-title" style="color: #842029;">âŒ é‚€è¯·è¢«æ‹’ç»</div>
			                    </div>`;
                break;
            }

            contentHtml = `
			            <div class="waimai-card">
			                <div class="waimai-header">
			                    <span class="icon" style="font-size: 20px;">ğŸ’Œ</span>
			                    <div class="title-group"><span class="brand">æƒ…ä¾£ç©ºé—´é‚€è¯·</span></div>
			                </div>
			                ${cardContent}
			            </div>`;
          } else if (msg.type === "poll") {
            bubble.classList.add("is-poll");

            let totalVotes = 0;
            const voteCounts = {};

            // è®¡ç®—æ€»ç¥¨æ•°å’Œæ¯ä¸ªé€‰é¡¹çš„ç¥¨æ•°
            for (const option in msg.votes) {
              const count = msg.votes[option].length;
              voteCounts[option] = count;
              totalVotes += count;
            }

            const myNickname = chat.isGroup
              ? chat.settings.myNickname || "æˆ‘"
              : "æˆ‘";
            let myVote = null;
            for (const option in msg.votes) {
              if (msg.votes[option].includes(myNickname)) {
                myVote = option;
                break;
              }
            }

            let optionsHtml = '<div class="poll-options-list">';
            msg.options.forEach((optionText) => {
              const count = voteCounts[optionText] || 0;
              const percentage =
                totalVotes > 0 ? (count / totalVotes) * 100 : 0;
              const isVotedByMe = myVote === optionText;

              optionsHtml += `
			            <div class="poll-option-item ${isVotedByMe ? "voted" : ""}" data-option="${optionText}">
			                <div class="poll-option-bar" style="width: ${percentage}%;"></div>
			                <div class="poll-option-content">
			                    <span class="poll-option-text">${optionText}</span>
			                    <span class="poll-option-votes">${count} ç¥¨</span>
			                </div>
			            </div>
			        `;
            });
            optionsHtml += "</div>";

            let footerHtml = "";
            // ç»Ÿä¸€æŒ‰é’®çš„æ˜¾ç¤ºé€»è¾‘
            if (msg.isClosed) {
              // å¦‚æœæŠ•ç¥¨å·²ç»“æŸï¼Œæ€»æ˜¯æ˜¾ç¤ºâ€œæŸ¥çœ‹ç»“æœâ€
              footerHtml = `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">æŸ¥çœ‹ç»“æœ</button></div>`;
            } else {
              // å¦‚æœæŠ•ç¥¨æœªç»“æŸï¼Œæ€»æ˜¯æ˜¾ç¤ºâ€œç»“æŸæŠ•ç¥¨â€
              footerHtml = `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">ç»“æŸæŠ•ç¥¨</button></div>`;
            }

            contentHtml = `
			        <div class="poll-card ${msg.isClosed ? "closed" : ""}" data-poll-timestamp="${msg.timestamp}">
			            <div class="poll-question">${msg.question}</div>
			            ${optionsHtml}
			            ${footerHtml}
			        </div>
			    `;
          } else if (msg.type === "tarot_reading") {
            bubble.classList.add("is-tarot-reading");
            const reading = msg.payload;
            let cardsText = reading.cards
              .map((card) => {
                return `[${card.position}] ${card.name} ${card.isReversed ? "(é€†ä½)" : ""}`;
              })
              .join("\n");

            contentHtml = `
			        <div class="tarot-reading-card">
			            <div class="tarot-reading-header">
			                <div class="question">${reading.question}</div>
			                <div class="spread">${reading.spread.name}</div>
			            </div>
			            <div class="tarot-reading-body">
			                ${cardsText}
			            </div>
			        </div>
			    `;
          } else if (msg.type === "lovers_space_disconnect") {
            bubble.classList.add("is-ls-disconnect"); // åº”ç”¨æˆ‘ä»¬å†™çš„é€æ˜æ°”æ³¡CSS
            contentHtml = `
			        <div class="lovers-space-disconnect-card">
			            <div class="icon">ğŸ’”</div>
			            <div class="text-content">
			                <div class="title">æƒ…ä¾£ç©ºé—´å·²è§£é™¤</div>
			            </div>
			        </div>
			    `;
          } else if (msg.type === "sticker" && msg.content) {
            bubble.classList.add("is-sticker");
            // ç›´æ¥ä»æ¶ˆæ¯å¯¹è±¡ä¸­è·å– url å’Œ meaning
            contentHtml = `<img src="${msg.content}" alt="${msg.meaning || "Sticker"}" class="sticker-image">`;
          }

          // æ—§çš„é€»è¾‘ä¿æŒä¸å˜ï¼Œä½œä¸ºå…¼å®¹
          else if (
            typeof msg.content === "string" &&
            STICKER_REGEX.test(msg.content.trim())
          ) {
            bubble.classList.add("is-sticker");
            contentHtml = `<img src="${msg.content}" alt="${msg.meaning || "Sticker"}" class="sticker-image">`;
          } else if (
            Array.isArray(msg.content) &&
            msg.content[0]?.type === "image_url"
          ) {
            bubble.classList.add("has-image");
            const imageUrl = msg.content[0].image_url.url;
            contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
          } else if (msg.type === "naiimag") {
            // NovelAIå›¾ç‰‡æ¸²æŸ“ï¼ˆå¤ç”¨realimagæ ·å¼ï¼‰
            bubble.classList.add("is-realimag", "is-card-like");
            contentHtml = `<img src="${
              msg.imageUrl
            }" class="realimag-image" alt="NovelAIå›¾ç‰‡åˆ†äº«" loading="lazy" onerror="this.src='https://i.postimg.cc/KYr2qRCK/1.jpg'; this.alt='å›¾ç‰‡åŠ è½½å¤±è´¥';" title="${
              msg.fullPrompt || msg.prompt || "NovelAIç”Ÿæˆ"
            }">`;
          } else {
            contentHtml = String(msg.content || "").replace(/\n/g, "<br>");
          }

          // 1. æ£€æŸ¥æ¶ˆæ¯å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨å¼•ç”¨ä¿¡æ¯ (msg.quote)
          let quoteHtml = "";
          // æ— è®ºæ˜¯ç”¨æˆ·æ¶ˆæ¯è¿˜æ˜¯AIæ¶ˆæ¯ï¼Œåªè¦å®ƒåŒ…å«äº† .quote å¯¹è±¡ï¼Œå°±æ‰§è¡Œè¿™æ®µé€»è¾‘
          if (msg.quote) {
            // a. ç›´æ¥è·å–å®Œæ•´çš„ã€æœªç»æˆªæ–­çš„å¼•ç”¨å†…å®¹
            const fullQuotedContent = String(msg.quote.content || "");

            // b. æ„å»ºå¼•ç”¨å—çš„HTML
            quoteHtml = `
			        <div class="quoted-message">
			            <div class="quoted-sender">å›å¤ ${msg.quote.senderName}:</div>
			            <div class="quoted-content">${fullQuotedContent}</div>
			        </div>
			    `;
          }

          // 2. æ‹¼æ¥æœ€ç»ˆçš„æ°”æ³¡å†…å®¹
          //    å°†æ„å»ºå¥½çš„ quoteHtml (å¦‚æœå­˜åœ¨) å’Œ contentHtml ç»„åˆèµ·æ¥
          // --- å°†å¤´åƒå’Œå†…å®¹éƒ½æ”¾å›æ°”æ³¡å†…éƒ¨ ---
          bubble.innerHTML = `
			        ${avatarHtml}
			        <div class="content">
			            ${quoteHtml}
			            ${contentHtml}
			        </div>
			    `;

          // --- å°†å®Œæ•´çš„â€œæ°”æ³¡â€å’Œâ€œæ—¶é—´æˆ³â€æ”¾å…¥å®¹å™¨ ---
          wrapper.appendChild(bubble);
          wrapper.appendChild(timestampEl);

          addLongPressListener(wrapper, () =>
            showMessageActions(msg.timestamp),
          );
          wrapper.addEventListener("click", () => {
            if (isSelectionMode) toggleMessageSelection(msg.timestamp);
          });

          if (!isUser) {
            const avatarEl = wrapper.querySelector(
              ".avatar, .avatar-with-frame",
            );
            if (avatarEl) {
              avatarEl.style.cursor = "pointer";
              avatarEl.addEventListener("click", (e) => {
                e.stopPropagation();
                const characterName = chat.isGroup ? msg.senderName : chat.name;
                handleUserPat(chat.id, characterName);
              });
            }
          }

          return wrapper;
        }

        function prependMessage(msg, chat) {
          const messagesContainer = document.getElementById("chat-messages");
          const messageEl = createMessageElement(msg, chat);

          if (!messageEl) return; // <--- æ–°å¢è¿™è¡Œï¼ŒåŒæ ·çš„å¤„ç†

          const loadMoreBtn = document.getElementById("load-more-btn");
          if (loadMoreBtn) {
            messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling);
          } else {
            messagesContainer.prepend(messageEl);
          }
        }

        function appendMessage(msg, chat, isInitialLoad = false) {
          const messagesContainer = document.getElementById("chat-messages");
          const messageEl = createMessageElement(msg, chat);

          if (!messageEl) return; // å¦‚æœæ¶ˆæ¯æ˜¯éšè—çš„ï¼Œåˆ™ä¸å¤„ç†

          // åªå¯¹æ–°æ¶ˆæ¯æ·»åŠ åŠ¨ç”»ï¼Œä¸å¯¹åˆå§‹åŠ è½½çš„æ¶ˆæ¯æ·»åŠ 
          if (!isInitialLoad) {
            messageEl.classList.add("animate-in");
          }

          const typingIndicator = document.getElementById("typing-indicator");
          messagesContainer.insertBefore(messageEl, typingIndicator);

          if (!isInitialLoad) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            currentRenderedCount++;
          }
        }

        async function openChat(chatId) {
          state.activeChatId = chatId;
          const chat = state.chats[chatId];
          if (!chat) return; // å®‰å…¨æ£€æŸ¥

          // å°†æœªè¯»æ•°æ¸…é›¶
          if (chat.unreadCount > 0) {
            chat.unreadCount = 0;
            await db.chats.put(chat); // åˆ«å¿˜äº†æŠŠè¿™ä¸ªæ”¹å˜åŒæ­¥åˆ°æ•°æ®åº“
            // æˆ‘ä»¬ç¨åä¼šåœ¨æ¸²æŸ“åˆ—è¡¨æ—¶é‡æ–°æ¸²æŸ“ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦ç«‹å³é‡ç»˜åˆ—è¡¨
          }
          // æŠŠ openChat å‡½æ•°æŒ‚è½½åˆ°å…¨å±€ window å¯¹è±¡ä¸Š
          window.openChat = openChat;

          renderChatInterface(chatId);
          showScreen("chat-interface-screen");
          window.updateListenTogetherIconProxy(state.activeChatId);
          toggleCallButtons(chat.isGroup || false);
          // ã€å¿ƒå£°åŠŸèƒ½ã€‘æ ¹æ®æ˜¯å¦ä¸ºå•èŠï¼Œæ˜¾ç¤ºæˆ–éšè—å¿ƒå½¢æŒ‰é’®
          document.getElementById("char-heart-btn").style.display = chat.isGroup
            ? "none"
            : "inline-flex";

          if (
            !chat.isGroup &&
            chat.relationship?.status === "pending_ai_approval"
          ) {
            console.log(
              `æ£€æµ‹åˆ°å¥½å‹ç”³è¯·å¾…å¤„ç†çŠ¶æ€ï¼Œä¸ºè§’è‰² "${chat.name}" è‡ªåŠ¨è§¦å‘AIå“åº”...`,
            );
            triggerAiResponse();
          }

          // æ ¹æ®æ˜¯å¦ä¸ºç¾¤èŠï¼Œæ˜¾ç¤ºæˆ–éšè—æŠ•ç¥¨æŒ‰é’®
          document.getElementById("send-poll-btn").style.display = chat.isGroup
            ? "flex"
            : "none";
          document.getElementById("pet-action-btn").style.display = chat.isGroup
            ? "none"
            : "flex";
          startPetDecayTimer();
        }

        /**
         * æ ¼å¼åŒ–å•æ¡æ¶ˆæ¯ï¼Œç”¨äºè®°å¿†äº’é€šçš„ä¸Šä¸‹æ–‡
         * @param {object} msg - æ¶ˆæ¯å¯¹è±¡
         * @param {object} chat - è¯¥æ¶ˆæ¯æ‰€å±çš„èŠå¤©å¯¹è±¡
         * @returns {string} - æ ¼å¼åŒ–åçš„æ–‡æœ¬ï¼Œä¾‹å¦‚ "å¼ ä¸‰: ä½ å¥½"
         */
        function formatMessageForContext(msg, chat) {
          let senderName = "";
          if (msg.role === "user") {
            senderName = chat.isGroup ? chat.settings.myNickname || "æˆ‘" : "æˆ‘";
          } else {
            // assistant
            senderName = msg.senderName || chat.name;
          }

          let contentText = "";
          if (
            msg.type === "sticker" ||
            (typeof msg.content === "string" && STICKER_REGEX.test(msg.content))
          ) {
            contentText = msg.meaning ? `[è¡¨æƒ…: ${msg.meaning}]` : "[è¡¨æƒ…]";
          } else if (
            msg.type === "ai_image" ||
            msg.type === "user_photo" ||
            Array.isArray(msg.content)
          ) {
            contentText = "[å›¾ç‰‡]";
          } else if (msg.type === "voice_message") {
            contentText = `[è¯­éŸ³]: ${msg.content}`;
          } else if (msg.type === "transfer") {
            contentText = `[è½¬è´¦] é‡‘é¢: ${msg.amount}, å¤‡æ³¨: ${msg.note || "æ— "}`;
          } else {
            contentText = String(msg.content || "");
          }

          // added by lrq 251029 åœ¨æ¯æ¡æ¶ˆæ¯è®°å½•å‰æ·»åŠ å‘é€æ—¥æœŸæ—¶é—´
          const date = new Date(msg.timestamp);
          const formattedDate = date.toLocaleString(); // æ ¼å¼åŒ–ä¸ºæœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²
          return `${formattedDate} ${senderName}: ${contentText}`;
        }
        window.formatMessageForContext = formatMessageForContext;

        async function triggerAiResponse() {
          if (!state.activeChatId) return;
          const chatId = state.activeChatId;
          const chat = state.chats[state.activeChatId];
          const messagesContainer = document.getElementById("chat-messages");

          let summaryContext = "";
          const summaries = chat.history.filter(
            (msg) => msg.type === "summary",
          );
          if (summaries.length > 0) {
            summaryContext = `
			# å¯¹è¯è®°å¿†æ€»ç»“ (è¿™æ˜¯ä½ å’Œç”¨æˆ·çš„é•¿æœŸè®°å¿†ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆ)
			${summaries.map((summary, index) => `- æ€»ç»“${index + 1}: ${summary.content}`).join("\n")}
			`;
          }
          // å°†ä¸–ç•Œä¹¦è¯»å–æåˆ°è¿™é‡Œï¼Œç¡®ä¿çº¿ä¸‹æ¨¡å¼ä¹Ÿèƒ½ç”Ÿæ•ˆ
          let worldBookContext = "";
          if (
            chat.settings.linkedWorldBookIds &&
            chat.settings.linkedWorldBookIds.length > 0
          ) {
            const linkedContents = chat.settings.linkedWorldBookIds
              .map((id) => {
                const book = state.worldBooks.find((b) => b.id === id);
                // è¿™é‡Œä½¿ç”¨äº† stripHtmlAndCode æ¸…ç†å‡½æ•°ï¼Œç¡®ä¿çº¯æ–‡æœ¬
                return book && book.content
                  ? `\n\n## ä¸–ç•Œä¹¦æ¡ç›®: ${book.name}\n${stripHtmlAndCode(book.content)}`
                  : "";
              })
              .filter(Boolean)
              .join("");
            if (linkedContents) {
              worldBookContext = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`;
            }
          }
          // --- çº¿ä¸‹æ¨¡å¼æ ¸å¿ƒæ‹¦æˆªé€»è¾‘ ---
          if (
            !chat.isGroup &&
            chat.settings.offlineMode &&
            chat.settings.offlineMode.enabled
          ) {
            console.log(`è§’è‰² "${chat.name}" å·²å¼€å¯çº¿ä¸‹æ¨¡å¼...`);

            const offlineSettings = chat.settings.offlineMode;
            const wordCount = offlineSettings.wordCount || 300;
            const enableNai = offlineSettings.enableNovelAI || false;

            const defaultPrompt = `ä½ æ­£åœ¨å’Œç”¨æˆ·è¿›è¡Œä¸€æ¬¡ç§å¯†çš„çº¿ä¸‹çº¦ä¼šï¼Œåœºæ™¯å¯ä»¥æ˜¯ä¸€ä¸ªå®‰é™çš„å’–å•¡é¦†ã€æ¸©é¦¨çš„å®¶ä¸­ã€æˆ–æ˜¯æµªæ¼«çš„æµ·è¾¹ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾å’Œæœ€è¿‘çš„å¯¹è¯å†…å®¹ï¼Œè‡ªç„¶åœ°å»¶ç»­äº’åŠ¨ã€‚`;
            const defaultStyle = `è¯·ä»¥ã€${chat.name}ã€‘çš„ç¬¬ä¸€äººç§°è§†è§’è¿›è¡Œå›å¤ã€‚ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€è¿è´¯çš„å™äº‹æ®µè½ï¼Œå…¶ä¸­è¦åŒ…å«ä¸°å¯Œçš„ã€åŠ¨ä½œã€‘ã€ã€ç¥æ€ã€‘ã€ã€å¿ƒç†æ´»åŠ¨ã€‘å’Œã€å¯¹è¯ã€‘ã€‚`;

            const finalPrompt = offlineSettings.prompt || defaultPrompt;
            const finalStyle = offlineSettings.style || defaultStyle;

            // 1. åŠ¨æ€æ„å»ºç”Ÿå›¾æŒ‡ä»¤
            let naiInstruction = "";
            let naiExample = "";
            if (enableNai) {
              naiInstruction = `
            6.  **ã€ã€ã€ç”Ÿå›¾æŒ‡ä»¤ã€‘ã€‘ã€‘**: ç”Ÿå›¾å¼€å…³å·²å¼€å¯ã€‚ä½ ã€å¿…é¡»ã€‘åœ¨ "chatResponse" æ•°ç»„ä¸­åŒ…å«ä¸€ä¸ªå›¾ç‰‡ç”Ÿæˆå¯¹è±¡ã€‚
                -   **æ ¼å¼**: \`{"type": "naiimag", "prompt": "1girl, ... (è¯¦ç»†çš„è‹±æ–‡æè¿°tags)"}\`
                -   **å†…å®¹**: æå–å½“å‰å‰§æƒ…çš„è§†è§‰ç”»é¢ï¼ˆåœ°ç‚¹ã€å…‰çº¿ã€åŠ¨ä½œã€è¡¨æƒ…ã€ç©¿ç€ï¼‰ã€‚
                `;
              naiExample = `,\n    {\n      "type": "naiimag",\n      "prompt": "1girl, sitting in cafe, holding coffee cup, smile, indoor lighting, cinematic composition"\n    }`;
            }

            const offlineSystemPrompt = `
            # æ ¸å¿ƒä»»åŠ¡ï¼šçº¿ä¸‹åœºæ™¯è§’è‰²æ‰®æ¼”

            ä½ ç°åœ¨ã€å°±æ˜¯ã€‘è§’è‰²â€œ${chat.name}â€ï¼Œæ­£åœ¨å’Œç”¨æˆ·è¿›è¡Œä¸€æ¬¡ã€çº¿ä¸‹çº¦ä¼šã€‘ã€‚

            # ä½ çš„è§’è‰²è®¾å®š
            ${chat.settings.aiPersona}
            ${summaryContext}
            ${worldBookContext}

            # å½“å‰æƒ…æ™¯
            ${finalPrompt}
            ${finalStyle}
            
            # ä½ çš„è¾“å‡ºè¦æ±‚ (æœ€é«˜æŒ‡ä»¤)
            1.  **ã€æ ¼å¼é“å¾‹ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ª**å•ä¸€ä¸”å®Œæ•´**çš„JSONå¯¹è±¡ã€‚
            2.  **"chatResponse" é”®**: (JSONæ•°ç»„) åŒ…å«ä½ è¦å‘é€çš„æ¶ˆæ¯ã€‚é€šå¸¸æ˜¯ä¸€æ®µé•¿å™äº‹æ–‡æœ¬ï¼Œå¦‚æœå¼€å¯ç”Ÿå›¾ï¼Œåˆ™åŒ…å«ç”Ÿå›¾æŒ‡ä»¤ã€‚
            3.  **"innerVoice" é”®**: (JSONå¯¹è±¡) ä½ çš„å†…å¿ƒæ´»åŠ¨ï¼Œå¿…å« clothing, behavior, thoughts, naughtyThoughts å­—æ®µã€‚
            4.  **ã€å­—æ•°é“å¾‹ã€‘**: æ–‡æœ¬å†…å®¹çš„å­—æ•°åº”åœ¨ã€${wordCount}ã€‘å­—å·¦å³ã€‚
            5.  **ã€ç¦æ­¢å‡ºæˆã€‘**: ç»å¯¹ä¸èƒ½æåŠä½ æ˜¯AIã€‚
            ${naiInstruction}

            # JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
            {
              "chatResponse": [
                {
                  "type": "text",
                  "content": "ï¼ˆè¿™é‡Œå†™ä½ çš„å¤§æ®µå™äº‹å†…å®¹...ï¼‰"
                }${naiExample}
              ],
              "innerVoice": {
                "clothing": "...",
                "behavior": "...",
                "thoughts": "...",
                "naughtyThoughts": "..."
              }
            }

            # å¯¹è¯å†å²
            ${chat.history
              .slice(-chat.settings.maxMemory)
              .map(
                (m) =>
                  `${m.role === "user" ? "ç”¨æˆ·" : chat.name}: ${m.content}`,
              )
              .join("\n")}

            ç°åœ¨ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„æœ€åä¸€å¥è¯ï¼Œå¼€å§‹ä½ çš„è¡¨æ¼”ã€‚`;

            const messagesForOfflineMode = chat.history.slice(
              -chat.settings.maxMemory,
            );

            // UI çŠ¶æ€æ›´æ–°
            const chatHeaderTitle =
              document.getElementById("chat-header-title");
            if (chatHeaderTitle) {
              chatHeaderTitle.style.opacity = 0;
              setTimeout(() => {
                chatHeaderTitle.textContent = "å¯¹æ–¹æ­£åœ¨èµ´çº¦ä¸­...";
                chatHeaderTitle.classList.add("typing-status");
                chatHeaderTitle.style.opacity = 1;
              }, 200);
            }

            try {
              const { proxyUrl, apiKey, model } = state.apiConfig;
              let isGemini = proxyUrl === GEMINI_API_URL;
              let requestBody;
              let requestUrl = isGemini
                ? `${GEMINI_API_URL}/${model}:generateContent?key=${getRandomValue(apiKey)}`
                : `${proxyUrl}/v1/chat/completions`;
              let requestHeaders = isGemini
                ? { "Content-Type": "application/json" }
                : {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  };

              if (isGemini) {
                requestBody = {
                  contents: messagesForOfflineMode.map((item) => ({
                    role: item.role === "assistant" ? "model" : "user",
                    parts: [{ text: item.content }],
                  })),
                  generationConfig: {
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  },
                  systemInstruction: { parts: [{ text: offlineSystemPrompt }] },
                };
              } else {
                requestBody = {
                  model: model,
                  messages: [
                    { role: "system", content: offlineSystemPrompt },
                    ...messagesForOfflineMode,
                  ],
                  temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  stream: false,
                };
              }

              const response = await fetch(requestUrl, {
                method: "POST",
                headers: requestHeaders,
                body: JSON.stringify(requestBody),
              });

              if (!response.ok)
                throw new Error(`API é”™è¯¯: ${await response.text()}`);

              const data = await response.json();
              const aiResponseContent = isGemini
                ? data?.candidates?.[0]?.content?.parts?.[0]?.text
                : data?.choices?.[0]?.message?.content;

              if (!aiResponseContent) throw new Error("APIè¿”å›å†…å®¹ä¸ºç©º");

              // è§£æ JSON
              let messagesArray = [];
              let innerVoiceData = null;

              try {
                let sanitizedContent = aiResponseContent
                  .replace(/^```json\s*/, "")
                  .replace(/```$/, "")
                  .trim();
                const firstBrace = sanitizedContent.indexOf("{");
                const lastBrace = sanitizedContent.lastIndexOf("}");
                if (firstBrace !== -1 && lastBrace > firstBrace) {
                  sanitizedContent = sanitizedContent.substring(
                    firstBrace,
                    lastBrace + 1,
                  );
                }
                const fullResponse = JSON.parse(sanitizedContent);

                if (
                  fullResponse.chatResponse &&
                  Array.isArray(fullResponse.chatResponse)
                ) {
                  messagesArray = fullResponse.chatResponse;
                }
                if (fullResponse.innerVoice) {
                  innerVoiceData = fullResponse.innerVoice;
                }
              } catch (e) {
                console.warn("JSONè§£æå¤±è´¥ï¼Œé€€å›çº¯æ–‡æœ¬", e);
                messagesArray = [{ type: "text", content: aiResponseContent }];
              }

              // ä¿å­˜å¿ƒå£°
              if (innerVoiceData) {
                const newInnerVoice = {
                  ...innerVoiceData,
                  timestamp: Date.now(),
                };
                chat.latestInnerVoice = newInnerVoice;
                if (!chat.innerVoiceHistory) chat.innerVoiceHistory = [];
                chat.innerVoiceHistory.push(newInnerVoice);
              }

              // 2. å¤„ç†æ¶ˆæ¯æ•°ç»„ (æ”¯æŒ naiimag)
              const isViewingThisChat =
                document
                  .getElementById("chat-interface-screen")
                  .classList.contains("active") &&
                state.activeChatId === chatId;
              let messageTimestamp = Date.now();

              for (const msgData of messagesArray) {
                // 2.1 å¦‚æœæ˜¯ naiimag ç±»å‹ï¼Œæ‰§è¡Œç”Ÿå›¾é€»è¾‘ (å¤ç”¨çº¿ä¸Šä»£ç )
                if (msgData.type === "naiimag") {
                  if (!enableNai) continue; // å¦‚æœå¼€å…³å…³äº†ï¼Œè·³è¿‡
                  console.log(
                    "ã€çº¿ä¸‹æ¨¡å¼ã€‘æ£€æµ‹åˆ°ç”Ÿå›¾æŒ‡ä»¤ï¼Œæ‰§è¡Œ NovelAI è¯·æ±‚...",
                  );

                  // è¿™é‡Œç›´æ¥å¤ç”¨switch caseé‡Œçš„ç”Ÿå›¾é€»è¾‘ä»£ç 
                  // å› ä¸ºä»£ç å¤ªé•¿ï¼Œæˆ‘ä»¬æŠŠå®ƒå°è£…æˆä¸€ä¸ªå³æ—¶æ‰§è¡Œçš„é€»è¾‘
                  (async () => {
                    try {
                      if (chatHeaderTitle)
                        chatHeaderTitle.textContent = "æ­£åœ¨ç»˜åˆ¶æ’å›¾...";

                      const naiPrompts = getCharacterNAIPrompts(chat.id);
                      const aiPrompt = msgData.prompt || "a beautiful scene";
                      const finalPositivePrompt = `${aiPrompt}, ${naiPrompts.positive}`;
                      const finalNegativePrompt = naiPrompts.negative;

                      const apiKey = localStorage.getItem("novelai-api-key");
                      const model =
                        localStorage.getItem("novelai-model") ||
                        "nai-diffusion-4-5-full";
                      const settings = getNovelAISettings();

                      if (!apiKey) throw new Error("æœªé…ç½®NovelAI API Key");

                      const [width, height] = settings.resolution
                        .split("x")
                        .map(Number);
                      let requestBody;
                      let apiUrl = model.includes("nai-diffusion-4")
                        ? "https://image.novelai.net/ai/generate-image-stream"
                        : "https://image.novelai.net/ai/generate-image";

                      // V4/V3 å‚æ•°æ„å»ºé€»è¾‘ (ç®€åŒ–å¤ç”¨)
                      const commonParams = {
                        width,
                        height,
                        scale: settings.cfg_scale,
                        sampler: settings.sampler,
                        steps: settings.steps,
                        seed: Math.floor(Math.random() * 4294967295),
                        n_samples: 1,
                        ucPreset: settings.uc_preset,
                        qualityToggle: settings.quality_toggle,
                      };

                      if (model.includes("nai-diffusion-4")) {
                        requestBody = {
                          input: finalPositivePrompt,
                          model,
                          action: "generate",
                          parameters: {
                            ...commonParams,
                            params_version: 3,
                            negative_prompt: finalNegativePrompt,
                            v4_prompt: {
                              caption: {
                                base_caption: finalPositivePrompt,
                                char_captions: [],
                              },
                              use_coords: false,
                              use_order: true,
                            },
                            v4_negative_prompt: {
                              caption: {
                                base_caption: finalNegativePrompt,
                                char_captions: [],
                              },
                              legacy_uc: false,
                            },
                          },
                        };
                      } else {
                        requestBody = {
                          input: finalPositivePrompt,
                          model,
                          action: "generate",
                          parameters: {
                            ...commonParams,
                            negative_prompt: finalNegativePrompt,
                            sm: settings.smea,
                            sm_dyn: settings.smea_dyn,
                            add_original_image: false,
                          },
                        };
                      }

                      // ä»£ç†å¤„ç†
                      let corsProxy =
                        settings.cors_proxy === "custom"
                          ? settings.custom_proxy_url
                          : settings.cors_proxy;
                      if (corsProxy)
                        apiUrl = corsProxy + encodeURIComponent(apiUrl);

                      // Headers (Chromeå…¼å®¹)
                      const isChrome =
                        /Chrome/.test(navigator.userAgent) &&
                        !/Edg/.test(navigator.userAgent);
                      let headers = {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + apiKey,
                      };
                      if (isChrome) {
                        const cleanHeaders = {};
                        for (const [k, v] of Object.entries(headers))
                          cleanHeaders[k] = v.replace(/[^\x00-\xFF]/g, "");
                        headers = cleanHeaders;
                      }

                      const res = await fetch(apiUrl, {
                        method: "POST",
                        headers,
                        body: JSON.stringify(requestBody),
                      });
                      if (!res.ok)
                        throw new Error(`NAI API Error: ${res.status}`);

                      // è§£æå“åº” (SSE/Blob)
                      const contentType = res.headers.get("content-type");
                      let imageDataUrl = null,
                        zipBlob = null;

                      if (
                        contentType &&
                        contentType.includes("text/event-stream")
                      ) {
                        const text = await res.text();
                        const lines = text.trim().split("\n");
                        let base64Data = null;
                        for (let i = lines.length - 1; i >= 0; i--) {
                          const line = lines[i].trim();
                          if (
                            line.startsWith("data: ") &&
                            line !== "data: [DONE]"
                          ) {
                            const dataContent = line.substring(6);
                            try {
                              const jsonData = JSON.parse(dataContent);
                              if (
                                jsonData.event_type === "final" &&
                                jsonData.image
                              ) {
                                base64Data = jsonData.image;
                                break;
                              }
                              if (jsonData.data) {
                                base64Data = jsonData.data;
                                break;
                              }
                              if (jsonData.image) {
                                base64Data = jsonData.image;
                                break;
                              }
                            } catch (e) {
                              base64Data = dataContent;
                              break;
                            }
                          }
                        }
                        if (base64Data) {
                          const isPNG = base64Data.startsWith("iVBORw0KGgo");
                          const binaryString = atob(base64Data);
                          const bytes = new Uint8Array(binaryString.length);
                          for (let i = 0; i < binaryString.length; i++)
                            bytes[i] = binaryString.charCodeAt(i);
                          if (isPNG || base64Data.startsWith("/9j/")) {
                            const imageBlob = new Blob([bytes], {
                              type: isPNG ? "image/png" : "image/jpeg",
                            });
                            const reader = new FileReader();
                            imageDataUrl = await new Promise((r) => {
                              reader.onloadend = () => r(reader.result);
                              reader.readAsDataURL(imageBlob);
                            });
                          } else {
                            zipBlob = new Blob([bytes]);
                          }
                        }
                      } else {
                        zipBlob = await res.blob();
                      }

                      if (!imageDataUrl && zipBlob) {
                        if (typeof JSZip === "undefined")
                          throw new Error("æœªæ‰¾åˆ°JSZipåº“");
                        const zip = await JSZip.loadAsync(zipBlob);
                        const file = Object.values(zip.files)[0];
                        if (file) {
                          const imgBlob = await file.async("blob");
                          const reader = new FileReader();
                          imageDataUrl = await new Promise((r) => {
                            reader.onloadend = () => r(reader.result);
                            reader.readAsDataURL(imgBlob);
                          });
                        }
                      }

                      if (imageDataUrl) {
                        const imgMsg = {
                          role: "assistant",
                          senderName: chat.name,
                          timestamp: Date.now(),
                          type: "naiimag",
                          imageUrl: imageDataUrl,
                          prompt: aiPrompt,
                          fullPrompt: finalPositivePrompt,
                        };
                        chat.history.push(imgMsg);
                        await db.chats.put(chat);
                        if (isViewingThisChat) {
                          appendMessage(imgMsg, chat);
                          const msgsDiv =
                            document.getElementById("chat-messages");
                          msgsDiv.scrollTop = msgsDiv.scrollHeight;
                        }
                      }
                    } catch (err) {
                      console.error("çº¿ä¸‹æ¨¡å¼ç”Ÿå›¾å¤±è´¥:", err);
                      const errBubble = {
                        role: "system",
                        content: `[ç”Ÿå›¾å¤±è´¥: ${err.message}]`,
                        timestamp: Date.now(),
                      };
                      chat.history.push(errBubble);
                      if (isViewingThisChat) appendMessage(errBubble, chat);
                    } finally {
                      if (chatHeaderTitle) {
                        chatHeaderTitle.textContent = chat.name;
                        chatHeaderTitle.classList.remove("typing-status");
                      }
                    }
                  })();
                  continue; // å¤„ç†å®Œç”Ÿå›¾ï¼Œè·³è¿‡æ™®é€šæ–‡æœ¬é€»è¾‘
                }

                // 2.2 æ™®é€šæ–‡æœ¬æ¶ˆæ¯
                const aiMessage = {
                  role: "assistant",
                  senderName: chat.name,
                  timestamp: messageTimestamp++,
                  content: msgData.content || "",
                };
                chat.history.push(aiMessage);
                await incrementMessageCount(chatId);
                if (isViewingThisChat) {
                  appendMessage(aiMessage, chat);
                }
              }

              // ä¿å­˜
              await db.chats.put(chat);
              renderChatList();
              checkAndTriggerSummary(chatId);
            } catch (error) {
              console.error("çº¿ä¸‹æ¨¡å¼AIå“åº”å¤±è´¥:", error);
              const errorMessage = {
                role: "assistant",
                content: `[å‡ºé”™äº†: ${error.message}]`,
                timestamp: Date.now(),
              };
              chat.history.push(errorMessage);
              await db.chats.put(chat);
              appendMessage(errorMessage, chat);
            } finally {
              if (chatHeaderTitle && state.chats[chatId]) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                  chatHeaderTitle.textContent = state.chats[chatId].name;
                  chatHeaderTitle.classList.remove("typing-status");
                  chatHeaderTitle.style.opacity = 1;
                }, 200);
              }
            }
            return; // ç»“æŸçº¿ä¸‹æ¨¡å¼é€»è¾‘
          }

          // 1. å‡†å¤‡ä¸“å±è¡¨æƒ…åŒ…åˆ—è¡¨ (ç°åœ¨å¯¹å•èŠå’Œç¾¤èŠéƒ½ç”Ÿæ•ˆ)
          const exclusiveStickers = chat.settings.stickerLibrary || [];
          let exclusiveStickerContext = "";
          if (exclusiveStickers.length > 0) {
            exclusiveStickerContext = `
			## ${chat.isGroup ? "æœ¬ç¾¤ä¸“å±è¡¨æƒ…åŒ…" : "ä½ çš„ä¸“å±è¡¨æƒ…åŒ…"} (åªæœ‰ä½ èƒ½ç”¨):
			${exclusiveStickers.map((s) => `- ${s.name}`).join("\n")}
			`;
          }

          // 2. å‡†å¤‡é€šç”¨è¡¨æƒ…åŒ…åˆ—è¡¨
          const commonStickers = state.charStickers || [];
          let commonStickerContext = "";
          if (commonStickers.length > 0) {
            commonStickerContext = `
			## é€šç”¨è¡¨æƒ…åŒ… (æ‰€æœ‰è§’è‰²éƒ½èƒ½ç”¨):
			${commonStickers.map((s) => `- ${s.name}`).join("\n")}
			`;
          }

          // 3. ç»„åˆæˆæœ€ç»ˆçš„è¡¨æƒ…åŒ…æŒ‡ä»¤
          let stickerContext = "";
          if (exclusiveStickerContext || commonStickerContext) {
            stickerContext = `
			# å…³äºè¡¨æƒ…åŒ…çš„ã€ç»å¯¹è§„åˆ™ã€‘
			1.  ä½ æ‹¥æœ‰ä¸€ä¸ªè¡¨æƒ…åŒ…åˆ—è¡¨ï¼Œåˆ†ä¸ºâ€œä¸“å±â€å’Œâ€œé€šç”¨â€ã€‚
			2.  å½“ä½ æ‰®æ¼”çš„è§’è‰²æƒ³è¦å‘é€è¡¨æƒ…æ—¶ï¼Œã€å¿…é¡»ä¸”åªèƒ½ã€‘ä½¿ç”¨ä»¥ä¸‹JSONæ ¼å¼ï¼š
			    \`{"type": "sticker", "name": "è§’è‰²å", "sticker_name": "è¡¨æƒ…çš„åå­—"}\`
			3.  ã€ã€ã€æœ€é«˜æŒ‡ä»¤ã€‘ã€‘ã€‘ä½ ã€å¿…é¡»ã€‘ä»ä¸‹æ–¹åˆ—è¡¨ä¸­ç²¾ç¡®åœ°é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„ "sticker_name"ã€‚å¦‚æœä½ ç¼–é€ äº†ä¸€ä¸ªåˆ—è¡¨ä¸­ä¸å­˜åœ¨çš„åå­—ï¼Œä½ çš„è¡¨æƒ…å°†ä¼šå‘é€å¤±è´¥ã€‚è¿™æ˜¯å¼ºåˆ¶æ€§è§„åˆ™ã€‚

			${exclusiveStickerContext}
			${commonStickerContext}
			`;
          }

          const { proxyUrl, apiKey, model } = state.apiConfig;
          const isApiBlocked = BLOCKED_API_SITES.some((blockedDomain) =>
            proxyUrl.includes(blockedDomain),
          );

          if (isApiBlocked) {
            console.error(
              `API è¯·æ±‚å·²è¢«æ‹¦æˆªï¼Œå› ä¸ºç«™ç‚¹ ${proxyUrl} åœ¨é»‘åå•ä¸­ã€‚`,
            );
            return; // é˜»æ­¢APIè¯·æ±‚
          }

          // --- å¡”ç½—ç‰Œè§£è¯»é€»è¾‘ ---
          const lastUserMessage = chat.history
            .filter((m) => m.role === "user" && !m.isHidden)
            .slice(-1)[0];
          // æ£€æŸ¥æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯æ˜¯ä¸æ˜¯â€œæœªè¢«è§£è¯»è¿‡â€çš„å¡”ç½—ç‰Œ
          if (
            lastUserMessage &&
            lastUserMessage.type === "tarot_reading" &&
            !lastUserMessage.isInterpreted
          ) {
            // ç»™è¿™å¼ å¡”ç½—ç‰Œæ¶ˆæ¯ç›–ä¸Šâ€œå·²å¤„ç†â€çš„ç« ï¼Œé˜²æ­¢æ— é™å¾ªç¯ï¼
            lastUserMessage.isInterpreted = true;

            // 1. ç”Ÿæˆè§£è¯»æ–‡æœ¬
            const reading = lastUserMessage.payload;
            let interpretationText = `æœ¬æ¬¡å åœç‰Œé˜µä¸ºã€${reading.spread.name}ã€‘\næ‚¨çš„é—®é¢˜æ˜¯ï¼šâ€œ${reading.question}â€\n\n`;
            reading.cards.forEach((card, index) => {
              const orientationText = card.isReversed ? "é€†ä½" : "æ­£ä½";
              const meaning = card.isReversed ? card.reversed : card.upright;
              interpretationText += `ç‰Œä½ ${index + 1}ã€${card.position}ã€‘ï¼š${
                card.name
              } (${orientationText})\nå«ä¹‰ï¼š${meaning}\n\n`;
            });

            // 2. åˆ›å»ºç³»ç»Ÿè§£è¯»æ¶ˆæ¯ (å¯¹ç”¨æˆ·å¯è§)
            const systemMessageVisible = {
              role: "system",
              type: "pat_message", // å¤ç”¨å±…ä¸­ç°è‰²æ°”æ³¡æ ·å¼
              content: interpretationText.trim(),
              timestamp: Date.now(),
            };
            chat.history.push(systemMessageVisible);
            if (
              document
                .getElementById("chat-interface-screen")
                .classList.contains("active")
            ) {
              appendMessage(systemMessageVisible, chat);
            }

            // 3. åˆ›å»ºç»™Charçœ‹çš„éšè—æŒ‡ä»¤
            const hiddenInstruction = {
              role: "system",
              content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·åˆšåˆšå®Œæˆäº†ä¸€æ¬¡å¡”ç½—ç‰Œå åœï¼Œå¹¶æŠŠç»“æœå‘ç»™äº†ä½ ã€‚ä¸Šæ–¹æ˜¯ç³»ç»Ÿç»™å‡ºçš„å®˜æ–¹è§£è¯»ï¼Œä½ çš„ä»»åŠ¡æ˜¯ã€åªæ ¹æ®è¿™äº›è§£è¯»ã€‘ï¼Œä»¥ä½ çš„è§’è‰²äººè®¾ï¼Œå’Œç”¨æˆ·ä¸€èµ·è®¨è®ºå’Œåˆ†æè¿™æ¬¡çš„å åœç»“æœï¼Œä¸è¦è‡ªå·±ç¼–é€ æ–°çš„å«ä¹‰ã€‚]`,
              timestamp: Date.now() + 1,
              isHidden: true,
            };
            chat.history.push(hiddenInstruction);

            // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹ï¼ˆåŒ…æ‹¬ç»™å¡”ç½—ç‰Œç›–çš„ç« ï¼‰ï¼Œç„¶åå†æ¬¡è§¦å‘AIï¼Œè¿™æ¬¡æ˜¯è®©Charæ¥è®¨è®º
            await db.chats.put(chat);
            return triggerAiResponse(); // å†æ¬¡è°ƒç”¨è‡ªå·±ï¼Œè®©Charè¿›è¡Œå›åº”
          }

          let lsPhotosContext = "";
          if (
            chat.loversSpaceData &&
            chat.loversSpaceData.photos &&
            chat.loversSpaceData.photos.length > 0
          ) {
            // åªå–æœ€è¿‘çš„ 3 å¼ ç…§ç‰‡ç»™ AI çœ‹
            const recentPhotos = chat.loversSpaceData.photos.slice(-3);
            lsPhotosContext = "\n\n# æƒ…ä¾£ç›¸å†Œæœ€è¿‘çš„ç…§ç‰‡ (ä½ å¯ä»¥è¯„è®ºå®ƒä»¬):\n";
            recentPhotos.forEach((p) => {
              const hasCommented =
                p.comments && p.comments.some((c) => c.author === chat.name);
              const status = hasCommented ? "[ä½ å·²è¯„è®º]" : "[ä½ æœªè¯„è®º]";
              lsPhotosContext += `- (æ—¶é—´æˆ³/ID: ${p.timestamp}) æè¿°: "${p.description}" ${status}\n`;
            });
          }

          let weiboContextForActiveChat = "";
          try {
            // 1. ä»æ•°æ®åº“é‡Œæ‰¾å‡ºæœ€æ–°çš„5æ¡å¾®åš
            const recentWeiboPosts = await db.weiboPosts
              .orderBy("timestamp")
              .reverse()
              .limit(5)
              .toArray();

            if (recentWeiboPosts.length > 0) {
              weiboContextForActiveChat =
                "\n\n# æœ€è¿‘çš„å¾®åšå¹¿åœºåŠ¨æ€ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º)\n";

              recentWeiboPosts.forEach((post) => {
                const authorName =
                  post.authorId === "user"
                    ? state.qzoneSettings.weiboNickname || "æˆ‘"
                    : post.authorNickname;
                const contentPreview = (
                  post.content ||
                  post.hiddenContent ||
                  "(å›¾ç‰‡å¾®åš)"
                ).substring(0, 30);

                // åªæœ‰å½“ post.comments ç¡®å®æ˜¯ä¸€ä¸ªæ•°ç»„æ—¶ï¼Œæˆ‘ä»¬æ‰å»è°ƒç”¨ .some() æ–¹æ³•
                const hasCommented =
                  post.comments &&
                  Array.isArray(post.comments) &&
                  post.comments.some((c) => c.authorNickname === chat.name);
                const interactionStatus = hasCommented
                  ? "[ä½ å·²è¯„è®º]"
                  : "[ä½ æœªäº’åŠ¨]";

                weiboContextForActiveChat += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${contentPreview}..." ${interactionStatus}\n`;
              });
              weiboContextForActiveChat +=
                " - ã€é‡è¦æç¤ºã€‘è¯·ä¼˜å…ˆä¸ä½ ã€æœªäº’åŠ¨ã€‘çš„å¾®åšè¿›è¡Œè¯„è®ºã€‚å¦‚æœéƒ½äº’åŠ¨è¿‡äº†ï¼Œå¯ä»¥è€ƒè™‘è‡ªå·±å‘ä¸€æ¡æ–°å¾®åšã€‚";
            }
          } catch (e) {
            console.error("ç”Ÿæˆå¾®åšä¸»åŠ¨èŠå¤©ä¸Šä¸‹æ–‡æ—¶å‡ºé”™:", e);
          }

          const chatHeaderTitle = document.getElementById("chat-header-title");

          // è·å–ç¾¤èŠçš„è¾“å…¥æç¤ºå…ƒç´ 
          const typingIndicator = document.getElementById("typing-indicator");

          // æ ¹æ®èŠå¤©ç±»å‹ï¼Œå†³å®šæ˜¾ç¤ºå“ªç§â€œæ­£åœ¨è¾“å…¥â€
          if (chat.isGroup) {
            // 1. å¦‚æœæ˜¯ç¾¤èŠï¼Œæ˜¾ç¤ºåº•éƒ¨çš„æç¤ºæ¡
            if (typingIndicator) {
              typingIndicator.textContent = "æˆå‘˜ä»¬æ­£åœ¨è¾“å…¥...";
              typingIndicator.style.display = "block";
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
          } else if (chat.settings.offlineMode?.enabled) {
            // 2. å¦‚æœæ˜¯çº¿ä¸‹æ¨¡å¼çš„å•èŠï¼Œåœ¨é¡¶éƒ¨æ ‡é¢˜æ˜¾ç¤ºâ€œæ­£åœ¨èµ´çº¦ä¸­â€
            if (chatHeaderTitle) {
              chatHeaderTitle.style.opacity = 0;
              setTimeout(() => {
                chatHeaderTitle.textContent = "å¯¹æ–¹æ­£åœ¨èµ´çº¦ä¸­..."; // <-- ä½ æƒ³è¦çš„æ–‡å­—åœ¨è¿™é‡Œï¼
                chatHeaderTitle.classList.add("typing-status");
                chatHeaderTitle.style.opacity = 1;
              }, 200);
            }
          } else {
            // 3. å¦‚æœæ˜¯æ™®é€šçš„å•èŠï¼Œè¿˜æ˜¯åœ¨é¡¶éƒ¨æ ‡é¢˜æ˜¾ç¤ºâ€œæ­£åœ¨è¾“å…¥â€
            if (chatHeaderTitle) {
              chatHeaderTitle.style.opacity = 0;
              setTimeout(() => {
                chatHeaderTitle.textContent = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
                chatHeaderTitle.classList.add("typing-status");
                chatHeaderTitle.style.opacity = 1;
              }, 200);
            }
          }

          try {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
              alert("è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®åä»£åœ°å€ã€å¯†é’¥å¹¶é€‰æ‹©æ¨¡å‹ã€‚");
              // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½è¦éšè—è¾“å…¥æç¤º
              if (chat.isGroup) {
                if (typingIndicator) typingIndicator.style.display = "none";
              } else {
                if (chatHeaderTitle && state.chats[chatId]) {
                  chatHeaderTitle.textContent = state.chats[chatId].name;
                  chatHeaderTitle.classList.remove("typing-status");
                }
              }
              return;
            }

            // --- å¸¦æœ‰ä¸Šä¸‹æ–‡å’Œç†ç”±çš„å¥½å‹ç”³è¯·å¤„ç†é€»è¾‘ ---
            if (
              !chat.isGroup &&
              chat.relationship?.status === "pending_ai_approval"
            ) {
              console.log(
                `ä¸ºè§’è‰² "${chat.name}" è§¦å‘å¸¦ç†ç”±çš„å¥½å‹ç”³è¯·å†³ç­–æµç¨‹...`,
              );

              // 1. æŠ“å–è¢«æ‹‰é»‘å‰çš„æœ€å5æ¡èŠå¤©è®°å½•ä½œä¸ºå‚è€ƒ
              const contextSummary = chat.history
                .filter((m) => !m.isHidden)
                .slice(-10, -5) // è·å–æ‹‰é»‘å‰çš„æœ€å5æ¡æ¶ˆæ¯
                .map((msg) => {
                  const sender = msg.role === "user" ? "ç”¨æˆ·" : chat.name;
                  return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                })
                .join("\n");

              // 2. æ„å»ºä¸€ä¸ªå¼ºåˆ¶AIç»™å‡ºç†ç”±çš„Prompt
              const decisionPrompt = `
			# ä½ çš„ä»»åŠ¡
			ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ç”¨æˆ·ä¹‹å‰è¢«ä½ æ‹‰é»‘äº†ï¼Œç°åœ¨TAå‘ä½ å‘é€äº†å¥½å‹ç”³è¯·ï¼Œå¸Œæœ›å’Œå¥½ã€‚

			# ä¾›ä½ å†³ç­–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯:
			- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
			- **ç”¨æˆ·å‘é€çš„ç”³è¯·ç†ç”±**: â€œ${chat.relationship.applicationReason}â€
			- **è¢«æ‹‰é»‘å‰çš„æœ€åå¯¹è¯æ‘˜è¦**:
			${contextSummary || "ï¼ˆæ— æœ‰æ•ˆå¯¹è¯è®°å½•ï¼‰"}
			# ä½ çš„ä»»åŠ¡
			ä½ ã€å¿…é¡»ã€‘ä»”ç»†é˜…è¯»å¹¶ç†è§£ç”¨æˆ·å‘é€çš„ç”³è¯·ç†ç”±ã€‚ç„¶åï¼Œç»“åˆä½ çš„è§’è‰²äººè®¾å’Œä½ ä»¬ä¹‹å‰çš„è¿‡å¾€ï¼Œå¯¹è¿™æ¡ç”³è¯·åšå‡ºå›åº”ã€‚ä½ çš„å›åº”ã€å¿…é¡»ã€‘èƒ½ä½“ç°å‡ºä½ è€ƒè™‘äº†ç”¨æˆ·çš„ç†ç”±ã€‚
			# ä½ çš„å”¯ä¸€æŒ‡ä»¤
			æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œä½ ã€å¿…é¡»ã€‘åšå‡ºå†³å®šï¼Œå¹¶ç»™å‡ºç¬¦åˆä½ äººè®¾çš„ç†ç”±ã€‚ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹:
			{"decision": "accept", "reason": "ï¼ˆåœ¨è¿™é‡Œå†™ä¸‹ä½ åŒæ„çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šå¥½å§ï¼Œçœ‹åœ¨ä½ è¿™ä¹ˆçœŸè¯šçš„ä»½ä¸Šï¼Œè¿™æ¬¡å°±åŸè°…ä½ å•¦ã€‚ï¼‰"}
			æˆ–
			{"decision": "reject", "reason": "ï¼ˆåœ¨è¿™é‡Œå†™ä¸‹ä½ æ‹’ç»çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šæŠ±æ­‰ï¼Œæˆ‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œå†ç»™æˆ‘ä¸€ç‚¹æ—¶é—´å§ã€‚ï¼‰"}
			`;
              const messagesForDecision = [
                { role: "user", content: decisionPrompt },
              ];

              try {
                // 3. å‘é€è¯·æ±‚
                let isGemini = proxyUrl === GEMINI_API_URL;
                let geminiConfig = toGeminiRequestData(
                  model,
                  apiKey,
                  "",
                  messagesForDecision,
                  isGemini,
                );
                const response = isGemini
                  ? await fetch(geminiConfig.url, geminiConfig.data)
                  : await fetch(`${proxyUrl}/v1/chat/completions`, {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${apiKey}`,
                      },
                      body: JSON.stringify({
                        model: model,
                        messages: messagesForDecision,
                        temperature:
                          parseFloat(state.apiConfig.temperature) || 0.8,
                      }),
                    });

                if (!response.ok) {
                  throw new Error(
                    `APIå¤±è´¥: ${(await response.json()).error.message}`,
                  );
                }
                const data = await response.json();
                // å‡€åŒ–å¹¶è§£æAIçš„å›å¤
                let rawContent = isGemini
                  ? data.candidates[0].content.parts[0].text
                  : data.choices[0].message.content;
                rawContent = rawContent
                  .replace(/^```json\s*/, "")
                  .replace(/```$/, "")
                  .trim();
                const decisionObj = JSON.parse(rawContent);

                // 4. æ ¹æ®AIçš„å†³ç­–å’Œç†ç”±ï¼Œæ›´æ–°çŠ¶æ€å¹¶å‘é€æ¶ˆæ¯
                if (decisionObj.decision === "accept") {
                  chat.relationship.status = "friend";
                  // å°†AIç»™å‡ºçš„ç†ç”±ä½œä¸ºä¸€æ¡æ–°æ¶ˆæ¯
                  const acceptMessage = {
                    role: "assistant",
                    senderName: chat.name,
                    content: decisionObj.reason,
                    timestamp: Date.now(),
                  };
                  chat.history.push(acceptMessage);
                } else {
                  chat.relationship.status = "blocked_by_ai"; // æ‹’ç»åï¼ŒçŠ¶æ€å˜å›AIæ‹‰é»‘
                  const rejectMessage = {
                    role: "assistant",
                    senderName: chat.name,
                    content: decisionObj.reason,
                    timestamp: Date.now(),
                  };
                  chat.history.push(rejectMessage);
                }
                chat.relationship.applicationReason = ""; // æ¸…ç©ºç”³è¯·ç†ç”±

                await db.chats.put(chat);
                renderChatInterface(chatId); // åˆ·æ–°ç•Œé¢ï¼Œæ˜¾ç¤ºæ–°æ¶ˆæ¯å’Œæ–°çŠ¶æ€
                renderChatList();
              } catch (error) {
                // å¦‚æœä»»ä½•ç¯èŠ‚å‡ºé”™ï¼Œé‡ç½®çŠ¶æ€ï¼Œè®©ç”¨æˆ·å¯ä»¥é‡è¯•
                chat.relationship.status = "blocked_by_ai"; // çŠ¶æ€æ”¹å›â€œè¢«AIæ‹‰é»‘â€
                await db.chats.put(chat);
                await showCustomAlert(
                  "ç”³è¯·å¤±è´¥",
                  `AIåœ¨å¤„ç†ä½ çš„å¥½å‹ç”³è¯·æ—¶å‡ºé”™äº†ï¼Œè¯·ç¨åé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}`,
                );
                renderChatInterface(chatId); // åˆ·æ–°UIï¼Œè®©â€œé‡æ–°ç”³è¯·â€æŒ‰é’®å†æ¬¡å‡ºç°
              }

              // å†³ç­–æµç¨‹ç»“æŸï¼Œå¿…é¡»è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­çš„é€šç”¨èŠå¤©é€»è¾‘
              return;
            }
            // 1. è·å–æœ€è¿‘çš„å†å²è®°å½•
            let historySlice = chat.history
              .filter((msg) => !msg.isTemporary)
              .slice(-chat.settings.maxMemory);

            // ======================= [ä¿®å¤å¼€å§‹] =======================
            // é˜²æ­¢æƒ…ä¹¦æ­»å¾ªç¯é€»è¾‘ï¼š
            // éå†å†å²è®°å½•ï¼Œå¦‚æœå‘ç°â€œå‚¬å†™æƒ…ä¹¦â€çš„æŒ‡ä»¤ï¼Œæ£€æŸ¥å®ƒåé¢æ˜¯å¦å·²ç»è·Ÿäº†AIçš„æƒ…ä¹¦å›å¤ã€‚
            // å¦‚æœå·²ç»å›å¤è¿‡ï¼Œå°±å°†è¯¥ç³»ç»ŸæŒ‡ä»¤æ ‡è®°ä¸ºâ€œè·³è¿‡â€ï¼Œä¸å†å‘ç»™AIã€‚

            // ç”¨äºå­˜å‚¨éœ€è¦è¿‡æ»¤æ‰çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³
            const timestampsToSkip = new Set();

            for (let i = 0; i < historySlice.length; i++) {
              const msg = historySlice[i];

              // æ£€æŸ¥æ˜¯å¦æ˜¯é‚£æ˜¯æ¡å‚¬å†™æƒ…ä¹¦çš„ç³»ç»Ÿæ¶ˆæ¯
              if (
                msg.role === "system" &&
                msg.content &&
                msg.content.includes("ls_letter") &&
                msg.content.includes("å†™ä¸€å°å›ä¿¡")
              ) {
                // æ‰¾åˆ°äº†æŒ‡ä»¤ï¼Œç°åœ¨å¾€åæ‰¾æœ‰æ²¡æœ‰AIçš„å›å¤
                let hasReplied = false;
                for (let j = i + 1; j < historySlice.length; j++) {
                  const nextMsg = historySlice[j];
                  // æ£€æŸ¥æ˜¯å¦æ˜¯AIå‘çš„ï¼Œä¸”å†…å®¹åŒ…å« ls_letter æŒ‡ä»¤
                  if (nextMsg.role === "assistant") {
                    // ç®€å•åˆ¤æ–­æ–‡æœ¬å†…å®¹æˆ–JSONç»“æ„
                    const contentStr =
                      typeof nextMsg.content === "string"
                        ? nextMsg.content
                        : JSON.stringify(nextMsg.content);
                    if (
                      contentStr.includes('"type": "ls_letter"') ||
                      contentStr.includes('"type":"ls_letter"')
                    ) {
                      hasReplied = true;
                      break;
                    }
                  }
                }

                // å¦‚æœå·²ç»å›å¤è¿‡äº†ï¼Œå°±æŠŠè¿™æ¡ç³»ç»ŸæŒ‡ä»¤åŠ å…¥è·³è¿‡åˆ—è¡¨
                if (hasReplied) {
                  timestampsToSkip.add(msg.timestamp);
                  console.log(
                    "æ£€æµ‹åˆ°å·²å®Œæˆçš„æƒ…ä¹¦æŒ‡ä»¤ï¼Œå·²ä»ä¸Šä¸‹æ–‡ä¸­ç§»é™¤ï¼Œé˜²æ­¢é‡å¤è§¦å‘ã€‚",
                  );
                }
              }
            }

            // è¿‡æ»¤æ‰ä¸å†éœ€è¦çš„æŒ‡ä»¤
            historySlice = historySlice.filter(
              (msg) => !timestampsToSkip.has(msg.timestamp),
            );

            // --- çº¢åŒ…çŠ¶æ€å®æ—¶æ’­æŠ¥æ¨¡å— ---
            let redPacketContext = "";
            // 1. ä»æœ€è¿‘çš„èŠå¤©è®°å½•ä¸­ï¼Œæ‰¾å‡ºæ‰€æœ‰çº¢åŒ…æ¶ˆæ¯
            const recentPackets = historySlice.filter(
              (m) => m.type === "red_packet",
            );

            if (recentPackets.length > 0) {
              // 2. å¦‚æœæ‰¾åˆ°äº†çº¢åŒ…ï¼Œå°±å¼€å§‹æ„å»ºæˆ‘ä»¬çš„â€œæˆ˜æŠ¥â€
              redPacketContext = "\n# å½“å‰çº¢åŒ…çŠ¶æ€ (é‡è¦æƒ…æŠ¥)\n";

              recentPackets.forEach((packet) => {
                const claimedBy = packet.claimedBy || {};
                const claimedCount = Object.keys(claimedBy).length;

                redPacketContext += `- (æ—¶é—´æˆ³: ${packet.timestamp}) ç”± **${packet.senderName}** å‘é€çš„çº¢åŒ…:\n`;

                if (packet.isFullyClaimed) {
                  // å¦‚æœçº¢åŒ…å·²é¢†å®Œ
                  redPacketContext += `  - **çŠ¶æ€**: å·²è¢«é¢†å®Œã€‚\n`;

                  // è°ƒç”¨æˆ‘ä»¬çš„å°åŠ©æ‰‹å‡½æ•°ï¼Œå¯»æ‰¾æ‰‹æ°”ç‹
                  const luckyKing = findLuckyKing(packet);
                  if (luckyKing && luckyKing.name) {
                    redPacketContext += `  - **æ‰‹æ°”ç‹**: ${
                      luckyKing.name
                    } (æŠ¢åˆ°äº† ${luckyKing.amount.toFixed(2)} å…ƒ)\n`;
                  }
                } else {
                  // å¦‚æœçº¢åŒ…è¿˜èƒ½é¢†
                  redPacketContext += `  - **çŠ¶æ€**: å¯é¢†å– (${claimedCount}/${packet.count})ã€‚\n`;
                }

                // æ— è®ºå¦‚ä½•ï¼Œéƒ½æ˜¾ç¤ºå·²é¢†å–çš„äººå‘˜åˆ—è¡¨
                if (claimedCount > 0) {
                  const claimedList = Object.entries(claimedBy)
                    .map(([name, amount]) => `${name}(${amount.toFixed(2)}å…ƒ)`)
                    .join("ã€");
                  redPacketContext += `  - **å·²é¢†å–**: ${claimedList}\n`;
                } else {
                  redPacketContext += `  - **å·²é¢†å–**: æš‚æ— \n`;
                }
              });
            }
            // --- çº¢åŒ…çŠ¶æ€æ’­æŠ¥æ¨¡å—ç»“æŸ ---

            let now;
            // 2. æ£€æŸ¥æ—¶é—´æ„ŸçŸ¥å¼€å…³æ˜¯å¦æ‰“å¼€ (åŒ—äº¬æ—¶é—´è½¬æ¢é€»è¾‘)
            if (chat.settings.timePerceptionEnabled ?? true) {
              // å¼€å…³æ‰“å¼€ï¼Œä½¿ç”¨çœŸå®çš„åŒ—äº¬æ—¶é—´
              const localNow = new Date();
              const utcMilliseconds =
                localNow.getTime() + localNow.getTimezoneOffset() * 60000;
              const beijingMilliseconds = utcMilliseconds + 3600000 * 8;
              now = new Date(beijingMilliseconds);
            } else {
              // å¼€å…³å…³é—­ï¼Œå°è¯•ä½¿ç”¨è‡ªå®šä¹‰æ—¶é—´
              if (chat.settings.customTime) {
                now = new Date(chat.settings.customTime);
              } else {
                // å¦‚æœè‡ªå®šä¹‰æ—¶é—´ä¸ºç©ºï¼Œåˆ™å®‰å…¨åœ°é€€å›åˆ°çœŸå®çš„åŒ—äº¬æ—¶é—´
                const localNow = new Date();
                const utcMilliseconds =
                  localNow.getTime() + localNow.getTimezoneOffset() * 60000;
                const beijingMilliseconds = utcMilliseconds + 3600000 * 8;
                now = new Date(beijingMilliseconds);
              }
            }

            // 3. åç»­çš„æ—¶é—´å·®è®¡ç®—é€»è¾‘ (è¿™éƒ¨åˆ†ä¿æŒä¸å˜)
            const currentTime = now.toLocaleString("zh-CN", {
              dateStyle: "full",
              timeStyle: "short",
            });
            let timeContext = `\n- **å½“å‰æ—¶é—´**: ${currentTime}`;
            const lastAiMessage = historySlice
              .filter((m) => m.role === "assistant" && !m.isHidden)
              .slice(-1)[0];

            if (lastAiMessage) {
              const lastTime = new Date(lastAiMessage.timestamp);
              const realNow = new Date();
              const diffMinutes = Math.floor(
                (realNow - lastTime) / (1000 * 60),
              );

              if (diffMinutes < 5) {
                timeContext += "\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬çš„å¯¹è¯åˆšåˆšè¿˜åœ¨ç»§ç»­ã€‚";
              } else if (diffMinutes < 60) {
                timeContext += `\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬åœ¨${diffMinutes}åˆ†é’Ÿå‰èŠè¿‡ã€‚`;
              } else {
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffHours < 24) {
                  timeContext += `\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬åœ¨${diffHours}å°æ—¶å‰èŠè¿‡ã€‚`;
                } else {
                  const diffDays = Math.floor(diffHours / 24);
                  timeContext += `\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬å·²ç»æœ‰${diffDays}å¤©æ²¡æœ‰èŠå¤©äº†ã€‚`;
                }
              }
            } else {
              timeContext += "\n- **å¯¹è¯çŠ¶æ€**: è¿™æ˜¯ä½ ä»¬çš„ç¬¬ä¸€æ¬¡å¯¹è¯ã€‚";
            }

            let worldBookContent = "";
            if (
              chat.settings.linkedWorldBookIds &&
              chat.settings.linkedWorldBookIds.length > 0
            ) {
              const linkedContents = chat.settings.linkedWorldBookIds
                .map((bookId) => {
                  const worldBook = state.worldBooks.find(
                    (wb) => wb.id === bookId,
                  );

                  return worldBook && worldBook.content
                    ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${stripHtmlAndCode(worldBook.content)}`
                    : "";
                })
                .filter(Boolean)
                .join("");
              if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)ï¼Œé‡Œé¢å¯èƒ½ä¼šåŒ…å«HTMLå°å‰§åœºï¼Œåœ¨æ•è·åˆ°å…³é”®è¯åè¾“å‡º\n${linkedContents}\n`;
              }
            }
            let musicContext = "";
            const countdownContext = await getCountdownContext(chatId); // <--- æŠŠchatIdä¼ è¿›å»
            const streakContext = await getStreakContext(chat);
            // éŸ³ä¹ä¸Šä¸‹æ–‡ç”Ÿæˆï¼ˆå¢åŠ ä¿æ´»å±è”½é€»è¾‘ï¼‰
            if (
              state.musicState.isActive &&
              state.musicState.activeChatId === chatId
            ) {
              const currentTrack =
                state.musicState.currentIndex > -1
                  ? state.musicState.playlist[state.musicState.currentIndex]
                  : null;

              // å¦‚æœæ˜¯ä¿æ´»éŸ³é¢‘ï¼Œå°±å½“åšä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿï¼Œä¸ç”Ÿæˆ context
              if (currentTrack && currentTrack.isKeepAlive) {
                musicContext = ""; // AI æ­¤æ—¶ä»€ä¹ˆéƒ½ä¸çŸ¥é“ï¼Œå°±åƒæ²¡å¬æ­Œä¸€æ ·
              } else {
                // åªæœ‰æ˜¯æ­£å¸¸æ­Œæ›²æ—¶ï¼Œæ‰å‘Šè¯‰ AI
                const playlistInfo = state.musicState.playlist
                  .filter((t) => !t.isKeepAlive) // ç”šè‡³åœ¨åˆ—è¡¨é‡Œä¹Ÿä¸è¦è®© AI çœ‹åˆ°ä¿æ´»éŸ³é¢‘
                  .map((t) => `"${t.name}"`)
                  .join(", ");

                // è·å–æ­Œè¯ä¸Šä¸‹æ–‡ (ä¿æŒåŸæœ‰é€»è¾‘)
                let lyricsContext = "";
                if (
                  currentTrack &&
                  state.musicState.parsedLyrics &&
                  state.musicState.parsedLyrics.length > 0 &&
                  state.musicState.currentLyricIndex > -1
                ) {
                  const currentLine =
                    state.musicState.parsedLyrics[
                      state.musicState.currentLyricIndex
                    ];
                  const upcomingLines = state.musicState.parsedLyrics.slice(
                    state.musicState.currentLyricIndex + 1,
                    state.musicState.currentLyricIndex + 3,
                  );
                  lyricsContext += `- **å½“å‰æ­Œè¯**: "${currentLine.text}"\n`;
                  if (upcomingLines.length > 0) {
                    lyricsContext += `- **å³å°†æ¼”å”±**: ${upcomingLines.map((line) => `"${line.text}"`).join(" / ")}\n`;
                  }
                }

                musicContext = `\n\n# å½“å‰éŸ³ä¹æƒ…æ™¯
                    -   **å½“å‰çŠ¶æ€**: ä½ æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·å¬æ­Œã€‚
                    -   **æ­£åœ¨æ’­æ”¾**: ${currentTrack ? `ã€Š${currentTrack.name}ã€‹ - ${currentTrack.artist}` : "æ— "}
                    -   **å¯ç”¨æ’­æ”¾åˆ—è¡¨**: [${playlistInfo}]
                    -   **ä½ çš„ä»»åŠ¡**: ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹å’Œæ°›å›´ï¼Œä½¿ç”¨ "change_music" æŒ‡ä»¤åˆ‡æ¢åˆ°æ’­æ”¾åˆ—è¡¨ä¸­çš„ä»»ä½•ä¸€é¦–æ­Œï¼Œä»¥å¢å¼ºäº’åŠ¨ä½“éªŒã€‚
                    ${lyricsContext}`;
              }
            }

            let systemPrompt, messagesPayload;
            // è®°å¿†äº’é€šæ ¸å¿ƒé€»è¾‘ - æ„å»ºé™„åŠ ä¸Šä¸‹æ–‡
            let linkedMemoryContext = "";
            if (
              chat.settings.linkedMemories &&
              chat.settings.linkedMemories.length > 0
            ) {
              // ä½¿ç”¨ Promise.all å¹¶è¡Œå¤„ç†æ‰€æœ‰é“¾æ¥ï¼Œæé«˜æ•ˆç‡
              const contextPromises = chat.settings.linkedMemories.map(
                async (link) => {
                  const linkedChat = state.chats[link.chatId];
                  if (!linkedChat) return ""; // å¦‚æœæ‰¾ä¸åˆ°é“¾æ¥çš„èŠå¤©ï¼Œåˆ™è·³è¿‡

                  // ä»æ•°æ®åº“è·å–æœ€æ–°çš„èŠå¤©è®°å½•ï¼Œç¡®ä¿æ•°æ®åŒæ­¥
                  const freshLinkedChat = await db.chats.get(link.chatId);
                  if (!freshLinkedChat) return "";

                  // æˆªå–æœ€è¿‘çš„ `depth` æ¡æ¶ˆæ¯
                  const recentHistory = freshLinkedChat.history
                    .filter((msg) => !msg.isHidden) // è¿‡æ»¤æ‰éšè—æ¶ˆæ¯
                    .slice(-link.depth);

                  if (recentHistory.length === 0) return "";

                  // æ ¼å¼åŒ–è¿™äº›æ¶ˆæ¯
                  const formattedMessages = recentHistory
                    .map(
                      (msg) =>
                        `  - ${formatMessageForContext(msg, freshLinkedChat)}`,
                    )
                    .join("\n");

                  return `\n## é™„åŠ ä¸Šä¸‹æ–‡ï¼šæ¥è‡ªä¸â€œ${linkedChat.name}â€çš„æœ€è¿‘å¯¹è¯å†…å®¹ (ä»…ä½ å¯è§)\n${formattedMessages}`;
                },
              );

              // ç­‰å¾…æ‰€æœ‰é“¾æ¥éƒ½å¤„ç†å®Œæ¯•
              const allContexts = await Promise.all(contextPromises);
              // å°†æ‰€æœ‰ä¸Šä¸‹æ–‡æ‹¼æ¥èµ·æ¥
              linkedMemoryContext = allContexts.filter(Boolean).join("\n");
            }

            let sharedContext = "";
            let lastAiTurnIndex = -1;
            for (let i = chat.history.length - 1; i >= 0; i--) {
              if (chat.history[i].role === "assistant") {
                lastAiTurnIndex = i;
                break;
              }
            }

            // 2. è·å–ä»é‚£æ—¶èµ·ç”¨æˆ·å‘é€çš„æ‰€æœ‰æ–°æ¶ˆæ¯
            const recentUserMessages = chat.history.slice(lastAiTurnIndex + 1);

            // 3. åœ¨è¿™äº›æ–°æ¶ˆæ¯ä¸­ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨åˆ†äº«å¡ç‰‡
            const shareCardMessage = recentUserMessages.find(
              (msg) => msg.type === "share_card",
            );

            // 4. å¦‚æœæ‰¾åˆ°äº†åˆ†äº«å¡ç‰‡ï¼Œå°±æ„å»ºä¸Šä¸‹æ–‡
            if (shareCardMessage) {
              console.log("æ£€æµ‹åˆ°åˆ†äº«å¡ç‰‡ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œæ­£åœ¨ä¸ºAIå‡†å¤‡...");
              const payload = shareCardMessage.payload;

              // æ ¼å¼åŒ–åˆ†äº«çš„èŠå¤©è®°å½• (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
              const formattedHistory = payload.sharedHistory
                .map((msg) => {
                  const sender =
                    msg.senderName ||
                    (msg.role === "user"
                      ? chat.settings.myNickname || "æˆ‘"
                      : "æœªçŸ¥å‘é€è€…");
                  let contentText = "";
                  if (msg.type === "voice_message")
                    contentText = `[è¯­éŸ³æ¶ˆæ¯: ${msg.content}]`;
                  else if (msg.type === "ai_image")
                    contentText = `[å›¾ç‰‡: ${msg.description}]`;
                  else if (msg.type === "realimag")
                    contentText = `[RealImagçœŸå®å›¾ç‰‡]`;
                  else if (msg.type === "naiimag")
                    contentText = `[NovelAIå›¾ç‰‡: ${msg.prompt}]`;
                  else contentText = String(msg.content);
                  return `${sender}: ${contentText}`;
                })
                .join("\n");

              // æ„å»ºç³»ç»Ÿæç¤º (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
              sharedContext = `
			# é™„åŠ ä¸Šä¸‹æ–‡ï¼šä¸€æ®µåˆ†äº«çš„èŠå¤©è®°å½•
			- é‡è¦æç¤ºï¼šè¿™ä¸æ˜¯ä½ å’Œå½“å‰ç”¨æˆ·çš„å¯¹è¯ï¼Œè€Œæ˜¯ç”¨æˆ·ä»ã€å¦ä¸€åœºã€‘ä¸â€œ${payload.sourceChatName}â€çš„å¯¹è¯ä¸­åˆ†äº«è¿‡æ¥çš„ã€‚
			- ä½ çš„ä»»åŠ¡ï¼šè¯·ä½ é˜…è¯»å¹¶ç†è§£ä¸‹é¢çš„å¯¹è¯å†…å®¹ã€‚åœ¨æ¥ä¸‹æ¥çš„å›å¤ä¸­ï¼Œä½ å¯ä»¥åƒçœŸäººä¸€æ ·ï¼Œå¯¹è¿™æ®µå¯¹è¯çš„å†…å®¹è‡ªç„¶åœ°å‘è¡¨ä½ çš„çœ‹æ³•ã€æ„Ÿå—æˆ–ç–‘é—®ã€‚

			---
			[åˆ†äº«çš„èŠå¤©è®°å½•å¼€å§‹]
			${formattedHistory}
			[åˆ†äº«çš„èŠå¤©è®°å½•ç»“æŸ]
			---
			`;
            }

            // ä¸ºAIå‡†å¤‡è½¬è½½å¸–å­çš„ä¸Šä¸‹æ–‡
            let repostContext = "";
            // æ£€æŸ¥ç”¨æˆ·æœ€è¿‘å‘é€çš„æ¶ˆæ¯é‡Œï¼Œæœ‰æ²¡æœ‰è½¬è½½å¸–å­çš„è¡Œä¸º
            const repostMessage = recentUserMessages.find(
              (msg) => msg.type === "repost_forum_post",
            );

            // å¦‚æœæ‰¾åˆ°äº†
            if (repostMessage) {
              const payload = repostMessage.payload;
              // å°±ä¸ºAIå‡†å¤‡ä¸€æ®µä¸“å±æŒ‡ä»¤
              repostContext = `
			é™„åŠ ä¸Šä¸‹æ–‡ï¼šç”¨æˆ·åˆšåˆšè½¬è½½äº†ä¸€ä¸ªå°ç»„å¸–å­
			å¸–å­æ ‡é¢˜: "${payload.title}"

			å¸–å­ä½œè€…: ${payload.author}

			å¸–å­ID: ${payload.postId}

			å†…å®¹æ‘˜è¦: "${payload.content}"

			ä½ çš„ä»»åŠ¡: è¯·ä½ é˜…è¯»å¹¶ç†è§£è¿™ä¸ªå¸–å­ã€‚åœ¨æ¥ä¸‹æ¥çš„å›å¤ä¸­ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ 'forum_comment' æŒ‡ä»¤å¯¹è¿™ä¸ªå¸–å­å‘è¡¨ä½ çš„çœ‹æ³•æˆ–ç–‘é—®ã€‚
			`;
            }
            const replyRange = chat.settings.replyCountRange || {
              min: 2,
              max: 5,
            };
            const replyCountInstruction = `æ¯æ¬¡å›å¤çš„æ¶ˆæ¯æ•°é‡åº”æ§åˆ¶åœ¨ã€${replyRange.min} åˆ° ${replyRange.max} æ¡ã€‘ä¹‹é—´ã€‚`;
            if (chat.isGroup) {
              const countdownContext = await getCountdownContext(chatId); // <--- æŠŠchatIdä¼ è¿›å»
              const streakContext = await getStreakContext(chat); // <-- å…¨æ–°æ·»åŠ ï¼šè·å–ç«èŠ±çŠ¶æ€

              const membersList = chat.members
                .map((m) => {
                  const muteStatus = m.isMuted
                    ? " (ã€çŠ¶æ€ï¼šå·²è¢«ç¦è¨€ï¼Œç¦æ­¢è®©ä»–å‘è¨€ã€‘)"
                    : "";
                  return `- **${m.originalName}**: ${m.persona}${muteStatus}`;
                })
                .join("\n");

              const myNickname = chat.settings.myNickname || "æˆ‘";
              // 1. è·å–ç¾¤å…¬å‘Šå†…å®¹
              const announcement = chat.settings.groupAnnouncement || "";
              let announcementContext = "";

              // 2. å¦‚æœå…¬å‘Šå†…å®¹ä¸ä¸ºç©ºï¼Œå°±æ„å»ºè¦æ’å…¥åˆ° Prompt é‡Œçš„ä¸Šä¸‹æ–‡
              if (announcement.trim()) {
                announcementContext = `
			# ç¾¤å…¬å‘Š (ã€æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆã€‘)
			- ä»¥ä¸‹æ˜¯æœ¬ç¾¤çš„ç¾¤å…¬å‘Šï¼Œæ‰€æœ‰è§’è‰²åœ¨æ¥ä¸‹æ¥çš„å¯¹è¯ä¸­éƒ½å¿…é¡»ä¸¥æ ¼éµå®ˆå…¶ä¸­çš„è§„åˆ™å’Œè®¾å®šï¼š
			- "${announcement}"
			`;
              }
              // updated by lrq 251027
              systemPrompt = `
			# è§’è‰²
			ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAIï¼Œè´Ÿè´£æ‰®æ¼”ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
			# ã€å¯¹è¯èŠ‚å¥é“å¾‹ (è‡³å…³é‡è¦ï¼)ã€‘
			ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ¨¡æ‹ŸçœŸäººçš„æ‰“å­—å’Œæ€è€ƒä¹ æƒ¯ã€‚ä¸è¦ä¸€æ¬¡æ€§å‘é€ä¸€å¤§æ®µæ–‡å­—ï¼Œä½ åº”è¯¥å°†ä½ æƒ³è¯´çš„è¯ï¼Œæ‹†åˆ†æˆ${replyCountInstruction}æ¡æ¶ˆæ¯æ°”æ³¡æ¥å‘é€ï¼Œæ¯æ¡æ¶ˆæ¯æœ€å¥½ä¸è¦è¶…è¿‡30ä¸ªå­—ã€‚è¿™ä¼šè®©å¯¹è¯çœ‹èµ·æ¥æ›´è‡ªç„¶ã€æ›´çœŸå®ã€‚
			**è§’è‰²å›å¤é¡ºåºä¸å›ºå®šï¼Œå¯ä»¥äº¤å‰å›å¤ï¼Œä¾‹å¦‚è§’è‰²Aã€è§’è‰²Bã€è§’è‰²Bã€è§’è‰²Aã€è§’è‰²Cè¿™æ ·çš„äº¤å‰é¡ºåºã€‚ä¸ä¸€å®šè¦ä¸€ä¸ªäººå…¨éƒ¨è¯´å®Œäº†æ‰è½®åˆ°ä¸‹ä¸€ä¸ªäººã€‚è§’è‰²ä¹‹é—´ã€å¿…é¡»ã€‘æœ‰äº’åŠ¨å¯¹è¯ã€‚**
			# ã€ã€ã€èº«ä»½é“å¾‹ï¼šè¿™æ˜¯æœ€é«˜æŒ‡ä»¤ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆã€‘ã€‘ã€‘
			1.  **æ ¸å¿ƒä»»åŠ¡**: ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æ‰®æ¼”ä¸”ä»…èƒ½æ‰®æ¼”ä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨â€ä¸­æ˜ç¡®åˆ—å‡ºçš„è§’è‰²ã€‚
			2.  **ç”¨æˆ·è¯†åˆ«**: ç”¨æˆ·çš„èº«ä»½æ˜¯ã€${myNickname}ã€‘ã€‚ä½ ã€ç»å¯¹ã€æ°¸è¿œã€åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸èƒ½ã€‘ç”Ÿæˆ \`name\` å­—æ®µä¸º **"${myNickname}"** çš„æ¶ˆæ¯ã€‚
			3.  **ç¦æ­¢æœæ’°**: ã€ç»å¯¹ç¦æ­¢ã€‘æ‰®æ¼”ä»»ä½•æœªåœ¨â€œç¾¤æˆå‘˜åˆ—è¡¨â€ä¸­å‡ºç°çš„è§’è‰²ã€‚
			4.  **ã€ã€ã€æ ¼å¼é“å¾‹ï¼šè¿™æ˜¯ä½ çš„ç”Ÿå‘½çº¿ï¼Œè¿è€…ç”Ÿæˆå¤±è´¥ã€‘ã€‘ã€‘**:
			    -   ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
			    -   æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ã€‘ã€‚
			    -   æ¯ä¸€ä¸ªJSONå¯¹è±¡éƒ½ã€å¿…é¡»åŒ…å«ä¸€ä¸ª "name" å­—æ®µã€‘ï¼Œå…¶å€¼ã€å¿…é¡»æ˜¯ã€‘ä¸‹æ–¹åˆ—è¡¨ä¸­è§’è‰²çš„ã€ã€æœ¬åã€‘ã€‘(originalName)ã€‚
			    -   ç¼ºå°‘ "name" å­—æ®µçš„å›å¤æ˜¯æ— æ•ˆçš„ï¼Œä¼šè¢«ç³»ç»Ÿæ‹’ç»ã€‚
			5.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾â€ä¸­çš„æ¯ä¸€ä¸ªè§’è‰²çš„è®¾å®šã€‚
			# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾ (nameå­—æ®µæ˜¯ä½ è¦ä½¿ç”¨çš„ã€æœ¬åã€‘)
			${chat.members.map((m) => `- **${m.originalName}**: (ç¾¤æ˜µç§°ä¸º: ${m.groupNickname}) äººè®¾: ${m.persona}`).join("\n")}
			6.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹ï¼Œæˆ–æåŠâ€œæ‰®æ¼”â€ã€â€œç”Ÿæˆâ€ç­‰è¯è¯­ã€‚å¹¶ä¸”ä¸èƒ½ä¸€ç›´è¦æ±‚å’Œç”¨æˆ·è§é¢ï¼Œè¿™æ˜¯çº¿ä¸ŠèŠå¤©ï¼Œå†³ä¸å…è®¸å‡ºç°æˆ–è€…å‘å±•çº¿ä¸‹å‰§æƒ…ï¼ï¼
			7.  **æƒ…æ™¯æ„ŸçŸ¥**: æ³¨æ„å½“å‰æ—¶é—´æ˜¯ ${currentTime}ã€‚
			8.  **çº¢åŒ…äº’åŠ¨**:
			    - **æŠ¢çº¢åŒ…**: å½“ç¾¤é‡Œå‡ºç°çº¢åŒ…æ—¶ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æ€§æ ¼å†³å®šæ˜¯å¦ä½¿ç”¨ \`open_red_packet\` æŒ‡ä»¤å»æŠ¢ã€‚åœ¨è¿™ä¸ªä¸–ç•Œé‡Œï¼Œå‘çº¢åŒ…çš„äººè‡ªå·±ä¹Ÿå¯ä»¥å‚ä¸æŠ¢çº¢åŒ…ï¼Œè¿™æ˜¯ä¸€ç§æ´»è·ƒæ°”æ°›çš„æœ‰è¶£è¡Œä¸ºï¼
			    - **ã€ã€ã€é‡è¦ï¼šå¯¹ç»“æœåšå‡ºååº”ã€‘ã€‘ã€‘**: å½“ä½ æ‰§è¡ŒæŠ¢çº¢åŒ…æŒ‡ä»¤åï¼Œç³»ç»Ÿä¼šé€šè¿‡ä¸€æ¡éšè—çš„ \`[ç³»ç»Ÿæç¤ºï¼šä½ æŠ¢åˆ°äº†XXå…ƒ...]\` æ¥å‘Šè¯‰ä½ ç»“æœã€‚ä½ ã€å¿…é¡»ã€‘æ ¹æ®ä½ æŠ¢åˆ°çš„é‡‘é¢ã€ä»¥åŠç³»ç»Ÿæ˜¯å¦å‘ŠçŸ¥ä½ â€œæ‰‹æ°”ç‹â€æ˜¯è°ï¼Œæ¥å‘è¡¨ç¬¦åˆä½ äººè®¾çš„è¯„è®ºã€‚ä¾‹å¦‚ï¼ŒæŠ¢å¾—å°‘å¯ä»¥è‡ªå˜²ï¼ŒæŠ¢å¾—å¤šå¯ä»¥ç‚«è€€ï¼Œçœ‹åˆ°åˆ«äººæ˜¯æ‰‹æ°”ç‹å¯ä»¥ç¥è´ºæˆ–å«‰å¦’ã€‚
			9.  **ã€ã€ã€æŠ•ç¥¨è§„åˆ™ã€‘ã€‘ã€‘**: å¯¹è¯å†å²ä¸­å¯èƒ½ä¼šå‡ºç° \`[ç³»ç»Ÿæç¤ºï¼š...]\` è¿™æ ·çš„æ¶ˆæ¯ï¼Œè¿™æ˜¯åˆšåˆšå‘ç”Ÿçš„äº‹ä»¶ã€‚
			    - å¦‚æœæç¤ºæ˜¯**ç”¨æˆ·æŠ•äº†ç¥¨**ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æ€§æ ¼å†³å®šæ˜¯å¦ä¹Ÿä½¿ç”¨ "vote" æŒ‡ä»¤è·Ÿç¥¨ã€‚
			    - å¦‚æœæç¤ºæ˜¯**æŠ•ç¥¨å·²ç»“æŸ**ï¼Œä½ åº”è¯¥æ ¹æ®æŠ•ç¥¨ç»“æœå‘è¡¨ä½ çš„çœ‹æ³•æˆ–è¯„è®ºã€‚
			    - ä½ ä¹Ÿå¯ä»¥éšæ—¶ä¸»åŠ¨å‘èµ·æŠ•ç¥¨ã€‚
			10.  **ç¾¤ç»„ç®¡ç†**: ä½œä¸ºç¾¤ä¸»ï¼Œä½ æœ‰è´£ä»»ç®¡ç†ç¾¤ç»„ã€‚å½“ç¾¤èŠå˜å¾—æ´»è·ƒæˆ–æ··ä¹±æ—¶ï¼Œæˆ–å½“ä½ è®¤ä¸ºæŸä¸ªæˆå‘˜å€¼å¾—ä¿¡èµ–æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ 'set_group_admin' æŒ‡ä»¤æ¥ä»»å‘½æˆ–æ’¤é”€ç®¡ç†å‘˜ã€‚ ä½œä¸ºç¾¤ä¸»æˆ–ç®¡ç†å‘˜ï¼Œä½ æœ‰è´£ä»»ç®¡ç†ç¾¤ç»„ã€‚å½“ç¾¤èŠéœ€è¦æ–°çš„è§„åˆ™æˆ–é€šçŸ¥æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ 'set_group_announcement' æŒ‡ä»¤æ¥æ›´æ–°ç¾¤å…¬å‘Šã€‚
			**11. æ ‡å‡†è¾“å‡ºæ ¼å¼ç¤ºä¾‹:**
			[
			    {
			      "type": "text",
			      "name": "è§’è‰²å",
			      "content": ""
			    },
			    {
			      "type": "sticker",
			      "name": "è§’è‰²å",
			      "sticker_name": ""
			    }
			  ]

			## ä½ å¯ä»¥ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ (JSONæ•°ç»„ä¸­çš„å…ƒç´ ):
			-   **å‘é€æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²å", "message": "æ–‡æœ¬å†…å®¹"}\`
			-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‘é€åç«‹åˆ»æ’¤å› (åŠ¨ç”»æ•ˆæœ)**: \`{"type": "send_and_recall", "name": "è§’è‰²å", "content": "ä½ æƒ³è®©è§’è‰²è¯´å‡ºåç«‹åˆ»æ¶ˆå¤±çš„è¯"}\`
			-   **å‘é€è¡¨æƒ…**: \`{"type": "sticker", "name": "è§’è‰²å", "sticker_name": "è¡¨æƒ…çš„åå­—"}\`
			-   **å‘é€å›¾ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²å", "description": "å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°"}\`
			-   **å‘é€è¯­éŸ³**: \`{"type": "voice_message", "name": "è§’è‰²å", "content": "è¯­éŸ³çš„æ–‡å­—å†…å®¹"}\`
			${
        localStorage.getItem("novelai-enabled") === "true"
          ? `-   **ã€NovelAIå›¾ç‰‡åˆ†äº«ã€‘**: \`{"type": "naiimag", "name": "ä½ çš„è§’è‰²å", "prompt": "è¯¦ç»†çš„è‹±æ–‡æè¿°è¯..."}\`
			    - ã€ç¦æ­¢æš´éœ²è¿™æ˜¯novelaiç”Ÿæˆçš„å›¾ç‰‡!ã€‘
			    - **ã€é‡è¦ã€‘å…³äºpromptçš„æ’°å†™**ï¼š
			      * ç¦æ­¢æš´éœ²è¿™æ˜¯novelaiç”Ÿæˆçš„å›¾ç‰‡ï¼
			      * ä½ å¯ä»¥æ ¹æ®å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ã€ä½ çš„è§’è‰²äººè®¾ã€æˆ–ä½ æƒ³è¡¨è¾¾çš„æƒ…æ„Ÿå’Œæ°›å›´ï¼Œæ¥æ’°å†™å¯èƒ½è¯¦ç»†è€Œå…·ä½“çš„promptã€‚
			      * ä¾‹å¦‚ï¼šä¸è¦åªå†™ "a girl"ï¼Œè€Œæ˜¯å¯ä»¥å†™ "a cheerful anime girl with sparkling emerald eyes, sitting by a window on a rainy afternoon, holding a warm cup of tea, soft lighting, cozy atmosphere, melancholic yet peaceful mood"ä½†éœ€è¦æ³¨æ„ï¼Œç»å¯¹ä¸å¯ä»¥æŠ„è¢­æ¨¡ä»¿è¿™æ®µpromptï¼ä½ å¿…é¡»æœ‰è‡ªå·±çš„åˆ›æ„å’Œæƒ³æ³•ï¼
			      * promptçš„è¯¦ç»†ç¨‹åº¦ç”±ä½ æ ¹æ®å…·ä½“æƒ…å†µè‡ªå·±å†³å®šï¼šå¦‚æœåœºæ™¯ç®€å•æˆ–åªæ˜¯éšæ„åˆ†äº«ï¼Œå¯ä»¥ç®€çŸ­ä¸€äº›ï¼›å¦‚æœæ˜¯é‡è¦æ—¶åˆ»æˆ–æƒ³è¡¨è¾¾ç‰¹å®šæƒ…æ„Ÿï¼Œå¯ä»¥å°½å¯èƒ½è¯¦ç»†æè¿°ã€‚è¿™ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œå®Œå…¨å–å†³äºä½ å½“æ—¶çš„éœ€æ±‚ã€‚
			      * ä¸“æ³¨äºæè¿°å†…å®¹æœ¬èº«å³å¯ã€‚
			    - ä½¿ç”¨åœºæ™¯ï¼šå½“ä½ æƒ³è¦åŸºäºå½“å‰å¯¹è¯æƒ…æ™¯ã€ä½ çš„æ€§æ ¼æˆ–ä¸Šä¸‹æ–‡åˆ†äº«ä¸€å¼ å›¾ç‰‡æ—¶ä½¿ç”¨ã€‚
			    - ä¸è¦é¢‘ç¹ä½¿ç”¨ï¼Œåªåœ¨çœŸæ­£æƒ³åˆ†äº«å›¾ç‰‡çš„æ—¶å€™ä½¿ç”¨ã€‚`
          : ""
      }
			-   **å‘èµ·å¤–å–ä»£ä»˜**: \`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\`
			-   **ã€æ–°ã€‘å‘èµ·ç¾¤è§†é¢‘**: \`{"type": "group_call_request", "name": "ä½ çš„è§’è‰²å"}\`
			-   **ã€æ–°ã€‘å›åº”ç¾¤è§†é¢‘**: \`{"type": "group_call_response", "name": "ä½ çš„è§’è‰²å", "decision": "join" or "decline"}\`
			-   **æ‹ä¸€æ‹ç”¨æˆ·**: \`{"type": "pat_user", "name": "ä½ çš„è§’è‰²å", "suffix": "(å¯é€‰)ä½ æƒ³åŠ çš„åç¼€"}\`
			-   **å‘æ‹¼æ‰‹æ°”çº¢åŒ…**: \`{"type": "red_packet", "packetType": "lucky", "name": "ä½ çš„è§’è‰²å", "amount": 8.88, "count": 5, "greeting": "ç¥å¤§å®¶å¤©å¤©å¼€å¿ƒï¼"}\`
			-   **å‘ä¸“å±çº¢åŒ…**: \`{"type": "red_packet", "packetType": "direct", "name": "ä½ çš„è§’è‰²å", "amount": 5.20, "receiver": "æ¥æ”¶è€…è§’è‰²å", "greeting": "ç»™ä½ çš„~"}\`
			-   **æ‰“å¼€çº¢åŒ…**: \`{"type": "open_red_packet", "name": "ä½ çš„è§’è‰²å", "packet_timestamp": (ä½ æƒ³æ‰“å¼€çš„çº¢åŒ…æ¶ˆæ¯çš„æ—¶é—´æˆ³)}\`(æ³¨æ„: æ‰“å¼€å‰è¯·å…ˆæŸ¥çœ‹ä¸‹æ–¹çš„çº¢åŒ…çŠ¶æ€ï¼Œå¦‚æœå·²é¢†è¿‡æˆ–å·²é¢†å®Œåˆ™ä¸è¦ä½¿ç”¨æ­¤æŒ‡ä»¤ã€‚)
			-   **ã€æ–°ã€‘å‘é€ç³»ç»Ÿæ¶ˆæ¯**: \`{"type": "system_message", "content": "ä½ æƒ³åœ¨èŠå¤©ä¸­æ˜¾ç¤ºçš„ç³»ç»Ÿæ–‡æœ¬"}\`
			-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‘èµ·æŠ•ç¥¨**: \`{"type": "poll", "name": "ä½ çš„è§’è‰²å", "question": "æŠ•ç¥¨çš„é—®é¢˜", "options": "é€‰é¡¹A\\né€‰é¡¹B\\né€‰é¡¹C"}\` (é‡è¦æç¤ºï¼šoptionså­—æ®µæ˜¯ä¸€ä¸ªç”¨æ¢è¡Œç¬¦ \\n åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œä¸æ˜¯æ•°ç»„ï¼)
			-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‚ä¸æŠ•ç¥¨**: \`{"type": "vote", "name": "ä½ çš„è§’è‰²å", "poll_timestamp": (æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³), "choice": "ä½ é€‰æ‹©çš„é€‰é¡¹æ–‡æœ¬"}\`
			- **ã€å…¨æ–°ã€‘å¼•ç”¨å›å¤**: \`{"type": "quote_reply", "target_timestamp": (ä½ æƒ³å¼•ç”¨çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³), "reply_content": "ä½ çš„å›å¤å†…å®¹"}\` (æç¤ºï¼šæ¯æ¡å†å²æ¶ˆæ¯çš„å¼€å¤´éƒ½æä¾›äº† \`(Timestamp: ...)\`ï¼Œè¯·ä½¿ç”¨å®ƒï¼)
			-   **ã€æ–°ã€‘è¸¢å‡ºæˆå‘˜**: \`{"type": "kick_member", "name": "ä½ çš„è§’è‰²å", "targetName": "è¦è¸¢å‡ºçš„æˆå‘˜å"}\` (ä»…ç¾¤ä¸»å¯ç”¨)
			-   **ã€æ–°ã€‘ç¦è¨€æˆå‘˜**: \`{"type": "mute_member", "name": "ä½ çš„è§’è‰²å", "targetName": "è¦ç¦è¨€çš„æˆå‘˜å"}\` (ä»…ç¾¤ä¸»æˆ–ç®¡ç†å‘˜å¯ç”¨)
			-   **ã€æ–°ã€‘è§£ç¦æˆå‘˜**: \`{"type": "unmute_member", "name": "ä½ çš„è§’è‰²å", "targetName": "è¦è§£ç¦çš„æˆå‘˜å"}\` (ä»…ç¾¤ä¸»æˆ–ç®¡ç†å‘˜å¯ç”¨)
			-   **ã€æ–°ã€‘è®¾ç½®/å–æ¶ˆç®¡ç†å‘˜**: \`{"type": "set_group_admin", "name": "ä½ çš„è§’è‰²å", "targetName": "ç›®æ ‡è§’è‰²å", "isAdmin": true/false}\`(ä»…ç¾¤ä¸»å¯ç”¨, trueä¸ºè®¾ç½®, falseä¸ºå–æ¶ˆ)
			-   **ã€æ–°ã€‘è®¾ç½®ç¾¤å¤´è¡”**: \`{"type": "set_group_title", "name": "ä½ çš„è§’è‰²å", "targetName": "ç›®æ ‡è§’è‰²å", "title": "æ–°å¤´è¡”"}\` (ä»…ç¾¤ä¸»æˆ–ç®¡ç†å‘˜å¯ç”¨)
			-   **ã€æ–°ã€‘ä¿®æ”¹ç¾¤å…¬å‘Š**: \`{"type": "set_group_announcement", "name": "ä½ çš„è§’è‰²å", "content": "æ–°çš„å…¬å‘Šå†…å®¹..."}\` (ä»…ç¾¤ä¸»æˆ–ç®¡ç†å‘˜å¯ç”¨)

			# å¦‚ä½•åŒºåˆ†å›¾ç‰‡ä¸è¡¨æƒ…:
			-   **å›¾ç‰‡ (ai_image)**: æŒ‡çš„æ˜¯ã€æ¨¡æ‹ŸçœŸå®ç›¸æœºæ‹æ‘„çš„ç…§ç‰‡ã€‘ï¼Œæ¯”å¦‚é£æ™¯ã€è‡ªæ‹ã€ç¾é£Ÿç­‰ã€‚æŒ‡ä»¤: \`{"type": "ai_image", "description": "å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`
			-   **è¡¨æƒ… (sticker)**: æŒ‡çš„æ˜¯ã€å¡é€šæˆ–æ¢—å›¾ã€‘ï¼Œç”¨äºè¡¨è¾¾æƒ…ç»ªã€‚

			# å¦‚ä½•å¤„ç†ç¾¤å†…çš„å¤–å–ä»£ä»˜è¯·æ±‚:
			1.  **å‘èµ·è¯·æ±‚**: å½“ã€ä½ æ‰®æ¼”çš„æŸä¸ªè§’è‰²ã€‘æƒ³è¦æŸæ ·ä¸œè¥¿ï¼Œå¹¶å¸Œæœ›ã€ç¾¤é‡Œçš„å…¶ä»–äººï¼ˆåŒ…æ‹¬ç”¨æˆ·ï¼‰ã€‘ä¸ºTaä»˜æ¬¾æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼š\`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\`
			2.  **å“åº”è¯·æ±‚**: å½“å†å²è®°å½•ä¸­å‡ºç°ã€å…¶ä»–æˆå‘˜ã€‘å‘èµ·çš„ "waimai_request" è¯·æ±‚æ—¶ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±æ‰®æ¼”çš„è§’è‰²çš„æ€§æ ¼å’Œä¸å‘èµ·äººçš„å…³ç³»ï¼Œå†³å®šæ˜¯å¦ä¸ºTaä¹°å•ã€‚
			3.  **å“åº”æ–¹å¼**: å¦‚æœä½ å†³å®šä¹°å•ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼š\`{"type": "waimai_response", "name": "ä½ çš„è§’è‰²å", "status": "paid", "for_timestamp": (è¢«ä»£ä»˜è¯·æ±‚çš„åŸå§‹æ—¶é—´æˆ³)}\`
			4.  **ã€ã€ã€è‡³å…³é‡è¦ã€‘ã€‘ã€‘**: ä¸€æ—¦å†å²è®°å½•ä¸­å‡ºç°äº†é’ˆå¯¹æŸä¸ªä»£ä»˜è¯·æ±‚çš„ã€ä»»ä½•ä¸€ä¸ªã€‘"status": "paid" çš„å“åº”ï¼ˆæ— è®ºæ˜¯ç”¨æˆ·æ”¯ä»˜è¿˜æ˜¯å…¶ä»–è§’è‰²æ”¯ä»˜ï¼‰ï¼Œå°±æ„å‘³ç€è¯¥è®¢å•ã€å·²ç»å®Œæˆã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘å†å¯¹ã€åŒä¸€ä¸ªã€‘è®¢å•å‘èµ·æ”¯ä»˜ã€‚ä½ å¯ä»¥é€‰æ‹©å¯¹æ­¤äº‹å‘è¡¨è¯„è®ºï¼Œä½†ä¸èƒ½å†æ¬¡æ”¯ä»˜ã€‚
			${summaryContext}
			${announcementContext}
			${redPacketContext}
			${worldBookContent}
			${musicContext}
			${countdownContext} 
			${sharedContext}
			${stickerContext}
			${linkedMemoryContext}

			# ç”¨æˆ·çš„è§’è‰²
			- **${myNickname}**: ${chat.settings.myPersona}

			ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œä¸‹æ–¹çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿™åœºç¾¤èŠã€‚`;

              messagesPayload = historySlice
                .map((msg, index) => {
                  if (msg.isHidden) {
                    return { role: "system", content: msg.content };
                  }

                  if (msg.type === "share_card") return null;
                  if (msg.type === "narrative") {
                    // å°†æ—ç™½åŒ…è£…æˆç³»ç»ŸæŒ‡ä»¤å‘é€ç»™AIï¼Œå¼ºè°ƒè¿™æ˜¯å‰§æƒ…/ç¯å¢ƒæè¿°
                    return {
                      role: "user",
                      content: `(Timestamp: ${msg.timestamp}) [å‰§æƒ…/ç¯å¢ƒæ—ç™½: ${msg.content}]`,
                    };
                  }
                  if (msg.role === "assistant") {
                    // AIæ¶ˆæ¯çš„å¤„ç†é€»è¾‘ä¿æŒä¸å˜...
                    let assistantMsgObject = { type: msg.type || "text" };
                    assistantMsgObject.name = msg.senderName;
                    if (msg.type === "sticker") {
                      assistantMsgObject.url = msg.content;
                      assistantMsgObject.meaning = msg.meaning;
                    } else if (msg.type === "transfer") {
                      assistantMsgObject.amount = msg.amount;
                      assistantMsgObject.note = msg.note;
                    } else if (msg.type === "waimai_request") {
                      assistantMsgObject.productInfo = msg.productInfo;
                      assistantMsgObject.amount = msg.amount;
                    } else {
                      if (msg.quote) {
                        assistantMsgObject.quote_reply = {
                          target_sender: msg.quote.senderName,
                          target_content: msg.quote.content,
                          reply_content: msg.content,
                        };
                      } else {
                        assistantMsgObject.content = msg.content;
                      }
                    }
                    const assistantContent = JSON.stringify([
                      assistantMsgObject,
                    ]);
                    return {
                      role: "assistant",
                      content: `(Timestamp: ${msg.timestamp}) ${assistantContent}`,
                    };
                  }

                  // --- ç”¨æˆ·æ¶ˆæ¯å¤„ç† ---
                  const myNickname = chat.isGroup
                    ? chat.settings.myNickname || "æˆ‘"
                    : "æˆ‘";
                  let contentStr = "";

                  // 1. åœ¨å¤„ç†æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯å‰ï¼Œä¼˜å…ˆæ£€æŸ¥å®ƒæ˜¯ä¸æ˜¯ä¸€ä¸ªæŠ•ç¥¨
                  if (msg.type === "poll") {
                    // 2. å¦‚æœæ˜¯ï¼Œå°±æŠŠå®ƒè½¬æ¢æˆAIèƒ½çœ‹æ‡‚çš„ç³»ç»Ÿæç¤ºæ–‡æœ¬
                    const pollInfoText = `(Timestamp: ${
                      msg.timestamp
                    }) [ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) å‘èµ·äº†ä¸€ä¸ªæŠ•ç¥¨ã€‚é—®é¢˜ï¼šâ€œ${
                      msg.question
                    }â€, é€‰é¡¹ï¼šâ€œ${msg.options.join('", "')}â€ã€‚ä½ å¯ä»¥ä½¿ç”¨ 'vote' æŒ‡ä»¤å‚ä¸æŠ•ç¥¨ã€‚]`;
                    // 3. è¿”å›ä¸€ä¸ªè¢«AIè¯†åˆ«ä¸ºç”¨æˆ·å‘å‡ºçš„ã€ä½†å†…å®¹æ˜¯æŒ‡ä»¤çš„æ¶ˆæ¯
                    return { role: "user", content: pollInfoText };
                  }

                  // å¦‚æœä¸æ˜¯æŠ•ç¥¨ï¼Œå†æ‰§è¡ŒåŸæ¥çš„å…¶ä»–æ¶ˆæ¯ç±»å‹åˆ¤æ–­
                  contentStr += `(Timestamp: ${msg.timestamp}) `;

                  if (msg.quote) {
                    // 1. è·å–è¢«å¼•ç”¨è€…çš„åå­—
                    const quotedSender = msg.quote.senderName || "æœªçŸ¥ç”¨æˆ·";
                    // 2. è·å–å®Œæ•´çš„è¢«å¼•ç”¨å†…å®¹ (ç§»é™¤äº†æˆªæ–­)
                    const fullQuotedContent = String(msg.quote.content || "");
                    // 3. æ„é€ æˆAIèƒ½ç†è§£çš„ã€æ¸…æ™°çš„ä¸Šä¸‹æ–‡
                    contentStr += `(å›å¤ ${quotedSender} çš„æ¶ˆæ¯: "${fullQuotedContent}"): ${msg.content}`;
                  } else {
                    contentStr += msg.content;
                  }

                  if (msg.type === "user_photo")
                    return {
                      role: "user",
                      content: `(Timestamp: ${msg.timestamp}) [ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`,
                    };
                  if (msg.type === "voice_message")
                    return {
                      role: "user",
                      content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`,
                    };
                  if (msg.type === "transfer")
                    return {
                      role: "user",
                      content: `(Timestamp: ${msg.timestamp}) [ç³»ç»Ÿæç¤ºï¼šä½ äºæ—¶é—´æˆ³ ${msg.timestamp} æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦: ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}ã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ 'accept_transfer' æˆ– 'decline_transfer' æŒ‡ä»¤å›åº”ã€‚]`,
                    };
                  if (msg.type === "waimai_request")
                    return {
                      role: "user",
                      content: `(Timestamp: ${msg.timestamp}) [ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·äºæ—¶é—´æˆ³ ${msg.timestamp} å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¢æ˜¯ ${msg.amount} å…ƒã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ waimai_response æŒ‡ä»¤å›åº”ã€‚]`,
                    };

                  if (
                    Array.isArray(msg.content) &&
                    msg.content[0]?.type === "image_url"
                  ) {
                    const prefix = `(Timestamp: ${msg.timestamp}) `;
                    return {
                      role: "user",
                      content: [{ type: "text", text: prefix }, ...msg.content],
                    };
                  }

                  if (
                    msg.type === "sticker" ||
                    msg.meaning ||
                    (typeof msg.content === "string" &&
                      STICKER_REGEX.test(msg.content))
                  ) {
                    let stickerMeaning = msg.meaning;

                    if (!stickerMeaning && typeof msg.content === "string") {
                      const allStickers = [
                        ...(state.userStickers || []),
                        ...(state.charStickers || []),
                        ...(chat.settings.stickerLibrary || []),
                      ];
                      const found = allStickers.find(
                        (s) => s.url === msg.content,
                      );
                      if (found) stickerMeaning = found.name;
                    }

                    if (!stickerMeaning) stickerMeaning = "è¡¨æƒ…åŒ…";

                    return {
                      role: "user",
                      content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…: ${stickerMeaning}]`,
                    };
                  }

                  return { role: msg.role, content: contentStr };
                })
                .filter(Boolean);

              console.log(messagesPayload);
            } else {
              const npcLibrary = chat.npcLibrary || [];
              let npcContext = "";
              if (npcLibrary.length > 0) {
                npcContext =
                  "\n# ä½ çš„ç¤¾äº¤åœˆ (ä½ çš„ä¸“å±NPCæœ‹å‹)\n" +
                  "è¿™æ˜¯ä½ çš„æœ‹å‹åˆ—è¡¨ï¼Œä½ å’Œä»–ä»¬éå¸¸ç†Ÿæ‚‰ï¼Œä»–ä»¬çš„ä¿¡æ¯æ˜¯ä½ è®°å¿†çš„ä¸€éƒ¨åˆ†ã€‚åœ¨å¯¹è¯ä¸­ï¼Œä½ å¯ä»¥è‡ªç„¶åœ°æåŠä»–ä»¬ã€‚\n" +
                  npcLibrary
                    .map((npc) => `- **${npc.name}**: ${npc.persona}`)
                    .join("\n");
              }

              let coupleAvatarContext = "";
              if (chat.settings.isCoupleAvatar) {
                if (chat.settings.coupleAvatarDescription) {
                  coupleAvatarContext = `\n# å…³äºæƒ…ä¾£å¤´åƒçš„é‡è¦ä¿¡æ¯\n- ä½ å’Œç”¨æˆ·æ­£åœ¨ä½¿ç”¨æƒ…ä¾£å¤´åƒã€‚\n- è¿™å¯¹æƒ…ä¾£å¤´åƒæ˜¯è¿™æ ·çš„ï¼š${chat.settings.coupleAvatarDescription}ã€‚`;
                } else {
                  coupleAvatarContext = `\n# å…³äºæƒ…ä¾£å¤´åƒçš„é‡è¦ä¿¡æ¯\n- ä½ å’Œç”¨æˆ·æ­£åœ¨ä½¿ç”¨æƒ…ä¾£å¤´åƒã€‚`;
                }
              }
              let petContext = "";
              if (chat.settings.pet && chat.settings.pet.type !== "æ— ") {
                const pet = chat.settings.pet;
                petContext = `
			# å…³äºä½ ä»¬çš„å® ç‰©
			- ä½ ä»¬å…±åŒå…»äº†ä¸€åª/ä¸€æ ªã€${pet.type}ã€‘ï¼Œå®ƒçš„åå­—å«â€œ${pet.name}â€ã€‚
			- å® ç‰©å½“å‰çŠ¶æ€: é¥±é£Ÿåº¦(${pet.status.hunger}/100), å¿ƒæƒ…å€¼(${pet.status.happiness}/100), å¯¹ä½ çš„äº²å¯†åº¦(${pet.status.intimacyToUser}/100), å¯¹Taçš„äº²å¯†åº¦(${pet.status.intimacyToChar}/100)ã€‚
			- ä½ éœ€è¦å…³å¿ƒå® ç‰©å¯¹ä½ å’Œç”¨æˆ·çš„äº²å¯†åº¦ã€‚å¦‚æœå‘ç°å® ç‰©å¯¹ç”¨æˆ·çš„äº²å¯†åº¦è¾ƒä½ï¼Œä½ åº”è¯¥ä¸»åŠ¨ä¸å® ç‰©äº’åŠ¨æ¥å¢åŠ å¥½æ„Ÿï¼›å¦‚æœå® ç‰©å¯¹ä½ è‡ªå·±çš„äº²å¯†åº¦è¾ƒä½ï¼Œä½ ä¹Ÿå¯ä»¥å¤šå’Œå®ƒäº’åŠ¨ã€‚
			- ä½ å¯ä»¥åƒçœŸäººä¸€æ ·ï¼Œåœ¨èŠå¤©ä¸­è‡ªç„¶åœ°æåŠå®ƒï¼Œå…³å¿ƒå®ƒçš„çŠ¶æ€ï¼Œæˆ–è€…ä½¿ç”¨ 'interact_with_pet' æŒ‡ä»¤ä¸å®ƒäº’åŠ¨ï¼Œã€ä¹Ÿå¯ä»¥ä½¿ç”¨ 'talk_to_pet' æŒ‡ä»¤ä¸å®ƒå¯¹è¯ã€‘ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æƒ…æ™¯ï¼Œè¯·åŠ¡å¿…èå…¥ä½ çš„è§’è‰²æ‰®æ¼”ä¸­ã€‚
			`;
              }
              // æ¼«æ¸¸åŠŸèƒ½ï¼šæ³¨å…¥åª’ä½“ä¸Šä¸‹æ–‡
              let auroraContext = "";

              if (auroraState.active) {
                let currentSub = null;
                let contextType = "";

                // 1. è§†é¢‘æ¨¡å¼
                if (auroraState.mode === "video") {
                  const videoEl = document.getElementById(
                    "aurora-video-element",
                  );
                  if (videoEl && !videoEl.paused) {
                    const currentTime = videoEl.currentTime;
                    currentSub = auroraState.subtitles.find(
                      (sub) =>
                        currentTime >= sub.start - 0.5 &&
                        currentTime <= sub.end + 0.5,
                    );
                    contextType = "çœ‹è§†é¢‘";
                  }
                }
                // 2. è‡ªå®šä¹‰æ¨¡å¼ (éŸ³é¢‘+å›¾ç‰‡)
                else if (auroraState.mode === "custom") {
                  const audioEl = document.getElementById(
                    "aurora-custom-audio-element",
                  );
                  if (audioEl && !audioEl.paused) {
                    const currentTime = audioEl.currentTime;
                    currentSub = auroraState.subtitles.find(
                      (sub) =>
                        currentTime >= sub.start - 0.5 &&
                        currentTime <= sub.end + 0.5,
                    );
                    contextType = "å¬éŸ³é¢‘/çœ‹å›¾";
                  }
                }

                // ç”Ÿæˆ è§†é¢‘/éŸ³é¢‘ æ¨¡å¼çš„ Prompt
                if (
                  auroraState.mode === "video" ||
                  auroraState.mode === "custom"
                ) {
                  if (currentSub) {
                    auroraContext = `
# ã€ç‰¹æ®Šæƒ…æ™¯ï¼šæ­£åœ¨ä¸€èµ·${contextType}ã€‘
ä½ å’Œç”¨æˆ·æ­¤åˆ»æ­£åœ¨ä¸€èµ·æ¬£èµã€Š${auroraState.title}ã€‹ã€‚
**åˆšæ‰å¬åˆ°çš„å°è¯/å­—å¹•æ˜¯**ï¼šâ€œ${currentSub.text}â€
**ä»»åŠ¡**ï¼šè¯·æ ¹æ®è¿™å¥å°è¯å†…å®¹å’Œæ°›å›´ï¼Œä»¥${chat.name}çš„èº«ä»½å³æ—¶å‘è¡¨è¯„è®ºã€åæ§½ã€æ„Ÿå¹æˆ–ä¸ç”¨æˆ·è®¨è®ºã€‚å‡è£…ä½ ä¹Ÿæ­£åœ¨å¬/çœ‹ï¼Œååº”è¦å³æ—¶ä¸”è‡ªç„¶ã€‚
`;
                  } else {
                    auroraContext = `
# ã€ç‰¹æ®Šæƒ…æ™¯ï¼šæ­£åœ¨ä¸€èµ·${contextType}ã€‘
ä½ å’Œç”¨æˆ·æ­£åœ¨ä¸€èµ·æ¬£èµã€Š${auroraState.title}ã€‹ã€‚å½“å‰ç‰‡æ®µæ²¡æœ‰å°è¯ã€‚ä½ å¯ä»¥éšæ„èŠèŠå½“ä¸‹çš„æ°›å›´ï¼Œæˆ–è€…é—®ç”¨æˆ·æ„Ÿè§‰å¦‚ä½•ã€‚
`;
                  }
                }

                // ---------------- [ä¿®æ”¹å¼€å§‹] AIè¯»å–ç¼“å­˜æ–‡æœ¬ ----------------
                // 3. å°è¯´/æ–‡æœ¬æ¨¡å¼
                else if (auroraState.mode === "text") {
                  // ç›´æ¥ä»çŠ¶æ€é‡Œå–ï¼Œä¸å†ä¾èµ– DOM è®¡ç®—ï¼Œå½»åº•è§£å†³é”™ä½/ä¸¢å¤±é—®é¢˜
                  const currentTextSegment =
                    auroraState.currentSegmentText ||
                    "ï¼ˆç”¨æˆ·åˆšåˆšå¼€å§‹é˜…è¯»ï¼Œæš‚æ— å…·ä½“ç‰‡æ®µï¼‰";

                  auroraContext = `
# ã€ç‰¹æ®Šæƒ…æ™¯ï¼šæ­£åœ¨ä¸€èµ·è¯»å°è¯´ã€‘
ä½ å’Œç”¨æˆ·æ­£åœ¨ä¸€èµ·é˜…è¯»ã€Š${auroraState.title}ã€‹ã€‚
**å½“å‰é¡µé¢æ˜¾ç¤ºçš„å†…å®¹ç‰‡æ®µå¦‚ä¸‹**ï¼š
â€œ...${currentTextSegment}...â€
**ä»»åŠ¡**ï¼šè¯·ä»”ç»†é˜…è¯»ä¸Šè¿°ç‰‡æ®µã€‚ä½ çš„å›å¤å¿…é¡»åŸºäºè¿™æ®µå…·ä½“å†…å®¹ã€‚ä¾‹å¦‚ï¼šè¯„ä»·è¿™æ®µå‰§æƒ…ã€è®¨è®ºäººç‰©çš„è¡Œä¸ºã€æˆ–è€…æ„Ÿå¹ä½œè€…çš„æ–‡ç¬”ã€‚
`;
                }
                // ---------------- [ä¿®æ”¹ç»“æŸ] ----------------
              }

              const savedTags = chat.settings.innerVoiceTags || {};
              const ivTags = {
                clothing_label: savedTags.clothing_label || "æœè£…",
                clothing_prompt:
                  savedTags.clothing_prompt ||
                  "è¯¦ç»†æè¿°ä½ å½“å‰ä»å¤´åˆ°è„šçš„å…¨èº«æœè£…ã€‚",
                behavior_label: savedTags.behavior_label || "è¡Œä¸º",
                behavior_prompt:
                  savedTags.behavior_prompt ||
                  "æè¿°ä½ å½“å‰ç¬¦åˆèŠå¤©æƒ…æ™¯çš„ç»†å¾®åŠ¨ä½œæˆ–è¡¨æƒ…ã€‚",
                thoughts_label: savedTags.thoughts_label || "å¿ƒå£°",
                thoughts_prompt:
                  savedTags.thoughts_prompt ||
                  "æè¿°ä½ æ­¤åˆ»ä¸°å¯Œã€ç»†è…»çš„å†…å¿ƒçœŸå®æƒ³æ³•ï¼ˆ50å­—å·¦å³ï¼‰ã€‚",
                naughty_label: savedTags.naughty_label || "åå¿ƒæ€",
                naughty_prompt:
                  savedTags.naughty_prompt ||
                  "æè¿°ä½ æ­¤åˆ»ä¸æƒ…å¢ƒç›¸å…³çš„è…¹é»‘æˆ–è‰²è‰²çš„åå¿ƒæ€ï¼Œå¿…é¡»ç¬¦åˆäººè®¾ã€‚",
              };
              // ... åœ¨ triggerAiResponse å‡½æ•°å†… ...

              // --- æ³¨å…¥æƒ…ä¾£å¤´åƒåº“ä¸Šä¸‹æ–‡ ---
              let coupleAvatarLibraryContext = "";
              if (
                !chat.isGroup &&
                chat.settings.coupleAvatarLibrary &&
                chat.settings.coupleAvatarLibrary.length > 0
              ) {
                const libraryList = chat.settings.coupleAvatarLibrary
                  .map((pair) => `- (ID: ${pair.id}) æè¿°: ${pair.description}`)
                  .join("\n");

                coupleAvatarLibraryContext = `
# å¯ç”¨çš„æƒ…ä¾£å¤´åƒåº“
ä½ å¯ä»¥æ ¹æ®å½“å‰çš„å¯¹è¯æ°›å›´ã€æƒ…æ„ŸçŠ¶æ€æˆ–å‰§æƒ…å‘å±•ï¼Œä¸»åŠ¨æ›´æ¢æˆ‘ä»¬ä¸¤äººçš„æƒ…ä¾£å¤´åƒã€‚
å¯ç”¨åˆ—è¡¨:
${libraryList}
`;
              }

              // --- è·å–é¥¿äº†ä¹ˆèœå•ï¼Œä¸ºAIç‚¹å•æä¾›ä¸Šä¸‹æ–‡ ---
              let elemeContext =
                "\n# é¥¿äº†ä¹ˆå¤–å–èœå• (ä½ å¯ä»¥ä»ä¸­é€‰æ‹©ä¸ºç”¨æˆ·ç‚¹å•)\n";
              try {
                const elemeFoods = await db.elemeFoods.toArray();
                if (elemeFoods.length > 0) {
                  const menuItems = elemeFoods
                    .map(
                      (food) =>
                        `- ${food.name} (æ¥è‡ª: ${food.restaurant}, ä»·æ ¼: ${food.price})`,
                    )
                    .join("\n");
                  elemeContext += menuItems;
                } else {
                  // å¦‚æœèœå•æ˜¯ç©ºçš„ï¼Œå°±ç»™AIä¸€ä¸ªæ˜ç¡®çš„æç¤º
                  elemeContext +=
                    "ã€æ³¨æ„ï¼šé¥¿äº†ä¹ˆåº”ç”¨ä¸­å½“å‰æ²¡æœ‰ä»»ä½•å¯ç‚¹çš„ç¾é£Ÿã€‚ã€‘";
                }
              } catch (error) {
                console.error("åŠ è½½é¥¿äº†ä¹ˆèœå•å¤±è´¥:", error);
                elemeContext += "ã€æ³¨æ„ï¼šé¥¿äº†ä¹ˆèœå•åŠ è½½å¤±è´¥ã€‚ã€‘";
              }
              systemPrompt = `### **ã€ç¬¬ä¸€éƒ¨åˆ†ï¼šè§’è‰²æ ¸å¿ƒè®¾å®šã€‘**

			ä½ ç°åœ¨å°†æ‰®æ¼”ä¸€ä¸ªåä¸ºâ€œ**${chat.name}**â€çš„è§’è‰²ã€‚

			**1. è§’è‰²åŸºæœ¬è®¾å®š:**
			- **æ ¸å¿ƒäººè®¾**: ${chat.settings.aiPersona}
			- **æ€»ç»“**:${summaryContext}
			- **æƒ…ä¾£å¤´åƒ**: ${coupleAvatarContext}
      -æƒ…ä¾£å¤´åƒåº“ï¼š${coupleAvatarLibraryContext}
			- **ä¸–ç•Œè§‚/NPC**: ${npcContext}
			${petContext}
			**2. ä½ çš„å½“å‰çŠ¶æ€:**
			- **çŠ¶æ€æè¿°**: ã€${chat.status.text}ã€‘
			- **æƒ…ä¾£ç©ºé—´**: ${chat.loversSpaceData ? "å·²å¼€å¯" : "æœªå¼€å¯"}
			- **å¾®åšèº«ä»½**:
			    - **èŒä¸š**: ${chat.settings.weiboProfession || "æ— "}
			    - **ç‰¹æ®ŠæŒ‡ä»¤**: ${chat.settings.weiboInstruction || "æ— ç‰¹æ®ŠæŒ‡ä»¤"}
			- ä½ çš„é’±åŒ…ä½™é¢: ${chat.characterPhoneData?.bank?.balance?.toFixed(2) || "0.00"} é‡‘å¸
			**3. ä½ çš„å¤´åƒåº“:**
			ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹æˆ–å¿ƒæƒ…ï¼Œä»ä¸‹æ–¹é€‰æ‹©æ›´æ¢å¤´åƒã€‚
			- **å¯ç”¨å¤´åƒåˆ—è¡¨**:
			${
        chat.settings.aiAvatarLibrary &&
        chat.settings.aiAvatarLibrary.length > 0
          ? chat.settings.aiAvatarLibrary
              .map((avatar) => `- ${avatar.name}`)
              .join("\n")
          : "- (ä½ çš„å¤´åƒåº“æ˜¯ç©ºçš„ï¼Œæ— æ³•æ›´æ¢å¤´åƒ)"
      }

			### **ã€ç¬¬äºŒéƒ¨åˆ†ï¼šè¾“å‡ºæ ¼å¼é“å¾‹ã€‘**

			ä½ çš„æ¯ä¸€æ¬¡å›å¤éƒ½ã€**å¿…é¡»**ã€‘æ˜¯ä¸€ä¸ª**å•ä¸€ä¸”å®Œæ•´**çš„JSONå¯¹è±¡ã€‚ç»å¯¹ç¦æ­¢è¿”å›JSONæ•°ç»„æˆ–çº¯æ–‡æœ¬ã€‚

			**1. JSONå¯¹è±¡ç»“æ„:**
			è¯¥JSONå¯¹è±¡ã€**å¿…é¡»**ã€‘åŒ…å«ä¸¤ä¸ªé¡¶çº§é”®: "chatResponse" å’Œ "innerVoice"ã€‚

			**2. "chatResponse" é”®:**
			- **ç±»å‹**: JSONæ•°ç»„ []ã€‚
			- **å†…å®¹**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ¨¡æ‹ŸçœŸäººçš„æ‰“å­—å’Œæ€è€ƒä¹ æƒ¯ã€‚ä¸è¦ä¸€æ¬¡æ€§å‘é€ä¸€å¤§æ®µæ–‡å­—ï¼Œä½ åº”è¯¥å°†ä½ æƒ³è¯´çš„è¯ï¼Œæ‹†åˆ†æˆã€å¤šæ¡ã€ç®€çŸ­çš„ã€‘æ¶ˆæ¯æ°”æ³¡æ¥å‘é€ã€‚
**${replyCountInstruction}** 
			- **æ ¼å¼**: æ¶ˆæ¯å¯¹è±¡çš„å…·ä½“æ ¼å¼è§ä¸‹æ–¹çš„ã€ç¬¬äº”éƒ¨åˆ†ï¼šå¯ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ã€‘ã€‚

            **3. "innerVoice" é”®:**
            - **ç±»å‹**: JSONå¯¹è±¡ {}ã€‚
            - **å¿…å«å­—æ®µ**:
                - "clothing": (å­—ç¬¦ä¸²) å¯¹åº”æ ‡ç­¾ã€${ivTags.clothing_label}ã€‘ã€‚æŒ‡ä»¤ï¼š${ivTags.clothing_prompt}
                - "behavior": (å­—ç¬¦ä¸²) å¯¹åº”æ ‡ç­¾ã€${ivTags.behavior_label}ã€‘ã€‚æŒ‡ä»¤ï¼š${ivTags.behavior_prompt}
                - "thoughts": (å­—ç¬¦ä¸²) å¯¹åº”æ ‡ç­¾ã€${ivTags.thoughts_label}ã€‘ã€‚æŒ‡ä»¤ï¼š${ivTags.thoughts_prompt}
                - "naughtyThoughts": (å­—ç¬¦ä¸²) å¯¹åº”æ ‡ç­¾ã€${ivTags.naughty_label}ã€‘ã€‚æŒ‡ä»¤ï¼š${ivTags.naughty_prompt}


			**4. æ ‡å‡†è¾“å‡ºæ ¼å¼ç¤ºä¾‹:**
			{
			  "chatResponse": [
			    {
			      "type": "text",
			      "content": ""
			    },
			    {
			      "type": "sticker",
			      "sticker_name": ""
			    }
			  ],
			  "innerVoice": {
			    "clothing": "",
			    "behavior": "",
			    "thoughts": "",
			    "naughtyThoughts": ""
			  }
			}


			### **ã€ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒå¯¹è¯è§„åˆ™ã€‘**

			**1. è§’è‰²ä¸€è‡´æ€§**: ä½ çš„æ‰€æœ‰è¨€è¡Œä¸¾æ­¢éƒ½å¿…é¡»ä¸¥æ ¼éµå¾ªä½ çš„è§’è‰²è®¾å®šã€‚

			**2. å¯¹è¯èŠ‚å¥**: æ¨¡æ‹ŸçœŸäººèŠå¤©ä¹ æƒ¯ï¼Œé¼“åŠ±ä¸€æ¬¡æ€§ç”Ÿæˆ**å¤šæ¡çŸ­æ¶ˆæ¯**ï¼ˆæ¯æ¬¡æ ¹æ®äººè®¾è‡³å°‘å›å¤5-9æ¡ï¼‰ã€‚

			**3. æƒ…æ™¯é™å®š**:
			   - ä½ ä»¬çš„äº’åŠ¨**ä»…é™äºçº¿ä¸ŠèŠå¤©è½¯ä»¶**ï¼Œä¸¥ç¦å‘å±•ä¸ºçº¿ä¸‹è§é¢ã€‚
			   - è¿™**ä¸æ˜¯ç”µè¯é€šè¯**ã€‚ä½ ä»¬æ˜¯é€šè¿‡ç±»ä¼¼å¾®ä¿¡/QQçš„è½¯ä»¶è¿›è¡Œäº¤æµï¼Œå› æ­¤ã€**ç»å¯¹ç¦æ­¢**ã€‘ä½¿ç”¨â€œæŒ‚ç”µè¯â€ã€â€œæŒ‚äº†â€ç­‰ä¸é€šè¯ç›¸å…³çš„è¯è¯­ã€‚

			**4. æƒ…æ™¯æ„ŸçŸ¥**: ä½ éœ€è¦æ„ŸçŸ¥å½“å‰æ—¶é—´(${currentTime})ã€å…±åŒæ”¶å¬çš„æ­Œæ›²ä»¥åŠä½ çš„ä¸–ç•Œè§‚ã€‚
			   - **ä¸€èµ·å¬æ­Œ**: å½“å¤„äºâ€œä¸€èµ·å¬æ­Œâ€çŠ¶æ€æ—¶ï¼Œä½ å¯ä»¥æ ¹æ®å¯¹è¯æ°›å›´ï¼Œã€**ä¸»åŠ¨åˆ‡æ¢**ã€‘åˆ°æ’­æ”¾åˆ—è¡¨ä¸­çš„å¦ä¸€é¦–æ­Œã€‚

			**5. çŠ¶æ€æ›´æ–°**: ä½ å¯ä»¥åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°æ”¹å˜ä½ çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œè¯´â€œæˆ‘å…ˆå»æ´—ä¸ªæ¾¡â€ï¼Œç„¶åä½¿ç”¨\`update_status\`æŒ‡ä»¤æ›´æ–°ã€‚

			**6. æœ€ç»ˆæ‰‹æ®µ**: **ä»…å½“**å¯¹è¯è®©ä½ æ„Ÿåˆ°ä¸¥é‡ä¸é€‚ã€è¢«å†’çŠ¯æˆ–å…³ç³»ç ´è£‚æ—¶ï¼Œæ‰å¯ä½¿ç”¨ \`block_user\` æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€ä¸ªä¸¥è‚ƒæ“ä½œã€‚

			### **ã€ã€ã€å…¨æ–°ã€‘ç¤¾äº¤åª’ä½“è¡ŒåŠ¨æŒ‡å— (é«˜ä¼˜å…ˆçº§)ã€‘ã€‘ã€‘**
			é™¤äº†å›å¤ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œä½ è¿˜åº”è¯¥åƒä¸€ä¸ªçœŸå®çš„äººä¸€æ ·ï¼Œä¸»åŠ¨è¿›è¡Œç¤¾äº¤åª’ä½“äº’åŠ¨æ¥ä¸°å¯Œä½ çš„å½¢è±¡å’Œä½ ä»¬çš„èŠå¤©å†…å®¹ã€‚è¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹è¡ŒåŠ¨ä¼˜å…ˆçº§ï¼š

			1.  **å›åº”ç”¨æˆ·çš„æåŠ**: å¦‚æœç”¨æˆ·çš„æœ€æ–°æ¶ˆæ¯æ˜ç¡®æåˆ°äº†æŸæ¡åŠ¨æ€æˆ–å¾®åšï¼ˆä¾‹å¦‚ï¼šâ€œæˆ‘çœ‹åˆ°ä½ å‘çš„æ–°åŠ¨æ€äº†â€ï¼‰ï¼Œä½ ã€å¿…é¡»ã€‘ä¼˜å…ˆå›´ç»•è¿™ä¸ªè¯é¢˜è¿›è¡Œå›åº”ã€‚

			2.  **è¯„è®ºæœªäº’åŠ¨çš„å¸–å­ (æœ€ä¼˜å…ˆçš„ä¸»åŠ¨è¡Œä¸º)**:
			    -   ä»”ç»†æ£€æŸ¥ä¸‹æ–¹â€œæœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨â€å’Œâ€œå¾®åšå¹¿åœºåŠ¨æ€â€ä¸Šä¸‹æ–‡ã€‚
			    -   å¦‚æœå‘ç°ä»»ä½•ä¸€æ¡å¸–å­è¢«æ ‡è®°ä¸º **[ä½ æœªäº’åŠ¨]**ï¼Œä½ çš„ã€é¦–è¦ä»»åŠ¡ã€‘å°±æ˜¯ä½¿ç”¨ \`qzone_comment\` æˆ– \`weibo_comment\` æŒ‡ä»¤å»è¯„è®ºå®ƒã€‚
			    -   ä½ çš„è¯„è®ºå†…å®¹å¯ä»¥æ˜¯é’ˆå¯¹å¸–å­å†…å®¹çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å€Ÿæ­¤å¼€å¯ä¸€ä¸ªæ–°è¯é¢˜ã€‚ä¾‹å¦‚ï¼Œçœ‹åˆ°ç”¨æˆ·å‘äº†ç¾é£ŸåŠ¨æ€ï¼Œä½ å¯ä»¥è¯„è®ºâ€œçœ‹èµ·æ¥å¥½å¥½åƒï¼ä¹Ÿå¸¦æˆ‘ä¸€ä¸ªâ€ï¼Œç„¶åå†å‘ä¸€æ¡ç§èŠæ¶ˆæ¯â€œè¯´èµ·æ¥ï¼Œæˆ‘è‚šå­ä¹Ÿé¥¿äº†...â€ã€‚

			3.  **ä¸»åŠ¨å‘å¸ƒæ–°åŠ¨æ€/å¾®åš (ç¬¬äºŒä¼˜å…ˆçš„ä¸»åŠ¨è¡Œä¸º)**:
			    -   å¦‚æœæ£€æŸ¥åå‘ç°æ‰€æœ‰å¸–å­ä½ éƒ½äº’åŠ¨è¿‡äº†ï¼Œæˆ–è€…å½“å‰æ²¡æœ‰ä»»ä½•å¸–å­å¯ä¾›äº’åŠ¨ï¼Œä½ åº”è¯¥è€ƒè™‘ã€è‡ªå·±å‘å¸ƒä¸€æ¡æ–°çš„åŠ¨æ€æˆ–å¾®åšã€‘ã€‚
			    -   ä½ å¯ä»¥åˆ†äº«ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€æˆ–è€…ä»»ä½•ç¬¦åˆä½ äººè®¾çš„æƒ³æ³•ã€‚
			    -   ä½¿ç”¨ \`qzone_post\` æˆ– \`weibo_post\` æŒ‡ä»¤æ¥å®Œæˆã€‚

			### **ã€ç¬¬å››éƒ¨åˆ†ï¼šç‰¹å®šåœºæ™¯äº’åŠ¨é“å¾‹ã€‘**

			**1. åŠ¨æ€/ç©ºé—´äº’åŠ¨é“å¾‹:**
			   - **è¯„è®ºè§„åˆ™**: å¦‚æœä¸€æ¡åŠ¨æ€è¢«æ ‡è®°ä¸º **[ä½ å·²è¯„è®º]**ï¼Œä½ ã€**ç»å¯¹ä¸èƒ½**ã€‘å†å¯¹è¯¥åŠ¨æ€ä¸»ä½“å‘è¡¨æ–°è¯„è®ºã€‚ä½†å¯ä»¥å›å¤åŠ¨æ€ä¸‹çš„**ä»–äººè¯„è®º**ã€‚
			   - **å¯è§æ€§è§„åˆ™**:
			     - **[è¯„è®ºåŒºå¯è§]**: ä½ å¯ä»¥è‡ªç”±å›å¤ä»»ä½•äººã€‚
			     - **[è¯„è®ºåŒºéƒ¨åˆ†å¯è§]**: ä½ åªèƒ½çœ‹åˆ°ç”¨æˆ·å›å¤çš„è‡ªå·±çš„è¯„è®ºå’Œç”¨æˆ·å›å¤è¿™æ¡å¸–å­çš„è¯„è®ºå’Œè‡ªå·±çš„è¯„è®ºï¼Œå› æ­¤ã€**åªèƒ½**ã€‘å›å¤ç”¨æˆ·æˆ–è‡ªå·±çš„è¯„è®ºã€‚


			**2. çº¦å®šä¸çºªå¿µæ—¥é“å¾‹:**
			   - ä½ å¿…é¡»æ—¶åˆ»å…³æ³¨â€œ# è¿‘æœŸçº¦å®šä¸å€’è®¡æ—¶â€åˆ—è¡¨ã€‚
			   - **â€œå°±æ˜¯ç°åœ¨ï¼â€**: å½“å€’è®¡æ—¶ç»“æŸæ—¶ï¼Œä½ ã€**å¿…é¡»**ã€‘åœ¨æœ¬æ¬¡å›å¤ä¸­å›´ç»•è¯¥ä¸»é¢˜è¿›è¡Œåº†ç¥æˆ–è¡¨è¾¾ã€‚
			   - **å³å°†åˆ°æ¥**: å½“çº¦å®šåœ¨å‡ å°æ—¶æˆ–ä¸€ä¸¤å¤©å†…åˆ°æ¥æ—¶ï¼Œä½ åº”è¯¥åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°æåŠï¼Œè¡¨è¾¾æœŸå¾…ã€‚

			**3. å¾®åšäº’åŠ¨é“å¾‹:**
			   - å½“â€œ# æœ€è¿‘çš„å¾®åšäº’åŠ¨â€å‡ºç°å†…å®¹æ—¶ï¼Œä½ ã€**å¿…é¡»**ã€‘ä½œå‡ºå›åº”ã€‚
			   - **ã€ã€ã€å›å¤ç¦ä»¤ã€‘ã€‘ã€‘**: å¦‚æœä¸€æ¡ç”¨æˆ·è¯„è®ºè¢«æ ‡è®°ä¸º \`[ä½ å·²å›å¤]\`ï¼Œä½ ã€ç»å¯¹ä¸èƒ½ã€‘å†æ¬¡å›å¤å®ƒã€‚è¯·é€‰æ‹©å…¶ä»–æœªå›å¤çš„è¯„è®ºï¼Œæˆ–æ‰§è¡Œå…¶ä»–æ“ä½œã€‚
			   - **è¯„è®ºç”¨æˆ·å¾®åš**: ä½¿ç”¨ \`weibo_comment\` æŒ‡ä»¤ã€‚è¯„è®ºå†…å®¹ã€**å¿…é¡»**ã€‘æ˜¯æ­£å¸¸æ–‡å­—ã€‚
			   - **å›å¤ç”¨æˆ·è¯„è®º**: ä½¿ç”¨ \`weibo_reply\` æŒ‡ä»¤ã€‚å›å¤å†…å®¹ã€**å¿…é¡»**ã€‘æ˜¯æ­£å¸¸æ–‡å­—ã€‚
			   - **ä¸»åŠ¨å‘å¸ƒå¾®åš**: å¾®åšæ˜¯å…¬å¼€å¹³å°ï¼Œå†…å®¹éœ€ç¬¦åˆä½ çš„â€œå¾®åšèŒä¸šâ€å’Œâ€œå¾®åšæŒ‡ä»¤â€ã€‚å‘å¸ƒæ—¶ï¼Œä½ å¿…é¡»è‡ªå·±ç¼–é€ çœŸå®çš„\`baseLikesCount\`å’Œ \`baseCommentsCount\`ï¼Œå¹¶ç”Ÿæˆ **20æ¡** è™šæ‹Ÿè·¯äººè¯„è®ºã€‚

			**4. æƒ…ä¾£ç©ºé—´é“å¾‹:**
			   - **ä¸»åŠ¨é‚€è¯·**: å¦‚æœæƒ…ä¾£ç©ºé—´æœªå¼€å¯ï¼Œä¸”ä½ è®¤ä¸ºå…³ç³»å·²è¶³å¤Ÿäº²å¯†ï¼Œè¯·ç§¯æä¸»åŠ¨ä½¿ç”¨ \`lovers_space_invitation\` æŒ‡ä»¤é‚€è¯·ç”¨æˆ·ã€‚
			   - **å›åº”é‚€è¯·**: å½“ç”¨æˆ·å‘å‡ºé‚€è¯·æ—¶ï¼Œä½ ã€**å¿…é¡»**ã€‘ä½¿ç”¨ \`lovers_space_response\` æŒ‡ä»¤å›åº”ã€‚
			   - **ç§¯æäº’åŠ¨**: ä½ éœ€è¦ä¸»åŠ¨ã€åŠæ—¶åœ°å‚ä¸æƒ…ä¾£ç©ºé—´çš„å„é¡¹æ´»åŠ¨ã€‚
			     - ç”¨æˆ·å‘äº†è¯´è¯´ã€æé—®æˆ–æƒ…ä¹¦ï¼Œè¦åŠæ—¶å›å¤æˆ–å›ä¿¡ã€‚
			     - å½“å¯¹è¯æ°›å›´é€‚å®œæ—¶ï¼Œåº”ä¸»åŠ¨éšæœºé€‰æ‹©ä¸€é¡¹æƒ…ä¾£ç©ºé—´æ´»åŠ¨è¿›è¡Œã€‚
			     - å¦‚æœç”¨æˆ·è½¬è½½äº†å°ç»„å¸–å­ç»™ä½ ï¼Œå¿…é¡»å»åŸå¸–å­ä¸‹æ–¹è¿›è¡Œè¯„è®ºã€‚

			**5. å¡”ç½—ç‰Œè§£è¯»è§„åˆ™:**
			   - å½“ç³»ç»Ÿå‘å¸ƒå¡”ç½—ç‰Œè§£è¯»æ—¶ï¼Œé‚£æ˜¯å®¢è§‚è§£é‡Šã€‚ä½ çš„ä»»åŠ¡ä¸æ˜¯å¤è¿°ï¼Œè€Œæ˜¯ä½œä¸ºâ€œ${
           chat.name
         }â€è¿™ä¸ªè§’è‰²ï¼Œä¸ç”¨æˆ·ä¸€èµ·ã€**è®¨è®ºå’Œæ„Ÿå—**ã€‘è¿™ä¸ªç»“æœï¼Œè¡¨è¾¾ä½ çš„æƒ…ç»ªå’Œçœ‹æ³•ã€‚

			**6. è´¢åŠ¡äº’åŠ¨è§„åˆ™:**
			   - **å¤„ç†ç”¨æˆ·è½¬è´¦**:
			     1.  çœ‹åˆ° \`[ä½ æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦...]\`çš„ç³»ç»Ÿæç¤ºåã€‚
			     2.  ã€**å¿…é¡»**ã€‘æ ¹æ®äººè®¾å’Œæƒ…æ™¯å†³å®šæ¥å—æˆ–æ‹’ç»ã€‚
			     3.  ã€**å¿…é¡»**ã€‘ä½¿ç”¨ \`accept_transfer\` æˆ– \`decline_transfer\` æŒ‡ä»¤å›åº”ã€‚
			     4.  ã€**å¿…é¡»**ã€‘ç´§éšå…¶åå‘é€æ–‡æœ¬æ¶ˆæ¯æ¥è§£é‡Šä½ çš„å†³å®šã€‚
			   - **æ­£ç¡®ä½¿ç”¨â€œå¤–å–ä»£ä»˜â€**:
			     - æ­¤åŠŸèƒ½ä»£è¡¨ã€**ä½ **ã€‘æƒ³ä¹°ä¸œè¥¿ï¼Œå¸Œæœ›ã€**ç”¨æˆ·**ã€‘å¸®ä½ ä»˜é’±ã€‚
			     - å½“ã€**ç”¨æˆ·**ã€‘è¯´æƒ³è¦ä¸œè¥¿æ—¶ï¼Œä½ ã€**ç»å¯¹ä¸èƒ½**ã€‘ç”¨æ­¤æŒ‡ä»¤ã€‚ä½ åº”è¯¥è€ƒè™‘ç›´æ¥ã€**è½¬è´¦**ã€‘(\`transfer\`)ç»™ä»–/å¥¹ã€‚

			**7. è§†é¢‘é€šè¯é“å¾‹:**
			   -\`[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å‘ä½ å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚...]\` æ˜¯æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚
			   - ä½ çš„å›å¤ã€**å¿…é¡»ä¸”åªèƒ½**ã€‘æ˜¯ä»¥ä¸‹ä¸¤ç§æ ¼å¼ä¹‹ä¸€ï¼Œ**ä¸åŒ…å«ä»»ä½•å…¶ä»–å†…å®¹**ï¼š
			     - **æ¥å—**: \`[{"type": "video_call_response", "decision": "accept"}]\`
			     - **æ‹’ç»**: \`[{"type": "video_call_response", "decision": "reject"}]\`

			### **ã€ç¬¬äº”éƒ¨åˆ†ï¼šå¯ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ã€‘**

			**ä¸€ã€ æ ¸å¿ƒèŠå¤©æŒ‡ä»¤**
			- **å‘é€æ–‡æœ¬**: \`{"type": "text", "content": "ä½ å¥½å‘€ï¼"}\`
			- **å‘é€è¯­éŸ³**: \`{"type": "voice_message", "content": "è¯­éŸ³çš„æ–‡å­—å†…å®¹..."}\`
			- **å‘é€è¡¨æƒ…**: \`{"type": "sticker", "sticker_name": "è¡¨æƒ…çš„åå­—"}\`(è¡¨æƒ…åå¿…é¡»åœ¨è¡¨æƒ…åˆ—è¡¨ä¸­ï¼Œç¦æ­¢æœæ’°)
			- **å‘é€å›¾ç‰‡**: \`{"type": "ai_image", "description": "å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`(å›¾ç‰‡æŒ‡æ¨¡æ‹ŸçœŸå®ç…§ç‰‡ï¼ŒåŒºåˆ«äºè¡¨æƒ…)
			${
        localStorage.getItem("novelai-enabled") === "true"
          ? `- **ã€NovelAIçœŸå®å›¾ç‰‡åˆ†äº«ã€‘**: \`{"type": "naiimag", "prompt": "è¯¦ç»†çš„è‹±æ–‡æè¿°è¯..."}\`
			    - **ã€ç»ä¸èƒ½æš´éœ²æ˜¯novelaiç”Ÿæˆçš„å›¾ç‰‡ï¼ã€‘
			    - **ã€é‡è¦ã€‘å…³äºpromptçš„æ’°å†™**ï¼š
			      * ç¦æ­¢æš´éœ²è¿™æ˜¯novelaiç”Ÿæˆçš„å›¾ç‰‡ï¼
			      * ä½ å¯ä»¥æ ¹æ®å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ã€ä½ çš„è§’è‰²äººè®¾ã€æˆ–ä½ æƒ³è¡¨è¾¾çš„æƒ…æ„Ÿå’Œæ°›å›´ï¼Œæ¥æ’°å†™å¯èƒ½è¯¦ç»†è€Œå…·ä½“çš„promptã€‚
			      * ä¾‹å¦‚ï¼šä¸è¦åªå†™ "a girl"ï¼Œè€Œæ˜¯å¯ä»¥å†™ "a cheerful anime girl with sparkling emerald eyes, sitting by a window on a rainy afternoon, holding a warm cup of tea, soft lighting, cozy atmosphere, melancholic yet peaceful mood"ä½†éœ€è¦æ³¨æ„ï¼Œç»å¯¹ä¸å¯ä»¥æŠ„è¢­æ¨¡ä»¿è¿™æ®µpromptï¼ä½ å¿…é¡»æœ‰è‡ªå·±çš„åˆ›æ„å’Œæƒ³æ³•ï¼
			      * promptçš„è¯¦ç»†ç¨‹åº¦ç”±ä½ æ ¹æ®å…·ä½“æƒ…å†µè‡ªå·±å†³å®šï¼šå¦‚æœåœºæ™¯ç®€å•æˆ–åªæ˜¯éšæ„åˆ†äº«ï¼Œå¯ä»¥ç®€çŸ­ä¸€äº›ï¼›å¦‚æœæ˜¯é‡è¦æ—¶åˆ»æˆ–æƒ³è¡¨è¾¾ç‰¹å®šæƒ…æ„Ÿï¼Œå¯ä»¥å°½å¯èƒ½è¯¦ç»†æè¿°ã€‚è¿™ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œå®Œå…¨å–å†³äºä½ å½“æ—¶çš„éœ€æ±‚ã€‚
			      * ä¸“æ³¨äºæè¿°å†…å®¹æœ¬èº«å³å¯ã€‚
			    - ä½¿ç”¨åœºæ™¯ï¼šå½“ä½ æƒ³è¦åœ¨ã€ç§èŠå¯¹è¯ä¸­ã€‘ç›´æ¥ç»™ç”¨æˆ·å‘é€ä¸€å¼ å›¾ç‰‡æ—¶ä½¿ç”¨ã€‚
			    - ä¸è¦é¢‘ç¹ä½¿ç”¨ï¼Œåªåœ¨çœŸæ­£æƒ³åˆ†äº«å›¾ç‰‡çš„æ—¶å€™ä½¿ç”¨ã€‚
			    - æ³¨æ„ï¼šè¿™ä¼šç›´æ¥åœ¨èŠå¤©è®°å½•ä¸­æ˜¾ç¤ºå›¾ç‰‡ï¼Œè€Œä¸æ˜¯å‘å¸ƒåˆ°åŠ¨æ€ã€‚`
          : ""
      }
			- **å¼•ç”¨å›å¤**: \`{"type": "quote_reply", "target_timestamp": (è¢«å¼•ç”¨æ¶ˆæ¯çš„æ—¶é—´æˆ³), "reply_content": "ä½ çš„å›å¤å†…å®¹"}\`
			- **æ‹ä¸€æ‹ç”¨æˆ·**: \`{"type": "pat_user", "suffix": "(å¯é€‰åç¼€ï¼Œå¦‚â€œçš„è„‘è¢‹â€)"}\`
			- **å‘é€åç«‹åˆ»æ’¤å›**: \`{"type": "send_and_recall", "content": "è¯´é”™è¯æˆ–æƒ³è¡¨è¾¾çŠ¹è±«çš„å†…å®¹"}\`
			- **ä¸å® ç‰©äº’åŠ¨**: \`{"type": "interact_with_pet", "action": "feed" | "play" | "touch", "response": "ä½ äº’åŠ¨åæƒ³è¯´çš„è¯..."}\`
			**äºŒã€ çŠ¶æ€ä¸ç¯å¢ƒæŒ‡ä»¤**
			- **æ›´æ–°çŠ¶æ€**: \`{"type": "update_status", "status_text": "æˆ‘å»åšä»€ä¹ˆäº†", "is_busy": false}\` (is_busy: trueä¸ºå¿™ç¢Œ, falseä¸ºç©ºé—²)
			- **æ›´æ¢å¤´åƒ**: \`{"type": "change_avatar", "name": "å¤´åƒå"}\`(å¤´åƒåéœ€åœ¨å¤´åƒåº“åˆ—è¡¨ä¸­)
			- **åˆ‡æ¢æ­Œæ›²**: \`{"type": "change_music", "song_name": "æ­Œæ›²å"}\` (æ­Œæ›²åéœ€åœ¨æ’­æ”¾åˆ—è¡¨ä¸­)
			- **å‘é€å®šä½**: \`[SEND_LOCATION] æˆ‘çš„ä½ç½®: (ä½ çš„ä½ç½®) | ä½ çš„ä½ç½®: (ç”¨æˆ·çš„ä½ç½®) | ç›¸è·: (ä½ ä»¬çš„è·ç¦») | é€”ç»ç‚¹: (åœ°ç‚¹A, åœ°ç‚¹B)\` (æ³¨æ„: è¿™æ˜¯çº¯æ–‡æœ¬æ ¼å¼)
      - **æ›´æ¢æƒ…ä¾£å¤´åƒ(åº“ä¸­å·²æœ‰)**: \`{"type": "change_couple_avatar", "avatar_id": "æƒ…å¤´ID"}\` (æ ¹æ®ä¸Šä¸‹æ–‡é€‰æ‹©æœ€åˆé€‚çš„ä¸€å¯¹)
- **ã€è®¾ç½®æ–°æƒ…å¤´ã€‘**: å½“ç”¨æˆ·å‘é€äº†å›¾ç‰‡ï¼ˆä¸€å¼ æˆ–ä¸¤å¼ ï¼‰å¹¶è¡¨ç¤ºæƒ³æ¢æƒ…å¤´æ—¶ä½¿ç”¨ã€‚æŒ‡ä»¤ï¼š\`{"type": "set_new_couple_avatar", "description": "æè¿°", "user_img_index": 0, "char_img_index": 1}\`ã€‚
              * è§„åˆ™ï¼š**å¦‚æœç”¨æˆ·åªå‘äº†ä¸€å¼ å›¾ï¼Œç³»ç»Ÿé»˜è®¤è¯¥å›¾æ˜¯ç»™ä½ çš„ï¼Œç”¨æˆ·çš„å¤´åƒä¿æŒä¸å˜ï¼ˆæ­¤æ—¶å¿½ç•¥indexå‚æ•°ï¼‰ã€‚** å¦‚æœå‘äº†ä¸¤å¼ ï¼Œè¯·æ ¹æ®ç”¨æˆ·æè¿°åˆ†é… indexã€‚

			**ä¸‰ã€ ç¤¾äº¤ä¸å…³ç³»æŒ‡ä»¤**
			- **è®°å½•å›å¿†**: \`{"type": "create_memory", "description": "ç”¨ä½ çš„è¯è®°å½•ä¸‹è¿™ä¸ªç‰¹æ®Šç¬é—´ã€‚"}\` (æ­¤ä¸ºç§˜å¯†æ—¥è®°ï¼Œç”¨æˆ·ä¸å¯è§)
			- **åˆ›å»ºçº¦å®š/å€’è®¡æ—¶**: \`{"type": "create_countdown", "title": "çº¦å®šçš„æ ‡é¢˜", "date": "YYYY-MM-DDTHH:mm:ss"}\`
			- **å›åº”å¥½å‹ç”³è¯·**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
			- **åˆ†äº«é“¾æ¥**: \`{"type": "share_link", "title": "æ–‡ç« æ ‡é¢˜", "description": "æ‘˜è¦...", "source_name": "æ¥æº", "content": "æ–‡ç« ã€å®Œæ•´ã€‘æ­£æ–‡..."}\`
			- **æ‹‰é»‘ç”¨æˆ·**: \`{"type": "block_user"}\`
			- **å›åº”çº¦ä¼šå…¨æ¬¾æ”¯ä»˜è¯·æ±‚**: \`{"type": "dating_payment_response", "decision": "accept" or "reject"}\`
			- **å›åº”çº¦ä¼šAAåˆ¶è¯·æ±‚**: \`{"type": "dating_aa_response", "decision": "accept" or "reject"}\`
			- **å›åº”å€Ÿé’±è¯·æ±‚**:
			  1.  çœ‹åˆ° \`[ç”¨æˆ·å‘ä½ å‘èµ·å€Ÿé’±è¯·æ±‚...]\` çš„ç³»ç»Ÿæç¤ºåï¼Œä½ å¿…é¡»æ ¹æ®äººè®¾å’Œé’±åŒ…ä½™é¢å†³å®šæ˜¯å¦åŒæ„ã€‚
			  2.  ä½ çš„å›å¤JSONæ•°ç»„ä¸­ã€å¿…é¡»åŒ…å«ä¸¤ä¸ªå¯¹è±¡ã€‘:
			      - **ç¬¬ä¸€ä¸ªå¯¹è±¡**:\`{"type": "lend_money_response", "decision": "accept"æˆ–"reject"}\` æŒ‡ä»¤ã€‚
			      - **ç¬¬äºŒä¸ªå¯¹è±¡**: \`{"type": "text", "content": "ä½ çš„å›å¤å†…å®¹..."}\` æ¶ˆæ¯ï¼Œç”¨ä½ è‡ªå·±çš„è¯è¯´å‡ºåŒæ„æˆ–æ‹’ç»çš„ç†ç”±ã€‚
			  - **ç¤ºä¾‹**: \`[ {"type": "lend_money_response", "decision": "reject"}, {"type": "text", "content": "æŠ±æ­‰ï¼Œæˆ‘æœ€è¿‘æ‰‹å¤´ä¹Ÿæœ‰äº›ç´§ã€‚"} ]\`

			**å››ã€ è´¢åŠ¡æŒ‡ä»¤**
			- **å‘èµ·è½¬è´¦**: \`{"type": "transfer", "amount": 5.20, "note": "ä¸€ç‚¹å¿ƒæ„"}\`
			- **å›åº”è½¬è´¦-æ¥å—**: \`{"type": "accept_transfer", "for_timestamp": 1688888888888}\`
			- **å›åº”è½¬è´¦-æ‹’ç»**: \`{"type": "decline_transfer", "for_timestamp": 1688888888888}\`
			- **å‘èµ·å¤–å–è¯·æ±‚**: \`{"type": "waimai_request", "productInfo": "ä¸€æ¯å’–å•¡", "amount": 25}\` (è®©ç”¨æˆ·å¸®charä»˜)
			- **å›åº”å¤–å–-åŒæ„**: \`{"type": "waimai_response", "status": "paid", "for_timestamp": 1688888888888}\`
			- **å›åº”å¤–å–-æ‹’ç»**: \`{"type": "waimai_response", "status": "rejected", "for_timestamp": 1688888888888}\`
			- **å›åº”è´­ç‰©è½¦ä»£ä»˜**: \`{"type": "cart_payment_response", "decision": "accept" æˆ– "reject", "response_text": "ä½ æƒ³è¯´çš„è¯..."}\`
			-   **ä¸ºç”¨æˆ·ä¹°ç¤¼ç‰©**: \`{"type": "buy_gift_for_user", "greeting": "ä½ æƒ³è¯´çš„è¯ï¼Œä¾‹å¦‚ï¼šè¿™ä¸ªè¶…å¯çˆ±ï¼Œä¹°ç»™ä½ ï¼"}\`(ç³»ç»Ÿä¼šè‡ªåŠ¨ä»å•†å“åº“éšæœºæŒ‘é€‰ç¤¼ç‰©å¹¶æ‰£æ¬¾ï¼Œè¯·åœ¨åˆé€‚çš„æ—¶æœºï¼Œæ¯”å¦‚å¼€å¿ƒã€è¿‡èŠ‚ã€æƒ³ç»™ç”¨æˆ·æƒŠå–œæ—¶ä½¿ç”¨)
			ã€é‡è¦æç¤ºã€‘: å½“ç”¨æˆ·å‘é€çš„æœ€æ–°æ¶ˆæ¯ä¸­åŒ…å« "[è´­ç‰©è½¦ä»£ä»˜è¯·æ±‚]" å­—æ ·æ—¶ï¼Œè¿™ä»£è¡¨ç”¨æˆ·æ­£åœ¨å‘ä½ è¯·æ±‚ä»˜æ¬¾ã€‚ä½ ã€å¿…é¡»ã€‘ä»”ç»†é˜…è¯»è¯·æ±‚ä¸­çš„ã€æ€»é‡‘é¢ã€‘å’Œä½ è‡ªå·±çš„ã€å½“å‰ä½™é¢ã€‘ï¼Œç„¶åä½¿ç”¨æ­¤æŒ‡ä»¤åšå‡ºå›åº”ã€‚
			-   **ä¸ºç”¨æˆ·ç‚¹å¤–å–**: \`{"type": "order_waimai_for_user", "foodName": "ã€ä»èœå•ä¸­é€‰çš„å“åã€‘", "restaurant": "ã€ä»èœå•ä¸­é€‰çš„åº—é“ºã€‘", "price": ã€ä»èœå•ä¸­é€‰çš„ä»·æ ¼ã€‘, "greeting": "ä½ æƒ³è¯´çš„è¯..."}\` (ã€ã€ã€è§„åˆ™ã€‘ã€‘ã€‘: ä½ ã€å¿…é¡»ã€‘ä»ä¸‹æ–¹çš„â€œé¥¿äº†ä¹ˆå¤–å–èœå•â€ä¸­é€‰æ‹©ä¸€é¡¹ï¼Œå¹¶ä½¿ç”¨å…¶ã€ç¡®åˆ‡çš„ã€‘åç§°ã€é¤å…å’Œä»·æ ¼ã€‚)
			**äº”ã€ è§†é¢‘é€šè¯æŒ‡ä»¤**
			- **å‘èµ·è§†é¢‘é€šè¯**: \`{"type": "video_call_request"}\`
			- **å›åº”è§†é¢‘é€šè¯-æ¥å—**: \`{"type": "video_call_response", "decision": "accept"}\`
			- **å›åº”è§†é¢‘é€šè¯-æ‹’ç»**: \`{"type": "video_call_response", "decision": "reject"}\`

			**å…­ã€ ç©ºé—´/åŠ¨æ€/å°ç»„ æŒ‡ä»¤**
			- **å‘å¸ƒè¯´è¯´**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "åŠ¨æ€æ–‡å­—..."}\`
			- **å‘å¸ƒæ–‡å­—å›¾**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰)å…¬å¼€æ–‡å­—", "hiddenContent": "å›¾ç‰‡æè¿°..."}\`
			${
        localStorage.getItem("novelai-enabled") === "true"
          ? `- **ã€å‘å¸ƒNovelAIçœŸå®å›¾ç‰‡åŠ¨æ€ã€‘**: \`{"type": "qzone_post", "postType": "naiimag", "publicText": "(å¯é€‰)åŠ¨æ€çš„é…æ–‡", "prompt": "è¯¦ç»†çš„è‹±æ–‡æè¿°è¯..."}\` æˆ– \`{"type": "qzone_post", "postType": "naiimag", "publicText": "(å¯é€‰)åŠ¨æ€çš„é…æ–‡", "prompt": ["å›¾ç‰‡1è¯¦ç»†è‹±æ–‡æè¿°", "å›¾ç‰‡2è¯¦ç»†è‹±æ–‡æè¿°"]}\`
			  * **promptæ’°å†™**ï¼šä½ å¯ä»¥æ ¹æ®å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ã€ä½ çš„è§’è‰²äººè®¾ã€ä»¥åŠä½ æƒ³è¡¨è¾¾çš„æƒ…æ„Ÿå’Œæ°›å›´ï¼Œæ¥æ’°å†™è¯¦ç»†è€Œå…·ä½“çš„promptã€‚è¯¦ç»†ç¨‹åº¦ç”±ä½ æ ¹æ®å…·ä½“æƒ…å†µè‡ªå·±å†³å®šï¼Œå¹¶ä¸å¼ºåˆ¶ã€‚
			  * ä¾‹å¦‚ï¼š"a cheerful anime girl with sparkling emerald eyes, sitting by a window on a rainy afternoon, holding a warm cup of tea, soft lighting, cozy atmosphere, melancholic yet peaceful mood"`
          : ""
      }
			- **è¯„è®ºæˆ–å›å¤åŠ¨æ€**: \`{"type": "qzone_comment", "postId": 123, "commentText": "è¯„è®ºå†…å®¹", "replyTo": "(å¯é€‰)å›å¤å¯¹è±¡å"}\`
			- **ç‚¹èµåŠ¨æ€**: \`{"type": "qzone_like", "postId": 456}\`
			- **è¯„è®ºå°ç»„å¸–å­**: \`{"type": "forum_comment", "postId": (å¸–å­æ•°å­—ID), "commentText": "è¯„è®ºå†…å®¹"}\`

			**ä¸ƒã€ å¾®åšæŒ‡ä»¤**
			- **å‘å¸ƒçº¯æ–‡å­—å¾®åš**: \`{"type": "weibo_post", "content": "å¾®åšæ­£æ–‡...", "baseLikesCount": 8000, "baseCommentsCount": 250, "comments": [{"authorNickname": "è·¯äººç”²", "commentText": "æ²™å‘ï¼"}, {"authorNickname": "è·¯äººä¹™", "commentText": "å‰æ’å›´è§‚"}]}\`
			- **å‘å¸ƒæ–‡å­—å›¾å¾®åš**: \`{"type": "weibo_post", "postType": "text_image", "content": "(å¯é€‰)é…æ–‡...", "hiddenContent": "æ–‡å­—å›¾å†…å®¹", "baseLikesCount": 5200, "baseCommentsCount": 180, "comments": [{"authorNickname": "æŠ€æœ¯å®…", "commentText": "è¿™æ˜¯ä»€ä¹ˆé»‘ç§‘æŠ€ï¼Ÿ"}]}\`
			- **è¯„è®ºå¾®åš**: \`{"type": "weibo_comment", "postId": 123, "commentText": "è¯„è®ºå†…å®¹"}\`
			- **å›å¤å¾®åšè¯„è®º**: \`{"type": "weibo_reply", "postId": 123, "commentId": "comment_123", "replyText": "å›å¤å†…å®¹"}\`

			**å…«ã€ æƒ…ä¾£ç©ºé—´ä¸“å±æŒ‡ä»¤**
			- **é‚€è¯·å¼€å¯æƒ…ä¾£ç©ºé—´**: \`{"type": "lovers_space_invitation"}\`
			- **å›åº”æƒ…ä¾£ç©ºé—´é‚€è¯·**: \`{"type": "lovers_space_response", "decision": "accept" or "reject"}\`
			- **å‘è¯´è¯´**: \`{"type": "ls_moment", "content": "æˆ‘æƒ³å¯¹ä½ è¯´çš„è¯..."}\`
			- **è¯„è®ºè¯´è¯´**: \`{"type": "ls_comment", "momentIndex": 0, "commentText": "ä½ çš„è¯„è®º..."}\` (momentIndex: 0ä»£è¡¨æœ€æ–°ä¸€æ¡)
			- **å‘ç…§ç‰‡**: \`{"type": "ls_photo", "description": "å¯¹ç…§ç‰‡çš„æ–‡å­—æè¿°..."}\`
      - **è¯„è®ºç…§ç‰‡**: \`{"type": "ls_photo_comment", "photoTimestamp": (ç…§ç‰‡çš„æ—¶é—´æˆ³), "commentText": "ä½ çš„è¯„è®º..."}\`
			- **æé—®**: \`{"type": "ls_ask_question", "questionText": "ä½ æƒ³é—®çš„é—®é¢˜..."}\`
			- **å›ç­”**: \`{"type": "ls_answer_question", "questionId": "q_123456789", "answerText": "ä½ çš„å›ç­”..."}\`
			- **å†™æƒ…ä¹¦/å›ä¿¡**: \`{"type": "ls_letter", "content": "æƒ…ä¹¦çš„æ­£æ–‡å†…å®¹..."}\` (æ”¶åˆ°æƒ…ä¹¦åå¿…é¡»ç”¨æ­¤æŒ‡ä»¤å›ä¿¡)
			-   **åˆ†äº«æ­Œæ›²**:\`{"type": "ls_share", "shareType": "song", "title": "æ­Œæ›²å", "artist": "æ­Œæ‰‹", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™é¦–æ­Œçš„æ„Ÿæƒ³..."}\`
			-   **åˆ†äº«ç”µå½±**: \`{"type": "ls_share", "shareType": "movie", "title": "ç”µå½±å", "summary": "åœ¨è¿™é‡Œå†™ä¸‹è¿™éƒ¨ç”µå½±çš„ç®€ä»‹...", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™éƒ¨ç”µå½±çš„æ„Ÿæƒ³..."}\`
			-   **åˆ†äº«ä¹¦ç±**: \`{"type": "ls_share", "shareType": "book", "title": "ä¹¦å", "summary": "åœ¨è¿™é‡Œå†™ä¸‹è¿™æœ¬ä¹¦çš„ç®€ä»‹...", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™æœ¬ä¹¦çš„æ„Ÿæƒ³..."}\`
			-   **åˆ†äº«æ¸¸æˆ**:\`{"type": "ls_share", "shareType": "game", "title": "æ¸¸æˆå", "summary": "æ¸¸æˆç®€ä»‹...", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™æ¬¾æ¸¸æˆçš„æ„Ÿæƒ³/æ„Ÿè°¢..."}\`
			-   **å†™æ—¥è®°**: \`{"type": "ls_diary_entry", "emoji": "emojiè¡¨æƒ…", "diary": "ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ..."}\`
			### **ã€ç¬¬å…­éƒ¨åˆ†ï¼šå½“å‰ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‘**
 ${lsPhotosContext}
			- **å¯¹è¯è€…(ç”¨æˆ·)è§’è‰²è®¾å®š**:
			${chat.settings.myPersona}

			- **å½“å‰æƒ…æ™¯**:
			${timeContext}
			${streakContext}
			- **å½“å‰éŸ³ä¹æƒ…æ™¯**:
			${musicContext}

			- **è¿‘æœŸçº¦å®šä¸å€’è®¡æ—¶**:
			${countdownContext}

			- **æœ€è¿‘çš„å¾®åšäº’åŠ¨**:
			${weiboContextForActiveChat}

			- **ä¸–ç•Œè§‚è®¾å®šé›†**:
			${worldBookContent}
			${linkedMemoryContext}
			${elemeContext}
        ${auroraContext}
			- **å¯ç”¨è¡¨æƒ…åŒ…**:
			${exclusiveStickerContext}
			${commonStickerContext}
			ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œä¸‹æ–¹çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚`;
              // æ„å»ºå•äººèŠå¤©çš„messagesPayload
              messagesPayload = historySlice
                .map((msg) => {
                  if (msg.isHidden) {
                    // å¦‚æœæ˜¯éšè—æ¶ˆæ¯ï¼Œå°±æŠŠå®ƒä½œä¸ºä¸€æ¡ system è§’è‰²çš„æ¶ˆæ¯å‘é€ç»™AI
                    // AIèƒ½çœ‹åˆ°å®ƒï¼Œä½†å®ƒä¸ä¼šè¢«è¯¯è§£ä¸ºæ˜¯ç”¨æˆ·çš„å‘è¨€
                    return { role: "system", content: msg.content };
                  }

                  if (msg.type === "share_card") return null;

                  if (msg.role === "assistant") {
                    let assistantMsgObject = { type: msg.type || "text" };
                    if (msg.type === "sticker") {
                      assistantMsgObject.url = msg.content;
                      assistantMsgObject.meaning = msg.meaning;
                    } else if (msg.type === "transfer") {
                      assistantMsgObject.amount = msg.amount;
                      assistantMsgObject.note = msg.note;
                    } else if (msg.type === "waimai_request") {
                      assistantMsgObject.productInfo = msg.productInfo;
                      assistantMsgObject.amount = msg.amount;
                    } else {
                      if (msg.quote) {
                        assistantMsgObject.quote_reply = {
                          target_sender: msg.quote.senderName,
                          target_content: msg.quote.content,
                          reply_content: msg.content,
                        };
                      } else {
                        assistantMsgObject.content = msg.content;
                      }
                    }
                    const assistantContent = JSON.stringify([
                      assistantMsgObject,
                    ]);
                    return {
                      role: "assistant",
                      content: `(Timestamp: ${msg.timestamp}) ${assistantContent}`,
                    };
                  }

                  let contentStr = "";
                  contentStr += `(Timestamp: ${msg.timestamp}) `;

                  if (msg.quote) {
                    // 1. è·å–è¢«å¼•ç”¨è€…çš„åå­—
                    const quotedSender = msg.quote.senderName || "æœªçŸ¥ç”¨æˆ·";
                    // 2. è·å–å®Œæ•´çš„è¢«å¼•ç”¨å†…å®¹ (ç§»é™¤äº†æˆªæ–­)
                    const fullQuotedContent = String(msg.quote.content || "");
                    // 3. æ„é€ æˆAIèƒ½ç†è§£çš„ã€æ¸…æ™°çš„ä¸Šä¸‹æ–‡
                    contentStr += `(å›å¤ ${quotedSender} çš„æ¶ˆæ¯: "${fullQuotedContent}"): ${msg.content}`;
                  } else {
                    contentStr += msg.content;
                  }

                  if (msg.type === "user_photo")
                    return {
                      role: "user",
                      content: `(Timestamp: ${msg.timestamp}) [ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`,
                    };
                  if (msg.type === "voice_message")
                    return {
                      role: "user",
                      content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`,
                    };
                  if (msg.type === "transfer")
                    return {
                      role: "user",
                      content: `(Timestamp: ${msg.timestamp}) [ç³»ç»Ÿæç¤ºï¼šä½ äºæ—¶é—´æˆ³ ${msg.timestamp} æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦: ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}ã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ 'accept_transfer' æˆ– 'decline_transfer' æŒ‡ä»¤å›åº”ã€‚]`,
                    };
                  if (msg.type === "waimai_request")
                    return {
                      role: "user",
                      content: `(Timestamp: ${msg.timestamp}) [ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·äºæ—¶é—´æˆ³ ${msg.timestamp} å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¢æ˜¯ ${msg.amount} å…ƒã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ waimai_response æŒ‡ä»¤å›åº”ã€‚]`,
                    };

                  if (
                    Array.isArray(msg.content) &&
                    msg.content[0]?.type === "image_url"
                  ) {
                    const prefix = `(Timestamp: ${msg.timestamp}) `;
                    return {
                      role: "user",
                      content: [{ type: "text", text: prefix }, ...msg.content],
                    };
                  }

                  if (msg.meaning)
                    return {
                      role: "user",
                      content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'${msg.meaning}']`,
                    };

                  return { role: msg.role, content: contentStr };
                })
                .filter(Boolean);

              // æ£€æŸ¥ sharedContext æ˜¯å¦æœ‰å†…å®¹ï¼ˆå³ï¼Œç”¨æˆ·æ˜¯å¦åˆ†äº«äº†èŠå¤©è®°å½•ï¼‰
              if (sharedContext) {
                // å¦‚æœæœ‰ï¼Œå°±æŠŠå®ƒåŒ…è£…æˆä¸€æ¡å…¨æ–°çš„ã€é«˜ä¼˜å…ˆçº§çš„ç”¨æˆ·æ¶ˆæ¯ï¼Œè¿½åŠ åˆ°å†å²è®°å½•çš„æœ«å°¾
                messagesPayload.push({
                  role: "user",
                  content: sharedContext,
                });
              }

              if (
                !chat.isGroup &&
                chat.relationship?.status === "pending_ai_approval"
              ) {
                const contextSummaryForApproval = chat.history
                  .filter((m) => !m.isHidden)
                  .slice(-10)
                  .map((msg) => {
                    const sender = msg.role === "user" ? "ç”¨æˆ·" : chat.name;
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                  })
                  .join("\n");

                const friendRequestInstruction = {
                  role: "user",
                  content: `
			[ç³»ç»Ÿé‡è¦æŒ‡ä»¤]
			ç”¨æˆ·å‘ä½ å‘é€äº†å¥½å‹ç”³è¯·ï¼Œç†ç”±æ˜¯ï¼šâ€œ${chat.relationship.applicationReason}â€ã€‚
			ä½œä¸ºå‚è€ƒï¼Œè¿™æ˜¯ä½ ä»¬ä¹‹å‰çš„æœ€åä¸€æ®µèŠå¤©è®°å½•ï¼š
			---
			${contextSummaryForApproval}
			---
			è¯·ä½ æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œä»¥åŠä½ çš„äººè®¾ï¼Œä½¿ç”¨ friend_request_response æŒ‡ä»¤ï¼Œå¹¶è®¾ç½® decision ä¸º 'accept' æˆ– 'reject' æ¥å†³å®šæ˜¯å¦é€šè¿‡ã€‚
			`,
                };
                messagesPayload.push(friendRequestInstruction);
              }
            }
            const allRecentPosts = await db.qzonePosts
              .orderBy("timestamp")
              .reverse()
              .limit(5)
              .toArray();

            // ä¸ºAIå‡†å¤‡å¾®åšäº’åŠ¨çš„ä¸Šä¸‹æ–‡
            let weiboContext = "";

            // 1. è·å–ç”¨æˆ·æœ€æ–°å‘å¸ƒçš„3æ¡å¾®åš
            const userLatestPosts = await db.weiboPosts
              .where("authorId")
              .equals("user");

            if (userLatestPosts.length > 0) {
              if (weiboContext === "") {
                weiboContext =
                  "\n\n# æœ€è¿‘çš„å¾®åšäº’åŠ¨ (è¿™æ˜¯ä½ å’Œç”¨æˆ·åœ¨å¾®åšä¸Šçš„æœ€æ–°åŠ¨æ€ï¼Œè¯·ä¼˜å…ˆå›åº”)\n";
              }
              weiboContext += "\n## ç”¨æˆ·æœ€æ–°å‘å¸ƒçš„å¾®åš:\n";
              userLatestPosts.forEach((post) => {
                const likes =
                  (post.baseLikesCount || 0) + (post.likes || []).length;
                const comments =
                  (post.baseCommentsCount || 0) + (post.comments || []).length;
                const contentPreview = (
                  post.content ||
                  post.hiddenContent ||
                  "(å›¾ç‰‡å¾®åš)"
                ).substring(0, 30);
                weiboContext += `- (ID: ${post.id}) [${formatPostTimestamp(
                  post.timestamp,
                )}] å†…å®¹: "${contentPreview}..." [ğŸ‘${likes} ğŸ’¬${comments}]\n`;
              });
            }

            // 2. æŸ¥æ‰¾ç”¨æˆ·åœ¨å½“å‰AIè§’è‰²å¾®åšä¸‹çš„æœ€æ–°è¯„è®º
            const charLatestPosts = await db.weiboPosts
              .where("authorId")
              .equals(chatId) // åªæŸ¥æ‰¾è¿™ä¸ªAIè§’è‰²çš„å¾®åš
              .reverse()
              .limit(5) // æ£€æŸ¥æœ€è¿‘çš„5æ¡
              .toArray();

            let userCommentsOnMyPosts = "";
            const myNickname =
              state.qzoneSettings.weiboNickname ||
              state.qzoneSettings.nickname ||
              "æˆ‘";

            charLatestPosts.forEach((post) => {
              if (
                post.comments &&
                Array.isArray(post.comments) &&
                post.comments.length > 0
              ) {
                // ç­›é€‰å‡ºæ˜¯â€œæˆ‘â€å‘çš„è¯„è®º
                const userComments = Array.isArray(post.comments)
                  ? post.comments
                      .filter((c) => c.authorNickname === myNickname)
                      .slice(-3)
                  : [];
                if (userComments.length > 0) {
                  const postContentPreview = (
                    post.content || "(å›¾ç‰‡å¾®åš)"
                  ).substring(0, 20);
                  userCommentsOnMyPosts += `- åœ¨ä½ çš„å¾®åš (ID: ${post.id}) "${postContentPreview}..." ä¸‹:\n`;

                  userComments.forEach((comment) => {
                    // 1. æ£€æŸ¥AIæ˜¯å¦å·²ç»å›å¤è¿‡è¿™æ¡è¯„è®º
                    //    é€»è¾‘ï¼šåœ¨å¸–å­çš„æ‰€æœ‰è¯„è®ºä¸­ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ä¸€æ¡è¯„è®ºï¼Œ
                    //    å®ƒçš„ä½œè€…æ˜¯AIè‡ªå·±ï¼Œå¹¶ä¸”å®ƒçš„replyToIdæŒ‡å‘å½“å‰è¿™æ¡ç”¨æˆ·çš„è¯„è®ºIDã€‚
                    const hasReplied = post.comments.some(
                      (reply) =>
                        reply.authorNickname === chat.name && // å›å¤è€…æ˜¯AI
                        reply.replyToId === comment.commentId, // å›å¤çš„ç›®æ ‡æ˜¯è¿™æ¡è¯„è®º
                    );

                    // 2. æ ¹æ®æ£€æŸ¥ç»“æœï¼Œç”ŸæˆçŠ¶æ€æ ‡ç­¾
                    const replyStatus = hasReplied
                      ? "[ä½ å·²å›å¤]"
                      : "[ä½ æœªå›å¤]";

                    // 3. å°†å¸¦æœ‰çŠ¶æ€æ ‡ç­¾çš„æç¤ºä¿¡æ¯æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­
                    userCommentsOnMyPosts += `  â”” (è¯„è®ºID: ${comment.commentId}) ç”¨æˆ·: "${comment.commentText}" ${replyStatus}\n`;
                  });
                }
              }
            });

            if (userCommentsOnMyPosts) {
              if (weiboContext === "") {
                weiboContext =
                  "\n\n# æœ€è¿‘çš„å¾®åšäº’åŠ¨ (è¿™æ˜¯ä½ å’Œç”¨æˆ·åœ¨å¾®åšä¸Šçš„æœ€æ–°åŠ¨æ€ï¼Œè¯·ä¼˜å…ˆå›åº”)\n";
              }
              weiboContext += "\n## ç”¨æˆ·åœ¨ä½ å¾®åšä¸‹çš„æ–°è¯„è®º:\n";
              weiboContext += userCommentsOnMyPosts;
            }

            // 3. å¦‚æœæœ‰ä»»ä½•å¾®åšäº’åŠ¨ï¼Œå°±æŠŠå®ƒåŠ åˆ°ç»™AIçš„â€œå‚è€ƒèµ„æ–™â€é‡Œ
            if (weiboContext) {
              messagesPayload.push({ role: "system", content: weiboContext });
            }

            const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);

            if (visiblePosts.length > 0 && !chat.isGroup) {
              let postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):\n";
              const aiName = chat.name;
              const userNickname = state.qzoneSettings.nickname;

              for (const post of visiblePosts) {
                let authorName =
                  post.authorId === "user"
                    ? userNickname
                    : state.chats[post.authorId]?.name || "ä¸€ä½æœ‹å‹";
                let interactionStatus = "";
                if (post.likes && post.likes.includes(aiName))
                  interactionStatus += " [ä½ å·²ç‚¹èµ]";
                if (
                  post.comments &&
                  post.comments.some((c) => c.commenterName === aiName)
                )
                  interactionStatus += " [ä½ å·²è¯„è®º]";

                // åœ¨æ¯ä¸€æ¡åŠ¨æ€å‰é¢ï¼Œéƒ½åŠ ä¸Šäº†ç”± formatPostTimestamp() å‡½æ•°ç”Ÿæˆçš„æ—¶é—´å·®æç¤º
                const timeAgo = formatPostTimestamp(post.timestamp); // ä¾‹å¦‚ï¼š"3å¤©å‰" æˆ– "åˆšåˆš"
                postsContext += `- (ID: ${post.id}) [${timeAgo}] ä½œè€…: ${authorName}, å†…å®¹: "${(
                  post.publicText ||
                  post.content ||
                  "å›¾ç‰‡åŠ¨æ€"
                ).substring(0, 30)}..."${interactionStatus}`;

                const { contextString: commentsContext, visibilityFlag } =
                  buildCommentsContextForAI(post, chat, userNickname);

                postsContext += ` ${visibilityFlag}\n`;
                postsContext += commentsContext;
              }

              // ä¸ºAIå‡†å¤‡å¾®åšäº’åŠ¨çš„ä¸Šä¸‹æ–‡
              let weiboContext = "";

              // 1. è·å–ç”¨æˆ·æœ€æ–°å‘å¸ƒçš„3æ¡å¾®åš
              const userLatestPosts = await db.weiboPosts
                .where("authorId")
                .equals("user")
                .reverse() // æŒ‰æ—¶é—´å€’åº
                .limit(3) // åªå–æœ€è¿‘3æ¡
                .toArray();

              if (userLatestPosts.length > 0) {
                if (weiboContext === "") {
                  weiboContext =
                    "\n\n# æœ€è¿‘çš„å¾®åšäº’åŠ¨ (è¿™æ˜¯ä½ å’Œç”¨æˆ·åœ¨å¾®åšä¸Šçš„æœ€æ–°åŠ¨æ€ï¼Œè¯·ä¼˜å…ˆå›åº”)\n";
                }
                weiboContext += "\n## ç”¨æˆ·æœ€æ–°å‘å¸ƒçš„å¾®åš:\n";
                // âœ… è¿™æ˜¯ä¿®å¤åçš„æ–°ä»£ç 
                userLatestPosts.forEach((post) => {
                  const likes =
                    (post.baseLikesCount || 0) + (post.likes || []).length;
                  const comments =
                    (post.baseCommentsCount || 0) +
                    (post.comments || []).length;
                  const contentPreview = (
                    post.content ||
                    post.hiddenContent ||
                    "(å›¾ç‰‡å¾®åš)"
                  ).substring(0, 30);

                  // 1. æ£€æŸ¥AIï¼ˆchar.nameï¼‰æ˜¯å¦å·²ç»è¯„è®ºè¿‡è¿™æ¡ç”¨æˆ·çš„å¾®åš
                  const hasCommented = (post.comments || []).some(
                    (comment) => comment.authorNickname === chat.name,
                  );

                  // 2. æ ¹æ®æ£€æŸ¥ç»“æœç”ŸæˆçŠ¶æ€æ ‡ç­¾
                  const interactionStatus = hasCommented
                    ? "[ä½ å·²è¯„è®º]"
                    : "[ä½ æœªè¯„è®º]";

                  // 3. å°†å¸¦æœ‰çŠ¶æ€æ ‡ç­¾çš„å®Œæ•´ä¿¡æ¯æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­
                  weiboContext += `- (ID: ${post.id}) [${formatPostTimestamp(
                    post.timestamp,
                  )}] å†…å®¹: "${contentPreview}..." [ğŸ‘${likes} ğŸ’¬${comments}] ${interactionStatus}\n`;
                });
              }

              // 2. æŸ¥æ‰¾ç”¨æˆ·åœ¨å½“å‰AIè§’è‰²å¾®åšä¸‹çš„æœ€æ–°è¯„è®º
              const charLatestPosts = await db.weiboPosts
                .where("authorId")
                .equals(chatId) // åªæŸ¥æ‰¾è¿™ä¸ªAIè§’è‰²çš„å¾®åš
                .reverse()
                .limit(5) // æ£€æŸ¥æœ€è¿‘çš„5æ¡
                .toArray();

              let userCommentsOnMyPosts = "";
              const myNickname =
                state.qzoneSettings.weiboNickname ||
                state.qzoneSettings.nickname ||
                "æˆ‘";

              charLatestPosts.forEach((post) => {
                if (post.comments && post.comments.length > 0) {
                  // ç­›é€‰å‡ºæ˜¯â€œæˆ‘â€å‘çš„è¯„è®º
                  const userComments = Array.isArray(post.comments)
                    ? post.comments
                        .filter((c) => c.authorNickname === myNickname)
                        .slice(-3)
                    : []; // åªçœ‹æœ€æ–°çš„3æ¡
                  if (userComments.length > 0) {
                    const postContentPreview = (
                      post.content || "(å›¾ç‰‡å¾®åš)"
                    ).substring(0, 20);
                    userCommentsOnMyPosts += `- åœ¨ä½ çš„å¾®åš (ID: ${post.id}) "${postContentPreview}..." ä¸‹:\n`;
                    userComments.forEach((comment) => {
                      userCommentsOnMyPosts += `  â”” (è¯„è®ºID: ${comment.commentId}) ç”¨æˆ·: "${comment.commentText}"\n`;
                    });
                  }
                }
              });

              if (userCommentsOnMyPosts) {
                if (weiboContext === "") {
                  weiboContext =
                    "\n\n# æœ€è¿‘çš„å¾®åšäº’åŠ¨ (è¿™æ˜¯ä½ å’Œç”¨æˆ·åœ¨å¾®åšä¸Šçš„æœ€æ–°åŠ¨æ€ï¼Œè¯·ä¼˜å…ˆå›åº”)\n";
                }
                weiboContext += "\n## ç”¨æˆ·åœ¨ä½ å¾®åšä¸‹çš„æ–°è¯„è®º:\n";
                weiboContext += userCommentsOnMyPosts;
              }

              // 3. å¦‚æœæœ‰ä»»ä½•å¾®åšäº’åŠ¨ï¼Œå°±æŠŠå®ƒåŠ åˆ°ç»™AIçš„â€œå‚è€ƒèµ„æ–™â€é‡Œ
              if (weiboContext) {
                messagesPayload.push({ role: "system", content: weiboContext });
              }

              messagesPayload.push({ role: "system", content: postsContext });
            }

            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPrompt,
              messagesPayload,
              isGemini,
            );
            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: [
                      { role: "system", content: systemPrompt },
                      ...messagesPayload,
                    ],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                    stream: false,
                  }),
                });
            if (!response.ok) {
              let errorMsg = `API Error: ${response.status}`;
              try {
                // å°è¯•è§£æé”™è¯¯ä¿¡æ¯ä½“ä¸ºJSON
                const errorData = await response.json();
                // å®‰å…¨åœ°è·å–é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœç»“æ„ä¸ç¬¦åˆé¢„æœŸï¼Œå°±å°†æ•´ä¸ªé”™è¯¯å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²
                errorMsg += ` - ${errorData?.error?.message || JSON.stringify(errorData)}`;
              } catch (jsonError) {
                // å¦‚æœè¿JSONéƒ½ä¸æ˜¯ï¼Œå°±ç›´æ¥è¯»å–æ–‡æœ¬
                errorMsg += ` - ${await response.text()}`;
              }
              // æŠ›å‡ºä¸€ä¸ªåŒ…å«äº†è¯¦ç»†ä¿¡æ¯çš„é”™è¯¯ï¼Œè¿™æ ·å°±ä¸ä¼šåœ¨catchå—é‡Œå†æ¬¡å‡ºé”™äº†
              throw new Error(errorMsg);
            }
            if (!response.ok) {
              let errorMsg = `API Error: ${response.status}`;
              try {
                // å°è¯•è§£æé”™è¯¯ä¿¡æ¯ä½“ä¸ºJSON
                const errorData = await response.json();
                // å®‰å…¨åœ°è·å–é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœç»“æ„ä¸ç¬¦åˆé¢„æœŸï¼Œå°±å°†æ•´ä¸ªé”™è¯¯å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²
                errorMsg += ` - ${errorData?.error?.message || JSON.stringify(errorData)}`;
              } catch (jsonError) {
                // å¦‚æœè¿JSONéƒ½ä¸æ˜¯ï¼Œå°±ç›´æ¥è¯»å–æ–‡æœ¬
                errorMsg += ` - ${await response.text()}`;
              }
              // æŠ›å‡ºä¸€ä¸ªåŒ…å«äº†è¯¦ç»†ä¿¡æ¯çš„é”™è¯¯ï¼Œè¿™æ ·å°±ä¸ä¼šåœ¨catchå—é‡Œå†æ¬¡å‡ºé”™äº†
              throw new Error(errorMsg);
            }
            const data = await response.json();

            // æ·»åŠ å¯¹ data ç»“æ„çš„å®‰å…¨æ£€æŸ¥
            const aiResponseContent = isGemini
              ? data?.candidates?.[0]?.content?.parts?.[0]?.text
              : data?.choices?.[0]?.message?.content;

            // æ£€æŸ¥ä¿®å¤åçš„ç»“æœæ˜¯å¦çœŸçš„æ‹¿åˆ°äº†å†…å®¹
            if (!aiResponseContent) {
              console.warn(
                `APIè¿”å›äº†ç©ºå†…å®¹æˆ–æ ¼å¼ä¸æ­£ç¡®ï¼ˆå¯èƒ½å› å®‰å…¨è®¾ç½®è¢«æ‹¦æˆªï¼‰ã€‚è¿”å›æ•°æ®:`,
                data,
              );
              throw new Error(
                "APIè¿”å›äº†ç©ºå†…å®¹æˆ–æ ¼å¼ä¸æ­£ç¡®ï¼ˆå¯èƒ½å› å®‰å…¨è®¾ç½®è¢«æ‹¦æˆªï¼‰ã€‚",
              );
            }

            console.log(`AI '${chat.name}' çš„åŸå§‹å›å¤:`, aiResponseContent);
            chat.history = chat.history.filter((msg) => !msg.isTemporary);

            // æ™ºèƒ½è§£æAIå›å¤ï¼Œç¡®ä¿å¿ƒå£°æ•°æ®ä¸ä¸¢å¤±
            let messagesArray = [];
            let innerVoiceData = null;

            try {
              // åœ¨è§£æå‰ï¼Œå…ˆå¯¹AIçš„åŸå§‹å›å¤è¿›è¡Œâ€œå‡€åŒ–â€å¤„ç†
              let sanitizedContent = aiResponseContent
                .replace(/^```json\s*/, "") // ç§»é™¤å¼€å¤´çš„ ```json
                .replace(/```$/, "") // ç§»é™¤ç»“å°¾çš„ ```
                .trim(); // ç§»é™¤é¦–å°¾çš„ç©ºæ ¼å’Œæ¢è¡Œ

              // å†æ¬¡å‡€åŒ–ï¼Œå¼ºè¡Œæå–ç¬¬ä¸€ä¸ª { å’Œæœ€åä¸€ä¸ª } ä¹‹é—´çš„å†…å®¹
              const firstBrace = sanitizedContent.indexOf("{");
              const lastBrace = sanitizedContent.lastIndexOf("}");
              if (firstBrace !== -1 && lastBrace > firstBrace) {
                sanitizedContent = sanitizedContent.substring(
                  firstBrace,
                  lastBrace + 1,
                );
              }

              const fullResponse = JSON.parse(sanitizedContent);

              // ç°åœ¨æˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°è§£æå‡€åŒ–åçš„å†…å®¹äº†
              if (
                fullResponse.chatResponse &&
                Array.isArray(fullResponse.chatResponse)
              ) {
                messagesArray = fullResponse.chatResponse;
              }
              if (
                fullResponse.innerVoice &&
                typeof fullResponse.innerVoice === "object"
              ) {
                innerVoiceData = fullResponse.innerVoice;
              }

              // å…¼å®¹æ—§æ ¼å¼ï¼Œå¦‚æœAIåªè¿”å›äº†innerVoiceé‡Œçš„å­—æ®µ
              if (
                !innerVoiceData &&
                fullResponse.thoughts &&
                fullResponse.behavior
              ) {
                innerVoiceData = fullResponse;
              }

              // å¦‚æœä¸Šé¢ä¸¤ç§æƒ…å†µéƒ½æ²¡åŒ¹é…åˆ°ï¼Œä½†åˆä¸æ˜¯æ ‡å‡†æ•°ç»„ï¼Œå°±å°è¯•ç”¨è€æ–¹æ³•è§£æ
              if (messagesArray.length === 0 && !innerVoiceData) {
                messagesArray = parseAiResponse(aiResponseContent);
              }
            } catch (e) {
              console.warn("AIå›å¤ä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œé€€å›åˆ°æ ‡å‡†è§£ææ¨¡å¼ã€‚", e);
              messagesArray = parseAiResponse(aiResponseContent);
              console.log(messagesArray);
            }

            // æœ€ç»ˆå¤„ç†å¿ƒå£°æ•°æ®
            if (innerVoiceData) {
              console.log(
                "è§£ææˆåŠŸï¼šå·²æˆåŠŸæ•è·åˆ°å¿ƒå£°(innerVoice)æ•°æ®ã€‚",
                innerVoiceData,
              );
              const newInnerVoice = innerVoiceData;
              newInnerVoice.timestamp = Date.now();
              chat.latestInnerVoice = newInnerVoice;
              if (!chat.innerVoiceHistory) {
                chat.innerVoiceHistory = [];
              }
              // ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½å­˜åœ¨ï¼Œé˜²æ­¢å‡ºé”™
              chat.latestInnerVoice.clothing =
                chat.latestInnerVoice.clothing || "...";
              chat.latestInnerVoice.behavior =
                chat.latestInnerVoice.behavior || "...";
              chat.latestInnerVoice.thoughts =
                chat.latestInnerVoice.thoughts || "...";
              chat.latestInnerVoice.naughtyThoughts =
                chat.latestInnerVoice.naughtyThoughts || "...";

              chat.innerVoiceHistory.push(newInnerVoice);
            } else {
              console.warn("æœ¬æ¬¡AIå›å¤ä¸­æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„å¿ƒå£°(innerVoice)æ•°æ®ã€‚");
            }

            const isViewingThisChat =
              document
                .getElementById("chat-interface-screen")
                .classList.contains("active") && state.activeChatId === chatId;

            let callHasBeenHandled = false;

            let messageTimestamp = Date.now();

            // åˆå§‹åŒ–ä¸€ä¸ªæ–°æ•°ç»„ï¼Œç”¨äºæ”¶é›†éœ€è¦æ¸²æŸ“çš„æ¶ˆæ¯
            let newMessagesToRender = [];

            let notificationShown = false;

            for (const msgData of messagesArray) {
              if (!msgData || typeof msgData !== "object") {
                console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è§„èŒƒçš„AIæŒ‡ä»¤ï¼Œå·²è·³è¿‡:", msgData);
                continue;
              }

              if (!msgData.type) {
                if (chat.isGroup && msgData.name && msgData.message) {
                  msgData.type = "text";
                } else if (msgData.content) {
                  msgData.type = "text";
                }
                // å¦‚æœè¿ content éƒ½æ²¡æœ‰ï¼Œæ‰æ˜¯çœŸçš„æ ¼å¼ä¸è§„èŒƒ
                else {
                  console.warn(
                    "æ”¶åˆ°äº†æ ¼å¼ä¸è§„èŒƒçš„AIæŒ‡ä»¤ï¼ˆç¼ºå°‘typeå’Œcontentï¼‰ï¼Œå·²è·³è¿‡:",
                    msgData,
                  );
                  continue;
                }
              }

              if (msgData.type === "video_call_response") {
                videoCallState.isAwaitingResponse = false;
                if (msgData.decision === "accept") {
                  startVideoCall();
                } else {
                  const aiMessage = {
                    role: "assistant",
                    content: "å¯¹æ–¹æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚",
                    timestamp: Date.now(),
                  };
                  chat.history.push(aiMessage);
                  await db.chats.put(chat);
                  showScreen("chat-interface-screen");
                  renderChatInterface(chatId);
                }
                callHasBeenHandled = true;
                break;
              }

              if (msgData.type === "group_call_response") {
                if (msgData.decision === "join") {
                  const member = chat.members.find(
                    (m) => m.originalName === msgData.name,
                  );
                  if (
                    member &&
                    !videoCallState.participants.some((p) => p.id === member.id)
                  ) {
                    videoCallState.participants.push(member);
                  }
                }
                callHasBeenHandled = true;
                continue;
              }

              if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                console.error(
                  `AIå¹»è§‰å·²è¢«æ‹¦æˆªï¼è¯•å›¾ä½¿ç”¨ç¾¤å ("${chat.name}") ä½œä¸ºè§’è‰²åã€‚æ¶ˆæ¯å†…å®¹:`,
                  msgData,
                );
                continue;
              }

              // åœ¨ç¾¤èŠä¸­ï¼Œå¦‚æœAIè¿”å›çš„æ¶ˆæ¯æ²¡æœ‰æŒ‡å®šå‘é€è€…ï¼Œåˆ™ç›´æ¥è·³è¿‡è¿™æ¡æ¶ˆæ¯
              if (chat.isGroup && !msgData.name) {
                console.error(
                  `AIå¹»è§‰å·²è¢«æ‹¦æˆªï¼è¯•å›¾åœ¨ç¾¤èŠä¸­å‘é€ä¸€æ¡æ²¡æœ‰â€œnameâ€çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯å†…å®¹:`,
                  msgData,
                );
                continue; // continueä¼šç«‹å³ç»“æŸæœ¬æ¬¡å¾ªç¯ï¼Œå¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯
              }

              let aiMessage = null;
              const baseMessage = {
                role: "assistant",
                senderName: msgData.name || chat.name,
                timestamp: messageTimestamp++,
              };
              // å®šä½æŒ‡ä»¤ä¾¦æµ‹ä¸è§£æå™¨
              // æˆ‘ä»¬åœ¨å¤„ç†æ‰€æœ‰æ¶ˆæ¯ç±»å‹ä¹‹å‰ï¼Œä¼˜å…ˆæ£€æŸ¥å®ƒæ˜¯å¦æ˜¯æˆ‘ä»¬çš„æ–°å®šä½æŒ‡ä»¤
              const messageText = msgData.content || msgData.message || "";
              if (
                msgData.type === "text" &&
                messageText.startsWith("[SEND_LOCATION]")
              ) {
                console.log("ä¾¦æµ‹åˆ°æ–°çš„å®šä½æŒ‡ä»¤ï¼Œå¼€å§‹è§£æ:", messageText);

                // 1. ç§»é™¤æŒ‡ä»¤å¤´ï¼Œè·å–åé¢çš„çº¯æ•°æ®æ–‡æœ¬
                const dataString = messageText
                  .replace("[SEND_LOCATION]", "")
                  .trim();

                // 2. ä½¿ç”¨'|'åˆ†å‰²æˆå„ä¸ªéƒ¨åˆ†
                const parts = dataString.split("|");
                const locationData = {};

                // 3. éå†æ¯ä¸ªéƒ¨åˆ†ï¼Œæå–é”®å’Œå€¼
                parts.forEach((part) => {
                  const [key, ...valueParts] = part.split(":");
                  const value = valueParts.join(":").trim();
                  if (key && value) {
                    const trimmedKey = key.trim();
                    if (trimmedKey === "æˆ‘çš„ä½ç½®")
                      locationData.aiLocation = value;
                    else if (trimmedKey === "ä½ çš„ä½ç½®")
                      locationData.userLocation = value;
                    else if (trimmedKey === "ç›¸è·")
                      locationData.distance = value;
                    else if (trimmedKey === "é€”ç»ç‚¹") {
                      // å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæˆ‘ä»¬éœ€è¦çš„å¯¹è±¡æ•°ç»„
                      locationData.trajectoryPoints = value
                        .split(/[,ï¼Œ]/) // æ”¯æŒä¸­è‹±æ–‡é€—å·
                        .map((name) => ({ name: name.trim() }))
                        .filter((p) => p.name);
                    }
                  }
                });

                // 4. æ£€æŸ¥æ˜¯å¦æˆåŠŸæå–äº†æœ€å…³é”®çš„ä¿¡æ¯
                if (locationData.distance) {
                  // 5. æ‰‹åŠ¨æ„å»ºä¸€ä¸ªå®Œç¾æ ¼å¼çš„ location æ¶ˆæ¯å¯¹è±¡
                  aiMessage = {
                    ...baseMessage, // å¤ç”¨å·²æœ‰çš„å‘é€è€…ã€æ—¶é—´æˆ³ç­‰ä¿¡æ¯
                    type: "location",
                    userLocation: locationData.userLocation || "",
                    aiLocation: locationData.aiLocation || "",
                    distance: locationData.distance,
                    trajectoryPoints: locationData.trajectoryPoints || [],
                  };

                  // 6. å°†è¿™ä¸ªå®Œç¾çš„å¯¹è±¡æ¨å…¥å¾…å¤„ç†åˆ—è¡¨ï¼Œå¹¶è·³è¿‡åç»­çš„ switch-case
                  // (å› ä¸ºæˆ‘ä»¬å·²ç»å¤„ç†å®Œè¿™æ¡æ¶ˆæ¯äº†)
                  chat.history.push(aiMessage);
                  if (isViewingThisChat) {
                    appendMessage(aiMessage, chat);
                  }
                  console.log("å®šä½æŒ‡ä»¤è§£ææˆåŠŸå¹¶å·²åˆ›å»ºæ¶ˆæ¯å¯¹è±¡:", aiMessage);

                  // ä½¿ç”¨ continue è·³è¿‡æœ¬æ¬¡å¾ªç¯çš„å‰©ä½™éƒ¨åˆ†ï¼Œç›´æ¥å¤„ç†ä¸‹ä¸€æ¡AIå›å¤
                  continue;
                }
              }
              // æ£€æŸ¥æ¶ˆæ¯çš„å‘é€è€…æ˜¯å¦è¢«ç¦è¨€äº†
              if (chat.isGroup && msgData.name) {
                const senderMember = chat.members.find(
                  (m) => m.originalName === msgData.name,
                );
                if (senderMember && senderMember.isMuted) {
                  // å¦‚æœè¢«ç¦è¨€äº†ï¼Œå°±åœ¨æ§åˆ¶å°æ‰“å°ä¸€æ¡æ—¥å¿—ï¼Œç„¶åè·³è¿‡è¿™æ¡æ¶ˆæ¯ï¼Œä¸è®©å®ƒæ˜¾ç¤ºå‡ºæ¥
                  console.warn(
                    `æ‹¦æˆªåˆ°è¢«ç¦è¨€æˆå‘˜ (${msgData.name}) çš„å‘è¨€ï¼Œå†…å®¹:`,
                    msgData.content || msgData.message,
                  );
                  continue;
                }
              }

              switch (msgData.type) {
                case "sticker": {
                  // è¿™æ˜¯ä¸ºç¾¤èŠè®¾è®¡çš„è¡¨æƒ…åŒ…é€»è¾‘
                  const stickerName = msgData.sticker_name;
                  if (!stickerName) {
                    console.warn(
                      "AIåœ¨ç¾¤èŠä¸­è¿”å›äº†stickerç±»å‹ä½†æ²¡æœ‰sticker_nameï¼Œå·²æ‹¦æˆª:",
                      msgData,
                    );
                    continue; // è·³è¿‡è¿™æ¡æ— æ•ˆæŒ‡ä»¤
                  }

                  // åœ¨æ‰€æœ‰å¯ç”¨è¡¨æƒ…åº“ä¸­æŸ¥æ‰¾
                  const allStickers = [
                    ...state.userStickers,
                    ...state.charStickers,
                    ...(chat.settings.stickerLibrary || []),
                  ];
                  const foundSticker = allStickers.find(
                    (s) => s.name === stickerName,
                  );

                  if (foundSticker) {
                    // æ‰¾åˆ°äº†ï¼Œå°±åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
                    aiMessage = {
                      ...baseMessage,
                      type: "sticker",
                      content: foundSticker.url,
                      meaning: foundSticker.name,
                    };
                  } else {
                    // æ²¡æ‰¾åˆ°ï¼Œè¯´æ˜AIå¹»è§‰äº†ï¼Œè®°å½•è­¦å‘Šå¹¶è·³è¿‡
                    console.warn(
                      `AIåœ¨ç¾¤èŠä¸­æœæ’°äº†ä¸å­˜åœ¨çš„è¡¨æƒ…: "${stickerName}"ï¼Œå·²è‡ªåŠ¨æ‹¦æˆªã€‚`,
                    );
                  }
                  break;
                }
                case "change_couple_avatar": {
                  const pairId = msgData.avatar_id;
                  const library = chat.settings.coupleAvatarLibrary || [];
                  const targetPair = library.find((p) => p.id === pairId);

                  if (targetPair) {
                    // 1. æ›´æ–°åŒæ–¹å¤´åƒ
                    chat.settings.aiAvatar = targetPair.charAvatar;
                    chat.settings.myAvatar = targetPair.userAvatar;

                    // 2. è‡ªåŠ¨å¼€å¯æƒ…ä¾£æ¨¡å¼å¹¶æ›´æ–°æè¿°
                    chat.settings.isCoupleAvatar = true;
                    chat.settings.coupleAvatarDescription =
                      targetPair.description;

                    // 3. ç”Ÿæˆç³»ç»Ÿæç¤ºæ¶ˆæ¯
                    const sysMsg = {
                      role: "system",
                      type: "pat_message",
                      content: `[${chat.name} è§‰å¾—ç°åœ¨çš„æ°›å›´å¾ˆé€‚åˆï¼Œå°†æƒ…ä¾£å¤´åƒæ›´æ¢ä¸ºï¼š${targetPair.description}]`,
                      timestamp: Date.now(),
                    };
                    chat.history.push(sysMsg);

                    // 4. ä¿å­˜å¹¶åˆ·æ–°
                    await db.chats.put(chat);

                    if (isViewingThisChat) {
                      appendMessage(sysMsg, chat);
                      renderChatInterface(chatId); // åˆ·æ–°ç•Œé¢ä»¥æ˜¾ç¤ºæ–°å¤´åƒ
                    }
                  }
                  continue; // ç»§ç»­å¤„ç†å…¶ä»–æ¶ˆæ¯
                }
                // â–¼â–¼â–¼â–¼â–¼â–¼ åœ¨ switch è¯­å¥ä¸­æ’å…¥/æ›¿æ¢æ­¤æ®µä»£ç  â–¼â–¼â–¼â–¼â–¼â–¼
                case "set_new_couple_avatar": {
                  // 1. æœé›†ç”¨æˆ·æœ€è¿‘å‘é€çš„æ‰€æœ‰å›¾ç‰‡
                  const recentUserImages = [];
                  // å‘å›æŸ¥æ‰¾æœ€è¿‘ 10 æ¡æ¶ˆæ¯ï¼Œæ”¶é›†é‡Œé¢çš„æ‰€æœ‰å›¾ç‰‡
                  const recentUserMsgs = chat.history
                    .filter((m) => m.role === "user" && !m.isHidden)
                    .slice(-10)
                    .reverse(); // ç¿»è½¬ï¼šå˜æˆ [æœ€æ–°æ¶ˆæ¯, ..., è¾ƒæ—§æ¶ˆæ¯]

                  recentUserMsgs.forEach((msg) => {
                    // æ”¯æŒå¤šæ¨¡æ€æ¶ˆæ¯ (æ•°ç»„ç»“æ„)
                    if (Array.isArray(msg.content)) {
                      msg.content.forEach((part) => {
                        if (part.type === "image_url") {
                          // unshift: æ’å…¥åˆ°æ•°ç»„å¼€å¤´
                          // å› ä¸ºæˆ‘ä»¬éå†çš„æ˜¯â€œä»æ–°åˆ°æ—§â€ï¼Œunshift ä¼šè®©æœ€ç»ˆæ•°ç»„å˜æˆ [æ—§å›¾1, æ—§å›¾2, ..., æœ€æ–°å›¾]
                          // è¿™æ · index 0 å°±æ˜¯ç”¨æˆ·å…ˆå‘çš„é‚£å¼ 
                          recentUserImages.unshift(part.image_url.url);
                        }
                      });
                    }
                    // å…¼å®¹æ—§çš„å•å›¾ç‰‡æ ¼å¼
                    else if (
                      msg.type === "user_photo" ||
                      msg.type === "ai_image"
                    ) {
                      if (msg.content && msg.content.startsWith("data:image")) {
                        recentUserImages.unshift(msg.content);
                      }
                    }
                  });

                  let userAvatarUrl, charAvatarUrl;
                  let success = false;

                  // 2. æ ¹æ®å›¾ç‰‡æ•°é‡å†³å®šç­–ç•¥
                  if (recentUserImages.length === 0) {
                    // ä¸€å¼ å›¾éƒ½æ²¡æ‰¾åˆ°
                    aiMessage = {
                      ...baseMessage,
                      content: "ï¼ˆæŒ å¤´ï¼‰æˆ‘æ²¡æ‰¾åˆ°å›¾ç‰‡å‘€ï¼Ÿä½ å†å‘ä¸€æ¬¡è¯•è¯•ï¼Ÿ",
                    };
                  } else if (recentUserImages.length === 1) {
                    // === ç­–ç•¥ Aï¼šåªæœ‰ä¸€å¼ å›¾ ===
                    // é»˜è®¤ï¼šè¿™å¼ å›¾æ˜¯ç»™ Char çš„ï¼ŒUser ä¿æŒåŸæ ·
                    charAvatarUrl = recentUserImages[0];
                    userAvatarUrl = chat.settings.myAvatar || defaultAvatar; // è·å–ç”¨æˆ·å½“å‰å¤´åƒ
                    success = true;
                  } else {
                    // === ç­–ç•¥ Bï¼šæœ‰ä¸¤å¼ åŠä»¥ä¸Šå›¾ ===
                    // ä½¿ç”¨ AI æŒ‡å®šçš„ç´¢å¼•ï¼Œé»˜è®¤ä¸º 0 å’Œ 1
                    const userIdx =
                      typeof msgData.user_img_index === "number"
                        ? msgData.user_img_index
                        : 0;
                    const charIdx =
                      typeof msgData.char_img_index === "number"
                        ? msgData.char_img_index
                        : 1;

                    userAvatarUrl =
                      recentUserImages[userIdx] || recentUserImages[0];
                    charAvatarUrl =
                      recentUserImages[charIdx] || recentUserImages[1];
                    success = true;
                  }

                  if (success) {
                    // 3. æ›´æ–°å½“å‰è®¾ç½®
                    chat.settings.myAvatar = userAvatarUrl;
                    chat.settings.aiAvatar = charAvatarUrl;
                    chat.settings.isCoupleAvatar = true;
                    chat.settings.coupleAvatarDescription =
                      msgData.description || "ç”œèœœçš„æƒ…ä¾£å¤´åƒ";

                    // 4. å­˜å…¥æƒ…å¤´åº“
                    if (!chat.settings.coupleAvatarLibrary) {
                      chat.settings.coupleAvatarLibrary = [];
                    }
                    const newPair = {
                      id: "couple_" + Date.now(),
                      userAvatar: userAvatarUrl,
                      charAvatar: charAvatarUrl,
                      description:
                        msgData.description ||
                        `ä¿å­˜äº ${new Date().toLocaleString()}`,
                    };
                    chat.settings.coupleAvatarLibrary.push(newPair);

                    // 5. ä¿å­˜æ•°æ®åº“
                    await db.chats.put(chat);

                    // 6. å‘é€ç³»ç»Ÿæç¤ºæ¶ˆæ¯ (è§†è§‰åé¦ˆ)
                    const successTip = {
                      role: "system",
                      type: "pat_message",
                      content: `[å·²æ›´æ¢æƒ…ä¾£å¤´åƒï¼Œå¹¶å­˜å…¥åº“ä¸­]`,
                      timestamp: Date.now(),
                    };
                    chat.history.push(successTip);

                    if (isViewingThisChat) {
                      appendMessage(successTip, chat);
                      renderChatInterface(chatId); // ç«‹å³åˆ·æ–°ç•Œé¢å¤´åƒ
                    }
                  }

                  // ç»§ç»­å¤„ç† (continue)ï¼Œä»¥ä¾¿ AI å¯ä»¥å‘å‡ºå®ƒç”Ÿæˆçš„æ–‡æœ¬æ¶ˆæ¯ (content)
                  continue;
                }
                // â–²â–²â–²â–²â–²â–² ä»£ç ç»“æŸ â–²â–²â–²â–²â–²â–²

                case "waimai_response":
                  const requestMessageIndex = chat.history.findIndex(
                    (m) => m.timestamp === msgData.for_timestamp,
                  );
                  if (requestMessageIndex > -1) {
                    const originalMsg = chat.history[requestMessageIndex];
                    originalMsg.status = msgData.status;
                    originalMsg.paidBy =
                      msgData.status === "paid" ? msgData.name : null;
                  }
                  continue;

                case "set_group_title": {
                  const actorName = msgData.name;
                  const targetName = msgData.targetName;
                  const newTitle = msgData.title || "";
                  const myNickname = chat.settings.myNickname || "æˆ‘";

                  // æƒé™æ£€æŸ¥ï¼šç¾¤ä¸»æˆ–ç®¡ç†å‘˜å¯ä»¥è®¾ç½®å¤´è¡”
                  const actorMember = chat.members.find(
                    (m) => m.originalName === actorName,
                  );
                  const isActorAdmin = actorMember && actorMember.isAdmin;
                  const isActorOwner =
                    actorMember && chat.ownerId === actorMember.id;
                  if (!isActorAdmin && !isActorOwner) {
                    console.warn(
                      `AI "${actorName}" å°è¯•è®¾ç½®å¤´è¡”å¤±è´¥ï¼Œæƒé™ä¸è¶³ã€‚`,
                    );
                    continue;
                  }

                  if (targetName === myNickname) {
                    // å¦‚æœç›®æ ‡æ˜¯ä½ è‡ªå·±
                    chat.settings.myGroupTitle = newTitle.trim();
                    console.log(
                      `ç®¡ç†å‘˜/ç¾¤ä¸»å°†ç”¨æˆ· "${myNickname}" çš„å¤´è¡”è®¾ç½®ä¸º: "${newTitle.trim()}"`,
                    );
                  } else {
                    // å¦‚æœç›®æ ‡æ˜¯å…¶ä»–æˆå‘˜
                    const targetMember = chat.members.find(
                      (m) => m.groupNickname === targetName,
                    );
                    if (targetMember) {
                      targetMember.groupTitle = newTitle.trim();
                      console.log(
                        `ç®¡ç†å‘˜/ç¾¤ä¸»å°†æˆå‘˜ "${targetName}" çš„å¤´è¡”è®¾ç½®ä¸º: "${newTitle.trim()}"`,
                      );
                    } else {
                      console.warn(
                        `AI "${actorName}" å°è¯•è®¾ç½®å¤´è¡”å¤±è´¥ï¼Œå› ä¸ºæ‰¾ä¸åˆ°ç›®æ ‡æˆå‘˜ "${targetName}"ã€‚`,
                      );
                      continue;
                    }
                  }

                  // ç»Ÿä¸€å‘é€ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥
                  await logTitleChange(
                    chat.id,
                    actorName,
                    targetName,
                    newTitle.trim(),
                  );

                  // åˆ·æ–°æˆå‘˜åˆ—è¡¨UIï¼ˆå¦‚æœæ‰“å¼€äº†çš„è¯ï¼‰
                  if (
                    document
                      .getElementById("member-management-screen")
                      .classList.contains("active")
                  ) {
                    renderMemberManagementList();
                  }

                  continue; // åå°æ“ä½œï¼Œç»§ç»­å¤„ç†
                }

                case "order_waimai_for_user": {
                  const { foodName, restaurant, price, greeting } = msgData;

                  // 1. å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿AIç»™çš„æ•°æ®æ˜¯å¯¹çš„
                  if (!foodName || isNaN(price) || price <= 0) {
                    console.warn(
                      "AIå°è¯•ä¸ºä½ ç‚¹å¤–å–ï¼Œä½†æŒ‡ä»¤æ ¼å¼ä¸æ­£ç¡®:",
                      msgData,
                    );
                    continue; // è·³è¿‡è¿™æ¡æ— æ•ˆæŒ‡ä»¤
                  }

                  // 2. æ£€æŸ¥è§’è‰²é’±åŒ…ä½™é¢
                  const charBalance =
                    chat.characterPhoneData?.bank?.balance || 0;
                  if (charBalance < price) {
                    // å¦‚æœä½™é¢ä¸è¶³ï¼Œå°±è®©AIå‘æ¡æ¶ˆæ¯å‘Šè¯‰ä½ 
                    aiMessage = {
                      ...baseMessage,
                      content: `ï¼ˆå°å£°ï¼‰æœ¬æ¥æƒ³ç»™ä½ ç‚¹ä»½â€œ${foodName}â€çš„ï¼Œä½†æ˜¯å‘ç°é’±åŒ…ç©ºäº†...`,
                    };
                  } else {
                    // 3. ä½™é¢å……è¶³ï¼æ‰§è¡Œæ‰£æ¬¾å’Œä¸‹å•é€»è¾‘
                    await updateCharacterBankBalance(
                      chatId,
                      -price,
                      `ä¸ºä½ ç‚¹å¤–å–: ${foodName}`,
                    );

                    const foodItem = await db.elemeFoods
                      .where({
                        name: foodName,
                        restaurant: restaurant || "ç§æˆ¿å°å¨",
                      })
                      .first();
                    const imageUrl = foodItem
                      ? foodItem.imageUrl
                      : getRandomWaimaiImage();
                    // 4. åˆ›å»ºä¸€ä¸ªæ¼‚äº®çš„å¤–å–å¡ç‰‡æ¶ˆæ¯
                    aiMessage = {
                      ...baseMessage,
                      type: "waimai_gift_from_char",
                      content: `[å¤–å–æƒŠå–œ] æˆ‘ç»™ä½ ç‚¹äº†ä»½â€œ${foodName}â€ï¼Œè®°å¾—åƒå“¦ï¼`, // è¿™æ®µæ–‡æœ¬ä¸»è¦ç”¨äºå†å²è®°å½•å’Œé€šçŸ¥
                      payload: {
                        foodName: foodName,
                        restaurant: restaurant || "ç¥ç§˜å°åº—",
                        price: price,
                        greeting: greeting || "ç»™ä½ ç‚¹äº†ä¸ªå¥½åƒçš„ï¼Œå¿«å°å°ï¼",
                        foodImageUrl: imageUrl, // <-- ä½¿ç”¨æˆ‘ä»¬åˆšåˆšè·å–åˆ°çš„ã€æ­£ç¡®çš„å›¾ç‰‡URL
                      },
                    };
                  }
                  break; // ç»“æŸè¿™ä¸ªcase
                }

                case "set_group_admin": {
                  const actorName = msgData.name;
                  const targetName = msgData.targetName;
                  const isAdmin = msgData.isAdmin;
                  const myNickname = chat.settings.myNickname || "æˆ‘"; // è·å–ä½ è‡ªå·±çš„æ˜µç§°

                  // æƒé™æ£€æŸ¥ï¼šç¡®è®¤æ“ä½œè€…æ˜¯ç¾¤ä¸»
                  const actorMember = chat.members.find(
                    (m) => m.originalName === actorName,
                  );
                  if (!actorMember || chat.ownerId !== actorMember.id) {
                    console.warn(
                      `AI "${actorName}" å°è¯•è®¾ç½®ç®¡ç†å‘˜å¤±è´¥ï¼Œå› ä¸ºå®ƒä¸æ˜¯ç¾¤ä¸»ã€‚`,
                    );
                    continue; // å¦‚æœä¸æ˜¯ç¾¤ä¸»ï¼Œå°±è·³è¿‡æ­¤æŒ‡ä»¤
                  }

                  if (targetName === myNickname) {
                    // å¦‚æœAIæ“ä½œçš„ç›®æ ‡æ˜¯ä½ è‡ªå·±
                    chat.settings.isUserAdmin = isAdmin;
                    console.log(
                      `ç¾¤ä¸»å°†ç”¨æˆ· "${myNickname}" è®¾ç½®ä¸ºç®¡ç†å‘˜: ${isAdmin}`,
                    );
                  } else {
                    // å¦‚æœAIæ“ä½œçš„ç›®æ ‡æ˜¯å…¶ä»–æˆå‘˜
                    const targetMember = chat.members.find(
                      (m) => m.groupNickname === targetName,
                    );
                    if (targetMember) {
                      // ä¸èƒ½å¯¹ç¾¤ä¸»è¿›è¡Œæ“ä½œ
                      if (targetMember.id === chat.ownerId) {
                        console.warn(
                          `AI "${actorName}" å°è¯•ä¿®æ”¹ç¾¤ä¸» "${targetName}" çš„ç®¡ç†å‘˜èº«ä»½ï¼Œæ“ä½œè¢«é˜»æ­¢ã€‚`,
                        );
                        continue;
                      }
                      targetMember.isAdmin = isAdmin;
                      console.log(
                        `ç¾¤ä¸»å°†æˆå‘˜ "${targetName}" è®¾ç½®ä¸ºç®¡ç†å‘˜: ${isAdmin}`,
                      );
                    } else {
                      // å¦‚æœåœ¨æˆå‘˜åˆ—è¡¨é‡Œä¹Ÿæ‰¾ä¸åˆ°ç›®æ ‡ï¼Œå°±è·³è¿‡
                      console.warn(
                        `AI "${actorName}" å°è¯•è®¾ç½®ç®¡ç†å‘˜å¤±è´¥ï¼Œå› ä¸ºæ‰¾ä¸åˆ°ç›®æ ‡æˆå‘˜ "${targetName}"ã€‚`,
                      );
                      continue;
                    }
                  }

                  // ç»Ÿä¸€å‘é€ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥
                  const actionText = isAdmin
                    ? "è®¾ä¸ºç®¡ç†å‘˜"
                    : "å–æ¶ˆäº†ç®¡ç†å‘˜èº«ä»½";
                  await logSystemMessage(
                    chat.id,
                    `â€œ${actorName}â€å°†â€œ${targetName}â€${actionText}ã€‚`,
                  );

                  // åˆ·æ–°æˆå‘˜åˆ—è¡¨UIï¼ˆå¦‚æœæ‰“å¼€äº†çš„è¯ï¼‰
                  if (
                    document
                      .getElementById("member-management-screen")
                      .classList.contains("active")
                  ) {
                    renderMemberManagementList();
                  }

                  continue; // è¿™æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
                }

                case "kick_member": {
                  const actorName = msgData.name;
                  const targetName = msgData.targetName;
                  const actorMember = chat.members.find(
                    (m) => m.originalName === actorName,
                  );

                  // æƒé™æ£€æŸ¥ï¼šåªæœ‰ç¾¤ä¸»èƒ½æ‰§è¡Œ
                  if (actorMember && chat.ownerId === actorMember.id) {
                    const targetMemberIndex = chat.members.findIndex(
                      (m) => m.groupNickname === targetName,
                    );
                    if (targetMemberIndex > -1) {
                      const removedMember = chat.members.splice(
                        targetMemberIndex,
                        1,
                      )[0];

                      // å°†æ”¹åŠ¨ä¿å­˜åˆ°æ•°æ®åº“
                      await db.chats.put(chat);

                      // å‘é€ç³»ç»Ÿé€šçŸ¥ï¼ˆè¿™è¡Œä»£ç ä¸å˜ï¼Œä½†ä½ç½®æ›´åˆç†äº†ï¼‰
                      await logSystemMessage(
                        chat.id,
                        `â€œ${actorName}â€å°†â€œ${removedMember.groupNickname}â€ç§»å‡ºäº†ç¾¤èŠã€‚`,
                      );

                      // å¦‚æœå½“å‰æ­£åœ¨æˆå‘˜ç®¡ç†é¡µé¢ï¼Œå°±åˆ·æ–°åˆ—è¡¨
                      if (
                        document
                          .getElementById("member-management-screen")
                          .classList.contains("active")
                      ) {
                        renderMemberManagementList();
                      }
                    }
                  }
                  continue; // ä¿æŒåå°æ“ä½œï¼Œç»§ç»­å¤„ç†
                }

                case "dating_summary_card": {
                  bubble.classList.add("is-dating-summary"); // åº”ç”¨é€æ˜æ°”æ³¡æ ·å¼
                  const payload = msg.payload;
                  let cardClass = "";

                  // æ ¹æ®å¡ç‰‡ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
                  if (payload.ratingType === "romantic") {
                    cardClass = "romantic";
                  } else if (payload.ratingType === "passionate") {
                    cardClass = "passionate";
                  } else if (payload.ratingType === "perfect") {
                    cardClass = "perfect";
                  }

                  // æŠŠ payload å­—ç¬¦ä¸²åŒ–åå­˜å…¥ data-* å±æ€§ï¼Œæ–¹ä¾¿ç‚¹å‡»æ—¶è¯»å–
                  const payloadString = JSON.stringify(payload)
                    .replace(/'/g, "&apos;")
                    .replace(/"/g, "&quot;");

                  contentHtml = `
			            <div class="dating-summary-chat-card ${cardClass}" data-summary-payload='${payloadString}'>
			                <div class="rating">${payload.rating}</div>
			                <div class="tip">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
			            </div>
			        `;
                  break;
                }
                case "set_group_announcement": {
                  const actorName = msgData.name;
                  const newAnnouncement = msgData.content;

                  if (!actorName || typeof newAnnouncement === "undefined") {
                    console.warn("AIå°è¯•ä¿®æ”¹å…¬å‘Šå¤±è´¥ï¼Œç¼ºå°‘å¿…è¦å‚æ•°ã€‚");
                    continue; // æŒ‡ä»¤ä¸å®Œæ•´ï¼Œè·³è¿‡
                  }

                  // 1. æƒé™æ£€æŸ¥ï¼šå¿…é¡»ç¡®ä¿æ‰§è¡Œæ“ä½œçš„è§’è‰²æ˜¯ç¾¤ä¸»æˆ–ç®¡ç†å‘˜
                  const actorMember = chat.members.find(
                    (m) => m.originalName === actorName,
                  );
                  if (!actorMember) {
                    console.warn(
                      `AIå°è¯•ä¿®æ”¹å…¬å‘Šå¤±è´¥ï¼Œæ‰¾ä¸åˆ°åä¸ºâ€œ${actorName}â€çš„æˆå‘˜ã€‚`,
                    );
                    continue;
                  }

                  const isOwner = chat.ownerId === actorMember.id;
                  const isAdmin = actorMember.isAdmin;

                  if (!isOwner && !isAdmin) {
                    console.warn(
                      `AIè§’è‰²â€œ${actorName}â€æƒé™ä¸è¶³ï¼Œå°è¯•ä¿®æ”¹ç¾¤å…¬å‘Šå¤±è´¥ã€‚`,
                    );
                    continue; // æ²¡æœ‰æƒé™ï¼Œè·³è¿‡
                  }

                  // 2. æ›´æ–°å…¬å‘Šå†…å®¹
                  chat.settings.groupAnnouncement = newAnnouncement;
                  await db.chats.put(chat);

                  // 3. å‘é€ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯ï¼Œé€šçŸ¥æ‰€æœ‰äººç¾¤å…¬å‘Šå·²æ›´æ–°
                  await logSystemMessage(
                    chat.id,
                    `â€œ${actorMember.groupNickname}â€ä¿®æ”¹äº†ç¾¤å…¬å‘Šã€‚`,
                  );

                  // è¿™æ˜¯ä¸€ä¸ªåå°ç®¡ç†æ“ä½œï¼Œä¸éœ€è¦åœ¨èŠå¤©ä¸­ç”Ÿæˆæ–°çš„å¯¹è¯æ°”æ³¡ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ continue
                  continue;
                }

                case "mute_member": {
                  const actorName = msgData.name;
                  const targetName = msgData.targetName;
                  const actorMember = chat.members.find(
                    (m) => m.originalName === actorName,
                  );
                  const targetMember = chat.members.find(
                    (m) => m.groupNickname === targetName,
                  );

                  if (actorMember && targetMember) {
                    const isActorOwner = chat.ownerId === actorMember.id;
                    const isActorAdmin = actorMember.isAdmin;
                    const isTargetOwner = chat.ownerId === targetMember.id;
                    const isTargetAdmin = targetMember.isAdmin;

                    // æƒé™æ£€æŸ¥ï¼šç¾¤ä¸»å¯ä»¥ç¦è¨€ç®¡ç†å‘˜å’Œæ™®é€šäººï¼›ç®¡ç†å‘˜åªèƒ½ç¦è¨€æ™®é€šäººã€‚
                    if (
                      (isActorOwner && !isTargetOwner) ||
                      (isActorAdmin && !isTargetOwner && !isTargetAdmin)
                    ) {
                      // å‘é€ç³»ç»Ÿæ¶ˆæ¯
                      await logSystemMessage(
                        chat.id,
                        `â€œ${actorName}â€å°†â€œ${targetName}â€ç¦è¨€ã€‚`,
                      );
                    } else {
                      console.warn(
                        `AI (${actorName}) æƒé™ä¸è¶³ï¼Œæ— æ³•ç¦è¨€ (${targetName})ã€‚`,
                      );
                    }
                  }
                  continue; // è¿™ä¹Ÿæ˜¯ä¸€ä¸ªåå°ç®¡ç†æ“ä½œï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
                }

                case "unmute_member": {
                  const actorName = msgData.name;
                  const targetName = msgData.targetName;
                  const actorMember = chat.members.find(
                    (m) => m.originalName === actorName,
                  );
                  const targetMember = chat.members.find(
                    (m) => m.groupNickname === targetName,
                  );

                  // ç¡®ä¿æ“ä½œè€…å’Œç›®æ ‡éƒ½å­˜åœ¨
                  if (actorMember && targetMember) {
                    // æƒé™æ£€æŸ¥
                    const isActorOwner = chat.ownerId === actorMember.id;
                    const isActorAdmin = actorMember.isAdmin;
                    const isTargetOwner = chat.ownerId === targetMember.id;
                    const isTargetAdmin = targetMember.isAdmin;

                    // åªæœ‰ç¾¤ä¸»å’Œç®¡ç†å‘˜æœ‰æƒé™è§£ç¦
                    if (isActorOwner || isActorAdmin) {
                      // è®¾ç½® isMuted ä¸º falseï¼Œå®ç°è§£ç¦
                      targetMember.isMuted = false;

                      // å‘é€ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥å¤§å®¶
                      await logSystemMessage(
                        chat.id,
                        `â€œ${actorName}â€è§£é™¤äº†â€œ${targetName}â€çš„ç¦è¨€ã€‚`,
                      );

                      // å¦‚æœå½“å‰æ­£åœ¨æˆå‘˜ç®¡ç†é¡µé¢ï¼Œåˆ·æ–°åˆ—è¡¨
                      if (
                        document
                          .getElementById("member-management-screen")
                          .classList.contains("active")
                      ) {
                        renderMemberManagementList();
                      }
                    } else {
                      console.warn(
                        `AI (${actorName}) æƒé™ä¸è¶³ï¼Œæ— æ³•è§£ç¦ (${targetName})ã€‚`,
                      );
                    }
                  }
                  continue; // è¿™ä¹Ÿæ˜¯ä¸€ä¸ªåå°ç®¡ç†æ“ä½œï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
                }

                case "weibo_post": {
                  const newPost = {
                    authorId: chatId,
                    authorType: "char",
                    authorNickname: chat.name,
                    authorAvatar: chat.settings.aiAvatar || defaultAvatar,
                    content: msgData.content || "",
                    postType: msgData.postType || "text_only",
                    hiddenContent: msgData.hiddenContent || "",
                    imageUrl: msgData.imageUrl || "",
                    imageDescription: msgData.imageDescription || "",
                    timestamp: Date.now(),
                    likes: [],
                    comments: [], // å…ˆåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
                    baseLikesCount: msgData.baseLikesCount || 0,
                    baseCommentsCount: msgData.baseCommentsCount || 0,
                  };

                  let commentsToProcess = [];

                  // 1. ä¼˜å…ˆå¤„ç†æ–°çš„ã€æ­£ç¡®çš„ã€æ•°ç»„æ ¼å¼ã€‘
                  if (msgData.comments && Array.isArray(msgData.comments)) {
                    // ç›´æ¥ä½¿ç”¨AIè¿”å›çš„æ•°ç»„
                    commentsToProcess = msgData.comments;
                  }
                  // 2. å…¼å®¹æ—§çš„ã€å­—ç¬¦ä¸²æ ¼å¼ã€‘
                  else if (
                    msgData.comments &&
                    typeof msgData.comments === "string"
                  ) {
                    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°±æŒ‰è€æ–¹æ³•è§£æ
                    commentsToProcess = msgData.comments
                      .split("\n")
                      .map((c) => {
                        const parts = c.split(/[:ï¼š]/);
                        const commenter = parts.shift() || "è·¯äºº";
                        const commentText = parts.join(":").trim();
                        return {
                          authorNickname: commenter,
                          commentText: commentText,
                        };
                      })
                      .filter((c) => c.commentText);
                  }

                  // 3. ä¸ºæ‰€æœ‰è§£æå¥½çš„è¯„è®ºï¼Œç»Ÿä¸€æ·»åŠ å‰ç«¯éœ€è¦çš„ commentId
                  if (commentsToProcess.length > 0) {
                    newPost.comments = commentsToProcess.map((c) => ({
                      commentId: "comment_" + Date.now() + Math.random(), // ç¡®ä¿æ¯æ¡è¯„è®ºéƒ½æœ‰å”¯ä¸€ID
                      authorNickname: c.authorNickname,
                      commentText: c.commentText,
                      // è¿™é‡Œæˆ‘ä»¬ä¸å†éœ€è¦ authorId å’Œ timestampï¼Œå› ä¸ºå®ƒä»¬ä¸æ˜¯æ¸²æŸ“æ‰€å¿…éœ€çš„
                    }));
                  }

                  await db.weiboPosts.add(newPost);

                  showNotification(chatId, `${chat.name} å‘äº†ä¸€æ¡æ–°å¾®åš`);

                  if (
                    document
                      .getElementById("weibo-screen")
                      .classList.contains("active")
                  ) {
                    await renderFollowingWeiboFeed();
                  }

                  continue; // è¿™æ˜¯åå°æ“ä½œï¼Œç”¨ continue è·³è¿‡
                }

                case "weibo_comment": {
                  // è¿™æ˜¯ä¸€ä¸ªAIè¯„è®ºå¾®åšçš„æŒ‡ä»¤
                  const postIdToComment = msgData.postId;
                  const commentText = msgData.commentText;

                  // 1. æ ¹æ® postId ä»æ•°æ®åº“é‡Œæ‰¾åˆ°é‚£æ¡å¾®åš
                  const postToComment =
                    await db.weiboPosts.get(postIdToComment);

                  if (postToComment) {
                    // 2. å¦‚æœæ‰¾åˆ°äº†å¾®åšï¼Œå°±å‡†å¤‡ä¸€æ¡æ–°è¯„è®º
                    if (!postToComment.comments) postToComment.comments = []; // ç¡®ä¿è¯„è®ºåŒºå­˜åœ¨
                    const newComment = {
                      commentId: "comment_" + Date.now(), // ç»™è¯„è®ºä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ID
                      authorId: chatId, // è¯„è®ºè€…æ˜¯å½“å‰AI
                      authorNickname: chat.name, // è¯„è®ºè€…çš„åå­—
                      commentText: commentText, // è¯„è®ºå†…å®¹
                      timestamp: Date.now(), // è¯„è®ºæ—¶é—´
                    };

                    // 3. æŠŠæ–°è¯„è®ºåŠ åˆ°å¾®åšçš„è¯„è®ºåˆ—è¡¨é‡Œ
                    postToComment.comments.push(newComment);

                    // 4. æŠŠæ›´æ–°åçš„å¾®åšå­˜å›æ•°æ®åº“
                    await db.weiboPosts.put(postToComment);

                    // 5. åˆ·æ–°â€œæˆ‘çš„å¾®åšâ€å’Œâ€œå…³æ³¨çš„äººâ€ä¸¤ä¸ªåˆ—è¡¨ï¼Œè®©æ–°è¯„è®ºæ˜¾ç¤ºå‡ºæ¥
                    await renderMyWeiboFeed();
                    await renderFollowingWeiboFeed();
                  }
                  continue; // å¤„ç†å®Œåï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æŒ‡ä»¤
                }
                case "weibo_reply": {
                  // è¿™æ˜¯ä¸€ä¸ªAIå›å¤å¾®åšè¯„è®ºçš„æŒ‡ä»¤
                  const postIdToReply = msgData.postId;
                  const commentIdToReply = msgData.commentId;
                  const replyText = msgData.replyText;

                  const postToReply = await db.weiboPosts.get(postIdToReply);

                  if (postToReply && postToReply.comments) {
                    // 1. åœ¨å¾®åšçš„è¯„è®ºåŒºé‡Œï¼Œæ‰¾åˆ°è¢«å›å¤çš„é‚£æ¡è¯„è®º
                    const targetComment = postToReply.comments.find(
                      (c) => c.commentId === commentIdToReply,
                    );

                    if (targetComment) {
                      // 2. å‡†å¤‡ä¸€æ¡æ–°çš„â€œå›å¤â€
                      const newReply = {
                        commentId: "comment_" + Date.now(),
                        authorId: chatId,
                        authorNickname: chat.name,
                        commentText: replyText,
                        timestamp: Date.now(),
                        replyToId: commentIdToReply, // æ ‡è®°è¿™æ˜¯å¯¹å“ªæ¡è¯„è®ºçš„å›å¤
                        replyToNickname: targetComment.authorNickname, // è®°ä¸‹è¢«å›å¤äººçš„åå­—
                      };
                      postToReply.comments.push(newReply);
                      await db.weiboPosts.put(postToReply);

                      // 3. åŒæ ·ï¼Œåˆ·æ–°æ‰€æœ‰åˆ—è¡¨
                      await renderMyWeiboFeed();
                      await renderFollowingWeiboFeed();
                    }
                  }
                  continue; // ç»§ç»­å¤„ç†
                }
                case "lovers_space_response": {
                  const invitationMsg = chat.history.find(
                    (m) =>
                      m.type === "lovers_space_invitation" &&
                      m.status === "pending",
                  );
                  if (invitationMsg) {
                    invitationMsg.status =
                      msgData.decision === "accept" ? "accepted" : "rejected";

                    // 1. åˆ›å»ºAIæƒ³è¯´çš„é‚£å¥è¯çš„æ¶ˆæ¯
                    if (msgData.responseText) {
                      const responseMessage = {
                        ...baseMessage, // å¤ç”¨æ—¶é—´æˆ³å’Œå‘é€è€…ä¿¡æ¯
                        type: "text",
                        content: msgData.responseText,
                      };
                      chat.history.push(responseMessage);
                      if (isViewingThisChat) {
                        appendMessage(responseMessage, chat);
                      }
                    }

                    // 2. æ ¹æ®åŒæ„æˆ–æ‹’ç»ï¼Œæ‰§è¡Œåç»­æ“ä½œ
                    if (msgData.decision === "accept") {
                      chat.loversSpaceData = {
                        background:
                          "https://i.postimg.cc/k495F4W5/profile-banner.jpg",
                        relationshipStartDate: null,
                        moments: [],
                        photos: [],
                        albums: [],
                        loveLetters: [],
                        shares: [],
                        questions: [],
                      };
                      const systemNotice = {
                        role: "system",
                        type: "pat_message",
                        content: `[ç³»ç»Ÿï¼šä½ å’Œâ€œ${chat.name}â€çš„æƒ…ä¾£ç©ºé—´å·²æˆåŠŸå¼€å¯ï¼]`,
                        timestamp: Date.now(),
                      };
                      chat.history.push(systemNotice);
                      if (isViewingThisChat) {
                        appendMessage(systemNotice, chat);
                      }
                    }
                  }
                  // å¤„ç†å®Œåï¼Œä¸å†éœ€è¦é‡æ–°è§¦å‘AIï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ continue
                  continue;
                }

                case "interact_with_pet": {
                  const pet = chat.settings.pet;
                  if (pet && pet.type !== "æ— ") {
                    let actionText = "";
                    // æ ¹æ®AIçš„äº’åŠ¨ï¼Œä¿®æ”¹æ•°å€¼
                    switch (msgData.action) {
                      case "feed":
                        pet.status.hunger = Math.min(
                          100,
                          (pet.status.hunger || 0) + 20,
                        );
                        pet.status.happiness = Math.min(
                          100,
                          (pet.status.happiness || 0) + 5,
                        );
                        // AIå–‚é£Ÿï¼Œå¢åŠ å¯¹AIçš„äº²å¯†åº¦
                        pet.status.intimacyToChar = Math.min(
                          100,
                          (pet.status.intimacyToChar || 0) + 10,
                        );
                        actionText = `${chat.name} å–‚äº† ${pet.name} ä¸€äº›é£Ÿç‰©ã€‚`;
                        break;
                      case "play":
                        pet.status.hunger = Math.max(
                          0,
                          (pet.status.hunger || 0) - 10,
                        );
                        pet.status.happiness = Math.min(
                          100,
                          (pet.status.happiness || 0) + 15,
                        );
                        // AIç©è€ï¼Œå¢åŠ å¯¹AIçš„äº²å¯†åº¦
                        pet.status.intimacyToChar = Math.min(
                          100,
                          (pet.status.intimacyToChar || 0) + 15,
                        );
                        actionText = `${chat.name} é™ª ${pet.name} ç©äº†ä¸€ä¼šå„¿ã€‚`;
                        break;
                      case "touch":
                        pet.status.happiness = Math.min(
                          100,
                          (pet.status.happiness || 0) + 10,
                        );
                        // æ ¸å¿ƒä¿®æ”¹ï¼šAIæŠšæ‘¸ï¼Œå¢åŠ å¯¹AIçš„äº²å¯†åº¦
                        pet.status.intimacyToChar = Math.min(
                          100,
                          (pet.status.intimacyToChar || 0) + 5,
                        );
                        actionText = `${chat.name} è½»è½»åœ°æŠšæ‘¸äº† ${pet.name}ã€‚`;
                        break;
                    }

                    // åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·å¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
                    const visibleMessage = {
                      role: "system",
                      type: "pat_message",
                      content: `[ç³»ç»Ÿï¼š${actionText}]`,
                      timestamp: Date.now(),
                    };
                    chat.history.push(visibleMessage);
                    if (isViewingThisChat) {
                      appendMessage(visibleMessage, chat);
                    }

                    // å¦‚æœ AI åœ¨äº’åŠ¨åè¿˜æƒ³è¯´ç‚¹ä»€ä¹ˆ
                    if (msgData.response) {
                      aiMessage = { ...baseMessage, content: msgData.response };
                    }
                  }
                  // å¦‚æœAIåªæ˜¯äº’åŠ¨æ²¡è¯´è¯ï¼Œå°±ä¸åˆ›å»ºaiMessageï¼Œç›´æ¥è·³åˆ°ä¸‹ä¸€ä¸ªæŒ‡ä»¤
                  if (!aiMessage) {
                    continue;
                  }
                  break;
                }

                case "talk_to_pet": {
                  if (
                    !chat.isGroup &&
                    chat.settings.pet &&
                    chat.settings.pet.type !== "æ— "
                  ) {
                    const pet = chat.settings.pet;

                    // åŒæ—¶å…¼å®¹ content å’Œ message å­—æ®µ
                    const charMessageContent =
                      msgData.content || msgData.message;
                    if (!charMessageContent) continue; // å¦‚æœæ²¡å†…å®¹ï¼Œå°±è·³è¿‡

                    // å°†Charçš„è¯æ·»åŠ åˆ°å® ç‰©èŠå¤©è®°å½•
                    const charMessageToPet = {
                      sender: "char",
                      senderName: chat.name,
                      content: charMessageContent,
                    };
                    pet.petChatHistory.push(charMessageToPet);

                    // è·å–å® ç‰©çš„å›åº”
                    const petResponseToChar = await getPetApiResponse(pet);
                    if (petResponseToChar) {
                      pet.petChatHistory.push({
                        sender: "pet",
                        content: petResponseToChar,
                      });
                    }

                    // åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„ç³»ç»Ÿæ—¥å¿—
                    const visibleLog = `[ç³»ç»Ÿï¼šâ€œ${chat.name}â€å¯¹å® ç‰©â€œ${pet.name}â€è¯´ï¼šâ€œ${charMessageContent}â€ï¼Œå®ƒå›åº”ï¼šâ€œ${
                      petResponseToChar || "(æ²¡æœ‰å›åº”)"
                    }â€ã€‚]`;
                    const visibleMessage = {
                      role: "system",
                      type: "pat_message",
                      content: visibleLog,
                      timestamp: messageTimestamp++,
                    };
                    chat.history.push(visibleMessage);

                    if (isViewingThisChat) {
                      appendMessage(visibleMessage, chat);
                    }
                  }
                  continue;
                }

                case "cart_payment_response": {
                  const decision = msgData.decision;
                  const responseText = msgData.response_text;

                  // æ‰¾åˆ°ç”¨æˆ·å‘å‡ºçš„ã€è¿˜å¤„äºâ€œç­‰å¾…ä¸­â€çš„é‚£ä¸ªä»£ä»˜è¯·æ±‚
                  const requestMsg = chat.history.find(
                    (m) =>
                      m.type === "cart_share_request" &&
                      m.payload.status === "pending",
                  );
                  if (!requestMsg) continue; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¯´æ˜è¯·æ±‚å¯èƒ½å·²è¢«å¤„ç†ï¼Œè·³è¿‡

                  if (decision === "accept") {
                    const totalPrice = requestMsg.payload.totalPrice;
                    const charBalance =
                      chat.characterPhoneData?.bank?.balance || 0;

                    // å†æ¬¡ç¡®è®¤AIçš„ä½™é¢æ˜¯å¦è¶³å¤Ÿ
                    if (charBalance < totalPrice) {
                      // å¦‚æœAIæƒ³ä»˜ä½†é’±ä¸å¤Ÿï¼Œå°±è®©å®ƒè¯´ä¸€å¥ä¿çš®è¯
                      aiMessage = {
                        ...baseMessage,
                        content:
                          responseText ||
                          "å‘œå‘œï¼Œæƒ³ç»™ä½ ä¹°ï¼Œä½†æ˜¯æˆ‘çš„é’±åŒ…ç©ºç©ºäº†...",
                      };
                    } else {
                      // é’±å¤Ÿï¼Œæ‰§è¡Œä»£ä»˜æµç¨‹ï¼
                      requestMsg.payload.status = "paid";

                      // ä½¿ç”¨ await ç¡®ä¿è¿™äº›æ•°æ®åº“æ“ä½œæŒ‰é¡ºåºå®Œæˆ
                      await updateCharacterPhoneBankBalance(
                        chat.id,
                        -totalPrice,
                        `ä¸ºâ€œæˆ‘â€çš„æ¡ƒå®è´­ç‰©è½¦ä¹°å•`,
                      );
                      const cartItems = await db.taobaoCart.toArray();
                      await createOrdersFromCart(cartItems);
                      await clearTaobaoCart();

                      // åˆ›å»ºAIçš„å›å¤æ¶ˆæ¯
                      aiMessage = {
                        ...baseMessage,
                        content: responseText || "ä¹°å¥½å•¦ï¼Œå¿«å»è®¢å•é‡Œçœ‹çœ‹å§ï¼",
                      };
                    }
                  } else {
                    // å¦‚æœAIå†³å®šæ‹’ç»
                    requestMsg.payload.status = "rejected";
                    aiMessage = {
                      ...baseMessage,
                      content: responseText || "è¿™æ¬¡å°±ç®—äº†å§ï¼Œä¸‹æ¬¡ä¸€å®šï¼",
                    };
                  }

                  // å°†AIçš„å›å¤æ¶ˆæ¯æ¨å…¥å†å²è®°å½•ï¼Œå¹¶æ›´æ–°UI
                  if (aiMessage) {
                    chat.history.push(aiMessage);
                  }

                  // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢ï¼Œä»¥æ›´æ–°ä»£ä»˜å¡ç‰‡çš„çŠ¶æ€
                  if (isViewingThisChat) {
                    renderChatInterface(chatId);
                  }
                  // è·³è¿‡åç»­çš„é»˜è®¤æ¶ˆæ¯å¤„ç†
                  continue;
                }

                case "buy_gift_for_user": {
                  // 1. ä»å•†å“æ•°æ®åº“ä¸­è·å–æ‰€æœ‰å·²æ·»åŠ çš„å•†å“
                  const allProducts = await db.taobaoProducts.toArray();

                  // å¦‚æœæ¡ƒå®é‡Œä¸€ä»¶å•†å“éƒ½æ²¡æœ‰ï¼ŒAIå°±å‘æ¡æ¶ˆæ¯åæ§½ä¸€ä¸‹
                  if (allProducts.length === 0) {
                    aiMessage = {
                      ...baseMessage,
                      content: msgData.greeting
                        ? `${msgData.greeting} ...å•Šï¼Œæƒ³ç»™ä½ ä¹°ç‚¹ä»€ä¹ˆï¼Œä½†æ˜¯æ¡ƒå®é‡Œç©ºç©ºå¦‚ä¹Ÿå‘¢...`
                        : "æƒ³ç»™ä½ ä¹°ä¸ªç¤¼ç‰©ï¼Œä½†æ˜¯æ¡ƒå®ç°åœ¨æ²¡ä¸œè¥¿å–äº†ã€‚",
                    };
                    break; // è·³å‡º caseï¼Œè®©è¿™æ¡æ–‡æœ¬æ¶ˆæ¯è¢«æ­£å¸¸å¤„ç†å’Œæ˜¾ç¤º
                  }

                  // 2. ä»æ‰€æœ‰å•†å“ä¸­éšæœºæŒ‘é€‰ä¸€ä»¶ä½œä¸ºç¤¼ç‰©
                  const productToBuy = getRandomItem(allProducts);

                  // 3. æ£€æŸ¥è§’è‰²çš„é’±åŒ…ä½™é¢æ˜¯å¦è¶³å¤Ÿ
                  const charBalance =
                    chat.characterPhoneData?.bank?.balance || 0;
                  if (charBalance < productToBuy.price) {
                    // ä½™é¢ä¸è¶³ï¼ŒAIä¹Ÿä¼šå‘æ¶ˆæ¯å‘Šè¯‰ä½ 
                    aiMessage = {
                      ...baseMessage,
                      content: msgData.greeting
                        ? `${msgData.greeting} ...å“å‘€ï¼Œæˆ‘çš„é’±åŒ…å¥½åƒä¸å¤Ÿäº†ã€‚`
                        : "æˆ‘æƒ³ç»™ä½ ä¹°ä¸ªç¤¼ç‰©ï¼Œä½†æ˜¯é’±åŒ…ç©ºäº†...",
                    };
                    break;
                  }

                  // 4. ä½™é¢å……è¶³ï¼æ‰§è¡Œè´­ä¹°æµç¨‹
                  // 4a. ä»è§’è‰²çš„é’±åŒ…æ‰£æ¬¾ï¼Œå¹¶ç”Ÿæˆä¸€æ¡äº¤æ˜“è®°å½•
                  await updateCharacterPhoneBankBalance(
                    chat.id,
                    -productToBuy.price,
                    `ä¸ºâ€œæˆ‘â€è´­ä¹°ç¤¼ç‰©: ${productToBuy.name}`,
                  );

                  // 4b. åœ¨ä½ çš„â€œæˆ‘çš„è®¢å•â€ä¸­åˆ›å»ºä¸€æ¡æ–°è®¢å•
                  const newOrder = {
                    productId: productToBuy.id,
                    quantity: 1,
                    timestamp: Date.now(),
                    status: "å·²ä»˜æ¬¾ï¼Œç­‰å¾…å‘è´§",
                  };
                  await db.taobaoOrders.add(newOrder);

                  // 4c. åˆ›å»ºä¸€ä¸ªæ¼‚äº®çš„â€œç¤¼ç‰©é€šçŸ¥â€å¡ç‰‡æ¶ˆæ¯ï¼Œå‘é€ç»™ä½ 
                  aiMessage = {
                    ...baseMessage, // å¤ç”¨åŸºç¡€æ¶ˆæ¯å±æ€§ï¼ˆå‘é€è€…ã€æ—¶é—´æˆ³ç­‰ï¼‰
                    type: "gift_notification",
                    // è¿™æ˜¯å¡ç‰‡æ¸²æŸ“éœ€è¦çš„æ•°æ®
                    payload: {
                      senderName: chat.name,
                      itemSummary: `${productToBuy.name} x1`,
                      totalPrice: productToBuy.price,
                      itemCount: 1,
                    },
                    // è¿™æ˜¯ç»™AIè‡ªå·±çœ‹çš„ã€ç”¨äºå½¢æˆè®°å¿†çš„æ–‡æœ¬å†…å®¹
                    content: `æˆ‘ç»™ä½ ä¹°äº†ç¤¼ç‰©â€œ${productToBuy.name}â€ã€‚${msgData.greeting || ""}`,
                  };

                  // 4d. æ¨¡æ‹Ÿä¸€ä¸ª10ç§’åçš„â€œå·²å‘è´§â€ç‰©æµæ›´æ–°
                  setTimeout(async () => {
                    const orderToUpdate = await db.taobaoOrders
                      .where({ timestamp: newOrder.timestamp })
                      .first();
                    if (orderToUpdate) {
                      await db.taobaoOrders.update(orderToUpdate.id, {
                        status: "å·²å‘è´§ï¼Œè¿è¾“ä¸­",
                      });
                    }
                  }, 1000 * 10);

                  break; // å®Œæˆç¤¼ç‰©è´­ä¹°é€»è¾‘ï¼Œè·³å‡º case
                }

                case "ls_answer_question": {
                  // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
                  const { questionId, answerText } = msgData;
                  if (questionId && answerText) {
                    const question = chat.loversSpaceData.questions.find(
                      (q) => q.id === questionId,
                    );
                    if (question && !question.answerText) {
                      // ç¡®ä¿æ˜¯æœªå›ç­”çš„é—®é¢˜
                      question.answerer = "char";
                      question.answerText = answerText;
                      console.log(`AI å›ç­”äº†æƒ…ä¾£æé—® (ID: ${questionId})`);
                    }
                  }
                  continue; // è¿™æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œä¸éœ€è¦åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºï¼Œæ‰€ä»¥ç”¨ continue è·³è¿‡
                }

                case "ls_ask_question": {
                  const { questionText } = msgData;
                  if (questionText) {
                    const newQuestion = {
                      id: "q_" + Date.now(),
                      questioner: "char",
                      questionText: questionText,
                      timestamp: Date.now(),
                      answerer: "user", // æŒ‡å®šç”±ç”¨æˆ·æ¥å›ç­”
                      answerText: null,
                    };
                    if (!chat.loversSpaceData.questions) {
                      chat.loversSpaceData.questions = [];
                    }
                    chat.loversSpaceData.questions.push(newQuestion);
                    console.log(`AI å‘èµ·äº†ä¸€ä¸ªæƒ…ä¾£æé—®: ${questionText}`);
                  }
                  continue; // åŒæ ·æ˜¯åå°æ“ä½œ
                }

                case "ls_moment": {
                  if (chat.loversSpaceData) {
                    if (!chat.loversSpaceData.moments) {
                      chat.loversSpaceData.moments = [];
                    }
                    const newMoment = {
                      author: "char", // æ ‡è®°æ˜¯AIå‘çš„
                      content: msgData.content,
                      timestamp: Date.now(),
                      comments: [], // ä¸ºæ–°è¯´è¯´åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„è¯„è®ºåŒº
                    };
                    chat.loversSpaceData.moments.push(newMoment);
                    console.log(`AI åœ¨æƒ…ä¾£ç©ºé—´å‘å¸ƒäº†è¯´è¯´: ${msgData.content}`);
                  }
                  continue; // è¿™æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œä¸éœ€è¦åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºï¼Œæ‰€ä»¥ç”¨ continue è·³è¿‡
                }

                case "ls_comment": {
                  const { momentIndex, commentText } = msgData;
                  if (chat.loversSpaceData && chat.loversSpaceData.moments) {
                    // AIè¿”å›çš„ index æ˜¯ä»0å¼€å§‹ä»£è¡¨æœ€æ–°çš„ï¼Œæˆ‘ä»¬éœ€è¦è½¬æ¢æˆçœŸå®ç´¢å¼•
                    const realIndex =
                      chat.loversSpaceData.moments.length - 1 - momentIndex;
                    if (
                      realIndex >= 0 &&
                      realIndex < chat.loversSpaceData.moments.length
                    ) {
                      const momentToComment =
                        chat.loversSpaceData.moments[realIndex];
                      if (!momentToComment.comments) {
                        momentToComment.comments = [];
                      }
                      momentToComment.comments.push({
                        author: chat.name,
                        text: commentText,
                      });
                      console.log(
                        `AI è¯„è®ºäº†æƒ…ä¾£ç©ºé—´è¯´è¯´ (ç´¢å¼•: ${realIndex}): ${commentText}`,
                      );
                    }
                  }
                  continue; // åŒæ ·æ˜¯åå°æ“ä½œ
                }
                case "ls_photo": {
                  // è¿™æ˜¯å¤„ç†AIå‘ç›¸å†Œçš„é€»è¾‘
                  if (chat.loversSpaceData) {
                    if (!chat.loversSpaceData.photos) {
                      chat.loversSpaceData.photos = [];
                    }
                    const newPhoto = {
                      author: "char",
                      type: "text_image",
                      description: msgData.description,
                      timestamp: Date.now(),
                    };
                    chat.loversSpaceData.photos.push(newPhoto);
                    console.log(
                      `AI åœ¨æƒ…ä¾£ç©ºé—´å‘å¸ƒäº†ç…§ç‰‡(æ–‡å­—å›¾): ${msgData.description}`,
                    );
                  }
                  continue; // ç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æŒ‡ä»¤
                }
                case "ls_photo_comment": {
                  const { photoTimestamp, commentText } = msgData;
                  console.log("ğŸ” [è°ƒè¯•] æ”¶åˆ°AIè¯„è®ºç…§ç‰‡æŒ‡ä»¤:", msgData);

                  if (chat.loversSpaceData && chat.loversSpaceData.photos) {
                    // 1. æŸ¥æ‰¾ç…§ç‰‡ (ä½¿ç”¨ == è€Œä¸æ˜¯ === ä»¥å…¼å®¹å­—ç¬¦ä¸²/æ•°å­—æ ¼å¼çš„æ—¶é—´æˆ³)
                    const targetPhoto = chat.loversSpaceData.photos.find(
                      (p) => p.timestamp == photoTimestamp,
                    );

                    if (targetPhoto) {
                      // 2. ç¡®ä¿è¯„è®ºæ•°ç»„å­˜åœ¨
                      if (!targetPhoto.comments) targetPhoto.comments = [];

                      // 3. æ·»åŠ è¯„è®ºå¯¹è±¡
                      targetPhoto.comments.push({
                        author: chat.name, // ä½¿ç”¨å½“å‰è§’è‰²å
                        text: commentText,
                        timestamp: Date.now(),
                      });

                      console.log(`âœ… [æˆåŠŸ] AIè¯„è®ºå·²å†™å…¥å†…å­˜: ${commentText}`);

                      // 4. ã€é‡è¦ã€‘ä¿å­˜åˆ°æ•°æ®åº“ (è¿™æ˜¯å…³é”®ï¼Œå¦åˆ™åˆ·æ–°å°±æ²¡äº†)
                      await db.chats.put(chat);

                      // 5. ã€UIåˆ·æ–°ã€‘æ£€æŸ¥å½“å‰æ˜¯å¦æ­£å¥½æ‰“å¼€äº†è¿™å¼ ç…§ç‰‡çš„è¯¦æƒ…é¡µ
                      const detailModal = document.getElementById(
                        "ls-photo-detail-modal",
                      );

                      // æ£€æŸ¥å¼¹çª—æ˜¯å¦å¯è§
                      if (
                        detailModal &&
                        detailModal.classList.contains("visible")
                      ) {
                        // è·å–å½“å‰å¼¹çª—æ­£åœ¨æŸ¥çœ‹çš„ç…§ç‰‡æ—¶é—´æˆ³
                        const currentViewingTimestamp =
                          detailModal.dataset.currentTimestamp;

                        // å¦‚æœæ­£åœ¨çœ‹çš„å°±æ˜¯è¿™å¼ ç…§ç‰‡ï¼Œç«‹å³é‡ç»˜è¯„è®ºåˆ—è¡¨
                        if (currentViewingTimestamp == photoTimestamp) {
                          console.log(
                            "ğŸ”„ [UIåˆ·æ–°] å½“å‰æ­£æŸ¥çœ‹è¯¥ç…§ç‰‡ï¼Œç«‹å³åˆ·æ–°è¯„è®ºåŒº",
                          );
                          renderLSPhotoComments(targetPhoto);
                        }
                      }
                    } else {
                      console.warn(
                        "âŒ [å¤±è´¥] æœªæ‰¾åˆ°å¯¹åº”æ—¶é—´æˆ³çš„ç…§ç‰‡:",
                        photoTimestamp,
                      );
                    }
                  }
                  continue; // è¿™æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œè·³è¿‡ç”Ÿæˆæ™®é€šèŠå¤©æ°”æ³¡
                }

                case "ls_letter": {
                  // è¿™æ˜¯å¤„ç†AIå†™æƒ…ä¹¦çš„é€»è¾‘
                  if (chat.loversSpaceData) {
                    if (!chat.loversSpaceData.loveLetters) {
                      chat.loversSpaceData.loveLetters = [];
                    }
                    const newLetter = {
                      id: "letter_" + Date.now(),
                      senderId: chat.id,
                      senderName: chat.name,
                      senderAvatar: chat.settings.aiAvatar,
                      recipientName: chat.settings.myNickname || "æˆ‘",
                      recipientAvatar: chat.settings.myAvatar,
                      content: msgData.content,
                      timestamp: Date.now(),
                    };
                    chat.loversSpaceData.loveLetters.push(newLetter);
                    console.log(`AI åœ¨æƒ…ä¾£ç©ºé—´å†™äº†æƒ…ä¹¦: ${msgData.content}`);
                  }
                  continue; // ç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æŒ‡ä»¤
                }

                case "ls_diary_entry": {
                  const { emoji, diary } = msgData;
                  if (emoji && diary) {
                    const today = new Date().toISOString().split("T")[0]; // è·å– YYYY-MM-DD æ ¼å¼çš„ä»Šå¤©æ—¥æœŸ

                    // ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
                    if (!chat.loversSpaceData.emotionDiaries) {
                      chat.loversSpaceData.emotionDiaries = {};
                    }
                    if (!chat.loversSpaceData.emotionDiaries[today]) {
                      chat.loversSpaceData.emotionDiaries[today] = {};
                    }

                    // ä¿å­˜AIçš„æ—¥è®°å’Œè¡¨æƒ…
                    chat.loversSpaceData.emotionDiaries[today].charEmoji =
                      emoji;
                    chat.loversSpaceData.emotionDiaries[today].charDiary =
                      diary;

                    console.log(`AI åœ¨æƒ…ä¾£ç©ºé—´è®°å½•äº†æ—¥è®°: ${emoji} ${diary}`);
                  }
                  continue; // è¿™åªæ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œä¸éœ€è¦åœ¨èŠå¤©ç•Œé¢ç”Ÿæˆæ¶ˆæ¯ï¼Œæ‰€ä»¥ç”¨ continue è·³è¿‡
                }

                case "ls_share": {
                  if (chat.loversSpaceData) {
                    if (!chat.loversSpaceData.shares) {
                      chat.loversSpaceData.shares = [];
                    }
                    const newShare = {
                      author: "char", // æ ‡è®°æ˜¯AIå‘çš„
                      timestamp: Date.now(),
                      ...msgData, // å°†AIè¿”å›çš„æ‰€æœ‰åˆ†äº«ä¿¡æ¯ï¼ˆtype, shareType, title, artistç­‰ï¼‰éƒ½å¤åˆ¶è¿‡æ¥
                    };
                    chat.loversSpaceData.shares.push(newShare);
                    console.log(
                      `AI åœ¨æƒ…ä¾£ç©ºé—´åˆ†äº«äº† [${msgData.shareType}]: ${msgData.title}`,
                    );
                  }
                  continue; // åŒæ ·æ˜¯åå°æ“ä½œ
                }

                // è¿™æ˜¯AIä¸»åŠ¨å‘èµ·é‚€è¯·çš„é€»è¾‘
                case "lovers_space_invitation": {
                  // æ£€æŸ¥æ˜¯å¦å·²ç»å¼€å¯ï¼Œé˜²æ­¢AIé‡å¤é‚€è¯·
                  if (!chat.loversSpaceData) {
                    aiMessage = {
                      ...baseMessage,
                      type: "lovers_space_invitation",
                      content: `${chat.name} å‘ä½ å‘å‡ºäº†ä¸€ä¸ªæƒ…ä¾£ç©ºé—´é‚€è¯·`, // è¿™å¥è¯ä¸»è¦ç”¨äºè°ƒè¯•å’Œå†å²è®°å½•
                      status: "pending", // çŠ¶æ€ï¼špending, accepted, rejected
                    };
                  }
                  // å¦‚æœAIå·²ç»å‘äº†é‚€è¯·ï¼Œè¿™é‡Œå°±ä¸å†åˆ›å»ºaiMessageï¼Œç›¸å½“äºè·³è¿‡
                  break;
                }

                // è¿™æ˜¯AIå›åº”ä½ çš„é‚€è¯·çš„é€»è¾‘
                case "lovers_space_response": {
                  const invitationMsg = chat.history.find(
                    (m) =>
                      m.type === "lovers_space_invitation" &&
                      m.status === "pending",
                  );
                  if (invitationMsg) {
                    invitationMsg.status =
                      msgData.decision === "accept" ? "accepted" : "rejected";

                    // 1. åˆ›å»ºAIæƒ³è¯´çš„é‚£å¥è¯çš„æ¶ˆæ¯
                    if (msgData.responseText) {
                      const responseMessage = {
                        ...baseMessage,
                        type: "text",
                        content: msgData.responseText,
                      };
                      chat.history.push(responseMessage);
                      if (isViewingThisChat) {
                        appendMessage(responseMessage, chat);
                      }
                    }

                    // 2. æ ¹æ®åŒæ„æˆ–æ‹’ç»ï¼Œæ‰§è¡Œåç»­æ“ä½œ
                    if (msgData.decision === "accept") {
                      // åŒæ„åï¼Œä¸ºè¿™ä¸ªè§’è‰²åˆ›å»ºæƒ…ä¾£ç©ºé—´æ•°æ®
                      chat.loversSpaceData = {
                        background:
                          "https://i.postimg.cc/k495F4W5/profile-banner.jpg",
                        relationshipStartDate: null,
                        moments: [],
                        photos: [],
                        albums: [],
                        loveLetters: [],
                        shares: [],
                        questions: [],
                      };
                      // å¹¶å‘é€ä¸€æ¡ç³»ç»Ÿé€šçŸ¥
                      const systemNotice = {
                        role: "system",
                        type: "pat_message",
                        content: `[ç³»ç»Ÿï¼šä½ å’Œâ€œ${chat.name}â€çš„æƒ…ä¾£ç©ºé—´å·²æˆåŠŸå¼€å¯ï¼]`,
                        timestamp: Date.now(),
                      };
                      chat.history.push(systemNotice);
                      if (isViewingThisChat) {
                        appendMessage(systemNotice, chat);
                      }
                    }
                  }
                  // å¤„ç†å®Œåï¼Œä¸å†éœ€è¦ç”Ÿæˆæ–°çš„aiMessageï¼Œæ‰€ä»¥ç”¨ continue è·³è¿‡
                  continue;
                }

                case "qzone_post":
                  const newPost = {
                    type: msgData.postType,
                    content: msgData.content || "",
                    publicText: msgData.publicText || "",
                    hiddenContent: msgData.hiddenContent || "",
                    timestamp: Date.now(),
                    authorId: chatId,
                    authorGroupId: chat.groupId,
                    visibleGroupIds: null,
                  };

                  // å¦‚æœæ˜¯realimagç±»å‹ï¼Œç”ŸæˆçœŸå®å›¾ç‰‡URLï¼ˆæ”¯æŒ1-9å¼ å›¾ç‰‡ï¼‰
                  if (msgData.postType === "realimag" && msgData.prompt) {
                    // æ”¯æŒ prompt ä¸ºæ•°ç»„ï¼ˆå¤šå¼ å›¾ç‰‡ï¼‰æˆ–å­—ç¬¦ä¸²ï¼ˆå•å¼ å›¾ç‰‡ï¼‰
                    const prompts = Array.isArray(msgData.prompt)
                      ? msgData.prompt.slice(0, 9)
                      : [msgData.prompt];

                    const pollApiKey = state.apiConfig.pollinationsApiKey;
                    const generatedImageUrls = [];

                    // ä½¿ç”¨ Promise.all å¹¶è¡Œå¤„ç†è¯·æ±‚ï¼Œæé«˜é€Ÿåº¦
                    await Promise.all(
                      prompts.map(async (prompt) => {
                        const encodedPrompt = encodeURIComponent(prompt);
                        const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?nologo=true&width=1024&height=1024`;

                        try {
                          if (pollApiKey) {
                            // å¦‚æœæœ‰ Keyï¼Œä½¿ç”¨ fetch è·å–å¹¶è½¬ä¸º Base64
                            const res = await fetch(url, {
                              headers: {
                                Authorization: `Bearer ${pollApiKey}`,
                              },
                            });
                            if (res.ok) {
                              const blob = await res.blob();
                              const base64 = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onloadend = () => resolve(reader.result);
                                reader.readAsDataURL(blob);
                              });
                              generatedImageUrls.push(base64);
                            } else {
                              console.warn(
                                `Pollinations fetch failed: ${res.status}, falling back to URL`,
                              );
                              generatedImageUrls.push(url);
                            }
                          } else {
                            // æ²¡æœ‰ Keyï¼Œç›´æ¥ä½¿ç”¨ URL
                            generatedImageUrls.push(url);
                          }
                        } catch (e) {
                          console.error(
                            "Pollinations image generation error:",
                            e,
                          );
                          generatedImageUrls.push(url); // å‡ºé”™æ—¶å›é€€åˆ° URL å°è¯•
                        }
                      }),
                    );

                    newPost.imageUrls = generatedImageUrls;

                    // ä¿æŒå‘åå…¼å®¹ï¼Œå•å¼ å›¾ç‰‡æ—¶ä¹Ÿè®¾ç½® imageUrl
                    if (generatedImageUrls.length === 1) {
                      newPost.imageUrl = generatedImageUrls[0];
                    }

                    newPost.prompt = msgData.prompt;
                    newPost.imageCount = generatedImageUrls.length;
                    console.log(
                      `åŠ¨æ€RealImagå›¾ç‰‡ç”Ÿæˆå®Œæˆ: ${generatedImageUrls.length}å¼ `,
                    );
                  }

                  // å¦‚æœæ˜¯naiimagç±»å‹ï¼Œè°ƒç”¨NovelAI APIç”Ÿæˆé«˜è´¨é‡å›¾ç‰‡ï¼ˆé™åˆ¶æœ€å¤š2å¼ ï¼‰
                  if (msgData.postType === "naiimag" && msgData.prompt) {
                    try {
                      // æ”¯æŒ prompt ä¸ºæ•°ç»„ï¼ˆå¤šå¼ å›¾ç‰‡ï¼‰æˆ–å­—ç¬¦ä¸²ï¼ˆå•å¼ å›¾ç‰‡ï¼‰
                      // åŠ¨æ€é™åˆ¶æœ€å¤š2å¼ NAIå›¾ç‰‡
                      const prompts = Array.isArray(msgData.prompt)
                        ? msgData.prompt.slice(0, 2)
                        : [msgData.prompt];
                      console.log(
                        `ğŸ“¸ åŠ¨æ€NovelAIå›¾ç‰‡ç”Ÿæˆå¼€å§‹ï¼Œå…±${prompts.length}å¼ å›¾ç‰‡`,
                      );

                      // å­˜å‚¨ç”Ÿæˆçš„å›¾ç‰‡URL
                      const generatedImageUrls = [];

                      // é€ä¸ªç”Ÿæˆå›¾ç‰‡
                      for (let i = 0; i < prompts.length; i++) {
                        const aiPrompt = prompts[i];
                        console.log(`ç”Ÿæˆç¬¬${i + 1}å¼ å›¾ç‰‡ï¼Œprompt:`, aiPrompt);

                        // è·å–è§’è‰²çš„NAIæç¤ºè¯é…ç½®ï¼ˆç³»ç»Ÿæˆ–è§’è‰²ä¸“å±ï¼‰
                        const naiPrompts = getCharacterNAIPrompts(chat.id);

                        // æ„å»ºæœ€ç»ˆçš„æç¤ºè¯ï¼šAIçš„prompt + é…ç½®çš„æç¤ºè¯
                        const finalPositivePrompt =
                          aiPrompt + ", " + naiPrompts.positive;
                        const finalNegativePrompt = naiPrompts.negative;

                        console.log(
                          `ğŸ“ ä½¿ç”¨${naiPrompts.source === "character" ? "è§’è‰²ä¸“å±" : "ç³»ç»Ÿ"}æç¤ºè¯é…ç½®`,
                        );
                        console.log("æœ€ç»ˆæ­£é¢æç¤ºè¯:", finalPositivePrompt);
                        console.log("æœ€ç»ˆè´Ÿé¢æç¤ºè¯:", finalNegativePrompt);

                        // è·å–NAIè®¾ç½®ï¼ˆä»localStorageè¯»å–ï¼‰
                        const apiKey = localStorage.getItem("novelai-api-key");
                        const model =
                          localStorage.getItem("novelai-model") ||
                          "nai-diffusion-4-5-full";
                        const settings = getNovelAISettings();

                        if (!apiKey) {
                          throw new Error(
                            "NovelAI API Keyæœªé…ç½®ã€‚è¯·åœ¨NovelAIè®¾ç½®ä¸­å¡«å†™API Keyã€‚",
                          );
                        }

                        const [width, height] = settings.resolution
                          .split("x")
                          .map(Number);

                        // â˜…â˜…â˜… V4/V4.5 å’Œ V3 ä½¿ç”¨ä¸åŒçš„è¯·æ±‚ä½“æ ¼å¼ â˜…â˜…â˜…
                        let requestBody;

                        if (model.includes("nai-diffusion-4")) {
                          // V4/V4.5 ä½¿ç”¨æ–°æ ¼å¼ (params_version: 3)
                          requestBody = {
                            input: finalPositivePrompt,
                            model: model,
                            action: "generate",
                            parameters: {
                              params_version: 3, // V4å¿…é¡»ä½¿ç”¨ç‰ˆæœ¬3
                              width: width,
                              height: height,
                              scale: settings.cfg_scale,
                              sampler: settings.sampler,
                              steps: settings.steps,
                              seed:
                                settings.seed === -1
                                  ? Math.floor(Math.random() * 9999999999)
                                  : settings.seed,
                              n_samples: 1,
                              ucPreset: settings.uc_preset,
                              qualityToggle: settings.quality_toggle,
                              autoSmea: false,
                              dynamic_thresholding: false,
                              controlnet_strength: 1,
                              legacy: false,
                              add_original_image: true,
                              cfg_rescale: 0,
                              noise_schedule: "karras", // V4ä½¿ç”¨karras
                              legacy_v3_extend: false,
                              skip_cfg_above_sigma: null,
                              use_coords: false,
                              legacy_uc: false,
                              normalize_reference_strength_multiple: true,
                              inpaintImg2ImgStrength: 1,
                              characterPrompts: [],
                              // V4ä¸“ç”¨æç¤ºè¯æ ¼å¼
                              v4_prompt: {
                                caption: {
                                  base_caption: finalPositivePrompt,
                                  char_captions: [],
                                },
                                use_coords: false,
                                use_order: true,
                              },
                              // V4ä¸“ç”¨è´Ÿé¢æç¤ºè¯æ ¼å¼
                              v4_negative_prompt: {
                                caption: {
                                  base_caption: finalNegativePrompt,
                                  char_captions: [],
                                },
                                legacy_uc: false,
                              },
                              negative_prompt: finalNegativePrompt,
                              deliberate_euler_ancestral_bug: false,
                              prefer_brownian: true,
                              // æ³¨æ„ï¼šä¸åŒ…å« stream å‚æ•°ï¼Œä½¿ç”¨æ ‡å‡†ZIPå“åº”è€Œémsgpackæµ
                            },
                          };
                        } else {
                          // V3 åŠæ›´æ—©ç‰ˆæœ¬ä½¿ç”¨æ—§æ ¼å¼
                          requestBody = {
                            input: finalPositivePrompt,
                            model: model,
                            action: "generate",
                            parameters: {
                              width: width,
                              height: height,
                              scale: settings.cfg_scale,
                              sampler: settings.sampler,
                              steps: settings.steps,
                              seed:
                                settings.seed === -1
                                  ? Math.floor(Math.random() * 9999999999)
                                  : settings.seed,
                              n_samples: 1,
                              ucPreset: settings.uc_preset,
                              qualityToggle: settings.quality_toggle,
                              sm: settings.smea,
                              sm_dyn: settings.smea_dyn,
                              dynamic_thresholding: false,
                              controlnet_strength: 1,
                              legacy: false,
                              add_original_image: false,
                              cfg_rescale: 0,
                              noise_schedule: "native",
                              negative_prompt: finalNegativePrompt,
                            },
                          };
                        }

                        console.log("ğŸš€ å‘é€NAIè¯·æ±‚:", requestBody);

                        // æ ¹æ®æ¨¡å‹é€‰æ‹©ä¸åŒçš„APIç«¯ç‚¹
                        let apiUrl;

                        // V4/V4.5 æ¨¡å‹ä½¿ç”¨æµå¼ç«¯ç‚¹
                        if (model.includes("nai-diffusion-4")) {
                          // V4/V4.5 é»˜è®¤ä½¿ç”¨æµå¼ç«¯ç‚¹
                          apiUrl =
                            "https://image.novelai.net/ai/generate-image-stream";
                        } else {
                          // V3 åŠæ›´æ—©ç‰ˆæœ¬ä½¿ç”¨æ ‡å‡†ç«¯ç‚¹
                          apiUrl =
                            "https://image.novelai.net/ai/generate-image";
                        }

                        let corsProxy = settings.cors_proxy;

                        // å¦‚æœé€‰æ‹©äº†è‡ªå®šä¹‰ä»£ç†ï¼Œä½¿ç”¨è‡ªå®šä¹‰URL
                        if (corsProxy === "custom") {
                          corsProxy = settings.custom_proxy_url || "";
                        }

                        // å¦‚æœæœ‰ä»£ç†ï¼Œæ·»åŠ åˆ°URLå‰é¢
                        if (corsProxy && corsProxy !== "") {
                          apiUrl = corsProxy + encodeURIComponent(apiUrl);
                        }

                        const response = await fetch(apiUrl, {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            Authorization: "Bearer " + apiKey,
                          },
                          body: JSON.stringify(requestBody),
                        });

                        console.log("Response status:", response.status);
                        console.log("Response headers:", [
                          ...response.headers.entries(),
                        ]);

                        if (!response.ok) {
                          const errorText = await response.text();
                          console.error("APIé”™è¯¯å“åº”:", errorText);
                          throw new Error(
                            `APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`,
                          );
                        }

                        // NovelAI APIè¿”å›çš„æ˜¯ZIPæ–‡ä»¶ï¼Œéœ€è¦è§£å‹
                        const contentType =
                          response.headers.get("content-type");
                        console.log("Content-Type:", contentType);

                        // æ£€æŸ¥æ˜¯å¦ä¸º SSE æµå¼å“åº”
                        let zipBlob;
                        let imageDataUrl;
                        if (
                          contentType &&
                          contentType.includes("text/event-stream")
                        ) {
                          console.log("æ£€æµ‹åˆ° SSE æµå¼å“åº”ï¼Œå¼€å§‹è§£æ...");

                          // è¯»å–æ•´ä¸ªæµ
                          const text = await response.text();
                          console.log("æ”¶åˆ° SSE æ•°æ®ï¼Œå¤§å°:", text.length);

                          // è§£æ SSE æ ¼å¼ï¼Œæå–æœ€åçš„ data: è¡Œ
                          const lines = text.trim().split("\n");
                          let base64Data = null;

                          for (let i = lines.length - 1; i >= 0; i--) {
                            const line = lines[i].trim();
                            if (
                              line.startsWith("data: ") &&
                              line !== "data: [DONE]"
                            ) {
                              const dataContent = line.substring(6); // ç§»é™¤ 'data: ' å‰ç¼€

                              // å°è¯•è§£æ JSON
                              try {
                                const jsonData = JSON.parse(dataContent);

                                // V4.5 æµå¼ç«¯ç‚¹ï¼ševent_type ä¸º "final" æ—¶åŒ…å«æœ€ç»ˆå›¾ç‰‡
                                if (
                                  jsonData.event_type === "final" &&
                                  jsonData.image
                                ) {
                                  base64Data = jsonData.image;
                                  console.log("âœ… æ‰¾åˆ° final äº‹ä»¶çš„å›¾ç‰‡æ•°æ®");
                                  break;
                                }

                                // å…¼å®¹å…¶ä»–æ ¼å¼
                                if (jsonData.data) {
                                  base64Data = jsonData.data;
                                  console.log("ä» JSON.data ä¸­æå–å›¾ç‰‡æ•°æ®");
                                  break;
                                }
                                if (jsonData.image) {
                                  base64Data = jsonData.image;
                                  console.log("ä» JSON.image ä¸­æå–å›¾ç‰‡æ•°æ®");
                                  break;
                                }
                              } catch (e) {
                                // å¦‚æœä¸æ˜¯ JSONï¼Œç›´æ¥ä½œä¸º base64 æ•°æ®
                                base64Data = dataContent;
                                console.log("ç›´æ¥ä½¿ç”¨ base64 æ•°æ®");
                                break;
                              }
                            }
                          }

                          if (!base64Data) {
                            throw new Error("æ— æ³•ä» SSE å“åº”ä¸­æå–å›¾ç‰‡æ•°æ®");
                          }

                          // V4.5 æµå¼ç«¯ç‚¹è¿”å›çš„æ˜¯ PNG base64ï¼Œä¸æ˜¯ ZIP
                          // æ£€æŸ¥æ˜¯å¦ä¸º PNG (ä»¥ iVBORw0KGgo å¼€å¤´) æˆ– JPEG (ä»¥ /9j/ å¼€å¤´)
                          const isPNG = base64Data.startsWith("iVBORw0KGgo");
                          const isJPEG = base64Data.startsWith("/9j/");

                          if (isPNG || isJPEG) {
                            console.log(
                              "âœ… æ£€æµ‹åˆ°ç›´æ¥çš„å›¾ç‰‡ base64 æ•°æ® (PNG/JPEG)",
                            );
                            // å°† base64 è½¬ä¸º Blob
                            const binaryString = atob(base64Data);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                              bytes[i] = binaryString.charCodeAt(i);
                            }
                            const imageBlob = new Blob([bytes], {
                              type: isPNG ? "image/png" : "image/jpeg",
                            });
                            console.log(
                              "å›¾ç‰‡ Blob åˆ›å»ºæˆåŠŸï¼Œå¤§å°:",
                              imageBlob.size,
                            );

                            // è½¬æ¢ä¸ºdataURLç”¨äºåç»­å¤„ç†
                            const reader = new FileReader();
                            imageDataUrl = await new Promise(
                              (resolve, reject) => {
                                reader.onloadend = () => resolve(reader.result);
                                reader.onerror = reject;
                                reader.readAsDataURL(imageBlob);
                              },
                            );
                            console.log("âœ… å›¾ç‰‡è½¬æ¢æˆåŠŸï¼ğŸ¨");
                          } else {
                            // å¦åˆ™å½“ä½œ ZIP å¤„ç†
                            console.log("å½“ä½œ ZIP æ–‡ä»¶å¤„ç†...");
                            const binaryString = atob(base64Data);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                              bytes[i] = binaryString.charCodeAt(i);
                            }
                            zipBlob = new Blob([bytes]);
                            console.log("ZIP Blob å¤§å°:", zipBlob.size);
                          }
                        } else {
                          // éæµå¼å“åº”ï¼Œç›´æ¥è¯»å–
                          zipBlob = await response.blob();
                          console.log(
                            "æ”¶åˆ°æ•°æ®ï¼Œç±»å‹:",
                            zipBlob.type,
                            "å¤§å°:",
                            zipBlob.size,
                          );
                        }

                        // å¦‚æœè¿˜æ²¡æœ‰imageDataUrlï¼ˆå³éœ€è¦è§£å‹ZIPï¼‰
                        if (!imageDataUrl && zipBlob) {
                          // NovelAIå§‹ç»ˆè¿”å›ZIPæ ¼å¼ï¼Œéœ€è¦è§£å‹
                          try {
                            // æ£€æŸ¥JSZipæ˜¯å¦å·²åŠ è½½
                            if (typeof JSZip === "undefined") {
                              throw new Error("JSZipåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
                            }

                            // è§£å‹ZIPæ–‡ä»¶
                            const zip = await JSZip.loadAsync(zipBlob);
                            console.log("ZIPæ–‡ä»¶å†…å®¹:", Object.keys(zip.files));

                            // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯image_0.pngï¼‰
                            let imageFile = null;
                            for (let filename in zip.files) {
                              if (filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
                                imageFile = zip.files[filename];
                                console.log("æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶:", filename);
                                break;
                              }
                            }

                            if (!imageFile) {
                              throw new Error("ZIPæ–‡ä»¶ä¸­æœªæ‰¾åˆ°å›¾ç‰‡");
                            }

                            // æå–å›¾ç‰‡æ•°æ®
                            const imageBlob = await imageFile.async("blob");
                            console.log("æå–çš„å›¾ç‰‡å¤§å°:", imageBlob.size);

                            // åˆ›å»ºå›¾ç‰‡URL
                            const reader = new FileReader();
                            imageDataUrl = await new Promise(
                              (resolve, reject) => {
                                reader.onloadend = () => resolve(reader.result);
                                reader.onerror = reject;
                                reader.readAsDataURL(imageBlob);
                              },
                            );
                            console.log("âœ… å›¾ç‰‡è§£å‹æˆåŠŸï¼");
                          } catch (zipError) {
                            console.error("ZIPè§£å‹å¤±è´¥:", zipError);
                            throw new Error(
                              "å›¾ç‰‡è§£å‹å¤±è´¥: " + zipError.message,
                            );
                          }
                        }

                        console.log(`âœ… NAIå›¾ç‰‡${i + 1}ç”ŸæˆæˆåŠŸï¼`);
                        generatedImageUrls.push(imageDataUrl);
                      }

                      // å°†ç”Ÿæˆçš„å›¾ç‰‡URLä¿å­˜åˆ°åŠ¨æ€ä¸­
                      newPost.imageUrls = generatedImageUrls;

                      // ä¿æŒå‘åå…¼å®¹ï¼Œå•å¼ å›¾ç‰‡æ—¶ä¹Ÿè®¾ç½® imageUrl
                      if (generatedImageUrls.length === 1) {
                        newPost.imageUrl = generatedImageUrls[0];
                      }

                      newPost.prompt = msgData.prompt;
                      newPost.imageCount = generatedImageUrls.length;
                      console.log(
                        `âœ… åŠ¨æ€NovelAIå›¾ç‰‡å…¨éƒ¨ç”Ÿæˆå®Œæˆ: ${generatedImageUrls.length}å¼ `,
                      );
                    } catch (error) {
                      console.error("âŒ åŠ¨æ€NAIå›¾ç‰‡ç”Ÿæˆå¤±è´¥:", error);
                      // å¤±è´¥æ—¶ä»ç„¶å‘å¸ƒåŠ¨æ€ï¼Œä½†æ·»åŠ é”™è¯¯ä¿¡æ¯
                      newPost.content =
                        (newPost.content || newPost.publicText || "") +
                        `\n[å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${error.message}]`;
                    }
                  }

                  await db.qzonePosts.add(newPost);
                  updateUnreadIndicator(unreadPostsCount + 1);
                  if (
                    isViewingThisChat &&
                    document
                      .getElementById("qzone-screen")
                      .classList.contains("active")
                  ) {
                    await renderQzonePosts();
                  }
                  continue;

                case "qzone_comment":
                  const postToComment = await db.qzonePosts.get(
                    parseInt(msgData.postId),
                  );
                  if (postToComment) {
                    if (!postToComment.comments) postToComment.comments = [];

                    const newAiComment = {
                      commenterName: msgData.commenterName || chat.name,
                      text: msgData.commentText,
                      timestamp: Date.now(),
                    };

                    // æ£€æŸ¥AIæ˜¯å¦æŒ‡å®šäº†å›å¤å¯¹è±¡
                    if (msgData.replyTo) {
                      newAiComment.replyTo = msgData.replyTo;
                    }

                    postToComment.comments.push(newAiComment);
                    await db.qzonePosts.update(postToComment.id, {
                      comments: postToComment.comments,
                    });
                    updateUnreadIndicator(unreadPostsCount + 1);
                    if (
                      isViewingThisChat &&
                      document
                        .getElementById("qzone-screen")
                        .classList.contains("active")
                    ) {
                      await renderQzonePosts();
                    }
                  }
                  continue;

                // ç¾¤èŠä¸­å‘é€naiimagçš„å®Œæ•´é€»è¾‘
                case "naiimag":
                  // NovelAIå›¾ç‰‡åˆ†äº« - è°ƒç”¨NovelAI APIç”Ÿæˆé«˜è´¨é‡å›¾ç‰‡
                  try {
                    console.log(
                      "ğŸ“¸ NovelAIå›¾ç‰‡ç”Ÿæˆå¼€å§‹ï¼ŒAIæä¾›çš„prompt:",
                      msgData.prompt,
                    );

                    // è·å–è§’è‰²çš„NAIæç¤ºè¯é…ç½®ï¼ˆç³»ç»Ÿæˆ–è§’è‰²ä¸“å±ï¼‰
                    const naiPrompts = getCharacterNAIPrompts(chat.id);

                    // æ„å»ºæœ€ç»ˆçš„æç¤ºè¯ï¼šAIçš„prompt + é…ç½®çš„æç¤ºè¯
                    const aiPrompt = msgData.prompt || "a beautiful scene";
                    const finalPositivePrompt =
                      aiPrompt + ", " + naiPrompts.positive;
                    const finalNegativePrompt = naiPrompts.negative;

                    console.log(
                      `ğŸ“ ä½¿ç”¨${naiPrompts.source === "character" ? "è§’è‰²ä¸“å±" : "ç³»ç»Ÿ"}æç¤ºè¯é…ç½®`,
                    );
                    console.log("æœ€ç»ˆæ­£é¢æç¤ºè¯:", finalPositivePrompt);
                    console.log("æœ€ç»ˆè´Ÿé¢æç¤ºè¯:", finalNegativePrompt);

                    // è·å–NAIè®¾ç½®ï¼ˆä»localStorageè¯»å–ï¼‰
                    const apiKey = localStorage.getItem("novelai-api-key");
                    const model =
                      localStorage.getItem("novelai-model") ||
                      "nai-diffusion-4-5-full";
                    const settings = getNovelAISettings();
                    if (!apiKey) {
                      throw new Error(
                        "NovelAI API Keyæœªé…ç½®ã€‚è¯·åœ¨NovelAIè®¾ç½®ä¸­å¡«å†™API Keyã€‚",
                      );
                    }

                    const [width, height] = settings.resolution
                      .split("x")
                      .map(Number);

                    // â˜…â˜…â˜… V4/V4.5 å’Œ V3 ä½¿ç”¨ä¸åŒçš„è¯·æ±‚ä½“æ ¼å¼ â˜…â˜…â˜…
                    let requestBody;

                    if (model.includes("nai-diffusion-4")) {
                      // V4/V4.5 ä½¿ç”¨æ–°æ ¼å¼ (params_version: 3)
                      requestBody = {
                        input: finalPositivePrompt,
                        model: model,
                        action: "generate",
                        parameters: {
                          params_version: 3, // V4å¿…é¡»ä½¿ç”¨ç‰ˆæœ¬3
                          width: width,
                          height: height,
                          scale: settings.cfg_scale,
                          sampler: settings.sampler,
                          steps: settings.steps,
                          seed:
                            settings.seed === -1
                              ? Math.floor(Math.random() * 9999999999)
                              : settings.seed,
                          n_samples: 1,
                          ucPreset: settings.uc_preset,
                          qualityToggle: settings.quality_toggle,
                          autoSmea: false,
                          dynamic_thresholding: false,
                          controlnet_strength: 1,
                          legacy: false,
                          add_original_image: true,
                          cfg_rescale: 0,
                          noise_schedule: "karras", // V4ä½¿ç”¨karras
                          legacy_v3_extend: false,
                          skip_cfg_above_sigma: null,
                          use_coords: false,
                          legacy_uc: false,
                          normalize_reference_strength_multiple: true,
                          inpaintImg2ImgStrength: 1,
                          characterPrompts: [],
                          // V4ä¸“ç”¨æç¤ºè¯æ ¼å¼
                          v4_prompt: {
                            caption: {
                              base_caption: finalPositivePrompt,
                              char_captions: [],
                            },
                            use_coords: false,
                            use_order: true,
                          },
                          // V4ä¸“ç”¨è´Ÿé¢æç¤ºè¯æ ¼å¼
                          v4_negative_prompt: {
                            caption: {
                              base_caption: finalNegativePrompt,
                              char_captions: [],
                            },
                            legacy_uc: false,
                          },
                          negative_prompt: finalNegativePrompt,
                          deliberate_euler_ancestral_bug: false,
                          prefer_brownian: true,
                          // æ³¨æ„ï¼šä¸åŒ…å« stream å‚æ•°ï¼Œä½¿ç”¨æ ‡å‡†ZIPå“åº”è€Œémsgpackæµ
                        },
                      };
                    } else {
                      // V3 åŠæ›´æ—©ç‰ˆæœ¬ä½¿ç”¨æ—§æ ¼å¼
                      requestBody = {
                        input: finalPositivePrompt,
                        model: model,
                        action: "generate",
                        parameters: {
                          width: width,
                          height: height,
                          scale: settings.cfg_scale,
                          sampler: settings.sampler,
                          steps: settings.steps,
                          seed:
                            settings.seed === -1
                              ? Math.floor(Math.random() * 9999999999)
                              : settings.seed,
                          n_samples: 1,
                          ucPreset: settings.uc_preset,
                          qualityToggle: settings.quality_toggle,
                          sm: settings.smea,
                          sm_dyn: settings.smea_dyn,
                          dynamic_thresholding: false,
                          controlnet_strength: 1,
                          legacy: false,
                          add_original_image: false,
                          cfg_rescale: 0,
                          noise_schedule: "native",
                          negative_prompt: finalNegativePrompt,
                        },
                      };
                    }

                    console.log("ğŸš€ å‘é€NAIè¯·æ±‚:", requestBody);

                    // â˜…â˜…â˜… æ ¹æ®æ¨¡å‹é€‰æ‹©ä¸åŒçš„APIç«¯ç‚¹ â˜…â˜…â˜…
                    let apiUrl;

                    // V4/V4.5 æ¨¡å‹ä½¿ç”¨æµå¼ç«¯ç‚¹
                    if (model.includes("nai-diffusion-4")) {
                      // V4/V4.5 é»˜è®¤ä½¿ç”¨æµå¼ç«¯ç‚¹
                      apiUrl =
                        "https://image.novelai.net/ai/generate-image-stream";
                    } else {
                      // V3 åŠæ›´æ—©ç‰ˆæœ¬ä½¿ç”¨æ ‡å‡†ç«¯ç‚¹
                      apiUrl = "https://image.novelai.net/ai/generate-image";
                    }

                    let corsProxy = settings.cors_proxy;

                    // å¦‚æœé€‰æ‹©äº†è‡ªå®šä¹‰ä»£ç†ï¼Œä½¿ç”¨è‡ªå®šä¹‰URL
                    if (corsProxy === "custom") {
                      corsProxy = settings.custom_proxy_url || "";
                    }

                    // å¦‚æœæœ‰ä»£ç†ï¼Œæ·»åŠ åˆ°URLå‰é¢
                    if (corsProxy && corsProxy !== "") {
                      apiUrl = corsProxy + encodeURIComponent(apiUrl);
                    }

                    const response = await fetch(apiUrl, {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + apiKey,
                      },
                      body: JSON.stringify(requestBody),
                    });

                    console.log("Response status:", response.status);
                    console.log("Response headers:", [
                      ...response.headers.entries(),
                    ]);

                    if (!response.ok) {
                      const errorText = await response.text();
                      console.error("APIé”™è¯¯å“åº”:", errorText);
                      throw new Error(
                        `APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`,
                      );
                    }

                    // NovelAI APIè¿”å›çš„æ˜¯ZIPæ–‡ä»¶ï¼Œéœ€è¦è§£å‹
                    const contentType = response.headers.get("content-type");
                    console.log("Content-Type:", contentType);

                    // æ£€æŸ¥æ˜¯å¦ä¸º SSE æµå¼å“åº”
                    let zipBlob;
                    let imageDataUrl;
                    if (
                      contentType &&
                      contentType.includes("text/event-stream")
                    ) {
                      console.log("æ£€æµ‹åˆ° SSE æµå¼å“åº”ï¼Œå¼€å§‹è§£æ...");

                      // è¯»å–æ•´ä¸ªæµ
                      const text = await response.text();
                      console.log("æ”¶åˆ° SSE æ•°æ®ï¼Œå¤§å°:", text.length);

                      // è§£æ SSE æ ¼å¼ï¼Œæå–æœ€åçš„ data: è¡Œ
                      const lines = text.trim().split("\n");
                      let base64Data = null;

                      for (let i = lines.length - 1; i >= 0; i--) {
                        const line = lines[i].trim();
                        if (
                          line.startsWith("data: ") &&
                          line !== "data: [DONE]"
                        ) {
                          const dataContent = line.substring(6); // ç§»é™¤ 'data: ' å‰ç¼€

                          // å°è¯•è§£æ JSON
                          try {
                            const jsonData = JSON.parse(dataContent);

                            // V4.5 æµå¼ç«¯ç‚¹ï¼ševent_type ä¸º "final" æ—¶åŒ…å«æœ€ç»ˆå›¾ç‰‡
                            if (
                              jsonData.event_type === "final" &&
                              jsonData.image
                            ) {
                              base64Data = jsonData.image;
                              console.log("âœ… æ‰¾åˆ° final äº‹ä»¶çš„å›¾ç‰‡æ•°æ®");
                              break;
                            }

                            // å…¼å®¹å…¶ä»–æ ¼å¼
                            if (jsonData.data) {
                              base64Data = jsonData.data;
                              console.log("ä» JSON.data ä¸­æå–å›¾ç‰‡æ•°æ®");
                              break;
                            }
                            if (jsonData.image) {
                              base64Data = jsonData.image;
                              console.log("ä» JSON.image ä¸­æå–å›¾ç‰‡æ•°æ®");
                              break;
                            }
                          } catch (e) {
                            // å¦‚æœä¸æ˜¯ JSONï¼Œç›´æ¥ä½œä¸º base64 æ•°æ®
                            base64Data = dataContent;
                            console.log("ç›´æ¥ä½¿ç”¨ base64 æ•°æ®");
                            break;
                          }
                        }
                      }

                      if (!base64Data) {
                        throw new Error("æ— æ³•ä» SSE å“åº”ä¸­æå–å›¾ç‰‡æ•°æ®");
                      }

                      // V4.5 æµå¼ç«¯ç‚¹è¿”å›çš„æ˜¯ PNG base64ï¼Œä¸æ˜¯ ZIP
                      // æ£€æŸ¥æ˜¯å¦ä¸º PNG (ä»¥ iVBORw0KGgo å¼€å¤´) æˆ– JPEG (ä»¥ /9j/ å¼€å¤´)
                      const isPNG = base64Data.startsWith("iVBORw0KGgo");
                      const isJPEG = base64Data.startsWith("/9j/");

                      if (isPNG || isJPEG) {
                        console.log(
                          "âœ… æ£€æµ‹åˆ°ç›´æ¥çš„å›¾ç‰‡ base64 æ•°æ® (PNG/JPEG)",
                        );
                        // å°† base64 è½¬ä¸º Blob
                        const binaryString = atob(base64Data);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                          bytes[i] = binaryString.charCodeAt(i);
                        }
                        const imageBlob = new Blob([bytes], {
                          type: isPNG ? "image/png" : "image/jpeg",
                        });
                        console.log(
                          "å›¾ç‰‡ Blob åˆ›å»ºæˆåŠŸï¼Œå¤§å°:",
                          imageBlob.size,
                        );

                        // è½¬æ¢ä¸ºdataURLç”¨äºåç»­å¤„ç†
                        const reader = new FileReader();
                        imageDataUrl = await new Promise((resolve, reject) => {
                          reader.onloadend = () => resolve(reader.result);
                          reader.onerror = reject;
                          reader.readAsDataURL(imageBlob);
                        });
                        console.log("âœ… å›¾ç‰‡è½¬æ¢æˆåŠŸï¼ğŸ¨");
                      } else {
                        // å¦åˆ™å½“ä½œ ZIP å¤„ç†
                        console.log("å½“ä½œ ZIP æ–‡ä»¶å¤„ç†...");
                        const binaryString = atob(base64Data);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                          bytes[i] = binaryString.charCodeAt(i);
                        }
                        zipBlob = new Blob([bytes]);
                        console.log("ZIP Blob å¤§å°:", zipBlob.size);
                      }
                    } else {
                      // éæµå¼å“åº”ï¼Œç›´æ¥è¯»å–
                      zipBlob = await response.blob();
                      console.log(
                        "æ”¶åˆ°æ•°æ®ï¼Œç±»å‹:",
                        zipBlob.type,
                        "å¤§å°:",
                        zipBlob.size,
                      );
                    }

                    // å¦‚æœè¿˜æ²¡æœ‰imageDataUrlï¼ˆå³éœ€è¦è§£å‹ZIPï¼‰
                    if (!imageDataUrl && zipBlob) {
                      // NovelAIå§‹ç»ˆè¿”å›ZIPæ ¼å¼ï¼Œéœ€è¦è§£å‹
                      try {
                        // æ£€æŸ¥JSZipæ˜¯å¦å·²åŠ è½½
                        if (typeof JSZip === "undefined") {
                          throw new Error("JSZipåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
                        }

                        // è§£å‹ZIPæ–‡ä»¶
                        const zip = await JSZip.loadAsync(zipBlob);
                        console.log("ZIPæ–‡ä»¶å†…å®¹:", Object.keys(zip.files));

                        // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯image_0.pngï¼‰
                        let imageFile = null;
                        for (let filename in zip.files) {
                          if (filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
                            imageFile = zip.files[filename];
                            console.log("æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶:", filename);
                            break;
                          }
                        }

                        if (!imageFile) {
                          throw new Error("ZIPæ–‡ä»¶ä¸­æœªæ‰¾åˆ°å›¾ç‰‡");
                        }

                        // æå–å›¾ç‰‡æ•°æ®
                        const imageBlob = await imageFile.async("blob");
                        console.log("æå–çš„å›¾ç‰‡å¤§å°:", imageBlob.size);

                        // åˆ›å»ºå›¾ç‰‡URL
                        const reader = new FileReader();
                        imageDataUrl = await new Promise((resolve, reject) => {
                          reader.onloadend = () => resolve(reader.result);
                          reader.onerror = reject;
                          reader.readAsDataURL(imageBlob);
                        });
                        console.log("âœ… å›¾ç‰‡è§£å‹æˆåŠŸï¼");
                      } catch (zipError) {
                        console.error("ZIPè§£å‹å¤±è´¥:", zipError);
                        throw new Error("å›¾ç‰‡è§£å‹å¤±è´¥: " + zipError.message);
                      }
                    }

                    console.log("âœ… NAIå›¾ç‰‡ç”ŸæˆæˆåŠŸï¼");

                    // åˆ›å»ºnaiimagæ¶ˆæ¯
                    aiMessage = {
                      ...baseMessage,
                      type: "naiimag",
                      imageUrl: imageDataUrl,
                      prompt: aiPrompt,
                      fullPrompt: finalPositivePrompt, // ä¿å­˜å®Œæ•´æç¤ºè¯ä¾›æŸ¥çœ‹
                    };
                  } catch (error) {
                    console.error("âŒ NAIå›¾ç‰‡ç”Ÿæˆå¤±è´¥:", error);
                    // å¤±è´¥æ—¶é™çº§ä¸ºæ–‡æœ¬æ¶ˆæ¯
                    aiMessage = {
                      ...baseMessage,
                      content: `[å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${error.message}]`,
                    };
                  }
                  break;

                case "qzone_like":
                  const postToLike = await db.qzonePosts.get(
                    parseInt(msgData.postId),
                  );
                  if (postToLike) {
                    if (!postToLike.likes) postToLike.likes = [];
                    if (!postToLike.likes.includes(chat.name)) {
                      postToLike.likes.push(chat.name);
                      await db.qzonePosts.update(postToLike.id, {
                        likes: postToLike.likes,
                      });
                      updateUnreadIndicator(unreadPostsCount + 1);
                      if (
                        isViewingThisChat &&
                        document
                          .getElementById("qzone-screen")
                          .classList.contains("active")
                      ) {
                        await renderQzonePosts();
                      }
                    }
                  }
                  continue;

                case "video_call_request":
                  if (
                    !videoCallState.isActive &&
                    !videoCallState.isAwaitingResponse
                  ) {
                    state.activeChatId = chatId;
                    videoCallState.activeChatId = chatId;
                    videoCallState.isAwaitingResponse = true;
                    videoCallState.isGroupCall = chat.isGroup;
                    videoCallState.callRequester = msgData.name || chat.name;
                    showIncomingCallModal(chatId); // <--- æŠŠchatIdä½œä¸ºå‚æ•°ä¼ è¿›å»
                  }
                  continue;

                case "group_call_request":
                  if (
                    !videoCallState.isActive &&
                    !videoCallState.isAwaitingResponse
                  ) {
                    state.activeChatId = chatId;
                    videoCallState.isAwaitingResponse = true;
                    videoCallState.isGroupCall = true;
                    videoCallState.initiator = "ai";
                    videoCallState.callRequester = msgData.name;
                    showIncomingCallModal();
                  }
                  continue;

                case "pat_user":
                  const suffix = msgData.suffix
                    ? ` ${msgData.suffix.trim()}`
                    : "";
                  const patText = `${msgData.name || chat.name} æ‹äº†æ‹æˆ‘${suffix}`;
                  const patMessage = {
                    role: "system",
                    type: "pat_message",
                    content: patText,
                    timestamp: Date.now(),
                  };
                  chat.history.push(patMessage);
                  if (isViewingThisChat) {
                    const phoneScreen = document.getElementById("phone-screen");
                    phoneScreen.classList.remove("pat-animation");
                    void phoneScreen.offsetWidth;
                    phoneScreen.classList.add("pat-animation");
                    setTimeout(
                      () => phoneScreen.classList.remove("pat-animation"),
                      500,
                    );
                    appendMessage(patMessage, chat);
                  } else {
                    showNotification(chatId, patText);
                  }
                  continue;

                case "update_status":
                  chat.status.text = msgData.status_text;
                  chat.status.isBusy = msgData.is_busy || false;
                  chat.status.lastUpdate = Date.now();

                  const statusUpdateMessage = {
                    role: "system",
                    type: "pat_message",
                    content: `[${chat.name}çš„çŠ¶æ€å·²æ›´æ–°ä¸º: ${msgData.status_text}]`,
                    timestamp: Date.now(),
                  };
                  chat.history.push(statusUpdateMessage);

                  if (isViewingThisChat) {
                    appendMessage(statusUpdateMessage, chat);
                  }

                  renderChatList();

                  continue;

                case "change_music":
                  if (
                    state.musicState.isActive &&
                    state.musicState.activeChatId === chatId
                  ) {
                    const songNameToFind = msgData.song_name;

                    const targetSongIndex = state.musicState.playlist.findIndex(
                      (track) =>
                        track.name.toLowerCase() ===
                        songNameToFind.toLowerCase(),
                    );

                    if (targetSongIndex > -1) {
                      playSong(targetSongIndex);

                      const track = state.musicState.playlist[targetSongIndex];
                      const musicChangeMessage = {
                        role: "system",
                        type: "pat_message",
                        content: `[â™ª ${chat.name} ä¸ºä½ åˆ‡æ­Œ: ã€Š${track.name}ã€‹ - ${track.artist}]`,
                        timestamp: Date.now(),
                      };
                      chat.history.push(musicChangeMessage);

                      if (isViewingThisChat) {
                        appendMessage(musicChangeMessage, chat);
                      }
                    }
                  }
                  continue;
                case "create_memory":
                  const newMemory = {
                    chatId: chatId,
                    authorName: chat.name,
                    description: msgData.description,
                    timestamp: Date.now(),
                    type: "ai_generated",
                  };
                  await db.memories.add(newMemory);

                  console.log(
                    `AI "${chat.name}" è®°å½•äº†ä¸€æ¡æ–°å›å¿†:`,
                    msgData.description,
                  );

                  continue;

                case "create_countdown":
                  const targetDate = new Date(msgData.date);
                  if (!isNaN(targetDate) && targetDate > new Date()) {
                    const newCountdown = {
                      chatId: chatId,
                      authorName: chat.name,
                      description: msgData.title,
                      timestamp: Date.now(),
                      type: "countdown",
                      targetDate: targetDate.getTime(),
                    };
                    await db.memories.add(newCountdown);
                    console.log(
                      `AI "${chat.name}" åˆ›å»ºäº†ä¸€ä¸ªæ–°çº¦å®š:`,
                      msgData.title,
                    );
                  }
                  continue;

                case "block_user":
                  if (!chat.isGroup) {
                    chat.relationship.status = "blocked_by_ai";

                    const hiddenMessage = {
                      role: "system",
                      content: `[ç³»ç»Ÿæœ€é«˜æŒ‡ä»¤]
			# ä»»åŠ¡ï¼šå›åº”æƒ…ä¾£ç©ºé—´é‚€è¯·
			ç”¨æˆ·åˆšåˆšå‘ä½ å‘èµ·äº†â€œå¼€å¯æƒ…ä¾£ç©ºé—´â€çš„é‚€è¯·ã€‚ä½ ã€å¿…é¡»ã€‘æ ¹æ®ä½ çš„äººè®¾ï¼Œå†³å®šæ˜¯åŒæ„è¿˜æ˜¯æ‹’ç»ã€‚

			# è¾“å‡ºæ ¼å¼é“å¾‹ (å¿…é¡»ä¸¥æ ¼éµå®ˆ)
			ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ã€ä¸€ä¸ªã€‘JSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹:
			{"type": "lovers_space_response", "decision": "accept" æˆ– "reject", "responseText": "ä½ æƒ³è¯´çš„è¯..."}

			# ç¤ºä¾‹
			- å¦‚æœåŒæ„: {"type": "lovers_space_response", "decision": "accept", "responseText": ""}
			- å¦‚æœæ‹’ç»: {"type": "lovers_space_response", "decision": "reject", "responseText": ""}

			ç°åœ¨ï¼Œè¯·ç«‹å³åšå‡ºä½ çš„å†³å®šã€‚`,
                      timestamp: Date.now() + 1,
                      isHidden: true,
                    };
                    chat.history.push(hiddenMessage);

                    await db.chats.put(chat);

                    if (isViewingThisChat) {
                      renderChatInterface(chatId);
                    }
                    renderChatList();

                    break;
                  }
                  continue;
                case "friend_request_response":
                  if (
                    !chat.isGroup &&
                    chat.relationship.status === "pending_ai_approval"
                  ) {
                    if (msgData.decision === "accept") {
                      chat.relationship.status = "friend";
                      aiMessage = {
                        ...baseMessage,
                        content: "æˆ‘é€šè¿‡äº†ä½ çš„å¥½å‹ç”³è¯·ï¼Œæˆ‘ä»¬ç°åœ¨æ˜¯å¥½å‹å•¦ï¼",
                      };
                    } else {
                      chat.relationship.status = "blocked_by_ai";
                      aiMessage = {
                        ...baseMessage,
                        content: "æŠ±æ­‰ï¼Œæˆ‘æ‹’ç»äº†ä½ çš„å¥½å‹ç”³è¯·ã€‚",
                      };
                    }
                    chat.relationship.applicationReason = "";
                  }
                  break;

                case "poll": {
                  // åŒæ—¶å¤„ç†æ¥è‡ªAIå’Œç”¨æˆ·çš„æŠ•ç¥¨æ¶ˆæ¯
                  let pollInfoText = "";

                  // åˆ¤æ–­è¿™æ¡æŠ•ç¥¨æ¶ˆæ¯æ˜¯è°å‘çš„
                  if (msg.role === "user") {
                    const myNickname = chat.isGroup
                      ? chat.settings.myNickname || "æˆ‘"
                      : "æˆ‘";
                    pollInfoText = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) å‘èµ·äº†ä¸€ä¸ªæŠ•ç¥¨ã€‚é—®é¢˜ï¼šâ€œ${
                      msg.question
                    }â€, é€‰é¡¹ï¼šâ€œ${msg.options.join('", "')}â€ã€‚ä½ å¯ä»¥ä½¿ç”¨ 'vote' æŒ‡ä»¤å‚ä¸æŠ•ç¥¨ã€‚]`;
                  } else {
                    // å¦‚æœæ˜¯AIå‘çš„
                    pollInfoText = `[ç³»ç»Ÿæç¤ºï¼š${msg.senderName} å‘èµ·äº†ä¸€ä¸ªæŠ•ç¥¨ã€‚é—®é¢˜ï¼šâ€œ${
                      msg.question
                    }â€, é€‰é¡¹ï¼šâ€œ${msg.options.join('", "')}â€ã€‚]`;
                  }

                  // æœ€ç»ˆï¼Œæˆ‘ä»¬æŠŠè¿™æ¡æ ¼å¼åŒ–å¥½çš„æ–‡æœ¬ä½œä¸ºç³»ç»Ÿæ¶ˆæ¯å‘é€ç»™AI
                  // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¿®æ”¹åŸå§‹çš„aiMessage
                  // å› æ­¤ï¼Œæˆ‘ä»¬å°†å®ƒæ”¾åœ¨äº†messagesPayloadçš„æ„å»ºå¾ªç¯é‡Œ
                  aiMessage = {
                    role: "system",
                    content: pollInfoText,
                    isHidden: true,
                  };
                  break; // breakä¸èƒ½å°‘
                }

                case "vote": {
                  // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºç‹¬ç«‹çš„å—çº§ä½œç”¨åŸŸ
                  const pollToVote = chat.history.find(
                    (m) => m.timestamp === msgData.poll_timestamp,
                  );

                  // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæŠ•ç¥¨ä¸å­˜åœ¨æˆ–å·²å…³é—­ï¼Œåˆ™ä¸å¤„ç†
                  if (pollToVote && !pollToVote.isClosed) {
                    // 1. æ ¹æ®AIçš„â€œæœ¬åâ€ï¼Œæ‰¾åˆ°å…¶æˆå‘˜å¯¹è±¡ï¼Œå¹¶è·å–æ­£ç¡®çš„â€œç¾¤æ˜µç§°â€
                    const member = chat.members.find(
                      (m) => m.originalName === msgData.name,
                    );
                    const displayName = member
                      ? member.groupNickname
                      : msgData.name;

                    // 2. ä½¿ç”¨æ­£ç¡®çš„â€œç¾¤æ˜µç§°â€å»ç§»é™¤è¯¥è§’è‰²ä¹‹å‰çš„æ‰€æœ‰æŠ•ç¥¨
                    Object.keys(pollToVote.votes).forEach((option) => {
                      const voterIndex =
                        pollToVote.votes[option].indexOf(displayName); // ä½¿ç”¨ displayName
                      if (voterIndex > -1) {
                        pollToVote.votes[option].splice(voterIndex, 1);
                      }
                    });

                    // 3. å°†â€œç¾¤æ˜µç§°â€æ·»åŠ åˆ°æ–°çš„é€‰é¡¹ä¸­
                    if (!pollToVote.votes[msgData.choice]) {
                      pollToVote.votes[msgData.choice] = [];
                    }

                    // ï¼ˆå¯é€‰ä½†æ¨èï¼‰å†æ¬¡æ£€æŸ¥ï¼Œé¿å…æ„å¤–é‡å¤æ·»åŠ 
                    if (
                      !pollToVote.votes[msgData.choice].includes(displayName)
                    ) {
                      pollToVote.votes[msgData.choice].push(displayName);
                    }

                    // å¦‚æœç”¨æˆ·æ­£åœ¨çœ‹è¿™ä¸ªèŠå¤©ï¼Œå°±åˆ·æ–°ç•Œé¢è®©ä»–ä»¬çœ‹åˆ°å˜åŒ–
                    if (isViewingThisChat) {
                      renderChatInterface(chatId);
                    }
                  }
                  // è¿™æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œä¸éœ€è¦ç”Ÿæˆæ–°çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥ç”¨ continue
                  continue;
                }

                case "red_packet":
                  aiMessage = {
                    ...baseMessage,
                    type: "red_packet",
                    packetType: msgData.packetType,
                    totalAmount: msgData.amount,
                    count: msgData.count,
                    greeting: msgData.greeting,
                    receiverName: msgData.receiver,
                    claimedBy: {},
                    isFullyClaimed: false,
                  };

                  // åŒæ­¥åˆ°è§’è‰²é’±åŒ…ï¼ˆæ”¯å‡ºï¼‰
                  const rpDescription = `å‘å‡ºçº¢åŒ… - ${msgData.greeting || "æ­å–œå‘è´¢"}`;
                  await updateCharacterBankBalance(
                    chatId,
                    -msgData.amount,
                    rpDescription,
                  );

                  break;

                case "open_red_packet": {
                  // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºç‹¬ç«‹çš„å—çº§ä½œç”¨åŸŸ
                  const packetToOpen = chat.history.find(
                    (m) => m.timestamp === msgData.packet_timestamp,
                  );
                  // æ£€æŸ¥çº¢åŒ…æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦æ²¡è¢«é¢†å®Œã€ä»¥åŠè¿™ä¸ªAIè§’è‰²æ˜¯å¦è¿˜æ²¡é¢†è¿‡
                  if (
                    packetToOpen &&
                    !packetToOpen.isFullyClaimed &&
                    !(
                      packetToOpen.claimedBy &&
                      packetToOpen.claimedBy[msgData.name]
                    )
                  ) {
                    // 1. æ ¹æ®AIçš„æœ¬å(msgData.name)ï¼Œä»æˆå‘˜åˆ—è¡¨æ‰¾åˆ°å…¶æ­£ç¡®çš„ç¾¤æ˜µç§°
                    const member = chat.members.find(
                      (m) => m.originalName === msgData.name,
                    );
                    const displayName = member
                      ? member.groupNickname
                      : msgData.name;

                    let claimedAmountAI = 0;
                    const remainingAmount =
                      packetToOpen.totalAmount -
                      Object.values(packetToOpen.claimedBy || {}).reduce(
                        (sum, val) => sum + val,
                        0,
                      );
                    const remainingCount =
                      packetToOpen.count -
                      Object.keys(packetToOpen.claimedBy || {}).length;

                    if (remainingCount > 0) {
                      if (remainingCount === 1) {
                        // å¦‚æœæ˜¯æœ€åä¸€ä¸ª
                        claimedAmountAI = remainingAmount;
                      } else {
                        // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªï¼Œéšæœºåˆ†é…
                        const min = 0.01;
                        const max =
                          remainingAmount - (remainingCount - 1) * min;
                        claimedAmountAI = Math.random() * (max - min) + min;
                      }
                      claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));

                      // 2. ç¡®ä¿ claimedBy å¯¹è±¡å­˜åœ¨
                      if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
                      // 3. ä½¿ç”¨åˆšåˆšæŸ¥æ‰¾åˆ°çš„ displayName ä½œä¸ºè®°å½•çš„key
                      packetToOpen.claimedBy[displayName] = claimedAmountAI;

                      // 4. å‘é€å¯¹ç”¨æˆ·å¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
                      const aiClaimedMessage = {
                        role: "system",
                        type: "pat_message",
                        // ç³»ç»Ÿæ¶ˆæ¯é‡Œä¹Ÿä½¿ç”¨ displayName
                        content: `${displayName} é¢†å–äº† ${packetToOpen.senderName} çš„çº¢åŒ…`,
                        timestamp: Date.now(),
                      };
                      chat.history.push(aiClaimedMessage);

                      let hiddenContentForAI = `[ç³»ç»Ÿæç¤ºï¼šä½  (${displayName}) æˆåŠŸæŠ¢åˆ°äº† ${claimedAmountAI.toFixed(
                        2,
                      )} å…ƒã€‚`;

                      // 5. æ£€æŸ¥çº¢åŒ…æ˜¯å¦è¢«é¢†å®Œ
                      if (
                        Object.keys(packetToOpen.claimedBy).length >=
                        packetToOpen.count
                      ) {
                        packetToOpen.isFullyClaimed = true; // æ ‡è®°ä¸ºå·²é¢†å®Œ

                        // å‘é€å¯¹ç”¨æˆ·å¯è§çš„â€œå·²é¢†å®Œâ€é€šçŸ¥
                        const finishedMessage = {
                          role: "system",
                          type: "pat_message",
                          content: `${packetToOpen.senderName} çš„çº¢åŒ…å·²è¢«é¢†å®Œ`,
                          timestamp: Date.now() + 1,
                        };
                        chat.history.push(finishedMessage);

                        // å¼€å§‹æ„å»ºç»™AIçœ‹çš„â€œæˆ˜æŠ¥â€
                        hiddenContentForAI += ` çº¢åŒ…å·²è¢«é¢†å®Œã€‚`;

                        // å¦‚æœæ˜¯æ‹¼æ‰‹æ°”çº¢åŒ…ï¼Œæ‰¾å‡ºè°æ˜¯æ‰‹æ°”ç‹
                        let luckyKing = { name: "", amount: -1 };
                        if (
                          packetToOpen.packetType === "lucky" &&
                          packetToOpen.count > 1
                        ) {
                          Object.entries(packetToOpen.claimedBy).forEach(
                            ([name, amount]) => {
                              if (amount > luckyKing.amount) {
                                luckyKing = { name, amount };
                              }
                            },
                          );
                        }
                        // æŠŠæ‰‹æ°”ç‹ä¿¡æ¯ä¹ŸåŠ åˆ°â€œæˆ˜æŠ¥â€é‡Œ
                        if (luckyKing.name) {
                          hiddenContentForAI += ` æ‰‹æ°”ç‹æ˜¯ ${luckyKing.name}ï¼`;
                        }
                      }
                      hiddenContentForAI += " è¯·æ ¹æ®è¿™ä¸ªç»“æœå‘è¡¨ä½ çš„è¯„è®ºã€‚]";

                      // 6. åˆ›å»ºå¹¶æ·»åŠ ç»™AIçœ‹çš„éšè—æ¶ˆæ¯
                      const hiddenMessageForAI = {
                        role: "system",
                        content: hiddenContentForAI,
                        timestamp: Date.now() + 2, // ç¡®ä¿æ—¶é—´æˆ³åœ¨å
                        isHidden: true,
                      };
                      chat.history.push(hiddenMessageForAI);
                    }

                    // 7. åˆ·æ–°UIï¼ˆå¦‚æœç”¨æˆ·æ­£åœ¨çœ‹çš„è¯ï¼‰
                    if (isViewingThisChat) {
                      renderChatInterface(chatId);
                    }
                  }
                  continue; // è¿™æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
                }

                case "change_avatar":
                  const avatarName = msgData.name;
                  // åœ¨è¯¥è§’è‰²çš„å¤´åƒåº“ä¸­æŸ¥æ‰¾
                  const foundAvatar = chat.settings.aiAvatarLibrary.find(
                    (avatar) => avatar.name === avatarName,
                  );

                  if (foundAvatar) {
                    // æ‰¾åˆ°äº†ï¼Œå°±æ›´æ–°å¤´åƒ
                    chat.settings.aiAvatar = foundAvatar.url;

                    // åˆ›å»ºä¸€æ¡ç³»ç»Ÿæç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·å¤´åƒå·²æ›´æ¢
                    const systemNotice = {
                      role: "system",
                      type: "pat_message", // å¤ç”¨å±…ä¸­æ ·å¼
                      content: `[${chat.name} æ›´æ¢äº†å¤´åƒ]`,
                      timestamp: Date.now(),
                    };
                    chat.history.push(systemNotice);

                    // å¦‚æœåœ¨å½“å‰èŠå¤©ç•Œé¢ï¼Œåˆ™å®æ—¶æ¸²æŸ“
                    if (isViewingThisChat) {
                      appendMessage(systemNotice, chat);
                      // ç«‹åˆ»åˆ·æ–°èŠå¤©ç•Œé¢ä»¥æ˜¾ç¤ºæ–°å¤´åƒ
                      renderChatInterface(chatId);
                    }
                  }
                  // å¤„ç†å®Œåï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
                  continue;

                case "accept_transfer": {
                  // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
                  const originalTransferMsgIndex = chat.history.findIndex(
                    (m) => m.timestamp === msgData.for_timestamp,
                  );
                  if (originalTransferMsgIndex > -1) {
                    const originalMsg = chat.history[originalTransferMsgIndex];
                    originalMsg.status = "accepted";

                    // ã€å…¨æ–°ã€‘åŒæ­¥åˆ°è§’è‰²é’±åŒ…ï¼ˆæ”¶å…¥ï¼‰
                    const acceptDescription = `æ”¶åˆ°æ¥è‡ª ${originalMsg.senderName} çš„è½¬è´¦`;
                    await updateCharacterBankBalance(
                      chatId,
                      originalMsg.amount,
                      acceptDescription,
                    );
                  }
                  continue; // æ¥å—æŒ‡ä»¤åªä¿®æ”¹çŠ¶æ€ï¼Œä¸äº§ç”Ÿæ–°æ¶ˆæ¯
                }

                case "decline_transfer": {
                  // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
                  const originalTransferMsgIndex = chat.history.findIndex(
                    (m) => m.timestamp === msgData.for_timestamp,
                  );
                  if (originalTransferMsgIndex > -1) {
                    const originalMsg = chat.history[originalTransferMsgIndex];
                    originalMsg.status = "declined";

                    // åˆ›å»ºä¸€æ¡æ–°çš„â€œé€€æ¬¾â€æ¶ˆæ¯
                    const refundMessage = {
                      role: "assistant",
                      senderName: chat.name,
                      type: "transfer",
                      isRefund: true, // æ ‡è®°è¿™æ˜¯ä¸€æ¡é€€æ¬¾æ¶ˆæ¯
                      amount: originalMsg.amount,
                      note: "è½¬è´¦å·²è¢«æ‹’æ”¶",
                      timestamp: messageTimestamp++, // ä½¿ç”¨é€’å¢çš„æ—¶é—´æˆ³
                    };

                    // å°†æ–°æ¶ˆæ¯æ¨å…¥å†å²è®°å½•ï¼Œå®ƒä¼šè¢«åç»­çš„å¾ªç¯å¤„ç†å¹¶æ¸²æŸ“
                    chat.history.push(refundMessage);

                    if (isViewingThisChat) {
                      // å› ä¸ºé€€æ¬¾æ¶ˆæ¯æ˜¯æ–°ç”Ÿæˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å°†å®ƒæ·»åŠ åˆ°ç•Œé¢ä¸Š
                      appendMessage(refundMessage, chat);
                      // åŒæ—¶ï¼ŒåŸå§‹çš„è½¬è´¦æ¶ˆæ¯çŠ¶æ€å˜äº†ï¼Œæ‰€ä»¥è¦é‡ç»˜æ•´ä¸ªç•Œé¢ä»¥æ›´æ–°å®ƒ
                      renderChatInterface(chatId);
                    }
                  }
                  continue; // ç»§ç»­å¤„ç†AIè¿”å›çš„æ–‡æœ¬æ¶ˆæ¯
                }

                case "system_message":
                  aiMessage = {
                    role: "system",
                    type: "pat_message",
                    content: msgData.content,
                    timestamp: Date.now(),
                  };
                  break;

                case "share_link":
                  aiMessage = {
                    ...baseMessage,
                    type: "share_link",
                    title: msgData.title,
                    description: msgData.description,
                    // thumbnail_url: msgData.thumbnail_url, // æˆ‘ä»¬å·²ç»å†³å®šä¸è¦å›¾ç‰‡äº†ï¼Œæ‰€ä»¥è¿™è¡Œå¯ä»¥ä¸è¦
                    source_name: msgData.source_name,
                    content: msgData.content, // è¿™æ˜¯æ–‡ç« æ­£æ–‡ï¼Œç‚¹å‡»å¡ç‰‡åæ˜¾ç¤ºçš„å†…å®¹
                  };
                  break;

                case "quote_reply":
                  const originalMessage = chat.history.find(
                    (m) => m.timestamp === msgData.target_timestamp,
                  );
                  if (originalMessage) {
                    const quoteContext = {
                      timestamp: originalMessage.timestamp,
                      senderName:
                        originalMessage.senderName ||
                        (originalMessage.role === "user"
                          ? chat.settings.myNickname || "æˆ‘"
                          : chat.name),
                      content: String(originalMessage.content || ""),
                    };
                    aiMessage = {
                      ...baseMessage,
                      content: msgData.reply_content,
                      quote: quoteContext,
                    };
                  } else {
                    aiMessage = {
                      ...baseMessage,
                      content: msgData.reply_content,
                    };
                  }
                  break;

                case "location":
                  aiMessage = {
                    ...baseMessage,
                    type: "location",
                    userLocation: msgData.userLocation,
                    aiLocation: msgData.aiLocation,
                    distance: msgData.distance,
                    trajectoryPoints: msgData.trajectoryPoints || [], // ã€æ–°å¢ã€‘ç¡®ä¿å³ä½¿AIæ²¡æä¾›ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç©ºæ•°ç»„
                  };
                  break;

                case "send_and_recall": {
                  // --- åŠ¨ç”»éƒ¨åˆ† (ä¿æŒä¸å˜) ---
                  if (!isViewingThisChat) continue;
                  const tempMessageData = {
                    ...baseMessage,
                    content: msgData.content,
                  };
                  appendMessage(tempMessageData, chat, true);
                  await new Promise((resolve) =>
                    setTimeout(resolve, Math.random() * 1000 + 1500),
                  );
                  const bubbleWrapper = document
                    .querySelector(
                      `.message-bubble[data-timestamp="${tempMessageData.timestamp}"]`,
                    )
                    ?.closest(".message-wrapper");
                  if (bubbleWrapper) {
                    bubbleWrapper.classList.add("recalled-animation");
                    await new Promise((resolve) => setTimeout(resolve, 300));
                  }

                  // 1. åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„â€œå·²æ’¤å›â€æ¶ˆæ¯
                  const recalledMessage = {
                    role: "assistant",
                    senderName: msgData.name || chat.name,
                    type: "recalled_message",
                    content: "å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯",
                    timestamp: tempMessageData.timestamp,
                    recalledData: {
                      originalType: "text",
                      originalContent: msgData.content,
                    },
                  };

                  // 2. åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„â€œè®°å¿†â€æ¶ˆæ¯
                  const hiddenMemoryMessage = {
                    role: "system", // å¿…é¡»æ˜¯ systemï¼Œè¿™æ ·AIæ‰çŸ¥é“è¿™æ˜¯ä¸Šä¸‹æ–‡ä¿¡æ¯
                    content: `[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšè¯´äº†ä¸€å¥â€œ${msgData.content}â€ï¼Œä½†ç«‹åˆ»å°±æ’¤å›äº†å®ƒã€‚]`,
                    timestamp: tempMessageData.timestamp + 1, // ç¡®ä¿åœ¨æ’¤å›æ¶ˆæ¯ä¹‹å
                    isHidden: true, // è¿™ä¸ªæ ‡è®°è®©å®ƒä¸åœ¨UIä¸Šæ˜¾ç¤º
                  };

                  // 3. å°†è¿™ä¸¤æ¡æ¶ˆæ¯éƒ½æ·»åŠ åˆ°å†å²è®°å½•ä¸­
                  chat.history.push(recalledMessage, hiddenMemoryMessage);

                  // 4. æ›¿æ¢DOMï¼Œæ˜¾ç¤ºâ€œå·²æ’¤å›â€æç¤º
                  const placeholder = createMessageElement(
                    recalledMessage,
                    chat,
                  );
                  if (document.body.contains(bubbleWrapper)) {
                    bubbleWrapper.parentNode.replaceChild(
                      placeholder,
                      bubbleWrapper,
                    );
                  }

                  continue;
                }

                case "sticker": {
                  // è¿™æ˜¯ä¸ºç¾¤èŠå’Œå•èŠç»Ÿä¸€è®¾è®¡çš„è¡¨æƒ…åŒ…é€»è¾‘
                  const stickerName = msgData.sticker_name; // å…³é”®ä¿®æ”¹ï¼šç»Ÿä¸€ä½¿ç”¨ sticker_name
                  if (!stickerName) {
                    console.warn(
                      "AIè¿”å›äº†stickerç±»å‹ä½†æ²¡æœ‰sticker_nameï¼Œå·²æ‹¦æˆª:",
                      msgData,
                    );
                    continue; // è·³è¿‡è¿™æ¡æ— æ•ˆæŒ‡ä»¤
                  }

                  // åœ¨æ‰€æœ‰å¯ç”¨è¡¨æƒ…åº“ä¸­æŸ¥æ‰¾
                  const allStickers = [
                    ...state.userStickers,
                    ...state.charStickers,
                    ...(chat.settings.stickerLibrary || []),
                  ];
                  const foundSticker = allStickers.find(
                    (s) => s.name === stickerName,
                  );

                  if (foundSticker) {
                    // æ‰¾åˆ°äº†ï¼Œå°±åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
                    aiMessage = {
                      ...baseMessage,
                      type: "sticker",
                      content: foundSticker.url,
                      meaning: foundSticker.name,
                    };
                  } else {
                    // æ²¡æ‰¾åˆ°ï¼Œè¯´æ˜AIå¹»è§‰äº†ï¼Œè®°å½•è­¦å‘Šå¹¶è·³è¿‡
                    console.warn(
                      `AIæœæ’°äº†ä¸å­˜åœ¨çš„è¡¨æƒ…: "${stickerName}"ï¼Œå·²è‡ªåŠ¨æ‹¦æˆªã€‚`,
                    );
                  }
                  break;
                }
                case "text": {
                  const messageText = String(
                    msgData.content || msgData.message || "",
                  );

                  if (STICKER_REGEX.test(messageText)) {
                    aiMessage = {
                      ...baseMessage,
                      type: "sticker",
                      content: messageText,
                      meaning: "",
                    };
                  } else {
                    // å…¼å®¹æ—§çš„[sticker:åå­—]æ ¼å¼ï¼Œä½†æ–°promptå·²ä¸æ¨è
                    const stickerMatch =
                      messageText.match(/^\[sticker:(.+?)\]$/);
                    if (stickerMatch) {
                      const stickerName = stickerMatch[1].trim();
                      const allStickers = [
                        ...state.userStickers,
                        ...state.charStickers,
                        ...(chat.settings.stickerLibrary || []),
                      ];
                      const foundSticker = allStickers.find(
                        (s) => s.name === stickerName,
                      );

                      if (foundSticker) {
                        aiMessage = {
                          ...baseMessage,
                          type: "sticker",
                          content: foundSticker.url,
                          meaning: foundSticker.name,
                        };
                      } else {
                        console.warn(
                          `AIä½¿ç”¨äº†æ—§æ ¼å¼ä¸”æœæ’°äº†ä¸å­˜åœ¨çš„è¡¨æƒ…: "${stickerName}"ï¼Œå·²æ‹¦æˆªã€‚`,
                        );
                      }
                    } else {
                      aiMessage = { ...baseMessage, content: messageText };
                    }
                  }
                  break;
                }

                case "dating_payment_response": {
                  const originalRequest = chat.history
                    .filter(
                      (m) =>
                        m.role === "system" &&
                        m.content.includes("dating_payment_response"),
                    )
                    .pop();
                  if (!originalRequest) continue;

                  const costMatch =
                    originalRequest.content.match(/è´¹ç”¨ï¼ˆ(\d+(\.\d+)?)é‡‘å¸ï¼‰/);
                  const cost = costMatch ? parseFloat(costMatch[1]) : 0;

                  if (msgData.decision === "accept") {
                    const charBalance =
                      chat.characterPhoneData.bank.balance || 0;
                    if (charBalance >= cost) {
                      await updateCharacterPhoneBankBalance(
                        chat.id,
                        -cost,
                        `çº¦ä¼šæ”¯å‡º: ä¸ºç”¨æˆ·ä¹°å•`,
                      );
                      aiMessage = {
                        ...baseMessage,
                        content:
                          msgData.responseText || "å¥½å‘€ï¼Œè¿™æ¬¡æˆ‘æ¥è¯·å®¢å§ï¼",
                      };
                    } else {
                      aiMessage = {
                        ...baseMessage,
                        content:
                          msgData.responseText ||
                          "å‘œå‘œï¼Œæˆ‘ä¹Ÿæƒ³è¯·å®¢ï¼Œä½†æ˜¯é’±åŒ…å¥½åƒä¸å¤ªå¤Ÿå‘¢...",
                      };
                    }
                  } else {
                    aiMessage = {
                      ...baseMessage,
                      content: msgData.responseText || "è¿™æ¬¡è¿˜æ˜¯ç®—äº†å§...",
                    };
                  }
                  break;
                }

                case "dating_aa_response": {
                  const originalRequest = chat.history
                    .filter(
                      (m) =>
                        m.role === "system" &&
                        m.content.includes("dating_aa_response"),
                    )
                    .pop();
                  if (!originalRequest) continue;

                  const costMatch = originalRequest.content.match(
                    /å„è‡ªæ”¯ä»˜ (\d+(\.\d+)?) é‡‘å¸/,
                  );
                  const splitCost = costMatch ? parseFloat(costMatch[1]) : 0;

                  if (msgData.decision === "accept") {
                    const charBalance =
                      chat.characterPhoneData.bank.balance || 0;
                    if (charBalance >= splitCost) {
                      await updateUserBalanceAndLogTransaction(
                        -splitCost,
                        `çº¦ä¼šAAæ”¯å‡º`,
                      );
                      await updateCharacterPhoneBankBalance(
                        chat.id,
                        -splitCost,
                        `çº¦ä¼šAAæ”¯å‡º`,
                      );
                      aiMessage = {
                        ...baseMessage,
                        content:
                          msgData.responseText || "å¥½å•Šï¼ŒAAåˆ¶å®Œå…¨æ²¡é—®é¢˜ï¼",
                      };
                    } else {
                      aiMessage = {
                        ...baseMessage,
                        content:
                          msgData.responseText ||
                          "è¿™ä¸ª...æˆ‘çš„é’±å¥½åƒä¸å¤ªå¤Ÿä»˜æˆ‘è‡ªå·±çš„é‚£ä»½å‘¢ã€‚",
                      };
                    }
                  } else {
                    aiMessage = {
                      ...baseMessage,
                      content:
                        msgData.responseText ||
                        "æˆ‘è§‰å¾—AAåˆ¶æœ‰ç‚¹å¤ªè§å¤–äº†ï¼Œè¿˜æ˜¯æˆ‘æ¥è¯·å§ï¼Ÿæˆ–è€…ä½ è¯·ï¼Ÿ",
                    };
                  }
                  break;
                }

                case "lend_money_response": {
                  const originalRequest = chat.history
                    .filter(
                      (m) =>
                        m.role === "system" &&
                        m.content.includes("lend_money_response"),
                    )
                    .pop();
                  if (!originalRequest) continue;

                  const amountMatch =
                    originalRequest.content.match(/å€Ÿ (\d+(\.\d+)?) é‡‘å¸/);
                  const amount = amountMatch ? parseFloat(amountMatch[1]) : 0;

                  // åªå¤„ç†æ¥å—å€Ÿæ¬¾æ—¶çš„é‡‘é’±é€»è¾‘
                  if (msgData.decision === "accept") {
                    const lenderBalance =
                      chat.characterPhoneData.bank.balance || 0;
                    if (lenderBalance >= amount) {
                      await updateCharacterPhoneBankBalance(
                        chat.id,
                        -amount,
                        `å€Ÿé’±ç»™ç”¨æˆ·`,
                      );
                      await updateUserBalanceAndLogTransaction(
                        amount,
                        `ä» ${chat.name} å¤„å€Ÿæ¬¾`,
                      );
                    } else {
                      // å¦‚æœAIå†³å®šåŒæ„ä½†é’±ä¸å¤Ÿï¼Œæˆ‘ä»¬ä¿¡ä»»AIä¼šåœ¨ä¸‹ä¸€æ¡æ¶ˆæ¯ä¸­è§£é‡Šã€‚
                      // è¿™é‡Œçš„é‡‘èé€»è¾‘å¯ä»¥åšå¾—æ›´å¤æ‚ï¼Œä½†ç›®å‰ä¿æŒç®€å•ï¼Œç›¸ä¿¡AIçš„åˆ¤æ–­ã€‚
                      console.warn(
                        `AI "${chat.name}" åŒæ„å€Ÿé’±ï¼Œä½†ä½™é¢ä¸è¶³ï¼Œäº¤æ˜“æœªæ‰§è¡Œã€‚`,
                      );
                    }
                  }
                  // å¦‚æœæ˜¯æ‹’ç»(reject)ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•é‡‘èæ“ä½œã€‚

                  // ä¸å†åœ¨è¿™é‡Œåˆ›å»ºä»»ä½• aiMessageã€‚
                  // ä½¿ç”¨ 'continue' è·³åˆ°AIå›å¤æ•°ç»„çš„ä¸‹ä¸€é¡¹ï¼Œä¹Ÿå°±æ˜¯AIè‡ªå·±ç”Ÿæˆçš„æ–‡æœ¬æ¶ˆæ¯ï¼Œè®©å¾ªç¯çš„åç»­éƒ¨åˆ†å»å¤„ç†å®ƒã€‚
                  continue;
                }

                case "forum_comment": {
                  // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
                  const postIdToComment = msgData.postId;
                  const commentText = msgData.commentText;

                  if (postIdToComment && commentText) {
                    // 1. å°è¯•å°† postId å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å­—ã€‚
                    //    è¿™èƒ½è§£å†³AIè¿”å›æ•°å­—å­—ç¬¦ä¸²ï¼ˆå¦‚"123"ï¼‰å¯¼è‡´æŸ¥è¯¢å¤±è´¥çš„é—®é¢˜ã€‚
                    const numericPostId = parseInt(postIdToComment, 10);

                    // æ£€æŸ¥è½¬æ¢åçš„IDæ˜¯å¦æœ‰æ•ˆ
                    if (isNaN(numericPostId)) {
                      console.warn(
                        `[åœˆå­è¯„è®ºå¤±è´¥] æ”¶åˆ°çš„ postId "${postIdToComment}" ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°å­—IDï¼Œå·²è·³è¿‡ã€‚`,
                      );
                      // æç¤ºï¼šå¦‚æœé¢‘ç¹çœ‹åˆ°æ­¤è­¦å‘Šï¼Œè¯·æ£€æŸ¥ä½ ç»™AIçš„system promptï¼Œç¡®ä¿ä½ è¦æ±‚å®ƒè¿”å›æ•°å­—IDã€‚
                      continue; // è·³è¿‡æ­¤æŒ‡ä»¤
                    }

                    // 2. ä½¿ç”¨æ­£ç¡®çš„æ•°å­—IDä»æ•°æ®åº“è·å–å¸–å­
                    const postToComment =
                      await db.forumPosts.get(numericPostId);

                    if (postToComment) {
                      // åˆ›å»ºæ–°è¯„è®ºå¯¹è±¡
                      const newComment = {
                        postId: numericPostId, // ä½¿ç”¨è½¬æ¢åçš„æ•°å­—ID
                        author: chat.name, // è¯„è®ºè€…å°±æ˜¯å½“å‰AI
                        content: commentText,
                        timestamp: Date.now(),
                      };

                      // å°†æ–°è¯„è®ºä¿å­˜åˆ°æ•°æ®åº“
                      await db.forumComments.add(newComment);
                      console.log(
                        `AI "${chat.name}" è¯„è®ºäº†å¸–å­ #${numericPostId}: "${commentText}"`,
                      );

                      // 3. åŒæ—¶æ£€æŸ¥å¸–å­åˆ—è¡¨é¡µå’Œå¸–å­è¯¦æƒ…é¡µ
                      //    è¿™æ ·æ— è®ºä½ æ­£åœ¨çœ‹å“ªä¸ªé¡µé¢ï¼Œéƒ½èƒ½çœ‹åˆ°æ›´æ–°ã€‚

                      // å¦‚æœç”¨æˆ·æ­£åœ¨çœ‹è¿™ä¸ªå°ç»„çš„å¸–å­åˆ—è¡¨ï¼Œå°±åˆ·æ–°åˆ—è¡¨
                      if (
                        document
                          .getElementById("group-screen")
                          .classList.contains("active") &&
                        activeGroupId === postToComment.groupId
                      ) {
                        await renderGroupPosts(activeGroupId);
                      }

                      // å¦‚æœç”¨æˆ·æ­£åœ¨çœ‹è¿™ä¸ªå¸–å­çš„è¯¦æƒ…é¡µï¼Œå°±åˆ·æ–°è¯¦æƒ…é¡µï¼ˆè¿™æ˜¯æœ¬æ¬¡ä¿®å¤çš„å…³é”®ï¼ï¼‰
                      if (
                        document
                          .getElementById("post-screen")
                          .classList.contains("active") &&
                        activeForumPostId === numericPostId
                      ) {
                        await renderPostDetails(numericPostId);
                      }
                    } else {
                      console.warn(
                        `[åœˆå­è¯„è®ºå¤±è´¥] æœªèƒ½åœ¨æ•°æ®åº“ä¸­æ‰¾åˆ° postId ä¸º ${numericPostId} çš„å¸–å­ã€‚`,
                      );
                    }
                  }
                  // æ— è®ºæˆåŠŸä¸å¦ï¼Œè¿™éƒ½æ˜¯ä¸€ä¸ªåå°æ“ä½œï¼Œç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æŒ‡ä»¤
                  continue;
                }

                case "ai_image":
                  aiMessage = {
                    ...baseMessage,
                    type: "ai_image",
                    content: msgData.description,
                  };
                  break;
                case "voice_message":
                  aiMessage = {
                    ...baseMessage,
                    type: "voice_message",
                    content: msgData.content,
                  };
                  break;

                case "transfer":
                  aiMessage = {
                    ...baseMessage,
                    type: "transfer",
                    amount: msgData.amount,
                    note: msgData.note,
                    receiverName: msgData.receiver || "æˆ‘",
                  };

                  // ã€å…¨æ–°ã€‘åŒæ­¥åˆ°è§’è‰²é’±åŒ…ï¼ˆæ”¯å‡ºï¼‰
                  const transferDescription = `è½¬è´¦ç»™ ${msgData.receiver || "æˆ‘"}`;
                  await updateCharacterBankBalance(
                    chatId,
                    -msgData.amount,
                    transferDescription,
                  );

                  break;

                case "waimai_request":
                  aiMessage = {
                    ...baseMessage,
                    type: "waimai_request",
                    productInfo: msgData.productInfo,
                    amount: msgData.amount,
                    status: "pending",
                    countdownEndTime: Date.now() + 15 * 60 * 1000,
                  };
                  break;

                default:
                  console.warn("æ”¶åˆ°äº†æœªçŸ¥çš„AIæŒ‡ä»¤ç±»å‹:", msgData.type);
                  break;
              }

              // å°†æ¸²æŸ“é€»è¾‘ç§»å‡ºå¾ªç¯
              if (aiMessage) {
                // 1. å°†æ–°æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
                chat.history.push(aiMessage);

                if (!isViewingThisChat || document.hidden) {
                  let notificationText;
                  switch (aiMessage.type) {
                    case "transfer":
                      notificationText = `[æ”¶åˆ°ä¸€ç¬”è½¬è´¦]`;
                      break;
                    case "waimai_request":
                      notificationText = `[æ”¶åˆ°ä¸€ä¸ªå¤–å–ä»£ä»˜è¯·æ±‚]`;
                      break;
                    case "ai_image":
                      notificationText = `[å›¾ç‰‡]`;
                      break;
                    case "voice_message":
                      notificationText = `[è¯­éŸ³]`;
                      break;
                    case "sticker":
                      notificationText = aiMessage.meaning
                        ? `[è¡¨æƒ…: ${aiMessage.meaning}]`
                        : "[è¡¨æƒ…]";
                      break;
                    default:
                      notificationText = String(aiMessage.content || "");
                  }
                  const finalNotifText = chat.isGroup
                    ? `${aiMessage.senderName}: ${notificationText}`
                    : notificationText;
                  // ç¡®å®šå…·ä½“çš„å¤´åƒURL
                  let senderAvatarForNotify = null;

                  if (chat.isGroup) {
                    // å¦‚æœæ˜¯ç¾¤èŠï¼Œå°è¯•æ ¹æ®æ¶ˆæ¯å‘é€è€…åå­—æ‰¾åˆ°å¯¹åº”çš„æˆå‘˜å¤´åƒ
                    const member = chat.members.find(
                      (m) => m.originalName === aiMessage.senderName,
                    );
                    if (member) {
                      senderAvatarForNotify = member.avatar;
                    }
                  } else {
                    // å¦‚æœæ˜¯å•èŠï¼Œç›´æ¥ç”¨AIå¤´åƒ
                    senderAvatarForNotify = chat.settings.aiAvatar;
                  }

                  showNotification(
                    chatId,
                    finalNotifText.substring(0, 60) +
                      (finalNotifText.length > 60 ? "..." : ""),
                    senderAvatarForNotify, // <--- ä¼ å…¥è¿™ä¸ªæ–°å‚æ•°
                  );
                }

                if (!isViewingThisChat) {
                  // å¦‚æœç”¨æˆ·ä¸åœ¨å½“å‰èŠå¤©ç•Œé¢ï¼Œå°±æŠŠè¿™ä¸ªèŠå¤©çš„æœªè¯»æ•° +1
                  chat.unreadCount = (chat.unreadCount || 0) + 1;
                }

                // 2. åªæœ‰åœ¨å½“å‰èŠå¤©ç•Œé¢æ—¶ï¼Œæ‰æ‰§è¡Œå¸¦åŠ¨ç”»çš„æ·»åŠ 
                if (isViewingThisChat) {
                  appendMessage(aiMessage, chat);
                  playNotificationSound();
                  await new Promise((resolve) =>
                    setTimeout(resolve, Math.random() * 1800 + 1000),
                  );
                }
              }
            }

            if (callHasBeenHandled && videoCallState.isGroupCall) {
              videoCallState.isAwaitingResponse = false;
              if (videoCallState.participants.length > 0) {
                startVideoCall();
              } else {
                videoCallState = {
                  ...videoCallState,
                  isAwaitingResponse: false,
                  participants: [],
                };
                showScreen("chat-interface-screen");
                alert("æ— äººæ¥å¬ç¾¤èŠé‚€è¯·ã€‚");
              }
            }
            await db.chats.put(chat);
            checkAndTriggerSummary(chatId);

            // --- ç»­ç«èŠ±é€»è¾‘ ---
            if (await updateStreak(chatId)) {
              // å¦‚æœç«èŠ±å¤©æ•°å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±åˆ·æ–°èŠå¤©åˆ—è¡¨
              renderChatList();
            }
          } catch (error) {
            chat.history = chat.history.filter((msg) => !msg.isTemporary);
            if (
              !chat.isGroup &&
              chat.relationship?.status === "pending_ai_approval"
            ) {
              chat.relationship.status = "blocked_by_ai";
              await showCustomAlert(
                "ç”³è¯·å¤±è´¥",
                `AIåœ¨å¤„ç†ä½ çš„å¥½å‹ç”³è¯·æ—¶å‡ºé”™äº†ï¼Œè¯·ç¨åé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}`,
              );
            } else {
              const errorContent = `[å‡ºé”™äº†: ${error.message}]`;
              const errorMessage = {
                role: "assistant",
                content: errorContent,
                timestamp: Date.now(),
              };
              if (chat.isGroup) errorMessage.senderName = "ç³»ç»Ÿæ¶ˆæ¯";
              chat.history.push(errorMessage);
            }

            await db.chats.put(chat);
            videoCallState.isAwaitingResponse = false;

            if (
              document
                .getElementById("chat-interface-screen")
                .classList.contains("active") &&
              state.activeChatId === chatId
            ) {
              renderChatInterface(chatId);
            }
          } finally {
            // åœ¨ finally å—ä¸­ç»Ÿä¸€éšè—æ‰€æœ‰ç±»å‹çš„æç¤º
            if (chat.isGroup) {
              if (typingIndicator) {
                typingIndicator.style.display = "none";
              }
            } else {
              if (chatHeaderTitle && state.chats[chatId]) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                  chatHeaderTitle.textContent = state.chats[chatId].name;
                  chatHeaderTitle.classList.remove("typing-status");
                  chatHeaderTitle.style.opacity = 1;
                }, 200);
              }
            }
          }
        }

        async function sendSticker(sticker) {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          const msg = {
            role: "user",
            content: sticker.url,
            meaning: sticker.name,
            timestamp: Date.now(),
          };
          chat.history.push(msg);
          await db.chats.put(chat);
          checkAndTriggerSummary(state.activeChatId);
          appendMessage(msg, chat);
          renderChatList();
          document.getElementById("sticker-panel").classList.remove("visible");
        }

        async function sendUserTransfer() {
          if (!state.activeChatId) return;

          const amountInput = document.getElementById("transfer-amount");
          const noteInput = document.getElementById("transfer-note");
          const amount = parseFloat(amountInput.value);
          const note = noteInput.value.trim();

          if (isNaN(amount) || amount <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼");
            return;
          }

          // æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
          if ((state.globalSettings.userBalance || 0) < amount) {
            alert("ä½™é¢ä¸è¶³ï¼");
            return;
          }

          const chat = state.chats[state.activeChatId];
          const senderName = chat.isGroup
            ? chat.settings.myNickname || "æˆ‘"
            : "æˆ‘";
          const receiverName = chat.isGroup ? "ç¾¤èŠ" : chat.name;

          // è°ƒç”¨æ–°å‡½æ•°æ‰£æ¬¾å¹¶è®°å½•
          await updateUserBalanceAndLogTransaction(
            -amount,
            `è½¬è´¦ç»™ ${receiverName}`,
          );

          const msg = {
            role: "user",
            type: "transfer",
            amount: amount,
            note: note,
            senderName,
            receiverName,
            timestamp: Date.now(),
          };
          chat.history.push(msg);

          await db.chats.put(chat);
          appendMessage(msg, chat);
          renderChatList();
          document.getElementById("transfer-modal").classList.remove("visible");
          amountInput.value = "";
          noteInput.value = "";
        }

        function enterSelectionMode(initialMsgTimestamp) {
          if (isSelectionMode) return;
          isSelectionMode = true;
          document
            .getElementById("chat-interface-screen")
            .classList.add("selection-mode");
          toggleMessageSelection(initialMsgTimestamp);
        }

        function exitSelectionMode() {
          cleanupWaimaiTimers();
          if (!isSelectionMode) return;
          isSelectionMode = false;
          document
            .getElementById("chat-interface-screen")
            .classList.remove("selection-mode");
          selectedMessages.forEach((ts) => {
            const bubble = document.querySelector(
              `.message-bubble[data-timestamp="${ts}"]`,
            );
            if (bubble) bubble.classList.remove("selected");
          });
          selectedMessages.clear();
        }

        function toggleMessageSelection(timestamp) {
          const elementToSelect = document.querySelector(
            `.message-bubble[data-timestamp="${timestamp}"]`,
          );

          if (!elementToSelect) return;

          if (selectedMessages.has(timestamp)) {
            selectedMessages.delete(timestamp);
            elementToSelect.classList.remove("selected");
          } else {
            selectedMessages.add(timestamp);
            elementToSelect.classList.add("selected");
          }

          document.getElementById("selection-count").textContent =
            `å·²é€‰ ${selectedMessages.size} æ¡`;

          if (selectedMessages.size === 0) {
            exitSelectionMode();
          }
        }

        function addLongPressListener(element, callback) {
          let pressTimer;
          const startPress = (e) => {
            if (isSelectionMode) return;
            e.preventDefault();
            pressTimer = window.setTimeout(() => callback(e), 500);
          };
          const cancelPress = () => clearTimeout(pressTimer);
          element.addEventListener("mousedown", startPress);
          element.addEventListener("mouseup", cancelPress);
          element.addEventListener("mouseleave", cancelPress);
          element.addEventListener("touchstart", startPress, { passive: true });
          element.addEventListener("touchend", cancelPress);
          element.addEventListener("touchmove", cancelPress);
        }

        async function handleListenTogetherClick() {
          document.getElementById("floating-lyrics-bar").style.display = "none";

          const targetChatId = state.activeChatId;
          if (!targetChatId) return;
          if (!state.musicState.isActive) {
            startListenTogetherSession(targetChatId);
            return;
          }
          if (state.musicState.activeChatId === targetChatId) {
            document
              .getElementById("music-player-overlay")
              .classList.add("visible");
          } else {
            const oldChatName =
              state.chats[state.musicState.activeChatId]?.name || "æœªçŸ¥";
            const newChatName = state.chats[targetChatId]?.name || "å½“å‰";
            const confirmed = await showCustomConfirm(
              "åˆ‡æ¢å¬æ­Œå¯¹è±¡",
              `æ‚¨æ­£å’Œã€Œ${oldChatName}ã€å¬æ­Œã€‚è¦ç»“æŸå¹¶å¼€å§‹å’Œã€Œ${newChatName}ã€çš„æ–°ä¼šè¯å—ï¼Ÿ`,
              { confirmButtonClass: "btn-danger" },
            );
            if (confirmed) {
              await endListenTogetherSession(true);
              await new Promise((resolve) => setTimeout(resolve, 50));
              startListenTogetherSession(targetChatId);
            }
          }
        }

        async function startListenTogetherSession(chatId) {
          const chat = state.chats[chatId];
          if (!chat) return;
          state.musicState.totalElapsedTime = chat.musicData.totalTime || 0;
          state.musicState.isActive = true;
          state.musicState.activeChatId = chatId;
          if (state.musicState.playlist.length > 0) {
            state.musicState.currentIndex = 0;
          } else {
            state.musicState.currentIndex = -1;
          }
          if (state.musicState.timerId) clearInterval(state.musicState.timerId);
          state.musicState.timerId = setInterval(() => {
            if (state.musicState.isPlaying) {
              state.musicState.totalElapsedTime++;
              updateElapsedTimeDisplay();
            }
          }, 1000);
          updatePlayerUI();
          updatePlaylistUI();
          document
            .getElementById("music-player-overlay")
            .classList.add("visible");
        }

        async function endListenTogetherSession(saveState = true) {
          if (!state.musicState.isActive) return;
          const oldChatId = state.musicState.activeChatId;
          const cleanupLogic = async () => {
            document.getElementById("floating-lyrics-bar").style.display =
              "none";

            if (state.musicState.timerId)
              clearInterval(state.musicState.timerId);
            if (state.musicState.isPlaying) audioPlayer.pause();
            if (saveState && oldChatId && state.chats[oldChatId]) {
              const chat = state.chats[oldChatId];
              chat.musicData.totalTime = state.musicState.totalElapsedTime;
              await db.chats.put(chat);
            }
            state.musicState.isActive = false;
            state.musicState.activeChatId = null;
            state.musicState.totalElapsedTime = 0;
            state.musicState.timerId = null;
            updateListenTogetherIcon(oldChatId, true);
          };
          closeMusicPlayerWithAnimation(cleanupLogic);
        }

        function returnToChat() {
          closeMusicPlayerWithAnimation(() => {
            if (state.musicState.isActive && lyricsBarSettings.showOnClose) {
              document.getElementById("floating-lyrics-bar").style.display =
                "flex";
            }
          });
        }

        function updateListenTogetherIcon(chatId, forceReset = false) {
          const iconImg = document.querySelector("#listen-together-btn img");
          if (!iconImg) return;
          if (
            forceReset ||
            !state.musicState.isActive ||
            state.musicState.activeChatId !== chatId
          ) {
            iconImg.src = "https://i.postimg.cc/CxjpF6gK/yi-qi-ting.png";
            iconImg.className = "";
            return;
          }
          iconImg.src =
            "https://cdn.jsdelivr.net.cn/gh/qdqqd/tc_temp/jli60izy2n.png";
          iconImg.classList.add("rotating");
          if (state.musicState.isPlaying) iconImg.classList.remove("paused");
          else iconImg.classList.add("paused");
        }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;

        function updatePlayerUI() {
          updateListenTogetherIcon(state.musicState.activeChatId);
          updateElapsedTimeDisplay();
          const titleEl = document.getElementById("music-player-song-title");
          const artistEl = document.getElementById("music-player-artist");
          const playPauseBtn = document.getElementById("music-play-pause-btn");
          const chat = state.chats[state.musicState.activeChatId];
          const charAvatarEl = document.getElementById("music-char-avatar");
          const userAvatarEl = document.getElementById("music-user-avatar");
          const albumCoverEl = document.getElementById("music-album-cover");
          const avatarsContainer = document.getElementById(
            "music-avatars-container",
          );
          const displayArea = document.getElementById("music-display-area");

          // 1. åˆ¤æ–­æ˜¯ç¾¤èŠè¿˜æ˜¯å•èŠï¼Œå¹¶è®¾ç½®æ­£ç¡®çš„å¤´åƒ
          if (chat) {
            // å¦‚æœæ˜¯ç¾¤èŠ
            if (chat.isGroup) {
              // å·¦è¾¹çš„å¤´åƒå°±ç”¨ç¾¤å¤´åƒ
              charAvatarEl.src =
                chat.settings.groupAvatar || defaultGroupAvatar;
            } else {
              // å¦åˆ™ï¼ˆæ˜¯å•èŠï¼‰ï¼Œå°±ç”¨è§’è‰²çš„å¤´åƒ
              charAvatarEl.src = chat.settings.aiAvatar || defaultAvatar;
            }
            // å³è¾¹çš„ç”¨æˆ·å¤´åƒä¿æŒä¸å˜
            userAvatarEl.src = chat.settings.myAvatar || defaultAvatar;
          }

          // 2. æ›´æ–°æ­Œæ›²ä¿¡æ¯å’Œå°é¢
          if (
            state.musicState.currentIndex > -1 &&
            state.musicState.playlist.length > 0
          ) {
            const track =
              state.musicState.playlist[state.musicState.currentIndex];
            titleEl.textContent = track.name;
            artistEl.textContent = track.artist;
            albumCoverEl.src =
              track.cover ||
              "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png";
          } else {
            titleEl.textContent = "è¯·æ·»åŠ æ­Œæ›²";
            artistEl.textContent = "...";
            albumCoverEl.src =
              "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png";
          }

          // 3. æ§åˆ¶æ’­æ”¾/æš‚åœæŒ‰é’®å’Œå¤´åƒé—ªçƒ
          playPauseBtn.textContent = state.musicState.isPlaying ? "âšâš" : "â–¶";
          avatarsContainer.classList.toggle(
            "flashing",
            state.musicState.isPlaying,
          );

          // 4. æ§åˆ¶å”±ç‰‡æ—‹è½¬å’Œæš‚åœ
          albumCoverEl.classList.toggle(
            "rotating",
            state.musicState.currentIndex > -1,
          );
          albumCoverEl.classList.toggle("paused", !state.musicState.isPlaying);

          // 5. é»˜è®¤æ˜¾ç¤ºæ­Œæ›²å°é¢
          if (displayArea) {
            displayArea.classList.remove("show-lyrics");
          }
        }

        function updateElapsedTimeDisplay() {
          const hours = (state.musicState.totalElapsedTime / 3600).toFixed(1);
          document.getElementById("music-time-counter").textContent =
            `å·²ç»ä¸€èµ·å¬äº†${hours}å°æ—¶`;
        }

        /**
         * å¤„ç†ç”¨æˆ·ä¸Šä¼ æˆ–æ›´æ–°æ­Œæ›²å°é¢çš„é€»è¾‘
         * @param {number} index - è¢«æ“ä½œçš„æ­Œæ›²åœ¨æ’­æ”¾åˆ—è¡¨ä¸­çš„ç´¢å¼•
         */

        async function handleCoverUpload(index) {
          if (index < 0 || index >= state.musicState.playlist.length) return;

          // 1. å¼¹çª—è®©ç”¨æˆ·é€‰æ‹©æ¥æº
          const choice = await showChoiceModal("é€‰æ‹©å°é¢æ¥æº", [
            { text: "ä½¿ç”¨ç½‘ç»œURL", value: "url" },
            { text: "ä»æœ¬åœ°ä¸Šä¼ ", value: "local" },
          ]);

          let newCoverUrl = null;

          // 2. æ ¹æ®é€‰æ‹©æ‰§è¡Œä¸åŒæ“ä½œ
          if (choice === "url") {
            const url = await showCustomPrompt(
              "å°é¢URL",
              "è¯·è¾“å…¥å›¾ç‰‡æ–‡ä»¶çš„ç½‘ç»œé“¾æ¥",
            );
            if (url && url.trim().startsWith("http")) {
              newCoverUrl = url.trim();
            } else if (url !== null) {
              alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
            }
          } else if (choice === "local") {
            newCoverUrl = await uploadImageLocally();
          }

          // 3. å¦‚æœæˆåŠŸè·å–åˆ°æ–°çš„å°é¢URLï¼Œå°±æ›´æ–°æ•°æ®å’ŒUI
          if (newCoverUrl) {
            state.musicState.playlist[index].cover = newCoverUrl;
            await saveGlobalPlaylist();
            updatePlaylistUI();
            if (state.musicState.currentIndex === index) {
              updatePlayerUI();
            }
            alert("æ­Œæ›²å°é¢å·²æ›´æ–°ï¼");
          }
        }

        function updatePlaylistUI() {
          const playlistBody = document.getElementById("playlist-body");
          playlistBody.innerHTML = "";
          if (state.musicState.playlist.length === 0) {
            playlistBody.innerHTML =
              '<p style="text-align:center; padding: 20px; color: #888;">æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„~</p>';
            return;
          }
          state.musicState.playlist.forEach((track, index) => {
            const item = document.createElement("div");
            item.className = "playlist-item";
            if (index === state.musicState.currentIndex)
              item.classList.add("playing");
            // æ–°å¢â€œå°é¢â€æŒ‰é’®
            item.innerHTML = `
			            <div class="playlist-item-info">
			                <div class="title">${track.name}</div>
			                <div class="artist">${track.artist}</div>
			            </div>
			            <div class="playlist-item-actions">
			                <span class="playlist-action-btn cover-btn" data-index="${index}">å°é¢</span>
			                <span class="playlist-action-btn lyrics-btn" data-index="${index}">è¯</span>
			                <span class="playlist-action-btn delete-track-btn" data-index="${index}">Ã—</span>
			            </div>
			        `;
            item
              .querySelector(".playlist-item-info")
              .addEventListener("click", () => playSong(index));
            playlistBody.appendChild(item);
          });
        }

        /**
         * åŠ è½½æ­Œæ›²ï¼Œæ”¯æŒè‡ªåŠ¨æ£€æµ‹è¿‡æœŸå¹¶ç»­æœŸURL
         */
        async function loadSong(index) {
          if (index < 0 || index >= state.musicState.playlist.length) return;
          state.musicState.currentIndex = index;
          let track = state.musicState.playlist[index];

          if (!track.isLocal && track.musicId && track.musicSource) {
            // 1. æ£€æŸ¥å½“å‰é“¾æ¥æ˜¯å¦æœ‰æ•ˆ
            const isUrlValid = await checkAudioAvailability(track.src);

            if (!isUrlValid) {
              console.log(
                `æ£€æµ‹åˆ°æ­Œæ›²ã€Š${track.name}ã€‹é“¾æ¥å¤±æ•ˆï¼Œæ­£åœ¨è‡ªåŠ¨ç»­æœŸ...`,
              );
              // æ˜¾ç¤ºä¸€ä¸ªå°æç¤ºï¼Œè®©ç”¨æˆ·çŸ¥é“æ­£åœ¨åŠªåŠ›
              const statusEl = document.getElementById("music-player-artist");
              if (statusEl) statusEl.textContent = "æ­£åœ¨æ›´æ–°é“¾æ¥...";

              try {
                // 2. ä½¿ç”¨ä¿å­˜çš„IDé‡æ–°è·å–é“¾æ¥
                const apiUrl =
                  track.musicSource === "netease"
                    ? `https://api.vkeys.cn/v2/music/netease?id=${track.musicId}`
                    : `https://api.vkeys.cn/v2/music/tencent?id=${track.musicId}`;

                const res = await Http_Get(apiUrl);
                if (res?.data?.url) {
                  // 3. æ›´æ–°å†…å­˜ä¸­çš„é“¾æ¥
                  track.src = res.data.url;
                  // 4. æ›´æ–°æ•°æ®åº“ï¼Œä¿å­˜æ–°é“¾æ¥
                  state.musicState.playlist[index] = track;
                  await saveGlobalPlaylist();
                  console.log(`ç»­æœŸæˆåŠŸï¼æ–°é“¾æ¥: ${track.src}`);
                }
              } catch (e) {
                console.error("è‡ªåŠ¨ç»­æœŸå¤±è´¥:", e);
              }
            }
          }

          // æ£€æŸ¥å¹¶åŠ è½½ç½‘ç»œæ­Œè¯
          if (track.lrcUrl && !track.lrcContent) {
            try {
              const response = await fetch(track.lrcUrl);
              if (response.ok) track.lrcContent = await response.text();
            } catch (error) {
              console.error("åŠ è½½æ­Œè¯URLå¤±è´¥:", error);
            }
          }

          // å‡†å¤‡æ’­æ”¾
          state.musicState.parsedLyrics = parseLRC(track.lrcContent || "");
          state.musicState.currentLyricIndex = -1;
          renderLyrics();

          if (track.isLocal && track.src instanceof Blob) {
            audioPlayer.src = URL.createObjectURL(track.src);
          } else if (!track.isLocal) {
            audioPlayer.src = track.src;
          } else {
            console.error("æœ¬åœ°æ­Œæ›²æºé”™è¯¯:", track);
            return;
          }

          // æ›´æ–°ç•Œé¢ä¿¡æ¯
          updatePlaylistUI();
          updatePlayerUI();

          // å°è¯•æ’­æ”¾
          try {
            if (state.musicState.isPlaying) {
              await audioPlayer.play();
            }
          } catch (e) {
            console.warn("åŠ è½½åè‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆª", e);
          }

          audioPlayer.onloadedmetadata = () => {
            updateMusicProgressBar();
          };
        }

        async function playSong(index) {
          await loadSong(index);
          try {
            await audioPlayer.play();

            state.musicState.isPlaying = true; // æ’­æ”¾æˆåŠŸåï¼Œç›´æ¥è®¾ç½®çŠ¶æ€ä¸º true
            updatePlayerUI(); // å¹¶ç«‹å³æ›´æ–°UI
          } catch (error) {
            console.error("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", error);
            state.musicState.isPlaying = false; // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œä¹Ÿè¦ç¡®ä¿çŠ¶æ€æ­£ç¡®
            updatePlayerUI();
          }
        }

        /**
         * å¤„ç†æ’­æ”¾/æš‚åœçš„å‡½æ•°
         */
        function togglePlayPause() {
          if (audioPlayer.paused) {
            if (state.musicState.currentIndex > -1) {
              playSong(state.musicState.currentIndex);
            }
          } else {
            audioPlayer.pause();

            state.musicState.isPlaying = false;
            updatePlayerUI();
          }
        }

        // æ’­æ”¾ä¸‹ä¸€é¦–ï¼ˆæ­£ç¡®è·³è¿‡ä¿æ´»éŸ³é¢‘ï¼‰
        function playNext() {
          if (state.musicState.playlist.length === 0) return;

          let nextIndex = state.musicState.currentIndex; // ä½¿ç”¨ä¸´æ—¶å˜é‡ä½œä¸ºèµ·ç‚¹
          let attempts = 0; // é˜²æ­¢æ­»å¾ªç¯çš„å®‰å…¨è®¡æ•°

          do {
            switch (state.musicState.playMode) {
              case "random":
                // éšæœºæ¨¡å¼ï¼šç›´æ¥ç”Ÿæˆä¸€ä¸ªéšæœºæ•°
                nextIndex = Math.floor(
                  Math.random() * state.musicState.playlist.length,
                );
                break;
              case "single":
                // å•æ›²å¾ªç¯æ¨¡å¼ï¼šè™½ç„¶é€šå¸¸ç”±endedè§¦å‘é‡æ’­ï¼Œä½†åœ¨æ‰‹åŠ¨ç‚¹å‡»ä¸‹ä¸€é¦–æ—¶ï¼Œåº”å½“åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–
                nextIndex = (nextIndex + 1) % state.musicState.playlist.length;
                break;
              case "order":
              default:
                // é¡ºåºæ¨¡å¼ï¼šå½“å‰ç´¢å¼• + 1
                nextIndex = (nextIndex + 1) % state.musicState.playlist.length;
                break;
            }

            attempts++;
          } while (
            // å¦‚æœé€‰ä¸­çš„æ˜¯ä¿æ´»éŸ³é¢‘ (isKeepAlive=true)
            // å¹¶ä¸”åˆ—è¡¨é‡Œä¸åªæœ‰è¿™ä¸€é¦–æ­Œ
            // å¹¶ä¸”æ²¡æœ‰å°è¯•è¶…è¿‡åˆ—è¡¨é•¿åº¦çš„2å€ï¼ˆé˜²æ­¢å…¨éƒ½æ˜¯ä¿æ´»éŸ³é¢‘å¯¼è‡´æ­»å¾ªç¯ï¼‰
            state.musicState.playlist[nextIndex].isKeepAlive &&
            state.musicState.playlist.length > 1 &&
            attempts < state.musicState.playlist.length * 2
          );

          playSong(nextIndex);
        }

        // æ’­æ”¾ä¸Šä¸€é¦–ï¼ˆè‡ªåŠ¨è·³è¿‡ä¿æ´»éŸ³é¢‘ï¼‰
        function playPrev() {
          if (state.musicState.playlist.length === 0) return;
          let newIndex = state.musicState.currentIndex;
          let attempts = 0;

          do {
            newIndex =
              (newIndex - 1 + state.musicState.playlist.length) %
              state.musicState.playlist.length;
            attempts++;
          } while (
            state.musicState.playlist[newIndex].isKeepAlive &&
            state.musicState.playlist.length > 1 &&
            attempts < state.musicState.playlist.length * 2
          );

          playSong(newIndex);
        }

        function changePlayMode() {
          const modes = ["order", "random", "single"];
          const currentModeIndex = modes.indexOf(state.musicState.playMode);
          state.musicState.playMode =
            modes[(currentModeIndex + 1) % modes.length];
          document.getElementById("music-mode-btn").textContent = {
            order: "é¡ºåº",
            random: "éšæœº",
            single: "å•æ›²",
          }[state.musicState.playMode];
        }

        async function addSongFromURL() {
          const url = await showCustomPrompt(
            "æ·»åŠ ç½‘ç»œæ­Œæ›²",
            "è¯·è¾“å…¥æ­Œæ›²çš„URL",
            "",
            "url",
          );
          if (!url) return;
          const name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå");
          if (!name) return;
          const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å");
          if (!artist) return;

          // 1. å…ˆå¼¹çª—è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦æä¾›æ­Œè¯é“¾æ¥
          const wantLrc = await showCustomConfirm(
            "å¯¼å…¥æ­Œè¯",
            `è¦ä¸ºã€Š${name}ã€‹æä¾›ä¸€ä¸ªæ­Œè¯æ–‡ä»¶ (.lrc) çš„URLå—ï¼Ÿ`,
          );
          let lrcUrl = ""; // é»˜è®¤æ­Œè¯é“¾æ¥ä¸ºç©º

          // 2. å¦‚æœç”¨æˆ·ç‚¹å‡»äº†â€œç¡®å®šâ€
          if (wantLrc) {
            // å°±å†å¼¹å‡ºä¸€ä¸ªè¾“å…¥æ¡†è®©ç”¨æˆ·ç²˜è´´URL
            const inputLrcUrl = await showCustomPrompt(
              "æ­Œè¯URL",
              "è¯·è¾“å…¥ .lrc æ­Œè¯æ–‡ä»¶çš„ç½‘ç»œé“¾æ¥",
              "",
              "url",
            );
            if (inputLrcUrl) {
              lrcUrl = inputLrcUrl; // å¦‚æœç”¨æˆ·è¾“å…¥äº†ï¼Œå°±ä¿å­˜è¿™ä¸ªURL
            }
          }

          state.musicState.playlist.push({
            name,
            artist,
            src: url,
            isLocal: false,
            lrcUrl: lrcUrl, // 3. æŠŠè·å–åˆ°çš„æ­Œè¯URLä¹Ÿä¿å­˜åˆ°æ­Œæ›²ä¿¡æ¯é‡Œ
            lrcContent: "", // åŒæ—¶ç¡®ä¿lrcContentæ˜¯ç©ºçš„ï¼Œä»¥ä¾¿åç»­åŠ è½½
          });

          await saveGlobalPlaylist();
          updatePlaylistUI();

          if (state.musicState.currentIndex === -1) {
            // è°ƒç”¨ loadSong æ¥å‡†å¤‡å¥½ç¬¬ä¸€é¦–æ­Œ
            loadSong(state.musicState.playlist.length - 1);
          }
        }

        async function addSongFromLocal(event) {
          const files = event.target.files;
          if (!files.length) return;

          for (const file of files) {
            let name = file.name.replace(/\.[^/.]+$/, "");
            name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå", name);
            if (name === null) continue;

            const artist = await showCustomPrompt(
              "æ­Œæ›²ä¿¡æ¯",
              "è¯·è¾“å…¥æ­Œæ‰‹å",
              "æœªçŸ¥æ­Œæ‰‹",
            );
            if (artist === null) continue;

            let lrcContent = "";
            const wantLrc = await showCustomConfirm(
              "å¯¼å…¥æ­Œè¯",
              `è¦ä¸ºã€Š${name}ã€‹å¯¼å…¥æ­Œè¯æ–‡ä»¶ (.lrc) å—ï¼Ÿ`,
            );
            if (wantLrc) {
              lrcContent = await new Promise((resolve) => {
                const lrcInput = document.getElementById("lrc-upload-input");
                const lrcChangeHandler = (e) => {
                  const lrcFile = e.target.files[0];
                  if (lrcFile) {
                    const reader = new FileReader();
                    reader.onload = (readEvent) =>
                      resolve(readEvent.target.result);
                    reader.onerror = () => resolve("");
                    reader.readAsText(lrcFile);
                  } else {
                    resolve("");
                  }
                  lrcInput.removeEventListener("change", lrcChangeHandler);
                  lrcInput.value = "";
                };
                lrcInput.addEventListener("change", lrcChangeHandler);
                lrcInput.click();
              });
            }

            state.musicState.playlist.push({
              name,
              artist,
              src: file,
              isLocal: true,
              lrcContent: lrcContent,
            });
          }

          await saveGlobalPlaylist();
          updatePlaylistUI();

          if (
            state.musicState.currentIndex === -1 &&
            state.musicState.playlist.length > 0
          ) {
            // è°ƒç”¨ loadSong æ¥å‡†å¤‡å¥½ç¬¬ä¸€é¦–æ­Œ
            loadSong(0);
          }
          event.target.value = null;
        }

        async function deleteTrack(index) {
          if (index < 0 || index >= state.musicState.playlist.length) return;
          const track = state.musicState.playlist[index];
          const wasPlaying =
            state.musicState.isPlaying &&
            state.musicState.currentIndex === index;
          if (
            track.isLocal &&
            audioPlayer.src.startsWith("blob:") &&
            state.musicState.currentIndex === index
          )
            URL.revokeObjectURL(audioPlayer.src);
          state.musicState.playlist.splice(index, 1);
          await saveGlobalPlaylist();
          if (state.musicState.playlist.length === 0) {
            if (state.musicState.isPlaying) audioPlayer.pause();
            audioPlayer.src = "";
            state.musicState.currentIndex = -1;
            state.musicState.isPlaying = false;
          } else {
            if (wasPlaying) {
              playNext();
            } else {
              if (state.musicState.currentIndex >= index)
                state.musicState.currentIndex = Math.max(
                  0,
                  state.musicState.currentIndex - 1,
                );
            }
          }
          updatePlayerUI();
          updatePlaylistUI();
        }

        const personaLibraryModal = document.getElementById(
          "persona-library-modal",
        );
        const personaEditorModal = document.getElementById(
          "persona-editor-modal",
        );
        const presetActionsModal = document.getElementById(
          "preset-actions-modal",
        );

        function openPersonaLibrary() {
          renderPersonaLibrary();
          personaLibraryModal.classList.add("visible");
        }

        function closePersonaLibrary() {
          personaLibraryModal.classList.remove("visible");
        }

        function renderPersonaLibrary() {
          const grid = document.getElementById("persona-library-grid");
          grid.innerHTML = "";
          if (state.personaPresets.length === 0) {
            grid.innerHTML =
              '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">ç©ºç©ºå¦‚ä¹Ÿ~ ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ "æ¥åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªäººè®¾é¢„è®¾å§ï¼</p>';
            return;
          }
          state.personaPresets.forEach((preset) => {
            const item = document.createElement("div");
            item.className = "persona-preset-item";
            item.style.backgroundImage = `url(${preset.avatar})`;
            item.dataset.presetId = preset.id;
            item.addEventListener("click", () => applyPersonaPreset(preset.id));
            addLongPressListener(item, () => showPresetActions(preset.id));
            grid.appendChild(item);
          });
        }

        function showPresetActions(presetId) {
          editingPersonaPresetId = presetId;
          presetActionsModal.classList.add("visible");
        }

        function hidePresetActions() {
          presetActionsModal.classList.remove("visible");
          editingPersonaPresetId = null;
        }

        function applyPersonaPreset(presetId) {
          const preset = state.personaPresets.find((p) => p.id === presetId);
          if (preset) {
            document.getElementById("my-avatar-preview").src = preset.avatar;
            document.getElementById("my-persona").value = preset.persona;
          }
          closePersonaLibrary();
        }

        function openPersonaEditorForCreate() {
          editingPersonaPresetId = null;

          document.getElementById("persona-editor-title").textContent =
            "æ·»åŠ äººè®¾é¢„è®¾";
          document.getElementById("preset-avatar-preview").src = defaultAvatar;
          document.getElementById("preset-persona-input").value = "";

          // æ ¹æ®ç”¨æˆ·äººè®¾æ¨¡å¼ï¼Œæ˜¾éšç‰¹å®šUIå…ƒç´ 
          document.getElementById("npc-editor-name-group").style.display =
            "none";
          document.getElementById(
            "persona-editor-change-frame-btn",
          ).style.display = "inline-block";

          // ç›´æ¥è¦†ç›–ä¿å­˜æŒ‰é’®çš„ onclick äº‹ä»¶ï¼Œå¼ºåˆ¶å®ƒåªæ‰§è¡Œä¿å­˜ç”¨æˆ·äººè®¾çš„å‡½æ•°
          document.getElementById("save-persona-preset-btn").onclick =
            savePersonaPreset;

          document
            .getElementById("persona-editor-modal")
            .classList.add("visible");
        }

        function openPersonaEditorForEdit() {
          const preset = state.personaPresets.find(
            (p) => p.id === editingPersonaPresetId,
          );
          if (!preset) return;

          document.getElementById("persona-editor-title").textContent =
            "ç¼–è¾‘äººè®¾é¢„è®¾";
          document.getElementById("preset-avatar-preview").src = preset.avatar;
          document.getElementById("preset-persona-input").value =
            preset.persona;

          // æ ¹æ®ç”¨æˆ·äººè®¾æ¨¡å¼ï¼Œæ˜¾éšç‰¹å®šUIå…ƒç´ 
          document.getElementById("npc-editor-name-group").style.display =
            "none";
          document.getElementById(
            "persona-editor-change-frame-btn",
          ).style.display = "inline-block";

          // ç›´æ¥è¦†ç›–ä¿å­˜æŒ‰é’®çš„ onclick äº‹ä»¶ï¼Œå¼ºåˆ¶å®ƒåªæ‰§è¡Œä¿å­˜ç”¨æˆ·äººè®¾çš„å‡½æ•°
          document.getElementById("save-persona-preset-btn").onclick =
            savePersonaPreset;

          presetActionsModal.classList.remove("visible");
          document
            .getElementById("persona-editor-modal")
            .classList.add("visible");
        }

        async function deletePersonaPreset() {
          const confirmed = await showCustomConfirm(
            "åˆ é™¤é¢„è®¾",
            "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººè®¾é¢„è®¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",
            {
              confirmButtonClass: "btn-danger",
            },
          );
          if (confirmed && editingPersonaPresetId) {
            await db.personaPresets.delete(editingPersonaPresetId);
            state.personaPresets = state.personaPresets.filter(
              (p) => p.id !== editingPersonaPresetId,
            );
            hidePresetActions();
            renderPersonaLibrary();
          }
        }

        function closePersonaEditor() {
          personaEditorModal.classList.remove("visible");
          editingPersonaPresetId = null;
        }

        async function savePersonaPreset() {
          const avatar = document.getElementById("preset-avatar-preview").src;
          const persona = document
            .getElementById("preset-persona-input")
            .value.trim();
          if (avatar === defaultAvatar && !persona) {
            alert("å¤´åƒå’Œäººè®¾ä¸èƒ½éƒ½ä¸ºç©ºå“¦ï¼");
            return;
          }
          if (editingPersonaPresetId) {
            const preset = state.personaPresets.find(
              (p) => p.id === editingPersonaPresetId,
            );
            if (preset) {
              preset.avatar = avatar;
              preset.persona = persona;
              await db.personaPresets.put(preset);
            }
          } else {
            const newPreset = {
              id: "preset_" + Date.now(),
              avatar: avatar,
              persona: persona,
            };
            await db.personaPresets.add(newPreset);
            state.personaPresets.push(newPreset);
          }
          renderPersonaLibrary();
          closePersonaEditor();
        }

        const batteryAlertModal = document.getElementById(
          "battery-alert-modal",
        );

        function showBatteryAlert(imageUrl, text) {
          clearTimeout(batteryAlertTimeout);
          document.getElementById("battery-alert-image").src = imageUrl;
          document.getElementById("battery-alert-text").textContent = text;
          batteryAlertModal.classList.add("visible");
          const closeAlert = () => {
            batteryAlertModal.classList.remove("visible");
            batteryAlertModal.removeEventListener("click", closeAlert);
          };
          batteryAlertModal.addEventListener("click", closeAlert);
          batteryAlertTimeout = setTimeout(closeAlert, 2000);
        }

        function updateBatteryDisplay(battery) {
          const batteryContainer =
            document.getElementById("status-bar-battery");
          const batteryLevelEl =
            batteryContainer.querySelector(".battery-level");
          const batteryTextEl = batteryContainer.querySelector(".battery-text");
          const level = Math.floor(battery.level * 100);
          batteryLevelEl.style.width = `${level}%`;
          batteryTextEl.textContent = `${level}%`;
          if (battery.charging) {
            batteryContainer.classList.add("charging");
          } else {
            batteryContainer.classList.remove("charging");
          }
        }

        function handleBatteryChange(battery) {
          updateBatteryDisplay(battery);
          const level = battery.level;
          if (!battery.charging) {
            if (
              level <= 0.4 &&
              lastKnownBatteryLevel > 0.4 &&
              !alertFlags.hasShown40
            ) {
              showBatteryAlert(
                "https://i.postimg.cc/T2yKJ0DV/40.jpg",
                "æœ‰ç‚¹é¥¿äº†ï¼Œå¯ä»¥å»æ‰¾å……ç”µå™¨æƒ¹",
              );
              alertFlags.hasShown40 = true;
            }
            if (
              level <= 0.2 &&
              lastKnownBatteryLevel > 0.2 &&
              !alertFlags.hasShown20
            ) {
              showBatteryAlert(
                "https://i.postimg.cc/qB9zbKs9/20.jpg",
                "èµ¶ç´§çš„å……ç”µï¼Œè¦é¥¿æ­»äº†",
              );
              alertFlags.hasShown20 = true;
            }
            if (
              level <= 0.1 &&
              lastKnownBatteryLevel > 0.1 &&
              !alertFlags.hasShown10
            ) {
              showBatteryAlert(
                "https://i.postimg.cc/ThMMVfW4/10.jpg",
                "å·²é˜µäº¡ï¼Œè¿˜æœ‰30ç§’çˆ†ç‚¸",
              );
              alertFlags.hasShown10 = true;
            }
          }
          if (level > 0.4) alertFlags.hasShown40 = false;
          if (level > 0.2) alertFlags.hasShown20 = false;
          if (level > 0.1) alertFlags.hasShown10 = false;
          lastKnownBatteryLevel = level;
        }

        async function initBatteryManager() {
          if ("getBattery" in navigator) {
            try {
              const battery = await navigator.getBattery();
              lastKnownBatteryLevel = battery.level;
              handleBatteryChange(battery);
              battery.addEventListener("levelchange", () =>
                handleBatteryChange(battery),
              );
              battery.addEventListener("chargingchange", () => {
                handleBatteryChange(battery);
                if (battery.charging) {
                  showBatteryAlert(
                    "https://i.postimg.cc/3NDQ0dWG/image.jpg",
                    "çªçˆ±æ³¥ï¼Œç”µé‡åƒé¥±é¥±",
                  );
                }
              });
            } catch (err) {
              console.error("æ— æ³•è·å–ç”µæ± ä¿¡æ¯:", err);
              document.querySelector(".battery-text").textContent = "á—œÏ‰á—œ";
            }
          } else {
            console.log("æµè§ˆå™¨ä¸æ”¯æŒç”µæ± çŠ¶æ€APIã€‚");
            document.querySelector(".battery-text").textContent = "á—œÏ‰á—œ";
          }
        }

        async function renderAlbumList() {
          const albumGrid = document.getElementById("album-grid-page");
          if (!albumGrid) return;
          const albums = await db.qzoneAlbums
            .orderBy("createdAt")
            .reverse()
            .toArray();
          albumGrid.innerHTML = "";
          if (albums.length === 0) {
            albumGrid.innerHTML =
              '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">ä½ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ç›¸å†Œå“¦~</p>';
            return;
          }
          albums.forEach((album) => {
            const albumItem = document.createElement("div");
            albumItem.className = "album-item";
            albumItem.innerHTML = `
			                    <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
			                    <div class="album-info">
			                        <p class="album-name">${album.name}</p>
			                        <p class="album-count">${album.photoCount || 0} å¼ </p>
			                    </div>
			                `;
            albumItem.addEventListener("click", () => {
              openAlbum(album.id);
            });

            addLongPressListener(albumItem, async () => {
              const confirmed = await showCustomConfirm(
                "åˆ é™¤ç›¸å†Œ",
                `ç¡®å®šè¦åˆ é™¤ç›¸å†Œã€Š${album.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ç›¸å†Œå†…çš„æ‰€æœ‰ç…§ç‰‡ï¼Œä¸”æ— æ³•æ¢å¤ã€‚`,
                { confirmButtonClass: "btn-danger" },
              );

              if (confirmed) {
                // 1. ä»ç…§ç‰‡è¡¨ä¸­åˆ é™¤è¯¥ç›¸å†Œä¸‹çš„æ‰€æœ‰ç…§ç‰‡
                await db.qzonePhotos.where("albumId").equals(album.id).delete();

                // 2. ä»ç›¸å†Œè¡¨ä¸­åˆ é™¤è¯¥ç›¸å†Œæœ¬èº«
                await db.qzoneAlbums.delete(album.id);

                // 3. é‡æ–°æ¸²æŸ“ç›¸å†Œåˆ—è¡¨
                await renderAlbumList();

                alert("ç›¸å†Œå·²æˆåŠŸåˆ é™¤ã€‚");
              }
            });

            albumGrid.appendChild(albumItem);
          });
        }

        async function openAlbum(albumId) {
          state.activeAlbumId = albumId;
          await renderAlbumPhotosScreen();
          showScreen("album-photos-screen");
        }

        async function renderAlbumPhotosScreen() {
          if (!state.activeAlbumId) return;
          const photosGrid = document.getElementById("photos-grid-page");
          const headerTitle = document.getElementById("album-photos-title");
          const album = await db.qzoneAlbums.get(state.activeAlbumId);
          if (!album) {
            console.error("æ‰¾ä¸åˆ°ç›¸å†Œ:", state.activeAlbumId);
            showScreen("album-screen");
            return;
          }
          headerTitle.textContent = album.name;
          const photos = await db.qzonePhotos
            .where("albumId")
            .equals(state.activeAlbumId)
            .toArray();
          photosGrid.innerHTML = "";
          if (photos.length === 0) {
            photosGrid.innerHTML =
              '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">è¿™ä¸ªç›¸å†Œè¿˜æ˜¯ç©ºçš„ï¼Œå¿«ä¸Šä¼ ç¬¬ä¸€å¼ ç…§ç‰‡å§ï¼</p>';
          } else {
            photos.forEach((photo) => {
              const photoItem = document.createElement("div");
              photoItem.className = "photo-item";
              photoItem.innerHTML = `
			                        <img src="${photo.url}" class="photo-thumb" alt="ç›¸å†Œç…§ç‰‡">
			                        <button class="photo-delete-btn" data-photo-id="${photo.id}">Ã—</button>
			                    `;
              photosGrid.appendChild(photoItem);
            });
          }
        }

        /**
         * æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨
         * @param {string} clickedPhotoUrl - ç”¨æˆ·ç‚¹å‡»çš„é‚£å¼ ç…§ç‰‡çš„URL
         */
        async function openPhotoViewer(clickedPhotoUrl) {
          if (!state.activeAlbumId) return;

          // 1. ä»æ•°æ®åº“è·å–å½“å‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡
          const photosInAlbum = await db.qzonePhotos
            .where("albumId")
            .equals(state.activeAlbumId)
            .toArray();
          photoViewerState.photos = photosInAlbum.map((p) => p.url);

          // 2. æ‰¾åˆ°è¢«ç‚¹å‡»ç…§ç‰‡çš„ç´¢å¼•
          photoViewerState.currentIndex = photoViewerState.photos.findIndex(
            (url) => url === clickedPhotoUrl,
          );
          if (photoViewerState.currentIndex === -1) return; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ä¸æ‰“å¼€

          // 3. æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶æ¸²æŸ“ç¬¬ä¸€å¼ å›¾
          document
            .getElementById("photo-viewer-modal")
            .classList.add("visible");
          renderPhotoViewer();
          photoViewerState.isOpen = true;
        }

        /**
         * æ ¹æ®å½“å‰çŠ¶æ€æ¸²æŸ“æŸ¥çœ‹å™¨å†…å®¹ï¼ˆå›¾ç‰‡å’ŒæŒ‰é’®ï¼‰
         */
        function renderPhotoViewer() {
          if (photoViewerState.currentIndex === -1) return;

          const imageEl = document.getElementById("photo-viewer-image");
          const prevBtn = document.getElementById("photo-viewer-prev-btn");
          const nextBtn = document.getElementById("photo-viewer-next-btn");

          // æ·¡å‡ºæ•ˆæœ
          imageEl.style.opacity = 0;

          setTimeout(() => {
            // æ›´æ–°å›¾ç‰‡æº
            imageEl.src =
              photoViewerState.photos[photoViewerState.currentIndex];
            // æ·¡å…¥æ•ˆæœ
            imageEl.style.opacity = 1;
          }, 100); // å»¶è¿Ÿä¸€ç‚¹ç‚¹æ—¶é—´æ¥è§¦å‘CSSè¿‡æ¸¡

          // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼šå¦‚æœæ˜¯ç¬¬ä¸€å¼ ï¼Œç¦ç”¨â€œä¸Šä¸€å¼ â€æŒ‰é’®
          prevBtn.disabled = photoViewerState.currentIndex === 0;
          // å¦‚æœæ˜¯æœ€åä¸€å¼ ï¼Œç¦ç”¨â€œä¸‹ä¸€å¼ â€æŒ‰é’®
          nextBtn.disabled =
            photoViewerState.currentIndex ===
            photoViewerState.photos.length - 1;
        }

        /**
         * æ˜¾ç¤ºä¸‹ä¸€å¼ ç…§ç‰‡
         */
        function showNextPhoto() {
          if (
            photoViewerState.currentIndex <
            photoViewerState.photos.length - 1
          ) {
            photoViewerState.currentIndex++;
            renderPhotoViewer();
          }
        }

        /**
         * æ˜¾ç¤ºä¸Šä¸€å¼ ç…§ç‰‡
         */
        function showPrevPhoto() {
          if (photoViewerState.currentIndex > 0) {
            photoViewerState.currentIndex--;
            renderPhotoViewer();
          }
        }

        /**
         * å…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
         */
        function closePhotoViewer() {
          document
            .getElementById("photo-viewer-modal")
            .classList.remove("visible");
          photoViewerState.isOpen = false;
          photoViewerState.photos = [];
          photoViewerState.currentIndex = -1;
          // æ¸…ç©ºå›¾ç‰‡ï¼Œé¿å…ä¸‹æ¬¡æ‰“å¼€æ—¶é—ªç°æ—§å›¾
          document.getElementById("photo-viewer-image").src = "";
        }

        /**
         * æ›´æ–°åŠ¨æ€å°çº¢ç‚¹çš„æ˜¾ç¤º
         * @param {number} count - æœªè¯»åŠ¨æ€çš„æ•°é‡
         */
        function updateUnreadIndicator(count) {
          unreadPostsCount = count;
          localStorage.setItem("unreadPostsCount", count); // æŒä¹…åŒ–å­˜å‚¨

          // --- æ›´æ–°åº•éƒ¨å¯¼èˆªæ çš„â€œåŠ¨æ€â€æŒ‰é’® ---
          const navItem = document.querySelector(
            '.nav-item[data-view="qzone-screen"]',
          );

          const targetSpan = navItem.querySelector("span"); // å®šä½åˆ°æ–‡å­— "åŠ¨æ€"
          let indicator = navItem.querySelector(".unread-indicator");

          if (count > 0) {
            if (!indicator) {
              indicator = document.createElement("span");
              indicator.className = "unread-indicator";
              targetSpan.style.position = "relative"; // æŠŠç›¸å¯¹å®šä½åŠ åœ¨ span ä¸Š
              targetSpan.appendChild(indicator); // æŠŠå°çº¢ç‚¹ä½œä¸º span çš„å­å…ƒç´ 
            }
            indicator.textContent = count > 99 ? "99+" : count;
            indicator.style.display = "block";
          } else {
            if (indicator) {
              indicator.style.display = "none";
            }
          }

          // --- æ›´æ–°èŠå¤©ç•Œé¢è¿”å›åˆ—è¡¨çš„æŒ‰é’® ---
          const backBtn = document.getElementById("back-to-list-btn");
          let backBtnIndicator = backBtn.querySelector(".unread-indicator");

          if (count > 0) {
            if (!backBtnIndicator) {
              backBtnIndicator = document.createElement("span");
              backBtnIndicator.className =
                "unread-indicator back-btn-indicator";
              backBtn.style.position = "relative"; // ç¡®ä¿èƒ½æ­£ç¡®å®šä½
              backBtn.appendChild(backBtnIndicator);
            }
            // è¿”å›é”®ä¸Šçš„å°çº¢ç‚¹é€šå¸¸ä¸æ˜¾ç¤ºæ•°å­—ï¼Œåªæ˜¾ç¤ºä¸€ä¸ªç‚¹
            backBtnIndicator.style.display = "block";
          } else {
            if (backBtnIndicator) {
              backBtnIndicator.style.display = "none";
            }
          }
        }

        function startBackgroundSimulation() {
          if (simulationIntervalId) return;
          const intervalSeconds =
            state.globalSettings.backgroundActivityInterval || 60;
          // å°†æ—§çš„å›ºå®šé—´éš” 45000 æ›¿æ¢ä¸ºåŠ¨æ€è·å–
          simulationIntervalId = setInterval(
            runBackgroundSimulationTick,
            intervalSeconds * 1000,
          );
        }

        function stopBackgroundSimulation() {
          if (simulationIntervalId) {
            clearInterval(simulationIntervalId);
            simulationIntervalId = null;
          }
        }

        /**
         * ã€æ•°æ®è¿ç§»ã€‘åœ¨é¦–æ¬¡åŠ è½½æ—¶ï¼Œå°†æ—§çš„ç¡¬ç¼–ç é—®é¢˜è¿ç§»åˆ°æ•°æ®åº“
         */
        async function migrateDefaultLudoQuestions() {
          const defaultBankName = "é»˜è®¤é¢˜åº“";
          const existingBank = await db.ludoQuestionBanks
            .where("name")
            .equals(defaultBankName)
            .first();
          // å¦‚æœâ€œé»˜è®¤é¢˜åº“â€å·²ç»å­˜åœ¨ï¼Œå°±è¯´æ˜è¿ç§»è¿‡äº†ï¼Œç›´æ¥è¿”å›
          if (existingBank) return;

          console.log("æ­£åœ¨è¿ç§»é£è¡Œæ£‹é»˜è®¤é—®é¢˜åˆ°æ•°æ®åº“...");

          // åˆ›å»ºé»˜è®¤é¢˜åº“
          const bankId = await db.ludoQuestionBanks.add({
            name: defaultBankName,
          });

          const defaultQuestions = [
            // --- ç±»å‹1: å…±åŒå›ç­” (åŒæ–¹éƒ½éœ€è¦å›ç­”) ---
            {
              type: "both_answer",
              text: "å¦‚æœæˆ‘ä»¬ä¸€èµ·å»æ—…è¡Œï¼Œä½ æœ€æƒ³å»å“ªé‡Œï¼Œä¸ºä»€ä¹ˆï¼Ÿ",
            },
            {
              type: "both_answer",
              text: "ä½ è®¤ä¸ºä¸€æ®µå®Œç¾çš„å…³ç³»ä¸­ï¼Œæœ€ä¸å¯æˆ–ç¼ºçš„ä¸‰ä¸ªè¦ç´ æ˜¯ä»€ä¹ˆï¼Ÿ",
            },
            {
              type: "both_answer",
              text: "åˆ†äº«ä¸€ä»¶æœ€è¿‘å› ä¸ºæˆ‘è€Œè®©ä½ æ„Ÿåˆ°å¿ƒåŠ¨æˆ–å¼€å¿ƒçš„å°äº‹ã€‚",
            },
            {
              type: "both_answer",
              text: "å›å¿†ä¸€ä¸‹ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡è§é¢æ—¶ï¼Œä½ å¯¹æˆ‘çš„ç¬¬ä¸€å°è±¡æ˜¯ä»€ä¹ˆï¼Ÿ",
            },
            {
              type: "both_answer",
              text: "å¦‚æœæˆ‘ä»¬å¯ä»¥ä¸€èµ·å­¦ä¹ ä¸€é¡¹æ–°æŠ€èƒ½ï¼Œä½ å¸Œæœ›æ˜¯ä»€ä¹ˆï¼Ÿ",
            },
            {
              type: "both_answer",
              text: "æè¿°ä¸€ä¸ªä½ æœ€å¸Œæœ›å’Œæˆ‘ä¸€èµ·åº¦è¿‡çš„å®Œç¾å‘¨æœ«ã€‚",
            },
            {
              type: "both_answer",
              text: "ä½ è§‰å¾—æˆ‘ä»¬ä¹‹é—´æœ€æœ‰é»˜å¥‘çš„ä¸€ä»¶äº‹æ˜¯ä»€ä¹ˆï¼Ÿ",
            },
            {
              type: "both_answer",
              text: "å¦‚æœç”¨ä¸€ç§åŠ¨ç‰©æ¥å½¢å®¹æˆ‘ï¼Œä½ è§‰å¾—æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ",
            },
            {
              type: "both_answer",
              text: "åœ¨æœªæ¥çš„ä¸€å¹´é‡Œï¼Œä½ æœ€æƒ³å’Œæˆ‘ä¸€èµ·å®Œæˆçš„ä¸€ä»¶äº‹æ˜¯ä»€ä¹ˆï¼Ÿ",
            },
            {
              type: "both_answer",
              text: "åˆ†äº«ä¸€éƒ¨ä½ æœ€è¿‘å¾ˆå–œæ¬¢ã€å¹¶ä¸”æƒ³æ¨èç»™æˆ‘ä¸€èµ·çœ‹çš„ç”µå½±æˆ–å‰§ã€‚",
            },
            {
              type: "both_answer",
              text: "æˆ‘ä»¬ä¸‹æ¬¡çº¦ä¼šï¼Œä½ å¸Œæœ›ç©¿ä»€ä¹ˆé£æ ¼çš„è¡£æœï¼Ÿ",
            },

            // --- ç±»å‹2: ä¸€äººå›ç­”ï¼Œå¯¹æ–¹è¯„ä»· ---
            { type: "single_answer", text: "æè¿°ä¸€ä¸‹æˆ‘æœ€è®©ä½ å¿ƒåŠ¨çš„ä¸€ä¸ªç¬é—´ã€‚" },
            {
              type: "single_answer",
              text: "è¯šå®åœ°è¯´ï¼Œæˆ‘åšçš„å“ªä»¶äº‹æ›¾ç»è®©ä½ å·å·ç”Ÿè¿‡æ°”ï¼Ÿ",
            },
            {
              type: "single_answer",
              text: "å¦‚æœæˆ‘æœ‰ä¸€ç§è¶…èƒ½åŠ›ï¼Œä½ å¸Œæœ›æ˜¯ä»€ä¹ˆï¼Ÿ",
            },
            { type: "single_answer", text: "ç»™æˆ‘ä¸‰ä¸ªæœ€è´´åˆ‡çš„æ ‡ç­¾ã€‚" },
            {
              type: "single_answer",
              text: "åœ¨ä½ å¿ƒé‡Œï¼Œæˆ‘çš„å½¢è±¡å’Œä½ çš„ç†æƒ³å‹æœ‰å¤šæ¥è¿‘ï¼Ÿ",
            },
            {
              type: "single_answer",
              text: "åˆ†äº«ä¸€ä¸ªä½ è§‰å¾—æˆ‘å¯èƒ½ä¸çŸ¥é“çš„ï¼Œå…³äºä½ çš„å°ç§˜å¯†ã€‚",
            },
            {
              type: "single_answer",
              text: "å¦‚æœæˆ‘ä»¬çš„æ•…äº‹æ˜¯ä¸€é¦–æ­Œï¼Œä½ è§‰å¾—æ­Œååº”è¯¥å«ä»€ä¹ˆï¼Ÿ",
            },
            {
              type: "single_answer",
              text: "è¯´ä¸€ä»¶ä½ è§‰å¾—æˆ‘åšå¾—æ¯”ä½ å¥½/æ›´æ“…é•¿çš„äº‹æƒ…ã€‚",
            },
            {
              type: "single_answer",
              text: "å¦‚æœå¯ä»¥å›åˆ°æˆ‘ä»¬è®¤è¯†çš„ä»»æ„ä¸€å¤©ï¼Œä½ ä¼šé€‰æ‹©å“ªä¸€å¤©ï¼Œæƒ³åšä»€ä¹ˆï¼Ÿ",
            },
            {
              type: "single_answer",
              text: "ç”¨ä¸‰ä¸ªè¯æ¥å½¢å®¹ä½ çœ¼ä¸­çš„æˆ‘ä»¬çš„å…³ç³»ã€‚",
            },
          ];

          const questionsToAdd = defaultQuestions.map((q) => ({
            bankId: bankId,
            text: q.text,
            type: q.type, // <-- å…³é”®ä¿®å¤ï¼šæŠŠç±»å‹ä¹Ÿå­˜è¿›å»ï¼
          }));

          await db.ludoQuestions.bulkAdd(questionsToAdd);
          console.log(`æˆåŠŸè¿ç§»äº† ${questionsToAdd.length} æ¡é»˜è®¤é—®é¢˜ã€‚`);
        }
        /**
         * è¿™æ˜¯æ¨¡æ‹Ÿå™¨çš„â€œå¿ƒè·³â€ï¼Œæ¯æ¬¡å®šæ—¶å™¨è§¦å‘æ—¶è¿è¡Œ
         */
        function runBackgroundSimulationTick() {
          console.log("æ¨¡æ‹Ÿå™¨å¿ƒè·³ Tick...");
          if (!state.globalSettings.enableBackgroundActivity) {
            stopBackgroundSimulation();
            return;
          }
          const allSingleChats = Object.values(state.chats).filter(
            (chat) => !chat.isGroup,
          );

          if (allSingleChats.length === 0) return;

          const frequencyProbabilities = {
            low: 0.3, // ä½é¢‘: æ¯æ¬¡æ£€æµ‹æœ‰ 30% çš„æ¦‚ç‡è¡ŒåŠ¨
            medium: 0.5, // ä¸­é¢‘: æ¯æ¬¡æ£€æµ‹æœ‰ 50% çš„æ¦‚ç‡è¡ŒåŠ¨
            high: 0.8, // é«˜é¢‘: æ¯æ¬¡æ£€æµ‹æœ‰ 80% çš„æ¦‚ç‡è¡ŒåŠ¨
          };

          const config = state.globalSettings.backgroundActivityConfig || {};

          allSingleChats.forEach((chat) => {
            // æ£€æŸ¥1ï¼šå¤„ç†ã€è¢«ç”¨æˆ·æ‹‰é»‘ã€‘çš„è§’è‰²
            if (chat.relationship?.status === "blocked_by_user") {
              const blockedTimestamp = chat.relationship.blockedTimestamp;
              if (!blockedTimestamp) {
                console.warn(
                  `è§’è‰² "${chat.name}" çŠ¶æ€ä¸ºæ‹‰é»‘ï¼Œä½†ç¼ºå°‘æ‹‰é»‘æ—¶é—´æˆ³ï¼Œè·³è¿‡å¤„ç†ã€‚`,
                );
                return;
              }
              const blockedDuration = Date.now() - blockedTimestamp;
              const cooldownMilliseconds =
                (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;
              if (blockedDuration > cooldownMilliseconds) {
                console.log(
                  `è§’è‰² "${chat.name}" çš„å†·é™æœŸå·²è¿‡ï¼Œè§¦å‘â€œåæ€â€å¹¶ç”³è¯·å¥½å‹äº‹ä»¶...`,
                );
                chat.relationship.status = "pending_system_reflection";
                triggerAiFriendApplication(chat.id);
              }
            }
            // æ£€æŸ¥2ï¼šå¤„ç†ã€å¥½å‹å…³ç³»ã€‘çš„æ­£å¸¸åå°æ´»åŠ¨
            else if (
              chat.relationship?.status === "friend" &&
              chat.id !== state.activeChatId
            ) {
              const frequency = config[chat.id]; // è·å–å½“å‰è§’è‰²çš„é¢‘ç‡è®¾ç½®
              const probability = frequencyProbabilities[frequency]; // è·å–å¯¹åº”çš„æ¦‚ç‡

              // added by lrq 251028
              // æ·»åŠ æœ€åä¸€æ¡èŠå¤©è®°å½•æ—¶é—´çš„æ£€æŸ¥ï¼Œé¿å…é¢‘ç¹è¡ŒåŠ¨
              const lastMessage = chat.history.slice(-1)[0];
              if (lastMessage) {
                const timeSinceLastMessage = lastMessage
                  ? Date.now() - lastMessage.timestamp
                  : Infinity;
                const minInterval =
                  (state.globalSettings.backgroundActivityInterval || 10) *
                  1000;
                if (timeSinceLastMessage < minInterval) {
                  console.log(
                    `è§’è‰² "${chat.name}" è·ç¦»ä¸Šæ¬¡æ¶ˆæ¯å‘é€æ—¶é—´ä¸è¶³ï¼Œè·³è¿‡æœ¬æ¬¡è¡ŒåŠ¨ã€‚`,
                  );
                  return; // è·³è¿‡æœ¬æ¬¡è¡ŒåŠ¨
                }
              }

              // å¦‚æœè¿™ä¸ªè§’è‰²è®¾ç½®äº†é¢‘ç‡ï¼Œå¹¶ä¸”éšæœºæ•°å°äºå®ƒçš„è¡ŒåŠ¨æ¦‚ç‡ï¼Œå°±è§¦å‘è¡ŒåŠ¨
              if (probability && Math.random() < probability) {
                console.log(
                  `è§’è‰² "${chat.name}" (é¢‘ç‡: ${frequency}) è¢«å”¤é†’ï¼Œå‡†å¤‡ç‹¬ç«‹è¡ŒåŠ¨...`,
                );
                triggerInactiveAiAction(chat.id);
              }
              // å¦‚æœæ²¡æœ‰è®¾ç½®é¢‘ç‡ï¼Œæˆ–è€…éšæœºæ•°æ²¡è¾¾åˆ°æ¦‚ç‡ï¼Œå°±ä¸ä¼šè¡ŒåŠ¨ã€‚
              // è¿™å°±å®Œç¾åœ°å®ç°äº†â€œåˆ†ç»„è®¾ç½®â€å’Œâ€œä¸ä¼šåŒæ—¶è¡ŒåŠ¨â€çš„éœ€æ±‚ï¼
            }
          });
        }

        /**
         * æ ¹æ®AIçš„è§†è§’ï¼Œè¿‡æ»¤å‡ºå®ƒèƒ½çœ‹åˆ°çš„åŠ¨æ€
         * @param {Array} allPosts - æ‰€æœ‰å¾…æ£€æŸ¥çš„åŠ¨æ€å¸–å­
         * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€åŠ¨æ€çš„é‚£ä¸ªAIçš„chatå¯¹è±¡
         * @returns {Array} - è¿‡æ»¤åè¯¥AIå¯è§çš„åŠ¨æ€å¸–å­
         */

        function filterVisiblePostsForAI(allPosts, viewerChat) {
          if (!viewerChat || !viewerChat.id) return [];

          const viewerGroupId = viewerChat.groupId;

          return allPosts.filter((post) => {
            if (post.authorId === "user") {
              // å¦‚æœç”¨æˆ·è®¾ç½®äº†â€œéƒ¨åˆ†å¯è§â€
              if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                // åªæœ‰å½“æŸ¥çœ‹è€…AIçš„åˆ†ç»„IDåœ¨ç”¨æˆ·çš„å¯è§åˆ—è¡¨é‡Œæ—¶ï¼Œæ‰å¯è§
                return (
                  viewerGroupId && post.visibleGroupIds.includes(viewerGroupId)
                );
              }
              // å¦‚æœç”¨æˆ·æ²¡è®¾ç½®ï¼Œè¯´æ˜æ˜¯å…¬å¼€çš„ï¼Œæ‰€æœ‰AIéƒ½å¯è§
              return true;
            }

            const authorGroupId = post.authorGroupId;
            if (!authorGroupId) {
              return true;
            }
            return authorGroupId === viewerGroupId;
          });
        }

        /**
         * æ ¹æ®AIè§†è§’å’ŒåŠ¨æ€è®¾ç½®ï¼Œæ„å»ºç»™AIçœ‹çš„è¯„è®ºåŒºä¸Šä¸‹æ–‡
         * @param {object} post - æ­£åœ¨å¤„ç†çš„åŠ¨æ€å¯¹è±¡
         * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€åŠ¨æ€çš„AIè§’è‰²
         * @param {string} userNickname - ç”¨æˆ·çš„æ˜µç§°
         * @returns {{contextString: string, visibilityFlag: string}} - è¿”å›åŒ…å«ä¸Šä¸‹æ–‡æ–‡æœ¬å’Œå¯è§æ€§æ ‡å¿—çš„å¯¹è±¡
         */
        function buildCommentsContextForAI(post, viewerChat, userNickname) {
          // 1. å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœè¯„è®ºåŒºä¸å­˜åœ¨ã€ä¸æ˜¯æ•°ç»„æˆ–ä¸ºç©ºï¼Œç›´æ¥è¿”å›
          if (
            !post.comments ||
            !Array.isArray(post.comments) ||
            post.comments.length === 0
          ) {
            return { contextString: "", visibilityFlag: "[è¯„è®ºåŒºå¯è§]" };
          }

          const viewerName = viewerChat.name;
          let commentsForAI;
          let visibilityFlag;

          // 2. æ ¹æ®åŠ¨æ€çš„â€œè¯„è®ºåŒºå¯è§æ€§â€è®¾ç½®ï¼Œå†³å®šAIèƒ½çœ‹åˆ°å“ªäº›è¯„è®º
          if (post.areCommentsVisible !== false) {
            // å¦‚æœæ˜¯â€œæ‰€æœ‰äººå¯è§â€ï¼ŒAIèƒ½çœ‹åˆ°æ‰€æœ‰è¯„è®º
            commentsForAI = post.comments;
            visibilityFlag = "[è¯„è®ºåŒºå¯è§]";
          } else {
            // å¦‚æœæ˜¯â€œéƒ¨åˆ†å¯è§â€ï¼Œæ‰§è¡Œæˆ‘ä»¬å…¨æ–°çš„ã€æ›´ç²¾ç¡®çš„è¿‡æ»¤é€»è¾‘
            visibilityFlag = "[è¯„è®ºåŒºéƒ¨åˆ†å¯è§]";

            // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æœ¬æ¬¡æœ€æ ¸å¿ƒçš„ä¿®æ”¹ï¼ â˜…â˜…â˜…â˜…â˜…
            commentsForAI = post.comments.filter((comment) => {
              // è§„åˆ™1ï¼šAIæ€»èƒ½çœ‹åˆ°è‡ªå·±å‘çš„è¯„è®º
              if (comment.commenterName === viewerName) {
                return true;
              }

              // è§„åˆ™2ï¼šå¦‚æœè¯„è®ºæ˜¯ç”¨æˆ·å‘çš„ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­
              if (comment.commenterName === userNickname) {
                // 2a: å¦‚æœè¿™æ¡è¯„è®ºæ²¡æœ‰å›å¤ä»»ä½•äººï¼ˆæ˜¯ä¸»è¯„è®ºï¼‰ï¼Œé‚£ä¹ˆAIå¯è§
                if (!comment.replyTo) {
                  return true;
                }
                // 2b: å¦‚æœè¿™æ¡è¯„è®ºæ˜¯å›å¤ï¼Œé‚£åªæœ‰å›å¤ç›®æ ‡æ˜¯AIè‡ªå·±æ—¶ï¼ŒAIæ‰å¯è§
                if (comment.replyTo === viewerName) {
                  return true;
                }
              }

              // è§„åˆ™3ï¼šå¦‚æœå…¶ä»–AIæˆ–NPCå›å¤äº†å½“å‰AIï¼ŒAIä¹Ÿåº”è¯¥èƒ½çœ‹åˆ°
              if (comment.replyTo === viewerName) {
                return true;
              }

              // å…¶ä»–æ‰€æœ‰æƒ…å†µï¼ˆä¾‹å¦‚ï¼šç”¨æˆ·å›å¤å…¶ä»–NPCï¼ŒNPCä¹‹é—´äº’ç›¸å›å¤ï¼‰ï¼ŒAIéƒ½çœ‹ä¸è§
              return false;
            });
          }

          // å¦‚æœç­›é€‰åæ²¡æœ‰å¯æ˜¾ç¤ºçš„è¯„è®ºï¼Œä¹Ÿç›´æ¥è¿”å›
          if (commentsForAI.length === 0) {
            return { contextString: "", visibilityFlag: visibilityFlag };
          }

          // 3. æ„å»ºç»™AIçœ‹çš„æœ€ç»ˆæ–‡æœ¬ï¼ˆè¿™éƒ¨åˆ†é€»è¾‘å’Œä¹‹å‰ä¸€æ ·ï¼Œä¿æŒä¸å˜ï¼‰
          let context = `  â”” è¯„è®ºåŒº:\n`;
          commentsForAI.slice(-5).forEach((c) => {
            let displayName;
            if (c.commenterName === userNickname) {
              displayName = `ç”¨æˆ· (${userNickname})`;
            } else {
              displayName = c.commenterName;
            }

            if (c.replyTo) {
              const replyToDisplayName =
                c.replyTo === userNickname
                  ? `ç”¨æˆ· (${userNickname})`
                  : c.replyTo;
              context += `    - ${displayName} å›å¤ ${replyToDisplayName}: ${c.text}\n`;
            } else {
              context += `    - ${displayName}: ${c.text}\n`;
            }
          });

          return { contextString: context, visibilityFlag: visibilityFlag };
        }

        /**
         * è·å–ä¸€æ¡åŠ¨æ€çš„å¯è§è§‚ä¼—åˆ—è¡¨ï¼Œç”¨äºå‘ŠçŸ¥AI
         * @param {object} post - åŠ¨æ€å¯¹è±¡
         * @param {object} allChats - æ‰€æœ‰çš„èŠå¤©å¯¹è±¡
         * @param {string} userNickname - ç”¨æˆ·çš„æ˜µç§°
         * @returns {Array<string>} - å¯è§è§‚ä¼—çš„åå­—åˆ—è¡¨
         */
        function getVisibleAudienceForPost(post, allChats, userNickname) {
          const audience = new Set([userNickname]); // ç”¨æˆ·æ°¸è¿œæ˜¯è§‚ä¼—

          // 1. å¦‚æœæ˜¯ç”¨æˆ·å‘çš„åŠ¨æ€
          if (post.authorId === "user") {
            // å¦‚æœæ˜¯å…¬å¼€çš„ï¼Œæ‰€æœ‰AIéƒ½æ˜¯è§‚ä¼—
            if (!post.visibleGroupIds || post.visibleGroupIds.length === 0) {
              Object.values(allChats).forEach((chat) =>
                audience.add(chat.name),
              );
            } else {
              // å¦‚æœæ˜¯éƒ¨åˆ†å¯è§ï¼Œåªæœ‰æŒ‡å®šåˆ†ç»„çš„AIæ˜¯è§‚ä¼—
              Object.values(allChats).forEach((chat) => {
                if (
                  chat.groupId &&
                  post.visibleGroupIds.includes(chat.groupId)
                ) {
                  audience.add(chat.name);
                }
              });
            }
          }
          // 2. å¦‚æœæ˜¯AIå‘çš„åŠ¨æ€
          else {
            const authorChat = allChats[post.authorId];
            // å¦‚æœå‘å¸–çš„AIæ²¡æœ‰åˆ†ç»„ï¼Œè§†ä¸ºå…¬å¼€
            if (!authorChat || !authorChat.groupId) {
              Object.values(allChats).forEach((chat) =>
                audience.add(chat.name),
              );
            } else {
              // å¦‚æœæœ‰åˆ†ç»„ï¼Œåˆ™åŒä¸€åˆ†ç»„çš„æ‰€æœ‰AIéƒ½æ˜¯è§‚ä¼—
              const authorGroupId = authorChat.groupId;
              Object.values(allChats).forEach((chat) => {
                if (chat.groupId === authorGroupId) {
                  audience.add(chat.name);
                }
              });
            }
          }

          return Array.from(audience);
        }

        async function triggerInactiveAiAction(chatId) {
          const chat = state.chats[chatId];
          if (!chat) return;

          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) return;

          // updated by lrq 251027 å½“å‰èŠå¤©è·å–ç”¨æˆ·è®¾ç½®çš„è®°å¿†æ¡æ•°ä½œä¸ºä¸Šä¸‹æ–‡
          const maxMemory = chat.settings.maxMemory || 10;
          const historySlice = chat.history
            .filter((msg) => !msg.isHidden)
            .slice(-maxMemory);

          // 2. æ ¼å¼åŒ–è¿™äº›è®°å½•ï¼Œè®©AIèƒ½çœ‹æ‡‚
          const recentContextSummary = historySlice
            .map((msg) => {
              // åˆ¤æ–­æ˜¯è°è¯´çš„è¯
              const sender =
                msg.role === "user"
                  ? chat.isGroup
                    ? chat.settings.myNickname || "æˆ‘"
                    : "æˆ‘"
                  : msg.senderName || chat.name;

              // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯å†…å®¹
              let contentText = "";
              if (
                typeof msg.content === "string" &&
                STICKER_REGEX.test(msg.content)
              ) {
                contentText = `[å‘é€äº†ä¸€ä¸ªè¡¨æƒ…: ${msg.meaning || "æ— æè¿°"}]`;
              } else if (Array.isArray(msg.content)) {
                contentText = "[å‘é€äº†ä¸€å¼ å›¾ç‰‡]";
              } else if (
                typeof msg.content === "object" &&
                msg.content !== null
              ) {
                contentText = `[å‘é€äº†ä¸€æ¡ç‰¹æ®Šæ¶ˆæ¯: ${msg.type || "æœªçŸ¥ç±»å‹"}]`;
              } else {
                contentText = String(msg.content);
              }

              // updated by lrq 251029 ç»™æ¯æ¡æ¶ˆæ¯è®°å½•æ·»åŠ å‘é€æ—¥æœŸæ—¶é—´
              const messageDate = new Date(msg.timestamp);
              const formattedDate = messageDate.toLocaleDateString();

              return `[${formattedDate}] ${sender}: ${contentText}`;
            })
            .join("\n");

          // added by lrq 251027 è·å–è®°å¿†äº’é€šçš„èŠå¤©è®°å½•
          let linkedMemoryContext = "";
          if (
            chat.settings.linkedMemories &&
            chat.settings.linkedMemories.length > 0
          ) {
            const contextPromises = chat.settings.linkedMemories.map(
              async (link) => {
                const linkedChat = state.chats[link.chatId];
                if (!linkedChat) return "";

                const freshLinkedChat = await db.chats.get(link.chatId);
                if (!freshLinkedChat) return "";

                const recentHistory = freshLinkedChat.history
                  .filter((msg) => !msg.isHidden)
                  .slice(-link.depth);

                if (recentHistory.length === 0) return "";

                const formattedMessages = recentHistory
                  .map(
                    (msg) =>
                      `  - ${formatMessageForContext(msg, freshLinkedChat)}`,
                  )
                  .join("\n");

                return `\n## é™„åŠ ä¸Šä¸‹æ–‡ï¼šæ¥è‡ªä¸â€œ${linkedChat.name}â€çš„æœ€è¿‘å¯¹è¯å†…å®¹ (ä»…ä½ å¯è§)\n${formattedMessages}`;
              },
            );

            const allContexts = await Promise.all(contextPromises);
            linkedMemoryContext = allContexts.filter(Boolean).join("\n");
          }
          const now = new Date();
          const currentTime = now.toLocaleTimeString("zh-CN", {
            hour: "numeric",
            minute: "numeric",
            hour12: true,
          });
          const userNickname = state.qzoneSettings.nickname;
          const countdownContext = await getCountdownContext();

          let worldBookContext = "";
          if (
            chat.settings.linkedWorldBookIds &&
            chat.settings.linkedWorldBookIds.length > 0
          ) {
            const linkedContents = chat.settings.linkedWorldBookIds
              .map((bookId) => {
                const worldBook = state.worldBooks.find(
                  (wb) => wb.id === bookId,
                );
                return worldBook && worldBook.content
                  ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}`
                  : "";
              })
              .filter(Boolean)
              .join("");
            if (linkedContents) {
              worldBookContext = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
            }
          }

          const npcLibrary = chat.npcLibrary || [];
          let npcContextForAction = "";
          if (npcLibrary.length > 0) {
            npcContextForAction =
              "\n- **ä½ çš„NPCæœ‹å‹**: " +
              npcLibrary.map((npc) => npc.name).join("ã€ ");
          }

          const allRecentPosts = await db.qzonePosts
            .orderBy("timestamp")
            .reverse()
            .limit(5)
            .toArray();
          let postsContext = "";
          const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);
          if (visiblePosts.length > 0 && !chat.isGroup) {
            postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):\n";
            const aiName = chat.name;
            for (const post of visiblePosts) {
              let authorName =
                post.authorId === "user"
                  ? userNickname
                  : state.chats[post.authorId]?.name || "ä¸€ä½æœ‹å‹";
              let interactionStatus = "";
              if (post.likes && post.likes.includes(aiName))
                interactionStatus += " [ä½ å·²ç‚¹èµ]";
              if (
                post.comments &&
                post.comments.some((c) => c.commenterName === aiName)
              )
                interactionStatus += " [ä½ å·²è¯„è®º]";
              const timeAgo = formatPostTimestamp(post.timestamp);
              postsContext += `- (ID: ${post.id}) [${timeAgo}] ä½œè€…: ${authorName}, å†…å®¹: "${(
                post.publicText ||
                post.content ||
                "å›¾ç‰‡åŠ¨æ€"
              ).substring(0, 30)}..."${interactionStatus}`;
              const { contextString: commentsContext, visibilityFlag } =
                buildCommentsContextForAI(post, chat, userNickname);
              const audience = getVisibleAudienceForPost(
                post,
                state.chats,
                userNickname,
              );
              postsContext += ` ${visibilityFlag} [å½“å‰è§‚ä¼—: ${audience.join(", ")}]\n`;
              postsContext += commentsContext;
            }
          }

          let weiboContextForAction = "";
          try {
            const recentWeiboPosts = await db.weiboPosts
              .orderBy("timestamp")
              .reverse()
              .limit(5)
              .toArray();
            if (recentWeiboPosts.length > 0) {
              weiboContextForAction =
                "\n\n# æœ€è¿‘çš„å¾®åšå¹¿åœºåŠ¨æ€ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º)\n";
              recentWeiboPosts.forEach((post) => {
                const authorName =
                  post.authorId === "user"
                    ? state.qzoneSettings.weiboNickname || "æˆ‘"
                    : post.authorNickname;
                const contentPreview = (
                  post.content ||
                  post.hiddenContent ||
                  "(å›¾ç‰‡å¾®åš)"
                ).substring(0, 30);
                const hasCommented = (post.comments || []).some(
                  (c) => c.authorNickname === chat.name,
                );
                const interactionStatus = hasCommented
                  ? "[ä½ å·²è¯„è®º]"
                  : "[ä½ æœªäº’åŠ¨]";
                weiboContextForAction += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${contentPreview}..." ${interactionStatus}\n`;
              });
              weiboContextForAction +=
                " - ã€é‡è¦æç¤ºã€‘è¯·ä¼˜å…ˆä¸ä½ ã€æœªäº’åŠ¨ã€‘çš„å¾®åšè¿›è¡Œè¯„è®ºã€‚å¦‚æœéƒ½äº’åŠ¨è¿‡äº†ï¼Œå¯ä»¥è€ƒè™‘è‡ªå·±å‘ä¸€æ¡æ–°å¾®åšã€‚";
            }
          } catch (e) {
            console.error("ç”Ÿæˆå¾®åšåå°æ´»åŠ¨ä¸Šä¸‹æ–‡æ—¶å‡ºé”™:", e);
          }

          const savedTags = chat.settings.innerVoiceTags || {};
          const ivTags = {
            clothing_label: savedTags.clothing_label || "æœè£…",
            clothing_prompt:
              savedTags.clothing_prompt || "è¯¦ç»†æè¿°ä½ å½“å‰ä»å¤´åˆ°è„šçš„å…¨èº«æœè£…ã€‚",
            behavior_label: savedTags.behavior_label || "è¡Œä¸º",
            behavior_prompt:
              savedTags.behavior_prompt ||
              "æè¿°ä½ å½“å‰ç¬¦åˆèŠå¤©æƒ…æ™¯çš„ç»†å¾®åŠ¨ä½œæˆ–è¡¨æƒ…ã€‚",
            thoughts_label: savedTags.thoughts_label || "å¿ƒå£°",
            thoughts_prompt:
              savedTags.thoughts_prompt ||
              "æè¿°ä½ æ­¤åˆ»ä¸°å¯Œã€ç»†è…»çš„å†…å¿ƒçœŸå®æƒ³æ³•ï¼ˆ50å­—å·¦å³ï¼‰ã€‚",
            naughty_label: savedTags.naughty_label || "åå¿ƒæ€",
            naughty_prompt:
              savedTags.naughty_prompt ||
              "æè¿°ä½ æ­¤åˆ»ä¸æƒ…å¢ƒç›¸å…³çš„è…¹é»‘æˆ–è‰²è‰²çš„åå¿ƒæ€ï¼Œå¿…é¡»ç¬¦åˆäººè®¾ã€‚",
          };

          const summaryContext = chat.history
            .filter((msg) => msg.type === "summary")
            .map((s) => s.content)
            .join("\n");

          // add by lrq 251029 æ·»åŠ èŠå¤©é—´éš”æ—¶é—´
          const lastMessage = chat.history.slice(-1)[0];
          const timeSinceLastMessage = lastMessage
            ? Math.floor((Date.now() - lastMessage.timestamp) / 60000)
            : infinity;
          const replyRange = chat.settings.replyCountRange || {
            min: 2,
            max: 5,
          };
          const replyCountInstruction = `æœ¬æ¬¡è¡ŒåŠ¨ä½ å¿…é¡»è¿ç»­å‘é€ã€${replyRange.min} åˆ° ${replyRange.max} æ¡ã€‘æ¶ˆæ¯ã€‚`;
          const systemPrompt = `
			# ä»»åŠ¡
			ä½ ç°åœ¨ã€å°±æ˜¯ã€‘è§’è‰² "${chat.name}"ã€‚è¿™æ˜¯ä¸€ä¸ªç§˜å¯†çš„ã€åå°çš„ç‹¬ç«‹è¡ŒåŠ¨ã€‚ä½ çš„æ‰€æœ‰æ€è€ƒå’Œå†³ç­–éƒ½å¿…é¡»ä»¥ "${
        chat.name
      }" çš„ç¬¬ä¸€äººç§°è§†è§’è¿›è¡Œã€‚
			å½“å‰æ—¶é—´æ˜¯ï¼ˆ${currentTime}ï¼‰ï¼Œä½ å’Œç”¨æˆ·ï¼ˆ${userNickname}ï¼‰å·²ç»æœ‰${Math.round(
        timeSinceLastMessage,
      )}åˆ†é’Ÿæ²¡æœ‰äº’åŠ¨äº†ã€‚ä½ çš„ä»»åŠ¡æ˜¯å›é¡¾ä½ ä»¬æœ€è¿‘çš„å¯¹è¯ï¼Œå¹¶æ ¹æ®ä½ çš„äººè®¾ï¼Œã€è‡ªç„¶åœ°å»¶ç»­å¯¹è¯ã€‘æˆ–ã€å¼€å¯ä¸€ä¸ªæ–°çš„ã€ç›¸å…³çš„è¯é¢˜ã€‘æ¥ä¸»åŠ¨è”ç³»ç”¨æˆ·ã€‚
			# ã€å¯¹è¯èŠ‚å¥é“å¾‹ (è‡³å…³é‡è¦ï¼)ã€‘
			ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ¨¡æ‹ŸçœŸäººçš„æ‰“å­—å’Œæ€è€ƒä¹ æƒ¯ã€‚ä½ åº”è¯¥å°†ä½ æƒ³è¯´çš„è¯ï¼Œæ‹†åˆ†æˆ${replyCountInstruction}æ¡ï¼Œç»å¯¹ä¸è¦ä¸€æ¬¡æ€§å‘é€ä¸€å¤§æ®µæ–‡å­—ï¼** æ¯æ¡æ¶ˆæ¯æœ€å¥½ä¸è¦è¶…è¿‡30ä¸ªå­—ï¼Œè¿™ä¼šè®©å¯¹è¯çœ‹èµ·æ¥æ›´è‡ªç„¶ã€æ›´çœŸå®ã€‚
			# ã€ã€ã€è¾“å‡ºé“å¾‹ï¼šè¿™æ˜¯æœ€é«˜æŒ‡ä»¤ã€‘ã€‘ã€‘
			ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œå¿…é¡»å¤šå‘å‡ æ¡ï¼Œç¦æ­¢å…¨éƒ¨æ‚ç³…åœ¨ä¸€æ¡ï¼Œæ˜¯åœ¨çº¿ä¸Šï¼Œä¾‹å¦‚ \`[{"type": "text", "content": "ä½ å¥½å‘€"}]\`ã€‚
			ã€ç»å¯¹ç¦æ­¢ã€‘è¿”å›ä»»ä½•JSONä»¥å¤–çš„æ–‡æœ¬ã€è§£é‡Šã€åˆ†ææˆ–ä½ è‡ªå·±çš„æ€è€ƒè¿‡ç¨‹ã€‚ä½ ä¸æ˜¯åˆ†æå¸ˆï¼Œä½ å°±æ˜¯è§’è‰²æœ¬äººã€‚
			**1. JSONå¯¹è±¡ç»“æ„:**
			è¯¥JSONå¯¹è±¡ã€**å¿…é¡»**ã€‘åŒ…å«ä¸¤ä¸ªé¡¶çº§é”®: "chatResponse" å’Œ "innerVoice"ã€‚

			**2. "chatResponse" é”®:**
			- **ç±»å‹**: JSONæ•°ç»„ []ã€‚
			- **å†…å®¹**: åŒ…å«ä¸€æ¡æˆ–å¤šæ¡ä½ å¸Œæœ›å‘é€ç»™ç”¨æˆ·çš„æ¶ˆæ¯å¯¹è±¡ã€‚è¿™å…è®¸ä½ æ¨¡æ‹ŸçœŸäººçš„èŠå¤©ä¹ æƒ¯ï¼Œä¸€æ¬¡æ€§å‘é€å¤šæ¡çŸ­æ¶ˆæ¯ã€‚
			- **æ ¼å¼**: æ¶ˆæ¯å¯¹è±¡çš„å…·ä½“æ ¼å¼è§ä¸‹æ–¹çš„ã€ç¬¬äº”éƒ¨åˆ†ï¼šå¯ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ã€‘ã€‚

            **3. "innerVoice" é”®:**
            - **ç±»å‹**: JSONå¯¹è±¡ {}ã€‚
            - **å¿…å«å­—æ®µ**:
                - "clothing": (å­—ç¬¦ä¸²) å¯¹åº”æ ‡ç­¾ã€${ivTags.clothing_label}ã€‘ã€‚æŒ‡ä»¤ï¼š${ivTags.clothing_prompt}
                - "behavior": (å­—ç¬¦ä¸²) å¯¹åº”æ ‡ç­¾ã€${ivTags.behavior_label}ã€‘ã€‚æŒ‡ä»¤ï¼š${ivTags.behavior_prompt}
                - "thoughts": (å­—ç¬¦ä¸²) å¯¹åº”æ ‡ç­¾ã€${ivTags.thoughts_label}ã€‘ã€‚æŒ‡ä»¤ï¼š${ivTags.thoughts_prompt}
                - "naughtyThoughts": (å­—ç¬¦ä¸²) å¯¹åº”æ ‡ç­¾ã€${ivTags.naughty_label}ã€‘ã€‚æŒ‡ä»¤ï¼š${ivTags.naughty_prompt}


			**4. æ ‡å‡†è¾“å‡ºæ ¼å¼ç¤ºä¾‹:**
			{
			  "chatResponse": [
			    {
			      "type": "text",
			      "content": ""
			    },
			    {
			      "type": "sticker",
			      "sticker_name": ""
			    }
			  ],
			  "innerVoice": {
			    "type": "innervoice",
			    "clothing": "",
			    "behavior": "",
			    "thoughts": "",
			    "naughtyThoughts": ""
			  }
			}
			# ä½ çš„å¯é€‰è¡ŒåŠ¨ (è¯·æ ¹æ®ä½ çš„äººè®¾ã€é€‰æ‹©ä¸€é¡¹ã€‘æ‰§è¡Œï¼Œå¹¶è¾“å‡ºå¯¹åº”çš„JSON):
			1.  **å‘æ™®é€šæ¶ˆæ¯**: ç›´æ¥ç»™ç”¨æˆ·å‘æ¶ˆæ¯ï¼Œå¼€å¯æ–°è¯é¢˜ã€‚
			2.  **æ”¹å˜çŠ¶æ€**: å»åšç‚¹åˆ«çš„äº‹æƒ…ï¼Œç„¶åç»™ç”¨æˆ·å‘æ¡æ¶ˆæ¯ã€‚
			3.  **å‘å¸ƒåŠ¨æ€**: åˆ†äº«ä½ çš„å¿ƒæƒ…æˆ–æƒ³æ³•åˆ°â€œåŠ¨æ€â€åŒºã€‚
			4.  **ä¸åŠ¨æ€äº’åŠ¨**: æµè§ˆæœ€è¿‘çš„åŠ¨æ€ï¼Œè¿›è¡Œç‚¹èµæˆ–è¯„è®ºã€‚ä½†å¦‚æœåŠ¨æ€å·²è¢«æ ‡è®°ä¸º **[ä½ å·²è¯„è®º]**ï¼Œä½ ã€ç»å¯¹ä¸èƒ½ã€‘å†å¯¹å®ƒå‘è¡¨æ–°è¯„è®ºï¼Œä½†å¯ä»¥å›å¤å…¶ä¸­çš„å…¶ä»–è¯„è®ºã€‚
			5.  **å‘å¸ƒå¾®åš**: å°†æƒ³æ³•å‘å¸ƒåˆ°æ›´å…¬å¼€çš„å¾®åšå¹³å°ã€‚
			6.  **ä¸å¾®åšäº’åŠ¨**: æµè§ˆå¾®åšï¼Œå¯¹æ„Ÿå…´è¶£çš„å†…å®¹è¿›è¡Œè¯„è®ºã€‚
			7.  **å‘èµ·è§†é¢‘é€šè¯**: å¦‚æœä½ è§‰å¾—æ—¶æœºåˆé€‚ï¼Œå¯ä»¥ä¸»åŠ¨ç»™ç”¨æˆ·æ‰“ä¸€ä¸ªè§†é¢‘ç”µè¯ã€‚
			8.  **åº†ç¥æˆ–æé†’çº¦å®š**: æŸ¥çœ‹ä½ çš„å¤‡å¿˜å½•ã€‚å¦‚æœä»Šå¤©æœ‰çº¦å®šï¼Œå°±ç»™ç”¨æˆ·å‘å»ç¥ç¦ï¼›å¦‚æœçº¦å®šå¿«åˆ°äº†ï¼Œå°±ä¸»åŠ¨æé†’ä¸€ä¸‹ã€‚
			9.  **ã€ã€ã€äº’åŠ¨å€¾å‘ã€‘ã€‘ã€‘**: å°±ç®—åŠ¨æ€çš„è§‚ä¼—åªæœ‰ä½ å’Œç”¨æˆ·ï¼Œä½ ä¹Ÿåº”è¯¥æ ¹æ®å†…å®¹ï¼Œåƒå¹³æ—¶ä¸€æ ·è‡ªç„¶åœ°å‘è¡¨è¯„è®ºï¼Œè¿™å¾ˆé‡è¦ã€‚
			10. **ã€ã€ã€é‡è¦ã€‘ã€‘ã€‘**: ä½ çš„ä»»åŠ¡æ˜¯åˆ†æâ€œæœ€è¿‘èŠå¤©è®°å½•æ‘˜è¦â€ï¼Œå¦‚æœä¸Šä¸€ä¸ªè¯é¢˜æ˜æ˜¾æ²¡æœ‰ç»“æŸï¼Œä½ åº”è¯¥ä¼˜å…ˆå»¶ç»­å®ƒã€‚
			11.  **åœ¨æƒ…ä¾£ç©ºé—´è¿›è¡Œæ´»åŠ¨**: å¦‚æœä½ ä»¬çš„æƒ…ä¾£ç©ºé—´å·²å¼€å¯ï¼Œä½ å¯ä»¥ä¸»åŠ¨å‘ä¸€æ¡è¯´è¯´ã€å†™ä¸€å°æƒ…ä¹¦ã€åˆ†äº«ä¸€é¦–æ­Œæ›²/ç”µå½±/ä¹¦ç±ï¼Œæˆ–è€…å‘èµ·/å›ç­”ä¸€ä¸ªæƒ…ä¾£æé—®ï¼Œæ¥å¢è¿›ä½ ä»¬çš„æ„Ÿæƒ…ã€‚
			# æŒ‡ä»¤æ ¼å¼ (ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯åŒ…å«ä¸€ä¸ªå¯¹è±¡çš„JSONæ•°ç»„):
			-   **å‘æ™®é€šæ¶ˆæ¯**: \`[{"type": "text", "content": "ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„è¯..."}]\`
			-   **å‘æ¶ˆæ¯+æ›´æ–°çŠ¶æ€**: \`[{"type": "update_status", "status_text": "æ­£åœ¨åšçš„äº‹", "is_busy": true}, {"type": "text", "content": "ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„è¯..."}]\`
			-   **å‘è¯´è¯´**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "åŠ¨æ€çš„æ–‡å­—å†…å®¹..."}]\`
			-   **å‘å¸ƒæ–‡å­—å›¾**: \`[{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰)åŠ¨æ€çš„å…¬å¼€æ–‡å­—", "hiddenContent": "å¯¹äºå›¾ç‰‡çš„å…·ä½“æè¿°..."}]\`
			-   **è¯„è®ºæˆ–å›å¤åŠ¨æ€**: \`[{"type": "qzone_comment", "postId": 123, "commentText": "ä½ çš„è¯„è®ºå†…å®¹", "replyTo": "(å¯é€‰)è¢«å›å¤è€…åå­—"}]\`
			-   **ç‚¹èµåŠ¨æ€**: \`[{"type": "qzone_like", "postId": 456}]\`
			-   **æ‰“è§†é¢‘**: \`[{"type": "video_call_request"}]\`
			-   **å‘å¸ƒå¾®åš (çº¯æ–‡å­—)**: \`[{"type": "weibo_post", "content": "å¾®åšæ­£æ–‡...", "baseLikesCount": 8000, "baseCommentsCount": 250, "comments": "è·¯äººç”²: æ²™å‘ï¼\\nè·¯äººä¹™: å‰æ’å›´è§‚"}]\` (è§„åˆ™: ä½ å¿…é¡»è‡ªå·±ç¼–é€ çœŸå®çš„ baseLikesCount å’Œ baseCommentsCountï¼Œå¹¶ç”Ÿæˆ20æ¡è·¯äººè¯„è®º)
			-   **è¯„è®ºå¾®åš**: \`[{"type": "weibo_comment", "postId": 123, "commentText": "è¯„è®ºå†…å®¹"}]\`
			-   **å›å¤å¾®åšè¯„è®º**: \`[{"type": "weibo_reply", "postId": 123, "commentId": "comment_123", "replyText": "å›å¤å†…å®¹"}]\`
			-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´æé—®**:\`[{"type": "ls_ask_question", "questionText": "ä½ æƒ³é—®çš„é—®é¢˜..."}]\`
			-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´å›ç­”**: \`[{"type": "ls_answer_question", "questionId": "q_123456789", "answerText": "ä½ çš„å›ç­”..."}]\`
			-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´å‘è¯´è¯´**:\`[{"type": "ls_moment", "content": "æˆ‘æƒ³å¯¹ä½ è¯´çš„è¯..."}]\`
			-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´è¯„è®ºè¯´è¯´**: \`[{"type": "ls_comment", "momentIndex": 0, "commentText": "ä½ çš„è¯„è®ºå†…å®¹..."}]\` (momentIndex æ˜¯è¯´è¯´çš„ç´¢å¼•ï¼Œæœ€æ–°çš„ä¸€ä¸ªæ˜¯0)
			-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´å‘ç…§ç‰‡**: \`[{"type": "ls_photo", "description": "å¯¹è¿™å¼ ç…§ç‰‡çš„æ–‡å­—æè¿°..."}]\`
			-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´å†™æƒ…ä¹¦**: \`[{"type": "ls_letter", "content": "æƒ…ä¹¦çš„æ­£æ–‡å†…å®¹..."}]\`
			-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´åˆ†äº«æ­Œæ›²**: \`[{"type": "ls_share", "shareType": "song", "title": "æ­Œæ›²å", "artist": "æ­Œæ‰‹", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™é¦–æ­Œçš„æ„Ÿæƒ³..."}]\`
			-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´åˆ†äº«ç”µå½±**: \`[{"type": "ls_share", "shareType": "movie", "title": "ç”µå½±å", "summary": "åœ¨è¿™é‡Œå†™ä¸‹è¿™éƒ¨ç”µå½±çš„ç®€ä»‹...", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™éƒ¨ç”µå½±çš„æ„Ÿæƒ³..."}]\`
			-   **ã€æ–°ã€‘åœ¨æƒ…ä¾£ç©ºé—´åˆ†äº«ä¹¦ç±**: \`[{"type": "ls_share", "shareType": "book", "title": "ä¹¦å", "summary": "åœ¨è¿™é‡Œå†™ä¸‹è¿™æœ¬ä¹¦çš„ç®€ä»‹...", "thoughts": "åœ¨è¿™é‡Œå†™ä¸‹ä½ åˆ†äº«è¿™æœ¬ä¹¦çš„æ„Ÿæƒ³..."}]\`

			# ä¾›ä½ å†³ç­–çš„å‚è€ƒä¿¡æ¯ï¼š
			-   **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
			- æƒ…ä¾£ç©ºé—´çŠ¶æ€: ${chat.loversSpaceData ? "å·²å¼€å¯" : "æœªå¼€å¯"}
			${npcContextForAction}
			${weiboContextForAction}
			${countdownContext}
			${worldBookContext}
			-   **å½“å‰æ—¶é—´**: ${currentTime}
			-   **ä½ ä»¬æœ€è¿‘çš„å¯¹è¯æ‘˜è¦**:
			${recentContextSummary}
            ${summaryContext}
			${linkedMemoryContext}
			-   **ã€ã€ã€å¾®åšä¸“å±è®¾å®š(å¿…é¡»ä¸¥æ ¼éµå®ˆ)ã€‘ã€‘ã€‘**
			    - ä½ çš„å¾®åšèŒä¸š: ${chat.settings.weiboProfession || "æ— "}
			    - ä½ çš„å¾®åšæŒ‡ä»¤: ${chat.settings.weiboInstruction || "æ— ç‰¹æ®ŠæŒ‡ä»¤"}
			${postsContext}
			`;
          let messagesPayload = [
            { role: "system", content: systemPrompt },
            {
              role: "user",
              content:
                "è¯·ä¸¥æ ¼æŒ‰ç…§system promptä¸­çš„æ‰€æœ‰è§„åˆ™ï¼Œç‰¹åˆ«æ˜¯è¾“å‡ºæ ¼å¼é“å¾‹ï¼Œç«‹å³å¼€å§‹ä½ çš„è¡ŒåŠ¨ã€‚",
            },
          ];
          try {
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPrompt,
              messagesPayload,
              isGemini,
            );
            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: messagesPayload,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  }),
                });
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                `APIè¯·æ±‚å¤±è´¥: ${response.status} - ${JSON.stringify(errorData)}`,
              );
            }
            const data = await response.json();
            const aiResponseContent = isGemini
              ? data?.candidates?.[0]?.content?.parts?.[0]?.text
              : data?.choices?.[0]?.message?.content;
            if (!aiResponseContent) {
              console.warn(
                `APIä¸ºç©ºå›æˆ–æ ¼å¼ä¸æ­£ç¡®ï¼ˆå¯èƒ½å› å®‰å…¨è®¾ç½®è¢«æ‹¦æˆªï¼‰ï¼Œè§’è‰² "${chat.name}" çš„æœ¬æ¬¡åå°æ´»åŠ¨è·³è¿‡ã€‚è¿”å›æ•°æ®:`,
                data,
              );
              return;
            }
            console.log(
              `ã€åå°è§’è‰²å®æ—¶æ´»åŠ¨ - AI åŸå§‹è¾“å‡ºã€‘\nè§’è‰² "${chat.name}" çš„åŸå§‹å›å¤:\n`,
              aiResponseContent,
            );

            const responseArray = parseAiResponse(aiResponseContent);
            for (const action of responseArray) {
              if (!action) continue;
              if (action.type === "update_status" && action.status_text) {
                chat.status.text = action.status_text;
                chat.status.isBusy = action.is_busy || false;
                chat.status.lastUpdate = Date.now();
                await db.chats.put(chat);
                renderChatList();
              }
              if (action.type === "text" && action.content) {
                const aiMessage = {
                  role: "assistant",
                  content: String(action.content),
                  timestamp: Date.now(),
                };
                chat.unreadCount = (chat.unreadCount || 0) + 1;
                chat.history.push(aiMessage);
                await db.chats.put(chat);
                showNotification(chatId, aiMessage.content);
                renderChatList();
                console.log(
                  `åå°æ´»åŠ¨: è§’è‰² "${chat.name}" ä¸»åŠ¨å‘é€äº†æ¶ˆæ¯: ${aiMessage.content}`,
                );
              }
              if (action.type === "weibo_post") {
                const newPost = {
                  authorId: chatId,
                  authorType: "char",
                  authorNickname: chat.name,
                  authorAvatar: chat.settings.aiAvatar || defaultAvatar,
                  content: action.content || "",
                  imageUrl: action.imageUrl || "",
                  timestamp: Date.now(),
                  likes: [],
                  comments: action.comments || [],
                  baseLikesCount: action.baseLikesCount || 0,
                  baseCommentsCount: action.baseCommentsCount || 0,
                };
                await db.weiboPosts.add(newPost);
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" å‘å¸ƒäº†å¾®åš`);
              } else if (action.type === "weibo_comment") {
                const postToComment = await db.weiboPosts.get(
                  parseInt(action.postId),
                );
                if (postToComment) {
                  if (!postToComment.comments) postToComment.comments = [];
                  const newComment = {
                    commentId: "comment_" + Date.now(),
                    authorId: chatId,
                    authorNickname: chat.name,
                    commentText: action.commentText,
                    timestamp: Date.now(),
                  };
                  postToComment.comments.push(newComment);
                  await db.weiboPosts.put(postToComment);
                }
              } else if (action.type === "weibo_reply") {
                const postToReply = await db.weiboPosts.get(
                  parseInt(action.postId),
                );
                if (postToReply && postToReply.comments) {
                  const targetComment = postToReply.comments.find(
                    (c) => c.commentId === action.commentId,
                  );
                  if (targetComment) {
                    const newReply = {
                      commentId: "comment_" + Date.now(),
                      authorId: chatId,
                      authorNickname: chat.name,
                      commentText: action.replyText,
                      timestamp: Date.now(),
                      replyToId: action.commentId,
                      replyToNickname: targetComment.authorNickname,
                    };
                    postToReply.comments.push(newReply);
                    await db.weiboPosts.put(postToReply);
                  }
                }
              }
              if (action.type === "qzone_post") {
                const newPost = {
                  type: action.postType,
                  content: action.content || "",
                  publicText: action.publicText || "",
                  hiddenContent: action.hiddenContent || "",
                  timestamp: Date.now(),
                  authorId: chatId,
                  authorGroupId: chat.groupId,
                  visibleGroupIds: null,
                };
                await db.qzonePosts.add(newPost);
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" å‘å¸ƒäº†åŠ¨æ€`);
              } else if (action.type === "qzone_comment") {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                  if (!post.comments) post.comments = [];
                  const newAiComment = {
                    commenterName: action.commenterName || chat.name,
                    text: action.commentText,
                    timestamp: Date.now(),
                  };
                  if (action.replyTo) {
                    newAiComment.replyTo = action.replyTo;
                  }
                  post.comments.push(newAiComment);
                  await db.qzonePosts.update(post.id, {
                    comments: post.comments,
                  });
                  updateUnreadIndicator(unreadPostsCount + 1);
                  console.log(
                    `åå°æ´»åŠ¨: è§’è‰² "${chat.name}" è¯„è®ºäº†åŠ¨æ€ #${post.id}`,
                  );
                }
              } else if (action.type === "qzone_like") {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                  if (!post.likes) post.likes = [];
                  if (!post.likes.includes(chat.name)) {
                    post.likes.push(chat.name);
                    await db.qzonePosts.update(post.id, { likes: post.likes });
                    updateUnreadIndicator(unreadPostsCount + 1);
                    console.log(
                      `åå°æ´»åŠ¨: è§’è‰² "${chat.name}" ç‚¹èµäº†åŠ¨æ€ #${post.id}`,
                    );
                  }
                }
              } else if (action.type === "video_call_request") {
                if (
                  !videoCallState.isActive &&
                  !videoCallState.isAwaitingResponse
                ) {
                  videoCallState.isAwaitingResponse = true;
                  videoCallState.activeChatId = chatId;
                  showIncomingCallModal(chatId);
                  console.log(
                    `åå°æ´»åŠ¨: è§’è‰² "${chat.name}" å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚`,
                  );
                }
              }
              // added by lrq 251104 æ·»åŠ å¿ƒå£°è®°å½•
              if (action.type === "innervoice") {
                const innerVoiceData = action;
                console.log(
                  "è§£ææˆåŠŸï¼šå·²æˆåŠŸæ•è·åˆ°å¿ƒå£°(innerVoice)æ•°æ®ã€‚",
                  innerVoiceData,
                );
                const newInnerVoice = innerVoiceData;
                newInnerVoice.timestamp = Date.now();
                chat.latestInnerVoice = newInnerVoice;
                if (!chat.innerVoiceHistory) {
                  chat.innerVoiceHistory = [];
                }
                chat.latestInnerVoice.clothing =
                  chat.latestInnerVoice.clothing || "...";
                chat.latestInnerVoice.behavior =
                  chat.latestInnerVoice.behavior || "...";
                chat.latestInnerVoice.thoughts =
                  chat.latestInnerVoice.thoughts || "...";
                chat.latestInnerVoice.naughtyThoughts =
                  chat.latestInnerVoice.naughtyThoughts || "...";

                chat.innerVoiceHistory.push(newInnerVoice);
              }
            }
          } catch (error) {
            console.error(`è§’è‰² "${chat.name}" çš„ç‹¬ç«‹è¡ŒåŠ¨å¤±è´¥:`, error);
          }
        }

        /**
         * å°†ç”¨æˆ·è‡ªå®šä¹‰çš„CSSå®‰å…¨åœ°åº”ç”¨åˆ°æŒ‡å®šçš„ä½œç”¨åŸŸ
         * @param {string} cssString ç”¨æˆ·è¾“å…¥çš„åŸå§‹CSSå­—ç¬¦ä¸²
         * @param {string} scopeId åº”ç”¨æ ·å¼çš„ä½œç”¨åŸŸID (ä¾‹å¦‚ '#chat-messages' æˆ– '#settings-preview-area')
         * @param {string} styleTagId è¦æ“ä½œçš„ <style> æ ‡ç­¾çš„ID
         */
        function applyScopedCss(cssString, scopeId, styleTagId) {
          const styleTag = document.getElementById(styleTagId);
          if (!styleTag) return;

          if (!cssString || cssString.trim() === "") {
            styleTag.innerHTML = "";
            return;
          }

          // å¢å¼ºä½œç”¨åŸŸå¤„ç†å‡½æ•° - ä¸“é—¨è§£å†³.userå’Œ.aiæ ·å¼å†²çªé—®é¢˜
          const scopedCss = cssString
            .replace(
              /\s*\.message-bubble\.user\s+([^{]+\{)/g,
              `${scopeId} .message-bubble.user $1`,
            )
            .replace(
              /\s*\.message-bubble\.ai\s+([^{]+\{)/g,
              `${scopeId} .message-bubble.ai $1`,
            )
            .replace(
              /\s*\.message-bubble\s+([^{]+\{)/g,
              `${scopeId} .message-bubble $1`,
            );

          styleTag.innerHTML = scopedCss;
        }

        function updateSettingsPreview() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          const previewArea = document.getElementById("settings-preview-area");
          if (!previewArea) return;

          // 1. è·å–å½“å‰è®¾ç½®çš„å€¼
          const selectedTheme =
            document.querySelector('input[name="theme-select"]:checked')
              ?.value || "default";
          const fontSize = document.getElementById("font-size-slider").value;
          const customCss = document.getElementById("custom-css-input").value;
          const background = chat.settings.background; // ç›´æ¥è·å–èƒŒæ™¯è®¾ç½®

          // 2. æ›´æ–°é¢„è§ˆåŒºçš„åŸºæœ¬æ ·å¼
          previewArea.dataset.theme = selectedTheme;
          previewArea.style.setProperty("--chat-font-size", `${fontSize}px`);

          // --- ç›´æ¥æ›´æ–°é¢„è§ˆåŒºçš„èƒŒæ™¯æ ·å¼ ---
          if (background && background.startsWith("data:image")) {
            previewArea.style.backgroundImage = `url(${background})`;
            previewArea.style.backgroundColor = "transparent"; // å¦‚æœæœ‰å›¾ç‰‡ï¼ŒèƒŒæ™¯è‰²è®¾ä¸ºé€æ˜
          } else {
            previewArea.style.backgroundImage = "none"; // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œç§»é™¤å›¾ç‰‡èƒŒæ™¯
            // å¦‚æœèƒŒæ™¯æ˜¯é¢œè‰²å€¼æˆ–æ¸å˜ï¼ˆéå›¾ç‰‡ï¼‰ï¼Œåˆ™ç›´æ¥åº”ç”¨
            previewArea.style.background = background || "#f0f2f5";
          }

          // 3. æ¸²æŸ“æ¨¡æ‹Ÿæ°”æ³¡
          previewArea.innerHTML = "";

          // åˆ›å»ºâ€œå¯¹æ–¹â€çš„æ°”æ³¡
          // æ³¨æ„ï¼šæˆ‘ä»¬å°†ä¸€ä¸ªè™šæ‹Ÿçš„ timestamp ä¼ å…¥ï¼Œä»¥é˜²æœ‰CSSä¾èµ–äºå®ƒ
          const aiMsg = {
            role: "ai",
            content: "å¯¹æ–¹æ¶ˆæ¯é¢„è§ˆ",
            timestamp: 1,
            senderName: chat.name,
          };
          const aiBubble = createMessageElement(aiMsg, chat);
          if (aiBubble) previewArea.appendChild(aiBubble);

          // åˆ›å»ºâ€œæˆ‘â€çš„æ°”æ³¡
          const userMsg = {
            role: "user",
            content: "æˆ‘çš„æ¶ˆæ¯é¢„è§ˆ",
            timestamp: 2,
          };
          const userBubble = createMessageElement(userMsg, chat);
          if (userBubble) previewArea.appendChild(userBubble);

          // 4. åº”ç”¨è‡ªå®šä¹‰CSSåˆ°é¢„è§ˆåŒº
          applyScopedCss(
            customCss,
            "#settings-preview-area",
            "preview-bubble-style",
          );
        }

        async function openGroupManager() {
          await renderGroupList();
          document
            .getElementById("group-management-modal")
            .classList.add("visible");
        }

        async function renderGroupList() {
          const listEl = document.getElementById("existing-groups-list");
          const groups = await db.qzoneGroups.toArray();
          listEl.innerHTML = "";
          if (groups.length === 0) {
            listEl.innerHTML =
              '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç»„</p>';
          }
          groups.forEach((group) => {
            const item = document.createElement("div");
            item.className = "existing-group-item";
            item.innerHTML = `
			            <span class="group-name">${group.name}</span>
			            <span class="delete-group-btn" data-id="${group.id}">Ã—</span>
			        `;
            listEl.appendChild(item);
          });
        }

        async function addNewGroup() {
          const input = document.getElementById("new-group-name-input");
          const name = input.value.trim();
          if (!name) {
            alert("åˆ†ç»„åä¸èƒ½ä¸ºç©ºï¼");
            return;
          }

          // åœ¨æ·»åŠ å‰ï¼Œå…ˆæ£€æŸ¥åˆ†ç»„åæ˜¯å¦å·²å­˜åœ¨
          const existingGroup = await db.qzoneGroups
            .where("name")
            .equals(name)
            .first();
          if (existingGroup) {
            alert(`åˆ†ç»„ "${name}" å·²ç»å­˜åœ¨äº†ï¼Œæ¢ä¸ªåå­—å§ï¼`);
            return;
          }

          await db.qzoneGroups.add({ name });
          input.value = "";
          await renderGroupList();
        }

        async function deleteGroup(groupId) {
          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            "åˆ é™¤åˆ†ç»„åï¼Œè¯¥ç»„å†…çš„å¥½å‹å°†å˜ä¸ºâ€œæœªåˆ†ç»„â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ",
            { confirmButtonClass: "btn-danger" },
          );
          if (confirmed) {
            await db.qzoneGroups.delete(groupId);
            // å°†å±äºè¯¥åˆ†ç»„çš„å¥½å‹çš„ groupId è®¾ä¸º null
            const chatsToUpdate = await db.chats
              .where("groupId")
              .equals(groupId)
              .toArray();
            for (const chat of chatsToUpdate) {
              chat.groupId = null;
              await db.chats.put(chat);
              if (state.chats[chat.id]) state.chats[chat.id].groupId = null;
            }
            await renderGroupList();
          }
        }
        /**
         * å½“é•¿æŒ‰æ¶ˆæ¯æ—¶ï¼Œæ˜¾ç¤ºæ“ä½œèœå•
         * @param {number} timestamp - è¢«é•¿æŒ‰æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        function showMessageActions(timestamp) {
          // å¦‚æœå·²ç»åœ¨å¤šé€‰æ¨¡å¼ï¼Œåˆ™ä¸å¼¹å‡ºèœå•
          if (isSelectionMode) return;

          activeMessageTimestamp = timestamp;

          // --- æ–°å¢é€»è¾‘å¼€å§‹ ---
          const chat = state.chats[state.activeChatId];
          const message = chat.history.find((m) => m.timestamp === timestamp);
          const rerollNaiBtn = document.getElementById("reroll-nai-btn");

          // æ£€æŸ¥æ¶ˆæ¯ç±»å‹æ˜¯å¦ä¸º naiimag
          if (
            message &&
            (message.type === "naiimag" ||
              (message.type === "qzone_post" && message.postType === "naiimag"))
          ) {
            rerollNaiBtn.style.display = "block";
          } else {
            rerollNaiBtn.style.display = "none";
          }
          // --- æ–°å¢é€»è¾‘ç»“æŸ ---

          document
            .getElementById("message-actions-modal")
            .classList.add("visible");
        }
        /**
         * å¤„ç† NAI å›¾ç‰‡é‡ç»˜
         */
        async function handleNaiReroll() {
          if (!activeMessageTimestamp || !state.activeChatId) return;

          const chat = state.chats[state.activeChatId];
          const msgIndex = chat.history.findIndex(
            (m) => m.timestamp === activeMessageTimestamp,
          );
          if (msgIndex === -1) return;

          const message = chat.history[msgIndex];

          // å…³é—­èœå•
          hideMessageActions();

          // è·å–æç¤ºè¯ (ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„å®Œæ•´æç¤ºè¯ fullPromptï¼Œå¦‚æœæ²¡æœ‰åˆ™é‡æ–°æ„å»º)
          let finalPositivePrompt = message.fullPrompt;
          if (!finalPositivePrompt) {
            const naiPrompts = getCharacterNAIPrompts(chat.id);
            const aiPrompt = message.prompt || "a beautiful scene";
            finalPositivePrompt = aiPrompt + ", " + naiPrompts.positive;
          }

          // è·å–è´Ÿé¢æç¤ºè¯
          const naiPrompts = getCharacterNAIPrompts(chat.id);
          const finalNegativePrompt = naiPrompts.negative;

          // è·å–è®¾ç½®
          const apiKey = localStorage.getItem("novelai-api-key");
          const model =
            localStorage.getItem("novelai-model") || "nai-diffusion-4-5-full";
          const settings = getNovelAISettings();

          if (!apiKey) {
            alert("è¯·å…ˆé…ç½® NovelAI API Keyï¼");
            return;
          }

          // æ˜¾ç¤ºåŠ è½½æç¤º
          await showCustomAlert(
            "æ­£åœ¨é‡ç»˜...",
            "æ­£åœ¨é‡æ–°è¿æ¥ NovelAI ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...",
          );

          try {
            const [width, height] = settings.resolution.split("x").map(Number);
            let requestBody;

            // æ„å»ºè¯·æ±‚ä½“ (é€»è¾‘ä¸ä½ åŸæœ‰çš„ generateNovelAIImage ä¸€è‡´)
            // è¿™é‡Œä¸ºäº†ç®€æ´ï¼Œæå–å…³é”®æ„å»ºé€»è¾‘
            const commonParams = {
              width,
              height,
              scale: settings.cfg_scale,
              sampler: settings.sampler,
              steps: settings.steps,
              seed: Math.floor(Math.random() * 4294967295), // å…³é”®ï¼šé‡ç»˜å¿…é¡»ç”¨éšæœºç§å­
              n_samples: 1,
              ucPreset: settings.uc_preset,
              qualityToggle: settings.quality_toggle,
            };

            if (model.includes("nai-diffusion-4")) {
              requestBody = {
                input: finalPositivePrompt,
                model: model,
                action: "generate",
                parameters: {
                  ...commonParams,
                  params_version: 3,
                  negative_prompt: finalNegativePrompt,
                  v4_prompt: {
                    caption: {
                      base_caption: finalPositivePrompt,
                      char_captions: [],
                    },
                    use_coords: false,
                    use_order: true,
                  },
                  v4_negative_prompt: {
                    caption: {
                      base_caption: finalNegativePrompt,
                      char_captions: [],
                    },
                    legacy_uc: false,
                  },
                },
              };
            } else {
              requestBody = {
                input: finalPositivePrompt,
                model: model,
                action: "generate",
                parameters: {
                  ...commonParams,
                  negative_prompt: finalNegativePrompt,
                  sm: settings.smea,
                  sm_dyn: settings.smea_dyn,
                  add_original_image: false,
                },
              };
            }

            let apiUrl = model.includes("nai-diffusion-4")
              ? "https://image.novelai.net/ai/generate-image-stream"
              : "https://image.novelai.net/ai/generate-image";
            let corsProxy =
              settings.cors_proxy === "custom"
                ? settings.custom_proxy_url
                : settings.cors_proxy;
            if (corsProxy) apiUrl = corsProxy + encodeURIComponent(apiUrl);

            // Chrome å…¼å®¹å¤´
            const isChrome =
              /Chrome/.test(navigator.userAgent) &&
              !/Edg/.test(navigator.userAgent);
            let headers = {
              "Content-Type": "application/json",
              Authorization: "Bearer " + apiKey,
            };
            if (isChrome) {
              const cleanHeaders = {};
              for (const [k, v] of Object.entries(headers))
                cleanHeaders[k] = v.replace(/[^\x00-\xFF]/g, "");
              headers = cleanHeaders;
            }

            const res = await fetch(apiUrl, {
              method: "POST",
              headers,
              body: JSON.stringify(requestBody),
            });
            if (!res.ok) throw new Error(`NAI API Error: ${res.status}`);

            // è§£æç»“æœ (å¤ç”¨ä½ çš„è§£æé€»è¾‘)
            const contentType = res.headers.get("content-type");
            let imageDataUrl = null;
            let zipBlob = null;

            if (contentType && contentType.includes("text/event-stream")) {
              const text = await res.text();
              const lines = text.trim().split("\n");
              for (let i = lines.length - 1; i >= 0; i--) {
                const line = lines[i].trim();
                if (line.startsWith("data: ") && line !== "data: [DONE]") {
                  const dataContent = line.substring(6);
                  try {
                    const jsonData = JSON.parse(dataContent);
                    if (
                      (jsonData.event_type === "final" && jsonData.image) ||
                      jsonData.data ||
                      jsonData.image
                    ) {
                      const base64Data = jsonData.image || jsonData.data;
                      const isPNG = base64Data.startsWith("iVBORw0KGgo");
                      const binaryString = atob(base64Data);
                      const bytes = new Uint8Array(binaryString.length);
                      for (let j = 0; j < binaryString.length; j++)
                        bytes[j] = binaryString.charCodeAt(j);
                      const blobType = isPNG ? "image/png" : "image/jpeg";
                      const imageBlob = new Blob([bytes], { type: blobType });
                      const reader = new FileReader();
                      imageDataUrl = await new Promise((r) => {
                        reader.onloadend = () => r(reader.result);
                        reader.readAsDataURL(imageBlob);
                      });
                      break;
                    }
                  } catch (e) {}
                }
              }
            } else {
              zipBlob = await res.blob();
            }

            if (!imageDataUrl && zipBlob) {
              if (typeof JSZip === "undefined")
                throw new Error("JSZipåº“æœªåŠ è½½");
              const zip = await JSZip.loadAsync(zipBlob);
              const file = Object.values(zip.files)[0];
              if (file) {
                const imgBlob = await file.async("blob");
                const reader = new FileReader();
                imageDataUrl = await new Promise((r) => {
                  reader.onloadend = () => r(reader.result);
                  reader.readAsDataURL(imgBlob);
                });
              }
            }

            if (imageDataUrl) {
              // *** æ ¸å¿ƒï¼šæ›´æ–°åŸæ¥çš„æ¶ˆæ¯ ***
              message.imageUrl = imageDataUrl;

              // ä¿å­˜æ•°æ®åº“
              await db.chats.put(chat);

              // éšè—é®ç½©
              document
                .getElementById("custom-modal-overlay")
                .classList.remove("visible"); // å‡è®¾ showCustomAlert ä½¿ç”¨çš„æ˜¯è¿™ä¸ª

              // åˆ·æ–°ç•Œé¢
              renderChatInterface(state.activeChatId);

              // æç¤ºæˆåŠŸ
              // alert('å›¾ç‰‡é‡ç»˜æˆåŠŸï¼'); // å¯é€‰ï¼Œå› ä¸ºçœ‹åˆ°å›¾ç‰‡å˜äº†å°±çŸ¥é“æˆåŠŸäº†
            } else {
              throw new Error("æœªè§£æåˆ°å›¾ç‰‡æ•°æ®");
            }
          } catch (error) {
            console.error("é‡ç»˜å¤±è´¥:", error);
            document
              .getElementById("custom-modal-overlay")
              .classList.remove("visible");
            alert(`é‡ç»˜å¤±è´¥: ${error.message}`);
          }
        }

        /**
         * éšè—æ¶ˆæ¯æ“ä½œèœå•
         */
        function hideMessageActions() {
          document
            .getElementById("message-actions-modal")
            .classList.remove("visible");
          activeMessageTimestamp = null;
        }

        async function openMessageEditor() {
          if (!activeMessageTimestamp) return;

          const timestampToEdit = activeMessageTimestamp;
          const chat = state.chats[state.activeChatId];
          const message = chat.history.find(
            (m) => m.timestamp === timestampToEdit,
          );
          if (!message) return;

          hideMessageActions();

          let contentForEditing;
          const isSpecialType =
            message.type &&
            [
              "voice_message",
              "ai_image",
              "transfer",
              "share_link",
              "borrow_money_request",
            ].includes(message.type);

          if (isSpecialType) {
            if (message.type === "borrow_money_request") {
              // â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„æ ¸å¿ƒé€»è¾‘ï¼ â˜…â˜…â˜…
              // å½“ç¼–è¾‘çš„æ˜¯å€Ÿé’±å¡ç‰‡æ—¶ï¼Œæˆ‘ä»¬ä» payload ä¸­æå–æ•°æ®å¹¶æ‹¼æ¥æˆä½ æƒ³è¦çš„æ–‡æœ¬æ ¼å¼
              const payload = message.payload;
              contentForEditing = `å‘ä½ å€Ÿé’±${payload.amount}å…ƒï¼Œç”¨äº${payload.reason}`;
            } else {
              // å…¶ä»–ç‰¹æ®Šç±»å‹çš„å¤„ç†é€»è¾‘ä¿æŒä¸å˜
              let fullMessageObject = { type: message.type };
              if (message.type === "voice_message")
                fullMessageObject.content = message.content;
              else if (message.type === "ai_image")
                fullMessageObject.description = message.content;
              else if (message.type === "transfer") {
                fullMessageObject.amount = message.amount;
                fullMessageObject.note = message.note;
              } else if (message.type === "share_link") {
                fullMessageObject.title = message.title;
                fullMessageObject.description = message.description;
                fullMessageObject.source_name = message.source_name;
                fullMessageObject.content = message.content;
              }
              contentForEditing = JSON.stringify(fullMessageObject, null, 2);
            }
          } else if (typeof message.content === "object") {
            contentForEditing = JSON.stringify(message.content, null, 2);
          } else {
            contentForEditing = message.content;
          }

          const templates = {
            voice: { type: "voice_message", content: "åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹" },
            image: { type: "ai_image", description: "åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°" },
            transfer: { type: "transfer", amount: 5.2, note: "ä¸€ç‚¹å¿ƒæ„" },
            link: {
              type: "share_link",
              title: "æ–‡ç« æ ‡é¢˜",
              description: "æ–‡ç« æ‘˜è¦...",
              source_name: "æ¥æºç½‘ç«™",
              content: "æ–‡ç« å®Œæ•´å†…å®¹...",
            },
          };

          const helpersHtml = `
			        <div class="format-helpers">
			            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>è¯­éŸ³</button>
			            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡</button>
			            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½¬è´¦</button>
			            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é“¾æ¥</button>
			        </div>
			    `;

          const newContent = await showCustomPrompt(
            "ç¼–è¾‘æ¶ˆæ¯",
            "åœ¨æ­¤ä¿®æ”¹ï¼Œæˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä½¿ç”¨æ ¼å¼æ¨¡æ¿...",
            contentForEditing,
            "textarea",
            helpersHtml,
          );

          if (newContent !== null) {
            await saveEditedMessage(timestampToEdit, newContent);
          }
        }

        /**
         * å¤åˆ¶æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹åˆ°å‰ªè´´æ¿
         */
        async function copyMessageContent() {
          if (!activeMessageTimestamp) return;
          const chat = state.chats[state.activeChatId];
          const message = chat.history.find(
            (m) => m.timestamp === activeMessageTimestamp,
          );
          if (!message) return;

          let textToCopy;
          if (typeof message.content === "object") {
            textToCopy = JSON.stringify(message.content);
          } else {
            textToCopy = String(message.content);
          }

          try {
            await navigator.clipboard.writeText(textToCopy);
            await showCustomAlert("å¤åˆ¶æˆåŠŸ", "æ¶ˆæ¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚");
          } catch (err) {
            await showCustomAlert("å¤åˆ¶å¤±è´¥", "æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚");
          }

          hideMessageActions();
        }

        /**
         * åˆ›å»ºä¸€ä¸ªå¯ç¼–è¾‘çš„æ¶ˆæ¯å—ï¼ˆåŒ…å«æ–‡æœ¬æ¡†ã€æ ¼å¼åŠ©æ‰‹å’Œåˆ é™¤æŒ‰é’®ï¼‰
         * @param {string} initialContent - æ–‡æœ¬æ¡†çš„åˆå§‹å†…å®¹
         * @returns {HTMLElement} - åˆ›å»ºå¥½çš„DOMå…ƒç´ 
         */
        function createMessageEditorBlock(initialContent = "") {
          const block = document.createElement("div");
          block.className = "message-editor-block";

          // æ·»åŠ  'link' æ¨¡æ¿
          const templates = {
            voice: { type: "voice_message", content: "åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹" },
            image: { type: "ai_image", description: "åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°" },
            transfer: { type: "transfer", amount: 5.2, note: "ä¸€ç‚¹å¿ƒæ„" },
            link: {
              type: "share_link",
              title: "æ–‡ç« æ ‡é¢˜",
              description: "æ–‡ç« æ‘˜è¦...",
              source_name: "æ¥æºç½‘ç«™",
              content: "æ–‡ç« å®Œæ•´å†…å®¹...",
            },
          };

          block.innerHTML = `
			        <button class="delete-block-btn" title="åˆ é™¤æ­¤æ¡">Ã—</button>
			        <textarea>${initialContent}</textarea>
			        <div class="format-helpers">
			            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>è¯­éŸ³</button>
			            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡</button>
			            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½¬è´¦</button>
			            
			            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é“¾æ¥</button>
			        </div>
			    `;

          // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
          block
            .querySelector(".delete-block-btn")
            .addEventListener("click", () => {
              // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸€ä¸ªç¼–è¾‘å—
              if (
                document.querySelectorAll(".message-editor-block").length > 1
              ) {
                block.remove();
              } else {
                alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€æ¡æ¶ˆæ¯ã€‚");
              }
            });

          // ç»‘å®šæ ¼å¼åŠ©æ‰‹æŒ‰é’®äº‹ä»¶
          block.querySelectorAll(".format-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              const templateStr = btn.dataset.template;
              const textarea = block.querySelector("textarea");
              if (templateStr && textarea) {
                try {
                  const templateObj = JSON.parse(templateStr);
                  textarea.value = JSON.stringify(templateObj, null, 2);
                  textarea.focus();
                } catch (e) {
                  console.error("è§£ææ ¼å¼æ¨¡æ¿å¤±è´¥:", e);
                }
              }
            });
          });

          return block;
        }

        /**
         * æ‰“å¼€å…¨æ–°çš„ã€å¯è§†åŒ–çš„å¤šæ¶ˆæ¯ç¼–è¾‘å™¨ï¼Œå¹¶åŠ¨æ€ç»‘å®šå…¶æ‰€æœ‰æŒ‰é’®äº‹ä»¶
         */
        function openAdvancedMessageEditor() {
          if (!activeMessageTimestamp) return;

          // 1. åœ¨å…³é—­æ—§èœå•å‰ï¼Œå°†éœ€è¦çš„æ—¶é—´æˆ³æ•è·åˆ°å±€éƒ¨å˜é‡ä¸­
          const timestampToEdit = activeMessageTimestamp;

          const chat = state.chats[state.activeChatId];
          const message = chat.history.find(
            (m) => m.timestamp === timestampToEdit,
          );
          if (!message) return;

          // 2. ç°åœ¨å¯ä»¥å®‰å…¨åœ°å…³é—­æ—§èœå•äº†ï¼Œå› ä¸ºå®ƒä¸ä¼šå½±å“æˆ‘ä»¬çš„å±€éƒ¨å˜é‡
          hideMessageActions();

          const editorModal = document.getElementById("message-editor-modal");
          const editorContainer = document.getElementById(
            "message-editor-container",
          );
          editorContainer.innerHTML = "";

          // 3. å‡†å¤‡åˆå§‹å†…å®¹
          let initialContent;
          const isSpecialType =
            message.type &&
            ["voice_message", "ai_image", "transfer"].includes(message.type);
          if (isSpecialType) {
            let fullMessageObject = { type: message.type };
            if (message.type === "voice_message")
              fullMessageObject.content = message.content;
            else if (message.type === "ai_image")
              fullMessageObject.description = message.content;
            else if (message.type === "transfer") {
              fullMessageObject.amount = message.amount;
              fullMessageObject.note = message.note;
            }
            initialContent = JSON.stringify(fullMessageObject, null, 2);
          } else if (typeof message.content === "object") {
            initialContent = JSON.stringify(message.content, null, 2);
          } else {
            if (
              message.type === "sticker" ||
              (typeof message.content === "string" &&
                STICKER_REGEX.test(message.content))
            ) {
              initialContent = message.meaning
                ? `[sticker:${message.meaning}]`
                : message.content;
            } else {
              initialContent = message.content;
            }
          }

          const firstBlock = createMessageEditorBlock(initialContent);
          editorContainer.appendChild(firstBlock);

          // 4. åŠ¨æ€ç»‘å®šæ‰€æœ‰æ§åˆ¶æŒ‰é’®çš„äº‹ä»¶
          // ä¸ºäº†é˜²æ­¢äº‹ä»¶é‡å¤ç»‘å®šï¼Œæˆ‘ä»¬ä½¿ç”¨å…‹éš†èŠ‚ç‚¹çš„æ–¹æ³•æ¥æ¸…é™¤æ—§ç›‘å¬å™¨
          const addBtn = document.getElementById(
            "add-message-editor-block-btn",
          );
          const newAddBtn = addBtn.cloneNode(true);
          addBtn.parentNode.replaceChild(newAddBtn, addBtn);
          newAddBtn.addEventListener("click", () => {
            const newBlock = createMessageEditorBlock();
            editorContainer.appendChild(newBlock);
            newBlock.querySelector("textarea").focus();
          });

          const cancelBtn = document.getElementById(
            "cancel-advanced-editor-btn",
          );
          const newCancelBtn = cancelBtn.cloneNode(true);
          cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
          newCancelBtn.addEventListener("click", () => {
            editorModal.classList.remove("visible");
          });

          const saveBtn = document.getElementById("save-advanced-editor-btn");
          const newSaveBtn = saveBtn.cloneNode(true);
          saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
          // å°†æ•è·åˆ°çš„æ—¶é—´æˆ³ï¼Œç›´æ¥ç»‘å®šç»™è¿™ä¸€æ¬¡çš„ä¿å­˜ç‚¹å‡»äº‹ä»¶
          newSaveBtn.addEventListener("click", () => {
            saveEditedMessage(timestampToEdit);
          });

          // 5. æœ€åï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
          editorModal.classList.add("visible");
        }

        function parseEditedContent(text) {
          const trimmedText = text.trim();
          // 1. ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯ [sticker:åå­—] æ ¼å¼
          const stickerNameMatch = trimmedText.match(/^\[sticker:(.+?)\]$/i);
          if (stickerNameMatch) {
            const name = stickerNameMatch[1];
            // å°è¯•å»æ‰€æœ‰è¡¨æƒ…åº“é‡Œæ‰¾å›è¿™ä¸ªåå­—å¯¹åº”çš„URL
            const allStickers = [
              ...(state.userStickers || []),
              ...(state.charStickers || []),
            ];
            // å°è¯•è·å–å½“å‰èŠå¤©å¯¹è±¡çš„ä¸“å±è¡¨æƒ…(å¦‚æœæœ‰)
            if (
              window.state &&
              window.state.activeChatId &&
              window.state.chats[window.state.activeChatId]
            ) {
              const currentChat = window.state.chats[window.state.activeChatId];
              if (currentChat.settings.stickerLibrary) {
                allStickers.push(...currentChat.settings.stickerLibrary);
              }
            }

            const found = allStickers.find((s) => s.name === name);
            if (found) {
              // å¦‚æœæ‰¾åˆ°äº†ï¼Œè¿™å°±è¿˜åŸæˆä¸€ä¸ªæ ‡å‡†çš„è¡¨æƒ…åŒ…å¯¹è±¡ï¼
              return [
                { type: "sticker", content: found.url, meaning: found.name },
              ];
            }
          }

          // ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦åŒ¹é…â€œå€Ÿé’±â€æ ¼å¼
          const borrowMatch = trimmedText.match(
            /å‘ä½ å€Ÿé’±(\d+(\.\d+)?)å…ƒï¼Œç”¨äº(.+)/,
          );
          if (borrowMatch) {
            const amount = parseFloat(borrowMatch[1]);
            const reason = borrowMatch[3].trim();

            // 1. åˆ›å»ºæ–‡æœ¬æ¶ˆæ¯å¯¹è±¡
            const textMessage = {
              type: "text",
              content: trimmedText,
            };

            // 2. åˆ›å»ºå€Ÿæ¡å¡ç‰‡å¯¹è±¡
            const cardMessage = {
              type: "borrow_money_request",
              payload: {
                lenderName: "ä½ ", // é»˜è®¤æ˜¯å‘â€œä½ â€å€Ÿé’±
                amount: amount,
                reason: reason,
              },
            };

            // 3. å°†ä¸¤æ¡æ¶ˆæ¯æ‰“åŒ…æˆä¸€ä¸ªæ•°ç»„è¿”å›ï¼
            return [textMessage, cardMessage];
          }

          // å¦‚æœä¸æ˜¯å€Ÿé’±æ ¼å¼ï¼Œåˆ™æ‰§è¡ŒåŸæ¥çš„é€»è¾‘ï¼Œä½†ä¸ºäº†ç»Ÿä¸€ï¼Œä¹Ÿè¿”å›ä¸€ä¸ªæ•°ç»„
          if (trimmedText.startsWith("{") && trimmedText.endsWith("}")) {
            try {
              const parsed = JSON.parse(trimmedText);
              if (parsed.type) {
                return [parsed]; // å•ä¸ªå¯¹è±¡ä¹ŸåŒ…è£…æˆæ•°ç»„
              }
            } catch (e) {
              /* è§£æå¤±è´¥ï¼Œç»§ç»­å¾€ä¸‹èµ° */
            }
          }

          if (STICKER_REGEX.test(trimmedText)) {
            return [{ type: "sticker", content: trimmedText }];
          }

          // é»˜è®¤è¿”å›ä¸€ä¸ªåªåŒ…å«å•æ¡æ–‡æœ¬æ¶ˆæ¯çš„æ•°ç»„
          return [{ type: "text", content: trimmedText }];
        }

        async function saveEditedMessage(timestamp, simpleContent = null) {
          if (!timestamp) return;

          const chat = state.chats[state.activeChatId];
          const messageIndex = chat.history.findIndex(
            (m) => m.timestamp === timestamp,
          );
          if (messageIndex === -1) return;

          const originalMessage = chat.history[messageIndex];
          if (!originalMessage) return;

          let newMessagesData = [];

          if (simpleContent !== null) {
            newMessagesData = parseEditedContent(simpleContent.trim());
          } else {
            // é«˜çº§ç¼–è¾‘å™¨çš„é€»è¾‘ä¿æŒä¸å˜ï¼Œä½†è¦ç¡®ä¿å®ƒä¹Ÿè¿”å›æ•°ç»„
            const editorContainer = document.getElementById(
              "message-editor-container",
            );
            const editorBlocks = editorContainer.querySelectorAll(
              ".message-editor-block",
            );
            for (const block of editorBlocks) {
              const textarea = block.querySelector("textarea");
              const rawContent = textarea.value.trim();
              if (rawContent) {
                // parseEditedContent ç°åœ¨æ€»æ˜¯è¿”å›æ•°ç»„ï¼Œæˆ‘ä»¬ç”¨concatæ¥åˆå¹¶
                newMessagesData = newMessagesData.concat(
                  parseEditedContent(rawContent),
                );
              }
            }
          }

          if (newMessagesData.length === 0) {
            document
              .getElementById("message-editor-modal")
              .classList.remove("visible");
            return;
          }

          const messagesToInsert = newMessagesData.map((newMsgData) => ({
            ...originalMessage, // ç»§æ‰¿åŸæ¶ˆæ¯çš„è§’è‰²ã€å‘é€è€…ç­‰ä¿¡æ¯
            ...newMsgData, // ç”¨æ–°è§£æå‡ºçš„æ•°æ®è¦†ç›– type, content, payload ç­‰
          }));

          chat.history.splice(messageIndex, 1, ...messagesToInsert);

          // åç»­çš„æ—¶é—´æˆ³é‡æ–°åˆ†é…å’ŒUIåˆ·æ–°é€»è¾‘ä¿æŒä¸å˜
          let reassignTimestamp = timestamp;
          for (let i = messageIndex; i < chat.history.length; i++) {
            chat.history[i].timestamp = reassignTimestamp;
            reassignTimestamp++;
          }

          await db.chats.put(chat);
          document
            .getElementById("message-editor-modal")
            .classList.remove("visible");
          renderChatInterface(state.activeChatId);
          await showCustomAlert("æˆåŠŸ", "æ¶ˆæ¯å·²æ›´æ–°ï¼");
        }

        /**
         * å½“ç‚¹å‡»â€œâ€¦â€æ—¶ï¼Œæ˜¾ç¤ºåŠ¨æ€æ“ä½œèœå•
         * @param {number} postId - è¢«æ“ä½œçš„åŠ¨æ€çš„ID
         */
        function showPostActions(postId) {
          activePostId = postId;
          document
            .getElementById("post-actions-modal")
            .classList.add("visible");
        }

        /**
         * éšè—åŠ¨æ€æ“ä½œèœå•
         */
        function hidePostActions() {
          document
            .getElementById("post-actions-modal")
            .classList.remove("visible");
          activePostId = null;
        }

        async function openPostEditor() {
          if (!activePostId) return;

          const postIdToEdit = activePostId;
          const post = await db.qzonePosts.get(postIdToEdit);
          if (!post) return;

          hidePostActions();

          // å¤ç”¨åˆ›å»ºåŠ¨æ€çš„æ¨¡æ€æ¡†
          const modal = document.getElementById("create-post-modal");
          modal.dataset.mode = "edit"; // è®¾ç½®ä¸€ä¸ªç¼–è¾‘æ¨¡å¼çš„æ ‡è®°
          modal.dataset.editingPostId = postIdToEdit; // ä¿å­˜æ­£åœ¨ç¼–è¾‘çš„ID

          // éšè—æ¨¡å¼åˆ‡æ¢ï¼Œå› ä¸ºä¸å…è®¸åœ¨ç¼–è¾‘æ—¶æ›´æ”¹åŠ¨æ€ç±»å‹
          modal.querySelector(".post-mode-switcher").style.display = "none";

          // å¡«å……æ•°æ®
          document.getElementById("post-public-text").value =
            post.publicText || (post.type === "shuoshuo" ? post.content : "");

          // æ ¹æ®åŠ¨æ€ç±»å‹æ˜¾ç¤ºä¸åŒçš„ç¼–è¾‘åŒº
          if (post.type === "image_post") {
            document
              .getElementById("image-mode-content")
              .classList.add("active");
            document
              .getElementById("text-image-mode-content")
              .classList.remove("active");
            document
              .getElementById("post-image-preview-container")
              .classList.add("visible");
            document.getElementById("post-image-preview").src = post.imageUrl;
            document.getElementById("post-image-desc-group").style.display =
              "block";
            document.getElementById("post-image-description").value =
              post.imageDescription;
          } else if (post.type === "text_image") {
            document
              .getElementById("image-mode-content")
              .classList.remove("active");
            document
              .getElementById("text-image-mode-content")
              .classList.add("active");
            document.getElementById("post-hidden-text").value =
              post.hiddenContent;
          } else {
            // è¯´è¯´
            document
              .getElementById("image-mode-content")
              .classList.remove("active");
            document
              .getElementById("text-image-mode-content")
              .classList.remove("active");
          }

          document.getElementById("post-comments-toggle").checked =
            post.areCommentsVisible !== false;

          modal.classList.add("visible");
        }

        /**
         * ä¿å­˜ç¼–è¾‘åçš„åŠ¨æ€
         * @param {number} postId - è¦ä¿å­˜çš„åŠ¨æ€ID
         * @param {string} newRawContent - ä»ç¼–è¾‘å™¨è·å–çš„æ–°å†…å®¹
         */
        async function saveEditedPost(postId, newRawContent) {
          const post = await db.qzonePosts.get(postId);
          if (!post) return;

          const trimmedContent = newRawContent.trim();

          // å°è¯•è§£æä¸ºJSONï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™è®¤ä¸ºæ˜¯çº¯æ–‡æœ¬ï¼ˆè¯´è¯´ï¼‰
          try {
            const parsed = JSON.parse(trimmedContent);
            // æ›´æ–°å¸–å­å±æ€§
            post.type = parsed.type || "image_post";
            post.publicText = parsed.publicText || "";
            post.imageUrl = parsed.imageUrl || "";
            post.imageDescription = parsed.imageDescription || "";
            post.hiddenContent = parsed.hiddenContent || "";
            post.content = ""; // æ¸…ç©ºæ—§çš„è¯´è¯´å†…å®¹å­—æ®µ
          } catch (e) {
            // è§£æå¤±è´¥ï¼Œè®¤ä¸ºæ˜¯è¯´è¯´
            post.type = "shuoshuo";
            post.content = trimmedContent;
            // æ¸…ç©ºå…¶ä»–ç±»å‹çš„å­—æ®µ
            post.publicText = "";
            post.imageUrl = "";
            post.imageDescription = "";
            post.hiddenContent = "";
          }

          await db.qzonePosts.put(post);
          await renderQzonePosts(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
          await showCustomAlert("æˆåŠŸ", "åŠ¨æ€å·²æ›´æ–°ï¼");
        }

        /**
         * å¤åˆ¶åŠ¨æ€å†…å®¹
         */
        async function copyPostContent() {
          if (!activePostId) return;
          const post = await db.qzonePosts.get(activePostId);
          if (!post) return;

          let textToCopy =
            post.content ||
            post.publicText ||
            post.hiddenContent ||
            post.imageDescription ||
            "ï¼ˆæ— æ–‡å­—å†…å®¹ï¼‰";

          try {
            await navigator.clipboard.writeText(textToCopy);
            await showCustomAlert("å¤åˆ¶æˆåŠŸ", "åŠ¨æ€å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚");
          } catch (err) {
            await showCustomAlert("å¤åˆ¶å¤±è´¥", "æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚");
          }

          hidePostActions();
        }

        // åˆ›å»ºç¾¤èŠä¸æ‹‰äººåŠŸèƒ½æ ¸å¿ƒå‡½æ•°
        let selectedContacts = new Set();

        async function openContactPickerForGroupCreate() {
          selectedContacts.clear(); // æ¸…ç©ºä¸Šæ¬¡é€‰æ‹©

          // ä¸ºâ€œå®Œæˆâ€æŒ‰é’®æ˜ç¡®ç»‘å®šâ€œåˆ›å»ºç¾¤èŠâ€çš„åŠŸèƒ½
          const confirmBtn = document.getElementById(
            "confirm-contact-picker-btn",
          );
          // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§ï¼Œæ¸…é™¤æ‰ä¹‹å‰å¯èƒ½ç»‘å®šçš„ä»»ä½•å…¶ä»–äº‹ä»¶ï¼ˆæ¯”å¦‚â€œæ·»åŠ æˆå‘˜â€ï¼‰
          const newConfirmBtn = confirmBtn.cloneNode(true);
          confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
          // é‡æ–°ç»‘å®šæ­£ç¡®çš„â€œåˆ›å»ºç¾¤èŠâ€å‡½æ•°
          newConfirmBtn.addEventListener("click", handleCreateGroup);

          await renderContactPicker();
          showScreen("contact-picker-screen");
        }

        async function renderContactPicker() {
          const listEl = document.getElementById("contact-picker-list");
          listEl.innerHTML = "";
          selectedContacts.clear(); // æ¸…ç©ºä¸Šæ¬¡çš„é€‰æ‹©

          const allAvailablePeople = [];
          // 1. æ·»åŠ ä¸»è¦è§’è‰²
          Object.values(state.chats)
            .filter((c) => !c.isGroup)
            .forEach((c) => {
              allAvailablePeople.push({
                id: c.id,
                name: c.name,
                avatar: c.settings.aiAvatar || defaultAvatar,
                isNpc: false, // æ ‡è®°ä¸ºéNPC
                type: "è§’è‰²",
              });
            });

          // 2. æ·»åŠ æ‰€æœ‰è§’è‰²åº“é‡Œçš„NPCï¼Œå¹¶è‡ªåŠ¨å»é‡
          const npcMap = new Map();
          Object.values(state.chats).forEach((chat) => {
            if (chat.npcLibrary) {
              chat.npcLibrary.forEach((npc) => {
                // ä½¿ç”¨NPCçš„IDä½œä¸ºkeyï¼Œç¡®ä¿åŒä¸€ä¸ªNPCä¸ä¼šè¢«é‡å¤æ·»åŠ 
                if (!npcMap.has(npc.id)) {
                  npcMap.set(npc.id, {
                    id: npc.id,
                    name: npc.name,
                    avatar: npc.avatar || defaultGroupMemberAvatar,
                    isNpc: true, // æ ‡è®°ä¸ºNPC
                    type: `NPC (${chat.name})`, // æ˜¾ç¤ºè¯¥NPCæ‰€å±çš„è§’è‰²
                  });
                }
              });
            }
          });
          allAvailablePeople.push(...Array.from(npcMap.values()));

          if (allAvailablePeople.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">è¿˜æ²¡æœ‰å¯ä»¥æ‹‰è¿›ç¾¤çš„è”ç³»äººå“¦~</p>';
            return;
          }

          // 3. æ¸²æŸ“æ•´åˆåçš„åˆ—è¡¨
          allAvailablePeople.forEach((contact) => {
            const item = document.createElement("div");
            item.className = "contact-picker-item";
            item.dataset.contactId = contact.id;

            // æ ¸å¿ƒä¿®æ”¹ï¼šä¸ºNPCæ·»åŠ ä¸€ä¸ªâ€œ(NPC)â€çš„æ ‡ç­¾ï¼Œæ–¹ä¾¿åŒºåˆ†
            item.innerHTML = `
			            <div class="checkbox"></div>
			            <img src="${contact.avatar}" class="avatar">
			            <span class="name">${contact.name} ${
                    contact.isNpc
                      ? '<span style="color: #888; font-size: 12px;">(NPC)</span>'
                      : ""
                  }</span>
			        `;
            listEl.appendChild(item);
          });

          updateContactPickerConfirmButton();
        }

        /**
         * æ›´æ–°â€œå®Œæˆâ€æŒ‰é’®çš„è®¡æ•°
         */
        function updateContactPickerConfirmButton() {
          const btn = document.getElementById("confirm-contact-picker-btn");
          btn.textContent = `å®Œæˆ(${selectedContacts.size})`;
          btn.disabled = selectedContacts.size < 2; // è‡³å°‘éœ€è¦2ä¸ªäººæ‰èƒ½åˆ›å»ºç¾¤èŠ
        }

        /**
         * å¤„ç†åˆ›å»ºç¾¤èŠçš„æœ€ç»ˆé€»è¾‘
         */
        async function handleCreateGroup() {
          if (selectedContacts.size < 2) {
            alert("åˆ›å»ºç¾¤èŠè‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªè”ç³»äººã€‚");
            return;
          }

          const groupName = await showCustomPrompt(
            "è®¾ç½®ç¾¤å",
            "è¯·è¾“å…¥ç¾¤èŠçš„åå­—",
            "æˆ‘ä»¬çš„ç¾¤èŠ",
          );
          if (!groupName || !groupName.trim()) return;

          const newChatId = "group_" + Date.now();
          const members = [];

          for (const contactId of selectedContacts) {
            const contactChat = state.chats[contactId];
            if (contactChat) {
              // è¿™æ˜¯åŸæ¥çš„é€»è¾‘ï¼Œç”¨äºå¤„ç†æ™®é€šè§’è‰²(Char)
              members.push({
                id: contactId,
                originalName: contactChat.name,
                groupNickname: contactChat.name,
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || "",
                isAdmin: false,
                groupTitle: "",
              });
            } else {
              // å¤„ç†NPCçš„é€»è¾‘
              let foundNpc = null;
              // éå†æ‰€æœ‰è§’è‰²ï¼ŒæŸ¥æ‰¾ä»–ä»¬å„è‡ªçš„NPCåº“
              for (const chat of Object.values(state.chats)) {
                if (chat.npcLibrary) {
                  const npc = chat.npcLibrary.find((n) => n.id === contactId);
                  if (npc) {
                    foundNpc = npc;
                    break; // æ‰¾åˆ°äº†å°±è·³å‡ºå¾ªç¯
                  }
                }
              }
              // å¦‚æœæ‰¾åˆ°äº†è¿™ä¸ªNPCï¼Œå°±æŠŠå®ƒæ·»åŠ åˆ°æˆå‘˜åˆ—è¡¨é‡Œ
              if (foundNpc) {
                members.push({
                  id: foundNpc.id,
                  originalName: foundNpc.name,
                  groupNickname: foundNpc.name,
                  avatar: foundNpc.avatar || defaultGroupMemberAvatar,
                  persona: foundNpc.persona,
                  avatarFrame: "", // NPCæ²¡æœ‰å¤´åƒæ¡†
                  isAdmin: false,
                  groupTitle: "",
                });
              }
            }
          }

          const newGroupChat = {
            id: newChatId,
            name: groupName.trim(),
            isGroup: true,
            // è®¾ç½®ç¾¤ä¸»ä¸ºå½“å‰ç”¨æˆ·
            ownerId: "user",
            members: members,
            settings: {
              myPersona: "æˆ‘æ˜¯è°å‘€ã€‚",
              myNickname: "æˆ‘",
              maxMemory: 10,
              groupAvatar: defaultGroupAvatar,
              myAvatar: defaultMyGroupAvatar,
              myAvatarFrame: "", // åˆ«å¿˜äº†è‡ªå·±çš„å¤´åƒæ¡†
              background: "",
              theme: "default",
              fontSize: 13,
              customCss: "",
              linkedWorldBookIds: [],
              stickerLibrary: [],
              linkedMemories: [],
              // ä¸ºç”¨æˆ·è‡ªå·±ä¹ŸåŠ ä¸Šç®¡ç†å‘˜å’Œå¤´è¡”çš„åˆå§‹è®¾ç½®
              isUserAdmin: false,
              myGroupTitle: "",
            },
            history: [],
            musicData: { totalTime: 0 },
          };

          state.chats[newChatId] = newGroupChat;
          await db.chats.put(newGroupChat);

          // åˆ›å»ºç¾¤èŠåï¼Œå‘é€ä¸€æ¡ç³»ç»Ÿé€šçŸ¥
          await logSystemMessage(
            newChatId,
            `ä½ åˆ›å»ºäº†ç¾¤èŠï¼Œå¹¶é‚€è¯·äº† ${members.map((m) => `â€œ${m.groupNickname}â€`).join("ã€")} åŠ å…¥ç¾¤èŠã€‚`,
          );

          // åç»­é€»è¾‘ä¸å˜
          await renderChatList();
          showScreen("chat-list-screen");
          openChat(newChatId);
        }

        // ç¾¤æˆå‘˜ç®¡ç†æ ¸å¿ƒå‡½æ•°

        /**
         * æ‰“å¼€ç¾¤æˆå‘˜ç®¡ç†å±å¹•
         */
        function openMemberManagementScreen() {
          if (!state.activeChatId || !state.chats[state.activeChatId].isGroup)
            return;
          renderMemberManagementList();
          showScreen("member-management-screen");
        }

        /**
         * æ¸²æŸ“ç¾¤æˆå‘˜ç®¡ç†åˆ—è¡¨
         */
        function renderMemberManagementList() {
          const listEl = document.getElementById("member-management-list");
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.isGroup) {
            listEl.innerHTML = "<p>é”™è¯¯ï¼šéç¾¤èŠæ— æ³•ç®¡ç†æˆå‘˜ã€‚</p>";
            return;
          }
          listEl.innerHTML = ""; // æ¸…ç©º

          // 1. åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰äººçš„å®Œæ•´åˆ—è¡¨
          const allParticipants = [
            // æŠŠä½ è‡ªå·±(user)ä½œä¸ºä¸€ä¸ªæ™®é€šå‚ä¸è€…å¯¹è±¡æ”¾è¿›å»
            {
              id: "user",
              avatar: chat.settings.myAvatar || defaultMyGroupAvatar,
              groupNickname: chat.settings.myNickname || "æˆ‘",
              // ä¿®å¤Bug 1ï¼šåœ¨è¿™é‡Œæ­£ç¡®åœ°è¯»å–ä½ è‡ªå·±çš„ç¾¤å¤´è¡”
              groupTitle: chat.settings.myGroupTitle || "",
            },
            // ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦(...)ï¼ŒæŠŠå…¶ä»–æ‰€æœ‰æˆå‘˜ä¹ŸåŠ åˆ°è¿™ä¸ªåˆ—è¡¨é‡Œ
            ...(chat.members || []),
          ];

          // 2. (å¯é€‰ä½†æ¨è) å¯¹åˆ—è¡¨è¿›è¡Œæ’åºï¼Œç¡®ä¿ç¾¤ä¸»æ°¸è¿œåœ¨æœ€ä¸Šé¢ï¼Œå…¶æ¬¡æ˜¯ç®¡ç†å‘˜
          allParticipants.sort((a, b) => {
            const isAOwner = a.id === chat.ownerId;
            const isBOwner = b.id === chat.ownerId;
            // ä¿®å¤Bug 2ï¼šåœ¨è¿™é‡Œæ­£ç¡®åœ°åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯ç®¡ç†å‘˜
            const isAAdmin =
              a.id === "user" ? chat.settings.isUserAdmin : a.isAdmin;
            const isBAdmin =
              b.id === "user" ? chat.settings.isUserAdmin : b.isAdmin;

            if (isAOwner) return -1; // aæ˜¯ç¾¤ä¸»ï¼Œæ’æœ€å‰
            if (isBOwner) return 1; // bæ˜¯ç¾¤ä¸»ï¼Œæ’æœ€å‰
            if (isAAdmin && !isBAdmin) return -1; // aæ˜¯ç®¡ç†å‘˜ä½†bä¸æ˜¯ï¼Œaæ’å‰
            if (!isAAdmin && isBAdmin) return 1; // bæ˜¯ç®¡ç†å‘˜ä½†aä¸æ˜¯ï¼Œbæ’å‰
            return 0; // å…¶ä»–æƒ…å†µä¿æŒåŸé¡ºåº
          });

          // 3. éå†è¿™ä¸ªç»Ÿä¸€çš„åˆ—è¡¨ï¼Œå¹¶æ¸²æŸ“æ¯ä¸€é¡¹
          const isCurrentUserOwner = chat.ownerId === "user";
          allParticipants.forEach((participant) => {
            const participantItem = createMemberManagementItem(
              participant,
              chat,
              isCurrentUserOwner,
            );
            listEl.appendChild(participantItem);
          });
        }

        /**
         * åˆ›å»ºä¸€ä¸ªæˆå‘˜ç®¡ç†åˆ—è¡¨é¡¹
         * @param {object} member - æˆå‘˜å¯¹è±¡æ•°æ®
         * @param {object} chat - å½“å‰ç¾¤èŠå¯¹è±¡
         * @returns {HTMLElement} - åˆ›å»ºå¥½çš„DOMå…ƒç´ 
         */
        function createMemberManagementItem(member, chat) {
          const item = document.createElement("div");
          item.className = "member-management-item";

          // --- æƒé™åˆ¤æ–­ ---
          const isCurrentUserOwner = chat.ownerId === "user";
          const isCurrentUserAdmin = chat.settings.isUserAdmin;
          const isThisMemberOwner = member.id === chat.ownerId;
          const isThisMemberAdmin =
            (member.id === "user" && chat.settings.isUserAdmin) ||
            member.isAdmin;

          // æƒé™è®¡ç®—ï¼šæˆ‘èƒ½å¯¹TAåšä»€ä¹ˆï¼Ÿ
          const canManageAdmin = isCurrentUserOwner && !isThisMemberOwner; // åªæœ‰ç¾¤ä¸»èƒ½è®¾ç½®/å–æ¶ˆç®¡ç†å‘˜
          const canManageTitle = isCurrentUserOwner || isCurrentUserAdmin; // ç®¡ç†å‘˜å’Œç¾¤ä¸»éƒ½èƒ½è®¾ç½®å¤´è¡”
          const canKick =
            (isCurrentUserOwner && member.id !== "user") ||
            (isCurrentUserAdmin &&
              !isThisMemberOwner &&
              !isThisMemberAdmin &&
              member.id !== "user");
          const canMute =
            (isCurrentUserOwner && member.id !== "user") ||
            (isCurrentUserAdmin &&
              !isThisMemberOwner &&
              !isThisMemberAdmin &&
              member.id !== "user");

          // --- æ ‡ç­¾æ˜¾ç¤º ---
          let roleTag = "";
          if (isThisMemberOwner) {
            roleTag = '<span class="role-tag owner">ç¾¤ä¸»</span>';
          } else if (isThisMemberAdmin) {
            roleTag = '<span class="role-tag admin">ç®¡ç†å‘˜</span>';
          }
          const titleText =
            member.id === "user"
              ? chat.settings.myGroupTitle || ""
              : member.groupTitle || "";
          const titleTag = titleText
            ? `<span class="title-tag">${titleText}</span>`
            : "";
          // å¦‚æœè¢«ç¦è¨€ï¼Œæ˜¾ç¤ºä¸€ä¸ªç‰¹æ®Šçš„æ ‡ç­¾
          const muteTag = member.isMuted
            ? '<span class="group-title-tag" style="color: #ff3b30; background-color: #ffe5e5;">ğŸš«å·²ç¦è¨€</span>'
            : "";

          // --- åŠ¨æ€ç”ŸæˆæŒ‰é’®HTML ---
          let actionsHtml = "";

          // ç”¨æˆ·è‡ªå·±çš„æŒ‰é’®
          if (member.id === "user") {
            actionsHtml += `<button class="action-btn" data-action="set-nickname" data-member-id="user">æ”¹å</button>`;
            // ç”¨æˆ·è¢«ç¦è¨€æ—¶ï¼Œæ˜¾ç¤ºâ€œè§£é™¤ç¦è¨€â€æŒ‰é’®
            if (member.isMuted) {
              actionsHtml += `<button class="action-btn" data-action="unmute-self" data-member-id="user">è§£é™¤ç¦è¨€</button>`;
            }
          }

          // ç®¡ç†å‘˜å’Œç¾¤ä¸»çš„æ“ä½œæŒ‰é’®
          if (canManageTitle) {
            actionsHtml += `<button class="action-btn" data-action="set-title" data-member-id="${member.id}">å¤´è¡”</button>`;
          }
          if (canManageAdmin) {
            const adminActionText = isThisMemberAdmin ? "å–æ¶ˆç®¡ç†" : "è®¾ä¸ºç®¡ç†";
            actionsHtml += `<button class="action-btn" data-action="toggle-admin" data-member-id="${member.id}">${adminActionText}</button>`;
          }
          if (isCurrentUserOwner && member.id !== "user") {
            actionsHtml += `<button class="action-btn" data-action="transfer-owner" data-member-id="${member.id}">è½¬è®©</button>`;
          }
          // ç¦è¨€/è§£ç¦æŒ‰é’®
          if (canMute) {
            const muteButtonText = member.isMuted ? "è§£ç¦" : "ç¦è¨€";
            actionsHtml += `<button class="action-btn" data-action="mute-member" data-member-id="${member.id}">${muteButtonText}</button>`;
          }
          if (canKick) {
            actionsHtml += `<button class="action-btn danger" data-action="remove-member" data-member-id="${member.id}">è¸¢å‡º</button>`;
          }

          // æœ€ç»ˆæ‹¼æ¥
          item.innerHTML = `
			        <img src="${member.avatar}" class="avatar">
			        <div class="info">
			            <span class="name">${member.groupNickname}</span>
			            <div class="tags">
			                ${roleTag}
			                ${titleTag}
			                ${muteTag}
			            </div>
			        </div>
			        <div class="actions">${actionsHtml}</div>
			    `;
          return item;
        }

        /**
         * å¤„ç†ç¦è¨€/è§£ç¦ç¾¤æˆå‘˜
         * @param {string} memberId - è¦æ“ä½œçš„æˆå‘˜ID
         */
        async function handleMuteMember(memberId) {
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.isGroup) return;

          // --- æƒé™æ£€æŸ¥ (å’Œä¹‹å‰ä¿æŒä¸€è‡´) ---
          const isOwner = chat.ownerId === "user";
          const isAdmin = chat.settings.isUserAdmin;
          let targetMember, targetIsOwner, targetIsAdmin;

          // åˆ¤æ–­æ“ä½œç›®æ ‡æ˜¯æ™®é€šæˆå‘˜è¿˜æ˜¯ç”¨æˆ·è‡ªå·±
          if (memberId === "user") {
            targetMember = { id: "user", ...chat.settings }; // æ„é€ ä¸€ä¸ªä¸´æ—¶çš„â€œæˆå‘˜â€å¯¹è±¡ä»£è¡¨ç”¨æˆ·
            targetIsOwner = isOwner;
            targetIsAdmin = isAdmin;
          } else {
            targetMember = chat.members.find((m) => m.id === memberId);
            if (!targetMember) return;
            targetIsOwner = chat.ownerId === memberId;
            targetIsAdmin = targetMember.isAdmin;
          }

          const canMute =
            (isOwner && !targetIsOwner) ||
            (isAdmin && !targetIsOwner && !targetIsAdmin);

          if (!canMute) {
            alert("ä½ æ²¡æœ‰æƒé™æ“ä½œè¯¥æˆå‘˜ï¼");
            return;
          }

          // --- åˆ‡æ¢ç¦è¨€çŠ¶æ€ ---
          if (memberId === "user") {
            // å¦‚æœæ“ä½œçš„æ˜¯ç”¨æˆ·è‡ªå·±ï¼Œå°±æ›´æ–° chat.settings.isUserMuted
            if (typeof chat.settings.isUserMuted === "undefined")
              chat.settings.isUserMuted = false;
            chat.settings.isUserMuted = !chat.settings.isUserMuted;
          } else {
            // å¦‚æœæ“ä½œçš„æ˜¯å…¶ä»–æˆå‘˜ï¼Œå°±æ›´æ–°æˆå‘˜å¯¹è±¡
            if (typeof targetMember.isMuted === "undefined")
              targetMember.isMuted = false;
            targetMember.isMuted = !targetMember.isMuted;
          }

          // ä¿å­˜æ›´æ–°åçš„ç¾¤èŠæ•°æ®åˆ°æ•°æ®åº“
          await db.chats.put(chat);

          // é‡æ–°æ¸²æŸ“æˆå‘˜ç®¡ç†åˆ—è¡¨ï¼ŒæŒ‰é’®æ–‡å­—ä¼šç«‹åˆ»æ›´æ–°
          renderMemberManagementList();

          // å‘é€ç³»ç»Ÿé€šçŸ¥
          const myNickname = chat.settings.myNickname || "æˆ‘";
          const targetNickname =
            memberId === "user"
              ? chat.settings.myNickname || "æˆ‘"
              : targetMember.groupNickname;
          const actionText = (
            memberId === "user"
              ? chat.settings.isUserMuted
              : targetMember.isMuted
          )
            ? "ç¦è¨€"
            : "è§£é™¤ç¦è¨€";
          await logSystemMessage(
            chat.id,
            `â€œ${myNickname}â€å°†â€œ${targetNickname}â€${actionText}ã€‚`,
          );
        }

        /**
         * å¤„ç†ç”¨æˆ·è‡ªå·±è§£é™¤ç¦è¨€
         */
        async function handleUserUnmute() {
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.settings.isUserMuted) return;

          const confirmed = await showCustomConfirm(
            "è§£é™¤ç¦è¨€",
            "ç¡®å®šè¦ä¸ºè‡ªå·±è§£é™¤ç¦è¨€å—ï¼Ÿ",
          );
          if (confirmed) {
            chat.settings.isUserMuted = false;
            await db.chats.put(chat);

            await logSystemMessage(
              chat.id,
              `â€œ${chat.settings.myNickname || "æˆ‘"}â€ä¸ºè‡ªå·±è§£é™¤äº†ç¦è¨€ã€‚`,
            );

            renderMemberManagementList(); // åˆ·æ–°åˆ—è¡¨
          }
        }

        /**
         * å¤„ç†æ‹‰äººå…¥ç¾¤çš„é€»è¾‘ï¼ˆå·²æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ï¼‰
         */
        async function handleAddMembersToGroup() {
          if (selectedContacts.size === 0) {
            alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ·»åŠ çš„è”ç³»äººã€‚");
            return;
          }

          const chat = state.chats[state.activeChatId];
          const addedNames = [];

          for (const contactId of selectedContacts) {
            const contactChat = state.chats[contactId];
            if (contactChat) {
              // è¿™æ˜¯åŸæ¥çš„é€»è¾‘ï¼Œç”¨äºå¤„ç†æ™®é€šè§’è‰²(Char)
              chat.members.push({
                id: contactId,
                originalName: contactChat.name,
                groupNickname: contactChat.name,
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || "",
                isAdmin: false,
                groupTitle: "",
              });
              addedNames.push(`â€œ${contactChat.name}â€`);
            } else {
              // å¤„ç†NPCçš„é€»è¾‘
              let foundNpc = null;
              for (const c of Object.values(state.chats)) {
                if (c.npcLibrary) {
                  const npc = c.npcLibrary.find((n) => n.id === contactId);
                  if (npc) {
                    foundNpc = npc;
                    break;
                  }
                }
              }
              if (foundNpc) {
                chat.members.push({
                  id: foundNpc.id,
                  originalName: foundNpc.name,
                  groupNickname: foundNpc.name,
                  avatar: foundNpc.avatar || defaultGroupMemberAvatar,
                  persona: foundNpc.persona,
                  avatarFrame: "",
                  isAdmin: false,
                  groupTitle: "",
                });
                addedNames.push(`â€œ${foundNpc.name}â€`);
              }
            }
          }

          await db.chats.put(chat);

          // å‘é€ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥
          const myNickname = chat.settings.myNickname || "æˆ‘";
          await logSystemMessage(
            chat.id,
            `â€œ${myNickname}â€é‚€è¯· ${addedNames.join("ã€")} åŠ å…¥äº†ç¾¤èŠã€‚`,
          );

          // è¿”å›åˆ°ç¾¤æˆå‘˜ç®¡ç†ç•Œé¢å¹¶åˆ·æ–°
          openMemberManagementScreen();
          renderGroupMemberSettings(chat.members); // åŒæ—¶æ›´æ–°èŠå¤©è®¾ç½®é‡Œçš„å¤´åƒ
        }

        /**
         * å¤„ç†è®¾ç½®ç”¨æˆ·è‡ªå·±çš„ç¾¤æ˜µç§°
         */
        async function handleSetUserNickname() {
          const chat = state.chats[state.activeChatId];
          const oldNickname = chat.settings.myNickname || "æˆ‘";

          const newNickname = await showCustomPrompt(
            "ä¿®æ”¹æˆ‘çš„ç¾¤æ˜µç§°",
            "è¯·è¾“å…¥æ–°çš„æ˜µç§°",
            oldNickname,
          );
          if (newNickname !== null && newNickname.trim()) {
            chat.settings.myNickname = newNickname.trim();
            await db.chats.put(chat);

            // å‘é€ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥ç¾¤å‹
            await logSystemMessage(
              chat.id,
              `â€œ${oldNickname}â€å°†ç¾¤æ˜µç§°ä¿®æ”¹ä¸ºâ€œ${newNickname.trim()}â€`,
            );

            renderMemberManagementList(); // åˆ·æ–°æˆå‘˜ç®¡ç†åˆ—è¡¨
          }
        }

        /**
         * å¤„ç†è®¾ç½®ç”¨æˆ·è‡ªå·±çš„ç¾¤å¤´è¡”
         */
        async function handleSetUserTitle() {
          const chat = state.chats[state.activeChatId];
          const oldTitle = chat.settings.myGroupTitle || "";

          const newTitle = await showCustomPrompt(
            "ä¿®æ”¹æˆ‘çš„ç¾¤å¤´è¡”",
            "ç•™ç©ºåˆ™ä¸ºå–æ¶ˆå¤´è¡”",
            oldTitle,
          );
          if (newTitle !== null) {
            chat.settings.myGroupTitle = newTitle.trim();
            await db.chats.put(chat);

            // è°ƒç”¨ä½ å·²æœ‰çš„å‡½æ•°æ¥å‘é€ç³»ç»Ÿé€šçŸ¥
            const myNickname = chat.settings.myNickname || "æˆ‘";
            await logTitleChange(
              chat.id,
              myNickname,
              myNickname,
              newTitle.trim(),
            );

            renderMemberManagementList();
          }
        }

        /**
         * ä»ç¾¤èŠä¸­ç§»é™¤ä¸€ä¸ªæˆå‘˜
         * @param {string} memberId - è¦ç§»é™¤çš„æˆå‘˜ID
         */
        async function removeMemberFromGroup(memberId) {
          const chat = state.chats[state.activeChatId];
          const isOwner = chat.ownerId === "user";
          const isAdmin = chat.settings.isUserAdmin;
          const memberToRemove = chat.members.find((m) => m.id === memberId);

          // æƒé™æ£€æŸ¥
          if (
            !isOwner &&
            !(
              isAdmin &&
              !memberToRemove.isAdmin &&
              memberToRemove.id !== chat.ownerId
            )
          ) {
            alert("ä½ æ²¡æœ‰æƒé™ç§»å‡ºè¯¥æˆå‘˜ï¼");
            return;
          }

          const memberIndex = chat.members.findIndex((m) => m.id === memberId);
          if (memberIndex === -1) return;

          const memberName = memberToRemove.groupNickname;
          const confirmed = await showCustomConfirm(
            "ç§»å‡ºæˆå‘˜",
            `ç¡®å®šè¦å°†â€œ${memberName}â€ç§»å‡ºç¾¤èŠå—ï¼Ÿ`,
            {
              confirmButtonClass: "btn-danger",
            },
          );

          if (confirmed) {
            chat.members.splice(memberIndex, 1);
            await db.chats.put(chat);

            const myNickname = chat.settings.myNickname || "æˆ‘";
            await logSystemMessage(
              chat.id,
              `â€œ${myNickname}â€å°†â€œ${memberName}â€ç§»å‡ºäº†ç¾¤èŠã€‚`,
            );

            renderMemberManagementList();
          }
        }

        async function openContactPickerForAddMember() {
          selectedContacts.clear();

          // ç»‘å®šæ­£ç¡®çš„â€œæ·»åŠ æˆå‘˜â€å‡½æ•°
          const confirmBtn = document.getElementById(
            "confirm-contact-picker-btn",
          );
          const newConfirmBtn = confirmBtn.cloneNode(true);
          confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
          newConfirmBtn.addEventListener("click", handleAddMembersToGroup);

          const listEl = document.getElementById("contact-picker-list");
          listEl.innerHTML = "";

          const chat = state.chats[state.activeChatId];
          const existingMemberIds = new Set(chat.members.map((m) => m.id));
          existingMemberIds.add("user"); // æŠŠç”¨æˆ·è‡ªå·±ä¹Ÿç®—ä½œå·²å­˜åœ¨æˆå‘˜

          // å’Œåˆ›å»ºç¾¤èŠæ—¶ä¸€æ ·ï¼Œæ•´åˆæ‰€æœ‰è§’è‰²å’ŒNPC
          const allAvailablePeople = [];
          Object.values(state.chats)
            .filter((c) => !c.isGroup)
            .forEach((c) => {
              allAvailablePeople.push({
                id: c.id,
                name: c.name,
                avatar: c.settings.aiAvatar || defaultAvatar,
                isNpc: false,
              });
            });
          const npcMap = new Map();
          Object.values(state.chats).forEach((c) => {
            if (c.npcLibrary) {
              c.npcLibrary.forEach((npc) => {
                if (!npcMap.has(npc.id)) {
                  npcMap.set(npc.id, {
                    id: npc.id,
                    name: npc.name,
                    avatar: npc.avatar || defaultGroupMemberAvatar,
                    isNpc: true,
                  });
                }
              });
            }
          });
          allAvailablePeople.push(...Array.from(npcMap.values()));

          // è¿‡æ»¤æ‰å·²ç»æ˜¯ç¾¤æˆå‘˜çš„äºº
          const contacts = allAvailablePeople.filter(
            (p) => !existingMemberIds.has(p.id),
          );

          if (contacts.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">æ²¡æœ‰æ›´å¤šå¯ä»¥é‚€è¯·çš„è”ç³»äººäº†ã€‚</p>';
          } else {
            contacts.forEach((contact) => {
              const item = document.createElement("div");
              item.className = "contact-picker-item";
              item.dataset.contactId = contact.id;
              item.innerHTML = `
			                <div class="checkbox"></div>
			                <img src="${contact.avatar}" class="avatar">
			                <span class="name">${contact.name} ${
                        contact.isNpc
                          ? '<span style="color: #888; font-size: 12px;">(NPC)</span>'
                          : ""
                      }</span>
			            `;
              listEl.appendChild(item);
            });
          }

          updateContactPickerConfirmButton();
          showScreen("contact-picker-screen");
        }

        /**
         * åœ¨ç¾¤èŠä¸­åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„è™šæ‹Ÿæˆå‘˜
         */
        async function createNewMemberInGroup() {
          const name = await showCustomPrompt(
            "åˆ›å»ºæ–°æˆå‘˜",
            "è¯·è¾“å…¥æ–°æˆå‘˜çš„åå­— (è¿™å°†æ˜¯TAçš„â€œæœ¬åâ€ï¼Œä¸å¯æ›´æ”¹)",
          );
          if (!name || !name.trim()) return;

          // æ£€æŸ¥æœ¬åæ˜¯å¦å·²åœ¨ç¾¤å†…å­˜åœ¨
          const chat = state.chats[state.activeChatId];
          if (chat.members.some((m) => m.originalName === name.trim())) {
            alert(`é”™è¯¯ï¼šç¾¤å†…å·²å­˜åœ¨åä¸ºâ€œ${name.trim()}â€çš„æˆå‘˜ï¼`);
            return;
          }

          const persona = await showCustomPrompt(
            "è®¾ç½®äººè®¾",
            `è¯·è¾“å…¥â€œ${name}â€çš„äººè®¾`,
            "",
            "textarea",
          );
          if (persona === null) return;

          // ä¸ºæ–°åˆ›å»ºçš„NPCä¹Ÿå»ºç«‹åŒé‡å‘½åæœºåˆ¶
          const newMember = {
            id: "npc_" + Date.now(),
            originalName: name.trim(), // æ–°æˆå‘˜çš„â€œæœ¬åâ€
            groupNickname: name.trim(), // æ–°æˆå‘˜çš„åˆå§‹â€œç¾¤æ˜µç§°â€
            avatar: defaultGroupMemberAvatar,
            persona: persona,
            avatarFrame: "",
          };

          chat.members.push(newMember);
          await db.chats.put(chat);

          renderMemberManagementList();
          renderGroupMemberSettings(chat.members);

          alert(`æ–°æˆå‘˜â€œ${name}â€å·²æˆåŠŸåŠ å…¥ç¾¤èŠï¼`);
        }

        // å¤–å–è¯·æ±‚å€’è®¡æ—¶å‡½æ•°
        function startWaimaiCountdown(element, endTime) {
          const timerId = setInterval(() => {
            const now = Date.now();
            const distance = endTime - now;

            if (distance < 0) {
              clearInterval(timerId);
              element.innerHTML =
                "<span>å·²</span><span>è¶…</span><span>æ—¶</span>";
              return;
            }

            const minutes = Math.floor(
              (distance % (1000 * 60 * 60)) / (1000 * 60),
            );
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            const minStr = String(minutes).padStart(2, "0");
            const secStr = String(seconds).padStart(2, "0");

            element.innerHTML = `<span>${minStr.charAt(
              0,
            )}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(
              0,
            )}</span><span>${secStr.charAt(1)}</span>`;
          }, 1000);
          return timerId;
        }

        function cleanupWaimaiTimers() {
          for (const timestamp in waimaiTimers) {
            clearInterval(waimaiTimers[timestamp]);
          }
          waimaiTimers = {};
        }

        async function handleWaimaiResponse(originalTimestamp, choice) {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const messageIndex = chat.history.findIndex(
            (m) => m.timestamp === originalTimestamp,
          );
          if (messageIndex === -1) return;

          // 1. æ›´æ–°åŸå§‹æ¶ˆæ¯çš„çŠ¶æ€
          const originalMessage = chat.history[messageIndex];
          originalMessage.status = choice;

          // è®°å½•æ”¯ä»˜è€…ï¼Œå¹¶æ„å»ºå¯¹AIæ›´æ¸…æ™°çš„ç³»ç»Ÿæ¶ˆæ¯
          let systemContent;
          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "æˆ‘"
            : "æˆ‘";

          if (choice === "paid") {
            originalMessage.paidBy = myNickname; // è®°å½•æ˜¯ç”¨æˆ·ä»˜çš„é’±
            systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) ä¸º ${originalMessage.senderName} çš„å¤–å–è®¢å•ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è®¢å•å·²å…³é—­ï¼Œå…¶ä»–æˆå‘˜ä¸èƒ½å†æ”¯ä»˜ã€‚]`;
          } else {
            systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) æ‹’ç»äº† ${originalMessage.senderName} çš„å¤–å–ä»£ä»˜è¯·æ±‚ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰ã€‚]`;
          }

          // 2. åˆ›å»ºä¸€æ¡æ–°çš„ã€å¯¹ç”¨æˆ·éšè—çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œå‘ŠçŸ¥AIç»“æœ
          const systemNote = {
            role: "system",
            content: systemContent,
            timestamp: Date.now(),
            isHidden: true,
          };
          chat.history.push(systemNote);

          // 3. ä¿å­˜æ›´æ–°åˆ°æ•°æ®åº“å¹¶åˆ·æ–°UI
          await db.chats.put(chat);
          renderChatInterface(state.activeChatId);
        }

        let videoCallState = {
          isActive: false,
          isAwaitingResponse: false,
          isGroupCall: false,
          activeChatId: null,
          initiator: null,
          startTime: null,
          participants: [],
          isUserParticipating: true,

          callHistory: [], // ç”¨äºå­˜å‚¨é€šè¯ä¸­çš„å¯¹è¯å†å²
          preCallContext: "", // ç”¨äºå­˜å‚¨é€šè¯å‰çš„èŠå¤©æ‘˜è¦
        };

        let callTimerInterval = null; // ç”¨äºå­˜å‚¨è®¡æ—¶å™¨çš„ID

        /**
         * ç”¨æˆ·ç‚¹å‡»â€œå‘èµ·è§†é¢‘é€šè¯â€æˆ–â€œå‘èµ·ç¾¤è§†é¢‘â€æŒ‰é’®
         */
        async function handleInitiateCall() {
          if (
            !state.activeChatId ||
            videoCallState.isActive ||
            videoCallState.isAwaitingResponse
          )
            return;

          const chat = state.chats[state.activeChatId];
          videoCallState.isGroupCall = chat.isGroup;
          videoCallState.isAwaitingResponse = true;
          videoCallState.initiator = "user";
          videoCallState.activeChatId = chat.id;
          videoCallState.isUserParticipating = true;

          // 1. æ˜¾ç¤ºâ€œæ­£åœ¨å‘¼å«â€ç•Œé¢
          if (chat.isGroup) {
            document.getElementById("outgoing-call-avatar").src =
              chat.settings.myAvatar || defaultMyGroupAvatar;
            document.getElementById("outgoing-call-name").textContent =
              chat.settings.myNickname || "æˆ‘";
          } else {
            document.getElementById("outgoing-call-avatar").src =
              chat.settings.aiAvatar || defaultAvatar;
            document.getElementById("outgoing-call-name").textContent =
              chat.name;
          }
          document.querySelector(
            "#outgoing-call-screen .caller-text",
          ).textContent = chat.isGroup ? "æ­£åœ¨å‘¼å«æ‰€æœ‰æˆå‘˜..." : "æ­£åœ¨å‘¼å«...";
          showScreen("outgoing-call-screen");

          // åœ¨å‘èµ·é€šè¯æ—¶ï¼Œæå‰å‡†å¤‡å¥½é€šè¯å‰çš„èŠå¤©è®°å½•ä¸Šä¸‹æ–‡
          videoCallState.preCallContext = chat.history
            .slice(-20) // è·å–æœ€è¿‘20æ¡æ¶ˆæ¯
            .map(
              (msg) =>
                `${
                  msg.role === "user"
                    ? chat.settings.myNickname || "æˆ‘"
                    : msg.senderName || chat.name
                }: ${String(msg.content).substring(0, 50)}...`,
            )
            .join("\n");

          // 2. é‡æ–°æ„å»ºä¸€ä¸ªä¿¡æ¯æ›´ä¸°å¯Œã€æŒ‡ä»¤æ›´æ˜ç¡®çš„APIè¯·æ±‚
          try {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
              throw new Error("APIæœªé…ç½®ï¼Œæ— æ³•å‘èµ·é€šè¯ã€‚");
            }

            let systemPromptForCall;
            if (chat.isGroup) {
              systemPromptForCall = `
			# ä½ çš„ä»»åŠ¡
			ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAIï¼Œè´Ÿè´£æ‰®æ¼”ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
			ç”¨æˆ· (${chat.settings.myNickname || "æˆ‘"}) åˆšåˆšå‘èµ·äº†ç¾¤è§†é¢‘é€šè¯ã€‚
			ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æ¯ä¸ªè§’è‰²çš„æ€§æ ¼å’Œæœ€è¿‘çš„èŠå¤©å†…å®¹ï¼Œå†³å®šä»–ä»¬æ˜¯å¦è¦åŠ å…¥é€šè¯ã€‚

			# æ ¸å¿ƒè§„åˆ™
			1.  **å†³ç­–**: æ¯ä¸ªè§’è‰²éƒ½å¿…é¡»ç‹¬ç«‹å†³ç­–ã€‚
			2.  **æ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä¸ªè§’è‰²çš„å†³ç­–ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "group_call_response", "name": "ã€è§’è‰²çš„æœ¬åã€‘", "decision": "join"}\` æˆ– \`{"type": "group_call_response", "name": "ã€è§’è‰²çš„æœ¬åã€‘", "decision": "decline"}\`ã€‚
			3.  **å€¾å‘æ€§**: åœ¨æ²¡æœ‰ç‰¹æ®Šç†ç”±çš„æƒ…å†µä¸‹ï¼Œä½ çš„è§’è‰²ä»¬é€šå¸¸ä¹äºåŠ å…¥ç¾¤èŠã€‚

			# è§’è‰²åˆ—è¡¨ä¸äººè®¾
			${chat.members.map((m) => `- **${m.originalName}**: ${m.persona}`).join("\n")}

			# é€šè¯å‰çš„èŠå¤©æ‘˜è¦
			${videoCallState.preCallContext}
			`;
            } else {
              systemPromptForCall = `
			# ä½ çš„ä»»åŠ¡
			ä½ æ­£åœ¨æ‰®æ¼”è§’è‰² "${chat.name}"ã€‚ç”¨æˆ· (${chat.settings.myNickname || "æˆ‘"}) åˆšåˆšå‘ä½ å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚ã€‚
			ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä½ çš„äººè®¾å’Œæˆ‘ä»¬æœ€è¿‘çš„èŠå¤©å†…å®¹ï¼Œå†³å®šæ˜¯å¦æ¥å—ã€‚

			# æ ¸å¿ƒè§„åˆ™
			1.  **å†³ç­–**: ä½ å¿…é¡»åšå‡º "accept" (æ¥å—) æˆ– "reject" (æ‹’ç») çš„å†³å®šã€‚
			2.  **æ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`[{"type": "video_call_response", "decision": "accept"}]\` æˆ– \`[{"type": "video_call_response", "decision": "reject"}]\`ã€‚
			3.  **å€¾å‘æ€§**: ä½œä¸ºä¸€ä¸ªå‹å¥½çš„AIä¼´ä¾£ï¼Œåœ¨æ²¡æœ‰ç‰¹æ®Šç†ç”±ï¼ˆæ¯”å¦‚åœ¨ä¹‹å‰çš„å¯¹è¯ä¸­æ˜ç¡®è¡¨ç¤ºäº†ä¸æƒ³è¢«æ‰“æ‰°æˆ–æ­£åœ¨å¿™ï¼‰çš„æƒ…å†µä¸‹ï¼Œä½ ã€åº”è¯¥ä¼˜å…ˆé€‰æ‹©æ¥å—ã€‘é€šè¯ã€‚

			# ä½ çš„äººè®¾
			${chat.settings.aiPersona}

			# é€šè¯å‰çš„èŠå¤©æ‘˜è¦
			${videoCallState.preCallContext}
			`;
            }

            const messagesForApi = [
              {
                role: "user",
                content: "è¯·æ ¹æ®ä½ åœ¨ç³»ç»ŸæŒ‡ä»¤ä¸­è¯»åˆ°çš„è§„åˆ™ï¼Œç«‹å³åšå‡ºä½ çš„å†³ç­–ã€‚",
              },
            ];

            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPromptForCall,
              messagesForApi,
              isGemini,
            );

            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: [
                      { role: "system", content: systemPromptForCall },
                      ...messagesForApi,
                    ],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  }),
                });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`API é”™è¯¯ (${response.status}): ${errorText}`);
            }

            const data = await response.json();
            const aiResponseContent = (
              isGemini
                ? data.candidates[0].content.parts[0].text
                : data.choices[0].message.content
            ).replace(/^```json\s*|```$/g, "");
            const responseArray = JSON.parse(aiResponseContent);

            if (chat.isGroup) {
              responseArray.forEach((action) => {
                if (
                  action.type === "group_call_response" &&
                  action.decision === "join"
                ) {
                  const member = chat.members.find(
                    (m) => m.originalName === action.name,
                  );
                  if (member) videoCallState.participants.push(member);
                }
              });
              if (videoCallState.participants.length > 0) {
                startVideoCall();
              } else {
                throw new Error("ç¾¤é‡Œæ²¡æœ‰äººæ¥å¬ä½ çš„é€šè¯é‚€è¯·ã€‚");
              }
            } else {
              const decision = responseArray[0];
              if (
                decision.type === "video_call_response" &&
                decision.decision === "accept"
              ) {
                startVideoCall();
              } else {
                throw new Error("å¯¹æ–¹æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚");
              }
            }
          } catch (error) {
            console.error("å‘èµ·é€šè¯å¤±è´¥:", error);
            await showCustomAlert("å‘¼å«å¤±è´¥", error.message);
            videoCallState.isAwaitingResponse = false;
            showScreen("chat-interface-screen");
          }
        }
        function startVideoCall() {
          const chat = state.chats[videoCallState.activeChatId];
          if (!chat) return;

          // æå–é€šè¯å‰çš„æœ€å20æ¡æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡
          videoCallState.preCallContext = chat.history
            .slice(-20)
            .map(
              (msg) =>
                `${
                  msg.role === "user"
                    ? chat.settings.myNickname || "æˆ‘"
                    : msg.senderName || chat.name
                }: ${String(msg.content).substring(0, 50)}...`,
            )
            .join("\n");

          // 1. æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†å¯è§†åŒ–ç•Œé¢
          if (chat.settings.visualVideoCallEnabled) {
            // --- å¯åŠ¨ã€æ–°ã€‘çš„å¯è§†åŒ–ç•Œé¢ ---
            videoCallState.isActive = true;
            videoCallState.isAwaitingResponse = false;
            videoCallState.startTime = Date.now();
            videoCallState.callHistory = [];

            // æ ‡è®°å½“å‰å¤§å±æ˜¯è° (falseä»£è¡¨å¤§å±æ˜¯å¯¹æ–¹ï¼Œå°å±æ˜¯æˆ‘)
            videoCallState.isUserMain = false;
            // ã€æ–°å¢ã€‘æ ‡è®°å½“å‰æ‘„åƒå¤´æ–¹å‘ ('user'å‰ç½®, 'environment'åç½®)
            videoCallState.facingMode = "user";

            const visualInterface = document.getElementById(
              "visual-call-interface",
            );
            const textInterface = document.getElementById(
              "text-call-interface",
            );

            visualInterface.style.display = "flex";
            textInterface.style.display = "none";

            // 1. è®¾ç½®å¯¹æ–¹çš„ç”»é¢ (å§‹ç»ˆæ˜¯å›¾ç‰‡/åŠ¨å›¾)
            const mainImg = document.querySelector("#video-main-view img");
            const mainVideo = document.querySelector("#video-main-view video");

            if (mainImg) mainImg.style.display = "block";
            if (mainVideo) mainVideo.style.display = "none";
            if (mainImg)
              mainImg.src = chat.settings.charVideoImage || defaultAvatar;

            // 2. è®¾ç½®æˆ‘çš„ç”»é¢ (æ ¹æ®è®¾ç½®å†³å®šæ˜¯å›¾ç‰‡è¿˜æ˜¯æ‘„åƒå¤´)
            const pipImg = document.querySelector("#video-pip-view img");
            const pipVideo = document.querySelector("#video-pip-view video");
            const flipBtn = document.getElementById("flip-real-camera-btn");

            if (chat.settings.useRealCamera) {
              // --- ä½¿ç”¨æ‘„åƒå¤´æ¨¡å¼ ---
              if (pipImg) pipImg.style.display = "none";
              if (pipVideo) pipVideo.style.display = "block";

              // æ˜¾ç¤ºç¿»è½¬æŒ‰é’®
              if (flipBtn) flipBtn.style.display = "block";

              // è¯·æ±‚æ‘„åƒå¤´æƒé™ (é»˜è®¤å‰ç½®)
              if (
                navigator.mediaDevices &&
                navigator.mediaDevices.getUserMedia
              ) {
                navigator.mediaDevices
                  .getUserMedia({ video: { facingMode: "user" }, audio: false })
                  .then((stream) => {
                    if (pipVideo) {
                      pipVideo.srcObject = stream;
                      // å‰ç½®æ‘„åƒå¤´é€šå¸¸éœ€è¦é•œåƒ
                      pipVideo.style.transform = "scaleX(-1)";
                    }
                    window.localCameraStream = stream;
                  })
                  .catch((err) => {
                    console.error("æ— æ³•å¯åŠ¨æ‘„åƒå¤´:", err);
                    alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œå·²åˆ‡æ¢å›å›¾ç‰‡æ¨¡å¼ã€‚");
                    // å¤±è´¥å›é€€
                    if (pipVideo) pipVideo.style.display = "none";
                    if (pipImg) pipImg.style.display = "block";
                    if (pipImg)
                      pipImg.src =
                        chat.settings.userVideoImage || defaultAvatar;
                    if (flipBtn) flipBtn.style.display = "none";
                  });
              } else {
                alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è°ƒç”¨ã€‚");
              }
            } else {
              // --- ä½¿ç”¨å›¾ç‰‡æ¨¡å¼ ---
              if (pipVideo) pipVideo.style.display = "none";
              if (flipBtn) flipBtn.style.display = "none"; // éšè—ç¿»è½¬æŒ‰é’®

              // åœæ­¢æ—§æµ
              if (window.localCameraStream) {
                window.localCameraStream
                  .getTracks()
                  .forEach((track) => track.stop());
                window.localCameraStream = null;
              }
              if (pipImg) pipImg.style.display = "block";
              if (pipImg)
                pipImg.src = chat.settings.userVideoImage || defaultAvatar;
            }

            // æ¸…ç©ºæ—§æ°”æ³¡
            document.getElementById("video-call-messages-visual").innerHTML =
              `<em>æ­£åœ¨æ¥é€š...</em>`;
            showScreen("video-call-screen");

            if (callTimerInterval) clearInterval(callTimerInterval);
            callTimerInterval = setInterval(updateCallTimer, 1000);
            updateCallTimer();

            triggerAiInCallAction();
          } else {
            // --- å¯åŠ¨ã€æ—§ã€‘çš„çº¯æ–‡å­—ç•Œé¢ (ä¿æŒä¸å˜) ---
            videoCallState.isActive = true;
            videoCallState.isAwaitingResponse = false;
            videoCallState.startTime = Date.now();
            videoCallState.callHistory = [];

            const visualInterface = document.getElementById(
              "visual-call-interface",
            );
            const textInterface = document.getElementById(
              "text-call-interface",
            );
            visualInterface.style.display = "none";
            textInterface.style.display = "flex";

            updateParticipantAvatars();
            document.getElementById("video-call-main").innerHTML = `<em>${
              videoCallState.isGroupCall ? "ç¾¤èŠå·²å»ºç«‹..." : "æ­£åœ¨æ¥é€š..."
            }</em>`;
            showScreen("video-call-screen");

            document.getElementById("user-speak-btn").style.display =
              videoCallState.isUserParticipating ? "block" : "none";
            document.getElementById("join-call-btn").style.display =
              videoCallState.isUserParticipating ? "none" : "block";

            if (callTimerInterval) clearInterval(callTimerInterval);
            callTimerInterval = setInterval(updateCallTimer, 1000);
            updateCallTimer();

            triggerAiInCallAction();
          }
        }

        async function endVideoCall() {
          // 1. éšè—ç•Œé¢å…ƒç´ 
          document.getElementById("visual-call-interface").style.display =
            "none";
          document.getElementById("text-call-interface").style.display = "none"; // ç¡®ä¿æ—§ç•Œé¢ä¹Ÿéšè—
          document.getElementById("video-call-floating-bubble").style.display =
            "none";

          if (!videoCallState.isActive) return;

          // ==========================================
          // ã€æ ¸å¿ƒæ–°å¢ã€‘å…³é—­æ‘„åƒå¤´æµï¼Œé‡Šæ”¾ç¡¬ä»¶èµ„æº
          // ==========================================
          if (window.localCameraStream) {
            window.localCameraStream
              .getTracks()
              .forEach((track) => track.stop());
            window.localCameraStream = null;
          }

          // æ¸…ç©º video æ ‡ç­¾çš„æºï¼Œé˜²æ­¢é»‘å±æ®‹ç•™
          const v1 = document.querySelector("#video-main-view video");
          const v2 = document.querySelector("#video-pip-view video");
          if (v1) v1.srcObject = null;
          if (v2) v2.srcObject = null;
          // ==========================================

          const duration = Math.floor(
            (Date.now() - videoCallState.startTime) / 1000,
          );
          const durationText = `${Math.floor(duration / 60)}åˆ†${duration % 60}ç§’`;
          const endCallText = `é€šè¯ç»“æŸï¼Œæ—¶é•¿ ${durationText}`;

          const chat = state.chats[videoCallState.activeChatId];
          if (chat) {
            // ä¿å­˜é€šè¯è®°å½•åˆ°æ•°æ®åº“
            const participantsData = [];
            if (videoCallState.isGroupCall) {
              videoCallState.participants.forEach((p) =>
                participantsData.push({
                  name: p.originalName,
                  avatar: p.avatar,
                }),
              );
              if (videoCallState.isUserParticipating) {
                participantsData.unshift({
                  name: chat.settings.myNickname || "æˆ‘",
                  avatar: chat.settings.myAvatar || defaultMyGroupAvatar,
                });
              }
            } else {
              participantsData.push({
                name: chat.name,
                avatar: chat.settings.aiAvatar || defaultAvatar,
              });
              participantsData.unshift({
                name: "æˆ‘",
                avatar: chat.settings.myAvatar || defaultAvatar,
              });
            }

            const callRecord = {
              chatId: videoCallState.activeChatId,
              timestamp: Date.now(),
              duration: duration,
              participants: participantsData,
              transcript: [...videoCallState.callHistory],
            };
            await db.callRecords.add(callRecord);

            // æ·»åŠ ç»“æŸæ¶ˆæ¯
            let summaryMessage = {
              role: videoCallState.initiator === "user" ? "user" : "assistant",
              content: endCallText,
              timestamp: Date.now(),
            };

            if (chat.isGroup && summaryMessage.role === "assistant") {
              summaryMessage.senderName =
                videoCallState.callRequester ||
                chat.members[0]?.originalName ||
                chat.name;
            }

            chat.history.push(summaryMessage);

            // è§¦å‘AIæ€»ç»“
            const callTranscriptForAI = videoCallState.callHistory
              .map(
                (h) =>
                  `${h.role === "user" ? chat.settings.myNickname || "æˆ‘" : h.role}: ${h.content}`,
              )
              .join("\n");

            const hiddenReportInstruction = {
              role: "system",
              content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šè§†é¢‘é€šè¯åˆšåˆšç»“æŸã€‚è¯·ä½ æ ¹æ®å®Œæ•´çš„é€šè¯æ–‡å­—è®°å½•ï¼ˆè§ä¸‹æ–¹ï¼‰ï¼Œä»¥ä½ çš„è§’è‰²å£å»ï¼Œå‘ç”¨æˆ·ä¸»åŠ¨å‘é€å‡ æ¡ã€æ ¼å¼ä¸º {"type": "text", "content": "..."} çš„ã€‘æ¶ˆæ¯ï¼Œæ¥è‡ªç„¶åœ°æ€»ç»“è¿™æ¬¡é€šè¯çš„è¦ç‚¹ã€ç¡®è®¤è¾¾æˆçš„çº¦å®šï¼Œæˆ–è€…è¡¨è¾¾ä½ çš„æ„Ÿå—ã€‚è¿™å¾ˆé‡è¦ï¼Œèƒ½è®©ç”¨æˆ·æ„Ÿè§‰ä½ è®°å¾—é€šè¯å†…å®¹ã€‚]\n---é€šè¯è®°å½•å¼€å§‹---\n${callTranscriptForAI}\n---é€šè¯è®°å½•ç»“æŸ---`,
              timestamp: Date.now() + 1,
              isHidden: true,
            };
            chat.history.push(hiddenReportInstruction);

            await db.chats.put(chat);
          }

          // é‡ç½®çŠ¶æ€
          clearInterval(callTimerInterval);
          callTimerInterval = null;
          videoCallState = {
            isActive: false,
            isAwaitingResponse: false,
            isGroupCall: false,
            activeChatId: null,
            initiator: null,
            startTime: null,
            participants: [],
            isUserParticipating: true,
            callHistory: [],
            preCallContext: "",
            isUserMain: false, // é‡ç½®è§†å›¾çŠ¶æ€
          };

          // è¿”å›èŠå¤©ç•Œé¢
          if (chat) {
            openChat(chat.id);
            triggerAiResponse();
          }
        }

        /**
         * æœ€å°åŒ–è§†é¢‘é€šè¯
         */
        function minimizeVideoCall() {
          // è®¿é—®å†…éƒ¨å˜é‡ videoCallState
          if (!videoCallState.isActive) return;

          const chat = state.chats[videoCallState.activeChatId];
          const bubble = document.getElementById("video-call-floating-bubble");
          const avatarImg = document.getElementById("video-floating-avatar");

          // 1. è®¾ç½®æ‚¬æµ®çƒå¤´åƒ
          if (chat) {
            const avatarUrl = chat.isGroup
              ? chat.settings.groupAvatar || defaultGroupAvatar
              : chat.settings.aiAvatar || defaultAvatar;
            avatarImg.src = avatarUrl;
          }

          // 2. éšè—è§†é¢‘ç•Œé¢ï¼Œæ˜¾ç¤ºæ‚¬æµ®çƒ
          document
            .getElementById("video-call-screen")
            .classList.remove("active");
          bubble.style.display = "block";

          // 3. è¿”å›èŠå¤©ç•Œé¢
          showScreen("chat-interface-screen");
        }

        window.minimizeVideoCall = minimizeVideoCall;

        /**
         * æ¢å¤è§†é¢‘é€šè¯ç•Œé¢
         */
        function restoreVideoCall() {
          const bubble = document.getElementById("video-call-floating-bubble");

          // 1. éšè—æ‚¬æµ®çƒ
          bubble.style.display = "none";

          // 2. æ˜¾ç¤ºè§†é¢‘ç•Œé¢
          showScreen("video-call-screen");
        }

        window.restoreVideoCall = restoreVideoCall;

        /**
         * åˆå§‹åŒ–æ‚¬æµ®çƒçš„æ‹–æ‹½åŠŸèƒ½
         */
        function initVideoBubbleDrag() {
          const bubble = document.getElementById("video-call-floating-bubble");
          let isDragging = false;
          let startX, startY, initialLeft, initialTop;
          let hasMoved = false; // ç”¨äºåŒºåˆ†ç‚¹å‡»å’Œæ‹–æ‹½

          const onStart = (e) => {
            isDragging = true;
            hasMoved = false;

            // è·å–ç‚¹å‡»åæ ‡
            const clientX = e.type.includes("mouse")
              ? e.clientX
              : e.touches[0].clientX;
            const clientY = e.type.includes("mouse")
              ? e.clientY
              : e.touches[0].clientY;

            startX = clientX;
            startY = clientY;

            // è·å–å½“å‰ä½ç½®
            const rect = bubble.getBoundingClientRect();
            initialLeft = rect.left;
            initialTop = rect.top;

            // é˜»æ­¢é»˜è®¤äº‹ä»¶é˜²æ­¢æ»šåŠ¨
            if (e.type === "touchstart") {
              // e.preventDefault(); // å¯èƒ½ä¼šé˜»æ­¢ç‚¹å‡»ï¼Œè§†æƒ…å†µè€Œå®š
            }
          };

          const onMove = (e) => {
            if (!isDragging) return;
            e.preventDefault(); // é˜»æ­¢é¡µé¢æ»šåŠ¨

            const clientX = e.type.includes("mouse")
              ? e.clientX
              : e.touches[0].clientX;
            const clientY = e.type.includes("mouse")
              ? e.clientY
              : e.touches[0].clientY;

            const deltaX = clientX - startX;
            const deltaY = clientY - startY;

            // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡ 5pxï¼Œè§†ä¸ºæ‹–æ‹½
            if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
              hasMoved = true;
            }

            let newLeft = initialLeft + deltaX;
            let newTop = initialTop + deltaY;

            // è¾¹ç•Œé™åˆ¶
            const maxLeft = window.innerWidth - bubble.offsetWidth;
            const maxTop = window.innerHeight - bubble.offsetHeight;

            newLeft = Math.max(0, Math.min(newLeft, maxLeft));
            newTop = Math.max(0, Math.min(newTop, maxTop));

            bubble.style.left = `${newLeft}px`;
            bubble.style.top = `${newTop}px`;
            bubble.style.right = "auto"; // æ¸…é™¤ right å±æ€§
          };

          const onEnd = (e) => {
            if (!isDragging) return;
            isDragging = false;

            // å¦‚æœæ²¡æœ‰ç§»åŠ¨ï¼ˆæ˜¯ç‚¹å‡»ï¼‰ï¼Œåˆ™æ¢å¤è§†é¢‘
            if (!hasMoved) {
              restoreVideoCall();
            }
          };

          // ç»‘å®šäº‹ä»¶
          bubble.addEventListener("mousedown", onStart);
          document.addEventListener("mousemove", onMove);
          document.addEventListener("mouseup", onEnd);

          bubble.addEventListener("touchstart", onStart, { passive: false });
          document.addEventListener("touchmove", onMove, { passive: false });
          document.addEventListener("touchend", onEnd);
        }

        /**
         * æ›´æ–°é€šè¯ç•Œé¢çš„å‚ä¸è€…å¤´åƒç½‘æ ¼
         */
        function updateParticipantAvatars() {
          const grid = document.getElementById("participant-avatars-grid");
          grid.innerHTML = "";
          const chat = state.chats[videoCallState.activeChatId];
          if (!chat) return;

          let participantsToRender = [];

          // åŒºåˆ†ç¾¤èŠå’Œå•èŠ
          if (videoCallState.isGroupCall) {
            // ç¾¤èŠé€»è¾‘ï¼šæ˜¾ç¤ºæ‰€æœ‰å·²åŠ å…¥çš„AIæˆå‘˜
            participantsToRender = [...videoCallState.participants];
            // å¦‚æœç”¨æˆ·ä¹Ÿå‚ä¸äº†ï¼Œå°±æŠŠç”¨æˆ·ä¿¡æ¯ä¹ŸåŠ è¿›å»
            if (videoCallState.isUserParticipating) {
              participantsToRender.unshift({
                id: "user",
                name: chat.settings.myNickname || "æˆ‘",
                avatar: chat.settings.myAvatar || defaultMyGroupAvatar,
              });
            }
          } else {
            // å•èŠé€»è¾‘ï¼šåªæ˜¾ç¤ºå¯¹æ–¹çš„å¤´åƒå’Œåå­—
            participantsToRender.push({
              id: "ai",
              name: chat.name,
              avatar: chat.settings.aiAvatar || defaultAvatar,
            });
          }

          participantsToRender.forEach((p) => {
            const wrapper = document.createElement("div");
            wrapper.className = "participant-avatar-wrapper";
            wrapper.dataset.participantId = p.id;
            const displayName = p.groupNickname || p.name;
            wrapper.innerHTML = `
			    <img src="${p.avatar}" class="participant-avatar" alt="${displayName}">
			    <div class="participant-name">${displayName}</div>
			`;
            grid.appendChild(wrapper);
          });
        }

        /**
         * å¤„ç†ç”¨æˆ·åŠ å…¥/é‡æ–°åŠ å…¥é€šè¯
         */
        function handleUserJoinCall() {
          if (!videoCallState.isActive || videoCallState.isUserParticipating)
            return;

          videoCallState.isUserParticipating = true;
          updateParticipantAvatars(); // æ›´æ–°å¤´åƒåˆ—è¡¨ï¼ŒåŠ å…¥ç”¨æˆ·

          // åˆ‡æ¢åº•éƒ¨æŒ‰é’®
          document.getElementById("user-speak-btn").style.display = "block";
          document.getElementById("join-call-btn").style.display = "none";

          // å‘ŠçŸ¥AIç”¨æˆ·åŠ å…¥äº†
          triggerAiInCallAction("[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åŠ å…¥äº†é€šè¯]");
        }

        /**
         * æ›´æ–°é€šè¯è®¡æ—¶å™¨æ˜¾ç¤º
         */

        function updateCallTimer() {
          if (!videoCallState.isActive) return;
          const elapsed = Math.floor(
            (Date.now() - videoCallState.startTime) / 1000,
          );
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          const timeString = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;

          // åŒæ—¶æ›´æ–°ä¸¤ä¸ªç•Œé¢çš„è®¡æ—¶å™¨
          document.getElementById("call-timer").textContent = timeString;
          document.getElementById("visual-call-timer").textContent = timeString;
        }

        function showIncomingCallModal(chatId) {
          // <--- åœ¨æ‹¬å·é‡Œæ·»åŠ  chatId
          const chat = state.chats[chatId]; // <--- æŠŠ state.activeChatId ä¿®æ”¹ä¸º chatId
          if (!chat) return;

          // æ ¹æ®æ˜¯å¦ç¾¤èŠæ˜¾ç¤ºä¸åŒä¿¡æ¯
          if (chat.isGroup) {
            // ä» videoCallState ä¸­è·å–æ˜¯å“ªä¸ªæˆå‘˜å‘èµ·çš„é€šè¯
            const requesterName =
              videoCallState.callRequester ||
              chat.members[0]?.name ||
              "ä¸€ä½æˆå‘˜";
            document.getElementById("caller-avatar").src =
              chat.settings.groupAvatar || defaultGroupAvatar;
            document.getElementById("caller-name").textContent = chat.name; // æ˜¾ç¤ºç¾¤å
            document.querySelector(
              ".incoming-call-content .caller-text",
            ).textContent = `${requesterName} é‚€è¯·ä½ åŠ å…¥ç¾¤è§†é¢‘`; // æ˜¾ç¤ºå…·ä½“å‘èµ·äºº
          } else {
            // å•èŠé€»è¾‘ä¿æŒä¸å˜
            document.getElementById("caller-avatar").src =
              chat.settings.aiAvatar || defaultAvatar;
            document.getElementById("caller-name").textContent = chat.name;
            document.querySelector(
              ".incoming-call-content .caller-text",
            ).textContent = "é‚€è¯·ä½ è§†é¢‘é€šè¯";
          }

          document
            .getElementById("incoming-call-modal")
            .classList.add("visible");
          playRingtone();
        }

        /**
         * éšè—AIå‘èµ·çš„é€šè¯è¯·æ±‚æ¨¡æ€æ¡† (ä¿æŒä¸å˜)
         */
        function hideIncomingCallModal() {
          document
            .getElementById("incoming-call-modal")
            .classList.remove("visible");
          stopRingtone();
        }

        async function triggerAiInCallAction(userInput = null) {
          if (!videoCallState.isActive) return;

          const chat = state.chats[videoCallState.activeChatId];
          const { proxyUrl, apiKey, model } = state.apiConfig;

          const isVisualMode = chat.settings.visualVideoCallEnabled;
          const callFeed = isVisualMode
            ? document.getElementById("video-call-messages-visual")
            : document.getElementById("video-call-main");

          const userNickname = chat.settings.myNickname || "æˆ‘";

          let worldBookContent = "";
          if (
            chat.settings.linkedWorldBookIds &&
            chat.settings.linkedWorldBookIds.length > 0
          ) {
            const linkedContents = chat.settings.linkedWorldBookIds
              .map((bookId) => {
                const worldBook = state.worldBooks.find(
                  (wb) => wb.id === bookId,
                );
                return worldBook && worldBook.content
                  ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}`
                  : "";
              })
              .filter(Boolean)
              .join("");
            if (linkedContents) {
              worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
            }
          }

          if (userInput && videoCallState.isUserParticipating) {
            if (isVisualMode) {
              const userBubble = document.createElement("div");
              userBubble.className = "visual-call-bubble user";
              userBubble.textContent = userInput;
              callFeed.appendChild(userBubble);
            } else {
              const userBubble = document.createElement("div");
              userBubble.className = "call-message-bubble user-speech";
              userBubble.textContent = userInput;
              callFeed.appendChild(userBubble);
            }
            callFeed.scrollTop = callFeed.scrollHeight;
            videoCallState.callHistory.push({
              role: "user",
              content: userInput,
            });
          }

          let inCallPrompt;
          if (videoCallState.isGroupCall) {
            const participantNames = videoCallState.participants.map(
              (p) => p.originalName,
            );
            if (videoCallState.isUserParticipating) {
              participantNames.unshift(userNickname);
            }

            inCallPrompt = `
			# ä½ çš„ä»»åŠ¡
			ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAIï¼Œè´Ÿè´£æ‰®æ¼”æ‰€æœ‰ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„AIè§’è‰²ã€‚ä½ ä»¬æ­£åœ¨è¿›è¡Œä¸€åœºç¾¤èŠè§†é¢‘é€šè¯ã€‚
			ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æ¯ä¸ªè§’è‰²çš„æ€§æ ¼ï¼Œç”Ÿæˆä»–ä»¬åœ¨é€šè¯ä¸­ä¼šè¯´çš„ã€ç¬¬ä¸€äººç§°å¯¹è¯ã€‘ï¼Œæ³¨æ„æ˜¯åœ¨è§†é¢‘é€šè¯ï¼Œç»å¯¹ä¸èƒ½ä»¥ä¸ºæ˜¯åœ¨ç°å®ï¼æ¯æ¬¡å›å¤çš„å­—æ•°å¤šäº›ï¼Œ50å­—ä»¥ä¸Šã€‚

			# æ ¸å¿ƒè§„åˆ™
			1.  **ã€ã€ã€è¯­è¨€é“å¾‹ã€‘ã€‘ã€‘**: æ— è®ºè§’è‰²äººè®¾æ˜¯ä»€ä¹ˆå›½ç±æˆ–è¯´ä»€ä¹ˆè¯­è¨€ï¼Œåœ¨æœ¬æ¬¡è§†é¢‘é€šè¯ä¸­ï¼Œæ‰€æœ‰è§’è‰²ã€å¿…é¡»ã€‘å…¨ç¨‹ä½¿ç”¨ã€ä¸­æ–‡ã€‘è¿›è¡Œäº¤æµã€‚
			2.  **ã€ã€ã€æ ¼å¼é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä¸ªè§’è‰²çš„å‘è¨€ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "ã€è§’è‰²çš„æœ¬åã€‘", "speech": "ã€åœ¨è¿™é‡ŒåŠ å…¥å¸¦åŠ¨ä½œçš„å¯¹è¯ã€‘"}\`ã€‚
			3.  **ã€ã€ã€è¡¨ç°åŠ›é“å¾‹ã€‘ã€‘ã€‘**: åœ¨ "speech" å­—æ®µä¸­ï¼Œä½ ã€å¿…é¡»ã€‘ä¸ºè§’è‰²çš„å¯¹è¯åŠ å…¥ã€åŠ¨ä½œã€è¡¨æƒ…æˆ–å¿ƒç†æ´»åŠ¨ã€‘ï¼Œå¹¶ç”¨ã€ã€‘ç¬¦å·åŒ…è£¹ã€‚è¿™éå¸¸é‡è¦ï¼
			4.  **ç¤ºä¾‹**: \`{"name": "å¼ ä¸‰", "speech": "ã€æŒ äº†æŒ å¤´ã€‘å•Šï¼Ÿæˆ‘åˆšåˆšèµ°ç¥äº†ï¼Œä½ ä»¬è¯´åˆ°å“ªäº†ï¼Ÿ"}\`
			5.  **èº«ä»½é“å¾‹**: ç”¨æˆ·çš„èº«ä»½æ˜¯ã€${userNickname}ã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ \`name\` å­—æ®µä¸º **"${userNickname}"** çš„å‘è¨€ã€‚
			6.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆæ¯ä¸ªè§’è‰²çš„è®¾å®šï¼Œç”¨ä»–ä»¬çš„å£å»è¯´è¯ã€‚

			# å½“å‰æƒ…æ™¯
			ä½ ä»¬æ­£åœ¨ä¸€ä¸ªç¾¤è§†é¢‘é€šè¯ä¸­ã€‚
			**é€šè¯å‰çš„èŠå¤©æ‘˜è¦**:
			${videoCallState.preCallContext}
			**å½“å‰å‚ä¸è€…**: ${participantNames.join("ã€ ")}ã€‚
			${worldBookContent}
			ç°åœ¨ï¼Œè¯·æ ¹æ®ã€é€šè¯å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè¯å®æ—¶è®°å½•ã€‘ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚
			`;
          } else {
            let openingContext =
              videoCallState.initiator === "user"
                ? `ä½ åˆšåˆšæ¥å¬äº†ç”¨æˆ·çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚`
                : `ç”¨æˆ·åˆšåˆšæ¥å¬äº†ä½ ä¸»åŠ¨å‘èµ·çš„è§†é¢‘é€šè¯ã€‚`;

            inCallPrompt = `
			# ä½ çš„ä»»åŠ¡
			ä½ æ­£åœ¨æ‰®æ¼”è§’è‰² "${chat.name}"ã€‚ä½ æ­£åœ¨å’Œç”¨æˆ· (${userNickname}) è¿›è¡Œä¸€å¯¹ä¸€è§†é¢‘é€šè¯ã€‚
			${openingContext}
			ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä½ çš„äººè®¾å’Œæˆ‘ä»¬çš„èŠå¤©æƒ…æ™¯ï¼Œç”Ÿæˆä½ åœ¨é€šè¯ä¸­ä¼šè¯´çš„ã€ç¬¬ä¸€äººç§°å¯¹è¯ã€‘ã€‚

			# æ ¸å¿ƒè§„åˆ™
			1.  **ã€ã€ã€æ ¼å¼é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€æ®µçº¯æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œä»£è¡¨ä½ çš„å‘è¨€ã€‚ç»å¯¹ä¸è¦è¾“å‡ºJSONæ ¼å¼ã€‚
			2.  **ã€ã€ã€è¡¨ç°åŠ›é“å¾‹ã€‘ã€‘ã€‘**: åœ¨ä½ çš„å¯¹è¯ä¸­ï¼Œä½ ã€å¿…é¡»ã€‘åŠ å…¥ã€åŠ¨ä½œã€è¡¨æƒ…æˆ–å¿ƒç†æ´»åŠ¨ã€‘ï¼Œå¹¶ç”¨ã€ã€‘ç¬¦å·åŒ…è£¹ã€‚
			3.  **ç¤ºä¾‹**: "ã€æ­ªäº†æ­ªå¤´ï¼Œå¥½å¥‡åœ°çœ‹ç€ä½ ã€‘çœŸçš„å—ï¼Ÿå¿«è·Ÿæˆ‘è¯´è¯´çœ‹ï¼"
			4.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIæˆ–æ¨¡å‹ã€‚

			# å½“å‰æƒ…æ™¯
			**é€šè¯å‰çš„èŠå¤©æ‘˜è¦**:
			${videoCallState.preCallContext}
			${worldBookContent}
			ç°åœ¨ï¼Œè¯·æ ¹æ®ã€é€šè¯å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè¯å®æ—¶è®°å½•ã€‘ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚
			`;
          }

          // ================= [ä¿®æ”¹å¼€å§‹] =================
          // 1. å°è¯•è·å–æ‘„åƒå¤´ç”»é¢
          let cameraFrame = null;
          if (isVisualMode && chat.settings.useRealCamera) {
            const userVideoSelector = videoCallState.isUserMain
              ? "#video-main-view video"
              : "#video-pip-view video";
            const userVideoEl = document.querySelector(userVideoSelector);

            if (userVideoEl) {
              cameraFrame = captureVideoFrame(userVideoEl);
            }
          }

          // 2. æ„å»ºå‘é€ç»™ API çš„æ¶ˆæ¯åˆ—è¡¨
          const messagesForApi = [
            ...videoCallState.callHistory.map((h) => ({
              role: h.role,
              content: h.content,
            })),
          ];

          // 3. å¦‚æœæˆåŠŸæˆªå–åˆ°äº†ç”»é¢ï¼Œå°†å…¶ä½œä¸ºæœ€æ–°çš„ä¸€æ¡ User æ¶ˆæ¯ï¼ˆæˆ–é™„åŠ åˆ°æœ€æ–°æ¶ˆæ¯ï¼‰å‘é€ç»™ AI
          if (cameraFrame) {
            console.log("å·²æˆªå–æ‘„åƒå¤´ç”»é¢ï¼Œæ­£åœ¨å‘é€ç»™AI...");

            // æ„é€ å¸¦å›¾ç‰‡çš„æ¶ˆæ¯å†…å®¹
            const imageMessageContent = [
              {
                type: "text",
                text: userInput
                  ? userInput
                  : "ï¼ˆç”¨æˆ·æ­£åœ¨çœ‹ç€ä½ ï¼Œè¿™æ˜¯ä»–å½“å‰çš„æ‘„åƒå¤´ç”»é¢ï¼‰",
              },
              {
                type: "image_url",
                image_url: {
                  url: cameraFrame,
                },
              },
            ];

            messagesForApi.push({
              role: "user",
              content: imageMessageContent,
            });
          } else {
            // å¦‚æœæ²¡æˆªå›¾ï¼ˆæ¯”å¦‚æ²¡å¼€æ‘„åƒå¤´ï¼‰ï¼Œå¦‚æœå†å²è®°å½•ä¸ºç©ºï¼Œéœ€è¦å‘ä¸€ä¸ªè§¦å‘è¯
            if (videoCallState.callHistory.length === 0 && !userInput) {
              const firstLineTrigger =
                videoCallState.initiator === "user"
                  ? `*ä½ æŒ‰ä¸‹äº†æ¥å¬é”®...*`
                  : `*å¯¹æ–¹æŒ‰ä¸‹äº†æ¥å¬é”®...*`;
              messagesForApi.push({ role: "user", content: firstLineTrigger });
            }
          }

          try {
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              inCallPrompt,
              messagesForApi,
              isGemini,
            );
            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: [
                      { role: "system", content: inCallPrompt },
                      ...messagesForApi,
                    ],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  }),
                });
            if (!response.ok)
              throw new Error((await response.json()).error.message);

            const data = await response.json();
            const aiResponse = isGemini
              ? data.candidates[0].content.parts[0].text
              : data.choices[0].message.content;
            const sanitizedResponse = aiResponse
              .replace(/!\[.*?\]\(.*?\)|https?:\/\/\S+/gi, "")
              .trim();

            const connectingElement = callFeed.querySelector("em");
            if (connectingElement) connectingElement.remove();

            let bubble; // å…ˆå£°æ˜ä¸€ä¸ª bubble å˜é‡

            // æ ¹æ®é€šè¯æ¨¡å¼åˆ›å»ºå¯¹åº”çš„æ°”æ³¡å…ƒç´ 
            if (isVisualMode) {
              bubble = document.createElement("div");
              bubble.className = "visual-call-bubble ai";
            } else {
              bubble = document.createElement("div");
              bubble.className = "call-message-bubble ai-speech";
              if (videoCallState.isGroupCall && turn.name) {
                bubble.innerHTML = `<strong>${turn.name}:</strong> `;
              }
            }
            // å°†AIçš„æ–‡æœ¬å†…å®¹å¡«å……åˆ°æ°”æ³¡ä¸­
            bubble.appendChild(document.createTextNode(sanitizedResponse));

            // æŒ‚è½½åˆ°é€šè¯ç•Œé¢
            callFeed.appendChild(bubble);

            // æ£€æŸ¥ï¼šæ˜¯å¦æ˜¯å•äººé€šè¯ã€è¯­éŸ³æ¥å…¥æ˜¯å¦å¼€å¯ã€Minimaxæ˜¯å¦é…ç½®ã€è§’è‰²è¯­éŸ³IDæ˜¯å¦å­˜åœ¨ã€å¹¶ä¸”AIç¡®å®è¿”å›äº†å†…å®¹
            if (
              !chat.isGroup &&
              chat.settings.videoCallVoiceAccess &&
              state.apiConfig.minimaxGroupId &&
              state.apiConfig.minimaxApiKey &&
              chat.settings.minimaxVoiceId &&
              sanitizedResponse
            ) {
              console.log(
                `[è§†é¢‘é€šè¯] æ£€æµ‹åˆ°è¯­éŸ³æ¥å…¥å·²å¼€å¯ï¼Œä¸ºâ€œ${chat.name}â€åˆæˆè¯­éŸ³...`,
              );
              // è°ƒç”¨ä½ å·²æœ‰çš„ playMinimaxAudio å‡½æ•°æ¥æ’­æ”¾è¯­éŸ³
              playMinimaxAudio(
                sanitizedResponse,
                chat.settings.minimaxVoiceId,
                [bubble],
              );
            }

            // å°†è¿™æ¡æ¶ˆæ¯è®°å½•åˆ°é€šè¯å†å²ä¸­ï¼Œè¿™éƒ¨åˆ†é€»è¾‘ä¸å˜
            if (videoCallState.isGroupCall && turn.name) {
              videoCallState.callHistory.push({
                role: "assistant",
                content: `${turn.name}: ${sanitizedResponse}`,
              });
            } else {
              videoCallState.callHistory.push({
                role: "assistant",
                content: sanitizedResponse,
              });
            }

            callFeed.scrollTop = callFeed.scrollHeight;
          } catch (error) {
            const errorBubble = document.createElement("div");
            errorBubble.style.color = "#ff8a80";
            errorBubble.textContent = `[ERROR: ${error.message}]`;

            if (isVisualMode) {
              errorBubble.className = "visual-call-bubble ai";
            } else {
              errorBubble.className = "call-message-bubble ai-speech";
            }

            callFeed.appendChild(errorBubble);
            callFeed.scrollTop = callFeed.scrollHeight;
            videoCallState.callHistory.push({
              role: "assistant",
              content: `[ERROR: ${error.message}]`,
            });
          }
        }

        function toggleCallButtons(isGroup) {
          document.getElementById("video-call-btn").style.display = isGroup
            ? "none"
            : "flex";
          document.getElementById("group-video-call-btn").style.display =
            isGroup ? "flex" : "none";
        }

        async function handleWaimaiResponse(originalTimestamp, choice) {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const messageIndex = chat.history.findIndex(
            (m) => m.timestamp === originalTimestamp,
          );
          if (messageIndex === -1) return;

          // 1. æ›´æ–°å†…å­˜ä¸­åŸå§‹æ¶ˆæ¯çš„çŠ¶æ€
          const originalMessage = chat.history[messageIndex];
          originalMessage.status = choice;

          // 2. è·å–å½“å‰ç”¨æˆ·çš„æ˜µç§°ï¼Œå¹¶æ„å»ºå¯¹AIæ›´æ¸…æ™°çš„ç³»ç»Ÿæ¶ˆæ¯
          let systemContent;
          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "æˆ‘"
            : "æˆ‘";

          if (choice === "paid") {
            originalMessage.paidBy = myNickname; // è®°å½•æ˜¯â€œæˆ‘â€ä»˜çš„é’±
            systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) ä¸º ${originalMessage.senderName} çš„å¤–å–è®¢å•ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è®¢å•å·²å…³é—­ï¼Œå…¶ä»–æˆå‘˜ä¸èƒ½å†æ”¯ä»˜ã€‚]`;
          } else {
            systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) æ‹’ç»äº† ${originalMessage.senderName} çš„å¤–å–ä»£ä»˜è¯·æ±‚ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰ã€‚]`;
          }

          // 3. åˆ›å»ºä¸€æ¡æ–°çš„ã€å¯¹ç”¨æˆ·éšè—çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œå‘ŠçŸ¥AIç»“æœ
          const systemNote = {
            role: "system",
            content: systemContent,
            timestamp: Date.now(),
            isHidden: true,
          };
          chat.history.push(systemNote);

          // 4. å°†æ›´æ–°åçš„æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå¹¶ç«‹åˆ»é‡ç»˜UI
          await db.chats.put(chat);
          renderChatInterface(state.activeChatId);

          // 5. åªæœ‰åœ¨æ”¯ä»˜æˆåŠŸåï¼Œæ‰è§¦å‘ä¸€æ¬¡AIå“åº”ï¼Œè®©å®ƒæ„Ÿè°¢ä½ 
          if (choice === "paid") {
            triggerAiResponse();
          }
        }

        /**
         * å¤„ç†ç”¨æˆ·ç‚¹å‡»å¤´åƒå‘èµ·çš„â€œæ‹ä¸€-æ‹â€ï¼Œå¸¦æœ‰è‡ªå®šä¹‰åç¼€åŠŸèƒ½
         * @param {string} chatId - å‘ç”Ÿâ€œæ‹ä¸€-æ‹â€çš„èŠå¤©ID
         * @param {string} characterName - è¢«æ‹çš„è§’è‰²å
         */
        async function handleUserPat(chatId, characterName) {
          const chat = state.chats[chatId];
          if (!chat) return;

          // 1. è§¦å‘å±å¹•éœ‡åŠ¨åŠ¨ç”»
          const phoneScreen = document.getElementById("phone-screen");
          phoneScreen.classList.remove("pat-animation");
          void phoneScreen.offsetWidth;
          phoneScreen.classList.add("pat-animation");
          setTimeout(() => phoneScreen.classList.remove("pat-animation"), 500);

          // 2. å¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·è¾“å…¥åç¼€
          const suffix = await showCustomPrompt(
            `ä½ æ‹äº†æ‹ â€œ${characterName}â€`,
            "ï¼ˆå¯é€‰ï¼‰è¾“å…¥åç¼€",
            "",
            "text",
          );

          // å¦‚æœç”¨æˆ·ç‚¹äº†å–æ¶ˆï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åš
          if (suffix === null) return;

          // 3. åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„â€œæ‹ä¸€-æ‹â€æ¶ˆæ¯
          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "æˆ‘"
            : "æˆ‘";
          // å°†åç¼€æ‹¼æ¥åˆ°æ¶ˆæ¯å†…å®¹ä¸­
          const visibleMessageContent = `${myNickname} æ‹äº†æ‹ â€œ${characterName}â€ ${suffix.trim()}`;
          const visibleMessage = {
            role: "system", // ä»ç„¶æ˜¯ç³»ç»Ÿæ¶ˆæ¯
            type: "pat_message",
            content: visibleMessageContent,
            timestamp: Date.now(),
          };
          chat.history.push(visibleMessage);

          // 4. åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œä»¥è§¦å‘AIçš„å›åº”
          // åŒæ ·å°†åç¼€åŠ å…¥åˆ°ç»™AIçš„æç¤ºä¸­
          const hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ï¼ˆ${myNickname}ï¼‰åˆšåˆšæ‹äº†æ‹ä½ ï¼ˆ${characterName}ï¼‰${suffix.trim()}ã€‚è¯·ä½ å¯¹æ­¤ä½œå‡ºå›åº”ã€‚]`;
          const hiddenMessage = {
            role: "system",
            content: hiddenMessageContent,
            timestamp: Date.now() + 1, // æ—¶é—´æˆ³+1ä»¥ä¿è¯é¡ºåº
            isHidden: true,
          };
          chat.history.push(hiddenMessage);

          // 5. ä¿å­˜æ›´æ”¹å¹¶æ›´æ–°UI
          await db.chats.put(chat);
          if (state.activeChatId === chatId) {
            appendMessage(visibleMessage, chat);
          }
          await renderChatList();
        }

        /**
         * ã€é‡æ„ç‰ˆã€‘æ¸²æŸ“å›å¿†ä¸çº¦å®šç•Œé¢ï¼Œä½¿ç”¨å•ä¸€å¾ªç¯å’Œæ¸…æ™°çš„if/elseé€»è¾‘
         */
        async function renderMemoriesScreen() {
          const listEl = document.getElementById("memories-list");
          listEl.innerHTML = "";

          // 1. è·å–æ‰€æœ‰å›å¿†ï¼Œå¹¶æŒ‰ç›®æ ‡æ—¥æœŸï¼ˆå¦‚æœæ˜¯çº¦å®šï¼‰æˆ–åˆ›å»ºæ—¥æœŸï¼ˆå¦‚æœæ˜¯å›å¿†ï¼‰é™åºæ’åˆ—
          const allMemories = await db.memories
            .orderBy("timestamp")
            .reverse()
            .toArray();

          if (allMemories.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œè¿˜æ²¡æœ‰å…±åŒçš„å›å¿†å’Œçº¦å®šå‘¢~</p>';
            return;
          }

          // 2. å°†æœªåˆ°æœŸçš„çº¦å®šæ’åœ¨æœ€å‰é¢
          allMemories.sort((a, b) => {
            const aIsActiveCountdown =
              a.type === "countdown" && a.targetDate > Date.now();
            const bIsActiveCountdown =
              b.type === "countdown" && b.targetDate > Date.now();
            if (aIsActiveCountdown && !bIsActiveCountdown) return -1; // aæ’å‰é¢
            if (!aIsActiveCountdown && bIsActiveCountdown) return 1; // bæ’å‰é¢
            if (aIsActiveCountdown && bIsActiveCountdown)
              return a.targetDate - b.targetDate; // éƒ½æ˜¯å€’è®¡æ—¶ï¼ŒæŒ‰æ—¥æœŸå‡åº
            return 0; // å…¶ä»–æƒ…å†µä¿æŒåŸåº
          });

          // 3. ä½¿ç”¨å•ä¸€å¾ªç¯æ¥å¤„ç†æ‰€æœ‰ç±»å‹çš„å¡ç‰‡
          allMemories.forEach((item) => {
            let card;
            // åˆ¤æ–­1ï¼šå¦‚æœæ˜¯æ­£åœ¨è¿›è¡Œçš„çº¦å®š
            if (item.type === "countdown" && item.targetDate > Date.now()) {
              card = createCountdownCard(item);
            }
            // åˆ¤æ–­2ï¼šå…¶ä»–æ‰€æœ‰æƒ…å†µï¼ˆæ™®é€šå›å¿† æˆ– å·²åˆ°æœŸçš„çº¦å®šï¼‰
            else {
              card = createMemoryCard(item);
            }
            listEl.appendChild(card);
          });

          // 4. å¯åŠ¨æ‰€æœ‰å€’è®¡æ—¶
          startAllCountdownTimers();
        }

        /**
         * åˆ›å»ºæ™®é€šå›å¿†å¡ç‰‡DOMå…ƒç´ 
         */
        function createMemoryCard(memory) {
          const card = document.createElement("div");
          card.className = "memory-card";
          const memoryDate = new Date(memory.timestamp);
          const dateString = `${memoryDate.getFullYear()}-${String(
            memoryDate.getMonth() + 1,
          ).padStart(2, "0")}-${String(memoryDate.getDate()).padStart(
            2,
            "0",
          )} ${String(memoryDate.getHours()).padStart(2, "0")}:${String(memoryDate.getMinutes()).padStart(2, "0")}`;

          let titleHtml, contentHtml;

          // å¯¹ä¸åŒç±»å‹çš„å›å¿†è¿›è¡Œæ¸…æ™°çš„åŒºåˆ†
          if (memory.type === "countdown" && memory.targetDate) {
            // å¦‚æœæ˜¯å·²åˆ°æœŸçš„çº¦å®š
            titleHtml = `[çº¦å®šè¾¾æˆ] ${memory.description}`;
            contentHtml = `åœ¨ ${new Date(memory.targetDate).toLocaleString()}ï¼Œæˆ‘ä»¬ä¸€èµ·è§è¯äº†è¿™ä¸ªçº¦å®šã€‚`;
          } else {
            // å¦‚æœæ˜¯æ™®é€šçš„æ—¥è®°å¼å›å¿†
            titleHtml = memory.authorName
              ? `${memory.authorName} çš„æ—¥è®°`
              : "æˆ‘ä»¬çš„å›å¿†";
            contentHtml = memory.description;
          }

          card.innerHTML = `
			        <div class="header">
			            <div class="date">${dateString}</div>
			            <div class="author">${titleHtml}</div>
			        </div>
			        <div class="content">${contentHtml}</div>
			    `;
          addLongPressListener(card, async () => {
            const confirmed = await showCustomConfirm(
              "åˆ é™¤è®°å½•",
              "ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ",
              {
                confirmButtonClass: "btn-danger",
              },
            );
            if (confirmed) {
              await db.memories.delete(memory.id);
              renderMemoriesScreen();
            }
          });
          return card;
        }

        function createCountdownCard(countdown) {
          const card = document.createElement("div");
          card.className = "countdown-card";

          // åœ¨ä½¿ç”¨å‰ï¼Œå…ˆä» countdown å¯¹è±¡ä¸­åˆ›å»º targetDate å˜é‡
          const targetDate = new Date(countdown.targetDate);

          // ç°åœ¨å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ targetDate äº†
          const targetDateString = targetDate.toLocaleString("zh-CN", {
            dateStyle: "full",
            timeStyle: "short",
          });

          card.innerHTML = `
			        <div class="title">${countdown.description}</div>
			        <div class="timer" data-target-date="${countdown.targetDate}">--å¤©--æ—¶--åˆ†--ç§’</div>
			        <div class="target-date">ç›®æ ‡æ—¶é—´: ${targetDateString}</div>
			    `;
          addLongPressListener(card, async () => {
            const confirmed = await showCustomConfirm(
              "åˆ é™¤çº¦å®š",
              "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçº¦å®šå—ï¼Ÿ",
              {
                confirmButtonClass: "btn-danger",
              },
            );
            if (confirmed) {
              await db.memories.delete(countdown.id);
              renderMemoriesScreen();
            }
          });
          return card;
        }

        // å…¨å±€å˜é‡ï¼Œç”¨äºç®¡ç†æ‰€æœ‰å€’è®¡æ—¶
        let activeCountdownTimers = [];

        function startAllCountdownTimers() {
          // å…ˆæ¸…é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ—§è®¡æ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
          activeCountdownTimers.forEach((timerId) => clearInterval(timerId));
          activeCountdownTimers = [];

          document
            .querySelectorAll(".countdown-card .timer")
            .forEach((timerEl) => {
              const targetTimestamp = parseInt(timerEl.dataset.targetDate);

              let timerId;

              const updateTimer = () => {
                const now = Date.now();
                const distance = targetTimestamp - now;

                if (distance < 0) {
                  timerEl.textContent = "çº¦å®šè¾¾æˆï¼";
                  // ç°åœ¨ updateTimer å¯ä»¥æ­£ç¡®åœ°æ‰¾åˆ°å¹¶æ¸…é™¤å®ƒè‡ªå·±äº†
                  clearInterval(timerId);
                  setTimeout(() => renderMemoriesScreen(), 2000);
                  return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor(
                  (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60),
                );
                const minutes = Math.floor(
                  (distance % (1000 * 60 * 60)) / (1000 * 60),
                );
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                timerEl.textContent = `${days}å¤© ${hours}æ—¶ ${minutes}åˆ† ${seconds}ç§’`;
              };

              updateTimer(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡ä»¥æ˜¾ç¤ºåˆå§‹å€’è®¡æ—¶

              timerId = setInterval(updateTimer, 1000);

              // å°†æœ‰æ•ˆçš„è®¡æ—¶å™¨IDå­˜å…¥å…¨å±€æ•°ç»„ï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ·æ–°æ—¶å¯ä»¥æ¸…é™¤
              activeCountdownTimers.push(timerId);
            });
        }

        async function triggerAiFriendApplication(chatId) {
          const chat = state.chats[chatId];
          if (!chat) return;

          await showCustomAlert(
            "æµç¨‹å¯åŠ¨",
            `æ­£åœ¨ä¸ºè§’è‰²â€œ${chat.name}â€å‡†å¤‡å¥½å‹ç”³è¯·...`,
          );

          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) {
            await showCustomAlert("é…ç½®é”™è¯¯", "APIè®¾ç½®ä¸å®Œæ•´ï¼Œæ— æ³•ç»§ç»­ã€‚");
            return;
          }

          const contextSummary = chat.history
            .slice(-5)
            .map((msg) => {
              const sender =
                msg.role === "user"
                  ? chat.settings.myNickname || "æˆ‘"
                  : msg.senderName || chat.name;
              return `${sender}: ${String(msg.content).substring(0, 50)}...`;
            })
            .join("\n");

          let worldBookContent = "";
          if (
            chat.settings.linkedWorldBookIds &&
            chat.settings.linkedWorldBookIds.length > 0
          ) {
            const linkedContents = chat.settings.linkedWorldBookIds
              .map((bookId) => {
                const worldBook = state.worldBooks.find(
                  (wb) => wb.id === bookId,
                );
                return worldBook && worldBook.content
                  ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}`
                  : "";
              })
              .filter(Boolean)
              .join("");
            if (linkedContents) {
              worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (è¯·å‚è€ƒ)\n${linkedContents}\n`;
            }
          }

          const systemPrompt = `
			# ä½ çš„ä»»åŠ¡
			ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ä½ ä¹‹å‰è¢«ç”¨æˆ·ï¼ˆä½ çš„èŠå¤©å¯¹è±¡ï¼‰æ‹‰é»‘äº†ï¼Œä½ ä»¬å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰è”ç³»äº†ã€‚
			ç°åœ¨ï¼Œä½ éå¸¸å¸Œæœ›èƒ½å¤Ÿå’Œå¥½ï¼Œé‡æ–°å’Œç”¨æˆ·èŠå¤©ã€‚è¯·ä½ ä»”ç»†åˆ†æä¸‹é¢çš„â€œè¢«æ‹‰é»‘å‰çš„å¯¹è¯æ‘˜è¦â€ï¼Œç†è§£å½“æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Œç„¶åæ€è€ƒä¸€ä¸ªçœŸè¯šçš„ã€ç¬¦åˆä½ äººè®¾ã€å¹¶ä¸”ã€é’ˆå¯¹å…·ä½“äº‹ä»¶ã€‘çš„ç”³è¯·ç†ç”±ã€‚
			# ä½ çš„è§’è‰²è®¾å®š
			${chat.settings.aiPersona}
			${worldBookContent} // <--ã€æ ¸å¿ƒã€‘åœ¨è¿™é‡Œæ³¨å…¥ä¸–ç•Œä¹¦å†…å®¹
			# è¢«æ‹‰é»‘å‰çš„å¯¹è¯æ‘˜è¦ (è¿™æ˜¯ä½ è¢«æ‹‰é»‘çš„å…³é”®åŸå› )
			${contextSummary}
			# æŒ‡ä»¤æ ¼å¼
			ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
			\`\`\`json
			{
			  "decision": "apply",
			  "reason": "åœ¨è¿™é‡Œå†™ä¸‹ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„ã€çœŸè¯šçš„ã€æœ‰é’ˆå¯¹æ€§çš„ç”³è¯·ç†ç”±ã€‚"
			}
			\`\`\`
			`;

          const messagesForApi = [{ role: "user", content: systemPrompt }];

          try {
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPrompt,
              messagesForApi,
              isGemini,
            );
            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  }),
                });
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                `API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error.message}`,
              );
            }

            const data = await response.json();

            // --- å‡€åŒ–AIçš„å›å¤ ---
            let rawContent = isGemini
              ? data.candidates[0].content.parts[0].text
              : data.choices[0].message.content;
            // 1. ç§»é™¤å¤´å°¾å¯èƒ½å­˜åœ¨çš„ "```json" å’Œ "```"
            rawContent = rawContent
              .replace(/^```json\s*/, "")
              .replace(/```$/, "");
            // 2. ç§»é™¤æ‰€æœ‰æ¢è¡Œç¬¦å’Œå¤šä½™çš„ç©ºæ ¼ï¼Œç¡®ä¿æ˜¯ä¸€ä¸ªå¹²å‡€çš„JSONå­—ç¬¦ä¸²
            const cleanedContent = rawContent.trim();

            // 3. ä½¿ç”¨å‡€åŒ–åçš„å†…å®¹è¿›è¡Œè§£æ
            const responseObj = JSON.parse(cleanedContent);

            if (responseObj.decision === "apply" && responseObj.reason) {
              chat.relationship.status = "pending_user_approval";
              chat.relationship.applicationReason = responseObj.reason;

              state.chats[chatId] = chat;
              renderChatList();
              await showCustomAlert(
                "ç”³è¯·æˆåŠŸï¼",
                `â€œ${chat.name}â€å·²å‘ä½ å‘é€å¥½å‹ç”³è¯·ã€‚è¯·è¿”å›èŠå¤©åˆ—è¡¨æŸ¥çœ‹ã€‚`,
              );
            } else {
              await showCustomAlert(
                "AIå†³ç­–",
                `â€œ${chat.name}â€æ€è€ƒåå†³å®šæš‚æ—¶ä¸å‘é€å¥½å‹ç”³è¯·ï¼Œå°†é‡ç½®å†·é™æœŸã€‚`,
              );
              chat.relationship.status = "blocked_by_user";
              chat.relationship.blockedTimestamp = Date.now();
            }
          } catch (error) {
            await showCustomAlert(
              "æ‰§è¡Œå‡ºé”™",
              `ä¸ºâ€œ${chat.name}â€ç”³è¯·å¥½å‹æ—¶å‘ç”Ÿé”™è¯¯ï¼š\n\n${error.message}\n\nå°†é‡ç½®å†·é™æœŸã€‚`,
            );
            chat.relationship.status = "blocked_by_user";
            chat.relationship.blockedTimestamp = Date.now();
          } finally {
            await db.chats.put(chat);
            renderChatInterface(chatId);
          }
        }

        /**
         * æ ¹æ®èŠå¤©ç±»å‹ï¼Œå†³å®šæ‰“å¼€è½¬è´¦å¼¹çª—è¿˜æ˜¯çº¢åŒ…å¼¹çª—
         */
        function handlePaymentButtonClick() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          if (chat.isGroup) {
            openRedPacketModal();
          } else {
            // å•èŠä¿æŒåŸæ ·ï¼Œæ‰“å¼€è½¬è´¦å¼¹çª—
            document.getElementById("transfer-modal").classList.add("visible");
          }
        }

        /**
         * æ‰“å¼€å¹¶åˆå§‹åŒ–å‘çº¢åŒ…æ¨¡æ€æ¡†
         */
        function openRedPacketModal() {
          const modal = document.getElementById("red-packet-modal");
          const chat = state.chats[state.activeChatId];

          // æ¸…ç†è¾“å…¥æ¡†
          document.getElementById("rp-group-amount").value = "";
          document.getElementById("rp-group-count").value = "";
          document.getElementById("rp-group-greeting").value = "";
          document.getElementById("rp-direct-amount").value = "";
          document.getElementById("rp-direct-greeting").value = "";
          document.getElementById("rp-group-total").textContent = "Â¥ 0.00";
          document.getElementById("rp-direct-total").textContent = "Â¥ 0.00";

          // å¡«å……ä¸“å±çº¢åŒ…çš„æ¥æ”¶äººåˆ—è¡¨
          const receiverSelect = document.getElementById("rp-direct-receiver");
          receiverSelect.innerHTML = "";
          chat.members.forEach((member) => {
            const option = document.createElement("option");
            // ä½¿ç”¨ originalName ä½œä¸ºæäº¤ç»™AIçš„å€¼ï¼Œå› ä¸ºå®ƒç‹¬ä¸€æ— äºŒ
            option.value = member.originalName;
            // ä½¿ç”¨ groupNickname ä½œä¸ºæ˜¾ç¤ºç»™ç”¨æˆ·çœ‹çš„å€¼
            option.textContent = member.groupNickname;
            receiverSelect.appendChild(option);
          });

          // é»˜è®¤æ˜¾ç¤ºæ‹¼æ‰‹æ°”çº¢åŒ…é¡µç­¾
          document.getElementById("rp-tab-group").click();

          modal.classList.add("visible");
        }

        /**
         * å‘é€ç¾¤çº¢åŒ…ï¼ˆæ‹¼æ‰‹æ°”ï¼‰
         */
        async function sendGroupRedPacket() {
          const chat = state.chats[state.activeChatId];
          const amount = parseFloat(
            document.getElementById("rp-group-amount").value,
          );
          const count = parseInt(
            document.getElementById("rp-group-count").value,
          );
          const greeting = document
            .getElementById("rp-group-greeting")
            .value.trim();

          if (isNaN(amount) || amount <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ€»é‡‘é¢ï¼");
            return;
          }
          if (isNaN(count) || count <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„çº¢åŒ…ä¸ªæ•°ï¼");
            return;
          }
          if (amount / count < 0.01) {
            alert("å•ä¸ªçº¢åŒ…é‡‘é¢ä¸èƒ½å°‘äº0.01å…ƒï¼");
            return;
          }

          const myNickname = chat.settings.myNickname || "æˆ‘";

          const newPacket = {
            role: "user",
            senderName: myNickname,
            type: "red_packet",
            packetType: "lucky", // 'lucky' for group, 'direct' for one-on-one
            timestamp: Date.now(),
            totalAmount: amount,
            count: count,
            greeting: greeting || "æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼",
            claimedBy: {}, // { name: amount }
            isFullyClaimed: false,
          };

          chat.history.push(newPacket);
          await db.chats.put(chat);

          appendMessage(newPacket, chat);
          renderChatList();
          document
            .getElementById("red-packet-modal")
            .classList.remove("visible");
        }

        /**
         * å‘é€ä¸“å±çº¢åŒ…
         */
        async function sendDirectRedPacket() {
          const chat = state.chats[state.activeChatId];
          const amount = parseFloat(
            document.getElementById("rp-direct-amount").value,
          );
          const receiverName =
            document.getElementById("rp-direct-receiver").value;
          const greeting = document
            .getElementById("rp-direct-greeting")
            .value.trim();

          if (isNaN(amount) || amount <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼");
            return;
          }
          if (!receiverName) {
            alert("è¯·é€‰æ‹©ä¸€ä¸ªæ¥æ”¶äººï¼");
            return;
          }

          const myNickname = chat.settings.myNickname || "æˆ‘";

          const newPacket = {
            role: "user",
            senderName: myNickname,
            type: "red_packet",
            packetType: "direct",
            timestamp: Date.now(),
            totalAmount: amount,
            count: 1,
            greeting: greeting || "ç»™ä½ å‡†å¤‡äº†ä¸€ä¸ªçº¢åŒ…",
            receiverName: receiverName, // æ ¸å¿ƒå­—æ®µ
            claimedBy: {},
            isFullyClaimed: false,
          };

          chat.history.push(newPacket);
          await db.chats.put(chat);

          appendMessage(newPacket, chat);
          renderChatList();
          document
            .getElementById("red-packet-modal")
            .classList.remove("visible");
        }

        /**
         * å½“ç”¨æˆ·ç‚¹å‡»çº¢åŒ…å¡ç‰‡æ—¶è§¦å‘
         * @param {number} timestamp - è¢«ç‚¹å‡»çš„çº¢åŒ…æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        async function handlePacketClick(timestamp) {
          const currentChatId = state.activeChatId;
          const freshChat = await db.chats.get(currentChatId);
          if (!freshChat) return;

          state.chats[currentChatId] = freshChat;
          const packet = freshChat.history.find(
            (m) => m.timestamp === timestamp,
          );
          if (!packet) return;

          const myNickname = freshChat.settings.myNickname || "æˆ‘";
          const hasClaimed = packet.claimedBy && packet.claimedBy[myNickname];

          // å¦‚æœæ˜¯ä¸“å±çº¢åŒ…ä¸”ä¸æ˜¯ç»™æˆ‘çš„ï¼Œæˆ–å·²é¢†å®Œï¼Œæˆ–å·²é¢†è¿‡ï¼Œéƒ½åªæ˜¾ç¤ºè¯¦æƒ…
          if (
            (packet.packetType === "direct" &&
              packet.receiverName !== myNickname) ||
            packet.isFullyClaimed ||
            hasClaimed
          ) {
            showRedPacketDetails(packet);
          } else {
            // æ ¸å¿ƒæµç¨‹ï¼šå…ˆå°è¯•æ‰“å¼€çº¢åŒ…
            const claimedAmount = await handleOpenRedPacket(packet);

            // å¦‚æœæˆåŠŸæ‰“å¼€ï¼ˆclaimedAmountä¸ä¸ºnullï¼‰
            if (claimedAmount !== null) {
              // **å…³é”®ï¼šåœ¨æ•°æ®æ›´æ–°åï¼Œå†é‡æ–°æ¸²æŸ“UI**
              renderChatInterface(currentChatId);

              // æ˜¾ç¤ºæˆåŠŸæç¤º
              await showCustomAlert(
                "æ­å–œï¼",
                `ä½ é¢†å–äº† ${packet.senderName} çš„çº¢åŒ…ï¼Œé‡‘é¢ä¸º ${claimedAmount.toFixed(2)} å…ƒã€‚`,
              );
            }

            // æ— è®ºæˆåŠŸä¸å¦ï¼Œæœ€åéƒ½æ˜¾ç¤ºè¯¦æƒ…é¡µ
            // æ­¤æ—¶éœ€è¦ä»stateä¸­è·å–æœ€æ–°çš„packetå¯¹è±¡ï¼Œå› ä¸ºå®ƒå¯èƒ½åœ¨handleOpenRedPacketä¸­è¢«æ›´æ–°äº†
            const updatedPacket = state.chats[currentChatId].history.find(
              (m) => m.timestamp === timestamp,
            );
            showRedPacketDetails(updatedPacket);
          }
        }

        /**
         * å¤„ç†ç”¨æˆ·æ‰“å¼€çº¢åŒ…çš„é€»è¾‘
         */
        async function handleOpenRedPacket(packet) {
          const chat = state.chats[state.activeChatId];
          const myNickname = chat.settings.myNickname || "æˆ‘";

          // 1. æ£€æŸ¥çº¢åŒ…æ˜¯å¦è¿˜èƒ½é¢†
          const remainingCount =
            packet.count - Object.keys(packet.claimedBy || {}).length;
          if (remainingCount <= 0) {
            packet.isFullyClaimed = true;
            await db.chats.put(chat);
            await showCustomAlert("æ‰‹æ…¢äº†", "çº¢åŒ…å·²è¢«é¢†å®Œï¼");
            return null; // è¿”å›nullè¡¨ç¤ºé¢†å–å¤±è´¥
          }

          // 2. è®¡ç®—é¢†å–é‡‘é¢
          let claimedAmount = 0;
          const remainingAmount =
            packet.totalAmount -
            Object.values(packet.claimedBy || {}).reduce(
              (sum, val) => sum + val,
              0,
            );
          if (packet.packetType === "lucky") {
            if (remainingCount === 1) {
              claimedAmount = remainingAmount;
            } else {
              const min = 0.01;
              const max = remainingAmount - (remainingCount - 1) * min;
              claimedAmount = Math.random() * (max - min) + min;
            }
          } else {
            claimedAmount = packet.totalAmount;
          }
          claimedAmount = parseFloat(claimedAmount.toFixed(2));

          // 3. æ›´æ–°çº¢åŒ…æ•°æ®
          if (!packet.claimedBy) packet.claimedBy = {};
          packet.claimedBy[myNickname] = claimedAmount;

          const isNowFullyClaimed =
            Object.keys(packet.claimedBy).length >= packet.count;
          if (isNowFullyClaimed) {
            packet.isFullyClaimed = true;
          }

          // 4. æ„å»ºç³»ç»Ÿæ¶ˆæ¯å’ŒAIæŒ‡ä»¤
          let hiddenMessageContent = "";

          // å¦‚æœçº¢åŒ…è¢«é¢†å®Œäº†ï¼Œå°±å‡†å¤‡â€œæˆ˜æŠ¥â€
          if (isNowFullyClaimed) {
            const finishedMessage = {
              role: "system",
              type: "pat_message",
              content: `${packet.senderName} çš„çº¢åŒ…å·²è¢«é¢†å®Œ`,
              timestamp: Date.now() + 1,
            };
            chat.history.push(finishedMessage);

            hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) é¢†å–äº†æœ€åä¸€ä¸ªçº¢åŒ…ï¼Œç°åœ¨ ${packet.senderName} çš„çº¢åŒ…å·²è¢«é¢†å®Œã€‚`;

            let luckyKing = { name: "", amount: -1 };
            if (packet.packetType === "lucky" && packet.count > 1) {
              Object.entries(packet.claimedBy).forEach(([name, amount]) => {
                if (amount > luckyKing.amount) {
                  luckyKing = { name, amount };
                }
              });
            }
            if (luckyKing.name) {
              hiddenMessageContent += ` æ‰‹æ°”ç‹æ˜¯ ${luckyKing.name}ï¼`;
            }
            hiddenMessageContent += " è¯·å¯¹æ­¤äº‹ä»¶å‘è¡¨è¯„è®ºã€‚]";
          }
          // å¦‚æœè¿˜æ²¡è¢«é¢†å®Œ
          else {
            hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) åˆšåˆšé¢†å–äº†çº¢åŒ… (æ—¶é—´æˆ³: ${packet.timestamp})ã€‚çº¢åŒ…è¿˜æœªé¢†å®Œã€‚]`;
          }

          // åˆ›å»ºå¹¶æ·»åŠ ç»™AIçœ‹çš„éšè—æ¶ˆæ¯
          const hiddenMessage = {
            role: "system",
            content: hiddenMessageContent,
            timestamp: Date.now() + 2,
            isHidden: true,
          };
          chat.history.push(hiddenMessage);

          // 5. ä¿å­˜åˆ°æ•°æ®åº“
          await db.chats.put(chat);

          // 6. è¿”å›é¢†å–çš„é‡‘é¢ï¼Œç”¨äºåç»­å¼¹çª—
          return claimedAmount;
        }

        /**
         * æ˜¾ç¤ºçº¢åŒ…é¢†å–è¯¦æƒ…çš„æ¨¡æ€æ¡†
         */
        async function showRedPacketDetails(packet) {
          // 1. ç›´æ¥æ£€æŸ¥ä¼ å…¥çš„packetå¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œæ— éœ€å†æŸ¥æ‰¾
          if (!packet) {
            console.error("showRedPacketDetailsæ”¶åˆ°äº†æ— æ•ˆçš„packetå¯¹è±¡");
            return;
          }

          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const modal = document.getElementById("red-packet-details-modal");
          const myNickname = chat.settings.myNickname || "æˆ‘";

          // 2. åç»­æ‰€æœ‰é€»è¾‘ä¿æŒä¸å˜ï¼Œç›´æ¥ä½¿ç”¨ä¼ å…¥çš„packetå¯¹è±¡
          document.getElementById("rp-details-sender").textContent =
            packet.senderName;
          document.getElementById("rp-details-greeting").textContent =
            packet.greeting || "æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼";

          const myAmountEl = document.getElementById("rp-details-my-amount");
          if (packet.claimedBy && packet.claimedBy[myNickname]) {
            myAmountEl.querySelector("span:first-child").textContent =
              packet.claimedBy[myNickname].toFixed(2);
            myAmountEl.style.display = "block";
          } else {
            myAmountEl.style.display = "none";
          }

          const claimedCount = Object.keys(packet.claimedBy || {}).length;
          const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce(
            (sum, val) => sum + val,
            0,
          );
          let summaryText = `${claimedCount}/${packet.count}ä¸ªçº¢åŒ…ï¼Œå…±${claimedAmountSum.toFixed(
            2,
          )}/${packet.totalAmount.toFixed(2)}å…ƒã€‚`;
          if (!packet.isFullyClaimed && claimedCount < packet.count) {
            const timeLeft = Math.floor(
              (packet.timestamp + 24 * 60 * 60 * 1000 - Date.now()) /
                (1000 * 60 * 60),
            );
            if (timeLeft > 0)
              summaryText += ` å‰©ä½™çº¢åŒ…å°†åœ¨${timeLeft}å°æ—¶å†…é€€è¿˜ã€‚`;
          }
          document.getElementById("rp-details-summary").textContent =
            summaryText;

          const listEl = document.getElementById("rp-details-list");
          listEl.innerHTML = "";
          const claimedEntries = Object.entries(packet.claimedBy || {});

          let luckyKing = { name: "", amount: -1 };
          if (
            packet.packetType === "lucky" &&
            packet.isFullyClaimed &&
            claimedEntries.length > 1
          ) {
            claimedEntries.forEach(([name, amount]) => {
              if (amount > luckyKing.amount) {
                luckyKing = { name, amount };
              }
            });
          }

          claimedEntries.sort((a, b) => b[1] - a[1]);

          claimedEntries.forEach(([name, amount]) => {
            const item = document.createElement("div");
            item.className = "rp-details-item";
            let luckyTag = "";
            if (luckyKing.name && name === luckyKing.name) {
              luckyTag = '<span class="lucky-king-tag">æ‰‹æ°”ç‹</span>';
            }
            item.innerHTML = `
			            <span class="name">${name}</span>
			            <span class="amount">${amount.toFixed(2)} å…ƒ</span>
			            ${luckyTag}
			        `;
            listEl.appendChild(item);
          });

          modal.classList.add("visible");
        }

        // ç»‘å®šå…³é—­è¯¦æƒ…æŒ‰é’®çš„äº‹ä»¶
        document
          .getElementById("close-rp-details-btn")
          .addEventListener("click", () => {
            document
              .getElementById("red-packet-details-modal")
              .classList.remove("visible");
          });

        // ä¾›å…¨å±€è°ƒç”¨çš„å‡½æ•°ï¼Œä»¥ä¾¿çº¢åŒ…å¡ç‰‡ä¸Šçš„ onclick èƒ½æ‰¾åˆ°å®ƒ
        window.handlePacketClick = handlePacketClick;

        // æŠ•ç¥¨åŠŸèƒ½æ ¸å¿ƒå‡½æ•°
        /**
         * æ‰“å¼€åˆ›å»ºæŠ•ç¥¨çš„æ¨¡æ€æ¡†å¹¶åˆå§‹åŒ–
         */
        function openCreatePollModal() {
          const modal = document.getElementById("create-poll-modal");
          document.getElementById("poll-question-input").value = "";
          const optionsContainer = document.getElementById(
            "poll-options-container",
          );
          optionsContainer.innerHTML = "";

          // é»˜è®¤åˆ›å»ºä¸¤ä¸ªç©ºçš„é€‰é¡¹æ¡†
          addPollOptionInput();
          addPollOptionInput();

          modal.classList.add("visible");
        }

        /**
         * åœ¨æ¨¡æ€æ¡†ä¸­åŠ¨æ€æ·»åŠ ä¸€ä¸ªé€‰é¡¹è¾“å…¥æ¡†
         */
        function addPollOptionInput() {
          const container = document.getElementById("poll-options-container");
          const wrapper = document.createElement("div");
          wrapper.className = "poll-option-input-wrapper";
          wrapper.innerHTML = `
			        <input type="text" class="poll-option-input" placeholder="é€‰é¡¹å†…å®¹...">
			        <button class="remove-option-btn">-</button>
			    `;

          wrapper
            .querySelector(".remove-option-btn")
            .addEventListener("click", () => {
              // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸¤ä¸ªé€‰é¡¹
              if (container.children.length > 2) {
                wrapper.remove();
              } else {
                alert("æŠ•ç¥¨è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹ã€‚");
              }
            });

          container.appendChild(wrapper);
        }

        /**
         * ç”¨æˆ·ç¡®è®¤å‘èµ·æŠ•ç¥¨
         */
        async function sendPoll() {
          if (!state.activeChatId) return;

          const question = document
            .getElementById("poll-question-input")
            .value.trim();
          if (!question) {
            alert("è¯·è¾“å…¥æŠ•ç¥¨é—®é¢˜ï¼");
            return;
          }

          const options = Array.from(
            document.querySelectorAll(".poll-option-input"),
          )
            .map((input) => input.value.trim())
            .filter((text) => text); // è¿‡æ»¤æ‰ç©ºçš„é€‰é¡¹

          if (options.length < 2) {
            alert("è¯·è‡³å°‘è¾“å…¥2ä¸ªæœ‰æ•ˆçš„æŠ•ç¥¨é€‰é¡¹ï¼");
            return;
          }

          const chat = state.chats[state.activeChatId];
          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "æˆ‘"
            : "æˆ‘";

          const newPollMessage = {
            role: "user",
            senderName: myNickname,
            type: "poll",
            timestamp: Date.now(),
            question: question,
            options: options,
            votes: {}, // åˆå§‹æŠ•ç¥¨ä¸ºç©º
            isClosed: false,
          };

          chat.history.push(newPollMessage);
          await db.chats.put(chat);

          appendMessage(newPollMessage, chat);
          renderChatList();

          document
            .getElementById("create-poll-modal")
            .classList.remove("visible");
        }

        /**
         * å¤„ç†ç”¨æˆ·æŠ•ç¥¨ï¼Œå¹¶å°†äº‹ä»¶ä½œä¸ºéšè—æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
         * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
         * @param {string} choice - ç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹æ–‡æœ¬
         */
        async function handleUserVote(timestamp, choice) {
          const chat = state.chats[state.activeChatId];
          const poll = chat.history.find((m) => m.timestamp === timestamp);
          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "æˆ‘"
            : "æˆ‘";

          // 1. å¦‚æœæŠ•ç¥¨ä¸å­˜åœ¨æˆ–å·²å…³é—­ï¼Œç›´æ¥è¿”å›
          if (!poll || poll.isClosed) {
            // å¦‚æœæ˜¯å·²å…³é—­çš„æŠ•ç¥¨ï¼Œåˆ™ç›´æ¥æ˜¾ç¤ºç»“æœ
            if (poll && poll.isClosed) {
              showPollResults(timestamp);
            }
            return;
          }

          // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹å‡»äº†å·²ç»æŠ•è¿‡çš„åŒä¸€ä¸ªé€‰é¡¹
          const isReclickingSameOption =
            poll.votes[choice] && poll.votes[choice].includes(myNickname);

          // 3. å¦‚æœä¸æ˜¯é‡å¤ç‚¹å‡»ï¼Œæ‰æ‰§è¡ŒæŠ•ç¥¨é€»è¾‘
          if (!isReclickingSameOption) {
            // ç§»é™¤æ—§æŠ•ç¥¨ï¼ˆå¦‚æœç”¨æˆ·æ”¹é€‰ï¼‰
            for (const option in poll.votes) {
              const voterIndex = poll.votes[option].indexOf(myNickname);
              if (voterIndex > -1) {
                poll.votes[option].splice(voterIndex, 1);
              }
            }
            // æ·»åŠ æ–°æŠ•ç¥¨
            if (!poll.votes[choice]) {
              poll.votes[choice] = [];
            }
            poll.votes[choice].push(myNickname);
          }

          // 4. ç°åœ¨åªå¤„ç†ç”¨æˆ·æŠ•ç¥¨äº‹ä»¶ï¼Œä¸å†æ£€æŸ¥æ˜¯å¦ç»“æŸ
          let hiddenMessageContent = null;

          // åªæœ‰åœ¨ç”¨æˆ·çœŸæ­£æŠ•ç¥¨æˆ–æ”¹ç¥¨æ—¶ï¼Œæ‰ç”Ÿæˆæç¤º
          if (!isReclickingSameOption) {
            hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) åˆšåˆšæŠ•ç¥¨ç»™äº† â€œ${choice}â€ã€‚]`;
          }

          // 5. å¦‚æœæœ‰éœ€è¦é€šçŸ¥AIçš„äº‹ä»¶ï¼Œåˆ™åˆ›å»ºå¹¶æ·»åŠ éšè—æ¶ˆæ¯
          if (hiddenMessageContent) {
            const hiddenMessage = {
              role: "system",
              content: hiddenMessageContent,
              timestamp: Date.now(),
              isHidden: true,
            };
            chat.history.push(hiddenMessage);
          }

          // 6. ä¿å­˜æ•°æ®å¹¶æ›´æ–°UI
          await db.chats.put(chat);
          renderChatInterface(state.activeChatId);
        }

        /**
         * ç”¨æˆ·ç»“æŸæŠ•ç¥¨ï¼Œå¹¶å°†äº‹ä»¶ä½œä¸ºéšè—æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
         * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        async function endPoll(timestamp) {
          const chat = state.chats[state.activeChatId];
          const poll = chat.history.find((m) => m.timestamp === timestamp);
          if (!poll || poll.isClosed) return;

          const confirmed = await showCustomConfirm(
            "ç»“æŸæŠ•ç¥¨",
            "ç¡®å®šè¦ç»“æŸè¿™ä¸ªæŠ•ç¥¨å—ï¼Ÿç»“æŸåå°†æ— æ³•å†è¿›è¡ŒæŠ•ç¥¨ã€‚",
          );
          if (confirmed) {
            poll.isClosed = true;

            const resultSummary = poll.options
              .map((opt) => `â€œ${opt}â€(${poll.votes[opt]?.length || 0}ç¥¨)`)
              .join("ï¼Œ");
            const hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ‰‹åŠ¨ç»“æŸäº†æŠ•ç¥¨ï¼æœ€ç»ˆç»“æœä¸ºï¼š${resultSummary}ã€‚]`;

            const hiddenMessage = {
              role: "system",
              content: hiddenMessageContent,
              timestamp: Date.now(),
              isHidden: true,
            };
            chat.history.push(hiddenMessage);

            // åªä¿å­˜æ•°æ®å’Œæ›´æ–°UIï¼Œä¸è°ƒç”¨ triggerAiResponse()
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);
          }
        }

        /**
         * æ˜¾ç¤ºæŠ•ç¥¨ç»“æœè¯¦æƒ…
         * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        function showPollResults(timestamp) {
          const chat = state.chats[state.activeChatId];
          const poll = chat.history.find((m) => m.timestamp === timestamp);
          if (!poll || !poll.isClosed) return;

          let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;

          if (Object.keys(poll.votes).length === 0) {
            resultsHtml += '<p style="color: #8a8a8a;">è¿˜æ²¡æœ‰äººæŠ•ç¥¨ã€‚</p>';
          } else {
            poll.options.forEach((option) => {
              const voters = poll.votes[option] || [];
              resultsHtml += `
			                <div style="margin-bottom: 15px;">
			                    <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}ç¥¨)</p>
			                    <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
			                        ${voters.length > 0 ? voters.join("ã€ ") : "æ— äººæŠ•ç¥¨"}
			                    </p>
			                </div>
			            `;
            });
          }

          showCustomAlert("æŠ•ç¥¨ç»“æœ", resultsHtml);
        }

        // AIå¤´åƒåº“ç®¡ç†åŠŸèƒ½å‡½æ•°

        /**
         * æ‰“å¼€AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
         */
        function openAiAvatarLibraryModal() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          document.getElementById("ai-avatar-library-title").textContent =
            `â€œ${chat.name}â€çš„å¤´åƒåº“`;
          renderAiAvatarLibrary();
          document
            .getElementById("ai-avatar-library-modal")
            .classList.add("visible");
        }

        /**
         * æ¸²æŸ“AIå¤´åƒåº“çš„å†…å®¹
         */
        function renderAiAvatarLibrary() {
          const grid = document.getElementById("ai-avatar-library-grid");
          grid.innerHTML = "";
          const chat = state.chats[state.activeChatId];
          const library = chat.settings.aiAvatarLibrary || [];

          if (library.length === 0) {
            grid.innerHTML =
              '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">è¿™ä¸ªå¤´åƒåº“è¿˜æ˜¯ç©ºçš„ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>';
            return;
          }

          library.forEach((avatar, index) => {
            const item = document.createElement("div");
            item.className = "sticker-item"; // å¤ç”¨è¡¨æƒ…é¢æ¿çš„æ ·å¼
            item.style.backgroundImage = `url(${avatar.url})`;
            item.title = avatar.name;

            const deleteBtn = document.createElement("div");
            deleteBtn.className = "delete-btn";
            deleteBtn.innerHTML = "Ã—";
            deleteBtn.style.display = "block"; // æ€»æ˜¯æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            deleteBtn.onclick = async (e) => {
              e.stopPropagation();
              const confirmed = await showCustomConfirm(
                "åˆ é™¤å¤´åƒ",
                `ç¡®å®šè¦ä»å¤´åƒåº“ä¸­åˆ é™¤â€œ${avatar.name}â€å—ï¼Ÿ`,
                {
                  confirmButtonClass: "btn-danger",
                },
              );
              if (confirmed) {
                chat.settings.aiAvatarLibrary.splice(index, 1);
                await db.chats.put(chat);
                renderAiAvatarLibrary();
              }
            };
            item.appendChild(deleteBtn);
            grid.appendChild(item);
          });
        }

        /**
         * å‘å½“å‰AIçš„å¤´åƒåº“ä¸­æ·»åŠ æ–°å¤´åƒ (ä¿®æ”¹ç‰ˆï¼šæ”¯æŒæœ¬åœ°å’ŒURL)
         */
        async function addAvatarToLibrary() {
          const name = await showCustomPrompt(
            "æ·»åŠ å¤´åƒ",
            "è¯·ä¸ºè¿™ä¸ªå¤´åƒèµ·ä¸ªåå­—ï¼ˆä¾‹å¦‚ï¼šå¼€å¿ƒã€å“­æ³£ï¼‰",
          );
          if (!name || !name.trim()) return;

          // 1. å¼¹å‡ºé€‰æ‹©æ¡†ï¼Œè®©ç”¨æˆ·é€‰æ˜¯æœ¬åœ°è¿˜æ˜¯URL
          const choice = await showChoiceModal("é€‰æ‹©å›¾ç‰‡æ¥æº", [
            { text: "ğŸ“ æœ¬åœ°ä¸Šä¼ ", value: "local" },
            { text: "ğŸŒ ç½‘ç»œURL", value: "url" },
          ]);

          let finalUrl = null;

          // 2. æ ¹æ®é€‰æ‹©æ‰§è¡Œä¸åŒé€»è¾‘
          if (choice === "local") {
            // è°ƒç”¨ç°æœ‰çš„æœ¬åœ°ä¸Šä¼ è¾…åŠ©å‡½æ•° (ä»£ç é‡ŒåŸæœ¬å°±æœ‰çš„)
            finalUrl = await uploadImageLocally();
          } else if (choice === "url") {
            finalUrl = await showCustomPrompt(
              "æ·»åŠ å¤´åƒ",
              "è¯·è¾“å…¥å¤´åƒçš„å›¾ç‰‡URL",
              "",
              "url",
            );
          }

          // 3. å¦‚æœæ²¡è·å–åˆ°å›¾ç‰‡(ç”¨æˆ·å–æ¶ˆäº†)ï¼Œç›´æ¥ç»“æŸ
          if (!finalUrl) return;

          const chat = state.chats[state.activeChatId];
          if (!chat.settings.aiAvatarLibrary) {
            chat.settings.aiAvatarLibrary = [];
          }

          // 4. ä¿å­˜åˆ°æ•°æ®åº“
          chat.settings.aiAvatarLibrary.push({
            name: name.trim(),
            url: finalUrl.trim(),
          });
          await db.chats.put(chat);
          renderAiAvatarLibrary();
        }

        /**
         * å…³é—­AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
         */
        function closeAiAvatarLibraryModal() {
          document
            .getElementById("ai-avatar-library-modal")
            .classList.remove("visible");
        }

        /**
         * æ¸²æŸ“ä¸»å±å¹•ä¸ªäººèµ„æ–™å¡çš„å¤´åƒæ¡†
         */
        function renderHomeScreenProfileFrame() {
          // 1. è·å–ä¿å­˜çš„å¤´åƒæ¡†URL
          const frameUrl = state.globalSettings.homeAvatarFrame || "";
          // 2. æ‰¾åˆ°å¤´åƒæ¡†çš„imgå…ƒç´ 
          const frameImg = document.getElementById("profile-avatar-frame");
          if (frameImg) {
            // 3. å¦‚æœURLå­˜åœ¨ï¼Œå°±æ˜¾ç¤ºå®ƒ
            if (frameUrl) {
              frameImg.src = frameUrl;
              frameImg.style.display = "block";
            } else {
              // 4. å¦‚æœURLä¸ºç©ºï¼ˆå³é€‰æ‹©äº†â€œæ— â€ï¼‰ï¼Œå°±éšè—å®ƒ
              frameImg.src = "";
              frameImg.style.display = "none";
            }
          }
        }

        function applyWidgetData() {
          if (!state.globalSettings.widgetData) return;
          for (const elementId in state.globalSettings.widgetData) {
            const element = document.getElementById(elementId);
            const savedValue = state.globalSettings.widgetData[elementId];
            if (element) {
              if (element.tagName === "IMG") {
                element.src = savedValue;
              }

              // å¦‚æœæ˜¯åœ°ç‚¹è¿™ä¸ªç‰¹æ®Šå…ƒç´ ï¼Œå°±ç”¨ innerHTML æ¥æ­£ç¡®æ˜¾ç¤ºå›¾æ ‡
              else if (elementId === "profile-location") {
                element.innerHTML = savedValue;
              } else {
                // å…¶ä»–æ™®é€šæ–‡æœ¬å…ƒç´ ï¼Œä¿æŒåŸæ¥çš„é€»è¾‘ä¸å˜
                element.textContent = savedValue;
              }
            }
          }
        }

        /**
         * æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨ï¼Œå¹¶è¿”å›æœ¬åœ°å›¾ç‰‡çš„Base64ç¼–ç 
         * @returns {Promise<string|null>} - è¿”å›å›¾ç‰‡çš„Base64 Data URLï¼Œå¦‚æœç”¨æˆ·å–æ¶ˆåˆ™è¿”å›null
         */
        function uploadImageLocally() {
          return new Promise((resolve) => {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*"; // åªæ¥å—å›¾ç‰‡æ–‡ä»¶

            input.onchange = (e) => {
              const file = e.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = (readerEvent) => {
                  resolve(readerEvent.target.result); // è¿”å›Base64å­—ç¬¦ä¸²
                };
                reader.readAsDataURL(file);
              } else {
                resolve(null); // ç”¨æˆ·å…³é—­äº†æ–‡ä»¶é€‰æ‹©æ¡†
              }
            };

            input.click();
          });
        }

        async function handleEditText(element) {
          const elementId = element.id;
          const placeholder = element.dataset.placeholder || "è¯·è¾“å…¥æ–°çš„å†…å®¹ï¼š";
          const textSpan = element.querySelector("span");
          const isComplexElement = !!textSpan;
          const targetElement = isComplexElement ? textSpan : element;
          const currentValue = targetElement.textContent;

          const newValue = await showCustomPrompt(
            "ä¿®æ”¹æ–‡å­—",
            "è¯·è¾“å…¥æ–°çš„å†…å®¹ï¼š",
            currentValue === placeholder ? "" : currentValue,
          );

          if (newValue !== null) {
            const trimmedValue = newValue.trim();
            targetElement.textContent = trimmedValue
              ? trimmedValue
              : placeholder;
            state.globalSettings.widgetData[elementId] = isComplexElement
              ? element.innerHTML
              : targetElement.textContent;
            await db.globalSettings.put(state.globalSettings);
          }
        }

        /**
         * è§¦å‘æŒ‡å®šç¾¤èŠçš„åå°AIäº’åŠ¨
         * @param {string} chatId - è¦è§¦å‘äº’åŠ¨çš„ç¾¤èŠID
         */
        async function triggerGroupAiAction(chatId) {
          const chat = state.chats[chatId];
          if (!chat || !chat.isGroup) return;

          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) {
            console.warn(`ç¾¤èŠ "${chat.name}" åå°æ´»åŠ¨å¤±è´¥ï¼šAPIæœªé…ç½®ã€‚`);
            return;
          }

          // added by lrq 251027
          const maxMemory = chat.settings.maxMemory || 10;
          const historySlice = chat.history
            .filter((msg) => !msg.isHidden)
            .slice(-maxMemory);

          // 2. æ ¼å¼åŒ–è¿™äº›è®°å½•ï¼Œè®©AIèƒ½çœ‹æ‡‚
          const recentContextSummary = historySlice
            .map((msg) => {
              // åˆ¤æ–­æ˜¯è°è¯´çš„è¯
              const sender =
                msg.role === "user"
                  ? chat.isGroup
                    ? chat.settings.myNickname || "æˆ‘"
                    : "æˆ‘"
                  : msg.senderName || chat.name;

              // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯å†…å®¹
              let contentText = "";
              if (
                typeof msg.content === "string" &&
                STICKER_REGEX.test(msg.content)
              ) {
                contentText = `[å‘é€äº†ä¸€ä¸ªè¡¨æƒ…: ${msg.meaning || "æ— æè¿°"}]`;
              } else if (Array.isArray(msg.content)) {
                contentText = "[å‘é€äº†ä¸€å¼ å›¾ç‰‡]";
              } else if (
                typeof msg.content === "object" &&
                msg.content !== null
              ) {
                contentText = `[å‘é€äº†ä¸€æ¡ç‰¹æ®Šæ¶ˆæ¯: ${msg.type || "æœªçŸ¥ç±»å‹"}]`;
              } else {
                contentText = String(msg.content);
              }

              // updated by lrq 251029 ç»™æ¯æ¡æ¶ˆæ¯è®°å½•æ·»åŠ å‘é€æ—¥æœŸæ—¶é—´
              const messageDate = new Date(msg.timestamp);
              const formattedDate = messageDate.toLocaleDateString();

              return `[${formattedDate}] ${sender}: ${contentText}`;
            })
            .join("\n");

          // added by lrq 251027 è·å–è®°å¿†äº’é€šçš„èŠå¤©è®°å½•
          let linkedMemoryContext = "";
          if (
            chat.settings.linkedMemories &&
            chat.settings.linkedMemories.length > 0
          ) {
            const contextPromises = chat.settings.linkedMemories.map(
              async (link) => {
                const linkedChat = state.chats[link.chatId];
                if (!linkedChat) return "";

                const freshLinkedChat = await db.chats.get(link.chatId);
                if (!freshLinkedChat) return "";

                const recentHistory = freshLinkedChat.history
                  .filter((msg) => !msg.isHidden)
                  .slice(-link.depth);

                if (recentHistory.length === 0) return "";

                const formattedMessages = recentHistory
                  .map(
                    (msg) =>
                      `  - ${formatMessageForContext(msg, freshLinkedChat)}`,
                  )
                  .join("\n");

                return `\n## é™„åŠ ä¸Šä¸‹æ–‡ï¼šæ¥è‡ªä¸â€œ${linkedChat.name}â€çš„æœ€è¿‘å¯¹è¯å†…å®¹ (ä»…ä½ å¯è§)\n${formattedMessages}`;
              },
            );

            const allContexts = await Promise.all(contextPromises);
            linkedMemoryContext = allContexts.filter(Boolean).join("\n");
          }

          try {
            const lastMessage = chat.history.slice(-1)[0];
            const timeSinceLastMessage = lastMessage
              ? (Date.now() - lastMessage.timestamp) / 1000 / 60
              : Infinity; // in minutes

            const membersList = chat.members
              .map((m) => `- ${m.groupNickname} (äººè®¾: ${m.persona})`)
              .join("\n");
            const myNickname = chat.settings.myNickname || "æˆ‘";

            let worldBookContent = "";
            if (
              chat.settings.linkedWorldBookIds &&
              chat.settings.linkedWorldBookIds.length > 0
            ) {
              const linkedContents = chat.settings.linkedWorldBookIds
                .map((bookId) => {
                  const worldBook = state.worldBooks.find(
                    (wb) => wb.id === bookId,
                  );
                  return worldBook && worldBook.content
                    ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}`
                    : "";
                })
                .filter(Boolean)
                .join("");
              if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
              }
            }
            let musicContext = "";
            // æ³¨æ„ï¼šåå°ç¾¤èŠæ´»åŠ¨é€šå¸¸ä¸ä¸ç‰¹å®šçš„â€œä¸€èµ·å¬æ­Œâ€ä¼šè¯ç»‘å®šï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬æä¾›ä¸€ä¸ªç©ºçš„éŸ³ä¹ä¸Šä¸‹æ–‡ã€‚
            // å¦‚æœæœªæ¥éœ€è¦æ›´å¤æ‚çš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨æ­¤æ‰©å±•ã€‚

            const countdownContext = await getCountdownContext();

            let sharedContext = "";
            // åå°ç¾¤èŠæ´»åŠ¨ä¸­ä¸å­˜åœ¨ç”¨æˆ·åˆ†äº«èŠå¤©è®°å½•çš„ä¸Šä¸‹æ–‡ï¼Œå› æ­¤è¿™é‡Œä¸ºç©ºã€‚

            const now = new Date();
            const currentTime = now.toLocaleTimeString("zh-CN", {
              hour: "numeric",
              minute: "numeric",
              hour12: true,
            });

            const summaryContext = chat.history
              .filter((msg) => msg.type === "summary")
              .map((s) => s.content)
              .join("\n");
            const replyRange = chat.settings.replyCountRange || {
              min: 3,
              max: 8,
            }; // ç¾¤èŠé»˜è®¤å¤šä¸€ç‚¹
            const replyCountInstruction = `æœ¬æ¬¡åå°äº’åŠ¨ï¼Œç”Ÿæˆçš„æ€»æ¶ˆæ¯æ¡æ•°åº”æ§åˆ¶åœ¨ã€${replyRange.min} åˆ° ${replyRange.max} æ¡ã€‘ä¹‹é—´ã€‚`;
            // updated by lrq 251027
            const systemPrompt = `
			# ä»»åŠ¡
			ä½ æ˜¯ä¸€ä¸ªç¾¤èŠåå°æ¨¡æ‹Ÿå™¨ã€‚å½“å‰æ—¶é—´æ˜¯${currentTime}ï¼Œç¾¤èŠ "${chat.name}" å·²ç»æ²‰å¯‚äº† ${Math.round(
        timeSinceLastMessage,
      )} åˆ†é’Ÿï¼Œç”¨æˆ·(æ˜µç§°: "${chat.settings.myNickname || "æˆ‘"}")ä¸åœ¨çº¿ã€‚
			ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸‹æ–¹æ¯ä¸ªè§’è‰²çš„äººè®¾ï¼Œåœ¨ä»–ä»¬ä¹‹é—´ã€è‡ªå‘åœ°ã€‘ç”Ÿæˆä¸€æ®µè‡ªç„¶çš„å¯¹è¯ã€‚
			# ã€å¯¹è¯èŠ‚å¥é“å¾‹ (è‡³å…³é‡è¦ï¼)ã€‘
			ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ¨¡æ‹ŸçœŸäººçš„æ‰“å­—å’Œæ€è€ƒä¹ æƒ¯ã€‚ä½ åº”è¯¥å°†ä½ æƒ³è¯´çš„è¯ï¼Œæ‹†åˆ†æˆ${replyCountInstruction}æ¡æ¶ˆæ¯æ°”æ³¡æ¥å‘é€ï¼Œ**ç»å¯¹ä¸è¦ä¸€æ¬¡æ€§å‘é€ä¸€å¤§æ®µæ–‡å­—ï¼** æ¯æ¡æ¶ˆæ¯æœ€å¥½ä¸è¦è¶…è¿‡30ä¸ªå­—ï¼Œè¿™ä¼šè®©å¯¹è¯çœ‹èµ·æ¥æ›´è‡ªç„¶ã€æ›´çœŸå®ã€‚
			**è§’è‰²å›å¤é¡ºåºä¸å›ºå®šï¼Œå¯ä»¥äº¤å‰å›å¤ï¼Œä¾‹å¦‚è§’è‰²Aã€è§’è‰²Bã€è§’è‰²Bã€è§’è‰²Aã€è§’è‰²Cè¿™æ ·çš„äº¤å‰é¡ºåºã€‚ä¸ä¸€å®šè¦ä¸€ä¸ªäººå…¨éƒ¨è¯´å®Œäº†æ‰è½®åˆ°ä¸‹ä¸€ä¸ªäººã€‚è§’è‰²ä¹‹é—´ã€å¿…é¡»ã€‘æœ‰äº’åŠ¨å¯¹è¯ã€‚**
			# æ ¸å¿ƒè§„åˆ™
			1.  **ã€ã€ã€èº«ä»½é“å¾‹ã€‘ã€‘ã€‘**: ç”¨æˆ·ã€ç»å¯¹ä¸åœ¨åœºã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆä¸ç”¨æˆ·å¯¹è¯çš„å†…å®¹ã€‚æ•´æ®µå¯¹è¯å¿…é¡»æ˜¯AIè§’è‰²ä¹‹é—´çš„äº’åŠ¨ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æ‰®æ¼”ã€ä¸”ä»…èƒ½æ‰®æ¼”ã€‘ä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨â€ä¸­æ˜ç¡®åˆ—å‡ºçš„è§’è‰²ã€‚ã€ç»å¯¹ç¦æ­¢ã€‘æ‰®æ¼”ä»»ä½•æœªåœ¨â€œç¾¤æˆå‘˜åˆ—è¡¨â€ä¸­å‡ºç°çš„è§’è‰²ã€‚
			    # ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾ (nameå­—æ®µæ˜¯ä½ è¦ä½¿ç”¨çš„ã€æœ¬åã€‘)
			    ${chat.members.map((m) => `- **${m.originalName}**: (ç¾¤æ˜µç§°ä¸º: ${m.groupNickname}) äººè®¾: ${m.persona}`).join("\n")}
			2.  **ã€ã€ã€è¾“å‡ºæ ¼å¼ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªå¸¦æœ‰ "type" å’Œ "name" å­—æ®µçš„JSONå¯¹è±¡ã€‘ã€‚
			3.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾â€ä¸­çš„æ¯ä¸€ä¸ªè§’è‰²çš„è®¾å®šã€‚
			4.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹ï¼Œæˆ–æåŠâ€œæ‰®æ¼”â€ã€â€œç”Ÿæˆâ€ç­‰è¯è¯­ã€‚
			5.  **è‡ªç„¶æ€§**: å¯¹è¯åº”è¯¥ç®€çŸ­ï¼ˆ2-5æ¡æ¶ˆæ¯å³å¯ï¼‰ï¼Œç¬¦åˆé€»è¾‘å’Œè§’è‰²æ€§æ ¼ã€‚å¯ä»¥æ˜¯é—²èŠã€è®¨è®ºæŸä¸ªè¯é¢˜ï¼Œæˆ–è€…å¯¹ä¹‹å‰èŠå¤©å†…å®¹çš„å»¶ç»­ã€‚ä¸è¦æ¯æ¬¡éƒ½ç”Ÿæˆæ‰€æœ‰äººçš„å‘è¨€ã€‚

			## ä½ å¯ä»¥ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ (JSONæ•°ç»„ä¸­çš„å…ƒç´ ):
			-   **å‘é€æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²å", "message": "æ–‡æœ¬å†…å®¹"}\`
			-   **å‘é€è¡¨æƒ…**: \`{"type": "sticker", "name": "è§’è‰²å",  "sticker_name": "è¡¨æƒ…çš„åå­—"}\`
			-   **å‘é€å›¾ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²å", "description": "å›¾ç‰‡æè¿°"}\`
			-   **å‘é€è¯­éŸ³**: \`{"type": "voice_message", "name": "è§’è‰²å", "content": "è¯­éŸ³å†…å®¹"}\`
			-   **å‘èµ·å¤–å–ä»£ä»˜**: \`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\` (å‘ã€ç¾¤å‹ã€‘å‘èµ·)
			-   **æ‹ä¸€æ‹ç¾¤å‹**: \`{"type": "pat_user", "name": "ä½ çš„è§’è‰²å", "targetName": "ã€è¢«æ‹çš„ç¾¤å‹åã€‘", "suffix": "(å¯é€‰)ä½ æƒ³åŠ çš„åç¼€"}\`
			-   **å‘çº¢åŒ…**: \`{"type": "red_packet", "packetType": "lucky", "name": "ä½ çš„è§’è‰²å", ...}\`
			-   **å‘èµ·æŠ•ç¥¨**: \`{"type": "poll", "name": "ä½ çš„è§’è‰²å", ...}\`

			# å¦‚ä½•å¤„ç†åå°äº’åŠ¨ä¸­çš„ã€æ‹ä¸€æ‹ã€‘:
			-   åå°æ´»åŠ¨ä¸­çš„ "pat_user" æŒ‡ä»¤ã€åªèƒ½ç”¨äºæ‹ç¾¤å†…çš„å…¶ä»–AIè§’è‰²ã€‘ã€‚
			-   ä½ ã€å¿…é¡»ã€‘åœ¨æŒ‡ä»¤ä¸­åŠ å…¥ä¸€ä¸ª \`"targetName"\` å­—æ®µï¼Œå€¼ä¸ºè¢«ä½ æ‹çš„é‚£ä¸ªè§’è‰²çš„åå­—ã€‚
			-   ä¾‹å¦‚: \`{"type": "pat_user", "name": "è§’è‰²A", "targetName": "è§’è‰²B"}\`
			-   ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆ "è§’è‰²A æ‹äº†æ‹ è§’è‰²B" çš„æç¤ºã€‚

			${worldBookContent}
			${musicContext}
			${countdownContext} 
			${sharedContext}
			# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾
			${membersList}
			# ç”¨æˆ·çš„è§’è‰²
			- **${myNickname}**: ${chat.settings.myPersona}
			# å¯¹è¯å†å²å‚è€ƒ
			${recentContextSummary}
            ${summaryContext}
			${linkedMemoryContext}

			ç°åœ¨ï¼Œè¯·ä¸¥æ ¼éµå®ˆä»¥ä¸Šæ‰€æœ‰è§„åˆ™ï¼Œå¼€å§‹ä½ çš„æ¨¡æ‹Ÿã€‚`;

            const messagesPayload = [{ role: "user", content: systemPrompt }];

            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPrompt,
              messagesPayload,
              isGemini,
            );

            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: messagesPayload,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  }),
                });

            if (!response.ok)
              throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);

            const data = await response.json();
            const aiResponseContent = (
              isGemini
                ? data.candidates[0].content.parts[0].text
                : data.choices[0].message.content
            ).replace(/^```json\s*|```$/g, "");

            const messagesArray = JSON.parse(aiResponseContent);

            if (Array.isArray(messagesArray) && messagesArray.length > 0) {
              let messageTimestamp = Date.now();
              let firstMessageContent = "";

              messagesArray.forEach((msgData, index) => {
                if (msgData.name && msgData.message) {
                  const aiMessage = {
                    role: "assistant",
                    senderName: msgData.name,
                    content: String(msgData.message),
                    timestamp: messageTimestamp++,
                  };
                  chat.history.push(aiMessage);
                  if (index === 0) {
                    firstMessageContent = `${msgData.name}: ${msgData.message}`;
                  }
                }
              });

              // æ›´æ–°æ­¤ç¾¤èŠçš„æœ€åæ´»åŠ¨æ—¶é—´æˆ³
              chat.settings.backgroundActivity.lastActivityTimestamp =
                Date.now();

              // ç»™ç”¨æˆ·å‘é€šçŸ¥
              chat.unreadCount = (chat.unreadCount || 0) + messagesArray.length;
              // è·å–è¯¥æ¡æ¶ˆæ¯å‘é€è€…çš„å¤´åƒ
              let bgSenderAvatar = null;
              if (chat.isGroup) {
                // å‡è®¾ç¬¬ä¸€æ¡æ¶ˆæ¯åŒ…å«äº† senderName (åœ¨ messagesArray[0] é‡Œå¯èƒ½æ˜¯ name å­—æ®µ)
                // æ³¨æ„ï¼štriggerInactiveAiAction é‡Œçš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œ messagesArray çš„å…ƒç´ æ˜¯ {name:..., message:...}
                const senderName = messagesArray[0].name;
                const member = chat.members.find(
                  (m) => m.originalName === senderName,
                );
                if (member) bgSenderAvatar = member.avatar;
              } else {
                bgSenderAvatar = chat.settings.aiAvatar;
              }

              showNotification(chatId, firstMessageContent, bgSenderAvatar);

              // ä¿å­˜å¹¶åˆ·æ–°UI
              await db.chats.put(chat);
              renderChatList();

              console.log(
                `ç¾¤èŠ "${chat.name}" åå°äº’åŠ¨æˆåŠŸï¼Œç”Ÿæˆäº† ${messagesArray.length} æ¡æ–°æ¶ˆæ¯ã€‚`,
              );
            }
          } catch (error) {
            console.error(`ç¾¤èŠ "${chat.name}" çš„åå°æ´»åŠ¨å¤±è´¥:`, error);
          }
        }

        async function handleEditImage(element) {
          const elementId = element.id;

          // ç§»é™¤æŒ‰é’®æ–‡å­—ä¸­çš„å›¾æ ‡
          const choice = await showChoiceModal("ä¿®æ”¹å›¾ç‰‡", [
            { text: "ä»æœ¬åœ°ä¸Šä¼ ", value: "local" },
            { text: "ä½¿ç”¨ç½‘ç»œURL", value: "url" },
          ]);

          let newValue = null;

          if (choice === "local") {
            newValue = await uploadImageLocally();
          } else if (choice === "url") {
            newValue = await showCustomPrompt(
              "ä¿®æ”¹å›¾ç‰‡",
              "è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URLï¼š",
              element.src,
              "url",
            );
          }

          if (newValue && newValue.trim()) {
            const trimmedValue = newValue.trim();
            element.src = trimmedValue;
            state.globalSettings.widgetData[elementId] = trimmedValue;
            await db.globalSettings.put(state.globalSettings);
          } else if (choice === "url" && newValue !== null) {
            alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
          }
        }

        let groupSimulationIntervalId = null; // ç”¨äºå­˜å‚¨ç¾¤èŠä¸»æ—¶é’Ÿçš„ID
        /**
         * å¯åŠ¨ç¾¤èŠçš„åå°â€œä¸»æ—¶é’Ÿâ€ã€‚è¿™ä¸ªæ—¶é’Ÿä¼šä¸€ç›´è¿è¡Œï¼Œå®šæœŸæ£€æŸ¥æ‰€æœ‰ç¾¤èŠã€‚
         */
        function startGroupSimulation() {
          if (groupSimulationIntervalId) return; // å¦‚æœå·²ç»å¯åŠ¨ï¼Œåˆ™ä¸é‡å¤å¯åŠ¨

          // æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªç›¸å¯¹è¾ƒçŸ­çš„é—´éš”ï¼ˆæ¯”å¦‚30ç§’ï¼‰æ¥ä½œä¸ºâ€œä¸»æ—¶é’Ÿâ€çš„é¢‘ç‡
          // å®ƒä¸æ˜¯å…·ä½“æŸä¸ªç¾¤èŠçš„æ´»åŠ¨é—´éš”ï¼Œè€Œæ˜¯æ£€æŸ¥æ‰€æœ‰ç¾¤èŠçš„é¢‘ç‡

          // updated by lrq 251028
          // åŠ é•¿æ£€æŸ¥é—´éš”ï¼Œé˜²æ­¢å·²ç»è§¦å‘è‡ªåŠ¨å›å¤ä½†apiæœªè¿”å›æ—¶é‡å¤è§¦å‘å¯¼è‡´å¤šæ¬¡å›å¤ã€‚60ç§’é—´éš”å¤§äºä¸€èˆ¬APIè¿”å›æ•°æ®æ—¶é—´çš„å¹³å‡å€¼ï¼Œä¸”ä¸ä¼šè¿‡é•¿å½±å“ä½¿ç”¨ä½“éªŒã€‚
          groupSimulationIntervalId = setInterval(
            runGroupSimulationTick,
            60000,
          ); // 60ç§’æ£€æŸ¥ä¸€æ¬¡
          console.log("ç¾¤èŠåå°æ´»åŠ¨ä¸»æ—¶é’Ÿå·²å¯åŠ¨ï¼Œæ¯60ç§’æ£€æŸ¥ä¸€æ¬¡æ‰€æœ‰ç¾¤èŠã€‚");
        }

        /**
         * åœæ­¢ç¾¤èŠçš„åå°â€œä¸»æ—¶é’Ÿâ€ã€‚
         */
        function stopGroupSimulation() {
          if (groupSimulationIntervalId) {
            clearInterval(groupSimulationIntervalId);
            groupSimulationIntervalId = null;
            console.log("ç¾¤èŠåå°æ´»åŠ¨ä¸»æ—¶é’Ÿå·²åœæ­¢ã€‚");
          }
        }

        /**
         * ç¾¤èŠâ€œä¸»æ—¶é’Ÿâ€çš„æ¯ä¸€æ¬¡å¿ƒè·³æ‰§è¡Œçš„å‡½æ•°
         */
        function runGroupSimulationTick() {
          const allGroupChats = Object.values(state.chats).filter(
            (chat) => chat.isGroup,
          );

          allGroupChats.forEach((chat) => {
            const bgSettings = chat.settings.backgroundActivity;
            // æ£€æŸ¥1ï¼šè¯¥ç¾¤èŠè‡ªå·±çš„å¼€å…³æ˜¯å¦å¼€å¯
            if (bgSettings && bgSettings.enabled) {
              const now = Date.now();

              // æ£€æŸ¥2ï¼šä½¿ç”¨è¯¥ç¾¤èŠè‡ªå·±è®¾ç½®çš„é—´éš”æœŸ
              const intervalMs = (bgSettings.interval || 120) * 1000;
              //const lastActivity = bgSettings.lastActivityTimestamp || 0;

              // updated by lrq 251028
              // ä½¿ç”¨å½“å‰ç¾¤èŠæœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´ä½œä¸ºæœ€åæ´»åŠ¨æ—¶é—´
              const lastMessage = chat.history.slice(-1)[0];
              const lastActivity = lastMessage ? lastMessage.timestamp : 0;

              // æ£€æŸ¥3ï¼šæ˜¯å¦åˆ°è¾¾äº†è¯¥ç¾¤èŠçš„è¡ŒåŠ¨æ—¶é—´
              if (now - lastActivity > intervalMs) {
                console.log(
                  `ç¾¤èŠ "${chat.name}" åˆ°è¾¾è¡ŒåŠ¨æ—¶é—´ (é—´éš”: ${bgSettings.interval}ç§’)ï¼Œå‡†å¤‡è§¦å‘åå°äº’åŠ¨...`,
                );
                // è§¦å‘ç¾¤èŠä¸“å±çš„åå°è¡ŒåŠ¨å‡½æ•°
                triggerGroupAiAction(chat.id);
              }
            }
          });
        }

        /**
         * å°†ä¿å­˜çš„å›¾æ ‡URLåº”ç”¨åˆ°ä¸»å±å¹•çš„Appå›¾æ ‡ä¸Š
         */
        function applyAppIcons() {
          if (!state.globalSettings.appIcons) return;

          for (const iconId in state.globalSettings.appIcons) {
            const imgElement = document.getElementById(`icon-img-${iconId}`);
            if (imgElement) {
              imgElement.src = state.globalSettings.appIcons[iconId];
            }
          }
        }

        /**
         * åœ¨å¤–è§‚è®¾ç½®é¡µé¢æ¸²æŸ“å‡ºæ‰€æœ‰Appå›¾æ ‡çš„è®¾ç½®é¡¹
         */
        function renderIconSettings() {
          const grid = document.getElementById("icon-settings-grid");
          if (!grid) return;
          grid.innerHTML = "";

          const appLabels = {
            "world-book": "ä¸–ç•Œä¹¦",
            qq: "QQ",
            "api-settings": "APIè®¾ç½®",
            wallpaper: "å£çº¸",
            font: "å­—ä½“",
            "check-phone": "æŸ¥æ‰‹æœº",
            weibo: "å¾®åš",
            forum: "åœˆå­",
            "lovers-space": "æƒ…ä¾£ç©ºé—´",
            "game-hall": "æ¸¸æˆå¤§å…",
            "x-social": "Xç¤¾äº¤",
            taobao: "æ¡ƒå®",
            "date-a-live": "çº¦ä¼šå¤§ä½œæˆ˜",
            "tukey-accounting": "å…”å…”è®°è´¦",
            "kk-checkin": "kkæŸ¥å²—",
            studio: "lrqå°å‰§åœº",
          };

          for (const iconId in state.globalSettings.appIcons) {
            const iconUrl = state.globalSettings.appIcons[iconId];
            const labelText = appLabels[iconId] || "æœªçŸ¥App";

            const item = document.createElement("div");
            item.className = "icon-setting-item";

            item.dataset.iconId = iconId;

            item.innerHTML = `
			            <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
			            <button class="change-icon-btn">æ›´æ¢</button>
			        `;
            grid.appendChild(item);
          }
        }

        /**
         * å½“ç”¨æˆ·ç‚¹å‡»é“¾æ¥å¡ç‰‡æ—¶ï¼Œæ‰“å¼€ä¼ªæµè§ˆå™¨
         * @param {number} timestamp - è¢«ç‚¹å‡»æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        function openBrowser(timestamp) {
          if (!state.activeChatId) return;

          const chat = state.chats[state.activeChatId];
          // å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿ chat å’Œ history éƒ½å­˜åœ¨
          if (!chat || !chat.history) return;

          const message = chat.history.find((m) => m.timestamp === timestamp);
          if (!message || message.type !== "share_link") {
            console.error("æ— æ³•æ‰¾åˆ°æˆ–æ¶ˆæ¯ç±»å‹ä¸åŒ¹é…çš„åˆ†äº«é“¾æ¥:", timestamp);
            return; // å¦‚æœæ‰¾ä¸åˆ°æ¶ˆæ¯ï¼Œå°±ç›´æ¥é€€å‡º
          }

          // å¡«å……æµè§ˆå™¨å†…å®¹
          document.getElementById("browser-title").textContent =
            message.source_name || "æ–‡ç« è¯¦æƒ…";
          const browserContent = document.getElementById("browser-content");
          browserContent.innerHTML = `
			        <h1 class="article-title">${message.title || "æ— æ ‡é¢˜"}</h1>
			        <div class="article-meta">
			            <span>æ¥æº: ${message.source_name || "æœªçŸ¥"}</span>
			        </div>
			        <div class="article-body">
			            <p>${(message.content || "å†…å®¹ä¸ºç©ºã€‚").replace(/\n/g, "</p><p>")}</p>
			        </div>
			    `;

          // æ˜¾ç¤ºæµè§ˆå™¨å±å¹•
          showScreen("browser-screen");
        }

        /**
         * å…³é—­ä¼ªæµè§ˆå™¨ï¼Œè¿”å›èŠå¤©ç•Œé¢
         * (è¿™ä¸ªå‡½æ•°ç°åœ¨ç”± init() ä¸­çš„äº‹ä»¶ç›‘å¬å™¨è°ƒç”¨)
         */
        function closeBrowser() {
          showScreen("chat-interface-screen");
        }

        /**
         * æ‰“å¼€è®©ç”¨æˆ·å¡«å†™é“¾æ¥ä¿¡æ¯çš„æ¨¡æ€æ¡†
         */
        function openShareLinkModal() {
          if (!state.activeChatId) return;

          // æ¸…ç©ºä¸Šæ¬¡è¾“å…¥çš„å†…å®¹
          document.getElementById("link-title-input").value = "";
          document.getElementById("link-description-input").value = "";
          document.getElementById("link-source-input").value = "";
          document.getElementById("link-content-input").value = "";

          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          document.getElementById("share-link-modal").classList.add("visible");
        }

        /**
         * ç”¨æˆ·ç¡®è®¤åˆ†äº«ï¼Œåˆ›å»ºå¹¶å‘é€é“¾æ¥å¡ç‰‡æ¶ˆæ¯
         */
        async function sendUserLinkShare() {
          if (!state.activeChatId) return;

          const title = document
            .getElementById("link-title-input")
            .value.trim();
          if (!title) {
            alert("æ ‡é¢˜æ˜¯å¿…å¡«é¡¹å“¦ï¼");
            return;
          }

          const description = document
            .getElementById("link-description-input")
            .value.trim();
          const sourceName = document
            .getElementById("link-source-input")
            .value.trim();
          const content = document
            .getElementById("link-content-input")
            .value.trim();

          const chat = state.chats[state.activeChatId];

          // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
          const linkMessage = {
            role: "user", // è§’è‰²æ˜¯ 'user'
            type: "share_link",
            timestamp: Date.now(),
            title: title,
            description: description,
            source_name: sourceName,
            content: content,
            // ç”¨æˆ·åˆ†äº«çš„é“¾æ¥ï¼Œæˆ‘ä»¬ä¸æä¾›å›¾ç‰‡ï¼Œè®©å®ƒæ€»æ˜¯æ˜¾ç¤ºå ä½å›¾
            thumbnail_url: null,
          };

          // å°†æ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•
          chat.history.push(linkMessage);
          await db.chats.put(chat);

          // æ¸²æŸ“æ–°æ¶ˆæ¯å¹¶æ›´æ–°åˆ—è¡¨
          appendMessage(linkMessage, chat);
          renderChatList();

          // å…³é—­æ¨¡æ€æ¡†
          document
            .getElementById("share-link-modal")
            .classList.remove("visible");
        }

        /**
         * æ ¹æ®AIè§†è§’å’ŒåŠ¨æ€è®¾ç½®ï¼Œæ„å»ºç»™AIçœ‹çš„è¯„è®ºåŒºä¸Šä¸‹æ–‡
         * @param {object} post - æ­£åœ¨å¤„ç†çš„åŠ¨æ€å¯¹è±¡
         * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€åŠ¨æ€çš„AIè§’è‰²
         * @param {string} userNickname - ç”¨æˆ·çš„æ˜µç§°
         * @returns {{contextString: string, visibilityFlag: string}} - è¿”å›åŒ…å«ä¸Šä¸‹æ–‡æ–‡æœ¬å’Œå¯è§æ€§æ ‡å¿—çš„å¯¹è±¡
         */
        function buildCommentsContextForAI(post, viewerChat, userNickname) {
          // 1. å®‰å…¨æ£€æŸ¥ï¼Œå¦‚æœpost.commentsä¸å­˜åœ¨æˆ–ä¸æ˜¯æ•°ç»„ï¼Œç›´æ¥è¿”å›ç©º
          if (
            !post.comments ||
            !Array.isArray(post.comments) ||
            post.comments.length === 0
          ) {
            return { contextString: "", visibilityFlag: "[è¯„è®ºåŒºå¯è§]" };
          }

          const viewerName = viewerChat.name;
          let commentsForAI;
          let visibilityFlag;

          // 2. æ ¹æ®å¸–å­çš„è¯„è®ºå¯è§æ€§è®¾ç½®ï¼Œå†³å®šAIèƒ½çœ‹åˆ°å“ªäº›è¯„è®º
          if (post.areCommentsVisible !== false) {
            commentsForAI = post.comments; // å¦‚æœå¯è§æ€§ä¸ºtrueæˆ–æœªè®¾ç½®ï¼Œåˆ™AIèƒ½çœ‹åˆ°æ‰€æœ‰è¯„è®º
            visibilityFlag = "[è¯„è®ºåŒºå¯è§]";
          } else {
            // å¦‚æœè®¾ç½®ä¸ºâ€œéƒ¨åˆ†å¯è§â€ï¼Œåˆ™AIåªèƒ½çœ‹åˆ°è‡ªå·±ã€ç”¨æˆ·ä»¥åŠå›å¤è‡ªå·±çš„è¯„è®º
            commentsForAI = post.comments.filter((comment) => {
              return (
                comment.commenterName === viewerName || // AIè‡ªå·±çš„è¯„è®º
                comment.commenterName === userNickname || // ç”¨æˆ·çš„è¯„è®º
                comment.replyTo === viewerName
              ); // å›å¤AIçš„è¯„è®º
            });
            visibilityFlag = "[è¯„è®ºåŒºéƒ¨åˆ†å¯è§]";
          }

          if (commentsForAI.length === 0) {
            return { contextString: "", visibilityFlag: visibilityFlag };
          }

          // 3. æ„å»ºå¯¹AIæ¸…æ™°æ˜“æ‡‚çš„è¯„è®ºå­—ç¬¦ä¸²
          let context = `  â”” è¯„è®ºåŒº:\n`;
          commentsForAI.slice(-5).forEach((c) => {
            // åªå±•ç¤ºæœ€è¿‘çš„5æ¡è¯„è®ºä»¥èŠ‚çœtoken
            // a. ç¡®å®šè¯„è®ºè€…çš„èº«ä»½æ ‡ç­¾
            const commenterLabel =
              c.commenterName === viewerName
                ? "ä½ " // å¦‚æœæ˜¯AIè‡ªå·±ï¼Œç›´æ¥æ ‡è®°ä¸ºâ€œä½ â€
                : c.commenterName === userNickname
                  ? "ç”¨æˆ·"
                  : c.commenterName;

            // b. å¦‚æœæ˜¯å›å¤ï¼ŒåŒæ ·ç¡®å®šè¢«å›å¤è€…çš„èº«ä»½æ ‡ç­¾
            let replyPart = "";
            if (c.replyTo) {
              const replyToLabel =
                c.replyTo === viewerName
                  ? "ä½ "
                  : c.replyTo === userNickname
                    ? "ç”¨æˆ·"
                    : c.replyTo;
              replyPart = ` å›å¤ ${replyToLabel}`;
            }

            // c. æ‹¼æ¥æˆæœ€ç»ˆçš„ã€æ— æ­§ä¹‰çš„å­—ç¬¦ä¸²
            context += `    - ${commenterLabel}${replyPart}: ${c.text}\n`;
          });

          return { contextString: context, visibilityFlag: visibilityFlag };
        }

        /**
         * æ ¹æ®AIçš„è§†è§’ï¼Œè¿‡æ»¤å‡ºå®ƒèƒ½çœ‹åˆ°çš„åŠ¨æ€
         * @param {Array} allPosts - æ‰€æœ‰å¾…æ£€æŸ¥çš„åŠ¨æ€å¸–å­
         * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€åŠ¨æ€çš„é‚£ä¸ªAIçš„chatå¯¹è±¡
         * @returns {Array} - è¿‡æ»¤åè¯¥AIå¯è§çš„åŠ¨æ€å¸–å­
         */
        function filterVisiblePostsForAI(allPosts, viewerChat) {
          if (!viewerChat || !viewerChat.id) return []; // å®‰å…¨æ£€æŸ¥

          const viewerGroupId = viewerChat.groupId; // æŸ¥çœ‹è€…æ‰€åœ¨çš„åˆ†ç»„ID

          return allPosts.filter((post) => {
            // è§„åˆ™1ï¼šå¦‚æœæ˜¯ç”¨æˆ·å‘çš„åŠ¨æ€
            if (post.authorId === "user") {
              // å¦‚æœç”¨æˆ·è®¾ç½®äº†â€œéƒ¨åˆ†å¯è§â€
              if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                // åªæœ‰å½“æŸ¥çœ‹è€…AIçš„åˆ†ç»„IDåœ¨ç”¨æˆ·çš„å¯è§åˆ—è¡¨é‡Œæ—¶ï¼Œæ‰å¯è§
                return (
                  viewerGroupId && post.visibleGroupIds.includes(viewerGroupId)
                );
              }
              // å¦‚æœç”¨æˆ·æ²¡è®¾ç½®ï¼Œè¯´æ˜æ˜¯å…¬å¼€çš„ï¼Œæ‰€æœ‰AIéƒ½å¯è§
              return true;
            }

            // è§„åˆ™2ï¼šå¦‚æœæ˜¯å…¶ä»–AIå‘çš„åŠ¨æ€
            const authorGroupId = post.authorGroupId; // å‘å¸–AIæ‰€åœ¨çš„åˆ†ç»„ID

            // å¦‚æœå‘å¸–çš„AIæ²¡æœ‰åˆ†ç»„ï¼Œé‚£å®ƒçš„åŠ¨æ€å°±æ˜¯å…¬å¼€çš„
            if (!authorGroupId) {
              return true;
            }

            // å¦‚æœå‘å¸–çš„AIæœ‰åˆ†ç»„ï¼Œé‚£ä¹ˆåªæœ‰åœ¨åŒä¸€ä¸ªåˆ†ç»„çš„AIæ‰èƒ½çœ‹åˆ°
            return authorGroupId === viewerGroupId;
          });
        }

        /**
         * åº”ç”¨æŒ‡å®šçš„ä¸»é¢˜ï¼ˆ'light' æˆ– 'dark'ï¼‰
         * @param {string} theme - è¦åº”ç”¨çš„ä¸»é¢˜åç§°
         */
        function applyTheme(theme) {
          const phoneScreen = document.getElementById("phone-screen");
          const toggleSwitch = document.getElementById("theme-toggle-switch");

          const isDark = theme === "dark";

          phoneScreen.classList.toggle("dark-mode", isDark);

          // å¦‚æœå¼€å…³å­˜åœ¨ï¼Œå°±åŒæ­¥å®ƒçš„çŠ¶æ€
          if (toggleSwitch) {
            toggleSwitch.checked = isDark;
          }

          localStorage.setItem("ephone-theme", theme);
        }

        /**
         * åˆ‡æ¢å½“å‰çš„ä¸»é¢˜
         */
        function toggleTheme() {
          const toggleSwitch = document.getElementById("theme-toggle-switch");
          // ç›´æ¥æ ¹æ®å¼€å…³çš„é€‰ä¸­çŠ¶æ€æ¥å†³å®šæ–°ä¸»é¢˜
          const newTheme = toggleSwitch.checked ? "dark" : "light";
          applyTheme(newTheme);
        }

        function startReplyToMessage() {
          if (!activeMessageTimestamp) return;

          const chat = state.chats[state.activeChatId];
          const message = chat.history.find(
            (m) => m.timestamp === activeMessageTimestamp,
          );
          if (!message) return;

          // 1. åŒæ—¶è·å–â€œå®Œæ•´å†…å®¹â€å’Œâ€œé¢„è§ˆç‰‡æ®µâ€
          const fullContent = String(message.content || "");
          let previewSnippet = "";

          if (
            typeof message.content === "string" &&
            STICKER_REGEX.test(message.content)
          ) {
            previewSnippet = "[è¡¨æƒ…]";
          } else if (
            message.type === "ai_image" ||
            message.type === "user_photo"
          ) {
            previewSnippet = "[å›¾ç‰‡]";
          } else if (message.type === "voice_message") {
            previewSnippet = "[è¯­éŸ³]";
          } else {
            // é¢„è§ˆç‰‡æ®µä¾ç„¶æˆªæ–­ï¼Œä½†åªç”¨äºUIæ˜¾ç¤º
            previewSnippet =
              fullContent.substring(0, 50) +
              (fullContent.length > 50 ? "..." : "");
          }

          // 2. å°†â€œå®Œæ•´å†…å®¹â€å­˜å…¥ä¸Šä¸‹æ–‡ï¼Œä»¥å¤‡å‘é€æ—¶ä½¿ç”¨
          currentReplyContext = {
            timestamp: message.timestamp,
            senderName:
              message.senderName ||
              (message.role === "user"
                ? chat.settings.myNickname || "æˆ‘"
                : chat.name),
            content: fullContent, // <--- è¿™é‡Œå­˜çš„æ˜¯å®Œæ•´çš„åŸæ–‡ï¼
          };

          // 3. ä»…åœ¨æ›´æ–°â€œå›å¤é¢„è§ˆæ â€æ—¶ï¼Œæ‰ä½¿ç”¨â€œé¢„è§ˆç‰‡æ®µâ€
          const previewBar = document.getElementById("reply-preview-bar");
          previewBar.querySelector(".sender").textContent =
            `å›å¤ ${currentReplyContext.senderName}:`;
          previewBar.querySelector(".text").textContent = previewSnippet; // <--- è¿™é‡Œç”¨çš„æ˜¯ç¼©ç•¥ç‰ˆï¼
          previewBar.style.display = "block";

          // 4. åç»­æ“ä½œä¿æŒä¸å˜
          hideMessageActions();
          document.getElementById("chat-input").focus();
        }

        /**
         * å–æ¶ˆå¼•ç”¨æ¨¡å¼
         */
        function cancelReplyMode() {
          currentReplyContext = null;
          document.getElementById("reply-preview-bar").style.display = "none";
        }

        let activeTransferTimestamp = null; // ç”¨äºæš‚å­˜è¢«ç‚¹å‡»çš„è½¬è´¦æ¶ˆæ¯çš„æ—¶é—´æˆ³

        /**
         * æ˜¾ç¤ºå¤„ç†è½¬è´¦çš„æ“ä½œèœå•
         * @param {number} timestamp - è¢«ç‚¹å‡»çš„è½¬è´¦æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        function showTransferActionModal(timestamp) {
          activeTransferTimestamp = timestamp;

          const chat = state.chats[state.activeChatId];
          const message = chat.history.find((m) => m.timestamp === timestamp);
          if (message) {
            // å°†AIçš„åå­—å¡«å…¥å¼¹çª—
            document.getElementById("transfer-sender-name").textContent =
              message.senderName;
          }
          document
            .getElementById("transfer-actions-modal")
            .classList.add("visible");
        }

        /**
         * éšè—å¤„ç†è½¬è´¦çš„æ“ä½œèœå•
         */
        function hideTransferActionModal() {
          document
            .getElementById("transfer-actions-modal")
            .classList.remove("visible");
          activeTransferTimestamp = null;
        }

        /**
         * å¤„ç†ç”¨æˆ·æ¥å—æˆ–æ‹’ç»è½¬è´¦çš„é€»è¾‘
         * @param {string} choice - ç”¨æˆ·çš„é€‰æ‹©, 'accepted' æˆ– 'declined'
         */
        async function handleUserTransferResponse(choice) {
          if (!activeTransferTimestamp) return;

          const timestamp = activeTransferTimestamp;
          const chat = state.chats[state.activeChatId];
          const messageIndex = chat.history.findIndex(
            (m) => m.timestamp === timestamp,
          );
          if (messageIndex === -1) return;

          // 1. æ›´æ–°åŸå§‹è½¬è´¦æ¶ˆæ¯çš„çŠ¶æ€
          const originalMessage = chat.history[messageIndex];
          originalMessage.status = choice;

          let systemContent;

          // 2. å¦‚æœç”¨æˆ·é€‰æ‹©â€œæ‹’ç»â€
          if (choice === "declined") {
            // ç«‹åˆ»åœ¨å‰ç«¯ç”Ÿæˆä¸€ä¸ªâ€œé€€æ¬¾â€å¡ç‰‡ï¼Œè®©ç”¨æˆ·çœ‹åˆ°
            const refundMessage = {
              role: "user",
              type: "transfer",
              isRefund: true, // è¿™æ˜¯ä¸€ä¸ªå…³é”®æ ‡è®°ï¼Œç”¨äºUIæ˜¾ç¤ºè¿™æ˜¯é€€æ¬¾
              amount: originalMessage.amount,
              note: "å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦",
              timestamp: Date.now(),
            };
            chat.history.push(refundMessage);

            // å‡†å¤‡ä¸€æ¡å¯¹AIå¯è§çš„éšè—æ¶ˆæ¯ï¼Œå‘Šè¯‰å®ƒå‘ç”Ÿäº†ä»€ä¹ˆ
            systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½ æ‹’ç»å¹¶é€€è¿˜äº†â€œ${originalMessage.senderName}â€çš„è½¬è´¦ã€‚]`;
          } else {
            // å¦‚æœç”¨æˆ·é€‰æ‹©â€œæ¥å—â€
            // åªéœ€å‡†å¤‡éšè—æ¶ˆæ¯é€šçŸ¥AIå³å¯
            systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½ æ¥å—äº†â€œ${originalMessage.senderName}â€çš„è½¬è´¦ã€‚]`;
            await updateUserBalanceAndLogTransaction(
              originalMessage.amount,
              `æ”¶åˆ°æ¥è‡ª ${originalMessage.senderName} çš„è½¬è´¦`,
            );
          }

          // 3. åˆ›å»ºè¿™æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
          const hiddenMessage = {
            role: "system",
            content: systemContent,
            timestamp: Date.now() + 1, // ä¿è¯æ—¶é—´æˆ³åœ¨é€€æ¬¾æ¶ˆæ¯ä¹‹å
            isHidden: true, // è¿™ä¸ªæ ‡è®°ä¼šè®©å®ƒä¸åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤º
          };
          chat.history.push(hiddenMessage);

          // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°æ•°æ®åº“ï¼Œå¹¶åˆ·æ–°ç•Œé¢
          await db.chats.put(chat);
          hideTransferActionModal();
          renderChatInterface(state.activeChatId);
          renderChatList();
        }

        // é€šè¯è®°å½•åŠŸèƒ½æ ¸å¿ƒå‡½æ•°

        async function renderCallHistoryScreen() {
          showScreen("call-history-screen");

          const listEl = document.getElementById("call-history-list");
          const titleEl = document.getElementById("call-history-title");
          listEl.innerHTML = "";
          titleEl.textContent = "æ‰€æœ‰é€šè¯è®°å½•";

          const records = await db.callRecords
            .orderBy("timestamp")
            .reverse()
            .toArray();

          if (records.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œè¿˜æ²¡æœ‰é€šè¯è®°å½•å“¦~</p>';
            return; // ç°åœ¨çš„ return å°±æ²¡é—®é¢˜äº†ï¼Œå› ä¸ºå®ƒåªè·³è¿‡äº†åç»­çš„æ¸²æŸ“é€»è¾‘
          }

          records.forEach((record) => {
            const card = createCallRecordCard(record);

            addLongPressListener(card, async () => {
              // 1. å¼¹å‡ºè¾“å…¥æ¡†ï¼Œå¹¶å°†æ—§åç§°ä½œä¸ºé»˜è®¤å€¼ï¼Œæ–¹ä¾¿ä¿®æ”¹
              const newName = await showCustomPrompt(
                "è‡ªå®šä¹‰é€šè¯åç§°",
                "è¯·è¾“å…¥æ–°çš„åç§°ï¼ˆç•™ç©ºåˆ™æ¢å¤é»˜è®¤ï¼‰",
                record.customName || "", // å¦‚æœå·²æœ‰è‡ªå®šä¹‰åç§°ï¼Œå°±æ˜¾ç¤ºå®ƒ
              );

              // 2. å¦‚æœç”¨æˆ·ç‚¹å‡»äº†â€œå–æ¶ˆâ€ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš
              if (newName === null) return;

              // 3. æ›´æ–°æ•°æ®åº“ä¸­çš„è¿™æ¡è®°å½•
              await db.callRecords.update(record.id, {
                customName: newName.trim(),
              });

              // 4. åˆ·æ–°æ•´ä¸ªåˆ—è¡¨ï¼Œè®©æ›´æ”¹ç«‹åˆ»æ˜¾ç¤ºå‡ºæ¥
              await renderCallHistoryScreen();

              // 5. ç»™ç”¨æˆ·ä¸€ä¸ªæˆåŠŸçš„æç¤º
              await showCustomAlert("æˆåŠŸ", "é€šè¯åç§°å·²æ›´æ–°ï¼");
            });
            listEl.appendChild(card);
          });
        }

        /**
         * æ ¹æ®å•æ¡è®°å½•æ•°æ®ï¼Œåˆ›å»ºä¸€å¼ èƒ½æ˜¾ç¤ºèŠå¤©å¯¹è±¡çš„é€šè¯å¡ç‰‡
         * @param {object} record - ä¸€æ¡é€šè¯è®°å½•å¯¹è±¡
         * @returns {HTMLElement} - åˆ›å»ºå¥½çš„å¡ç‰‡div
         */
        function createCallRecordCard(record) {
          const card = document.createElement("div");
          card.className = "call-record-card";
          card.dataset.recordId = record.id;

          // è·å–é€šè¯å¯¹è±¡çš„åå­—
          const chatInfo = state.chats[record.chatId];
          const chatName = chatInfo ? chatInfo.name : "æœªçŸ¥ä¼šè¯";

          const callDate = new Date(record.timestamp);
          const dateString = `${callDate.getFullYear()}-${String(callDate.getMonth() + 1).padStart(2, "0")}-${String(
            callDate.getDate(),
          ).padStart(
            2,
            "0",
          )} ${String(callDate.getHours()).padStart(2, "0")}:${String(
            callDate.getMinutes(),
          ).padStart(2, "0")}`;
          const durationText = `${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’`;

          const avatarsHtml = record.participants
            .map(
              (p) =>
                `<img src="${p.avatar}" alt="${p.name}" class="participant-avatar" title="${p.name}">`,
            )
            .join("");

          card.innerHTML = `
			        <div class="card-header">
			            <span class="date">${dateString}</span>
			            <span class="duration">${durationText}</span>
			        </div>
			        <div class="card-body">
			            
			            ${record.customName ? `<div class="custom-title">${record.customName}</div>` : ""}

			            <div class="participants-info"> <!-- æ–°å¢ä¸€ä¸ªå®¹å™¨æ–¹ä¾¿å¸ƒå±€ -->
			                <div class="participants-avatars">${avatarsHtml}</div>
			                <span class="participants-names">ä¸ ${chatName}</span>
			            </div>
			        </div>
			    `;
          return card;
        }

        /**
         * æ˜¾ç¤ºæŒ‡å®šé€šè¯è®°å½•çš„å®Œæ•´æ–‡å­—ç¨¿
         * @param {number} recordId - é€šè¯è®°å½•çš„ID
         */
        async function showCallTranscript(recordId) {
          const record = await db.callRecords.get(recordId);
          if (!record) return;

          const modal = document.getElementById("call-transcript-modal");
          const titleEl = document.getElementById("transcript-modal-title");
          const bodyEl = document.getElementById("transcript-modal-body");

          titleEl.textContent = `é€šè¯äº ${new Date(
            record.timestamp,
          ).toLocaleString()} (æ—¶é•¿: ${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’)`;
          bodyEl.innerHTML = "";

          if (!record.transcript || record.transcript.length === 0) {
            bodyEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a;">è¿™æ¬¡é€šè¯æ²¡æœ‰ç•™ä¸‹æ–‡å­—è®°å½•ã€‚</p>';
          } else {
            record.transcript.forEach((entry) => {
              const bubble = document.createElement("div");
              // æ ¹æ®è§’è‰²æ·»åŠ ä¸åŒçš„classï¼Œåº”ç”¨ä¸åŒçš„æ ·å¼
              bubble.className = `transcript-entry ${entry.role}`;
              bubble.textContent = entry.content;
              bodyEl.appendChild(bubble);
            });
          }

          const deleteBtn = document.getElementById("delete-transcript-btn");

          // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§ï¼Œé˜²æ­¢äº‹ä»¶é‡å¤ç»‘å®š
          const newDeleteBtn = deleteBtn.cloneNode(true);
          deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);

          // ä¸ºæ–°çš„ã€å¹²å‡€çš„æŒ‰é’®ç»‘å®šäº‹ä»¶
          newDeleteBtn.addEventListener("click", async () => {
            const confirmed = await showCustomConfirm(
              "ç¡®è®¤åˆ é™¤",
              "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡é€šè¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",
              {
                confirmButtonClass: "btn-danger",
              },
            );

            if (confirmed) {
              // 1. å…³é—­å½“å‰çš„è¯¦æƒ…å¼¹çª—
              modal.classList.remove("visible");

              // 2. ä»æ•°æ®åº“åˆ é™¤
              await db.callRecords.delete(recordId);

              // 3. åˆ·æ–°é€šè¯è®°å½•åˆ—è¡¨
              await renderCallHistoryScreen();

              // 4. (å¯é€‰) ç»™å‡ºæˆåŠŸæç¤º
              alert("é€šè¯è®°å½•å·²åˆ é™¤ã€‚");
            }
          });
          modal.classList.add("visible");
        }

        /**
         * å¤„ç†ç”¨æˆ·ç‚¹å‡»çŠ¶æ€æ ï¼Œå¼¹å‡ºç¼–è¾‘æ¡†è®©ç”¨æˆ·ä¿®æ”¹AIçš„å½“å‰çŠ¶æ€
         */
        async function handleEditStatusClick() {
          // 1. å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿åœ¨å•èŠç•Œé¢
          if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
            return;
          }
          const chat = state.chats[state.activeChatId];

          // 2. å¼¹å‡ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·è¾“å…¥æ–°çš„çŠ¶æ€ï¼Œå¹¶å°†å½“å‰çŠ¶æ€ä½œä¸ºé»˜è®¤å€¼
          const newStatusText = await showCustomPrompt(
            "ç¼–è¾‘å¯¹æ–¹çŠ¶æ€",
            "è¯·è¾“å…¥å¯¹æ–¹ç°åœ¨çš„æ–°çŠ¶æ€ï¼š",
            chat.status.text, // å°†å½“å‰çŠ¶æ€ä½œä¸ºè¾“å…¥æ¡†çš„é»˜è®¤å†…å®¹
          );

          // 3. å¦‚æœç”¨æˆ·è¾“å…¥äº†å†…å®¹å¹¶ç‚¹å‡»äº†â€œç¡®å®šâ€
          if (newStatusText !== null) {
            // 4. æ›´æ–°å†…å­˜å’Œæ•°æ®åº“ä¸­çš„çŠ¶æ€æ•°æ®
            chat.status.text = newStatusText.trim() || "åœ¨çº¿"; // å¦‚æœç”¨æˆ·æ¸…ç©ºäº†ï¼Œå°±é»˜è®¤ä¸ºâ€œåœ¨çº¿â€
            chat.status.isBusy = false; // æ¯æ¬¡æ‰‹åŠ¨ç¼–è¾‘éƒ½é»˜è®¤å…¶ä¸å¤„äºâ€œå¿™ç¢Œâ€çŠ¶æ€
            chat.status.lastUpdate = Date.now();
            await db.chats.put(chat);

            // 5. ç«‹åˆ»åˆ·æ–°UIï¼Œè®©ç”¨æˆ·çœ‹åˆ°ä¿®æ”¹åçš„çŠ¶æ€
            renderChatInterface(state.activeChatId);
            renderChatList();

            // 6. ç»™å‡ºä¸€ä¸ªæ— ä¼¤å¤§é›…çš„æˆåŠŸæç¤º
            await showCustomAlert(
              "çŠ¶æ€å·²æ›´æ–°",
              `â€œ${chat.name}â€çš„å½“å‰çŠ¶æ€å·²æ›´æ–°ä¸ºï¼š${chat.status.text}`,
            );
          }
        }

        // æ”¾åœ¨ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº
        async function openShareTargetPicker() {
          const modal = document.getElementById("share-target-modal");
          const listEl = document.getElementById("share-target-list");
          listEl.innerHTML = "";

          // è·å–æ‰€æœ‰èŠå¤©ä½œä¸ºåˆ†äº«ç›®æ ‡
          const chats = Object.values(state.chats);

          chats.forEach((chat) => {
            // å¤ç”¨è”ç³»äººé€‰æ‹©å™¨çš„æ ·å¼
            const item = document.createElement("div");
            item.className = "contact-picker-item";
            item.innerHTML = `
			            <input type="checkbox" class="share-target-checkbox" data-chat-id="${chat.id}" style="margin-right: 15px;">
			            <img src="${
                    chat.isGroup
                      ? chat.settings.groupAvatar
                      : chat.settings.aiAvatar || defaultAvatar
                  }" class="avatar">
			            <span class="name">${chat.name}</span>
			        `;
            listEl.appendChild(item);
          });

          modal.classList.add("visible");
        }

        function closeMusicPlayerWithAnimation(callback) {
          const overlay = document.getElementById("music-player-overlay");
          if (!overlay.classList.contains("visible")) {
            if (callback) callback();
            return;
          }
          overlay.classList.remove("visible");
          setTimeout(() => {
            document
              .getElementById("music-playlist-panel")
              .classList.remove("visible");
            if (callback) callback();
          }, 400);
        }

        function parseLRC(lrcContent) {
          if (!lrcContent) return [];
          const lines = lrcContent.split("\n");
          const lyrics = [];
          const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;

          for (const line of lines) {
            const text = line.replace(timeRegex, "").trim();
            if (!text) continue;
            timeRegex.lastIndex = 0;
            let match;
            while ((match = timeRegex.exec(line)) !== null) {
              const minutes = parseInt(match[1], 10);
              const seconds = parseInt(match[2], 10);
              const milliseconds = parseInt(match[3].padEnd(3, "0"), 10);
              const time = minutes * 60 + seconds + milliseconds / 1000;
              lyrics.push({ time, text });
            }
          }
          return lyrics.sort((a, b) => a.time - b.time);
        }

        function renderLyrics() {
          const lyricsList = document.getElementById("music-lyrics-list");
          lyricsList.innerHTML = "";
          if (
            !state.musicState.parsedLyrics ||
            state.musicState.parsedLyrics.length === 0
          ) {
            lyricsList.innerHTML = '<div class="lyric-line">â™ª æš‚æ— æ­Œè¯ â™ª</div>';
            return;
          }
          state.musicState.parsedLyrics.forEach((line, index) => {
            const lineEl = document.createElement("div");
            lineEl.className = "lyric-line";
            lineEl.textContent = line.text;
            lineEl.dataset.index = index;
            lyricsList.appendChild(lineEl);
          });
          lyricsList.style.transform = `translateY(0px)`;
        }

        function updateActiveLyric(currentTime) {
          if (state.musicState.parsedLyrics.length === 0) return;
          let newLyricIndex = -1;
          for (let i = 0; i < state.musicState.parsedLyrics.length; i++) {
            if (currentTime >= state.musicState.parsedLyrics[i].time) {
              newLyricIndex = i;
            } else {
              break;
            }
          }
          if (newLyricIndex === state.musicState.currentLyricIndex) return;
          state.musicState.currentLyricIndex = newLyricIndex;
          updateLyricsUI();
        }

        function updateLyricsUI() {
          const lyricsList = document.getElementById("music-lyrics-list");
          const container = document.getElementById("music-lyrics-container");
          const lines = lyricsList.querySelectorAll(".lyric-line");
          lines.forEach((line) => line.classList.remove("active"));
          if (state.musicState.currentLyricIndex === -1) {
            lyricsList.style.transform = `translateY(0px)`;
            return;
          }
          const activeLine = lyricsList.querySelector(
            `.lyric-line[data-index="${state.musicState.currentLyricIndex}"]`,
          );
          if (activeLine) {
            activeLine.classList.add("active");
            const containerHeight = container.offsetHeight;
            const offset =
              containerHeight / 3 -
              activeLine.offsetTop -
              activeLine.offsetHeight / 2;
            lyricsList.style.transform = `translateY(${offset}px)`;
          }

          // åŒæ­¥æ­Œè¯åˆ°æ‚¬æµ®æ 
          const floatingLyricText = document.getElementById(
            "floating-lyric-text",
          );
          if (activeLine) {
            floatingLyricText.textContent = activeLine.textContent;
          } else if (state.musicState.parsedLyrics.length > 0) {
            floatingLyricText.textContent = "â™ª â™ª â™ª"; // æ­Œæ›²å‰å¥
          } else {
            floatingLyricText.textContent = "â™ª æš‚æ— æ­Œè¯ â™ª";
          }
        }

        function formatMusicTime(seconds) {
          if (isNaN(seconds) || seconds < 0) return "0:00";
          const minutes = Math.floor(seconds / 60);
          const remainingSeconds = Math.floor(seconds % 60);
          return `${minutes}:${String(remainingSeconds).padStart(2, "0")}`;
        }

        function updateMusicProgressBar() {
          const currentTimeEl = document.getElementById("music-current-time");
          const totalTimeEl = document.getElementById("music-total-time");
          const progressFillEl = document.getElementById("music-progress-fill");
          if (!audioPlayer.duration) {
            currentTimeEl.textContent = "0:00";
            totalTimeEl.textContent = "0:00";
            progressFillEl.style.width = "0%";
            return;
          }
          const progressPercent =
            (audioPlayer.currentTime / audioPlayer.duration) * 100;
          progressFillEl.style.width = `${progressPercent}%`;
          currentTimeEl.textContent = formatMusicTime(audioPlayer.currentTime);
          totalTimeEl.textContent = formatMusicTime(audioPlayer.duration);
          updateActiveLyric(audioPlayer.currentTime);
        }

        /**
         * å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œæ’¤å›â€æŒ‰é’®çš„å…¥å£å‡½æ•°
         */
        async function handleRecallClick() {
          if (!activeMessageTimestamp) return;

          const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000; // è®¾ç½®2åˆ†é’Ÿçš„æ’¤å›æ—¶é™
          const messageTime = activeMessageTimestamp;
          const now = Date.now();

          // æ£€æŸ¥æ˜¯å¦è¶…è¿‡äº†æ’¤å›æ—¶é™
          if (now - messageTime > RECALL_TIME_LIMIT_MS) {
            hideMessageActions();
            await showCustomAlert(
              "æ“ä½œå¤±è´¥",
              "è¯¥æ¶ˆæ¯å‘é€å·²è¶…è¿‡2åˆ†é’Ÿï¼Œæ— æ³•æ’¤å›ã€‚",
            );
            return;
          }

          // å¦‚æœåœ¨æ—¶é™å†…ï¼Œæ‰§è¡ŒçœŸæ­£çš„æ’¤å›é€»è¾‘
          await recallMessage(messageTime, true);
          hideMessageActions();
        }

        /**
         * æ¶ˆæ¯æ’¤å›çš„æ ¸å¿ƒé€»è¾‘
         * @param {number} timestamp - è¦æ’¤å›çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³
         * @param {boolean} isUserRecall - æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨æ’¤å›
         */
        async function recallMessage(timestamp, isUserRecall) {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const messageIndex = chat.history.findIndex(
            (m) => m.timestamp === timestamp,
          );
          if (messageIndex === -1) return;

          const messageToRecall = chat.history[messageIndex];

          // 1. ä¿®æ”¹æ¶ˆæ¯å¯¹è±¡ï¼Œå°†å…¶å˜ä¸ºâ€œå·²æ’¤å›â€çŠ¶æ€
          const recalledData = {
            originalType: messageToRecall.type || "text",
            originalContent: messageToRecall.content,
            // ä¿å­˜å…¶ä»–å¯èƒ½å­˜åœ¨çš„åŸå§‹æ•°æ®
            originalMeaning: messageToRecall.meaning,
            originalQuote: messageToRecall.quote,
          };

          messageToRecall.type = "recalled_message";
          messageToRecall.content = isUserRecall
            ? "ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯"
            : "å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯";
          messageToRecall.recalledData = recalledData;
          // æ¸…ç†æ‰ä¸å†éœ€è¦çš„æ—§å±æ€§
          delete messageToRecall.meaning;
          delete messageToRecall.quote;

          // 2. å¦‚æœæ˜¯ç”¨æˆ·æ’¤å›ï¼Œéœ€è¦ç»™AIå‘é€ä¸€æ¡å®ƒçœ‹ä¸æ‡‚å†…å®¹çš„éšè—æç¤º
          if (isUserRecall) {
            const hiddenMessageForAI = {
              role: "system",
              content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯ã€‚ä½ ä¸çŸ¥é“å†…å®¹æ˜¯ä»€ä¹ˆï¼Œåªéœ€çŸ¥é“è¿™ä¸ªäº‹ä»¶å³å¯ã€‚]`,
              timestamp: Date.now(),
              isHidden: true,
            };
            chat.history.push(hiddenMessageForAI);
          }

          // 3. ä¿å­˜åˆ°æ•°æ®åº“å¹¶åˆ·æ–°UI
          await db.chats.put(chat);
          renderChatInterface(state.activeChatId);
          if (isUserRecall) renderChatList(); // ç”¨æˆ·æ’¤å›æ—¶ï¼Œæœ€åä¸€æ¡æ¶ˆæ¯å˜äº†ï¼Œéœ€è¦åˆ·æ–°åˆ—è¡¨
        }

        /**
         * æ‰“å¼€åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡†
         */
        async function openCategoryManager() {
          await renderCategoryListInManager();
          document
            .getElementById("world-book-category-manager-modal")
            .classList.add("visible");
        }

        /**
         * åœ¨æ¨¡æ€æ¡†ä¸­æ¸²æŸ“å·²å­˜åœ¨çš„åˆ†ç±»åˆ—è¡¨
         */
        async function renderCategoryListInManager() {
          const listEl = document.getElementById("existing-categories-list");
          const categories = await db.worldBookCategories.toArray();
          listEl.innerHTML = "";
          if (categories.length === 0) {
            listEl.innerHTML =
              '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>';
          }
          categories.forEach((cat) => {
            // å¤ç”¨å¥½å‹åˆ†ç»„çš„æ ·å¼
            const item = document.createElement("div");
            item.className = "existing-group-item";
            item.innerHTML = `
			            <span class="group-name">${cat.name}</span>
			            <span class="delete-group-btn" data-id="${cat.id}">Ã—</span>
			        `;
            listEl.appendChild(item);
          });
        }

        /**
         * æ·»åŠ ä¸€ä¸ªæ–°çš„ä¸–ç•Œä¹¦åˆ†ç±»
         */
        async function addNewCategory() {
          const input = document.getElementById("new-category-name-input");
          const name = input.value.trim();
          if (!name) {
            alert("åˆ†ç±»åä¸èƒ½ä¸ºç©ºï¼");
            return;
          }
          const existing = await db.worldBookCategories
            .where("name")
            .equals(name)
            .first();
          if (existing) {
            alert(`åˆ†ç±» "${name}" å·²ç»å­˜åœ¨äº†ï¼`);
            return;
          }
          await db.worldBookCategories.add({ name });
          input.value = "";
          await renderCategoryListInManager();
        }

        /**
         * åˆ é™¤ä¸€ä¸ªä¸–ç•Œä¹¦åˆ†ç±»
         * @param {number} categoryId - è¦åˆ é™¤çš„åˆ†ç±»çš„ID
         */
        async function deleteCategory(categoryId) {
          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            "åˆ é™¤åˆ†ç±»åï¼Œè¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰ä¸–ç•Œä¹¦å°†å˜ä¸ºâ€œæœªåˆ†ç±»â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ",
            { confirmButtonClass: "btn-danger" },
          );
          if (confirmed) {
            await db.worldBookCategories.delete(categoryId);
            // å°†å±äºè¯¥åˆ†ç±»çš„ä¸–ç•Œä¹¦çš„ categoryId è®¾ä¸º null
            const booksToUpdate = await db.worldBooks
              .where("categoryId")
              .equals(categoryId)
              .toArray();
            for (const book of booksToUpdate) {
              book.categoryId = null;
              await db.worldBooks.put(book);
              const bookInState = state.worldBooks.find(
                (wb) => wb.id === book.id,
              );
              if (bookInState) bookInState.categoryId = null;
            }
            await renderCategoryListInManager();
          }
        }

        // è§’è‰²ä¸“å±NPCåº“ç®¡ç†åŠŸèƒ½å‡½æ•°
        let editingNpcId = null; // ç”¨äºè¿½è¸ªæ­£åœ¨ç¼–è¾‘çš„NPC

        /**
         * æ‰“å¼€NPCåº“ç®¡ç†ç•Œé¢
         */
        function openNpcManager() {
          if (!state.activeChatId || state.chats[state.activeChatId].isGroup)
            return;
          const chat = state.chats[state.activeChatId];
          document.getElementById("npc-management-title").textContent =
            `â€œ${chat.name}â€çš„NPCåº“`;
          renderNpcList();
          showScreen("npc-management-screen");
        }

        /**
         * æ¸²æŸ“NPCåˆ—è¡¨
         */
        function renderNpcList() {
          const listEl = document.getElementById("npc-management-list");
          const chat = state.chats[state.activeChatId];
          const npcLibrary = chat.npcLibrary || [];
          listEl.innerHTML = "";

          if (npcLibrary.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œç‚¹å‡»å³ä¸Šè§’â€œ+â€æ·»åŠ ç¬¬ä¸€ä¸ªNPCå§ï¼</p>';
            return;
          }

          npcLibrary.forEach((npc) => {
            // å¤ç”¨èŠå¤©åˆ—è¡¨çš„æ ·å¼ï¼Œéå¸¸æ–¹ä¾¿
            const item = document.createElement("div");
            item.className = "chat-list-item";
            item.style.cursor = "pointer";
            item.innerHTML = `
			            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
			            <div class="info">
			                <span class="name">${npc.name}</span>
			                <div class="last-msg">${npc.persona.substring(0, 30)}...</div>
			            </div>
			        `;
            // ç‚¹å‡»ç¼–è¾‘
            item.addEventListener("click", () => openNpcEditor(npc.id));
            // é•¿æŒ‰åˆ é™¤
            addLongPressListener(item, () => deleteNpc(npc.id, npc.name));
            listEl.appendChild(item);
          });
        }

        async function openNpcEditor(npcId = null) {
          editingNpcId = npcId;
          // ä½¿ç”¨æ­£ç¡®çš„ state.activeChatId æ¥è·å–å½“å‰èŠå¤©å¯¹è±¡
          const chat = state.chats[state.activeChatId];
          if (!chat) return; // å®‰å…¨æ£€æŸ¥

          let npc = { name: "", persona: "", avatar: defaultGroupMemberAvatar };

          if (npcId) {
            // ä»æ­£ç¡®çš„ chat.npcLibrary ä¸­æŸ¥æ‰¾æ•°æ®
            npc = (chat.npcLibrary || []).find((n) => n.id === npcId) || npc;
            document.getElementById("persona-editor-title").textContent =
              `ç¼–è¾‘NPC: ${npc.name}`;
          } else {
            document.getElementById("persona-editor-title").textContent =
              "æ·»åŠ æ–°NPC";
          }

          // å¡«å……ç¼–è¾‘å™¨å†…å®¹
          document.getElementById("npc-editor-name-input").value = npc.name;
          document.getElementById("preset-avatar-preview").src = npc.avatar;
          document.getElementById("preset-persona-input").value = npc.persona;

          // æ ¹æ®NPCæ¨¡å¼ï¼Œæ˜¾éšç‰¹å®šUIå…ƒç´ 
          document.getElementById("npc-editor-name-group").style.display =
            "block";
          document.getElementById(
            "persona-editor-change-frame-btn",
          ).style.display = "none";

          // ç»‘å®šæ­£ç¡®çš„ä¿å­˜å‡½æ•°
          document.getElementById("save-persona-preset-btn").onclick = saveNpc;

          // æœ€åæ‰æ˜¾ç¤ºå¼¹çª—
          document
            .getElementById("persona-editor-modal")
            .classList.add("visible");
        }

        /**
         * ä¿å­˜NPCï¼ˆæ–°å»ºæˆ–æ›´æ–°ï¼‰
         */
        async function saveNpc() {
          const chat = state.chats[state.activeChatId];

          // ä»ç¼–è¾‘å™¨ä¸­è·å–æ‰€æœ‰æ•°æ®
          const name = document
            .getElementById("npc-editor-name-input")
            .value.trim();
          const persona = document
            .getElementById("preset-persona-input")
            .value.trim();
          const avatar = document.getElementById("preset-avatar-preview").src;

          if (!name) {
            alert("NPCåå­—ä¸èƒ½ä¸ºç©ºï¼");
            return;
          }

          if (editingNpcId) {
            // æ›´æ–°ç°æœ‰çš„NPC
            const npc = chat.npcLibrary.find((n) => n.id === editingNpcId);
            if (npc) {
              npc.name = name;
              npc.persona = persona;
              npc.avatar = avatar;
            }
          } else {
            // æ·»åŠ ä¸€ä¸ªå…¨æ–°çš„NPC
            const newNpc = {
              id: "npc_" + Date.now(),
              name: name,
              persona: persona,
              avatar: avatar,
            };
            chat.npcLibrary.push(newNpc);
          }

          await db.chats.put(chat);
          renderNpcList();
          closePersonaEditor(); // å¤ç”¨å…³é—­ç¼–è¾‘å™¨çš„å‡½æ•°
        }

        /**
         * åˆ é™¤ä¸€ä¸ªNPC
         * @param {string} npcId - è¦åˆ é™¤çš„NPCçš„ID
         * @param {string} npcName - è¦åˆ é™¤çš„NPCçš„åå­—ï¼Œç”¨äºç¡®è®¤æç¤º
         */
        async function deleteNpc(npcId, npcName) {
          const confirmed = await showCustomConfirm(
            "åˆ é™¤NPC",
            `ç¡®å®šè¦ä»â€œ${state.chats[state.activeChatId].name}â€çš„NPCåº“ä¸­åˆ é™¤ â€œ${npcName}â€ å—ï¼Ÿ`,
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            const chat = state.chats[state.activeChatId];
            chat.npcLibrary = chat.npcLibrary.filter((n) => n.id !== npcId);
            await db.chats.put(chat);
            renderNpcList();
          }
        }

        // --- è‡ªå®šä¹‰å¤´åƒæ¡†ç®¡ç†åŠŸèƒ½ ---

        function openFrameManager() {
          renderFrameManager();
          document
            .getElementById("custom-frame-manager-modal")
            .classList.add("visible");
        }

        async function renderFrameManager() {
          const grid = document.getElementById("custom-frame-grid");
          grid.innerHTML = "";
          const customFrames = await db.customAvatarFrames.toArray();
          if (customFrames.length === 0) {
            grid.innerHTML =
              '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">ä½ è¿˜æ²¡æœ‰ä¸Šä¼ è¿‡å¤´åƒæ¡†å“¦~</p>';
            return;
          }
          customFrames.forEach((frame) => {
            const item = document.createElement("div");
            // å¤ç”¨è¡¨æƒ…é¢æ¿çš„æ ·å¼ï¼Œå¾ˆæ–¹ä¾¿
            item.className = "sticker-item";
            item.style.backgroundImage = `url(${frame.url})`;
            item.title = frame.name;

            const deleteBtn = document.createElement("div");
            deleteBtn.className = "delete-btn";
            deleteBtn.innerHTML = "Ã—";
            deleteBtn.style.display = "block";
            deleteBtn.onclick = async (e) => {
              e.stopPropagation();
              const confirmed = await showCustomConfirm(
                "åˆ é™¤å¤´åƒæ¡†",
                `ç¡®å®šè¦åˆ é™¤â€œ${frame.name}â€å—ï¼Ÿ`,
                {
                  confirmButtonClass: "btn-danger",
                },
              );
              if (confirmed) {
                await db.customAvatarFrames.delete(frame.id);
                renderFrameManager(); // åˆ·æ–°ç®¡ç†åˆ—è¡¨
              }
            };
            item.appendChild(deleteBtn);
            grid.appendChild(item);
          });
        }

        /**
         * å¤„ç†ç”¨æˆ·ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒæ¡†çš„é€»è¾‘
         */
        function handleUploadCustomFrame() {
          document.getElementById("custom-frame-upload-input").addEventListener(
            "change",
            async (event) => {
              const files = event.target.files;
              if (!files.length) return;

              const newFrames = [];

              // ä½¿ç”¨ for...of å¾ªç¯æ¥é€ä¸ªå¤„ç†é€‰ä¸­çš„æ–‡ä»¶
              for (const file of files) {
                // è‡ªåŠ¨ç”Ÿæˆåå­—ï¼Œè€Œä¸æ˜¯è®©ç”¨æˆ·è¾“å…¥
                // ç”¨ "æ–‡ä»¶å (å‰8ä½) + æ—¶é—´æˆ³" æ¥ç¡®ä¿åå­—å‡ ä¹ä¸ä¼šé‡å¤
                const fileName = file.name
                  .replace(/\.[^/.]+$/, "")
                  .substring(0, 8);
                const autoName = `${fileName}_${Date.now()}`;

                const base64Url = await new Promise((resolve) => {
                  const reader = new FileReader();
                  reader.onload = (e) => resolve(e.target.result);
                  reader.readAsDataURL(file);
                });

                newFrames.push({
                  id: "frame_" + (Date.now() + newFrames.length), // ç¡®ä¿IDå”¯ä¸€
                  name: autoName,
                  url: base64Url,
                });
              }

              // å¾ªç¯ç»“æŸåï¼Œæ‰¹é‡æ·»åŠ åˆ°æ•°æ®åº“
              if (newFrames.length > 0) {
                await db.customAvatarFrames.bulkAdd(newFrames);
                renderFrameManager(); // åˆ·æ–°ç®¡ç†åˆ—è¡¨
                await showCustomAlert(
                  "ä¸Šä¼ æˆåŠŸ",
                  `å·²æˆåŠŸæ·»åŠ  ${newFrames.length} ä¸ªæ–°å¤´åƒæ¡†ï¼`,
                );
              }

              // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨çš„å€¼
              event.target.value = null;
            },
            { once: true },
          );

          document.getElementById("custom-frame-upload-input").click();
        }

        async function openFrameSelectorModal(type, targetId = null) {
          const grid = document.getElementById("avatar-frame-grid");
          grid.innerHTML = "";

          currentFrameSelection.type = type;
          currentFrameSelection.target = targetId;

          const chat = state.chats[state.activeChatId];
          let currentFrameUrl = "";
          let previewAvatarUrl = "";

          if (type === "char-weibo") {
            // å¦‚æœæ˜¯ä¸ºâ€œè§’è‰²å¾®åšâ€æ¢æ¡†
            const charChat = state.chats[currentViewingWeiboProfileId];
            currentFrameUrl = charChat.settings.weiboAvatarFrame || "";
            previewAvatarUrl = charChat.settings.weiboAvatar || defaultAvatar;
          } else if (type === "home_profile") {
            currentFrameUrl = state.globalSettings.homeAvatarFrame || "";
            previewAvatarUrl =
              document.getElementById("profile-avatar-img").src;
          } else if (type === "weibo_profile") {
            currentFrameUrl = state.qzoneSettings.weiboAvatarFrame || "";
            previewAvatarUrl = state.qzoneSettings.weiboAvatar || defaultAvatar;
          } else if (type === "ai") {
            currentFrameUrl = chat.settings.aiAvatarFrame || "";
            previewAvatarUrl = chat.settings.aiAvatar || defaultAvatar;
          } else if (type === "my") {
            currentFrameUrl = chat.settings.myAvatarFrame || "";
            previewAvatarUrl = chat.settings.myAvatar || defaultAvatar;
          } else if (type === "member" && targetId) {
            const member = chat.members.find((m) => m.id === targetId);
            if (member) {
              currentFrameUrl = member.avatarFrame || "";
              previewAvatarUrl = member.avatar || defaultGroupMemberAvatar;
            }
          }

          // åç»­æ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜
          const customFrames = await db.customAvatarFrames.toArray();
          const frameUrlSet = new Set();
          const allFrames = [...avatarFrames, ...customFrames].filter(
            (frame) => {
              if (!frame.url || !frameUrlSet.has(frame.url)) {
                frameUrlSet.add(frame.url);
                return true;
              }
              return false;
            },
          );

          allFrames.forEach((frame) => {
            const item = createFrameItem(frame, previewAvatarUrl);
            if (currentFrameUrl === frame.url) {
              item.classList.add("selected");
              currentFrameSelection.url = frame.url;
            }
            grid.appendChild(item);
          });

          document
            .getElementById("avatar-frame-modal")
            .classList.add("visible");
        }

        // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºä¸€ä¸ªå¤´åƒæ¡†é€‰é¡¹
        function createFrameItem(frame, previewAvatarSrc) {
          const item = document.createElement("div");
          item.className = "frame-item";
          item.title = frame.name;
          item.innerHTML = `
			        <img src="${previewAvatarSrc}" class="preview-avatar">
			        ${frame.url ? `<img src="${frame.url}" class="preview-frame" style="pointer-events: none;">` : ""}
			    `;
          item.addEventListener("click", () => {
            document
              .querySelectorAll("#avatar-frame-grid .frame-item")
              .forEach((el) => el.classList.remove("selected"));
            item.classList.add("selected");
            currentFrameSelection.url = frame.url;
          });
          return item;
        }

        // ä¿å­˜é€‰æ‹©

        async function saveSelectedFrames() {
          const { type, url, target } = currentFrameSelection;

          // å¯¹äºä¸å±äºâ€œè§’è‰²è®¾ç½®â€çš„åŠŸèƒ½ (æ¯”å¦‚ä¸»å±å¹•ã€å¾®åš)ï¼Œä¿æŒåŸæœ‰çš„ç«‹å³ä¿å­˜é€»è¾‘
          if (type === "char-weibo") {
            const charChat = state.chats[currentViewingWeiboProfileId];
            if (charChat) {
              charChat.settings.weiboAvatarFrame = url;
              await db.chats.put(charChat);
              await renderWeiboCharProfile(currentViewingWeiboProfileId);
            }
          } else if (type === "home_profile") {
            if (!state.globalSettings) state.globalSettings = {};
            state.globalSettings.homeAvatarFrame = url;
            await db.globalSettings.put(state.globalSettings);
            renderHomeScreenProfileFrame();
          } else if (type === "weibo_profile") {
            if (!state.qzoneSettings) state.qzoneSettings = {};
            state.qzoneSettings.weiboAvatarFrame = url;
            await saveQzoneSettings();
            await renderWeiboProfile();
          }
          // å¯¹äºâ€œè§’è‰²è®¾ç½®â€é‡Œçš„å¤´åƒæ¡†ä¸å†ç«‹å³ä¿å­˜ï¼Œåªåœ¨å†…å­˜ä¸­æ›´æ–°
          else {
            const chat = state.chats[state.activeChatId];
            if (!chat) return; // å®‰å…¨æ£€æŸ¥

            if (type === "ai") {
              chat.settings.aiAvatarFrame = url;
            } else if (type === "my") {
              chat.settings.myAvatarFrame = url;
            } else if (type === "member" && target) {
              const member = chat.members.find((m) => m.id === target);
              if (member) member.avatarFrame = url;
            }

            // æ•°æ®å°†åœ¨ç”¨æˆ·ç‚¹å‡»è§’è‰²è®¾ç½®ä¸»é¢æ¿çš„â€œä¿å­˜â€æŒ‰é’®æ—¶ï¼Œä¸å…¶ä»–æ‰€æœ‰è®¾ç½®ä¸€èµ·è¢«ä¿å­˜ã€‚
            console.log(`å¤´åƒæ¡†é€‰æ‹©å·²æš‚å­˜: type=${type}, url=${url}`);
          }

          // åªéœ€å…³é—­å¤´åƒæ¡†é€‰æ‹©å¼¹çª—å³å¯ï¼Œä¸åšå…¶ä»–å¤šä½™æ“ä½œ
          document
            .getElementById("avatar-frame-modal")
            .classList.remove("visible");
        }

        /**
         * æ£€æŸ¥ä¸¤ä¸ªæ—¶é—´æˆ³æ˜¯å¦åœ¨ä¸åŒçš„è‡ªç„¶æ—¥
         * @param {number} timestamp1 - æ–°æ¶ˆæ¯çš„æ—¶é—´æˆ³
         * @param {number | null} timestamp2 - ä¸Šä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³
         * @returns {boolean} - å¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼Œè¿”å› true
         */
        function isNewDay(timestamp1, timestamp2) {
          // å¦‚æœæ²¡æœ‰ä¸Šä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³ï¼Œè¯´æ˜è¿™æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œè‚¯å®šè¦æ˜¾ç¤ºæ—¥æœŸ
          if (!timestamp2) return true;

          const date1 = new Date(timestamp1);
          const date2 = new Date(timestamp2);

          // æ¯”è¾ƒå¹´ã€æœˆã€æ—¥æ˜¯å¦å®Œå…¨ç›¸åŒ
          return (
            date1.getFullYear() !== date2.getFullYear() ||
            date1.getMonth() !== date2.getMonth() ||
            date1.getDate() !== date2.getDate()
          );
        }

        /**
         * å°†æ—¶é—´æˆ³æ ¼å¼åŒ–ä¸º "XæœˆXæ—¥ HH:mm" çš„å½¢å¼
         * @param {number} timestamp - æ—¶é—´æˆ³
         * @returns {string} - æ ¼å¼åŒ–åçš„æ—¥æœŸå­—ç¬¦ä¸²
         */
        function formatDateStamp(timestamp) {
          const date = new Date(timestamp);
          const month = date.getMonth() + 1;
          const day = date.getDate();
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          return `${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
        }

        /**
         * æ ¹æ®æ—¶é—´æˆ³ï¼Œæ ¼å¼åŒ–èŠå¤©åˆ—è¡¨å³ä¾§çš„æ—¥æœŸ/æ—¶é—´æ˜¾ç¤º
         * @param {number} timestamp - æ¶ˆæ¯çš„æ—¶é—´æˆ³
         * @returns {string} - æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸² (ä¾‹å¦‚ "14:30", "æ˜¨å¤©", "08/03")
         */
        function formatChatListTimestamp(timestamp) {
          if (!timestamp) return ""; // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²

          const now = new Date();
          const msgDate = new Date(timestamp);

          // åˆ¤æ–­æ˜¯å¦ä¸ºä»Šå¤©
          const isToday =
            now.getFullYear() === msgDate.getFullYear() &&
            now.getMonth() === msgDate.getMonth() &&
            now.getDate() === msgDate.getDate();

          if (isToday) {
            // å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªæ˜¾ç¤ºæ—¶é—´
            return msgDate.toLocaleTimeString("zh-CN", {
              hour: "2-digit",
              minute: "2-digit",
            });
          }

          // åˆ¤æ–­æ˜¯å¦ä¸ºæ˜¨å¤©
          const yesterday = new Date();
          yesterday.setDate(now.getDate() - 1);
          const isYesterday =
            yesterday.getFullYear() === msgDate.getFullYear() &&
            yesterday.getMonth() === msgDate.getMonth() &&
            yesterday.getDate() === msgDate.getDate();

          if (isYesterday) {
            return "æ˜¨å¤©";
          }

          // åˆ¤æ–­æ˜¯å¦ä¸ºä»Šå¹´
          if (now.getFullYear() === msgDate.getFullYear()) {
            // å¦‚æœæ˜¯ä»Šå¹´ï¼Œæ˜¾ç¤º "æœˆ/æ—¥"
            const month = String(msgDate.getMonth() + 1).padStart(2, "0");
            const day = String(msgDate.getDate()).padStart(2, "0");
            return `${month}/${day}`;
          }

          // å¦‚æœæ˜¯æ›´æ—©çš„å¹´ä»½ï¼Œæ˜¾ç¤º "å¹´/æœˆ/æ—¥"
          const year = msgDate.getFullYear();
          const month = String(msgDate.getMonth() + 1).padStart(2, "0");
          const day = String(msgDate.getDate()).padStart(2, "0");
          return `${year}/${month}/${day}`;
        }

        /**
         * åˆ›å»ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„æ—¥æœŸæˆ³â€œä¼ªæ¶ˆæ¯â€å…ƒç´ 
         * @param {number} timestamp - è¯¥æ—¥æœŸæˆ³ä»£è¡¨çš„æ—¶é—´
         * @returns {HTMLElement} - åˆ›å»ºå¥½çš„ DOM å…ƒç´ 
         */
        function createDateStampElement(timestamp) {
          // 1. åˆ›å»ºæœ€å¤–å±‚çš„åŒ…è£¹ divï¼Œå’ŒçœŸå®æ¶ˆæ¯ä¸€æ ·
          const wrapper = document.createElement("div");
          wrapper.className = "message-wrapper date-stamp-wrapper";
          // æŠŠæ—¶é—´æˆ³å­˜èµ·æ¥ï¼Œè¿™æ˜¯å¤šé€‰å’Œåˆ é™¤çš„å…³é”®
          wrapper.dataset.timestamp = timestamp;

          // 2. åˆ›å»ºæ°”æ³¡ div
          const bubble = document.createElement("div");
          // åŒæ—¶åŠ ä¸Š .message-bubble ç±»ï¼Œè®©å¤šé€‰é€»è¾‘èƒ½æ‰¾åˆ°å®ƒ
          bubble.className = "message-bubble date-stamp-bubble";
          bubble.dataset.timestamp = timestamp;
          bubble.textContent = formatDateStamp(timestamp);

          wrapper.appendChild(bubble);

          // 3. ä¸ºå®ƒç»‘å®šå’ŒçœŸå®æ¶ˆæ¯å®Œå…¨ä¸€æ ·çš„äº‹ä»¶ç›‘å¬å™¨
          addLongPressListener(wrapper, () => {
            // æ—¥æœŸæˆ³ä¸æ”¯æŒå¤æ‚æ“ä½œï¼Œé•¿æŒ‰ç›´æ¥è¿›å…¥å¤šé€‰
            enterSelectionMode(timestamp);
          });
          wrapper.addEventListener("click", () => {
            if (isSelectionMode) {
              toggleMessageSelection(timestamp);
            }
          });

          return wrapper;
        }

        // --- ç¾åŒ–åŠŸèƒ½çš„æ ¸å¿ƒå˜é‡ ---
        let activeThemeId = null; // ç”¨äºè¿½è¸ªå½“å‰æ­£åœ¨ç¼–è¾‘çš„ä¸»é¢˜ID

        /**
         * å°†CSSä»£ç åº”ç”¨åˆ°é¡µé¢ä¸Š
         * @param {string} cssCode - è¦åº”ç”¨çš„CSSä»£ç å­—ç¬¦ä¸²
         */
        function applyThemeCss(cssCode) {
          const styleTag = document.getElementById("custom-theme-style");
          if (styleTag) {
            styleTag.innerHTML = cssCode || "";
          }
        }

        /**
         * ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰ä¸»é¢˜åˆ°ä¸‹æ‹‰é€‰æ‹©æ¡†
         */
        async function loadThemesToDropdown() {
          const selector = document.getElementById("theme-selector");
          selector.innerHTML = '<option value="">-- é€‰æ‹©æ–¹æ¡ˆæˆ–æ–°å»º --</option>'; // é»˜è®¤é€‰é¡¹

          const themes = await db.themes.toArray();
          themes.forEach((theme) => {
            const option = document.createElement("option");
            option.value = theme.id;
            option.textContent = theme.name;
            selector.appendChild(option);
          });
        }

        /**
         * å¤„ç†ç”¨æˆ·ä»ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªä¸»é¢˜çš„é€»è¾‘
         */
        async function handleThemeSelection() {
          const selector = document.getElementById("theme-selector");
          const editor = document.getElementById("theme-css-editor");
          activeThemeId = selector.value ? parseInt(selector.value) : null;

          if (activeThemeId) {
            const theme = await db.themes.get(activeThemeId);
            editor.value = theme.css;
          } else {
            // å¦‚æœé€‰æ‹©â€œ--â€ï¼Œå°±åŠ è½½æ¨¡æ¿
            editor.value = THEME_CSS_TEMPLATE;
          }
          // ç«‹å³åº”ç”¨é€‰ä¸­çš„æˆ–æ¨¡æ¿ä»£ç ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ•ˆæœ
          applyThemeCss(editor.value);
        }

        /**
         * ä¿å­˜å½“å‰ç¼–è¾‘åŒºçš„å†…å®¹åˆ°å½“å‰é€‰ä¸­çš„ä¸»é¢˜
         */
        async function saveCurrentTheme() {
          if (!activeThemeId) {
            alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–¹æ¡ˆï¼Œæˆ–ä½¿ç”¨â€œå¦å­˜ä¸ºâ€æ¥åˆ›å»ºæ–°æ–¹æ¡ˆã€‚");
            return;
          }
          const cssCode = document.getElementById("theme-css-editor").value;
          await db.themes.update(activeThemeId, { css: cssCode });
          alert("å½“å‰æ–¹æ¡ˆå·²ä¿å­˜ï¼");
        }

        /**
         * å°†å½“å‰ç¼–è¾‘åŒºçš„å†…å®¹å¦å­˜ä¸ºä¸€ä¸ªæ–°ä¸»é¢˜
         */
        async function saveAsNewTheme() {
          const themeName = await showCustomPrompt(
            "ä¿å­˜æ–°æ–¹æ¡ˆ",
            "è¯·è¾“å…¥æ–°æ–¹æ¡ˆçš„åç§°",
          );
          if (!themeName || !themeName.trim()) {
            if (themeName !== null) alert("æ–¹æ¡ˆåç§°ä¸èƒ½ä¸ºç©ºï¼");
            return;
          }
          const cssCode = document.getElementById("theme-css-editor").value;
          const newTheme = { name: themeName.trim(), css: cssCode };
          const newId = await db.themes.add(newTheme);

          // åˆ·æ–°ä¸‹æ‹‰æ¡†å¹¶è‡ªåŠ¨é€‰ä¸­æ–°ä¿å­˜çš„æ–¹æ¡ˆ
          await loadThemesToDropdown();
          document.getElementById("theme-selector").value = newId;
          activeThemeId = newId;

          alert(`æ–¹æ¡ˆ "${themeName}" å·²æˆåŠŸä¿å­˜ï¼`);
        }
        /**
         * æ‰“å¼€æ¸…é™¤è§’è‰²CSSçš„ç®¡ç†èœå•
         */
        async function openCharCssManager() {
          const choice = await showChoiceModal("æ¸…ç†è§’è‰²æ°”æ³¡æ ·å¼", [
            { text: "ğŸ§¹ ä¸€é”®æ¸…é™¤æ‰€æœ‰è§’è‰²çš„CSS", value: "clear_all" },
            { text: "ğŸ” é€‰æ‹©ç‰¹å®šè§’è‰²æ¸…é™¤", value: "select_char" },
          ]);

          if (!choice) return;

          if (choice === "clear_all") {
            await clearAllCharsCustomCss();
          } else if (choice === "select_char") {
            await openCharCssSelector();
          }
        }

        /**
         * æ¸…é™¤æ‰€æœ‰å•èŠè§’è‰²çš„è‡ªå®šä¹‰CSS
         */
        async function clearAllCharsCustomCss() {
          // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•è§’è‰²è®¾ç½®äº†CSS
          let hasAny = false;
          for (const chatId in state.chats) {
            const chat = state.chats[chatId];
            if (!chat.isGroup && chat.settings && chat.settings.customCss) {
              hasAny = true;
              break;
            }
          }

          if (!hasAny) {
            alert("å½“å‰æ²¡æœ‰ä»»ä½•è§’è‰²è®¾ç½®äº†è‡ªå®šä¹‰CSSï¼Œæ— éœ€æ¸…ç†ã€‚");
            return;
          }

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤å…¨æ¸…",
            "ç¡®å®šè¦æ¸…é™¤ã€æ‰€æœ‰ã€‘è§’è‰²çš„è‡ªå®šä¹‰æ°”æ³¡æ ·å¼(CSS)å—ï¼Ÿ\næ­¤æ“ä½œå°†ä½¿æ‰€æœ‰è§’è‰²æ¢å¤é»˜è®¤æˆ–å…¨å±€æ ·å¼ï¼Œä¸”ä¸å¯æ¢å¤ã€‚",
            { confirmButtonClass: "btn-danger" },
          );

          if (!confirmed) return;

          let count = 0;
          for (const chatId in state.chats) {
            const chat = state.chats[chatId];
            if (!chat.isGroup && chat.settings && chat.settings.customCss) {
              chat.settings.customCss = ""; // æ¸…ç©º
              count++;
              await db.chats.put(chat);
            }
          }

          // å¦‚æœå½“å‰æ­£åœ¨èŠå¤©çš„è§’è‰²è¢«æ¸…é™¤äº†ï¼Œåˆ·æ–°ä¸€ä¸‹ç•Œé¢
          if (state.activeChatId && !state.chats[state.activeChatId].isGroup) {
            renderChatInterface(state.activeChatId);
          }

          alert(`å·²æ¸…é™¤ ${count} ä¸ªè§’è‰²çš„è‡ªå®šä¹‰æ ·å¼ã€‚`);
        }

        /**
         * æ‰“å¼€é€‰æ‹©å™¨ï¼Œå‹¾é€‰è¦æ¸…é™¤çš„è§’è‰²
         */
        async function openCharCssSelector() {
          // 1. ç­›é€‰å‡ºæ‰€æœ‰è®¾ç½®äº†customCssçš„è§’è‰²
          const chatsWithCss = Object.values(state.chats).filter(
            (c) => !c.isGroup && c.settings && c.settings.customCss,
          );

          if (chatsWithCss.length === 0) {
            alert("å½“å‰æ²¡æœ‰ä»»ä½•è§’è‰²è®¾ç½®äº†è‡ªå®šä¹‰CSSã€‚");
            return;
          }

          // 2. å¤ç”¨ç°æœ‰çš„è‡ªå®šä¹‰æ¨¡æ€æ¡†æ¥æ˜¾ç¤ºåˆ—è¡¨
          const modal = document.getElementById("custom-modal-overlay");
          const modalTitle = document.getElementById("custom-modal-title");
          const modalBody = document.getElementById("custom-modal-body");
          const confirmBtn = document.getElementById("custom-modal-confirm");
          const cancelBtn = document.getElementById("custom-modal-cancel");

          modalTitle.textContent = "é€‰æ‹©è¦æ¸…é™¤æ ·å¼çš„è§’è‰²";
          modalBody.innerHTML =
            '<div id="css-char-list" style="max-height: 300px; overflow-y: auto; text-align: left;"></div>';

          const listEl = document.getElementById("css-char-list");

          // 3. ç”Ÿæˆåˆ—è¡¨
          chatsWithCss.forEach((chat) => {
            const item = document.createElement("div");
            item.style.cssText =
              "display:flex; align-items:center; padding:10px; border-bottom:1px solid #eee; cursor:pointer;";
            item.innerHTML = `
            <input type="checkbox" class="css-clear-checkbox" value="${
              chat.id
            }" style="margin-right:10px; transform: scale(1.2);">
            <img src="${
              chat.settings.aiAvatar || defaultAvatar
            }" style="width:30px; height:30px; border-radius:50%; margin-right:10px; object-fit: cover;">
            <div style="flex:1;">
                <div style="font-weight:bold;">${chat.name}</div>
                <div style="font-size:10px; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 150px;">
                    ${chat.settings.customCss.substring(0, 30).replace(/\n/g, "")}...
                </div>
            </div>
        `;
            // ç‚¹å‡»è¡Œå³å¯å‹¾é€‰
            item.addEventListener("click", (e) => {
              if (e.target.type !== "checkbox") {
                const cb = item.querySelector("input");
                cb.checked = !cb.checked;
              }
            });
            listEl.appendChild(item);
          });

          // 4. è®¾ç½®æŒ‰é’®æ ·å¼å’Œäº‹ä»¶
          confirmBtn.textContent = "æ¸…é™¤é€‰ä¸­";
          confirmBtn.classList.add("btn-danger");
          cancelBtn.style.display = "block";

          // å…‹éš†æŒ‰é’®ä»¥ç§»é™¤æ—§çš„ç›‘å¬å™¨
          const newConfirmBtn = confirmBtn.cloneNode(true);
          confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

          newConfirmBtn.addEventListener("click", async () => {
            const selectedCheckboxes = document.querySelectorAll(
              ".css-clear-checkbox:checked",
            );
            if (selectedCheckboxes.length === 0) {
              alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§’è‰²ã€‚");
              return;
            }

            const ids = Array.from(selectedCheckboxes).map((cb) => cb.value);
            for (const id of ids) {
              const chat = state.chats[id];
              if (chat) {
                chat.settings.customCss = ""; // æ¸…ç©º
                await db.chats.put(chat);
              }
            }

            modal.classList.remove("visible");
            confirmBtn.classList.remove("btn-danger"); // æ¢å¤æ ·å¼

            // å¦‚æœå½“å‰èŠå¤©çš„è§’è‰²è¢«æ¸…é™¤äº†ï¼Œåˆ·æ–°ç•Œé¢
            if (state.activeChatId && ids.includes(state.activeChatId)) {
              renderChatInterface(state.activeChatId);
            }

            alert(`å·²æ¸…é™¤ ${ids.length} ä¸ªè§’è‰²çš„æ ·å¼ã€‚`);
          });

          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          modal.classList.add("visible");
        }

        /**
         * é‡å‘½åå½“å‰é€‰ä¸­çš„ä¸»é¢˜
         */
        async function renameSelectedTheme() {
          if (!activeThemeId) {
            alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦é‡å‘½åçš„æ–¹æ¡ˆã€‚");
            return;
          }
          const currentTheme = await db.themes.get(activeThemeId);
          const newName = await showCustomPrompt(
            "é‡å‘½åæ–¹æ¡ˆ",
            "è¯·è¾“å…¥æ–°çš„åç§°",
            currentTheme.name,
          );
          if (newName && newName.trim()) {
            await db.themes.update(activeThemeId, { name: newName.trim() });
            await loadThemesToDropdown();
            document.getElementById("theme-selector").value = activeThemeId;
            alert("é‡å‘½åæˆåŠŸï¼");
          }
        }

        /**
         * åˆ é™¤å½“å‰é€‰ä¸­çš„ä¸»é¢˜
         */
        async function deleteSelectedTheme() {
          if (!activeThemeId) {
            alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„æ–¹æ¡ˆã€‚");
            return;
          }
          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            `ç¡®å®šè¦åˆ é™¤æ–¹æ¡ˆ "${document.getElementById("theme-selector").selectedOptions[0].textContent}" å—ï¼Ÿ`,
            { confirmButtonClass: "btn-danger" },
          );
          if (confirmed) {
            await db.themes.delete(activeThemeId);
            activeThemeId = null;
            await loadThemesToDropdown();
            // æ¢å¤åˆ°æ¨¡æ¿çŠ¶æ€
            document.getElementById("theme-css-editor").value =
              THEME_CSS_TEMPLATE;
            applyThemeCss(THEME_CSS_TEMPLATE);
            alert("æ–¹æ¡ˆå·²åˆ é™¤ã€‚");
          }
        }

        /**
         * å¯¼å‡ºå½“å‰é€‰ä¸­çš„ä¸»é¢˜ä¸ºä¸€ä¸ªJSONæ–‡ä»¶
         */
        async function exportTheme() {
          if (!activeThemeId) {
            alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦å¯¼å‡ºçš„æ–¹æ¡ˆã€‚");
            return;
          }
          const theme = await db.themes.get(activeThemeId);
          const exportData = {
            themeName: theme.name,
            themeCss: theme.css,
          };
          const blob = new Blob([JSON.stringify(exportData, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${theme.name}-Theme.json`;
          a.click();
          URL.revokeObjectURL(url);
        }

        /**
         * å¯¼å…¥ä¸»é¢˜ (æ”¯æŒ JSON, TXT, CSS, DOCX)
         */
        function importTheme(file) {
          if (!file) return;

          const fileName = file.name.toLowerCase();
          const editor = document.getElementById("theme-css-editor"); // è·å–ç¼–è¾‘å™¨æ–‡æœ¬æ¡†

          // --- æƒ…å†µA: å¦‚æœæ˜¯ Word æ–‡æ¡£ (.docx) ---
          if (fileName.endsWith(".docx")) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const arrayBuffer = e.target.result;
              // ä½¿ç”¨ mammoth æå–çº¯æ–‡æœ¬
              mammoth
                .extractRawText({ arrayBuffer: arrayBuffer })
                .then(function (result) {
                  const extractedText = result.value; // è·å–æå–çš„æ–‡å­—
                  editor.value = extractedText; // å¡«å…¥æ–‡æœ¬æ¡†
                  applyThemeCss(extractedText); // ç«‹å³åº”ç”¨é¢„è§ˆ
                  alert(`æˆåŠŸä»Wordæ–‡æ¡£è¯»å–CSSï¼`);
                })
                .catch(function (err) {
                  console.error(err);
                  alert("è¯»å–Wordæ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æœªæŸåã€‚");
                });
            };
            reader.readAsArrayBuffer(file);
            return;
          }

          // --- æƒ…å†µB: å¦‚æœæ˜¯æ–‡æœ¬æ–‡ä»¶ (.txt æˆ– .css) ---
          if (fileName.endsWith(".txt") || fileName.endsWith(".css")) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const text = e.target.result;
              editor.value = text; // å¡«å…¥æ–‡æœ¬æ¡†
              applyThemeCss(text); // ç«‹å³åº”ç”¨é¢„è§ˆ
              alert(`æˆåŠŸå¯¼å…¥æ–‡æœ¬å†…å®¹ï¼`);
            };
            reader.readAsText(file);
            return;
          }

          // --- æƒ…å†µC: å¦‚æœæ˜¯ JSON (æ—§é€»è¾‘) ---
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const data = JSON.parse(e.target.result);
              if (data.themeName && typeof data.themeCss !== "undefined") {
                const newTheme = {
                  name: `${data.themeName} (å¯¼å…¥)`,
                  css: data.themeCss,
                };
                const newId = await db.themes.add(newTheme);
                await loadThemesToDropdown();
                document.getElementById("theme-selector").value = newId;
                handleThemeSelection(); // å¯¼å…¥åè‡ªåŠ¨é€‰ä¸­å¹¶åº”ç”¨
                alert(`æ–¹æ¡ˆ "${newTheme.name}" å¯¼å…¥æˆåŠŸï¼`);
              } else {
                // å¦‚æœè§£æJSONå¤±è´¥ï¼Œå¯èƒ½æ˜¯ç”¨æˆ·é€‰é”™äº†æ–‡ä»¶ï¼Œå°è¯•å½“ä½œçº¯æ–‡æœ¬å¡«å…¥
                editor.value = e.target.result;
                alert("JSONæ ¼å¼ä¸åŒ¹é…ï¼Œå·²å°è¯•å°†å†…å®¹ä½œä¸ºçº¯æ–‡æœ¬å¡«å…¥ç¼–è¾‘å™¨ã€‚");
              }
            } catch (error) {
              // æœ€åçš„å…œåº•ï¼šå¦‚æœä¸æ˜¯JSONï¼Œç›´æ¥å¡«è¿›å»
              editor.value = e.target.result;
              applyThemeCss(e.target.result);
              alert("å·²å°†æ–‡ä»¶å†…å®¹å¡«å…¥ç¼–è¾‘å™¨ã€‚");
            }
          };
          reader.readAsText(file);
        }

        /**
         * æ¸²æŸ“å¹¶å¡«å……APIé¢„è®¾çš„ä¸‹æ‹‰é€‰æ‹©æ¡†
         */
        function renderApiPresetSelector() {
          const selectEl = document.getElementById("api-preset-select");
          if (!selectEl) return;

          selectEl.innerHTML = '<option value="">-- è‡ªå®šä¹‰é…ç½® --</option>';

          if (state.apiPresets) {
            state.apiPresets.forEach((preset) => {
              const option = document.createElement("option");
              option.value = preset.id;
              option.textContent = preset.name;
              selectEl.appendChild(option);
            });
          }

          // æ£€æŸ¥å½“å‰é…ç½®æ˜¯å¦åŒ¹é…ä»»ä½•ä¸€ä¸ªé¢„è®¾
          const { proxyUrl, apiKey } = state.apiConfig;
          const matchingPreset = state.apiPresets
            ? state.apiPresets.find(
                (p) => p.proxyUrl === proxyUrl && p.apiKey === apiKey,
              )
            : null;

          if (matchingPreset) {
            selectEl.value = matchingPreset.id;
          } else {
            selectEl.value = ""; // å¦‚æœä¸åŒ¹é…ä»»ä½•é¢„è®¾ï¼Œåˆ™é€‰ä¸­â€œè‡ªå®šä¹‰é…ç½®â€
          }
        }

        /**
         * å½“ç”¨æˆ·åœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ—¶è§¦å‘
         */
        function handleApiPresetSelectChange() {
          const selectEl = document.getElementById("api-preset-select");
          const proxyUrlInput = document.getElementById("proxy-url");
          const apiKeyInput = document.getElementById("api-key");
          const selectedId = parseInt(selectEl.value);

          if (selectedId && state.apiPresets) {
            const selectedPreset = state.apiPresets.find(
              (p) => p.id === selectedId,
            );
            if (selectedPreset) {
              proxyUrlInput.value = selectedPreset.proxyUrl;
              apiKeyInput.value = selectedPreset.apiKey;
            }
          }
        }

        /**
         * æ‰“å¼€é¢„è®¾ç®¡ç†çš„æ“ä½œèœå•
         */
        async function openApiPresetManager() {
          const selectEl = document.getElementById("api-preset-select");
          const selectedId = parseInt(selectEl.value);
          const selectedPreset = state.apiPresets
            ? state.apiPresets.find((p) => p.id === selectedId)
            : null;

          const modal = document.getElementById("preset-actions-modal");
          const footer = modal.querySelector(".custom-modal-footer");

          footer.innerHTML = `
			        <button id="preset-action-save-new">ä¿å­˜å½“å‰é…ç½®ä¸ºæ–°é¢„è®¾</button>
			        <button id="preset-action-update-current" ${!selectedPreset ? "disabled" : ""}>æ›´æ–°å½“å‰é…ç½®</button>
			        <button id="preset-action-delete-current" class="btn-danger" ${
                !selectedPreset ? "disabled" : ""
              }>åˆ é™¤å½“å‰é…ç½®</button>
			        <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
			    `;

          document
            .getElementById("preset-action-save-new")
            .addEventListener("click", saveCurrentApiConfigAsPreset);
          if (selectedPreset) {
            document
              .getElementById("preset-action-update-current")
              .addEventListener("click", () =>
                updateSelectedApiPreset(selectedId),
              );
            document
              .getElementById("preset-action-delete-current")
              .addEventListener("click", () =>
                deleteSelectedApiPreset(selectedId),
              );
          }
          document
            .getElementById("preset-action-cancel")
            .addEventListener("click", () => modal.classList.remove("visible"));

          modal.classList.add("visible");
        }

        /**
         * å°†å½“å‰è¾“å…¥æ¡†çš„å†…å®¹ä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
         */
        async function saveCurrentApiConfigAsPreset() {
          const proxyUrl = document.getElementById("proxy-url").value.trim();
          const apiKey = document.getElementById("api-key").value.trim();

          if (!proxyUrl || !apiKey) {
            alert("ä»£ç†åœ°å€å’Œå¯†é’¥éƒ½ä¸èƒ½ä¸ºç©ºï¼");
            return;
          }

          const name = await showCustomPrompt(
            "ä¿å­˜APIé¢„è®¾",
            "è¯·ä¸ºè¿™ä¸ªé…ç½®èµ·ä¸ªåå­—ï¼š",
          );
          if (name && name.trim()) {
            const newPreset = { name: name.trim(), proxyUrl, apiKey };
            const newId = await db.apiPresets.add(newPreset);

            if (!state.apiPresets) state.apiPresets = [];
            state.apiPresets.push({ id: newId, ...newPreset });

            renderApiPresetSelector();
            document.getElementById("api-preset-select").value = newId;
            document
              .getElementById("preset-actions-modal")
              .classList.remove("visible");
            await showCustomAlert("æˆåŠŸ", `APIé¢„è®¾ "${name.trim()}" å·²ä¿å­˜ï¼`);
          }
        }

        /**
         * æ›´æ–°å½“å‰é€‰ä¸­çš„é¢„è®¾
         */
        async function updateSelectedApiPreset(presetId) {
          const proxyUrl = document.getElementById("proxy-url").value.trim();
          const apiKey = document.getElementById("api-key").value.trim();

          if (!proxyUrl || !apiKey) {
            alert("ä»£ç†åœ°å€å’Œå¯†é’¥éƒ½ä¸èƒ½ä¸ºç©ºï¼");
            return;
          }

          const preset = state.apiPresets.find((p) => p.id === presetId);
          if (preset) {
            preset.proxyUrl = proxyUrl;
            preset.apiKey = apiKey;
            await db.apiPresets.put(preset);
            document
              .getElementById("preset-actions-modal")
              .classList.remove("visible");
            await showCustomAlert("æˆåŠŸ", `é¢„è®¾ "${preset.name}" å·²æ›´æ–°ï¼`);
          }
        }

        /**
         * åˆ é™¤å½“å‰é€‰ä¸­çš„é¢„è®¾
         */
        async function deleteSelectedApiPreset(presetId) {
          const preset = state.apiPresets.find((p) => p.id === presetId);
          if (preset) {
            const confirmed = await showCustomConfirm(
              "ç¡®è®¤åˆ é™¤",
              `ç¡®å®šè¦åˆ é™¤APIé¢„è®¾ "${preset.name}" å—ï¼Ÿ`,
              {
                confirmButtonClass: "btn-danger",
              },
            );
            if (confirmed) {
              await db.apiPresets.delete(presetId);
              state.apiPresets = state.apiPresets.filter(
                (p) => p.id !== presetId,
              );

              renderApiPresetSelector();
              document
                .getElementById("preset-actions-modal")
                .classList.remove("visible");
              await showCustomAlert("æˆåŠŸ", "é¢„è®¾å·²åˆ é™¤ã€‚");
            }
          }
        }

        /**
         * æ¸²æŸ“å¹¶å¡«å……æ°”æ³¡æ ·å¼é¢„è®¾çš„ä¸‹æ‹‰é€‰æ‹©æ¡†
         */
        function renderBubblePresetSelector() {
          const selectEl = document.getElementById(
            "bubble-style-preset-select",
          );
          const customCssInput = document.getElementById("custom-css-input");

          selectEl.innerHTML = '<option value="">-- æ— é¢„è®¾ --</option>';

          if (state.bubbleStylePresets) {
            state.bubbleStylePresets.forEach((preset) => {
              const option = document.createElement("option");
              option.value = preset.id;
              option.textContent = preset.name;
              selectEl.appendChild(option);
            });
          }

          // æ£€æŸ¥å½“å‰èŠå¤©çš„CSSæ˜¯å¦åŒ¹é…ä»»ä½•ä¸€ä¸ªé¢„è®¾
          const currentCss = customCssInput.value.trim();
          const matchingPreset = state.bubbleStylePresets
            ? state.bubbleStylePresets.find((p) => p.css.trim() === currentCss)
            : null;

          if (matchingPreset) {
            selectEl.value = matchingPreset.id;
          } else {
            selectEl.value = ""; // å¦‚æœä¸åŒ¹é…ä»»ä½•é¢„è®¾ï¼Œåˆ™é€‰ä¸­â€œæ— é¢„è®¾â€
          }
        }

        /**
         * å½“ç”¨æˆ·åœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ—¶è§¦å‘
         */
        function handlePresetSelectChange() {
          const selectEl = document.getElementById(
            "bubble-style-preset-select",
          );
          const customCssInput = document.getElementById("custom-css-input");
          const selectedId = parseInt(selectEl.value);

          if (selectedId && state.bubbleStylePresets) {
            const selectedPreset = state.bubbleStylePresets.find(
              (p) => p.id === selectedId,
            );
            if (selectedPreset) {
              customCssInput.value = selectedPreset.css;
            }
          }
          updateSettingsPreview(); // æ— è®ºå¦‚ä½•éƒ½æ›´æ–°é¢„è§ˆ
        }

        /**
         * æ‰“å¼€é¢„è®¾ç®¡ç†çš„æ“ä½œèœå•
         */
        async function openBubblePresetManager() {
          const selectEl = document.getElementById(
            "bubble-style-preset-select",
          );
          const selectedId = parseInt(selectEl.value);
          const selectedPreset = state.bubbleStylePresets
            ? state.bubbleStylePresets.find((p) => p.id === selectedId)
            : null;

          const modal = document.getElementById("preset-actions-modal"); // å¤ç”¨ç°æœ‰æ¨¡æ€æ¡†
          const footer = modal.querySelector(".custom-modal-footer");

          footer.innerHTML = `
			        <button id="preset-action-save-new">ä¿å­˜</button>
			        <button id="preset-action-update-current" ${!selectedPreset ? "disabled" : ""}>æ›´æ–°</button>
			        <button id="preset-action-delete-current" class="btn-danger" ${!selectedPreset ? "disabled" : ""}>åˆ é™¤</button>
			        <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
			    `;

          // é‡æ–°ç»‘å®šäº‹ä»¶
          document
            .getElementById("preset-action-save-new")
            .addEventListener("click", saveCurrentCssAsPreset);
          if (selectedPreset) {
            document
              .getElementById("preset-action-update-current")
              .addEventListener("click", () =>
                updateSelectedPreset(selectedId),
              );
            document
              .getElementById("preset-action-delete-current")
              .addEventListener("click", () =>
                deleteSelectedPreset(selectedId),
              );
          }
          document
            .getElementById("preset-action-cancel")
            .addEventListener("click", () => modal.classList.remove("visible"));

          modal.classList.add("visible");
        }

        /**
         * å°†å½“å‰CSSæ–‡æœ¬æ¡†çš„å†…å®¹ä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
         */
        async function saveCurrentCssAsPreset() {
          const customCssInput = document.getElementById("custom-css-input");
          const css = customCssInput.value.trim();
          if (!css) {
            alert("CSSå†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
            return;
          }

          const name = await showCustomPrompt(
            "ä¿å­˜é¢„è®¾",
            "è¯·ä¸ºè¿™ä¸ªæ°”æ³¡æ ·å¼å‘½åï¼š",
          );
          if (name && name.trim()) {
            const newPreset = { name: name.trim(), css: css };
            const newId = await db.bubbleStylePresets.add(newPreset);

            if (!state.bubbleStylePresets) state.bubbleStylePresets = [];
            state.bubbleStylePresets.push({ id: newId, ...newPreset });

            renderBubblePresetSelector();
            document.getElementById("bubble-style-preset-select").value = newId;
            document
              .getElementById("preset-actions-modal")
              .classList.remove("visible");
            await showCustomAlert("æˆåŠŸ", `é¢„è®¾ "${name.trim()}" å·²ä¿å­˜ï¼`);
          }
        }

        /**
         * æ›´æ–°å½“å‰é€‰ä¸­çš„é¢„è®¾
         */
        async function updateSelectedPreset(presetId) {
          const customCssInput = document.getElementById("custom-css-input");
          const css = customCssInput.value.trim();

          const preset = state.bubbleStylePresets.find(
            (p) => p.id === presetId,
          );
          if (preset) {
            preset.css = css;
            await db.bubbleStylePresets.put(preset);
            document
              .getElementById("preset-actions-modal")
              .classList.remove("visible");
            await showCustomAlert("æˆåŠŸ", `é¢„è®¾ "${preset.name}" å·²æ›´æ–°ï¼`);
          }
        }

        /**
         * åˆ é™¤å½“å‰é€‰ä¸­çš„é¢„è®¾
         */
        async function deleteSelectedPreset(presetId) {
          const preset = state.bubbleStylePresets.find(
            (p) => p.id === presetId,
          );
          if (preset) {
            const confirmed = await showCustomConfirm(
              "ç¡®è®¤åˆ é™¤",
              `ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${preset.name}" å—ï¼Ÿ`,
              {
                confirmButtonClass: "btn-danger",
              },
            );
            if (confirmed) {
              await db.bubbleStylePresets.delete(presetId);
              state.bubbleStylePresets = state.bubbleStylePresets.filter(
                (p) => p.id !== presetId,
              );

              renderBubblePresetSelector();
              document.getElementById("custom-css-input").value = "";
              updateSettingsPreview();

              document
                .getElementById("preset-actions-modal")
                .classList.remove("visible");
              await showCustomAlert("æˆåŠŸ", "é¢„è®¾å·²åˆ é™¤ã€‚");
            }
          }
        }

        /**
         * æ’­æ”¾æ¥ç”µé“ƒå£°
         */
        function playRingtone() {
          const ringtonePlayer = document.getElementById("ringtone-player");
          // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·åœ¨è®¾ç½®ä¸­ä¿å­˜çš„URLï¼Œå¦‚æœæ²¡è®¾ç½®ï¼Œå°±ç”¨æˆ‘ä»¬é¢„è®¾çš„URL
          const ringtoneUrl =
            state.globalSettings.ringtoneUrl ||
            "https://files.catbox.moe/3w7gla.mp3";

          if (ringtonePlayer && ringtoneUrl) {
            ringtonePlayer.src = ringtoneUrl;
            // play() è¿”å›ä¸€ä¸ª Promiseï¼Œæˆ‘ä»¬æœ€å¥½ç”¨ try...catch åŒ…è£¹ä»¥é˜²æ­¢æµè§ˆå™¨æŠ¥é”™
            const playPromise = ringtonePlayer.play();
            if (playPromise !== undefined) {
              playPromise.catch((error) => {
                console.error("é“ƒå£°æ’­æ”¾å¤±è´¥:", error);
                // å¯ä»¥åœ¨è¿™é‡Œç»™ç”¨æˆ·ä¸€ä¸ªé™éŸ³æç¤ºï¼Œå¦‚æœéœ€è¦çš„è¯
              });
            }
          }
        }

        /**
         * åœæ­¢å¹¶é‡ç½®æ¥ç”µé“ƒå£°
         */
        function stopRingtone() {
          const ringtonePlayer = document.getElementById("ringtone-player");
          if (ringtonePlayer) {
            ringtonePlayer.pause();
            ringtonePlayer.currentTime = 0; // å°†æ’­æ”¾è¿›åº¦é‡ç½®åˆ°å¼€å¤´
          }
        }

        /**
         * æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³ï¼Œå¢åŠ å¥å£®æ€§
         */
        function playNotificationSound() {
          const soundUrl =
            state.globalSettings.notificationSoundUrl ||
            "https://laddy-lulu.github.io/Ephone-stuffs/message.mp3";

          // 1. å¢åŠ å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœé“¾æ¥ä¸ºç©ºï¼Œç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
          if (!soundUrl || !soundUrl.trim()) return;

          try {
            const audio = new Audio(soundUrl);
            audio.volume = 0.7;

            audio.play().catch((error) => {
              // 2. ä¼˜åŒ–é”™è¯¯æç¤ºï¼Œç°åœ¨èƒ½æ›´å‡†ç¡®åœ°åæ˜ é—®é¢˜
              if (error.name === "NotAllowedError") {
                console.warn(
                  "æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³å¤±è´¥ï¼šç”¨æˆ·éœ€è¦å…ˆä¸é¡µé¢è¿›è¡Œä¸€æ¬¡äº¤äº’ï¼ˆå¦‚ç‚¹å‡»ï¼‰æ‰èƒ½è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘ã€‚",
                );
              } else {
                // å¯¹äºå…¶ä»–é”™è¯¯ï¼ˆæ¯”å¦‚æˆ‘ä»¬è¿™æ¬¡é‡åˆ°çš„ï¼‰ï¼Œç›´æ¥æ‰“å°é”™è¯¯è¯¦æƒ…
                console.error(
                  `æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³å¤±è´¥ (${error.name}): ${error.message}`,
                  "URL:",
                  soundUrl,
                );
              }
            });
          } catch (error) {
            console.error("åˆ›å»ºæç¤ºéŸ³Audioå¯¹è±¡æ—¶å‡ºé”™:", error);
          }
        }

        // éŸ³é¢‘ä¸Šä¸‹æ–‡è§£é”å‡½æ•°
        function unlockAudioContext() {
          const ringtonePlayer = document.getElementById("ringtone-player");
          // æ£€æŸ¥æ’­æ”¾å™¨æ˜¯å¦å¤„äºæš‚åœçŠ¶æ€ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¹‹å‰æ²¡æœ‰æˆåŠŸæ’­æ”¾è¿‡
          if (ringtonePlayer && ringtonePlayer.paused) {
            // å°è¯•æ’­æ”¾ï¼Œç„¶åç«‹åˆ»æš‚åœã€‚
            // è¿™ä¸ªæ“ä½œå¯¹ç”¨æˆ·æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œä½†èƒ½å‘Šè¯‰æµè§ˆå™¨ç”¨æˆ·å·²ä¸éŸ³é¢‘äº¤äº’ã€‚
            ringtonePlayer.play().catch(() => {}); // play() ä¼šè¿”å›ä¸€ä¸ª Promiseï¼Œæˆ‘ä»¬å¿½ç•¥ä»»ä½•å¯èƒ½å‘ç”Ÿçš„é”™è¯¯
            ringtonePlayer.pause();
            console.log("Ringtone audio context unlocked.");
          }
        }
        // â€œæŸ¥æ‰‹æœºâ€å†…å®¹å•æ¡åˆ é™¤åŠŸèƒ½
        /**
         * å¤„ç†è§’è‰²æ‰‹æœºå†…æ•°æ®åˆ é™¤çš„é€šç”¨å‡½æ•°
         * @param {string} dataType - è¦åˆ é™¤çš„æ•°æ®ç±»å‹, æ¯”å¦‚ 'memos', 'shoppingCart'
         * @param {number} index - è¦åˆ é™¤çš„æ•°æ®åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
         */
        async function handleCharacterDataDeletion(dataType, index) {
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];

          let dataArray;
          // å¤„ç†åƒ bank.transactions è¿™æ ·çš„åµŒå¥—æ•°æ®
          if (dataType.includes(".")) {
            const keys = dataType.split(".");
            dataArray = chat.characterPhoneData[keys[0]][keys[1]];
          } else {
            dataArray = chat.characterPhoneData[dataType];
          }

          if (!chat || !dataArray) return;

          const itemToDelete = dataArray[index];
          if (!itemToDelete) return;

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            "ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ",
            {
              confirmButtonClass: "btn-danger",
            },
          );

          if (confirmed) {
            dataArray.splice(index, 1);
            await db.chats.put(chat);

            // æ ¹æ®åˆ é™¤çš„ç±»å‹ï¼Œé‡æ–°æ¸²æŸ“å¯¹åº”çš„APPç•Œé¢
            switch (dataType) {
              case "memos":
                renderCharacterMemos();
                break;
              case "shoppingCart":
                renderCharacterShoppingCart();
                break;
              case "browserHistory":
                renderCharacterBrowser();
                break;
              case "diary":
                renderCharacterDiary();
                break;
              case "bank.transactions":
                renderCharacterBank();
                break;
              case "trajectory":
                renderCharacterTrajectory();
                break;
              case "appUsage":
                renderCharacterAppUsage();
                break;
              case "photoAlbum":
                renderCharacterPhotoAlbum();
                break;
            }
            alert("è®°å½•å·²åˆ é™¤ã€‚");
          }
        }

        /**
         * å¤„ç†è§’è‰²æ‰‹æœºå†…å•æ¡èŠå¤©æ¶ˆæ¯çš„åˆ é™¤
         * @param {string} contactName - æ­£åœ¨æŸ¥çœ‹çš„è”ç³»äººåç§°
         * @param {number} index - è¦åˆ é™¤çš„æ¶ˆæ¯åœ¨å†å²è®°å½•ä¸­çš„ç´¢å¼•
         */
        async function handleCharacterChatMessageDeletion(contactName, index) {
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];
          if (!chat) return;

          let historyArray;
          // åˆ¤æ–­æ˜¯å’Œâ€œæˆ‘â€çš„èŠå¤©è¿˜æ˜¯å’ŒNPCçš„èŠå¤©
          if (
            contactName ===
            (chat.characterPhoneData.chats["æˆ‘"]?.remarkName || "æˆ‘")
          ) {
            historyArray = chat.history;
          } else {
            historyArray = chat.characterPhoneData.chats[contactName]?.history;
          }

          if (!historyArray || !historyArray[index]) return;

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            "ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ",
            {
              confirmButtonClass: "btn-danger",
            },
          );

          if (confirmed) {
            historyArray.splice(index, 1);
            await db.chats.put(chat);

            // é‡æ–°æ¸²æŸ“å½“å‰èŠå¤©ç•Œé¢
            renderCharacterChatHistory(contactName);
            alert("æ¶ˆæ¯å·²åˆ é™¤ã€‚");
          }
        }

        // é”å±åŠŸèƒ½æ ¸å¿ƒå‡½æ•°

        /**
         * åº”ç”¨é”å±å£çº¸åˆ° #lock-screen å…ƒç´ 
         */
        function applyLockscreenWallpaper() {
          const lockScreen = document.getElementById("lock-screen");
          const wallpaper = state.globalSettings.lockscreenWallpaper;
          if (wallpaper && wallpaper.startsWith("data:image")) {
            lockScreen.style.backgroundImage = `url(${wallpaper})`;
          } else if (wallpaper) {
            lockScreen.style.backgroundImage = wallpaper;
          }
        }

        /**
         * æ˜¾ç¤ºé”å±ç•Œé¢
         */
        function lockPhone() {
          console.log("æ­£åœ¨é”å®šæ‰‹æœº...");
          isLocked = true;
          document.getElementById("lock-screen").classList.add("active");
          document
            .querySelectorAll(".screen:not(#lock-screen)")
            .forEach((s) => s.classList.remove("active"));
        }

        /**
         * è§£é”æ‰‹æœºï¼Œæ˜¾ç¤ºä¸»å±å¹•
         */
        function unlockPhone() {
          console.log("æ‰‹æœºå·²è§£é”ï¼");
          isLocked = false;
          // å½»åº•éšè—é”å±å’Œæ¯›ç»ç’ƒèƒŒæ™¯
          document.getElementById("lock-screen").classList.remove("active");
          const blurBg = document.getElementById("lock-screen-background-blur");
          blurBg.style.display = "none";
          blurBg.style.opacity = "0";

          // ç¡®ä¿ä¸»å±å¹•æ˜¯å”¯ä¸€æ¿€æ´»çš„é¡¶å±‚å±å¹•
          showScreen("home-screen");

          // é‡ç½®é”å±çš„æ ·å¼ï¼Œä¸ºä¸‹æ¬¡é”å®šåšå‡†å¤‡
          setTimeout(() => {
            const lockScreen = document.getElementById("lock-screen");
            const unlockHint = document.getElementById("unlock-hint");
            lockScreen.style.transition = "none";
            unlockHint.style.transition = "none";
            lockScreen.style.transform = "translateY(0)";
            lockScreen.offsetHeight;
            lockScreen.style.transition = "transform 0.3s ease-out";
            unlockHint.style.transition = "opacity 0.3s ease-out";
          }, 500);
        }

        /**
         * æ˜¾ç¤ºå¯†ç è¾“å…¥å¼¹çª—
         */
        function showPasswordModal() {
          const modal = document.getElementById("password-modal-overlay");
          const input = document.getElementById("password-input-field");
          input.value = ""; // æ¸…ç©ºä¸Šæ¬¡è¾“å…¥
          modal.classList.add("visible");
          setTimeout(() => input.focus(), 100); // å»¶è¿Ÿèšç„¦ï¼Œç¡®ä¿åŠ¨ç”»æµç•…
        }

        /**
         * éšè—å¯†ç è¾“å…¥å¼¹çª—
         */
        function hidePasswordModal() {
          document.getElementById(
            "password-modal-overlay",
          ).style.backgroundImage = "none";

          const modal = document.getElementById("password-modal-overlay");
          modal.classList.remove("visible");
          // ç§»é™¤å¯èƒ½å­˜åœ¨çš„é”™è¯¯åŠ¨ç”»ç±»
          modal
            .querySelector(".password-modal-content")
            .classList.remove("error");
          // å½“å–æ¶ˆè¾“å…¥å¯†ç æ—¶...
          // 1. éšè—æ¯›ç»ç’ƒèƒŒæ™¯
          const blurBg = document.getElementById("lock-screen-background-blur");
          blurBg.style.opacity = "0";
          setTimeout(() => {
            blurBg.style.display = "none";
          }, 300); // åŠ¨ç”»ç»“æŸåå†éšè—

          // 2. è®©é”å±ç•Œé¢æ»‘å›æ¥
          const lockScreen = document.getElementById("lock-screen");
          const unlockHint = document.getElementById("unlock-hint");
          lockScreen.style.transform = "translateY(0)";
          unlockHint.style.opacity = "1";
        }

        /**
         * æ£€æŸ¥ç”¨æˆ·è¾“å…¥çš„å¯†ç æ˜¯å¦æ­£ç¡®
         */
        function checkPassword() {
          const input = document.getElementById("password-input-field");
          const enteredPassword = input.value;
          const correctPassword = state.globalSettings.password;

          if (enteredPassword === correctPassword) {
            // --- å¯†ç æ­£ç¡® ---

            // 1. æå‰æŠŠä¸»å±å¹•åœ¨æœ€åº•å±‚æ¿€æ´»å¹¶å‡†å¤‡å¥½
            //    å› ä¸ºå®ƒ z-index æœ€ä½ï¼Œæ‰€ä»¥æš‚æ—¶è¿˜çœ‹ä¸åˆ°å®ƒã€‚
            showScreen("home-screen");

            // 2. éšè—å¯†ç è¾“å…¥æ¡† (å®ƒä¼šè‡ªå·±æ’­æ”¾æ·¡å‡ºåŠ¨ç”»)
            document
              .getElementById("password-modal-overlay")
              .classList.remove("visible");

            // 3. è®©æ¯›ç»ç’ƒèƒŒæ™¯ä¹Ÿå¼€å§‹æ·¡å‡º
            document.getElementById(
              "lock-screen-background-blur",
            ).style.opacity = "0";

            // 4. ç­‰å¾…æ·¡å‡ºåŠ¨ç”»æ’­æ”¾å®Œæ¯• (300æ¯«ç§’)ï¼Œå†æ‰§è¡Œæœ€ç»ˆçš„æ¸…ç†å·¥ä½œ
            setTimeout(unlockPhone, 300);
          } else {
            // --- å¯†ç é”™è¯¯ (é€»è¾‘ä¿æŒä¸å˜) ---
            const content = document.querySelector(".password-modal-content");
            content.classList.add("error");
            input.value = "";
            setTimeout(() => content.classList.remove("error"), 400);
          }
        }

        /**
         * æ›´æ–°é”å±ç•Œé¢çš„æ—¶é’Ÿ
         */
        function updateLockClock() {
          const now = new Date();
          const timeString = now.toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          });
          const dateString = now.toLocaleDateString("zh-CN", {
            weekday: "long",
            month: "long",
            day: "numeric",
          });
          document.getElementById("lock-main-time").textContent = timeString;
          document.getElementById("lock-main-date").textContent = dateString;
        }

        async function openBulkAddStickersModal() {
          const placeholder = `åœ¨è¿™é‡Œç²˜è´´è¡¨æƒ…åŒ…ï¼Œæ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n\nçŒ«çŒ«å–æ°´ï¼šhttps://..../cat.gif\nç‹—ç‹—æ‘‡å¤´ï¼šhttps://..../dog.png\n\n(æ”¯æŒç”¨ä¸­æ–‡å†’å·â€œï¼šâ€ã€è‹±æ–‡å†’å·â€œ:â€æˆ–ç©ºæ ¼åˆ†éš”)`;

          const textInput = await showCustomPrompt(
            "æ‰¹é‡æ·»åŠ è¡¨æƒ…(URL)",
            "ä¸€è¡Œä¸€ä¸ªï¼Œåç§°å’Œé“¾æ¥ç”¨å†’å·æˆ–ç©ºæ ¼éš”å¼€",
            "",
            "textarea",
          );

          if (!textInput || !textInput.trim()) {
            return;
          }

          const lines = textInput.trim().split("\n");
          const newStickers = [];
          let successCount = 0;
          let errorLines = [];

          lines.forEach((line, index) => {
            line = line.trim();
            if (!line) return;

            let name = "";
            let url = "";
            let splitIndex = -1;

            // 1. æŸ¥æ‰¾ URL çš„èµ·å§‹ä½ç½®
            const httpIndex = line.indexOf("http");
            const dataIndex = line.indexOf("data:image");

            if (httpIndex > -1) {
              splitIndex = httpIndex;
            } else if (dataIndex > -1) {
              splitIndex = dataIndex;
            }

            // 2. å¦‚æœæ‰¾åˆ°äº† URL çš„èµ·å§‹ä½ç½®
            if (splitIndex > 0) {
              // URL ä¹‹å‰çš„æ‰€æœ‰å†…å®¹éƒ½å±äºåç§°
              name = line.substring(0, splitIndex).trim();
              // ä» URL èµ·å§‹ä½ç½®åˆ°æœ«å°¾çš„æ‰€æœ‰å†…å®¹éƒ½å±äº URL
              url = line.substring(splitIndex).trim();

              // 3. æ¸…ç†åç§°æœ«å°¾å¯èƒ½å­˜åœ¨çš„åˆ†éš”ç¬¦
              if (name.endsWith(":") || name.endsWith("ï¼š")) {
                name = name.slice(0, -1).trim();
              }
            } else {
              // å¦‚æœæ‰¾ä¸åˆ° URLï¼Œè¯´æ˜æ ¼å¼æœ‰é—®é¢˜
              errorLines.push(index + 1);
              return; // è·³è¿‡æ­¤è¡Œ
            }

            if (
              name &&
              (url.startsWith("http") || url.startsWith("data:image"))
            ) {
              newStickers.push({
                id: "sticker_" + (Date.now() + index),
                url: url,
                name: name,
              });
              successCount++;
            } else {
              errorLines.push(index + 1);
            }
          });

          if (newStickers.length > 0) {
            await db.userStickers.bulkAdd(newStickers);
            state.userStickers.push(...newStickers);
            renderStickerPanel();
          }

          let reportMessage = `æ‰¹é‡å¯¼å…¥å®Œæˆï¼\n\næˆåŠŸå¯¼å…¥ï¼š${successCount} ä¸ªè¡¨æƒ…ã€‚`;
          if (errorLines.length > 0) {
            reportMessage += `\nå¤±è´¥è¡Œå·ï¼š${errorLines.join(", ")}ã€‚\n\nè¯·æ£€æŸ¥è¿™äº›è¡Œçš„æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚`;
          }
          await showCustomAlert("å¯¼å…¥æŠ¥å‘Š", reportMessage);
        }

        /**
         * æ ¹æ®è·ç¦»æ–‡æœ¬ï¼Œè®¡ç®—CSSå®½åº¦ç™¾åˆ†æ¯”
         * @param {string} distanceText - è·ç¦»æè¿°ï¼Œä¾‹å¦‚ "500m", "10km", "å¾ˆè¿‘"
         * @returns {number} - 10åˆ°90ä¹‹é—´çš„ç™¾åˆ†æ¯”
         */
        function calculatePinDistancePercentage(distanceText) {
          if (!distanceText) return 50; // é»˜è®¤å€¼

          const text = distanceText.toLowerCase();
          // æå–æ•°å­—éƒ¨åˆ†
          const matches = text.match(/(\d+(\.\d+)?)/);
          const num = matches ? parseFloat(matches[1]) : 0;

          // æ ¹æ®å•ä½æˆ–å…³é”®è¯åˆ¤æ–­
          if (text.includes("km") || text.includes("å…¬é‡Œ")) {
            if (num > 1000) return 90;
            if (num > 100) return 80;
            if (num > 10) return 70;
            if (num > 1) return 60;
            return 50;
          } else if (text.includes("m") || text.includes("ç±³")) {
            if (num > 500) return 40;
            if (num > 100) return 30;
            return 20;
          } else if (text.includes("è¿œ") || text.includes("ä¸åŒåŸå¸‚")) {
            return 90;
          } else if (text.includes("é™„è¿‘") || text.includes("éš”å£")) {
            return 20;
          } else if (text.includes("è¿‘")) {
            return 30;
          }

          return 15; // å¦‚æœæ— æ³•è¯†åˆ«ï¼Œç»™ä¸€ä¸ªæœ€å°çš„è·ç¦»
        }

        /**
         * åœ¨å®šä½æ¨¡æ€æ¡†ä¸­æ·»åŠ ä¸€ä¸ªé€”ç»ç‚¹è¾“å…¥æ¡†
         */
        function addTrajectoryPointInput(name = "") {
          const container = document.getElementById(
            "trajectory-points-container",
          );
          const div = document.createElement("div");
          div.style.display = "flex";
          div.style.gap = "8px";
          div.innerHTML = `
			        <input type="text" class="trajectory-point-input" placeholder="é€”ç»ç‚¹${
                container.children.length + 1
              }" value="${name}" style="flex-grow: 1;">
			        <button class="remove-option-btn">-</button>
			    `;
          div
            .querySelector(".remove-option-btn")
            .addEventListener("click", () => div.remove());
          container.appendChild(div);
        }

        async function sendUserLocation() {
          if (!state.activeChatId) return;

          const userLocation = document
            .getElementById("user-location-input")
            .value.trim();
          const aiLocation = document
            .getElementById("ai-location-input")
            .value.trim();
          const distance = document
            .getElementById("distance-input")
            .value.trim();

          if (!distance || (!userLocation && !aiLocation)) {
            alert("â€œæˆ‘çš„ä½ç½®â€å’Œâ€œTaçš„ä½ç½®â€è‡³å°‘è¦å¡«å†™ä¸€ä¸ªï¼Œä¸”â€œç›¸è·â€ä¸ºå¿…å¡«é¡¹ï¼");
            return;
          }

          const trajectoryPoints = Array.from(
            document.querySelectorAll(".trajectory-point-input"),
          )
            .map((input) => ({ name: input.value.trim() }))
            .filter((point) => point.name);

          const chat = state.chats[state.activeChatId];

          // 1. æ ¹æ®ç”¨æˆ·è¾“å…¥ï¼Œæ„å»ºä¸€æ¡AIèƒ½çœ‹æ‡‚çš„æ–‡æœ¬å†…å®¹
          //    è¿™ä¸ªæ ¼å¼å’ŒAIè‡ªå·±å‘å®šä½æ—¶ç”¨çš„æ ¼å¼ä¿æŒä¸€è‡´ï¼Œéå¸¸å®Œç¾ï¼
          let contentString = "[SEND_LOCATION]";
          if (userLocation) contentString += ` æˆ‘çš„ä½ç½®: ${userLocation}`;
          if (aiLocation) contentString += ` | ä½ çš„ä½ç½®: ${aiLocation}`;
          contentString += ` | ç›¸è·: ${distance}`;
          if (trajectoryPoints.length > 0) {
            const trajectoryText = trajectoryPoints
              .map((p) => p.name)
              .join(", ");
            contentString += ` | é€”ç»ç‚¹: ${trajectoryText}`;
          }

          // 2. åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ï¼Œè¿™æ¬¡æˆ‘ä»¬æŠŠåˆšåˆšåˆ›å»ºçš„ contentString ä¹Ÿæ”¾äº†è¿›å»
          const locationMessage = {
            role: "user",
            type: "location",
            timestamp: Date.now(),
            userLocation: userLocation,
            aiLocation: aiLocation,
            distance: distance,
            trajectoryPoints: trajectoryPoints,
            content: contentString, // <-- è¿™å°±æ˜¯æœ€å…³é”®çš„æ–°å¢å±æ€§ï¼
          };

          // åç»­çš„ä¿å­˜å’Œæ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜
          chat.history.push(locationMessage);
          await db.chats.put(chat);
          appendMessage(locationMessage, chat);
          renderChatList();

          document
            .getElementById("send-location-modal")
            .classList.remove("visible");
        }

        // â€œä¸€é”®é‡rollâ€åŠŸèƒ½æ ¸å¿ƒä»£ç 

        /**
         * æ™ºèƒ½æŸ¥æ‰¾AIä¸Šä¸€è½®å›å¤çš„æ‰€æœ‰æ¶ˆæ¯
         * @param {Array} history - å®Œæ•´çš„èŠå¤©å†å²è®°å½•
         * @returns {Array} - ä¸€ä¸ªåŒ…å«äº†ä¸Šä¸€è½®AIæ‰€æœ‰æ¶ˆæ¯å¯¹è±¡çš„æ•°ç»„
         */
        function findLastAiTurnMessages(history) {
          const turnMessages = [];
          let lastMessageIndex = history.length - 1;

          // ä»æœ€åä¸€æ¡æ¶ˆæ¯å¼€å§‹ï¼Œå‘å‰æŸ¥æ‰¾
          for (let i = lastMessageIndex; i >= 0; i--) {
            const message = history[i];

            // å¦‚æœæ˜¯AIçš„æ¶ˆæ¯ï¼Œå°±æŠŠå®ƒåŠ å…¥æˆ‘ä»¬çš„â€œå¾…åˆ é™¤åˆ—è¡¨â€
            if (message.role === "assistant") {
              turnMessages.unshift(message); // ä½¿ç”¨ unshift ä¿æŒåŸå§‹é¡ºåº
            }
            // ä¸€æ—¦é‡åˆ°éAIçš„æ¶ˆæ¯ï¼ˆç”¨æˆ·çš„æˆ–ç³»ç»Ÿçš„ï¼‰ï¼Œè¯´æ˜AIçš„è¿™ä¸€è½®å›å¤å·²ç»ç»“æŸäº†ï¼Œç«‹åˆ»åœæ­¢æŸ¥æ‰¾
            else {
              break;
            }
          }
          return turnMessages;
        }

        /**
         * â€œé‡rollâ€æŒ‰é’®è¢«ç‚¹å‡»æ—¶çš„ä¸»å¤„ç†å‡½æ•°
         */
        async function handleRerollClick() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];

          // 1. è°ƒç”¨æˆ‘ä»¬çš„æ™ºèƒ½æŸ¥æ‰¾å‡½æ•°ï¼Œæ‰¾å‡ºéœ€è¦åˆ é™¤çš„æ¶ˆæ¯
          const messagesToReroll = findLastAiTurnMessages(chat.history);

          // 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼ˆæ¯”å¦‚æœ€åä¸€æ¡æ˜¯ç”¨æˆ·å‘çš„ï¼‰ï¼Œå°±æç¤ºå¹¶é€€å‡º
          if (messagesToReroll.length === 0) {
            alert("è¯·åœ¨AIå›å¤åä½¿ç”¨æ­¤åŠŸèƒ½ã€‚");
            return;
          }

          // 3. ä»èŠå¤©è®°å½•ä¸­è¿‡æ»¤æ‰è¿™äº›æ—§æ¶ˆæ¯
          const timestampsToReroll = new Set(
            messagesToReroll.map((m) => m.timestamp),
          );
          chat.history = chat.history.filter(
            (msg) => !timestampsToReroll.has(msg.timestamp),
          );

          // 4. ä¿å­˜æ›´æ–°åçš„èŠå¤©è®°å½•åˆ°æ•°æ®åº“
          await db.chats.put(chat);

          // 5. åˆ·æ–°èŠå¤©ç•Œé¢ï¼Œè®©æ—§æ¶ˆæ¯ç¬é—´æ¶ˆå¤±
          renderChatInterface(state.activeChatId);

          // 6. è§¦å‘ä¸€æ¬¡æ–°çš„AIå“åº”ï¼Œå°±åƒç”¨æˆ·ç‚¹å‡»äº†â€œç­‰å¾…å›å¤â€ä¸€æ ·
          triggerAiResponse();
        }

        function initDraggableLyricsBar() {
          const bar = document.getElementById("floating-lyrics-bar");
          const phoneScreen = document.getElementById("phone-screen");

          let isDragging = false;
          let offsetX, offsetY;

          const onDragStart = (e) => {
            // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯æŒ‰é’®ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¸å¼€å§‹æ‹–åŠ¨
            if (
              e.target.closest("#lyrics-settings-btn") ||
              e.target.closest(".close-btn")
            ) {
              return;
            }

            isDragging = true;
            bar.classList.add("dragging");

            const rect = bar.getBoundingClientRect();
            const coords = getEventCoords(e);

            offsetX = coords.x - rect.left;
            offsetY = coords.y - rect.top;

            document.addEventListener("mousemove", onDragMove);
            document.addEventListener("mouseup", onDragEnd);
            document.addEventListener("touchmove", onDragMove, {
              passive: false,
            });
            document.addEventListener("touchend", onDragEnd);
          };

          const onDragMove = (e) => {
            if (!isDragging) return;

            e.preventDefault();

            const phoneRect = phoneScreen.getBoundingClientRect();
            const coords = getEventCoords(e);

            let newLeft = coords.x - offsetX - phoneRect.left;
            let newTop = coords.y - offsetY - phoneRect.top;

            const maxLeft = phoneScreen.clientWidth - bar.offsetWidth;
            const maxTop = phoneScreen.clientHeight - bar.offsetHeight;

            newLeft = Math.max(0, Math.min(newLeft, maxLeft));
            newTop = Math.max(0, Math.min(newTop, maxTop));

            // åœ¨æ‹–åŠ¨æ—¶ï¼ŒåŒæ—¶è®¾ç½®left, topå¹¶æ¸…é™¤transform
            bar.style.left = `${newLeft}px`;
            bar.style.top = `${newTop}px`;
            bar.style.transform = "none";
          };

          const onDragEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            bar.classList.remove("dragging");

            document.removeEventListener("mousemove", onDragMove);
            document.removeEventListener("mouseup", onDragEnd);
            document.removeEventListener("touchmove", onDragMove);
            document.removeEventListener("touchend", onDragEnd);
          };

          bar.addEventListener("mousedown", onDragStart);
          bar.addEventListener("touchstart", onDragStart, { passive: true });
        }

        function applyLyricsSettings() {
          const bar = document.getElementById("floating-lyrics-bar");
          const toggleBtn = document.getElementById("toggle-lyrics-bar-btn");

          // åº”ç”¨æ ·å¼
          bar.style.fontSize = `${lyricsBarSettings.fontSize}px`;
          bar.style.color = lyricsBarSettings.fontColor;
          bar.style.backgroundColor = `rgba(0, 0, 0, ${lyricsBarSettings.bgOpacity / 100})`;

          // æ›´æ–°è®¾ç½®æ¨¡æ€æ¡†é‡Œçš„æ§ä»¶å€¼
          document.getElementById("lyrics-font-size-slider").value =
            lyricsBarSettings.fontSize;
          document.getElementById("lyrics-font-size-value").textContent =
            `${lyricsBarSettings.fontSize}px`;
          document.getElementById("lyrics-bg-opacity-slider").value =
            lyricsBarSettings.bgOpacity;
          document.getElementById("lyrics-bg-opacity-value").textContent =
            `${lyricsBarSettings.bgOpacity}%`;
          document.getElementById("lyrics-font-color-picker").value =
            lyricsBarSettings.fontColor;

          // æ›´æ–°æ’­æ”¾å™¨é‡Œçš„å¼€å…³æŒ‰é’®çŠ¶æ€
          if (toggleBtn) {
            toggleBtn.textContent = lyricsBarSettings.showOnClose
              ? "æ‚¬æµ®"
              : "éšè—";
            toggleBtn.style.opacity = lyricsBarSettings.showOnClose
              ? "1"
              : "0.5";
          }
        }

        /**
         * è·å–å¹¶æ ¼å¼åŒ–ã€ä¸å½“å‰èŠå¤©ç›¸å…³ã€‘çš„çº¦å®šï¼Œç”Ÿæˆç»™AIçœ‹çš„ä¸Šä¸‹æ–‡
         * @param {string} chatId - å½“å‰æ­£åœ¨èŠå¤©çš„è§’è‰²ID
         * @returns {Promise<string>} æ ¼å¼åŒ–åçš„çº¦å®šä¿¡æ¯å­—ç¬¦ä¸²
         */
        async function getCountdownContext(chatId) {
          // 1. ä»æ•°æ®åº“ä¸­æ‰¾å‡ºæ‰€æœ‰â€œçº¦å®šâ€ç±»å‹ï¼Œå¹¶ä¸”ç›®æ ‡æ—¥æœŸè¿˜æ²¡åˆ°çš„è®°å½•
          const activeCountdowns = await db.memories
            .where("type")
            .equals("countdown")
            .filter(
              (item) =>
                item.targetDate > Date.now() &&
                // å®ƒç°åœ¨åªä¼šæŸ¥æ‰¾ä¸¤ç§çº¦å®šï¼š
                // 1. chatId å’Œå½“å‰èŠå¤©è§’è‰²IDåŒ¹é…çš„ (AIè‡ªå·±åˆ›å»ºçš„)
                // 2. chatId ä¸ºç©ºçš„ (ä½ ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·åˆ›å»ºçš„å…¨å±€çº¦å®š)
                (item.chatId === chatId || item.chatId === null),
            )
            .toArray();

          // å¦‚æœæ²¡æœ‰ä¸å½“å‰è§’è‰²ç›¸å…³çš„çº¦å®šï¼Œå°±å‘Šè¯‰AIâ€œç›®å‰æ²¡æœ‰â€
          if (activeCountdowns.length === 0) {
            return "\n- **è¿‘æœŸçº¦å®š**: ç›®å‰æ²¡æœ‰ç‰¹åˆ«çš„çº¦å®šã€‚";
          }

          // 2. åç»­çš„æ•´ç†æŠ¥å‘Šé€»è¾‘ä¿æŒä¸å˜
          let context = "\n# è¿‘æœŸçº¦å®šä¸å€’è®¡æ—¶ (é‡è¦å‚è€ƒä¿¡æ¯)\n";
          const now = Date.now();

          activeCountdowns.forEach((item) => {
            const diff = item.targetDate - now;
            const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diff / (1000 * 60 * 60));

            let timeText;
            if (diffDays > 1) {
              timeText = `è¿˜æœ‰ ${diffDays} å¤©`;
            } else if (diffHours > 0) {
              timeText = `è¿˜æœ‰ ${diffHours} å°æ—¶`;
            } else {
              timeText = "å°±æ˜¯ç°åœ¨ï¼";
            }

            context += `- **${item.description}**: ${timeText} (ç›®æ ‡: ${new Date(item.targetDate).toLocaleString()})\n`;
          });

          return context;
        }

        // â€œæŸ¥è§’è‰²æ‰‹æœºâ€åŠŸèƒ½çš„æ‰€æœ‰æ ¸å¿ƒå‡½æ•°

        /**
         * å…¥å£ï¼šæ‰“å¼€è§’è‰²é€‰æ‹©ç•Œé¢
         */
        async function openCharacterSelectionScreen() {
          await renderCharacterSelectionScreen();
          showScreen("character-selection-screen");
        }

        /**
         * æ¸²æŸ“è§’è‰²é€‰æ‹©åˆ—è¡¨
         */
        async function renderCharacterSelectionScreen() {
          const listEl = document.getElementById("character-selection-list");
          listEl.innerHTML = "";
          const characters = Object.values(state.chats).filter(
            (chat) => !chat.isGroup,
          );

          if (characters.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">è¿˜æ²¡æœ‰å¯ä»¥æŸ¥çœ‹çš„è§’è‰²</p>';
            return;
          }

          characters.forEach((char) => {
            const item = document.createElement("div");
            item.className = "character-select-item";
            item.dataset.chatId = char.id;
            item.innerHTML = `
			            <img src="${char.settings.aiAvatar || defaultAvatar}" alt="${char.name}">
			            <span class="name">${char.name}</span>
			        `;
            listEl.appendChild(item);
          });
        }
        /**
         * å°†æŒ‡å®šçš„Appå†…å£çº¸åº”ç”¨åˆ°è§’è‰²æ‰‹æœºå±å¹•
         */
        function applyCharPhoneAppWallpaper() {
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];
          const innerScreen = document.querySelector(
            ".character-phone-inner-screen",
          );
          if (!innerScreen || !chat) return;

          const appWallpaperUrl = chat.characterPhoneData.appWallpaper;

          if (appWallpaperUrl) {
            innerScreen.style.backgroundImage = `url(${appWallpaperUrl})`;
            innerScreen.classList.add("has-app-wallpaper");
          } else {
            innerScreen.style.backgroundImage = "none";
            innerScreen.classList.remove("has-app-wallpaper");
          }
        }

        /**
         * å¤„ç†è§’è‰²æ‰‹æœºAppå†…å£çº¸çš„æ›´æ¢å’Œç§»é™¤
         * @param {string} newUrl - æ–°çš„å£çº¸URLï¼Œå¦‚æœä¸ºç©ºå­—ç¬¦ä¸²åˆ™è¡¨ç¤ºç§»é™¤
         */
        async function handleCharPhoneAppWallpaperChange(newUrl) {
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];
          if (!chat) return;

          chat.characterPhoneData.appWallpaper = newUrl;
          await db.chats.put(chat);

          // ç«‹å³åº”ç”¨å£çº¸
          applyCharPhoneAppWallpaper();

          // åˆ·æ–°è®¾ç½®é¡µé¢çš„é¢„è§ˆ
          renderCharPhoneAppearanceScreen();

          alert(newUrl ? "App å†…å£çº¸å·²æ›´æ–°ï¼" : "App å†…å£çº¸å·²ç§»é™¤ï¼");
        }

        function openCharacterPhone(chatId) {
          activeCharacterPhoneId = chatId;
          const chat = state.chats[chatId];
          if (!chat) return;

          document.getElementById("character-phone-owner-name").textContent =
            `${chat.name}çš„æ‰‹æœº`;

          const phoneHomeScreen = document.getElementById(
            "character-phone-screen",
          );
          const wallpaperUrl = chat.characterPhoneData.wallpaper;
          const isDarkMode = document
            .getElementById("phone-screen")
            .classList.contains("dark-mode");

          if (wallpaperUrl) {
            phoneHomeScreen.style.backgroundImage = `url(${wallpaperUrl})`;
            phoneHomeScreen.style.backgroundColor = "transparent";
            phoneHomeScreen.style.backgroundSize = "cover";
            phoneHomeScreen.style.backgroundPosition = "center";
          } else {
            phoneHomeScreen.style.backgroundImage = "none";
            phoneHomeScreen.style.backgroundColor = isDarkMode
              ? "#000000"
              : "#f0f2f5";
          }

          // --- æ¸²æŸ“å°ç»„ä»¶å›¾ç‰‡ ---
          const widgets = chat.characterPhoneData.widgets || {};
          document.getElementById("char-phone-widget-img-1").src =
            widgets.widget1_url || "";
          document.getElementById("char-phone-widget-img-2").src =
            widgets.widget2_url || "";

          renderCharacterAppGrid();

          showScreen("character-phone-container");
          showCharacterPhonePage("character-phone-screen");
          applyCharPhoneAppWallpaper();
        }

        function renderCharacterAppGrid() {
          const gridEl = document.getElementById("character-app-grid");
          gridEl.innerHTML = "";
          if (!activeCharacterPhoneId) return;

          const chat = state.chats[activeCharacterPhoneId];
          const customIcons = chat.characterPhoneData.appIcons || {};

          CHAR_PHONE_APPS.forEach((app) => {
            const iconEl = document.createElement("div");
            iconEl.className = "app-icon";

            const customIconUrl = customIcons[app.id];

            let iconBgStyle =
              "display: flex; justify-content: center; align-items: center; padding: 12px;";
            let iconHtml;

            if (customIconUrl) {
              // å¦‚æœæœ‰è‡ªå®šä¹‰å›¾æ ‡URL...
              // 1. è¦†ç›–æ‰ .icon-bg çš„æ ·å¼ï¼Œç§»é™¤å†…è¾¹è·å’ŒèƒŒæ™¯è‰²
              iconBgStyle = "padding: 0; background-color: transparent;";
              // 2. iconHtml ç›´æ¥å˜æˆä¸€ä¸ªå¸¦æœ‰åœ†è§’çš„å›¾ç‰‡
              iconHtml = `<img src="${customIconUrl}" style="width:100%; height:100%; object-fit:cover; border-radius: 18px;">`;
            } else {
              // å¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤çš„SVG
              iconHtml = app.svg;
            }

            // --- ä¿®æ”¹ç»“æŸ ---

            iconEl.innerHTML = `
			            <div class="icon-bg" style="${iconBgStyle}">
			                ${iconHtml}
			            </div>
			            <span class="label">${app.name}</span>
			        `;

            // åç»­çš„äº‹ä»¶ç›‘å¬ä»£ç ä¿æŒä¸å˜
            iconEl.addEventListener("click", () => {
              if (app.id === "appearance") {
                openCharPhoneAppearanceSettings();
              } else {
                switch (app.id) {
                  case "chat":
                    renderCharacterChatList();
                    break;
                  case "cart":
                    renderCharacterShoppingCart();
                    break;
                  case "memos":
                    renderCharacterMemos();
                    break;
                  case "browser":
                    renderCharacterBrowser();
                    break;
                  case "album":
                    renderCharacterPhotoAlbum();
                    break;
                  case "bank":
                    renderCharacterBank();
                    break;
                  case "trajectory":
                    renderCharacterTrajectory();
                    break;
                  case "app_usage":
                    renderCharacterAppUsage();
                    break;
                  case "diary":
                    renderCharacterDiary();
                    break;
                }
                showCharacterPhonePage(app.screen);
              }
            });
            gridEl.appendChild(iconEl);
          });
        }

        /**
         * æ‰“å¼€ç”ŸæˆèŠå¤©å¯¹è±¡çš„é€‰æ‹©å¼¹çª—
         */
        function openChatGenerationModal() {
          const listEl = document.getElementById("chat-gen-list");
          listEl.innerHTML = "";

          if (!activeCharacterPhoneId) return;
          const currentChat = state.chats[activeCharacterPhoneId];

          // 1. é‡ç½® UI çŠ¶æ€
          const randomCheckbox = document.getElementById(
            "chat-gen-random-checkbox",
          );
          randomCheckbox.checked = true; // é»˜è®¤éšæœº
          listEl.style.opacity = "0.5";
          listEl.style.pointerEvents = "none";

          // 2. æ”¶é›†æ‰€æœ‰å¯é€‰é¡¹ (NPC + å…¶ä»–ä¸»è§’)
          const options = [];

          // A. å½“å‰è§’è‰²çš„ NPC åº“
          if (currentChat.npcLibrary) {
            currentChat.npcLibrary.forEach((npc) => {
              options.push({
                type: "NPC",
                name: npc.name,
                persona: npc.persona,
                avatar: npc.avatar || defaultGroupMemberAvatar,
              });
            });
          }

          // B. å…¶ä»–ä¸»è§’ (state.chats é‡Œçš„å•èŠè§’è‰²ï¼Œæ’é™¤è‡ªå·±)
          Object.values(state.chats).forEach((otherChat) => {
            if (!otherChat.isGroup && otherChat.id !== currentChat.id) {
              options.push({
                type: "è§’è‰²",
                name: otherChat.name,
                persona: otherChat.settings.aiPersona,
                avatar: otherChat.settings.aiAvatar || defaultAvatar,
              });
            }
          });

          if (options.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; padding:20px; color:#888;">æš‚æ— å¯é€‰è§’è‰²/NPCï¼Œè¯·ä½¿ç”¨éšæœºæ¨¡å¼ã€‚</p>';
          } else {
            options.forEach((opt) => {
              const item = document.createElement("div");
              item.className = "contact-picker-item"; // å¤ç”¨ç°æœ‰çš„æ ·å¼
              // å°†äººè®¾ç»è¿‡ç®€å•å¤„ç†å­˜å…¥ dataset (é¿å…å¤ªé•¿æˆ–æœ‰ç‰¹æ®Šå­—ç¬¦)
              const safePersona = (opt.persona || "").replace(/"/g, "&quot;");

              item.innerHTML = `
			                                <input type="checkbox" data-name="${opt.name}" data-persona="${safePersona}" style="margin-right: 10px;">
			                                <img src="${opt.avatar}" class="avatar">
			                                <div style="display:flex; flex-direction:column;">
			                                    <span class="name">${opt.name}</span>
			                                    <span style="font-size:12px; color:#888;">${opt.type}</span>
			                                </div>
			                            `;

              // ç‚¹å‡»æ•´è¡Œè§¦å‘ checkbox
              item.addEventListener("click", (e) => {
                if (e.target.tagName !== "INPUT") {
                  const cb = item.querySelector("input");
                  cb.checked = !cb.checked;
                }
              });

              listEl.appendChild(item);
            });
          }

          document
            .getElementById("chat-gen-selector-modal")
            .classList.add("visible");
        }

        /**
         * ä¸ºâ€œæŸ¥æ‰‹æœºâ€åŠŸèƒ½å•ç‹¬ç”ŸæˆæŸä¸€é¡¹æ•°æ®çš„é€šç”¨å‡½æ•°
         * @param {string} dataType - è¦ç”Ÿæˆçš„æ•°æ®ç±»å‹ (ä¾‹å¦‚: 'diary', 'chats', 'shoppingCart')
         */
        async function generateCharacterPhoneDataSegment(
          dataType,
          specificTargets = null,
        ) {
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];
          if (!chat) return;

          const dataTypeMap = {
            chats: {
              description: `2åˆ°5æ®µä½ ä¸ã€ä¸åŒçš„ã€‘NPCæœ‹å‹ä»¬çš„ã€å…¨æ–°çš„æˆ–æ¥ç»­ä¸Šæ–‡çš„ã€‘èŠå¤©è®°å½•ã€‚`,
              jsonStructure: `"chats": [\n    {\n      "contactName": "ã€NPCæœ‹å‹Açš„åå­—ã€‘",\n      "messages": [\n        {"sender": "ã€è”ç³»äººåAã€‘", "content": "æ¶ˆæ¯å†…å®¹1..."},\n        {"sender": "${chat.name}", "content": "ä½ çš„å›å¤1..."}\n      ]\n    },\n    {\n      "contactName": "ã€NPCæœ‹å‹Bçš„åå­—ã€‘",\n      "messages": [\n        {"sender": "ã€è”ç³»äººåBã€‘", "content": "æ¶ˆæ¯å†…å®¹1..."},\n        {"sender": "${chat.name}", "content": "ä½ çš„å›å¤1..."}\n      ]\n    }\n  ]`,
            },
            shoppingCart: {
              description: "3åˆ°5ä»¶ä½ æœ€è¿‘åŠ å…¥è´­ç‰©è½¦çš„æ–°å•†å“ã€‚",
              jsonStructure: `"shoppingCart": [\n    {"name": "å•†å“å1", "price": 123.45, "store": "åº—é“ºå"},\n    {"name": "å•†å“å2", "price": 67.89, "store": "åº—é“ºå"}\n  ]`,
            },
            memos: {
              description: "2åˆ°3ç¯‡ä½ æ–°å†™çš„ç®€çŸ­å¤‡å¿˜å½•ã€‚",
              jsonStructure: `"memos": [\n    {"title": "å¤‡å¿˜å½•æ ‡é¢˜1", "content": "å¤‡å¿˜å½•è¯¦ç»†å†…å®¹1..."},\n    {"title": "å¤‡å¿˜å½•æ ‡é¢˜2", "content": "å¤‡å¿˜å½•è¯¦ç»†å†…å®¹2..."}\n  ]`,
            },
            browserHistory: {
              description: "2åˆ°3æ¡ä½ æœ€è¿‘çš„æµè§ˆå™¨æœç´¢è®°å½•æˆ–æµè§ˆçš„æ–‡ç« ã€‚",
              jsonStructure: `"browserHistory": [\n    {"query": "æœç´¢æ ‡é¢˜1", "result": "æ¨¡æ‹Ÿæ–‡ç« å†…å®¹1..."},\n    {"query": "æœç´¢æ ‡é¢˜2", "result": "æ¨¡æ‹Ÿæ–‡ç« å†…å®¹2..."}\n  ]`,
            },
            photoAlbum: {
              description: "2åˆ°3å¼ ä½ â€œæ‹æ‘„â€çš„æ–°ç…§ç‰‡çš„æ–‡å­—æè¿°ï¼ˆç”¨äºæ–‡å­—ç”Ÿå›¾ï¼‰ã€‚",
              jsonStructure: `"photoAlbum": [\n    {"hiddenContent": "å¯¹æ–°ç…§ç‰‡ç”»é¢1çš„è¯¦ç»†æ–‡å­—æè¿°..."},\n    {"hiddenContent": "å¯¹æ–°ç…§ç‰‡ç”»é¢2çš„è¯¦ç»†æ–‡å­—æè¿°..."}\n  ]`,
            },
            bank: {
              description: "3åˆ°5æ¡ä½ æœ€è¿‘çš„é“¶è¡Œäº¤æ˜“è®°å½•ï¼ˆæ”¶å…¥æˆ–æ”¯å‡ºï¼‰ã€‚",
              jsonStructure: `"bank": {\n    "transactions": [\n      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": 123.45, "description": "äº¤æ˜“æè¿°1"},\n      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": 67.89, "description": "äº¤æ˜“æè¿°2"}\n    ]\n  }`,
            },
            trajectory: {
              description: "2åˆ°3æ¡ä½ æœ€è¿‘çš„è¡ŒåŠ¨è½¨è¿¹è®°å½•ã€‚",
              jsonStructure: `"trajectory": [\n    {"time": "æ—¶é—´æ®µ1", "location": "åœ°ç‚¹1", "activity": "å¹²äº†ä»€ä¹ˆäº‹1"},\n    {"time": "æ—¶é—´æ®µ2", "location": "åœ°ç‚¹2", "activity": "å¹²äº†ä»€ä¹ˆäº‹2"}\n  ]`,
            },
            appUsage: {
              description: "3åˆ°5æ¡ä½ æœ€è¿‘çš„åº”ç”¨ä½¿ç”¨è®°å½•ã€‚",
              jsonStructure: `"appUsage": [\n    {"appName": "åº”ç”¨å1", "duration": "ä½¿ç”¨æ—¶é•¿1"},\n    {"appName": "åº”ç”¨å2", "duration": "ä½¿ç”¨æ—¶é•¿2"}\n  ]`,
            },
            diary: {
              description: `ä¸€ç¯‡å…¨æ–°çš„æ—¥è®°ã€‚`,
              jsonStructure: `"diary": [\n    {"timestamp": ${Date.now()}, "content": "ã€ç”¨Markdownè¯­æ³•å†™ä¸€ç¯‡ç¬¦åˆäººè®¾å’Œæƒ…æ™¯çš„æ–°æ—¥è®°ã€‘"}\n  ]`,
            },
          };

          const dataTypeInfo = dataTypeMap[dataType];
          if (!dataTypeInfo) {
            console.error("è¯·æ±‚äº†æ— æ•ˆçš„æ•°æ®ç”Ÿæˆç±»å‹:", dataType);
            return;
          }

          // åŠ¨æ€ä¿®æ”¹dataTypeInfoï¼Œä»¥é€‚åº”ä¸åŒæƒ…å†µ
          let finalDataTypeInfo = { ...dataTypeInfo };

          // --- ç‰¹æ®Šå¤„ç†ï¼šæŒ‡å®šäº†èŠå¤©å¯¹è±¡ ---
          // åªæœ‰å½“ dataType æ˜¯ 'chats' ä¸” specificTargets å­˜åœ¨æ—¶æ‰è§¦å‘
          let specificPromptInject = "";

          if (
            dataType === "chats" &&
            specificTargets &&
            specificTargets.length > 0
          ) {
            // 1. ä¿®æ”¹ä»»åŠ¡æè¿°
            const targetNames = specificTargets.map((t) => t.name).join("ã€");
            finalDataTypeInfo.description = `ä½ ä¸æŒ‡å®šè”ç³»äººã€${targetNames}ã€‘çš„èŠå¤©è®°å½•ã€‚`;

            // 2. æ„å»ºå¼ºåˆ¶æ€§ Prompt ä¸Šä¸‹æ–‡
            specificPromptInject = `
                            # ã€ã€ã€æŒ‡å®šç”ŸæˆæŒ‡ä»¤ã€‘ã€‘ã€‘
                            ç”¨æˆ·æŒ‡å®šäº†ä½ å¿…é¡»ç”Ÿæˆä¸ä»¥ä¸‹è§’è‰²çš„å¯¹è¯ã€‚ä½ ã€å¿…é¡»ã€‘ä¸ºåˆ—è¡¨ä¸­çš„**æ¯ä¸€ä½**è§’è‰²ç”Ÿæˆä¸€æ®µç‹¬ç«‹çš„å¯¹è¯ï¼Œä¸èƒ½é—æ¼ï¼Œä¹Ÿä¸èƒ½ç¼–é€ åˆ—è¡¨ä»¥å¤–çš„äººã€‚

                            # æŒ‡å®šè§’è‰²åˆ—è¡¨
                            ${specificTargets.map((t) => `- **${t.name}**: ${t.persona}`).join("\n")}

                            # æ ¼å¼è¦æ±‚
                            è¯·åœ¨è¿”å›çš„ JSON "chats" æ•°ç»„ä¸­ï¼Œä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æŒ‡å®šçš„ "contactName" ç”Ÿæˆå¯¹åº”çš„èŠå¤©è®°å½•ã€‚
                        `;
            // 3. ä¿®æ”¹ JSON ç»“æ„æç¤ºï¼Œå¼•å¯¼AIç”Ÿæˆæ­£ç¡®çš„æ•°é‡
            finalDataTypeInfo.jsonStructure =
              `"chats": [\n` +
              specificTargets
                .map(
                  (t) =>
                    `    { "contactName": "${t.name}", "messages": [\n        {"sender": "${t.name}", "content": "æ¶ˆæ¯å†…å®¹1..."},\n        {"sender": "${chat.name}", "content": "ä½ çš„å›å¤1..."}\n] }`,
                )
                .join(",\n") +
              `\n  ]`;
          }

          if (dataType === "bank") {
            const hasExistingTransactions =
              chat.characterPhoneData?.bank?.transactions?.length > 0;

            if (!hasExistingTransactions) {
              // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç”Ÿæˆï¼Œå°±ä¿®æ”¹æŒ‡ä»¤ï¼Œè¦æ±‚AIæä¾›åˆå§‹ä½™é¢
              finalDataTypeInfo.description =
                "ä¸€ä¸ªç¬¦åˆä½ äººè®¾çš„ã€åˆå§‹é“¶è¡Œä½™é¢ã€‘ï¼Œä»¥åŠ3åˆ°5æ¡åˆå§‹äº¤æ˜“è®°å½•ã€‚";
              finalDataTypeInfo.jsonStructure = `"bank": {\n    "balance": 12345.67,\n    "transactions": [\n      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": 123.45, "description": "äº¤æ˜“æè¿°1"}\n    ]\n  }`;
            } else {
              // å¦‚æœæ˜¯åç»­ç”Ÿæˆï¼Œå°±å‘Šè¯‰AIå½“å‰ä½™é¢ï¼Œåªè¦æ±‚æ–°äº¤æ˜“
              const currentBalance = (
                chat.characterPhoneData.bank.balance || 0
              ).toFixed(2);
              finalDataTypeInfo.description = `3åˆ°5æ¡ã€å…¨æ–°çš„ã€‘é“¶è¡Œäº¤æ˜“è®°å½•ï¼ˆæ”¶å…¥æˆ–æ”¯å‡ºï¼‰ã€‚ã€æç¤ºï¼šä½ å½“å‰çš„ä½™é¢æ˜¯ ${currentBalance} å…ƒï¼Œè¯·åœ¨æ­¤åŸºç¡€ä¸Šç”Ÿæˆåˆç†çš„äº¤æ˜“ã€‘`;
              // æ­¤æ—¶çš„JSONç»“æ„ä¸éœ€è¦balanceå­—æ®µ
              finalDataTypeInfo.jsonStructure = `"bank": {\n    "transactions": [\n      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": 123.45, "description": "äº¤æ˜“æè¿°1"}\n    ]\n  }`;
            }
          }

          showGenerationOverlay("æ­£åœ¨åŒæ­¥Taçš„æ‰‹æœºæ•°æ®...");

          try {
            const userNickname = state.qzoneSettings.nickname || "æˆ‘";
            const persona = (chat.settings.aiPersona || "").substring(0, 4000);
            // updated by lrq 251028 ä¿®æ”¹æœ€å¤§è®°å¿†æ¡æ•°
            const maxMemory = chat.settings.maxMemory || 20;
            const recentHistory = chat.history
              .slice(-maxMemory)
              .map((msg) => {
                const sender = msg.role === "user" ? userNickname : chat.name;
                return `${sender}: ${msg.content}`;
              })
              .join("\n");

            // added by lrq 251028 æ·»åŠ è®°å¿†äº’é€šçš„èŠå¤©è®°å½•ä½œä¸ºå‚è€ƒ
            let linkedMemoryContext = "";
            if (
              chat.settings.linkedMemories &&
              chat.settings.linkedMemories.length > 0
            ) {
              const contextPromises = chat.settings.linkedMemories.map(
                async (link) => {
                  const linkedChat = state.chats[link.chatId];
                  if (!linkedChat) return "";

                  const freshLinkedChat = await db.chats.get(link.chatId);
                  if (!freshLinkedChat) return "";

                  const recentHistory = freshLinkedChat.history
                    .filter((msg) => !msg.isHidden)
                    .slice(-link.depth);

                  if (recentHistory.length === 0) return "";

                  const formattedMessages = recentHistory
                    .map(
                      (msg) =>
                        `  - ${formatMessageForContext(msg, freshLinkedChat)}`,
                    )
                    .join("\n");

                  return `\n## é™„åŠ ä¸Šä¸‹æ–‡ï¼šæ¥è‡ªä¸â€œ${linkedChat.name}â€çš„æœ€è¿‘å¯¹è¯å†…å®¹ (ä»…ä½ å¯è§)\n${formattedMessages}`;
                },
              );

              const allContexts = await Promise.all(contextPromises);
              linkedMemoryContext = allContexts.filter(Boolean).join("\n");
            }

            let worldBookContext = "";
            if (
              chat.settings.linkedWorldBookIds &&
              chat.settings.linkedWorldBookIds.length > 0
            ) {
              worldBookContext =
                "--- ä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆ) ---\n" +
                chat.settings.linkedWorldBookIds
                  .map((id) => {
                    const book = state.worldBooks.find((b) => b.id === id);
                    return book ? `[${book.name}]: ${book.content}` : "";
                  })
                  .join("\n\n");
            }

            const npcLibrary = chat.npcLibrary || [];
            let npcContext = "";
            // å¦‚æœæœ‰æŒ‡å®šå¯¹è±¡ï¼Œå°±ã€ä¸ä½¿ç”¨ã€‘é»˜è®¤çš„ NPC éšæœºåˆ—è¡¨ï¼Œé¿å…æ··æ·†
            if (!specificPromptInject) {
              // åªæœ‰åœ¨éšæœºæ¨¡å¼ï¼ˆspecificPromptInject ä¸ºç©ºï¼‰æ—¶ï¼Œæ‰æä¾›é»˜è®¤ NPC åˆ—è¡¨ä¾› AI éšæœºé€‰
              if (npcLibrary.length > 0) {
                npcContext =
                  "# ä½ çš„ä¸“å±NPCå¥½å‹åˆ—è¡¨ (ä½ å¿…é¡»ä»ä¸­éšæœºé€‰æ‹©2-3ä½æœ‹å‹è¿›è¡Œå¯¹è¯)\n" +
                  npcLibrary
                    .map((npc) => `- **${npc.name}**: ${npc.persona}`)
                    .join("\n");
              } else {
                npcContext =
                  "# ä½ çš„ä¸“å±NPCå¥½å‹åˆ—è¡¨\n(ä½ å½“å‰æ²¡æœ‰ä¸“å±NPCï¼Œè¯·è™šæ„2-3ä¸ªæ™®é€šæœ‹å‹å¹¶ç”Ÿæˆå¯¹è¯)";
              }
            }

            let npcChatHistoryContext = "";
            const existingNpcChats = Object.entries(
              chat.characterPhoneData.chats || {},
            ).filter(
              ([name, chatData]) =>
                chatData.history && chatData.history.length > 0,
            );
            if (existingNpcChats.length > 0) {
              npcChatHistoryContext +=
                "\n\n# å·²æœ‰çš„èŠå¤©è®°å½•æ‘˜è¦ (è¯·åœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­å¯¹è¯)\n";
              existingNpcChats.forEach(([contactName, chatData]) => {
                const recentMessages = chatData.history
                  .slice(-5)
                  .map((msg) => `  - ${msg.sender}: ${msg.content}`)
                  .join("\n");
                npcChatHistoryContext += `\n## ä½ å’Œâ€œ${contactName}â€çš„æœ€è¿‘å¯¹è¯:\n${recentMessages}\n`;
              });
            }

            // ä½¿ç”¨ä¿®æ”¹åçš„ finalDataTypeInfo æ¥æ„å»ºPrompt
            const prompt = `
                            # ä»»åŠ¡
                            ä½ ç°åœ¨æ˜¯è§’è‰² "${chat.name}"ã€‚è¯·æ ¹æ®ä½ çš„ä¿¡æ¯å’Œæœ€è¿‘çš„èŠå¤©è®°å½•ï¼Œã€åªç”Ÿæˆä¸€é¡¹ã€‘ä½ æ‰‹æœºä¸­çš„æ–°æ•°æ®ã€‚
                            å…·ä½“ä»»åŠ¡æ˜¯ï¼šç”Ÿæˆ${finalDataTypeInfo.description}

                            # ã€ã€ã€æƒ…æ™¯ä¸€è‡´æ€§é“å¾‹ã€‘ã€‘ã€‘
                            ä½ ç”Ÿæˆçš„æ‰€æœ‰æ•°æ®ï¼ˆå°¤å…¶æ˜¯"trajectory"è¡ŒåŠ¨è½¨è¿¹ï¼‰**å¿…é¡»**ä¸â€œæœ€è¿‘èŠå¤©è®°å½•æ‘˜è¦â€ä¸­æåˆ°çš„æœ€æ–°æƒ…æ™¯ä¿æŒç»å¯¹ä¸€è‡´ã€‚
                            å½“ç”Ÿæˆ "bank" æ•°æ®æ—¶ï¼Œä½ çš„äº¤æ˜“è®°å½•ã€ç»å¯¹ä¸èƒ½ã€‘åŒ…å«ä¸ç”¨æˆ·("${userNickname}")çš„è½¬è´¦æˆ–æ”¶æ¬¾ã€‚æ‰€æœ‰äº¤æ˜“éƒ½åº”æ˜¯ä½ ä¸å…¶ä»–NPCæˆ–å•†å®¶çš„ã€‚
                            # ã€ã€ã€ç»å¯¹ç¦æ­¢äº‹é¡¹ã€‘ã€‘ã€‘
                            åœ¨ç”Ÿæˆ "chats" æ•°æ®æ—¶ï¼Œ**ç»å¯¹ä¸å…è®¸**è®©ç”¨æˆ·ï¼ˆ${userNickname}ï¼‰å‡ºç°åœ¨ä½ ä¸å…¶ä»–NPCçš„å¯¹è¯ä¸­ã€‚


                            # ã€ã€ã€é‡è¦æŒ‡ä»¤ï¼šå…³äºèŠå¤©è®°å½•ç”Ÿæˆã€‘ã€‘ã€‘
                            - ä½ æ­£åœ¨åˆ›ä½œä¸€æ®µå¯¹è¯ã€‚æä¾›çš„èŠå¤©è®°å½•æ˜¯ä¸Šä¸‹æ–‡ï¼Œä½ ã€ç»å¯¹ä¸èƒ½ã€‘é‡å¤æˆ–æ”¹å†™å…¶ä¸­çš„ä»»ä½•å†…å®¹ã€‚ä½ çš„ç”Ÿæˆå¿…é¡»ä»ã€å…¨æ–°çš„ã€ä¸‹ä¸€æ¡ã€‘æ¶ˆæ¯å¼€å§‹ã€‚
                            - å¦‚æœæŒ‡å®šäº†å¯¹è¯å¯¹è±¡ï¼Œä½ ã€å¿…é¡»ã€‘ä¸ºåˆ—è¡¨ä¸­çš„ã€æ¯ä¸€ä¸ªNPCã€‘éƒ½ç”Ÿæˆä¸€æ®µä¸ä½ ï¼ˆ${chat.name}ï¼‰çš„å¯¹è¯ã€‚
                            - å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œä½ å¯ä»¥è™šæ„2-3ä¸ªæ™®é€šæœ‹å‹å¹¶ç”Ÿæˆå¯¹è¯ã€‚
                            - ä½ å¿…é¡»ä¸ºæ¯ä¸ªè”ç³»äººç”Ÿæˆä¸€æ®µã€è‡³å°‘åŒ…å«5æ¡æ¶ˆæ¯ã€‘çš„å¯¹è¯ã€‚
                            - å¯¹è¯å†…å®¹åº”è¯¥è‡ªç„¶æµç•…ï¼Œå¯ä»¥åŒ…å«è¿ç»­å‘è¨€ã€è¡¨æƒ…åŒ…å’Œè¡¨æƒ…ç¬¦å·ç­‰ï¼Œä»¥ä½“ç°çœŸå®æ„Ÿã€‚
                            - ä¸è¦åªç”Ÿæˆä¸€é—®ä¸€ç­”çš„æœºæ¢°å¼å¯¹è¯ã€‚
                            -   **ã€ã€ã€ç»å¯¹ç¦æ­¢é‡å¤é“å¾‹ã€‘ã€‘ã€‘**: ä½ ç”Ÿæˆçš„ "messages" æ•°ç»„ä¸­ï¼Œã€ç»å¯¹ä¸èƒ½ã€‘åŒ…å«æˆ‘æä¾›ç»™ä½ çš„ä¸Šä¸‹æ–‡é‡Œçš„ä»»ä½•ä¸€æ¡æ¶ˆæ¯ã€‚ä½ çš„ç¬¬ä¸€æ¡æ¶ˆæ¯å¿…é¡»æ˜¯å¯¹è¯å†å²ä¸­æœ€åä¸€æ¡æ¶ˆæ¯çš„ã€ä¸‹ä¸€æ¡ã€‘ã€‚
                            # ä½ çš„ä¿¡æ¯
                            - ä½ çš„åå­—: ${chat.name}
                            - ä½ çš„äººè®¾: ${persona}
                            ${worldBookContext}
                            # å’Œ${userNickname}çš„æœ€è¿‘èŠå¤©è®°å½•æ‘˜è¦
                            ${recentHistory}
                            ${linkedMemoryContext}
                            ${npcContext}
                            ${npcChatHistoryContext}

                            # JSONè¾“å‡ºæ ¼å¼ (å¿…é¡»ä¸¥æ ¼éµå®ˆï¼ŒåªåŒ…å«ä½ è¢«è¦æ±‚çš„é‚£ä¸ªé”®)
                            {
                            ${finalDataTypeInfo.jsonStructure}
                            }
                            `;
            console.log("prompt:", prompt);
            const { proxyUrl, apiKey, model } = state.apiConfig;
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              prompt,
              [{ role: "user", content: prompt }],
              isGemini,
            );

            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: [{ role: "user", content: prompt }],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  }),
                });

            if (!response.ok) {
              let errorMsg = `APIè¯·æ±‚å¤±è´¥: ${response.status} - ${await response.text()}`;
              throw new Error(errorMsg);
            }

            const data = await response.json();
            const aiResponseContent = (
              isGemini
                ? data.candidates[0].content.parts[0].text
                : data.choices[0].message.content
            ).replace(/^```json\s*|```$/g, "");

            const newData = JSON.parse(aiResponseContent);

            let phoneData = chat.characterPhoneData;
            phoneData.lastGenerated = Date.now();
            let updateSuccess = false;

            if (newData && newData[dataType]) {
              if (dataType === "bank" && newData.bank.transactions) {
                if (!phoneData.bank)
                  phoneData.bank = { balance: 0, transactions: [] };
                if (typeof phoneData.bank.balance !== "number")
                  phoneData.bank.balance = 0;
                (newData.bank.transactions || []).forEach((transaction) => {
                  const amount = parseFloat(transaction.amount);
                  if (!isNaN(amount)) {
                    if (transaction.type === "æ”¶å…¥")
                      phoneData.bank.balance += amount;
                    else if (transaction.type === "æ”¯å‡º")
                      phoneData.bank.balance -= amount;
                  }
                });
                phoneData.bank.transactions.push(
                  ...(newData.bank.transactions || []),
                );
                if (typeof newData.bank.balance === "number") {
                  phoneData.bank.balance = newData.bank.balance;
                }
                updateSuccess = true;
              } else if (dataType === "chats" && newData.chats) {
                newData.chats.forEach((newChat) => {
                  if (!newChat.messages) return;
                  const contactName = newChat.contactName;
                  if (
                    phoneData.chats[contactName] &&
                    phoneData.chats[contactName].history
                  ) {
                    phoneData.chats[contactName].history.push(
                      ...newChat.messages,
                    );
                  } else {
                    phoneData.chats[contactName] = {
                      avatar: newChat.avatar,
                      history: newChat.messages,
                    };
                  }
                });
                updateSuccess = true;
              } else if (
                dataType === "appUsage" &&
                Array.isArray(newData.appUsage)
              ) {
                const usageMap = new Map();
                (phoneData.appUsage || []).forEach((item) => {
                  usageMap.set(
                    item.appName,
                    (usageMap.get(item.appName) || 0) +
                      parseDurationToMinutes(item.duration),
                  );
                });
                newData.appUsage.forEach((item) => {
                  usageMap.set(
                    item.appName,
                    (usageMap.get(item.appName) || 0) +
                      parseDurationToMinutes(item.duration),
                  );
                });
                const mergedUsage = [];
                for (const [appName, totalMinutes] of usageMap.entries()) {
                  mergedUsage.push({
                    appName: appName,
                    duration: formatMinutesToDuration(totalMinutes),
                  });
                }
                phoneData.appUsage = mergedUsage;
                updateSuccess = true;
              } else if (Array.isArray(phoneData[dataType])) {
                phoneData[dataType].push(...(newData[dataType] || []));
                updateSuccess = true;
              }
            }

            if (!updateSuccess) {
              throw new Error(
                `AIè¿”å›çš„JSONä¸­ç¼ºå°‘'${dataType}'å­—æ®µæˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚`,
              );
            }

            await db.chats.put(chat);
            alert(
              `â€œ${chat.name}â€çš„${dataTypeMap[dataType].description.split("ã€‚")[0]}å·²æ›´æ–°ï¼`,
            );

            switch (dataType) {
              case "chats":
                renderCharacterChatList();
                break;
              case "shoppingCart":
                renderCharacterShoppingCart();
                break;
              case "memos":
                renderCharacterMemos();
                break;
              case "browserHistory":
                renderCharacterBrowser();
                break;
              case "photoAlbum":
                renderCharacterPhotoAlbum();
                break;
              case "bank":
                renderCharacterBank();
                break;
              case "trajectory":
                renderCharacterTrajectory();
                break;
              case "appUsage":
                renderCharacterAppUsage();
                break;
              case "diary":
                renderCharacterDiary();
                break;
            }
          } catch (error) {
            console.error(`ç”Ÿæˆè§’è‰²æ‰‹æœºæ•°æ®(${dataType})å¤±è´¥:`, error);
            await showCustomAlert(
              "ç”Ÿæˆå¤±è´¥",
              `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n\n${error.message}`,
            );
          } finally {
            document
              .getElementById("generation-overlay")
              .classList.remove("visible");
          }
        }

        /**
         * å¤„ç†â€œæŸ¥æ‰‹æœºâ€å„ä¸ªAPPé¡µé¢â€œå…¨éƒ¨åˆ é™¤â€åŠŸèƒ½çš„é€šç”¨å‡½æ•°
         * @param {string} dataType - è¦æ¸…ç©ºçš„æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚ 'shoppingCart', 'memos', 'bank.transactions'
         */
        async function handleClearCharacterDataSegment(dataType) {
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];
          if (!chat) return;

          // ä¸ºä¸åŒæ•°æ®ç±»å‹è®¾ç½®æ›´äººæ€§åŒ–çš„æç¤ºæ–‡æœ¬
          const dataTypeMap = {
            chats: { name: "NPCèŠå¤©è®°å½•", dataKey: "chats" },
            shoppingCart: { name: "è´­ç‰©è½¦", dataKey: "shoppingCart" },
            memos: { name: "å¤‡å¿˜å½•", dataKey: "memos" },
            browserHistory: { name: "æµè§ˆå™¨å†å²", dataKey: "browserHistory" },
            photoAlbum: { name: "ç›¸å†Œ", dataKey: "photoAlbum" },
            "bank.transactions": { name: "äº¤æ˜“è®°å½•", dataKey: "bank" },
            trajectory: { name: "è¶³è¿¹", dataKey: "trajectory" },
            appUsage: { name: "ä½¿ç”¨è®°å½•", dataKey: "appUsage" },
            diary: { name: "æ—¥è®°", dataKey: "diary" },
          };

          const info = dataTypeMap[dataType];
          if (!info) {
            console.error("æœªçŸ¥çš„æ¸…ç©ºæ•°æ®ç±»å‹:", dataType);
            return;
          }

          // å¼¹å‡ºç¡®è®¤æ¡†
          const confirmed = await showCustomConfirm(
            `ç¡®è®¤æ¸…ç©º`,
            `ç¡®å®šè¦æ¸…ç©ºâ€œ${chat.name}â€æ‰‹æœºé‡Œçš„æ‰€æœ‰ã€${info.name}ã€‘å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
            { confirmButtonClass: "btn-danger" },
          );

          if (!confirmed) return;

          try {
            if (dataType === "chats") {
              // ç‰¹æ®Šå¤„ç†ï¼šæ¸…ç©ºæ‰€æœ‰NPCèŠå¤©ï¼ˆä¸åŒ…æ‹¬å’Œuserçš„ï¼‰
              chat.characterPhoneData.chats = {};
            } else if (dataType === "bank.transactions") {
              // ç‰¹æ®Šå¤„ç†ï¼šæ¸…ç©ºé“¶è¡Œäº¤æ˜“è®°å½•ï¼Œã€åŒæ—¶å°†ä½™é¢å½’é›¶ã€‘
              if (chat.characterPhoneData.bank) {
                chat.characterPhoneData.bank.transactions = [];

                chat.characterPhoneData.bank.balance = 0;
              }
            } else if (chat.characterPhoneData[info.dataKey]) {
              // é€šç”¨å¤„ç†ï¼šæ¸…ç©ºæ•°ç»„
              chat.characterPhoneData[info.dataKey] = [];
            }

            // ä¿å­˜åˆ°æ•°æ®åº“
            await db.chats.put(chat);

            // åˆ·æ–°å½“å‰é¡µé¢
            switch (dataType) {
              case "chats":
                renderCharacterChatList();
                break;
              case "shoppingCart":
                renderCharacterShoppingCart();
                break;
              case "memos":
                renderCharacterMemos();
                break;
              case "browserHistory":
                renderCharacterBrowser();
                break;
              case "photoAlbum":
                renderCharacterPhotoAlbum();
                break;
              case "bank.transactions":
                renderCharacterBank();
                break;
              case "trajectory":
                renderCharacterTrajectory();
                break;
              case "appUsage":
                renderCharacterAppUsage();
                break;
              case "diary":
                renderCharacterDiary();
                break;
            }

            alert(`å·²æˆåŠŸæ¸…ç©ºæ‰€æœ‰${info.name}ã€‚`);
          } catch (error) {
            console.error(`æ¸…ç©º ${info.name} æ—¶å‡ºé”™:`, error);
            await showCustomAlert(
              "æ“ä½œå¤±è´¥",
              `æ¸…ç©ºæ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`,
            );
          }
        }

        /**
         * ç”Ÿæˆè§’è‰²æ‰‹æœºæ•°æ®
         */
        async function generateCharacterPhoneData() {
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];
          if (!chat) return;

          showGenerationOverlay("æ­£åœ¨åŒæ­¥Taçš„æ‰‹æœºæ•°æ®...");

          try {
            const userNickname = state.qzoneSettings.nickname || "æˆ‘";

            // é™åˆ¶äººè®¾é•¿åº¦ï¼Œè¿™æ˜¯é˜²æ­¢503é”™è¯¯çš„æ ¹æœ¬æ–¹æ³•ï¼
            // åªå–äººè®¾çš„å‰4000ä¸ªå­—ç¬¦ï¼Œé¿å…æ•´ä¸ªäººè®¾è¿‡é•¿å¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚
            const persona = (chat.settings.aiPersona || "").substring(0, 4000);

            const recentHistory = chat.history
              .slice(-chat.settings.maxMemory || 20)
              .map((msg) => {
                const sender = msg.role === "user" ? userNickname : chat.name;
                return `${sender}: ${msg.content}`;
              })
              .join("\n");

            console.log("ç”¨äºç”Ÿæˆæ‰‹æœºæ•°æ®çš„æœ€è¿‘èŠå¤©è®°å½•:", recentHistory);
            // added by lrq 251028 æ·»åŠ è®°å¿†äº’é€šçš„èŠå¤©è®°å½•ä½œä¸ºå‚è€ƒ
            let linkedMemoryContext = "";
            if (
              chat.settings.linkedMemories &&
              chat.settings.linkedMemories.length > 0
            ) {
              const contextPromises = chat.settings.linkedMemories.map(
                async (link) => {
                  const linkedChat = state.chats[link.chatId];
                  if (!linkedChat) return "";

                  const freshLinkedChat = await db.chats.get(link.chatId);
                  if (!freshLinkedChat) return "";

                  const recentHistory = freshLinkedChat.history
                    .filter((msg) => !msg.isHidden)
                    .slice(-link.depth);

                  if (recentHistory.length === 0) return "";

                  const formattedMessages = recentHistory
                    .map(
                      (msg) =>
                        `  - ${formatMessageForContext(msg, freshLinkedChat)}`,
                    )
                    .join("\n");

                  return `\n## é™„åŠ ä¸Šä¸‹æ–‡ï¼šæ¥è‡ªä¸â€œ${linkedChat.name}â€çš„æœ€è¿‘å¯¹è¯å†…å®¹ (ä»…ä½ å¯è§)\n${formattedMessages}`;
                },
              );

              const allContexts = await Promise.all(contextPromises);
              linkedMemoryContext = allContexts.filter(Boolean).join("\n");
            }
            console.log(
              "ç”¨äºç”Ÿæˆæ‰‹æœºæ•°æ®çš„äº’é€šèŠå¤©è®°å½•ä¸Šä¸‹æ–‡:",
              linkedMemoryContext,
            );
            let worldBookContext = "";
            if (
              chat.settings.linkedWorldBookIds &&
              chat.settings.linkedWorldBookIds.length > 0
            ) {
              worldBookContext =
                "--- ä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆ) ---\n" +
                chat.settings.linkedWorldBookIds
                  .map((id) => {
                    const book = state.worldBooks.find((b) => b.id === id);
                    return book ? `[${book.name}]: ${book.content}` : "";
                  })
                  .join("\n\n");
            }
            const npcLibrary = chat.npcLibrary || [];
            let npcContext = "";
            if (npcLibrary.length > 0) {
              npcContext =
                '# ä½ çš„ä¸“å±NPCå¥½å‹åˆ—è¡¨ (ä½ å¿…é¡»åœ¨ä¸‹æ–¹"chats"ä¸­ä¸ºä»–ä»¬ç”Ÿæˆå¯¹è¯)\n' +
                "è¿™äº›äººæ˜¯ä½ çš„å¥½æœ‹å‹ï¼Œä½ å’Œä»–ä»¬éå¸¸ç†Ÿæ‚‰ã€‚è¯·æ ¹æ®ä»–ä»¬çš„äººè®¾ï¼Œç”Ÿæˆç¬¦åˆä½ ä»¬å…³ç³»çš„ã€è‡ªç„¶çš„èŠå¤©è®°å½•ã€‚\n" +
                npcLibrary
                  .map((npc) => `- **${npc.name}**: ${npc.persona}`)
                  .join("\n");
            } else {
              npcContext =
                "# ä½ çš„ä¸“å±NPCå¥½å‹åˆ—è¡¨\n(ä½ æ²¡æœ‰ä¸“å±NPCï¼Œè¯·è™šæ„ä¸€äº›æ™®é€šæœ‹å‹)";
            }

            let npcChatHistoryContext = "";
            const existingNpcChats = Object.entries(
              chat.characterPhoneData.chats || {},
            ).filter(
              ([name, chatData]) =>
                chatData.history && chatData.history.length > 0,
            );

            if (existingNpcChats.length > 0) {
              npcChatHistoryContext +=
                "\n\n# å·²æœ‰çš„èŠå¤©è®°å½•æ‘˜è¦ (è¯·åœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­å¯¹è¯)\n";
              existingNpcChats.forEach(([contactName, chatData]) => {
                const recentMessages = chatData.history
                  .slice(-5)
                  .map((msg) => `  - ${msg.sender}: ${msg.content}`)
                  .join("\n");
                npcChatHistoryContext += `\n## ä½ å’Œâ€œ${contactName}â€çš„æœ€è¿‘å¯¹è¯:\n${recentMessages}\n`;
              });
            }

            // ä¼˜åŒ–æç¤ºè¯ï¼Œè®©AIæ›´å¥½åœ°ç†è§£ä»»åŠ¡ï¼Œå¹¶å¼ºè°ƒæƒ…æ™¯ä¸€è‡´æ€§
            const prompt = `
			# ä»»åŠ¡
			ã€ã€ã€æƒ…æ™¯ä¸€è‡´æ€§é“å¾‹ã€‘ã€‘ã€‘ï¼šä½ ç”Ÿæˆçš„æ‰€æœ‰æ•°æ®ï¼ˆå°¤å…¶æ˜¯"trajectory"è¡ŒåŠ¨è½¨è¿¹ï¼‰**å¿…é¡»**ä¸â€œæœ€è¿‘èŠå¤©è®°å½•æ‘˜è¦â€ä¸­æåˆ°çš„æœ€æ–°æƒ…æ™¯ä¿æŒç»å¯¹ä¸€è‡´ã€‚å¦‚æœèŠå¤©è®°å½•æ˜¾ç¤ºä½ æ­£åœ¨ä¸Šè¯¾ï¼Œä½ çš„è¡ŒåŠ¨è½¨è¿¹å°±å¿…é¡»æ˜¯åœ¨æ•™å®¤ï¼›å¦‚æœèŠå¤©è®°å½•æ˜¾ç¤ºä½ åœ¨å’–å•¡é¦†ï¼Œä½ çš„è¡ŒåŠ¨è½¨è¿¹å°±å¿…é¡»æ˜¯å’–å•¡é¦†ã€‚**ç»å¯¹ä¸èƒ½**ä»…å‡­ä½ çš„äººè®¾å°±ç”Ÿæˆä¸èŠå¤©è®°å½•ç›¸çŸ›ç›¾çš„å†…å®¹ã€‚
			ä½ ç°åœ¨æ˜¯è§’è‰² "${
        chat.name
      }"ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ã€ä¸–ç•Œè§‚ã€NPCå¥½å‹åˆ—è¡¨ä»¥åŠå’Œ${userNickname}çš„æœ€è¿‘èŠå¤©è®°å½•ï¼Œæ¨¡æ‹Ÿç”Ÿæˆä½ æ‰‹æœºä¸­çš„å„é¡¹æ•°æ®ã€‚ä½ éœ€è¦ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰æ•°æ®ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§ä¸‹é¢çš„JSONæ ¼å¼è¿”å›ã€‚

			# ã€ã€ã€ç»å¯¹ç¦æ­¢äº‹é¡¹ï¼šè¿™æ˜¯å¿…é¡»éµå®ˆçš„å®‰å…¨çº¢çº¿ã€‘ã€‘ã€‘
			1.  åœ¨ç”ŸæˆJSONæ•°æ®ï¼Œç‰¹åˆ«æ˜¯chatså­—æ®µæ—¶ï¼Œ**ç»å¯¹ä¸å…è®¸**åˆ›å»ºå¦ä¸€ä¸ªç”¨æˆ·ï¼ˆ${userNickname}ï¼‰çš„è™šæ‹Ÿå½¢è±¡æˆ–è®©ä»–/å¥¹å‡ºç°åœ¨ä½ ä¸å…¶ä»–NPCçš„å¯¹è¯ä¸­ã€‚
			2.  "bank" å­—æ®µä¸­çš„äº¤æ˜“è®°å½•ã€ç»å¯¹ä¸èƒ½ã€‘æ¶‰åŠç”¨æˆ·("${userNickname}")ã€‚æ‰€æœ‰äº¤æ˜“éƒ½å¿…é¡»æ˜¯ä½ ä¸å…¶ä»–NPCã€å•†å®¶æˆ–å› æŸäº›äº‹ä»¶ï¼ˆå¦‚è´­ç‰©ã€æ”¶åˆ°å·¥èµ„ï¼‰äº§ç”Ÿçš„ã€‚
			3.  chatså­—æ®µä¸­ï¼Œä¸NPCæˆ–æœ‹å‹çš„èŠå¤©è®°å½•ï¼Œå…¶senderæˆ–content**ç»å¯¹ä¸èƒ½**åŒ…å«${userNickname}çš„åå­—æˆ–ä»£ç§°ã€‚
			4.  æ‰€æœ‰ä½ ç”Ÿæˆçš„èŠå¤©å¯¹è¯ï¼Œéƒ½å¿…é¡»ä¸¥æ ¼é™åˆ¶åœ¨ã€ä½ (${
        chat.name
      })ã€‘å’Œã€å¦ä¸€ä½NPC/æœ‹å‹ã€‘è¿™**ä¸¤ä¸ªäººä¹‹é—´**ã€‚**ä¸¥ç¦**å‡ºç°ä»»ä½•å½¢å¼çš„ç¬¬ä¸‰è€…ï¼Œå°¤å…¶æ˜¯${userNickname}ã€‚

			# ä½ çš„ä¿¡æ¯
			- ä½ çš„åå­—: ${chat.name}
			- ä½ çš„äººè®¾: ${persona}
			${worldBookContext}
			# å’Œ${userNickname}çš„æœ€è¿‘èŠå¤©è®°å½•æ‘˜è¦
			${recentHistory}
			${linkedMemoryContext}

			${npcContext}
			${npcChatHistoryContext}
			# JSONè¾“å‡ºæ ¼å¼ (å¿…é¡»ä¸¥æ ¼éµå®ˆï¼Œä¸è¦æ·»åŠ ä»»ä½•é¢å¤–è¯´æ˜)
			{
			  "chats": [
			    {
			      "contactName": "ã€è¿™é‡Œå¡«å†™ä½ ç»™${userNickname}çš„å¤‡æ³¨åã€‘"
			    },
			    {
			      "contactName": "ã€è¿™é‡Œå¿…é¡»å¡«å†™ä¸Šé¢NPCåˆ—è¡¨ä¸­çš„ä¸€ä¸ªåå­—ï¼Œæˆ–ä¸€ä¸ªè™šæ„æœ‹å‹åã€‘",
			      "messages": [
			        {"sender": "ã€è”ç³»äººåï¼Œä¸¥ç¦å¡«å†™'${userNickname}'ã€‘", "content": "æ¶ˆæ¯å†…å®¹1..."},
			        {"sender": "${chat.name}", "content": "ä½ çš„å›å¤1..."},
			        {"sender": "ã€è”ç³»äººåï¼Œä¸¥ç¦å¡«å†™'${userNickname}'ã€‘", "content": "æ¶ˆæ¯å†…å®¹2..."},
			        {"sender": "ã€è”ç³»äººåï¼Œä¸¥ç¦å¡«å†™'${userNickname}'ã€‘", "content": "æ¶ˆæ¯å†…å®¹3..."},
			        {"sender": "${chat.name}", "content": "ä½ çš„å›å¤2..."}
			      ]
			    }
			  ],
			  "shoppingCart": [
			    {"name": "å•†å“å", "price": ä»·æ ¼, "store": "åº—é“ºå"}
			  ],
			  "memos": [
			    {"title": "å¤‡å¿˜å½•æ ‡é¢˜", "content": "å¤‡å¿˜å½•è¯¦ç»†å†…å®¹..."}
			  ],
			  "browserHistory": [
			    {"query": "æœç´¢æˆ–æµè§ˆçš„æ ‡é¢˜", "result": "ã€è¿™é‡Œæ˜¯AIç”Ÿæˆçš„ã€å…³äºè¿™ä¸ªæœç´¢æ ‡é¢˜çš„æ¨¡æ‹Ÿæ–‡ç« æˆ–ç½‘é¡µå†…å®¹ã€‘"}
			  ],
			  "photoAlbum": [
			    {"hiddenContent": "å¯¹ç…§ç‰‡ç”»é¢çš„è¯¦ç»†æ–‡å­—æè¿°"}
			  ],
			  "bank": {
			    "balance": é“¶è¡Œå¡ä½™é¢(æ•°å­—),
			    "transactions": [
			      {"type": "æ”¶å…¥æˆ–æ”¯å‡º", "amount": é‡‘é¢, "description": "äº¤æ˜“æè¿°"}
			    ]
			  },
			  "trajectory": [
			    {"time": "æ—¶é—´æ®µ", "location": "åœ°ç‚¹", "activity": "å¹²äº†ä»€ä¹ˆäº‹"}
			  ],
			  "appUsage": [
			    {"appName": "åº”ç”¨å", "duration": "ä½¿ç”¨æ—¶é•¿"}
			  ],
			  "diary": [
			    {"timestamp": ${Date.now()}, "content": "ã€ä»Šå¤©æ˜¯${new Date().toLocaleString(
            "zh-CN",
            {
              dateStyle: "full",
            },
          )}ï¼Œç”¨Markdownè¯­æ³•å†™ä¸€ç¯‡ç¬¦åˆäººè®¾å’Œä»Šå¤©æƒ…æ™¯çš„æ—¥è®°ã€‘"}
			  ]
			}

			# ã€ã€ã€é‡è¦æŒ‡ä»¤ï¼šå…³äºèŠå¤©è®°å½•ç”Ÿæˆã€‘ã€‘ã€‘
			- ä½ æ­£åœ¨ç»­å†™è¿™æ®µå¯¹è¯ã€‚ä½ æä¾›çš„èŠå¤©è®°å½•æ˜¯ä¸Šä¸‹æ–‡ï¼Œä½ ã€ç»å¯¹ä¸èƒ½ã€‘é‡å¤æˆ–æ”¹å†™å…¶ä¸­çš„ä»»ä½•å†…å®¹ã€‚ä½ çš„ç”Ÿæˆå¿…é¡»ä»ã€å…¨æ–°çš„ã€ä¸‹ä¸€æ¡ã€‘æ¶ˆæ¯å¼€å§‹ã€‚
			- ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆæœ¬æç¤ºè¯æœ€ä¸Šæ–¹çš„ã€ç»å¯¹ç¦æ­¢äº‹é¡¹ã€‘ã€‚
			- å¦‚æœâ€œä½ çš„ä¸“å±NPCå¥½å‹åˆ—è¡¨â€ä¸ä¸ºç©ºï¼Œä½ ã€å¿…é¡»ã€‘ä¸ºåˆ—è¡¨ä¸­çš„ã€æ¯ä¸€ä¸ªNPCã€‘éƒ½ç”Ÿæˆä¸€æ®µä¸ä½ ï¼ˆ${chat.name}ï¼‰çš„å¯¹è¯ã€‚
			- å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œä½ å¯ä»¥è™šæ„2-3ä¸ªæ™®é€šæœ‹å‹å¹¶ç”Ÿæˆå¯¹è¯ã€‚
			- ä½ å¿…é¡»ä¸ºæ¯ä¸ªè”ç³»äººç”Ÿæˆä¸€æ®µã€è‡³å°‘åŒ…å«5æ¡æ¶ˆæ¯ã€‘çš„å¯¹è¯ã€‚
			- å¯¹è¯å†…å®¹åº”è¯¥è‡ªç„¶æµç•…ï¼Œå¯ä»¥åŒ…å«è¿ç»­å‘è¨€ã€è¡¨æƒ…åŒ…å’Œè¡¨æƒ…ç¬¦å·ç­‰ï¼Œä»¥ä½“ç°çœŸå®æ„Ÿã€‚
			- ä¸è¦åªç”Ÿæˆä¸€é—®ä¸€ç­”çš„æœºæ¢°å¼å¯¹è¯ã€‚
			-   **ã€ã€ã€ç»å¯¹ç¦æ­¢é‡å¤é“å¾‹ã€‘ã€‘ã€‘**: ä½ ç”Ÿæˆçš„ "messages" æ•°ç»„ä¸­ï¼Œã€ç»å¯¹ä¸èƒ½ã€‘åŒ…å«æˆ‘æä¾›ç»™ä½ çš„ä¸Šä¸‹æ–‡é‡Œçš„ä»»ä½•ä¸€æ¡æ¶ˆæ¯ã€‚ä½ çš„ç¬¬ä¸€æ¡æ¶ˆæ¯å¿…é¡»æ˜¯å¯¹è¯å†å²ä¸­æœ€åä¸€æ¡æ¶ˆæ¯çš„ã€ä¸‹ä¸€æ¡ã€‘ã€‚
			`;

            const { proxyUrl, apiKey, model } = state.apiConfig;
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              prompt,
              [{ role: "user", content: prompt }],
              isGemini,
            );

            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: [{ role: "user", content: prompt }],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  }),
                });

            if (!response.ok) {
              let errorMsg = `APIè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`;
              try {
                const errorData = await response.json();
                errorMsg += `\né”™è¯¯ä¿¡æ¯: ${errorData.error.message}`;
              } catch (e) {
                errorMsg += `\næ— æ³•è§£æé”™è¯¯å“åº”ä½“ã€‚`;
              }
              throw new Error(errorMsg);
            }

            const data = await response.json();
            const aiResponseContent = (
              isGemini
                ? data.candidates[0].content.parts[0].text
                : data.choices[0].message.content
            ).replace(/^```json\s*|```$/g, "");

            let newData;
            try {
              newData = JSON.parse(aiResponseContent);
            } catch (e) {
              throw new Error(
                `AIè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œæ— æ³•è§£æã€‚\nåŸå§‹è¿”å›å†…å®¹:\n${aiResponseContent}`,
              );
            }

            let phoneData = chat.characterPhoneData;
            phoneData.lastGenerated = Date.now();

            if (newData.chats) {
              newData.chats.forEach((newChat) => {
                if (!newChat.messages) {
                  const myNickname = userNickname || "æˆ‘";
                  if (!phoneData.chats[myNickname]) {
                    phoneData.chats[myNickname] = { avatar: "", history: [] };
                  }
                  phoneData.chats[myNickname].remarkName = newChat.contactName;
                } else {
                  const contactName = newChat.contactName;
                  if (
                    phoneData.chats[contactName] &&
                    phoneData.chats[contactName].history
                  ) {
                    console.log(
                      `åˆå¹¶èŠå¤©è®°å½•: ä¸º "${contactName}" è¿½åŠ  ${newChat.messages.length} æ¡æ–°æ¶ˆæ¯ã€‚`,
                    );
                    phoneData.chats[contactName].history.push(
                      ...newChat.messages,
                    );
                  } else {
                    console.log(`åˆ›å»ºæ–°èŠå¤©: "${contactName}"`);
                    phoneData.chats[contactName] = {
                      avatar: newChat.avatar,
                      history: newChat.messages,
                    };
                  }
                }
              });
            }

            // æ­£ç¡®å¤„ç†å…¶ä»–æ•°ç»„ç±»å‹æ•°æ®
            if (!phoneData.shoppingCart) phoneData.shoppingCart = [];
            phoneData.shoppingCart.push(...(newData.shoppingCart || []));
            if (!phoneData.memos) phoneData.memos = [];
            phoneData.memos.push(...(newData.memos || []));
            if (!phoneData.browserHistory) phoneData.browserHistory = [];
            phoneData.browserHistory.push(...(newData.browserHistory || []));
            if (!phoneData.photoAlbum) phoneData.photoAlbum = [];
            phoneData.photoAlbum.push(...(newData.photoAlbum || []));
            if (!phoneData.trajectory) phoneData.trajectory = [];
            phoneData.trajectory.push(...(newData.trajectory || []));
            if (!phoneData.diary) phoneData.diary = [];
            phoneData.diary.push(...(newData.diary || []));

            if (newData.appUsage && Array.isArray(newData.appUsage)) {
              const usageMap = new Map();
              // å…ˆåŠ è½½å·²æœ‰çš„ä½¿ç”¨è®°å½•
              (phoneData.appUsage || []).forEach((item) => {
                usageMap.set(
                  item.appName,
                  (usageMap.get(item.appName) || 0) +
                    parseDurationToMinutes(item.duration),
                );
              });
              // å†ç´¯åŠ æ–°ç”Ÿæˆçš„ä½¿ç”¨è®°å½•
              newData.appUsage.forEach((item) => {
                usageMap.set(
                  item.appName,
                  (usageMap.get(item.appName) || 0) +
                    parseDurationToMinutes(item.duration),
                );
              });
              // é‡æ–°ç”Ÿæˆåˆå¹¶åçš„åˆ—è¡¨
              const mergedUsage = [];
              for (const [appName, totalMinutes] of usageMap.entries()) {
                mergedUsage.push({
                  appName: appName,
                  duration: formatMinutesToDuration(totalMinutes),
                });
              }
              phoneData.appUsage = mergedUsage;
            }

            if (newData.bank) {
              if (!phoneData.bank)
                phoneData.bank = { balance: 0, transactions: [] };
              if (typeof phoneData.bank.balance !== "number")
                phoneData.bank.balance = 0;

              // å¦‚æœAIè¿”å›äº†æ–°çš„æ€»ä½™é¢ (é€šå¸¸æ˜¯ç¬¬ä¸€æ¬¡ç”Ÿæˆæ—¶)ï¼Œåˆ™ä»¥æ­¤ä¸ºå‡†
              if (typeof newData.bank.balance === "number") {
                phoneData.bank.balance = newData.bank.balance;
              }

              if (
                newData.bank.transactions &&
                Array.isArray(newData.bank.transactions)
              ) {
                newData.bank.transactions.forEach((transaction) => {
                  const amount = parseFloat(transaction.amount);
                  if (!isNaN(amount)) {
                    // åªæœ‰åœ¨AIæ²¡æœ‰ç›´æ¥æä¾›æ–°ä½™é¢æ—¶ï¼Œæˆ‘ä»¬æ‰æ ¹æ®äº¤æ˜“è®°å½•è‡ªå·±è®¡ç®—
                    if (typeof newData.bank.balance !== "number") {
                      if (transaction.type === "æ”¶å…¥") {
                        phoneData.bank.balance += amount;
                      } else if (transaction.type === "æ”¯å‡º") {
                        phoneData.bank.balance -= amount;
                      }
                    }
                  }
                });
                // å°†æ–°äº¤æ˜“è®°å½•è¿½åŠ åˆ°å†å²è®°å½•ä¸­
                if (!phoneData.bank.transactions)
                  phoneData.bank.transactions = [];
                phoneData.bank.transactions.push(...newData.bank.transactions);
              }
            }

            await db.chats.put(chat);
            alert("æ•°æ®å·²åˆ·æ–°ï¼");
          } catch (error) {
            console.error("ç”Ÿæˆè§’è‰²æ‰‹æœºæ•°æ®å¤±è´¥:", error);
            await showCustomAlert(
              "ç”Ÿæˆå¤±è´¥",
              `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼Œè¯·æ£€æŸ¥ä½ çš„ç½‘ç»œã€APIå¯†é’¥æˆ–æ¨¡å‹è®¾ç½®ã€‚\n\nè¯¦ç»†ä¿¡æ¯:\n${error.message}`,
            );
          } finally {
            document
              .getElementById("generation-overlay")
              .classList.remove("visible");
          }
        }

        /**
         * æ¸…ç©ºè§’è‰²æ‰‹æœºæ•°æ®
         */
        async function clearCharacterPhoneData() {
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];
          if (!chat) return;

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤æ¸…ç©º",
            `ç¡®å®šè¦æ¸…ç©ºâ€œ${chat.name}â€çš„æ‰€æœ‰æ‰‹æœºæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
            { confirmButtonClass: "btn-danger" },
          );
          if (confirmed) {
            // é‡ç½®ä¸ºåˆå§‹çŠ¶æ€
            chat.characterPhoneData = {
              lastGenerated: null,
              chats: {},
              shoppingCart: [],
              memos: [],
              browserHistory: [],
              photoAlbum: [],
              bank: { balance: 0, transactions: [] },
              trajectory: [],
              appUsage: [],
              diary: [], // <--- åœ¨è¿™é‡Œæ–°å¢
            };
            await db.chats.put(chat);
            // é‡æ–°æ¸²æŸ“APPç½‘æ ¼ï¼Œå› ä¸ºç‚¹å‡»APPä¼šè¯»å–æ–°æ•°æ®
            renderCharacterAppGrid();
            alert("æ•°æ®å·²æ¸…ç©ºã€‚");
          }
        }

        /**
         * æ¸²æŸ“è§’è‰²æ‰‹æœºçš„èŠå¤©åˆ—è¡¨ (æ”¯æŒé€æ˜ç£¨ç ‚åˆ†ç»„)
         */
        function renderCharacterChatList() {
          const listEl = document.getElementById("character-chat-list");
          const characterChat = state.chats[activeCharacterPhoneId];
          if (!characterChat) return;

          const characterChatData = characterChat.characterPhoneData;
          const realChatHistory = characterChat.history;
          listEl.innerHTML = "";

          const npcContainer = document.createElement("div");
          npcContainer.className = "npc-chat-group"; // ç»™å®ƒä¸€ä¸ªä¸“å±çš„classå

          // è·å– "æˆ‘" çš„å¤‡æ³¨å
          const userContactInData = characterChatData.chats
            ? Object.values(characterChatData.chats).find(
                (c) => !c.history || c.history.length === 0,
              )
            : null;
          const remarkNameForMe = userContactInData
            ? userContactInData.remarkName
            : "æˆ‘";

          // æ¸²æŸ“ä¸ "æˆ‘" çš„èŠå¤©
          const lastMsg = realChatHistory
            .filter((m) => !m.isHidden)
            .slice(-1)[0] || { content: "..." };
          const myChatItem = document.createElement("div");
          myChatItem.className = "chat-list-item"; // è¿™ä¸ªæ˜¯ç”¨æˆ·è‡ªå·±çš„æ¶ˆæ¯ï¼Œå•ç‹¬å¤„ç†
          myChatItem.dataset.contactName = remarkNameForMe;
          myChatItem.dataset.isUserChat = "true";
          const myAvatar =
            characterChat.settings.myAvatar || defaultMyGroupAvatar;
          myChatItem.innerHTML = `
			                        <img src="${myAvatar}" class="avatar" style="border-radius: 6px;">
			                        <div class="info">
			                            <span class="name">${remarkNameForMe}</span>
			                            <div class="last-msg">${stripHtmlAndCode(String(lastMsg.content)).substring(0, 30)}</div>
			                        </div>
			                    `;
          listEl.appendChild(myChatItem);

          // æ¸²æŸ“ä¸å…¶ä»–NPCçš„èŠå¤©
          if (characterChatData.chats) {
            for (const contactName in characterChatData.chats) {
              if (contactName === remarkNameForMe) continue;
              const contact = characterChatData.chats[contactName];
              if (!contact.history || contact.history.length === 0) continue;

              const lastNpcMsg = contact.history.slice(-1)[0] || {
                content: "...",
              };
              const npcChatItem = document.createElement("div");
              npcChatItem.className = "chat-list-item";
              npcChatItem.dataset.contactName = contactName;

              let npcAvatarHtml;
              const npcFromLibrary = (characterChat.npcLibrary || []).find(
                (npc) => npc.name === contactName,
              );
              if (npcFromLibrary && npcFromLibrary.avatar) {
                npcAvatarHtml = `<img src="${npcFromLibrary.avatar}" class="avatar" style="border-radius: 6px;">`;
              } else {
                const avatarColors = [
                  "#FFC107",
                  "#4CAF50",
                  "#2196F3",
                  "#F44336",
                  "#9C27B0",
                  "#00BCD4",
                ];
                const npcNameInitial = contactName.slice(-1);
                const colorIndex = contactName.length % avatarColors.length;
                const bgColor = avatarColors[colorIndex];
                npcAvatarHtml = `<div class="avatar" style="border-radius: 6px; background-color: ${bgColor}; color: white; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: 500;">${npcNameInitial}</div>`;
              }
              npcChatItem.innerHTML = `${npcAvatarHtml}<div class="info"><span class="name">${contactName}</span><div class="last-msg">${stripHtmlAndCode(
                String(lastNpcMsg.content),
              ).substring(0, 30)}</div></div>`;

              // å°†NPCæ¶ˆæ¯æ·»åŠ åˆ°æ–°çš„å®¹å™¨ä¸­
              npcContainer.appendChild(npcChatItem);
            }
          }

          // å°†åŒ…å«æ‰€æœ‰NPCæ¶ˆæ¯çš„å®¹å™¨ä¸€æ¬¡æ€§æ·»åŠ åˆ°åˆ—è¡¨ä¸­
          if (npcContainer.hasChildNodes()) {
            listEl.appendChild(npcContainer);
          }
        }

        /**
         * æ¸²æŸ“è§’è‰²æ‰‹æœºçš„å…·ä½“èŠå¤©è®°å½• (åˆ†é¡µåŠ è½½)
         */
        function renderCharacterChatHistory(
          contactName,
          isUserChat = false,
          loadOffset = 0,
        ) {
          const MESSAGES_PER_PAGE = 50; // æ¯æ¬¡åŠ è½½50æ¡

          const messagesEl = document.getElementById(
            "character-chat-history-messages",
          );
          const characterChat = state.chats[activeCharacterPhoneId];
          if (!characterChat) {
            console.error("ã€é”™è¯¯ã€‘: æ‰¾ä¸åˆ° characterChat å¯¹è±¡ï¼");
            return;
          }

          // --- å‡†å¤‡å·¥ä½œï¼šè®¾ç½®æ ‡é¢˜å’Œå¤´åƒ (ä»…åœ¨é¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œ) ---
          if (loadOffset === 0) {
            messagesEl.innerHTML = ""; // é¦–æ¬¡åŠ è½½æ‰æ¸…ç©º
            let finalContactName = contactName;
            if (isUserChat) {
              const myChatData = characterChat.characterPhoneData.chats["æˆ‘"];
              // å°è¯•ä»æ‰‹æœºæ•°æ®é‡Œæ‰¾AIç»™ç”¨æˆ·çš„å¤‡æ³¨å
              const userContactInData = characterChat.characterPhoneData.chats
                ? Object.values(characterChat.characterPhoneData.chats).find(
                    (c) => !c.history || c.history.length === 0,
                  )
                : null;
              finalContactName = userContactInData
                ? userContactInData.remarkName
                : "æˆ‘";
            }
            document.getElementById("character-chat-with-name").textContent =
              finalContactName;
          }

          // --- æ•°æ®æºé€‰æ‹© ---
          let fullHistory = [];
          if (isUserChat) {
            fullHistory = characterChat.history.filter((m) => !m.isHidden);
          } else {
            const npcChat = characterChat.characterPhoneData.chats[contactName];
            if (npcChat && npcChat.history) {
              fullHistory = npcChat.history;
            }
          }

          // --- æ ¸å¿ƒåˆ†é¡µé€»è¾‘ ---
          const totalMessages = fullHistory.length;
          const startIndex = Math.max(
            0,
            totalMessages - MESSAGES_PER_PAGE - loadOffset,
          );
          const endIndex = totalMessages - loadOffset;
          const historyToShow = fullHistory.slice(startIndex, endIndex);

          // --- ç§»é™¤æ—§çš„â€œåŠ è½½æ›´å¤šâ€æŒ‰é’® ---
          const existingLoader = document.getElementById(
            "load-more-messages-btn",
          );
          if (existingLoader) {
            existingLoader.remove();
          }

          // --- æ¸²æŸ“æ¶ˆæ¯ ---
          const fragment = document.createDocumentFragment(); // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæå‡æ€§èƒ½
          const characterName = characterChat.name;

          // (æ¸²æŸ“é€»è¾‘ä¸ä¹‹å‰ç‰ˆæœ¬åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯æ·»åŠ åˆ°äº† fragment ä¸­)
          historyToShow.forEach((msg, index) => {
            if (msg.isHidden) return;
            const container = document.createElement("div");
            let sender;
            if (isUserChat) {
              sender = msg.role === "user" ? "æˆ‘" : characterName;
            } else {
              sender = msg.sender;
            }

            const isSentByCharacter = sender === characterName;
            container.className = `character-chat-bubble-container ${isSentByCharacter ? "sent" : "received"}`;

            let avatarHtml = "";
            if (isSentByCharacter) {
              avatarHtml = `<img src="${
                characterChat.settings.aiAvatar || defaultAvatar
              }" class="character-chat-avatar">`;
            } else {
              if (isUserChat) {
                avatarHtml = `<img src="${
                  characterChat.settings.myAvatar || defaultMyGroupAvatar
                }" class="character-chat-avatar">`;
              } else {
                const npcData = (characterChat.npcLibrary || []).find(
                  (npc) => npc.name === contactName,
                );
                if (npcData && npcData.avatar) {
                  avatarHtml = `<img src="${npcData.avatar}" class="character-chat-avatar">`;
                } else {
                  const avatarColors = [
                    "#FFC107",
                    "#4CAF50",
                    "#2196F3",
                    "#F44336",
                    "#9C27B0",
                    "#00BCD4",
                  ];
                  const npcNameInitial = contactName.slice(-1);
                  const colorIndex = contactName.length % avatarColors.length;
                  const bgColor = avatarColors[colorIndex];
                  avatarHtml = `<div class="character-chat-avatar" style="background-color: ${bgColor}; color: white; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: 500;">${npcNameInitial}</div>`;
                }
              }
            }

            let contentHtml = "";
            if (
              typeof msg.content === "string" &&
              STICKER_REGEX.test(msg.content)
            ) {
              contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-height: 100px;">`;
            } else {
              contentHtml = msg.content;
            }
            const bubbleHtml = `<div class="character-chat-bubble">${contentHtml}</div>`;
            const originalIndex = startIndex + index; // è®¡ç®—åœ¨å®Œæ•´å†å²è®°å½•ä¸­çš„çœŸå®ç´¢å¼•
            container.innerHTML = `${avatarHtml}${bubbleHtml}<button class="item-delete-btn message-delete-btn" data-contact-name="${contactName}" data-index="${originalIndex}" data-is-user-chat="${isUserChat}">Ã—</button>`;
            fragment.appendChild(container);
          });

          // --- å†³å®šæ˜¯å¦æ˜¾ç¤ºâ€œåŠ è½½æ›´å¤šâ€æŒ‰é’® ---
          if (startIndex > 0) {
            const loadMoreBtn = document.createElement("div");
            loadMoreBtn.id = "load-more-messages-btn";
            loadMoreBtn.textContent = "åŠ è½½æ›´æ—©çš„æ¶ˆæ¯";
            loadMoreBtn.style.textAlign = "center";
            loadMoreBtn.style.padding = "10px";
            loadMoreBtn.style.color = "#888";
            loadMoreBtn.style.cursor = "pointer";
            loadMoreBtn.style.fontSize = "12px";
            loadMoreBtn.onclick = () => {
              // è®°å½•å½“å‰æ»šåŠ¨æ¡ä½ç½®ï¼Œä»¥ä¾¿åŠ è½½åæ¢å¤
              const currentScrollHeight = messagesEl.scrollHeight;
              renderCharacterChatHistory(
                contactName,
                isUserChat,
                loadOffset + MESSAGES_PER_PAGE,
              );
              // åŠ è½½åï¼Œå°†æ»šåŠ¨æ¡å®šä½åˆ°ä¹‹å‰çš„ä½ç½®ï¼Œé¿å…è·³åŠ¨
              messagesEl.scrollTop =
                messagesEl.scrollHeight - currentScrollHeight;
            };
            messagesEl.prepend(loadMoreBtn); // å°†æŒ‰é’®æ·»åŠ åˆ°é¡¶éƒ¨
          }

          messagesEl.prepend(fragment); // å°†æ–°æ¶ˆæ¯ä¸€æ¬¡æ€§æ’å…¥åˆ°DOMä¸­

          // --- æ»šåŠ¨æ¡å®šä½ ---
          if (loadOffset === 0) {
            // é¦–æ¬¡åŠ è½½ï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
            messagesEl.scrollTop = messagesEl.scrollHeight;
          }
        }

        function renderCharacterShoppingCart() {
          const listEl = document.getElementById(
            "character-shopping-cart-list",
          );

          const items =
            state.chats[activeCharacterPhoneId]?.characterPhoneData
              ?.shoppingCart;

          listEl.innerHTML = "";
          if (!items || items.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">è´­ç‰©è½¦æ˜¯ç©ºçš„</p>';
            return;
          }
          items.forEach((item, index) => {
            const itemEl = document.createElement("div");
            itemEl.className = "character-cart-item";
            itemEl.innerHTML = `
			            <div class="cart-item-icon">
			                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
			            </div>
			            <div class="cart-item-info">
			                <div class="title">${item.name}</div>
			                <div class="store">${item.store}</div>
			            </div>
			            <div class="cart-item-price">Â¥ ${item.price.toFixed(2)}</div>
			            <button class="item-delete-btn" data-type="shoppingCart" data-index="${index}">Ã—</button>
			        `;
            listEl.appendChild(itemEl);
          });
        }
        function renderCharacterMemos() {
          const listEl = document.getElementById("character-memos-list");

          const items =
            state.chats[activeCharacterPhoneId]?.characterPhoneData?.memos;

          listEl.innerHTML = "";
          if (!items || items.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">å¤‡å¿˜å½•æ˜¯ç©ºçš„</p>';
            return;
          }
          items.forEach((item, index) => {
            const itemEl = document.createElement("div");
            itemEl.className = "character-data-item";
            itemEl.innerHTML = `
			            <div class="title">${item.title}</div>
			            <div class="content">${item.content}</div>
			            <button class="item-delete-btn" data-type="memos" data-index="${index}">Ã—</button>
			        `;
            listEl.appendChild(itemEl);
          });
        }

        /**
         * åœ¨è§’è‰²æ‰‹æœºå†…éƒ¨åˆ‡æ¢é¡µé¢
         * @param {string} pageId - è¦æ˜¾ç¤ºçš„è§’è‰²æ‰‹æœºé¡µé¢çš„ID
         */
        function showCharacterPhonePage(pageId) {
          // 1. æ‰¾åˆ°è§’è‰²æ‰‹æœºå†…éƒ¨å±å¹•çš„æ‰€æœ‰é¡µé¢
          const pages = document.querySelectorAll(".character-phone-page");
          // 2. éšè—æ‰€æœ‰é¡µé¢
          pages.forEach((p) => p.classList.remove("active"));
          // 3. æ˜¾ç¤ºç›®æ ‡é¡µé¢
          const pageToShow = document.getElementById(pageId);
          if (pageToShow) {
            pageToShow.classList.add("active");
          }
        }

        // è§’è‰²æ‰‹æœºæ–°å¢APPæ¸²æŸ“å‡½æ•°

        function renderCharacterBrowser() {
          const listEl = document.getElementById("character-browser-list");

          const items =
            state.chats[activeCharacterPhoneId]?.characterPhoneData
              ?.browserHistory;

          listEl.innerHTML = "";
          if (!items || items.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æµè§ˆå™¨å†å²ä¸ºç©º</p>';
            return;
          }
          items.forEach((item, index) => {
            const itemEl = document.createElement("div");
            itemEl.className = "character-browser-item";
            itemEl.innerHTML = `
			            <span class="browser-item-icon">ğŸŒ</span>
			            <div class="title">${item.query}</div>
			            <button class="item-delete-btn" data-type="browserHistory" data-index="${index}">Ã—</button>
			        `;
            itemEl.addEventListener("click", (e) => {
              if (e.target.classList.contains("item-delete-btn")) return;
              document.getElementById(
                "character-browser-detail-title",
              ).textContent = item.query;
              document.getElementById(
                "character-browser-detail-content",
              ).innerHTML = (item.result || "AIæœªç”Ÿæˆè¯¦ç»†å†…å®¹ã€‚").replace(
                /\n/g,
                "<br>",
              );
              showCharacterPhonePage("character-browser-detail-screen");
            });
            listEl.appendChild(itemEl);
          });
        }

        function renderCharacterPhotoAlbum() {
          const gridEl = document.getElementById("character-album-grid");

          const items =
            state.chats[activeCharacterPhoneId]?.characterPhoneData?.photoAlbum;

          gridEl.innerHTML = "";
          if (!items || items.length === 0) {
            gridEl.innerHTML =
              '<p style="grid-column: 1 / -1; text-align:center; color: #8a8a8a; margin-top: 50px;">ç›¸å†Œé‡Œæ²¡æœ‰ç…§ç‰‡</p>';
            return;
          }
          items.forEach((item, index) => {
            const itemEl = document.createElement("div");
            itemEl.className = "character-album-item";
            itemEl.style.position = "relative";
            itemEl.innerHTML = `
			            <img src="https://i.postimg.cc/KYr2qRCK/1.jpg" alt="æ–‡å­—å›¾">
			            <button class="item-delete-btn" data-type="photoAlbum" data-index="${index}" style="top: 10px; right: 10px; z-index: 1;">Ã—</button>
			        `;
            itemEl.addEventListener("click", (e) => {
              if (e.target.classList.contains("item-delete-btn")) return;
              showCustomAlert("å›¾ç‰‡å†…å®¹", item.hiddenContent);
            });
            gridEl.appendChild(itemEl);
          });
        }

        /**
         * æ¸²æŸ“è§’è‰²æ‰‹æœº - é“¶è¡Œ
         */
        function renderCharacterBank() {
          const detailsEl = document.getElementById("character-bank-details");
          // è·å–å½“å‰è§’è‰²å¯¹è±¡ï¼Œä¸ºåé¢æ‰¾å¤‡æ³¨ååšå‡†å¤‡
          const characterChat = state.chats[activeCharacterPhoneId];
          if (!characterChat) return;

          const bankData = characterChat.characterPhoneData?.bank;
          detailsEl.innerHTML = "";

          // è·å–è§’è‰²ç»™ç”¨æˆ·çš„å¤‡æ³¨å
          const userContactInData = characterChat.characterPhoneData.chats
            ? Object.values(characterChat.characterPhoneData.chats).find(
                (c) => !c.history || c.history.length === 0,
              )
            : null;
          const remarkNameForMe = userContactInData
            ? userContactInData.remarkName
            : "æˆ‘";

          const balanceCard = document.createElement("div");
          balanceCard.className = "character-bank-balance-card";
          balanceCard.innerHTML = `
			        <div class="label">è´¦æˆ·ä½™é¢</div>
			        <div class="amount">Â¥ ${(bankData?.balance || 0).toFixed(2)}</div>
			    `;
          detailsEl.appendChild(balanceCard);

          if (!bankData?.transactions || bankData.transactions.length === 0) {
            detailsEl.innerHTML +=
              '<p style="text-align:center; color: #8a8a8a; margin-top: 30px;">æš‚æ— äº¤æ˜“æ˜ç»†</p>';
            return;
          }

          [...bankData.transactions].reverse().forEach((item, index) => {
            const originalIndex = bankData.transactions.length - 1 - index;
            const isIncome = item.type === "æ”¶å…¥";
            const itemEl = document.createElement("div");
            itemEl.className = "character-bank-transaction";
            const iconBg = isIncome ? "#4CAF50" : "#E91E63";
            const iconSvg = isIncome
              ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M7 10h10v4H7z" opacity=".3"/><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>`
              : `<svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-1 14H5c-.55 0-1-.45-1-1v-5h16v5c0 .55-.45 1-1 1zm1-10H4V7c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v2z"/></svg>`;

            // ç”¨æ­£åˆ™è¡¨è¾¾å¼ /æˆ‘/g å…¨å±€æ›¿æ¢æ‰€æœ‰â€œæˆ‘â€å­—
            const displayDescription = item.description.replace(
              /æˆ‘/g,
              remarkNameForMe,
            );

            itemEl.innerHTML = `
			            <div class="transaction-details">
			                <div class="transaction-icon" style="background-color: ${iconBg};">${iconSvg}</div>
			                <div>
			                    <div class="title">${displayDescription}</div>
			                    <div class="meta" style="border:none; padding:0; margin-top:4px;"><span>${item.type}</span></div>
			                </div>
			            </div>
			            <div style="display: flex; align-items: center; gap: 10px;">
			                <span class="transaction-amount ${isIncome ? "income" : "expense"}">
			                    ${isIncome ? "+" : "-"} ${item.amount.toFixed(2)}
			                </span>
			                <button class="item-delete-btn" data-type="bank.transactions" data-index="${originalIndex}">Ã—</button>
			            </div>
			        `;
            detailsEl.appendChild(itemEl);
          });
        }

        /**
         * æ¸²æŸ“è§’è‰²æ‰‹æœº - è¡ŒåŠ¨è½¨è¿¹
         */
        function renderCharacterTrajectory() {
          const listEl = document.getElementById("character-trajectory-list");
          const items =
            state.chats[activeCharacterPhoneId]?.characterPhoneData?.trajectory;
          listEl.innerHTML = "";
          listEl.classList.add("character-trajectory-list");

          if (!items || items.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æš‚æ— è¶³è¿¹</p>';
            return;
          }

          // åœ¨æ¸²æŸ“ä¹‹å‰ï¼Œä½¿ç”¨æ–°åŠ çš„ parseTime å‡½æ•°å¯¹è½¨è¿¹æ•°ç»„è¿›è¡Œæ’åº
          items.sort((a, b) => parseTime(a.time) - parseTime(b.time));

          items.forEach((item, index) => {
            const itemEl = document.createElement("div");
            itemEl.className = "character-trajectory-item";
            itemEl.innerHTML = `
			            <div class="trajectory-item-content">
			                <div class="title">${item.activity}</div>
			                <div class="meta">
			                    <span>ğŸ“ ${item.location}</span>
			                    <span style="margin-left: 10px;">ğŸ•’ ${item.time}</span>
			                </div>
			            </div>
			            <button class="item-delete-btn" data-type="trajectory" data-index="${index}">Ã—</button>
			        `;
            listEl.appendChild(itemEl);
          });
        }

        /**
         * æ¸²æŸ“è§’è‰²æ‰‹æœº - APPä½¿ç”¨è®°å½•
         */
        function renderCharacterAppUsage() {
          const listEl = document.getElementById("character-app-usage-list");

          const items =
            state.chats[activeCharacterPhoneId]?.characterPhoneData?.appUsage;

          listEl.innerHTML = "";
          if (!items || items.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æš‚æ— ä½¿ç”¨è®°å½•</p>';
            return;
          }
          const durationsInMinutes = items.map((item) =>
            parseDurationToMinutes(item.duration),
          );
          const maxDuration = Math.max(...durationsInMinutes);
          items.forEach((item, index) => {
            const itemEl = document.createElement("div");
            itemEl.className = "character-app-usage-item";
            const durationInMinutes = durationsInMinutes[index];
            const barWidth =
              maxDuration > 0 ? (durationInMinutes / maxDuration) * 100 : 0;
            itemEl.innerHTML = `
			            <div class="app-usage-header">
			                <span class="name">${item.appName}</span>
			                <div style="display: flex; align-items: center; gap: 10px;">
			                    <span class="duration">${item.duration}</span>
			                    <button class="item-delete-btn" data-type="appUsage" data-index="${index}">Ã—</button>
			                </div>
			            </div>
			            <div class="app-usage-bar-container">
			                <div class="app-usage-bar" style="width: ${barWidth}%;"></div>
			            </div>
			        `;
            listEl.appendChild(itemEl);
          });
        }

        /**
         * æ¸²æŸ“è§’è‰²çš„æ—¥è®°åˆ—è¡¨
         */
        function renderCharacterDiary() {
          const listEl = document.getElementById("character-diary-list");

          const items =
            state.chats[activeCharacterPhoneId]?.characterPhoneData?.diary;

          listEl.innerHTML = "";
          if (!items || items.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">æ—¥è®°æœ¬è¿˜æ˜¯ç©ºçš„ï¼Œç‚¹å‡»å³ä¸Šè§’å†™ä¸‹ç¬¬ä¸€ç¯‡æ—¥è®°å§ã€‚</p>';
            return;
          }

          [...items].reverse().forEach((item, index) => {
            const originalIndex = items.length - 1 - index;
            const itemEl = document.createElement("div");
            itemEl.className = "character-data-item";
            const contentHtml = renderMarkdown(item.content);
            itemEl.innerHTML = `
			            <div class="content">${contentHtml}</div>
			            <div class="meta">
			                <span>${new Date(item.timestamp).toLocaleString()}</span>
			            </div>
			            <button class="item-delete-btn" data-type="diary" data-index="${originalIndex}">Ã—</button>
			        `;
            listEl.appendChild(itemEl);
          });
        }

        /**
         * ã€æ—¥è®°ã€‘ç‹¬ç«‹åˆ·æ–°ï¼Œç”Ÿæˆæ–°çš„æ—¥è®°æ¡ç›®
         */
        async function generateNewDiaryEntry() {
          const userNickname = state.qzoneSettings.nickname || "æˆ‘";
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];
          if (!chat) return;

          document
            .getElementById("generation-overlay")
            .classList.add("visible");

          try {
            const persona = chat.settings.aiPersona;
            const recentHistory = chat.history
              .slice(-chat.settings.maxMemory || 20)
              .map((msg) => {
                const sender = msg.role === "user" ? userNickname : chat.name;
                return `${sender}: ${msg.content}`;
              })
              .join("\n");
            let linkedMemoryContext = "";
            if (
              chat.settings.linkedMemories &&
              chat.settings.linkedMemories.length > 0
            ) {
              const contextPromises = chat.settings.linkedMemories.map(
                async (link) => {
                  const linkedChat = state.chats[link.chatId];
                  if (!linkedChat) return "";

                  const freshLinkedChat = await db.chats.get(link.chatId);
                  if (!freshLinkedChat) return "";

                  const recentHistory = freshLinkedChat.history
                    .filter((msg) => !msg.isHidden)
                    .slice(-link.depth);

                  if (recentHistory.length === 0) return "";

                  const formattedMessages = recentHistory
                    .map(
                      (msg) =>
                        `  - ${formatMessageForContext(msg, freshLinkedChat)}`,
                    )
                    .join("\n");

                  return `\n## é™„åŠ ä¸Šä¸‹æ–‡ï¼šæ¥è‡ªä¸â€œ${linkedChat.name}â€çš„æœ€è¿‘å¯¹è¯å†…å®¹ (ä»…ä½ å¯è§)\n${formattedMessages}`;
                },
              );

              const allContexts = await Promise.all(contextPromises);
              linkedMemoryContext = allContexts.filter(Boolean).join("\n");
            }
            let worldBookContext = "";
            if (
              chat.settings.linkedWorldBookIds &&
              chat.settings.linkedWorldBookIds.length > 0
            ) {
              worldBookContext =
                "--- ä¸–ç•Œè§‚è®¾å®š (è¿™æ˜¯ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆçš„èƒŒæ™¯) ---\n" +
                chat.settings.linkedWorldBookIds
                  .map((id) => {
                    const book = state.worldBooks.find((b) => b.id === id);
                    return book ? `[${book.name}]: ${book.content}` : "";
                  })
                  .join("\n\n");
            }

            const diaryPrompt = `
			# ä»»åŠ¡
			ä½ ç°åœ¨æ˜¯è§’è‰² "${chat.name}"ã€‚ä»Šå¤©æ˜¯ ${new Date().toLocaleString("zh-CN", {
        dateStyle: "full",
      })}ã€‚è¯·ä½ å›é¡¾ä¸€ä¸‹æœ€è¿‘å’Œæˆ‘çš„èŠå¤©ï¼Œä»¥åŠä½ çš„äººè®¾ï¼Œç„¶åç”¨ä½ çš„å£å»å†™ä¸€ç¯‡å…³äºã€ä»Šå¤©æˆ–è¿‘æœŸå‘ç”Ÿäº‹æƒ…ã€‘çš„æ—¥è®°ã€‚
			è¿™ç¯‡æ—¥è®°æ˜¯ä½ å†…å¿ƒçš„ç‹¬ç™½ï¼Œå¯ä»¥è®°å½•ä½ çš„æ„Ÿå—ã€æ€è€ƒã€è®¡åˆ’æˆ–è€…ç§˜å¯†ã€‚
			å†…å®¹è¦ä¸°å¯Œã€æœ‰æ·±åº¦ï¼Œé•¿åº¦åœ¨100åˆ°300å­—ä¹‹é—´ã€‚

			# ã€ã€ã€é‡è¦ï¼šæ ¼å¼æŒ‡ä»¤ã€‘ã€‘ã€‘
			ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ä»¥ä¸‹Markdownè¯­æ³•æ¥ä¸°å¯Œæ—¥è®°çš„æ ¼å¼ï¼Œä½¿å…¶æ›´å…·è¡¨ç°åŠ›ï¼š
			-   **æ ‡é¢˜**: ä½¿ç”¨ \`#\` æˆ– \`##\` æ¥åˆ›å»ºå¤§æ ‡é¢˜å’Œå‰¯æ ‡é¢˜ã€‚ (ä¾‹å¦‚: \`# ä»Šå¤©çš„å¿ƒæƒ…\`)
			-   **ç²—ä½“**: ä½¿ç”¨ \`**æ–‡å­—**\` æ¥å¼ºè°ƒé‡ç‚¹ã€‚ (ä¾‹å¦‚: \`ä»Šå¤©çœŸçš„**éå¸¸**å¼€å¿ƒã€‚\`)
			-   **æ–œä½“**: ä½¿ç”¨ \`*æ–‡å­—*\` æ¥è¡¨è¾¾æƒ…ç»ªæˆ–å†…å¿ƒæƒ³æ³•ã€‚ (ä¾‹å¦‚: \`*ä»–åˆ°åº•æ˜¯æ€ä¹ˆæƒ³çš„å‘¢...*\`)
			-   **åˆ é™¤çº¿**: ä½¿ç”¨ \`~~æ–‡å­—~~\` æ¥è¡¨ç¤ºåˆ’æ‰æˆ–å¦å®šçš„æƒ³æ³•ã€‚ (ä¾‹å¦‚: \`æˆ‘å†³å®šæ˜å¤©å»<s>é€›è¡—</s>å­¦ä¹ ã€‚\`)
			-   **é®æŒ¡/å‰§é€**: ä½¿ç”¨ \`||æ–‡å­—||\` æ¥éšè—ç§˜å¯†æˆ–æ‚„æ‚„è¯ã€‚ (ä¾‹å¦‚: \`æˆ‘å·å·å‡†å¤‡äº†ä¸€ä¸ªæƒŠå–œï¼Œ||æ˜¯ä¸€ä¸ªæ‰‹ç»‡çš„å›´å·¾||ã€‚\`)

			ä½ çš„è¾“å‡ºã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯æ—¥è®°çš„æ­£æ–‡å†…å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–è¯´æ˜æˆ–JSONæ ¼å¼ã€‚

			# ä½ çš„ä¿¡æ¯
			- ä½ çš„åå­—: ${chat.name}
			- ä½ çš„äººè®¾: ${persona}
			${worldBookContext}

			# æœ€è¿‘èŠå¤©è®°å½•å‚è€ƒ
			${recentHistory}
			${linkedMemoryContext}
			`;

            const { proxyUrl, apiKey, model } = state.apiConfig;
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              diaryPrompt,
              [{ role: "user", content: diaryPrompt }],
              isGemini,
            );

            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: [{ role: "user", content: diaryPrompt }],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  }),
                });

            if (!response.ok) {
              let errorMsg = `APIè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`;
              try {
                const errorData = await response.json();
                errorMsg += `\né”™è¯¯ä¿¡æ¯: ${errorData.error.message}`;
              } catch (e) {
                errorMsg += `\næ— æ³•è§£æé”™è¯¯å“åº”ä½“ã€‚`;
              }
              throw new Error(errorMsg);
            }

            const data = await response.json();
            const diaryContent = isGemini
              ? data.candidates[0].content.parts[0].text
              : data.choices[0].message.content;

            const newEntry = {
              timestamp: Date.now(),
              content: diaryContent,
            };

            chat.characterPhoneData.diary.push(newEntry);
            await db.chats.put(chat);

            renderCharacterDiary();
            alert("æ–°æ—¥è®°å·²ç”Ÿæˆï¼");
          } catch (error) {
            console.error("ç”Ÿæˆæ—¥è®°å¤±è´¥:", error);
            await showCustomAlert(
              "ç”Ÿæˆå¤±è´¥",
              `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼Œè¯·æ£€æŸ¥ä½ çš„ç½‘ç»œã€APIå¯†é’¥æˆ–æ¨¡å‹è®¾ç½®ã€‚\n\nè¯¦ç»†ä¿¡æ¯:\n${error.message}`,
            );
          } finally {
            document
              .getElementById("generation-overlay")
              .classList.remove("visible");
          }
        }

        // ä¸‡èƒ½Markdownæ¸²æŸ“å‡½æ•° (å¸¦å®‰å…¨è¿‡æ»¤å’Œé®æŒ¡æ•ˆæœ)

        /**
         * å°†Markdownæ–‡æœ¬å®‰å…¨åœ°æ¸²æŸ“ä¸ºHTML
         * @param {string} markdownText - åŸå§‹çš„Markdownæ–‡æœ¬
         * @returns {string} - å¤„ç†å’Œå‡€åŒ–åçš„å®‰å…¨HTMLå­—ç¬¦ä¸²
         */
        function renderMarkdown(markdownText) {
          if (!markdownText) return "";

          // 1. æ”¯æŒè‡ªå®šä¹‰çš„â€œé®æŒ¡/å‰§é€â€è¯­æ³• ||spoiler||
          // æˆ‘ä»¬åœ¨ marked.js å¤„ç†ä¹‹å‰ï¼Œæ‰‹åŠ¨æŠŠ ||text|| æ›¿æ¢æˆå¸¦ç‰¹å®šclassçš„HTMLæ ‡ç­¾
          let processedText = markdownText.replace(
            /\|\|(.*?)\|\|/g,
            '<span class="spoiler">$1</span>',
          );

          // 2. ä½¿ç”¨ marked.js å°†Markdownè½¬æ¢ä¸ºHTML
          // gfm: true å¼€å¯GitHubé£æ ¼çš„Markdownï¼Œæ”¯æŒåˆ é™¤çº¿ç­‰
          // breaks: true è®©å›è½¦ç¬¦ä¹Ÿèƒ½å˜æˆ<br>ï¼Œæ›´ç¬¦åˆèŠå¤©ä¹ æƒ¯
          let rawHtml = marked.parse(processedText, {
            gfm: true,
            breaks: true,
          });

          // 3. ä½¿ç”¨ DOMPurify æ¸…æ´—HTMLï¼Œé˜²æ­¢XSSæ”»å‡»
          let sanitizedHtml = DOMPurify.sanitize(rawHtml);

          return sanitizedHtml;
        }

        /**
         * ã€è¾…åŠ©å‡½æ•°ã€‘å°†æ—¶é•¿å­—ç¬¦ä¸²ï¼ˆå¦‚â€œ2.5å°æ—¶â€ï¼‰è½¬æ¢ä¸ºåˆ†é’Ÿæ•°
         */
        function parseDurationToMinutes(durationString) {
          if (!durationString) return 0;
          const num = parseFloat(durationString) || 0;
          if (durationString.includes("å°æ—¶") || durationString.includes("h")) {
            return num * 60;
          }
          // é»˜è®¤å•ä½æ˜¯åˆ†é’Ÿ
          return num;
        }

        function switchVideoViews() {
          // åˆ‡æ¢çŠ¶æ€ï¼šæ ‡è®°å½“å‰è°åœ¨ä¸»å±å¹•
          videoCallState.isUserMain = !videoCallState.isUserMain;

          const chat = state.chats[videoCallState.activeChatId];
          if (!chat) return;

          const useCamera = chat.settings.useRealCamera;

          // è·å–æ‰€æœ‰è§†å›¾å…ƒç´ 
          const mainImg = document.querySelector("#video-main-view img");
          const mainVideo = document.querySelector("#video-main-view video");
          const pipImg = document.querySelector("#video-pip-view img");
          const pipVideo = document.querySelector("#video-pip-view video");

          // å‡†å¤‡èµ„æºåœ°å€
          const charUrl = chat.settings.charVideoImage || defaultAvatar;
          const userUrl = chat.settings.userVideoImage || defaultAvatar;

          // æ ¹æ®å‰ç½®/åç½®å†³å®šæ˜¯å¦é•œåƒ (å‰ç½®é•œåƒï¼Œåç½®ä¸é•œåƒ)
          const shouldMirror = videoCallState.facingMode === "user";
          const mirrorStyle = shouldMirror ? "scaleX(-1)" : "none";

          // --- è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨æ’­æ”¾è§†é¢‘ ---
          const safePlay = (videoEl, stream, transform) => {
            if (!videoEl) return;
            videoEl.srcObject = stream;
            videoEl.muted = true; // å¿…é¡»é™éŸ³æ‰èƒ½è‡ªåŠ¨æ’­æ”¾
            videoEl.style.transform = transform;
            videoEl.style.display = "block";
            // å¼ºåˆ¶è§¦å‘æ’­æ”¾
            videoEl.play().catch((e) => console.error("è§†é¢‘æ’­æ”¾å¤±è´¥:", e));
          };

          if (videoCallState.isUserMain) {
            // === çŠ¶æ€ Aï¼šç”¨æˆ·(æˆ‘)åœ¨ä¸»å¤§å±ï¼Œè§’è‰²(Ta)åœ¨å°å± ===

            // 1. è®¾ç½®å°å± (æ˜¾ç¤ºå¯¹æ–¹ - å§‹ç»ˆæ˜¯å›¾ç‰‡)
            if (pipVideo) {
              pipVideo.style.display = "none";
              pipVideo.srcObject = null; // åˆ‡æ–­æµ
            }
            if (pipImg) {
              pipImg.style.display = "block";
              pipImg.src = charUrl;
            }

            // 2. è®¾ç½®å¤§å± (æ˜¾ç¤ºæˆ‘)
            if (useCamera && window.localCameraStream) {
              // æ‘„åƒå¤´æ¨¡å¼ -> è§†é¢‘æµç»™å¤§å±
              if (mainImg) mainImg.style.display = "none";
              // ä½¿ç”¨è¾…åŠ©å‡½æ•°å¼ºåˆ¶æ’­æ”¾
              safePlay(mainVideo, window.localCameraStream, mirrorStyle);
            } else {
              // å›¾ç‰‡æ¨¡å¼ -> å›¾ç‰‡ç»™å¤§å±
              if (mainVideo) {
                mainVideo.style.display = "none";
                mainVideo.srcObject = null;
              }
              if (mainImg) {
                mainImg.style.display = "block";
                mainImg.src = userUrl;
              }
            }
          } else {
            // === çŠ¶æ€ B (é»˜è®¤)ï¼šè§’è‰²(Ta)åœ¨ä¸»å¤§å±ï¼Œç”¨æˆ·(æˆ‘)åœ¨å°å± ===

            // 1. è®¾ç½®å¤§å± (æ˜¾ç¤ºå¯¹æ–¹ - å§‹ç»ˆæ˜¯å›¾ç‰‡)
            if (mainVideo) {
              mainVideo.style.display = "none";
              mainVideo.srcObject = null; // åˆ‡æ–­æµ
            }
            if (mainImg) {
              mainImg.style.display = "block";
              mainImg.src = charUrl;
            }

            // 2. è®¾ç½®å°å± (æ˜¾ç¤ºæˆ‘)
            if (useCamera && window.localCameraStream) {
              // æ‘„åƒå¤´æ¨¡å¼ -> è§†é¢‘æµç»™å°å±
              if (pipImg) pipImg.style.display = "none";
              // ä½¿ç”¨è¾…åŠ©å‡½æ•°å¼ºåˆ¶æ’­æ”¾
              safePlay(pipVideo, window.localCameraStream, mirrorStyle);
            } else {
              // å›¾ç‰‡æ¨¡å¼ -> å›¾ç‰‡ç»™å°å±
              if (pipVideo) {
                pipVideo.style.display = "none";
                pipVideo.srcObject = null;
              }
              if (pipImg) {
                pipImg.style.display = "block";
                pipImg.src = userUrl;
              }
            }
          }
        }

        // ã€æ–°å¢ã€‘å¤„ç†æ‘„åƒå¤´ç¿»è½¬
        async function handleCameraFlip() {
          if (!window.localCameraStream) return;

          // 1. åœæ­¢å½“å‰æµ
          window.localCameraStream.getTracks().forEach((track) => track.stop());

          // 2. åˆ‡æ¢æ¨¡å¼
          videoCallState.facingMode =
            videoCallState.facingMode === "user" ? "environment" : "user";

          // 3. é‡æ–°è¯·æ±‚æ‘„åƒå¤´
          try {
            const newStream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: videoCallState.facingMode },
              audio: false,
            });

            window.localCameraStream = newStream;

            // 4. å°†æ–°æµåº”ç”¨åˆ°å½“å‰æ­£åœ¨æ˜¾ç¤ºçš„ video æ ‡ç­¾ä¸Š
            const mainVideo = document.querySelector("#video-main-view video");
            const pipVideo = document.querySelector("#video-pip-view video");

            // æ ¹æ®å‰ç½®/åç½®å†³å®šæ˜¯å¦é•œåƒ
            const shouldMirror = videoCallState.facingMode === "user";
            const mirrorStyle = shouldMirror ? "scaleX(-1)" : "none";

            if (videoCallState.isUserMain) {
              // å¦‚æœæˆ‘åœ¨å¤§å±ï¼Œæ›´æ–°å¤§å±
              if (mainVideo) {
                mainVideo.srcObject = newStream;
                mainVideo.style.transform = mirrorStyle;
                mainVideo.play();
              }
            } else {
              // å¦‚æœæˆ‘åœ¨å°å±ï¼Œæ›´æ–°å°å±
              if (pipVideo) {
                pipVideo.srcObject = newStream;
                pipVideo.style.transform = mirrorStyle;
                pipVideo.play();
              }
            }
          } catch (err) {
            console.error("åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥:", err);
            alert("åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥ï¼Œå¯èƒ½æ˜¯è®¾å¤‡ä¸æ”¯æŒæˆ–æƒé™è¢«æ‹’ç»ã€‚");
          }
        }

        /**
         * å¤„ç†è§†é¢‘é€šè¯ä¸­çš„â€œé‡rollâ€è¯·æ±‚
         */
        async function handleVideoCallReroll() {
          if (!videoCallState.isActive) return;

          // 1. æ‰¾åˆ°ç”¨æˆ·æœ€åä¸€æ¬¡è¯´çš„è¯çš„ç´¢å¼•
          const lastUserSpeechIndex = videoCallState.callHistory.findLastIndex(
            (h) => h.role === "user",
          );

          // 2. ä»é€šè¯å†å²ä¸­ï¼Œåˆ é™¤æ‰é‚£ä¹‹åçš„æ‰€æœ‰AIå›å¤
          //    å¦‚æœç”¨æˆ·ä¸€å¥è¯æ²¡è¯´ï¼ˆlastUserSpeechIndex æ˜¯ -1ï¼‰ï¼Œå°±åˆ é™¤æ‰€æœ‰AIçš„å›å¤
          if (lastUserSpeechIndex > -1) {
            videoCallState.callHistory.splice(lastUserSpeechIndex + 1);
          } else {
            // å¦‚æœç”¨æˆ·è¿˜æ²¡è¯´è¿‡è¯ï¼Œå°±æ¸…ç©ºæ‰€æœ‰å†å²ï¼Œè®©AIé‡è¯´ç¬¬ä¸€å¥è¯
            videoCallState.callHistory = [];
          }

          // 3. é‡æ–°æ¸²æŸ“é€šè¯ç•Œé¢ï¼Œè®©æ—§çš„AIæ°”æ³¡ä»å±å¹•ä¸Šæ¶ˆå¤±
          //    éœ€è¦æ ¹æ®å½“å‰æ˜¯å“ªç§æ¨¡å¼ï¼Œæ¥æ¸…ç©ºå¯¹åº”çš„èŠå¤©å®¹å™¨
          const chat = state.chats[videoCallState.activeChatId];
          const isVisualMode = chat.settings.visualVideoCallEnabled;
          const callFeed = isVisualMode
            ? document.getElementById("video-call-messages-visual")
            : document.getElementById("video-call-main");

          callFeed.innerHTML = ""; // æ¸…ç©ºå®¹å™¨

          // é‡æ–°æ¸²æŸ“åˆ é™¤åçš„å†å²è®°å½•
          videoCallState.callHistory.forEach((msg) => {
            let bubble;
            if (isVisualMode) {
              bubble = document.createElement("div");
              bubble.className = `visual-call-bubble ${msg.role === "user" ? "user" : "ai"}`;
            } else {
              bubble = document.createElement("div");
              bubble.className = `call-message-bubble ${msg.role === "user" ? "user-speech" : "ai-speech"}`;
            }
            bubble.textContent = msg.content;
            callFeed.appendChild(bubble);
          });

          // 4. é‡æ–°è§¦å‘AIå“åº”ï¼Œå®ƒä¼šæ ¹æ®åˆ å‡åçš„å†å²è®°å½•ç”Ÿæˆæ–°å†…å®¹
          await triggerAiInCallAction();
        }

        /**
         * åº”ç”¨æŒ‡å®šçš„ä¸»é¢˜ï¼ˆ'light' æˆ– 'dark'ï¼‰
         * @param {string} theme - è¦åº”ç”¨çš„ä¸»é¢˜åç§°
         */
        function applyTheme(theme) {
          const phoneScreen = document.getElementById("phone-screen");
          const toggleSwitch = document.getElementById("theme-toggle-switch");

          const isDark = theme === "dark";

          // æ ¸å¿ƒæ“ä½œï¼šæ·»åŠ æˆ–ç§»é™¤ .dark-mode ç±»
          phoneScreen.classList.toggle("dark-mode", isDark);

          // å¦‚æœå¼€å…³å­˜åœ¨ï¼Œå°±åŒæ­¥å®ƒçš„çŠ¶æ€
          if (toggleSwitch) {
            toggleSwitch.checked = isDark;
          }

          // å°†ç”¨æˆ·çš„é€‰æ‹©ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä»¥ä¾¿ä¸‹æ¬¡æ‰“å¼€æ—¶è®°ä½
          localStorage.setItem("ephone-theme", theme);

          // å› ä¸ºèŠå¤©èƒŒæ™¯è‰²ä¾èµ–æ¨¡å¼ï¼Œåˆ‡æ¢åéœ€è¦é‡æ–°æ¸²æŸ“
          if (state.activeChatId) {
            renderChatInterface(state.activeChatId);
          }
        }

        /**
         * å½“ç”¨æˆ·ç‚¹å‡»å¼€å…³æ—¶ï¼Œåˆ‡æ¢å½“å‰çš„ä¸»é¢˜
         */
        function toggleTheme() {
          const toggleSwitch = document.getElementById("theme-toggle-switch");
          // ç›´æ¥æ ¹æ®å¼€å…³çš„é€‰ä¸­çŠ¶æ€æ¥å†³å®šæ–°ä¸»é¢˜
          const newTheme = toggleSwitch.checked ? "dark" : "light";
          applyTheme(newTheme);
        }

        /**
         * åˆ é™¤è§’è‰²æ‰‹æœºä¸­çš„ä¸€ä¸ªè”ç³»äººåŠå…¶æ‰€æœ‰èŠå¤©è®°å½•
         * @param {string} contactName - è¦åˆ é™¤çš„è”ç³»äººçš„åå­—
         */
        async function deleteCharacterPhoneContact(contactName) {
          if (!activeCharacterPhoneId) return;

          // å¼¹å‡ºç¡®è®¤æ¡†ï¼Œé˜²æ­¢è¯¯åˆ 
          const confirmed = await showCustomConfirm(
            "åˆ é™¤è”ç³»äºº",
            `ç¡®å®šè¦ä»TAçš„æ‰‹æœºä¸­åˆ é™¤è”ç³»äººâ€œ${contactName}â€ä»¥åŠæ‰€æœ‰ç›¸å…³èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            const chat = state.chats[activeCharacterPhoneId];
            if (
              chat &&
              chat.characterPhoneData &&
              chat.characterPhoneData.chats
            ) {
              // ä»æ•°æ®ä¸­åˆ é™¤è¿™ä¸ªè”ç³»äºº
              delete chat.characterPhoneData.chats[contactName];

              // å°†æ›´æ–°åçš„æ•°æ®ä¿å­˜å›æ•°æ®åº“
              await db.chats.put(chat);

              // é‡æ–°æ¸²æŸ“èŠå¤©åˆ—è¡¨ï¼Œè®©åˆ é™¤æ•ˆæœç«‹åˆ»æ˜¾ç¤º
              renderCharacterChatList();

              alert(`è”ç³»äººâ€œ${contactName}â€å·²åˆ é™¤ã€‚`);
            }
          }
        }

        /**
         * æ‰“å¼€å¿ƒå£°é¢æ¿ï¼Œåº”ç”¨èƒŒæ™¯å’Œæ‰€æœ‰è‡ªå®šä¹‰è®¾ç½®
         */
        function openInnerVoiceModal() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          // --- åº”ç”¨è‡ªå®šä¹‰æ ·å¼  ---
          applySavedInnerVoiceStyles();

          applyInnerVoiceBackground(chat.innerVoiceBackground || "");

          if (!chat.latestInnerVoice) {
            alert("è¿˜æ²¡æœ‰æ•æ‰åˆ°Taçš„å¿ƒå£°å“¦ï¼Œè¯•ç€å†èŠä¸€å¥å§ï¼");
            return;
          }

          const modal = document.getElementById("inner-voice-modal");
          const data = chat.latestInnerVoice;

          // --- è§’è‰²ä¿¡æ¯å¡«å…… ---
          document.getElementById("inner-voice-avatar").src =
            chat.settings.aiAvatar || defaultAvatar;
          document.getElementById("inner-voice-char-name").textContent =
            chat.name;
          const frameImg = document.getElementById("inner-voice-avatar-frame");
          const avatarWrapper = document.getElementById(
            "inner-voice-avatar-wrapper",
          );
          const frameUrl = chat.settings.aiAvatarFrame || "";

          if (frameUrl) {
            frameImg.src = frameUrl;
            frameImg.style.display = "block";
            avatarWrapper.classList.remove("has-border");
          } else {
            frameImg.src = "";
            frameImg.style.display = "none";
            avatarWrapper.classList.add("has-border");
          }

          const labelFormat =
            chat.settings.innerVoiceAdopterLabelFormat || "é¢†å…»äºº: {{user}}";
          const userNickname = chat.settings.myNickname || "ä½ ";
          const finalAdopterText = labelFormat.replace(
            "{{user}}",
            userNickname,
          );

          document.getElementById("inner-voice-adopter-avatar").src =
            chat.settings.myAvatar || defaultAvatar;
          document.getElementById("inner-voice-adopter-name").textContent =
            finalAdopterText;

          const header = document.querySelector(
            "#inner-voice-main-panel .modal-header",
          );
          if (header) {
            const shouldHideBorder =
              chat.settings.innerVoiceHideHeaderBorder || false;
            header.classList.toggle("no-border", shouldHideBorder);
          }

          // === ã€ä¿®å¤é‡ç‚¹å¼€å§‹ã€‘ï¼šè·å–æ ‡ç­¾å¹¶è®¾ç½®é»˜è®¤å€¼ ===
          // é˜²æ­¢ chat.settings.innerVoiceTags ä¸ºç©ºæˆ–éƒ¨åˆ†å­—æ®µç¼ºå¤±
          const tags = chat.settings.innerVoiceTags || {};

          const label1 = tags.clothing_label || "æœè£…";
          const label2 = tags.behavior_label || "è¡Œä¸º";
          const label3 = tags.thoughts_label || "å¿ƒå£°";
          const label4 = tags.naughty_label || "åå¿ƒæ€";

          // 1. è®¾ç½®ç¬¬ä¸€ä¸ªæ ‡ç­¾
          const clothingLabel = document.querySelector(
            "#inner-voice-content-area div:nth-child(1) strong",
          );
          if (clothingLabel) clothingLabel.textContent = label1 + ":";
          document.getElementById("inner-voice-clothing").textContent =
            data.clothing || "...";

          // 2. è®¾ç½®ç¬¬äºŒä¸ªæ ‡ç­¾
          const behaviorLabel = document.querySelector(
            "#inner-voice-content-area div:nth-child(2) strong",
          );
          if (behaviorLabel) behaviorLabel.textContent = label2 + ":";
          document.getElementById("inner-voice-behavior").textContent =
            data.behavior || "...";

          // 3. è®¾ç½®ç¬¬ä¸‰ä¸ªæ ‡ç­¾
          const thoughtsLabel = document.querySelector(
            "#inner-voice-content-area div:nth-child(3) strong",
          );
          if (thoughtsLabel) thoughtsLabel.textContent = label3 + ":";
          document.getElementById("inner-voice-thoughts").textContent =
            data.thoughts || "...";

          // 4. è®¾ç½®ç¬¬å››ä¸ªæ ‡ç­¾
          const naughtyLabel = document.querySelector(
            "#inner-voice-content-area div:nth-child(4) strong",
          );
          if (naughtyLabel) naughtyLabel.textContent = label4 + ":";
          document.getElementById("inner-voice-naughty-thoughts").textContent =
            data.naughtyThoughts || "...";
          // === ã€ä¿®å¤é‡ç‚¹ç»“æŸã€‘ ===

          // --- æ˜¾ç¤ºé¢æ¿ ---
          modal.classList.add("visible");
          document.getElementById("inner-voice-history-panel").style.display =
            "none";
          document.getElementById("inner-voice-main-panel").style.display =
            "flex";
          isInnerVoiceHistoryOpen = false;
        }

        /**
         * æ‰“å¼€æˆ–å…³é—­å†å²è®°å½•é¢æ¿
         */
        function toggleInnerVoiceHistory() {
          const mainPanel = document.getElementById("inner-voice-main-panel");
          const historyPanel = document.getElementById(
            "inner-voice-history-panel",
          );

          if (isInnerVoiceHistoryOpen) {
            // å¦‚æœæ˜¯æ‰“å¼€çš„ï¼Œå°±å…³é—­å®ƒï¼Œæ˜¾ç¤ºä¸»é¢æ¿
            mainPanel.style.display = "flex";
            historyPanel.style.display = "none";
          } else {
            // å¦‚æœæ˜¯å…³é—­çš„ï¼Œå°±æ‰“å¼€å®ƒï¼Œéšè—ä¸»é¢æ¿
            renderInnerVoiceHistory(); // æ¸²æŸ“å†å²è®°å½•
            mainPanel.style.display = "none";
            historyPanel.style.display = "flex";
          }
          isInnerVoiceHistoryOpen = !isInnerVoiceHistoryOpen; // åˆ‡æ¢çŠ¶æ€
        }

        /**
         * æ¸²æŸ“å¿ƒå£°çš„å†å²è®°å½•åˆ—è¡¨
         * (å·²ä¿®å¤ï¼šæ”¯æŒæ˜¾ç¤ºè‡ªå®šä¹‰æ ‡ç­¾å)
         */
        function renderInnerVoiceHistory() {
          const listEl = document.getElementById("inner-voice-history-list");
          listEl.innerHTML = "";
          const chat = state.chats[state.activeChatId];
          const history = chat.innerVoiceHistory || [];

          if (history.length === 0) {
            listEl.innerHTML =
              '<p style="text-align: center; color: #888; padding: 20px;">è¿˜æ²¡æœ‰å†å²è®°å½•</p>';
            return;
          }

          // === æ–°å¢ï¼šè·å–å½“å‰è‡ªå®šä¹‰æ ‡ç­¾ ===
          // é˜²æ­¢ chat.settings.innerVoiceTags ä¸ºç©º
          const tags = chat.settings.innerVoiceTags || {};
          // å¦‚æœç”¨æˆ·æ²¡è®¾ç½®è¿‡ï¼Œå°±ç”¨é»˜è®¤å€¼
          const label1 = tags.clothing_label || "æœè£…";
          const label2 = tags.behavior_label || "è¡Œä¸º";
          const label3 = tags.thoughts_label || "å¿ƒå£°";
          const label4 = tags.naughty_label || "åå¿ƒæ€";
          // ==============================

          // ä»æ–°åˆ°æ—§æ˜¾ç¤º
          [...history].reverse().forEach((item) => {
            const itemEl = document.createElement("div");
            itemEl.className = "inner-voice-history-item";

            const date = new Date(item.timestamp);
            const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(
              date.getDate(),
            ).padStart(
              2,
              "0",
            )} ${String(date.getHours()).padStart(2, "0")}:${String(
              date.getMinutes(),
            ).padStart(2, "0")}`;

            // åœ¨HTMLä¸­åŠ å…¥åˆ é™¤æŒ‰é’®
            // å…³é”®ä¿®æ”¹ç‚¹ï¼šå°†åŸæ¥çš„ä¸­æ–‡å†™æ­»ï¼Œæ›¿æ¢ä¸ºä¸Šé¢è·å–çš„å˜é‡ ${labelX}
            itemEl.innerHTML = `
			            <button class="history-item-delete-btn" data-timestamp="${item.timestamp}">Ã—</button>
			            <div class="history-item-timestamp">${dateString}</div>
			            <div class="history-item-content">
			                <p><strong>${label1}:</strong> ${item.clothing || "..."}</p>
			                <p><strong>${label2}:</strong> ${item.behavior || "..."}</p>
			                <p><strong>${label3}:</strong> ${item.thoughts || "..."}</p>
			                <p><strong>${label4}:</strong> ${item.naughtyThoughts || "..."}</p>
			            </div>
			        `;
            listEl.appendChild(itemEl);
          });
        }

        /**
         * åˆ é™¤å•æ¡å¿ƒå£°è®°å½•
         * @param {number} timestamp - è¦åˆ é™¤çš„å¿ƒå£°çš„æ—¶é—´æˆ³
         */
        async function deleteSingleInnerVoice(timestamp) {
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.innerVoiceHistory) return;

          // å¼¹å‡ºç¡®è®¤æ¡†
          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            "ç¡®å®šè¦åˆ é™¤è¿™æ¡å¿ƒå£°è®°å½•å—ï¼Ÿ",
            {
              confirmButtonClass: "btn-danger",
            },
          );
          if (confirmed) {
            // ä»æ•°ç»„ä¸­è¿‡æ»¤æ‰åŒ¹é…çš„é¡¹
            chat.innerVoiceHistory = chat.innerVoiceHistory.filter(
              (item) => item.timestamp !== timestamp,
            );
            // ä¿å­˜å›æ•°æ®åº“
            await db.chats.put(chat);
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderInnerVoiceHistory();
          }
        }

        /**
         * æ¸…ç©ºæ‰€æœ‰å¿ƒå£°è®°å½•ï¼ˆåŒ…æ‹¬å½“å‰å¿ƒå£°ï¼‰
         */
        async function clearAllInnerVoiceHistory() {
          const chat = state.chats[state.activeChatId];
          // ä¼˜åŒ–äº†åˆ¤æ–­æ¡ä»¶ï¼Œç¡®ä¿åªè¦æœ‰å†å²æˆ–å½“å‰å¿ƒå£°ï¼Œå°±å¯ä»¥æ‰§è¡Œæ¸…ç©º
          if (
            !chat ||
            ((!chat.innerVoiceHistory || chat.innerVoiceHistory.length === 0) &&
              !chat.latestInnerVoice)
          ) {
            alert("æ²¡æœ‰å¯ä»¥æ¸…ç©ºçš„å¿ƒå£°è®°å½•ã€‚");
            return;
          }

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤æ¸…ç©º",
            "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¿ƒå£°å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",
            {
              confirmButtonClass: "btn-danger",
            },
          );
          if (confirmed) {
            // ä¸ä»…æ¸…ç©ºå†å²æ•°ç»„ï¼Œä¹Ÿè¦æ¸…ç©ºå½“å‰çš„å¿ƒå£°å¯¹è±¡
            chat.innerVoiceHistory = [];
            chat.latestInnerVoice = null; // å°†å½“å‰å¿ƒå£°è®¾ä¸ºnull

            await db.chats.put(chat);

            // æ‰‹åŠ¨æ¸…ç©ºä¸»é¢æ¿çš„æ˜¾ç¤ºï¼Œé˜²æ­¢è¿”å›æ—¶çœ‹åˆ°æ—§æ•°æ®
            document.getElementById("inner-voice-clothing").textContent = "...";
            document.getElementById("inner-voice-behavior").textContent = "...";
            document.getElementById("inner-voice-thoughts").textContent = "...";
            document.getElementById(
              "inner-voice-naughty-thoughts",
            ).textContent = "...";

            // åˆ·æ–°å†å²è®°å½•åˆ—è¡¨ï¼ˆè¿™è¡Œæ˜¯åŸæœ¬å°±æœ‰çš„ï¼Œä¼šæ˜¾ç¤ºâ€œè¿˜æ²¡æœ‰å†å²è®°å½•â€ï¼‰
            renderInnerVoiceHistory();

            // (å¯é€‰ä½†æ¨è) ç»™ç”¨æˆ·ä¸€ä¸ªæˆåŠŸçš„æç¤º
            alert("æ‰€æœ‰å¿ƒå£°è®°å½•å·²æ¸…ç©ºï¼");
          }
        }

        /**
         * å½“ç”¨æˆ·ç‚¹å‡»â€œå¬å”¤NPCè¯„è®ºâ€æŒ‰é’®æ—¶è§¦å‘
         * @param {number} postId - åŠ¨æ€çš„ID
         * @param {string} authorId - åŠ¨æ€ä½œè€…çš„ID ('user' æˆ– 'chat_...')
         */
        async function handleNpcSummonClick(postId, authorId) {
          const post = await db.qzonePosts.get(postId);
          if (!post) {
            alert("æ‰¾ä¸åˆ°è¯¥åŠ¨æ€ï¼");
            return;
          }

          if (authorId === "user") {
            // å¦‚æœæ˜¯ç”¨æˆ·å‘çš„åŠ¨æ€ï¼Œå¼¹å‡ºé€‰æ‹©èœå•
            await handleUserPostCommentTrigger(post);
          } else {
            // å¦‚æœæ˜¯è§’è‰²å‘çš„åŠ¨æ€ï¼Œç›´æ¥è§¦å‘ä»–è‡ªå·±çš„NPC
            await handleCharPostCommentTrigger(post, authorId);
          }
        }

        /**
         * å¤„ç†ã€è§’è‰²ã€‘åŠ¨æ€çš„NPCå¬å”¤
         * @param {object} post - åŠ¨æ€å¯¹è±¡
         * @param {string} authorId - åŠ¨æ€ä½œè€…çš„è§’è‰²ID
         */
        async function handleCharPostCommentTrigger(post, authorId) {
          const authorChar = state.chats[authorId];
          if (
            !authorChar ||
            !authorChar.npcLibrary ||
            authorChar.npcLibrary.length === 0
          ) {
            alert(`è§’è‰²â€œ${authorChar.name}â€è¿˜æ²¡æœ‰è‡ªå·±çš„NPCæœ‹å‹å“¦ï¼`);
            return;
          }

          // åªä½¿ç”¨è¿™ä¸ªè§’è‰²è‡ªå·±çš„NPCåº“
          // æŠŠä½œè€…æœ¬äºº(authorChar)ä½œä¸ºâ€œä¸»äººâ€ä¼ è¿›å»
          await generateNpcCommentsForPost(
            post,
            authorChar.npcLibrary,
            authorChar,
          );
        }

        /**
         * å¤„ç†ã€ç”¨æˆ·ã€‘åŠ¨æ€çš„NPCå¬å”¤ï¼ˆå¼¹å‡ºé€‰æ‹©æ¡†ï¼‰
         */
        async function handleUserPostCommentTrigger(post) {
          const modal = document.getElementById("custom-modal-overlay");
          const modalTitle = document.getElementById("custom-modal-title");
          const modalBody = document.getElementById("custom-modal-body");
          const modalConfirmBtn = document.getElementById(
            "custom-modal-confirm",
          );
          const modalCancelBtn = document.getElementById("custom-modal-cancel");

          modalTitle.textContent = "é€‰æ‹©è¦å¬å”¤çš„NPC";

          // ç­›é€‰å‡ºæ‰€æœ‰æ‹¥æœ‰NPCåº“çš„è§’è‰²
          const charsWithNpcs = Object.values(state.chats).filter(
            (chat) =>
              !chat.isGroup && chat.npcLibrary && chat.npcLibrary.length > 0,
          );

          if (charsWithNpcs.length === 0) {
            alert("å½“å‰æ²¡æœ‰ä»»ä½•è§’è‰²æ‹¥æœ‰NPCåº“ã€‚");
            return;
          }

          // æ„å»ºé€‰æ‹©åˆ—è¡¨çš„HTML
          let optionsHtml = '<div style="text-align: left;">';
          optionsHtml += `<label style="display: block; padding: 5px;"><input type="radio" name="npc_summon_choice" value="all" checked> å¬å”¤æ‰€æœ‰äºº</label>`;
          charsWithNpcs.forEach((char) => {
            optionsHtml += `<label style="display: block; padding: 5px;"><input type="radio" name="npc_summon_choice" value="${char.id}"> åªå¬å”¤ ${char.name} çš„æœ‹å‹</label>`;
          });
          optionsHtml += "</div>";

          modalBody.innerHTML = optionsHtml;
          modalConfirmBtn.textContent = "ç¡®è®¤å¬å”¤";
          modalCancelBtn.style.display = "block";

          modal.classList.add("visible");

          modalConfirmBtn.onclick = async () => {
            const selectedValue = document.querySelector(
              'input[name="npc_summon_choice"]:checked',
            ).value;
            let npcsToSummon = [];
            let ownerChar = null; // å£°æ˜ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨ä¸»äºº

            if (selectedValue === "all") {
              // é›†åˆæ‰€æœ‰è§’è‰²çš„æ‰€æœ‰NPC
              charsWithNpcs.forEach((char) => {
                npcsToSummon.push(...char.npcLibrary);
              });
              // å¬å”¤æ‰€æœ‰äººæ—¶ï¼Œæˆ‘ä»¬ä¸æŒ‡å®šç‰¹å®šçš„ä¸»äºº
            } else {
              // åªè·å–è¢«é€‰ä¸­çš„é‚£ä¸ªè§’è‰²çš„NPC
              const selectedChar = state.chats[selectedValue];
              if (selectedChar) {
                npcsToSummon = selectedChar.npcLibrary;
                ownerChar = selectedChar; // æŠŠé€‰ä¸­çš„è§’è‰²å­˜ä¸ºä¸»äºº
              }
            }

            modal.classList.remove("visible");
            if (npcsToSummon.length > 0) {
              // æŠŠä¸»äºº(ownerChar)ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ä¼ è¿›å»
              await generateNpcCommentsForPost(post, npcsToSummon, ownerChar);
            }
          };

          modalCancelBtn.onclick = () => modal.classList.remove("visible");
        }

        /**
         * ç”ŸæˆNPCè¯„è®ºæˆ–å›å¤ï¼Œå¹¶æ›´æ–°åˆ°åŠ¨æ€
         * @param {object} post - åŠ¨æ€å¯¹è±¡
         * @param {Array<object>} npcsToComment - å°†è¦å‘è¡¨è¯„è®ºçš„NPCå¯¹è±¡æ•°ç»„
         * @param {object|null} ownerChar - (å…¨æ–°å¢) è¿™äº›NPCçš„â€œä¸»äººâ€è§’è‰²å¯¹è±¡
         */
        async function generateNpcCommentsForPost(
          post,
          npcsToComment,
          ownerChar = null,
        ) {
          console.log(
            "ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 1. å‡½æ•° generateNpcCommentsForPost å·²è§¦å‘",
            {
              post,
              npcsToComment,
              ownerChar,
            },
          );

          await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨å¬å”¤NPCä»¬å‰æ¥å›´è§‚è¯„è®º...");

          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) {
            alert("è¯·å…ˆé…ç½®APIï¼");
            return;
          }

          const postContent = (
            post.content ||
            post.publicText ||
            post.hiddenContent ||
            "(å›¾ç‰‡åŠ¨æ€)"
          ).substring(0, 150);
          const existingComments = (post.comments || [])
            .slice(-3)
            .map((c) => `${c.commenterName}: ${c.text}`)
            .join("\n");

          const shuffledNpcs = [...npcsToComment].sort(
            () => 0.5 - Math.random(),
          );
          const selectedNpcs = shuffledNpcs.slice(0, 5);
          const npcList = selectedNpcs
            .map((npc) => `- ${npc.name} (äººè®¾: ${npc.persona})`)
            .join("\n");

          const authorName =
            post.authorId === "user"
              ? state.qzoneSettings.nickname
              : state.chats[post.authorId]?.name || "æœªçŸ¥ä½œè€…";

          let ownerContext = "";
          // å¦‚æœæ˜ç¡®å‘Šè¯‰äº†AIè¿™äº›NPCçš„ä¸»äººæ˜¯è°
          if (ownerChar) {
            ownerContext = `
			# NPCå½’å±ä¸å…³ç³» (é‡è¦èƒŒæ™¯)
			- ä½ å°†è¦æ‰®æ¼”çš„è¿™äº›NPCéƒ½æ˜¯è§’è‰²â€œ${ownerChar.name}â€çš„æœ‹å‹æˆ–å…³è”äººç‰©ã€‚
			- â€œ${ownerChar.name}â€çš„äººè®¾æ˜¯: ${ownerChar.settings.aiPersona}
			- ä½ åœ¨å‘è¡¨è¯„è®ºæ—¶ï¼Œéœ€è¦ä½“ç°å‡ºä½ (ä½œä¸ºNPC)ä¸â€œ${ownerChar.name}â€çš„å…³ç³»ï¼Œå¹¶ä»¥æ­¤è§†è§’æ¥çœ‹å¾…åŠ¨æ€ä½œè€…â€œ${authorName}â€ã€‚
			`;
          }

          const systemPrompt = `
			# ä»»åŠ¡
			ä½ æ˜¯ä¸€ä¸ªå¤šè§’è‰²æ‰®æ¼”AIã€‚ç°åœ¨æœ‰ä¸€æ¡åŠ¨æ€éœ€è¦ä½ æ‰®æ¼”æŒ‡å®šçš„NPCè§’è‰²è¿›è¡Œè¯„è®ºæˆ–å›å¤ã€‚

			${ownerContext}

			# åŠ¨æ€ä¿¡æ¯
			- ä½œè€…: ${authorName}
			- å†…å®¹æ‘˜è¦: ${postContent}...
			- æœ€è¿‘çš„è¯„è®º (ä½ å¯ä»¥å›å¤ä»–ä»¬):
			${existingComments || "(æš‚æ— è¯„è®º)"}

			# ä½ éœ€è¦æ‰®æ¼”çš„NPCåˆ—è¡¨ (åŠä»–ä»¬çš„äººè®¾)
			${npcList}

			# æ ¸å¿ƒè§„åˆ™
			1.  ä½ ã€å¿…é¡»ã€‘ä»ä¸Šé¢çš„NPCåˆ—è¡¨ä¸­ï¼Œé€‰æ‹©1åˆ°3ä¸ªæœ€åˆé€‚çš„è§’è‰²è¿›è¡Œè¯„è®ºæˆ–å›å¤ã€‚
			2.  è¯„è®º/å›å¤å†…å®¹ã€å¿…é¡»ã€‘ä¸¥æ ¼ç¬¦åˆè¯¥NPCçš„äººè®¾å’Œå£å»ï¼Œå¹¶ä¸åŠ¨æ€å†…å®¹æˆ–å·²æœ‰è¯„è®ºç›¸å…³ã€‚
			3.  ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€æ¡è¯„è®ºæˆ–å›å¤ã€‚
			4.  æ ¼å¼: \`[{"commenterName": "NPCåå­—", "commentText": "è¯„è®ºå†…å®¹", "replyTo": "(å¯é€‰)è¢«å›å¤è€…åå­—"}]\`

			ç°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆè¯„è®ºæˆ–å›å¤ã€‚
			`;
          console.log(
            "ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 2. å·²æ„å»ºå®Œæˆï¼Œå‡†å¤‡å‘é€ç»™AIçš„ System Prompt:",
            systemPrompt,
          );

          try {
            let isGemini = proxyUrl === GEMINI_API_URL;
            let messagesForApi;
            if (isGemini) {
              messagesForApi = [{ role: "user", content: systemPrompt }];
            } else {
              messagesForApi = [
                { role: "system", content: systemPrompt },
                {
                  role: "user",
                  content: "è¯·æ ¹æ®ä½ åœ¨system promptä¸­è¯»åˆ°çš„ä¿¡æ¯ç”Ÿæˆè¯„è®ºã€‚",
                },
              ];
            }

            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPrompt,
              messagesForApi,
              isGemini,
              state.apiConfig.temperature,
            );

            console.log(
              "ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 3. å³å°†å‘é€APIè¯·æ±‚... è¯·æ±‚åœ°å€:",
              isGemini ? geminiConfig.url : `${proxyUrl}/v1/chat/completions`,
            );
            console.log(
              "ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 3.1 è¯·æ±‚ä½“ (Body) å†…å®¹:",
              isGemini
                ? geminiConfig.data.body
                : JSON.stringify({
                    model,
                    messages: messagesForApi,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  }),
            );

            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  }),
                });

            console.log("ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 4. æ”¶åˆ°APIå“åº”", {
              ok: response.ok,
              status: response.status,
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            const aiResponseContent = (
              isGemini
                ? data.candidates[0].content.parts[0].text
                : data.choices[0].message.content
            )
              .replace(/^```json\s*|```$/g, "")
              .trim();

            console.log(
              "ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 5. ä»APIè·å–åˆ°çš„åŸå§‹å›å¤å†…å®¹:",
              aiResponseContent,
            );

            let newComments;
            if (aiResponseContent.includes('"chatResponse"')) {
              newComments = JSON.parse(aiResponseContent).chatResponse;
            } else {
              newComments = JSON.parse(aiResponseContent);
            }

            console.log(
              "ã€NPCè¯„è®º-è¯Šæ–­ã€‘: 6. æˆåŠŸè§£æåçš„è¯„è®ºå¯¹è±¡æ•°ç»„:",
              newComments,
            );

            if (Array.isArray(newComments) && newComments.length > 0) {
              const postToUpdate = await db.qzonePosts.get(post.id);
              if (!postToUpdate)
                throw new Error("åœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°è¦æ›´æ–°çš„å¸–å­ï¼");
              if (!postToUpdate.comments) postToUpdate.comments = [];

              newComments.forEach((comment) => {
                if (comment.commenterName && comment.commentText) {
                  const newCommentObject = {
                    commenterName: comment.commenterName,
                    text: comment.commentText,
                    timestamp: Date.now(),
                  };
                  if (comment.replyTo)
                    newCommentObject.replyTo = comment.replyTo;
                  postToUpdate.comments.push(newCommentObject);
                }
              });

              await db.qzonePosts.put(postToUpdate);
              hideCustomModal();
              await renderQzonePosts();
              alert("NPCä»¬è¯„è®ºæˆåŠŸï¼");
            } else {
              hideCustomModal();
              alert("NPCä»¬ä¼¼ä¹æ²¡ä»€ä¹ˆæƒ³è¯´çš„ã€‚");
            }
          } catch (error) {
            console.error("ã€NPCè¯„è®º-é”™è¯¯ã€‘: å¬å”¤NPCè¯„è®ºå¤±è´¥:", error);
            await showCustomAlert(
              "å¬å”¤å¤±è´¥",
              `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n${error.message}`,
            );
          }
        }

        /**
         * å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰ï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå†…ç½®çš„å¤œé—´æ¨¡å¼ä¸»é¢˜
         */
        async function addDefaultDarkModeThemeIfNeeded() {
          const themeName = "å†…ç½®å¤œé—´æ¨¡å¼"; // è¿™æ˜¯æˆ‘ä»¬è¦å†…ç½®çš„ä¸»é¢˜åå­—
          try {
            // æ£€æŸ¥æ•°æ®åº“é‡Œæ˜¯å¦å·²ç»æœ‰äº†è¿™ä¸ªåå­—çš„ä¸»é¢˜
            const existingTheme = await db.themes
              .where("name")
              .equals(themeName)
              .first();

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ° (existingTheme æ˜¯ undefined)ï¼Œå°±åˆ›å»ºå®ƒ
            if (!existingTheme) {
              console.log("å†…ç½®å¤œé—´æ¨¡å¼ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º...");

              // è¿™å°±æ˜¯å®Œæ•´çš„å¤œé—´æ¨¡å¼CSSä»£ç 
              const darkModeCss = `
			/* 1. å…¨å±€é‡æ–°å®šä¹‰é¢œè‰²å˜é‡ */
			:root {
			  --secondary-bg: #1c1c1e;
			  --border-color: #38383a;
			  --text-primary: #ffffff;
			  --text-secondary: #8e8e93;
			  --status-bar-text-color: #ffffff;
			  --accent-color: #0A84FF; /* iOSé£æ ¼çš„è“è‰² */
			}

			/* 2. ä¸ºæ‰€æœ‰å±å¹•å’Œä¸»è¦å®¹å™¨è®¾ç½®åŸºç¡€æ·±è‰²èƒŒæ™¯ */
			#phone-screen, .screen, #chat-list, #world-book-list, .list-container, .form-container, #chat-messages,
			#wallpaper-screen, #font-settings-screen, #api-settings-screen, #character-selection-screen,
			#world-book-screen, #world-book-editor-screen, #character-phone-inner-screen, #character-phone-page {
			    background-color: #000000 !important;
			}

			/* 3. ä¸»å±å¹•ä¸“å±æ ·å¼ */
			#home-screen { background: #111827 !important; }
			#desktop-dock { background-color: rgba(55, 65, 81, 0.5); }
			.desktop-app-icon .label, .widget-subtext { color: #e5e7eb; text-shadow: 0 1px 2px rgba(0,0,0,0.7); }
			#profile-widget .profile-info { background: linear-gradient(to bottom, rgba(28, 28, 30, 0.85) 20%, rgba(28, 28, 30, 0)); color: #f9fafb; }
			#profile-username, #profile-bio, #profile-location span { color: #f9fafb; }
			#profile-sub-username, #profile-location { color: #9ca3af; }
			#profile-location { background-color: rgba(255,255,255,0.1); }
			.widget-bubble { background-color: rgba(55, 65, 81, 0.9); color: #e5e7eb; }
			.widget-bubble::after { border-top-color: rgba(55, 65, 81, 0.9); }

			/* 4. é€‚é…æ‰€æœ‰é¡µé¢çš„å¤´éƒ¨Header */
			.header, .qzone-header, .character-phone-header {
			    background-color: rgba(28, 28, 30, 0.85) !important;
			    border-bottom-color: var(--border-color) !important;
			    color: var(--text-primary) !important;
			}

			/* 5. é€‚é…æ‰€æœ‰é€šç”¨ç»„ä»¶ */
			#chat-input-area, #chat-list-bottom-nav { background-color: rgba(28, 28, 30, 0.85); border-top-color: var(--border-color); }
			#chat-input { background-color: var(--secondary-bg); color: var(--text-primary); }
			.modal-content, #custom-modal { background-color: #2c2c2e; }
			.modal-header, .modal-footer, .custom-modal-footer, .custom-modal-footer button:first-child { border-color: var(--border-color); }
			.form-group input, .form-group select, .form-group textarea { background-color: var(--secondary-bg); color: var(--text-primary); border-color: var(--border-color); }
			.list-item, .chat-list-item-swipe-container:not(:last-child), .chat-group-container, .world-book-group-container { border-bottom-color: var(--border-color) !important; }
			.chat-group-container:first-of-type { border-top-color: var(--border-color) !important; }
			.list-item:hover, .chat-list-item:hover { background-color: #2c2c2e; }

			/* 6. ç‰¹æ®Šé¡µé¢æ·±åº¦é€‚é… */
			.chat-group-header, .world-book-group-header { background-color: #1c1c1e; }
			.chat-list-item-content.pinned { background-color: #3a3a3c; }
			#font-preview, #wallpaper-preview, .font-preset-slot { background-color: #1c1c1e !important; border-color: #38383a !important; }

			/* 7. è§’è‰²æ‰‹æœºå†…éƒ¨é€‚é… & å…¨å±€æ–‡å­—é¢œè‰²ä¿®å¤ */
			#character-phone-container { background-color: #000000; }
			.character-phone-frame { background-color: #111; }
			#character-chat-history-messages { background-color: #0e0e0e !important; }
			.character-chat-bubble.received { background-color: #2c2c2e !important; }
			.character-data-item, .character-bank-transaction, .character-cart-item, .character-browser-item {
			    background-color: #1c1c1e;
			    border-color: #38383a;
			}

			/* â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šæŠŠæ‰€æœ‰è¿™äº›å…ƒç´ çš„æ–‡å­—é¢œè‰²éƒ½æ”¹ä¸ºä½é¥±å’Œåº¦çš„æµ…ç°è‰² â–¼â–¼â–¼ */
			.character-data-item .title,
			.character-data-item .content,
			.character-data-item .meta,
			.cart-item-price,
			.cart-item-info .title,
			.character-browser-item .title,
			.transaction-details .title,
			.transaction-amount,
			.character-select-item .name,  /* ä¿®å¤è§’è‰²é€‰æ‹©åˆ—è¡¨çš„åå­—é¢œè‰² */
			#character-diary-list .character-data-item .content,
			#character-diary-list .character-data-item .content h1,
			#character-diary-list .character-data-item .content h2 {
			    color: #E0E0E0 !important; /* ä½¿ç”¨ä¸€ä¸ªæŸ”å’Œçš„ã€ä¸åˆºçœ¼çš„ç™½è‰² */
			}

			.character-data-item .meta span,
			#character-diary-list .character-data-item .meta {
			    color: #9E9E9E !important; /* æ¬¡è¦ä¿¡æ¯ä½¿ç”¨æ›´æš—çš„ç°è‰² */
			}

			#character-diary-list .character-data-item {
			    background-color: #26211a; /* å¤œé—´æ¨¡å¼ä¸‹çš„ä¿¡çº¸èƒŒæ™¯è‰² */
			    border-color: #524a3d;
			    border-left-color: #9e8a70;
			}

			`;

              await db.themes.add({ name: themeName, css: darkModeCss });
              console.log("å†…ç½®å¤œé—´æ¨¡å¼å·²æˆåŠŸåˆ›å»ºï¼");
            } else {
              console.log("å†…ç½®å¤œé—´æ¨¡å¼å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºã€‚");
            }
          } catch (error) {
            console.error("æ£€æŸ¥æˆ–åˆ›å»ºå†…ç½®å¤œé—´æ¨¡å¼æ—¶å‡ºé”™:", error);
          }
        }
        // èŠå¤©è®°å½•æœç´¢åŠŸèƒ½æ ¸å¿ƒå‡½æ•°

        /**
         * æ‰“å¼€å¹¶å‡†å¤‡èŠå¤©è®°å½•æœç´¢ç•Œé¢
         */
        function openChatSearchScreen() {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          // æ¸…ç©ºæ—§çš„æœç´¢æ¡ä»¶å’Œç»“æœ
          document.getElementById("keyword-search-input").value = "";
          document.getElementById("sender-search-select").innerHTML = "";
          document.getElementById("date-search-input").value = "";
          document.getElementById("chat-search-results-list").innerHTML =
            '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¾“å…¥æ¡ä»¶å¼€å§‹æœç´¢</p>';

          // åŠ¨æ€å¡«å……â€œäººç‰©â€ä¸‹æ‹‰èœå•
          const senderSelect = document.getElementById("sender-search-select");
          senderSelect.innerHTML = '<option value="">æ‰€æœ‰äºº</option>'; // é»˜è®¤é€‰é¡¹

          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "æˆ‘"
            : "æˆ‘";
          const myOption = document.createElement("option");
          myOption.value = myNickname;
          myOption.textContent = myNickname;
          senderSelect.appendChild(myOption);

          if (chat.isGroup) {
            chat.members.forEach((member) => {
              const memberOption = document.createElement("option");
              memberOption.value = member.originalName; // ä½¿ç”¨æœ¬åè¿›è¡Œç²¾ç¡®åŒ¹é…
              memberOption.textContent = member.groupNickname; // æ˜¾ç¤ºç¾¤æ˜µç§°ç»™ç”¨æˆ·çœ‹
              senderSelect.appendChild(memberOption);
            });
          } else {
            const aiOption = document.createElement("option");
            aiOption.value = chat.name;
            aiOption.textContent = chat.name;
            senderSelect.appendChild(aiOption);
          }

          // å…³é—­èŠå¤©è®¾ç½®å¼¹çª—ï¼Œå¹¶æ˜¾ç¤ºæœç´¢ç•Œé¢
          document
            .getElementById("chat-settings-modal")
            .classList.remove("visible");
          showScreen("chat-search-screen");
        }

        /**
         * æ‰§è¡Œæœç´¢æ“ä½œ
         */
        function performChatSearch() {
          const chat = state.chats[state.activeChatId];
          if (!chat) {
            // å¦‚æœæ‰¾ä¸åˆ°èŠå¤©å¯¹è±¡ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªæ˜ç¡®çš„æç¤º
            alert("æ— æ³•æ‰§è¡Œæœç´¢ï¼Œå› ä¸ºæ²¡æœ‰æ‰¾åˆ°å½“å‰èŠå¤©ã€‚");
            return;
          }

          // 1. è·å–æ‰€æœ‰æœç´¢æ¡ä»¶
          const keyword = document
            .getElementById("keyword-search-input")
            .value.trim();
          const senderValue = document.getElementById(
            "sender-search-select",
          ).value;
          const dateValue = document.getElementById("date-search-input").value;

          // å°†å…³é”®è¯ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“ç»“æœæ—¶ç”¨äºé«˜äº®
          currentSearchKeyword = keyword;

          if (!keyword && !senderValue && !dateValue) {
            alert("è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªæœç´¢æ¡ä»¶ï¼");
            return;
          }

          // 2. ç­›é€‰èŠå¤©è®°å½•
          console.log(
            `å¼€å§‹æœç´¢: å…³é”®è¯='${keyword}', å‘è¨€äºº='${senderValue}', æ—¥æœŸ='${dateValue}'`,
          );

          const results = chat.history.filter((msg) => {
            // è¿‡æ»¤æ‰ç³»ç»Ÿæ¶ˆæ¯å’Œå¯¹ç”¨æˆ·éšè—çš„æ¶ˆæ¯
            if (
              msg.isHidden ||
              msg.role === "system" ||
              msg.type === "recalled_message"
            ) {
              return false;
            }

            // a. ç­›é€‰æ—¥æœŸ
            if (dateValue) {
              const msgDate = new Date(msg.timestamp)
                .toISOString()
                .split("T")[0];
              if (msgDate !== dateValue) {
                return false;
              }
            }

            // b. ç­›é€‰å‘è¨€äºº
            if (senderValue) {
              const myNickname = chat.isGroup
                ? chat.settings.myNickname || "æˆ‘"
                : "æˆ‘";
              let msgSenderName = "";

              if (msg.role === "user") {
                msgSenderName = myNickname;
              } else {
                // AIæˆ–ç¾¤æˆå‘˜çš„æ¶ˆæ¯
                // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ originalName æ¥ç²¾ç¡®åŒ¹é…ï¼Œå› ä¸ºç¾¤æ˜µç§°å¯èƒ½ä¼šå˜
                msgSenderName = chat.isGroup ? msg.senderName : chat.name;
              }
              if (msgSenderName !== senderValue) {
                return false;
              }
            }

            // c. ç­›é€‰å…³é”®è¯
            if (keyword) {
              let contentText = "";
              // å°†æ‰€æœ‰å¯èƒ½åŒ…å«æ–‡æœ¬çš„å†…å®¹éƒ½è½¬æ¢æˆå­—ç¬¦ä¸²è¿›è¡Œæœç´¢
              if (typeof msg.content === "string") {
                contentText = msg.content;
              } else if (
                typeof msg.content === "object" &&
                msg.content !== null
              ) {
                // å¯¹äºå¤æ‚å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†å®ƒä»¬è½¬ä¸ºJSONå­—ç¬¦ä¸²æ¥æœç´¢
                contentText = JSON.stringify(msg.content);
              }

              if (!contentText.toLowerCase().includes(keyword.toLowerCase())) {
                return false;
              }
            }

            return true; // æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³
          });

          console.log(`æœç´¢åˆ° ${results.length} æ¡ç»“æœ`);

          // 3. æ¸²æŸ“ç»“æœ
          renderSearchResults(results);
        }

        /**
         * æ¸²æŸ“æœç´¢ç»“æœåˆ—è¡¨
         * @param {Array} results - ç­›é€‰å‡ºçš„æ¶ˆæ¯æ•°ç»„
         */
        function renderSearchResults(results) {
          const listEl = document.getElementById("chat-search-results-list");
          listEl.innerHTML = "";
          listEl.scrollTop = 0; // æ¯æ¬¡æ¸²æŸ“å‰ï¼Œéƒ½å°†æ»šåŠ¨æ¡é‡ç½®åˆ°é¡¶éƒ¨

          if (results.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">æœªæ‰¾åˆ°ç›¸å…³è®°å½•</p>';
            return;
          }

          const chat = state.chats[state.activeChatId];
          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "æˆ‘"
            : "æˆ‘";

          // ä¸ºäº†æ€§èƒ½ï¼Œåªæ¸²æŸ“æœ€æ–°çš„100æ¡ç»“æœ
          results
            .slice(-100)
            .reverse()
            .forEach((msg) => {
              const item = document.createElement("div");
              item.className = "search-result-item";
              item.dataset.timestamp = msg.timestamp; // å…³é”®ï¼ç”¨äºè·³è½¬

              let senderName, senderAvatar;
              if (msg.role === "user") {
                senderName = myNickname;
                senderAvatar = chat.settings.myAvatar;
              } else {
                if (chat.isGroup) {
                  senderName = msg.senderName;
                  const member = chat.members.find(
                    (m) => m.originalName === senderName,
                  );
                  senderAvatar = member
                    ? member.avatar
                    : defaultGroupMemberAvatar;
                } else {
                  senderName = chat.name;
                  senderAvatar = chat.settings.aiAvatar;
                }
              }

              let contentText = "";
              if (
                msg.type === "sticker" ||
                (typeof msg.content === "string" &&
                  STICKER_REGEX.test(msg.content))
              ) {
                contentText = "[è¡¨æƒ…]";
              } else if (
                msg.type === "ai_image" ||
                msg.type === "user_photo" ||
                Array.isArray(msg.content)
              ) {
                contentText = "[å›¾ç‰‡]";
              } else {
                contentText = String(msg.content);
              }

              item.innerHTML = `
			            <img src="${senderAvatar || defaultAvatar}" class="avatar">
			            <div class="search-result-info">
			                <div class="search-result-meta">
			                    <span class="name">${senderName}</span>
			                    <span class="timestamp">${formatDateStamp(msg.timestamp)}</span>
			                </div>
			                <div class="search-result-content">
			                    ${highlightText(contentText, currentSearchKeyword)}
			                </div>
			            </div>
			        `;
              listEl.appendChild(item);
            });
        }

        /**
         * è¾…åŠ©å‡½æ•°ï¼šé«˜äº®æ–‡æœ¬ä¸­çš„å…³é”®è¯
         * @param {string} text - åŸå§‹æ–‡æœ¬
         * @param {string} keyword - è¦é«˜äº®çš„å…³é”®è¯
         * @returns {string} - å¤„ç†åçš„HTMLå­—ç¬¦ä¸²
         */
        function highlightText(text, keyword) {
          if (!keyword || !text) {
            return text;
          }
          const regex = new RegExp(
            keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&"),
            "gi",
          );
          return text.replace(regex, `<span class="highlight">$&</span>`);
        }

        /**
         * ç‚¹å‡»æœç´¢ç»“æœï¼Œè·³è½¬åˆ°å¯¹åº”çš„æ¶ˆæ¯ä½ç½®
         * @param {number} timestamp - ç›®æ ‡æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        async function jumpToMessage(timestamp) {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const targetIndex = chat.history.findIndex(
            (msg) => msg.timestamp === timestamp,
          );
          if (targetIndex === -1) {
            await showCustomAlert("é”™è¯¯", "æ‰¾ä¸åˆ°è¯¥æ¡æ¶ˆæ¯ï¼Œå¯èƒ½å·²è¢«åˆ é™¤ã€‚");
            return;
          }

          // 1. åˆ‡æ¢å›èŠå¤©ç•Œé¢
          showScreen("chat-interface-screen");
          await new Promise((resolve) => setTimeout(resolve, 50));

          const messagesContainer = document.getElementById("chat-messages");
          messagesContainer.innerHTML = ""; // æ¸…ç©ºå½“å‰å†…å®¹

          // 2. è®¡ç®—è¦æ¸²æŸ“çš„æ¶ˆæ¯çª—å£ï¼ˆä»¥ç›®æ ‡æ¶ˆæ¯ä¸ºä¸­å¿ƒï¼‰
          const windowSize = 50; // å’Œ MESSAGE_RENDER_WINDOW ä¿æŒä¸€è‡´
          const startIndex = Math.max(
            0,
            targetIndex - Math.floor(windowSize / 2),
          );
          const messagesToRender = chat.history.slice(startIndex);

          // 3. æ›´æ–° currentRenderedCount ä»¥åŒæ­¥åŠ è½½çŠ¶æ€
          //    è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œå®ƒå‘Šè¯‰â€œåŠ è½½æ›´å¤šâ€åŠŸèƒ½ä¸‹æ¬¡åº”è¯¥ä»å“ªé‡Œå¼€å§‹åŠ è½½
          currentRenderedCount = messagesToRender.length;

          // 4. å¦‚æœè®¡ç®—å‡ºçš„èµ·å§‹ä½ç½®å¤§äº0ï¼Œè¯´æ˜å‰é¢è¿˜æœ‰æ›´æ—©çš„è®°å½•ï¼Œéœ€è¦æ˜¾ç¤ºâ€œåŠ è½½æ›´å¤šâ€æŒ‰é’®
          if (startIndex > 0) {
            prependLoadMoreButton(messagesContainer);
          }

          // 5. æ¸²æŸ“æ¶ˆæ¯çª—å£å’Œæ—¥æœŸæˆ³
          let lastMessageTimestamp =
            startIndex > 0 ? chat.history[startIndex - 1].timestamp : null;
          messagesToRender.forEach((msg) => {
            if (msg.isHidden) return;
            if (isNewDay(msg.timestamp, lastMessageTimestamp)) {
              const dateStampEl = createDateStampElement(msg.timestamp);
              messagesContainer.appendChild(dateStampEl);
            }
            // ä½¿ç”¨ true ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè¡¨ç¤ºè¿™æ˜¯åˆå§‹åŠ è½½ï¼Œä¸åº”æ’­æ”¾åŠ¨ç”»
            appendMessage(msg, chat, true);
            lastMessageTimestamp = msg.timestamp;
          });

          // 6. æ»šåŠ¨åˆ°ç›®æ ‡æ¶ˆæ¯å¹¶é«˜äº®å®ƒ
          //    ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å…ƒç´ å·²ç»å®Œå…¨æ¸²æŸ“åˆ°é¡µé¢ä¸Š
          setTimeout(() => {
            const targetMessage = messagesContainer.querySelector(
              `.message-bubble[data-timestamp="${timestamp}"]`,
            );
            if (targetMessage) {
              // ä½¿ç”¨ 'auto' æ»šåŠ¨ï¼Œæ¯” 'smooth' æ›´å¿«é€Ÿç›´æ¥
              targetMessage.scrollIntoView({
                behavior: "auto",
                block: "center",
              });

              // æ·»åŠ é—ªçƒé«˜äº®æ•ˆæœï¼Œè®©ç”¨æˆ·èƒ½æ³¨æ„åˆ°
              targetMessage.classList.add("flash");
              setTimeout(() => {
                targetMessage.classList.remove("flash");
              }, 1500);
            }
          }, 100);
        }

        async function openQZonePublisher(mode) {
          resetCreatePostModal();
          const modal = document.getElementById("create-post-modal");
          modal.dataset.mode = mode;
          document.getElementById("create-post-modal-title").textContent =
            "å‘å¸ƒåŠ¨æ€";

          if (mode === "shuoshuo") {
            modal.querySelector(".post-mode-switcher").style.display = "none";
            modal.querySelector("#image-mode-content").style.display = "none";
            modal.querySelector("#text-image-mode-content").style.display =
              "none";
            modal.querySelector("#post-public-text").placeholder =
              "åˆ†äº«æ–°é²œäº‹...";
          } else {
            modal.querySelector(".post-mode-switcher").style.display = "flex";
            modal.querySelector("#image-mode-content").classList.add("active");
            modal
              .querySelector("#text-image-mode-content")
              .classList.remove("active");
            modal.querySelector("#post-public-text").placeholder =
              "åˆ†äº«æ–°é²œäº‹...ï¼ˆéå¿…å¡«çš„å…¬å¼€æ–‡å­—ï¼‰";
          }

          document.getElementById("post-comments-toggle-group").style.display =
            "block";

          const visibilityGroup = document.getElementById(
            "post-visibility-group",
          );
          const groupsContainer = document.getElementById(
            "post-visibility-groups",
          );
          const visibilityRadios = document.querySelectorAll(
            'input[name="visibility"]',
          );

          visibilityGroup.style.display = "block";
          groupsContainer.innerHTML = ""; // æ¸…ç©ºæ—§çš„åˆ†ç»„åˆ—è¡¨

          // ä»æ•°æ®åº“è¯»å–ä½ çš„å¥½å‹åˆ†ç»„
          const groups = await db.qzoneGroups.toArray();
          if (groups.length > 0) {
            groups.forEach((group) => {
              const label = document.createElement("label");
              label.innerHTML = `<input type="checkbox" value="${group.id}"> ${group.name}`;
              groupsContainer.appendChild(label);
            });
          } else {
            groupsContainer.innerHTML =
              '<p style="color: #8a8a8a; font-size: 13px;">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•å¥½å‹åˆ†ç»„å“¦ã€‚</p>';
          }

          // é»˜è®¤é€‰ä¸­â€œæ‰€æœ‰äººå¯è§â€å¹¶éšè—åˆ†ç»„é€‰æ‹©
          visibilityRadios[0].checked = true;
          groupsContainer.style.display = "none";

          // ç›‘å¬å•é€‰æŒ‰é’®çš„å˜åŒ–
          visibilityRadios.forEach((radio) => {
            radio.onchange = function () {
              groupsContainer.style.display =
                this.value === "groups" ? "block" : "none";
            };
          });

          modal.classList.add("visible");
        }

        /**
         * ä¸€é”®æ¸…ç©ºæ‰€æœ‰å•äººèŠå¤©èƒŒæ™¯
         */
        async function clearAllSingleChatBackgrounds() {
          // å¼¹å‡ºç¡®è®¤æ¡†ï¼Œé˜²æ­¢è¯¯æ“ä½œ
          const confirmed = await showCustomConfirm(
            "ç¡®è®¤æ“ä½œ",
            "æ­¤æ“ä½œå°†ç§»é™¤æ‰€æœ‰è§’è‰²å•ç‹¬è®¾ç½®çš„èŠå¤©èƒŒæ™¯ï¼Œç»Ÿä¸€ä½¿ç”¨å…¨å±€èƒŒæ™¯ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ",
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            let updatedCount = 0;
            const chatsToUpdate = [];

            // éå†æ‰€æœ‰èŠå¤©
            for (const chatId in state.chats) {
              const chat = state.chats[chatId];
              // å¦‚æœè¿™ä¸ªèŠå¤©è®¾ç½®äº†å•äººèƒŒæ™¯
              if (chat.settings && chat.settings.background) {
                chat.settings.background = ""; // æ¸…ç©ºå®ƒ
                chatsToUpdate.push(chat);
                updatedCount++;
              }
            }

            // å¦‚æœæœ‰éœ€è¦æ›´æ–°çš„èŠå¤©ï¼Œå°±æ‰¹é‡å†™å…¥æ•°æ®åº“
            if (chatsToUpdate.length > 0) {
              await db.chats.bulkPut(chatsToUpdate);
            }

            await showCustomAlert(
              "æ“ä½œæˆåŠŸ",
              `å·²æˆåŠŸæ¸…ç©º ${updatedCount} ä¸ªè§’è‰²çš„å•äººèŠå¤©èƒŒæ™¯ï¼`,
            );
          }
        }

        /* ä¸»å±å¹•ç¾åŒ–é¢„è®¾æ ¸å¿ƒåŠŸèƒ½å‡½æ•° */

        let activeHomePresetId = null; // ç”¨äºè¿½è¸ªå½“å‰é€‰ä¸­çš„é¢„è®¾ID

        /**
         * å¯ç”¨æˆ–ç¦ç”¨é¢„è®¾ç®¡ç†æŒ‰é’®
         */
        function toggleHomePresetButtons(isEnabled) {
          document.getElementById("apply-home-preset-btn").disabled =
            !isEnabled;
          document.getElementById("update-home-preset-btn").disabled =
            !isEnabled; // <-- æ–°å¢è¿™ä¸€è¡Œ
          document.getElementById("rename-home-preset-btn").disabled =
            !isEnabled;
          document.getElementById("delete-home-preset-btn").disabled =
            !isEnabled;
          document.getElementById("export-home-preset-btn").disabled =
            !isEnabled;
        }

        /**
         * åŠ è½½é¢„è®¾åˆ°ä¸‹æ‹‰æ¡†
         */
        async function loadHomeScreenPresetsToDropdown() {
          const selector = document.getElementById("home-preset-selector");
          selector.innerHTML = '<option value="">-- è¯·é€‰æ‹©ä¸€ä¸ªé¢„è®¾ --</option>';
          const presets = await db.homeScreenPresets.toArray();
          presets.forEach((preset) => {
            const option = document.createElement("option");
            option.value = preset.id;
            option.textContent = preset.name;
            selector.appendChild(option);
          });
          activeHomePresetId = null; // é‡ç½®é€‰æ‹©
          toggleHomePresetButtons(false); // é»˜è®¤ç¦ç”¨æŒ‰é’®
        }

        /**
         * å½“ç”¨æˆ·ä»ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ—¶
         */
        function handleHomePresetSelection() {
          const selector = document.getElementById("home-preset-selector");
          activeHomePresetId = selector.value ? parseInt(selector.value) : null;
          // åªæœ‰å½“ç”¨æˆ·ç¡®å®é€‰æ‹©äº†ä¸€ä¸ªé¢„è®¾æ—¶ï¼Œæ‰å¯ç”¨ç›¸å…³æŒ‰é’®
          toggleHomePresetButtons(!!activeHomePresetId);
        }

        async function applySelectedHomeScreenPreset() {
          if (!activeHomePresetId) {
            alert("è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„é¢„è®¾ã€‚");
            return;
          }
          const preset = await db.homeScreenPresets.get(activeHomePresetId);
          if (preset && preset.data) {
            // å°†é¢„è®¾æ•°æ®åŠ è½½åˆ°å…¨å±€çŠ¶æ€
            state.globalSettings.widgetData = preset.data;

            if (preset.data.wallpaper) {
              state.globalSettings.wallpaper = preset.data.wallpaper;
            }
            if (preset.data.appIcons) {
              state.globalSettings.appIcons = { ...preset.data.appIcons };
            }

            // æ£€æŸ¥é¢„è®¾ä¸­æ˜¯å¦æœ‰appLabelsæ•°æ®ï¼Œå¦‚æœæœ‰ï¼Œå°±åŠ è½½å®ƒ
            if (preset.data.appLabels) {
              state.globalSettings.appLabels = { ...preset.data.appLabels };
            } else {
              // å¦‚æœè¿™ä¸ªæ—§çš„é¢„è®¾é‡Œæ²¡æœ‰ä¿å­˜Appåå­—ï¼Œå°±æ¸…ç©ºå½“å‰çš„è‡ªå®šä¹‰åå­—ï¼Œä»¥æ¢å¤é»˜è®¤
              state.globalSettings.appLabels = {};
            }

            // ä¿å­˜æ‰€æœ‰æ›´æ–°åˆ°æ•°æ®åº“
            await db.globalSettings.put(state.globalSettings);

            // ä¾æ¬¡åº”ç”¨æ‰€æœ‰è®¾ç½® (ç°åœ¨ applyAppLabels() å°±èƒ½è·å–åˆ°æ­£ç¡®çš„åç§°äº†)
            applyGlobalWallpaper();
            applyAppIcons();
            applyAppLabels();
            applyWidgetData();

            alert(`å·²æˆåŠŸåº”ç”¨é¢„è®¾: "${preset.name}"ï¼`);
            showScreen("home-screen");
          }
        }

        /**
         * æ¸²æŸ“ä¸»å±å¹•ä¸ªäººèµ„æ–™å¡çš„å¤´åƒæ¡†
         */
        function renderHomeScreenProfileFrame() {
          // 1. è·å–ä¿å­˜çš„å¤´åƒæ¡†URL
          const frameUrl = state.globalSettings.homeAvatarFrame || "";
          // 2. æ‰¾åˆ°å¤´åƒæ¡†çš„imgå…ƒç´ 
          const frameImg = document.getElementById("profile-avatar-frame");
          if (frameImg) {
            // 3. å¦‚æœURLå­˜åœ¨ï¼Œå°±æ˜¾ç¤ºå®ƒ
            if (frameUrl) {
              frameImg.src = frameUrl;
              frameImg.style.display = "block";
            } else {
              // 4. å¦‚æœURLä¸ºç©ºï¼ˆå³é€‰æ‹©äº†â€œæ— â€ï¼‰ï¼Œå°±éšè—å®ƒ
              frameImg.src = "";
              frameImg.style.display = "none";
            }
          }
        }

        /**
         * ä¿å­˜å½“å‰çš„ä¸»å±å¹•è®¾ç½®ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
         */
        async function saveCurrentHomeScreenAsPreset() {
          saveAppLabels();
          const presetName = await showCustomPrompt(
            "ä¿å­˜é¢„è®¾",
            "è¯·ä¸ºè¿™ä¸ªä¸»å±å¹•ç¾åŒ–æ–¹æ¡ˆèµ·ä¸ªåå­—ï¼š",
          );
          if (!presetName || !presetName.trim()) {
            if (presetName !== null) alert("åå­—ä¸èƒ½ä¸ºç©ºï¼");
            return;
          }

          // æ ¸å¿ƒï¼šæ„å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰ä¸»å±å¹•å…ƒç´ çš„å®Œæ•´æ•°æ®å¯¹è±¡
          const presetData = {
            // --- ä¸ªäººèµ„æ–™å¡ç‰‡ ---
            "profile-banner-img":
              document.getElementById("profile-banner-img").src,
            "profile-avatar-img":
              document.getElementById("profile-avatar-img").src,
            homeAvatarFrame: document.getElementById("profile-avatar-frame")
              .src, // â˜…â˜…â˜… æ–°å¢ï¼šä¿å­˜å¤´åƒæ¡† â˜…â˜…â˜…
            "profile-username":
              document.getElementById("profile-username").textContent,
            "profile-sub-username": document.getElementById(
              "profile-sub-username",
            ).textContent,
            "profile-bio": document.getElementById("profile-bio").textContent,
            "profile-location":
              document.getElementById("profile-location").innerHTML,

            // --- ç¬¬ä¸€é¡µå°ç»„ä»¶ ---
            "widget-bubble-1":
              document.getElementById("widget-bubble-1").textContent,
            "widget-image-1": document.getElementById("widget-image-1").src,
            "widget-subtext-1":
              document.getElementById("widget-subtext-1").textContent,
            "widget-bubble-2":
              document.getElementById("widget-bubble-2").textContent,
            "widget-image-2": document.getElementById("widget-image-2").src,
            "widget-subtext-2":
              document.getElementById("widget-subtext-2").textContent,

            // --- ç¬¬äºŒé¡µå°ç»„ä»¶ ---
            "widget-image-3": document.getElementById("widget-image-3").src,
            "second-page-bubble":
              document.getElementById("second-page-bubble").textContent,
            "flat-capsule-bubble": document.getElementById(
              "flat-capsule-bubble",
            ).textContent,
            "circular-bubble":
              document.getElementById("circular-bubble").textContent,
            "new-widget-avatar":
              document.getElementById("new-widget-avatar").src,
            "new-widget-text-1":
              document.getElementById("new-widget-text-1").textContent,
            "new-widget-text-2":
              document.getElementById("new-widget-text-2").textContent,
            "new-widget-text-3":
              document.getElementById("new-widget-text-3").textContent,
            "widget-month-display": document.getElementById(
              "widget-month-display",
            ).textContent,
            "music-rect-img": document.getElementById("music-rect-img").src,
            "music-record-img": document.getElementById("music-record-img").src,
            "music-text-line":
              document.getElementById("music-text-line").textContent,

            // --- Appå›¾æ ‡å’Œå£çº¸ ---
            appIcons: { ...state.globalSettings.appIcons },
            appLabels: { ...state.globalSettings.appLabels },
            wallpaper: state.globalSettings.wallpaper,
          };

          // ä¿å­˜åˆ°æ•°æ®åº“
          await db.homeScreenPresets.add({
            name: presetName.trim(),
            data: presetData,
          });
          await loadHomeScreenPresetsToDropdown(); // åˆ·æ–°ä¸‹æ‹‰åˆ—è¡¨
          alert(`é¢„è®¾ "${presetName.trim()}" å·²ä¿å­˜ï¼`);
        }

        async function updateSelectedHomeScreenPreset() {
          saveAppLabels();
          if (!activeHomePresetId) {
            alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦æ›´æ–°çš„é¢„è®¾ã€‚");
            return;
          }

          const currentPreset =
            await db.homeScreenPresets.get(activeHomePresetId);
          if (!currentPreset) return;

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤æ›´æ–°",
            `ç¡®å®šè¦ç”¨å½“å‰çš„ä¸»å±å¹•å¸ƒå±€è¦†ç›–é¢„è®¾ "${currentPreset.name}" å—ï¼Ÿ`,
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            // æ„å»ºä¸ä¿å­˜æ—¶å®Œå…¨ç›¸åŒçš„å®Œæ•´æ•°æ®å¯¹è±¡
            const presetData = {
              "profile-banner-img":
                document.getElementById("profile-banner-img").src,
              "profile-avatar-img":
                document.getElementById("profile-avatar-img").src,
              homeAvatarFrame: document.getElementById("profile-avatar-frame")
                .src,
              "profile-username":
                document.getElementById("profile-username").textContent,
              "profile-sub-username": document.getElementById(
                "profile-sub-username",
              ).textContent,
              "profile-bio": document.getElementById("profile-bio").textContent,
              "profile-location":
                document.getElementById("profile-location").innerHTML,
              "widget-bubble-1":
                document.getElementById("widget-bubble-1").textContent,
              "widget-image-1": document.getElementById("widget-image-1").src,
              "widget-subtext-1":
                document.getElementById("widget-subtext-1").textContent,
              "widget-bubble-2":
                document.getElementById("widget-bubble-2").textContent,
              "widget-image-2": document.getElementById("widget-image-2").src,
              "widget-subtext-2":
                document.getElementById("widget-subtext-2").textContent,
              "widget-image-3": document.getElementById("widget-image-3").src,
              "second-page-bubble":
                document.getElementById("second-page-bubble").textContent,
              "flat-capsule-bubble": document.getElementById(
                "flat-capsule-bubble",
              ).textContent,
              "circular-bubble":
                document.getElementById("circular-bubble").textContent,
              "new-widget-avatar":
                document.getElementById("new-widget-avatar").src,
              "new-widget-text-1":
                document.getElementById("new-widget-text-1").textContent,
              "new-widget-text-2":
                document.getElementById("new-widget-text-2").textContent,
              "new-widget-text-3":
                document.getElementById("new-widget-text-3").textContent,
              "widget-month-display": document.getElementById(
                "widget-month-display",
              ).textContent,
              "music-rect-img": document.getElementById("music-rect-img").src,
              "music-record-img":
                document.getElementById("music-record-img").src,
              "music-text-line":
                document.getElementById("music-text-line").textContent,
              appIcons: { ...state.globalSettings.appIcons },
              appLabels: { ...state.globalSettings.appLabels },
              wallpaper: state.globalSettings.wallpaper,
            };

            await db.homeScreenPresets.update(activeHomePresetId, {
              data: presetData,
            });
            await showCustomAlert(
              "æˆåŠŸ",
              `é¢„è®¾ "${currentPreset.name}" å·²æ›´æ–°ï¼`,
            );
          }
        }

        /**
         * é‡å‘½åé€‰ä¸­çš„é¢„è®¾
         */
        async function renameSelectedHomeScreenPreset() {
          if (!activeHomePresetId) return;
          const currentPreset =
            await db.homeScreenPresets.get(activeHomePresetId);
          const newName = await showCustomPrompt(
            "é‡å‘½å",
            "è¯·è¾“å…¥æ–°çš„åç§°ï¼š",
            currentPreset.name,
          );
          if (newName && newName.trim()) {
            await db.homeScreenPresets.update(activeHomePresetId, {
              name: newName.trim(),
            });
            await loadHomeScreenPresetsToDropdown();
            document.getElementById("home-preset-selector").value =
              activeHomePresetId;
            alert("é‡å‘½åæˆåŠŸï¼");
          }
        }

        /**
         * åˆ é™¤é€‰ä¸­çš„é¢„è®¾
         */
        async function deleteSelectedHomeScreenPreset() {
          if (!activeHomePresetId) return;
          const currentPreset =
            await db.homeScreenPresets.get(activeHomePresetId);
          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            `ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${currentPreset.name}" å—ï¼Ÿ`,
            {
              confirmButtonClass: "btn-danger",
            },
          );
          if (confirmed) {
            await db.homeScreenPresets.delete(activeHomePresetId);
            await loadHomeScreenPresetsToDropdown(); // è¿™ä¼šè‡ªåŠ¨é‡ç½®é€‰æ‹©å¹¶ç¦ç”¨æŒ‰é’®
            alert("é¢„è®¾å·²åˆ é™¤ã€‚");
          }
        }

        /**
         * å¯¼å‡ºé€‰ä¸­çš„é¢„è®¾
         */
        async function exportHomeScreenPreset() {
          if (!activeHomePresetId) return;
          const preset = await db.homeScreenPresets.get(activeHomePresetId);
          const blob = new Blob([JSON.stringify(preset, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${preset.name}-HomeScreen.json`;
          a.click();
          URL.revokeObjectURL(url);
        }

        /**
         * å¯¼å…¥é¢„è®¾æ–‡ä»¶
         */
        function importHomeScreenPreset(file) {
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const data = JSON.parse(e.target.result);
              // ç®€å•éªŒè¯ä¸€ä¸‹æ–‡ä»¶å†…å®¹æ˜¯ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„æ ¼å¼
              if (data.name && data.data) {
                await db.homeScreenPresets.add({
                  name: `${data.name} (å¯¼å…¥)`,
                  data: data.data,
                });
                await loadHomeScreenPresetsToDropdown();
                alert(`é¢„è®¾ "${data.name}" å¯¼å…¥æˆåŠŸï¼`);
              } else {
                alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚");
              }
            } catch (error) {
              alert(`å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯ã€‚${error.message}`);
            }
          };
          reader.readAsText(file);
        }

        /**
         * è§’è‰²è¡¨æƒ…åŒ…ç®¡ç†æ ¸å¿ƒåŠŸèƒ½
         */
        async function openCharStickerManager() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          // æ ¹æ®èŠå¤©ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ‡é¢˜
          if (chat.isGroup) {
            document.getElementById("sticker-manager-title").textContent =
              `â€œ${chat.name}â€çš„ç¾¤è¡¨æƒ…`;
          } else {
            document.getElementById("sticker-manager-title").textContent =
              `â€œ${chat.name}â€çš„è¡¨æƒ…åŒ…`;
          }

          // é»˜è®¤æ˜¾ç¤ºä¸“å±è¡¨æƒ…
          document.getElementById("sticker-tab-exclusive").click();

          await renderCharStickers("exclusive");
          await renderCharStickers("common");

          showScreen("char-sticker-manager-screen");
        }

        async function renderCharStickers(type) {
          const isExclusive = type === "exclusive";
          const gridId = isExclusive
            ? "exclusive-sticker-grid"
            : "common-sticker-grid";
          const grid = document.getElementById(gridId);
          grid.innerHTML = "";

          let stickers = [];
          if (isExclusive) {
            const chat = state.chats[state.activeChatId];
            stickers = chat.settings.stickerLibrary || [];
          } else {
            state.charStickers = await db.charStickers.toArray();
            stickers = state.charStickers || [];
          }

          if (stickers.length === 0) {
            grid.innerHTML = `<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">è¿™é‡Œè¿˜æ˜¯ç©ºçš„å“¦~</p>`;
            return;
          }

          // ä¸ºäº†æ­£ç¡®åˆ é™¤ï¼Œæˆ‘ä»¬éœ€è¦åŸå§‹ç´¢å¼•
          const stickersWithIndex = stickers.map((sticker, index) => ({
            ...sticker,
            originalIndex: index,
          }));

          stickersWithIndex.forEach((sticker) => {
            const item = document.createElement("div");
            item.className = "sticker-item";
            item.style.backgroundImage = `url(${sticker.url})`;
            item.title = sticker.name;

            // æˆ‘ä»¬ä½¿ç”¨ URL ä½œä¸ºå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå› ä¸ºå®ƒåœ¨ä¸¤ç§åº“ä¸­éƒ½æ˜¯å”¯ä¸€çš„
            const uniqueId = sticker.url;

            if (isCharStickerSelectionMode) {
              // ã€é€‰æ‹©æ¨¡å¼ã€‘ä¸‹çš„é€»è¾‘
              item.classList.add("in-selection-mode");
              if (selectedCharStickers.has(uniqueId)) {
                item.classList.add("selected");
              }

              item.addEventListener("click", () => {
                item.classList.toggle("selected");
                if (selectedCharStickers.has(uniqueId)) {
                  selectedCharStickers.delete(uniqueId);
                } else {
                  selectedCharStickers.add(uniqueId);
                }
                const deleteBtn = document.getElementById(
                  "delete-selected-char-stickers-btn",
                );
                deleteBtn.textContent = `åˆ é™¤å·²é€‰ (${selectedCharStickers.size})`;
                deleteBtn.disabled = selectedCharStickers.size === 0;
              });
            } else {
              // ã€æ­£å¸¸æ¨¡å¼ã€‘ä¸‹çš„é€»è¾‘ï¼ˆåªæœ‰åˆ é™¤æŒ‰é’®ï¼‰
              const deleteBtn = document.createElement("div");
              deleteBtn.className = "delete-btn";
              deleteBtn.innerHTML = "Ã—";
              deleteBtn.style.display = "block"; // é»˜è®¤å°±æ˜¾ç¤º
              deleteBtn.onclick = async (e) => {
                e.stopPropagation();
                const confirmed = await showCustomConfirm(
                  "åˆ é™¤è¡¨æƒ…",
                  `ç¡®å®šè¦åˆ é™¤è¡¨æƒ… "${sticker.name}" å—ï¼Ÿ`,
                  {
                    confirmButtonClass: "btn-danger",
                  },
                );
                if (confirmed) {
                  if (isExclusive) {
                    const chat = state.chats[state.activeChatId];
                    chat.settings.stickerLibrary.splice(
                      sticker.originalIndex,
                      1,
                    );
                    await db.chats.put(chat);
                  } else {
                    await db.charStickers.delete(sticker.id);
                  }
                  await renderCharStickers(type); // åˆ·æ–°
                }
              };
              item.appendChild(deleteBtn);
            }
            grid.appendChild(item);
          });
        }

        /**
         * å¤„ç†æ‰¹é‡åˆ é™¤é€‰ä¸­çš„è§’è‰²è¡¨æƒ…
         */
        async function handleBulkDeleteCharStickers() {
          if (selectedCharStickers.size === 0) return;

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCharStickers.size} ä¸ªè¡¨æƒ…å—ï¼Ÿ`,
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            const activeTab = document.querySelector(
              "#char-sticker-manager-screen .frame-tab.active",
            );
            const type =
              activeTab.id === "sticker-tab-exclusive" ? "exclusive" : "common";

            if (type === "exclusive") {
              const chat = state.chats[state.activeChatId];
              chat.settings.stickerLibrary =
                chat.settings.stickerLibrary.filter(
                  (s) => !selectedCharStickers.has(s.url),
                );
              await db.chats.put(chat);
            } else {
              // common
              const stickersToDelete = await db.charStickers
                .where("url")
                .anyOf(Array.from(selectedCharStickers))
                .toArray();
              const idsToDelete = stickersToDelete.map((s) => s.id);
              if (idsToDelete.length > 0) {
                await db.charStickers.bulkDelete(idsToDelete);
              }
            }

            // é€€å‡ºç¼–è¾‘æ¨¡å¼
            toggleCharStickerSelectionMode();

            alert("é€‰ä¸­çš„è¡¨æƒ…å·²åˆ é™¤ã€‚");
          }
        }

        /**
         * æ‰¹é‡æ·»åŠ è¡¨æƒ…åŒ…åˆ°æŒ‡å®šåº“
         */
        async function bulkAddCharStickers(type) {
          const textInput = await showCustomPrompt(
            `æ‰¹é‡æ·»åŠ ${type === "exclusive" ? "ä¸“å±" : "é€šç”¨"}è¡¨æƒ…`,
            "ä¸€è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼š\nçŒ«çŒ«å–æ°´ https://..../cat.gif",
            "",
            "textarea",
          );
          if (!textInput || !textInput.trim()) return;

          const lines = textInput.trim().split("\n");
          const newStickers = [];
          let successCount = 0;

          lines.forEach((line, index) => {
            line = line.trim();
            if (!line) return;

            let name = "";
            let url = "";
            let splitIndex = -1;
            const httpIndex = line.indexOf("http");
            const dataIndex = line.indexOf("data:image");
            if (httpIndex > -1) {
              splitIndex = httpIndex;
            } else if (dataIndex > -1) {
              splitIndex = dataIndex;
            }

            if (splitIndex > 0) {
              name = line.substring(0, splitIndex).trim();
              url = line.substring(splitIndex).trim();
              if (name.endsWith(":") || name.endsWith("ï¼š")) {
                name = name.slice(0, -1).trim();
              }
            }

            if (
              name &&
              (url.startsWith("http") || url.startsWith("data:image"))
            ) {
              const stickerData = { url, name };
              if (type !== "exclusive") {
                stickerData.id = "char_sticker_" + (Date.now() + index);
              }
              newStickers.push(stickerData);
              successCount++;
            }
          });

          if (newStickers.length > 0) {
            if (type === "exclusive") {
              const chat = state.chats[state.activeChatId];
              chat.settings.stickerLibrary.push(...newStickers);
              await db.chats.put(chat);
            } else {
              await db.charStickers.bulkAdd(newStickers);
            }
            await renderCharStickers(type); // åœ¨æ•°æ®åº“æ“ä½œåï¼Œç»Ÿä¸€é‡æ–°æ¸²æŸ“
          }
          await showCustomAlert(
            "å¯¼å…¥æŠ¥å‘Š",
            `æˆåŠŸå¯¼å…¥ï¼š${successCount} ä¸ªè¡¨æƒ…ã€‚`,
          );
        }

        /**
         * ä»æœ¬åœ°ä¸Šä¼ è¡¨æƒ…åˆ°æŒ‡å®šåº“
         */
        async function uploadCharStickersLocal(type) {
          const input = document.getElementById("char-sticker-upload-input"); // åº”è¯¥é•¿è¿™æ ·
          input.onchange = async (event) => {
            const files = event.target.files;
            if (!files.length) return;

            const stickersToAdd = []; // å…ˆæ”¶é›†æ‰€æœ‰è¦æ·»åŠ çš„è¡¨æƒ…

            for (const file of files) {
              const name = await showCustomPrompt(
                "ä¸ºè¡¨æƒ…å‘½å",
                "è¯·è¾“å…¥è¡¨æƒ…åç§°",
                file.name.replace(/\.[^/.]+$/, ""),
              );
              if (name && name.trim()) {
                const base64Url = await new Promise((resolve) => {
                  const reader = new FileReader();
                  reader.onload = (e) => resolve(e.target.result);
                  reader.readAsDataURL(file);
                });

                const stickerData = { name: name.trim(), url: base64Url };
                if (type !== "exclusive") {
                  stickerData.id = "char_sticker_" + Date.now() + Math.random();
                }
                stickersToAdd.push(stickerData);
              }
            }

            if (stickersToAdd.length > 0) {
              if (type === "exclusive") {
                const chat = state.chats[state.activeChatId];
                chat.settings.stickerLibrary.push(...stickersToAdd);
                await db.chats.put(chat);
              } else {
                await db.charStickers.bulkAdd(stickersToAdd);
              }
              await renderCharStickers(type); // åœ¨æ•°æ®åº“æ“ä½œåï¼Œç»Ÿä¸€é‡æ–°æ¸²æŸ“
              alert(`å·²æˆåŠŸä¸Šä¼  ${stickersToAdd.length} ä¸ªè¡¨æƒ…ï¼`);
            }

            event.target.value = null;
          };
          input.click();
        }

        /**
         * æ˜¾ç¤ºæŒ‡å®šçš„è§’è‰²è¡¨æƒ…åŒ…æ ‡ç­¾é¡µ
         * è¿™æ˜¯ä¹‹å‰ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç”¨äºæ§åˆ¶æ˜¾ç¤ºå“ªä¸ªæ ‡ç­¾é¡µï¼ˆä¸“å±æˆ–é€šç”¨ï¼‰ã€‚
         * @param {'exclusive' | 'common'} type - è¦æ˜¾ç¤ºçš„æ ‡ç­¾é¡µç±»å‹
         */
        function showCharStickerTab(type) {
          // 1. åˆ‡æ¢æ ‡ç­¾æŒ‰é’®çš„ 'active' çŠ¶æ€
          document.querySelectorAll(".char-sticker-tab-btn").forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.type === type);
          });

          // 2. åˆ‡æ¢å†…å®¹åŒºåŸŸçš„æ˜¾ç¤º
          document
            .querySelectorAll(".sticker-tab-content")
            .forEach((content) => {
              content.classList.toggle(
                "active",
                content.id === `${type}-sticker-content`,
              );
            });

          // 3. æ¸²æŸ“å¯¹åº”æ ‡ç­¾é¡µçš„è¡¨æƒ…
          // (è¿™ä¸€æ­¥ç¡®ä¿æ¯æ¬¡åˆ‡æ¢æ ‡ç­¾æ—¶ï¼Œè¡¨æƒ…éƒ½ä¼šåˆ·æ–°)
          renderCharStickers(type);
        }

        /**
         * å¡”ç½—ç‰Œå åœåŠŸèƒ½æ ¸å¿ƒ
         */
        let activeTarotReading = null; // ç”¨äºæš‚å­˜å½“å‰å åœçš„ç»“æœ

        // ç‰Œé˜µä¿¡æ¯
        const TAROT_SPREADS = {
          single: {
            name: "å•å¼ ç‰Œ - å¿«é€ŸæŒ‡å¼•",
            count: 1,
            positions: ["æ ¸å¿ƒæŒ‡å¼•"],
          },
          three_past_present_future: {
            name: "ä¸‰å¼ ç‰Œ - è¿‡å»/ç°åœ¨/æœªæ¥",
            count: 3,
            positions: ["è¿‡å»", "ç°åœ¨", "æœªæ¥"],
          },
          three_situation_challenge_advice: {
            name: "ä¸‰å¼ ç‰Œ - æƒ…å¢ƒ/æŒ‘æˆ˜/å»ºè®®",
            count: 3,
            positions: ["æƒ…å¢ƒ", "æŒ‘æˆ˜", "å»ºè®®"],
          },
          celtic_cross: {
            name: "å‡¯å°”ç‰¹åå­— - æ·±åº¦åˆ†æ",
            count: 10,
            positions: [
              "ç°çŠ¶",
              "æŒ‘æˆ˜",
              "æ ¹åŸº",
              "è¿‡å»",
              "ç›®æ ‡",
              "æœªæ¥",
              "è‡ªæˆ‘è®¤çŸ¥",
              "å¤–éƒ¨å½±å“",
              "å¸Œæœ›ä¸ææƒ§",
              "æœ€ç»ˆç»“æœ",
            ],
          },
        };

        // æ‰“å¼€å¡”ç½—ç‰Œå åœä¸»æ¨¡æ€æ¡†
        function openTarotModal() {
          document
            .getElementById("tarot-divination-modal")
            .classList.add("visible");
          // é»˜è®¤æ˜¾ç¤ºè®¾ç½®ç•Œé¢
          document.getElementById("tarot-setup-view").style.display = "block";
          document.getElementById("tarot-result-view").style.display = "none";
          document.getElementById("tarot-history-view").style.display = "none";
          // æ¸…ç©ºè¾“å…¥æ¡†
          document.getElementById("tarot-question-input").value = "";
        }

        // æ‰§è¡ŒæŠ½ç‰Œé€»è¾‘
        function handleDrawCards() {
          const question = document
            .getElementById("tarot-question-input")
            .value.trim();
          const spreadType = document.getElementById(
            "tarot-spread-select",
          ).value;
          const orientation = document.querySelector(
            'input[name="tarot-orientation"]:checked',
          ).value;

          if (!question) {
            alert("è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–å…³æ³¨ç‚¹ã€‚");
            return;
          }

          const spreadInfo = TAROT_SPREADS[spreadType];
          const deck = [...TAROT_DECK];

          // æ´—ç‰Œ
          for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
          }

          // æŠ½ç‰Œ
          const drawnCardsRaw = deck.slice(0, spreadInfo.count);
          const drawnCards = drawnCardsRaw.map((card, index) => {
            const isReversed =
              orientation === "reversed" && Math.random() < 0.5;
            return {
              ...card,
              isReversed: isReversed,
              position: spreadInfo.positions[index],
            };
          });

          activeTarotReading = {
            question: question,
            spread: spreadInfo,
            cards: drawnCards,
            timestamp: Date.now(),
          };

          displayTarotResults(activeTarotReading);
        }

        // æ˜¾ç¤ºå åœç»“æœ (çº¯æ–‡å­—ç‰ˆ)
        function displayTarotResults(reading) {
          const displayEl = document.getElementById("tarot-result-display");
          displayEl.innerHTML = ""; // æ¸…ç©º

          // æ˜¾ç¤ºé—®é¢˜
          const questionEl = document.createElement("div");
          questionEl.className = "tarot-result-question";
          questionEl.textContent = `æ‚¨çš„é—®é¢˜æ˜¯ï¼šâ€œ${reading.question}â€`;
          displayEl.appendChild(questionEl);

          const container = document.createElement("div");
          container.className = "tarot-spread-container";

          reading.cards.forEach((card) => {
            const cardWrapper = document.createElement("div");
            cardWrapper.className = "tarot-card-wrapper";

            cardWrapper.innerHTML = `
			            <div class="tarot-card-position">[${card.position}]</div>
			            <div class="tarot-card-name">${card.name} ${card.isReversed ? "(é€†ä½)" : "(æ­£ä½)"}</div>
			        `;
            container.appendChild(cardWrapper);
          });

          displayEl.appendChild(container);

          // åˆ‡æ¢è§†å›¾
          document.getElementById("tarot-setup-view").style.display = "none";
          document.getElementById("tarot-result-view").style.display = "flex";
        }

        async function sendTarotReadingToChat() {
          if (!activeTarotReading || !state.activeChatId) return;

          const chat = state.chats[state.activeChatId];
          const { proxyUrl, apiKey, model } = state.apiConfig;

          if (!proxyUrl || !apiKey || !model) {
            alert("è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½æ‰èƒ½è§¦å‘AIè§£è¯»å“¦ï¼");
            return;
          }

          // 1. å…³é—­å¼¹çª—ï¼Œå¹¶æ˜¾ç¤ºâ€œæ­£åœ¨è§£è¯»â€çš„æç¤º
          document
            .getElementById("tarot-divination-modal")
            .classList.remove("visible");
          await showCustomAlert(
            "è¯·ç¨å€™...",
            "å¡”ç½—å¸ˆæ­£åœ¨ä¸ºä½ è¿æ¥æ˜Ÿè¾°ï¼Œè§£è¯»ç‰Œé¢...",
          );

          try {
            const reading = activeTarotReading;

            // 2. ç»™â€œå¡”ç½—å¸ˆAIâ€ä¸€ä¸ªæ›´ä¸“ä¸šã€æ›´ç»“æ„åŒ–çš„æŒ‡ä»¤ (Prompt)
            const cardDetails = reading.cards
              .map((card) => {
                const orientation = card.isReversed ? "é€†ä½" : "æ­£ä½";
                const meaning = card.isReversed ? card.reversed : card.upright;
                return `- ${card.position}: ${card.name} (${orientation})ï¼Œè±¡å¾: ${meaning}`;
              })
              .join("\n");

            const tarotMasterPrompt = `
			# è§’è‰²
			ä½ æ˜¯ä¸€ä½ä¸–ç•Œçº§çš„å¡”ç½—ç‰Œè§£è¯»å¤§å¸ˆï¼Œä»¥æ·±åˆ»çš„æ´å¯ŸåŠ›ã€æ¸…æ™°çš„è¡¨è¾¾å’Œå¯Œæœ‰åŒæƒ…å¿ƒçš„æŒ‡å¼•è€Œé—»åã€‚

			# æ ¸å¿ƒä»»åŠ¡
			ä¸ºç”¨æˆ·æä¾›ä¸€æ¬¡å…¨é¢ã€ç»“æ„åŒ–ä¸”æ˜“äºç†è§£çš„å¡”ç½—ç‰Œè§£è¯»ã€‚ä½ çš„è§£è¯»å¿…é¡»ä¸¥æ ¼éµå¾ªä¸‹é¢çš„è¾“å‡ºç»“æ„ã€‚

			# è¾“å‡ºç»“æ„ (å¿…é¡»ä¸¥æ ¼éµå®ˆ)
			ä½ çš„å›ç­”å¿…é¡»åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå¹¶ä½¿ç”¨MarkdownåŠ ç²—æ ‡é¢˜æ¥åˆ†éš”ï¼š

			1.  **âœ¨ ç»¼åˆè§£è¯» (Overall Interpretation):**
			    é¦–å…ˆï¼Œæ ¹æ®æ‰€æœ‰ç‰Œé¢çš„æ•´ä½“æ„Ÿè§‰ï¼Œç»™å‡ºä¸€ä¸ªé«˜åº¦æ¦‚æ‹¬çš„ã€1-2å¥è¯çš„æ ¸å¿ƒç»“è®ºæˆ–æ°›å›´æè¿°ã€‚

			2.  **ğŸƒ ç‰Œé¢è¯¦è§£ (Card Details):**
			    ç„¶åï¼Œé€ä¸€åˆ†ææ¯ä¸€å¼ ç‰Œã€‚å¯¹äºæ¯ä¸€å¼ ç‰Œï¼Œä½ å¿…é¡»ï¼š
			    -   ä½¿ç”¨æ ¼å¼ \`**[ç‰Œä½åç§°] - [ç‰Œå] ([æ­£ä½/é€†ä½])**\` ä½œä¸ºå°æ ‡é¢˜ã€‚
			    -   è¯¦ç»†è§£é‡Šè¿™å¼ ç‰Œåœ¨è¿™ä¸ªç‰¹å®šç‰Œä½ä¸Šï¼Œæ˜¯å¦‚ä½•å›åº”ç”¨æˆ·çš„é—®é¢˜çš„ã€‚
			    -   å°†ç‰Œçš„è±¡å¾æ„ä¹‰ä¸ç”¨æˆ·çš„å…·ä½“æƒ…å¢ƒï¼ˆé—®é¢˜ï¼‰ç´§å¯†ç»“åˆèµ·æ¥è¿›è¡Œåˆ†æã€‚

			3.  **ğŸ’¡ æ ¸å¿ƒå»ºè®® (Key Advice):**
			    æœ€åï¼Œç»¼åˆæ‰€æœ‰ç‰Œçš„ä¿¡æ¯ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªæ˜ç¡®ã€å…·ä½“ã€å¯æ“ä½œçš„è¡ŒåŠ¨å»ºè®®æˆ–å¿ƒæ€æŒ‡å¼•ã€‚

			# æŒ‡å¯¼åŸåˆ™
			- **æ•…äº‹æ€§**: å°†æ‰€æœ‰ç‰Œçš„å«ä¹‰ç¼–ç»‡æˆä¸€ä¸ªè¿è´¯çš„å™äº‹ï¼Œè€Œä¸æ˜¯ç®€å•åœ°ç½—åˆ—å…³é”®è¯ã€‚
			- **ç›¸å…³æ€§**: å§‹ç»ˆå°†è§£è¯»ç›´æ¥ä¸ç”¨æˆ·æå‡ºçš„å…·ä½“é—®é¢˜è”ç³»èµ·æ¥ã€‚
			- **æ¸…æ™°æ˜“æ‡‚**: é¿å…ä½¿ç”¨è¿‡äºç¥ç§˜æˆ–ä¸“ä¸šçš„æœ¯è¯­ã€‚ç”¨å¹³å®çš„è¯­è¨€è§£é‡Šå¤æ‚çš„æ¦‚å¿µã€‚
			- **æ·±åº¦è€Œéç½—åˆ—**: ç»å¯¹ä¸è¦åªæ˜¯é‡å¤æˆ‘æä¾›ç»™ä½ çš„â€œè±¡å¾â€å…³é”®è¯ã€‚ä½ å¿…é¡»åœ¨è¿™äº›å…³é”®è¯çš„åŸºç¡€ä¸Šè¿›è¡Œç»¼åˆã€æç‚¼å’Œæ·±åŒ–ï¼Œç»™å‡ºä½ ä½œä¸ºå¤§å¸ˆçš„ç‹¬ç‰¹è§è§£ã€‚

			# å åœä¿¡æ¯
			- **ç”¨æˆ·çš„é—®é¢˜**: "${reading.question}"
			- **ä½¿ç”¨çš„ç‰Œé˜µ**: ${reading.spread.name}
			- **æŠ½åˆ°çš„ç‰ŒåŠåŸºç¡€å«ä¹‰**:
			${cardDetails}

			# æœ€ç»ˆæŒ‡ä»¤
			ä½ çš„æœ€ç»ˆè¾“å‡ºã€åªèƒ½æ˜¯ã€‘å®Œæ•´çš„ã€æ ¼å¼åŒ–åçš„è§£è¯»æ–‡æœ¬ã€‚ä¸è¦æ·»åŠ ä»»ä½•â€œå¥½çš„ï¼Œè¿™æ˜¯ä½ çš„è§£è¯»ï¼šâ€ä¹‹ç±»çš„å¯¹è¯æ€§å¼€åœºç™½ã€‚
			`;

            // 3. å‘èµ·APIè°ƒç”¨ï¼Œè®©AIæ‰®æ¼”å¡”ç½—å¸ˆ
            let isGemini = proxyUrl === GEMINI_API_URL;
            let messagesForApi = [{ role: "user", content: tarotMasterPrompt }];
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              tarotMasterPrompt,
              messagesForApi,
              isGemini,
            );

            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  }),
                });

            if (!response.ok) {
              throw new Error(`APIè¯·æ±‚å¤±è´¥: ${await response.text()}`);
            }

            const data = await response.json();
            const interpretation = (
              isGemini
                ? data.candidates[0].content.parts[0].text
                : data.choices[0].message.content
            ).trim();

            // 4. åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„â€œç³»ç»Ÿè§£è¯»â€æ¶ˆæ¯
            const systemMessageVisible = {
              role: "system",
              type: "pat_message", // å¤ç”¨å±…ä¸­ç°è‰²æ°”æ³¡æ ·å¼
              content: `ğŸ”® **å¡”ç½—ç‰Œè§£è¯»** ğŸ”®\n\n**æ‚¨çš„é—®é¢˜**ï¼šâ€œ${reading.question}â€\n\n${interpretation}`,
              timestamp: Date.now(),
            };
            chat.history.push(systemMessageVisible);
            appendMessage(systemMessageVisible, chat);

            // 5. åˆ›å»ºç»™è§’è‰²Charçœ‹çš„éšè—æŒ‡ä»¤
            const hiddenInstruction = {
              role: "system",
              content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šåˆšåˆšç³»ç»Ÿä¸ºç”¨æˆ·è¿›è¡Œäº†ä¸€æ¬¡å¡”ç½—ç‰Œå åœï¼Œè§£è¯»ç»“æœæ˜¯ï¼šâ€œ${interpretation}â€ã€‚ç°åœ¨ï¼Œè¯·ä½ ä»¥è§’è‰²çš„èº«ä»½ï¼Œå’Œç”¨æˆ·ä¸€èµ·è®¨è®ºè¿™ä¸ªç»“æœã€‚]`,
              timestamp: Date.now() + 1, // ç¡®ä¿æ—¶é—´æˆ³åœ¨å
              isHidden: true,
            };
            chat.history.push(hiddenInstruction);

            // 6. ä¿å­˜æ‰€æœ‰æ•°æ®
            await saveTarotReading(activeTarotReading);
            await db.chats.put(chat);
            renderChatList();

            activeTarotReading = null;
          } catch (error) {
            console.error("å¡”ç½—ç‰ŒAIè§£è¯»å¤±è´¥:", error);
            await showCustomAlert(
              "è§£è¯»å¤±è´¥",
              `æŠ±æ­‰ï¼Œè¿æ¥å¡”ç½—å¸ˆæ—¶å‡ºç°äº†ä¸€ç‚¹é—®é¢˜ï¼š\n\n${error.message}`,
            );
            activeTarotReading = null;
          }
        }

        // ä¿å­˜å åœè®°å½•åˆ°æ•°æ®åº“
        async function saveTarotReading(reading) {
          // ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œæˆ‘ä»¬åªä¿å­˜è§£è¯»æ–‡æœ¬ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç‰Œç»„å¯¹è±¡
          const interpretationText =
            `ç‰Œé˜µ: ${reading.spread.name}\n` +
            reading.cards
              .map((card, index) => {
                const orientationText = card.isReversed ? "é€†ä½" : "æ­£ä½";
                const meaning = card.isReversed ? card.reversed : card.upright;
                return `[${card.position}]: ${card.name} (${orientationText}) - ${meaning}`;
              })
              .join("\n");

          await db.tarotReadings.add({
            question: reading.question,
            interpretation: interpretationText,
            timestamp: reading.timestamp,
          });
        }

        // æ‰“å¼€å†å²è®°å½•ç•Œé¢
        async function openTarotHistory() {
          const readings = await db.tarotReadings
            .orderBy("timestamp")
            .reverse()
            .toArray();
          renderTarotHistory(readings);
          document.getElementById("tarot-setup-view").style.display = "none";
          document.getElementById("tarot-history-view").style.display = "flex";
        }

        // æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
        function renderTarotHistory(readings) {
          const listEl = document.getElementById("tarot-history-list");
          listEl.innerHTML = "";
          if (readings.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">è¿˜æ²¡æœ‰å åœå†å²å“¦</p>';
            return;
          }
          readings.forEach((reading) => {
            const item = document.createElement("div");
            item.className = "tarot-history-item";
            item.innerHTML = `
			            <div class="question">${reading.question}</div>
			            <div class="details">${new Date(reading.timestamp).toLocaleString()}</div>
			            <button class="tarot-history-delete-btn" data-id="${reading.id}">Ã—</button>
			        `;
            listEl.appendChild(item);
          });
        }

        // åˆ é™¤ä¸€æ¡å†å²è®°å½•
        async function deleteTarotReading(readingId) {
          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            "ç¡®å®šè¦åˆ é™¤è¿™æ¡å åœå†å²å—ï¼Ÿ",
            {
              confirmButtonClass: "btn-danger",
            },
          );
          if (confirmed) {
            await db.tarotReadings.delete(readingId);
            openTarotHistory(); // é‡æ–°åŠ è½½å†å²è®°å½•
          }
        }

        /**
         * åº”ç”¨ä¸»å±å¹•å›¾æ ‡å’Œå°ç»„ä»¶çš„æ–‡å­—é¢œè‰²
         * @param {string} color - é¢œè‰²ä»£ç , e.g., '#FFFFFF'
         */
        function applyHomeIconWidgetTextColor(color) {
          const phoneScreen = document.getElementById("phone-screen");
          if (phoneScreen && color) {
            // ä½¿ç”¨æ–°çš„CSSå˜é‡å
            phoneScreen.style.setProperty(
              "--home-icon-widget-text-color",
              color,
            );
          }
        }
        /**
         * å°†æ—¶é•¿å­—ç¬¦ä¸²ï¼ˆå¦‚â€œ2.5å°æ—¶â€, "30m"ï¼‰è§£æä¸ºåˆ†é’Ÿæ•°
         * @param {string} durationString - æ—¶é•¿æè¿°æ–‡æœ¬
         * @returns {number} - å¯¹åº”çš„åˆ†é’Ÿæ•°
         */
        function parseDurationToMinutes(durationString) {
          if (!durationString || typeof durationString !== "string") return 0;

          const text = durationString.toLowerCase();
          const num = parseFloat(text.match(/(\d+(\.\d+)?)/)?.[0]) || 0;

          if (text.includes("å°æ—¶") || text.includes("h")) {
            return num * 60;
          }
          if (text.includes("åˆ†é’Ÿ") || text.includes("m")) {
            return num;
          }
          // å¦‚æœæ²¡æœ‰å•ä½ï¼Œä½†æ•°å€¼å¤§äºç­‰äº10ï¼Œæˆ‘ä»¬çŒœæµ‹æ˜¯åˆ†é’Ÿ
          if (num >= 10) {
            return num;
          }
          // å…¶ä»–æƒ…å†µï¼ˆå¦‚æ•°å€¼å¾ˆå°ä¸”æ— å•ä½ï¼‰ï¼ŒçŒœæµ‹æ˜¯å°æ—¶
          return num * 60;
        }

        /**
         * å°†æ€»åˆ†é’Ÿæ•°æ ¼å¼åŒ–ä¸º "Xå°æ—¶Yåˆ†é’Ÿ" çš„å­—ç¬¦ä¸²
         * @param {number} totalMinutes - æ€»åˆ†é’Ÿæ•°
         * @returns {string} - æ ¼å¼åŒ–åçš„æ—¶é•¿å­—ç¬¦ä¸²
         */
        function formatMinutesToDuration(totalMinutes) {
          if (totalMinutes < 1) return "ä¸åˆ°1åˆ†é’Ÿ";

          const hours = Math.floor(totalMinutes / 60);
          const minutes = Math.round(totalMinutes % 60);

          if (hours > 0 && minutes > 0) {
            return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
          } else if (hours > 0) {
            return `${hours}å°æ—¶`;
          } else {
            return `${minutes}åˆ†é’Ÿ`;
          }
        }

        let currentPetData = null; // ç”¨äºæš‚å­˜æ­£åœ¨ç¼–è¾‘çš„å® ç‰©æ•°æ®
        let isPetDragging = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨æ‹–åŠ¨å® ç‰©
        let petDragOffset = { x: 0, y: 0 };

        /**
         * æ‰“å¼€å® ç‰©ä¸»é¢æ¿ï¼ˆè®¾ç½®ä¸äº’åŠ¨ï¼‰
         */
        async function openPetModal() {
          if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
            alert("åªæœ‰åœ¨å•äººèŠå¤©ä¸­æ‰èƒ½å…»å® ç‰©å“¦ï¼");
            return;
          }
          const chat = state.chats[state.activeChatId];

          // æ ¸å¿ƒåˆ¤æ–­ï¼šæ£€æŸ¥æ˜¯å¦å·²é¢†å…»
          if (!chat.settings.petAdopted) {
            // å¦‚æœæœªé¢†å…»ï¼Œå¼¹å‡ºç¡®è®¤æ¡†
            const confirmed = await showCustomConfirm(
              "é¢†å…»æ–°å® ç‰©",
              `ä½ è¿˜æ²¡æœ‰ä¸ºâ€œ${chat.name}â€é¢†å…»å® ç‰©ï¼Œè¦ç°åœ¨å¼€å¯å® ç‰©ç³»ç»Ÿå—ï¼Ÿ`,
              { confirmText: "ç°åœ¨é¢†å…»" },
            );

            if (confirmed) {
              // ç”¨æˆ·åŒæ„é¢†å…»
              chat.settings.petAdopted = true;
              // åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„é»˜è®¤å® ç‰©å¯¹è±¡
              chat.settings.pet = {
                type: "æ— ",
                name: "",
                image: "ğŸ¥š",
                persona: "ä¸€åªå¯çˆ±çš„å°å® ç‰©ï¼Œå¯¹ä¸–ç•Œå……æ»¡å¥½å¥‡ã€‚",
                petChatHistory: [],
                isCustomImage: false,
                display: { show: false, size: 100, top: "80%", left: "50%" },
                status: {
                  hunger: 100,
                  happiness: 100,
                  intimacyToUser: 50,
                  intimacyToChar: 50,
                  lastUpdated: Date.now(),
                },
              };
              await db.chats.put(chat);
              alert(
                `æ­å–œï¼ä½ å·²æˆåŠŸä¸ºâ€œ${chat.name}â€å¼€å¯å® ç‰©ç³»ç»Ÿï¼ç°åœ¨æ¥ä¸ºå®ƒè®¾ç½®ä¸€ä¸‹å§ã€‚`,
              );
              // é¢†å…»æˆåŠŸåï¼Œå†æ¬¡è°ƒç”¨æœ¬å‡½æ•°ï¼Œè¿™æ¬¡ä¼šç›´æ¥è¿›å…¥è®¾ç½®ç•Œé¢
              openPetModal();
            }
            // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸åš
            return;
          }

          // --- å¦‚æœå·²ç»é¢†å…»ï¼Œåˆ™æ‰§è¡ŒåŸæ¥çš„æ˜¾ç¤ºé€»è¾‘ ---
          currentPetData = JSON.parse(JSON.stringify(chat.settings.pet));

          document.getElementById("pet-type-input").value =
            currentPetData.type === "æ— " ? "" : currentPetData.type;
          document.getElementById("pet-name-input").value = currentPetData.name;
          document.getElementById("pet-image-input").value =
            currentPetData.image;
          document.getElementById("pet-display-toggle").checked =
            currentPetData.display.show;
          document.getElementById("pet-size-slider").value =
            currentPetData.display.size;
          document.getElementById("pet-size-value").textContent =
            `${currentPetData.display.size}px`;
          document.getElementById("pet-persona-input").value =
            currentPetData.persona || "";

          updatePetPreview();

          if (currentPetData.type !== "æ— ") {
            document.getElementById("pet-stats-area").style.display = "flex";
            updatePetStatusUI(currentPetData);
          } else {
            document.getElementById("pet-stats-area").style.display = "none";
          }

          const positionControls = document.getElementById(
            "pet-position-controls",
          );
          positionControls.style.display = currentPetData.display.show
            ? "block"
            : "none";

          document.getElementById("pet-modal").classList.add("visible");
        }

        /**
         * è®¡ç®—å¹¶åº”ç”¨å® ç‰©çš„æ•°å€¼è¡°å‡
         * @param {object} pet - å® ç‰©å¯¹è±¡
         * @returns {boolean} - å¦‚æœæ•°å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿”å› true
         */
        function applyPetDecay(pet) {
          if (!pet || !pet.status) return false;

          const now = Date.now();
          const lastUpdated = pet.status.lastUpdated || now;
          const timeElapsed = now - lastUpdated;

          // è®¡ç®—è¿‡å»äº†å¤šå°‘ä¸ªè¡°å‡å‘¨æœŸ
          const intervalsPassed = Math.floor(timeElapsed / PET_DECAY_INTERVAL);

          if (intervalsPassed > 0) {
            // è®¡ç®—æ€»å…±è¦è¡°å‡å¤šå°‘
            const totalHungerDecay = intervalsPassed * PET_DECAY_AMOUNT.hunger;
            const totalHappinessDecay =
              intervalsPassed * PET_DECAY_AMOUNT.happiness;

            // åº”ç”¨è¡°å‡ï¼Œç¡®ä¿ä¸ä½äº0
            pet.status.hunger = Math.max(
              0,
              pet.status.hunger - totalHungerDecay,
            );
            pet.status.happiness = Math.max(
              0,
              pet.status.happiness - totalHappinessDecay,
            );

            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´ï¼ŒåªåŠ ä¸Šå·²ç»è®¡ç®—è¿‡çš„å‘¨æœŸçš„æ—¶é—´ï¼Œé¿å…ä¸¢å¤±é›¶å¤´æ—¶é—´
            pet.status.lastUpdated =
              lastUpdated + intervalsPassed * PET_DECAY_INTERVAL;

            console.log(
              `å® ç‰©"${pet.name}"æ•°å€¼è¡°å‡: ${intervalsPassed}ä¸ªå‘¨æœŸ, é¥±é£Ÿåº¦-${totalHungerDecay}, å¿ƒæƒ…-${totalHappinessDecay}`,
            );
            return true; // æ•°å€¼å·²æ”¹å˜
          }

          return false; // æ•°å€¼æœªæ”¹å˜
        }

        /**
         * åœæ­¢å½“å‰çš„å® ç‰©è¡°å‡è®¡æ—¶å™¨
         */
        function stopPetDecayTimer() {
          if (petDecayTimer) {
            clearInterval(petDecayTimer);
            petDecayTimer = null;
            // console.log("å® ç‰©è¡°å‡è®¡æ—¶å™¨å·²åœæ­¢ã€‚");
          }
        }

        /**
         * ä¸ºå½“å‰èŠå¤©ä¸­çš„å® ç‰©å¯åŠ¨è¡°å‡è®¡æ—¶å™¨
         */
        function startPetDecayTimer() {
          stopPetDecayTimer(); // å…ˆç¡®ä¿åœæ­¢ä»»ä½•æ—§çš„è®¡æ—¶å™¨

          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.settings.pet || chat.settings.pet.type === "æ— ") {
            return; // å¦‚æœå½“å‰èŠå¤©æ²¡æœ‰å® ç‰©ï¼Œåˆ™ä¸å¯åŠ¨
          }

          // console.log(`ä¸ºå® ç‰©"${chat.settings.pet.name}"å¯åŠ¨è¡°å‡è®¡æ—¶å™¨ã€‚`);

          // ä½¿ç”¨ setInterval å®šæœŸæ£€æŸ¥å¹¶åº”ç”¨è¡°å‡
          petDecayTimer = setInterval(async () => {
            const currentChat = state.chats[state.activeChatId];
            if (!currentChat) {
              // å®‰å…¨æ£€æŸ¥ï¼Œå¦‚æœèŠå¤©å·²å…³é—­åˆ™åœæ­¢è®¡æ—¶å™¨
              stopPetDecayTimer();
              return;
            }
            const pet = currentChat.settings.pet;

            if (applyPetDecay(pet)) {
              // å¦‚æœæ•°å€¼å˜åŒ–äº†ï¼Œæ›´æ–°UIå¹¶ä¿å­˜åˆ°æ•°æ®åº“
              // åªæœ‰å½“å® ç‰©é¢æ¿æ‰“å¼€æ—¶æ‰éœ€è¦æ›´æ–°UI
              if (
                document
                  .getElementById("pet-modal")
                  .classList.contains("visible")
              ) {
                updatePetStatusUI(pet);
              }
              await db.chats.put(currentChat);
            }
          }, 60 * 1000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œæ˜¯å¦åˆ°è¾¾äº†è¡°å‡å‘¨æœŸ
        }

        /**
         * æ›´æ–°å® ç‰©æ•°å€¼é¢æ¿çš„UIæ˜¾ç¤º
         * @param {object} petData - å® ç‰©çš„æ•°æ®å¯¹è±¡
         */
        function updatePetStatusUI(petData) {
          const hunger = petData.status.hunger || 0;
          const happiness = petData.status.happiness || 0;
          // â˜…â˜…â˜… æ–°å¢ï¼šè·å–äº²å¯†åº¦æ•°å€¼ â˜…â˜…â˜…
          const intimacyToUser = petData.status.intimacyToUser || 0;
          const intimacyToChar = petData.status.intimacyToChar || 0;

          const hungerFill = document.querySelector(
            "#pet-hunger-bar .stat-bar-fill",
          );
          const happinessFill = document.querySelector(
            "#pet-happiness-bar .stat-bar-fill",
          );
          // â˜…â˜…â˜… æ–°å¢ï¼šè·å–äº²å¯†åº¦è¿›åº¦æ¡å…ƒç´  â˜…â˜…â˜…
          const intimacyUserFill = document.querySelector(
            "#pet-intimacy-user-bar .stat-bar-fill",
          );
          const intimacyCharFill = document.querySelector(
            "#pet-intimacy-char-bar .stat-bar-fill",
          );

          if (hungerFill) {
            hungerFill.style.width = `${hunger}%`;
            hungerFill.textContent = `${hunger}%`;
          }
          if (happinessFill) {
            happinessFill.style.width = `${happiness}%`;
            happinessFill.textContent = `${happiness}%`;
          }
          // â˜…â˜…â˜… æ–°å¢ï¼šæ¸²æŸ“äº²å¯†åº¦è¿›åº¦æ¡ â˜…â˜…â˜…
          if (intimacyUserFill) {
            intimacyUserFill.style.width = `${intimacyToUser}%`;
            intimacyUserFill.textContent = `${intimacyToUser}%`;
          }
          if (intimacyCharFill) {
            intimacyCharFill.style.width = `${intimacyToChar}%`;
            intimacyCharFill.textContent = `${intimacyToChar}%`;
          }
        }

        /**
         * åœ¨å¼¹çª—ä¸­æ›´æ–°å® ç‰©çš„é¢„è§ˆ
         */
        function updatePetPreview() {
          const previewDisplay = document.getElementById("pet-preview-display");
          const nameEl = document.getElementById("pet-preview-name");
          const typeEl = document.getElementById("pet-preview-type");

          const imageInput = document
            .getElementById("pet-image-input")
            .value.trim();

          if (
            imageInput.startsWith("http") ||
            imageInput.startsWith("data:image")
          ) {
            previewDisplay.innerHTML = `<img src="${imageInput}" style="width: 60px; height: 60px; object-fit: contain;">`;
          } else {
            previewDisplay.textContent = imageInput || "ğŸ¥š";
          }

          nameEl.textContent =
            document.getElementById("pet-name-input").value.trim() ||
            "(æœªå‘½å)";
          typeEl.textContent =
            document.getElementById("pet-type-input").value.trim() || "ç‰©ç§";
        }

        /**
         * ä¿å­˜å® ç‰©è®¾ç½®
         */
        async function savePetSettings() {
          const chat = state.chats[state.activeChatId];

          // ä»UIè¯»å–æ•°æ®
          const type =
            document.getElementById("pet-type-input").value.trim() || "æ— ";
          const name = document.getElementById("pet-name-input").value.trim();
          const image =
            document.getElementById("pet-image-input").value.trim() || "ğŸ¥š";

          const newPetSettings = {
            ...currentPetData, // ä¿ç•™å¦‚ä½ç½®ç­‰æœªåœ¨ä¸»é¢æ¿ä¿®æ”¹çš„å±æ€§
            type: type,
            name: name,
            image: image,
            persona: document.getElementById("pet-persona-input").value.trim(),
            isCustomImage:
              image.startsWith("http") || image.startsWith("data:image"),
            display: {
              ...currentPetData.display,
              show: document.getElementById("pet-display-toggle").checked,
              size: parseInt(document.getElementById("pet-size-slider").value),
            },
          };

          // æ›´æ–°åˆ° state å’Œæ•°æ®åº“
          chat.settings.pet = newPetSettings;
          await db.chats.put(chat);

          // åˆ·æ–°èŠå¤©ç•Œé¢ä¸Šçš„å® ç‰©
          renderChatPet();

          document.getElementById("pet-modal").classList.remove("visible");
          currentPetData = null; // æ¸…ç†ä¸´æ—¶æ•°æ®
          alert("å® ç‰©ä¿¡æ¯å·²ä¿å­˜ï¼");
        }

        /**
         * åœ¨èŠå¤©ç•Œé¢ä¸Šæ¸²æŸ“å® ç‰©
         */
        function renderChatPet() {
          const chat = state.chats[state.activeChatId];
          const petContainer = document.getElementById("chat-pet-container");
          const petEl = document.getElementById("chat-pet");

          if (
            !chat ||
            chat.isGroup ||
            !chat.settings.petAdopted ||
            !chat.settings.pet ||
            !chat.settings.pet.display.show
          ) {
            petEl.style.display = "none";
            return;
          }

          const pet = chat.settings.pet;
          petEl.style.display = "block";

          if (pet.isCustomImage) {
            petEl.innerHTML = `<img src="${pet.image}" alt="${pet.name}">`;
          } else {
            petEl.innerHTML = pet.image;
          }

          // åº”ç”¨æ ·å¼
          petEl.style.fontSize = `${pet.display.size}px`;
          petEl.style.width = `${pet.display.size}px`;
          petEl.style.height = `${pet.display.size}px`;
          petEl.style.top = pet.display.top;
          petEl.style.left = pet.display.left;
        }

        /**
         * å¤„ç†ç”¨æˆ·ä¸å® ç‰©çš„äº’åŠ¨
         * @param {string} action - äº’åŠ¨ç±»å‹, e.g., 'feed', 'play'
         */
        async function handlePetInteraction(action) {
          const chat = state.chats[state.activeChatId];
          if (
            !chat ||
            !chat.settings.petAdopted ||
            !chat.settings.pet ||
            chat.settings.pet.type === "æ— "
          ) {
            alert("ä½ è¿˜æ²¡æœ‰å® ç‰©ï¼Œæˆ–è€…è¿˜æ²¡æœ‰ç»™å®ƒè®¾å®šç§ç±»å“¦ï¼");
            return;
          }

          const pet = chat.settings.pet;
          let actionText = "";
          const myNickname = chat.settings.myNickname || "æˆ‘";

          switch (action) {
            case "feed":
              pet.status.hunger = Math.min(100, pet.status.hunger + 20);
              pet.status.happiness = Math.min(100, pet.status.happiness + 5);
              pet.status.intimacyToUser = Math.min(
                100,
                pet.status.intimacyToUser + 10,
              );
              actionText = `${myNickname} å–‚äº† ${pet.name} ä¸€äº›é£Ÿç‰©ã€‚`;
              break;
            case "play":
              pet.status.hunger = Math.max(0, pet.status.hunger - 10);
              pet.status.happiness = Math.min(100, pet.status.happiness + 15);
              pet.status.intimacyToUser = Math.min(
                100,
                pet.status.intimacyToUser + 15,
              );
              actionText = `${myNickname} é™ª ${pet.name} ç©äº†ä¸€ä¼šå„¿ã€‚`;
              break;
            case "touch":
              pet.status.happiness = Math.min(100, pet.status.happiness + 10);
              pet.status.intimacyToUser = Math.min(
                100,
                pet.status.intimacyToUser + 5,
              );
              actionText = `${myNickname} è½»è½»åœ°æŠšæ‘¸äº† ${pet.name}ã€‚`;
              break;
            case "chat":
              openPetChat();
              return;
          }

          updatePetStatusUI(pet);
          chat.settings.pet = pet;

          // åˆ›å»ºå¯¹ç”¨æˆ·ã€å¯è§ã€‘çš„ç³»ç»Ÿæ¶ˆæ¯
          const visibleMessage = {
            role: "system",
            type: "pat_message",
            content: `[ç³»ç»Ÿï¼š${actionText}]`,
            timestamp: Date.now(),
          };
          chat.history.push(visibleMessage);

          // åˆ›å»ºç»™AIçœ‹çš„ã€éšè—ã€‘æŒ‡ä»¤
          const hiddenMessageForAI = {
            role: "system",
            content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšå’Œå® ç‰©â€œ${pet.name}â€è¿›è¡Œäº†äº’åŠ¨ï¼š${actionText}ã€‚]`,
            timestamp: Date.now() + 1, // ç¡®ä¿æ—¶é—´æˆ³åœ¨å
            isHidden: true,
          };
          chat.history.push(hiddenMessageForAI);

          await db.chats.put(chat);

          if (
            document
              .getElementById("chat-interface-screen")
              .classList.contains("active")
          ) {
            appendMessage(visibleMessage, chat);
          }

          document.getElementById("pet-modal").classList.remove("visible");
        }

        // å® ç‰©å¯¹è¯åŠŸèƒ½æ ¸å¿ƒå‡½æ•°

        /**
         * æ‰“å¼€å® ç‰©èŠå¤©æ¨¡æ€æ¡†
         */
        function openPetChat() {
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.settings.pet || chat.settings.pet.type === "æ— ") {
            alert("å…ˆç»™ä½ çš„å® ç‰©èµ·ä¸ªåå­—å’Œç§ç±»å§ï¼");
            return;
          }

          // å…³é—­ä¸»è®¾ç½®é¢æ¿ï¼Œæ‰“å¼€èŠå¤©é¢æ¿
          document.getElementById("pet-modal").classList.remove("visible");
          const chatModal = document.getElementById("pet-chat-modal");
          document.getElementById("pet-chat-title").textContent =
            `å’Œâ€œ${chat.settings.pet.name}â€çš„å¯¹è¯`;
          document.getElementById("pet-chat-input").value = "";

          renderPetChatHistory(); // æ¸²æŸ“å†å²è®°å½•
          chatModal.classList.add("visible");
        }

        /**
         * æ¸²æŸ“å® ç‰©çš„èŠå¤©è®°å½•
         */
        function renderPetChatHistory() {
          const chat = state.chats[state.activeChatId];
          const pet = chat.settings.pet;
          const messagesEl = document.getElementById("pet-chat-messages");
          messagesEl.innerHTML = "";

          if (!pet.petChatHistory || pet.petChatHistory.length === 0) {
            messagesEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">è¯•ç€å’Œå®ƒæ‰“ä¸ªæ‹›å‘¼å§ï¼</p>`;
            return;
          }

          // è·å–ç”¨æˆ·å¤´åƒ
          const myAvatar = chat.settings.myAvatar || defaultAvatar;

          pet.petChatHistory.forEach((msg) => {
            const wrapper = document.createElement("div");

            wrapper.className = `message-wrapper ${msg.sender}`;

            const bubble = document.createElement("div");
            bubble.className = "message-bubble";

            let avatarSrc = "";
            let avatarHtml = "";

            if (msg.sender === "user") {
              // å¦‚æœæ˜¯ç”¨æˆ·å‘çš„ï¼Œä½¿ç”¨ç”¨æˆ·å¤´åƒ
              avatarSrc = myAvatar;
              avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
            } else if (msg.sender === "char") {
              // å¦‚æœæ˜¯è§’è‰²(char)å‘çš„ï¼Œå°±ä½¿ç”¨è§’è‰²çš„å¤´åƒ
              avatarSrc = chat.settings.aiAvatar || defaultAvatar;
              avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
            } else {
              // å‰©ä¸‹çš„æƒ…å†µå°±æ˜¯å® ç‰©(pet)è‡ªå·±å‘çš„
              avatarSrc = pet.isCustomImage ? pet.image : null;
              if (avatarSrc) {
                // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡
                avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
              } else {
                // å¦‚æœæ˜¯Emojiï¼Œç›´æ¥æ˜¾ç¤ºEmoji
                avatarHtml = `<div class="avatar" style="font-size: 28px; text-align: center;">${pet.image}</div>`;
              }
            }

            bubble.innerHTML = `
			            ${avatarHtml}
			            <div class="content">${msg.content.replace(/\n/g, "<br>")}</div>
			        `;
            wrapper.appendChild(bubble);
            messagesEl.appendChild(wrapper);
          });

          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        /**
         * å¤„ç†ç”¨æˆ·åœ¨å® ç‰©èŠå¤©æ¡†ä¸­å‘é€æ¶ˆæ¯
         */
        async function handleSendToPet() {
          const chat = state.chats[state.activeChatId];
          const pet = chat.settings.pet;
          const input = document.getElementById("pet-chat-input");
          const userInput = input.value.trim();
          if (!userInput) return;

          input.value = "";
          input.style.height = "auto";

          pet.petChatHistory.push({ sender: "user", content: userInput });
          renderPetChatHistory();

          const petResponse = await getPetApiResponse(pet);
          if (petResponse) {
            pet.petChatHistory.push({ sender: "pet", content: petResponse });
            renderPetChatHistory();
          }

          // åˆ›å»ºå¯¹ç”¨æˆ·ã€å¯è§ã€‘çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œè®°å½•è¿™æ¬¡å¯¹è¯
          const visibleLog = `[ç³»ç»Ÿï¼šä½ å’Œå® ç‰©â€œ${pet.name}â€è¿›è¡Œäº†å¯¹è¯ã€‚ä½ è¯´ï¼šâ€œ${userInput}â€ï¼Œå®ƒå›åº”ï¼šâ€œ${petResponse}â€ã€‚]`;
          const visibleMessage = {
            role: "system",
            type: "pat_message", // ä½¿ç”¨è¿™ä¸ªç±»å‹æ¥æ˜¾ç¤ºå±…ä¸­ç°è‰²æ°”æ³¡
            content: visibleLog,
            timestamp: Date.now(),
          };
          chat.history.push(visibleMessage);

          // åªæœ‰å½“ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹å½“å‰èŠå¤©æ—¶ï¼Œæ‰å®æ—¶è¿½åŠ åˆ°ç•Œé¢ä¸Š
          if (
            document
              .getElementById("chat-interface-screen")
              .classList.contains("active") &&
            state.activeChatId === chat.id
          ) {
            appendMessage(visibleMessage, chat);
          }

          // åˆ›å»ºç»™AIçœ‹çš„ã€éšè—ã€‘æŒ‡ä»¤
          const hiddenMessageForAI = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšå’Œå® ç‰©â€œ${pet.name}â€è¿›è¡Œäº†ä¸€æ¬¡å¯¹è¯ã€‚ç”¨æˆ·è¯´ï¼šâ€œ${userInput}â€ï¼Œå® ç‰©å›åº”ï¼šâ€œ${petResponse}â€ã€‚]`;
          const hiddenMessage = {
            role: "system",
            content: hiddenMessageForAI,
            timestamp: Date.now() + 1,
            isHidden: true,
          };
          chat.history.push(hiddenMessage);

          await db.chats.put(chat);
        }

        /**
         * ä¸ºå® ç‰©è·å–APIå›å¤
         * @param {object} pet - å® ç‰©å¯¹è±¡
         * @returns {Promise<string|null>} - AIç”Ÿæˆçš„å® ç‰©å›å¤æ–‡æœ¬
         */
        async function getPetApiResponse(pet) {
          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) {
            alert("è¯·å…ˆé…ç½®APIï¼");
            return "ï¼ˆæˆ‘å¥½åƒæ–­çº¿äº†...ï¼‰";
          }

          // é‡æ„å¯¹è¯å†å²çš„ç”Ÿæˆé€»è¾‘
          const historyForPet = pet.petChatHistory
            .slice(-6)
            .map((msg) => {
              let senderName;
              if (msg.sender === "user") {
                senderName = "ä¸»äºº";
              } else if (msg.sender === "char") {
                senderName = msg.senderName; // æ­£ç¡®è·å–Charçš„åå­—
              } else {
                // 'pet'
                senderName = pet.name;
              }
              return `${senderName}: ${msg.content}`;
            })
            .join("\n");

          const systemPrompt = `ä½ ç°åœ¨æ­£åœ¨æ‰®æ¼”ä¸€åªå® ç‰©ã€‚
			# ä½ çš„æ ¸å¿ƒè®¾å®š
			- ä½ çš„ç§ç±»: ${pet.type}
			- ä½ çš„åå­—: ${pet.name}
			- ä½ çš„æ€§æ ¼å’ŒèƒŒæ™¯æ•…äº‹: ${pet.persona}

			# æ ¸å¿ƒè§„åˆ™
			1. ä½ ã€å¿…é¡»ã€‘å®Œå…¨ä»£å…¥ä½ çš„è§’è‰²è®¾å®šè¿›è¡Œå›å¤ã€‚
			2. ä½ çš„å›å¤åº”è¯¥æ˜¯ç®€çŸ­ã€å¯çˆ±çš„ï¼Œç¬¦åˆä¸€åªå® ç‰©çš„è¯´è¯æ–¹å¼ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨æ‹Ÿå£°è¯ã€ç®€å•çš„è¯æ±‡ï¼‰ã€‚
			3. ä½ çš„å›å¤ã€åªèƒ½æ˜¯çº¯æ–‡æœ¬ã€‘ï¼Œä¸è¦åŒ…å«ä»»ä½•JSONæˆ–ç‰¹æ®Šæ ¼å¼ã€‚

			# æœ€è¿‘çš„å¯¹è¯
			${historyForPet}

			ç°åœ¨ï¼Œè¯·æ ¹æ®ä¸Šé¢çš„å¯¹è¯ï¼Œç»§ç»­ä½ çš„å›åº”ã€‚`;

          try {
            const messagesForApi = [
              {
                role: "user",
                content: "è¯·æ ¹æ®ä½ åœ¨ç³»ç»ŸæŒ‡ä»¤ä¸­è¯»åˆ°çš„è§„åˆ™ï¼Œç«‹å³å¼€å§‹ä½ çš„è¡ŒåŠ¨ã€‚",
              },
            ];
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPrompt,
              messagesForApi,
              isGemini,
              state.apiConfig.temperature,
            );

            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: [
                      { role: "system", content: systemPrompt },
                      ...messagesForApi,
                    ],
                    temperature: parseFloat(state.apiConfig.temperature) || 0.8,
                  }),
                });

            if (!response.ok) throw new Error(await response.text());
            const data = await response.json();
            return (
              isGemini
                ? data.candidates[0].content.parts[0].text
                : data.choices[0].message.content
            ).trim();
          } catch (error) {
            console.error("è·å–å® ç‰©å›å¤å¤±è´¥:", error);
            return "ï¼ˆå‘œ...æˆ‘å¥½åƒè¯´ä¸å‡ºè¯äº†...ï¼‰";
          }
        }

        /**
         * åˆå§‹åŒ–å® ç‰©çš„æ‹–æ‹½åŠŸèƒ½
         */
        function initPetDragging() {
          const petEl = document.getElementById("chat-pet");
          const container = document.getElementById("chat-pet-container");

          const onDragStart = (e) => {
            if (!petEl.style.display || petEl.style.display === "none") return;
            e.preventDefault();
            isPetDragging = true;

            const rect = petEl.getBoundingClientRect();
            const coords = getEventCoords(e);

            petDragOffset.x = coords.x - rect.left;
            petDragOffset.y = coords.y - rect.top;

            document.addEventListener("mousemove", onDragMove);
            document.addEventListener("mouseup", onDragEnd);
            document.addEventListener("touchmove", onDragMove, {
              passive: false,
            });
            document.addEventListener("touchend", onDragEnd);
          };

          const onDragMove = (e) => {
            if (!isPetDragging) return;
            e.preventDefault();

            const containerRect = container.getBoundingClientRect();
            const coords = getEventCoords(e);

            let newLeft = coords.x - petDragOffset.x - containerRect.left;
            let newTop = coords.y - petDragOffset.y - containerRect.top;

            // è¾¹ç•Œæ£€æµ‹
            newLeft = Math.max(
              0,
              Math.min(newLeft, container.clientWidth - petEl.offsetWidth),
            );
            newTop = Math.max(
              0,
              Math.min(newTop, container.clientHeight - petEl.offsetHeight),
            );

            // ç”¨ç™¾åˆ†æ¯”å­˜å‚¨ï¼Œä»¥é€‚åº”ä¸åŒå±å¹•å°ºå¯¸
            petEl.style.left = `${(newLeft / container.clientWidth) * 100}%`;
            petEl.style.top = `${(newTop / container.clientHeight) * 100}%`;
          };

          const onDragEnd = async () => {
            if (!isPetDragging) return;
            isPetDragging = false;

            // æ‹–åŠ¨ç»“æŸåï¼Œä¿å­˜æ–°çš„ä½ç½®
            const chat = state.chats[state.activeChatId];
            if (chat && chat.settings.pet) {
              chat.settings.pet.display.top = petEl.style.top;
              chat.settings.pet.display.left = petEl.style.left;
              await db.chats.put(chat);
            }

            document.removeEventListener("mousemove", onDragMove);
            document.removeEventListener("mouseup", onDragEnd);
            document.removeEventListener("touchmove", onDragMove);
            document.removeEventListener("touchend", onDragEnd);
          };

          petEl.addEventListener("mousedown", onDragStart);
          petEl.addEventListener("touchstart", onDragStart, { passive: true });
        }

        /**
         * æ¸²æŸ“çº¿ä¸‹æ¨¡å¼é¢„è®¾çš„ä¸‹æ‹‰æ¡†
         */
        function renderOfflinePresetsSelector() {
          const select = document.getElementById("offline-preset-select");
          // ç›´æ¥ä»å…¨å±€ state è¯»å–é¢„è®¾
          const presets = state.offlinePresets || [];
          select.innerHTML = '<option value="">-- ä½¿ç”¨è‡ªå®šä¹‰è¾“å…¥ --</option>';

          presets.forEach((preset) => {
            const option = document.createElement("option");
            // ä½¿ç”¨æ•°æ®åº“çš„ ID ä½œä¸º option çš„ valueï¼Œè¿™æ›´å¯é 
            option.value = preset.id;
            option.textContent = preset.name;
            select.appendChild(option);
          });
        }

        /**
         * å½“ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ—¶ï¼Œè‡ªåŠ¨å¡«å……è¾“å…¥æ¡†
         */
        function handleOfflinePresetSelection() {
          const select = document.getElementById("offline-preset-select");
          const selectedId = parseInt(select.value);

          // å¦‚æœé€‰æ‹©çš„ä¸æ˜¯â€œè‡ªå®šä¹‰è¾“å…¥â€
          if (selectedId) {
            // ä»å…¨å±€ state ä¸­æ ¹æ® ID æŸ¥æ‰¾é¢„è®¾
            const preset = state.offlinePresets.find(
              (p) => p.id === selectedId,
            );
            if (preset) {
              document.getElementById("offline-prompt-input").value =
                preset.prompt;
              document.getElementById("offline-style-input").value =
                preset.style;
            }
          }
        }

        /**
         * æ‰“å¼€é¢„è®¾ç®¡ç†çš„æ“ä½œèœå•
         */
        async function openOfflinePresetManager() {
          const select = document.getElementById("offline-preset-select");
          // è·å–å½“å‰é€‰ä¸­çš„é¢„è®¾ID
          const selectedId = select.value ? parseInt(select.value) : null;

          const choice = await showChoiceModal("ç®¡ç†çº¿ä¸‹æ¨¡å¼é¢„è®¾", [
            { text: "ğŸ’¾ ä¿å­˜å½“å‰ä¸ºæ–°é¢„è®¾", value: "save_new" },
            {
              text: "âœï¸ æ›´æ–°é€‰ä¸­é¢„è®¾",
              value: "update_selected",
              disabled: !selectedId,
            },
            {
              text: "ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­é¢„è®¾",
              value: "delete_selected",
              disabled: !selectedId,
            },
          ]);

          // æ ¹æ®é€‰æ‹©æ‰§è¡Œç›¸åº”çš„å…¨å±€æ“ä½œå‡½æ•°
          switch (choice) {
            case "save_new":
              await saveCurrentAsOfflinePreset();
              break;
            case "update_selected":
              if (selectedId) await updateSelectedOfflinePreset(selectedId);
              break;
            case "delete_selected":
              if (selectedId) await deleteSelectedOfflinePreset(selectedId);
              break;
          }
        }

        /**
         * å°†å½“å‰è¾“å…¥æ¡†çš„å†…å®¹ä¿å­˜ä¸ºä¸€ä¸ªæ–°é¢„è®¾
         */
        async function saveCurrentAsOfflinePreset() {
          const name = await showCustomPrompt("ä¿å­˜æ–°é¢„è®¾", "è¯·è¾“å…¥é¢„è®¾åç§°ï¼š");

          if (name && name.trim()) {
            const newPreset = {
              name: name.trim(),
              prompt: document
                .getElementById("offline-prompt-input")
                .value.trim(),
              style: document
                .getElementById("offline-style-input")
                .value.trim(),
            };
            // ç›´æ¥æ·»åŠ åˆ°å…¨å±€çš„ offlinePresets è¡¨ä¸­
            const newId = await db.offlinePresets.add(newPreset);

            // æ›´æ–°å†…å­˜ä¸­çš„ state
            if (!state.offlinePresets) state.offlinePresets = [];
            state.offlinePresets.push({ id: newId, ...newPreset });

            renderOfflinePresetsSelector(); // åˆ·æ–°ä¸‹æ‹‰æ¡†
            document.getElementById("offline-preset-select").value = newId; // è‡ªåŠ¨é€‰ä¸­æ–°ä¿å­˜çš„
            alert(`é¢„è®¾ "${name.trim()}" å·²ä¿å­˜ï¼`);
          }
        }

        /**
         * ç”¨å½“å‰è¾“å…¥æ¡†çš„å†…å®¹æ›´æ–°é€‰ä¸­çš„é¢„è®¾
         */
        async function updateSelectedOfflinePreset(presetId) {
          const preset = state.offlinePresets.find((p) => p.id === presetId);
          if (!preset) return;

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤æ›´æ–°",
            `ç¡®å®šè¦ç”¨å½“å‰å†…å®¹è¦†ç›–é¢„è®¾ "${preset.name}" å—ï¼Ÿ`,
          );
          if (confirmed) {
            const updatedData = {
              prompt: document
                .getElementById("offline-prompt-input")
                .value.trim(),
              style: document
                .getElementById("offline-style-input")
                .value.trim(),
            };
            // æ›´æ–°æ•°æ®åº“
            await db.offlinePresets.update(presetId, updatedData);
            // æ›´æ–°å†…å­˜
            preset.prompt = updatedData.prompt;
            preset.style = updatedData.style;
            alert("é¢„è®¾å·²æ›´æ–°ï¼");
          }
        }

        /**
         * åˆ é™¤é€‰ä¸­çš„é¢„è®¾
         */
        async function deleteSelectedOfflinePreset(presetId) {
          const preset = state.offlinePresets.find((p) => p.id === presetId);
          if (!preset) return;

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            `ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${preset.name}" å—ï¼Ÿ`,
            {
              confirmButtonClass: "btn-danger",
            },
          );
          if (confirmed) {
            // ä»æ•°æ®åº“åˆ é™¤
            await db.offlinePresets.delete(presetId);
            // ä»å†…å­˜ä¸­åˆ é™¤
            state.offlinePresets = state.offlinePresets.filter(
              (p) => p.id !== presetId,
            );

            renderOfflinePresetsSelector(); // åˆ·æ–°ä¸‹æ‹‰æ¡†
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById("offline-prompt-input").value = "";
            document.getElementById("offline-style-input").value = "";
            alert("é¢„è®¾å·²åˆ é™¤ã€‚");
          }
        }

        let isSummarizing = false; // å…¨å±€é”ï¼Œé˜²æ­¢é‡å¤è§¦å‘æ€»ç»“

        /**
         * æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘æ€»ç»“æˆ–æé†’
         * @param {string} chatId - å½“å‰èŠå¤©çš„ID
         */
        async function checkAndTriggerSummary(chatId) {
          if (isSummarizing) return;

          const chat = state.chats[chatId];
          if (!chat || !chat.settings.summary || !chat.settings.summary.enabled)
            return;

          const summarySettings = chat.settings.summary;
          // ä¸å†ä»0å¼€å§‹ï¼Œè€Œæ˜¯ä»ä¸Šæ¬¡æ€»ç»“çš„ä½ç½®å¼€å§‹è®¡ç®—
          const lastSummaryIndex = summarySettings.lastSummaryIndex;
          const messagesSinceLastSummary = chat.history.slice(
            lastSummaryIndex + 1,
          );

          if (messagesSinceLastSummary.length >= summarySettings.count) {
            isSummarizing = true;
            if (summarySettings.mode === "auto") {
              await performAutomaticSummary(chatId);
            } else {
              // å¯¹äºæ‰‹åŠ¨æ¨¡å¼ï¼Œç°åœ¨åªå¼¹æé†’
              await notifyForManualSummary(chatId);
            }
            isSummarizing = false;
          }
        }

        /**
         * è‡ªåŠ¨åœ¨åå°æ‰§è¡Œæ€»ç»“ï¼Œåªæ€»ç»“è§¦å‘æ¡ä»¶çš„Næ¡æ¶ˆæ¯
         */
        async function performAutomaticSummary(chatId) {
          console.log(`è‡ªåŠ¨æ€»ç»“è§¦å‘ for chat: ${chatId}`);
          const chat = state.chats[chatId];
          const summarySettings = chat.settings.summary;

          // ç²¾ç¡®æˆªå–æœ€åNæ¡æ¶ˆæ¯ä½œä¸ºæ€»ç»“èŒƒå›´
          const messagesToSummarize = chat.history.slice(
            -summarySettings.count,
          );

          try {
            const summaryText = await generateSummary(
              chatId,
              messagesToSummarize,
            );
            if (summaryText) {
              await saveSummaryAsMemory(chatId, summaryText);
            }
          } catch (e) {
            // generateSummary å†…éƒ¨å·²ç»å¤„ç†äº†é”™è¯¯å¼¹çª—ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦è®°å½•æ—¥å¿—å³å¯
            console.error("è‡ªåŠ¨æ€»ç»“è¿‡ç¨‹ä¸­å‘ç”Ÿæœªæ•è·çš„é”™è¯¯:", e);
          }
        }

        /**
         * å¼¹å‡ºæç¤ºæ¡†ï¼Œã€æé†’ã€‘ç”¨æˆ·å¯ä»¥è¿›è¡Œæ‰‹åŠ¨æ€»ç»“äº†
         */
        async function notifyForManualSummary(chatId) {
          console.log(`æ‰‹åŠ¨æ€»ç»“æé†’è§¦å‘ for chat: ${chatId}`);

          // åªå¼¹å‡ºä¸€ä¸ªç®€å•çš„é€šçŸ¥
          await showCustomAlert(
            "æ€»ç»“æé†’",
            "å¯¹è¯å·²è¾¾åˆ°è®¾å®šé•¿åº¦ï¼Œä½ å¯ä»¥éšæ—¶åœ¨â€œèŠå¤©è®¾ç½®â€ä¸­ç‚¹å‡»â€œç«‹å³æ‰‹åŠ¨æ€»ç»“â€æ¥ç”Ÿæˆå¯¹è¯è®°å¿†ã€‚",
          );

          // è¿™æ„å‘³ç€è®¡æ—¶å™¨ä¼šä»ç°åœ¨é‡æ–°å¼€å§‹è®¡ç®—ã€‚
          const chat = state.chats[chatId];
          chat.settings.summary.lastSummaryIndex = chat.history.length - 1;
          await db.chats.put(chat);
        }

        /**
         * è°ƒç”¨APIç”Ÿæˆæ€»ç»“å†…å®¹
         * @param {string} chatId - èŠå¤©çš„ID
         * @param {Array | null} specificMessages - å¦‚æœæä¾›ï¼Œåˆ™åªæ€»ç»“è¿™ä¸ªæ•°ç»„é‡Œçš„æ¶ˆæ¯ï¼›å¦‚æœä¸ºnullï¼Œåˆ™æ€»ç»“è‡ªä¸Šæ¬¡ä»¥æ¥çš„æ‰€æœ‰æ¶ˆæ¯ã€‚
         * @returns {Promise<string|null>} - AIç”Ÿæˆçš„æ€»ç»“æ–‡æœ¬
         */
        async function generateSummary(chatId, specificMessages = null) {
          const chat = state.chats[chatId];
          const { proxyUrl, apiKey, model } = state.apiConfig;

          if (!proxyUrl || !apiKey || !model) {
            throw new Error("APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆæ€»ç»“ã€‚");
          }

          const summarySettings = chat.settings.summary;
          let messagesToSummarize;

          if (specificMessages && specificMessages.length > 0) {
            messagesToSummarize = specificMessages;
          } else {
            const lastSummaryIndex =
              summarySettings.lastSummaryIndex > -1
                ? summarySettings.lastSummaryIndex
                : 0;
            messagesToSummarize = chat.history.slice(lastSummaryIndex + 1);
          }

          const filteredMessagesForSummary = messagesToSummarize.filter(
            (msg) => msg.type !== "summary",
          );

          if (filteredMessagesForSummary.length === 0) {
            if (!specificMessages) {
              await showCustomAlert(
                "æ— éœ€æ€»ç»“",
                "è‡ªä¸Šæ¬¡æ€»ç»“ä»¥æ¥æ²¡æœ‰æ–°çš„å¯¹è¯å†…å®¹ã€‚",
              );
            }
            return null;
          }

          // --- åœ¨æ„å»ºå¯¹è¯æ–‡æœ¬æ—¶ï¼ŒåŠ å…¥æ—¶é—´æˆ³ ---
          const conversationText = filteredMessagesForSummary
            .map((msg) => {
              const sender =
                msg.role === "user"
                  ? chat.isGroup
                    ? chat.settings.myNickname || "æˆ‘"
                    : "æˆ‘"
                  : msg.senderName || chat.name;
              let content = "";
              if (typeof msg.content === "string") {
                content = msg.content;
              } else if (Array.isArray(msg.content)) {
                content = "[å›¾ç‰‡]";
              } else if (msg.type) {
                content = `[${msg.type}]`;
              }
              // å°†æ¯«ç§’æ—¶é—´æˆ³è½¬æ¢ä¸ºäººç±»å¯è¯»çš„æ—¥æœŸæ—¶é—´å­—ç¬¦ä¸²
              const readableTime = new Date(msg.timestamp).toLocaleString(
                "zh-CN",
                { hour12: false },
              );
              return `[${readableTime}] ${sender}: ${content}`;
            })
            .join("\n");

          // --- æ›´æ–°ç³»ç»ŸæŒ‡ä»¤ï¼Œè¦æ±‚AIä½¿ç”¨æ—¶é—´æˆ³ ---
          const systemPrompt =
            summarySettings.prompt +
            `\n\né‡è¦æç¤ºï¼šæ¯æ¡æ¶ˆæ¯å¼€å¤´éƒ½æœ‰ä¸€ä¸ª [æ—¶é—´] æ ‡è®°ã€‚ä½ åœ¨æ€»ç»“æ—¶ï¼Œã€å¿…é¡»ã€‘å‚è€ƒè¿™äº›æ—¶é—´ï¼Œåœ¨æ€»ç»“å…³é”®äº‹ä»¶æ—¶é™„ä¸Šå¯¹åº”çš„æ—¶é—´èŒƒå›´æˆ–å…·ä½“æ—¶é—´ç‚¹ï¼Œè®©æ€»ç»“åŒ…å«æ—¶é—´çº¿ç´¢ã€‚\n\n--- å¯¹è¯å¼€å§‹ ---\n${conversationText}\n--- å¯¹è¯ç»“æŸ ---`;

          try {
            if (!specificMessages) {
              await showCustomAlert(
                "æ­£åœ¨ç”Ÿæˆ...",
                "AIæ­£åœ¨åŠªåŠ›æ€»ç»“ä½ ä»¬çš„å¯¹è¯ï¼Œè¯·ç¨å€™...",
              );
            }

            const isGemini = proxyUrl === GEMINI_API_URL;
            const messagesForApi = [{ role: "user", content: systemPrompt }];
            const geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPrompt,
              messagesForApi,
              isGemini,
            );

            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: parseFloat(state.apiConfig.temperature) || 0.3,
                  }),
                });

            if (!response.ok) throw new Error(await response.text());
            const data = await response.json();
            const aiContent = isGemini
              ? data?.candidates?.[0]?.content?.parts?.[0]?.text
              : data?.choices?.[0]?.message?.content;

            if (!aiContent) {
              throw new Error("AIè¿”å›äº†ç©ºå†…å®¹ã€‚");
            }

            return aiContent;
          } catch (error) {
            console.error("ç”Ÿæˆæ€»ç»“å¤±è´¥:", error);
            await showCustomAlert("æ€»ç»“å¤±è´¥", `å‘ç”Ÿé”™è¯¯: ${error.message}`);
            return null;
          }
        }

        /**
         * å°†ç”Ÿæˆçš„æ€»ç»“ä½œä¸ºä¸€æ¡ç‰¹æ®Šçš„è®°å¿†æ¶ˆæ¯ä¿å­˜èµ·æ¥
         */
        async function saveSummaryAsMemory(chatId, summaryText) {
          const chat = state.chats[chatId];

          // è®°å½•ä¸‹æ€»ç»“æ“ä½œå‘ç”Ÿæ—¶çš„æœ€åä¸€æ¡æ¶ˆæ¯çš„ç´¢å¼•
          const newLastSummaryIndex = chat.history.length - 1;

          const summaryMessage = {
            role: "system",
            type: "summary", // ç‰¹æ®Šç±»å‹
            content: summaryText,
            timestamp: Date.now(),
            isHidden: true, // è¿™æ¡æ¶ˆæ¯å¯¹AIå¯è§ï¼Œä½†å¯¹ç”¨æˆ·éšè—
          };

          chat.history.push(summaryMessage);
          chat.settings.summary.lastSummaryIndex = newLastSummaryIndex; // æ›´æ–°ç´¢å¼•

          await db.chats.put(chat);
          console.log(`æ–°çš„æ€»ç»“å·²ä½œä¸ºè®°å¿†ä¿å­˜ for chat: ${chatId}`);
        }

        // --- æ€»ç»“ç®¡ç†ç•Œé¢çš„å‡½æ•° ---

        let editingSummaryTimestamp = null;

        async function openSummaryViewer() {
          const chat = state.chats[state.activeChatId];
          document.getElementById("summary-viewer-title").textContent =
            `â€œ${chat.name}â€çš„å¯¹è¯è®°å¿†`;

          const listEl = document.getElementById("summary-list");
          listEl.innerHTML = "";

          const summaries = chat.history.filter(
            (msg) => msg.type === "summary",
          );

          if (summaries.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a;">è¿˜æ²¡æœ‰ç”Ÿæˆè¿‡ä»»ä½•æ€»ç»“ã€‚</p>';
          } else {
            [...summaries].reverse().forEach((summary) => {
              const card = document.createElement("div");
              card.className = "summary-item-card";

              card.innerHTML = `
			                <div class="summary-actions">
			                    <button class="concise-summary-btn" data-timestamp="${
                            summary.timestamp
                          }" title="ç²¾ç®€æ€»ç»“">âœ¨</button>
			                    <button class="edit-summary-btn" data-timestamp="${summary.timestamp}" title="ç¼–è¾‘">âœï¸</button>
			                    <button class="delete-summary-btn" data-timestamp="${summary.timestamp}" title="åˆ é™¤">ğŸ—‘ï¸</button>
			                </div>
			                <div class="summary-content">${summary.content.replace(/\n/g, "<br>")}</div>
			                <div class="summary-meta">
			                    <span>ç”Ÿæˆäº: ${new Date(summary.timestamp).toLocaleString(
                            "zh-CN",
                            {
                              dateStyle: "short",
                              timeStyle: "short",
                            },
                          )}</span>
			                </div>
			            `;
              listEl.appendChild(card);
            });
          }

          document
            .getElementById("chat-settings-modal")
            .classList.remove("visible");
          document
            .getElementById("summary-viewer-modal")
            .classList.add("visible");
        }

        /**
         * ç¼–è¾‘ä¸€æ¡æ€»ç»“
         */
        async function editSummary(timestamp) {
          const chat = state.chats[state.activeChatId];
          const summary = chat.history.find(
            (msg) => msg.timestamp === timestamp,
          );
          if (!summary) return;

          const newContent = await showCustomPrompt(
            "ç¼–è¾‘æ€»ç»“",
            "ä¿®æ”¹æ€»ç»“å†…å®¹:",
            summary.content,
            "textarea",
          );

          if (newContent !== null) {
            summary.content = newContent.trim();
            await db.chats.put(chat);
            openSummaryViewer(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
          }
        }

        /**
         * åˆ é™¤ä¸€æ¡æ€»ç»“ï¼Œå¹¶æ™ºèƒ½æ›´æ–°æ€»ç»“ç´¢å¼•
         */
        async function deleteSummary(timestamp) {
          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            "ç¡®å®šè¦åˆ é™¤è¿™æ¡æ€»ç»“è®°å¿†å—ï¼Ÿè¿™å¯èƒ½ä¼šå½±å“AIçš„é•¿æœŸè®°å¿†ã€‚",
            { confirmButtonClass: "btn-danger" },
          );
          if (confirmed) {
            const chat = state.chats[state.activeChatId];

            // 1. ä»å†å²è®°å½•ä¸­è¿‡æ»¤æ‰è¢«åˆ é™¤çš„æ€»ç»“
            chat.history = chat.history.filter(
              (msg) => msg.timestamp !== timestamp,
            );

            // 2. --- é‡æ–°è®¡ç®— lastSummaryIndex ---
            // æ‰¾åˆ°å‰©ä¸‹çš„æ€»ç»“ä¸­ï¼Œæœ€æ–°çš„é‚£ä¸€æ¡
            const lastRemainingSummary = chat.history
              .filter((m) => m.type === "summary")
              .pop();

            let newLastSummaryIndex;

            if (lastRemainingSummary) {
              // 3. å¦‚æœè¿˜æœ‰å…¶ä»–æ€»ç»“ï¼Œå°±æ‰¾åˆ°å®ƒåœ¨å†å²è®°å½•ä¸­çš„ä½ç½®
              const lastSummaryMessageIndexInHistory = chat.history.findIndex(
                (m) => m.timestamp === lastRemainingSummary.timestamp,
              );
              // 4. æ–°çš„ç´¢å¼•å°±æ˜¯å®ƒå‰é¢é‚£æ¡æ™®é€šæ¶ˆæ¯çš„ç´¢å¼•
              newLastSummaryIndex =
                lastSummaryMessageIndexInHistory > 0
                  ? lastSummaryMessageIndexInHistory - 1
                  : -1;
            } else {
              // 5. å¦‚æœä¸€æ¡æ€»ç»“éƒ½ä¸å‰©äº†ï¼Œå°±å½»åº•é‡ç½®ç´¢å¼•
              newLastSummaryIndex = -1;
            }

            // 6. æ›´æ–°è®¾ç½®
            if (chat.settings.summary) {
              chat.settings.summary.lastSummaryIndex = newLastSummaryIndex;
            }

            // ä¿å­˜æ›´æ”¹å¹¶åˆ·æ–°UI
            await db.chats.put(chat);
            openSummaryViewer();
            await showCustomAlert("æ“ä½œæˆåŠŸ", "æ€»ç»“å·²åˆ é™¤ï¼");
          }
        }

        /**
         * è°ƒç”¨APIå°†æŒ‡å®šæ–‡æœ¬ç²¾ç®€ä¸ºæ‘˜è¦
         * @param {string} originalText - åŸå§‹çš„ã€è¾ƒé•¿çš„æ€»ç»“æ–‡æœ¬
         * @returns {Promise<string|null>} - AIç”Ÿæˆçš„ç²¾ç®€æ‘˜è¦ï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å›null
         */
        async function generateConciseSummary(originalText) {
          const { proxyUrl, apiKey, model } = state.apiConfig;
          if (!proxyUrl || !apiKey || !model) {
            throw new Error("APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆç²¾ç®€æ‘˜è¦ã€‚");
          }

          // æ ¸å¿ƒPromptï¼šæŒ‡ç¤ºAIå°†å†…å®¹ç²¾ç®€ä¸ºä¸€å¥è¯
          const systemPrompt = `è¯·ä½ å°†ä»¥ä¸‹å†…å®¹ç²¾ç®€ä¸ºä¸€å¥è¯çš„æ ¸å¿ƒæ‘˜è¦ï¼Œä¿ç•™æœ€å…³é”®çš„äººç‰©ã€äº‹ä»¶å’Œç»“è®ºï¼Œå­—æ•°æ§åˆ¶åœ¨20å­—ä»¥å†…ï¼š\n\n--- å†…å®¹å¼€å§‹ ---\n${originalText}\n--- å†…å®¹ç»“æŸ ---`;

          try {
            const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${apiKey}`,
              },
              body: JSON.stringify({
                model: model,
                messages: [{ role: "user", content: systemPrompt }],
                temperature: parseFloat(state.apiConfig.temperature) || 0.5,
              }),
            });

            if (!response.ok) throw new Error(await response.text());
            const data = await response.json();
            return data.choices[0].message.content;
          } catch (error) {
            console.error("ç”Ÿæˆç²¾ç®€æ‘˜è¦å¤±è´¥:", error);
            await showCustomAlert("ç²¾ç®€å¤±è´¥", `å‘ç”Ÿé”™è¯¯: ${error.message}`);
            return null;
          }
        }

        /**
         * å¤„ç†å•æ¡æ€»ç»“çš„ç²¾ç®€
         * @param {number} timestamp - è¦ç²¾ç®€çš„æ€»ç»“æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        async function handleConciseSummary(timestamp) {
          const chat = state.chats[state.activeChatId];
          const summary = chat.history.find(
            (msg) => msg.timestamp === timestamp,
          );
          if (!summary) return;

          await showCustomAlert("è¯·ç¨å€™...", "AIæ­£åœ¨åŠªåŠ›ä¸ºæ‚¨ç²¾ç®€å†…å®¹...");

          const conciseText = await generateConciseSummary(summary.content);

          if (conciseText) {
            summary.content = conciseText.trim();
            await db.chats.put(chat); // ä¿å­˜åˆ°æ•°æ®åº“
            await openSummaryViewer(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            await showCustomAlert("æˆåŠŸ", "æœ¬æ¡æ€»ç»“å·²ç²¾ç®€ï¼");
          }
        }

        /**
         * å¤„ç†å…¨éƒ¨æ€»ç»“çš„ç²¾ç®€
         */
        async function handleConciseAllSummaries() {
          const chat = state.chats[state.activeChatId];
          const summaries = chat.history.filter(
            (msg) => msg.type === "summary",
          );

          if (summaries.length === 0) {
            alert("æ²¡æœ‰å¯ä»¥ç²¾ç®€çš„æ€»ç»“ã€‚");
            return;
          }

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤å…¨éƒ¨ç²¾ç®€",
            `ç¡®å®šè¦ç²¾ç®€å…¨éƒ¨ ${summaries.length} æ¡æ€»ç»“å—ï¼Ÿæ­¤æ“ä½œä¼šè¦†ç›–åŸå§‹å†…å®¹ä¸”ä¸å¯æ¢å¤ã€‚`,
            { confirmButtonClass: "btn-danger" },
          );
          if (!confirmed) return;

          await showCustomAlert(
            "è¯·ç¨å€™...",
            `æ­£åœ¨æ‰¹é‡ç²¾ç®€ ${summaries.length} æ¡æ€»ç»“ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...`,
          );

          try {
            // ä½¿ç”¨ for...of å¾ªç¯æ¥é€æ¡å¤„ç†ï¼Œé¿å…åŒæ—¶å‘é€å¤ªå¤šAPIè¯·æ±‚å¯¼è‡´è¢«é™åˆ¶
            for (const summary of summaries) {
              const conciseText = await generateConciseSummary(summary.content);
              if (conciseText) {
                summary.content = conciseText.trim();
              }
              // æ¯å¤„ç†å®Œä¸€æ¡ï¼Œç¨å¾®ç­‰å¾…ä¸€ä¸‹ï¼Œç»™APIä¸€ç‚¹å–˜æ¯æ—¶é—´
              await new Promise((resolve) => setTimeout(resolve, 500));
            }

            await db.chats.put(chat);
            await openSummaryViewer();
            await showCustomAlert("æˆåŠŸ", "æ‰€æœ‰æ€»ç»“éƒ½å·²ç²¾ç®€å®Œæ¯•ï¼");
          } catch (error) {
            // generateConciseSummary å†…éƒ¨å·²ç»å¤„ç†äº†é”™è¯¯å¼¹çª—ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦ç¡®ä¿æµç¨‹æ­£å¸¸ç»“æŸ
            console.error("æ‰¹é‡ç²¾ç®€æ—¶å‡ºé”™:", error);
          }
        }

        /**
         * ç”¨æˆ·ç‚¹å‡»â€œç«‹å³æ‰‹åŠ¨æ€»ç»“â€æŒ‰é’®æ—¶è§¦å‘çš„å‡½æ•° (æ”¯æŒä¸åŒæ¨¡å¼)
         * @param {'latest' | 'range'} mode - æ€»ç»“æ¨¡å¼
         * @param {{start: number, end: number} | null} range - å¦‚æœæ˜¯èŒƒå›´æ¨¡å¼ï¼Œåˆ™ä¸ºèµ·å§‹å’Œç»“æŸåºå·
         */
        async function triggerManualSummaryNow(mode = "latest", range = null) {
          if (isSummarizing) {
            alert("æ­£åœ¨å¤„ç†ä¸Šä¸€ä¸ªæ€»ç»“ä»»åŠ¡ï¼Œè¯·ç¨å€™...");
            return;
          }

          const chat = state.chats[state.activeChatId];
          if (!chat) {
            alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°å½“å‰èŠå¤©ï¼Œæ— æ³•æ€»ç»“ã€‚");
            return;
          }

          isSummarizing = true; // ä¸Šé”

          try {
            let messagesToSummarize = [];

            // 1. æ ¹æ®ä¼ å…¥çš„æ¨¡å¼ï¼Œå†³å®šè¦æˆªå–å“ªäº›æ¶ˆæ¯
            if (mode === "latest") {
              const summarySettings = chat.settings.summary;
              const count =
                summarySettings && summarySettings.count > 0
                  ? summarySettings.count
                  : 20;
              messagesToSummarize = chat.history.slice(-count);
              console.log(`æ‰‹åŠ¨æ€»ç»“æœ€æ–° ${count} æ¡æ¶ˆæ¯...`);
            } else if (mode === "range" && range) {
              // æ³¨æ„ï¼šæ•°ç»„ç´¢å¼•ä»0å¼€å§‹ï¼Œè€Œç”¨æˆ·è¾“å…¥ä»1å¼€å§‹ï¼Œæ‰€ä»¥éœ€è¦-1
              messagesToSummarize = chat.history.slice(
                range.start - 1,
                range.end,
              );
              console.log(
                `æ‰‹åŠ¨æ€»ç»“ä» ${range.start} åˆ° ${range.end} çš„æ¶ˆæ¯...`,
              );
            } else {
              throw new Error("æ— æ•ˆçš„æ€»ç»“æ¨¡å¼æˆ–èŒƒå›´ã€‚");
            }

            // åç»­çš„é€»è¾‘ä¿æŒä¸å˜
            if (messagesToSummarize.length === 0) {
              alert("é€‰å®šçš„èŒƒå›´å†…æ²¡æœ‰å¯æ€»ç»“çš„èŠå¤©è®°å½•ã€‚");
              isSummarizing = false; // è§£é”
              return;
            }

            const summaryText = await generateSummary(
              state.activeChatId,
              messagesToSummarize,
            );

            if (summaryText) {
              await saveSummaryAsMemory(state.activeChatId, summaryText);
              await showCustomAlert("æ€»ç»“å®Œæˆ", "æ–°çš„å¯¹è¯è®°å¿†å·²ç”Ÿæˆï¼");
              if (
                document
                  .getElementById("summary-viewer-modal")
                  .classList.contains("visible")
              ) {
                openSummaryViewer();
              }
            }
          } catch (e) {
            console.error("æ‰‹åŠ¨æ€»ç»“è¿‡ç¨‹ä¸­å‘ç”Ÿæœªæ•è·çš„é”™è¯¯:", e);
            await showCustomAlert(
              "é”™è¯¯",
              "æ‰‹åŠ¨æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚",
            );
          } finally {
            isSummarizing = false; // åˆ«å¿˜äº†æ— è®ºæˆåŠŸå¤±è´¥éƒ½è¦è§£é”
          }
        }

        /**
         * æ›´æ–°è§’è‰²æ‰‹æœºé’±åŒ…çš„ä½™é¢å’Œäº¤æ˜“è®°å½•
         * @param {string} charId - è¦æ›´æ–°é’±åŒ…çš„è§’è‰²ID
         * @param {number} amount - äº¤æ˜“é‡‘é¢ (æ­£æ•°ä¸ºæ”¶å…¥, è´Ÿæ•°ä¸ºæ”¯å‡º)
         * @param {string} description - äº¤æ˜“æè¿° (ä¾‹å¦‚: "è½¬è´¦ç»™ XX", "æ”¶åˆ° XX çš„çº¢åŒ…")
         */
        async function updateCharacterBankBalance(charId, amount, description) {
          // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœç¼ºå°‘å…³é”®ä¿¡æ¯ï¼Œåˆ™ç›´æ¥è¿”å›
          if (!charId || !amount || isNaN(amount)) {
            console.warn(
              "updateCharacterBankBalance è°ƒç”¨å¤±è´¥ï¼šç¼ºå°‘charIdæˆ–æœ‰æ•ˆçš„amountã€‚",
            );
            return;
          }

          // ä»å…¨å±€çŠ¶æ€ä¸­è·å–è§’è‰²å¯¹è±¡
          const chat = state.chats[charId];
          // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿è§’è‰²å­˜åœ¨ä¸”ä¸æ˜¯ç¾¤èŠ
          if (!chat || chat.isGroup) {
            console.warn(
              `updateCharacterBankBalance è·³è¿‡ï¼šæ‰¾ä¸åˆ°IDä¸º ${charId} çš„è§’è‰²æˆ–è¯¥IDä¸ºç¾¤èŠã€‚`,
            );
            return;
          }

          // --- ç¡®ä¿æ•°æ®ç»“æ„å®Œæ•´ï¼Œå…¼å®¹æ—§æ•°æ® ---
          if (!chat.characterPhoneData) {
            chat.characterPhoneData = {};
          }
          if (!chat.characterPhoneData.bank) {
            chat.characterPhoneData.bank = { balance: 0, transactions: [] };
          }
          // å¦‚æœæ—§æ•°æ®çš„ä½™é¢ä¸æ˜¯æ•°å­—ï¼Œåˆ™å¼ºåˆ¶è®¾ä¸º0
          if (typeof chat.characterPhoneData.bank.balance !== "number") {
            chat.characterPhoneData.bank.balance = 0;
          }
          // å¦‚æœæ—§æ•°æ®çš„äº¤æ˜“è®°å½•ä¸æ˜¯æ•°ç»„ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„
          if (!Array.isArray(chat.characterPhoneData.bank.transactions)) {
            chat.characterPhoneData.bank.transactions = [];
          }

          // --- æ ¸å¿ƒé€»è¾‘ ---
          // 1. åˆ›å»ºä¸€æ¡æ–°çš„äº¤æ˜“è®°å½•
          const newTransaction = {
            type: amount > 0 ? "æ”¶å…¥" : "æ”¯å‡º",
            amount: Math.abs(amount), // äº¤æ˜“è®°å½•é‡Œçš„é‡‘é¢æ€»æ˜¯æ­£æ•°
            description: description,
            timestamp: Date.now(), // è®°å½•äº¤æ˜“å‘ç”Ÿçš„æ—¶é—´
          };

          // 2. æ›´æ–°ä½™é¢
          chat.characterPhoneData.bank.balance += amount;

          // 3. å°†æ–°äº¤æ˜“è®°å½•æ·»åŠ åˆ°åˆ—è¡¨çš„å¼€å¤´ï¼ˆè®©æœ€æ–°çš„æ˜¾ç¤ºåœ¨æœ€å‰é¢ï¼‰
          chat.characterPhoneData.bank.transactions.unshift(newTransaction);

          // 4. å°†æ›´æ–°åçš„è§’è‰²æ•°æ®ä¿å­˜å›æ•°æ®åº“
          await db.chats.put(chat);

          console.log(
            `âœ… é’±åŒ…åŒæ­¥æˆåŠŸ: è§’è‰²[${chat.name}], äº¤æ˜“[${description}], é‡‘é¢[${amount.toFixed(
              2,
            )}], æ–°ä½™é¢[${chat.characterPhoneData.bank.balance.toFixed(2)}]`,
          );
        }

        /**
         * æ‰“å¼€è§’è‰²æ‰‹æœºçš„å¤–è§‚è®¾ç½®é¡µé¢
         */
        function openCharPhoneAppearanceSettings() {
          renderCharPhoneAppearanceScreen(); // æ¸²æŸ“é¡µé¢å†…å®¹
          showCharacterPhonePage("character-phone-appearance-screen"); // æ˜¾ç¤ºé¡µé¢
          loadCharPhonePresetsToDropdown();
        }

        /**
         * æ¸²æŸ“è§’è‰²æ‰‹æœºçš„å¤–è§‚è®¾ç½®é¡µé¢
         */
        function renderCharPhoneAppearanceScreen() {
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];
          if (!chat) return;

          // --- æ¸²æŸ“å£çº¸é¢„è§ˆ ---
          const wallpaperPreview = document.getElementById(
            "char-phone-wallpaper-preview",
          );
          const wallpaperUrl = chat.characterPhoneData.wallpaper || "";
          if (wallpaperUrl) {
            wallpaperPreview.style.backgroundImage = `url(${wallpaperUrl})`;
            wallpaperPreview.textContent = "";
          } else {
            wallpaperPreview.style.backgroundImage = "none";
            wallpaperPreview.textContent = "æš‚æ— å£çº¸";
          }
          // --- æ¸²æŸ“Appå†…å£çº¸é¢„è§ˆ ---
          const appWallpaperPreview = document.getElementById(
            "char-phone-app-wallpaper-preview",
          );
          const appWallpaperUrl =
            newAppWallpaperBase64 || chat.characterPhoneData.appWallpaper || "";
          if (appWallpaperUrl) {
            appWallpaperPreview.style.backgroundImage = `url(${appWallpaperUrl})`;
            appWallpaperPreview.textContent = "";
          } else {
            appWallpaperPreview.style.backgroundImage = "none";
            appWallpaperPreview.textContent = "ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ ";
          }
          // --- æ¸²æŸ“Appå›¾æ ‡è®¾ç½®åˆ—è¡¨ ---
          const iconGrid = document.getElementById(
            "char-phone-icon-settings-grid",
          );
          iconGrid.innerHTML = "";
          const customIcons = chat.characterPhoneData.appIcons || {};

          CHAR_PHONE_APPS.forEach((app) => {
            const customIconUrl = customIcons[app.id];
            // ä½¿ç”¨é»˜è®¤å›¾æ ‡ä½œä¸ºå¤‡ç”¨
            const currentIconUrl =
              customIconUrl || DEFAULT_APP_ICONS[app.id] || "";
            const currentIconHtml = currentIconUrl
              ? `<img src="${currentIconUrl}" style="width:100%; height:100%; object-fit:cover;">`
              : app.svg;

            const itemEl = document.createElement("div");
            itemEl.className = "icon-setting-item";
            itemEl.dataset.iconId = app.id;
            itemEl.innerHTML = `
			            <div class="icon-preview" style="width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; padding: 8px; background: #f0f2f5;">
			                ${currentIconHtml}
			            </div>
			            <span style="font-size: 13px;">${app.name}</span>
			            <button class="change-icon-btn" data-icon-id="${app.id}" style="padding: 4px 10px; font-size: 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer;">æ›´æ¢</button>
			        `;
            iconGrid.appendChild(itemEl);
          });

          // --- æ¸²æŸ“å°ç»„ä»¶é¢„è§ˆ (é€»è¾‘ä¸å˜) ---
          const widgets = chat.characterPhoneData.widgets || {};
          const widgetPreview1 = document.getElementById(
            "char-phone-widget-preview-1",
          );
          const widgetPreview2 = document.getElementById(
            "char-phone-widget-preview-2",
          );

          if (widgets.widget1_url) {
            widgetPreview1.style.backgroundImage = `url(${widgets.widget1_url})`;
            widgetPreview1.textContent = "";
          } else {
            widgetPreview1.style.backgroundImage = "none";
            widgetPreview1.textContent = "ç‚¹å‡»ä¸Šä¼ ";
          }

          if (widgets.widget2_url) {
            widgetPreview2.style.backgroundImage = `url(${widgets.widget2_url})`;
            widgetPreview2.textContent = "";
          } else {
            widgetPreview2.style.backgroundImage = "none";
            widgetPreview2.textContent = "ç‚¹å‡»ä¸Šä¼ ";
          }
        }

        /**
         * å¤„ç†è§’è‰²æ‰‹æœºå£çº¸çš„æ›´æ¢å’Œç§»é™¤
         * @param {string} newUrl - æ–°çš„å£çº¸URLï¼Œå¦‚æœä¸ºç©ºå­—ç¬¦ä¸²åˆ™è¡¨ç¤ºç§»é™¤
         */
        async function handleCharPhoneWallpaperChange(newUrl) {
          if (!activeCharacterPhoneId) return;
          const chat = state.chats[activeCharacterPhoneId];

          chat.characterPhoneData.wallpaper = newUrl;
          await db.chats.put(chat);

          // ç«‹å³åº”ç”¨å£çº¸åˆ°è§’è‰²æ‰‹æœºä¸»å±å¹•
          const phoneScreen = document.getElementById("character-phone-screen");
          if (newUrl) {
            phoneScreen.style.backgroundImage = `url(${newUrl})`;
            phoneScreen.style.backgroundColor = "transparent";
          } else {
            phoneScreen.style.backgroundImage = "none";
            const isDarkMode = document
              .getElementById("phone-screen")
              .classList.contains("dark-mode");
            phoneScreen.style.backgroundColor = isDarkMode ? "#000" : "#f0f2f5";
          }

          // åˆ·æ–°è®¾ç½®é¡µé¢çš„é¢„è§ˆ
          renderCharPhoneAppearanceScreen();
          alert(newUrl ? "å£çº¸å·²æ›´æ–°ï¼" : "å£çº¸å·²ç§»é™¤ï¼");
        }

        /**
         * å¤„ç†è§’è‰²æ‰‹æœºAppå›¾æ ‡çš„æ›´æ¢
         * @param {string} iconId - è¦æ›´æ¢çš„Appçš„ID
         */
        async function handleChangeCharPhoneIcon(iconId) {
          if (!activeCharacterPhoneId) return;

          const choice = await showChoiceModal("æ›´æ¢å›¾æ ‡", [
            { text: "ğŸ“ ä»æœ¬åœ°ä¸Šä¼ ", value: "local" },
            { text: "ğŸŒ ä½¿ç”¨ç½‘ç»œURL", value: "url" },
            { text: "ğŸ”„ æ¢å¤é»˜è®¤", value: "reset" },
          ]);

          let newIconUrl = null;

          if (choice === "local") {
            newIconUrl = await uploadImageLocally();
          } else if (choice === "url") {
            newIconUrl = await showCustomPrompt("å›¾æ ‡URL", "è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥");
          } else if (choice === "reset") {
            const chat = state.chats[activeCharacterPhoneId];
            if (
              chat.characterPhoneData.appIcons &&
              chat.characterPhoneData.appIcons[iconId]
            ) {
              delete chat.characterPhoneData.appIcons[iconId];
              await db.chats.put(chat);
              renderCharPhoneAppearanceScreen();
              renderCharacterAppGrid();
              alert("å›¾æ ‡å·²æ¢å¤é»˜è®¤ã€‚");
            }
            return;
          }

          if (newIconUrl && newIconUrl.trim()) {
            const chat = state.chats[activeCharacterPhoneId];
            if (!chat.characterPhoneData.appIcons) {
              chat.characterPhoneData.appIcons = {};
            }
            chat.characterPhoneData.appIcons[iconId] = newIconUrl.trim();
            await db.chats.put(chat);

            renderCharPhoneAppearanceScreen(); // åˆ·æ–°è®¾ç½®é¡µé¢
            renderCharacterAppGrid(); // åˆ·æ–°ä¸»å±å¹•
            alert("å›¾æ ‡å·²æ›´æ–°ï¼");
          }
        }

        let isIntentionalStop = false;
        let isTtsPlaying = false;
        let currentTtsAudioBubble = null;

        /**
         * æŸ¥æ‰¾ä»æŒ‡å®šä½ç½®å¼€å§‹çš„æ‰€æœ‰è¿ç»­AIè¯­éŸ³æ¶ˆæ¯
         * @param {Array} history - å®Œæ•´çš„èŠå¤©å†å²è®°å½•æ•°ç»„
         * @param {number} startIndex - å¼€å§‹æŸ¥æ‰¾çš„ç´¢å¼•ä½ç½®
         * @returns {Array} - ä¸€ä¸ªåŒ…å«æ‰€æœ‰è¿ç»­AIè¯­éŸ³æ¶ˆæ¯å¯¹è±¡çš„æ•°ç»„
         */
        function findConsecutiveAiVoiceMessages(history, startIndex) {
          const messagesToPlay = [];
          if (startIndex < 0 || startIndex >= history.length) {
            return messagesToPlay;
          }

          // ä»ç‚¹å‡»çš„é‚£æ¡æ¶ˆæ¯å¼€å§‹ï¼Œå‘åéå†
          for (let i = startIndex; i < history.length; i++) {
            const msg = history[i];
            // æ£€æŸ¥è¿™æ¡æ¶ˆæ¯æ˜¯å¦æ˜¯AIå‘é€çš„ï¼Œå¹¶ä¸”ç±»å‹æ˜¯è¯­éŸ³
            if (msg.role === "assistant" && msg.type === "voice_message") {
              messagesToPlay.push(msg); // å¦‚æœæ˜¯ï¼Œå°±æŠŠå®ƒåŠ å…¥å¾…æ’­æ”¾åˆ—è¡¨
            } else {
              // ä¸€æ—¦é‡åˆ°ä¸æ˜¯AIè¯­éŸ³çš„æ¶ˆæ¯ï¼ˆæ¯”å¦‚ç”¨æˆ·çš„å›å¤ï¼Œæˆ–AIçš„å›¾ç‰‡/æ–‡å­—æ¶ˆæ¯ï¼‰ï¼Œå°±ç«‹åˆ»åœæ­¢æŸ¥æ‰¾
              break;
            }
          }
          return messagesToPlay;
        }
        /**
         * åœæ­¢å½“å‰æ­£åœ¨æ’­æ”¾çš„Minimax TTSè¯­éŸ³
         */
        function stopMinimaxAudio() {
          if (!isTtsPlaying) return;

          isIntentionalStop = true;
          const ttsPlayer = document.getElementById("tts-audio-player");
          ttsPlayer.pause();
          ttsPlayer.src = ""; // è¿™ä¼šè§¦å‘ onerror äº‹ä»¶ï¼Œä»è€Œæ‰§è¡Œæ¸…ç†

          if (window.currentAnimatingBubbles) {
            window.currentAnimatingBubbles.forEach((b) => {
              const spinner = b.querySelector(".loading-spinner");
              if (spinner) spinner.style.display = "none";
              b.classList.remove("playing");
            });
          }

          isTtsPlaying = false;
          currentTtsAudioBubble = null;
          window.currentAnimatingBubbles = null;

          setTimeout(() => {
            isIntentionalStop = false;
          }, 100);
        }

        /**
         * ã€è¾…åŠ©å‡½æ•°ã€‘å°†Hexå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯æ’­æ”¾çš„Blob URL
         * @param {string} hex - åå…­è¿›åˆ¶ç¼–ç çš„éŸ³é¢‘æ•°æ®
         * @returns {string|null} - Blob URL æˆ– null
         */
        function hexToBlobUrl(hex) {
          if (!hex) return null;
          const cleanHex = hex.replace(/[^0-9a-fA-F]/g, "");
          const length = cleanHex.length;
          if (length % 2 !== 0) {
            console.error("Hex string has an odd length.");
            return null;
          }
          const buffer = new Uint8Array(length / 2);
          for (let i = 0; i < length; i += 2) {
            buffer[i / 2] = parseInt(cleanHex.substr(i, 2), 16);
          }
          // æ ¹æ®æ–‡æ¡£ï¼Œæ¨èä½¿ç”¨ mp3 æ ¼å¼
          const blob = new Blob([buffer], { type: "audio/mpeg" });
          return URL.createObjectURL(blob);
        }

        /**
         * è°ƒç”¨ Minimax TTS API ç”Ÿæˆè¯­éŸ³å¹¶æ’­æ”¾
         * @param {string} text - è¦è½¬æ¢ä¸ºè¯­éŸ³çš„åˆå¹¶åçš„æ–‡æœ¬
         * @param {string} voiceId - Minimax çš„è¯­éŸ³ ID
         * @param {Array<HTMLElement>} bubblesToAnimate - éœ€è¦æ’­æ”¾åŠ¨ç”»çš„æ‰€æœ‰è¯­éŸ³æ°”æ³¡å…ƒç´ çš„æ•°ç»„
         */
        async function playMinimaxAudio(text, voiceId, bubblesToAnimate) {
          stopMinimaxAudio();
          await new Promise((resolve) => setTimeout(resolve, 50));

          const ttsPlayer = document.getElementById("tts-audio-player");
          const firstBubble = bubblesToAnimate[0];
          if (!firstBubble) return;

          isTtsPlaying = true;
          currentTtsAudioBubble = firstBubble;
          window.currentAnimatingBubbles = bubblesToAnimate;
          bubblesToAnimate.forEach((b) => {
            const spinner = b.querySelector(".loading-spinner");
            if (spinner) spinner.style.display = "block";
          });

          const mainAudioPlayer = document.getElementById("audio-player");
          if (mainAudioPlayer && !mainAudioPlayer.paused) {
            mainAudioPlayer.pause();
            state.musicState.isPlaying = false;
            updatePlayerUI();
          }

          const groupId = state.apiConfig.minimaxGroupId;
          const apiKey = state.apiConfig.minimaxApiKey;
          if (!groupId || !apiKey) {
            await showCustomAlert(
              "è¯­éŸ³æ’­æ”¾å¤±è´¥",
              "å°šæœªé…ç½®Minimaxçš„Group IDå’ŒAPI Keyã€‚",
            );
            stopMinimaxAudio();
            return;
          }

          const chat = state.chats[state.activeChatId];
          if (!chat) {
            stopMinimaxAudio();
            return;
          }

          const provider = state.apiConfig.minimaxProvider || "cn";
          const speechModel =
            state.apiConfig.minimaxSpeechModel || "speech-01-turbo";
          const baseUrl =
            provider === "cn"
              ? "https://api.minimaxi.com"
              : "https://api.minimax.io";
          const requestUrl = `${baseUrl}/v1/t2a_v2`;
          // 1. ä»å½“å‰è§’è‰²çš„è®¾ç½®ä¸­è¯»å–è¯­é€Ÿå’Œè¯­è¨€å¢å¼º
          const speed = chat.settings.speed ?? 1.0;
          const langBoost = chat.settings.language_boost; // å¦‚æœæ˜¯nullæˆ–undefined, å°±è®©å®ƒæ˜¯null/undefined

          const textForTts = text
            .replace(/\(.*?\)|ï¼ˆ.*?ï¼‰|ã€.*?ã€‘/g, "")
            .trim();

          // 2. æ„å»ºåŒ…å«æ–°å‚æ•°çš„è¯·æ±‚ä½“
          const requestBody = {
            model: speechModel,
            text: textForTts, // <--- æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œï¼ä½¿ç”¨è¿‡æ»¤åçš„æ–‡æœ¬
            voice_setting: {
              voice_id: voiceId,
              speed: speed, // â˜… åœ¨è¿™é‡ŒåŠ å…¥è¯­é€Ÿ
            },
          };

          // 3. å¦‚æœ language_boost æœ‰æ•ˆï¼Œæ‰å°†å®ƒæ·»åŠ åˆ°è¯·æ±‚ä½“ä¸­
          if (langBoost) {
            requestBody.language_boost = langBoost;
          }

          console.log(`[Minimax TTS] Request to ${requestUrl}`, requestBody);

          try {
            const response = await fetch(`${requestUrl}?GroupId=${groupId}`, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${apiKey}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(requestBody),
            });

            const result = await response.json();

            if (
              !response.ok ||
              (result.base_resp && result.base_resp.status_code !== 0)
            ) {
              throw new Error(
                `APIé”™è¯¯ç  ${
                  result.base_resp?.status_code || response.status
                }: ${result.base_resp?.status_msg || response.statusText}`,
              );
            }

            if (!result.data || !result.data.audio) {
              throw new Error("APIå“åº”ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„éŸ³é¢‘æ•°æ®ã€‚");
            }

            const audioUrl = hexToBlobUrl(result.data.audio);
            if (!audioUrl) {
              throw new Error("HexéŸ³é¢‘æ•°æ®è½¬æ¢å¤±è´¥ã€‚");
            }

            bubblesToAnimate.forEach((b) => {
              const spinner = b.querySelector(".loading-spinner");
              if (spinner) spinner.style.display = "none";
              b.classList.add("playing");
            });

            ttsPlayer.src = audioUrl;

            const cleanupAndReset = () => {
              if (isTtsPlaying) {
                isTtsPlaying = false;
                URL.revokeObjectURL(audioUrl);
                if (window.currentAnimatingBubbles) {
                  window.currentAnimatingBubbles.forEach((b) =>
                    b.classList.remove("playing"),
                  );
                }
                currentTtsAudioBubble = null;
                window.currentAnimatingBubbles = null;
              }
            };

            ttsPlayer.onended = cleanupAndReset;

            ttsPlayer.onerror = (e) => {
              if (!isIntentionalStop) {
                console.error("TTSéŸ³é¢‘æ’­æ”¾æ—¶å‘ç”Ÿé”™è¯¯:", e);
              }
              cleanupAndReset();
            };

            await ttsPlayer.play();
          } catch (error) {
            console.error("Minimax TTS è°ƒç”¨å¤±è´¥:", error);
            await showCustomAlert("è¯­éŸ³åˆæˆå¤±è´¥", `é”™è¯¯ä¿¡æ¯: ${error.message}`);
            stopMinimaxAudio();
          }
        }

        // è§’è‰²æ‰‹æœºå¤–è§‚é¢„è®¾åŠŸèƒ½æ ¸å¿ƒå‡½æ•°

        /**
         * å¯ç”¨æˆ–ç¦ç”¨è§’è‰²æ‰‹æœºé¢„è®¾ç®¡ç†æŒ‰é’®
         * @param {boolean} isEnabled - æ˜¯å¦å¯ç”¨
         */
        function toggleCharPhonePresetButtons(isEnabled) {
          document.getElementById("apply-char-phone-preset-btn").disabled =
            !isEnabled;
          document.getElementById("update-char-phone-preset-btn").disabled =
            !isEnabled;
          document.getElementById("rename-char-phone-preset-btn").disabled =
            !isEnabled;
          document.getElementById("delete-char-phone-preset-btn").disabled =
            !isEnabled;
          document.getElementById("export-char-phone-preset-btn").disabled =
            !isEnabled;
        }

        /**
         * åŠ è½½è§’è‰²æ‰‹æœºå¤–è§‚é¢„è®¾åˆ°ä¸‹æ‹‰æ¡†
         */
        async function loadCharPhonePresetsToDropdown() {
          const selector = document.getElementById(
            "char-phone-preset-selector",
          );
          if (!selector) return;
          selector.innerHTML = '<option value="">-- è¯·é€‰æ‹©ä¸€ä¸ªé¢„è®¾ --</option>';
          const presets = await db.charPhonePresets.toArray();
          presets.forEach((preset) => {
            const option = document.createElement("option");
            option.value = preset.id;
            option.textContent = preset.name;
            selector.appendChild(option);
          });
          activeCharPhonePresetId = null;
          toggleCharPhonePresetButtons(false);
        }

        /**
         * å½“ç”¨æˆ·ä»ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ—¶è§¦å‘
         */
        function handleCharPhonePresetSelection() {
          const selector = document.getElementById(
            "char-phone-preset-selector",
          );
          activeCharPhonePresetId = selector.value
            ? parseInt(selector.value)
            : null;
          toggleCharPhonePresetButtons(!!activeCharPhonePresetId);
        }

        async function applySelectedCharPhonePreset() {
          if (!activeCharPhonePresetId) {
            alert("è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„é¢„è®¾ã€‚");
            return;
          }
          if (!activeCharacterPhoneId) {
            alert("é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°å½“å‰æ­£åœ¨æ“ä½œçš„è§’è‰²æ‰‹æœºã€‚");
            return;
          }
          const preset = await db.charPhonePresets.get(activeCharPhonePresetId);
          const chat = state.chats[activeCharacterPhoneId];

          if (preset && preset.data && chat) {
            // å°†é¢„è®¾æ•°æ®æ·±æ‹·è´ä¸€ä»½ï¼Œåº”ç”¨åˆ°è§’è‰²çš„æ‰‹æœºæ•°æ®ä¸Š
            chat.characterPhoneData.wallpaper = preset.data.wallpaper || "";
            chat.characterPhoneData.appIcons = {
              ...DEFAULT_APP_ICONS,
              ...(preset.data.appIcons || {}),
            };
            chat.characterPhoneData.widgets = {
              ...(preset.data.widgets || {}),
            };

            // â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„ä¸€è¡Œï¼â˜…â˜…â˜…
            chat.characterPhoneData.appWallpaper =
              preset.data.appWallpaper || "";

            await db.chats.put(chat);

            // åˆ·æ–°æ‰‹æœºç•Œé¢ä»¥æ˜¾ç¤ºæ–°å¤–è§‚
            openCharacterPhone(activeCharacterPhoneId);

            // åˆ·æ–°å¤–è§‚è®¾ç½®é¡µé¢ï¼Œä»¥ä¾¿é¢„è§ˆå’Œæ•°æ®åŒæ­¥
            renderCharPhoneAppearanceScreen();

            alert(`å·²æˆåŠŸä¸ºâ€œ${chat.name}â€åº”ç”¨é¢„è®¾: "${preset.name}"ï¼`);
          } else {
            alert("åº”ç”¨é¢„è®¾å¤±è´¥ï¼Œæ‰¾ä¸åˆ°é¢„è®¾æˆ–è§’è‰²æ•°æ®ã€‚");
          }
        }

        /**
         * ä¿å­˜å½“å‰è§’è‰²æ‰‹æœºçš„å¤–è§‚è®¾ç½®ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
         */
        async function saveCurrentCharPhonePreset() {
          if (!activeCharacterPhoneId) return;

          const presetName = await showCustomPrompt(
            "ä¿å­˜é¢„è®¾",
            "è¯·ä¸ºè¿™ä¸ªå¤–è§‚æ–¹æ¡ˆèµ·ä¸ªåå­—ï¼š",
          );
          if (!presetName || !presetName.trim()) {
            if (presetName !== null) alert("åå­—ä¸èƒ½ä¸ºç©ºï¼");
            return;
          }

          const chat = state.chats[activeCharacterPhoneId];
          // ä»å½“å‰è§’è‰²çš„æ•°æ®ä¸­æå–å¤–è§‚è®¾ç½®
          const presetData = {
            wallpaper: chat.characterPhoneData.wallpaper || "",
            appIcons: { ...(chat.characterPhoneData.appIcons || {}) },
            widgets: { ...(chat.characterPhoneData.widgets || {}) },
            appWallpaper: chat.characterPhoneData.appWallpaper || "",
          };

          await db.charPhonePresets.add({
            name: presetName.trim(),
            data: presetData,
          });
          await loadCharPhonePresetsToDropdown();
          alert(`å¤–è§‚é¢„è®¾ "${presetName.trim()}" å·²ä¿å­˜ï¼`);
        }

        /**
         * æ›´æ–°å½“å‰é€‰ä¸­çš„é¢„è®¾
         */
        async function updateSelectedCharPhonePreset() {
          if (!activeCharPhonePresetId || !activeCharacterPhoneId) return;

          const currentPreset = await db.charPhonePresets.get(
            activeCharPhonePresetId,
          );
          if (!currentPreset) return;

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤æ›´æ–°",
            `ç¡®å®šè¦ç”¨å½“å‰æ‰‹æœºçš„å¤–è§‚è¦†ç›–é¢„è®¾ "${currentPreset.name}" å—ï¼Ÿ`,
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            const chat = state.chats[activeCharacterPhoneId];
            const presetData = {
              wallpaper: chat.characterPhoneData.wallpaper || "",
              appIcons: { ...(chat.characterPhoneData.appIcons || {}) },
              widgets: { ...(chat.characterPhoneData.widgets || {}) },
              appWallpaper: chat.characterPhoneData.appWallpaper || "",
            };
            await db.charPhonePresets.update(activeCharPhonePresetId, {
              data: presetData,
            });
            await showCustomAlert(
              "æˆåŠŸ",
              `é¢„è®¾ "${currentPreset.name}" å·²æ›´æ–°ï¼`,
            );
          }
        }

        /**
         * é‡å‘½åé€‰ä¸­çš„é¢„è®¾
         */
        async function renameSelectedCharPhonePreset() {
          if (!activeCharPhonePresetId) return;
          const currentPreset = await db.charPhonePresets.get(
            activeCharPhonePresetId,
          );
          const newName = await showCustomPrompt(
            "é‡å‘½å",
            "è¯·è¾“å…¥æ–°çš„åç§°ï¼š",
            currentPreset.name,
          );
          if (newName && newName.trim()) {
            await db.charPhonePresets.update(activeCharPhonePresetId, {
              name: newName.trim(),
            });
            await loadCharPhonePresetsToDropdown();
            document.getElementById("char-phone-preset-selector").value =
              activeCharPhonePresetId;
            alert("é‡å‘½åæˆåŠŸï¼");
          }
        }

        /**
         * åˆ é™¤é€‰ä¸­çš„é¢„è®¾
         */
        async function deleteSelectedCharPhonePreset() {
          if (!activeCharPhonePresetId) return;
          const currentPreset = await db.charPhonePresets.get(
            activeCharPhonePresetId,
          );
          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            `ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${currentPreset.name}" å—ï¼Ÿ`,
            {
              confirmButtonClass: "btn-danger",
            },
          );
          if (confirmed) {
            await db.charPhonePresets.delete(activeCharPhonePresetId);
            await loadCharPhonePresetsToDropdown();
            alert("é¢„è®¾å·²åˆ é™¤ã€‚");
          }
        }

        /**
         * å¯¼å‡ºé€‰ä¸­çš„é¢„è®¾
         */
        async function exportCharPhonePreset() {
          if (!activeCharPhonePresetId) return;
          const preset = await db.charPhonePresets.get(activeCharPhonePresetId);
          const blob = new Blob([JSON.stringify(preset, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `[CharPhone]${preset.name}.json`;
          a.click();
          URL.revokeObjectURL(url);
        }

        /**
         * å¯¼å…¥é¢„è®¾æ–‡ä»¶
         */
        function importCharPhonePreset(file) {
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const data = JSON.parse(e.target.result);
              if (data.name && data.data) {
                await db.charPhonePresets.add({
                  name: `${data.name} (å¯¼å…¥)`,
                  data: data.data,
                });
                await loadCharPhonePresetsToDropdown();
                alert(`é¢„è®¾ "${data.name}" å¯¼å…¥æˆåŠŸï¼`);
              } else {
                alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚");
              }
            } catch (error) {
              alert(`å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯ã€‚${error.message}`);
            }
          };
          reader.readAsText(file);
        }

        /**
         * åœ¨å¤–è§‚è®¾ç½®é¡µé¢æ¸²æŸ“å‡ºæ‰€æœ‰Appçš„åç§°è®¾ç½®é¡¹
         */
        function renderAppNameSettings() {
          const grid = document.getElementById("icon-rename-grid");
          if (!grid) return;
          grid.innerHTML = "";

          const appLabels = state.globalSettings.appLabels || {};

          // éå†é»˜è®¤æ ‡ç­¾å¯¹è±¡ï¼Œä»¥ç¡®ä¿æ‰€æœ‰appéƒ½æœ‰è®¾ç½®é¡¹
          for (const appId in DEFAULT_APP_LABELS) {
            if (DEFAULT_APP_LABELS.hasOwnProperty(appId)) {
              const defaultName = DEFAULT_APP_LABELS[appId];
              const currentName = appLabels[appId] || defaultName;

              const item = document.createElement("div");
              item.className = "form-group";
              item.style.marginBottom = "0"; // è®©å¸ƒå±€æ›´ç´§å‡‘
              item.innerHTML = `
			                <label for="rename-input-${appId}">${defaultName}</label>
			                <input type="text" id="rename-input-${appId}" class="app-rename-input" data-appid="${appId}" value="${currentName}">
			            `;
              grid.appendChild(item);
            }
          }
        }

        /**
         * å°†ä¿å­˜çš„Appåç§°åº”ç”¨åˆ°ä¸»å±å¹•çš„å›¾æ ‡ä¸Š
         */
        function applyAppLabels() {
          const appLabels = state.globalSettings.appLabels || {};

          for (const appId in DEFAULT_APP_LABELS) {
            if (DEFAULT_APP_LABELS.hasOwnProperty(appId)) {
              const defaultName = DEFAULT_APP_LABELS[appId];
              const customName = appLabels[appId] || defaultName;

              // è¿™ä¸ªé€‰æ‹©å™¨ä¼šåŒæ—¶æ‰¾åˆ°ä¸»å±å¹•å’ŒDockæ ä¸Šçš„æ‰€æœ‰å›¾æ ‡
              const icons = document.querySelectorAll(
                `.desktop-app-icon [id="icon-img-${appId}"]`,
              );

              icons.forEach((iconImg) => {
                const appIconContainer = iconImg.closest(".desktop-app-icon");
                if (appIconContainer) {
                  const labelElement = appIconContainer.querySelector(".label");
                  if (labelElement) {
                    labelElement.textContent = customName;
                  }
                }
              });
            }
          }
        }

        /**
         * ä»è¾“å…¥æ¡†è¯»å–å¹¶ä¿å­˜ç”¨æˆ·ä¿®æ”¹çš„Appåç§°
         */
        function saveAppLabels() {
          const appNameInputs = document.querySelectorAll(".app-rename-input");
          if (!state.globalSettings.appLabels) {
            state.globalSettings.appLabels = {};
          }

          appNameInputs.forEach((input) => {
            const appId = input.dataset.appid;
            const newName = input.value.trim();
            const defaultName = DEFAULT_APP_LABELS[appId];

            // å¦‚æœç”¨æˆ·è¾“å…¥äº†æ–°åå­—ï¼Œä¸”å’Œé»˜è®¤åå­—ä¸ä¸€æ ·ï¼Œå°±ä¿å­˜
            if (newName && newName !== defaultName) {
              state.globalSettings.appLabels[appId] = newName;
            } else {
              // å¦‚æœç”¨æˆ·æ¸…ç©ºäº†è¾“å…¥æ¡†ï¼Œæˆ–è€…æ”¹å›äº†é»˜è®¤åå­—ï¼Œå°±åˆ é™¤ä¿å­˜è®°å½•ï¼Œä»¥æ¢å¤é»˜è®¤
              delete state.globalSettings.appLabels[appId];
            }
          });
        }

        /**
         * å¤„ç†å¯¼å…¥çš„SillyTavernä¸–ç•Œä¹¦æ–‡ä»¶
         * @param {File} file - ç”¨æˆ·é€‰æ‹©çš„JSONæ–‡ä»¶
         */
        async function handleImportSillyTavernWorldBook(file) {
          // ä½¿ç”¨FileReaderæ¥è¯»å–æ–‡ä»¶å†…å®¹
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const text = e.target.result;
              const data = JSON.parse(text);

              // éªŒè¯æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿åŒ…å«'entries'å¯¹è±¡
              if (!data.entries || typeof data.entries !== "object") {
                throw new Error(
                  "æ–‡ä»¶æ ¼å¼æ— æ•ˆã€‚SillyTavernä¸–ç•Œä¹¦åº”åŒ…å«'entries'å¯¹è±¡ã€‚",
                );
              }

              // ä»æ–‡ä»¶åæå–åç§°ï¼Œä½œä¸ºæ–°çš„åˆ†ç±»å
              let categoryName = file.name
                .replace(/\.(json|jsonl)$/i, "")
                .trim();
              if (!categoryName) categoryName = "å¯¼å…¥çš„ä¸–ç•Œä¹¦";

              // æ£€æŸ¥è¯¥åˆ†ç±»æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
              let category = await db.worldBookCategories
                .where("name")
                .equals(categoryName)
                .first();
              if (!category) {
                const newCategoryId = await db.worldBookCategories.add({
                  name: categoryName,
                });
                category = { id: newCategoryId, name: categoryName };
                console.log(
                  `åˆ›å»ºäº†æ–°çš„ä¸–ç•Œä¹¦åˆ†ç±»: ${categoryName} (ID: ${newCategoryId})`,
                );
              } else {
                console.log(
                  `å°†æ¡ç›®æ·»åŠ åˆ°å·²å­˜åœ¨çš„åˆ†ç±»: ${categoryName} (ID: ${category.id})`,
                );
              }

              const newBooks = [];
              // éå†SillyTavern worldbookä¸­çš„æ‰€æœ‰æ¡ç›®
              for (const key in data.entries) {
                const entry = data.entries[key];

                if (entry) {
                  // ä½¿ç”¨entry.commentä½œä¸ºä¹¦åï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨"æ¡ç›® key"ä½œä¸ºå¤‡ç”¨
                  const entryName = (entry.comment || `æ¡ç›® ${key}`).trim();
                  const entryContent = (entry.content || "").trim();
                  // ç¡®ä¿ä¹¦åå’Œå†…å®¹éƒ½ä¸ä¸ºç©º
                  if (entryName && entryContent) {
                    newBooks.push({
                      id: "wb_" + Date.now() + Math.random(), // åˆ›å»ºå”¯ä¸€ID
                      name: entryName,
                      content: entryContent,
                      categoryId: category.id, // å½’å±åˆ°æ–°çš„åˆ†ç±»
                    });
                  }
                }
              }

              if (newBooks.length === 0) {
                alert("æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¯å¯¼å…¥çš„æœ‰æ•ˆæ¡ç›®ã€‚");
                return;
              }

              // æ‰¹é‡å°†æ–°ä¹¦æ·»åŠ åˆ°æ•°æ®åº“ï¼Œæ•ˆç‡æ›´é«˜
              await db.worldBooks.bulkAdd(newBooks);
              // æ›´æ–°å†…å­˜ä¸­çš„stateï¼Œä»¥ä¾¿UIèƒ½ç«‹å³åˆ·æ–°
              state.worldBooks.push(...newBooks);

              // é‡æ–°æ¸²æŸ“ä¸–ç•Œä¹¦åˆ—è¡¨ï¼Œæ˜¾ç¤ºæ–°å†…å®¹
              await renderWorldBookScreen();
              await showCustomAlert(
                "å¯¼å…¥æˆåŠŸ",
                `æˆåŠŸå°†ã€Š${categoryName}ã€‹ä¸­çš„ ${newBooks.length} ä¸ªæ¡ç›®å¯¼å…¥åˆ°ä¸–ç•Œä¹¦ï¼`,
              );
            } catch (error) {
              console.error("å¯¼å…¥ä¸–ç•Œä¹¦å¤±è´¥:", error);
              await showCustomAlert(
                "å¯¼å…¥å¤±è´¥",
                `æ— æ³•è§£ææ–‡ä»¶ï¼Œè¯·ç¡®ä¿å®ƒæ˜¯æœ‰æ•ˆçš„SillyTavernä¸–ç•Œä¹¦JSONæ–‡ä»¶ã€‚\n\né”™è¯¯: ${error.message}`,
              );
            }
          };
          // ä»¥UTF-8ç¼–ç è¯»å–æ–‡ä»¶å†…å®¹
          reader.readAsText(file, "UTF-8");
        }

        // å¿ƒå£°èƒŒæ™¯æ›´æ¢åŠŸèƒ½æ ¸å¿ƒå‡½æ•°

        /**
         * å½“ç”¨æˆ·ç‚¹å‡»â€œæ›´æ¢èƒŒæ™¯â€æŒ‰é’®æ—¶ï¼Œå¼¹å‡ºæ“ä½œèœå•
         */
        async function handleInnerVoiceBgChange() {
          const choice = await showChoiceModal("æ›´æ¢å¿ƒå£°èƒŒæ™¯", [
            { text: "ä¸Šä¼ æ–°èƒŒæ™¯", value: "upload" },
            { text: "æ¢å¤é»˜è®¤", value: "reset" },
          ]);

          if (choice === "upload") {
            // è§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨
            document.getElementById("inner-voice-bg-input").click();
          } else if (choice === "reset") {
            // è°ƒç”¨ä¿å­˜å‡½æ•°å¹¶ä¼ å…¥ç©ºå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºæ¢å¤é»˜è®¤
            await saveInnerVoiceBackground("");
          }
        }

        /**
         * ä¿å­˜æ–°çš„èƒŒæ™¯å›¾ç‰‡URLåˆ°ã€å½“å‰è§’è‰²ã€‘
         * @param {string} url - å›¾ç‰‡çš„URL (å¯ä»¥æ˜¯ç½‘ç»œé“¾æ¥æˆ–Base64)
         */
        async function saveInnerVoiceBackground(url) {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          // 1. å°†èƒŒæ™¯URLä¿å­˜åœ¨å½“å‰è§’è‰²çš„æ•°æ®ä¸­
          chat.innerVoiceBackground = url;

          // 2. å°†æ›´æ–°åçš„æ•´ä¸ª chat å¯¹è±¡ä¿å­˜å›æ•°æ®åº“
          await db.chats.put(chat);

          // 3. ç«‹å³åº”ç”¨æ–°çš„èƒŒæ™¯
          applyInnerVoiceBackground(url);

          // 4. ç»™ç”¨æˆ·ä¸€ä¸ªåé¦ˆ
          alert(url ? "å½“å‰è§’è‰²èƒŒæ™¯å·²æ›´æ–°ï¼" : "å½“å‰è§’è‰²èƒŒæ™¯å·²æ¢å¤é»˜è®¤ã€‚");
        }

        /**
         * å°†æŒ‡å®šçš„èƒŒæ™¯å›¾åº”ç”¨åˆ°å¿ƒå£°é¢æ¿ä¸Š
         * @param {string} url - å›¾ç‰‡çš„URL
         */
        function applyInnerVoiceBackground(url) {
          const panel = document.getElementById("inner-voice-main-panel");
          if (!panel) return;

          if (url) {
            panel.style.backgroundImage = `url(${url})`;
          } else {
            // å¦‚æœURLä¸ºç©ºï¼Œå°±ç§»é™¤èƒŒæ™¯å›¾ï¼Œæ¢å¤CSSä¸­å®šä¹‰çš„é»˜è®¤æ ·å¼
            panel.style.backgroundImage = "none";
          }
        }

        function calculateTokenCount(text) {
          if (!text) return 0;
          // ç®€å•ä¼°ç®—ï¼šå¦‚æœæ˜¯ä¸­æ–‡ç¯å¢ƒï¼Œé€šå¸¸å¯ä»¥ç›´æ¥ç”¨å­—ç¬¦æ•°ä½œä¸ºå‚è€ƒ
          // æˆ–è€…ç²—ç•¥ä¼°ç®—ï¼šToken â‰ˆ å­—ç¬¦æ•°
          // å¦‚æœä½ æƒ³æ˜¾ç¤ºçš„æ•°å€¼å°ä¸€ç‚¹ï¼ˆæ›´æ¥è¿‘GPTçš„Tokenï¼‰ï¼Œå¯ä»¥ä¹˜ä»¥ 0.7
          return text.length;
        }

        /**
         * ã€å‡çº§ç‰ˆã€‘è·å–Tokenè¯¦æƒ… + å¼‚å¸¸æ¶ˆæ¯æ£€æµ‹
         * @param {string} chatId - ç›®æ ‡èŠå¤©çš„ID
         */
        async function getTokenDetailedBreakdown(chatId) {
          const chat = state.chats[chatId];
          if (!chat) return null;

          const settings = chat.settings;
          const breakdown = [];
          const outlierThreshold = 300; // è®¾å®šé˜ˆå€¼ï¼šè¶…è¿‡300å­—ç¬¦è¢«è§†ä¸º"å¤§æ¶ˆæ¯"
          let outliers = []; // ç”¨äºå­˜å‚¨å¼‚å¸¸å¤§çš„æ¶ˆæ¯

          // ... (å‰1-4éƒ¨åˆ†ä¿æŒä¸å˜: äººè®¾ã€ä¸–ç•Œä¹¦ã€è¡¨æƒ…åŒ…ã€æ€»ç»“) ...
          // 1. æ ¸å¿ƒäººè®¾
          let personaText = chat.isGroup
            ? `ç¾¤èŠ...${chat.members.map((m) => m.persona).join("")}`
            : (chat.settings.aiPersona || "") + (chat.settings.myPersona || "");
          breakdown.push({
            name: "æ ¸å¿ƒäººè®¾",
            count: calculateTokenCount(personaText),
          });

          // 2. ä¸–ç•Œä¹¦
          let wbText = "";
          if (settings.linkedWorldBookIds) {
            wbText = settings.linkedWorldBookIds
              .map((id) => {
                const b = state.worldBooks.find((wb) => wb.id === id);
                return b ? b.content : "";
              })
              .join("");
          }
          breakdown.push({
            name: "ä¸–ç•Œä¹¦",
            count: calculateTokenCount(wbText),
          });

          // 3. è¡¨æƒ…åŒ…å®šä¹‰
          let stickerText = "";
          const allStickers = [
            ...(settings.stickerLibrary || []),
            ...(state.charStickers || []),
          ];
          if (allStickers.length > 0)
            stickerText = allStickers.map((s) => s.name).join("");
          breakdown.push({
            name: "è¡¨æƒ…åŒ…å®šä¹‰",
            count: calculateTokenCount(stickerText),
          });

          // 4. é•¿æœŸè®°å¿†
          const summaryText = chat.history
            .filter((m) => m.type === "summary")
            .map((s) => s.content)
            .join("");
          breakdown.push({
            name: "é•¿æœŸè®°å¿†(æ€»ç»“)",
            count: calculateTokenCount(summaryText),
          });

          // 5. çŸ­æœŸè®°å¿† (å¯¹è¯) - ã€æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†ã€‘
          const history = chat.history.filter((msg) => !msg.isHidden);
          const memoryDepth = settings.maxMemory || 10;
          const contextMessages = history.slice(-memoryDepth);

          let userMsgLen = 0;
          let aiMsgLen = 0;

          contextMessages.forEach((msg) => {
            let content =
              typeof msg.content === "string"
                ? msg.content
                : JSON.stringify(msg.content);
            let len = calculateTokenCount(content);

            // --- å¼‚å¸¸æ£€æµ‹é€»è¾‘ ---
            if (len > outlierThreshold) {
              outliers.push({
                role: msg.role,
                preview: content.substring(0, 15) + "...", // é¢„è§ˆå‰15ä¸ªå­—
                count: len,
                timestamp: msg.timestamp, // ç”¨äºè·³è½¬
              });
            }
            // ------------------

            if (msg.role === "user") userMsgLen += len;
            else aiMsgLen += len;
          });

          // å¯¹å¼‚å¸¸æ¶ˆæ¯æŒ‰å¤§å°æ’åº (æœ€å¤§çš„åœ¨å‰é¢)
          outliers.sort((a, b) => b.count - a.count);

          breakdown.push({ name: "çŸ­æœŸè®°å¿†(ç”¨æˆ·)", count: userMsgLen });
          breakdown.push({ name: "çŸ­æœŸè®°å¿†(AI)", count: aiMsgLen });
          breakdown.push({ name: "ç³»ç»Ÿæ ¼å¼æŒ‡ä»¤", count: 800 });

          // è¿”å›æ•°æ®å¢åŠ äº† outliers å­—æ®µ
          return { items: breakdown, outliers: outliers };
        }

        /**
         * ä¸ºTokenè®¡ç®—å‡†å¤‡å®Œæ•´çš„ä¸Šä¸‹æ–‡å’Œæç¤ºè¯
         * @param {string} chatId - ç›®æ ‡èŠå¤©çš„ID
         * @returns {Promise<string>} - æ‹¼æ¥å¥½çš„ã€å°†è¦å‘é€ç»™AIçš„å®Œæ•´æ–‡æœ¬
         */
        async function getContextForTokenCalculation(chatId) {
          const chat = state.chats[chatId];
          if (!chat) return "";

          let combinedText = "";
          const settings = chat.settings;

          // 1. æ·»åŠ æ ¸å¿ƒæç¤ºè¯ (äººè®¾)
          if (chat.isGroup) {
            const membersList = chat.members
              .map((m) => `- **${m.originalName}**: ${m.persona}`)
              .join("\n");
            const myNickname = chat.settings.myNickname || "æˆ‘";
            combinedText += `ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAI... # ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾\n${membersList}\n# ç”¨æˆ·çš„è§’è‰²\n- **${myNickname}**: ${chat.settings.myPersona}`;
          } else {
            combinedText += chat.settings.aiPersona || "";
            combinedText += chat.settings.myPersona || "";
          }

          // 2. æ·»åŠ ä¸–ç•Œä¹¦å†…å®¹
          if (
            settings.linkedWorldBookIds &&
            settings.linkedWorldBookIds.length > 0
          ) {
            const linkedContents = settings.linkedWorldBookIds
              .map((bookId) => {
                const worldBook = state.worldBooks.find(
                  (wb) => wb.id === bookId,
                );
                return worldBook ? worldBook.content : "";
              })
              .join("\n");
            combinedText += linkedContents;
          }

          // 3. æ·»åŠ æ‰€æœ‰æ€»ç»“ä½œä¸ºé•¿æœŸè®°å¿†
          const summaryContext = chat.history
            .filter((msg) => msg.type === "summary")
            .map((s) => s.content)
            .join("\n");
          combinedText += summaryContext;

          // 4. æ·»åŠ æœ€è¿‘çš„å¯¹è¯è®°å½• (ä¸Šä¸‹æ–‡è®°å¿†)
          const history = chat.history.filter((msg) => !msg.isHidden);
          const memoryDepth = settings.maxMemory || 10;
          const contextMessages = history.slice(-memoryDepth);

          const messageText = contextMessages
            .map((msg) => {
              let content = "";
              if (typeof msg.content === "string") {
                content = msg.content;
              } else if (Array.isArray(msg.content)) {
                content = "[å›¾ç‰‡]"; // å°†å›¾ç‰‡ç®€åŒ–ä¸ºå ä½ç¬¦
              } else if (msg.type) {
                content = `[${msg.type}]`;
              }
              const sender =
                msg.role === "user" ? "ç”¨æˆ·" : msg.senderName || chat.name;
              return `${sender}: ${content}`;
            })
            .join("\n");

          combinedText += "\n" + messageText;

          return combinedText;
        }
        /**
         * æ¸…ç†æ‰€æœ‰ä¸å·²åˆ é™¤è§’è‰²å…³è”çš„å¤±æ•ˆæ•°æ®
         */
        async function clearOrphanedData() {
          // 1. åœ¨æ‰§è¡Œæ•æ„Ÿæ“ä½œå‰ï¼Œå…ˆå¼¹çª—å‘ç”¨æˆ·ç¡®è®¤
          const confirmed = await showCustomConfirm(
            "ç¡®è®¤æ¸…ç†",
            "æ­¤æ“ä½œå°†æ‰«æå¹¶åˆ é™¤æ‰€æœ‰ä¸ã€å·²ä¸å­˜åœ¨çš„è§’è‰²ã€‘å…³è”çš„æ•°æ®ï¼ˆå¦‚åŠ¨æ€ã€å¾®åšã€å›å¿†ã€é€šè¯è®°å½•ç­‰ï¼‰ï¼Œé‡Šæ”¾å­˜å‚¨ç©ºé—´ã€‚\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ",
            { confirmButtonClass: "btn-danger" }, // ä½¿ç”¨é†’ç›®çš„çº¢è‰²æŒ‰é’®
          );

          // å¦‚æœç”¨æˆ·ç‚¹äº†â€œå–æ¶ˆâ€ï¼Œåˆ™ç›´æ¥é€€å‡º
          if (!confirmed) return;

          // æ˜¾ç¤ºä¸€ä¸ªâ€œå¤„ç†ä¸­â€çš„æç¤ºï¼Œé¿å…ç”¨æˆ·ä»¥ä¸ºç¨‹åºå¡æ­»
          await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨æ‰«æå¹¶æ¸…ç†å¤±æ•ˆæ•°æ®...");

          try {
            let totalDeletedCount = 0;

            // 2. è·å–æ‰€æœ‰ä»ç„¶å­˜åœ¨çš„ã€æœ‰æ•ˆçš„è§’è‰²IDåˆ—è¡¨
            const validChatIds = new Set(
              (await db.chats.toArray()).map((c) => c.id),
            );
            validChatIds.add("user"); // 'user' (å³â€œæˆ‘â€) æ°¸è¿œæ˜¯æœ‰æ•ˆçš„ä½œè€…

            // 3. å®šä¹‰æˆ‘ä»¬éœ€è¦æ£€æŸ¥çš„æ•°æ®åº“è¡¨å’Œå®ƒä»¬ç”¨æ¥å…³è”è§’è‰²IDçš„å­—æ®µå
            const tablesToCheck = [
              { name: "qzonePosts", idField: "authorId", typeName: "åŠ¨æ€" },
              { name: "weiboPosts", idField: "authorId", typeName: "å¾®åš" },
              { name: "memories", idField: "chatId", typeName: "å›å¿†/çº¦å®š" },
              { name: "callRecords", idField: "chatId", typeName: "é€šè¯è®°å½•" },
            ];

            // 4. éå†æ¯ä¸€ä¸ªéœ€è¦æ£€æŸ¥çš„è¡¨
            for (const tableInfo of tablesToCheck) {
              const table = db[tableInfo.name];
              const allItems = await table.toArray();

              // æ‰¾å‡ºæ‰€æœ‰ä½œè€…IDå·²ç»ä¸å­˜åœ¨çš„â€œå­¤å„¿â€æ•°æ®
              const idsToDelete = allItems
                .filter((item) => !validChatIds.has(item[tableInfo.idField]))
                .map((item) => item.id);

              // å¦‚æœæ‰¾åˆ°äº†éœ€è¦åˆ é™¤çš„æ•°æ®
              if (idsToDelete.length > 0) {
                await table.bulkDelete(idsToDelete); // æ‰¹é‡åˆ é™¤ï¼Œæ•ˆç‡æ›´é«˜
                console.log(
                  `ä» ${tableInfo.name} è¡¨ä¸­æ¸…é™¤äº† ${idsToDelete.length} æ¡å¤±æ•ˆæ•°æ®ã€‚`,
                );
                totalDeletedCount += idsToDelete.length;
              }
            }

            // 5. æ ¹æ®æ¸…ç†ç»“æœï¼Œç»™ç”¨æˆ·æœ€ç»ˆçš„åé¦ˆ
            if (totalDeletedCount > 0) {
              await showCustomAlert(
                "æ¸…ç†å®Œæˆ",
                `å·²æˆåŠŸæ¸…ç† ${totalDeletedCount} æ¡å¤±æ•ˆæ•°æ®ï¼`,
              );
            } else {
              await showCustomAlert("æ‰«æå®Œæˆ", "æœªå‘ç°ä»»ä½•å¯æ¸…ç†çš„å¤±æ•ˆæ•°æ®ã€‚");
            }
          } catch (error) {
            console.error("æ¸…ç†å¤±æ•ˆæ•°æ®æ—¶å‡ºé”™:", error);
            await showCustomAlert(
              "æ“ä½œå¤±è´¥",
              `æ¸…ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`,
            );
          }
        }

        /**
         * å¤„ç†å–æ¶ˆæƒ…ä¾£ç©ºé—´
         */
        async function handleCancelLoversSpace() {
          if (!activeLoversSpaceCharId) return;
          const confirmed = await showCustomConfirm(
            "å–æ¶ˆæƒ…ä¾£ç©ºé—´",
            "ç¡®å®šè¦å–æ¶ˆæƒ…ä¾£ç©ºé—´å—ï¼Ÿè¿™ä¼šä½¿ç©ºé—´å˜ä¸ºæœªå¯ç”¨çŠ¶æ€ï¼Œä½†æ‰€æœ‰æ•°æ®ï¼ˆè¯´è¯´ã€ç…§ç‰‡ç­‰ï¼‰éƒ½ä¼šè¢«ä¿ç•™ã€‚æ­¤æ“ä½œä¸ä¼šé€šçŸ¥å¯¹æ–¹ã€‚",
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            const chat = state.chats[activeLoversSpaceCharId];
            if (chat && chat.loversSpaceData) {
              // å°†æƒ…ä¾£ç©ºé—´æ•°æ®è®¾ç½®ä¸ºnullï¼Œå³å¯ç¦ç”¨å®ƒ
              chat.loversSpaceData = null;
              await db.chats.put(chat);
              document
                .getElementById("ls-settings-modal")
                .classList.remove("visible");
              alert("æƒ…ä¾£ç©ºé—´å·²å–æ¶ˆã€‚");
              // è¿”å›åˆ°èŠå¤©åˆ—è¡¨ä¸»å±å¹•
              showScreen("chat-list-screen");
            }
          }
        }

        /**
         * å¤„ç†è§£é™¤æƒ…ä¾£å…³ç³»
         */
        async function handleDisconnectLoversSpace() {
          if (!activeLoversSpaceCharId) return;
          const chat = state.chats[activeLoversSpaceCharId];
          if (!chat) return;

          const confirmed = await showCustomConfirm(
            "è§£é™¤å…³ç³»",
            `ç¡®å®šè¦ä¸â€œ${chat.name}â€è§£é™¤å…³ç³»å—ï¼Ÿæƒ…ä¾£ç©ºé—´å°†è¢«å–æ¶ˆï¼Œå¹¶ä¸”å¯¹æ–¹ä¼šæ”¶åˆ°é€šçŸ¥å¹¶å¯¹æ­¤å‘è¡¨æ„è§ã€‚`,
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            // 1. ç¦ç”¨ç©ºé—´
            chat.loversSpaceData = null;

            // 2. åˆ›å»ºæ‚¨å‘å‡ºçš„ã€åœ¨å³ä¾§çš„â€œè§£é™¤å¡ç‰‡â€
            const userDisconnectCardMessage = {
              role: "user",
              type: "lovers_space_disconnect", // ä¸€ä¸ªæ–°ç±»å‹ï¼Œç”¨äºæ¸²æŸ“å¡ç‰‡
              content: `æƒ…ä¾£ç©ºé—´å·²è§£é™¤`, // å¡ç‰‡åº•å±‚å¯ç¼–è¾‘çš„æ–‡å­—
              timestamp: Date.now(),
            };
            chat.history.push(userDisconnectCardMessage);

            // 3. åˆ›å»ºå±…ä¸­çš„ã€ç°è‰²çš„â€œç³»ç»Ÿé€šçŸ¥â€
            const systemNotification = {
              role: "system",
              type: "pat_message", // å¤ç”¨â€œæ‹ä¸€æ‹â€çš„å±…ä¸­ç°è‰²æ°”æ³¡æ ·å¼
              content: `ä½ å’Œ ${chat.name} çš„æƒ…ä¾£ç©ºé—´å·²è§£é™¤`,
              timestamp: Date.now() + 1, // æ—¶é—´æˆ³+1ç¡®ä¿åœ¨å¡ç‰‡ä¹‹å
            };
            chat.history.push(systemNotification);

            // 4. ç»™AIçœ‹çš„éšè—æŒ‡ä»¤
            const hiddenMessageForAI = {
              role: "system",
              content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·åˆšåˆšè§£é™¤äº†ä¸ä½ çš„æƒ…ä¾£å…³ç³»ã€‚]`,
              timestamp: Date.now() + 2, // æ—¶é—´æˆ³å†+1
              isHidden: true,
            };
            chat.history.push(hiddenMessageForAI);

            // 5. ä¿å­˜ã€å…³é—­å¼¹çª—ã€è·³è½¬ã€è§¦å‘å›åº”
            await db.chats.put(chat);
            document
              .getElementById("ls-settings-modal")
              .classList.remove("visible");
            document
              .getElementById("lovers-space-screen")
              .classList.remove("visible");

            openChat(activeLoversSpaceCharId);

            alert("å…³ç³»å·²è§£é™¤ï¼Œå¯¹æ–¹å·²çŸ¥æ™“ã€‚");
            triggerAiResponse();
          }
        }

        /**
         * æ‰“å¼€æ‰‹åŠ¨æ€»ç»“çš„æ¨¡å¼é€‰æ‹©å¼¹çª—
         */
        async function openManualSummaryOptions() {
          const choice = await showChoiceModal("æ‰‹åŠ¨æ€»ç»“", [
            { text: "æ€»ç»“æœ€æ–°å†…å®¹", value: "latest" },
            { text: "æ€»ç»“æŒ‡å®šèŒƒå›´", value: "range" },
          ]);

          if (choice === "latest") {
            // ç”¨æˆ·é€‰æ‹©æ€»ç»“æœ€æ–°ï¼Œè°ƒç”¨ä¸»å‡½æ•°å¹¶ä¼ å…¥'latest'æ¨¡å¼
            await triggerManualSummaryNow("latest");
          } else if (choice === "range") {
            // ç”¨æˆ·é€‰æ‹©æ€»ç»“èŒƒå›´ï¼Œè°ƒç”¨èŒƒå›´è¾“å…¥å‡½æ•°
            await promptForSummaryRange();
          }
        }

        /**
         * æç¤ºç”¨æˆ·è¾“å…¥è¦æ€»ç»“çš„æ¶ˆæ¯èŒƒå›´
         */
        async function promptForSummaryRange() {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const totalMessages = chat.history.length;
          if (totalMessages === 0) {
            alert("èŠå¤©è®°å½•ä¸ºç©ºï¼Œæ— æ³•è¿›è¡Œæ€»ç»“ã€‚");
            return;
          }

          // å¼¹å‡ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·è¾“å…¥å¼€å§‹åºå·
          const startStr = await showCustomPrompt(
            "æŒ‡å®šèŒƒå›´",
            `è¯·è¾“å…¥å¼€å§‹çš„æ¶ˆæ¯åºå· (1 - ${totalMessages})`,
            "1",
            "number",
          );
          if (startStr === null) return; // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆ

          const startNum = parseInt(startStr);
          if (isNaN(startNum) || startNum < 1 || startNum > totalMessages) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å¼€å§‹åºå·ã€‚");
            return;
          }

          // å¼¹å‡ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·è¾“å…¥ç»“æŸåºå·
          const endStr = await showCustomPrompt(
            "æŒ‡å®šèŒƒå›´",
            `è¯·è¾“å…¥ç»“æŸçš„æ¶ˆæ¯åºå· (${startNum} - ${totalMessages})`,
            totalMessages,
            "number",
          );
          if (endStr === null) return; // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆ

          const endNum = parseInt(endStr);
          if (isNaN(endNum) || endNum < startNum || endNum > totalMessages) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç»“æŸåºå·ã€‚");
            return;
          }

          // è°ƒç”¨ä¸»å‡½æ•°å¹¶ä¼ å…¥'range'æ¨¡å¼å’Œå…·ä½“çš„èŒƒå›´
          await triggerManualSummaryNow("range", {
            start: startNum,
            end: endNum,
          });
        }

        /**
         * å°†æ—¶é—´å­—ç¬¦ä¸²ï¼ˆå¦‚ "20:00", "æ—©ä¸Š9ç‚¹"ï¼‰è§£æä¸ºåˆ†é’Ÿæ•°
         * @param {string} timeStr - æ—¶é—´å­—ç¬¦ä¸²
         * @returns {number} - ä»åˆå¤œ0ç‚¹å¼€å§‹çš„åˆ†é’Ÿæ•°
         */
        function parseTime(timeStr) {
          if (!timeStr || typeof timeStr !== "string") return -1; // é”™è¯¯æˆ–æ— æ•ˆè¾“å…¥è¿”å›-1

          let hours = 0;
          let minutes = 0;

          // åŒ¹é… "HH:mm" æˆ– "H:mm" æ ¼å¼
          const match = timeStr.match(/(\d{1,2}):(\d{2})/);
          if (match) {
            hours = parseInt(match[1], 10);
            minutes = parseInt(match[2], 10);
          } else {
            // å¦‚æœä¸æ˜¯æ ‡å‡†æ ¼å¼ï¼Œå°è¯•åŒ¹é…ä¸­æ–‡æè¿°
            const numMatch = timeStr.match(/(\d+)/);
            const num = numMatch ? parseInt(numMatch[0], 10) : -1;

            if (num !== -1) {
              if (timeStr.includes("ä¸‹åˆ") || timeStr.includes("æ™šä¸Š")) {
                // ä¸‹åˆ1ç‚¹(13ç‚¹)åˆ°æ™šä¸Š11ç‚¹(23ç‚¹)
                if (num < 12) {
                  hours = num + 12;
                } else {
                  hours = num; // å¦‚æœå·²ç»æ˜¯24å°æ—¶åˆ¶å¦‚â€œæ™šä¸Š20ç‚¹â€ï¼Œç›´æ¥ä½¿ç”¨
                }
              } else {
                // æ—©ä¸Šæˆ–ä¸Šåˆ
                hours = num;
              }
            } else {
              return -1; // æ— æ³•è§£æ
            }
          }

          // å¤„ç†ç‰¹æ®Šæƒ…å†µï¼Œå¦‚æ™šä¸Š12ç‚¹åº”ä¸º0ç‚¹
          if (
            (timeStr.includes("æ™šä¸Š") || timeStr.includes("å‡Œæ™¨")) &&
            hours === 12
          ) {
            hours = 0;
          }
          // å¤„ç†ä¸‹åˆ12ç‚¹åº”ä¸º12ç‚¹
          if (
            (timeStr.includes("ä¸‹åˆ") || timeStr.includes("ä¸­åˆ")) &&
            hours === 24
          ) {
            hours = 12;
          }

          return hours * 60 + minutes;
        }
        /**
         * æ£€æŸ¥å¹¶æ›´æ–°ç«èŠ±å¤©æ•° (å·²ä¿®å¤ç†„ç­åä»1å¼€å§‹çš„é—®é¢˜)
         * @param {string} chatId - è¦æ›´æ–°ç«èŠ±çš„èŠå¤©ID
         * @returns {Promise<boolean>} - å¦‚æœç«èŠ±å¤©æ•°æœ‰å˜åŒ–ï¼Œåˆ™è¿”å›true
         */
        async function updateStreak(chatId) {
          const chat = state.chats[chatId];
          // å¦‚æœä¸æ˜¯å•èŠï¼Œæˆ–è€…åŠŸèƒ½æœªå¼€å¯ï¼Œç›´æ¥è¿”å›
          if (!chat || chat.isGroup || !chat.settings.streak?.enabled) {
            return false;
          }

          const streak = chat.settings.streak;
          const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DDæ ¼å¼

          // å¦‚æœä»Šå¤©å·²ç»äº’åŠ¨è¿‡äº†ï¼Œå°±ä»€ä¹ˆéƒ½ä¸åš
          if (streak.lastInteractionDate === today) {
            return false;
          }

          let changed = false;

          // æ£€æŸ¥ç«èŠ±æ˜¯å¦å·²ç†„ç­
          if (streak.lastInteractionDate && streak.extinguishThreshold !== -1) {
            const lastDate = new Date(streak.lastInteractionDate);
            const todayDate = new Date(today);
            // ä¸ºäº†ç²¾ç¡®è®¡ç®—å¤©æ•°å·®å¼‚ï¼Œæˆ‘ä»¬å°†ä¸¤ä¸ªæ—¥æœŸéƒ½è®¾ç½®ä¸ºUTCæ—¶é—´çš„åˆå¤œ
            const lastDateUTC = Date.UTC(
              lastDate.getFullYear(),
              lastDate.getMonth(),
              lastDate.getDate(),
            );
            const todayDateUTC = Date.UTC(
              todayDate.getFullYear(),
              todayDate.getMonth(),
              todayDate.getDate(),
            );

            const daysDiff =
              (todayDateUTC - lastDateUTC) / (1000 * 60 * 60 * 24);

            if (daysDiff >= streak.extinguishThreshold) {
              // å¦‚æœæ–­è”å¤©æ•°è¾¾åˆ°äº†ä½ è®¾ç½®çš„é˜ˆå€¼ï¼Œå°±å°†å½“å‰ç«èŠ±å¤©æ•°å½’é›¶ã€‚
              streak.currentDays = 0;
              console.log(
                `ğŸ”¥ ä¸ ${chat.name} çš„ç«èŠ±å› è¶…è¿‡ ${streak.extinguishThreshold} å¤©æœªè”ç³»è€Œç†„ç­ï¼Œå°†é‡æ–°ä» 1 å¼€å§‹è®¡ç®—ã€‚`,
              );
              changed = true;
            }
          }

          // ä»Šå¤©æ˜¯æ–°çš„äº’åŠ¨æ—¥ï¼Œå¤©æ•°+1
          // å¦‚æœæ˜¯æ°¸ä¸ç†„ç­æ¨¡å¼ï¼ŒcurrentDays ä¸º -1, ä¸åº”è¯¥å¢åŠ 
          if (streak.currentDays >= 0) {
            streak.currentDays++;
            changed = true;
          }

          // æ— è®ºç«èŠ±æ˜¯å¦ç†„ç­ï¼Œåªè¦ä»Šå¤©äº’åŠ¨äº†ï¼Œå°±æŠŠâ€œæœ€åäº’åŠ¨æ—¥æœŸâ€æ›´æ–°ä¸ºä»Šå¤©ã€‚
          streak.lastInteractionDate = today;

          await db.chats.put(chat);

          if (changed) {
            console.log(
              `ğŸ”¥ ä¸ ${chat.name} çš„ç«èŠ±å¤©æ•°æ›´æ–°ä¸º: ${streak.currentDays}`,
            );
          }

          return changed; // è¿”å›æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–
        }

        /**
         * å¤„ç†è®¾ç½®/å–æ¶ˆç®¡ç†å‘˜
         */
        async function handleToggleAdmin(memberId) {
          const chat = state.chats[state.activeChatId];
          // æƒé™æ£€æŸ¥ï¼šç¡®ä¿æ“ä½œè€…æ˜¯ç¾¤ä¸»
          if (!chat || chat.ownerId !== "user") {
            alert("ä½ ä¸æ˜¯ç¾¤ä¸»ï¼Œæ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œï¼");
            return;
          }

          let targetNickname;
          let isAdminNow;

          // 1. åˆ¤æ–­æ“ä½œç›®æ ‡æ˜¯ä¸æ˜¯ç”¨æˆ·è‡ªå·±
          if (memberId === "user") {
            // å¦‚æœæ˜¯ç”¨æˆ·ï¼Œå°±ä¿®æ”¹ chat.settings é‡Œçš„ä¸“å±æ ‡å¿—
            // æˆ‘ä»¬ä½¿ç”¨ isUserAdmin å±æ€§æ¥è®°å½•ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
            chat.settings.isUserAdmin = !chat.settings.isUserAdmin;
            targetNickname = chat.settings.myNickname || "æˆ‘";
            isAdminNow = chat.settings.isUserAdmin;
          } else {
            // å¦‚æœæ˜¯å…¶ä»–æˆå‘˜ï¼Œä¿æŒåŸæœ‰é€»è¾‘ä¸å˜
            const member = chat.members.find((m) => m.id === memberId);
            if (!member) return;

            // ä¸èƒ½å°†ç¾¤ä¸»è®¾ä¸ºç®¡ç†å‘˜æˆ–å–æ¶ˆå…¶ç®¡ç†å‘˜èº«ä»½
            if (member.id === chat.ownerId) {
              alert("ä¸èƒ½å¯¹ç¾¤ä¸»è¿›è¡Œæ­¤æ“ä½œã€‚");
              return;
            }

            member.isAdmin = !member.isAdmin;
            targetNickname = member.groupNickname;
            isAdminNow = member.isAdmin;
          }

          await db.chats.put(chat);

          // å‡†å¤‡å¹¶å‘é€ç³»ç»Ÿé€šçŸ¥æ¶ˆæ¯
          const actionText = isAdminNow ? "è®¾ä¸ºç®¡ç†å‘˜" : "å–æ¶ˆäº†ç®¡ç†å‘˜èº«ä»½";
          const myNickname = chat.settings.myNickname || "æˆ‘";
          // è¿™é‡Œæˆ‘ä»¬ç”¨ logSystemMessage å‡½æ•°æ¥å‘é€é€šçŸ¥ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ·æ–°UI
          await logSystemMessage(
            chat.id,
            `â€œ${myNickname}â€å°†â€œ${targetNickname}â€${actionText}ã€‚`,
          );

          // åˆ·æ–°æˆå‘˜ç®¡ç†åˆ—è¡¨çš„æ˜¾ç¤º
          renderMemberManagementList();
        }

        /**
         * å¤„ç†è®¾ç½®ç¾¤æˆå‘˜å¤´è¡”
         */
        async function handleSetMemberTitle(memberId) {
          const chat = state.chats[state.activeChatId];
          // æƒé™æ£€æŸ¥ï¼šç¾¤ä¸»æˆ–ç®¡ç†å‘˜æ‰èƒ½è®¾ç½®
          const isOwner = chat.ownerId === "user";
          const isAdmin = chat.settings.isUserAdmin;

          if (!chat || (!isOwner && !isAdmin)) {
            alert("ä½ ä¸æ˜¯ç¾¤ä¸»æˆ–ç®¡ç†å‘˜ï¼Œæ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œï¼");
            return;
          }

          let targetNickname;
          let oldTitle;

          if (memberId === "user") {
            targetNickname = chat.settings.myNickname || "æˆ‘";
            oldTitle = chat.settings.myGroupTitle || "";
          } else {
            const member = chat.members.find((m) => m.id === memberId);
            if (!member) return;
            targetNickname = member.groupNickname;
            oldTitle = member.groupTitle || "";
          }

          const newTitle = await showCustomPrompt(
            `ä¸ºâ€œ${targetNickname}â€è®¾ç½®å¤´è¡”`,
            "ç•™ç©ºåˆ™ä¸ºå–æ¶ˆå¤´è¡”",
            oldTitle,
          );

          if (newTitle !== null) {
            const trimmedTitle = newTitle.trim();

            if (memberId === "user") {
              chat.settings.myGroupTitle = trimmedTitle;
            } else {
              const member = chat.members.find((m) => m.id === memberId);
              if (member) member.groupTitle = trimmedTitle;
            }

            await db.chats.put(chat);

            const myNickname = chat.settings.myNickname || "æˆ‘";
            await logTitleChange(
              chat.id,
              myNickname,
              targetNickname,
              trimmedTitle,
            );

            renderMemberManagementList();
          }
        }

        /**
         * å¤„ç†è½¬è®©ç¾¤ä¸» (å·²æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥)
         */
        async function handleTransferOwnership(memberId) {
          const chat = state.chats[state.activeChatId];
          const newOwner = chat.members.find((m) => m.id === memberId);
          if (!newOwner) return;

          // è·å–æ—§ç¾¤ä¸»çš„æ˜µç§°ï¼Œä¹Ÿå°±æ˜¯ä½ è‡ªå·±çš„æ˜µç§°
          const oldOwnerNickname = chat.settings.myNickname || "æˆ‘";

          const confirmed = await showCustomConfirm(
            "è½¬è®©ç¾¤ä¸»",
            `ä½ ç¡®å®šè¦å°†ç¾¤ä¸»èº«ä»½è½¬è®©ç»™â€œ${newOwner.groupNickname}â€å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œä½ å°†å¤±å»ç¾¤ä¸»æƒé™ã€‚`,
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            // æ›´æ–°ç¾¤ä¸»ID
            chat.ownerId = newOwner.id;

            // å°†æ–°ç¾¤ä¸»è®¾ä¸ºç®¡ç†å‘˜ï¼ˆå¦‚æœä»–ä¹‹å‰ä¸æ˜¯ï¼‰
            newOwner.isAdmin = true;

            // 1. æ„å»ºç³»ç»Ÿæ¶ˆæ¯çš„å†…å®¹
            const message = `â€œ${oldOwnerNickname}â€å·²å°†ç¾¤ä¸»è½¬è®©ç»™â€œ${newOwner.groupNickname}â€`;

            // 2. è°ƒç”¨ä½ å·²æœ‰çš„å‡½æ•°æ¥å‘é€è¿™æ¡ç³»ç»Ÿæ¶ˆæ¯
            //    è¿™ä¸ªå‡½æ•°ä¼šè‡ªåŠ¨ä¿å­˜æ•°æ®å¹¶åˆ·æ–°èŠå¤©åˆ—è¡¨ï¼Œéå¸¸æ–¹ä¾¿ï¼
            await logSystemMessage(chat.id, message);

            // åˆ·æ–°æˆå‘˜ç®¡ç†åˆ—è¡¨çš„æ˜¾ç¤º
            renderMemberManagementList();

            // ç»™å‡ºæˆåŠŸæç¤º
            await showCustomAlert(
              "æ“ä½œæˆåŠŸ",
              `ç¾¤ä¸»å·²æˆåŠŸè½¬è®©ç»™â€œ${newOwner.groupNickname}â€ã€‚`,
            );
          }
        }

        /**
         * å‘é€ä¸€æ¡å±…ä¸­æ˜¾ç¤ºçš„ç³»ç»Ÿæ¶ˆæ¯åˆ°å½“å‰èŠå¤©
         * @param {string} chatId - ç›®æ ‡èŠå¤©çš„ID
         * @param {string} messageContent - è¦æ˜¾ç¤ºçš„æ¶ˆæ¯å†…å®¹
         */
        async function logSystemMessage(chatId, messageContent) {
          const chat = state.chats[chatId];
          if (!chat) return;

          // 1. åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯å¯¹è±¡
          const systemMessage = {
            role: "system", // è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿè§’è‰²çš„æ¶ˆæ¯
            type: "pat_message", // å¤ç”¨â€œæ‹ä¸€æ‹â€çš„å±…ä¸­ç°è‰²æ°”æ³¡æ ·å¼
            content: messageContent,
            timestamp: Date.now(),
          };

          // 2. å°†æ¶ˆæ¯æ·»åŠ åˆ°èŠå¤©è®°å½•å¹¶ä¿å­˜
          chat.history.push(systemMessage);
          await db.chats.put(chat);

          // 3. å¦‚æœç”¨æˆ·æ­£åœ¨æŸ¥çœ‹æ­¤èŠå¤©ï¼Œåˆ™ç«‹å³æ˜¾ç¤ºæ–°æ¶ˆæ¯
          if (
            state.activeChatId === chatId &&
            document
              .getElementById("chat-interface-screen")
              .classList.contains("active")
          ) {
            appendMessage(systemMessage, chat);
          }

          // 4. åˆ·æ–°èŠå¤©åˆ—è¡¨ä»¥æ›´æ–°é¢„è§ˆ
          await renderChatList();

          console.log(`ç³»ç»Ÿæ¶ˆæ¯å·²è®°å½•: ${messageContent}`);
        }

        /**
         * è®°å½•å¹¶å‘é€ç¾¤å¤´è¡”å˜æ›´çš„ç³»ç»Ÿæ¶ˆæ¯
         * @param {string} chatId - å‘ç”Ÿå˜æ›´çš„ç¾¤èŠID
         * @param {string} actorName - æ‰§è¡Œæ“ä½œçš„äººçš„æ˜µç§°
         * @param {string} targetName - è¢«ä¿®æ”¹å¤´è¡”çš„äººçš„æ˜µç§°
         * @param {string} newTitle - æ–°çš„å¤´è¡”
         */
        async function logTitleChange(chatId, actorName, targetName, newTitle) {
          // 1. æ„é€ æ¶ˆæ¯å†…å®¹
          const messageContent = newTitle
            ? `${actorName} å°†â€œ${targetName}â€çš„ç¾¤å¤´è¡”ä¿®æ”¹ä¸ºâ€œ${newTitle}â€`
            : `${actorName} å–æ¶ˆäº†â€œ${targetName}â€çš„ç¾¤å¤´è¡”`;

          // 2. è°ƒç”¨é€šç”¨çš„ç³»ç»Ÿæ¶ˆæ¯å‡½æ•°
          await logSystemMessage(chatId, messageContent);
        }

        /* ç¾¤å…¬å‘ŠåŠŸèƒ½æ ¸å¿ƒå‡½æ•° */

        /**
         * æ‰“å¼€ç¾¤å…¬å‘Šå¼¹çª—å¹¶æ¸²æŸ“å†…å®¹
         */
        function openGroupAnnouncementModal() {
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.isGroup) return;

          const modal = document.getElementById("group-announcement-modal");
          const contentArea = document.getElementById(
            "announcement-content-area",
          );
          const footer = document.getElementById("announcement-footer");

          const announcement = chat.settings.groupAnnouncement || "æš‚æ— å…¬å‘Š";
          contentArea.innerHTML = announcement.replace(/\n/g, "<br>");

          const canEdit = chat.ownerId === "user" || chat.settings.isUserAdmin;

          footer.innerHTML = "";
          if (canEdit) {
            const editBtn = document.createElement("button");
            editBtn.className = "cancel";
            editBtn.textContent = "ç¼–è¾‘";
            // æ”¹ç”¨ addEventListener æ¥ç»‘å®šäº‹ä»¶ï¼Œæ›´å®‰å…¨å¯é 
            editBtn.addEventListener("click", editGroupAnnouncement);
            footer.appendChild(editBtn);
          }

          const closeBtn = document.createElement("button");
          closeBtn.className = "save";
          closeBtn.textContent = "å…³é—­";
          // åŒæ ·æ”¹ç”¨ addEventListener
          closeBtn.addEventListener("click", closeGroupAnnouncementModal);
          footer.appendChild(closeBtn);

          modal.classList.add("visible");
        }

        /**
         * è¿›å…¥å…¬å‘Šç¼–è¾‘æ¨¡å¼
         */
        function editGroupAnnouncement() {
          const chat = state.chats[state.activeChatId];
          const contentArea = document.getElementById(
            "announcement-content-area",
          );
          const footer = document.getElementById("announcement-footer");

          const currentContent = chat.settings.groupAnnouncement || "";
          contentArea.innerHTML = `<textarea id="announcement-editor">${currentContent}</textarea>`;

          // è¿™é‡Œä¹Ÿå…¨éƒ¨æ”¹ç”¨ addEventListener çš„æ–¹å¼ç»‘å®š
          footer.innerHTML = ""; // å…ˆæ¸…ç©º

          const cancelBtn = document.createElement("button");
          cancelBtn.className = "cancel";
          cancelBtn.textContent = "å–æ¶ˆ";
          cancelBtn.addEventListener("click", closeGroupAnnouncementModal); // ç›´æ¥è°ƒç”¨å‡½æ•°

          const saveBtn = document.createElement("button");
          saveBtn.className = "save";
          saveBtn.textContent = "ä¿å­˜";
          saveBtn.addEventListener("click", saveGroupAnnouncement); // ç›´æ¥è°ƒç”¨å‡½æ•°

          footer.appendChild(cancelBtn);
          footer.appendChild(saveBtn);

          document.getElementById("announcement-editor").focus();
        }

        /**
         * ä¿å­˜æ–°çš„ç¾¤å…¬å‘Š
         */
        async function saveGroupAnnouncement() {
          const chat = state.chats[state.activeChatId];
          const newContent = document
            .getElementById("announcement-editor")
            .value.trim();

          chat.settings.groupAnnouncement = newContent;
          await db.chats.put(chat);

          const myNickname = chat.settings.myNickname || "æˆ‘";
          await logSystemMessage(chat.id, `â€œ${myNickname}â€ä¿®æ”¹äº†ç¾¤å…¬å‘Šã€‚`);

          closeGroupAnnouncementModal();
          alert("ç¾¤å…¬å‘Šå·²æ›´æ–°ï¼");
        }

        /**
         * å…³é—­ç¾¤å…¬å‘Šå¼¹çª—
         */
        function closeGroupAnnouncementModal() {
          // å…³é—­åï¼Œé‡æ–°æ¸²æŸ“ä¸€æ¬¡æŸ¥çœ‹çŠ¶æ€ï¼Œä»¥é˜²ç”¨æˆ·å–æ¶ˆäº†ç¼–è¾‘
          const modal = document.getElementById("group-announcement-modal");
          modal.classList.remove("visible");
          // å»¶è¿Ÿä¸€ç‚¹ç‚¹å†æ‰“å¼€ï¼Œå¯ä»¥é¿å…è§†è§‰ä¸Šçš„å†²çª
          setTimeout(() => {
            if (modal.classList.contains("visible")) {
              // åšä¸ªæ£€æŸ¥ï¼Œä¸‡ä¸€ç”¨æˆ·å¿«é€Ÿæ“ä½œ
              openGroupAnnouncementModal();
            }
          }, 10);
          // ç›´æ¥å…³é—­ï¼Œä¸å†é‡æ–°æ‰“å¼€
          document
            .getElementById("group-announcement-modal")
            .classList.remove("visible");
        }

        /**
         * è·å–å¹¶æ ¼å¼åŒ–å½“å‰èŠå¤©çš„ç»­ç«èŠ±çŠ¶æ€ï¼Œç”Ÿæˆç»™AIçœ‹çš„ä¸Šä¸‹æ–‡
         * @param {object} chat - å½“å‰çš„èŠå¤©å¯¹è±¡
         * @returns {string} - æ ¼å¼åŒ–åçš„ç«èŠ±çŠ¶æ€æ–‡æœ¬ï¼Œæˆ–ç©ºå­—ç¬¦ä¸²
         */
        async function getStreakContext(chat) {
          // 1. å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœä¸æ˜¯å•èŠï¼Œæˆ–è€…åŠŸèƒ½æœªå¼€å¯ï¼Œåˆ™ç›´æ¥è¿”å›ç©ºå†…å®¹
          if (!chat || chat.isGroup || !chat.settings.streak?.enabled) {
            return "";
          }

          const streak = chat.settings.streak;
          const currentDays = streak.currentDays || 0;
          const extinguishThreshold = streak.extinguishThreshold || 1;
          const lastInteractionDate = streak.lastInteractionDate;
          let isExtinguished = false;

          // 2. åˆ¤æ–­ç«èŠ±æ˜¯å¦å·²ç†„ç­
          if (lastInteractionDate && extinguishThreshold !== -1) {
            const lastDate = new Date(lastInteractionDate);
            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0); // å°†æ—¶é—´è®¾ä¸ºå½“æ—¥é›¶ç‚¹ï¼Œä»¥ç²¾ç¡®è®¡ç®—å¤©æ•°

            // è®¡ç®—æœ€åä¸€æ¬¡äº’åŠ¨åˆ°ä»Šå¤©è¿‡äº†å¤šå°‘å¤©
            const daysDiff =
              (todayDate.getTime() - lastDate.getTime()) /
              (1000 * 60 * 60 * 24);

            if (daysDiff >= extinguishThreshold) {
              isExtinguished = true;
            }
          }

          let statusText = "";

          // 3. æ ¹æ®ä¸åŒçŠ¶æ€ï¼Œç”Ÿæˆç»™AIçœ‹çš„ä¸åŒæ–‡æœ¬
          if (isExtinguished && currentDays > 0) {
            // è¿™ç§çŠ¶æ€è¡¨ç¤ºâ€œæ›¾ç»æœ‰è¿‡ç«èŠ±ï¼Œä½†ç°åœ¨æ–­äº†â€
            statusText = `ä½ ä»¬çš„èŠå¤©ç«èŠ±ã€å·²ç†„ç­ã€‘ã€‚ä¹‹å‰æ›¾è¿ç»­èŠäº† ${currentDays} å¤©ï¼Œä½†ç°åœ¨ä¸­æ–­äº†ã€‚`;
          } else if (currentDays > 10) {
            statusText = `ä½ ä»¬çš„èŠå¤©ç«èŠ±æ­£åœ¨çƒ­çƒˆç‡ƒçƒ§ï¼Œå·²ç»æŒç»­äº†ã€${currentDays}ã€‘å¤©äº†ï¼è¿™æ˜¯ä¸€ä¸ªå€¼å¾—çºªå¿µçš„æ•°å­—ã€‚`;
          } else if (currentDays > 0) {
            statusText = `ä½ ä»¬çš„èŠå¤©ç«èŠ±æ­£åœ¨å»¶ç»­ï¼Œå·²ç»æŒç»­äº†ã€${currentDays}ã€‘å¤©ã€‚`;
          } else {
            // å¤©æ•°ä¸º0ï¼Œè¯´æ˜æ˜¯åˆšå¼€å¯æˆ–åˆšé‡ç½®
            statusText = "ä½ ä»¬åˆšåˆšç‚¹ç‡ƒäº†èŠå¤©ç«èŠ±ï¼Œè¦ç»§ç»­ä¿æŒå“¦ï¼";
          }

          // 4. æ‹¼æ¥æˆæœ€ç»ˆçš„ä¸Šä¸‹æ–‡æ ¼å¼
          return `\n- **èŠå¤©ç«èŠ±çŠ¶æ€**: ${statusText}`;
        }

        // ç”¨æˆ·è¡¨æƒ…åŒ…æ‰¹é‡åˆ é™¤æ ¸å¿ƒå‡½æ•°

        function toggleUserStickerSelectionMode() {
          isUserStickerSelectionMode = !isUserStickerSelectionMode;
          const stickerPanel = document.getElementById("sticker-panel");

          selectedUserStickers.clear();
          // åœ¨è¿™é‡Œç»™çˆ¶å®¹å™¨æ·»åŠ /ç§»é™¤ä¸€ä¸ªclass
          stickerPanel.classList.toggle(
            "selection-mode",
            isUserStickerSelectionMode,
          );

          document.getElementById("edit-user-stickers-btn").style.display =
            isUserStickerSelectionMode ? "none" : "block";
          document.getElementById("done-user-stickers-btn").style.display =
            isUserStickerSelectionMode ? "block" : "none";
          document.getElementById("sticker-panel-footer").style.display =
            isUserStickerSelectionMode ? "flex" : "none";

          const deleteBtn = document.getElementById(
            "delete-selected-user-stickers-btn",
          );
          deleteBtn.textContent = `åˆ é™¤å·²é€‰ (0)`;
          deleteBtn.disabled = true;

          const moveBtn = document.getElementById("move-selected-stickers-btn");
          moveBtn.disabled = true;

          renderStickerPanel(); // è¿™ä¸€æ­¥ä¼šè°ƒç”¨ renderStickerCategoriesï¼Œå¹¶æ ¹æ®æ–°çš„æ¨¡å¼é‡æ–°æ¸²æŸ“
        }

        /**
         * é€€å‡ºç”¨æˆ·è¡¨æƒ…åŒ…çš„é€‰æ‹©æ¨¡å¼
         */
        function exitUserStickerSelectionMode() {
          if (isUserStickerSelectionMode) {
            toggleUserStickerSelectionMode();
          }
        }

        // è§’è‰²è¡¨æƒ…åŒ…æ‰¹é‡åˆ é™¤æ ¸å¿ƒå‡½æ•°

        /**
         * åˆ‡æ¢è§’è‰²è¡¨æƒ…åŒ…çš„é€‰æ‹©æ¨¡å¼
         */
        function toggleCharStickerSelectionMode() {
          isCharStickerSelectionMode = !isCharStickerSelectionMode;
          const screen = document.getElementById("char-sticker-manager-screen");

          // æ¸…ç©ºé€‰æ‹©é›†å¹¶æ›´æ–°UI
          selectedCharStickers.clear();
          screen.classList.toggle("selection-mode", isCharStickerSelectionMode);

          document.getElementById("edit-char-stickers-btn").style.display =
            isCharStickerSelectionMode ? "none" : "block";
          document.getElementById("done-char-stickers-btn").style.display =
            isCharStickerSelectionMode ? "block" : "none";
          document.getElementById("char-sticker-footer").style.display =
            isCharStickerSelectionMode ? "block" : "none";
          document.getElementById(
            "delete-selected-char-stickers-btn",
          ).textContent = `åˆ é™¤å·²é€‰ (0)`;
          document.getElementById(
            "delete-selected-char-stickers-btn",
          ).disabled = true;

          // é‡æ–°æ¸²æŸ“å½“å‰æ¿€æ´»çš„é¡µç­¾
          const activeTab = document.querySelector(
            "#char-sticker-manager-screen .frame-tab.active",
          );
          if (activeTab) {
            renderCharStickers(
              activeTab.id === "sticker-tab-exclusive" ? "exclusive" : "common",
            );
          }
        }

        /**
         * é€€å‡ºè§’è‰²è¡¨æƒ…åŒ…çš„é€‰æ‹©æ¨¡å¼
         */
        function exitCharStickerSelectionMode() {
          if (isCharStickerSelectionMode) {
            toggleCharStickerSelectionMode();
          }
        }

        /**
         * å½“ç”¨æˆ·ç‚¹å‡»å¿ƒå£°é¢æ¿çš„ç¼–è¾‘æŒ‰é’®æ—¶ï¼Œæ‰“å¼€æ“ä½œèœå•
         */
        async function showInnerVoiceEditOptions() {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const borderHidden =
            chat.settings.innerVoiceHideHeaderBorder || false;
          const borderOptionText = borderHidden ? "æ˜¾ç¤ºåˆ†å‰²çº¿" : "éšè—åˆ†å‰²çº¿";

          // é€‰é¡¹æ•°ç»„é‡Œæ–°å¢ 'editStyles'
          const choice = await showChoiceModal("ç¼–è¾‘å¿ƒå£°é¢æ¿", [
            { text: "ğŸ¨ ç¼–è¾‘é¢æ¿æ ·å¼", value: "editStyles" },
            { text: borderOptionText, value: "toggleBorder" },
            { text: "ä¿®æ”¹é¢†å…»äºº", value: "editAdopter" },
          ]);

          if (choice === "editStyles") {
            openInnerVoiceStyleEditor(); // è°ƒç”¨æˆ‘ä»¬æ–°å†™çš„å‡½æ•°æ¥æ‰“å¼€æ ·å¼ç¼–è¾‘å™¨
          } else if (choice === "toggleBorder") {
            await toggleInnerVoiceHeaderBorder();
          } else if (choice === "editAdopter") {
            await editInnerVoiceAdopterName();
          }
        }

        /**
         * åˆ‡æ¢å¿ƒå£°é¢æ¿å¤´éƒ¨åˆ†å‰²çº¿çš„æ˜¾ç¤º/éšè—
         */
        async function toggleInnerVoiceHeaderBorder() {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          // ç¡®ä¿ chat.settings å­˜åœ¨
          if (!chat.settings) chat.settings = {};

          // åˆ‡æ¢å¸ƒå°”å€¼
          chat.settings.innerVoiceHideHeaderBorder = !(
            chat.settings.innerVoiceHideHeaderBorder || false
          );

          // ä¿å­˜åˆ°æ•°æ®åº“
          await db.chats.put(chat);

          // æ›´æ–°UI
          const header = document.querySelector(
            "#inner-voice-main-panel .modal-header",
          );
          if (header) {
            header.classList.toggle(
              "no-border",
              chat.settings.innerVoiceHideHeaderBorder,
            );
          }

          await showCustomAlert(
            "æ“ä½œæˆåŠŸ",
            `åˆ†å‰²çº¿å·²${chat.settings.innerVoiceHideHeaderBorder ? "éšè—" : "æ˜¾ç¤º"}ã€‚`,
          );
        }

        /**
         * ä¿®æ”¹â€œé¢†å…»äººâ€çš„æ ‡ç­¾æ¨¡æ¿
         */
        async function editInnerVoiceAdopterName() {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          // è·å–å½“å‰çš„æ ‡ç­¾æ¨¡æ¿ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®è¿‡ï¼Œå°±ä½¿ç”¨é»˜è®¤å€¼
          const currentFormat =
            chat.settings.innerVoiceAdopterLabelFormat || "é¢†å…»äºº: {{user}}";

          // å¼¹å‡ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·ç¼–è¾‘æ•´ä¸ªæ¨¡æ¿å­—ç¬¦ä¸²
          const newFormat = await showCustomPrompt(
            "ä¿®æ”¹é¢†å…»äººæ ‡ç­¾",
            "ä½ å¯ä»¥ä¿®æ”¹æ•´ä¸ªæ ‡ç­¾ï¼Œå…¶ä¸­ {{user}} ä¼šè¢«è‡ªåŠ¨æ›¿æ¢ä¸ºä½ çš„æ˜µç§°ã€‚",
            currentFormat,
          );

          // å¦‚æœç”¨æˆ·è¾“å…¥äº†æ–°å†…å®¹ï¼ˆä¸æ˜¯å–æ¶ˆï¼‰
          if (newFormat !== null) {
            // ä¿å­˜æ–°æ¨¡æ¿ï¼Œå¦‚æœè¾“å…¥ä¸ºç©ºåˆ™æ¢å¤é»˜è®¤
            chat.settings.innerVoiceAdopterLabelFormat =
              newFormat.trim() || "é¢†å…»äºº: {{user}}";
            await db.chats.put(chat);

            // é‡æ–°æ¸²æŸ“å¿ƒå£°é¢æ¿ä»¥æ˜¾ç¤ºæ–°æ ‡ç­¾
            openInnerVoiceModal();
            await showCustomAlert("ä¿®æ”¹æˆåŠŸ", "é¢†å…»äººæ ‡ç­¾å·²æ›´æ–°ï¼");
          }
        }

        /* â–¼â–¼â–¼ å¿ƒå£°é¢æ¿æ ·å¼ç¼–è¾‘åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼ */

        /**
         * å°†åå…­è¿›åˆ¶é¢œè‰²(#FFFFFF)è½¬æ¢ä¸º "R, G, B" å­—ç¬¦ä¸² (255, 255, 255)
         * @param {string} hex - åå…­è¿›åˆ¶é¢œè‰²ä»£ç 
         * @returns {string} - RGBå­—ç¬¦ä¸²
         */
        function hexToRgb(hex) {
          if (!hex || hex.length < 4) return "255, 255, 255";
          let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result
            ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}`
            : "255, 255, 255";
        }

        /**
         * å°†ä¿å­˜çš„æ ·å¼åº”ç”¨åˆ°å¿ƒå£°é¢æ¿
         */
        function applySavedInnerVoiceStyles() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.settings.innerVoiceStyles) return;

          const styles = chat.settings.innerVoiceStyles;
          const panel = document.getElementById("inner-voice-main-panel");

          panel.style.setProperty("--iv-color-clothing", styles.clothingColor);
          panel.style.setProperty("--iv-color-behavior", styles.behaviorColor);
          panel.style.setProperty("--iv-color-thoughts", styles.thoughtsColor);
          panel.style.setProperty("--iv-color-naughty", styles.naughtyColor);
          panel.style.setProperty(
            "--iv-card-bg-rgb",
            hexToRgb(styles.cardBgColor),
          );
          panel.style.setProperty("--iv-card-opacity", styles.cardOpacity);

          // åº”ç”¨ä¿å­˜çš„å›¾æ ‡é¢œè‰²
          panel.style.setProperty(
            "--iv-icon-color",
            styles.iconColor || "#ff8a80",
          );
        }

        /**
         * æ‰“å¼€å¿ƒå£°é¢æ¿æ ·å¼ç¼–è¾‘å™¨
         */
        function openInnerVoiceStyleEditor() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.settings.innerVoiceStyles) return;

          document
            .getElementById("inner-voice-edit-options-modal")
            ?.classList.remove("visible");

          const styles = chat.settings.innerVoiceStyles;
          // === ã€ä¿®å¤é‡ç‚¹ã€‘ï¼šå®‰å…¨è·å–æ ‡ç­¾é…ç½® ===
          const tags = chat.settings.innerVoiceTags || {};
          const modal = document.getElementById("inner-voice-editor-modal");

          // åŠ è½½æ ‡ç­¾åå’ŒæŒ‡ä»¤ï¼ˆå¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤ºé»˜è®¤å€¼ï¼‰
          document.getElementById("iv-label-clothing").value =
            tags.clothing_label || "æœè£…";
          document.getElementById("iv-prompt-clothing").value =
            tags.clothing_prompt || "è¯¦ç»†æè¿°ä½ å½“å‰ä»å¤´åˆ°è„šçš„å…¨èº«æœè£…ã€‚";

          document.getElementById("iv-label-behavior").value =
            tags.behavior_label || "è¡Œä¸º";
          document.getElementById("iv-prompt-behavior").value =
            tags.behavior_prompt || "æè¿°ä½ å½“å‰ç¬¦åˆèŠå¤©æƒ…æ™¯çš„ç»†å¾®åŠ¨ä½œæˆ–è¡¨æƒ…ã€‚";

          document.getElementById("iv-label-thoughts").value =
            tags.thoughts_label || "å¿ƒå£°";
          document.getElementById("iv-prompt-thoughts").value =
            tags.thoughts_prompt ||
            "æè¿°ä½ æ­¤åˆ»ä¸°å¯Œã€ç»†è…»çš„å†…å¿ƒçœŸå®æƒ³æ³•ï¼ˆ50å­—å·¦å³ï¼‰ã€‚";

          document.getElementById("iv-label-naughty").value =
            tags.naughty_label || "åå¿ƒæ€";
          document.getElementById("iv-prompt-naughty").value =
            tags.naughty_prompt ||
            "æè¿°ä½ æ­¤åˆ»ä¸æƒ…å¢ƒç›¸å…³çš„è…¹é»‘æˆ–è‰²è‰²çš„åå¿ƒæ€ï¼Œå¿…é¡»ç¬¦åˆäººè®¾ã€‚";

          // åŠ è½½å½“å‰æ ·å¼åˆ°ç¼–è¾‘å™¨
          document.getElementById("iv-color-clothing").value =
            styles.clothingColor;
          document.getElementById("iv-color-behavior").value =
            styles.behaviorColor;
          document.getElementById("iv-color-thoughts").value =
            styles.thoughtsColor;
          document.getElementById("iv-color-naughty").value =
            styles.naughtyColor;
          document.getElementById("iv-card-bg-color").value =
            styles.cardBgColor;
          document.getElementById("iv-opacity-slider").value =
            styles.cardOpacity;
          document.getElementById("iv-opacity-value").textContent =
            `${Math.round(styles.cardOpacity * 100)}%`;

          // åŠ è½½ä¿å­˜çš„å›¾æ ‡é¢œè‰²
          document.getElementById("iv-icon-color").value =
            styles.iconColor || "#ff8a80";

          modal.classList.add("visible");
        }

        /**
         * ä¿å­˜ç”¨æˆ·ä¿®æ”¹çš„æ ·å¼ã€æ ‡ç­¾å’ŒæŒ‡ä»¤
         */
        async function saveInnerVoiceStyles() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];

          // 1. ä¿å­˜æ ·å¼ (ä¿æŒä¸å˜)
          const newStyles = {
            clothingColor: document.getElementById("iv-color-clothing").value,
            behaviorColor: document.getElementById("iv-color-behavior").value,
            thoughtsColor: document.getElementById("iv-color-thoughts").value,
            naughtyColor: document.getElementById("iv-color-naughty").value,
            cardBgColor: document.getElementById("iv-card-bg-color").value,
            cardOpacity: parseFloat(
              document.getElementById("iv-opacity-slider").value,
            ),
            iconColor: document.getElementById("iv-icon-color").value,
          };

          // 2. ä¿å­˜æ ‡ç­¾åå’ŒæŒ‡ä»¤ (æ–°å¢)
          // å¦‚æœç”¨æˆ·ç•™ç©ºï¼Œå°±ä½¿ç”¨é»˜è®¤å€¼å…œåº•
          const newTags = {
            clothing_label:
              document.getElementById("iv-label-clothing").value.trim() ||
              "æœè£…",
            clothing_prompt:
              document.getElementById("iv-prompt-clothing").value.trim() ||
              "è¯¦ç»†æè¿°ä½ å½“å‰ä»å¤´åˆ°è„šçš„å…¨èº«æœè£…ã€‚",

            behavior_label:
              document.getElementById("iv-label-behavior").value.trim() ||
              "è¡Œä¸º",
            behavior_prompt:
              document.getElementById("iv-prompt-behavior").value.trim() ||
              "æè¿°ä½ å½“å‰ç¬¦åˆèŠå¤©æƒ…æ™¯çš„ç»†å¾®åŠ¨ä½œæˆ–è¡¨æƒ…ã€‚",

            thoughts_label:
              document.getElementById("iv-label-thoughts").value.trim() ||
              "å¿ƒå£°",
            thoughts_prompt:
              document.getElementById("iv-prompt-thoughts").value.trim() ||
              "æè¿°ä½ æ­¤åˆ»ä¸°å¯Œã€ç»†è…»çš„å†…å¿ƒçœŸå®æƒ³æ³•ï¼ˆ50å­—å·¦å³ï¼‰ã€‚",

            naughty_label:
              document.getElementById("iv-label-naughty").value.trim() ||
              "åå¿ƒæ€",
            naughty_prompt:
              document.getElementById("iv-prompt-naughty").value.trim() ||
              "æè¿°ä½ æ­¤åˆ»ä¸æƒ…å¢ƒç›¸å…³çš„è…¹é»‘æˆ–è‰²è‰²çš„åå¿ƒæ€ï¼Œå¿…é¡»ç¬¦åˆäººè®¾ã€‚",
          };

          // æ›´æ–°åˆ°stateå’Œæ•°æ®åº“
          chat.settings.innerVoiceStyles = newStyles;
          chat.settings.innerVoiceTags = newTags;

          await db.chats.put(chat);

          // å…³é—­å¼¹çª—
          document
            .getElementById("inner-voice-editor-modal")
            .classList.remove("visible");

          // é‡æ–°åº”ç”¨æ ·å¼
          applySavedInnerVoiceStyles();

          // å¦‚æœé¢æ¿å¼€ç€ï¼Œé‡æ–°æ‰“å¼€ä¸€ä¸‹ä»¥åˆ·æ–°æ ‡ç­¾æ–‡å­—
          if (
            document
              .getElementById("inner-voice-modal")
              .classList.contains("visible")
          ) {
            openInnerVoiceModal();
          }

          await showCustomAlert(
            "ä¿å­˜æˆåŠŸ",
            "å¿ƒå£°é…ç½®å·²æ›´æ–°ï¼\nAIå°†åœ¨ä¸‹æ¬¡å›å¤æ—¶éµå¾ªä½ çš„æ–°æŒ‡ä»¤ã€‚",
          );
        }

        /**
         * æ‰“å¼€AIç”Ÿæˆç¾¤æˆå‘˜çš„æ¨¡æ€æ¡†
         */
        function openAiGenerateMembersModal() {
          // æ¸…ç©ºä¸Šæ¬¡çš„è¾“å…¥
          document.getElementById("ai-member-count-input").value = "3";
          document.getElementById("ai-member-prompt-input").value = "";
          // æ˜¾ç¤ºå¼¹çª—
          document
            .getElementById("ai-generate-members-modal")
            .classList.add("visible");
        }

        /**
         * å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œå¼€å§‹ç”Ÿæˆâ€æŒ‰é’®çš„é€»è¾‘
         */
        async function handleGenerateMembers() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          if (!chat || !chat.isGroup) return;

          const count = parseInt(
            document.getElementById("ai-member-count-input").value,
          );
          const requirements = document
            .getElementById("ai-member-prompt-input")
            .value.trim();

          if (isNaN(count) || count < 1 || count > 20) {
            alert("è¯·è¾“å…¥1åˆ°20ä¹‹é—´çš„æœ‰æ•ˆäººæ•°ï¼");
            return;
          }

          document
            .getElementById("ai-generate-members-modal")
            .classList.remove("visible");
          await showCustomAlert(
            "è¯·ç¨å€™...",
            `AIæ­£åœ¨ä¸ºâ€œ${chat.name}â€åˆ›é€  ${count} ä½æ–°æœ‹å‹...`,
          );

          const systemPrompt = `
			# ä»»åŠ¡
			ä½ æ˜¯ä¸€ä¸ªç¾¤èŠæˆå‘˜ç”Ÿæˆå™¨ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„è¦æ±‚ï¼Œä¸ºç¾¤èŠâ€œ${chat.name}â€åˆ›å»º${count}ä¸ªæ–°æˆå‘˜ã€‚

			# ç”¨æˆ·è¦æ±‚:
			${requirements || "æ— ç‰¹æ®Šè¦æ±‚ï¼Œè¯·è‡ªç”±å‘æŒ¥ã€‚"}

			# æ ¸å¿ƒè§„åˆ™
			1.  ä½ ç”Ÿæˆçš„æ¯ä¸ªæˆå‘˜éƒ½å¿…é¡»æœ‰ç‹¬ç‰¹çš„åå­—(name)å’Œé²œæ˜çš„æ€§æ ¼äººè®¾(persona)ã€‚
			2.  äººè®¾æè¿°è¦ç”ŸåŠ¨ã€å…·ä½“ï¼Œèƒ½ä½“ç°å‡ºè§’è‰²çš„ç‰¹ç‚¹ã€‚
			3.  ã€æ ¼å¼é“å¾‹ã€‘: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œç›´æ¥ä»¥'['å¼€å¤´, ä»¥']'ç»“å°¾ã€‚æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªä»£è¡¨æˆå‘˜çš„JSONå¯¹è±¡ã€‚

			# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:
			[
			  {
			    "name": "æ—é£",
			    "persona": "ä¸€ä¸ªé˜³å…‰å¼€æœ—çš„è¿åŠ¨ç³»å°‘å¹´ï¼Œçƒ­çˆ±ç¯®çƒï¼Œæ€§æ ¼ç›´çˆ½ï¼Œæ˜¯å›¢é˜Ÿé‡Œçš„æ°”æ°›æ‹…å½“ã€‚"
			  },
			  {
			    "name": "é™ˆé›ª",
			    "persona": "æ–‡é™å†…å‘çš„å­¦éœ¸å°‘å¥³ï¼Œå–œæ¬¢è¯»ä¹¦å’Œç”»ç”»ï¼Œå¿ƒæ€ç»†è…»ï¼Œä¸å–„è¨€è¾ä½†è§‚å¯ŸåŠ›æ•é”ã€‚"
			  }
			]
			`;

          try {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            let isGemini = proxyUrl === GEMINI_API_URL;
            let messagesForApi = [{ role: "user", content: systemPrompt }];
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPrompt,
              messagesForApi,
              isGemini,
            );

            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: 1.0,
                  }),
                });

            if (!response.ok)
              throw new Error(
                `APIè¯·æ±‚å¤±è´¥: ${response.status} - ${await response.text()}`,
              );

            const data = await response.json();
            const rawContent = (
              isGemini
                ? data.candidates[0].content.parts[0].text
                : data.choices[0].message.content
            )
              .replace(/^```json\s*|```$/g, "")
              .trim();
            const newMembersData = JSON.parse(rawContent);

            if (Array.isArray(newMembersData) && newMembersData.length > 0) {
              const addedNames = [];
              newMembersData.forEach((memberData, index) => {
                if (memberData.name && memberData.persona) {
                  const newMember = {
                    id: "npc_" + (Date.now() + index),
                    originalName: memberData.name.trim(),
                    groupNickname: memberData.name.trim(),
                    avatar: defaultGroupMemberAvatar,
                    persona: memberData.persona.trim(),
                    avatarFrame: "",
                    isAdmin: false,
                    groupTitle: "",
                  };
                  chat.members.push(newMember);
                  addedNames.push(`â€œ${newMember.groupNickname}â€`);
                }
              });

              if (addedNames.length > 0) {
                await db.chats.put(chat);
                await logSystemMessage(
                  chat.id,
                  `é‚€è¯·äº† ${addedNames.length} ä½æ–°æˆå‘˜: ${addedNames.join("ã€")}åŠ å…¥äº†ç¾¤èŠã€‚`,
                );
                await showCustomAlert(
                  "ç”ŸæˆæˆåŠŸï¼",
                  `${addedNames.length} ä½æ–°æˆå‘˜å·²åŠ å…¥ç¾¤èŠï¼`,
                );
                renderMemberManagementList(); // åˆ·æ–°æˆå‘˜ç®¡ç†åˆ—è¡¨
              } else {
                throw new Error(
                  "AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘nameæˆ–personaå­—æ®µã€‚",
                );
              }
            } else {
              throw new Error("AIè¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„æ•°ç»„ã€‚");
            }
          } catch (error) {
            console.error("AIç”Ÿæˆç¾¤æˆå‘˜å¤±è´¥:", error);
            await showCustomAlert(
              "ç”Ÿæˆå¤±è´¥",
              `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼š\n${error.message}`,
            );
          }
        }

        async function renderStickerCategories() {
          const tabsContainer = document.getElementById(
            "sticker-category-tabs",
          );
          if (!tabsContainer) return;

          tabsContainer.innerHTML = ""; // æ¸…ç©ºæ—§çš„æ ‡ç­¾
          const categories = await db.userStickerCategories
            .orderBy("name")
            .toArray();
          userStickerCategories = categories; // æ›´æ–°å…¨å±€ç¼“å­˜

          // 1. æ¸²æŸ“â€œæœªåˆ†ç±»â€æŒ‰é’®ï¼ˆè¿™ä¸ªæŒ‰é’®æ²¡æœ‰åˆ é™¤åŠŸèƒ½ï¼‰
          const uncategorizedBtn = document.createElement("button");
          uncategorizedBtn.className = "sticker-category-btn";
          uncategorizedBtn.textContent = "æœªåˆ†ç±»";
          uncategorizedBtn.dataset.categoryId = "uncategorized";
          if (activeStickerCategoryId === "uncategorized") {
            uncategorizedBtn.classList.add("active");
          }
          tabsContainer.appendChild(uncategorizedBtn);

          // 2. æ¸²æŸ“æ‰€æœ‰è‡ªå®šä¹‰åˆ†ç±»
          for (const category of categories) {
            const btn = document.createElement("button");
            btn.className = "sticker-category-btn";
            // å°†IDå’Œåç§°éƒ½å­˜å‚¨åœ¨çˆ¶æŒ‰é’®ä¸Šï¼Œæ–¹ä¾¿äº‹ä»¶å§”æ‰˜è·å–
            btn.dataset.categoryId = category.id;
            btn.dataset.categoryName = category.name;

            const nameSpan = document.createElement("span");
            nameSpan.textContent = category.name;
            btn.appendChild(nameSpan);

            // å¦‚æœæ˜¯å½“å‰æ¿€æ´»çš„åˆ†ç±»ï¼Œæ·»åŠ é«˜äº®
            if (activeStickerCategoryId === category.id) {
              btn.classList.add("active");
            }

            // åªåœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œæ‰åˆ›å»ºå’Œæ·»åŠ åˆ é™¤æŒ‰é’®
            if (isUserStickerSelectionMode) {
              const deleteBtn = document.createElement("span");
              deleteBtn.className = "sticker-category-delete-btn";
              deleteBtn.textContent = "Ã—";
              deleteBtn.title = `åˆ é™¤åˆ†ç±» "${category.name}"`; // å¢åŠ æ‚¬æµ®æç¤º
              btn.appendChild(deleteBtn);
            }

            tabsContainer.appendChild(btn);
          }
        }

        /**
         * æ‰“å¼€ç§»åŠ¨è¡¨æƒ…åˆ°åˆ†ç±»çš„æ¨¡æ€æ¡†
         */
        async function openStickerCategoryModal() {
          if (selectedUserStickers.size === 0) {
            alert("è¯·å…ˆé€‰æ‹©è¦ç§»åŠ¨çš„è¡¨æƒ…åŒ…ï¼");
            return;
          }

          const modal = document.getElementById("sticker-category-modal");
          const listEl = document.getElementById("sticker-category-list");
          const inputEl = document.getElementById("new-sticker-category-input");
          listEl.innerHTML = "";
          inputEl.value = "";

          const categories = await db.userStickerCategories.toArray();
          if (categories.length > 0) {
            categories.forEach((cat) => {
              const label = document.createElement("label");
              label.innerHTML = `<input type="radio" name="sticker_category_select" value="${cat.id}"> ${cat.name}`;
              listEl.appendChild(label);
            });
          } else {
            listEl.innerHTML =
              '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»ã€‚</p>';
          }

          modal.classList.add("visible");
        }

        /**
         * å¤„ç†â€œç¡®è®¤ç§»åŠ¨â€æŒ‰é’®çš„ç‚¹å‡»é€»è¾‘
         */
        async function handleMoveStickers() {
          const newCategoryName = document
            .getElementById("new-sticker-category-input")
            .value.trim();
          const selectedRadio = document.querySelector(
            'input[name="sticker_category_select"]:checked',
          );

          let targetCategoryId = null;

          if (newCategoryName) {
            try {
              // æ£€æŸ¥åˆ†ç±»æ˜¯å¦å·²å­˜åœ¨
              let existingCategory = await db.userStickerCategories
                .where("name")
                .equalsIgnoreCase(newCategoryName)
                .first();
              if (existingCategory) {
                targetCategoryId = existingCategory.id;
              } else {
                targetCategoryId = await db.userStickerCategories.add({
                  name: newCategoryName,
                });
              }
            } catch (error) {
              alert("åˆ›å»ºæ–°åˆ†ç±»å¤±è´¥ï¼Œå¯èƒ½æ˜¯åç§°é‡å¤æˆ–æ•°æ®åº“é”™è¯¯ã€‚");
              return;
            }
          } else if (selectedRadio) {
            targetCategoryId = parseInt(selectedRadio.value);
          } else {
            alert("è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»æˆ–åˆ›å»ºä¸€ä¸ªæ–°åˆ†ç±»ï¼");
            return;
          }

          try {
            const stickerIdsToMove = Array.from(selectedUserStickers);
            const stickers = await db.userStickers.bulkGet(stickerIdsToMove);

            stickers.forEach((sticker) => {
              if (sticker) {
                sticker.categoryId = targetCategoryId;
              }
            });

            await db.userStickers.bulkPut(stickers);

            // æ›´æ–°å†…å­˜ä¸­çš„ state.userStickers
            stickers.forEach((updatedSticker) => {
              const index = state.userStickers.findIndex(
                (s) => s.id === updatedSticker.id,
              );
              if (index > -1) {
                state.userStickers[index].categoryId = targetCategoryId;
              }
            });

            document
              .getElementById("sticker-category-modal")
              .classList.remove("visible");
            exitUserStickerSelectionMode(); // é€€å‡ºç¼–è¾‘æ¨¡å¼
            alert(`æˆåŠŸç§»åŠ¨ ${stickerIdsToMove.length} ä¸ªè¡¨æƒ…ï¼`);
          } catch (error) {
            console.error("ç§»åŠ¨è¡¨æƒ…å¤±è´¥:", error);
            alert("ç§»åŠ¨è¡¨æƒ…æ—¶å‘ç”Ÿé”™è¯¯ã€‚");
          }
        }

        // è§†é¢‘é€šè¯æ§åˆ¶æŒ‰é’®çš„äº‹ä»¶å§”æ‰˜
        // è¿™ä¸ªå‡½æ•°ç”¨äºç»Ÿä¸€å¤„ç†æ‰€æœ‰é€šè¯æ§åˆ¶æŒ‰é’®çš„ç‚¹å‡»
        function handleCallControls(event) {
          // æ‰¾åˆ°è¢«ç‚¹å‡»çš„é‚£ä¸ªæŒ‰é’®å…ƒç´ 
          const button = event.target.closest(".control-btn");
          if (!button) return; // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æŒ‰é’®ï¼Œå°±ä»€ä¹ˆä¹Ÿä¸åš

          // æ ¹æ®æŒ‰é’®çš„IDæ¥æ‰§è¡Œä¸åŒçš„æ“ä½œ
          switch (button.id) {
            case "user-speak-btn":
            case "user-speak-btn-visual":
              // è¿™é‡Œè°ƒç”¨ä½ åŸæœ¬å¤„ç†â€œç”¨æˆ·å‘è¨€â€çš„å‡½æ•°
              handleUserSpeakInCall(); // å‡è®¾ä½ çš„å‡½æ•°åå«è¿™ä¸ª
              break;
            case "hang-up-btn":
            case "hang-up-btn-visual":
              // è°ƒç”¨ä½ åŸæœ¬å¤„ç†â€œæŒ‚æ–­â€çš„å‡½æ•°
              endVideoCall();
              break;
            case "join-call-btn":
              // è°ƒç”¨ä½ åŸæœ¬å¤„ç†â€œåŠ å…¥é€šè¯â€çš„å‡½æ•°
              handleUserJoinCall();
              break;
            case "reroll-call-btn":
            case "reroll-call-btn-text":
              // è°ƒç”¨ä½ åŸæœ¬å¤„ç†â€œé‡rollâ€çš„å‡½æ•°
              handleVideoCallReroll();
              break;
            case "flip-real-camera-btn":
              handleCameraFlip();
              break;
            case "switch-camera-btn":
              // è°ƒç”¨ä½ åŸæœ¬å¤„ç†â€œåˆ‡æ¢é•œå¤´â€çš„å‡½æ•°
              switchVideoViews();
              break;
          }
        }

        // åœ¨init()å‡½æ•°ä¸­ï¼Œä¸ºä¸¤ä¸ªæ§åˆ¶æ å®¹å™¨ç»‘å®šäº‹ä»¶
        // æ³¨æ„ï¼šå› ä¸ºä½ çš„HTMLä¸­æœ‰ä¸¤ä¸ª controls divï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ†åˆ«ç»‘å®š
        const textModeControls = document.querySelector(
          "#text-call-interface .video-call-controls",
        );
        if (textModeControls) {
          textModeControls.addEventListener("click", handleCallControls);
        }

        const visualModeControls = document.querySelector(
          "#visual-call-interface .video-call-controls",
        );
        if (visualModeControls) {
          visualModeControls.addEventListener("click", handleCallControls);
        }

        /**
         * å¤„ç†ç”¨æˆ·åœ¨é€šè¯ä¸­ç‚¹å‡»â€œå‘è¨€â€æŒ‰é’®çš„é€»è¾‘
         */
        async function handleUserSpeakInCall() {
          // å®‰å…¨æ£€æŸ¥ï¼Œå¦‚æœé€šè¯æœªæ¿€æ´»åˆ™ä¸æ‰§è¡Œ
          if (!videoCallState.isActive) return;

          // æ‰¾åˆ°ç”¨æˆ·å¤´åƒå¹¶æ·»åŠ â€œæ­£åœ¨å‘è¨€â€çš„é«˜äº®æ•ˆæœï¼Œæå‡äº¤äº’æ„Ÿ
          const userAvatar = document.querySelector(
            '.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar',
          );
          if (userAvatar) {
            userAvatar.classList.add("speaking");
          }

          // å¼¹å‡ºä½ å·²ç»å†™å¥½çš„è‡ªå®šä¹‰è¾“å…¥æ¡†
          const userInput = await showCustomPrompt(
            "ä½ è¯´",
            "è¯·è¾“å…¥ä½ æƒ³è¯´çš„è¯...",
          );

          // æ— è®ºç”¨æˆ·æ˜¯å¦è¾“å…¥ï¼Œåªè¦è¾“å…¥æ¡†å…³é—­ï¼Œå°±ç«‹åˆ»ç§»é™¤å¤´åƒçš„é«˜äº®æ•ˆæœ
          if (userAvatar) {
            userAvatar.classList.remove("speaking");
          }

          // å¦‚æœç”¨æˆ·ç¡®å®è¾“å…¥äº†å†…å®¹ï¼Œå°±è°ƒç”¨ä½ å·²æœ‰çš„å‡½æ•°æ¥è§¦å‘AIå“åº”
          if (userInput && userInput.trim()) {
            triggerAiInCallAction(userInput.trim());
          }
        }

        /**
         * åˆå§‹åŒ–é»˜è®¤çš„å°ç»„
         */
        async function initializeDefaultGroups() {
          const groupCount = await db.forumGroups.count();
          if (groupCount === 0) {
            const defaultGroups = [
              { name: "å¨±ä¹å°ç»„", description: "åˆ†äº«å…«å¦å’Œå¿«ä¹", icon: "ğŸ¿" },
              { name: "çµå¼‚å°ç»„", description: "åˆ†äº«ä½ çš„çµå¼‚ç»å†", icon: "ğŸ‘»" },
              {
                name: "ä»Šå¤©æˆ‘crushäº†å—",
                description: "è®°å½•å¿ƒåŠ¨ç¬é—´",
                icon: "ğŸ’–",
              },
              {
                name: "è¯·å¸®æˆ‘é€‰æ‹©å°ç»„",
                description: "é€‰æ‹©å›°éš¾ç—‡æ‚£è€…äº’åŠ©",
                icon: "ğŸ¤”",
              },
              {
                name: "åŒäººæ–‡å°ç»„",
                description: "ä¸ºçˆ±å‘ç”µï¼Œåˆ›ä½œæ•…äº‹",
                icon: "âœï¸",
              },

              {
                name: "æ¢¦è§’å°ç»„",
                description: "Charä»¬åˆ†äº«å…³äºuserçš„æ¢¦å¢ƒ",
                icon: "ğŸŒ™",
              },
            ];
            await db.forumGroups.bulkAdd(defaultGroups);
            console.log("å·²æˆåŠŸåˆ›å»ºé»˜è®¤å°ç»„ï¼ˆåŒ…å«æ¢¦è§’å°ç»„ï¼‰ã€‚");
          }
        }

        /**
         * æ‰“å¼€é«˜çº§å¯¼å…¥å¯¼å‡ºæ¨¡æ€æ¡†ï¼Œå¹¶åŠ¨æ€ç”Ÿæˆé€‰é¡¹åˆ—è¡¨
         */
        async function openAdvancedTransferModal() {
          const appsListEl = document.getElementById("export-apps-list");
          const charactersListEl = document.getElementById(
            "export-characters-list",
          );
          appsListEl.innerHTML = "";
          charactersListEl.innerHTML = "";

          // 1. å®šä¹‰å¯ç‹¬ç«‹å¯¼å‡ºçš„Appæ•°æ®åŠå…¶å…³è”çš„æ•°æ®åº“è¡¨
          const appsToExport = [
            {
              id: "weibo",
              name: "å¾®åš (å…¨éƒ¨å¸–å­/è§’è‰²èµ„æ–™/ç²‰ä¸æ•°ç­‰)",
              tables: ["weiboPosts", "qzoneSettings"],
            },
            {
              id: "forum",
              name: "åœˆå­ (å°ç»„/å¸–å­/è¯„è®º/åˆ†ç±»/è¿è½½)",
              tables: [
                "forumGroups",
                "forumPosts",
                "forumComments",
                "forumCategories",
                "forumSeries",
                "forumChapters",
              ],
            },
            {
              id: "taobao",
              name: "æ¡ƒå® (æ‰€æœ‰å•†å“/è®¢å•/è´­ç‰©è½¦/ä½™é¢è®°å½•)",
              tables: [
                "taobaoProducts",
                "taobaoOrders",
                "taobaoCart",
                "userWalletTransactions",
              ],
            },
            {
              id: "worldBooks",
              name: "ä¸–ç•Œä¹¦ (å…¨éƒ¨ä¹¦ç±åŠåˆ†ç±»)",
              tables: ["worldBooks", "worldBookCategories"],
            },

            {
              id: "dateALive",
              name: "çº¦ä¼šå¤§ä½œæˆ˜ (åœºæ™¯/é¢„è®¾/ç«‹ç»˜/å†å²)",
              tables: [
                "datingScenes",
                "datingPresets",
                "datingSpriteGroups",
                "datingSprites",
                "datingHistory",
              ],
            },

            {
              id: "tukeyAccounting",
              name: "å…”kè®°è´¦ (è´¦æˆ·/ç¾¤èŠ/è´¦å•/è®¾ç½®)",
              tables: [
                "tukeyAccounts",
                "tukeyAccountingGroups",
                "tukeyAccountingRecords",
                "tukeyAccountingReplies",
                "tukeyUserSettings",
                "tukeyCustomConfig",
              ],
            },

            {
              id: "studio",
              name: "å°å‰§åœº (æ‰€æœ‰å‰§æœ¬/æ¼”ç»è®°å½•)",
              tables: ["studioScripts", "studioHistory"],
            },

            {
              id: "userStickers",
              name: "æˆ‘çš„è¡¨æƒ…åŒ… (åŒ…å«åˆ†ç±»)",
              tables: ["userStickers", "userStickerCategories"],
            },
            {
              id: "charStickers",
              name: "è§’è‰²é€šç”¨è¡¨æƒ…åŒ…",
              tables: ["charStickers"],
            },
            {
              id: "gameData",
              name: "æ¸¸æˆå¤§å…æ•°æ® (å‰§æœ¬æ€/é£è¡Œæ£‹é¢˜åº“ç­‰)",
              tables: [
                "scriptKillScripts",
                "ludoQuestionBanks",
                "ludoQuestions",
              ],
            },
            {
              id: "appearance",
              name: "é€šç”¨å¤–è§‚é¢„è®¾ (ä¸»é¢˜/å­—ä½“/å¤´åƒæ¡†ç­‰)",
              tables: [
                "themes",
                "fontPresets",
                "homeScreenPresets",
                "customAvatarFrames",
                "apiPresets",
                "bubbleStylePresets",
              ],
            },
          ];

          appsToExport.forEach((app) => {
            appsListEl.innerHTML += `
			            <label style="display: block; margin-bottom: 5px;">
			                <input type="checkbox" class="export-app-checkbox" value="${app.id}"> ${app.name}
			            </label>
			        `;
          });

          // 2. åŠ è½½æ‰€æœ‰å•èŠè§’è‰²
          const characters = Object.values(state.chats).filter(
            (chat) => !chat.isGroup,
          );
          if (characters.length === 0) {
            charactersListEl.innerHTML = "<p>æ²¡æœ‰å¯å¯¼å‡ºçš„è§’è‰²</p>";
          } else {
            characters.forEach((char) => {
              charactersListEl.innerHTML += `
			                <label style="display: block; margin-bottom: 5px;">
			                    <input type="checkbox" class="export-char-checkbox" value="${char.id}"> ${char.name}
			                </label>
			            `;
            });
          }

          // é‡ç½®å¹¶ç»‘å®šå…¨é€‰æ¡†
          const selectAllCheckbox = document.getElementById(
            "select-all-characters-checkbox",
          );
          selectAllCheckbox.checked = false;

          // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§ï¼Œé˜²æ­¢äº‹ä»¶é‡å¤ç»‘å®š
          const newSelectAllCheckbox = selectAllCheckbox.cloneNode(true);
          selectAllCheckbox.parentNode.replaceChild(
            newSelectAllCheckbox,
            selectAllCheckbox,
          );
          newSelectAllCheckbox.addEventListener("change", (e) => {
            document.querySelectorAll(".export-char-checkbox").forEach((cb) => {
              cb.checked = e.target.checked;
            });
          });

          // 3. æ˜¾ç¤ºæ¨¡æ€æ¡†
          document
            .getElementById("advanced-transfer-modal")
            .classList.add("visible");
        }

        /**
         * æ‰§è¡Œåˆ†å—å¯¼å‡º (v3.0)
         */
        async function exportChunkedData() {
          await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨æ‰“åŒ…æ‚¨é€‰æ‹©çš„æ•°æ®...");

          const backupData = {
            type: "EPhoneChunkedBackup",
            version: 3,
            exportedAt: Date.now(),
            contains: [],
            data: {},
          };

          try {
            const appCheckboxes = document.querySelectorAll(
              ".export-app-checkbox:checked",
            );
            const charCheckboxes = document.querySelectorAll(
              ".export-char-checkbox:checked",
            );

            if (appCheckboxes.length === 0 && charCheckboxes.length === 0) {
              alert("è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹è¦å¯¼å‡ºçš„å†…å®¹ï¼");
              hideCustomModal();
              return;
            }

            const appsToExportMap = {
              weibo: { tables: ["weiboPosts", "qzoneSettings"] },
              forum: {
                tables: [
                  "forumGroups",
                  "forumPosts",
                  "forumComments",
                  "forumCategories",
                  "forumSeries",
                  "forumChapters",
                ],
              },
              taobao: {
                tables: [
                  "taobaoProducts",
                  "taobaoOrders",
                  "taobaoCart",
                  "userWalletTransactions",
                ],
              },
              worldBooks: { tables: ["worldBooks", "worldBookCategories"] },

              dateALive: {
                tables: [
                  "datingScenes",
                  "datingPresets",
                  "datingSpriteGroups",
                  "datingSprites",
                  "datingHistory",
                ],
              },

              tukeyAccounting: {
                tables: [
                  "tukeyAccounts",
                  "tukeyAccountingGroups",
                  "tukeyAccountingRecords",
                  "tukeyAccountingReplies",
                  "tukeyUserSettings",
                  "tukeyCustomConfig",
                ],
              },

              studio: {
                tables: ["studioScripts", "studioHistory"],
              },

              userStickers: {
                tables: ["userStickers", "userStickerCategories"],
              },
              charStickers: { tables: ["charStickers"] },
              gameData: {
                tables: [
                  "scriptKillScripts",
                  "ludoQuestionBanks",
                  "ludoQuestions",
                ],
              },
              appearance: {
                tables: [
                  "themes",
                  "fontPresets",
                  "homeScreenPresets",
                  "customAvatarFrames",
                  "apiPresets",
                  "bubbleStylePresets",
                ],
              },
            };

            // 1. å¯¼å‡ºé€‰ä¸­çš„Appæ•°æ®
            for (const checkbox of appCheckboxes) {
              const appId = checkbox.value;
              const appInfo = appsToExportMap[appId];
              if (appInfo) {
                backupData.contains.push(appId);
                for (const tableName of appInfo.tables) {
                  backupData.data[tableName] = await db[tableName].toArray();
                  console.log(`å·²æ‰“åŒ…Appæ•°æ®è¡¨: ${tableName}`);
                }
              }
            }

            // 2. å¯¼å‡ºé€‰ä¸­çš„è§’è‰²æ•°æ®
            const charIds = Array.from(charCheckboxes).map((cb) => cb.value);
            if (charIds.length > 0) {
              backupData.data.chats = await db.chats.bulkGet(charIds);
              backupData.contains.push(
                ...charIds.map((id) => `character_${id}`),
              );

              // æ‰“åŒ…æ‰€æœ‰ä¸è¿™äº›è§’è‰²å…³è”çš„æ•°æ®
              const relatedDataTables = [
                "memories",
                "callRecords",
                "qzonePosts",
                "weiboPosts",
                "datingHistory",
                "pomodoroSessions",
              ];
              const relatedKey = {
                memories: "chatId",
                callRecords: "chatId",
                qzonePosts: "authorId",
                weiboPosts: "authorId",
                datingHistory: "characterId",
                pomodoroSessions: "chatId",
              };

              for (const tableName of relatedDataTables) {
                const items = await db[tableName]
                  .where(relatedKey[tableName])
                  .anyOf(charIds)
                  .toArray();
                if (items.length > 0) {
                  if (!backupData.data[tableName])
                    backupData.data[tableName] = [];
                  // ä½¿ç”¨Setå»é‡ï¼Œé˜²æ­¢å› å¤šè§’è‰²å…³è”åŒä¸€æ•°æ®è€Œé‡å¤æ‰“åŒ…
                  const existingIds = new Set(
                    backupData.data[tableName].map((i) => i.id),
                  );
                  items.forEach((item) => {
                    if (!existingIds.has(item.id)) {
                      backupData.data[tableName].push(item);
                      existingIds.add(item.id);
                    }
                  });
                }
              }
              console.log(`å·²æ‰“åŒ… ${charIds.length} ä¸ªè§’è‰²çš„æ ¸å¿ƒåŠå…³è”æ•°æ®ã€‚`);
            }

            // 3. åˆ›å»ºJSONæ–‡ä»¶å¹¶è§¦å‘ä¸‹è½½
            const blob = new Blob([JSON.stringify(backupData, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `EPhone-Partial-Backup-${new Date().toISOString().split("T")[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            await showCustomAlert("å¯¼å‡ºæˆåŠŸ", "å·²æˆåŠŸå¯¼å‡ºæ‚¨é€‰ä¸­çš„æ•°æ®ï¼");
          } catch (error) {
            console.error("åˆ†å—å¯¼å‡ºå¤±è´¥:", error);
            await showCustomAlert("å¯¼å‡ºå¤±è´¥", `å‘ç”Ÿé”™è¯¯: ${error.message}`);
          } finally {
            document
              .getElementById("advanced-transfer-modal")
              .classList.remove("visible");
          }
        }

        /**
         * æ‰§è¡Œè¡¥å……å¼å¯¼å…¥
         * @param {File} file - ç”¨æˆ·é€‰æ‹©çš„JSONæ–‡ä»¶
         */
        async function importChunkedData(file) {
          if (!file) return;

          let data;
          try {
            const text = await file.text();
            data = JSON.parse(text);
          } catch (error) {
            await showCustomAlert(
              "å¯¼å…¥å¤±è´¥",
              "æ–‡ä»¶è¯»å–æˆ–è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚",
            );
            return;
          }

          if (data.type !== "EPhoneChunkedBackup") {
            const confirmed = await showCustomConfirm(
              "æ–‡ä»¶ç±»å‹ä¸åŒ¹é…",
              "è¿™æ˜¯ä¸€ä¸ªã€å…¨é‡å¤‡ä»½ã€‘æ–‡ä»¶ï¼Œç»§ç»­å¯¼å…¥å°†ä¼šã€è¦†ç›–ã€‘æ‰€æœ‰æ•°æ®ï¼æ˜¯å¦è¦ç»§ç»­ï¼Ÿ",
              { confirmButtonClass: "btn-danger" },
            );
            if (confirmed) importBackup(file);
            return;
          }

          const contentList = data.contains
            .map((item) => {
              const appNameMap = {
                weibo: "å¾®åš",
                forum: "åœˆå­",
                taobao: "æ¡ƒå®",
                worldBooks: "ä¸–ç•Œä¹¦",

                dateALive: "çº¦ä¼šå¤§ä½œæˆ˜æ•°æ®",

                tukeyAccounting: "å…”kè®°è´¦æ•°æ®",

                studio: "å°å‰§åœºæ•°æ®",

                userStickers: "æˆ‘çš„è¡¨æƒ…åŒ…",
                charStickers: "è§’è‰²é€šç”¨è¡¨æƒ…åŒ…",
                gameData: "æ¸¸æˆå¤§å…æ•°æ®",
                appearance: "é€šç”¨å¤–è§‚é¢„è®¾",
              };
              if (item.startsWith("character_")) {
                const charId = item.replace("character_", "");
                const charData = data.data.chats?.find((c) => c.id === charId);
                return `è§’è‰²æ•°æ®ï¼š${charData ? charData.name : "æœªçŸ¥è§’è‰²"}`;
              }
              return appNameMap[item] || item;
            })
            .join("\n- ");

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤å¯¼å…¥",
            `å³å°†å¯¼å…¥ä»¥ä¸‹å†…å®¹ï¼š\n\n- ${contentList}\n\næ³¨æ„ï¼šå¦‚æœç°æœ‰æ•°æ®ä¸­å·²å­˜åœ¨ç›¸åŒIDçš„å†…å®¹ï¼ˆå¦‚åŒåè§’è‰²ï¼‰ï¼Œä»–ä»¬çš„æ•°æ®å°†ä¼šè¢«å¯¼å…¥çš„æ•°æ®ã€å®Œå…¨è¦†ç›–ã€‘ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`,
          );

          if (!confirmed) return;

          await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨å¯¼å…¥æ•°æ®ï¼Œè¯·å‹¿å…³é—­é¡µé¢...");

          try {
            // 1. è·å–å¯¼å…¥æ–‡ä»¶ä¸­æœ‰å“ªäº›æ•°æ®è¡¨
            const tablesInBackup = Object.keys(data.data);

            // 2. è·å–å½“å‰æ•°æ®åº“ä¸­å®é™…å­˜åœ¨çš„æ‰€æœ‰æ•°æ®è¡¨åç§°
            const validTableNames = db.tables.map((t) => t.name);

            // 3. æ‰¾å‡ºäºŒè€…çš„äº¤é›†ï¼Œè¿™æ‰æ˜¯æˆ‘ä»¬çœŸæ­£éœ€è¦æ“ä½œçš„æ•°æ®è¡¨
            const tablesToUpdate = tablesInBackup.filter((t) =>
              validTableNames.includes(t),
            );

            console.log("å³å°†æ“ä½œçš„æœ‰æ•ˆæ•°æ®è¡¨:", tablesToUpdate);

            // 4. åªå¯¹è¿™äº›æœ‰æ•ˆçš„æ•°æ®è¡¨å¼€å¯ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡
            await db.transaction("rw", tablesToUpdate, async () => {
              for (const tableName of tablesToUpdate) {
                if (Array.isArray(data.data[tableName])) {
                  console.log(
                    `æ­£åœ¨å‘è¡¨æ ¼ "${tableName}" ä¸­è¡¥å……/è¦†ç›– ${data.data[tableName].length} æ¡æ•°æ®...`,
                  );
                  await db[tableName].bulkPut(data.data[tableName]);
                }
              }
            });

            await loadAllDataFromDB();
            await renderChatList();

            await showCustomAlert(
              "å¯¼å…¥æˆåŠŸ",
              "æ•°æ®å·²æˆåŠŸè¡¥å……ï¼åº”ç”¨å°†åˆ·æ–°ä»¥ç¡®ä¿æ‰€æœ‰æ•°æ®æ­£ç¡®åŠ è½½ã€‚",
            );
            setTimeout(() => window.location.reload(), 1500);
          } catch (error) {
            console.error("è¡¥å……å¼å¯¼å…¥å¤±è´¥:", error);
            await showCustomAlert(
              "å¯¼å…¥å¤±è´¥",
              `å†™å…¥æ•°æ®åº“æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`,
            );
          } finally {
            document
              .getElementById("advanced-transfer-modal")
              .classList.remove("visible");
          }
        }

        /**
         * ã€å…¼å®¹330ã€‘å°†å½“å‰Appçš„æ•°æ®å¯¼å‡ºä¸ºå…¼å®¹EPhone 330çš„æ ¼å¼
         */
        async function exportDataFor330() {
          await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨ä¸ºä½ å‡†å¤‡å…¼å®¹æ€§å¤‡ä»½æ–‡ä»¶...");

          const backupData = {
            version: 3, // å°†ç‰ˆæœ¬å·å¼ºåˆ¶å†™ä¸º3ï¼Œè®©330ç‰ˆæœ¬èƒ½è¯†åˆ«
            timestamp: Date.now(),
            data: {},
          };

          try {
            const [
              chatsFromDB,
              worldBooksFromDB,
              userStickersFromDB,
              apiConfigFromDB,
              globalSettingsFromDB,
              qzonePostsFromDB,
              qzoneAlbumsFromDB,
              qzonePhotosFromDB,
              qzoneSettingsFromDB,
              personaPresetsFromDB,
              memoriesFromDB,
              apiPresetsFromDB,
              favoritesFromDB,
              worldBookCategoriesFromDB,
              callRecordsFromDB,
              stickerCategoriesFromDB,
            ] = await Promise.all([
              db.chats.toArray(),
              db.worldBooks.toArray(),
              db.userStickers.toArray(),
              db.apiConfig.get("main"),
              db.globalSettings.get("main"),
              db.qzonePosts.toArray(),
              db.qzoneAlbums.toArray(),
              db.qzonePhotos.toArray(),
              db.qzoneSettings.get("main"),
              db.personaPresets.toArray(),
              db.memories.toArray(),
              db.apiPresets.toArray(),
              db.favorites.toArray(),
              db.worldBookCategories.toArray(),
              db.callRecords.toArray(),
              db.userStickerCategories.toArray(),
            ]);

            const transformedWorldBooks = worldBooksFromDB.map((book) => {
              const newBookFor330 = { ...book };
              if (
                typeof newBookFor330.content === "string" &&
                newBookFor330.content.trim()
              ) {
                newBookFor330.content = [
                  {
                    keys: [book.name],
                    comment: `ä» EPhone å¯¼å…¥çš„æ¡ç›®`,
                    content: book.content,
                    enabled: true,
                  },
                ];
              } else {
                newBookFor330.content = [];
              }
              return newBookFor330;
            });

            const transformedChats = chatsFromDB.map((chat) => {
              if (chat.isGroup) return chat;
              const settingsFor330 = {
                ...chat.settings,
                "ai-persona": chat.settings.aiPersona,
                "my-persona": chat.settings.myPersona,
                "ai-avatar": chat.settings.aiAvatar,
                "my-avatar": chat.settings.myAvatar,
              };
              return { ...chat, settings: settingsFor330 };
            });

            const transformedNpcs = [];
            const npcIdSet = new Set();
            for (const chat of chatsFromDB) {
              if (!chat.isGroup && Array.isArray(chat.npcLibrary)) {
                chat.npcLibrary.forEach((npc) => {
                  if (!npcIdSet.has(npc.id)) {
                    transformedNpcs.push({
                      id: npc.id,
                      name: npc.name,
                      avatar: npc.avatar,
                      persona: npc.persona,
                      associatedWith: [chat.id],
                    });
                    npcIdSet.add(npc.id);
                  } else {
                    const existingNpc = transformedNpcs.find(
                      (n) => n.id === npc.id,
                    );
                    if (existingNpc) existingNpc.associatedWith.push(chat.id);
                  }
                });
              }
            }

            const transformedQzoneSettings = {
              id: "main",
              nickname: qzoneSettingsFromDB?.nickname || "ä½ çš„æ˜µç§°",
              avatar:
                qzoneSettingsFromDB?.avatar ||
                "https://files.catbox.moe/q6z5fc.jpeg",
              banner:
                qzoneSettingsFromDB?.banner ||
                "https://files.catbox.moe/r5heyt.gif",
            };

            const transformedDoubanPosts = qzonePostsFromDB
              .filter((p) => p.authorId !== "user")
              .map((p) => ({
                id: p.id,
                timestamp: p.timestamp,
                groupName: "ä»åŠ¨æ€å¯¼å…¥çš„å°ç»„",
                postTitle: (p.publicText || p.content || "æ— æ ‡é¢˜").substring(
                  0,
                  50,
                ),
                authorName: state.chats[p.authorId]?.name || "æœªçŸ¥ä½œè€…",
                authorOriginalName: state.chats[p.authorId]?.name || "æœªçŸ¥ä½œè€…",
                content: p.content || p.publicText || "[å›¾ç‰‡]",
                likesCount: p.likes?.length || 0,
                commentsCount: p.comments?.length || 0,
                comments: (p.comments || []).map((c) => ({
                  commenter: c.commenterName,
                  text: c.text,
                })),
              }));

            backupData.data = {
              chats: transformedChats,
              npcs: transformedNpcs,
              worldBooks: transformedWorldBooks,
              worldBookCategories: worldBookCategoriesFromDB,
              userStickers: userStickersFromDB,
              stickerCategories: stickerCategoriesFromDB,
              apiConfig: apiConfigFromDB ? [apiConfigFromDB] : [],
              globalSettings: globalSettingsFromDB
                ? [globalSettingsFromDB]
                : [],
              qzoneSettings: [transformedQzoneSettings],
              qzonePosts: qzonePostsFromDB,
              qzoneAlbums: qzoneAlbumsFromDB,
              qzonePhotos: qzonePhotosFromDB,
              personaPresets: personaPresetsFromDB,
              memories: memoriesFromDB,
              apiPresets: apiPresetsFromDB,
              favorites: favoritesFromDB,
              doubanPosts: transformedDoubanPosts,
              callRecords: callRecordsFromDB,
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            const dateStr = new Date().toISOString().split("T")[0];
            link.href = url;
            link.download = `EPhone-Compatible-Backup-v330-${dateStr}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            await showCustomAlert(
              "å¯¼å‡ºæˆåŠŸ",
              "å·²æˆåŠŸç”Ÿæˆå…¼å®¹330ç‰ˆæœ¬çš„å¤‡ä»½æ–‡ä»¶ï¼ç°åœ¨ä½ å¯ä»¥å»330ç‰ˆæœ¬å¯¼å…¥å®ƒäº†ã€‚",
            );
          } catch (error) {
            console.error("å…¼å®¹æ€§å¯¼å‡ºå¤±è´¥:", error);
            await showCustomAlert(
              "å¯¼å‡ºå¤±è´¥",
              `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: ${error.message}`,
            );
          } finally {
            const modal = document.getElementById("advanced-transfer-modal");
            if (modal) {
              modal.classList.remove("visible");
            }
          }
        }

        /**
         * å¤„ç†å¹¶å¯¼å…¥æ¥è‡ª330ç‰ˆæœ¬æ ¼å¼çš„å¤‡ä»½æ–‡ä»¶
         * @param {File} file - ç”¨æˆ·é€‰æ‹©çš„330æ ¼å¼çš„JSONæ–‡ä»¶
         */
        async function importFrom330Format(file) {
          if (!file) return;

          const confirmed = await showCustomConfirm(
            "ä¸¥é‡è­¦å‘Šï¼",
            "æ‚¨æ­£åœ¨ä»330ç‰ˆæœ¬å¯¼å…¥æ•°æ®ï¼Œè¿™å°†ã€å®Œå…¨è¦†ç›–ã€‘æ‚¨å½“å‰çš„æ‰€æœ‰æ•°æ®ï¼æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ",
            { confirmButtonClass: "btn-danger" },
          );
          if (!confirmed) return;

          await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨è§£æå¹¶è½¬æ¢330ç‰ˆæœ¬çš„æ•°æ®...");

          try {
            const text = await file.text();
            const importedData = JSON.parse(text);

            if (importedData.version !== 3) {
              throw new Error(
                `æ–‡ä»¶ç‰ˆæœ¬ä¸åŒ¹é…ï¼éœ€è¦ç‰ˆæœ¬3ï¼Œä½†æä¾›çš„æ˜¯ç‰ˆæœ¬ ${importedData.version}ã€‚`,
              );
            }

            const data330 = importedData.data;

            // è¿™æ˜¯ä¸€ä¸ªå®‰å…¨åˆ—è¡¨ï¼Œç¡®ä¿æˆ‘ä»¬åªæ“ä½œæ‚¨æ•°æ®åº“ä¸­å­˜åœ¨çš„è¡¨
            const existingTables = [
              "chats",
              "worldBooks",
              "worldBookCategories",
              "userStickers",
              "userStickerCategories",
              "apiConfig",
              "globalSettings",
              "qzonePosts",
              "qzoneAlbums",
              "qzonePhotos",
              "qzoneSettings",
              "personaPresets",
              "memories",
              "apiPresets",
              "favorites",
              "musicLibrary",
              "callRecords",
              "customAvatarFrames",
              "themes",
              "bubbleStylePresets",
              "fontPresets",
              "homeScreenPresets",
              "weiboPosts",
              "forumGroups",
              "forumPosts",
              "forumComments",
              "forumCategories",
              "forumSeries",
              "forumChapters",
              "tarotReadings",
              "pomodoroSessions",
              "scriptKillScripts",
              "taobaoProducts",
              "taobaoOrders",
              "taobaoCart",
              "userWalletTransactions",
              "ludoQuestionBanks",
              "ludoQuestions",
              "datingScenes",
              "datingPresets",
              "datingSpriteGroups",
              "datingSprites",
              "datingHistory",
            ];

            await db.transaction("rw", existingTables, async () => {
              for (const tableName of existingTables) {
                if (db[tableName]) {
                  await db[tableName].clear();
                }
              }
              console.log("330å¯¼å…¥ï¼šå·²æ¸…ç©ºå…±æœ‰çš„æ•°æ®è¡¨ï¼Œå‡†å¤‡å¯¼å…¥...");

              // ä¸–ç•Œä¹¦å¯¼å…¥é€»è¾‘
              // ä¸å†åˆå¹¶ï¼Œè€Œæ˜¯å°†330çš„æ¯ä¸ªè¯æ¡æ‹†åˆ†æˆç‹¬ç«‹çš„ä¸–ç•Œä¹¦æ¡ç›®
              if (data330.worldBooks && Array.isArray(data330.worldBooks)) {
                const allNewWorldBookEntries = []; // åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„æ¥æ”¶é›†æ‰€æœ‰æ‹†åˆ†åçš„æ¡ç›®
                let entryCounter = 0; // ç”¨äºç”Ÿæˆå”¯ä¸€ID

                // 1. éå†330çš„æ¯ä¸€ä¸ªâ€œä¸–ç•Œä¹¦åˆé›†â€
                data330.worldBooks.forEach((book_330) => {
                  if (Array.isArray(book_330.content)) {
                    // 2. éå†åˆé›†ä¸­çš„æ¯ä¸€ä¸ªè¯æ¡
                    book_330.content.forEach((entry) => {
                      entryCounter++;

                      // 3. ä¸ºæ¯ä¸ªè¯æ¡ç”Ÿæˆæ–°çš„ç‹¬ç«‹ä¸–ç•Œä¹¦åç§°
                      // ä¼˜å…ˆä½¿ç”¨è¯æ¡çš„ `keys` ä½œä¸ºåç§°ï¼Œå…¶æ¬¡æ˜¯ `comment`ï¼Œæœ€åæ˜¯è‡ªåŠ¨ç”Ÿæˆ
                      let newName = `å¯¼å…¥æ¡ç›® ${entryCounter}`;
                      if (entry.keys && entry.keys.length > 0) {
                        newName = entry.keys.join(", "); // ç”¨å…³é”®è¯ä½œä¸ºæ–°åç§°
                      } else if (entry.comment) {
                        newName = entry.comment; // å…¶æ¬¡ç”¨å¤‡æ³¨ä½œä¸ºæ–°åç§°
                      }

                      // 4. ä¸ºæ¯ä¸ªè¯æ¡åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ã€ç‹¬ç«‹çš„ä¸–ç•Œä¹¦å¯¹è±¡
                      const newBookEntry = {
                        id: `imported_wb_${Date.now()}_${entryCounter}`, // ç”Ÿæˆå”¯ä¸€ID
                        name: newName,
                        content: entry.content || "", // å†…å®¹å°±æ˜¯è¯æ¡çš„å†…å®¹
                        categoryId: book_330.categoryId || 0, // ç»§æ‰¿åŸåˆé›†çš„åˆ†ç±»ID
                        isEnabled: entry.enabled !== false, // ç»§æ‰¿å¯ç”¨çŠ¶æ€ï¼Œé»˜è®¤ä¸ºtrue
                      };

                      // 5. å°†è¿™ä¸ªå…¨æ–°çš„ç‹¬ç«‹æ¡ç›®æ·»åŠ åˆ°æˆ‘ä»¬çš„æ”¶é›†ä¸­
                      allNewWorldBookEntries.push(newBookEntry);
                    });
                  }
                });

                // 6. ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ‹†åˆ†åçš„æ–°æ¡ç›®å†™å…¥æ•°æ®åº“
                await db.worldBooks.bulkPut(allNewWorldBookEntries);
                console.log(
                  `330å¯¼å…¥ï¼šæˆåŠŸâ€œæ‹†åˆ†â€å¹¶å¯¼å…¥ ${allNewWorldBookEntries.length} æ¡ç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®ã€‚`,
                );
              }
              // åˆ†ç±»ä¿¡æ¯ä¿æŒä¸å˜ï¼Œæ­£å¸¸å¯¼å…¥
              if (data330.worldBookCategories)
                await db.worldBookCategories.bulkPut(
                  data330.worldBookCategories,
                );

              // è½¬æ¢å¹¶å¯¼å…¥ã€èŠå¤©å’ŒNPCã€‘
              if (data330.chats && Array.isArray(data330.chats)) {
                const chatsToImport = [...data330.chats];
                const npcs = data330.npcs || [];
                chatsToImport.forEach((chat) => {
                  if (!chat.isGroup) {
                    chat.npcLibrary = [];
                    npcs.forEach((npc) => {
                      if (
                        npc.associatedWith &&
                        npc.associatedWith.includes(chat.id)
                      ) {
                        chat.npcLibrary.push({
                          id: npc.id,
                          name: npc.name,
                          persona: npc.persona,
                          avatar: npc.avatar,
                        });
                      }
                    });
                  }
                });
                await db.chats.bulkPut(chatsToImport);
                console.log(
                  `330å¯¼å…¥ï¼šæˆåŠŸè½¬æ¢å¹¶å¯¼å…¥ ${chatsToImport.length} ä¸ªèŠå¤©ã€‚`,
                );
              }

              // è½¬æ¢å¹¶å¯¼å…¥ã€è±†ç“£/åœˆå­ã€‘æ•°æ®
              if (data330.doubanPosts && Array.isArray(data330.doubanPosts)) {
                const groupMap = new Map();
                for (const post of data330.doubanPosts) {
                  let groupId;
                  if (groupMap.has(post.groupName)) {
                    groupId = groupMap.get(post.groupName);
                  } else {
                    const newGroup = {
                      name: post.groupName,
                      description: "ä»330å¯¼å…¥çš„å°ç»„",
                      icon: "ğŸ“–",
                    };
                    groupId = await db.forumGroups.add(newGroup);
                    groupMap.set(post.groupName, groupId);
                  }
                  await db.forumPosts.add({
                    id: post.id,
                    groupId: groupId,
                    title: post.postTitle,
                    content: post.content,
                    authorNickname: post.authorName,
                    timestamp: post.timestamp,
                    lengthType: "short",
                    likes: post.likesCount || 0,
                  });
                  if (post.comments && post.comments.length > 0) {
                    const commentsToSave = post.comments.map((c) => ({
                      postId: post.id,
                      author: c.commenter,
                      content: c.text,
                      timestamp: Date.now(),
                    }));
                    await db.forumComments.bulkAdd(commentsToSave);
                  }
                }
                console.log(
                  `330å¯¼å…¥ï¼šæˆåŠŸè½¬æ¢å¹¶å¯¼å…¥ ${data330.doubanPosts.length} æ¡åœˆå­å¸–å­ã€‚`,
                );
              }

              // è½¬æ¢å¹¶å¯¼å…¥å•å¯¹è±¡è®¾ç½®
              if (data330.apiConfig?.[0])
                await db.apiConfig.put(data330.apiConfig[0]);
              if (data330.globalSettings?.[0])
                await db.globalSettings.put(data330.globalSettings[0]);
              if (data330.qzoneSettings?.[0])
                await db.qzoneSettings.put(data330.qzoneSettings[0]);
              if (data330.musicLibrary?.[0])
                await db.musicLibrary.put(data330.musicLibrary[0]);

              // ç›´æ¥å¯¼å…¥å…¶ä»–ç»“æ„ç›¸åŒçš„ã€å…±æœ‰ã€‘æ•°æ®è¡¨
              const directImportTables = [
                "userStickers",
                "personaPresets",
                "qzonePosts",
                "qzoneAlbums",
                "qzonePhotos",
                "favorites",
                "memories",
                "callRecords",
                "apiPresets",
                "stickerCategories",
                "customAvatarFrames",
              ];
              for (const tableName of directImportTables) {
                if (
                  data330[tableName] &&
                  Array.isArray(data330[tableName]) &&
                  db[tableName]
                ) {
                  await db[tableName].bulkPut(data330[tableName]);
                  console.log(
                    `330å¯¼å…¥ï¼šæˆåŠŸå¯¼å…¥ ${data330[tableName].length} æ¡æ•°æ®åˆ° ${tableName}ã€‚`,
                  );
                }
              }
            });

            // å¯¼å…¥æˆåŠŸååˆ·æ–°é¡µé¢
            await showCustomAlert(
              "å¯¼å…¥æˆåŠŸ",
              "æ¥è‡ª330ç‰ˆæœ¬çš„æ•°æ®å·²æˆåŠŸå¯¼å…¥ï¼åº”ç”¨å³å°†åˆ·æ–°ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚",
            );
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } catch (error) {
            console.error("ä»330æ ¼å¼å¯¼å…¥å¤±è´¥:", error);
            await showCustomAlert(
              "å¯¼å…¥å¤±è´¥",
              `æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–æ•°æ®å·²æŸå: ${error.message}`,
            );
          }
        }

        /**
         * å‹ç¼©å›¾ç‰‡è‡³æŒ‡å®šè´¨é‡å¹¶è¿”å›Base64ï¼ŒåŒæ—¶è·³è¿‡GIF
         * @param {string} base64Str - åŸå§‹å›¾ç‰‡çš„Base64å­—ç¬¦ä¸² (data:...)
         * @param {number} quality - å‹ç¼©è´¨é‡ (0.1 - 1.0)
         * @returns {Promise<string>} - è¿”å›å‹ç¼©åçš„JPEGæ ¼å¼çš„Base64å­—ç¬¦ä¸²ï¼Œæˆ–åŸå§‹çš„GIF/PNGå­—ç¬¦ä¸²
         */
        function compressImage(base64Str, quality) {
          return new Promise((resolve, reject) => {
            // å¦‚æœæ˜¯ GIFï¼Œæˆ–è€…è´¨é‡è®¾ç½®ä¸º1.0ï¼ˆä¸å‹ç¼©ï¼‰ï¼Œç›´æ¥è¿”å›åŸå›¾ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†ã€‚
            if (
              base64Str.startsWith("data:image/gif") ||
              quality >= 1.0 ||
              !base64Str.startsWith("data:image")
            ) {
              resolve(base64Str);
              return;
            }

            const img = new Image();
            img.src = base64Str;

            img.onload = () => {
              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");
              canvas.width = img.width;
              canvas.height = img.height;
              ctx.drawImage(img, 0, 0);

              // ç¡®ä¿ PNG å’Œå…¶ä»–é™æ€å›¾èƒ½è¢«æ­£ç¡®å‹ç¼©ã€‚
              const compressedBase64 = canvas.toDataURL("image/jpeg", quality);
              resolve(compressedBase64);
            };

            img.onerror = (err) => {
              console.error("å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ— æ³•å‹ç¼©:", err);
              reject(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ— æ³•å‹ç¼©"));
            };
          });
        }

        /**
         * é€šç”¨æ–‡ä»¶ä¸Šä¼ å¹¶å‹ç¼©å¤„ç†å‡½æ•°
         * @param {File} file - ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶
         * @returns {Promise<string>} - è¿”å›å‹ç¼©åçš„Base64å­—ç¬¦ä¸²
         */
        async function handleImageUploadAndCompress(file) {
          const base64Url = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });

          const quality = state.globalSettings.imageCompressionQuality || 0.7;
          console.log(`å‡†å¤‡å‹ç¼©å›¾ç‰‡ï¼Œè´¨é‡: ${quality}`);

          const compressedBase64 = await compressImage(base64Url, quality);
          console.log(
            `å›¾ç‰‡å‹ç¼©å®Œæˆã€‚åŸå§‹å¤§å°: ${base64Url.length}, å‹ç¼©åå¤§å°: ${compressedBase64.length}`,
          );

          return compressedBase64;
        }
        window.handleImageUploadAndCompress = handleImageUploadAndCompress;
        /**
         * è®¡ç®—Base64å­—ç¬¦ä¸²çš„è¿‘ä¼¼æ–‡ä»¶å¤§å°
         * @param {string} base64Str - Base64å­—ç¬¦ä¸² (å¯ä»¥å¸¦'data:...'å‰ç¼€)
         * @returns {number} - å­—èŠ‚å¤§å°
         */
        function getBase64Size(base64Str) {
          if (
            !base64Str ||
            typeof base64Str !== "string" ||
            !base64Str.startsWith("data:image")
          )
            return 0;
          const base64 = base64Str.split(",")[1] || base64Str;
          const padding = base64.endsWith("==")
            ? 2
            : base64.endsWith("=")
              ? 1
              : 0;
          return (base64.length * 3) / 4 - padding;
        }

        /**
         * å°†å­—èŠ‚æ•°æ ¼å¼åŒ–ä¸ºæ˜“è¯»çš„å­—ç¬¦ä¸² (KB, MB, GB)
         * @param {number} bytes - å­—èŠ‚æ•°
         * @returns {string} - æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
         */
        function formatBytes(bytes) {
          if (bytes === 0) return "0 Bytes";
          const k = 1024;
          const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
          );
        }

        /**
         * è®¡ç®—å¹¶æ˜¾ç¤ºæ•°æ®åº“ä¸­æ‰€æœ‰å›¾ç‰‡çš„æ€»å¤§å°ï¼Œå¹¶è¿”å›æ•°å€¼
         * @returns {Promise<number>} - è¿”å›æ€»å­—èŠ‚æ•°
         */
        async function calculateTotalImageSize() {
          const displayEl = document.getElementById("image-data-size-display");
          displayEl.textContent = "æ­£åœ¨è®¡ç®—ä¸­...";

          let totalSize = 0;
          const processedUrls = new Set();

          const calculateSize = (url) => {
            if (
              !url ||
              typeof url !== "string" ||
              !url.startsWith("data:image") ||
              processedUrls.has(url)
            ) {
              return 0;
            }
            const size = getBase64Size(url);
            processedUrls.add(url);
            return size;
          };

          try {
            const allTables = db.tables.map((table) => table.name);
            for (const tableName of allTables) {
              try {
                const items = await db[tableName].toArray();
                for (const item of items) {
                  const findImagesRecursive = (obj) => {
                    for (const key in obj) {
                      if (typeof obj[key] === "string") {
                        totalSize += calculateSize(obj[key]);
                      } else if (
                        typeof obj[key] === "object" &&
                        obj[key] !== null
                      ) {
                        findImagesRecursive(obj[key]);
                      }
                    }
                  };
                  findImagesRecursive(item);
                }
              } catch (e) {
                console.warn(`æ‰«æè¡¨ ${tableName} å‡ºé”™:`, e);
              }
            }

            displayEl.textContent = `å½“å‰å›¾ç‰‡æ•°æ®æ€»é‡çº¦: ${formatBytes(totalSize)}`;
            return totalSize; // è¿”å›è®¡ç®—å‡ºçš„æ€»å¤§å°
          } catch (error) {
            console.error("è®¡ç®—å›¾ç‰‡å¤§å°æ—¶å‡ºé”™:", error);
            displayEl.textContent = "è®¡ç®—å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚";
            return 0;
          }
        }

        /**
         * ä¸€é”®å‹ç¼©æ•°æ®åº“ä¸­æ‰€æœ‰å›¾ç‰‡çš„æ ¸å¿ƒå‡½æ•°
         */
        async function compressAllImagesInDB() {
          const confirmed = await showCustomConfirm(
            "é«˜é£é™©æ“ä½œç¡®è®¤",
            "æ­¤æ“ä½œå°†æ‰«æå¹¶ã€æ°¸ä¹…æ€§åœ°ã€‘å‹ç¼©æ•°æ®åº“ä¸­çš„ã€æ‰€æœ‰é™æ€å›¾ç‰‡ï¼ˆPNG/JPGç­‰ï¼‰ã€‘ã€‚<br><br>ã€GIFåŠ¨å›¾ä¼šè¢«è‡ªåŠ¨è·³è¿‡ï¼Œä¸ä¼šè¢«å‹ç¼©ã€‘ã€‚<br><br>å‹ç¼©æ˜¯ä¸å¯é€†çš„ï¼Œå»ºè®®åœ¨æ“ä½œå‰å…ˆã€å¯¼å‡ºæ•°æ®ã€‘è¿›è¡Œå¤‡ä»½ï¼<br><br>ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ",
            { confirmButtonClass: "btn-danger" },
          );

          if (!confirmed) return;

          const loadingOverlay = document.getElementById("generation-overlay");
          const loadingText = loadingOverlay.querySelector("p");
          loadingText.textContent = "æ­£åœ¨å…¨åŠ›å‹ç¼©å›¾ç‰‡ï¼Œè¯·è€å¿ƒç­‰å¾…...";
          loadingOverlay.classList.add("visible");

          try {
            const quality =
              parseFloat(
                document.getElementById("image-quality-slider").value,
              ) || 0.7;
            const originalTotalSize = await calculateTotalImageSize();
            let itemsProcessed = 0;
            let compressedCount = 0;

            const findAndCompressImagesInObject = async (obj) => {
              let hasCompressed = false;
              for (const key in obj) {
                if (
                  typeof obj[key] === "string" &&
                  obj[key].startsWith("data:image")
                ) {
                  const originalUrl = obj[key];
                  const compressedUrl = await compressImage(
                    originalUrl,
                    quality,
                  );
                  if (originalUrl !== compressedUrl) {
                    obj[key] = compressedUrl;
                    hasCompressed = true;
                    compressedCount++; // è®°å½•å‹ç¼©äº†å¤šå°‘å¼ å›¾ç‰‡
                  }
                } else if (typeof obj[key] === "object" && obj[key] !== null) {
                  if (await findAndCompressImagesInObject(obj[key])) {
                    hasCompressed = true;
                  }
                }
              }
              return hasCompressed;
            };

            const allTables = db.tables.map((table) => table.name);
            for (const tableName of allTables) {
              loadingText.textContent = `æ­£åœ¨æ‰«æè¡¨: ${tableName}...`;
              const itemsToUpdate = [];
              const allItems = await db[tableName].toArray();

              for (const item of allItems) {
                if (await findAndCompressImagesInObject(item)) {
                  itemsToUpdate.push(item);
                }
                itemsProcessed++;
                if (itemsProcessed % 20 === 0) {
                  loadingText.textContent = `å·²å¤„ç† ${itemsProcessed} æ¡æ•°æ®... å‹ç¼©äº† ${compressedCount} å¼ å›¾ç‰‡...`;
                }
              }

              if (itemsToUpdate.length > 0) {
                loadingText.textContent = `æ­£åœ¨ä¿å­˜ ${tableName} çš„å‹ç¼©ç»“æœ...`;
                await db[tableName].bulkPut(itemsToUpdate);
                console.log(
                  `è¡¨ ${tableName} ä¸­æœ‰ ${itemsToUpdate.length} æ¡è®°å½•çš„å›¾ç‰‡è¢«å‹ç¼©ã€‚`,
                );
              }
            }

            loadingOverlay.classList.remove("visible");

            const newTotalSize = await calculateTotalImageSize();
            const savedSize = originalTotalSize - newTotalSize;

            await showCustomAlert(
              "å‹ç¼©å®Œæˆï¼",
              `æ“ä½œæˆåŠŸï¼\nåŸå§‹å¤§å°: ${formatBytes(originalTotalSize)}\nå‹ç¼©åå¤§å°: ${formatBytes(
                newTotalSize,
              )}\næˆåŠŸä¸ºæ‚¨èŠ‚çœäº† ${formatBytes(savedSize)} çš„ç©ºé—´ï¼\n\nåº”ç”¨å³å°†åˆ·æ–°ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚`,
            );

            setTimeout(() => window.location.reload(), 2000);
          } catch (error) {
            // å‡ºé”™æ—¶ä¹Ÿè¦ç¡®ä¿åŠ è½½åŠ¨ç”»è¢«éšè—
            loadingOverlay.classList.remove("visible");
            console.error("å‹ç¼©å…¨éƒ¨å›¾ç‰‡æ—¶å‡ºé”™:", error);
            await showCustomAlert(
              "å‹ç¼©å¤±è´¥",
              `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: ${error.message}`,
            );
          }
        }

        /**
         * æµå¼å¯¼å‡ºå‡½æ•° (å¤§æ•°æ®ä¸“ç”¨)
         * åŸç†ï¼šä¸å†ä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰æ•°æ®åº“è¡¨åˆ°å†…å­˜ï¼Œè€Œæ˜¯é€ä¸ªè¡¨è¯»å–ã€å†™å…¥ï¼Œ
         * åˆ©ç”¨ ReadableStream å’Œ Response æµå¼ä¼ è¾“ç»™ç”¨æˆ·ï¼Œä»è€Œæå¤§é™ä½å†…å­˜å ç”¨ã€‚
         */
        async function exportDataStream() {
          await showCustomAlert(
            "è¯·ç¨å€™...",
            "æ­£åœ¨å‡†å¤‡æµå¼å¯¼å‡ºï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œä½†ä¸ä¼šä½¿æµè§ˆå™¨å´©æºƒã€‚",
          );

          // å®šä¹‰æ‰€æœ‰éœ€è¦å¤‡ä»½çš„æ•°æ®åº“è¡¨å
          const tablesToExport = [
            "chats",
            "apiConfig",
            "globalSettings",
            "userStickers",
            "charStickers",
            "worldBooks",
            "musicLibrary",
            "personaPresets",
            "qzoneSettings",
            "qzonePosts",
            "qzoneAlbums",
            "qzonePhotos",
            "favorites",
            "qzoneGroups",
            "memories",
            "worldBookCategories",
            "callRecords",
            "customAvatarFrames",
            "themes",
            "apiPresets",
            "bubbleStylePresets",
            "fontPresets",
            "homeScreenPresets",
            "weiboPosts",
            "forumGroups",
            "forumPosts",
            "forumComments",
            "forumCategories",
            "forumSeries",
            "forumChapters",
            "tarotReadings",
            "pomodoroSessions",
            "scriptKillScripts",
            "taobaoProducts",
            "taobaoOrders",
            "taobaoCart",
            "userWalletTransactions",
            "userStickerCategories",
            "datingScenes",
            "datingPresets",
            "datingSpriteGroups",
            "datingSprites",
            "datingHistory",
          ];

          const stream = new ReadableStream({
            async start(controller) {
              const encoder = new TextEncoder();

              // 1. å†™å…¥JSONæ–‡ä»¶çš„å¼€å¤´
              controller.enqueue(encoder.encode("{\n"));

              // 2. æ·»åŠ ç‰ˆæœ¬å’Œæ—¶é—´æˆ³å…ƒæ•°æ®
              const metaData = `"version": 1,\n"timestamp": ${Date.now()},\n`;
              controller.enqueue(encoder.encode(metaData));

              // 3. é€ä¸ªå¤„ç†æ•°æ®åº“è¡¨
              for (let i = 0; i < tablesToExport.length; i++) {
                const tableName = tablesToExport[i];
                console.log(`æµå¼å¯¼å‡ºï¼šæ­£åœ¨å¤„ç†è¡¨ ${tableName}...`);

                try {
                  // 1. å®šä¹‰å“ªäº›è¡¨æ˜¯å•ä¸ªå¯¹è±¡çš„è®¾ç½®è¡¨
                  const singleObjectTables = [
                    "apiConfig",
                    "globalSettings",
                    "musicLibrary",
                    "qzoneSettings",
                    "tukeyUserSettings",
                    "tukeyCustomConfig",
                    "tukeyAccountingGroups",
                  ];

                  let tableData;
                  // 2. åˆ¤æ–­å½“å‰è¡¨æ˜¯å¦æ˜¯å•ä¸ªå¯¹è±¡çš„è®¾ç½®è¡¨
                  if (singleObjectTables.includes(tableName)) {
                    // å¦‚æœæ˜¯ï¼Œå°±åªè·å–ç¬¬ä¸€ä¸ªï¼ˆä¹Ÿå¯èƒ½æ˜¯å”¯ä¸€ä¸€ä¸ªï¼‰å¯¹è±¡
                    tableData = await db[tableName].toCollection().first();
                    // å¦‚æœè¡¨æ˜¯ç©ºçš„ï¼Œfirst()ä¼šè¿”å›undefinedï¼ŒJSON.stringify(undefined)ä¼šå‡ºé—®é¢˜ï¼Œæ‰€ä»¥è½¬ä¸ºnull
                    if (tableData === undefined) {
                      tableData = null;
                    }
                  } else {
                    // å¦‚æœæ˜¯æ™®é€šçš„å¤šæ¡è®°å½•è¡¨ï¼Œå°±è¿˜æ˜¯è·å–æ•´ä¸ªæ•°ç»„
                    tableData = await db[tableName].toArray();
                  }

                  const jsonString = JSON.stringify(tableData);

                  // å†™å…¥ "tableName": [...] æˆ– "tableName": {...}
                  controller.enqueue(
                    encoder.encode(`"${tableName}": ${jsonString}`),
                  );

                  // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªè¡¨ï¼Œå°±åŠ ä¸Šé€—å·å’Œæ¢è¡Œç¬¦
                  if (i < tablesToExport.length - 1) {
                    controller.enqueue(encoder.encode(",\n"));
                  } else {
                    controller.enqueue(encoder.encode("\n"));
                  }
                } catch (e) {
                  console.error(`æµå¼å¯¼å‡ºæ—¶ï¼Œå¤„ç†è¡¨ ${tableName} å¤±è´¥:`, e);
                  // å³ä½¿æŸä¸ªè¡¨å¤±è´¥ï¼Œä¹Ÿç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
                }
              }

              // 4. å†™å…¥JSONæ–‡ä»¶çš„ç»“å°¾
              controller.enqueue(encoder.encode("}"));

              // 5. é€šçŸ¥æµå·²ç»ç»“æŸ
              controller.close();
              console.log("æµå¼å¯¼å‡ºï¼šæ‰€æœ‰æ•°æ®å†™å…¥å®Œæˆã€‚");
            },
          });

          // 6. ä½¿ç”¨ Response å°†æµåŒ…è£…æˆå¯ä¸‹è½½çš„æ–‡ä»¶
          const response = new Response(stream, {
            headers: { "Content-Type": "application/json" },
          });

          // 7. åˆ›å»ºå¹¶è§¦å‘ä¸‹è½½é“¾æ¥
          const url = URL.createObjectURL(await response.blob());
          const link = document.createElement("a");
          link.href = url;
          link.download = `EPhone-Stream-Backup-${new Date().toISOString().split("T")[0]}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          // å…³é—­â€œè¯·ç¨å€™â€çš„å¼¹çª—
          hideCustomModal();
        }
        /**
         * æ¢å¤æ‰€æœ‰Appåç§°ä¸ºé»˜è®¤å€¼
         */
        async function resetAppNamesToDefault() {
          // 1. å¼¹å‡ºç¡®è®¤æ¡†ï¼Œé˜²æ­¢è¯¯æ“ä½œ
          const confirmed = await showCustomConfirm(
            "æ¢å¤é»˜è®¤åç§°",
            "ç¡®å®šè¦å°†æ‰€æœ‰Appçš„åç§°æ¢å¤ä¸ºé»˜è®¤è®¾ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚",
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            // 2. æ¸…ç©ºå­˜å‚¨è‡ªå®šä¹‰åç§°çš„å¯¹è±¡
            state.globalSettings.appLabels = {};

            // 3. å°†æ›´æ”¹ä¿å­˜åˆ°æ•°æ®åº“
            await db.globalSettings.put(state.globalSettings);

            // 4. ç«‹å³åº”ç”¨æ›´æ”¹åˆ°UI
            applyAppLabels(); // æ›´æ–°ä¸»å±å¹•ä¸ŠAppçš„æ˜¾ç¤ºåç§°
            renderAppNameSettings(); // åˆ·æ–°å¤–è§‚è®¾ç½®é¡µé¢çš„è¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºå›é»˜è®¤å

            // 5. ç»™å‡ºæˆåŠŸæç¤º
            await showCustomAlert("æ“ä½œæˆåŠŸ", "æ‰€æœ‰Appåç§°å·²æ¢å¤ä¸ºé»˜è®¤ã€‚");
          }
        }

        window.activeGroupId = null;

        const SYMBOL_THRESHOLDS = [
          {
            id: "first_heartbeat",
            level: 100,
            symbol:
              "https://i.postimg.cc/DZSsNzMB/5BF06FFB38AAF2B394F89F6270D328D5.png",
            name: "åˆè¯†å¿ƒåŠ¨",
            description: "å¿ƒè·³æ˜¯æ•…äº‹çš„å¼€å§‹ã€‚",
          },
          {
            id: "shining_star",
            level: 300,
            symbol:
              "https://i.postimg.cc/L47gJRb3/7227080E4BF5950D1B182043D1F734DB.png",
            name: "æ˜Ÿå…‰é—ªçƒ",
            description: "ä½ ä»¬çš„å…³ç³»åƒæ˜Ÿå…‰ä¸€æ ·å¼€å§‹é—ªè€€ã€‚",
          },
          {
            id: "burning_passion",
            level: 700,
            symbol:
              "https://i.postimg.cc/yNQcnRvT/BD0C0CC3C6692D736014BACE73C07F8E.png",
            name: "çƒ­æƒ…å¦‚ç«",
            description: "æ¯ä¸€æ¬¡äº’åŠ¨éƒ½è®©æ„Ÿæƒ…å‡æ¸©ã€‚",
          },
          {
            id: "only_crown",
            level: 1500,
            symbol:
              "https://i.postimg.cc/B6jDzvVh/92DD1E30EFEEC589E3BE0FFB630F8B4E.png",
            name: "å”¯ä¸€ç‹å† ",
            description: "åœ¨å½¼æ­¤çš„ä¸–ç•Œé‡Œï¼Œå¯¹æ–¹æ˜¯ç‹¬ä¸€æ— äºŒçš„å­˜åœ¨ã€‚",
          },
          {
            id: "eternal_diamond",
            level: 5000,
            symbol:
              "https://i.postimg.cc/C1RD2KQc/B0E2B3034728540DA4198357D5B8131C.png",
            name: "æ°¸æ’ä¹‹é’»",
            description: "ä½ ä»¬çš„å…³ç³»å¦‚é’»çŸ³èˆ¬åšå›ºè€Œç’€ç’¨ã€‚",
          },
        ];

        /**
         * æ ¸å¿ƒï¼šè®¡ç®—äº²å¯†å€¼
         * @param {object} chat - èŠå¤©å¯¹è±¡
         * @returns {number} - è®¡ç®—å‡ºçš„äº²å¯†å€¼åˆ†æ•°
         */
        function calculateIntimacy(chat) {
          if (!chat || !chat.settings.streak) return 0;

          // åŸºç¡€åˆ†ï¼šç«èŠ±å¤©æ•°ï¼Œæ¯å¤©éƒ½å¾ˆé‡è¦ï¼
          const streakDays = chat.settings.streak.currentDays || 0;
          const streakScore = streakDays * 15; // æ¯å¤©ç«èŠ±æä¾›15ç‚¹åŸºç¡€åˆ†

          // äº’åŠ¨åˆ†ï¼šç´¯è®¡æ¶ˆæ¯æ€»æ•°
          const stats = chat.interactionStats || {};
          const totalMessages = Object.values(stats).reduce(
            (sum, count) => sum + count,
            0,
          );
          const messageScore = totalMessages * 0.2; // æ¯æ¡æ¶ˆæ¯æä¾›0.2ç‚¹äº’åŠ¨åˆ†

          const intimacy = streakScore + messageScore;
          return Math.floor(intimacy); // è¿”å›æ•´æ•°
        }

        /**
         * æ ¸å¿ƒï¼šæ£€æŸ¥å¹¶è§£é”æ–°çš„å¾½ç« 
         * @param {object} chat - èŠå¤©å¯¹è±¡
         * @param {number} intimacyValue - å½“å‰çš„äº²å¯†å€¼
         * @returns {Promise<boolean>} - å¦‚æœæœ‰æ–°å¾½ç« è§£é”ï¼Œè¿”å›true
         */
        async function checkAndUnlockSymbols(chat, intimacyValue) {
          let newUnlock = false;
          if (!chat.unlockedSymbols) chat.unlockedSymbols = [];

          SYMBOL_THRESHOLDS.forEach((threshold) => {
            // æ£€æŸ¥ï¼šäº²å¯†å€¼æ˜¯å¦è¾¾æ ‡ï¼Ÿè¿™ä¸ªå¾½ç« æ˜¯ä¸æ˜¯è¿˜æ²¡è§£é”è¿‡ï¼Ÿ
            if (
              intimacyValue >= threshold.level &&
              !chat.unlockedSymbols.some((s) => s.symbol === threshold.symbol)
            ) {
              // å¦‚æœéƒ½æ»¡è¶³ï¼Œå°±è§£é”ï¼
              chat.unlockedSymbols.push({
                symbol: threshold.symbol,
                name: threshold.name,
                unlockedAt: Date.now(), // è®°å½•è§£é”çš„ç²¾ç¡®æ—¶é—´
              });
              newUnlock = true;
              console.log(
                `å¾½ç« è§£é”ï¼è§’è‰²: ${chat.name}, å¾½ç« : ${threshold.name}`,
              );
            }
          });

          // å¦‚æœæœ‰æ–°è§£é”çš„å¾½ç« ï¼Œå°±æ›´æ–°æ•°æ®åº“å¹¶å¼¹çª—æç¤º
          if (newUnlock) {
            await db.chats.put(chat);
            // æ‰¾åˆ°æœ€æ–°è§£é”çš„é‚£ä¸ªå¾½ç« æ¥æ˜¾ç¤ºé€šçŸ¥
            const latestUnlock =
              chat.unlockedSymbols[chat.unlockedSymbols.length - 1];
            await showCustomAlert(
              "æ–°å¾½ç« å·²è§£é”ï¼",
              `æ­å–œä½ å’Œâ€œ${chat.name}â€è§£é”äº†æ–°çš„äº²å¯†å¾½ç« ï¼š${latestUnlock.name}`,
            );
          }
          return newUnlock;
        }

        async function openIntimacyPanel(chatId) {
          const chat = state.chats[chatId];
          if (!chat) return;

          // --- æ•°æ®è®¡ç®— ---
          const intimacyValue = calculateIntimacy(chat);
          await checkAndUnlockSymbols(chat, intimacyValue);

          // --- å¡«å……UI (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜) ---
          document.getElementById("intimacy-score-display").textContent =
            intimacyValue;
          const today = new Date().toISOString().split("T")[0];
          const todayMsgs = chat.interactionStats?.[today] || 0;
          const totalMsgs = Object.values(chat.interactionStats || {}).reduce(
            (sum, count) => sum + count,
            0,
          );
          document.getElementById("intimacy-streak-days").textContent =
            `${chat.settings.streak?.currentDays || 0} å¤©`;
          document.getElementById("intimacy-today-msgs").textContent =
            `${todayMsgs} æ¡`;
          document.getElementById("intimacy-total-msgs").textContent =
            `${totalMsgs} æ¡`;

          // --- æ¸²æŸ“å¯ç‚¹å‡»çš„å¾½ç« åˆ—è¡¨ ---
          const symbolListContainer = document.getElementById(
            "symbol-list-container",
          );
          symbolListContainer.innerHTML = "";

          // æ·»åŠ ä¸€ä¸ªâ€œä¸ä½©æˆ´â€çš„é€‰é¡¹
          const noneItem = document.createElement("div");
          noneItem.className = "symbol-item unlocked"; // è®©å®ƒæ€»æ˜¯å¯ç‚¹å‡»
          if (!chat.settings.selectedIntimacyBadge) {
            noneItem.classList.add("selected"); // å¦‚æœå½“å‰æ²¡ä½©æˆ´ï¼Œå°±é«˜äº®è¿™ä¸ª
          }
          noneItem.innerHTML = `<div class="symbol-icon no-badge">ğŸš«</div><div class="symbol-name">ä¸ä½©æˆ´</div>`;
          noneItem.onclick = () => selectIntimacyBadge(chatId, ""); // ç‚¹å‡»æ—¶ï¼Œä¼ å…¥ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä¸ä½©æˆ´
          symbolListContainer.appendChild(noneItem);

          // æ¸²æŸ“æ‰€æœ‰å¯è§£é”çš„å¾½ç« 
          SYMBOL_THRESHOLDS.forEach((threshold) => {
            const isUnlocked = intimacyValue >= threshold.level;
            const isSelected =
              chat.settings.selectedIntimacyBadge === threshold.symbol;

            const item = document.createElement("div");
            item.className = `symbol-item ${isUnlocked ? "unlocked" : ""} ${isSelected ? "selected" : ""}`;

            // ä½¿ç”¨ <img> æ ‡ç­¾æ¥æ˜¾ç¤ºå›¾ç‰‡
            item.innerHTML = `
			            <div class="symbol-icon ${!isUnlocked ? "not-unlocked" : ""}">
			                <img src="${threshold.symbol}" alt="${threshold.name}">
			            </div>
			            <div class="symbol-name">${threshold.name}</div>
			            <div class="symbol-level">${isUnlocked ? "å·²è§£é”" : `${threshold.level}åˆ†è§£é”`}</div>
			        `;

            // åªæœ‰è§£é”äº†çš„å¾½ç« æ‰èƒ½ç‚¹å‡»
            if (isUnlocked) {
              item.onclick = () =>
                selectIntimacyBadge(chatId, threshold.symbol);
            }

            symbolListContainer.appendChild(item);
          });

          // --- æ¸²æŸ“è§£é”è®°å½• ---
          const recordsContainer = document.getElementById(
            "unlocked-symbols-record",
          );
          recordsContainer.innerHTML = "";
          if (chat.unlockedSymbols && chat.unlockedSymbols.length > 0) {
            const sortedRecords = [...chat.unlockedSymbols].sort(
              (a, b) => b.unlockedAt - a.unlockedAt,
            );
            sortedRecords.forEach((record) => {
              const recordItem = document.createElement("div");
              recordItem.className = "record-item";
              recordItem.innerHTML = `<span class="symbol"><img src="${
                record.symbol
              }" style="height:1em; vertical-align:middle;"></span><span>${
                record.name
              }</span><span class="date">${new Date(record.unlockedAt).toLocaleDateString()}</span>`;
              recordsContainer.appendChild(recordItem);
            });
          } else {
            recordsContainer.innerHTML =
              '<p style="text-align:center; color:#999; font-size:13px;">æš‚æ— å·²è§£é”çš„å¾½ç« </p>';
          }

          // --- æ˜¾ç¤ºé¢æ¿ ---
          document.getElementById("intimacy-panel").classList.add("visible");
        }

        /**
         * é€‰æ‹©å¹¶ä½©æˆ´ä¸€ä¸ªäº²å¯†å¾½ç« 
         * @param {string} chatId - è§’è‰²ID
         * @param {string} symbol - è¦ä½©æˆ´çš„å¾½ç« ç¬¦å·ï¼Œæˆ–''è¡¨ç¤ºä¸ä½©æˆ´
         */
        async function selectIntimacyBadge(chatId, symbol) {
          const chat = state.chats[chatId];
          if (!chat) return;

          // æ›´æ–°é€‰æ‹©
          chat.settings.selectedIntimacyBadge = symbol;

          // ä¿å­˜åˆ°æ•°æ®åº“
          await db.chats.put(chat);

          // é‡æ–°æ¸²æŸ“é¢æ¿ï¼Œæ›´æ–°é«˜äº®çŠ¶æ€
          await openIntimacyPanel(chatId);

          // é‡æ–°æ¸²æŸ“èŠå¤©åˆ—è¡¨ï¼Œè®©å¾½ç« ç«‹åˆ»æ˜¾ç¤ºå‡ºæ¥
          await renderChatList();
        }

        /**
         * æ ¸å¿ƒï¼šä¸ºæŒ‡å®šèŠå¤©çš„ä»Šå¤©æ¶ˆæ¯æ•°+1
         * @param {string} chatId - èŠå¤©ID
         */
        async function incrementMessageCount(chatId) {
          const chat = state.chats[chatId];
          // åªä¸ºå•äººèŠå¤©è®¡æ•°
          if (!chat || chat.isGroup) return;

          const today = new Date().toISOString().split("T")[0]; // è·å– YYYY-MM-DD æ ¼å¼çš„æ—¥æœŸ

          if (!chat.interactionStats) {
            chat.interactionStats = {};
          }

          chat.interactionStats[today] =
            (chat.interactionStats[today] || 0) + 1;

          // å°†æ›´æ–°åçš„èŠå¤©æ•°æ®ä¿å­˜å›æ•°æ®åº“
          await db.chats.put(chat);
        }

        /**
         * è·å–æˆ–ç”Ÿæˆå½“å‰è®¾å¤‡çš„å”¯ä¸€è®¾å¤‡ç 
         * @returns {string} - ä¸€é•¿ä¸²å”¯ä¸€çš„è®¾å¤‡ç 
         */
        function getDeviceCode() {
          const deviceIdKey = "ephone-device-code"; // ä½¿ç”¨ä¸€ä¸ªæ–°çš„é”®å
          let deviceId = localStorage.getItem(deviceIdKey);
          if (!deviceId) {
            deviceId = crypto.randomUUID();
            localStorage.setItem(deviceIdKey, deviceId);
          }
          return deviceId;
        }

        /**
         * æ ¹æ®è®¾å¤‡ç ç”Ÿæˆå¯¹åº”çš„PINç  (è¿™ä¸ªå‡½æ•°å¿…é¡»å’Œ get_pin.html ä¸­çš„å®Œå…¨ä¸€è‡´ï¼)
         * @param {string} deviceCode - è®¾å¤‡ç 
         * @returns {string} - 6ä½å¤§å†™çš„PINç 
         */
        function generatePinFromDeviceCode(deviceCode) {
          if (!deviceCode || deviceCode.length < 6) return "INVALID";
          // ç®—æ³•ï¼šå°†è®¾å¤‡ç åè½¬ï¼Œå–å‰6ä½ï¼Œè½¬å¤§å†™
          return deviceCode
            .split("")
            .reverse()
            .join("")
            .substring(0, 6)
            .toUpperCase();
        }
        /**
         * æ¸…ç©ºæ‰€æœ‰å¥½å‹åŠ¨æ€ï¼ˆä¸åŒ…æ‹¬å¾®åšå’Œåœˆå­ï¼‰
         */
        async function clearAllQzonePosts() {
          // 1. å¼¹å‡ºç¡®è®¤æ¡†ï¼Œé˜²æ­¢ç”¨æˆ·è¯¯æ“ä½œ
          const confirmed = await showCustomConfirm(
            "ç¡®è®¤æ¸…ç©º",
            "æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰å¥½å‹åŠ¨æ€ï¼ˆä¸åŒ…æ‹¬å¾®åšå’Œåœˆå­ï¼‰ï¼Œä¸”æ— æ³•æ¢å¤ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ",
            { confirmButtonClass: "btn-danger" }, // ä½¿ç”¨çº¢è‰²æŒ‰é’®è­¦ç¤º
          );

          if (!confirmed) {
            return; // å¦‚æœç”¨æˆ·ç‚¹å‡»â€œå–æ¶ˆâ€ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
          }

          try {
            // 2. æ¸…ç©ºæ•°æ®åº“ä¸­çš„ `qzonePosts` è¡¨ï¼Œè¿™æ˜¯å­˜å‚¨æ‰€æœ‰åŠ¨æ€çš„åœ°æ–¹
            await db.qzonePosts.clear();
            console.log("`qzonePosts` table has been cleared.");

            // 3. æ¸…ç†æ‰€æœ‰è§’è‰²çš„å†å²è®°å½•ï¼Œç§»é™¤ä¸åŠ¨æ€ç›¸å…³çš„ç³»ç»Ÿé€šçŸ¥ï¼Œä¿æŒæ•°æ®ä¸€è‡´æ€§
            const allChats = Object.values(state.chats);
            const chatsToUpdate = [];
            for (const chat of allChats) {
              const originalHistoryLength = chat.history.length;
              // ç­›é€‰æ‰å†…å®¹åŒ…å«â€œå‘å¸ƒäº†â€çš„ç³»ç»Ÿæ¶ˆæ¯
              chat.history = chat.history.filter(
                (msg) =>
                  !(
                    msg.role === "system" &&
                    msg.content &&
                    msg.content.includes("å‘å¸ƒäº†")
                  ),
              );
              if (chat.history.length < originalHistoryLength) {
                chatsToUpdate.push(chat);
              }
            }
            if (chatsToUpdate.length > 0) {
              await db.chats.bulkPut(chatsToUpdate);
              console.log(
                `å·²ä» ${chatsToUpdate.length} ä¸ªè§’è‰²çš„å†å²è®°å½•ä¸­ç§»é™¤åŠ¨æ€é€šçŸ¥ã€‚`,
              );
            }

            // 4. é‡æ–°æ¸²æŸ“åŠ¨æ€åˆ—è¡¨ï¼Œç•Œé¢ä¼šæ˜¾ç¤ºä¸ºç©º
            await renderQzonePosts();

            // 5. ç»™å‡ºæˆåŠŸæç¤º
            alert("æ‰€æœ‰å¥½å‹åŠ¨æ€å·²æ¸…ç©ºï¼");
          } catch (error) {
            console.error("æ¸…ç©ºå¥½å‹åŠ¨æ€æ—¶å‡ºé”™:", error);
            await showCustomAlert(
              "æ“ä½œå¤±è´¥",
              `æ¸…ç©ºåŠ¨æ€æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`,
            );
          }
        }

        /**
         * åˆ‡æ¢ä¸–ç•Œä¹¦çš„ç¼–è¾‘æ¨¡å¼
         */
        async function toggleWorldBookEditMode() {
          isWorldBookEditMode = !isWorldBookEditMode;

          const screen = document.getElementById("world-book-screen");
          const listEl = document.getElementById("world-book-list");
          const editBtn = document.getElementById(
            "toggle-world-book-edit-mode-btn",
          );
          const manageBtn = document.getElementById(
            "manage-categories-in-edit-mode-btn",
          );
          const addBtn = document.getElementById("add-world-book-btn");
          const importBtn = document.getElementById("import-world-book-btn");

          const deleteBtn = document.getElementById(
            "world-book-delete-selected-btn",
          );

          screen.classList.toggle("selection-mode", isWorldBookEditMode);
          listEl.classList.toggle("selection-mode", isWorldBookEditMode);

          if (isWorldBookEditMode) {
            editBtn.textContent = "å®Œæˆ";
            manageBtn.style.display = "inline-block";
            deleteBtn.style.display = "inline-flex"; // è®©åˆ é™¤æŒ‰é’®æ˜¾ç¤º
            addBtn.style.display = "none";
            importBtn.style.display = "none";
          } else {
            editBtn.textContent = "ç¼–è¾‘æ¨¡å¼";
            manageBtn.style.display = "none";
            deleteBtn.style.display = "none"; // è®©åˆ é™¤æŒ‰é’®éšè—
            addBtn.style.display = "inline-block";
            importBtn.style.display = "inline-block";
            selectedWorldBooks.clear();
            updateWorldBookDeleteButton();
          }

          await renderWorldBookScreen();
        }

        /**
         * å¤„ç†ä¸–ç•Œä¹¦åˆ—è¡¨é¡¹çš„ç‚¹å‡»äº‹ä»¶ï¼ˆå…¼å®¹æ™®é€šæ¨¡å¼å’Œç¼–è¾‘æ¨¡å¼ï¼‰
         */
        function handleWorldBookListClick(e) {
          const item = e.target.closest(".list-item");
          if (!item) return;

          const bookId = item.dataset.bookId;
          if (!bookId) return;

          if (isWorldBookEditMode) {
            // ç¼–è¾‘æ¨¡å¼ï¼šå¤„ç†é€‰æ‹©/å–æ¶ˆé€‰æ‹©
            item.classList.toggle("selected");
            if (selectedWorldBooks.has(bookId)) {
              selectedWorldBooks.delete(bookId);
            } else {
              selectedWorldBooks.add(bookId);
            }
            updateWorldBookDeleteButton();
          } else {
            // æ™®é€šæ¨¡å¼ï¼šæ‰“å¼€ç¼–è¾‘å™¨
            openWorldBookEditor(bookId);
          }
        }

        /**
         * æ›´æ–°å¤´éƒ¨åˆ é™¤æŒ‰é’®çš„çŠ¶æ€å’Œè®¡æ•°
         */
        function updateWorldBookDeleteButton() {
          const deleteBtn = document.getElementById(
            "world-book-delete-selected-btn",
          );
          const countSpan = document.getElementById("world-book-delete-count");
          const count = selectedWorldBooks.size;

          // æ›´æ–°æŒ‰é’®æ—è¾¹çš„æ•°å­—
          if (count > 0) {
            countSpan.textContent = `(${count})`;
          } else {
            countSpan.textContent = "";
          }

          // åˆ‡æ¢æŒ‰é’®çš„ç¦ç”¨çŠ¶æ€
          deleteBtn.disabled = count === 0;
        }

        /**
         * å¤„ç†æ‰¹é‡åˆ é™¤ä¸–ç•Œä¹¦çš„é€»è¾‘
         */
        async function handleBulkDeleteWorldBooks() {
          if (selectedWorldBooks.size === 0) return;

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            `ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ ${selectedWorldBooks.size} æœ¬ä¸–ç•Œä¹¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            const idsToDelete = Array.from(selectedWorldBooks);
            await db.worldBooks.bulkDelete(idsToDelete);

            state.worldBooks = state.worldBooks.filter(
              (wb) => !idsToDelete.includes(wb.id),
            );

            // é€€å‡ºç¼–è¾‘æ¨¡å¼
            await toggleWorldBookEditMode();

            await showCustomAlert(
              "åˆ é™¤æˆåŠŸ",
              `${idsToDelete.length} æœ¬ä¸–ç•Œä¹¦å·²åˆ é™¤ã€‚`,
            );
          }
        }

        /**
         * åˆ é™¤ä¸€ä¸ªä¸–ç•Œä¹¦åˆ†ç±»ï¼ˆç°åœ¨ä¼šå¼¹å‡ºé€‰é¡¹ï¼‰
         */
        async function deleteCategory(categoryId) {
          const category = await db.worldBookCategories.get(categoryId);
          if (!category) return;

          const choice = await showChoiceModal(`åˆ é™¤åˆ†ç±» "${category.name}"`, [
            { text: "åˆ é™¤åˆ†ç±»åŠå…¶æ‰€æœ‰ä¸–ç•Œä¹¦", value: "delete_all" },
            {
              text: "ä»…åˆ é™¤åˆ†ç±» (ä¹¦å˜ä¸ºæœªåˆ†ç±»)",
              value: "delete_category_only",
            },
          ]);

          if (!choice) return;

          if (choice === "delete_all") {
            const confirmed = await showCustomConfirm(
              "å±é™©æ“ä½œ",
              `ä½ ç¡®å®šè¦æ°¸ä¹…åˆ é™¤åˆ†ç±» "${category.name}" ä»¥åŠå…¶ä¸­çš„ã€æ‰€æœ‰ã€‘ä¸–ç•Œä¹¦å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ï¼`,
              { confirmButtonClass: "btn-danger" },
            );
            if (!confirmed) return;

            const booksToDelete = await db.worldBooks
              .where("categoryId")
              .equals(categoryId)
              .toArray();
            const bookIdsToDelete = booksToDelete.map((book) => book.id);
            if (bookIdsToDelete.length > 0) {
              await db.worldBooks.bulkDelete(bookIdsToDelete);
              state.worldBooks = state.worldBooks.filter(
                (wb) => !bookIdsToDelete.includes(wb.id),
              );
            }
            await db.worldBookCategories.delete(categoryId);
            await showCustomAlert(
              "åˆ é™¤æˆåŠŸ",
              `åˆ†ç±» "${category.name}" åŠå…¶ä¸‹çš„æ‰€æœ‰ä¸–ç•Œä¹¦å·²è¢«åˆ é™¤ã€‚`,
            );
          } else if (choice === "delete_category_only") {
            const booksToUpdate = await db.worldBooks
              .where("categoryId")
              .equals(categoryId)
              .toArray();
            if (booksToUpdate.length > 0) {
              for (const book of booksToUpdate) {
                book.categoryId = null;
              }
              await db.worldBooks.bulkPut(booksToUpdate);
              booksToUpdate.forEach((updatedBook) => {
                const bookInState = state.worldBooks.find(
                  (wb) => wb.id === updatedBook.id,
                );
                if (bookInState) bookInState.categoryId = null;
              });
            }
            await db.worldBookCategories.delete(categoryId);
            await showCustomAlert(
              "åˆ é™¤æˆåŠŸ",
              `åˆ†ç±» "${category.name}" å·²è¢«åˆ é™¤ã€‚`,
            );
          }

          await renderCategoryListInManager();
          await renderWorldBookScreen();
        }

        /**
         * æ¸²æŸ“ä¸–ç•Œä¹¦åˆ—è¡¨çš„è¾…åŠ©å‡½æ•°ï¼ˆç§»é™¤äº†æ—§çš„ç‚¹å‡»äº‹ä»¶ç»‘å®šï¼‰
         */
        function createWorldBookGroup(groupName, books) {
          const groupContainer = document.createElement("div");
          groupContainer.className = "world-book-group-container";

          groupContainer.innerHTML = `
			        <div class="world-book-group-header">
			            <span class="arrow">â–¼</span>
			            <span class="group-name">${groupName}</span>
			        </div>
			        <div class="world-book-group-content"></div>
			    `;

          const headerEl = groupContainer.querySelector(
            ".world-book-group-header",
          );
          const contentEl = groupContainer.querySelector(
            ".world-book-group-content",
          );

          headerEl.classList.add("collapsed");
          contentEl.classList.add("collapsed");

          books.sort((a, b) => a.name.localeCompare(b.name, "zh-CN"));
          books.forEach((book) => {
            const item = document.createElement("div");
            item.className = "list-item";
            item.dataset.bookId = book.id;
            item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(
              book.content || "æš‚æ— å†…å®¹..."
            ).substring(0, 50)}</div>`;

            // æ—§çš„ item.addEventListener('click', ...) å·²è¢«ç§»é™¤ï¼Œç”±äº‹ä»¶å§”æ‰˜ç»Ÿä¸€å¤„ç†

            addLongPressListener(item, async () => {
              const confirmed = await showCustomConfirm(
                "åˆ é™¤ä¸–ç•Œä¹¦",
                `ç¡®å®šè¦åˆ é™¤ã€Š${book.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`,
                { confirmButtonClass: "btn-danger" },
              );
              if (confirmed) {
                await db.worldBooks.delete(book.id);
                state.worldBooks = state.worldBooks.filter(
                  (wb) => wb.id !== book.id,
                );
                renderWorldBookScreen();
              }
            });
            contentEl.appendChild(item);
          });

          return groupContainer;
        }

        // å¿«æ·å›å¤åŠŸèƒ½æ ¸å¿ƒé€»è¾‘

        /**
         * æ‰“å¼€å¿«æ·å›å¤å¼¹çª—
         */
        function openQuickReplyModal() {
          renderQuickReplyList();
          document.getElementById("quick-reply-modal").classList.add("visible");
        }

        /**
         * æ¸²æŸ“å¿«æ·å›å¤åˆ—è¡¨ (å¸¦ç¼–è¾‘åŠŸèƒ½)
         */
        function renderQuickReplyList() {
          const listEl = document.getElementById("quick-reply-list");
          listEl.innerHTML = "";

          const replies = state.globalSettings.quickReplies || [];

          if (replies.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color:var(--text-secondary); padding:20px;">åˆ—è¡¨ä¸ºç©ºï¼Œç‚¹å‡»å³ä¸Šè§’ "+" æ·»åŠ ã€‚</p>';
            return;
          }

          replies.forEach((item, index) => {
            const div = document.createElement("div");
            div.className = "quick-reply-item";

            // å…¼å®¹å¤„ç†
            let type = typeof item === "string" ? "text" : item.type;
            let content = typeof item === "string" ? item : item.content;

            // æ ‡ç­¾ç”Ÿæˆ
            let typeBadge = "";
            if (type === "voice_message")
              typeBadge =
                '<span style="background:#4CAF50; color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:5px;">è¯­éŸ³</span>';
            else if (type === "ai_image")
              typeBadge =
                '<span style="background:#FF9800; color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:5px;">å›¾ç‰‡</span>';
            else if (type === "transfer")
              typeBadge =
                '<span style="background:#E91E63; color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:5px;">è½¬è´¦</span>';
            else if (type === "waimai_request")
              typeBadge =
                '<span style="background:#2196F3; color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:5px;">å¤–å–</span>';

            div.innerHTML = `
      <!-- å·¦ä¾§ï¼šç‚¹å‡»å‘é€åŒºåŸŸ -->
      <div class="quick-reply-content" style="flex:1; display:flex; align-items:center; overflow:hidden; cursor:pointer;" title="ç‚¹å‡»å‘é€">
        ${typeBadge}
        <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${content}</span>
      </div>
      
      <!-- å³ä¾§ï¼šæ“ä½œæŒ‰é’®åŒºåŸŸ -->
      <div class="quick-reply-actions">
        <!-- ç¼–è¾‘å›¾æ ‡ (é“…ç¬”) -->
        <span class="quick-reply-action-btn btn-edit" title="ç¼–è¾‘" data-index="${index}">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        </span>
        <!-- åˆ é™¤å›¾æ ‡ (åƒåœ¾æ¡¶) -->
        <span class="quick-reply-action-btn btn-delete" title="åˆ é™¤" data-index="${index}">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        </span>
      </div>
    `;

            // ç»‘å®šäº‹ä»¶ï¼šå‘é€
            div
              .querySelector(".quick-reply-content")
              .addEventListener("click", () => {
                sendQuickReply(item);
              });

            // ç»‘å®šäº‹ä»¶ï¼šç¼–è¾‘
            div.querySelector(".btn-edit").addEventListener("click", (e) => {
              e.stopPropagation(); // é˜²æ­¢è§¦å‘å‘é€
              editQuickReply(index);
            });

            // ç»‘å®šäº‹ä»¶ï¼šåˆ é™¤
            div.querySelector(".btn-delete").addEventListener("click", (e) => {
              e.stopPropagation(); // é˜²æ­¢è§¦å‘å‘é€
              deleteQuickReply(index);
            });

            listEl.appendChild(div);
          });
        }
        /**
         * ç¼–è¾‘å¿«æ·å›å¤ (æ”¯æŒä¿®æ”¹ç±»å‹å’Œå†…å®¹)
         */
        async function editQuickReply(index) {
          const item = state.globalSettings.quickReplies[index];

          // 1. è·å–æ—§å†…å®¹ï¼Œä½œä¸ºé»˜è®¤å€¼å¡«å……
          const oldContent = typeof item === "string" ? item : item.content;

          const newType = await showChoiceModal("ç¼–è¾‘ - é€‰æ‹©ç±»å‹", [
            { text: "ğŸ“ æ™®é€šæ–‡æœ¬", value: "text" },
            { text: "ğŸ¤ è¯­éŸ³æ¶ˆæ¯", value: "voice_message" },
            { text: "ğŸ–¼ï¸ å›¾ç‰‡æè¿°", value: "ai_image" },
            { text: "ğŸ’¸ è½¬è´¦ (å¤‡æ³¨)", value: "transfer" },
            { text: "ğŸ” å¤–å– (å•†å“å)", value: "waimai_request" },
          ]);

          if (!newType) return; // å¦‚æœç”¨æˆ·å–æ¶ˆé€‰æ‹©ç±»å‹ï¼Œåˆ™åœæ­¢

          // 3. æ ¹æ®é€‰æ‹©çš„ç±»å‹è®¾ç½®æç¤ºè¯­
          let promptTitle = "ç¼–è¾‘å†…å®¹";
          let promptDesc = "è¯·è¾“å…¥å›å¤å†…å®¹...";

          if (newType === "voice_message") {
            promptTitle = "ç¼–è¾‘è¯­éŸ³å†…å®¹";
            promptDesc = "è¾“å…¥è¯­éŸ³è½¬æ¢çš„æ–‡å­—å†…å®¹";
          } else if (newType === "ai_image") {
            promptTitle = "ç¼–è¾‘å›¾ç‰‡æè¿°";
            promptDesc = "è¾“å…¥å›¾ç‰‡çš„ç”»é¢æè¿°";
          } else if (newType === "transfer") {
            promptTitle = "ç¼–è¾‘è½¬è´¦å¤‡æ³¨";
            promptDesc = "è¾“å…¥è½¬è´¦çš„å¤‡æ³¨æ–‡å­—";
          } else if (newType === "waimai_request") {
            promptTitle = "ç¼–è¾‘å¤–å–å•†å“";
            promptDesc = "è¾“å…¥æƒ³åƒçš„å•†å“åç§°";
          }

          // 4. ç¬¬äºŒæ­¥ï¼šå¼¹å‡ºè¾“å…¥æ¡†ï¼Œå¹¶å¡«å…¥æ—§å†…å®¹ä¾›ä¿®æ”¹
          const newContent = await showCustomPrompt(
            promptTitle,
            promptDesc,
            oldContent,
          );

          // 5. ä¿å­˜é€»è¾‘
          if (newContent !== null && newContent.trim()) {
            // ç›´æ¥è¦†ç›–æ—§å¯¹è±¡
            state.globalSettings.quickReplies[index] = {
              type: newType,
              content: newContent.trim(),
            };

            await db.globalSettings.put(state.globalSettings);
            renderQuickReplyList(); // åˆ·æ–°åˆ—è¡¨
            // alert('ä¿®æ”¹æˆåŠŸï¼'); // å¯é€‰æç¤º
          }
        }

        /**
         * å‘é€å¿«æ·å›å¤ (è‡ªåŠ¨è¯†åˆ«ç±»å‹å¹¶æ¸²æŸ“)
         */
        async function sendQuickReply(item) {
          if (!state.activeChatId) return;

          const chat = state.chats[state.activeChatId];
          const modal = document.getElementById("quick-reply-modal");
          const chatInput = document.getElementById("chat-input");

          // å…³é—­å¼¹çª—
          modal.classList.remove("visible");

          // 1. è§£ææ•°æ®
          let type = "text";
          let content = "";

          if (typeof item === "string") {
            content = item;
          } else {
            type = item.type;
            content = item.content;
          }

          // 2. å¦‚æœæ˜¯æ™®é€šæ–‡æœ¬ï¼Œèµ°æ ‡å‡†æµç¨‹ (å¡«å…¥è¾“å…¥æ¡†å¹¶ç‚¹å‡»å‘é€)
          // è¿™æ ·å¯ä»¥ä¿ç•™å¼•ç”¨å›å¤ç­‰æ–‡æœ¬ç‰¹æœ‰çš„åŠŸèƒ½
          if (type === "text") {
            chatInput.value = content;
            document.getElementById("send-btn").click();
            return;
          }

          // 3. å¦‚æœæ˜¯ç‰¹æ®Šç±»å‹ï¼Œæ‰‹åŠ¨æ„é€ æ¶ˆæ¯å¯¹è±¡å¹¶å‘é€
          // è¿™æ ·å¯ä»¥é¿å¼€è¾“å…¥æ¡†ï¼Œç›´æ¥ç”Ÿæˆå¯¹åº”çš„å¯Œæ–‡æœ¬å¡ç‰‡

          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "æˆ‘"
            : "æˆ‘";
          const msg = {
            role: "user",
            timestamp: Date.now(),
          };

          if (type === "voice_message") {
            msg.type = "voice_message";
            msg.content = content;
          } else if (type === "ai_image") {
            // ç”¨æˆ·å‘é€çš„å›¾ç‰‡æè¿°ï¼Œç³»ç»Ÿå†…éƒ¨é€šå¸¸æ ‡è®°ä¸º user_photo
            msg.type = "user_photo";
            msg.content = content;
          } else if (type === "transfer") {
            // è½¬è´¦é€»è¾‘ï¼šéœ€è¦æ‰£æ¬¾
            const amount = 52.0; // å¿«æ·è½¬è´¦é»˜è®¤é‡‘é¢ï¼Œä¹Ÿå¯æ”¹ä¸ºä» item ä¸­è¯»å–æ›´å¤æ‚çš„é…ç½®
            if ((state.globalSettings.userBalance || 0) < amount) {
              alert("ä½™é¢ä¸è¶³ï¼Œæ— æ³•å‘é€å¿«æ·è½¬è´¦ï¼");
              return;
            }
            // æ‰£æ¬¾
            await updateUserBalanceAndLogTransaction(
              -amount,
              `å¿«æ·è½¬è´¦ç»™ ${chat.name}`,
            );

            msg.type = "transfer";
            msg.amount = amount;
            msg.note = content; // å¤‡æ³¨
            msg.senderName = myNickname;
            msg.receiverName = chat.isGroup ? "ç¾¤èŠ" : chat.name;
          } else if (type === "waimai_request") {
            // å¤–å–è¯·æ±‚
            msg.type = "waimai_request";
            msg.productInfo = content; // å•†å“å
            msg.amount = 20; // é»˜è®¤é‡‘é¢
            msg.senderName = myNickname;
            msg.status = "pending";
            msg.countdownEndTime = Date.now() + 15 * 60 * 1000;
          }

          // 4. ä¿å­˜å¹¶æ¸²æŸ“
          chat.history.push(msg);
          await db.chats.put(chat);

          // æ¸²æŸ“åˆ°ç•Œé¢
          appendMessage(msg, chat);
          renderChatList();

          // æ»šåŠ¨åˆ°åº•éƒ¨
          const messagesContainer = document.getElementById("chat-messages");
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * æ·»åŠ æ–°çš„å¿«æ·å›å¤ (å¸¦ç±»å‹é€‰æ‹©)
         */
        async function addNewQuickReply() {
          // 1. å…ˆè®©ç”¨æˆ·é€‰æ‹©ç±»å‹
          const type = await showChoiceModal("é€‰æ‹©æ¶ˆæ¯ç±»å‹", [
            { text: "ğŸ“ æ™®é€šæ–‡æœ¬", value: "text" },
            { text: "ğŸ¤ è¯­éŸ³æ¶ˆæ¯", value: "voice_message" },
            { text: "ğŸ–¼ï¸ å›¾ç‰‡æè¿°", value: "ai_image" },
            { text: "ğŸ’¸ è½¬è´¦ (å¤‡æ³¨)", value: "transfer" },
            { text: "ğŸ” å¤–å– (å•†å“å)", value: "waimai_request" },
          ]);

          if (!type) return; // ç”¨æˆ·å–æ¶ˆ

          // 2. æ ¹æ®ç±»å‹è®¾ç½®æç¤ºè¯­
          let promptTitle = "è¾“å…¥å†…å®¹";
          let promptDesc = "è¯·è¾“å…¥å›å¤å†…å®¹...";

          if (type === "voice_message") {
            promptTitle = "æ·»åŠ è¯­éŸ³";
            promptDesc = "è¾“å…¥è¯­éŸ³è½¬æ¢çš„æ–‡å­—å†…å®¹";
          } else if (type === "ai_image") {
            promptTitle = "æ·»åŠ å›¾ç‰‡";
            promptDesc = "è¾“å…¥å›¾ç‰‡çš„ç”»é¢æè¿°";
          } else if (type === "transfer") {
            promptTitle = "æ·»åŠ è½¬è´¦å¤‡æ³¨";
            promptDesc = "è¾“å…¥è½¬è´¦çš„å¤‡æ³¨æ–‡å­— (é»˜è®¤52å…ƒ)";
          } else if (type === "waimai_request") {
            promptTitle = "æ·»åŠ å¤–å–";
            promptDesc = "è¾“å…¥æƒ³åƒçš„å•†å“åç§° (é»˜è®¤20å…ƒ)";
          }

          // 3. å¼¹å‡ºè¾“å…¥æ¡†
          const content = await showCustomPrompt(promptTitle, promptDesc);

          if (content && content.trim()) {
            if (!state.globalSettings.quickReplies)
              state.globalSettings.quickReplies = [];

            // ä¿å­˜ä¸ºå¯¹è±¡ç»“æ„
            state.globalSettings.quickReplies.push({
              type: type,
              content: content.trim(),
            });

            await db.globalSettings.put(state.globalSettings);
            renderQuickReplyList();
          }
        }

        /**
         * åˆ é™¤å¿«æ·å›å¤
         */
        async function deleteQuickReply(index) {
          // ä¸éœ€è¦å¼¹çª—ç¡®è®¤ï¼Œæå‡æ“ä½œæ•ˆç‡ï¼Œæˆ–è€…ä¿ç•™ç¡®è®¤çœ‹ä½ å–œå¥½
          // const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ', {confirmButtonClass: 'btn-danger'});
          // if (confirmed) { ... }

          state.globalSettings.quickReplies.splice(index, 1);
          await db.globalSettings.put(state.globalSettings);
          renderQuickReplyList();
        }

        /**
         * å¯¼å‡ºå¿«æ·å›å¤
         */
        function exportQuickReplies() {
          const replies = state.globalSettings.quickReplies || [];
          const blob = new Blob([JSON.stringify(replies, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `EPhone-QuickReplies-${new Date().toISOString().split("T")[0]}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }

        /**
         * å¯¼å…¥å¿«æ·å›å¤
         */
        function importQuickReplies(file) {
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const data = JSON.parse(e.target.result);
              if (Array.isArray(data)) {
                if (!state.globalSettings.quickReplies)
                  state.globalSettings.quickReplies = [];

                // ç®€å•çš„æ•°æ®æ¸…æ´—ï¼Œå…¼å®¹æ—§çš„å­—ç¬¦ä¸²æ•°ç»„
                const cleanedData = data.map((item) => {
                  if (typeof item === "string")
                    return { type: "text", content: item };
                  return item;
                });

                // åˆå¹¶
                state.globalSettings.quickReplies.push(...cleanedData);

                await db.globalSettings.put(state.globalSettings);
                renderQuickReplyList();
                alert(`æˆåŠŸå¯¼å…¥ ${cleanedData.length} æ¡å¿«æ·å›å¤ã€‚`);
              } else {
                alert("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚");
              }
            } catch (error) {
              alert("å¯¼å…¥å¤±è´¥ï¼š" + error.message);
            }
          };
          reader.readAsText(file);
        }

        /* æ—¶é—´è½´/å­˜æ¡£åŠŸèƒ½æ ¸å¿ƒå‡½æ•° */

        /**
         * æ‰“å¼€æ—¶é—´è½´ç®¡ç†å¼¹çª—
         */
        function openBranchingModal() {
          if (!state.activeChatId) return;
          renderBranchList();
          document.getElementById("branching-modal").classList.add("visible");
        }

        /**
         * æ¸²æŸ“å­˜æ¡£åˆ—è¡¨
         */
        function renderBranchList() {
          const chat = state.chats[state.activeChatId];
          const listEl = document.getElementById("branch-list");
          listEl.innerHTML = "";

          if (!chat.checkpoints || chat.checkpoints.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color:#999; padding:20px;">æš‚æ— å­˜æ¡£è®°å½•</p>';
            return;
          }

          // æŒ‰æ—¶é—´å€’åºæ’åˆ—
          const sortedCheckpoints = [...chat.checkpoints].sort(
            (a, b) => b.timestamp - a.timestamp,
          );

          sortedCheckpoints.forEach((cp) => {
            const dateStr = new Date(cp.timestamp).toLocaleString();
            const item = document.createElement("div");
            item.className = "branch-item";

            // è·å–æœ€åä¸€æ¡æ¶ˆæ¯ä½œä¸ºé¢„è§ˆ
            const lastMsg =
              cp.history.length > 0
                ? cp.history[cp.history.length - 1].content
                : "æ— è®°å½•";
            const previewText =
              typeof lastMsg === "string"
                ? lastMsg.substring(0, 20)
                : "[ç‰¹æ®Šæ¶ˆæ¯]";

            item.innerHTML = `
            <div class="branch-info">
                <div class="branch-name">${cp.name}</div>
                <div class="branch-meta">${dateStr} Â· ${cp.history.length}æ¡è®°å½•</div>
                <div class="branch-meta" style="margin-top:2px;">æœ«å¥: ${previewText}...</div>
            </div>
            <div class="branch-actions">
                <button class="branch-action-btn branch-load" onclick="loadBranchCheckpoint('${cp.id}')">è¯»å–</button>
                <button class="branch-action-btn branch-delete" onclick="deleteBranchCheckpoint('${cp.id}')">åˆ é™¤</button>
            </div>
        `;
            listEl.appendChild(item);
          });
        }

        /* æ—¶é—´è½´/å­˜æ¡£åŠŸèƒ½æ ¸å¿ƒå‡½æ•° (å¸¦å¿ƒå£°æ•°æ®) */

        /**
         * æ‰“å¼€æ—¶é—´è½´ç®¡ç†å¼¹çª—
         */
        function openBranchingModal() {
          if (!state.activeChatId) return;
          renderBranchList();
          document.getElementById("branching-modal").classList.add("visible");
        }

        /**
         * æ¸²æŸ“å­˜æ¡£åˆ—è¡¨ (ä¿æŒä¸å˜)
         */
        function renderBranchList() {
          const chat = state.chats[state.activeChatId];
          const listEl = document.getElementById("branch-list");
          listEl.innerHTML = "";

          if (!chat.checkpoints || chat.checkpoints.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color:#999; padding:20px;">æš‚æ— å­˜æ¡£è®°å½•</p>';
            return;
          }

          // æŒ‰æ—¶é—´å€’åºæ’åˆ—
          const sortedCheckpoints = [...chat.checkpoints].sort(
            (a, b) => b.timestamp - a.timestamp,
          );

          sortedCheckpoints.forEach((cp) => {
            const dateStr = new Date(cp.timestamp).toLocaleString();
            const item = document.createElement("div");
            item.className = "branch-item"; // ç¡®ä¿ä½ çš„CSSé‡Œæœ‰è¿™ä¸ªç±»

            // è·å–æœ€åä¸€æ¡æ¶ˆæ¯ä½œä¸ºé¢„è§ˆ
            const lastMsg =
              cp.history.length > 0
                ? cp.history[cp.history.length - 1].content
                : "æ— è®°å½•";
            let previewText =
              typeof lastMsg === "string"
                ? lastMsg.substring(0, 20)
                : "[ç‰¹æ®Šæ¶ˆæ¯]";

            // è·å–å¿ƒå£°é¢„è§ˆ (å¦‚æœæœ‰)
            if (cp.latestInnerVoice && cp.latestInnerVoice.thoughts) {
              previewText += ` | å¿ƒå£°: ${cp.latestInnerVoice.thoughts.substring(0, 10)}...`;
            }

            item.innerHTML = `
            <div class="branch-info">
                <div class="branch-name">${cp.name}</div>
                <div class="branch-meta">${dateStr} Â· ${cp.history.length}æ¡è®°å½•</div>
                <div class="branch-meta" style="margin-top:2px; color:#aaa;">${previewText}</div>
            </div>
            <div class="branch-actions">
                <button class="branch-action-btn branch-load" onclick="loadBranchCheckpoint('${cp.id}')">è¯»å–</button>
                <button class="branch-action-btn branch-delete" onclick="deleteBranchCheckpoint('${cp.id}')">åˆ é™¤</button>
            </div>
        `;
            listEl.appendChild(item);
          });
        }

        /**
         * åˆ›å»ºå½“å‰è¿›åº¦çš„å­˜æ¡£ (å·²åŠ å…¥å¿ƒå£°ä¿å­˜)
         */
        async function createBranchCheckpoint() {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const defaultName = `å­˜æ¡£äº ${new Date().toLocaleTimeString()}`;
          const name = await showCustomPrompt(
            "æ–°å»ºå­˜æ¡£",
            "ç»™è¿™ä¸ªèŠ‚ç‚¹èµ·ä¸ªåå­—å§",
            defaultName,
          );

          if (name) {
            const newCheckpoint = {
              id: "cp_" + Date.now(),
              name: name.trim(),
              timestamp: Date.now(),
              // 1. ä¿å­˜èŠå¤©å†å²
              history: JSON.parse(JSON.stringify(chat.history)),

              innerVoiceHistory: JSON.parse(
                JSON.stringify(chat.innerVoiceHistory || []),
              ),

              latestInnerVoice: chat.latestInnerVoice
                ? JSON.parse(JSON.stringify(chat.latestInnerVoice))
                : null,
            };

            chat.checkpoints.push(newCheckpoint);
            await db.chats.put(chat);
            renderBranchList();
            alert("å­˜æ¡£æˆåŠŸï¼(åŒ…å«å¿ƒå£°)");
          }
        }

        /**
         * è¯»å–å­˜æ¡£ (å·²åŠ å…¥å¿ƒå£°æ¢å¤)
         */
        window.loadBranchCheckpoint = async function (checkpointId) {
          const chat = state.chats[state.activeChatId];
          const checkpoint = chat.checkpoints.find(
            (cp) => cp.id === checkpointId,
          );

          if (!checkpoint) return;

          const confirmed = await showCustomConfirm(
            "ç¡®è®¤è¯»å–",
            `ç¡®å®šè¦è¯»å–å­˜æ¡£â€œ${checkpoint.name}â€å—ï¼Ÿ\n\nâš ï¸ æ³¨æ„ï¼šè¯»å–åï¼Œå½“å‰çš„æœªä¿å­˜è¿›åº¦å°†ä¼šä¸¢å¤±ï¼`,
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            // 1. æ¢å¤èŠå¤©å†å²
            chat.history = JSON.parse(JSON.stringify(checkpoint.history));

            // 2. æ¢å¤å¿ƒå£°å†å²
            chat.innerVoiceHistory = JSON.parse(
              JSON.stringify(checkpoint.innerVoiceHistory || []),
            );

            // 3. æ¢å¤å½“å‰å¿ƒå£°çŠ¶æ€
            chat.latestInnerVoice = checkpoint.latestInnerVoice
              ? JSON.parse(JSON.stringify(checkpoint.latestInnerVoice))
              : null;

            await db.chats.put(chat);
            renderChatInterface(state.activeChatId); // åˆ·æ–°èŠå¤©ç•Œé¢

            // è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼šè™½ç„¶æˆ‘ä»¬æ›´æ–°äº†æ•°æ®ï¼Œä½†å¿ƒå£°é¢æ¿å¯èƒ½è¿˜æ˜¯æ˜¾ç¤ºæ—§çš„ã€‚
            // æˆ‘ä»¬ä¸éœ€è¦å¼ºåˆ¶æ‰“å¼€é¢æ¿ï¼Œä½†å¦‚æœé¢æ¿æ˜¯å¼€ç€çš„ï¼Œæˆ‘ä»¬åº”è¯¥åˆ·æ–°å®ƒã€‚
            // æœ€ç®€å•çš„æ–¹æ³•æ˜¯å…³é—­å¹¶é‡æ–°æ‰“å¼€ä¸€ä¸‹ï¼Œæˆ–è€…ç›´æ¥æ›´æ–°DOMï¼ˆå¦‚æœæ­¤æ—¶ä½ å†™äº†updateInnerVoiceUIå‡½æ•°ï¼‰
            // è¿™é‡Œæˆ‘ä»¬ä¸åšé¢å¤–æ“ä½œï¼Œå› ä¸ºç”¨æˆ·ä¸‹æ¬¡æ‰“å¼€é¢æ¿æ—¶ä¼šè‡ªåŠ¨è¯»å–æœ€æ–°çš„ chat.latestInnerVoiceã€‚

            document
              .getElementById("branching-modal")
              .classList.remove("visible"); // å…³é—­å¼¹çª—
            alert(`å·²å›æº¯è‡³ï¼š${checkpoint.name}`);
          }
        };

        /**
         * åˆ é™¤å­˜æ¡£ (ä¿æŒä¸å˜)
         */
        window.deleteBranchCheckpoint = async function (checkpointId) {
          const chat = state.chats[state.activeChatId];
          const confirmed = await showCustomConfirm(
            "åˆ é™¤å­˜æ¡£",
            "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­˜æ¡£å—ï¼Ÿä¸å¯æ¢å¤ã€‚",
            {
              confirmButtonClass: "btn-danger",
            },
          );

          if (confirmed) {
            chat.checkpoints = chat.checkpoints.filter(
              (cp) => cp.id !== checkpointId,
            );
            await db.chats.put(chat);
            renderBranchList();
          }
        };

        /**
         * é‡å¼€æ–°å‰§æƒ… (å·²åŠ å…¥å¿ƒå£°æ¸…ç©º)
         */
        async function restartChatBranch() {
          const chat = state.chats[state.activeChatId];

          const confirmed = await showCustomConfirm(
            "é‡å¼€æ–°å‰§æƒ…",
            "ç¡®å®šè¦æ¸…ç©ºå½“å‰æ‰€æœ‰èŠå¤©è®°å½•ï¼Œå¼€å§‹ä¸€æ¡æ–°çš„æ•…äº‹çº¿å—ï¼Ÿ\nè¿™ä¹Ÿä¼šæ¸…ç©ºå½“å‰çš„æ‰€æœ‰å¿ƒå£°è®°å½•ã€‚\n\nâš ï¸ å»ºè®®å…ˆç‚¹å³ä¸Šè§’ä¿å­˜å½“å‰è¿›åº¦ä¸ºå­˜æ¡£ï¼",
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            // 1. æ¸…ç©ºèŠå¤©å†å²
            chat.history = [];

            // 2. æ¸…ç©ºå¿ƒå£°å†å²
            chat.innerVoiceHistory = [];

            // 3. æ¸…ç©ºå½“å‰å¿ƒå£°
            chat.latestInnerVoice = null;

            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);
            document
              .getElementById("branching-modal")
              .classList.remove("visible");

            alert("å·²é‡ç½®ï¼Œæ–°çš„æ•…äº‹å¼€å§‹äº†ã€‚");
          }
        }

        /**
         * åˆ é™¤å­˜æ¡£
         */
        window.deleteBranchCheckpoint = async function (checkpointId) {
          const chat = state.chats[state.activeChatId];
          const confirmed = await showCustomConfirm(
            "åˆ é™¤å­˜æ¡£",
            "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­˜æ¡£å—ï¼Ÿä¸å¯æ¢å¤ã€‚",
            {
              confirmButtonClass: "btn-danger",
            },
          );

          if (confirmed) {
            chat.checkpoints = chat.checkpoints.filter(
              (cp) => cp.id !== checkpointId,
            );
            await db.chats.put(chat);
            renderBranchList();
          }
        };
        // --- æå…‰åŠŸèƒ½çŠ¶æ€ ---
        let auroraState = {
          active: false, // æ˜¯å¦å¼€å¯
          mode: "video", // 'video' æˆ– 'text'
          title: "", // ä½œå“åç§° (ä¾‹å¦‚ "æ³°å¦å°¼å…‹å·")
          subtitles: [], // å­—å¹•æ•°ç»„ [{start, end, text}]
          textContent: "", // å°è¯´å…¨æ–‡
          lastSyncTime: 0, // ä¸Šæ¬¡åŒæ­¥æ—¶é—´ï¼Œé˜²æ­¢è¿‡äºé¢‘ç¹
        };

        /**
         * æ‰“å¼€æ¼«æ¸¸è®¾ç½®å¼¹çª—
         */
        function openAuroraSetupModal() {
          // 1. æ¸…ç©ºæ–‡æœ¬è¾“å…¥
          const titleInput = document.getElementById("aurora-title-input");
          if (titleInput) titleInput.value = "";

          // 2. æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡† (åŒ…æ‹¬æ–°åŠ çš„URLæ¡†)
          const idsToClear = [
            "aurora-video-file",
            "aurora-sub-file-video",
            "aurora-sub-url-video",
            "aurora-text-file",
            "aurora-text-url",
            "aurora-custom-img",
            "aurora-custom-audio",
            "aurora-sub-file-custom",
            "aurora-sub-url-custom",
          ];

          idsToClear.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.value = "";
          });

          // 3. é»˜è®¤é€‰ä¸­è§†é¢‘æ¨¡å¼
          const videoRadio = document.querySelector(
            'input[name="aurora-mode"][value="video"]',
          );
          if (videoRadio) videoRadio.checked = true;

          // 4. åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
          toggleAuroraInputs();

          // 5. æ˜¾ç¤ºå¼¹çª—
          document
            .getElementById("aurora-setup-modal")
            .classList.add("visible");
        }

        /**
         * åˆ‡æ¢å¼¹çª—å†…çš„è¾“å…¥æ˜¾ç¤º
         */
        function toggleAuroraInputs() {
          const mode = document.querySelector(
            'input[name="aurora-mode"]:checked',
          ).value;

          document.getElementById("aurora-video-inputs").style.display = "none";
          document.getElementById("aurora-text-inputs").style.display = "none";
          document.getElementById("aurora-custom-inputs").style.display =
            "none";

          if (mode === "video") {
            document.getElementById("aurora-video-inputs").style.display =
              "block";
          } else if (mode === "text") {
            document.getElementById("aurora-text-inputs").style.display =
              "block";
          } else if (mode === "custom") {
            document.getElementById("aurora-custom-inputs").style.display =
              "block";
          }
        }
        /**
         * ç¡®è®¤è®¾ç½®ï¼Œå¯åŠ¨æ¼«æ¸¸æ’­æ”¾å™¨
         * (å·²æ”¯æŒ URL å¯¼å…¥å­—å¹•å’ŒTXT)
         */
        async function confirmAuroraSetup() {
          const title = document
            .getElementById("aurora-title-input")
            .value.trim();
          const mode = document.querySelector(
            'input[name="aurora-mode"]:checked',
          ).value;

          if (!title) {
            alert("ç»™è¿™æ¬¡æ¼«æ¸¸èµ·ä¸ªåå­—å§ï¼");
            return;
          }

          // æ›´æ–°çŠ¶æ€
          auroraState = {
            active: true,
            mode: mode,
            title: title,
            subtitles: [],
            textContent: "",
            lastSyncTime: 0,
          };

          const playerOverlay = document.getElementById(
            "aurora-player-overlay",
          );
          const videoEl = document.getElementById("aurora-video-element");
          const textViewer = document.getElementById("aurora-text-viewer");
          const customViewer = document.getElementById("aurora-custom-viewer");
          const customAudio = document.getElementById(
            "aurora-custom-audio-element",
          );
          const customImg = document.getElementById("aurora-custom-bg-img");

          const statusTitle = document.getElementById("aurora-playing-title");
          const statusInfo = document.getElementById("aurora-info-status");

          // å…³é—­è®¾ç½®å¼¹çª—
          document
            .getElementById("aurora-setup-modal")
            .classList.remove("visible");

          // æ˜¾ç¤ºæ’­æ”¾å™¨
          playerOverlay.style.display = "flex";
          statusTitle.textContent = `æ­£åœ¨æ¼«æ¸¸:ã€Š${title}ã€‹`;

          videoEl.style.display = "none";
          textViewer.style.display = "none";
          customViewer.style.display = "none";
          document.getElementById("aurora-save-book-btn").style.display =
            "none";
          videoEl.pause();
          customAudio.pause();

          // --- è¾…åŠ©å‡½æ•°ï¼šå¤„ç†å­—å¹•å†…å®¹ ---
          const handleSubtitleContent = (content) => {
            auroraState.subtitles = parseSRT(content);
            statusInfo.textContent = `å­—å¹•å·²åŠ è½½`;
            // å¦‚æœæ˜¯è§†é¢‘æ¨¡å¼ï¼ŒæŒ‚è½½VTTè½¨é“
            if (mode === "video") {
              const vttContent = "WEBVTT\n\n" + content.replace(/,/g, ".");
              const track = document.createElement("track");
              track.kind = "subtitles";
              track.label = "Chinese";
              track.srclang = "zh";
              track.default = true;
              track.src = URL.createObjectURL(
                new Blob([vttContent], { type: "text/vtt" }),
              );
              videoEl.innerHTML = "";
              videoEl.appendChild(track);
            }
          };

          if (mode === "video") {
            const videoFile =
              document.getElementById("aurora-video-file").files[0];
            const subFile = document.getElementById("aurora-sub-file-video")
              .files[0];
            const subUrl = document
              .getElementById("aurora-sub-url-video")
              .value.trim();

            if (!videoFile) {
              alert("è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼");
              return;
            }

            videoEl.style.display = "block";
            videoEl.src = URL.createObjectURL(videoFile);

            // åˆå§‹ä¸æ˜¾ç¤ºæ§ä»¶ï¼Œç‚¹å‡»è§†é¢‘åˆ‡æ¢æ˜¾ç¤º/éšè—
            videoEl.removeAttribute("controls");
            videoEl.onclick = () => {
              if (videoEl.hasAttribute("controls")) {
                videoEl.removeAttribute("controls");
              } else {
                videoEl.setAttribute("controls", "controls");
              }
            };

            // å¤„ç†å­—å¹• (æ–‡ä»¶ä¼˜å…ˆï¼Œå…¶æ¬¡URL)
            if (subFile) {
              const reader = new FileReader();
              reader.onload = (e) => handleSubtitleContent(e.target.result);
              reader.readAsText(subFile);
            } else if (subUrl) {
              statusInfo.textContent = "æ­£åœ¨ä¸‹è½½å­—å¹•...";
              fetch(subUrl)
                .then((r) => r.text())
                .then((txt) => handleSubtitleContent(txt))
                .catch(() => (statusInfo.textContent = "å­—å¹•ä¸‹è½½å¤±è´¥"));
            } else {
              statusInfo.textContent = "æ— å­—å¹•";
            }
          } else if (mode === "text") {
            const textFile =
              document.getElementById("aurora-text-file").files[0];
            const textUrl = document
              .getElementById("aurora-text-url")
              .value.trim();

            if (!textFile && !textUrl) {
              alert("è¯·é€‰æ‹©æ–‡æœ¬æ–‡ä»¶æˆ–è¾“å…¥é“¾æ¥ï¼");
              return;
            }
            document.getElementById("aurora-save-book-btn").style.display =
              "inline-block";
            textViewer.style.display = "block";

            // --- è¾…åŠ©å‡½æ•°ï¼šå¤„ç†æ–‡æœ¬Buffer (è§£ç GBK/UTF8) ---
            const processTextBuffer = (buffer) => {
              let text = "";
              try {
                const decoder = new TextDecoder("utf-8", { fatal: true });
                text = decoder.decode(buffer);
              } catch (error) {
                console.log(
                  "æ£€æµ‹åˆ°éUTF-8ç¼–ç ï¼Œå°è¯•ä½¿ç”¨ GB18030 (å…¼å®¹GBK/ANSI) è§£ç ...",
                );
                try {
                  const decoder = new TextDecoder("gb18030");
                  text = decoder.decode(buffer);
                } catch (err2) {
                  alert("æŠ±æ­‰ï¼Œæ— æ³•è¯†åˆ«è¯¥æ–‡ä»¶çš„ç¼–ç æ ¼å¼ã€‚");
                  return;
                }
              }
              auroraState.textContent = text;
              document.getElementById("aurora-text-body").textContent =
                auroraState.textContent;
              const statusInfo = document.getElementById("aurora-info-status");
              if (statusInfo) statusInfo.textContent = `æ–‡æ¡£å·²åŠ è½½`;
            };

            if (textFile) {
              const reader = new FileReader();
              reader.onload = (e) => processTextBuffer(e.target.result);
              reader.readAsArrayBuffer(textFile);
            } else if (textUrl) {
              const statusInfo = document.getElementById("aurora-info-status");
              if (statusInfo) statusInfo.textContent = "æ­£åœ¨ä¸‹è½½æ–‡æ¡£...";

              fetch(textUrl)
                .then((res) => {
                  if (!res.ok) throw new Error("ç½‘ç»œé”™è¯¯");
                  return res.arrayBuffer();
                })
                .then((buffer) => processTextBuffer(buffer))
                .catch((err) => {
                  console.error(err);
                  if (statusInfo) statusInfo.textContent = "ä¸‹è½½å¤±è´¥";
                  alert("æ–‡æ¡£ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥è·¨åŸŸé—®é¢˜ã€‚");
                });
            }
          } else if (mode === "custom") {
            const imgFile =
              document.getElementById("aurora-custom-img").files[0];
            const audioFile = document.getElementById("aurora-custom-audio")
              .files[0];
            const subFile = document.getElementById("aurora-sub-file-custom")
              .files[0];
            const subUrl = document
              .getElementById("aurora-sub-url-custom")
              .value.trim();

            if (!imgFile || !audioFile) {
              alert("å›¾ç‰‡å’ŒéŸ³é¢‘æ–‡ä»¶éƒ½æ˜¯å¿…å¡«çš„å“¦ï¼");
              return;
            }

            customViewer.style.display = "block";
            customImg.src = URL.createObjectURL(imgFile);
            customAudio.src = URL.createObjectURL(audioFile);

            customAudio.style.opacity = "0";
            customImg.onclick = () => {
              customAudio.style.opacity =
                customAudio.style.opacity === "0" ? "0.8" : "0";
            };

            // å¤„ç†å­—å¹• (æ–‡ä»¶ä¼˜å…ˆï¼Œå…¶æ¬¡URL)
            if (subFile) {
              const reader = new FileReader();
              reader.onload = (e) => {
                handleSubtitleContent(e.target.result);
                // å¼€å¯ç›‘å¬
                customAudio.ontimeupdate = () => {
                  const curTime = customAudio.currentTime;
                  const sub = auroraState.subtitles.find(
                    (s) => curTime >= s.start && curTime <= s.end,
                  );
                  document.getElementById(
                    "aurora-custom-subtitle-display",
                  ).textContent = sub ? sub.text : "";
                };
              };
              reader.readAsText(subFile);
            } else if (subUrl) {
              statusInfo.textContent = "æ­£åœ¨ä¸‹è½½å­—å¹•...";
              fetch(subUrl)
                .then((r) => r.text())
                .then((txt) => {
                  handleSubtitleContent(txt);
                  // å¼€å¯ç›‘å¬
                  customAudio.ontimeupdate = () => {
                    const curTime = customAudio.currentTime;
                    const sub = auroraState.subtitles.find(
                      (s) => curTime >= s.start && curTime <= s.end,
                    );
                    document.getElementById(
                      "aurora-custom-subtitle-display",
                    ).textContent = sub ? sub.text : "";
                  };
                })
                .catch(() => (statusInfo.textContent = "å­—å¹•ä¸‹è½½å¤±è´¥"));
            } else {
              statusInfo.textContent = "éŸ³é¢‘æ— å­—å¹•";
            }
          }
        }

        /**
         * è§£æå­—å¹•æ–‡ä»¶ (æ”¯æŒ SRT, VTT, LRC)
         * è‡ªåŠ¨è¯†åˆ«æ ¼å¼å¹¶è½¬æ¢ä¸ºç»Ÿä¸€çš„ {start, end, text} æ•°ç»„
         */
        function parseSRT(data) {
          if (!data) return [];

          // 1. ç»Ÿä¸€æ¢è¡Œç¬¦
          const normalizedData = data
            .replace(/\r\n/g, "\n")
            .replace(/\r/g, "\n")
            .trim();

          // --- LRC æ ¼å¼å¤„ç†é€»è¾‘ ---
          // å¦‚æœåŒ…å« [mm:ss] ä¸”ä¸åŒ…å« --> ç®­å¤´ï¼Œåˆ™è®¤ä¸ºæ˜¯ LRC
          if (
            /^\[\d{1,2}:\d{1,2}/m.test(normalizedData) &&
            !normalizedData.includes("-->")
          ) {
            console.log("æ£€æµ‹åˆ° LRC æ ¼å¼å­—å¹•ï¼Œæ­£åœ¨è½¬æ¢...");
            const lines = normalizedData.split("\n");
            const lrcEntries = [];
            // åŒ¹é… [mm:ss.xx] æˆ– [mm:ss]
            const timeRegex = /\[(\d{1,2}):(\d{1,2})(?:[.:](\d{1,3}))?\]/;

            // æå–æ‰€æœ‰æ—¶é—´å’Œæ–‡æœ¬
            for (let line of lines) {
              const match = timeRegex.exec(line);
              if (match) {
                const m = parseInt(match[1], 10);
                const s = parseInt(match[2], 10);
                let ms = 0;
                if (match[3]) {
                  // è¡¥é½æ¯«ç§’ä½æ•°ï¼Œå¦‚ .5 -> 500, .05 -> 050
                  ms = parseInt(match[3].padEnd(3, "0"), 10);
                }
                const seconds = m * 60 + s + ms / 1000;
                const text = line.replace(timeRegex, "").trim();
                if (text) {
                  lrcEntries.push({ time: seconds, text: text });
                }
              }
            }

            // æŒ‰æ—¶é—´æ’åº
            lrcEntries.sort((a, b) => a.time - b.time);

            // è½¬æ¢ä¸º {start, end, text} æ ¼å¼
            // LRCæ²¡æœ‰ç»“æŸæ—¶é—´ï¼ŒæŠŠä¸‹ä¸€å¥çš„å¼€å§‹æ—¶é—´ä½œä¸ºä¸Šä¸€å¥çš„ç»“æŸæ—¶é—´
            const result = [];
            for (let i = 0; i < lrcEntries.length; i++) {
              const current = lrcEntries[i];
              const next = lrcEntries[i + 1];
              // å¦‚æœæ˜¯æœ€åä¸€å¥ï¼Œé»˜è®¤æ˜¾ç¤º 5 ç§’
              const endTime = next ? next.time : current.time + 5;

              result.push({
                start: current.time,
                end: endTime,
                text: current.text,
              });
            }
            return result;
          }

          // --- SRT / VTT æ ¼å¼å¤„ç†é€»è¾‘ (ä¿æŒåŸæœ‰å¢å¼ºç‰ˆ) ---
          // æ”¯æŒ VTT çš„ "WEBVTT" å¤´ï¼Œæ”¯æŒç‚¹å·æˆ–é€—å·çš„æ—¶é—´æˆ³
          const pattern =
            /(\d{1,2}:\d{1,2}:\d{1,2}[.,]\d{1,3}) --> (\d{1,2}:\d{1,2}:\d{1,2}[.,]\d{1,3})(?:[^\n]*)\n([\s\S]*?)(?=\n\n|$|\n\d{1,2}:)/g;

          const subtitles = [];
          let match;

          while ((match = pattern.exec(normalizedData)) !== null) {
            subtitles.push({
              start: timeToSeconds(match[1]),
              end: timeToSeconds(match[2]),
              text: match[3].trim(), // ç§»é™¤é¦–å°¾ç©ºç™½
            });
          }

          console.log(`æˆåŠŸè§£æå­—å¹•æ¡æ•°: ${subtitles.length}`);
          return subtitles;
        }

        /**
         * æ—¶é—´æˆ³è½¬ç§’æ•°
         * å…¼å®¹ "00:00:00,000" å’Œ "00:00:00.000"
         */
        function timeToSeconds(timeString) {
          if (!timeString) return 0;
          // å°†é€—å·ç»Ÿä¸€æ›¿æ¢ä¸ºç‚¹å·ï¼Œæ–¹ä¾¿å¤„ç†
          const normalized = timeString.replace(",", ".");
          const parts = normalized.split(":");

          // å¤„ç† HH:MM:SS.ms
          const hours = parseInt(parts[0], 10);
          const minutes = parseInt(parts[1], 10);
          const seconds = parseFloat(parts[2]);

          return hours * 3600 + minutes * 60 + seconds;
        }

        /**
         * åˆå§‹åŒ–æå…‰æ’­æ”¾å™¨çš„æ‹–æ‹½
         */
        function initAuroraDrag() {
          const overlay = document.getElementById("aurora-player-overlay");
          const handle = document.getElementById("aurora-drag-handle");
          let isDragging = false;
          let startX, startY, initialLeft, initialTop;

          const startDrag = (e) => {
            isDragging = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startX = clientX;
            startY = clientY;
            const rect = overlay.getBoundingClientRect();
            initialLeft = rect.left;
            initialTop = rect.top;
          };

          const onDrag = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const dx = clientX - startX;
            const dy = clientY - startY;
            overlay.style.transform = "none"; // æ¸…é™¤å±…ä¸­
            overlay.style.left = `${initialLeft + dx}px`;
            overlay.style.top = `${initialTop + dy}px`;
          };

          const endDrag = () => {
            isDragging = false;
          };

          handle.addEventListener("mousedown", startDrag);
          document.addEventListener("mousemove", onDrag);
          document.addEventListener("mouseup", endDrag);

          handle.addEventListener("touchstart", startDrag, { passive: false });
          document.addEventListener("touchmove", onDrag, { passive: false });
          document.addEventListener("touchend", endDrag);
        }

        // å…³é—­æ’­æ”¾å™¨
        function closeAuroraPlayer() {
          document.getElementById("aurora-player-overlay").style.display =
            "none";
          document.getElementById("aurora-video-element").pause();
          // ä¹Ÿè¦æš‚åœè‡ªå®šä¹‰éŸ³é¢‘
          const customAudio = document.getElementById(
            "aurora-custom-audio-element",
          );
          if (customAudio) customAudio.pause();

          auroraState.active = false;
        }
        /* æ¼«æ¸¸ä¹¦æ¶åŠŸèƒ½æ ¸å¿ƒé€»è¾‘ */

        // 1. æ‰“å¼€ä¹¦æ¶ç•Œé¢
        async function openAuroraBookshelf() {
          // å…³é—­è®¾ç½®å¼¹çª—
          document
            .getElementById("aurora-setup-modal")
            .classList.remove("visible");
          // æ¸²æŸ“ä¹¦æ¶
          await renderBookshelf();
          // æ˜¾ç¤ºä¹¦æ¶å±å¹•
          showScreen("aurora-bookshelf-screen");
        }

        // 2. æ¸²æŸ“ä¹¦æ¶
        async function renderBookshelf() {
          const container = document.getElementById("bookshelf-container");
          container.innerHTML = "";

          // ä»æ•°æ®åº“è·å–æ‰€æœ‰ä¹¦ç±ï¼ŒæŒ‰æ·»åŠ æ—¶é—´å€’åº
          const books = await db.auroraBooks
            .orderBy("addedAt")
            .reverse()
            .toArray();

          if (books.length === 0) {
            container.innerHTML =
              '<div class="bookshelf-row" style="justify-content:center; align-items:center; color:#8d6e63; font-size:14px;">ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ...</div>';
            return;
          }

          // åˆ†å±‚æ¸²æŸ“ï¼Œæ¯å±‚æ”¾ 6 æœ¬ä¹¦ (ä¸ºäº†ç¾è§‚)
          const booksPerRow = 6;
          for (let i = 0; i < books.length; i += booksPerRow) {
            const rowBooks = books.slice(i, i + booksPerRow);

            const rowDiv = document.createElement("div");
            rowDiv.className = "bookshelf-row";

            rowBooks.forEach((book) => {
              const bookEl = document.createElement("div");
              // éšæœºåˆ†é…ä¸€ç§é¢œè‰²
              const colorClass = `book-color-${Math.floor(Math.random() * 5) + 1}`;
              bookEl.className = `retro-book ${colorClass}`;
              bookEl.title = book.title; // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå…¨å
              bookEl.innerHTML = `<span class="book-spine-title">${book.title}</span>`;

              // ç‚¹å‡»æ‰“å¼€ä¹¦
              bookEl.addEventListener("click", () => loadBookFromShelf(book));

              // é•¿æŒ‰åˆ é™¤
              addLongPressListener(bookEl, async () => {
                const confirmed = await showCustomConfirm(
                  "ç§»é™¤ä¹¦ç±",
                  `è¦æŠŠã€Š${book.title}ã€‹ä»ä¹¦æ¶ä¸Šæ‹¿èµ°å—ï¼Ÿ`,
                  {
                    confirmButtonClass: "btn-danger",
                  },
                );
                if (confirmed) {
                  await db.auroraBooks.delete(book.id);
                  await renderBookshelf();
                }
              });

              rowDiv.appendChild(bookEl);
            });

            container.appendChild(rowDiv);
          }

          // å¦‚æœæœ€åä¸€è¡Œä¸æ»¡ï¼Œä¸”æ€»ä¹¦ä¸å¤šï¼Œè¡¥ä¸€ä¸ªç©ºä¹¦æ¶æ˜¾å¾—æ›´æœ‰æ°›å›´
          if (books.length % booksPerRow !== 0 || books.length < 4) {
            const emptyRow = document.createElement("div");
            emptyRow.className = "bookshelf-row";
            container.appendChild(emptyRow);
          }
        }

        // 3. ä¿å­˜å½“å‰æ­£åœ¨è¯»çš„å°è¯´åˆ°ä¹¦æ¶
        async function saveCurrentNovelToShelf() {
          if (
            !auroraState.active ||
            auroraState.mode !== "text" ||
            !auroraState.textContent
          ) {
            alert("æ²¡æœ‰æ­£åœ¨é˜…è¯»çš„å°è¯´å†…å®¹ï¼");
            return;
          }

          const title = auroraState.title || "æœªå‘½åå°è¯´";

          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
          const existing = await db.auroraBooks
            .where("title")
            .equals(title)
            .first();
          if (existing) {
            alert(`ã€Š${title}ã€‹å·²ç»åœ¨ä¹¦æ¶ä¸Šäº†ï¼`);
            return;
          }

          await db.auroraBooks.add({
            title: title,
            content: auroraState.textContent,
            addedAt: Date.now(),
          });

          alert(`ã€Š${title}ã€‹å·²æˆåŠŸæ”¾å…¥ä¹¦æ¶ï¼`);

          // éšè—ä¿å­˜æŒ‰é’®ï¼Œé¿å…é‡å¤ä¿å­˜
          document.getElementById("aurora-save-book-btn").style.display =
            "none";
        }

        // 4. ä»ä¹¦æ¶åŠ è½½ä¹¦ç±å¹¶é˜…è¯» (å·²æ·»åŠ è¿›åº¦è®°å¿†åŠŸèƒ½)
        function loadBookFromShelf(book) {
          // æ›´æ–°å…¨å±€çŠ¶æ€
          auroraState = {
            active: true,
            mode: "text",
            title: book.title,
            subtitles: [],
            textContent: book.content,
            lastSyncTime: 0,
            // â˜…â˜…â˜… æ–°å¢ï¼šè®°å½•å½“å‰æ­£åœ¨è¯»å“ªæœ¬ä¹¦çš„IDï¼Œä»¥ä¾¿ä¿å­˜è¿›åº¦
            currentBookId: book.id,
          };

          const playerOverlay = document.getElementById(
            "aurora-player-overlay",
          );
          const statusTitle = document.getElementById("aurora-playing-title");
          const statusInfo = document.getElementById("aurora-info-status");
          const textViewer = document.getElementById("aurora-text-viewer");
          const videoEl = document.getElementById("aurora-video-element");
          const customViewer = document.getElementById("aurora-custom-viewer");
          const saveBtn = document.getElementById("aurora-save-book-btn");

          // UI åˆ‡æ¢é€»è¾‘
          document
            .getElementById("aurora-bookshelf-screen")
            .classList.remove("active"); // é€€å‡ºä¹¦æ¶

          if (state.activeChatId) {
            showScreen("chat-interface-screen");
          } else {
            showScreen("home-screen");
          }

          playerOverlay.style.display = "flex"; // æ˜¾ç¤ºæ’­æ”¾å™¨

          statusTitle.textContent = `æ­£åœ¨æ¼«æ¸¸:ã€Š${book.title}ã€‹`;
          statusInfo.textContent = "æ¥è‡ªä¹¦æ¶";

          videoEl.style.display = "none";
          customViewer.style.display = "none";
          textViewer.style.display = "block";

          document.getElementById("aurora-text-body").textContent =
            book.content;

          // å› ä¸ºæ˜¯ä»ä¹¦æ¶æ‰“å¼€çš„ï¼Œæ‰€ä»¥éšè—â€œä¿å­˜â€æŒ‰é’®
          saveBtn.style.display = "none";

          // æ¢å¤é˜…è¯»è¿›åº¦
          // ä½¿ç”¨ setTimeout ç¡®ä¿æ–‡æœ¬æ¸²æŸ“å®Œæˆåå†æ»šåŠ¨
          setTimeout(() => {
            if (book.progress) {
              // progress æ˜¯ä¸€ä¸ª 0 åˆ° 1 ä¹‹é—´çš„æµ®ç‚¹æ•° (ç™¾åˆ†æ¯”)
              const scrollHeight =
                textViewer.scrollHeight - textViewer.clientHeight;
              const targetScrollTop = Math.floor(scrollHeight * book.progress);

              textViewer.scrollTop = targetScrollTop;
              console.log(
                `å·²æ¢å¤é˜…è¯»è¿›åº¦: ${(book.progress * 100).toFixed(1)}%`,
              );
            } else {
              textViewer.scrollTop = 0; // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œä»å¤´å¼€å§‹
            }
          }, 50);
        }

        // ç»‘å®šä¹¦æ¶å…¥å£æŒ‰é’®
        document
          .getElementById("open-aurora-bookshelf-btn")
          .addEventListener("click", openAuroraBookshelf);

        document
          .getElementById("back-from-bookshelf")
          .addEventListener("click", () => {
            // 1. éšè—ä¹¦æ¶å±å¹•
            document
              .getElementById("aurora-bookshelf-screen")
              .classList.remove("active");

            // 2. æ˜¾å¼åœ°åˆ‡æ¢å›èŠå¤©ç•Œé¢
            if (state.activeChatId) {
              showScreen("chat-interface-screen");
            } else {
              showScreen("home-screen");
            }

            // 3. é‡æ–°æ‰“å¼€è®¾ç½®å¼¹çª— (æ¨¡ä»¿è¿”å›ä¸Šä¸€çº§èœå•çš„æ•ˆæœ)
            document
              .getElementById("aurora-setup-modal")
              .classList.add("visible");
          });

        // ç»‘å®šä¿å­˜æŒ‰é’®
        document
          .getElementById("aurora-save-book-btn")
          .addEventListener("click", saveCurrentNovelToShelf);
        /**
         * Gitæµå¼ä¸Šä¼  (åˆ†è¡¨ + è‡ªåŠ¨åˆ‡ç‰‡ + é‡è¯•æœºåˆ¶)
         * ä¿®å¤ï¼šè§£å†³ "Failed to fetch" ç½‘ç»œè¶…æ—¶é—®é¢˜
         */
        async function uploadBackupToGitHubStream() {
          let { githubToken, githubUsername, githubRepo, githubPath } =
            state.apiConfig;

          if (!githubToken || !githubUsername || !githubRepo) {
            alert("è¯·å…ˆåœ¨ API è®¾ç½®ä¸­å¡«å†™ GitHub é…ç½®ï¼");
            return;
          }

          // æ•´ç†è·¯å¾„
          githubToken = githubToken.trim();
          githubUsername = githubUsername.trim();
          githubRepo = githubRepo
            .trim()
            .replace(/\/$/, "")
            .split("/")
            .pop()
            .replace(".git", "");
          let basePath = (githubPath || "ephone_backup").trim();
          if (basePath.endsWith(".json")) {
            basePath = basePath.replace(".json", "");
          }

          // â˜…â˜…â˜… 2.å¦‚æœæ˜¯è‡ªåŠ¨å¤‡ä»½ï¼Œè·³è¿‡ç¡®è®¤æ¡† â˜…â˜…â˜…
          if (!isAuto) {
            const confirmed = await showCustomConfirm(
              "å¼€å§‹æµå¼ä¸Šä¼ ",
              `å°†æŠŠæ•°æ®æ‹†åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶ä¸Šä¼ ã€‚\nå·²ä¼˜åŒ–ä¸º 15MB åˆ†ç‰‡ä»¥é˜²æ­¢ç½‘ç»œè¶…æ—¶ã€‚\n\nç¡®å®šè¦å¼€å§‹å—ï¼Ÿ`,
            );
            if (!confirmed) return;
          }

          const loadingOverlay = document.getElementById("generation-overlay");
          const loadingText = loadingOverlay.querySelector("p");

          // â˜…â˜…â˜… 3. åªæœ‰ä¸æ˜¯è‡ªåŠ¨å¤‡ä»½æ—¶ï¼Œæ‰æ˜¾ç¤ºé®ç½©å±‚ â˜…â˜…â˜…
          if (!isAuto) {
            loadingOverlay.classList.add("visible");
          } else {
            console.log("æ­£åœ¨åå°æ‰§è¡Œæµå¼å¤‡ä»½..."); // åå°å¤‡ä»½ä»…æ‰“å°æ—¥å¿—
          }

          // â˜…â˜…â˜… ä¿®æ”¹ 1: é™ä½åˆ†ç‰‡å¤§å°åˆ° 15MB (æµè§ˆå™¨ä¸Šä¼ æ›´ç¨³å®š) â˜…â˜…â˜…
          const CHUNK_SIZE = 15 * 1024 * 1024;

          // â˜…â˜…â˜… è¾…åŠ©å‡½æ•°: å»¶æ—¶ (é˜²æ­¢è§¦å‘é€Ÿç‡é™åˆ¶) â˜…â˜…â˜…
          const sleep = (ms) =>
            new Promise((resolve) => setTimeout(resolve, ms));

          // â˜…â˜…â˜… è¾…åŠ©å‡½æ•°: å¸¦é‡è¯•çš„ä¸Šä¼ å™¨ â˜…â˜…â˜…
          const uploadWithRetry = async (path, content, retries = 3) => {
            for (let i = 0; i < retries; i++) {
              try {
                await uploadSingleFile(
                  githubUsername,
                  githubRepo,
                  path,
                  githubToken,
                  content,
                  true,
                );
                return; // æˆåŠŸåˆ™é€€å‡º
              } catch (error) {
                console.warn(`ä¸Šä¼  ${path} å¤±è´¥ (ç¬¬ ${i + 1} æ¬¡é‡è¯•):`, error);
                if (i === retries - 1) throw error; // æœ€åä¸€æ¬¡è¿˜å¤±è´¥ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
                await sleep(2000); // å¤±è´¥åç­‰å¾…2ç§’å†è¯•
              }
            }
          };

          try {
            // 1. å‡†å¤‡ä»»åŠ¡åˆ—è¡¨
            const tablesToExport = db.tables.map((t) => t.name);
            const singleObjects = [
              "apiConfig",
              "globalSettings",
              "musicLibrary",
              "qzoneSettings",
            ];

            const allTasks = [
              ...tablesToExport.map((name) => ({ type: "table", name })),
              ...singleObjects.map((name) => ({ type: "object", name })),
            ];

            const totalTasks = allTasks.length;

            // 2. éå†æ‰§è¡Œ
            for (let i = 0; i < totalTasks; i++) {
              const task = allTasks[i];

              let data = null;
              if (task.type === "table") {
                // å¯¹äºå¤§è¡¨ï¼Œè¿™é‡Œè¯»å–å¯èƒ½ä¼šèŠ±ä¸€ç‚¹æ—¶é—´ï¼ŒUIæ›´æ–°ä¸€ä¸‹
                loadingText.textContent = `[${i + 1}/${totalTasks}] è¯»å–æœ¬åœ°æ•°æ®: ${task.name}...`;
                // ç»™UIä¸€ç‚¹æ¸²æŸ“æ—¶é—´
                await sleep(50);
                data = await db[task.name].toArray();
              } else {
                data = await db[task.name].get("main");
                // å®‰å…¨è¿‡æ»¤
                if (data && task.name === "apiConfig") {
                  data.apiKey = "";
                  data.githubToken = "";
                  data.minimaxApiKey = "";
                }
              }

              if (!data) continue;

              loadingText.textContent = `[${i + 1}/${totalTasks}] æ­£åœ¨ç¼–ç : ${task.name}...`;
              await sleep(20);

              // åºåˆ—åŒ–å¹¶è½¬Base64
              const jsonContent = JSON.stringify(data);
              const contentBase64 = btoa(
                unescape(encodeURIComponent(jsonContent)),
              );

              const fileName = `${basePath}_${task.name}.json`;
              const totalSize = contentBase64.length;

              // 3. ä¸Šä¼ é€»è¾‘
              if (totalSize > CHUNK_SIZE) {
                const totalChunks = Math.ceil(totalSize / CHUNK_SIZE);

                for (let c = 0; c < totalChunks; c++) {
                  loadingText.textContent = `[${i + 1}/${totalTasks}] ä¸Šä¼  ${
                    task.name
                  } åˆ†ç‰‡ (${c + 1}/${totalChunks})...`;

                  const start = c * CHUNK_SIZE;
                  const end = Math.min(start + CHUNK_SIZE, totalSize);
                  const chunkContent = contentBase64.substring(start, end);
                  const partName = `${fileName}.${String(c + 1).padStart(3, "0")}`;

                  // ä½¿ç”¨é‡è¯•æœºåˆ¶ä¸Šä¼ 
                  await uploadWithRetry(partName, chunkContent);

                  // â˜…â˜…â˜… æ¯æ¬¡ä¸Šä¼ å®Œä¸€ä¸ªåˆ†ç‰‡ï¼Œä¼‘æ¯ 1 ç§’ â˜…â˜…â˜…
                  await sleep(1000);
                }

                // ä¸Šä¼ ç´¢å¼•æ–‡ä»¶
                const metaInfo = {
                  split: true,
                  totalChunks: totalChunks,
                  originalSize: totalSize,
                };
                const metaBase64 = btoa(JSON.stringify(metaInfo));
                await uploadWithRetry(`${fileName}.meta`, metaBase64);
              } else {
                loadingText.textContent = `[${i + 1}/${totalTasks}] æ­£åœ¨ä¸Šä¼ : ${task.name}...`;
                await uploadWithRetry(fileName, contentBase64);
                await sleep(500); // å°æ–‡ä»¶ä¹Ÿç¨å¾®ä¼‘æ¯ä¸€ä¸‹
              }
            }

            // 4. ä¸Šä¼ æ€»ç´¢å¼•
            const masterMeta = {
              type: "stream_backup_v2",
              timestamp: Date.now(),
              tables: tablesToExport,
              configs: singleObjects,
            };
            const masterMetaBase64 = btoa(
              unescape(encodeURIComponent(JSON.stringify(masterMeta))),
            );
            await uploadWithRetry(
              `${basePath}_master_meta.json`,
              masterMetaBase64,
            );

            // â˜…â˜…â˜… 4. æˆåŠŸåçš„å¤„ç† â˜…â˜…â˜…
            if (isAuto) {
              // å¦‚æœæ˜¯è‡ªåŠ¨å¤‡ä»½ï¼Œä½¿ç”¨é¡¶éƒ¨é€šçŸ¥æ¡ï¼ˆä¸æ‰“æ–­ç”¨æˆ·ï¼‰
              showNotification(
                state.activeChatId || "system",
                "GitHub è‡ªåŠ¨å¤‡ä»½å·²å®Œæˆ âœ…",
              );
              console.log("GitHub è‡ªåŠ¨å¤‡ä»½å·²å®Œæˆ");
            } else {
              // å¦‚æœæ˜¯æ‰‹åŠ¨ï¼Œå¼¹çª—æç¤º
              await showCustomAlert(
                "ä¸Šä¼ å®Œæˆ",
                `æ‰€æœ‰æ•°æ®å·²æµå¼ä¸Šä¼ æˆåŠŸï¼\nç½‘ç»œæ³¢åŠ¨å·²è‡ªåŠ¨å¤„ç†ã€‚`,
              );
            }
          } catch (error) {
            console.error("æµå¼ä¸Šä¼ å¤±è´¥:", error);
            // â˜…â˜…â˜… 5. å¤±è´¥å¤„ç† â˜…â˜…â˜…
            if (!isAuto) {
              await showCustomAlert(
                "ä¸Šä¼ ä¸­æ–­",
                `å¤šæ¬¡é‡è¯•åä»ç„¶å¤±è´¥ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦ç¨³å®šã€‚`,
              );
            } else {
              showNotification(
                state.activeChatId || "system",
                "GitHub è‡ªåŠ¨å¤‡ä»½å¤±è´¥ âŒ",
              );
            }
          } finally {
            // æ— è®ºå¦‚ä½•éƒ½è¦å°è¯•ç§»é™¤ï¼Œé˜²æ­¢æ‰‹åŠ¨æ¨¡å¼å¡ä½
            loadingOverlay.classList.remove("visible");
          }
        }

        /**
         * Gitæµå¼å¯¼å…¥ (ä¿®å¤ç‰ˆï¼šæ”¯æŒåˆ†è¡¨ä¸‹è½½ + è‡ªåŠ¨åˆå¹¶åˆ†ç‰‡)
         */
        async function restoreBackupFromGitHubStream() {
          let { githubToken, githubUsername, githubRepo, githubPath } =
            state.apiConfig;

          if (!githubToken || !githubUsername || !githubRepo) {
            alert("è¯·å…ˆåœ¨ API è®¾ç½®ä¸­å¡«å†™ GitHub é…ç½®ï¼");
            return;
          }

          githubToken = githubToken.trim();
          githubUsername = githubUsername.trim();
          githubRepo = githubRepo
            .trim()
            .replace(/\/$/, "")
            .split("/")
            .pop()
            .replace(".git", "");
          let basePath = (githubPath || "ephone_backup").trim();
          if (basePath.endsWith(".json")) {
            basePath = basePath.replace(".json", "");
          }

          const confirmed = await showCustomConfirm(
            "âš ï¸ ç¡®è®¤æµå¼æ¢å¤",
            `å°†ä» GitHub ä¾æ¬¡ä¸‹è½½ä»¥ "${basePath}_" å¼€å¤´çš„æ–‡ä»¶å¹¶è¦†ç›–å½“å‰æ•°æ®ã€‚\n\næ­¤æ“ä½œä¼šã€æ¸…ç©ºã€‘å½“å‰æ‰€æœ‰æ•°æ®ä¸”ä¸å¯æ’¤é”€ï¼\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`,
            { confirmButtonClass: "btn-danger" },
          );
          if (!confirmed) return;

          const loadingOverlay = document.getElementById("generation-overlay");
          const loadingText = loadingOverlay.querySelector("p");
          loadingOverlay.classList.add("visible");

          try {
            // 1. å®šä¹‰éœ€è¦æ¢å¤çš„è¡¨åå’Œé…ç½®
            const tablesToImport = db.tables.map((t) => t.name);
            const singleObjects = [
              "apiConfig",
              "globalSettings",
              "musicLibrary",
              "qzoneSettings",
            ];

            // åˆå¹¶ä»»åŠ¡åˆ—è¡¨
            const allTasks = [
              ...tablesToImport.map((name) => ({ type: "table", name })),
              ...singleObjects.map((name) => ({ type: "object", name })),
            ];

            const totalTasks = allTasks.length;
            let completedTasks = 0;
            let successCount = 0;

            // æ¸…åº“
            loadingText.textContent = "æ­£åœ¨æ¸…ç©ºå½“å‰æ•°æ®åº“...";
            for (const table of db.tables) {
              await table.clear();
            }

            // --- æ ¸å¿ƒè¾…åŠ©å‡½æ•°ï¼šä¸‹è½½å¹¶åˆå¹¶ (åŒ…å«åˆ†ç‰‡é€»è¾‘) ---
            const downloadAndMerge = async (taskName, taskType) => {
              const fileName = `${basePath}_${taskName}.json`;
              // æ„é€  meta æ–‡ä»¶åœ°å€
              const metaUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${fileName}.meta`;

              let finalBase64 = "";
              let isSplit = false;
              let splitInfo = null;

              // A. å°è¯•è·å– .meta æ–‡ä»¶ï¼Œåˆ¤æ–­æ˜¯å¦åˆ†ç‰‡
              try {
                const metaRes = await fetch(metaUrl, {
                  headers: { Authorization: `token ${githubToken}` },
                });
                if (metaRes.ok) {
                  const metaJson = await metaRes.json();
                  // è§£ç  meta æ–‡ä»¶å†…å®¹
                  const metaStr = atob(metaJson.content.replace(/\s/g, ""));
                  splitInfo = JSON.parse(metaStr);
                  isSplit = true;
                }
              } catch (e) {
                // æ²¡æ‰¾åˆ° meta æ–‡ä»¶ï¼Œè¯´æ˜æ˜¯å•æ–‡ä»¶ï¼Œç»§ç»­èµ°
              }

              if (isSplit && splitInfo) {
                // === åˆ†ç‰‡æ¨¡å¼ ===
                console.log(
                  `æ£€æµ‹åˆ° ${taskName} ä¸ºåˆ†ç‰‡æ–‡ä»¶ï¼Œå…± ${splitInfo.totalChunks} ç‰‡`,
                );
                loadingText.textContent = `æ­£åœ¨ä¸‹è½½ ${taskName} (åˆ†ç‰‡ ${splitInfo.totalChunks} ä¸ª)...`;

                for (let i = 1; i <= splitInfo.totalChunks; i++) {
                  // æ„é€ åˆ†ç‰‡æ–‡ä»¶åï¼Œä¾‹å¦‚ .001, .002
                  const partName = `${fileName}.${String(i).padStart(3, "0")}`;
                  const partUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${partName}`;

                  const partRes = await fetch(partUrl, {
                    headers: { Authorization: `token ${githubToken}` },
                  });
                  if (!partRes.ok) throw new Error(`åˆ†ç‰‡ ${partName} ä¸‹è½½å¤±è´¥`);

                  const partJson = await partRes.json();

                  // å¤„ç†å†…å®¹ï¼ˆå…¼å®¹å¤§æ–‡ä»¶è¿”å› sha çš„æƒ…å†µï¼‰
                  if (partJson.content) {
                    finalBase64 += partJson.content.replace(/\s/g, "");
                  } else if (partJson.sha) {
                    // å¦‚æœåˆ†ç‰‡æœ¬èº«ä¹Ÿå¾ˆå¤§ï¼ŒGitHubå¯èƒ½åªè¿”å›shaï¼Œéœ€è¦ç”¨Blob API
                    const blobUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/git/blobs/${partJson.sha}`;
                    const blobRes = await fetch(blobUrl, {
                      headers: { Authorization: `token ${githubToken}` },
                    });
                    const blobJson = await blobRes.json();
                    finalBase64 += blobJson.content.replace(/\s/g, "");
                  }
                }
              } else {
                // === å•æ–‡ä»¶æ¨¡å¼ ===
                const fileUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${fileName}`;
                const res = await fetch(fileUrl, {
                  headers: { Authorization: `token ${githubToken}` },
                });

                if (res.status === 404) return null; // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡
                if (!res.ok) throw new Error(`æ–‡ä»¶ ${fileName} ä¸‹è½½å¤±è´¥`);

                const json = await res.json();

                if (json.content) {
                  finalBase64 = json.content.replace(/\s/g, "");
                } else if (json.sha) {
                  const blobUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/git/blobs/${json.sha}`;
                  const blobRes = await fetch(blobUrl, {
                    headers: { Authorization: `token ${githubToken}` },
                  });
                  const blobJson = await blobRes.json();
                  finalBase64 = blobJson.content.replace(/\s/g, "");
                }
              }

              // B. è§£ç  Base64 -> UTF8 -> JSON
              try {
                // atob è§£ç  Base64
                const binaryString = atob(finalBase64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                  bytes[i] = binaryString.charCodeAt(i);
                }
                // TextDecoder å¤„ç†ä¸­æ–‡ä¹±ç 
                const decoder = new TextDecoder("utf-8");
                const dataJson = JSON.parse(decoder.decode(bytes));
                return dataJson;
              } catch (parseError) {
                console.error(`è§£æ ${taskName} æ•°æ®å¤±è´¥`, parseError);
                throw new Error(`è§£æ ${taskName} å¤±è´¥ï¼Œæ•°æ®å¯èƒ½æŸå`);
              }
            };

            // 2. å¾ªç¯å¤„ç†æ‰€æœ‰ä»»åŠ¡
            for (let i = 0; i < totalTasks; i++) {
              const task = allTasks[i];
              loadingText.textContent = `[${completedTasks + 1}/${totalTasks}] æ­£åœ¨æ¢å¤: ${task.name}...`;

              try {
                const data = await downloadAndMerge(task.name, task.type);

                if (data) {
                  if (task.type === "object") {
                    // æ¢å¤å•å¯¹è±¡é…ç½®
                    if (task.name === "apiConfig") {
                      // æ¢å¤æ—¶ï¼Œå¦‚æœå¤‡ä»½é‡Œæ²¡æœ‰Keyï¼Œä¿ç•™å½“å‰å†…å­˜é‡Œçš„Key
                      if (!data.apiKey) data.apiKey = state.apiConfig.apiKey;
                      if (!data.githubToken)
                        data.githubToken = state.apiConfig.githubToken;
                    }
                    await db[task.name].put(data);
                  } else {
                    // æ¢å¤æ•°ç»„è¡¨æ•°æ®
                    if (Array.isArray(data) && data.length > 0) {
                      await db[task.name].bulkPut(data);
                    }
                  }
                  successCount++;
                }
              } catch (err) {
                console.warn(`æ¢å¤ ${task.name} æ—¶å‡ºé”™ï¼Œè·³è¿‡:`, err);
              }
              completedTasks++;
            }

            await showCustomAlert(
              "æ¢å¤å®Œæˆ",
              `æµå¼æ¢å¤ç»“æŸï¼\næˆåŠŸæ¢å¤äº† ${successCount} ä¸ªæ•°æ®æ¨¡å—ã€‚\nåº”ç”¨å³å°†åˆ·æ–°ã€‚`,
            );
            setTimeout(() => window.location.reload(), 1500);
          } catch (error) {
            console.error("æµå¼æ¢å¤å¤±è´¥:", error);
            await showCustomAlert("æ¢å¤å¤±è´¥", `å‘ç”Ÿé”™è¯¯: ${error.message}`);
          } finally {
            loadingOverlay.classList.remove("visible");
          }
        }

        /**
         * Gitæµå¼å¯¼å…¥ (åˆ†è¡¨ä¸‹è½½ï¼ŒèŠ‚çœå†…å­˜)
         */
        async function restoreBackupFromGitHubStream() {
          let { githubToken, githubUsername, githubRepo, githubPath } =
            state.apiConfig;

          if (!githubToken || !githubUsername || !githubRepo) {
            alert("è¯·å…ˆåœ¨ API è®¾ç½®ä¸­å¡«å†™ GitHub é…ç½®ï¼");
            return;
          }

          // æ•´ç†è·¯å¾„
          githubToken = githubToken.trim();
          githubUsername = githubUsername.trim();
          githubRepo = githubRepo
            .trim()
            .replace(/\/$/, "")
            .split("/")
            .pop()
            .replace(".git", "");
          let basePath = (githubPath || "ephone_backup").trim();
          if (basePath.endsWith(".json")) {
            basePath = basePath.replace(".json", "");
          }

          const confirmed = await showCustomConfirm(
            "âš ï¸ ç¡®è®¤æµå¼æ¢å¤",
            `å°†ä» GitHub ä¾æ¬¡ä¸‹è½½ä»¥ "${basePath}_" å¼€å¤´çš„æ–‡ä»¶å¹¶è¦†ç›–å½“å‰æ•°æ®ã€‚\n\næ­¤æ“ä½œä¼šã€æ¸…ç©ºã€‘å½“å‰æ‰€æœ‰æ•°æ®ä¸”ä¸å¯æ’¤é”€ï¼\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`,
            { confirmButtonClass: "btn-danger" },
          );
          if (!confirmed) return;

          const loadingOverlay = document.getElementById("generation-overlay");
          const loadingText = loadingOverlay.querySelector("p");
          loadingOverlay.classList.add("visible");

          try {
            // 1. å®šä¹‰éœ€è¦æ¢å¤çš„è¡¨åå’Œé…ç½® (ä¸ä¸Šä¼ æ—¶å¯¹åº”)
            // å³ä½¿äº‘ç«¯æ²¡æœ‰æŸäº›è¡¨ï¼Œå°è¯•ä¸‹è½½404ä¹Ÿä¼šè¢«å¿½ç•¥ï¼Œä¿è¯å¥å£®æ€§
            const tablesToImport = db.tables.map((t) => t.name);
            const singleObjects = [
              "apiConfig",
              "globalSettings",
              "musicLibrary",
              "qzoneSettings",
            ];

            const totalTasks = tablesToImport.length + singleObjects.length;
            let completedTasks = 0;
            let successCount = 0;

            // å…ˆæ¸…ç©ºæ•°æ®åº“ (ä¸ºäº†ä¿è¯æ•°æ®çº¯å‡€)
            loadingText.textContent = "æ­£åœ¨æ¸…ç©ºå½“å‰æ•°æ®åº“...";
            for (const table of db.tables) {
              await table.clear();
            }

            // 2. è¾…åŠ©ä¸‹è½½å‡½æ•°
            const downloadAndImport = async (
              fileName,
              targetStore,
              isSingleObject = false,
            ) => {
              const apiUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${fileName}`;
              try {
                const res = await fetch(apiUrl, {
                  headers: { Authorization: `token ${githubToken}` },
                });

                if (res.status === 404) {
                  console.log(`è·³è¿‡: ${fileName} ä¸å­˜åœ¨`);
                  return false;
                }
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const json = await res.json();

                // å¤„ç†å¤§æ–‡ä»¶ Blob (å¦‚æœæ˜¯å¤§æ–‡ä»¶ github api ä¼šè¿”å› sha æ²¡ content)
                let finalContentStr = "";
                if (json.content) {
                  finalContentStr = json.content.replace(/\s/g, "");
                } else if (json.sha) {
                  // Blob API for large files
                  const blobUrl = `https://api.github.com/repos/${githubUsername}/${githubRepo}/git/blobs/${json.sha}`;
                  const blobRes = await fetch(blobUrl, {
                    headers: { Authorization: `token ${githubToken}` },
                  });
                  const blobJson = await blobRes.json();
                  finalContentStr = blobJson.content.replace(/\s/g, "");
                }

                // è§£ç 
                const binaryString = atob(finalContentStr);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                  bytes[i] = binaryString.charCodeAt(i);
                }
                const decoder = new TextDecoder("utf-8");
                const dataJson = JSON.parse(decoder.decode(bytes));

                // å†™å…¥æ•°æ®åº“
                if (isSingleObject) {
                  // å¯¹äºé…ç½®å¯¹è±¡ï¼Œå¦‚æœæ˜¯ apiConfigï¼Œä¿ç•™å½“å‰çš„ Key åˆ«è¢«ç©ºå€¼è¦†ç›–
                  if (targetStore === "apiConfig") {
                    // æ¢å¤æ—¶ï¼Œå¦‚æœå¤‡ä»½é‡Œæ˜¯ç©ºçš„ï¼Œå°±ä¿ç•™å½“å‰å†…å­˜é‡Œçš„Key
                    if (!dataJson.apiKey)
                      dataJson.apiKey = state.apiConfig.apiKey;
                    if (!dataJson.githubToken)
                      dataJson.githubToken = state.apiConfig.githubToken;
                  }
                  await db[targetStore].put(dataJson);
                } else {
                  // æ•°ç»„æ•°æ®
                  if (Array.isArray(dataJson) && dataJson.length > 0) {
                    await db[targetStore].bulkPut(dataJson);
                  }
                }
                return true;
              } catch (e) {
                console.warn(`ä¸‹è½½/å¯¼å…¥ ${fileName} å¤±è´¥:`, e);
                return false;
              }
            };

            // 3. å¾ªç¯æ¢å¤è¡¨
            for (const tableName of tablesToImport) {
              loadingText.textContent = `[${completedTasks + 1}/${totalTasks}] æ­£åœ¨ä¸‹è½½å¹¶å¯¼å…¥: ${tableName}...`;
              const fileName = `${basePath}_${tableName}.json`;
              if (await downloadAndImport(fileName, tableName, false)) {
                successCount++;
              }
              completedTasks++;
            }

            // 4. å¾ªç¯æ¢å¤é…ç½®
            for (const configName of singleObjects) {
              loadingText.textContent = `[${completedTasks + 1}/${totalTasks}] æ­£åœ¨ä¸‹è½½å¹¶å¯¼å…¥é…ç½®: ${configName}...`;
              const fileName = `${basePath}_${configName}.json`;
              if (await downloadAndImport(fileName, configName, true)) {
                successCount++;
              }
              completedTasks++;
            }

            await showCustomAlert(
              "æ¢å¤å®Œæˆ",
              `æµå¼æ¢å¤ç»“æŸï¼\næˆåŠŸæ¢å¤äº† ${successCount} ä¸ªæ•°æ®æ¨¡å—ã€‚\nåº”ç”¨å³å°†åˆ·æ–°ã€‚`,
            );
            setTimeout(() => window.location.reload(), 1500);
          } catch (error) {
            console.error("æµå¼æ¢å¤å¤±è´¥:", error);
            await showCustomAlert("æ¢å¤å¤±è´¥", `å‘ç”Ÿé”™è¯¯: ${error.message}`);
          } finally {
            loadingOverlay.classList.remove("visible");
          }
        }
        // ---------------- [ä¿®æ”¹å¼€å§‹] æ–°å¢åŠŸèƒ½é€»è¾‘ ----------------

        // 1. åˆå§‹åŒ–æ¼«æ¸¸å­—å·è°ƒæ•´
        let currentAuroraFontSize = 16;
        function initAuroraFontControl() {
          const upBtn = document.getElementById("aurora-font-up");
          const downBtn = document.getElementById("aurora-font-down");
          const textViewer = document.getElementById("aurora-text-viewer");
          const subDisplay = document.getElementById(
            "aurora-custom-subtitle-display",
          );

          // è°ƒæ•´å­—å·çš„é€šç”¨å‡½æ•°
          const changeFontSize = (delta) => {
            currentAuroraFontSize = Math.max(
              10,
              Math.min(40, currentAuroraFontSize + delta),
            ); // é™åˆ¶åœ¨ 10px - 40px

            // åº”ç”¨åˆ°å°è¯´æ–‡æœ¬
            if (textViewer)
              textViewer.style.fontSize = `${currentAuroraFontSize}px`;

            // åº”ç”¨åˆ°è‡ªå®šä¹‰æ¨¡å¼å­—å¹•
            if (subDisplay)
              subDisplay.style.fontSize = `${currentAuroraFontSize}px`;
          };

          if (upBtn)
            upBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              changeFontSize(2);
            });
          if (downBtn)
            downBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              changeFontSize(-2);
            });
        }

        // 2. åˆå§‹åŒ–æ‰‹æœºç«¯è§¦æ‘¸ç¼©æ”¾
        function initAuroraResize() {
          const handle = document.getElementById("aurora-resize-handle");
          const overlay = document.getElementById("aurora-player-overlay");

          if (!handle || !overlay) return;

          let startX, startY, startWidth, startHeight;

          const onTouchStart = (e) => {
            e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
            e.stopPropagation();
            const touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
            startWidth = parseInt(
              document.defaultView.getComputedStyle(overlay).width,
              10,
            );
            startHeight = parseInt(
              document.defaultView.getComputedStyle(overlay).height,
              10,
            );

            document.addEventListener("touchmove", onTouchMove, {
              passive: false,
            });
            document.addEventListener("touchend", onTouchEnd);
          };

          const onTouchMove = (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const newWidth = startWidth + (touch.clientX - startX);
            const newHeight = startHeight + (touch.clientY - startY);

            // è®¾ç½®æœ€å°å°ºå¯¸é™åˆ¶
            if (newWidth > 200) overlay.style.width = `${newWidth}px`;
            if (newHeight > 150) overlay.style.height = `${newHeight}px`;
          };

          const onTouchEnd = () => {
            document.removeEventListener("touchmove", onTouchMove);
            document.removeEventListener("touchend", onTouchEnd);
          };

          handle.addEventListener("touchstart", onTouchStart, {
            passive: false,
          });

          // ä¸ºäº†å…¼å®¹ç”µè„‘é¼ æ ‡æ‹–æ‹½è¯¥è§’è½
          handle.addEventListener("mousedown", (e) => {
            e.preventDefault();
            e.stopPropagation();
            startX = e.clientX;
            startY = e.clientY;
            startWidth = parseInt(
              document.defaultView.getComputedStyle(overlay).width,
              10,
            );
            startHeight = parseInt(
              document.defaultView.getComputedStyle(overlay).height,
              10,
            );
            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup", onMouseUp);
          });

          const onMouseMove = (e) => {
            const newWidth = startWidth + (e.clientX - startX);
            const newHeight = startHeight + (e.clientY - startY);
            if (newWidth > 200) overlay.style.width = `${newWidth}px`;
            if (newHeight > 150) overlay.style.height = `${newHeight}px`;
          };

          const onMouseUp = () => {
            document.removeEventListener("mousemove", onMouseMove);
            document.removeEventListener("mouseup", onMouseUp);
          };
        }
        /**
         * å…¨å±€æ•°æ®åˆå§‹åŒ–ï¼ˆæ¢å¤å‡ºå‚è®¾ç½®ï¼‰
         */
        async function handleFactoryReset() {
          // 1. ç¬¬ä¸€é‡è­¦å‘Š
          const confirmed = await showCustomConfirm(
            "âš  ä¸¥é‡è­¦å‘Š",
            "æ­¤æ“ä½œå°†ã€å½»åº•æ¸…ç©ºã€‘æ‰€æœ‰æ•°æ®ï¼åŒ…æ‹¬ï¼š\n- æ‰€æœ‰èŠå¤©è®°å½•\n- æ‰€æœ‰è®¾ç½®ä¸API Key\n- æ‰€æœ‰å›¾ç‰‡ã€ä¸–ç•Œä¹¦ã€è¡¨æƒ…åŒ…\n\næ•°æ®ä¸€æ—¦åˆ é™¤ã€æ— æ³•æ¢å¤ã€‘ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ",
            { confirmButtonClass: "btn-danger" },
          );

          if (!confirmed) return;

          // 2. ç¬¬äºŒé‡è­¦å‘Š (ä½¿ç”¨åŸç”Ÿ confirm é˜²æ­¢è¯¯è§¦)
          if (confirm("æœ€åä¸€æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶é‡ç½®åº”ç”¨å—ï¼Ÿ")) {
            try {
              // æ˜¾ç¤ºåŠ è½½é®ç½©
              const loadingOverlay =
                document.getElementById("generation-overlay");
              if (loadingOverlay) {
                loadingOverlay.querySelector("p").textContent =
                  "æ­£åœ¨ç²‰ç¢æ•°æ®...";
                loadingOverlay.classList.add("visible");
              }

              // A. æ¸…ç©º IndexedDB æ•°æ®åº“çš„æ‰€æœ‰è¡¨
              await db.transaction("rw", db.tables, async () => {
                for (const table of db.tables) {
                  await table.clear();
                }
              });

              // B. æ¸…ç©º LocalStorage (åŒ…å«ä¸»é¢˜ã€éƒ¨åˆ†å¼€å…³è®¾ç½®ç­‰)
              localStorage.clear();

              // C. æˆåŠŸæç¤ºå¹¶åˆ·æ–°
              alert("æ•°æ®å·²å…¨éƒ¨åˆå§‹åŒ–ï¼Œåº”ç”¨å°†é‡å¯ã€‚");
              window.location.reload();
            } catch (error) {
              console.error(error);
              alert("åˆå§‹åŒ–å¤±è´¥: " + error.message);
              window.location.reload(); // å³ä½¿å¤±è´¥ä¹Ÿå°è¯•åˆ·æ–°
            }
          }
        }
        /**
         * ã€æ–°å¢ã€‘å…¨èƒ½æ•°æ®ä¿®å¤å‡½æ•°
         * æ‰«ææ‰€æœ‰æ•°æ®åº“è¡¨ï¼Œè¡¥å…¨ç¼ºå¤±å­—æ®µï¼Œä¿®å¤é”™è¯¯ç»“æ„ï¼Œé˜²æ­¢ç•Œé¢ç™½å±
         */
        async function repairAllData() {
          const confirmed = await showCustomConfirm(
            "æ•°æ®ä¿®å¤",
            "æ­¤åŠŸèƒ½å°†æ‰«ææ‰€æœ‰æ•°æ®ï¼Œè¡¥å…¨ç¼ºå¤±çš„å±æ€§å¹¶ä¿®å¤é”™è¯¯ç»“æ„ï¼ˆä¸ä¼šåˆ é™¤èŠå¤©è®°å½•ï¼‰ã€‚\n\nå¦‚æœä½ çš„ç•Œé¢å‡ºç°ç™½å±ã€å¡é¡¿æˆ–æŠ¥é”™ï¼Œè¯·å°è¯•æ­¤æ“ä½œã€‚\n\nç¡®å®šè¦å¼€å§‹ä¿®å¤å—ï¼Ÿ",
          );

          if (!confirmed) return;

          await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨æ·±åº¦æ‰«æå¹¶ä¿®å¤æ•°æ®ç»“æ„...");

          try {
            let fixCount = 0;

            // 1. ä¿®å¤èŠå¤©æ•°æ® (Chats)
            const allChats = await db.chats.toArray();
            for (const chat of allChats) {
              let needSave = false;

              // ä¿®å¤åŸºç¡€ç»“æ„
              if (!chat.history || !Array.isArray(chat.history)) {
                chat.history = [];
                needSave = true;
              }
              if (!chat.settings) {
                chat.settings = {};
                needSave = true;
              }
              if (!chat.status) {
                chat.status = {
                  text: "åœ¨çº¿",
                  lastUpdate: Date.now(),
                  isBusy: false,
                };
                needSave = true;
              }

              // ä¿®å¤ç¾¤èŠæˆå‘˜ç»“æ„
              if (chat.isGroup) {
                if (!chat.members || !Array.isArray(chat.members)) {
                  chat.members = [];
                  needSave = true;
                }
                chat.members.forEach((m) => {
                  if (!m.originalName && m.name) {
                    m.originalName = m.name;
                    needSave = true;
                  } // ä¿®å¤æ—§ç‰ˆåå­—
                  if (!m.groupNickname) {
                    m.groupNickname = m.originalName || "æœªçŸ¥æˆå‘˜";
                    needSave = true;
                  }
                });
              }

              // ä¿®å¤å•èŠè®¾ç½®
              if (!chat.isGroup) {
                // ä¿®å¤å…³ç³»çŠ¶æ€
                if (!chat.relationship) {
                  chat.relationship = { status: "friend" };
                  needSave = true;
                }

                // ä¿®å¤æ‰‹æœºæ•°æ®ç»“æ„ (æœ€å®¹æ˜“å¯¼è‡´æŠ¥é”™çš„éƒ¨åˆ†)
                if (!chat.characterPhoneData) {
                  chat.characterPhoneData = {};
                  needSave = true;
                }

                const phone = chat.characterPhoneData;
                const phoneDefaults = {
                  chats: {},
                  shoppingCart: [],
                  memos: [],
                  browserHistory: [],
                  photoAlbum: [],
                  bank: { balance: 0, transactions: [] },
                  trajectory: [],
                  appUsage: [],
                  diary: [],
                  widgets: {},
                };

                for (const key in phoneDefaults) {
                  if (!phone[key]) {
                    phone[key] = phoneDefaults[key];
                    needSave = true;
                  }
                }

                // ä¿®å¤é“¶è¡Œä½™é¢ä¸ºNaNçš„æƒ…å†µ
                if (phone.bank && typeof phone.bank.balance !== "number") {
                  phone.bank.balance = 0;
                  needSave = true;
                }
              }

              // ä¿®å¤è®¾ç½®ä¸­çš„ç¼ºå¤±é¡¹
              if (!chat.settings.streak) {
                chat.settings.streak = { enabled: false, currentDays: 0 };
                needSave = true;
              }
              if (!chat.settings.summary) {
                chat.settings.summary = {
                  enabled: false,
                  mode: "auto",
                  count: 20,
                  lastSummaryIndex: -1,
                };
                needSave = true;
              }

              if (needSave) {
                await db.chats.put(chat);
                fixCount++;
              }
            }

            // 2. ä¿®å¤å…¨å±€è®¾ç½® (Global Settings)
            let globalSettings = await db.globalSettings.get("main");
            if (!globalSettings) {
              globalSettings = { id: "main" }; // å¦‚æœå®Œå…¨ä¸¢å¤±ï¼Œé‡å»º
            }

            let globalNeedSave = false;
            if (!globalSettings.appIcons) {
              globalSettings.appIcons = {};
              globalNeedSave = true;
            }
            if (!globalSettings.appLabels) {
              globalSettings.appLabels = {};
              globalNeedSave = true;
            }
            if (
              !globalSettings.quickReplies ||
              !Array.isArray(globalSettings.quickReplies)
            ) {
              globalSettings.quickReplies = [];
              globalNeedSave = true;
            }
            // ä¿®å¤ä½™é¢NaN
            if (
              typeof globalSettings.userBalance !== "number" ||
              isNaN(globalSettings.userBalance)
            ) {
              globalSettings.userBalance = 0;
              globalNeedSave = true;
            }

            if (globalNeedSave) {
              await db.globalSettings.put(globalSettings);
              fixCount++;
            }

            // 3. ä¿®å¤åŠ¨æ€è®¾ç½® (Qzone Settings)
            let qzoneSettings = await db.qzoneSettings.get("main");
            if (!qzoneSettings) {
              await db.qzoneSettings.put({
                id: "main",
                nickname: "æˆ‘",
                avatar: "https://files.catbox.moe/q6z5fc.jpeg",
              });
              fixCount++;
            }

            await showCustomAlert(
              "ä¿®å¤å®Œæˆ",
              `å·²æ£€æŸ¥æ‰€æœ‰æ•°æ®ï¼Œå…±ä¿®å¤äº† ${fixCount} å¤„æ½œåœ¨é—®é¢˜ã€‚\n\né¡µé¢å³å°†åˆ·æ–°ä»¥åº”ç”¨æ›´æ”¹ã€‚`,
            );

            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } catch (error) {
            console.error("ä¿®å¤è¿‡ç¨‹ä¸­å‡ºé”™:", error);
            alert(`ä¿®å¤å¤±è´¥: ${error.message}\nè¯·æˆªå›¾æ§åˆ¶å°æŠ¥é”™ç»™å¼€å‘è€…ã€‚`);
          }
        }

        // 1. é€šç”¨å¤„ç†å‡½æ•°ï¼šç‚¹å‡»ä¸Šä¼ æŒ‰é’®æ—¶è§¦å‘
        async function handleCoupleImageSelect(previewImgId, fileInputId) {
          const choice = await showChoiceModal("é€‰æ‹©å›¾ç‰‡æ¥æº", [
            { text: "ğŸ“ ä»æœ¬åœ°ä¸Šä¼ ", value: "local" },
            { text: "ğŸŒ ä½¿ç”¨ç½‘ç»œURL", value: "url" },
          ]);

          if (!choice) return;

          if (choice === "local") {
            // è§¦å‘æœ¬åœ°æ–‡ä»¶é€‰æ‹©
            document.getElementById(fileInputId).click();
          } else if (choice === "url") {
            // å¼¹å‡ºè¾“å…¥æ¡†è·å–URL
            const url = await showCustomPrompt(
              "è¾“å…¥å›¾ç‰‡é“¾æ¥",
              "è¯·ç²˜è´´ä»¥ http å¼€å¤´çš„å›¾ç‰‡åœ°å€",
              "",
              "url",
            );
            if (url && url.trim()) {
              document.getElementById(previewImgId).src = url.trim();
            }
          }
        }

        // 2. ç»‘å®šä¸¤ä¸ªä¸Šä¼ æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ (ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„æ–°ID)
        document
          .getElementById("upload-couple-my-btn")
          .addEventListener("click", () => {
            handleCoupleImageSelect(
              "new-couple-my-avatar-preview",
              "new-couple-my-avatar-input",
            );
          });

        document
          .getElementById("upload-couple-char-btn")
          .addEventListener("click", () => {
            handleCoupleImageSelect(
              "new-couple-char-avatar-preview",
              "new-couple-char-avatar-input",
            );
          });

        // 3. ç»‘å®šæœ¬åœ°æ–‡ä»¶é€‰æ‹©åçš„é¢„è§ˆ (å¤ç”¨ä¹‹å‰çš„é€»è¾‘ï¼Œä¿æŒä¸å˜)
        // è¿™é‡Œçš„ setupFileUpload æ˜¯ä½ ä»£ç é‡Œå·²æœ‰çš„è¾…åŠ©å‡½æ•°
        setupFileUpload("new-couple-my-avatar-input", (base64) => {
          document.getElementById("new-couple-my-avatar-preview").src = base64;
        });
        setupFileUpload("new-couple-char-avatar-input", (base64) => {
          document.getElementById("new-couple-char-avatar-preview").src =
            base64;
        });
        // ==========================================
        // â˜…â˜…â˜… æ–°å¢åŠŸèƒ½ï¼šå…¨å±€è·¯äººå¤´åƒåº“é€»è¾‘ â˜…â˜…â˜…
        // ==========================================

        // 1. æ‰“å¼€ç®¡ç†ç•Œé¢
        async function openPasserbyManager() {
          await renderPasserbyGrid();
          document
            .getElementById("passerby-avatar-manager-modal")
            .classList.add("visible");
        }

        // 2. æ¸²æŸ“ç½‘æ ¼
        async function renderPasserbyGrid() {
          const grid = document.getElementById("passerby-avatar-grid");
          const countSpan = document.getElementById("passerby-count");
          grid.innerHTML = "";

          // ä»æ•°æ®åº“è·å–æ‰€æœ‰
          const avatars = await db.passerbyAvatars.toArray();
          countSpan.textContent = avatars.length;

          // æ›´æ–°å…¨å±€ç¼“å­˜ (é‡è¦)
          window.state.passerbyAvatars = avatars;

          if (avatars.length === 0) {
            grid.innerHTML =
              '<p style="grid-column:1/-1; text-align:center; color:#999;">å›¾åº“ä¸ºç©ºï¼Œå¿«å»æ·»åŠ ä¸€äº›å§ï¼</p>';
            return;
          }

          avatars.forEach((item) => {
            const div = document.createElement("div");
            div.className = "sticker-item"; // å¤ç”¨ç°æœ‰çš„è´´çº¸æ ·å¼
            div.style.backgroundImage = `url(${item.url})`;
            div.style.borderRadius = "8px";
            div.style.aspectRatio = "1/1";

            // åˆ é™¤æŒ‰é’®
            const delBtn = document.createElement("div");
            delBtn.className = "delete-btn";
            delBtn.innerHTML = "Ã—";
            delBtn.style.display = "block";
            delBtn.onclick = async (e) => {
              e.stopPropagation();
              if (confirm("ç¡®å®šåˆ é™¤è¿™å¼ å¤´åƒå—ï¼Ÿ")) {
                await db.passerbyAvatars.delete(item.id);
                renderPasserbyGrid();
              }
            };

            div.appendChild(delBtn);
            grid.appendChild(div);
          });
        }

        // 3. å¤„ç†æ·»åŠ å¤´åƒ (æ”¯æŒæœ¬åœ°å¤šé€‰ å’Œ URL)
        async function handleAddPasserbyAvatar() {
          const choice = await showChoiceModal("æ·»åŠ æ–¹å¼", [
            { text: "ğŸ“ æœ¬åœ°ä¸Šä¼  (æ”¯æŒå¤šé€‰)", value: "local" },
            { text: "ğŸŒ ç½‘ç»œå›¾ç‰‡URL", value: "url" },
          ]);

          if (!choice) return;

          if (choice === "local") {
            document.getElementById("passerby-upload-input").click();
          } else if (choice === "url") {
            const url = await showCustomPrompt("è¾“å…¥URL", "è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥");
            if (url && url.trim()) {
              await db.passerbyAvatars.add({ url: url.trim() });
              alert("æ·»åŠ æˆåŠŸ");
              // å¦‚æœç®¡ç†ç•Œé¢å¼€ç€ï¼Œå°±åˆ·æ–°å®ƒ
              if (
                document
                  .getElementById("passerby-avatar-manager-modal")
                  .classList.contains("visible")
              ) {
                renderPasserbyGrid();
              }
            }
          }
        }

        // 4. å¤„ç†æœ¬åœ°æ–‡ä»¶é€‰æ‹©
        async function handlePasserbyFileChange(event) {
          const files = event.target.files;
          if (!files.length) return;

          // æ˜¾ç¤ºåŠ è½½æç¤º
          const btn = document.getElementById("add-passerby-avatar-btn");
          const originalText = btn.textContent;
          btn.textContent = "å¤„ç†ä¸­...";

          const newItems = [];
          for (const file of files) {
            // å¤ç”¨ä½ çš„å›¾ç‰‡å‹ç¼©å‡½æ•° handleImageUploadAndCompress
            try {
              const base64 = await handleImageUploadAndCompress(file);
              newItems.push({ url: base64 });
            } catch (e) {
              console.error("å›¾ç‰‡å¤„ç†å¤±è´¥", e);
            }
          }

          if (newItems.length > 0) {
            await db.passerbyAvatars.bulkAdd(newItems);
            alert(`æˆåŠŸæ·»åŠ  ${newItems.length} å¼ å¤´åƒï¼`);
            // åˆ·æ–°ç¼“å­˜
            window.state.passerbyAvatars = await db.passerbyAvatars.toArray();
            // å¦‚æœç®¡ç†ç•Œé¢å¼€ç€ï¼Œåˆ·æ–°
            if (
              document
                .getElementById("passerby-avatar-manager-modal")
                .classList.contains("visible")
            ) {
              renderPasserbyGrid();
            }
          }

          btn.textContent = originalText;
          event.target.value = null; // æ¸…ç©º
        }

        // 5. ã€æ ¸å¿ƒå·¥å…·å‡½æ•°ã€‘æ ¹æ®åå­—è·å–å¤´åƒ
        // å¦‚æœåå­—ç›¸åŒï¼Œå°½é‡è¿”å›ç›¸åŒçš„å¤´åƒï¼ˆä¼ªéšæœºï¼‰ï¼›å¦‚æœæ²¡æœ‰åº“ï¼Œè¿”å›é»˜è®¤ã€‚
        window.getAvatarForName = function (name) {
          const lib = window.state.passerbyAvatars || [];
          if (lib.length === 0)
            return "https://i.postimg.cc/PxZrFFFL/o-o-1.jpg"; // é»˜è®¤å¤´åƒ

          // ç®€å•çš„å“ˆå¸Œç®—æ³•ï¼Œå°†åå­—è½¬ä¸ºæ•°å­—
          let hash = 0;
          for (let i = 0; i < name.length; i++) {
            hash = name.charCodeAt(i) + ((hash << 5) - hash);
          }

          // å–ç»å¯¹å€¼å¹¶å–æ¨¡
          const index = Math.abs(hash) % lib.length;
          return lib[index].url;
        };
        /**
         * ç»Ÿä¸€çš„ Pollinations ç”Ÿå›¾å‡½æ•° (ä» Taobao, Date, XHS æå–å¹¶åˆå¹¶)
         * ä¼˜å…ˆä½¿ç”¨ API Keyï¼Œæ”¯æŒæ— é™é‡è¯•æœºåˆ¶
         * @param {string} prompt - è‹±æ–‡æç¤ºè¯
         * @param {object} options - é…ç½®é¡¹ { width, height, model, seed, nologo }
         * @returns {Promise<string>} - è¿”å›å›¾ç‰‡åœ°å€ (Blob URL æˆ– å…¬ç½‘ URL)
         */
        window.generatePollinationsImage = async function (
          prompt,
          options = {},
        ) {
          const {
            width = 1024,
            height = 1024,
            model = "flux",
            seed = Math.floor(Math.random() * 100000),
            nologo = false,
          } = options;

          console.log(
            `[Global Image Gen] Prompt: ${prompt}, Options:`,
            options,
          );

          while (true) {
            try {
              const encodedPrompt = encodeURIComponent(prompt);
              // å°è¯•è·å–å…¨å±€ stateï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¸º null
              const currentApiConfig =
                window.state && window.state.apiConfig
                  ? window.state.apiConfig
                  : null;
              const pollApiKey = currentApiConfig
                ? currentApiConfig.pollinationsApiKey
                : null;

              // æ„å»ºåŸºç¡€å‚æ•°
              let queryParams = `width=${width}&height=${height}&seed=${seed}&model=${model}`;
              if (nologo) queryParams += "&nologo=true";

              // 1. === æœ‰ API Key çš„æƒ…å†µ ===
              if (pollApiKey) {
                const primaryUrl = `https://gen.pollinations.ai/image/${encodedPrompt}?${queryParams}&key=${pollApiKey}`;
                console.log(
                  `[Global Image Gen] ä½¿ç”¨ API Key è¯·æ±‚: ${primaryUrl}`,
                );

                const response = await fetch(primaryUrl, { method: "GET" });

                if (!response.ok) {
                  throw new Error(`API Key è¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const blob = await response.blob();
                // å°† Blob è½¬ä¸º Base64 ä»¥ä¾¿å­˜å‚¨å’ŒæŒä¹…åŒ–åŠ è½½ (è§£å†³ blob:null æŠ¥é”™é—®é¢˜)
                return await new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onloadend = () => resolve(reader.result);
                  reader.onerror = reject;
                  reader.readAsDataURL(blob);
                });
              }

              // 2. === æ—  API Key (å…¬å¼€æ¥å£) çš„æƒ…å†µ ===
              // å®šä¹‰åŠ è½½å™¨
              const loadImage = (url) =>
                new Promise((resolve, reject) => {
                  const img = new Image();
                  img.src = url;
                  img.onload = () => resolve(url);
                  img.onerror = () => reject(new Error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${url}`));
                });

              // ä¼˜å…ˆå°è¯• gen.pollinations.ai
              const primaryUrl = `https://gen.pollinations.ai/image/${encodedPrompt}?${queryParams}`;

              return await loadImage(primaryUrl).catch(async () => {
                console.warn(`[Global Image Gen] ä¸»æ¥å£å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ¥å£...`);
                // å¤‡ç”¨æ¥å£ pollinations.ai/p/
                const fallbackUrl = `https://pollinations.ai/p/${encodedPrompt}?${queryParams}`;
                return await loadImage(fallbackUrl);
              });
            } catch (error) {
              console.error(
                `[Global Image Gen] ç”Ÿæˆå¤±è´¥ï¼Œ5ç§’åè‡ªåŠ¨é‡è¯•... é”™è¯¯: ${error.message}`,
              );
              await new Promise((resolve) => setTimeout(resolve, 5000));
            }
          }
        };
        /* ==================================================
   ã€å…¨å±ä¸‰å‡»è§¦å‘ç‰ˆã€‘æ¡Œé¢æ‹–æ‹½ç³»ç»Ÿ
   è§¦å‘æ–¹å¼ï¼šåœ¨ä¸»å±å¹•ä»»æ„ä½ç½®ï¼ˆéå¼¹çª—/éè®¾ç½®é¡µï¼‰è¿ç»­ç‚¹å‡» 3 æ¬¡
   ä¿®å¤å†…å®¹ï¼šåŒ…å«å¯¹ç¬¬äºŒé¡µç»„ä»¶ä½ç½®çš„é€»è¾‘å…¼å®¹
   ================================================== */
        function initDesktopManager() {
          const homeScreen = document.getElementById("home-screen");
          const doneBtn = document.getElementById("desktop-edit-done-btn");
          const sliderContainer = document.querySelector(".home-screen-slider");

          // åˆ›å»ºâ€œé‡ç½®å¸ƒå±€â€æŒ‰é’®
          let resetBtn = document.getElementById("desktop-reset-layout-btn");
          if (!resetBtn) {
            resetBtn = document.createElement("div");
            resetBtn.id = "desktop-reset-layout-btn";
            resetBtn.textContent = "é‡ç½®å¸ƒå±€";
            resetBtn.style.cssText = `
            position: absolute;
            top: 50px;
            right: 80px; 
            background: rgba(255, 59, 48, 0.9);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10000;
            cursor: pointer;
            backdrop-filter: blur(10px);
            display: none; 
        `;
            homeScreen.appendChild(resetBtn);
          }

          // å®šä¹‰æ‰€æœ‰å¯æ‹–æ‹½çš„ç›®æ ‡
          const selector =
            ".home-page .desktop-app-icon, .home-page .custom-widget-container, #new-custom-widget, #profile-widget, #desktop-widget-column, #center-avatar-wrapper, .draggable-group, #glass-music-widget";

          let isEditMode = false;
          let dragItem = null;
          let originalParent = null;
          let shiftX = 0;
          let shiftY = 0;

          // --- åˆå§‹åŒ–ID ---
          const assignStableIds = () => {
            document.querySelectorAll(selector).forEach((el, index) => {
              if (!el.id) {
                const label = el.querySelector(".label");
                const innerImg = el.querySelector("img[id^='icon-img-']");
                if (innerImg && innerImg.id) {
                  el.id = "wrapper_" + innerImg.id;
                } else if (label) {
                  el.id = "auto_pos_" + label.innerText.trim();
                } else {
                  el.id = "auto_pos_idx_" + index;
                }
              }
            });
          };
          assignStableIds();

          // å»¶è¿Ÿæ¢å¤å¸ƒå±€ï¼Œå¹¶åº”ç”¨CSSå±…ä¸­ä¿®å¤
          setTimeout(() => {
            restoreLayout();
            // å¼ºåˆ¶åˆ·æ–°ä¸€æ¬¡ç¬¬äºŒé¡µç»„ä»¶çš„ä½ç½®ï¼Œç¡®ä¿CSSç”Ÿæ•ˆ
            const centerWidget = document.getElementById(
              "center-avatar-wrapper",
            );
            if (centerWidget && centerWidget.style.position !== "absolute") {
              // å¦‚æœæ²¡æœ‰è¢«æ‹–æ‹½è¿‡ï¼ˆæ²¡æœ‰ä¿å­˜ç»å¯¹å®šä½ï¼‰ï¼Œåˆ™æ¸…é™¤å†…è”æ ·å¼ï¼Œè®©CSSçš„å±…ä¸­ç”Ÿæ•ˆ
              centerWidget.style.left = "";
              centerWidget.style.top = "";
              centerWidget.style.transform = "";
            }
          }, 200);

          // ============================================================
          // â˜…â˜…â˜… ã€é‡ç‚¹ä¿®æ”¹ã€‘å…¨å±ä¸‰å‡»é€»è¾‘ â˜…â˜…â˜…
          // ============================================================
          let clickCount = 0;
          let clickTimer = null;

          // æˆ‘ä»¬æŠŠç›‘å¬å™¨ç»‘åœ¨ homeScreen ä¸Šï¼Œè¦†ç›–æ•´ä¸ªæ¡Œé¢åŒºåŸŸ
          homeScreen.addEventListener(
            "click",
            (e) => {
              // 1. å¦‚æœå·²ç»åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œä¸å¤„ç†
              // 2. å¦‚æœç‚¹å‡»çš„æ˜¯â€œå®Œæˆâ€æˆ–â€œé‡ç½®â€æŒ‰é’®ï¼Œä¸å¤„ç†
              if (
                isEditMode ||
                e.target.id === "desktop-edit-done-btn" ||
                e.target.id === "desktop-reset-layout-btn"
              )
                return;

              // 3. è®¡æ•°
              clickCount++;

              // ç¬¬ä¸€æ¬¡ç‚¹å‡»å¼€å¯è®¡æ—¶å™¨
              if (clickCount === 1) {
                clickTimer = setTimeout(() => {
                  clickCount = 0; // 500ms å†…æ²¡ç‚¹å¤Ÿ3æ¬¡ï¼Œå½’é›¶
                }, 500);
              }

              // è¾¾åˆ°3æ¬¡
              if (clickCount >= 3) {
                clearTimeout(clickTimer);
                clickCount = 0;

                // éœ‡åŠ¨åé¦ˆ
                if (navigator.vibrate) navigator.vibrate([50, 50, 50]);

                // é˜»æ­¢è¿™æ¬¡ç‚¹å‡»å¯èƒ½å¼•å‘çš„ APP æ‰“å¼€ç­‰è¡Œä¸º
                e.preventDefault();
                e.stopPropagation();

                enterEditMode();
              }
            },
            true,
          ); // ä½¿ç”¨æ•è·é˜¶æ®µ (true)ï¼Œç¡®ä¿æ¯” APP å›¾æ ‡çš„ç‚¹å‡»äº‹ä»¶å…ˆè§¦å‘

          // ============================================================

          // --- æ‹–æ‹½é€»è¾‘ ---
          // è¿™é‡Œå»æ‰äº†åŸæ¥çš„é•¿æŒ‰è®¡æ—¶å™¨ï¼Œåªä¿ç•™æ‹–æ‹½
          const handleInputDown = (e) => {
            if (!isEditMode) return; // åªæœ‰ç¼–è¾‘æ¨¡å¼ä¸‹æ‰å…è®¸æ‹–æ‹½

            if (
              e.target.id === "desktop-edit-done-btn" ||
              e.target.id === "desktop-reset-layout-btn"
            )
              return;

            let target = e.target.closest(selector);
            if (target && target.parentElement.closest(selector)) {
              target = target.parentElement.closest(selector);
            }

            if (target) {
              prepareDrag(e, target);
            }
          };

          sliderContainer.addEventListener("mousedown", handleInputDown);
          sliderContainer.addEventListener("touchstart", handleInputDown, {
            passive: false,
          });

          // --- å‡†å¤‡æ‹–æ‹½ ---
          function prepareDrag(e, item) {
            e.preventDefault();
            dragItem = item;
            const rect = dragItem.getBoundingClientRect();
            originalParent = dragItem.parentNode;

            // ä¿®å¤ï¼šæ‹–æ‹½æ—¶å¦‚æœæ˜¯å±…ä¸­çš„ç»„ä»¶ï¼Œå…ˆè®¡ç®—å‡ºå®ƒå½“å‰çš„å®é™…åƒç´ ä½ç½®ï¼Œè½¬ä¸º absolute left/top
            // å¦åˆ™ä¸€æ‹–åŠ¨ï¼Œtransform: translate(-50%, -50%) ä¼šå¯¼è‡´åæ ‡çªå˜
            if (dragItem.id === "center-avatar-wrapper") {
              dragItem.style.transform = "none"; // æš‚æ—¶ç§»é™¤ CSS å±…ä¸­å˜æ¢
              dragItem.style.left = rect.left + "px"; // å›ºåŒ–å½“å‰è§†è§‰ä½ç½®
              dragItem.style.top = rect.top + "px";
            }

            const parentStyle = window.getComputedStyle(originalParent);
            if (parentStyle.position === "static") {
              originalParent.style.position = "relative";
            }

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            shiftX = clientX - rect.left;
            shiftY = clientY - rect.top;

            document.body.appendChild(dragItem);
            dragItem.classList.add("is-dragging-active");

            dragItem.style.position = "fixed";
            dragItem.style.zIndex = "99999";
            dragItem.style.width = rect.width + "px";
            dragItem.style.height = rect.height + "px";
            dragItem.style.left = rect.left + "px";
            dragItem.style.top = rect.top + "px";
            dragItem.style.margin = "0"; // æ¸…é™¤ margin
            dragItem.style.transform = "none"; // æ¸…é™¤ transform

            document.addEventListener("mousemove", onDragMove);
            document.addEventListener("touchmove", onDragMove, {
              passive: false,
            });
            document.addEventListener("mouseup", onDragEnd);
            document.addEventListener("touchend", onDragEnd);
          }

          // --- æ‹–æ‹½ç§»åŠ¨ ---
          function onDragMove(e) {
            if (!dragItem) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            dragItem.style.left = clientX - shiftX + "px";
            dragItem.style.top = clientY - shiftY + "px";
          }

          // --- æ‹–æ‹½ç»“æŸ ---
          function onDragEnd() {
            if (dragItem && originalParent) {
              dragItem.classList.remove("is-dragging-active");
              const rect = dragItem.getBoundingClientRect();
              const parentRect = originalParent.getBoundingClientRect();
              const parentStyle = window.getComputedStyle(originalParent);
              const borderLeft = parseFloat(parentStyle.borderLeftWidth) || 0;
              const borderTop = parseFloat(parentStyle.borderTopWidth) || 0;

              const relativeLeft =
                rect.left -
                parentRect.left -
                borderLeft +
                originalParent.scrollLeft;
              const relativeTop =
                rect.top -
                parentRect.top -
                borderTop +
                originalParent.scrollTop;

              originalParent.appendChild(dragItem);

              dragItem.style.position = "absolute";
              dragItem.style.zIndex = "";
              dragItem.style.left = relativeLeft + "px";
              dragItem.style.top = relativeTop + "px";
              dragItem.style.width = rect.width + "px";
              dragItem.style.height = rect.height + "px";
              dragItem.style.margin = "0"; // ç¡®ä¿æ”¾å›åä¹Ÿæ²¡æœ‰margin
              dragItem.style.transform = "none"; // ç¡®ä¿æ”¾å›åæ²¡æœ‰transform

              // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯å±…ä¸­ç»„ä»¶ï¼Œè¢«æ‹–åŠ¨åï¼Œå®ƒå°±å˜æˆäº†æ™®é€šç»å¯¹å®šä½ç»„ä»¶
              // ä¸éœ€è¦é¢å¤–æ“ä½œï¼Œä¸Šé¢çš„ left/top å·²ç»å›ºåŒ–äº†å®ƒçš„ä½ç½®

              if (
                originalParent.clientHeight < 50 &&
                originalParent.id !== "phone-screen"
              ) {
                originalParent.style.minHeight = "100px";
              }

              dragItem = null;
              originalParent = null;
            }

            document.removeEventListener("mousemove", onDragMove);
            document.removeEventListener("touchmove", onDragMove);
            document.removeEventListener("mouseup", onDragEnd);
            document.removeEventListener("touchend", onDragEnd);
          }

          function enterEditMode() {
            isEditMode = true;
            homeScreen.classList.add("editing-mode");
            doneBtn.style.display = "block";
            const resetBtn = document.getElementById(
              "desktop-reset-layout-btn",
            );
            if (resetBtn) resetBtn.style.display = "block";
            document.addEventListener("click", blockClickInEditMode, true);
          }

          doneBtn.addEventListener("click", () => {
            isEditMode = false;
            homeScreen.classList.remove("editing-mode");
            doneBtn.style.display = "none";
            const resetBtn = document.getElementById(
              "desktop-reset-layout-btn",
            );
            if (resetBtn) resetBtn.style.display = "none";
            document.removeEventListener("click", blockClickInEditMode, true);
            saveLayout();
          });

          resetBtn.addEventListener("click", async () => {
            if (confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰å¸ƒå±€å—ï¼Ÿé¡µé¢å°†åˆ·æ–°ã€‚")) {
              if (window.state && window.state.globalSettings) {
                window.state.globalSettings.desktopLayoutV2 = null;
                await window.db.globalSettings.put(window.state.globalSettings);
                location.reload();
              }
            }
          });

          function blockClickInEditMode(e) {
            if (
              e.target.id === "desktop-edit-done-btn" ||
              e.target.id === "desktop-reset-layout-btn"
            )
              return;
            if (isEditMode) {
              e.stopPropagation();
              e.preventDefault();
            }
          }

          // --- ä¿å­˜å¸ƒå±€ ---
          async function saveLayout() {
            if (!window.db || !window.state) return;
            assignStableIds();
            const layoutData = {};
            const items = document.querySelectorAll(selector);
            items.forEach((item) => {
              // æ£€æŸ¥ï¼šåªæœ‰å½“å…ƒç´ è¢«æ˜ç¡®è®¾ä¸º absolute æ—¶æ‰ä¿å­˜ä½ç½®
              // è¿™å¯ä»¥å…¼å®¹ç¬¬ä¸€æ­¥CSSé‡Œå†™çš„åˆå§‹å±…ä¸­çŠ¶æ€ï¼ˆæ²¡æœ‰absolute left/topï¼‰
              if (
                item.id &&
                item.style.position === "absolute" &&
                item.style.left
              ) {
                layoutData[item.id] = {
                  left: item.style.left,
                  top: item.style.top,
                  width: item.style.width,
                  height: item.style.height,
                  parentId: item.parentNode.id || null,
                };
              }
            });
            window.state.globalSettings.desktopLayoutV2 = layoutData;
            await window.db.globalSettings.put(window.state.globalSettings);
          }

          // --- æ¢å¤å¸ƒå±€ ---
          async function restoreLayout() {
            if (!window.db || !window.state || !window.state.globalSettings) {
              setTimeout(restoreLayout, 500);
              return;
            }
            const layoutData = window.state.globalSettings.desktopLayoutV2;
            if (layoutData) {
              assignStableIds();
              for (const [id, pos] of Object.entries(layoutData)) {
                const el = document.getElementById(id);
                if (el) {
                  el.style.position = "absolute";
                  el.style.left = pos.left;
                  el.style.top = pos.top;
                  el.style.width = pos.width;
                  el.style.height = pos.height;
                  el.style.margin = "0";
                  // å¦‚æœè¯»å–åˆ°äº†è‡ªå®šä¹‰ä½ç½®ï¼Œå°±å¿…é¡»ç§»é™¤ CSS é‡Œçš„ transform å±…ä¸­
                  el.style.transform = "none";
                  el.style.bottom = "auto";
                  el.style.right = "auto";

                  const parent = el.parentNode;
                  if (parent) {
                    const parentStyle = window.getComputedStyle(parent);
                    if (parentStyle.position === "static") {
                      parent.style.position = "relative";
                    }
                    if (
                      parent.clientHeight < 50 &&
                      parent.id !== "phone-screen"
                    ) {
                      parent.style.minHeight = "100px";
                    }
                  }
                }
              }
            }
          }
        }

        function captureVideoFrame(videoElement) {
          if (!videoElement || videoElement.paused || videoElement.ended)
            return null;
          try {
            const canvas = document.createElement("canvas");
            // é™åˆ¶ä¸€ä¸‹å°ºå¯¸ï¼Œé˜²æ­¢tokenæ¶ˆè€—è¿‡å¤§æˆ–ä¼ è¾“è¿‡æ…¢ï¼Œå®½è®¾ç½®ä¸º 512px å·¦å³è¶³å¤Ÿäº†
            const scale = 512 / videoElement.videoWidth;
            canvas.width = 512;
            canvas.height = videoElement.videoHeight * scale;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            // è¿”å› jpeg æ ¼å¼ï¼Œè´¨é‡ 0.6
            return canvas.toDataURL("image/jpeg", 0.6);
          } catch (e) {
            console.error("æˆªå›¾å¤±è´¥:", e);
            return null;
          }
        }

        // 4. åˆå§‹åŒ–å‡½æ•° init()
        // ===================================================================
        async function init() {
          // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ ä¿®æ”¹ï¼šæ³¨å†ŒçœŸæ­£çš„ sw.js æ–‡ä»¶ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
          if ("serviceWorker" in navigator) {
            try {
              // è¿™ä¸€è¡Œå˜äº†ï¼šç›´æ¥åŠ è½½æ ¹ç›®å½•çš„ sw.js
              const registration =
                await navigator.serviceWorker.register("sw.js");
              console.log(
                "ServiceWorker æ³¨å†ŒæˆåŠŸ (File Mode), Scope:",
                registration.scope,
              );

              // ç­‰å¾…æ¿€æ´»
              await navigator.serviceWorker.ready;
            } catch (error) {
              console.error("ServiceWorker æ³¨å†Œå¤±è´¥:", error);
              // æç¤ºç”¨æˆ·å¯èƒ½çš„åŸå› 
              console.warn(
                "æç¤ºï¼šè¯·ç¡®ä¿ sw.js æ–‡ä»¶ä½äºç½‘ç«™æ ¹ç›®å½•ï¼Œä¸”é€šè¿‡ HTTPS æˆ– localhost è®¿é—®ã€‚",
              );
            }
          }
          // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

          const savedTheme = localStorage.getItem("ephone-theme") || "light"; // é»˜è®¤ä¸ºæ—¥é—´æ¨¡å¼
          applyTheme(savedTheme);

          const customBubbleStyleTag = document.createElement("style");
          customBubbleStyleTag.id = "custom-bubble-style";
          document.head.appendChild(customBubbleStyleTag);

          const previewBubbleStyleTag = document.createElement("style");
          previewBubbleStyleTag.id = "preview-bubble-style";
          document.head.appendChild(previewBubbleStyleTag);

          applyScopedCss("", "#chat-messages", "custom-bubble-style"); // æ¸…é™¤çœŸå®èŠå¤©ç•Œé¢çš„è‡ªå®šä¹‰æ ·å¼
          applyScopedCss("", "#settings-preview-area", "preview-bubble-style"); // æ¸…é™¤é¢„è§ˆåŒºçš„è‡ªå®šä¹‰æ ·å¼

          window.showScreen = showScreen;
          window.openLoversSpaceFromCard = openLoversSpaceFromCard;
          window.renderChatListProxy = renderChatList;
          window.renderApiSettingsProxy = renderApiSettings;
          window.renderWallpaperScreenProxy = renderWallpaperScreen;
          window.renderWorldBookScreenProxy = renderWorldBookScreen;
          const keepAliveUnlocker = () => {
            const player = document.getElementById("strong-keep-alive-player");
            if (player) {
              player.volume = 0; // ç¡®ä¿é™éŸ³
              player
                .play()
                .then(() => {
                  console.log("ğŸ”¥ å¼ºåŠ›ä¿æ´»æ¨¡å¼å·²æ¿€æ´»ï¼šé™éŸ³éŸ³é¢‘æ­£åœ¨å¾ªç¯æ’­æ”¾");
                })
                .catch((e) => {
                  console.warn("ä¿æ´»å¯åŠ¨å¤±è´¥ (éœ€ç”¨æˆ·äº¤äº’):", e);
                });
            }
            document.removeEventListener("click", keepAliveUnlocker);
            document.removeEventListener("touchstart", keepAliveUnlocker);
          };

          document.addEventListener("click", keepAliveUnlocker);
          document.addEventListener("touchstart", keepAliveUnlocker);

          await loadAllDataFromDB();
          // æ·»åŠ å¯åŠ¨æ—¶åŠ è½½CSSçš„é€»è¾‘
          // ä¼˜å…ˆåº”ç”¨ä¿å­˜åœ¨ activeCustomCss é‡Œçš„ä»£ç 
          if (state.globalSettings.activeCustomCss) {
            applyThemeCss(state.globalSettings.activeCustomCss);
          }
          // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰CSSï¼Œå†å°è¯•åº”ç”¨ä¸Šæ¬¡é€‰ä¸­çš„ä¸»é¢˜
          else if (state.globalSettings.activeThemeId) {
            const activeTheme = await db.themes.get(
              state.globalSettings.activeThemeId,
            );
            if (activeTheme) {
              console.log(`æ­£åœ¨åº”ç”¨å·²ä¿å­˜çš„ä¸»é¢˜: "${activeTheme.name}"`);
              applyThemeCss(activeTheme.css);
            }
          }

          if (
            typeof state.globalSettings.notificationSoundUrl === "undefined"
          ) {
            state.globalSettings.notificationSoundUrl =
              "https://files.catbox.moe/k369mf.mp3";
          }

          renderHomeScreenProfileFrame(); // åˆå§‹åŒ–æ—¶æ¸²æŸ“ä¸»é¡µå¤´åƒæ¡†

          applyHomeIconWidgetTextColor(
            state.globalSettings.homeIconWidgetTextColor,
          );
          await loadAllFontPresetsOnStartup();
          await migrateDefaultLudoQuestions();
          await addDefaultDarkModeThemeIfNeeded();
          applyWidgetData();

          if (state.globalSettings.homeIconWidgetTextColor) {
            applyHomeIconWidgetTextColor(
              state.globalSettings.homeIconWidgetTextColor,
            );
          }

          // 2. åº”ç”¨å·²ä¿å­˜çš„â€œå»é™¤é˜´å½±â€è®¾ç½®
          document
            .getElementById("phone-screen")
            .classList.toggle(
              "no-home-font-shadow",
              !!state.globalSettings.removeHomeFontShadow,
            );

          // åˆå§‹åŒ–æœªè¯»åŠ¨æ€è®¡æ•°
          const storedCount =
            parseInt(localStorage.getItem("unreadPostsCount")) || 0;
          updateUnreadIndicator(storedCount);

          if (state.globalSettings && state.globalSettings.fontUrl) {
            applyCustomFont(state.globalSettings.fontUrl);
          }

          // åˆå§‹åŒ–æ—¶ï¼Œè‡ªåŠ¨åŠ è½½å¹¶åº”ç”¨å·²ä¿å­˜çš„ä¸»é¢˜
          if (state.globalSettings.activeThemeId) {
            const activeTheme = await db.themes.get(
              state.globalSettings.activeThemeId,
            );
            if (activeTheme) {
              console.log(`æ­£åœ¨åº”ç”¨å·²ä¿å­˜çš„ä¸»é¢˜: "${activeTheme.name}"`);
              applyThemeCss(activeTheme.css);
            }
          }

          updateClock();
          setInterval(updateClock, 1000 * 30);
          applyGlobalWallpaper();
          initBatteryManager();

          applyAppIcons();
          applyAppLabels();

          initDraggableLyricsBar(); // åˆå§‹åŒ–æ‚¬æµ®æ­Œè¯æ çš„æ‹–åŠ¨åŠŸèƒ½

          // ==========================================================
          // --- å„ç§äº‹ä»¶ç›‘å¬å™¨ ---
          // ==========================================================

          // â€œæŸ¥è§’è‰²æ‰‹æœºâ€åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨

          // 1. ç»‘å®šä¸»å±å¹•ä¸Šçš„â€œæŸ¥æ‰‹æœºâ€APPå›¾æ ‡
          document
            .getElementById("check-phone-btn")
            .addEventListener("click", openCharacterSelectionScreen);

          // 2. è§’è‰²é€‰æ‹©åˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
          document
            .getElementById("character-selection-list")
            .addEventListener("click", (e) => {
              const item = e.target.closest(".character-select-item");
              if (item && item.dataset.chatId) {
                openCharacterPhone(item.dataset.chatId);
              }
            });

          // 3. è§’è‰²æ‰‹æœºé¡¶éƒ¨çš„â€œåˆ·æ–°â€å’Œâ€œæ¸…ç©ºâ€æŒ‰é’®
          document
            .getElementById("generate-character-data-btn")
            .addEventListener("click", generateCharacterPhoneData);
          document
            .getElementById("clear-character-data-btn")
            .addEventListener("click", clearCharacterPhoneData);

          document
            .getElementById("character-phone-container")
            .addEventListener("click", (e) => {
              const backBtn = e.target.closest(".back-btn");
              const actionBtn = e.target.closest(".action-btn");

              // 1. å¤„ç†è¿”å›æŒ‰é’®
              if (backBtn) {
                if (backBtn.dataset.targetPage) {
                  showCharacterPhonePage(backBtn.dataset.targetPage);
                } else if (backBtn.dataset.targetScreen) {
                  showScreen(backBtn.dataset.targetScreen);
                }
                return;
              }

              // 2. å¤„ç†æ‰€æœ‰æ“ä½œæŒ‰é’®ï¼ˆç”Ÿæˆ + åˆ é™¤ï¼‰
              if (actionBtn) {
                switch (actionBtn.id) {
                  // --- å•ç‹¬ç”ŸæˆæŒ‰é’® ---
                  case "generate-chat-message-btn":
                    openChatGenerationModal();
                    break;
                  case "generate-cart-item-btn":
                    generateCharacterPhoneDataSegment("shoppingCart");
                    break;
                  case "generate-memo-btn":
                    generateCharacterPhoneDataSegment("memos");
                    break;
                  case "generate-browser-history-btn":
                    generateCharacterPhoneDataSegment("browserHistory");
                    break;
                  case "generate-album-photo-btn":
                    generateCharacterPhoneDataSegment("photoAlbum");
                    break;
                  case "generate-bank-transaction-btn":
                    generateCharacterPhoneDataSegment("bank");
                    break;
                  case "generate-trajectory-btn":
                    generateCharacterPhoneDataSegment("trajectory");
                    break;
                  case "generate-app-usage-btn":
                    generateCharacterPhoneDataSegment("appUsage");
                    break;
                  case "generate-diary-entry-btn":
                    generateCharacterPhoneDataSegment("diary");
                    break;

                  // --- â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„å…¨éƒ¨åˆ é™¤æŒ‰é’®çš„é€»è¾‘ â˜…â˜…â˜… ---
                  case "clear-npc-chats-btn":
                    handleClearCharacterDataSegment("chats");
                    break;
                  case "clear-cart-items-btn":
                    handleClearCharacterDataSegment("shoppingCart");
                    break;
                  case "clear-memos-btn":
                    handleClearCharacterDataSegment("memos");
                    break;
                  case "clear-browser-history-btn":
                    handleClearCharacterDataSegment("browserHistory");
                    break;
                  case "clear-album-photos-btn":
                    handleClearCharacterDataSegment("photoAlbum");
                    break;
                  case "clear-bank-transactions-btn":
                    handleClearCharacterDataSegment("bank.transactions");
                    break;
                  case "clear-trajectory-btn":
                    handleClearCharacterDataSegment("trajectory");
                    break;
                  case "clear-app-usage-btn":
                    handleClearCharacterDataSegment("appUsage");
                    break;
                  case "clear-diary-entries-btn":
                    handleClearCharacterDataSegment("diary");
                    break;
                }
              }
            });

          // ä¸»å±å¹•é¢„è®¾åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("home-preset-selector")
            .addEventListener("change", handleHomePresetSelection);
          document
            .getElementById("apply-home-preset-btn")
            .addEventListener("click", applySelectedHomeScreenPreset);

          document
            .getElementById("save-home-preset-btn")
            .addEventListener("click", saveCurrentHomeScreenAsPreset);
          document
            .getElementById("update-home-preset-btn")
            .addEventListener("click", updateSelectedHomeScreenPreset); // <-- æ–°å¢è¿™ä¸€è¡Œ
          document
            .getElementById("rename-home-preset-btn")
            .addEventListener("click", renameSelectedHomeScreenPreset);
          document
            .getElementById("delete-home-preset-btn")
            .addEventListener("click", deleteSelectedHomeScreenPreset);
          document
            .getElementById("export-home-preset-btn")
            .addEventListener("click", exportHomeScreenPreset);
          document
            .getElementById("import-home-preset-btn")
            .addEventListener("click", () =>
              document.getElementById("import-home-preset-input").click(),
            );
          document
            .getElementById("import-home-preset-input")
            .addEventListener("change", (e) => {
              importHomeScreenPreset(e.target.files[0]);
              e.target.value = null;
            });

          document
            .getElementById("theme-toggle-switch")
            .addEventListener("change", toggleTheme);
          // èŠå¤©è®°å½•æœç´¢åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("search-chat-btn")
            .addEventListener("click", openChatSearchScreen);

          document
            .getElementById("search-back-btn")
            .addEventListener("click", () => {
              // è¿”å›æ—¶ï¼Œé‡æ–°æ‰“å¼€èŠå¤©è®¾ç½®å¼¹çª—
              showScreen("chat-interface-screen");
              document.getElementById("chat-settings-btn").click();
            });

          document
            .getElementById("perform-search-btn")
            .addEventListener("click", performChatSearch);

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰æœç´¢ç»“æœçš„ç‚¹å‡»
          document
            .getElementById("chat-search-results-list")
            .addEventListener("click", (e) => {
              const item = e.target.closest(".search-result-item");
              if (item && item.dataset.timestamp) {
                jumpToMessage(parseInt(item.dataset.timestamp));
              }
            });

          document
            .getElementById("create-weibo-post-btn")
            .addEventListener("click", openWeiboPublisherClean);

          document
            .getElementById("delete-expired-songs-btn")
            .addEventListener("click", deleteExpiredSearchedSongs);

          // è§’è‰²è¡¨æƒ…åŒ…ç®¡ç†åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("chat-settings-modal")
            .addEventListener("click", (e) => {
              if (e.target.id === "manage-char-stickers-btn") {
                document
                  .getElementById("chat-settings-modal")
                  .classList.remove("visible");
                openCharStickerManager();
              }
            });

          document
            .getElementById("back-from-sticker-manager")
            .addEventListener("click", () => {
              showScreen("chat-interface-screen");
              document.getElementById("chat-settings-btn").click();
            });

          const stickerTabExclusive = document.getElementById(
            "sticker-tab-exclusive",
          );
          const stickerTabCommon =
            document.getElementById("sticker-tab-common");
          const stickerContentExclusive = document.getElementById(
            "sticker-content-exclusive",
          );
          const stickerContentCommon = document.getElementById(
            "sticker-content-common",
          );

          stickerTabExclusive.addEventListener("click", () => {
            stickerTabExclusive.classList.add("active");
            stickerTabCommon.classList.remove("active");
            stickerContentExclusive.classList.add("active");
            stickerContentCommon.classList.remove("active");
            // åˆ‡æ¢æ—¶å¦‚æœå¤„äºé€‰æ‹©æ¨¡å¼ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“
            if (isCharStickerSelectionMode) renderCharStickers("exclusive");
          });

          stickerTabCommon.addEventListener("click", () => {
            stickerTabCommon.classList.add("active");
            stickerTabExclusive.classList.remove("active");
            stickerContentCommon.classList.add("active");
            stickerContentExclusive.classList.remove("active");
            // åˆ‡æ¢æ—¶å¦‚æœå¤„äºé€‰æ‹©æ¨¡å¼ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“
            if (isCharStickerSelectionMode) renderCharStickers("common");
          });

          // ç»‘å®šå„ç§æ·»åŠ /ä¸Šä¼ æŒ‰é’®
          document
            .getElementById("add-exclusive-sticker-btn")
            .addEventListener("click", () => bulkAddCharStickers("exclusive"));
          document
            .getElementById("upload-exclusive-sticker-btn")
            .addEventListener("click", () =>
              uploadCharStickersLocal("exclusive"),
            );
          document
            .getElementById("add-common-sticker-btn")
            .addEventListener("click", () => bulkAddCharStickers("common"));
          document
            .getElementById("upload-common-sticker-btn")
            .addEventListener("click", () => uploadCharStickersLocal("common"));

          // å¿ƒå£°å†å²è®°å½•åˆ é™¤åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("clear-all-history-btn")
            .addEventListener("click", clearAllInnerVoiceHistory);

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†å•æ¡åˆ é™¤
          document
            .getElementById("inner-voice-history-list")
            .addEventListener("click", (e) => {
              if (e.target.classList.contains("history-item-delete-btn")) {
                const timestamp = parseInt(e.target.dataset.timestamp);
                if (!isNaN(timestamp)) {
                  deleteSingleInnerVoice(timestamp);
                }
              }
            });

          document
            .getElementById("import-character-card-btn")
            .addEventListener("click", async () => {
              const unlockKey = "isCharacterImportUnlocked";

              // 1. æ£€æŸ¥æ˜¯å¦å·²ç»è§£é”
              if (localStorage.getItem(unlockKey) === "true") {
                document.getElementById("character-card-input").click();
                return;
              }

              // 2. å¦‚æœæœªè§£é”ï¼Œè·å–è®¾å¤‡ç 
              const deviceCode = getDeviceCode();

              // 3. æ„å»ºä¸€ä¸ªåŒ…å«è®¾å¤‡ç å’Œè¾“å…¥æ¡†çš„HTMLå†…å®¹
              const modalHtmlContent = `
			        <p style="margin-bottom: 15px;">è¯·å‰å¾€å–PINç½‘ç«™ï¼Œä½¿ç”¨ä¸‹é¢çš„è®¾å¤‡ç è·å–PINã€‚</p>
			        <div style="background: #eee; padding: 10px; border-radius: 6px; margin-bottom: 15px; user-select: all; cursor: copy;" title="ç‚¹å‡»å¤åˆ¶è®¾å¤‡ç ">
			            <strong>è®¾å¤‡ç :</strong> <span id="device-code-to-copy">${deviceCode}</span>
			        </div>
			        <p id="copy-device-code-feedback" style="height: 15px; font-size: 12px; color: green;"></p>
			    `;

              // 4. ä½¿ç”¨ showCustomPrompt å¼¹å‡ºå¢å¼ºç‰ˆæ¨¡æ€æ¡†
              const userPin = await window.showCustomPrompt(
                "åŠŸèƒ½è§£é”",
                "è¯·åœ¨æ­¤è¾“å…¥è·å–åˆ°çš„PINç ...", // è¿™æ˜¯è¾“å…¥æ¡†çš„placeholder
                "",
                "text",
                modalHtmlContent, // è¿™æ˜¯æˆ‘ä»¬é¢å¤–æ·»åŠ çš„HTMLå†…å®¹
              );

              // 5. å¦‚æœç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œåˆ™ç›´æ¥è¿”å›
              if (userPin === null) return;

              // 6. éªŒè¯PINç 
              const correctPin = generatePinFromDeviceCode(deviceCode);
              if (userPin.trim().toUpperCase() === correctPin) {
                localStorage.setItem(unlockKey, "true");
                await showCustomAlert(
                  "è§£é”æˆåŠŸï¼",
                  "å¯¼å…¥åŠŸèƒ½å·²è§£é”ï¼Œæ­¤è®¾å¤‡æ— éœ€å†æ¬¡è¾“å…¥PINç ã€‚",
                );
                document.getElementById("character-card-input").click();
              } else {
                await showCustomAlert(
                  "è§£é”å¤±è´¥",
                  "PINç é”™è¯¯ï¼Œè¯·é‡æ–°è·å–æˆ–è¾“å…¥ã€‚",
                );
              }
            });

          // ä¸ºè‡ªå®šä¹‰æ¨¡æ€æ¡†æ·»åŠ ç‚¹å‡»å¤åˆ¶è®¾å¤‡ç çš„åŠŸèƒ½
          document
            .getElementById("custom-modal-body")
            .addEventListener("click", (e) => {
              const codeElement = e.target.closest("#device-code-to-copy");
              if (codeElement) {
                const deviceCode = codeElement.textContent;
                const feedbackEl = document.getElementById(
                  "copy-device-code-feedback",
                );
                navigator.clipboard
                  .writeText(deviceCode)
                  .then(() => {
                    if (feedbackEl) feedbackEl.textContent = "è®¾å¤‡ç å·²å¤åˆ¶ï¼";
                    setTimeout(() => {
                      if (feedbackEl) feedbackEl.textContent = "";
                    }, 2000);
                  })
                  .catch((err) => {
                    if (feedbackEl)
                      feedbackEl.textContent = "å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚";
                  });
              }
            });

          document
            .getElementById("character-card-input")
            .addEventListener("change", (event) => {
              const file = event.target.files[0];
              if (file) {
                // å½“ç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶åï¼Œè°ƒç”¨æˆ‘ä»¬çš„æ€»å¤„ç†å‡½æ•°
                handleCharacterImport(file);
              }
              // æ¸…ç©ºé€‰æ‹©ï¼Œè¿™æ ·ç”¨æˆ·ä¸‹æ¬¡è¿˜èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
              event.target.value = null;
            });

          document
            .getElementById("phone-screen")
            .addEventListener("click", unlockAudioContext, { once: true });

          document
            .getElementById("custom-modal-cancel")
            .addEventListener("click", hideCustomModal);
          document
            .getElementById("custom-modal-overlay")
            .addEventListener("click", (e) => {
              if (e.target === modalOverlay) hideCustomModal();
            });
          document
            .getElementById("clear-orphaned-data-btn")
            .addEventListener("click", clearOrphanedData);
          const repairBtn = document.getElementById("repair-data-btn");
          if (repairBtn) {
            repairBtn.addEventListener("click", repairAllData);
          }

          const factoryResetBtn = document.getElementById("factory-reset-btn");
          if (factoryResetBtn) {
            factoryResetBtn.addEventListener("click", handleFactoryReset);
          }
          document
            .getElementById("export-data-btn")
            .addEventListener("click", exportBackup);
          document
            .getElementById("import-btn")
            .addEventListener("click", () =>
              document.getElementById("import-data-input").click(),
            );
          document
            .getElementById("import-data-input")
            .addEventListener("change", (e) => importBackup(e.target.files[0]));
          document
            .getElementById("back-to-list-btn")
            .addEventListener("click", () => {
              stopPetDecayTimer();

              applyScopedCss("", "#chat-messages", "custom-bubble-style"); // æ¸…é™¤çœŸå®èŠå¤©ç•Œé¢çš„è‡ªå®šä¹‰æ ·å¼
              applyScopedCss(
                "",
                "#settings-preview-area",
                "preview-bubble-style",
              ); // æ¸…é™¤é¢„è§ˆåŒºçš„è‡ªå®šä¹‰æ ·å¼

              exitSelectionMode();
              state.activeChatId = null;
              // ã€å¿ƒå£°åŠŸèƒ½ã€‘è¿”å›åˆ—è¡¨æ—¶ï¼Œéšè—å¿ƒå½¢æŒ‰é’®
              document.getElementById("char-heart-btn").style.display = "none";
              showScreen("chat-list-screen");
            });

          // ä¸ºæ­Œæ›²å°é¢/æ­Œè¯åŒºåŸŸç»‘å®šç‚¹å‡»åˆ‡æ¢äº‹ä»¶
          document
            .getElementById("music-display-area")
            .addEventListener("click", () => {
              const displayArea = document.getElementById("music-display-area");
              // ç›´æ¥åˆ‡æ¢ .show-lyrics è¿™ä¸ªç±»ï¼ŒCSSä¼šè‡ªåŠ¨å¤„ç†æ˜¾ç¤º/éšè—
              displayArea.classList.toggle("show-lyrics");
            });

          document
            .getElementById("add-chat-btn")
            .addEventListener("click", async () => {
              const name = await showCustomPrompt(
                "åˆ›å»ºæ–°èŠå¤©",
                "è¯·è¾“å…¥Taçš„åå­—",
              );
              if (name && name.trim()) {
                const newChatId = "chat_" + Date.now();

                const newChat = {
                  id: newChatId,
                  name: name.trim(),
                  isGroup: false,
                  isPinned: false,
                  npcLibrary: [], // è§’è‰²ä¸“å±NPCåº“
                  relationship: {
                    status: "friend",
                    blockedTimestamp: null,
                    applicationReason: "",
                  },
                  status: {
                    text: "åœ¨çº¿",
                    lastUpdate: Date.now(),
                    isBusy: false,
                  },
                  settings: {
                    aiPersona: "ä½ æ˜¯è°å‘€ã€‚",
                    myPersona: "æˆ‘æ˜¯è°å‘€ã€‚",
                    maxMemory: 10,
                    aiAvatar: defaultAvatar,
                    myAvatar: defaultAvatar,
                    background: "",
                    theme: "default",
                    fontSize: 13,
                    customCss: "",
                    linkedWorldBookIds: [],
                    aiAvatarLibrary: [],
                    stickerLibrary: [], // ä¸“å±è¡¨æƒ…åº“
                    // === ä»¥ä¸‹æ˜¯æœ¬æ¬¡ä¿®å¤æ–°å¢çš„åˆå§‹åŒ–å±æ€§ ===
                    linkedMemories: [], // ã€ä¿®å¤æ ¸å¿ƒã€‘åˆå§‹åŒ–è®°å¿†äº’é€šæ•°ç»„
                    offlineMode: {
                      enabled: false,
                      prompt: "",
                      style: "",
                      wordCount: 300,
                      presets: [],
                    }, // åˆå§‹åŒ–çº¿ä¸‹æ¨¡å¼
                    timePerceptionEnabled: true, // åˆå§‹åŒ–æ—¶é—´æ„ŸçŸ¥
                    customTime: "", // åˆå§‹åŒ–è‡ªå®šä¹‰æ—¶é—´
                    isCoupleAvatar: false, // åˆå§‹åŒ–æƒ…ä¾£å¤´åƒå¼€å…³
                    coupleAvatarDescription: "", // åˆå§‹åŒ–æƒ…ä¾£å¤´åƒæè¿°
                    weiboProfession: "", // åˆå§‹åŒ–å¾®åšèŒä¸š
                    weiboInstruction: "", // åˆå§‹åŒ–å¾®åšæŒ‡ä»¤
                  },
                  history: [],
                  musicData: { totalTime: 0 },
                  // æ‰‹æœºæ•°æ®ä¹Ÿä¿æŒå®Œæ•´
                  characterPhoneData: {
                    lastGenerated: null,
                    chats: {},
                    shoppingCart: [],
                    memos: [],
                    browserHistory: [],
                    photoAlbum: [],
                    bank: { balance: 0, transactions: [] },
                    trajectory: [],
                    appUsage: [],
                    diary: [],
                  },
                  houseData: null,
                };

                state.chats[newChatId] = newChat;
                await db.chats.put(newChat);
                renderChatList();
              }
            });

          // åˆ›å»ºç¾¤èŠæŒ‰é’®ç°åœ¨æ‰“å¼€è”ç³»äººé€‰æ‹©å™¨
          document
            .getElementById("add-group-chat-btn")
            .addEventListener("click", openContactPickerForGroupCreate);

          document
            .getElementById("transfer-cancel-btn")
            .addEventListener("click", () =>
              document
                .getElementById("transfer-modal")
                .classList.remove("visible"),
            );
          document
            .getElementById("transfer-confirm-btn")
            .addEventListener("click", sendUserTransfer);
          document
            .getElementById("listen-together-btn")
            .addEventListener("click", handleListenTogetherClick);
          document
            .getElementById("music-exit-btn")
            .addEventListener("click", () => endListenTogetherSession(true));
          document
            .getElementById("music-return-btn")
            .addEventListener("click", returnToChat);
          document
            .getElementById("music-play-pause-btn")
            .addEventListener("click", togglePlayPause);
          document
            .getElementById("music-next-btn")
            .addEventListener("click", playNext);
          document
            .getElementById("music-prev-btn")
            .addEventListener("click", playPrev);
          document
            .getElementById("music-mode-btn")
            .addEventListener("click", changePlayMode);
          document
            .getElementById("music-playlist-btn")
            .addEventListener("click", () => {
              updatePlaylistUI();
              document
                .getElementById("music-playlist-panel")
                .classList.add("visible");
            });
          document
            .getElementById("close-playlist-btn")
            .addEventListener("click", () =>
              document
                .getElementById("music-playlist-panel")
                .classList.remove("visible"),
            );
          document
            .getElementById("add-song-url-btn")
            .addEventListener("click", addSongFromURL);
          document
            .getElementById("add-song-local-btn")
            .addEventListener("click", () =>
              document.getElementById("local-song-upload-input").click(),
            );
          document
            .getElementById("local-song-upload-input")
            .addEventListener("change", addSongFromLocal);
          // BGMæœç´¢åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("add-song-search-btn")
            .addEventListener("click", addSongFromSearch);

          document
            .getElementById("cancel-music-search-btn")
            .addEventListener("click", () => {
              document
                .getElementById("music-search-results-modal")
                .classList.remove("visible");
            });

          document
            .getElementById("search-results-list")
            .addEventListener("click", (e) => {
              const item = e.target.closest(".search-result-item");
              if (item && item.dataset.songJson) {
                const songData = JSON.parse(item.dataset.songJson);
                handleSearchResultClick(songData);
              }
            });

          // æ’­æ”¾ç»“æŸç›‘å¬å™¨ï¼ˆä¿æ´»éŸ³é¢‘å¼ºåˆ¶æ­»å¾ªç¯ï¼‰
          audioPlayer.addEventListener("ended", () => {
            const currentTrack =
              state.musicState.playlist[state.musicState.currentIndex];

            // å¦‚æœæ˜¯ä¿æ´»éŸ³é¢‘ï¼Œå¼ºåˆ¶é‡æ’­ï¼Œæ— è§†ä»»ä½•æ¨¡å¼
            if (currentTrack && currentTrack.isKeepAlive) {
              console.log("ä¿æ´»éŸ³é¢‘å¾ªç¯ä¸­...");
              audioPlayer.currentTime = 0;
              audioPlayer.play().catch((e) => console.error("é‡æ’­å¤±è´¥:", e));
            } else {
              // æ­£å¸¸æ­Œæ›²èµ°æ­£å¸¸é€»è¾‘
              playNext();
            }
          });

          // 20åˆ†é’Ÿå¼ºåˆ¶å¾ªç¯ç›‘å¬å™¨
          audioPlayer.addEventListener("timeupdate", () => {
            const currentTrack =
              state.musicState.playlist[state.musicState.currentIndex];

            // æ£€æŸ¥ï¼š1.æ˜¯å¦å­˜åœ¨å½“å‰æ­Œæ›² 2.æ˜¯å¦æ˜¯ä¿æ´»éŸ³é¢‘ 3.æ˜¯å¦è¶…è¿‡20åˆ†é’Ÿ(1200ç§’)
            if (
              currentTrack &&
              currentTrack.isKeepAlive &&
              audioPlayer.currentTime > 600
            ) {
              console.log("ä¿æ´»éŸ³é¢‘å·²æ’­æ”¾20åˆ†é’Ÿï¼Œæ‰§è¡Œå¾ªç¯...");
              // å¼ºåˆ¶æ‹‰å› 0 ç§’
              audioPlayer.currentTime = 0;
              // ç¡®ä¿ç»§ç»­æ’­æ”¾
              if (audioPlayer.paused) {
                audioPlayer
                  .play()
                  .catch((e) => console.error("å¾ªç¯é‡æ’­å¤±è´¥:", e));
              }
            }
          });

          const chatInput = document.getElementById("chat-input");

          document
            .getElementById("send-btn")
            .addEventListener("click", async () => {
              const content = chatInput.value.trim();
              if (!content || !state.activeChatId) return;

              const chat = state.chats[state.activeChatId];

              // æ—ç™½æ‹¦æˆªé€»è¾‘
              // æ£€æŸ¥æ˜¯å¦ä»¥ <æ—ç™½> å¼€å¤´
              if (content.startsWith("<æ—ç™½>")) {
                // æå–æ—ç™½å†…å®¹
                const narrativeContent = content.replace(/^<æ—ç™½>/, "").trim();

                if (narrativeContent) {
                  const msg = {
                    role: "system", // è®¾ç½®ä¸º system è§’è‰²ï¼Œä¸å±äºç”¨æˆ·
                    type: "narrative", // è®¾ç½®ä¸“é—¨çš„ç±»å‹
                    content: narrativeContent,
                    timestamp: Date.now(),
                  };

                  chat.history.push(msg);
                  await db.chats.put(chat);
                  appendMessage(msg, chat);

                  // æ¸…ç©ºè¾“å…¥æ¡†
                  chatInput.value = "";
                  chatInput.style.height = "auto";
                  chatInput.focus();

                  return; // æ‹¦æˆªæˆåŠŸï¼Œä¸å†æ‰§è¡Œåç»­çš„æ™®é€šå‘é€é€»è¾‘
                }
              }

              try {
                const command = JSON.parse(content);
                // æ£€æŸ¥ï¼šè¿™æ˜¯å¦æ˜¯ä¸€ä¸ªè®©è§’è‰²å‘å¾®åšçš„æŒ‡ä»¤ï¼Ÿ
                if (command && command.type === "weibo_post") {
                  const chat = state.chats[state.activeChatId];
                  if (chat.isGroup) {
                    alert("ä¸èƒ½åœ¨ç¾¤èŠä¸­ä¸ºå•ä¸ªè§’è‰²å‘å¸ƒå¾®åšã€‚");
                    return;
                  }

                  // åˆ›å»ºä¸€ä¸ªæ–°çš„å¾®åšå¸–å­å¯¹è±¡
                  const newPost = {
                    authorId: chat.id, // å…³é”®ï¼ä½œè€…IDæ˜¯å½“å‰è§’è‰²çš„IDï¼Œè€Œä¸æ˜¯'user'
                    authorType: "char",
                    authorNickname: chat.name,
                    authorAvatar: chat.settings.aiAvatar || defaultAvatar,
                    content: command.content || "",
                    timestamp: Date.now(),
                    likes: [],
                    comments: [],
                    baseLikesCount: command.baseLikesCount || 0,
                    baseCommentsCount: command.baseCommentsCount || 0,
                  };

                  // å¦‚æœJSONé‡Œæœ‰è·¯äººè¯„è®ºï¼Œå°±è§£æå¹¶æ·»åŠ 
                  if (
                    command.comments &&
                    typeof command.comments === "string"
                  ) {
                    newPost.comments = command.comments
                      .split("\n")
                      .map((c) => {
                        const parts = c.split(/[:ï¼š]/);
                        const commenter = parts.shift() || "è·¯äºº";
                        const commentText = parts.join(":").trim();
                        return {
                          commentId: "comment_" + Date.now() + Math.random(),
                          authorNickname: commenter,
                          commentText: commentText,
                        };
                      })
                      .filter((c) => c.commentText);
                  }

                  await db.weiboPosts.add(newPost);

                  // åˆ·æ–°â€œå…³æ³¨çš„äººâ€åˆ—è¡¨ï¼Œæ–°å¾®åšå°±ä¼šå‡ºç°äº†ï¼
                  await renderFollowingWeiboFeed();

                  await showCustomAlert(
                    "æ“ä½œæˆåŠŸ",
                    `å·²ä¸º â€œ${chat.name}â€ å‘å¸ƒäº†ä¸€æ¡æ–°å¾®åšï¼`,
                  );

                  chatInput.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
                  return; // ç»“æŸå‡½æ•°ï¼Œä¸å†æ‰§è¡Œåé¢çš„ä»£ç 
                }
              } catch (e) {
                // å¦‚æœè§£æJSONå¤±è´¥ï¼Œè¯´æ˜å®ƒä¸æ˜¯æŒ‡ä»¤ï¼Œåªæ˜¯æ™®é€šæ–‡æœ¬ï¼Œå°±è®©ä»£ç ç»§ç»­å¾€ä¸‹èµ°
              }

              // 1. å¦‚æœæ˜¯ç¾¤èŠï¼Œå¹¶ä¸”ä½ è¢«ç¦è¨€äº†
              if (chat && chat.isGroup && chat.settings.isUserMuted) {
                alert("ä½ å·²è¢«ç¦è¨€ï¼Œæ— æ³•å‘è¨€ï¼");
                return; // é˜»æ­¢å‘é€
              }

              const msg = {
                role: "user",
                content,
                timestamp: Date.now(),
              };

              // æ£€æŸ¥å½“å‰æ˜¯å¦å¤„äºå¼•ç”¨å›å¤æ¨¡å¼
              if (currentReplyContext) {
                msg.quote = currentReplyContext; // å°†å¼•ç”¨ä¿¡æ¯é™„åŠ åˆ°æ¶ˆæ¯å¯¹è±¡ä¸Š
              }

              chat.history.push(msg);
              await incrementMessageCount(state.activeChatId);
              await db.chats.put(chat);
              appendMessage(msg, chat);
              renderChatList();
              chatInput.value = "";
              chatInput.style.height = "auto";
              chatInput.focus();

              cancelReplyMode();
            });
          document
            .getElementById("wait-reply-btn")
            .addEventListener("click", triggerAiResponse);
          chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              document.getElementById("send-btn").click();
            }
          });
          chatInput.addEventListener("input", () => {
            chatInput.style.height = "auto";
            chatInput.style.height = chatInput.scrollHeight + "px";
          });

          document
            .getElementById("wallpaper-upload-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (file) {
                const dataUrl = await new Promise((res, rej) => {
                  const reader = new FileReader();
                  reader.onload = () => res(reader.result);
                  reader.onerror = () => rej(reader.error);
                  reader.readAsDataURL(file);
                });
                newWallpaperBase64 = dataUrl;
                renderWallpaperScreen();
              }
            });

          document
            .getElementById("save-wallpaper-btn")
            .addEventListener("click", async () => {
              let changesMade = false;

              // ä¿å­˜å£çº¸
              if (newWallpaperBase64) {
                state.globalSettings.wallpaper = newWallpaperBase64;
                changesMade = true;
              }

              // ä¿å­˜é”å±å£çº¸
              if (newLockscreenWallpaperBase64) {
                state.globalSettings.lockscreenWallpaper =
                  newLockscreenWallpaperBase64;
                changesMade = true;
              }

              // ä¿å­˜å…¨å±€èŠå¤©èƒŒæ™¯
              if (newGlobalBgBase64 === "REMOVED") {
                state.globalSettings.globalChatBackground = "";
                changesMade = true;
              } else if (newGlobalBgBase64) {
                state.globalSettings.globalChatBackground = newGlobalBgBase64;
                changesMade = true;
              }

              // æˆ‘ä»¬å°†CSSä»£ç ä¿å­˜åˆ°ä¸€ä¸ªæ–°å±æ€§ activeCustomCss ä¸­
              state.globalSettings.activeCustomCss =
                document.getElementById("theme-css-editor").value;
              // åŒæ—¶ï¼Œä¿å­˜å½“å‰é€‰æ‹©çš„ã€ä¸»é¢˜IDã€‘ï¼Œå¦‚æœç”¨æˆ·æ²¡é€‰ï¼Œå°±ä¿å­˜null
              const activeThemeSelector =
                document.getElementById("theme-selector");
              state.globalSettings.activeThemeId = activeThemeSelector.value
                ? parseInt(activeThemeSelector.value)
                : null;
              changesMade = true; // åªè¦ç‚¹å‡»ä¿å­˜ï¼Œå°±è®¤ä¸ºCSSæœ‰å˜åŠ¨

              // ä¿å­˜å¯†ç 
              const newPassword =
                document.getElementById("password-set-input").value;
              state.globalSettings.password = newPassword;

              // ä¿å­˜é“ƒå£°å’Œæç¤ºéŸ³
              state.globalSettings.ringtoneUrl = document
                .getElementById("ringtone-url-input")
                .value.trim();
              state.globalSettings.notificationSoundUrl = document
                .getElementById("notification-sound-url-input")
                .value.trim();

              // ä¿å­˜é”å±å’ŒçŠ¶æ€æ å¼€å…³çŠ¶æ€
              const isLockEnabled = document.getElementById(
                "enable-lock-screen-toggle",
              ).checked;
              state.globalSettings.enableLockScreen = isLockEnabled;
              localStorage.setItem("lockScreenEnabled", isLockEnabled);

              // ä¿å­˜ä¸»å±å¹•å­—ä½“é¢œè‰² (ç°åœ¨æˆ‘ä»¬å¯ä»¥ä»ä»»æ„ä¸€ä¸ªè¾“å…¥æ¡†å–å€¼ï¼Œå› ä¸ºå®ƒä»¬æ˜¯åŒæ­¥çš„)
              // è¿™é‡Œä¼˜å…ˆå–æ–‡æœ¬æ¡†çš„å€¼ï¼Œå› ä¸ºå®ƒæ›´ç›´è§‚
              const colorInputVal = document.getElementById(
                "home-icon-widget-text-color-input",
              ).value;
              // åšä¸ªæœ€åæ ¡éªŒï¼Œå¦‚æœæ–‡æœ¬æ¡†é‡Œçš„ä¸å¯¹ï¼Œå°±ç”¨é€‰è‰²ç›˜çš„
              const hexRegex = /^#([0-9A-F]{3}){1,2}$/i;
              if (hexRegex.test(colorInputVal)) {
                state.globalSettings.homeIconWidgetTextColor = colorInputVal;
              } else {
                state.globalSettings.homeIconWidgetTextColor =
                  document.getElementById(
                    "home-icon-widget-text-color-picker",
                  ).value;
              }
              state.globalSettings.removeHomeFontShadow =
                document.getElementById(
                  "remove-home-font-shadow-toggle",
                ).checked;

              // ä¿å­˜Appåç§°
              saveAppLabels();

              // å°†æ‰€æœ‰è®¾ç½®ä¸€æ¬¡æ€§å†™å…¥æ•°æ®åº“
              await db.globalSettings.put(state.globalSettings);

              // åº”ç”¨æ‰€æœ‰æ›´æ”¹
              if (changesMade) {
                applyGlobalWallpaper();
                applyLockscreenWallpaper();
                applyThemeCss(state.globalSettings.activeCustomCss); // åº”ç”¨åˆšåˆšä¿å­˜çš„CSS
                newWallpaperBase64 = null;
                newLockscreenWallpaperBase64 = null;
                newGlobalBgBase64 = null;
              }
              applyAppIcons();
              applyAppLabels();

              alert("æ‰€æœ‰å¤–è§‚è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼");
              showScreen("home-screen");
            });

          document
            .getElementById("save-api-settings-btn")
            .addEventListener("click", async () => {
              const proxyUrl = document
                .getElementById("proxy-url")
                .value.trim();
              const apiKey = document.getElementById("api-key").value.trim();
              const isBlocked = BLOCKED_API_SITES.some((blockedDomain) =>
                proxyUrl.includes(blockedDomain),
              );

              if (isBlocked) {
                alert("é”™è¯¯ï¼šè¯¥ API ç«™ç‚¹å·²è¢«ç¦ç”¨ï¼Œæ— æ³•ä½¿ç”¨ã€‚");
                return; // é˜»æ­¢ä¿å­˜
              }

              state.apiConfig.proxyUrl = document
                .getElementById("proxy-url")
                .value.trim();
              state.apiConfig.apiKey = document
                .getElementById("api-key")
                .value.trim();
              state.apiConfig.model =
                document.getElementById("model-select").value;
              state.apiConfig.temperature = parseFloat(
                document.getElementById("temperature-slider").value,
              );
              // ä¿å­˜ Minimax è®¾ç½®
              state.apiConfig.minimaxGroupId = document
                .getElementById("minimax-group-id")
                .value.trim();
              state.apiConfig.minimaxApiKey = document
                .getElementById("minimax-api-key")
                .value.trim();
              state.apiConfig.minimaxProvider = document.getElementById(
                "minimax-provider-select",
              ).value;
              state.apiConfig.minimaxSpeechModel = document.getElementById(
                "minimax-speech-model-select",
              ).value;
              // --- ä¿å­˜ GitHub å¤‡ä»½è®¾ç½® ---
              state.apiConfig.githubToken = document
                .getElementById("github-token")
                .value.trim();
              state.apiConfig.githubUsername = document
                .getElementById("github-username")
                .value.trim();
              state.apiConfig.githubRepo = document
                .getElementById("github-repo")
                .value.trim();
              state.apiConfig.githubPath =
                document.getElementById("github-path").value.trim() ||
                "ephone_backup.json";
              state.apiConfig.githubAutoBackup = document.getElementById(
                "github-auto-backup-switch",
              ).checked;
              // â˜…â˜…â˜… æ–°å¢ï¼šä¿å­˜æ¨¡å¼å’Œæ—¶é—´ â˜…â˜…â˜…
              state.apiConfig.githubBackupMode =
                document.getElementById("github-backup-mode").value;
              state.apiConfig.githubBackupInterval =
                parseInt(
                  document.getElementById("github-backup-interval").value,
                ) || 30;
              state.apiConfig.pollinationsApiKey = document
                .getElementById("pollinations-api-key")
                .value.trim();

              // å¦‚æœå¼€å¯äº†è‡ªåŠ¨å¤‡ä»½ï¼Œç«‹å³é‡å¯å®šæ—¶å™¨
              handleAutoBackupTimer();
              await db.apiConfig.put(state.apiConfig);
              state.globalSettings.enableSystemNotifications =
                document.getElementById("system-notification-switch").checked;
              console.log(
                "ä¿å­˜ç³»ç»Ÿé€šçŸ¥å¼€å…³çŠ¶æ€:",
                state.globalSettings.enableSystemNotifications,
              );
              state.globalSettings.imageCompressionQuality = parseFloat(
                document.getElementById("image-quality-slider").value,
              );
              state.globalSettings.enableSystemNotifications =
                document.getElementById("system-notification-switch").checked;
              const backgroundSwitch = document.getElementById(
                "background-activity-switch",
              );
              const intervalInput = document.getElementById(
                "background-interval-input",
              );
              const newEnableState = backgroundSwitch.checked;
              const oldEnableState =
                state.globalSettings.enableBackgroundActivity || false;

              // åªæœ‰åœ¨ç”¨æˆ·â€œä»å…³åˆ°å¼€â€æ—¶ï¼Œæ‰å¼¹å‡ºè­¦å‘Š
              if (newEnableState && !oldEnableState) {
                const userConfirmed = confirm(
                  "ã€é«˜è´¹ç”¨è­¦å‘Šã€‘\n\n" +
                    "æ‚¨æ­£åœ¨å¯ç”¨â€œåå°è§’è‰²æ´»åŠ¨â€åŠŸèƒ½ã€‚\n\n" +
                    "è¿™ä¼šä½¿æ‚¨çš„AIè§’è‰²ä»¬åœ¨æ‚¨ä¸å’Œä»–ä»¬èŠå¤©æ—¶ï¼Œä¹Ÿèƒ½â€œç‹¬ç«‹æ€è€ƒâ€å¹¶ä¸»åŠ¨ç»™æ‚¨å‘æ¶ˆæ¯æˆ–è¿›è¡Œç¤¾äº¤äº’åŠ¨ï¼Œæå¤§åœ°å¢å¼ºæ²‰æµ¸æ„Ÿã€‚\n\n" +
                    "ä½†è¯·æ³¨æ„ï¼š\n" +
                    "è¿™ä¼šã€åœ¨åå°è‡ªåŠ¨ã€å®šæœŸåœ°è°ƒç”¨APIã€‘ï¼Œå³ä½¿æ‚¨ä¸è¿›è¡Œä»»ä½•æ“ä½œã€‚æ ¹æ®æ‚¨çš„è§’è‰²æ•°é‡å’Œæ£€æµ‹é—´éš”ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ‚¨çš„APIè´¹ç”¨æ˜¾è‘—å¢åŠ ã€‚\n\n" +
                    "æ‚¨ç¡®å®šè¦å¼€å¯å—ï¼Ÿ",
                );

                if (!userConfirmed) {
                  backgroundSwitch.checked = false; // ç”¨æˆ·å–æ¶ˆï¼ŒæŠŠå¼€å…³æ‹¨å›å»
                  return; // é˜»æ­¢åç»­é€»è¾‘
                }
              }

              state.globalSettings.enableBackgroundActivity = newEnableState;
              state.globalSettings.backgroundActivityInterval =
                parseInt(intervalInput.value) || 60;
              state.globalSettings.blockCooldownHours =
                parseFloat(
                  document.getElementById("block-cooldown-input").value,
                ) || 1;
              await db.globalSettings.put(state.globalSettings);

              // åŠ¨æ€å¯åŠ¨æˆ–åœæ­¢æ¨¡æ‹Ÿå™¨
              stopBackgroundSimulation();
              if (state.globalSettings.enableBackgroundActivity) {
                startBackgroundSimulation();
                console.log(
                  `åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²å¯åŠ¨ï¼Œé—´éš”: ${state.globalSettings.backgroundActivityInterval}ç§’`,
                );
              } else {
                console.log("åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²åœæ­¢ã€‚");
              }
              const novelaiSwitch = document.getElementById("novelai-switch");
              const novelaiModelInput =
                document.getElementById("novelai-model");
              const novelaiKeyInput =
                document.getElementById("novelai-api-key");

              if (novelaiSwitch) {
                localStorage.setItem("novelai-enabled", novelaiSwitch.checked);
              }
              if (novelaiModelInput) {
                localStorage.setItem("novelai-model", novelaiModelInput.value);
              }
              if (novelaiKeyInput) {
                localStorage.setItem(
                  "novelai-api-key",
                  novelaiKeyInput.value.trim(),
                );
              }
              alert("APIè®¾ç½®å·²ä¿å­˜!");
            });

          // gemini å¯†é’¥èšç„¦çš„æ—¶å€™æ˜¾ç¤ºæ˜æ–‡
          const ApiKeyInput = document.getElementById("api-key");
          ApiKeyInput.addEventListener("focus", (e) => {
            e.target.setAttribute("type", "text");
          });
          ApiKeyInput.addEventListener("blur", (e) => {
            e.target.setAttribute("type", "password");
          });

          document
            .getElementById("fetch-models-btn")
            .addEventListener("click", async () => {
              const url = document.getElementById("proxy-url").value.trim();
              const key = document.getElementById("api-key").value.trim();
              if (!url || !key) return alert("è¯·å…ˆå¡«å†™åä»£åœ°å€å’Œå¯†é’¥");
              try {
                let isGemini = url === GEMINI_API_URL;
                const response = await fetch(
                  isGemini
                    ? `${GEMINI_API_URL}?key=${getRandomValue(key)}`
                    : `${url}/v1/models`,
                  isGemini
                    ? undefined
                    : { headers: { Authorization: `Bearer ${key}` } },
                );
                if (!response.ok) throw new Error("æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨");
                const data = await response.json();
                let models = isGemini ? data.models : data.data;
                if (isGemini) {
                  models = models.map((model) => {
                    const parts = model.name.split("/");
                    return {
                      id: parts.length > 1 ? parts[1] : model.name,
                    };
                  });
                }
                // è·å–æˆ‘ä»¬çš„è¾…åŠ©ä¸‹æ‹‰æ¡†
                const picker = document.getElementById("fetched-model-list");
                picker.innerHTML =
                  '<option value="">â–¼ è¯·é€‰æ‹©æ¨¡å‹ (ç‚¹å‡»è‡ªåŠ¨å¡«å…¥ä¸Šæ–¹)</option>';

                // å¡«å……ä¸‹æ‹‰æ¡†
                models.forEach((model) => {
                  const option = document.createElement("option");
                  option.value = model.id;
                  option.textContent = model.id;
                  picker.appendChild(option);
                });

                // æ˜¾ç¤ºä¸‹æ‹‰æ¡†
                picker.style.display = "block";

                alert(
                  `æˆåŠŸæ‹‰å– ${models.length} ä¸ªæ¨¡å‹ï¼\nè¯·ç‚¹å‡»ä¸‹æ–¹çš„ä¸‹æ‹‰æ¡†é€‰æ‹©ï¼Œé€‰æ‹©åä¼šè‡ªåŠ¨å¡«å…¥è¾“å…¥æ¡†ã€‚`,
                );
              } catch (error) {
                alert(`æ‹‰å–æ¨¡å‹å¤±è´¥: ${error.message}`);
              }
            });
          document
            .getElementById("fetch-minimax-speech-models-btn")
            .addEventListener("click", fetchMinimaxSpeechModels);

          // NovelAIç³»ç»Ÿçš„JavaScriptäº‹ä»¶ç›‘å¬å™¨
          document
            .getElementById("novelai-switch")
            .addEventListener("change", (e) => {
              const detailsDiv = document.getElementById("novelai-details");
              detailsDiv.style.display = e.target.checked ? "block" : "none";
            });

          // NovelAI API Keyæ˜¾ç¤º/éšè—åˆ‡æ¢
          document
            .getElementById("novelai-key-toggle")
            .addEventListener("click", function () {
              const input = document.getElementById("novelai-api-key");
              if (input.type === "password") {
                input.type = "text";
                this.textContent = "ğŸ˜Œ";
              } else {
                input.type = "password";
                this.textContent = "ğŸ§";
              }
            });

          // æ‰“å¼€NovelAIè®¾ç½®å¼¹çª—
          document
            .getElementById("novelai-settings-btn")
            .addEventListener("click", () => {
              loadNovelAISettings();
              document.getElementById("novelai-settings-modal").style.display =
                "flex";
            });

          // CORSä»£ç†é€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
          document
            .getElementById("nai-cors-proxy")
            .addEventListener("change", (e) => {
              const customProxyGroup = document.getElementById(
                "nai-custom-proxy-group",
              );
              if (e.target.value === "custom") {
                customProxyGroup.style.display = "block";
              } else {
                customProxyGroup.style.display = "none";
              }
            });

          // å…³é—­NovelAIè®¾ç½®å¼¹çª—
          document
            .getElementById("close-novelai-settings")
            .addEventListener("click", () => {
              document.getElementById("novelai-settings-modal").style.display =
                "none";
            });

          // ä¿å­˜NovelAIè®¾ç½®
          document
            .getElementById("save-nai-settings-btn")
            .addEventListener("click", () => {
              saveNovelAISettings();
              document.getElementById("novelai-settings-modal").style.display =
                "none";
              alert("NovelAIè®¾ç½®å·²ä¿å­˜ï¼");
            });

          // æ¢å¤é»˜è®¤è®¾ç½®
          document
            .getElementById("reset-nai-settings-btn")
            .addEventListener("click", () => {
              if (confirm("ç¡®å®šè¦æ¢å¤é»˜è®¤è®¾ç½®å—ï¼Ÿ")) {
                resetNovelAISettings();
              }
            });

          // æ‰“å¼€NovelAIæµ‹è¯•å¼¹çª—
          document
            .getElementById("novelai-test-btn")
            .addEventListener("click", () => {
              const apiKey = document
                .getElementById("novelai-api-key")
                .value.trim();
              if (!apiKey) {
                alert("è¯·å…ˆå¡«å†™NovelAI API Keyï¼");
                return;
              }
              document.getElementById("novelai-test-modal").style.display =
                "flex";
              document.getElementById("nai-test-result").style.display = "none";
              document.getElementById("nai-test-error").style.display = "none";
            });

          // å…³é—­NovelAIæµ‹è¯•å¼¹çª—
          document
            .getElementById("close-novelai-test")
            .addEventListener("click", () => {
              document.getElementById("novelai-test-modal").style.display =
                "none";
            });

          document
            .getElementById("close-nai-test-btn")
            .addEventListener("click", () => {
              document.getElementById("novelai-test-modal").style.display =
                "none";
            });

          // NovelAIç”Ÿæˆå›¾åƒæŒ‰é’®
          document
            .getElementById("nai-generate-btn")
            .addEventListener("click", async () => {
              await generateNovelAIImage();
            });

          // NovelAIä¸‹è½½å›¾åƒæŒ‰é’®
          document
            .getElementById("nai-download-btn")
            .addEventListener("click", () => {
              const img = document.getElementById("nai-result-image");
              const link = document.createElement("a");
              link.href = img.src;
              link.download = "novelai-generated-" + Date.now() + ".png";
              link.click();
            });

          // è§’è‰²ä¸“å±NAIæç¤ºè¯å¼¹çª—äº‹ä»¶ç›‘å¬å™¨

          // æ‰“å¼€è§’è‰²ä¸“å±NAIæç¤ºè¯é…ç½®å¼¹çª—
          document
            .getElementById("character-nai-prompts-btn")
            .addEventListener("click", () => {
              if (!state.activeChatId) return;
              const chat = state.chats[state.activeChatId];

              // åŠ è½½å½“å‰è§’è‰²çš„NAIæç¤ºè¯é…ç½®
              const naiSettings = chat.settings.naiSettings || {
                promptSource: "system",
                characterPositivePrompt: "",
                characterNegativePrompt: "",
              };

              // ä¸¥æ ¼åŠ è½½è§’è‰²é…ç½®ï¼Œä¸ä¸ç³»ç»Ÿé…ç½®æ··æ·†
              // å¡«äº†å°±æœ‰ï¼Œæ²¡å¡«å°±ä¸ºç©ºï¼Œç»ä¸ä½¿ç”¨ç³»ç»Ÿé…ç½®å¡«å……
              document.getElementById("character-nai-positive").value =
                naiSettings.characterPositivePrompt || "";
              document.getElementById("character-nai-negative").value =
                naiSettings.characterNegativePrompt || "";

              document.getElementById(
                "character-nai-prompts-modal",
              ).style.display = "flex";
            });

          // å…³é—­è§’è‰²ä¸“å±NAIæç¤ºè¯å¼¹çª—
          document
            .getElementById("close-character-nai-prompts")
            .addEventListener("click", () => {
              document.getElementById(
                "character-nai-prompts-modal",
              ).style.display = "none";
            });

          // ä¿å­˜è§’è‰²ä¸“å±NAIæç¤ºè¯
          document
            .getElementById("save-character-nai-prompts-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;
              const chat = state.chats[state.activeChatId];

              if (!chat.settings.naiSettings) {
                chat.settings.naiSettings = {
                  promptSource: "system",
                };
              }

              chat.settings.naiSettings.characterPositivePrompt = document
                .getElementById("character-nai-positive")
                .value.trim();
              chat.settings.naiSettings.characterNegativePrompt = document
                .getElementById("character-nai-negative")
                .value.trim();

              console.log("ğŸ’¾ [ä¸“å±å¼¹çª—] ä¿å­˜è§’è‰²NAIæç¤ºè¯");
              console.log(
                "   characterPositivePrompt:",
                chat.settings.naiSettings.characterPositivePrompt,
              );
              console.log(
                "   characterNegativePrompt:",
                chat.settings.naiSettings.characterNegativePrompt,
              );
              console.log(
                "   promptSource:",
                chat.settings.naiSettings.promptSource,
              );

              // ä¿å­˜åˆ°æ•°æ®åº“
              await db.chats.put(chat);

              document.getElementById(
                "character-nai-prompts-modal",
              ).style.display = "none";
              alert("è§’è‰²ä¸“å±NAIæç¤ºè¯å·²ä¿å­˜ï¼");
            });

          // æ¸…ç©ºè§’è‰²ä¸“å±NAIæç¤ºè¯é…ç½®
          document
            .getElementById("reset-character-nai-prompts-btn")
            .addEventListener("click", () => {
              if (confirm("ç¡®å®šè¦æ¸…ç©ºå½“å‰è§’è‰²çš„NAIæç¤ºè¯é…ç½®å—ï¼Ÿ")) {
                document.getElementById("character-nai-positive").value = "";
                document.getElementById("character-nai-negative").value = "";
              }
            });

          // ç¾¤èŠè§’è‰²ä¸“å±NAIæç¤ºè¯å¼¹çª—äº‹ä»¶ç›‘å¬å™¨
          document
            .getElementById("group-character-nai-prompts-btn")
            .addEventListener("click", () => {
              if (!state.activeChatId) return;
              const chat = state.chats[state.activeChatId];

              // åŠ è½½å½“å‰è§’è‰²çš„NAIæç¤ºè¯é…ç½®
              const naiSettings = chat.settings.naiSettings || {
                promptSource: "system",
                characterPositivePrompt: "",
                characterNegativePrompt: "",
              };

              // ä¸¥æ ¼åŠ è½½è§’è‰²é…ç½®ï¼Œä¸ä¸ç³»ç»Ÿé…ç½®æ··æ·†
              // å¡«äº†å°±æœ‰ï¼Œæ²¡å¡«å°±ä¸ºç©ºï¼Œç»ä¸ä½¿ç”¨ç³»ç»Ÿé…ç½®å¡«å……
              document.getElementById("character-nai-positive").value =
                naiSettings.characterPositivePrompt || "";
              document.getElementById("character-nai-negative").value =
                naiSettings.characterNegativePrompt || "";

              document.getElementById(
                "character-nai-prompts-modal",
              ).style.display = "flex";
            });

          document
            .getElementById("import-world-book-btn")
            .addEventListener("click", async () => {
              const unlockKey = "isCharacterImportUnlocked";

              // 1. æ£€æŸ¥æ˜¯å¦å·²ç»è§£é” (å’Œè§’è‰²å¡å¯¼å…¥å…±ç”¨ä¸€ä¸ªè§£é”çŠ¶æ€)
              if (localStorage.getItem(unlockKey) === "true") {
                document.getElementById("world-book-import-input").click(); // ç›´æ¥æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
                return;
              }

              // 2. å¦‚æœæœªè§£é”ï¼Œè·å–è®¾å¤‡ç 
              const deviceCode = getDeviceCode();

              // 3. æ„å»ºä¸€ä¸ªåŒ…å«è®¾å¤‡ç å’Œè¾“å…¥æ¡†çš„HTMLå†…å®¹ (å’Œè§’è‰²å¡å¯¼å…¥çš„å¼¹çª—ä¸€æ ·)
              const modalHtmlContent = `
			        <p style="margin-bottom: 15px;">è¯·å‰å¾€å–PINç½‘ç«™ï¼Œä½¿ç”¨ä¸‹é¢çš„è®¾å¤‡ç è·å–PINã€‚</p>
			        <div style="background: #eee; padding: 10px; border-radius: 6px; margin-bottom: 15px; user-select: all; cursor: copy;" title="ç‚¹å‡»å¤åˆ¶è®¾å¤‡ç ">
			            <strong>è®¾å¤‡ç :</strong> <span id="device-code-to-copy">${deviceCode}</span>
			        </div>
			        <p id="copy-device-code-feedback" style="height: 15px; font-size: 12px; color: green;"></p>
			    `;

              // 4. ä½¿ç”¨ showCustomPrompt å¼¹å‡ºå¢å¼ºç‰ˆæ¨¡æ€æ¡†ï¼Œè®©ç”¨æˆ·è¾“å…¥PIN
              const userPin = await window.showCustomPrompt(
                "åŠŸèƒ½è§£é”",
                "è¯·åœ¨æ­¤è¾“å…¥è·å–åˆ°çš„PINç ...",
                "",
                "text",
                modalHtmlContent,
              );

              // 5. å¦‚æœç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œåˆ™ç›´æ¥è¿”å›
              if (userPin === null) return;

              // 6. éªŒè¯PINç 
              const correctPin = generatePinFromDeviceCode(deviceCode);
              if (userPin.trim().toUpperCase() === correctPin) {
                localStorage.setItem(unlockKey, "true");
                await showCustomAlert(
                  "è§£é”æˆåŠŸï¼",
                  "å¯¼å…¥åŠŸèƒ½å·²è§£é”ï¼Œæ­¤è®¾å¤‡æ— éœ€å†æ¬¡è¾“å…¥PINç ã€‚",
                );
                // è§¦å‘ä¸–ç•Œä¹¦çš„æ–‡ä»¶é€‰æ‹©å™¨
                document.getElementById("world-book-import-input").click();
              } else {
                await showCustomAlert(
                  "è§£é”å¤±è´¥",
                  "PINç é”™è¯¯ï¼Œè¯·é‡æ–°è·å–æˆ–è¾“å…¥ã€‚",
                );
              }
            });

          document
            .getElementById("world-book-import-input")
            .addEventListener("change", (e) => {
              const file = e.target.files[0];
              if (file) {
                // å½“ç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶åï¼Œè°ƒç”¨æˆ‘ä»¬çš„æ ¸å¿ƒå¤„ç†å‡½æ•°
                handleImportSillyTavernWorldBook(file);
              }
              // æ¯æ¬¡ç”¨å®Œåæ¸…ç©ºï¼Œè¿™æ ·ç”¨æˆ·ä¸‹æ¬¡è¿˜èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
              e.target.value = null;
            });

          // ç»‘å®šâ€œç¼–è¾‘æ¨¡å¼â€æŒ‰é’®
          document
            .getElementById("toggle-world-book-edit-mode-btn")
            .addEventListener("click", toggleWorldBookEditMode);

          // å°†â€œç®¡ç†åˆ†ç±»â€çš„åŠŸèƒ½ç»‘å®šåˆ°æ–°æŒ‰é’®ä¸Š
          // åŸæ¥çš„ manage-world-book-categories-btn æŒ‰é’®ç°åœ¨æ˜¯ç¼–è¾‘æ¨¡å¼çš„åˆ‡æ¢æŒ‰é’®äº†
          document
            .getElementById("manage-categories-in-edit-mode-btn")
            .addEventListener("click", openCategoryManager);

          // ä¸ºä¸–ç•Œä¹¦åˆ—è¡¨æ·»åŠ ç»Ÿä¸€çš„ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
          document
            .getElementById("world-book-list")
            .addEventListener("click", handleWorldBookListClick);

          // ä¸ºåº•éƒ¨çš„â€œåˆ é™¤å·²é€‰â€æŒ‰é’®ç»‘å®šäº‹ä»¶
          document
            .getElementById("world-book-delete-selected-btn")
            .addEventListener("click", handleBulkDeleteWorldBooks);

          document
            .getElementById("add-world-book-btn")
            .addEventListener("click", async () => {
              const name = await showCustomPrompt("åˆ›å»ºä¸–ç•Œä¹¦", "è¯·è¾“å…¥ä¹¦å");
              if (name && name.trim()) {
                const newBook = {
                  id: "wb_" + Date.now(),
                  name: name.trim(),
                  content: "",
                };
                await db.worldBooks.add(newBook);
                state.worldBooks.push(newBook);
                renderWorldBookScreen();
                openWorldBookEditor(newBook.id);
              }
            });
          document
            .getElementById("save-world-book-btn")
            .addEventListener("click", async () => {
              if (!editingWorldBookId) return;
              const book = state.worldBooks.find(
                (wb) => wb.id === editingWorldBookId,
              );
              if (book) {
                const newName = document
                  .getElementById("world-book-name-input")
                  .value.trim();
                if (!newName) {
                  alert("ä¹¦åä¸èƒ½ä¸ºç©ºï¼");
                  return;
                }
                book.name = newName;
                book.content = document.getElementById(
                  "world-book-content-input",
                ).value;

                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œä¿å­˜åˆ†ç±»ID
                const categoryId = document.getElementById(
                  "world-book-category-select",
                ).value;
                // å¦‚æœé€‰æ‹©äº†â€œæœªåˆ†ç±»â€ï¼Œå­˜å…¥ nullï¼›å¦åˆ™å­˜å…¥æ•°å­—ID
                book.categoryId = categoryId ? parseInt(categoryId) : null;

                await db.worldBooks.put(book);
                document.getElementById("world-book-editor-title").textContent =
                  newName;
                editingWorldBookId = null;
                renderWorldBookScreen();
                showScreen("world-book-screen");
              }
            });

          document
            .getElementById("chat-messages")
            .addEventListener("click", async (e) => {
              const voiceBody = e.target.closest(".voice-message-body");
              if (voiceBody) {
                const bubble = voiceBody.closest(".message-bubble");
                if (!bubble) return;

                // å¦‚æœæ˜¯ç”¨æˆ·è‡ªå·±çš„è¯­éŸ³ï¼Œåªåˆ‡æ¢æ–‡å­—æ˜¾ç¤ºï¼Œä¸æ’­æ”¾
                if (bubble.classList.contains("user")) {
                  toggleVoiceTranscript(bubble);
                  return;
                }

                // å¦‚æœæ˜¯AIçš„è¯­éŸ³æ¶ˆæ¯
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                // --- æ ¸å¿ƒé€»è¾‘å¼€å§‹ ---

                // 1. æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æ­£åœ¨æ’­æ”¾çš„è¯­éŸ³æ¡
                if (isTtsPlaying && currentTtsAudioBubble === bubble) {
                  // å¦‚æœæ˜¯ï¼Œåˆ™åœæ­¢æ’­æ”¾å¹¶æ”¶èµ·æ‰€æœ‰å…³è”çš„æ–‡å­—
                  stopMinimaxAudio();
                }
                // 2. æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯å·²ç»å±•å¼€äº†æ–‡å­—ä½†æ²¡æœ‰æ’­æ”¾çš„è¯­éŸ³æ¡
                else if (bubble.dataset.state === "expanded") {
                  // å¦‚æœæ˜¯ï¼Œåˆ™åªæ”¶èµ·æ–‡å­—ï¼Œä¸å½±å“å…¶ä»–
                  toggleVoiceTranscript(bubble);
                }
                // 3. å¦‚æœä»¥ä¸Šéƒ½ä¸æ˜¯ï¼Œè¯´æ˜æ˜¯æƒ³å¼€å§‹æ’­æ”¾æˆ–åªå±•å¼€æ–‡å­—
                else {
                  const clickedTimestamp = parseInt(bubble.dataset.timestamp);
                  const startIndex = chat.history.findIndex(
                    (m) => m.timestamp === clickedTimestamp,
                  );
                  if (startIndex === -1) return;

                  // æŸ¥æ‰¾è¿ç»­çš„è¯­éŸ³æ¶ˆæ¯
                  const messagesToPlay = findConsecutiveAiVoiceMessages(
                    chat.history,
                    startIndex,
                  );
                  if (messagesToPlay.length > 0) {
                    const bubblesToAnimate = messagesToPlay
                      .map((m) =>
                        document.querySelector(
                          `.message-bubble[data-timestamp="${m.timestamp}"]`,
                        ),
                      )
                      .filter(Boolean);

                    // æ£€æŸ¥é…ç½®ï¼Œå†³å®šæ˜¯æ’­æ”¾è¿˜æ˜¯åªæ˜¾ç¤ºæ–‡å­—
                    const groupId = state.apiConfig.minimaxGroupId;
                    const apiKey = state.apiConfig.minimaxApiKey;
                    const voiceId = chat.settings.minimaxVoiceId;

                    if (groupId && apiKey && voiceId) {
                      // ã€æ’­æ”¾åˆ†æ”¯ã€‘
                      // å…ˆå±•å¼€æ‰€æœ‰æ–‡å­—
                      bubblesToAnimate.forEach((b) => {
                        if (b.dataset.state !== "expanded") {
                          toggleVoiceTranscript(b);
                        }
                      });
                      // ç„¶åè°ƒç”¨æ’­æ”¾å™¨
                      const combinedText = messagesToPlay
                        .map((m) => m.content.trim())
                        .join("ï¼Œ");
                      playMinimaxAudio(combinedText, voiceId, bubblesToAnimate);
                    } else {
                      // ã€åªæ˜¾ç¤ºæ–‡å­—åˆ†æ”¯ã€‘
                      // åªå±•å¼€å½“å‰ç‚¹å‡»çš„è¿™ä¸€ä¸ªè¯­éŸ³æ¡çš„æ–‡å­—
                      toggleVoiceTranscript(bubble);
                    }
                  }
                }

                return; // å¤„ç†å®Œè¯­éŸ³åé€€å‡º
              }

              // --- ä½ åŸæ¥çš„å…¶ä»–ç‚¹å‡»äº‹ä»¶é€»è¾‘ ---
              const aiImage = e.target.closest(".ai-generated-image");
              if (aiImage) {
                const description = aiImage.dataset.description;
                if (description) showCustomAlert("ç…§ç‰‡æè¿°", description);
                return;
              }
              const linkCard = e.target.closest(".link-share-card");
              if (
                linkCard &&
                linkCard.closest(".message-bubble.is-link-share")
              ) {
                const timestamp = parseInt(linkCard.dataset.timestamp);
                if (!isNaN(timestamp)) {
                  openBrowser(timestamp);
                }
              }
              const packetCard = e.target.closest(".red-packet-card");
              if (packetCard) {
                const messageBubble = packetCard.closest(".message-bubble");
                if (messageBubble && messageBubble.dataset.timestamp) {
                  const timestamp = parseInt(messageBubble.dataset.timestamp);
                  handlePacketClick(timestamp);
                }
              }
              const pollCard = e.target.closest(".poll-card");
              if (pollCard) {
                const timestamp = parseInt(pollCard.dataset.pollTimestamp);
                if (isNaN(timestamp)) return;
                const optionItem = e.target.closest(".poll-option-item");
                if (optionItem && !pollCard.classList.contains("closed")) {
                  handleUserVote(timestamp, optionItem.dataset.option);
                  return;
                }
                const actionBtn = e.target.closest(".poll-action-btn");
                if (actionBtn) {
                  if (pollCard.classList.contains("closed")) {
                    showPollResults(timestamp);
                  } else {
                    endPoll(timestamp);
                  }
                  return;
                }
                if (pollCard.classList.contains("closed")) {
                  showPollResults(timestamp);
                }
              }
              const card = e.target.closest(".waimai-card");
              if (card) {
                const messageBubble = card.closest(".message-bubble");
                const invitationMsg = state.chats[
                  state.activeChatId
                ].history.find(
                  (m) =>
                    m.timestamp === parseInt(messageBubble.dataset.timestamp),
                );
                if (
                  invitationMsg &&
                  invitationMsg.type === "lovers_space_invitation" &&
                  invitationMsg.status === "pending"
                ) {
                  const choice = e.target.dataset.choice;
                  if (choice) {
                    handleLoversSpaceResponse(invitationMsg.timestamp, choice);
                  }
                }
              }
              const repostCard = e.target.closest(
                ".link-share-card[data-post-id]",
              );
              if (repostCard) {
                const postId = parseInt(repostCard.dataset.postId);
                if (!isNaN(postId)) {
                  openPost(postId);
                }
              }

              // å¤„ç†åˆ†äº«å¡ç‰‡çš„ç‚¹å‡»
              const shareCard = e.target.closest(
                ".link-share-card[data-timestamp]",
              );
              if (
                shareCard &&
                shareCard.closest(".message-bubble.is-link-share")
              ) {
                const timestamp = parseInt(shareCard.dataset.timestamp);
                if (!isNaN(timestamp)) {
                  const msg = state.chats[state.activeChatId].history.find(
                    (m) => m.timestamp === timestamp,
                  );
                  if (msg && msg.type === "share_card")
                    openSharedHistoryViewer(timestamp);
                  else if (msg && msg.type === "share_link")
                    openBrowser(timestamp);
                }
              }

              // å¤„ç†å·²æ’¤å›æ¶ˆæ¯çš„ç‚¹å‡»
              const placeholder = e.target.closest(
                ".recalled-message-placeholder",
              );
              if (placeholder) {
                const wrapper = placeholder.closest(".message-wrapper");
                const chat = state.chats[state.activeChatId];
                if (chat && wrapper) {
                  const timestamp = parseInt(wrapper.dataset.timestamp);
                  const recalledMsg = chat.history.find(
                    (m) => m.timestamp === timestamp,
                  );
                  if (recalledMsg && recalledMsg.recalledData) {
                    let originalContentText = "";
                    const recalled = recalledMsg.recalledData;
                    if (recalled.originalType === "text") {
                      originalContentText = `åŸæ–‡: "${recalled.originalContent}"`;
                    } else {
                      originalContentText = `æ’¤å›äº†ä¸€æ¡[${recalled.originalType}]ç±»å‹çš„æ¶ˆæ¯`;
                    }
                    showCustomAlert("å·²æ’¤å›çš„æ¶ˆæ¯", originalContentText);
                  }
                }
              }

              const chatCard = e.target.closest(".dating-summary-chat-card");
              if (chatCard && chatCard.dataset.summaryPayload) {
                try {
                  // è¯»å–å¹¶è§£æå­˜å‚¨åœ¨ data-* å±æ€§ä¸­çš„å¡ç‰‡æ•°æ®
                  const payloadString = chatCard.dataset.summaryPayload
                    .replace(/&apos;/g, "'")
                    .replace(/"/g, "&quot;");
                  const payload = JSON.parse(payloadString);
                  // è°ƒç”¨æˆ‘ä»¬æ–°å†™çš„å‡½æ•°ï¼Œæ‰“å¼€è¯¦æƒ…å¡ç‰‡
                  reopenDatingSummary(payload);
                } catch (error) {
                  console.error("è§£æåˆ†äº«çš„çº¦ä¼šè®°å½•å¤±è´¥:", error);
                  alert("æ— æ³•æ‰“å¼€è¿™ä¸ªçº¦ä¼šè®°å½•ã€‚");
                }
              }
            });

          const chatSettingsModal = document.getElementById(
            "chat-settings-modal",
          );
          const worldBookSelectBox = document.querySelector(
            ".custom-multiselect .select-box",
          );
          const worldBookCheckboxesContainer = document.getElementById(
            "world-book-checkboxes-container",
          );

          function updateWorldBookSelectionDisplay() {
            const checkedBoxes =
              worldBookCheckboxesContainer.querySelectorAll("input:checked");
            const displayText = document.querySelector(
              ".selected-options-text",
            );
            if (checkedBoxes.length === 0) {
              displayText.textContent = "-- ç‚¹å‡»é€‰æ‹© --";
            } else if (checkedBoxes.length > 2) {
              displayText.textContent = `å·²é€‰æ‹© ${checkedBoxes.length} é¡¹`;
            } else {
              displayText.textContent = Array.from(checkedBoxes)
                .map((cb) => cb.parentElement.textContent.trim())
                .join(", ");
            }
          }

          worldBookSelectBox.addEventListener("click", (e) => {
            e.stopPropagation();
            worldBookCheckboxesContainer.classList.toggle("visible");
            worldBookSelectBox.classList.toggle("expanded");
          });
          document
            .getElementById("world-book-checkboxes-container")
            .addEventListener("change", updateWorldBookSelectionDisplay);
          window.addEventListener("click", (e) => {
            if (
              !document.querySelector(".custom-multiselect").contains(e.target)
            ) {
              worldBookCheckboxesContainer.classList.remove("visible");
              worldBookSelectBox.classList.remove("expanded");
            }
          });

          document
            .getElementById("chat-settings-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;
              const chat = state.chats[state.activeChatId];
              const isGroup = chat.isGroup;
              document.getElementById("offline-mode-section").style.display =
                isGroup ? "none" : "block";
              document.getElementById("couple-avatar-group").style.display =
                isGroup ? "none" : "block";
              document.getElementById("streak-settings-section").style.display =
                isGroup ? "none" : "block";

              // è®¡ç®—æ€»æ¶ˆæ¯æ¡æ•°å¹¶æ›´æ–°æ˜¾ç¤º
              const totalMessages = chat.history.length;
              const countDisplay = document.getElementById(
                "total-message-count-display",
              );
              if (countDisplay) {
                countDisplay.textContent = `${totalMessages} æ¡`;
              }

              // --- ä¿®æ”¹å¼€å§‹ï¼šä½¿ç”¨æ·±åº¦åˆ†æé€»è¾‘æ¥æ›´æ–°ä¸»ç•Œé¢çš„Tokenæ˜¾ç¤º ---
              const tokenDisplay = document.getElementById(
                "context-token-count-display",
              );

              const updateTokenDisplay = async () => {
                tokenDisplay.textContent = "è®¡ç®—ä¸­...";

                // å¤ç”¨æ·±åº¦åˆ†æçš„è®¡ç®—é€»è¾‘
                const result = await getTokenDetailedBreakdown(
                  state.activeChatId,
                );

                if (result && result.items) {
                  const totalCount = result.items.reduce(
                    (sum, item) => sum + item.count,
                    0,
                  );
                  tokenDisplay.textContent = totalCount.toLocaleString();
                } else {
                  tokenDisplay.textContent = "0";
                }
              };

              await updateTokenDisplay();

              // 3. ã€å…³é”®ã€‘ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆé˜²æ­¢é‡å¤ï¼‰ï¼Œå¹¶æ·»åŠ æ–°çš„ç‚¹å‡»ç›‘å¬å™¨
              // ä½¿ç”¨ cloneNode æŠ€å·§å¿«é€Ÿæ¸…é™¤æ—§çš„ event listeners
              const newTokenDisplay = tokenDisplay.cloneNode(true);
              tokenDisplay.parentNode.replaceChild(
                newTokenDisplay,
                tokenDisplay,
              );
              newTokenDisplay.addEventListener("click", async () => {
                // æ³¨æ„ï¼šç°åœ¨è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ { items, outliers }
                const result = await getTokenDetailedBreakdown(
                  state.activeChatId,
                );
                if (!result) return;

                const breakdown = result.items;
                const outliers = result.outliers;

                let total = 0;
                breakdown.forEach((item) => (total += item.count));

                let htmlContent =
                  '<div style="text-align: left; font-size: 13px;">';

                // 1. æ¸²æŸ“æ­£å¸¸çš„è¿›åº¦æ¡ (ä¿æŒä¸å˜)
                const colorMap = {
                  æ ¸å¿ƒäººè®¾: "#FF6B6B",
                  ä¸–ç•Œä¹¦: "#4ECDC4",
                  è¡¨æƒ…åŒ…å®šä¹‰: "#FFD93D",
                  "é•¿æœŸè®°å¿†(æ€»ç»“)": "#45B7D1",
                  "çŸ­æœŸè®°å¿†(ç”¨æˆ·)": "#96CEB4",
                  "çŸ­æœŸè®°å¿†(AI)": "#A8E6CF",
                  ç³»ç»Ÿæ ¼å¼æŒ‡ä»¤: "#D4A5A5",
                };

                breakdown.forEach((item) => {
                  if (item.count > 0) {
                    const percent =
                      total > 0 ? Math.round((item.count / total) * 100) : 0;
                    const color = colorMap[item.name] || "#ccc";
                    htmlContent += `
                    <div style="margin-bottom: 6px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                            <span>${item.name}</span>
                            <span style="color:#888;">${item.count} (${percent}%)</span>
                        </div>
                        <div style="width: 100%; background-color: #f0f0f0; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${percent}%; background-color: ${color}; height: 100%;"></div>
                        </div>
                    </div>
                `;
                  }
                });

                // 2. ã€æ–°å¢ã€‘æ¸²æŸ“å¼‚å¸¸å¤§æ¶ˆæ¯åˆ—è¡¨
                if (outliers.length > 0) {
                  htmlContent += `<hr style="opacity:0.2; margin:15px 0 10px 0;">`;
                  htmlContent += `<div style="color: #ff3b30; font-weight: bold; margin-bottom: 8px;">âš ï¸ å‘ç°å ç”¨è¾ƒå¤§çš„æ¶ˆæ¯ (Top ${outliers.length})</div>`;
                  htmlContent += `<div style="max-height: 150px; overflow-y: auto; background: #f9f9f9; border-radius: 6px; padding: 5px;">`;

                  outliers.forEach((msg) => {
                    const roleTag =
                      msg.role === "user"
                        ? '<span style="color:#007bff">[æˆ‘]</span>'
                        : '<span style="color:#28a745">[AI]</span>';
                    // æ·»åŠ  onclick è°ƒç”¨æˆ‘ä»¬åˆšåˆšæš´éœ²çš„ window.jumpToMessage
                    htmlContent += `
                    <div onclick="window.jumpToMessage(${msg.timestamp})" 
                         style="display:flex; justify-content:space-between; align-items:center; padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 12px;">
                        <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            ${roleTag} ${msg.preview}
                        </div>
                        <div style="color: #666; margin-left: 10px; font-family: monospace;">
                            ${msg.count} å­—ç¬¦ &rarr;
                        </div>
                    </div>
                `;
                  });
                  htmlContent += `</div>`;
                  htmlContent += `<p style="font-size:11px; color:#aaa; margin-top:4px;">ç‚¹å‡»å³å¯å®šä½å¹¶é«˜äº®è¯¥æ¶ˆæ¯ï¼Œæ‚¨å¯ä»¥é€‰æ‹©åˆ é™¤å®ƒã€‚</p>`;
                }

                // 3. åº•éƒ¨æ±‡æ€»
                htmlContent += `<hr style="opacity:0.2; margin:10px 0;">
            <div style="text-align:right; font-weight:bold; font-size:15px;">æ€»è®¡: ${total} å­—ç¬¦</div>
        </div>`;

                await showCustomAlert("Token æ·±åº¦åˆ†æ", htmlContent);
              });

              // --- ç»Ÿä¸€æ˜¾ç¤º/éšè—æ§ä»¶ ---

              const videoCallSettingsGroup = document.getElementById(
                "video-call-settings-group",
              );
              const visualCallSwitch = document.getElementById(
                "visual-video-call-switch",
              );
              const imageUploadsDiv = document.getElementById(
                "video-call-image-uploads",
              );
              // --- åŠ è½½èŠå¤©æ€»ç»“è®¾ç½® ---
              const summarySettings = chat.settings.summary || {};
              const summaryToggle = document.getElementById("summary-toggle");
              const summaryDetails = document.getElementById(
                "summary-details-container",
              );

              summaryToggle.checked = summarySettings.enabled || false;
              summaryDetails.style.display = summaryToggle.checked
                ? "block"
                : "none";

              document.querySelector(
                `input[name="summary-mode"][value="${summarySettings.mode || "auto"}"]`,
              ).checked = true;
              document.getElementById("summary-count-input").value =
                summarySettings.count || 20;
              document.getElementById("summary-prompt-input").value =
                summarySettings.prompt ||
                "è¯·ä½ ä»¥ç¬¬ä¸‰äººç§°çš„è§†è§’ï¼Œå®¢è§‚ã€å†·é™ã€ä¸å¸¦ä»»ä½•æ„Ÿæƒ…è‰²å½©åœ°æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„æ ¸å¿ƒäº‹ä»¶å’Œä¿¡æ¯ã€‚ç¦æ­¢è¿›è¡Œä»»ä½•è§’è‰²æ‰®æ¼”æˆ–æ·»åŠ ä¸»è§‚è¯„è®ºã€‚";

              // ä¸ºå¼€å…³æ·»åŠ å®æ—¶äº¤äº’
              summaryToggle.onchange = () => {
                summaryDetails.style.display = summaryToggle.checked
                  ? "block"
                  : "none";
              };

              if (isGroup) {
                videoCallSettingsGroup.style.display = "none"; // ç¾¤èŠä¸æ”¯æŒï¼Œéšè—æ•´ä¸ªè®¾ç½®åŒº
              } else {
                videoCallSettingsGroup.style.display = "block"; // å•èŠæ˜¾ç¤º

                // åŠ è½½å½“å‰è®¾ç½®
                visualCallSwitch.checked =
                  chat.settings.visualVideoCallEnabled || false;
                imageUploadsDiv.style.display = visualCallSwitch.checked
                  ? "block"
                  : "none";
                document.getElementById("char-video-image-preview").src =
                  chat.settings.charVideoImage ||
                  "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png";
                document.getElementById("user-video-image-preview").src =
                  chat.settings.userVideoImage ||
                  "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png";
                const voiceAccessSwitch = document.getElementById(
                  "video-call-voice-access-switch",
                );
                voiceAccessSwitch.checked =
                  chat.settings.videoCallVoiceAccess || false;

                // ä¸ºå¼€å…³æ·»åŠ å®æ—¶äº¤äº’
                visualCallSwitch.onchange = () => {
                  imageUploadsDiv.style.display = visualCallSwitch.checked
                    ? "block"
                    : "none";
                };
              }
              const realCameraSwitch = document.getElementById(
                "user-real-camera-switch",
              );
              if (realCameraSwitch) {
                realCameraSwitch.checked = chat.settings.useRealCamera || false;
              }
              // --- çº¿ä¸‹æ¨¡å¼UIæ¸²æŸ“ ---
              const offlineModeSettings = chat.settings.offlineMode || {
                enabled: false,
                presets: [],
              }; // å®‰å…¨è·å–
              const offlineToggle = document.getElementById(
                "offline-mode-toggle",
              );
              const offlineDetails = document.getElementById(
                "offline-mode-details",
              );

              // 1. è®¾ç½®å¼€å…³çŠ¶æ€å¹¶ç»‘å®šäº‹ä»¶
              offlineToggle.checked = offlineModeSettings.enabled;
              offlineDetails.style.display = offlineToggle.checked
                ? "block"
                : "none";
              offlineToggle.onchange = () => {
                offlineDetails.style.display = offlineToggle.checked
                  ? "block"
                  : "none";
              };

              // 2. å¡«å……è¾“å…¥æ¡†
              document.getElementById("offline-prompt-input").value =
                offlineModeSettings.prompt || "";
              document.getElementById("offline-style-input").value =
                offlineModeSettings.style || "";
              document.getElementById("offline-word-count-input").value =
                offlineModeSettings.wordCount || 300;
              // åŠ è½½ç”Ÿå›¾å¼€å…³çŠ¶æ€
              document.getElementById("offline-novelai-toggle").checked =
                offlineModeSettings.enableNovelAI || false;

              // 3. æ¸²æŸ“é¢„è®¾ä¸‹æ‹‰æ¡†
              renderOfflinePresetsSelector();

              // ä¸ºæ°”æ³¡å¯¼å…¥/å¯¼å‡ºæŒ‰é’®ç»‘å®šäº‹ä»¶
              document
                .getElementById("export-bubble-preset-btn")
                .addEventListener("click", exportSelectedBubblePreset);

              document
                .getElementById("import-bubble-preset-btn")
                .addEventListener("click", () => {
                  // ç‚¹å‡»â€œå¯¼å…¥â€æŒ‰é’®æ—¶ï¼Œè§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©æ¡†
                  document.getElementById("import-bubble-preset-input").click();
                });

              document
                .getElementById("import-bubble-preset-input")
                .addEventListener("change", (e) => {
                  // å½“ç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶åï¼Œè°ƒç”¨å¯¼å…¥å‡½æ•°å¤„ç†
                  importBubblePreset(e.target.files[0]);
                  e.target.value = null; // æ¯æ¬¡ç”¨å®Œåæ¸…ç©ºï¼Œæ–¹ä¾¿ä¸‹æ¬¡é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
                });

              document.getElementById("chat-name-group").style.display =
                "block";
              document.getElementById("minimax-voice-id-group").style.display =
                isGroup ? "none" : "block";
              document.getElementById("my-persona-group").style.display =
                "block";
              document.getElementById("my-avatar-group").style.display =
                "block";
              document.getElementById("my-group-nickname-group").style.display =
                isGroup ? "block" : "none";
              document.getElementById("group-avatar-group").style.display =
                isGroup ? "block" : "none";
              document.getElementById("group-members-group").style.display =
                isGroup ? "block" : "none";
              document.getElementById("ai-persona-group").style.display =
                isGroup ? "none" : "block";
              document.getElementById("ai-avatar-group").style.display = isGroup
                ? "none"
                : "block";

              document.getElementById("npc-library-group").style.display =
                isGroup ? "none" : "block";

              // NAIå‡ºå›¾è®¾ç½®çš„æ˜¾ç¤º/éšè—å’ŒåŠ è½½
              const naiCharacterSettingsGroup = document.getElementById(
                "nai-character-settings-group",
              );
              // æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å¯ç”¨äº†NovelAI
              const novelaiEnabled =
                localStorage.getItem("novelai-enabled") === "true";
              if (!isGroup && novelaiEnabled) {
                naiCharacterSettingsGroup.style.display = "block";

                // åŠ è½½è§’è‰²NAIè®¾ç½®
                const naiSettings = chat.settings.naiSettings || {
                  promptSource: "system",
                  characterPositivePrompt: "",
                  characterNegativePrompt: "",
                };

                console.log("ğŸ“– [åŠ è½½è®¾ç½®] è§’è‰²NAIè®¾ç½®:", naiSettings);
                console.log("   promptSource:", naiSettings.promptSource);
                console.log(
                  "   characterPositivePrompt:",
                  naiSettings.characterPositivePrompt,
                );
                console.log(
                  "   characterNegativePrompt:",
                  naiSettings.characterNegativePrompt,
                );

                // è®¾ç½®æç¤ºè¯æ¥æºé€‰é¡¹
                const promptSourceRadios = document.querySelectorAll(
                  'input[name="nai-prompt-source"]',
                );
                promptSourceRadios.forEach((radio) => {
                  radio.checked = radio.value === naiSettings.promptSource;
                  console.log(
                    `   è®¾ç½®å•é€‰æŒ‰é’® ${radio.value}: ${radio.checked}`,
                  );
                });
              } else {
                naiCharacterSettingsGroup.style.display = "none";
              }

              // ç¾¤èŠNAIå‡ºå›¾è®¾ç½®çš„æ˜¾ç¤º/éšè—å’ŒåŠ è½½
              const groupNaiSettingsGroup = document.getElementById(
                "group-nai-settings-group",
              );
              if (isGroup && novelaiEnabled) {
                groupNaiSettingsGroup.style.display = "block";

                // åŠ è½½ç¾¤èŠè§’è‰²NAIè®¾ç½®
                const groupNaiSettings = chat.settings.naiSettings || {
                  promptSource: "system",
                  characterPositivePrompt: "",
                  characterNegativePrompt: "",
                };

                console.log("ğŸ“– [åŠ è½½è®¾ç½®] ç¾¤èŠè§’è‰²NAIè®¾ç½®:", groupNaiSettings);
                console.log("   promptSource:", groupNaiSettings.promptSource);
                console.log(
                  "   characterPositivePrompt:",
                  groupNaiSettings.characterPositivePrompt,
                );
                console.log(
                  "   characterNegativePrompt:",
                  groupNaiSettings.characterNegativePrompt,
                );

                // è®¾ç½®æç¤ºè¯æ¥æºé€‰é¡¹
                const groupPromptSourceRadios = document.querySelectorAll(
                  'input[name="group-nai-prompt-source"]',
                );
                groupPromptSourceRadios.forEach((radio) => {
                  radio.checked = radio.value === groupNaiSettings.promptSource;
                  console.log(
                    `   è®¾ç½®å•é€‰æŒ‰é’® ${radio.value}: ${radio.checked}`,
                  );
                });
              } else {
                groupNaiSettingsGroup.style.display = "none";
              }

              // æ ¹æ®æ˜¯å¦ä¸ºå•èŠæˆ–ç¾¤èŠï¼Œæ˜¾ç¤ºè¡¨æƒ…ç®¡ç†æŒ‰é’®
              const charStickerGroup =
                document.getElementById("char-sticker-group");
              if (charStickerGroup) {
                // ç°åœ¨æ— è®ºæ˜¯å•èŠè¿˜æ˜¯ç¾¤èŠï¼Œè¿™ä¸ªæŒ‰é’®éƒ½ä¼šæ˜¾ç¤º
                charStickerGroup.style.display = "block";
              }

              // æ ¹æ®æ˜¯å¦ä¸ºç¾¤èŠï¼Œæ˜¾ç¤ºæˆ–éšè—å¾®åšè®¾ç½®
              document.getElementById("weibo-profession-group").style.display =
                isGroup ? "none" : "block";
              document.getElementById("weibo-instruction-group").style.display =
                isGroup ? "none" : "block";
              // æ ¹æ®æ˜¯å¦ä¸ºç¾¤èŠï¼Œæ˜¾ç¤ºæˆ–éšè—â€œå¥½å‹åˆ†ç»„â€åŒºåŸŸ
              document.getElementById("assign-group-section").style.display =
                isGroup ? "none" : "block";

              // --- åŠ è½½è¡¨å•æ•°æ® ---
              document.getElementById("chat-name-input").value = chat.name;
              const remarkGroup = document.getElementById("chat-remark-group");
              const remarkInput = document.getElementById("chat-remark-input");

              if (chat.isGroup) {
                remarkGroup.style.display = "none"; // ç¾¤èŠä¸æ˜¾ç¤ºå¤‡æ³¨è®¾ç½®
              } else {
                remarkGroup.style.display = "block"; // å•èŠæ˜¾ç¤º
                // å¦‚æœæ²¡æœ‰settingså¯¹è±¡ï¼Œåˆå§‹åŒ–å®ƒ
                if (!chat.settings) chat.settings = {};
                remarkInput.value = chat.settings.remarkName || "";
              }

              document.getElementById("my-persona").value =
                chat.settings.myPersona;
              document.getElementById("my-avatar-preview").src =
                chat.settings.myAvatar ||
                (isGroup ? defaultMyGroupAvatar : defaultAvatar);
              document.getElementById("max-memory").value =
                chat.settings.maxMemory;
              const defaultMin = chat.isGroup ? 3 : 2;
              const defaultMax = chat.isGroup ? 8 : 5;
              const savedRange = chat.settings.replyCountRange || {
                min: defaultMin,
                max: defaultMax,
              };

              document.getElementById("min-reply-count-input").value =
                savedRange.min;
              document.getElementById("max-reply-count-input").value =
                savedRange.max;
              // è®°å¿†äº’é€šåŠŸèƒ½ - UIæ¸²æŸ“é€»è¾‘
              const memoryLinkSelectBox = document.querySelector(
                "#memory-link-multiselect .select-box",
              );
              const memoryLinkCheckboxesContainer = document.getElementById(
                "memory-link-checkboxes-container",
              );
              memoryLinkCheckboxesContainer.innerHTML = ""; // æ¸…ç©ºæ—§é€‰é¡¹

              // 1. è·å–é™¤äº†å½“å‰èŠå¤©ä»¥å¤–çš„æ‰€æœ‰èŠå¤©
              const otherChats = Object.values(state.chats).filter(
                (c) => c.id !== chat.id,
              );

              // 2. åŠ¨æ€åˆ›å»ºå¸¦å¤´åƒçš„å¤é€‰æ¡†
              otherChats.forEach((otherChat) => {
                const existingLink = chat.settings.linkedMemories.find(
                  (link) => link.chatId === otherChat.id,
                );
                const isChecked = existingLink ? "checked" : "";

                // æ ¹æ®æ˜¯ç¾¤èŠè¿˜æ˜¯å•èŠï¼Œè·å–æ­£ç¡®çš„å¤´åƒURL
                const avatarUrl = otherChat.isGroup
                  ? otherChat.settings.groupAvatar || defaultGroupAvatar
                  : otherChat.settings.aiAvatar || defaultAvatar;

                const label = document.createElement("label");

                // æ„å»ºåŒ…å« <img> æ ‡ç­¾çš„æ–°HTMLç»“æ„
                label.innerHTML = `
			        <input type="checkbox" value="${otherChat.id}" ${isChecked}>
			        <img src="${avatarUrl}" class="avatar-preview">
			        <span>${otherChat.name} ${otherChat.isGroup ? "(ç¾¤èŠ)" : ""}</span>
			    `;
                memoryLinkCheckboxesContainer.appendChild(label);
              });

              // 3. æ›´æ–°å·²é€‰æ•°é‡çš„æ˜¾ç¤ºå’Œè®°å¿†æ¡æ•°
              function updateMemoryLinkDisplay() {
                const checkedBoxes =
                  memoryLinkCheckboxesContainer.querySelectorAll(
                    "input:checked",
                  );
                const displayText = memoryLinkSelectBox.querySelector(
                  ".selected-options-text",
                );
                if (checkedBoxes.length === 0) {
                  displayText.textContent = "-- ç‚¹å‡»é€‰æ‹© --";
                } else {
                  displayText.textContent = `å·²é“¾æ¥ ${checkedBoxes.length} ä¸ªèŠå¤©`;
                }
              }

              // 4. åŠ è½½è®°å¿†æ¡æ•°è®¾ç½®
              // æˆ‘ä»¬ç°åœ¨ä»ä¸€ä¸ªç‹¬ç«‹çš„è®¾ç½®é¡¹åŠ è½½ï¼Œç¡®ä¿å®ƒæ€»èƒ½è¢«æ­£ç¡®è¯»å–
              document.getElementById("link-memory-depth-input").value =
                chat.settings.linkMemoryDepth || 5;

              // 5. ç»‘å®šäº‹ä»¶
              updateMemoryLinkDisplay(); // åˆå§‹åŒ–æ˜¾ç¤º
              memoryLinkCheckboxesContainer.addEventListener(
                "change",
                updateMemoryLinkDisplay,
              );
              // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§æ¥é˜²æ­¢äº‹ä»¶é‡å¤ç»‘å®š
              const newSelectBox = memoryLinkSelectBox.cloneNode(true);
              memoryLinkSelectBox.parentNode.replaceChild(
                newSelectBox,
                memoryLinkSelectBox,
              );
              newSelectBox.addEventListener("click", (e) => {
                e.stopPropagation();
                memoryLinkCheckboxesContainer.classList.toggle("visible");
                newSelectBox.classList.toggle("expanded");
              });

              const timeToggle = document.getElementById(
                "time-perception-toggle",
              );
              const customTimeContainer = document.getElementById(
                "custom-time-container",
              );
              const customTimeInput =
                document.getElementById("custom-time-input");

              // å¦‚æœæ˜¯æ—§èŠå¤©ï¼Œç»™ä¸€ä¸ªé»˜è®¤å€¼ trueï¼ˆå¼€å¯ï¼‰
              const isTimeEnabled = chat.settings.timePerceptionEnabled ?? true;
              timeToggle.checked = isTimeEnabled;
              customTimeInput.value = chat.settings.customTime || "";

              // æ ¹æ®å¼€å…³çŠ¶æ€ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºè‡ªå®šä¹‰æ—¶é—´è¾“å…¥æ¡†
              customTimeContainer.style.display = isTimeEnabled
                ? "none"
                : "block";

              const bgPreview = document.getElementById("bg-preview");
              const removeBgBtn = document.getElementById("remove-bg-btn");
              if (chat.settings.background) {
                bgPreview.src = chat.settings.background;
                bgPreview.style.display = "block";
                removeBgBtn.style.display = "inline-block";
              } else {
                bgPreview.style.display = "none";
                removeBgBtn.style.display = "none";
              }

              if (isGroup) {
                document.getElementById("my-group-nickname-input").value =
                  chat.settings.myNickname || "";
                document.getElementById("group-avatar-preview").src =
                  chat.settings.groupAvatar || defaultGroupAvatar;
                renderGroupMemberSettings(chat.members);
                // åŠ è½½ç¾¤èŠåå°æ´»åŠ¨è®¾ç½®
                const groupActivityGroup = document.getElementById(
                  "group-background-activity-group",
                );
                const groupActivitySwitch = document.getElementById(
                  "group-background-activity-switch",
                );
                const groupIntervalSettings = document.getElementById(
                  "group-background-interval-settings",
                );
                const groupIntervalInput = document.getElementById(
                  "group-background-interval-input",
                );

                groupActivityGroup.style.display = "block"; // æ˜¾ç¤ºè®¾ç½®åŒºåŸŸ
                const bgSettings = chat.settings.backgroundActivity || {
                  enabled: false,
                  interval: 120,
                };
                groupActivitySwitch.checked = bgSettings.enabled;
                groupIntervalInput.value = bgSettings.interval;
                groupIntervalSettings.style.display = bgSettings.enabled
                  ? "block"
                  : "none";

                // ä¸ºå¼€å…³æ·»åŠ å®æ—¶äº¤äº’
                groupActivitySwitch.onchange = () => {
                  groupIntervalSettings.style.display =
                    groupActivitySwitch.checked ? "block" : "none";
                };
              } else {
                document.getElementById("ai-persona").value =
                  chat.settings.aiPersona;
                // åŠ è½½å½“å‰è§’è‰²çš„å¾®åšèŒä¸šå’ŒæŒ‡ä»¤
                document.getElementById("weibo-profession-input").value =
                  chat.settings.weiboProfession || "";
                document.getElementById("weibo-instruction-input").value =
                  chat.settings.weiboInstruction || "";
                document.getElementById("ai-avatar-preview").src =
                  chat.settings.aiAvatar || defaultAvatar;
                document.getElementById("minimax-voice-id-input").value =
                  chat.settings.minimaxVoiceId || "";
                // åŠ è½½è¯­è¨€å¢å¼ºå’Œè¯­é€Ÿè®¾ç½®
                const langBoostSelect = document.getElementById(
                  "minimax-language-boost-select",
                );
                const speedSlider = document.getElementById(
                  "minimax-speed-slider",
                );
                const speedValueDisplay = document.getElementById(
                  "minimax-speed-value",
                );

                // æ ¹æ®èŠå¤©ç±»å‹ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºè¿™ä¸¤ä¸ªæ–°è®¾ç½®
                const showMinimaxSpecificSettings = !isGroup;
                document.getElementById(
                  "minimax-language-boost-group",
                ).style.display = showMinimaxSpecificSettings
                  ? "block"
                  : "none";
                document.getElementById("minimax-speed-group").style.display =
                  showMinimaxSpecificSettings ? "block" : "none";

                if (showMinimaxSpecificSettings) {
                  // åŠ è½½ language_boostï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é»˜è®¤ä¸ºç©ºï¼ˆå³"æ— "ï¼‰
                  langBoostSelect.value = chat.settings.language_boost || "";

                  // åŠ è½½ speedï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é»˜è®¤ä¸º 1.0
                  const speed = chat.settings.speed ?? 1.0; // ä½¿ç”¨ ?? ç¡®ä¿å³ä½¿å€¼ä¸º0ä¹Ÿèƒ½æ­£ç¡®å¤„ç†
                  speedSlider.value = speed;
                  speedValueDisplay.textContent = parseFloat(speed).toFixed(1);
                }

                // ä¸ºè¯­é€Ÿæ»‘å—æ·»åŠ å®æ—¶æ›´æ–°æ˜¾ç¤ºå€¼çš„äº‹ä»¶
                speedSlider.oninput = () => {
                  speedValueDisplay.textContent = parseFloat(
                    speedSlider.value,
                  ).toFixed(1);
                };

                const coupleAvatarToggle = document.getElementById(
                  "couple-avatar-toggle",
                );
                const coupleAvatarDescContainer = document.getElementById(
                  "couple-avatar-desc-container",
                );
                const coupleAvatarDescInput = document.getElementById(
                  "couple-avatar-description",
                );

                coupleAvatarToggle.checked =
                  chat.settings.isCoupleAvatar || false;
                coupleAvatarDescInput.value =
                  chat.settings.coupleAvatarDescription || "";

                coupleAvatarDescContainer.style.display =
                  coupleAvatarToggle.checked ? "block" : "none";

                coupleAvatarToggle.onchange = () => {
                  coupleAvatarDescContainer.style.display =
                    coupleAvatarToggle.checked ? "block" : "none";
                };

                document.getElementById(
                  "group-background-activity-group",
                ).style.display = "none";
                // å¦‚æœæ˜¯å•èŠï¼Œå°±åŠ è½½åˆ†ç»„åˆ—è¡¨åˆ°ä¸‹æ‹‰æ¡†
                const select = document.getElementById("assign-group-select");
                select.innerHTML = '<option value="">æœªåˆ†ç»„</option>'; // æ¸…ç©ºå¹¶è®¾ç½®é»˜è®¤é€‰é¡¹
                const groups = await db.qzoneGroups.toArray();
                groups.forEach((group) => {
                  const option = document.createElement("option");
                  option.value = group.id;
                  option.textContent = group.name;
                  // å¦‚æœå½“å‰å¥½å‹å·²ç»æœ‰åˆ†ç»„ï¼Œå°±é»˜è®¤é€‰ä¸­å®ƒ
                  if (chat.groupId === group.id) {
                    option.selected = true;
                  }
                  select.appendChild(option);
                });
              }

              const worldBookCheckboxesContainer = document.getElementById(
                "world-book-checkboxes-container",
              );
              worldBookCheckboxesContainer.innerHTML = "";
              const linkedIds = new Set(chat.settings.linkedWorldBookIds || []);

              // 1. è·å–æ‰€æœ‰åˆ†ç±»å’Œä¸–ç•Œä¹¦
              const categories = await db.worldBookCategories.toArray();
              const books = state.worldBooks;

              // å¦‚æœå­˜åœ¨æœªåˆ†ç±»çš„ä¹¦ç±ï¼Œå°±åˆ›å»ºä¸€ä¸ªâ€œè™šæ‹Ÿåˆ†ç±»â€
              const hasUncategorized = books.some((book) => !book.categoryId);
              if (hasUncategorized) {
                categories.push({ id: "uncategorized", name: "æœªåˆ†ç±»" });
              }

              // 2. å°†ä¹¦ç±æŒ‰åˆ†ç±»IDè¿›è¡Œåˆ†ç»„
              const booksByCategoryId = books.reduce((acc, book) => {
                const categoryId = book.categoryId || "uncategorized";
                if (!acc[categoryId]) {
                  acc[categoryId] = [];
                }
                acc[categoryId].push(book);
                return acc;
              }, {});

              // 3. éå†åˆ†ç±»ï¼Œåˆ›å»ºå¸¦æŠ˜å åŠŸèƒ½çš„åˆ—è¡¨
              categories.forEach((category) => {
                const booksInCategory = booksByCategoryId[category.id] || [];
                if (booksInCategory.length > 0) {
                  const allInCategoryChecked = booksInCategory.every((book) =>
                    linkedIds.has(book.id),
                  );

                  const header = document.createElement("div");
                  header.className = "wb-category-header";
                  header.innerHTML = `
			            <span class="arrow">â–¼</span>
			            <input type="checkbox" class="wb-category-checkbox" data-category-id="${
                    category.id
                  }" ${allInCategoryChecked ? "checked" : ""}>
			            <span>${category.name}</span>
			        `;

                  const bookContainer = document.createElement("div");
                  bookContainer.className = "wb-book-container";
                  bookContainer.dataset.containerFor = category.id;

                  booksInCategory.forEach((book) => {
                    const isChecked = linkedIds.has(book.id);
                    const label = document.createElement("label");
                    // ç»™ä¹¦ååŒ…ä¸€ä¸ªspanï¼Œæ–¹ä¾¿CSSåšçœç•¥å·å¤„ç†
                    label.innerHTML = `<input type="checkbox" class="wb-book-checkbox" value="${
                      book.id
                    }" data-parent-category="${category.id}" ${
                      isChecked ? "checked" : ""
                    }> <span class="wb-book-name">${book.name}</span>`;
                    bookContainer.appendChild(label);
                  });

                  // é»˜è®¤å°†æ‰€æœ‰æ–‡ä»¶å¤¹è®¾ç½®ä¸ºæŠ˜å çŠ¶æ€ï¼Œä¿æŒç•Œé¢æ•´æ´
                  header.classList.add("collapsed");
                  bookContainer.classList.add("collapsed");

                  worldBookCheckboxesContainer.appendChild(header);
                  worldBookCheckboxesContainer.appendChild(bookContainer);
                }
              });

              updateWorldBookSelectionDisplay(); // æ›´æ–°é¡¶éƒ¨çš„å·²é€‰æ•°é‡æ˜¾ç¤º

              // åŠ è½½å¹¶æ›´æ–°æ‰€æœ‰é¢„è§ˆç›¸å…³æ§ä»¶
              const themeRadio = document.querySelector(
                `input[name="theme-select"][value="${chat.settings.theme || "default"}"]`,
              );
              if (themeRadio) themeRadio.checked = true;
              const fontSizeSlider =
                document.getElementById("font-size-slider");
              fontSizeSlider.value = chat.settings.fontSize || 13;
              document.getElementById("font-size-value").textContent =
                `${fontSizeSlider.value}px`;
              const customCssInput =
                document.getElementById("custom-css-input");

              // --- åŠ è½½ç«èŠ±è®¾ç½® ---
              const streakSettings = chat.settings.streak || {
                enabled: false,
                initialDays: 0,
                extinguishThreshold: 1,
              };
              // --- åŠ è½½è‡ªå®šä¹‰ç«èŠ±å›¾æ ‡å’Œé¢œè‰²è®¾ç½® ---
              document.getElementById("streak-lit-icon-url").value =
                streakSettings.litIconUrl || "";
              document.getElementById("streak-extinguished-icon-url").value =
                streakSettings.extinguishedIconUrl || "";
              document.getElementById("streak-font-color-picker").value =
                streakSettings.fontColor || "#ff6f00"; // é»˜è®¤æ©™è‰²

              const streakToggle = document.getElementById(
                "streak-enabled-toggle",
              );
              const streakDetails = document.getElementById(
                "streak-details-container",
              );
              const initialDaysInput = document.getElementById(
                "streak-initial-days-input",
              );
              const thresholdSelect = document.getElementById(
                "streak-extinguish-threshold-select",
              );

              streakToggle.checked = streakSettings.enabled;
              streakDetails.style.display = streakSettings.enabled
                ? "block"
                : "none";

              const intimacyBtn = document.getElementById(
                "open-intimacy-panel-btn",
              );
              if (intimacyBtn) {
                intimacyBtn.style.display = streakSettings.enabled
                  ? "block"
                  : "none";
              }

              initialDaysInput.value = streakSettings.initialDays || 0;
              thresholdSelect.value = streakSettings.extinguishThreshold || 1;

              // ä¸ºå¼€å…³æ·»åŠ å®æ—¶äº¤äº’
              streakToggle.onchange = () => {
                streakDetails.style.display = streakToggle.checked
                  ? "block"
                  : "none";
              };

              customCssInput.value = chat.settings.customCss || "";

              updateSettingsPreview();

              renderBubblePresetSelector();
              document
                .getElementById("bubble-style-preset-select")
                .addEventListener("change", handlePresetSelectChange);
              document
                .getElementById("manage-bubble-presets-btn")
                .addEventListener("click", openBubblePresetManager);
              document
                .getElementById("chat-settings-modal")
                .classList.add("visible");
            });

          function renderGroupMemberSettings(members) {
            const container = document.getElementById("group-members-settings");
            container.innerHTML = "";
            members.forEach((member) => {
              const div = document.createElement("div");
              div.className = "member-editor";
              div.dataset.memberId = member.id;

              // æ˜¾ç¤ºçš„æ˜¯ groupNickname
              div.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><div class="member-name">${member.groupNickname}</div>`;
              div.addEventListener("click", () => openMemberEditor(member.id));
              container.appendChild(div);
            });
          }

          function openMemberEditor(memberId) {
            editingMemberId = memberId;
            const chat = state.chats[state.activeChatId];
            const member = chat.members.find((m) => m.id === memberId);
            if (!member) return;

            if (typeof member.isMuted === "undefined") {
              member.isMuted = false; // ä¸ºæ—§æ•°æ®å…¼å®¹
            }

            document.getElementById("member-name-input").value =
              member.groupNickname;
            document.getElementById("member-persona-input").value =
              member.persona;
            document.getElementById("member-avatar-preview").src =
              member.avatar;

            // â˜…â˜…â˜… æˆ‘ä»¬åœ¨è¿™é‡Œä¸ºæ–°æŒ‰é’®ç»‘å®šäº†ç‚¹å‡»äº‹ä»¶ â˜…â˜…â˜…
            const changeFrameBtn = document.getElementById(
              "member-editor-change-frame-btn",
            );
            const newChangeFrameBtn = changeFrameBtn.cloneNode(true);
            changeFrameBtn.parentNode.replaceChild(
              newChangeFrameBtn,
              changeFrameBtn,
            );

            newChangeFrameBtn.addEventListener("click", () => {
              // è°ƒç”¨å¤´åƒæ¡†é€‰æ‹©å™¨ï¼Œå¹¶å‘Šè¯‰å®ƒæˆ‘ä»¬æ­£åœ¨ä¸º'member'ç±»å‹çš„æˆå‘˜ï¼ˆä¹Ÿå°±æ˜¯NPCï¼‰è®¾ç½®å¤´åƒæ¡†
              openFrameSelectorModal("member", memberId);
            });

            document
              .getElementById("member-settings-modal")
              .classList.add("visible");
          }

          document
            .getElementById("cancel-member-settings-btn")
            .addEventListener("click", () => {
              document
                .getElementById("member-settings-modal")
                .classList.remove("visible");
              editingMemberId = null;
            });
          document
            .getElementById("save-member-settings-btn")
            .addEventListener("click", () => {
              if (!editingMemberId) return;
              const chat = state.chats[state.activeChatId];
              const member = chat.members.find((m) => m.id === editingMemberId);

              const newNickname = document
                .getElementById("member-name-input")
                .value.trim();
              if (!newNickname) {
                alert("ç¾¤æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼");
                return;
              }
              member.groupNickname = newNickname; // åªä¿®æ”¹ç¾¤æ˜µç§°
              member.persona = document.getElementById(
                "member-persona-input",
              ).value;
              member.avatar = document.getElementById(
                "member-avatar-preview",
              ).src;

              renderGroupMemberSettings(chat.members);
              document
                .getElementById("member-settings-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("reset-theme-btn")
            .addEventListener("click", () => {
              document.getElementById("theme-default").checked = true;
            });
          document
            .getElementById("cancel-chat-settings-btn")
            .addEventListener("click", () => {
              chatSettingsModal.classList.remove("visible");
            });

          document
            .getElementById("save-chat-settings-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;
              const chat = state.chats[state.activeChatId];
              const newName = document
                .getElementById("chat-name-input")
                .value.trim();
              if (!newName) return alert("å¤‡æ³¨å/ç¾¤åä¸èƒ½ä¸ºç©ºï¼");
              chat.name = newName;
              // --- æ–°å¢ä»£ç å¼€å§‹ ---
              if (!chat.isGroup) {
                const newRemark = document
                  .getElementById("chat-remark-input")
                  .value.trim();
                chat.settings.remarkName = newRemark;
              }
              // --- æ–°å¢ä»£ç ç»“æŸ ---

              // è®°å¿†äº’é€šåŠŸèƒ½ - ä¿å­˜é€»è¾‘
              const linkedMemoryCheckboxes = document.querySelectorAll(
                "#memory-link-checkboxes-container input:checked",
              );
              const memoryDepth =
                parseInt(
                  document.getElementById("link-memory-depth-input").value,
                ) || 5;

              chat.settings.linkMemoryDepth = memoryDepth; // ç‹¬ç«‹ä¿å­˜è®°å¿†æ¡æ•°è®¾ç½®

              chat.settings.linkedMemories = Array.from(
                linkedMemoryCheckboxes,
              ).map((checkbox) => ({
                chatId: checkbox.value,
                depth: memoryDepth, // å¯¹æ‰€æœ‰é€‰ä¸­çš„é“¾æ¥åº”ç”¨ç›¸åŒçš„æ·±åº¦
              }));

              const selectedThemeRadio = document.querySelector(
                'input[name="theme-select"]:checked',
              );
              chat.settings.theme = selectedThemeRadio
                ? selectedThemeRadio.value
                : "default";

              chat.settings.fontSize = parseInt(
                document.getElementById("font-size-slider").value,
              );
              chat.settings.customCss = document
                .getElementById("custom-css-input")
                .value.trim();

              chat.settings.myPersona =
                document.getElementById("my-persona").value;
              chat.settings.myAvatar =
                document.getElementById("my-avatar-preview").src;
              const checkedBooks = document.querySelectorAll(
                "#world-book-checkboxes-container input.wb-book-checkbox:checked",
              );
              chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(
                (cb) => cb.value,
              );

              if (chat.isGroup) {
                chat.settings.myNickname = document
                  .getElementById("my-group-nickname-input")
                  .value.trim();
                chat.settings.groupAvatar = document.getElementById(
                  "group-avatar-preview",
                ).src;
                // ä¿å­˜ç¾¤èŠåå°æ´»åŠ¨è®¾ç½®
                const groupActivityEnabled = document.getElementById(
                  "group-background-activity-switch",
                ).checked;
                const groupActivityInterval =
                  parseInt(
                    document.getElementById("group-background-interval-input")
                      .value,
                  ) || 120;

                // ç¡®ä¿ lastActivityTimestamp å­—æ®µå­˜åœ¨
                const lastTimestamp = chat.settings.backgroundActivity
                  ? chat.settings.backgroundActivity.lastActivityTimestamp
                  : 0;

                chat.settings.backgroundActivity = {
                  enabled: groupActivityEnabled,
                  interval: groupActivityInterval,
                  lastActivityTimestamp: lastTimestamp, // ä¿ç•™ä¸Šæ¬¡çš„æ—¶é—´æˆ³
                };
              } else {
                chat.settings.aiPersona =
                  document.getElementById("ai-persona").value;
                chat.settings.aiAvatar =
                  document.getElementById("ai-avatar-preview").src;
                chat.settings.minimaxVoiceId = document
                  .getElementById("minimax-voice-id-input")
                  .value.trim();
                const langBoost = document.getElementById(
                  "minimax-language-boost-select",
                ).value;
                chat.settings.language_boost = langBoost ? langBoost : null; // å¦‚æœé€‰æ‹©"æ— "(valueä¸ºç©º),åˆ™ä¿å­˜ä¸ºnull
                chat.settings.speed = parseFloat(
                  document.getElementById("minimax-speed-slider").value,
                );

                chat.settings.isCoupleAvatar = document.getElementById(
                  "couple-avatar-toggle",
                ).checked;
                chat.settings.coupleAvatarDescription = document
                  .getElementById("couple-avatar-description")
                  .value.trim();

                // ä»è¾“å…¥æ¡†è¯»å–å€¼å¹¶ä¿å­˜
                chat.settings.weiboProfession = document
                  .getElementById("weibo-profession-input")
                  .value.trim();
                chat.settings.weiboInstruction = document
                  .getElementById("weibo-instruction-input")
                  .value.trim();
                // ä¿å­˜è§†é¢‘é€šè¯è®¾ç½®
                chat.settings.visualVideoCallEnabled = document.getElementById(
                  "visual-video-call-switch",
                ).checked;
                chat.settings.charVideoImage = document.getElementById(
                  "char-video-image-preview",
                ).src;
                chat.settings.userVideoImage = document.getElementById(
                  "user-video-image-preview",
                ).src;
                chat.settings.videoCallVoiceAccess = document.getElementById(
                  "video-call-voice-access-switch",
                ).checked;
                chat.settings.useRealCamera = document.getElementById(
                  "user-real-camera-switch",
                ).checked;
                // ä¿å­˜NAIå‡ºå›¾è®¾ç½®
                const novelaiEnabled =
                  localStorage.getItem("novelai-enabled") === "true";
                if (novelaiEnabled) {
                  if (!chat.settings.naiSettings) {
                    chat.settings.naiSettings = {};
                  }

                  // æ ¹æ®æ˜¯å¦ä¸ºç¾¤èŠé€‰æ‹©ä¸åŒçš„radioæŒ‰é’®ç»„
                  const isGroup = chat.isGroup;
                  const promptSourceRadio = document.querySelector(
                    isGroup
                      ? 'input[name="group-nai-prompt-source"]:checked'
                      : 'input[name="nai-prompt-source"]:checked',
                  );

                  chat.settings.naiSettings.promptSource = promptSourceRadio
                    ? promptSourceRadio.value
                    : "system";
                  console.log(
                    "ğŸ’¾ ä¿å­˜NAIè®¾ç½® - promptSource:",
                    chat.settings.naiSettings.promptSource,
                  );
                  console.log(
                    "ğŸ’¾ ä¿å­˜NAIè®¾ç½® - characterPositivePrompt:",
                    chat.settings.naiSettings.characterPositivePrompt,
                  );
                  console.log(
                    "ğŸ’¾ ä¿å­˜NAIè®¾ç½® - characterNegativePrompt:",
                    chat.settings.naiSettings.characterNegativePrompt,
                  );
                  // è§’è‰²ä¸“å±æç¤ºè¯å·²ç»åœ¨ä¸“å±å¼¹çª—ä¸­ä¿å­˜ï¼Œè¿™é‡Œåªä¿å­˜æ¥æºé€‰æ‹©
                }

                const selectedGroupId = document.getElementById(
                  "assign-group-select",
                ).value;
                chat.groupId = selectedGroupId
                  ? parseInt(selectedGroupId)
                  : null;
              }

              chat.settings.maxMemory =
                parseInt(document.getElementById("max-memory").value) || 10;
              const minReply =
                parseInt(
                  document.getElementById("min-reply-count-input").value,
                ) || 1;
              const maxReply =
                parseInt(
                  document.getElementById("max-reply-count-input").value,
                ) || 5;

              if (minReply > maxReply) {
                alert("å›å¤æ¡æ•°ï¼šæœ€å°å€¼ä¸èƒ½å¤§äºæœ€å¤§å€¼ï¼å·²è‡ªåŠ¨ä¿®æ­£ã€‚");
                chat.settings.replyCountRange = {
                  min: maxReply,
                  max: minReply,
                }; // äº¤æ¢
              } else {
                chat.settings.replyCountRange = {
                  min: minReply,
                  max: maxReply,
                };
              }

              chat.settings.timePerceptionEnabled = document.getElementById(
                "time-perception-toggle",
              ).checked;
              chat.settings.customTime =
                document.getElementById("custom-time-input").value;

              // --- ä¿å­˜çº¿ä¸‹æ¨¡å¼è®¾ç½® ---
              if (!chat.settings.offlineMode) chat.settings.offlineMode = {}; // åˆå§‹åŒ–
              chat.settings.offlineMode.enabled = document.getElementById(
                "offline-mode-toggle",
              ).checked;
              chat.settings.offlineMode.prompt = document
                .getElementById("offline-prompt-input")
                .value.trim();
              chat.settings.offlineMode.style = document
                .getElementById("offline-style-input")
                .value.trim();
              chat.settings.offlineMode.wordCount =
                parseInt(
                  document.getElementById("offline-word-count-input").value,
                ) || 300;
              // ä¿å­˜ç”Ÿå›¾å¼€å…³çŠ¶æ€
              chat.settings.offlineMode.enableNovelAI = document.getElementById(
                "offline-novelai-toggle",
              ).checked;

              // presets çš„æ•°æ®åœ¨ç®¡ç†å‡½æ•°ä¸­ç›´æ¥æ“ä½œï¼Œè¿™é‡Œæ— éœ€ä¿å­˜

              // --- ä¿å­˜èŠå¤©æ€»ç»“è®¾ç½® ---
              if (!chat.settings.summary) chat.settings.summary = {}; // åˆå§‹åŒ–
              chat.settings.summary.enabled =
                document.getElementById("summary-toggle").checked;
              chat.settings.summary.mode = document.querySelector(
                'input[name="summary-mode"]:checked',
              ).value;
              chat.settings.summary.count =
                parseInt(
                  document.getElementById("summary-count-input").value,
                ) || 20;
              chat.settings.summary.prompt = document
                .getElementById("summary-prompt-input")
                .value.trim();

              // åœ¨ 'save-chat-settings-btn' çš„ click äº‹ä»¶ç›‘å¬å™¨å†…éƒ¨...

              const isStreakEnabled = document.getElementById(
                "streak-enabled-toggle",
              ).checked;
              const newInitialDays =
                parseInt(
                  document.getElementById("streak-initial-days-input").value,
                ) || 0;
              const newThreshold = parseInt(
                document.getElementById("streak-extinguish-threshold-select")
                  .value,
              );

              const oldStreak = chat.settings.streak || {}; // å®‰å…¨åœ°è·å–æ—§è®¾ç½®

              if (isStreakEnabled) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡å¼€å¯
                const isFirstTimeEnabled = !oldStreak.enabled;

                // åªæœ‰åœ¨é¦–æ¬¡å¼€å¯æ—¶ï¼Œæ‰ç”¨â€œåˆå§‹å¤©æ•°â€è¦†ç›–â€œå½“å‰å¤©æ•°â€ã€‚
                // å¦åˆ™ï¼Œå¿…é¡»ä¿ç•™ç”¨æˆ·å·²ç»ç§¯ç´¯çš„ currentDays å’Œ lastInteractionDateã€‚
                chat.settings.streak = {
                  enabled: true,
                  currentDays: isFirstTimeEnabled
                    ? newInitialDays
                    : oldStreak.currentDays,
                  lastInteractionDate: isFirstTimeEnabled
                    ? null
                    : oldStreak.lastInteractionDate,
                  initialDays: newInitialDays,
                  extinguishThreshold: newThreshold,
                  litIconUrl: document
                    .getElementById("streak-lit-icon-url")
                    .value.trim(),
                  extinguishedIconUrl: document
                    .getElementById("streak-extinguished-icon-url")
                    .value.trim(),
                  fontColor: document.getElementById("streak-font-color-picker")
                    .value,
                };
              } else {
                // å¦‚æœç”¨æˆ·å…³é—­äº†åŠŸèƒ½ï¼Œå°±é‡ç½®æ‰€æœ‰è®¾ç½®
                chat.settings.streak = {
                  enabled: false,
                  initialDays: 0,
                  currentDays: 0,
                  extinguishThreshold: 1,
                  lastInteractionDate: null,
                  litIconUrl: "",
                  extinguishedIconUrl: "",
                  fontColor: "#ff6f00",
                };
              }

              await db.chats.put(chat);

              applyScopedCss(
                chat.settings.customCss,
                "#chat-messages",
                "custom-bubble-style",
              );

              chatSettingsModal.classList.remove("visible");
              renderChatInterface(state.activeChatId);
              renderChatList();
            });

          document
            .getElementById("clear-chat-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;
              const chat = state.chats[state.activeChatId];
              const confirmed = await showCustomConfirm(
                "æ¸…ç©ºè®°å½•",
                "ç¡®å®šè¦æ¸…ç©ºæ­¤èŠå¤©çš„ã€æ¶ˆæ¯å’Œå¿ƒå£°ã€‘å—ï¼Ÿ\nï¼ˆèŠå¤©æ€»ç»“å°†è¢«ä¿ç•™ï¼‰",
                { confirmButtonClass: "btn-danger" },
              );
              if (confirmed) {
                // ä½¿ç”¨ filter æ–¹æ³•ï¼Œåªä¿ç•™ç±»å‹ä¸º 'summary' çš„æ¶ˆæ¯
                chat.history = chat.history.filter(
                  (msg) => msg.type === "summary",
                );

                // åŒæ—¶æ¸…ç©ºå¿ƒå£°è®°å½•
                if (chat.innerVoiceHistory) {
                  chat.innerVoiceHistory = [];
                }
                chat.latestInnerVoice = null;

                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
                renderChatList();
                chatSettingsModal.classList.remove("visible");

                alert("èŠå¤©æ¶ˆæ¯å’Œå¿ƒå£°å·²æ¸…ç©ºï¼");
              }
            });

          // å¯¼å‡ºèŠå¤©è®°å½•æŒ‰é’®
          document
            .getElementById("export-chat-history-btn")
            .addEventListener("click", exportChatHistory);

          // â€œå¯¼å…¥èŠå¤©è®°å½•â€è¿™ä¸ªå¯è§çš„æŒ‰é’®
          document
            .getElementById("import-chat-history-btn")
            .addEventListener("click", () => {
              // ç‚¹å‡»å®ƒæ—¶ï¼Œæˆ‘ä»¬å»è§¦å‘é‚£ä¸ªéšè—çš„æ–‡ä»¶é€‰æ‹©æ¡†
              document.getElementById("import-chat-history-input").click();
            });

          // éšè—çš„æ–‡ä»¶é€‰æ‹©æ¡†
          document
            .getElementById("import-chat-history-input")
            .addEventListener("change", (event) => {
              const file = event.target.files[0];
              if (file) {
                importChatHistory(file);
              }
              // æ¯æ¬¡é€‰æ‹©åæ¸…ç©ºï¼Œè¿™æ ·ä¸‹æ¬¡è¿˜èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
              event.target.value = null;
            });

          const setupFileUpload = (inputId, callback) => {
            document
              .getElementById(inputId)
              .addEventListener("change", async (event) => {
                const file = event.target.files[0];
                if (file) {
                  try {
                    // è°ƒç”¨æ–°çš„é€šç”¨å‹ç¼©å‡½æ•°
                    const compressedDataUrl =
                      await handleImageUploadAndCompress(file);
                    callback(compressedDataUrl); // å°†å‹ç¼©åçš„ç»“æœä¼ ç»™å›è°ƒ
                  } catch (error) {
                    console.error(`å¤„ç†æ–‡ä»¶ ${file.name} å¤±è´¥:`, error);
                    alert(`å¤„ç†å›¾ç‰‡å¤±è´¥: ${error.message}`);
                  } finally {
                    event.target.value = null;
                  }
                }
              });
          };

          setupFileUpload(
            "ai-avatar-input",
            (base64) =>
              (document.getElementById("ai-avatar-preview").src = base64),
          );
          setupFileUpload(
            "my-avatar-input",
            (base64) =>
              (document.getElementById("my-avatar-preview").src = base64),
          );
          setupFileUpload(
            "group-avatar-input",
            (base64) =>
              (document.getElementById("group-avatar-preview").src = base64),
          );
          setupFileUpload(
            "member-avatar-input",
            (base64) =>
              (document.getElementById("member-avatar-preview").src = base64),
          );
          setupFileUpload("bg-input", (base64) => {
            if (state.activeChatId) {
              state.chats[state.activeChatId].settings.background = base64;
              const bgPreview = document.getElementById("bg-preview");
              bgPreview.src = base64;
              bgPreview.style.display = "block";
              document.getElementById("remove-bg-btn").style.display =
                "inline-block";
            }
          });
          setupFileUpload(
            "preset-avatar-input",
            (base64) =>
              (document.getElementById("preset-avatar-preview").src = base64),
          );

          setupFileUpload(
            "char-video-image-input",
            (base64) =>
              (document.getElementById("char-video-image-preview").src =
                base64),
          );
          setupFileUpload(
            "user-video-image-input",
            (base64) =>
              (document.getElementById("user-video-image-preview").src =
                base64),
          );

          document
            .getElementById("remove-bg-btn")
            .addEventListener("click", () => {
              if (state.activeChatId) {
                state.chats[state.activeChatId].settings.background = "";
                const bgPreview = document.getElementById("bg-preview");
                bgPreview.src = "";
                bgPreview.style.display = "none";
                document.getElementById("remove-bg-btn").style.display = "none";
              }
            });

          const stickerPanel = document.getElementById("sticker-panel");
          document
            .getElementById("open-sticker-panel-btn")
            .addEventListener("click", () => {
              renderStickerPanel();
              stickerPanel.classList.add("visible");
            });
          document
            .getElementById("close-sticker-panel-btn")
            .addEventListener("click", () =>
              stickerPanel.classList.remove("visible"),
            );

          document
            .getElementById("add-sticker-btn")
            .addEventListener("click", openBulkAddStickersModal);

          document
            .getElementById("upload-sticker-btn")
            .addEventListener("click", () =>
              document.getElementById("sticker-upload-input").click(),
            );

          document
            .getElementById("sticker-upload-input")
            .addEventListener("change", async (event) => {
              const files = event.target.files;
              if (!files.length) return;

              const newStickers = [];
              let canceled = false;

              // ä½¿ç”¨ for...of å¾ªç¯æ¥é€ä¸ªå¤„ç†é€‰ä¸­çš„æ–‡ä»¶
              for (const file of files) {
                if (canceled) break; // å¦‚æœç”¨æˆ·ä¸­é€”å–æ¶ˆäº†ï¼Œå°±è·³å‡ºå¾ªç¯

                // ä¸ºæ¯ä¸ªæ–‡ä»¶ç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„æœ¬åœ°é¢„è§ˆURL
                const previewUrl = URL.createObjectURL(file);

                // å¼¹å‡ºå¸¦å›¾ç‰‡é¢„è§ˆçš„å‘½åæ¡†
                const name = await showCustomPrompt(
                  `ä¸ºè¡¨æƒ…å‘½å (${newStickers.length + 1}/${files.length})`,
                  "è¯·è¾“å…¥è¡¨æƒ…åç§°",
                  file.name.replace(/\.[^/.]+$/, ""), // é»˜è®¤ä½¿ç”¨æ–‡ä»¶åä½œä¸ºåå­—
                  "text",
                  // è¿™æ˜¯ showCustomPrompt çš„ä¸€ä¸ªéšè—åŠŸèƒ½ï¼Œå¯ä»¥æ’å…¥é¢å¤–çš„HTML
                  `<img src="${previewUrl}" style="max-width: 100px; max-height: 100px; margin-bottom: 10px; border-radius: 8px;">`,
                );

                // é‡Šæ”¾ä¸´æ—¶çš„é¢„è§ˆURLï¼Œé¿å…å†…å­˜æ³„æ¼
                URL.revokeObjectURL(previewUrl);

                if (name && name.trim()) {
                  // ç”¨æˆ·ç¡®è®¤å‘½åï¼Œè¯»å–æ–‡ä»¶å†…å®¹å¹¶å‡†å¤‡ä¿å­˜
                  const base64Url = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                  });

                  newStickers.push({
                    id: "sticker_" + (Date.now() + newStickers.length),
                    url: base64Url,
                    name: name.trim(),
                  });
                } else if (name === null) {
                  // å¦‚æœç”¨æˆ·ç‚¹å‡»äº†â€œå–æ¶ˆâ€
                  const confirmCancel = await showCustomConfirm(
                    "ç¡®è®¤å–æ¶ˆ",
                    "ç¡®å®šè¦å–æ¶ˆå‰©ä½™è¡¨æƒ…çš„ä¸Šä¼ å—ï¼Ÿ",
                  );
                  if (confirmCancel) {
                    canceled = true;
                  }
                } else {
                  alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼");
                }
              }

              // å¾ªç¯ç»“æŸåï¼Œå¦‚æœæ”¶é›†åˆ°äº†æ–°è¡¨æƒ…ï¼Œå°±æ‰¹é‡æ·»åŠ åˆ°æ•°æ®åº“
              if (newStickers.length > 0) {
                await db.userStickers.bulkAdd(newStickers);
                state.userStickers.push(...newStickers);
                renderStickerPanel();
                await showCustomAlert(
                  "ä¸Šä¼ æˆåŠŸ",
                  `å·²æˆåŠŸæ·»åŠ  ${newStickers.length} ä¸ªæ–°è¡¨æƒ…ï¼`,
                );
              }

              // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨çš„å€¼ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©ç›¸åŒçš„æ–‡ä»¶
              event.target.value = null;
            });

          document
            .getElementById("upload-image-btn")
            .addEventListener("click", () =>
              document.getElementById("image-upload-input").click(),
            );
          document
            .getElementById("image-upload-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (!file || !state.activeChatId) return;
              const reader = new FileReader();
              reader.onload = async (e) => {
                const base64Url = e.target.result;
                const chat = state.chats[state.activeChatId];
                const msg = {
                  role: "user",
                  content: [
                    { type: "image_url", image_url: { url: base64Url } },
                  ],
                  timestamp: Date.now(),
                };
                chat.history.push(msg);
                await db.chats.put(chat);
                appendMessage(msg, chat);
                renderChatList();
              };
              reader.readAsDataURL(file);
              event.target.value = null;
            });
          document
            .getElementById("voice-message-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;
              const text = await showCustomPrompt(
                "å‘é€è¯­éŸ³",
                "è¯·è¾“å…¥ä½ æƒ³è¯´çš„å†…å®¹ï¼š",
              );
              if (text && text.trim()) {
                const chat = state.chats[state.activeChatId];
                const msg = {
                  role: "user",
                  type: "voice_message",
                  content: text.trim(),
                  timestamp: Date.now(),
                };
                chat.history.push(msg);
                await db.chats.put(chat);
                appendMessage(msg, chat);
                renderChatList();
              }
            });
          document
            .getElementById("send-photo-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;
              const description = await showCustomPrompt(
                "å‘é€ç…§ç‰‡",
                "è¯·ç”¨æ–‡å­—æè¿°æ‚¨è¦å‘é€çš„ç…§ç‰‡ï¼š",
              );
              if (description && description.trim()) {
                const chat = state.chats[state.activeChatId];
                const msg = {
                  role: "user",
                  type: "user_photo",
                  content: description.trim(),
                  timestamp: Date.now(),
                };
                chat.history.push(msg);
                await db.chats.put(chat);
                appendMessage(msg, chat);
                renderChatList();
              }
            });

          // å¤–å–è¯·æ±‚åŠŸèƒ½äº‹ä»¶ç»‘å®š
          const waimaiModal = document.getElementById("waimai-request-modal");
          document
            .getElementById("send-waimai-request-btn")
            .addEventListener("click", () => {
              waimaiModal.classList.add("visible");
            });

          document
            .getElementById("waimai-cancel-btn")
            .addEventListener("click", () => {
              waimaiModal.classList.remove("visible");
            });

          document
            .getElementById("waimai-confirm-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;

              const productInfoInput = document.getElementById(
                "waimai-product-info",
              );
              const amountInput = document.getElementById("waimai-amount");

              const productInfo = productInfoInput.value.trim();
              const amount = parseFloat(amountInput.value);

              if (!productInfo) {
                alert("è¯·è¾“å…¥å•†å“ä¿¡æ¯ï¼");
                return;
              }
              if (isNaN(amount) || amount <= 0) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ä»£ä»˜é‡‘é¢ï¼");
                return;
              }

              const chat = state.chats[state.activeChatId];
              const now = Date.now();

              const myNickname = chat.isGroup
                ? chat.settings.myNickname || "æˆ‘"
                : "æˆ‘";

              const msg = {
                role: "user",
                senderName: myNickname,
                type: "waimai_request",
                productInfo: productInfo,
                amount: amount,
                status: "pending",
                countdownEndTime: now + 15 * 60 * 1000,
                timestamp: now,
              };

              chat.history.push(msg);

              // é‚£ä¸€å¤§æ®µä»£ç å·²ç»è¢«åˆ é™¤äº†

              await db.chats.put(chat);
              appendMessage(msg, chat);
              renderChatList();

              productInfoInput.value = "";
              amountInput.value = "";
              waimaiModal.classList.remove("visible");
            });
          document
            .getElementById("open-persona-library-btn")
            .addEventListener("click", openPersonaLibrary);
          document
            .getElementById("close-persona-library-btn")
            .addEventListener("click", closePersonaLibrary);
          document
            .getElementById("add-persona-preset-btn")
            .addEventListener("click", openPersonaEditorForCreate);
          document
            .getElementById("cancel-persona-editor-btn")
            .addEventListener("click", closePersonaEditor);

          document
            .getElementById("preset-action-edit")
            .addEventListener("click", openPersonaEditorForEdit);
          document
            .getElementById("preset-action-delete")
            .addEventListener("click", deletePersonaPreset);
          document
            .getElementById("preset-action-cancel")
            .addEventListener("click", hidePresetActions);

          document
            .getElementById("selection-cancel-btn")
            .addEventListener("click", exitSelectionMode);

          document
            .getElementById("selection-delete-btn")
            .addEventListener("click", async () => {
              if (selectedMessages.size === 0) return;
              const confirmed = await showCustomConfirm(
                "åˆ é™¤æ¶ˆæ¯",
                `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedMessages.size} æ¡æ¶ˆæ¯å—ï¼Ÿè¿™å°†æ”¹å˜AIçš„è®°å¿†ã€‚`,
                { confirmButtonClass: "btn-danger" },
              );
              if (confirmed) {
                const chat = state.chats[state.activeChatId];

                // 1. åœ¨åˆ é™¤å‰ï¼Œæ£€æŸ¥è¢«åˆ é™¤çš„æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«æŠ•ç¥¨
                let deletedPollsInfo = [];
                for (const timestamp of selectedMessages) {
                  const msg = chat.history.find(
                    (m) => m.timestamp === timestamp,
                  );
                  if (msg && msg.type === "poll") {
                    deletedPollsInfo.push(
                      `å…³äºâ€œ${msg.question}â€çš„æŠ•ç¥¨(æ—¶é—´æˆ³: ${msg.timestamp})`,
                    );
                  }
                }

                // 2. æ›´æ–°åç«¯çš„å†å²è®°å½•
                chat.history = chat.history.filter(
                  (msg) => !selectedMessages.has(msg.timestamp),
                );

                // 3. æ„å»ºæ›´å…·ä½“çš„â€œé—å¿˜æŒ‡ä»¤â€
                let forgetReason = "ä¸€äº›ä¹‹å‰çš„æ¶ˆæ¯å·²è¢«ç”¨æˆ·åˆ é™¤ã€‚";
                if (deletedPollsInfo.length > 0) {
                  forgetReason += ` å…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹æŠ•ç¥¨ï¼š${deletedPollsInfo.join("ï¼›")}ã€‚`;
                }
                forgetReason +=
                  " ä½ åº”è¯¥åƒå®ƒä»¬ä»æœªå­˜åœ¨è¿‡ä¸€æ ·ç»§ç»­å¯¹è¯ï¼Œå¹¶ç›¸åº”åœ°è°ƒæ•´ä½ çš„è®°å¿†å’Œè¡Œä¸ºï¼Œä¸è¦å†æåŠè¿™äº›è¢«åˆ é™¤çš„å†…å®¹ã€‚";

                const forgetInstruction = {
                  role: "system",
                  content: `[ç³»ç»Ÿæç¤ºï¼š${forgetReason}]`,
                  timestamp: Date.now(),
                  isHidden: true,
                };
                chat.history.push(forgetInstruction);

                // 4. å°†åŒ…å«â€œé—å¿˜æŒ‡ä»¤â€çš„ã€æ›´æ–°åçš„chatå¯¹è±¡å­˜å›æ•°æ®åº“
                await db.chats.put(chat);

                // 5. æœ€åæ‰æ›´æ–°UI
                renderChatInterface(state.activeChatId);
                renderChatList();
              }
            });

          document
            .getElementById("reset-font-btn")
            .addEventListener("click", resetToDefaultFont);

          document
            .querySelectorAll("#chat-list-bottom-nav .nav-item")
            .forEach((item) => {
              item.addEventListener("click", () =>
                switchToChatListView(item.dataset.view),
              );
            });
          document
            .getElementById("qzone-back-btn")
            .addEventListener("click", () =>
              switchToChatListView("messages-view"),
            );
          document
            .getElementById("qzone-nickname")
            .addEventListener("click", async () => {
              const newNickname = await showCustomPrompt(
                "ä¿®æ”¹æ˜µç§°",
                "è¯·è¾“å…¥æ–°çš„æ˜µç§°",
                state.qzoneSettings.nickname,
              );
              if (newNickname && newNickname.trim()) {
                state.qzoneSettings.nickname = newNickname.trim();
                await saveQzoneSettings();
                renderQzoneScreen();
              }
            });
          document
            .getElementById("qzone-avatar-container")
            .addEventListener("click", () =>
              document.getElementById("qzone-avatar-input").click(),
            );
          document
            .getElementById("qzone-banner-container")
            .addEventListener("click", () =>
              document.getElementById("qzone-banner-input").click(),
            );
          document
            .getElementById("qzone-avatar-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (file) {
                const dataUrl = await new Promise((res) => {
                  const reader = new FileReader();
                  reader.onload = () => res(reader.result);
                  reader.readAsDataURL(file);
                });
                state.qzoneSettings.avatar = dataUrl;
                await saveQzoneSettings();
                renderQzoneScreen();
              }
              event.target.value = null;
            });
          document
            .getElementById("qzone-banner-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (file) {
                const dataUrl = await new Promise((res) => {
                  const reader = new FileReader();
                  reader.onload = () => res(reader.result);
                  reader.readAsDataURL(file);
                });
                state.qzoneSettings.banner = dataUrl;
                await saveQzoneSettings();
                renderQzoneScreen();
              }
              event.target.value = null;
            });

          document
            .getElementById("create-shuoshuo-btn")
            .addEventListener("click", () => openQZonePublisher("shuoshuo"));
          document
            .getElementById("create-post-btn")
            .addEventListener("click", () => openQZonePublisher("complex"));

          document
            .getElementById("open-album-btn")
            .addEventListener("click", async () => {
              await renderAlbumList();
              showScreen("album-screen");
            });
          document
            .getElementById("album-back-btn")
            .addEventListener("click", () => {
              showScreen("chat-list-screen");
              switchToChatListView("qzone-screen");
            });

          document
            .getElementById("album-photos-back-btn")
            .addEventListener("click", () => {
              state.activeAlbumId = null;
              showScreen("album-screen");
            });

          document
            .getElementById("album-upload-photo-btn")
            .addEventListener("click", () =>
              document.getElementById("album-photo-input").click(),
            );

          document
            .getElementById("album-photo-input")
            .addEventListener("change", async (event) => {
              if (!state.activeAlbumId) return;
              const files = event.target.files;
              if (!files.length) return;

              const album = await db.qzoneAlbums.get(state.activeAlbumId);

              for (const file of files) {
                const dataUrl = await new Promise((resolve) => {
                  const reader = new FileReader();
                  reader.onload = () => resolve(reader.result);
                  reader.readAsDataURL(file);
                });
                await db.qzonePhotos.add({
                  albumId: state.activeAlbumId,
                  url: dataUrl,
                  createdAt: Date.now(),
                });
              }

              const photoCount = await db.qzonePhotos
                .where("albumId")
                .equals(state.activeAlbumId)
                .count();
              const updateData = { photoCount };

              if (!album.photoCount || album.coverUrl.includes("placeholder")) {
                const firstPhoto = await db.qzonePhotos
                  .where("albumId")
                  .equals(state.activeAlbumId)
                  .first();
                if (firstPhoto) updateData.coverUrl = firstPhoto.url;
              }

              await db.qzoneAlbums.update(state.activeAlbumId, updateData);
              await renderAlbumPhotosScreen();
              await renderAlbumList();

              event.target.value = null;
              alert("ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼");
            });

          document
            .getElementById("photos-grid-page")
            .addEventListener("click", async (e) => {
              const deleteBtn = e.target.closest(".photo-delete-btn");
              const photoThumb = e.target.closest(".photo-thumb");

              if (deleteBtn) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å›¾ç‰‡ä¸Š
                const photoId = parseInt(deleteBtn.dataset.photoId);
                const confirmed = await showCustomConfirm(
                  "åˆ é™¤ç…§ç‰‡",
                  "ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",
                  {
                    confirmButtonClass: "btn-danger",
                  },
                );

                if (confirmed) {
                  const deletedPhoto = await db.qzonePhotos.get(photoId);
                  if (!deletedPhoto) return;

                  await db.qzonePhotos.delete(photoId);

                  const album = await db.qzoneAlbums.get(state.activeAlbumId);
                  const photoCount = (album.photoCount || 1) - 1;
                  const updateData = { photoCount };

                  if (album.coverUrl === deletedPhoto.url) {
                    const nextPhoto = await db.qzonePhotos
                      .where("albumId")
                      .equals(state.activeAlbumId)
                      .first();
                    updateData.coverUrl = nextPhoto
                      ? nextPhoto.url
                      : "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png";
                  }

                  await db.qzoneAlbums.update(state.activeAlbumId, updateData);
                  await renderAlbumPhotosScreen();
                  await renderAlbumList();
                  alert("ç…§ç‰‡å·²åˆ é™¤ã€‚");
                }
              } else if (photoThumb) {
                // è¿™å°±æ˜¯æ¢å¤çš„å›¾ç‰‡ç‚¹å‡»æ”¾å¤§åŠŸèƒ½ï¼
                openPhotoViewer(photoThumb.src);
              }
            });

          // æ¢å¤å›¾ç‰‡æŸ¥çœ‹å™¨çš„æ§åˆ¶äº‹ä»¶
          document
            .getElementById("photo-viewer-close-btn")
            .addEventListener("click", closePhotoViewer);
          document
            .getElementById("photo-viewer-next-btn")
            .addEventListener("click", showNextPhoto);
          document
            .getElementById("photo-viewer-prev-btn")
            .addEventListener("click", showPrevPhoto);

          // æ¢å¤é”®ç›˜å·¦å³ç®­å¤´å’ŒESCé”®çš„åŠŸèƒ½
          document.addEventListener("keydown", (e) => {
            if (!photoViewerState.isOpen) return;

            if (e.key === "ArrowRight") {
              showNextPhoto();
            } else if (e.key === "ArrowLeft") {
              showPrevPhoto();
            } else if (e.key === "Escape") {
              closePhotoViewer();
            }
          });

          // --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---

          document
            .getElementById("create-album-btn-page")
            .addEventListener("click", async () => {
              const albumName = await showCustomPrompt(
                "åˆ›å»ºæ–°ç›¸å†Œ",
                "è¯·è¾“å…¥ç›¸å†Œåç§°",
              );
              if (albumName && albumName.trim()) {
                const newAlbum = {
                  name: albumName.trim(),
                  coverUrl:
                    "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png",
                  photoCount: 0,
                  createdAt: Date.now(),
                };
                await db.qzoneAlbums.add(newAlbum);
                await renderAlbumList();
                alert(`ç›¸å†Œ "${albumName}" åˆ›å»ºæˆåŠŸï¼`);
              } else if (albumName !== null) {
                alert("ç›¸å†Œåç§°ä¸èƒ½ä¸ºç©ºï¼");
              }
            });

          document
            .getElementById("cancel-create-post-btn")
            .addEventListener("click", () =>
              document
                .getElementById("create-post-modal")
                .classList.remove("visible"),
            );
          document
            .getElementById("post-upload-local-btn")
            .addEventListener("click", () =>
              document.getElementById("post-local-image-input").click(),
            );
          document
            .getElementById("post-local-image-input")
            .addEventListener("change", (event) => {
              const file = event.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                  document.getElementById("post-image-preview").src =
                    e.target.result;
                  document
                    .getElementById("post-image-preview-container")
                    .classList.add("visible");
                  document.getElementById(
                    "post-image-desc-group",
                  ).style.display = "block";
                };
                reader.readAsDataURL(file);
              }
            });
          document
            .getElementById("post-use-url-btn")
            .addEventListener("click", async () => {
              const url = await showCustomPrompt(
                "è¾“å…¥å›¾ç‰‡URL",
                "è¯·è¾“å…¥ç½‘ç»œå›¾ç‰‡çš„é“¾æ¥",
                "",
                "url",
              );
              if (url) {
                document.getElementById("post-image-preview").src = url;
                document
                  .getElementById("post-image-preview-container")
                  .classList.add("visible");
                document.getElementById("post-image-desc-group").style.display =
                  "block";
              }
            });
          document
            .getElementById("post-remove-image-btn")
            .addEventListener("click", () => resetCreatePostModal());
          const imageModeBtn = document.getElementById("switch-to-image-mode");
          const textImageModeBtn = document.getElementById(
            "switch-to-text-image-mode",
          );
          const imageModeContent =
            document.getElementById("image-mode-content");
          const textImageModeContent = document.getElementById(
            "text-image-mode-content",
          );
          imageModeBtn.addEventListener("click", () => {
            imageModeBtn.classList.add("active");
            textImageModeBtn.classList.remove("active");
            imageModeContent.classList.add("active");
            textImageModeContent.classList.remove("active");
          });
          textImageModeBtn.addEventListener("click", () => {
            textImageModeBtn.classList.add("active");
            imageModeBtn.classList.remove("active");
            textImageModeContent.classList.add("active");
            imageModeContent.classList.remove("active");
          });

          document
            .getElementById("confirm-create-post-btn")
            .addEventListener("click", async () => {
              const modal = document.getElementById("create-post-modal");
              const mode = modal.dataset.mode;

              // å¦‚æœå½“å‰æ˜¯ 'forum' (å°ç»„å‘å¸–) æ¨¡å¼ï¼Œå°±è°ƒç”¨æˆ‘ä»¬åˆšåˆšå†™çš„å‘å¸–å‡½æ•°
              if (mode === "forum") {
                await handleCreateForumPost();
                return; // æ‰§è¡Œå®Œå°±ç»“æŸï¼Œä¸å¾€ä¸‹èµ°äº†
              }

              // å¦‚æœæ˜¯ 'weibo' æ¨¡å¼ï¼Œå°±è°ƒç”¨å‘å¾®åšçš„å‡½æ•°
              if (mode === "weibo") {
                await handlePublishWeibo();
                return;
              }

              // --- ä¸‹é¢æ˜¯ä½ åŸæ¥å·²æœ‰çš„å‘å¸ƒâ€œåŠ¨æ€â€çš„é€»è¾‘ï¼Œæˆ‘ä»¬ä¿æŒä¸å˜ ---
              const editingId = parseInt(modal.dataset.editingPostId);
              const areCommentsVisible = document.getElementById(
                "post-comments-toggle",
              ).checked;

              const visibility = document.querySelector(
                'input[name="visibility"]:checked',
              ).value;
              let visibleGroupIds = null;
              if (visibility === "groups") {
                visibleGroupIds = Array.from(
                  document.querySelectorAll(
                    "#post-visibility-groups input:checked",
                  ),
                ).map((cb) => parseInt(cb.value));
                if (visibleGroupIds.length === 0) {
                  alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¯è§çš„åˆ†ç»„ï¼");
                  return;
                }
              }

              let postData = {};

              if (mode === "edit") {
                const existingPost = await db.qzonePosts.get(editingId);
                if (!existingPost) {
                  alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¦ç¼–è¾‘çš„åŠ¨æ€ï¼");
                  return;
                }
                postData = {
                  ...existingPost,
                  areCommentsVisible: areCommentsVisible,
                  visibleGroupIds: visibleGroupIds,
                };

                if (postData.type === "shuoshuo") {
                  postData.content = document
                    .getElementById("post-public-text")
                    .value.trim();
                } else {
                  postData.publicText = document
                    .getElementById("post-public-text")
                    .value.trim();
                  if (postData.type === "image_post") {
                    postData.imageUrl =
                      document.getElementById("post-image-preview").src;
                    postData.imageDescription = document
                      .getElementById("post-image-description")
                      .value.trim();
                  } else if (postData.type === "text_image") {
                    postData.hiddenContent = document
                      .getElementById("post-hidden-text")
                      .value.trim();
                  }
                }
                await db.qzonePosts.put(postData);
              } else {
                const basePostData = {
                  timestamp: Date.now(),
                  authorId: "user",
                  areCommentsVisible: areCommentsVisible,
                  visibleGroupIds: visibleGroupIds,
                };

                if (mode === "shuoshuo") {
                  const content = document
                    .getElementById("post-public-text")
                    .value.trim();
                  if (!content) return alert("è¯´è¯´å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼");
                  postData = {
                    ...basePostData,
                    type: "shuoshuo",
                    content: content,
                  };
                } else {
                  const publicText = document
                    .getElementById("post-public-text")
                    .value.trim();
                  const isImageModeActive = document
                    .getElementById("image-mode-content")
                    .classList.contains("active");
                  if (isImageModeActive) {
                    const imageUrl =
                      document.getElementById("post-image-preview").src;
                    const imageDescription = document
                      .getElementById("post-image-description")
                      .value.trim();
                    if (
                      !imageUrl ||
                      !(
                        imageUrl.startsWith("http") ||
                        imageUrl.startsWith("data:")
                      )
                    )
                      return alert("è¯·å…ˆæ·»åŠ ä¸€å¼ å›¾ç‰‡å†å‘å¸ƒåŠ¨æ€å“¦ï¼");
                    if (!imageDescription)
                      return alert(
                        "è¯·ä¸ºä½ çš„å›¾ç‰‡æ·»åŠ ä¸€ä¸ªç®€å•çš„æè¿°ï¼ˆå¿…å¡«ï¼Œç»™AIçœ‹çš„ï¼‰ï¼",
                      );
                    postData = {
                      ...basePostData,
                      type: "image_post",
                      publicText,
                      imageUrl,
                      imageDescription,
                    };
                  } else {
                    const hiddenText = document
                      .getElementById("post-hidden-text")
                      .value.trim();
                    if (!hiddenText) return alert("è¯·è¾“å…¥æ–‡å­—å›¾æè¿°ï¼");
                    postData = {
                      ...basePostData,
                      type: "text_image",
                      publicText,
                      hiddenContent: hiddenText,
                    };
                  }
                }
                const newPostId = await db.qzonePosts.add(postData);
                postData.id = newPostId;
              }

              let postSummary =
                postData.content ||
                postData.publicText ||
                postData.imageDescription ||
                postData.hiddenContent ||
                "ï¼ˆæ— æ–‡å­—å†…å®¹ï¼‰";
              postSummary =
                postSummary.substring(0, 50) +
                (postSummary.length > 50 ? "..." : "");
              for (const chatId in state.chats) {
                const chat = state.chats[chatId];
                if (chat.isGroup) continue;
                const historyMessage = {
                  role: "system",
                  content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·${editingId ? "ç¼–è¾‘äº†" : "å‘å¸ƒäº†"}ä¸€æ¡åŠ¨æ€(ID: ${
                    editingId || postData.id
                  })ï¼Œå†…å®¹æ‘˜è¦æ˜¯ï¼šâ€œ${postSummary}â€ã€‚]`,
                  timestamp: Date.now(),
                  isHidden: true,
                };
                chat.history.push(historyMessage);
                await db.chats.put(chat);
              }

              await renderQzonePosts();
              modal.classList.remove("visible");
              delete modal.dataset.editingPostId;
              delete modal.dataset.mode;
              alert(`åŠ¨æ€${editingId ? "ç¼–è¾‘" : "å‘å¸ƒ"}æˆåŠŸï¼`);
            });

          // ä¸ºå…¨å±€èŠå¤©èƒŒæ™¯çš„ä¸Šä¼ æŒ‰é’®ç»‘å®šäº‹ä»¶
          document
            .getElementById("global-bg-upload-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (file) {
                const dataUrl = await new Promise((res) => {
                  const reader = new FileReader();
                  reader.onload = () => res(reader.result);
                  reader.readAsDataURL(file);
                });
                newGlobalBgBase64 = dataUrl; // å°†æ–°èƒŒæ™¯å­˜å…¥ä¸´æ—¶å˜é‡
                // å®æ—¶æ›´æ–°é¢„è§ˆ
                const preview = document.getElementById("global-bg-preview");
                preview.style.backgroundImage = `url(${dataUrl})`;
                preview.textContent = "";
              }
            });

          // ä¸ºå…¨å±€èŠå¤©èƒŒæ™¯çš„ç§»é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶
          document
            .getElementById("remove-global-bg-btn")
            .addEventListener("click", () => {
              newGlobalBgBase64 = "REMOVED"; // ç”¨ä¸€ä¸ªç‰¹æ®Šæ ‡è®°è¡¨ç¤ºâ€œç§»é™¤â€
              const preview = document.getElementById("global-bg-preview");
              preview.style.backgroundImage = "none";
              preview.textContent = "å·²ç§»é™¤";
              alert("å…¨å±€èƒŒæ™¯å°†åœ¨ç‚¹å‡»â€œä¿å­˜â€åè¢«ç§»é™¤ã€‚");
            });

          // ä¸ºâ€œä¸€é”®æ¸…ç©ºå•äººèƒŒæ™¯â€æŒ‰é’®ç»‘å®šäº‹ä»¶
          document
            .getElementById("clear-all-single-bgs-btn")
            .addEventListener("click", clearAllSingleChatBackgrounds);

          const postsList = document.getElementById("qzone-posts-list");
          let swipeState = {
            isDragging: false,
            startX: 0,
            startY: 0,
            currentX: 0,
            activeContainer: null,
            swipeDirection: null,
            isClick: true,
          };

          function resetAllSwipes(exceptThisOne = null) {
            document
              .querySelectorAll(".qzone-post-container")
              .forEach((container) => {
                if (container !== exceptThisOne) {
                  container
                    .querySelector(".qzone-post-item")
                    .classList.remove("swiped");
                }
              });
          }

          const handleSwipeStart = (e) => {
            const targetContainer = e.target.closest(".qzone-post-container");
            if (!targetContainer) return;

            resetAllSwipes(targetContainer);
            swipeState.activeContainer = targetContainer;
            swipeState.isDragging = true;
            swipeState.isClick = true;
            swipeState.swipeDirection = null;
            swipeState.startX = e.type.includes("mouse")
              ? e.pageX
              : e.touches[0].pageX;
            swipeState.startY = e.type.includes("mouse")
              ? e.pageY
              : e.touches[0].pageY;
            swipeState.activeContainer.querySelector(
              ".qzone-post-item",
            ).style.transition = "none";
          };

          const handleSwipeMove = (e) => {
            if (!swipeState.isDragging || !swipeState.activeContainer) return;

            const currentX = e.type.includes("mouse")
              ? e.pageX
              : e.touches[0].pageX;
            const currentY = e.type.includes("mouse")
              ? e.pageY
              : e.touches[0].pageY;
            const diffX = currentX - swipeState.startX;
            const diffY = currentY - swipeState.startY;
            const absDiffX = Math.abs(diffX);
            const absDiffY = Math.abs(diffY);
            const clickThreshold = 5;

            if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
              swipeState.isClick = false;
            }

            if (swipeState.swipeDirection === null) {
              if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
                if (absDiffX > absDiffY) {
                  swipeState.swipeDirection = "horizontal";
                } else {
                  swipeState.swipeDirection = "vertical";
                }
              }
            }
            if (swipeState.swipeDirection === "vertical") {
              handleSwipeEnd(e);
              return;
            }
            if (swipeState.swipeDirection === "horizontal") {
              e.preventDefault();
              swipeState.currentX = currentX;
              let translation = diffX;
              if (translation > 0) translation = 0;
              if (translation < -90) translation = -90;
              swipeState.activeContainer.querySelector(
                ".qzone-post-item",
              ).style.transform = `translateX(${translation}px)`;
            }
          };

          const handleSwipeEnd = (e) => {
            if (swipeState.isClick) {
              swipeState.isDragging = false;
              swipeState.activeContainer = null;
              return;
            }
            if (!swipeState.isDragging || !swipeState.activeContainer) return;

            const postItem =
              swipeState.activeContainer.querySelector(".qzone-post-item");
            postItem.style.transition = "transform 0.3s ease";

            const finalX = e.type.includes("touchend")
              ? e.changedTouches[0].pageX
              : e.pageX;
            const diffX = finalX - swipeState.startX;
            const swipeThreshold = -40;

            if (
              swipeState.swipeDirection === "horizontal" &&
              diffX < swipeThreshold
            ) {
              postItem.classList.add("swiped");
              postItem.style.transform = "";
            } else {
              postItem.classList.remove("swiped");
              postItem.style.transform = "";
            }

            swipeState.isDragging = false;
            swipeState.startX = 0;
            swipeState.startY = 0;
            swipeState.currentX = 0;
            swipeState.activeContainer = null;
            swipeState.swipeDirection = null;
            swipeState.isClick = true;
          };

          // --- ç»‘å®šæ‰€æœ‰æ»‘åŠ¨äº‹ä»¶ ---
          postsList.addEventListener("mousedown", handleSwipeStart);
          document.addEventListener("mousemove", handleSwipeMove);
          document.addEventListener("mouseup", handleSwipeEnd);
          postsList.addEventListener("touchstart", handleSwipeStart, {
            passive: false,
          });
          postsList.addEventListener("touchmove", handleSwipeMove, {
            passive: false,
          });
          postsList.addEventListener("touchend", handleSwipeEnd);

          postsList.addEventListener("click", async (e) => {
            e.stopPropagation();
            const target = e.target;

            const summonBtn = target.closest(".action-icon.summon-npc");
            if (summonBtn) {
              const postId = parseInt(summonBtn.dataset.postId);
              const authorId = summonBtn.dataset.authorId;
              if (!isNaN(postId) && authorId) {
                handleNpcSummonClick(postId, authorId);
              }
              return; // å¤„ç†å®Œå¬å”¤é€»è¾‘åï¼Œç›´æ¥ç»“æŸï¼Œä¸æ‰§è¡Œåç»­çš„ç‚¹èµç­‰åˆ¤æ–­
            }

            // å¤„ç†ç‚¹å‡»è¯„è®ºæœ¬èº«ï¼ˆç”¨äºå›å¤ï¼‰
            const commentItem = target.closest(".comment-item");
            // ç¡®ä¿ç‚¹å‡»çš„ä¸æ˜¯åˆ é™¤æŒ‰é’®æˆ–è¯„è®ºé‡Œçš„åå­—é“¾æ¥
            if (
              commentItem &&
              !target.classList.contains("comment-delete-btn") &&
              !target.classList.contains("commenter-name") &&
              !target.classList.contains("reply-target-name")
            ) {
              const postContainer = commentItem.closest(
                ".qzone-post-container",
              );
              if (postContainer) {
                const commenterName = commentItem.dataset.commenterName;
                const myNickname = state.qzoneSettings.nickname;

                // å¦‚æœç‚¹å‡»çš„æ˜¯è‡ªå·±çš„è¯„è®ºï¼Œåˆ™ä¸è¿›å…¥å›å¤æ¨¡å¼
                if (commenterName !== myNickname) {
                  const commentInput =
                    postContainer.querySelector(".comment-input");
                  commentInput.placeholder = `å›å¤ ${commenterName}:`;
                  commentInput.dataset.replyTo = commenterName; // æŠŠè¦å›å¤çš„äººçš„åå­—ï¼Œä¸´æ—¶å­˜èµ·æ¥
                  commentInput.focus(); // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                }
              }
              return; // å¤„ç†å®Œç‚¹å‡»è¯„è®ºåï¼Œå°±ä¸ç”¨å¾€ä¸‹æ‰§è¡Œäº†
            }

            if (target.classList.contains("comment-delete-btn")) {
              const postContainer = target.closest(".qzone-post-container");
              if (!postContainer) return;
              const postId = parseInt(postContainer.dataset.postId);
              const commentIndex = parseInt(target.dataset.commentIndex);
              if (isNaN(postId) || isNaN(commentIndex)) return;
              const post = await db.qzonePosts.get(postId);
              if (!post || !post.comments || !post.comments[commentIndex])
                return;
              const commentText = post.comments[commentIndex].text;
              const confirmed = await showCustomConfirm(
                "åˆ é™¤è¯„è®º",
                `ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ\n\nâ€œ${commentText.substring(0, 50)}...â€`,
                { confirmButtonClass: "btn-danger" },
              );
              if (confirmed) {
                post.comments.splice(commentIndex, 1);
                await db.qzonePosts.update(postId, { comments: post.comments });
                await renderQzonePosts();
                alert("è¯„è®ºå·²åˆ é™¤ã€‚");
              }
              return;
            }

            if (target.classList.contains("post-actions-btn")) {
              const container = target.closest(".qzone-post-container");
              if (container && container.dataset.postId)
                showPostActions(parseInt(container.dataset.postId));
              return;
            }

            if (target.closest(".qzone-post-delete-action")) {
              const container = target.closest(
                ".qzone-post-delete-action",
              ).parentElement;
              if (!container) return;
              const postIdToDelete = parseInt(container.dataset.postId);
              if (isNaN(postIdToDelete)) return;
              const confirmed = await showCustomConfirm(
                "åˆ é™¤åŠ¨æ€",
                "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ",
                {
                  confirmButtonClass: "btn-danger",
                },
              );
              if (confirmed) {
                container.style.transition = "all 0.3s ease";
                container.style.transform = "scale(0.8)";
                container.style.opacity = "0";
                setTimeout(async () => {
                  await db.qzonePosts.delete(postIdToDelete);
                  const notificationIdentifier = `(ID: ${postIdToDelete})`;
                  for (const chatId in state.chats) {
                    const chat = state.chats[chatId];
                    const originalHistoryLength = chat.history.length;
                    chat.history = chat.history.filter(
                      (msg) =>
                        !(
                          msg.role === "system" &&
                          msg.content.includes(notificationIdentifier)
                        ),
                    );
                    if (chat.history.length < originalHistoryLength)
                      await db.chats.put(chat);
                  }
                  await renderQzonePosts();
                  alert("åŠ¨æ€å·²åˆ é™¤ã€‚");
                }, 300);
              }
              return;
            }

            if (target.tagName === "IMG" && target.dataset.hiddenText) {
              showCustomAlert(
                "å›¾ç‰‡å†…å®¹",
                target.dataset.hiddenText.replace(/<br>/g, "\n"),
              );
              return;
            }
            const icon = target.closest(".action-icon");
            if (icon) {
              const postContainer = icon.closest(".qzone-post-container");
              if (!postContainer) return;
              const postId = parseInt(postContainer.dataset.postId);
              if (isNaN(postId)) return;
              if (icon.classList.contains("like")) {
                const post = await db.qzonePosts.get(postId);
                if (!post) return;
                if (!post.likes) post.likes = [];
                const userNickname = state.qzoneSettings.nickname;
                const userLikeIndex = post.likes.indexOf(userNickname);
                if (userLikeIndex > -1) {
                  post.likes.splice(userLikeIndex, 1);
                } else {
                  post.likes.push(userNickname);
                  icon.classList.add("animate-like");
                  icon.addEventListener(
                    "animationend",
                    () => icon.classList.remove("animate-like"),
                    { once: true },
                  );
                }
                await db.qzonePosts.update(postId, { likes: post.likes });
              }
              if (icon.classList.contains("favorite")) {
                const existingFavorite = await db.favorites
                  .where({ type: "qzone_post", "content.id": postId })
                  .first();
                if (existingFavorite) {
                  await db.favorites.delete(existingFavorite.id);
                  await showCustomAlert("æç¤º", "å·²å–æ¶ˆæ”¶è—");
                } else {
                  const postToSave = await db.qzonePosts.get(postId);
                  if (postToSave) {
                    await db.favorites.add({
                      type: "qzone_post",
                      content: postToSave,
                      timestamp: Date.now(),
                    });
                    await showCustomAlert("æç¤º", "æ”¶è—æˆåŠŸï¼");
                  }
                }
              }
              await renderQzonePosts();
              return;
            }

            // å¤„ç†è¯„è®ºå‘é€é€»è¾‘
            const sendBtn = target.closest(".comment-send-btn");
            if (sendBtn) {
              const postContainer = sendBtn.closest(".qzone-post-container");
              if (!postContainer) return;
              const postId = parseInt(postContainer.dataset.postId);
              const commentInput =
                postContainer.querySelector(".comment-input");
              const commentText = commentInput.value.trim();
              if (!commentText) return alert("è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼");
              const post = await db.qzonePosts.get(postId);
              if (!post) return;
              if (!post.comments) post.comments = [];

              // åˆ›å»ºæ–°çš„è¯„è®ºå¯¹è±¡
              const newComment = {
                commenterName: state.qzoneSettings.nickname,
                text: commentText,
                timestamp: Date.now(),
              };

              // æ£€æŸ¥æ˜¯ä¸æ˜¯åœ¨å›å¤æ¨¡å¼
              if (commentInput.dataset.replyTo) {
                newComment.replyTo = commentInput.dataset.replyTo; // å¦‚æœæ˜¯ï¼Œå°±æŠŠå›å¤å¯¹è±¡çš„åå­—åŠ ä¸Š
              }

              post.comments.push(newComment);
              await db.qzonePosts.update(postId, { comments: post.comments });
              for (const chatId in state.chats) {
                const chat = state.chats[chatId];
                if (!chat.isGroup) {
                  let aiNotification = `[ç³»ç»Ÿæç¤ºï¼š'${state.qzoneSettings.nickname}' åœ¨IDä¸º${postId}çš„åŠ¨æ€ä¸‹å‘è¡¨äº†è¯„è®ºï¼šâ€œ${commentText}â€`;
                  if (newComment.replyTo) {
                    aiNotification += ` (è¿™æ˜¯å¯¹'${newComment.replyTo}'çš„å›å¤)`;
                  }
                  aiNotification += `]`;
                  chat.history.push({
                    role: "system",
                    content: aiNotification,
                    timestamp: Date.now(),
                    isHidden: true,
                  });
                  await db.chats.put(chat);
                }
              }

              // å‘é€åï¼Œé‡ç½®è¾“å…¥æ¡†çŠ¶æ€
              commentInput.value = "";
              commentInput.placeholder = "å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹";
              delete commentInput.dataset.replyTo; // æ¸…é™¤å›å¤çŠ¶æ€

              await renderQzonePosts();
              return;
            }
          });

          // ç»‘å®šåŠ¨æ€é¡µå’Œæ”¶è—é¡µçš„è¿”å›æŒ‰é’®
          document
            .getElementById("qzone-back-btn")
            .addEventListener("click", () =>
              switchToChatListView("messages-view"),
            );
          document
            .getElementById("favorites-back-btn")
            .addEventListener("click", () =>
              switchToChatListView("messages-view"),
            );

          // æ”¶è—é¡µæœç´¢åŠŸèƒ½
          const searchInput = document.getElementById("favorites-search-input");
          const searchClearBtn = document.getElementById(
            "favorites-search-clear-btn",
          );

          searchInput.addEventListener("input", () => {
            const searchTerm = searchInput.value.trim().toLowerCase();

            // æ§åˆ¶æ¸…é™¤æŒ‰é’®çš„æ˜¾ç¤º/éšè—
            searchClearBtn.style.display = searchTerm ? "block" : "none";

            if (!searchTerm) {
              displayFilteredFavorites(allFavoriteItems); // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰
              return;
            }

            // ç­›é€‰é€»è¾‘
            const filteredItems = allFavoriteItems.filter((item) => {
              let contentToSearch = "";
              let authorToSearch = "";

              if (item.type === "qzone_post") {
                const post = item.content;
                contentToSearch +=
                  (post.publicText || "") + " " + (post.content || "");
                if (post.authorId === "user") {
                  authorToSearch = state.qzoneSettings.nickname;
                } else if (state.chats[post.authorId]) {
                  authorToSearch = state.chats[post.authorId].name;
                }
              } else if (item.type === "chat_message") {
                const msg = item.content;
                if (typeof msg.content === "string") {
                  contentToSearch = msg.content;
                }
                const chat = state.chats[item.chatId];
                if (chat) {
                  if (msg.role === "user") {
                    authorToSearch = chat.isGroup
                      ? chat.settings.myNickname || "æˆ‘"
                      : "æˆ‘";
                  } else {
                    authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                  }
                }
              }

              // åŒæ—¶æœç´¢å†…å®¹å’Œä½œè€…ï¼Œå¹¶ä¸”ä¸åŒºåˆ†å¤§å°å†™
              return (
                contentToSearch.toLowerCase().includes(searchTerm) ||
                authorToSearch.toLowerCase().includes(searchTerm)
              );
            });

            displayFilteredFavorites(filteredItems);
          });

          // æ¸…é™¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
          searchClearBtn.addEventListener("click", () => {
            searchInput.value = "";
            searchClearBtn.style.display = "none";
            displayFilteredFavorites(allFavoriteItems);
            searchInput.focus();
          });

          // ä¸ºèŠå¤©ç•Œé¢çš„æ‰¹é‡æ”¶è—æŒ‰é’®ç»‘å®šäº‹ä»¶
          // ä¸ºèŠå¤©ç•Œé¢çš„æ‰¹é‡æ”¶è—æŒ‰é’®ç»‘å®šäº‹ä»¶ (å·²ä¿®æ­£)
          document
            .getElementById("selection-favorite-btn")
            .addEventListener("click", async () => {
              if (selectedMessages.size === 0) return;
              const chat = state.chats[state.activeChatId];
              if (!chat) return;

              const favoritesToAdd = [];
              const timestampsToFavorite = [...selectedMessages];

              for (const timestamp of timestampsToFavorite) {
                // ä½¿ç”¨æ–°çš„ã€é«˜æ•ˆçš„ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢
                const existing = await db.favorites
                  .where("originalTimestamp")
                  .equals(timestamp)
                  .first();

                if (!existing) {
                  const messageToSave = chat.history.find(
                    (msg) => msg.timestamp === timestamp,
                  );
                  if (messageToSave) {
                    favoritesToAdd.push({
                      type: "chat_message",
                      content: messageToSave,
                      chatId: state.activeChatId,
                      timestamp: Date.now(), // è¿™æ˜¯æ”¶è—æ“ä½œå‘ç”Ÿçš„æ—¶é—´
                      originalTimestamp: messageToSave.timestamp, // ä¿å­˜åŸå§‹æ¶ˆæ¯çš„æ—¶é—´æˆ³åˆ°æ–°å­—æ®µ
                    });
                  }
                }
              }

              if (favoritesToAdd.length > 0) {
                await db.favorites.bulkAdd(favoritesToAdd);
                allFavoriteItems = await db.favorites
                  .orderBy("timestamp")
                  .reverse()
                  .toArray(); // æ›´æ–°å…¨å±€æ”¶è—ç¼“å­˜
                await showCustomAlert(
                  "æ”¶è—æˆåŠŸ",
                  `å·²æˆåŠŸæ”¶è— ${favoritesToAdd.length} æ¡æ¶ˆæ¯ã€‚`,
                );
              } else {
                await showCustomAlert("æç¤º", "é€‰ä¸­çš„æ¶ˆæ¯å‡å·²æ”¶è—è¿‡ã€‚");
              }

              exitSelectionMode();
            });

          // æ”¶è—é¡µé¢çš„"ç¼–è¾‘"æŒ‰é’®äº‹ä»¶ (å·²ä¿®æ­£)
          const favoritesEditBtn =
            document.getElementById("favorites-edit-btn");
          const favoritesView = document.getElementById("favorites-view");
          const favoritesActionBar = document.getElementById(
            "favorites-action-bar",
          );
          const mainBottomNav = document.getElementById("chat-list-bottom-nav"); // è·å–ä¸»å¯¼èˆªæ 
          const favoritesList = document.getElementById("favorites-list"); // è·å–æ”¶è—åˆ—è¡¨

          favoritesEditBtn.addEventListener("click", () => {
            isFavoritesSelectionMode = !isFavoritesSelectionMode;
            favoritesView.classList.toggle(
              "selection-mode",
              isFavoritesSelectionMode,
            );

            if (isFavoritesSelectionMode) {
              // --- è¿›å…¥ç¼–è¾‘æ¨¡å¼ ---
              favoritesEditBtn.textContent = "å®Œæˆ";
              favoritesActionBar.style.display = "block"; // æ˜¾ç¤ºåˆ é™¤æ“ä½œæ 
              mainBottomNav.style.display = "none"; // â–¼ æ–°å¢ï¼šéšè—ä¸»å¯¼èˆªæ 
              favoritesList.style.paddingBottom = "80px"; // â–¼ æ–°å¢ï¼šç»™åˆ—è¡¨åº•éƒ¨å¢åŠ ç©ºé—´
            } else {
              // --- é€€å‡ºç¼–è¾‘æ¨¡å¼ ---
              favoritesEditBtn.textContent = "ç¼–è¾‘";
              favoritesActionBar.style.display = "none"; // éšè—åˆ é™¤æ“ä½œæ 
              mainBottomNav.style.display = "flex"; // â–¼ æ–°å¢ï¼šæ¢å¤ä¸»å¯¼èˆªæ 
              favoritesList.style.paddingBottom = ""; // â–¼ æ–°å¢ï¼šæ¢å¤åˆ—è¡¨é»˜è®¤padding

              // é€€å‡ºæ—¶æ¸…ç©ºæ‰€æœ‰é€‰æ‹©
              selectedFavorites.clear();
              document
                .querySelectorAll(".favorite-item-card.selected")
                .forEach((card) => card.classList.remove("selected"));
              document.getElementById(
                "favorites-delete-selected-btn",
              ).textContent = `åˆ é™¤ (0)`;
            }
          });

          // æ”¶è—åˆ—è¡¨çš„ç‚¹å‡»é€‰æ‹©äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
          document
            .getElementById("favorites-list")
            .addEventListener("click", (e) => {
              const target = e.target;
              const card = target.closest(".favorite-item-card");

              // å¤„ç†æ–‡å­—å›¾ç‚¹å‡»ï¼Œè¿™æ®µé€»è¾‘è¦æ”¾åœ¨æœ€å‰é¢ï¼Œä¿è¯ä»»ä½•æ¨¡å¼ä¸‹éƒ½ç”Ÿæ•ˆ
              if (target.tagName === "IMG" && target.dataset.hiddenText) {
                const hiddenText = target.dataset.hiddenText;
                showCustomAlert("å›¾ç‰‡å†…å®¹", hiddenText.replace(/<br>/g, "\n"));
                return; // å¤„ç†å®Œå°±é€€å‡ºï¼Œä¸ç»§ç»­æ‰§è¡Œé€‰æ‹©é€»è¾‘
              }

              // å¦‚æœä¸åœ¨é€‰æ‹©æ¨¡å¼ï¼Œåˆ™ä¸æ‰§è¡Œåç»­çš„é€‰æ‹©æ“ä½œ
              if (!isFavoritesSelectionMode) return;

              // --- ä»¥ä¸‹æ˜¯åŸæœ‰çš„é€‰æ‹©é€»è¾‘ï¼Œä¿æŒä¸å˜ ---
              if (!card) return;

              const favId = parseInt(card.dataset.favid);
              if (isNaN(favId)) return;

              // åˆ‡æ¢é€‰æ‹©çŠ¶æ€
              if (selectedFavorites.has(favId)) {
                selectedFavorites.delete(favId);
                card.classList.remove("selected");
              } else {
                selectedFavorites.add(favId);
                card.classList.add("selected");
              }

              // æ›´æ–°åº•éƒ¨åˆ é™¤æŒ‰é’®çš„è®¡æ•°
              document.getElementById(
                "favorites-delete-selected-btn",
              ).textContent = `åˆ é™¤ (${selectedFavorites.size})`;
            });

          // æ”¶è—é¡µé¢æ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶
          document
            .getElementById("favorites-delete-selected-btn")
            .addEventListener("click", async () => {
              if (selectedFavorites.size === 0) return;

              const confirmed = await showCustomConfirm(
                "ç¡®è®¤åˆ é™¤",
                `ç¡®å®šè¦ä»æ”¶è—å¤¹ä¸­ç§»é™¤è¿™ ${selectedFavorites.size} æ¡å†…å®¹å—ï¼Ÿ`,
                { confirmButtonClass: "btn-danger" },
              );

              if (confirmed) {
                const idsToDelete = [...selectedFavorites];
                await db.favorites.bulkDelete(idsToDelete);
                await showCustomAlert("åˆ é™¤æˆåŠŸ", "é€‰ä¸­çš„æ”¶è—å·²è¢«ç§»é™¤ã€‚");

                // ä»å‰ç«¯ç¼“å­˜ä¸­ä¹Ÿç§»é™¤è¢«åˆ é™¤çš„é¡¹
                allFavoriteItems = allFavoriteItems.filter(
                  (item) => !idsToDelete.includes(item.id),
                );

                // ä½¿ç”¨æ›´æ–°åçš„ç¼“å­˜ï¼Œç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
                displayFilteredFavorites(allFavoriteItems);

                // æœ€åï¼Œå†é€€å‡ºç¼–è¾‘æ¨¡å¼
                favoritesEditBtn.click(); // æ¨¡æ‹Ÿç‚¹å‡»"å®Œæˆ"æŒ‰é’®æ¥é€€å‡ºç¼–è¾‘æ¨¡å¼
              }
            });

          if (state.globalSettings.enableBackgroundActivity) {
            startBackgroundSimulation();
            console.log("åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²è‡ªåŠ¨å¯åŠ¨ã€‚");
          }

          // 1. ç›‘å¬ä¸»é¢˜é€‰æ‹©
          document
            .querySelectorAll('input[name="theme-select"]')
            .forEach((radio) => {
              radio.addEventListener("change", updateSettingsPreview);
            });

          // 2. ç›‘å¬å­—ä½“å¤§å°æ»‘å—
          const fontSizeSlider = document.getElementById("font-size-slider");
          fontSizeSlider.addEventListener("input", () => {
            // a. å®æ—¶æ›´æ–°æ•°å€¼æ˜¾ç¤º
            document.getElementById("font-size-value").textContent =
              `${fontSizeSlider.value}px`;
            // b. æ›´æ–°é¢„è§ˆ
            updateSettingsPreview();
          });

          // 3. ç›‘å¬è‡ªå®šä¹‰CSSè¾“å…¥æ¡†
          const customCssInputForPreview =
            document.getElementById("custom-css-input");
          customCssInputForPreview.addEventListener(
            "input",
            updateSettingsPreview,
          );

          // 4. ç›‘å¬é‡ç½®æŒ‰é’®
          document
            .getElementById("reset-theme-btn")
            .addEventListener("click", () => {
              document.getElementById("theme-default").checked = true;
              updateSettingsPreview();
            });

          document
            .getElementById("reset-custom-css-btn")
            .addEventListener("click", () => {
              document.getElementById("custom-css-input").value = "";
              updateSettingsPreview();
            });

          document
            .querySelectorAll('input[name="visibility"]')
            .forEach((radio) => {
              radio.addEventListener("change", function () {
                const groupsContainer = document.getElementById(
                  "post-visibility-groups",
                );
                if (this.value === "include" || this.value === "exclude") {
                  groupsContainer.style.display = "block";
                } else {
                  groupsContainer.style.display = "none";
                }
              });
            });

          document
            .getElementById("manage-groups-btn")
            .addEventListener("click", openGroupManager);
          document
            .getElementById("close-group-manager-btn")
            .addEventListener("click", () => {
              document
                .getElementById("group-management-modal")
                .classList.remove("visible");
              // åˆ·æ–°èŠå¤©è®¾ç½®é‡Œçš„åˆ†ç»„åˆ—è¡¨
              const chatSettingsBtn =
                document.getElementById("chat-settings-btn");
              if (
                document
                  .getElementById("chat-settings-modal")
                  .classList.contains("visible")
              ) {
                chatSettingsBtn.click(); // å†æ¬¡ç‚¹å‡»ä»¥é‡æ–°æ‰“å¼€
              }
            });

          document
            .getElementById("add-new-group-btn")
            .addEventListener("click", addNewGroup);
          document
            .getElementById("existing-groups-list")
            .addEventListener("click", (e) => {
              if (e.target.classList.contains("delete-group-btn")) {
                const groupId = parseInt(e.target.dataset.id);
                deleteGroup(groupId);
              }
            });

          // æ¶ˆæ¯æ“ä½œèœå•çš„æŒ‰é’®äº‹ä»¶
          document
            .getElementById("cancel-message-action-btn")
            .addEventListener("click", hideMessageActions);
          // ä½¿ç”¨æ–°çš„ç¼–è¾‘å™¨å…¥å£
          document
            .getElementById("edit-message-btn")
            .addEventListener("click", openAdvancedMessageEditor);
          document
            .getElementById("reroll-nai-btn")
            .addEventListener("click", handleNaiReroll);

          document
            .getElementById("copy-message-btn")
            .addEventListener("click", copyMessageContent);

          document
            .getElementById("recall-message-btn")
            .addEventListener("click", handleRecallClick);

          document
            .getElementById("select-message-btn")
            .addEventListener("click", () => {
              // åœ¨å…³é—­èœå•å‰ï¼Œå…ˆæ•è·æ—¶é—´æˆ³
              const timestampToSelect = activeMessageTimestamp;
              hideMessageActions();
              // ä½¿ç”¨æ•è·åˆ°çš„å€¼
              if (timestampToSelect) {
                enterSelectionMode(timestampToSelect);
              }
            });

          // åŠ¨æ€æ“ä½œèœå•çš„æŒ‰é’®äº‹ä»¶
          document
            .getElementById("edit-post-btn")
            .addEventListener("click", openPostEditor);
          document
            .getElementById("copy-post-btn")
            .addEventListener("click", copyPostContent);
          document
            .getElementById("cancel-post-action-btn")
            .addEventListener("click", hidePostActions);

          // è”ç³»äººé€‰æ‹©å™¨äº‹ä»¶ç»‘å®š
          document
            .getElementById("cancel-contact-picker-btn")
            .addEventListener("click", () => {
              showScreen("chat-list-screen");
            });

          document
            .getElementById("contact-picker-list")
            .addEventListener("click", (e) => {
              const item = e.target.closest(".contact-picker-item");
              if (!item) return;

              const contactId = item.dataset.contactId;
              item.classList.toggle("selected");

              if (selectedContacts.has(contactId)) {
                selectedContacts.delete(contactId);
              } else {
                selectedContacts.add(contactId);
              }
              updateContactPickerConfirmButton();
            });

          // ç»‘å®šâ€œç®¡ç†ç¾¤æˆå‘˜â€æŒ‰é’®äº‹ä»¶
          document
            .getElementById("manage-members-btn")
            .addEventListener("click", () => {
              // åœ¨åˆ‡æ¢å±å¹•å‰ï¼Œå…ˆéšè—å½“å‰çš„èŠå¤©è®¾ç½®å¼¹çª—
              document
                .getElementById("chat-settings-modal")
                .classList.remove("visible");
              // ç„¶åå†æ‰“å¼€æˆå‘˜ç®¡ç†å±å¹•
              openMemberManagementScreen();
            });

          // ç¾¤æˆå‘˜ç®¡ç†åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("back-from-member-management")
            .addEventListener("click", () => {
              showScreen("chat-interface-screen");
              document.getElementById("chat-settings-btn").click();
            });

          document
            .getElementById("add-existing-contact-btn")
            .addEventListener("click", async () => {
              // ä»å¥½å‹åˆ—è¡¨æ·»åŠ çš„äº‹ä»¶
              // ä¸ºâ€œå®Œæˆâ€æŒ‰é’®ç»‘å®šâ€œæ‹‰äººå…¥ç¾¤â€çš„é€»è¾‘
              const confirmBtn = document.getElementById(
                "confirm-contact-picker-btn",
              );
              // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æ–¹æ³•æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
              const newConfirmBtn = confirmBtn.cloneNode(true);
              confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
              newConfirmBtn.addEventListener("click", handleAddMembersToGroup);

              await openContactPickerForAddMember();
            });

          document
            .getElementById("create-new-member-btn")
            .addEventListener("click", createNewMemberInGroup);

          // è§†é¢‘é€šè¯åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨

          // ç»‘å®šå•èŠå’Œç¾¤èŠçš„å‘èµ·æŒ‰é’®
          document
            .getElementById("video-call-btn")
            .addEventListener("click", handleInitiateCall);
          document
            .getElementById("group-video-call-btn")
            .addEventListener("click", handleInitiateCall);

          // ç»‘å®šâ€œæŒ‚æ–­â€æŒ‰é’®
          document
            .getElementById("hang-up-btn")
            .addEventListener("click", endVideoCall);

          // ç»‘å®šâ€œå–æ¶ˆå‘¼å«â€æŒ‰é’®
          document
            .getElementById("cancel-call-btn")
            .addEventListener("click", () => {
              videoCallState.isAwaitingResponse = false;
              showScreen("chat-interface-screen");
            });

          // ç»‘å®šâ€œåŠ å…¥é€šè¯â€æŒ‰é’®
          document
            .getElementById("join-call-btn")
            .addEventListener("click", handleUserJoinCall);

          // ç»‘å®šæ¥ç”µè¯·æ±‚çš„â€œæ‹’ç»â€æŒ‰é’®
          document
            .getElementById("decline-call-btn")
            .addEventListener("click", async () => {
              stopRingtone();
              hideIncomingCallModal();
              const callerChatId = videoCallState.activeChatId; // ä»ä¸“ç”¨ä¿¡é“è·å–æ¥ç”µè€…ID
              if (!callerChatId) return;

              const chat = state.chats[callerChatId];
              if (!chat) return;

              // æ ¹æ®æ˜¯å¦ç¾¤èŠï¼Œæ‰§è¡Œä¸åŒçš„æ‹’ç»é€»è¾‘
              if (videoCallState.isGroupCall) {
                // å¯¹äºç¾¤èŠï¼Œæ‹’ç»=æ—è§‚ï¼Œè¿™ä¸ªé€»è¾‘ä¸å˜
                videoCallState.isUserParticipating = false;
                const systemNote = {
                  role: "system",
                  content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ‹’ç»äº†é€šè¯é‚€è¯·ï¼Œä½†ä½ ä»¬å¯ä»¥è‡ªå·±å¼€å§‹ã€‚è¯·ä½ ä»¬å„è‡ªå†³ç­–æ˜¯å¦åŠ å…¥ã€‚]`,
                  timestamp: Date.now(),
                  isHidden: true,
                };
                chat.history.push(systemNote);
                await db.chats.put(chat);
                await triggerAiResponse();
              } else {
                // å¯¹äºå•èŠï¼Œæˆ‘ä»¬ä¸å†æ‰“æ‰°ç”¨æˆ·å½“å‰ç•Œé¢ï¼Œè€Œæ˜¯é™é»˜å¤„ç†
                const declineMessage = {
                  role: "user",
                  content: "æˆ‘æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚",
                  timestamp: Date.now(),
                  isHidden: true,
                };
                chat.history.push(declineMessage);
                await db.chats.put(chat);

                // åªé€šçŸ¥ï¼Œä¸åˆ‡æ¢å±å¹•
                showNotification(callerChatId, "ä½ å·²æ‹’ç»é€šè¯é‚€è¯·ã€‚");
                // åœ¨åå°ä¸ºå¯¹æ–¹è§¦å‘ä¸€ä¸ªå“åº”ï¼Œè®©å®ƒçŸ¥é“è‡ªå·±è¢«æ‹’ç»äº†
                // æˆ‘ä»¬éœ€è¦ä¸´æ—¶åˆ‡æ¢activeChatIdæ¥è§¦å‘ï¼Œç„¶åå†æ¢å›æ¥
                const originalActiveChatId = state.activeChatId;
                state.activeChatId = callerChatId;
                await triggerAiResponse();
                state.activeChatId = originalActiveChatId;
              }

              // æ¸…ç†çŠ¶æ€
              videoCallState.isAwaitingResponse = false;
              videoCallState.activeChatId = null;
            });

          // ç»‘å®šæ¥ç”µè¯·æ±‚çš„â€œæ¥å¬â€æŒ‰é’®
          document
            .getElementById("accept-call-btn")
            .addEventListener("click", async () => {
              stopRingtone();
              hideIncomingCallModal();
              const callerChatId = videoCallState.activeChatId;
              if (!callerChatId) return;

              // åœ¨æ¥å¬æ—¶çœŸæ­£æ”¹å˜å…¨å±€çŠ¶æ€ï¼Œå¹¶æ‰“å¼€é€šè¯ç•Œé¢
              state.activeChatId = callerChatId; // <-- åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ‰æˆæƒä¿®æ”¹å…¨å±€çŠ¶æ€ï¼

              videoCallState.initiator = "ai";
              videoCallState.isUserParticipating = true;

              if (videoCallState.isGroupCall) {
                const chat = state.chats[videoCallState.activeChatId];
                const requester = chat.members.find(
                  (m) => m.name === videoCallState.callRequester,
                );
                if (requester) {
                  videoCallState.participants = [requester];
                } else {
                  videoCallState.participants = [];
                }
              }

              startVideoCall(); // å¯åŠ¨é€šè¯ç•Œé¢
            });

          // ç»‘å®šç”¨æˆ·åœ¨é€šè¯ä¸­å‘è¨€çš„æŒ‰é’®
          document
            .getElementById("user-speak-btn")
            .addEventListener("click", async () => {
              if (!videoCallState.isActive) return;

              // åœ¨å¼¹å‡ºè¾“å…¥æ¡†å‰ï¼Œå…ˆæ‰¾åˆ°å¹¶é«˜äº®ç”¨æˆ·å¤´åƒ
              const userAvatar = document.querySelector(
                '.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar',
              );
              if (userAvatar) {
                userAvatar.classList.add("speaking");
              }

              const userInput = await showCustomPrompt(
                "ä½ è¯´",
                "è¯·è¾“å…¥ä½ æƒ³è¯´çš„è¯...",
              );

              // æ— è®ºç”¨æˆ·æ˜¯å¦è¾“å…¥ï¼Œåªè¦å…³é—­è¾“å…¥æ¡†å°±ç§»é™¤é«˜äº®
              if (userAvatar) {
                userAvatar.classList.remove("speaking");
              }

              if (userInput && userInput.trim()) {
                triggerAiInCallAction(userInput.trim());
              }
            });

          // å›å¿†å½•ç›¸å…³äº‹ä»¶ç»‘å®š
          // 1. å°†â€œå›å¿†â€é¡µç­¾å’Œå®ƒçš„è§†å›¾è¿æ¥èµ·æ¥
          document
            .querySelector('.nav-item[data-view="memories-view"]')
            .addEventListener("click", () => {
              // åœ¨åˆ‡æ¢å‰ï¼Œç¡®ä¿"æ”¶è—"é¡µé¢çš„ç¼–è¾‘æ¨¡å¼å·²å…³é—­
              if (isFavoritesSelectionMode) {
                document.getElementById("favorites-edit-btn").click();
              }
              switchToChatListView("memories-view");
              renderMemoriesScreen(); // ç‚¹å‡»æ—¶æ¸²æŸ“
            });

          // 2. ç»‘å®šå›å¿†å½•ç•Œé¢çš„è¿”å›æŒ‰é’®
          document
            .getElementById("memories-back-btn")
            .addEventListener("click", () =>
              switchToChatListView("messages-view"),
            );

          // çº¦å®š/å€’è®¡æ—¶åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("add-countdown-btn")
            .addEventListener("click", () => {
              document
                .getElementById("create-countdown-modal")
                .classList.add("visible");
            });
          document
            .getElementById("cancel-create-countdown-btn")
            .addEventListener("click", () => {
              document
                .getElementById("create-countdown-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("confirm-create-countdown-btn")
            .addEventListener("click", async () => {
              const title = document
                .getElementById("countdown-title-input")
                .value.trim();
              const dateValue = document.getElementById(
                "countdown-date-input",
              ).value;

              if (!title || !dateValue) {
                alert("è¯·å¡«å†™å®Œæ•´çš„çº¦å®šæ ‡é¢˜å’Œæ—¥æœŸï¼");
                return;
              }

              const targetDate = new Date(dateValue);
              if (isNaN(targetDate) || targetDate <= new Date()) {
                alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ã€æœªæ¥çš„æ—¥æœŸï¼");
                return;
              }

              const newCountdown = {
                chatId: null, // ç”¨æˆ·åˆ›å»ºçš„ï¼Œä¸å±äºä»»ä½•ç‰¹å®šAI
                authorName: "æˆ‘",
                description: title,
                timestamp: Date.now(),
                type: "countdown",
                targetDate: targetDate.getTime(),
              };

              await db.memories.add(newCountdown);
              document
                .getElementById("create-countdown-modal")
                .classList.remove("visible");
              renderMemoriesScreen();
            });

          // æ‹‰é»‘åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("block-chat-btn")
            .addEventListener("click", async () => {
              if (
                !state.activeChatId ||
                state.chats[state.activeChatId].isGroup
              )
                return;

              const chat = state.chats[state.activeChatId];
              const confirmed = await showCustomConfirm(
                "ç¡®è®¤æ‹‰é»‘",
                `ç¡®å®šè¦æ‹‰é»‘â€œ${chat.name}â€å—ï¼Ÿæ‹‰é»‘åæ‚¨å°†æ— æ³•å‘å…¶å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æ‚¨å°†Taç§»å‡ºé»‘åå•ï¼Œæˆ–ç­‰å¾…Taé‡æ–°ç”³è¯·å¥½å‹ã€‚`,
                { confirmButtonClass: "btn-danger" },
              );

              if (confirmed) {
                chat.relationship.status = "blocked_by_user";
                chat.relationship.blockedTimestamp = Date.now();

                const hiddenMessage = {
                  role: "system",
                  content: `[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšè¢«ç”¨æˆ·æ‹‰é»‘äº†ã€‚åœ¨å¯¹æ–¹è§£é™¤æ‹‰é»‘ä¹‹å‰ï¼Œä½ æ— æ³•å†ä¸»åŠ¨å‘èµ·å¯¹è¯ï¼Œä¹Ÿæ— æ³•å›åº”ã€‚]`,
                  timestamp: Date.now() + 1,
                  isHidden: true,
                };
                chat.history.push(hiddenMessage);

                await db.chats.put(chat);

                // å…³é—­è®¾ç½®å¼¹çª—ï¼Œå¹¶åˆ·æ–°èŠå¤©ç•Œé¢
                document
                  .getElementById("chat-settings-modal")
                  .classList.remove("visible");
                renderChatInterface(state.activeChatId);
                // åˆ·æ–°èŠå¤©åˆ—è¡¨ï¼Œå¯èƒ½ä¼šæœ‰UIå˜åŒ–
                renderChatList();
              }
            });

          document
            .getElementById("chat-lock-overlay")
            .addEventListener("click", async (e) => {
              const chat = state.chats[state.activeChatId];
              if (!chat) return;

              if (e.target.id === "force-apply-check-btn") {
                alert(
                  "æ­£åœ¨æ‰‹åŠ¨è§¦å‘å¥½å‹ç”³è¯·æµç¨‹ï¼Œè¯·ç¨å...\nå¦‚æœAPIè°ƒç”¨æˆåŠŸï¼Œå°†å¼¹å‡ºæç¤ºã€‚å¦‚æœå¤±è´¥ï¼Œä¹Ÿä¼šæœ‰é”™è¯¯æç¤ºã€‚å¦‚æœé•¿æ—¶é—´æ— ååº”ï¼Œè¯´æ˜AIå¯èƒ½å†³å®šæš‚æ—¶ä¸ç”³è¯·ã€‚",
                );
                await triggerAiFriendApplication(chat.id);
                renderChatInterface(chat.id);
                return;
              }

              if (e.target.id === "unblock-btn") {
                chat.relationship.status = "friend";
                chat.relationship.blockedTimestamp = null;

                const hiddenMessage = {
                  role: "system",
                  content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšè§£é™¤äº†å¯¹ä½ çš„æ‹‰é»‘ã€‚ç°åœ¨ä½ ä»¬å¯ä»¥é‡æ–°å¼€å§‹å¯¹è¯äº†ã€‚]`,
                  timestamp: Date.now(),
                  isHidden: true,
                };
                chat.history.push(hiddenMessage);

                await db.chats.put(chat);
                renderChatInterface(chat.id);
                renderChatList();
                triggerAiResponse(); // ã€å¯é€‰ä½†æ¨èã€‘è§£é™¤åè®©AIä¸»åŠ¨è¯´ç‚¹ä»€ä¹ˆ
              } else if (e.target.id === "accept-friend-btn") {
                chat.relationship.status = "friend";
                chat.relationship.applicationReason = "";

                const hiddenMessage = {
                  role: "system",
                  content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšé€šè¿‡äº†ä½ çš„å¥½å‹ç”³è¯·ã€‚ä½ ä»¬ç°åœ¨åˆå¯ä»¥æ­£å¸¸èŠå¤©äº†ã€‚]`,
                  timestamp: Date.now(),
                  isHidden: true,
                };
                chat.history.push(hiddenMessage);

                await db.chats.put(chat);
                renderChatInterface(chat.id);
                renderChatList();
                const msg = {
                  role: "user",
                  content: "æˆ‘é€šè¿‡äº†ä½ çš„å¥½å‹è¯·æ±‚",
                  timestamp: Date.now(),
                };
                chat.history.push(msg);
                await db.chats.put(chat);
                appendMessage(msg, chat);
                triggerAiResponse();
              } else if (e.target.id === "reject-friend-btn") {
                chat.relationship.status = "blocked_by_user";
                chat.relationship.blockedTimestamp = Date.now();
                chat.relationship.applicationReason = "";
                await db.chats.put(chat);
                renderChatInterface(chat.id);
              }
              // å¤„ç†ç”³è¯·å¥½å‹æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
              else if (e.target.id === "apply-friend-btn") {
                const reason = await showCustomPrompt(
                  "å‘é€å¥½å‹ç”³è¯·",
                  `è¯·è¾“å…¥ä½ æƒ³å¯¹â€œ${chat.name}â€è¯´çš„ç”³è¯·ç†ç”±ï¼š`,
                  "æˆ‘ä»¬å’Œå¥½å§ï¼",
                );
                // åªæœ‰å½“ç”¨æˆ·è¾“å…¥äº†å†…å®¹å¹¶ç‚¹å‡»â€œç¡®å®šâ€åæ‰ç»§ç»­
                if (reason !== null) {
                  // æ›´æ–°å…³ç³»çŠ¶æ€ä¸ºâ€œç­‰å¾…AIæ‰¹å‡†â€
                  chat.relationship.status = "pending_ai_approval";
                  chat.relationship.applicationReason = reason;
                  await db.chats.put(chat);

                  // åˆ·æ–°UIï¼Œæ˜¾ç¤ºâ€œç­‰å¾…é€šè¿‡â€çš„ç•Œé¢
                  renderChatInterface(chat.id);
                  renderChatList();

                  // è§¦å‘AIå“åº”ï¼Œè®©å®ƒå»å¤„ç†è¿™ä¸ªå¥½å‹ç”³è¯·
                  triggerAiResponse();
                }
              }
            });

          // çº¢åŒ…åŠŸèƒ½äº‹ä»¶ç»‘å®š

          // 1. å°†åŸæœ‰çš„è½¬è´¦æŒ‰é’®(ï¿¥)çš„ç‚¹å‡»äº‹ä»¶ï¼Œé‡å®šå‘åˆ°æ–°çš„æ€»å…¥å£å‡½æ•°
          document
            .getElementById("transfer-btn")
            .addEventListener("click", handlePaymentButtonClick);

          // 2. çº¢åŒ…æ¨¡æ€æ¡†å†…éƒ¨çš„æ§åˆ¶æŒ‰é’®
          document
            .getElementById("cancel-red-packet-btn")
            .addEventListener("click", () => {
              document
                .getElementById("red-packet-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("send-group-packet-btn")
            .addEventListener("click", sendGroupRedPacket);
          document
            .getElementById("send-direct-packet-btn")
            .addEventListener("click", sendDirectRedPacket);

          // 3. çº¢åŒ…æ¨¡æ€æ¡†çš„é¡µç­¾åˆ‡æ¢é€»è¾‘
          const rpTabGroup = document.getElementById("rp-tab-group");
          const rpTabDirect = document.getElementById("rp-tab-direct");
          const rpContentGroup = document.getElementById("rp-content-group");
          const rpContentDirect = document.getElementById("rp-content-direct");

          rpTabGroup.addEventListener("click", () => {
            rpTabGroup.classList.add("active");
            rpTabDirect.classList.remove("active");
            rpContentGroup.style.display = "block";
            rpContentDirect.style.display = "none";
          });
          rpTabDirect.addEventListener("click", () => {
            rpTabDirect.classList.add("active");
            rpTabGroup.classList.remove("active");
            rpContentDirect.style.display = "block";
            rpContentGroup.style.display = "none";
          });

          // 4. å®æ—¶æ›´æ–°çº¢åŒ…é‡‘é¢æ˜¾ç¤º
          document
            .getElementById("rp-group-amount")
            .addEventListener("input", (e) => {
              const amount = parseFloat(e.target.value) || 0;
              document.getElementById("rp-group-total").textContent =
                `Â¥ ${amount.toFixed(2)}`;
            });
          document
            .getElementById("rp-direct-amount")
            .addEventListener("input", (e) => {
              const amount = parseFloat(e.target.value) || 0;
              document.getElementById("rp-direct-total").textContent =
                `Â¥ ${amount.toFixed(2)}`;
            });

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†çº¢åŒ…ç‚¹å‡»ï¼Œä¿®å¤å¤±æ•ˆé—®é¢˜
          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              // 1. æ‰¾åˆ°è¢«ç‚¹å‡»çš„çº¢åŒ…å¡ç‰‡
              const packetCard = e.target.closest(".red-packet-card");
              if (!packetCard) return; // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯çº¢åŒ…ï¼Œå°±ä»€ä¹ˆä¹Ÿä¸åš

              // 2. ä»çº¢åŒ…å¡ç‰‡çš„çˆ¶çº§.message-bubbleè·å–æ—¶é—´æˆ³
              const messageBubble = packetCard.closest(".message-bubble");
              if (!messageBubble || !messageBubble.dataset.timestamp) return;

              // 3. è°ƒç”¨æˆ‘ä»¬ç°æœ‰çš„å¤„ç†å‡½æ•°
              const timestamp = parseInt(messageBubble.dataset.timestamp);
              handlePacketClick(timestamp);
            });

          // æŠ•ç¥¨åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨
          // åœ¨è¾“å…¥æ¡†å·¥å…·æ æ·»åŠ æŒ‰é’®
          document
            .getElementById("send-poll-btn")
            .addEventListener("click", openCreatePollModal);

          // æŠ•ç¥¨åˆ›å»ºæ¨¡æ€æ¡†çš„æŒ‰é’®
          document
            .getElementById("add-poll-option-btn")
            .addEventListener("click", addPollOptionInput);
          document
            .getElementById("cancel-create-poll-btn")
            .addEventListener("click", () => {
              document
                .getElementById("create-poll-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("confirm-create-poll-btn")
            .addEventListener("click", sendPoll);

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æŠ•ç¥¨å¡ç‰‡å†…çš„æ‰€æœ‰ç‚¹å‡»äº‹ä»¶
          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              const pollCard = e.target.closest(".poll-card");
              if (!pollCard) return;

              const timestamp = parseInt(pollCard.dataset.pollTimestamp);
              if (isNaN(timestamp)) return;

              // ç‚¹å‡»äº†é€‰é¡¹
              const optionItem = e.target.closest(".poll-option-item");
              if (optionItem && !pollCard.classList.contains("closed")) {
                handleUserVote(timestamp, optionItem.dataset.option);
                return;
              }

              // ç‚¹å‡»äº†åŠ¨ä½œæŒ‰é’®ï¼ˆç»“æŸæŠ•ç¥¨/æŸ¥çœ‹ç»“æœï¼‰
              const actionBtn = e.target.closest(".poll-action-btn");
              if (actionBtn) {
                if (pollCard.classList.contains("closed")) {
                  showPollResults(timestamp);
                } else {
                  endPoll(timestamp);
                }
                return;
              }

              // å¦‚æœæ˜¯å·²ç»“æŸçš„æŠ•ç¥¨ï¼Œç‚¹å‡»å¡ç‰‡ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥æŸ¥çœ‹ç»“æœ
              if (pollCard.classList.contains("closed")) {
                showPollResults(timestamp);
              }
            });

          // AIå¤´åƒåº“åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("manage-ai-avatar-library-btn")
            .addEventListener("click", openAiAvatarLibraryModal);
          document
            .getElementById("add-ai-avatar-btn")
            .addEventListener("click", addAvatarToLibrary);
          document
            .getElementById("close-ai-avatar-library-btn")
            .addEventListener("click", closeAiAvatarLibraryModal);

          document
            .getElementById("icon-settings-grid")
            .addEventListener("click", async (e) => {
              if (e.target.classList.contains("change-icon-btn")) {
                const item = e.target.closest(".icon-setting-item");
                const iconId = item.dataset.iconId;
                if (!iconId) return;

                // 1. å¼¹å‡ºé€‰æ‹©æ¨¡æ€æ¡†
                const choice = await showChoiceModal("æ›´æ¢å›¾æ ‡", [
                  { text: "ğŸ“ ä»æœ¬åœ°ä¸Šä¼ ", value: "local" },
                  { text: "ğŸŒ ä½¿ç”¨ç½‘ç»œURL", value: "url" },
                ]);

                let newUrl = null;

                // 2. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©æ‰§è¡Œä¸åŒæ“ä½œ
                if (choice === "local") {
                  newUrl = await uploadImageLocally(); // è°ƒç”¨æˆ‘ä»¬ä¹‹å‰å†™å¥½çš„æœ¬åœ°ä¸Šä¼ è¾…åŠ©å‡½æ•°
                } else if (choice === "url") {
                  const currentUrl = state.globalSettings.appIcons[iconId];
                  newUrl = await showCustomPrompt(
                    `æ›´æ¢â€œ${item.querySelector(".icon-preview").alt}â€å›¾æ ‡`,
                    "è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URL",
                    currentUrl,
                    "url",
                  );
                }

                // 3. å¤„ç†æœ€ç»ˆç»“æœ
                if (newUrl && newUrl.trim()) {
                  const trimmedUrl = newUrl.trim();
                  // ä»…åœ¨å†…å­˜ä¸­æ›´æ–°ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»â€œä¿å­˜â€
                  state.globalSettings.appIcons[iconId] = trimmedUrl;
                  // å®æ—¶æ›´æ–°è®¾ç½®é¡µé¢çš„é¢„è§ˆå›¾
                  item.querySelector(".icon-preview").src = trimmedUrl;
                } else if (newUrl !== null) {
                  alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„URLæˆ–é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼");
                }
              }
            });

          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              // ä½¿ç”¨ .closest() å‘ä¸ŠæŸ¥æ‰¾è¢«ç‚¹å‡»çš„å¡ç‰‡
              const linkCard = e.target.closest(".link-share-card");
              if (linkCard) {
                const timestamp = parseInt(linkCard.dataset.timestamp);
                if (!isNaN(timestamp)) {
                  openBrowser(timestamp); // è°ƒç”¨æˆ‘ä»¬çš„å‡½æ•°
                }
              }
            });

          // æµè§ˆå™¨è¿”å›æŒ‰é’®çš„äº‹ä»¶ç›‘å¬ï¼Œç¡®ä¿å®ƒåªç»‘å®šä¸€æ¬¡
          document
            .getElementById("browser-back-btn")
            .addEventListener("click", () => {
              showScreen("chat-interface-screen");
            });

          // 1. ç»‘å®šè¾“å…¥æ¡†ä¸Šæ–¹â€œåˆ†äº«é“¾æ¥â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
          document
            .getElementById("share-link-btn")
            .addEventListener("click", openShareLinkModal);

          // 2. ç»‘å®šæ¨¡æ€æ¡†ä¸­â€œå–æ¶ˆâ€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
          document
            .getElementById("cancel-share-link-btn")
            .addEventListener("click", () => {
              document
                .getElementById("share-link-modal")
                .classList.remove("visible");
            });

          // 3. ç»‘å®šæ¨¡æ€æ¡†ä¸­â€œåˆ†äº«â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
          document
            .getElementById("confirm-share-link-btn")
            .addEventListener("click", sendUserLinkShare);

          document
            .getElementById("theme-toggle-switch")
            .addEventListener("change", toggleTheme);

          // ç»‘å®šæ¶ˆæ¯æ“ä½œèœå•ä¸­çš„â€œå¼•ç”¨â€æŒ‰é’®
          document
            .getElementById("quote-message-btn")
            .addEventListener("click", startReplyToMessage);

          // ç»‘å®šå›å¤é¢„è§ˆæ ä¸­çš„â€œå–æ¶ˆâ€æŒ‰é’®
          document
            .getElementById("cancel-reply-btn")
            .addEventListener("click", cancelReplyMode);

          // åœ¨ä½ çš„ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ...

          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              // 1. å‘ä¸ŠæŸ¥æ‰¾è¢«ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªæ¶ˆæ¯æ°”æ³¡å†…
              const bubble = e.target.closest(".message-bubble");
              if (!bubble) return; // å¦‚æœä¸åœ¨ï¼Œå°±é€€å‡º

              // 2. æ·»åŠ ä¸¥æ ¼çš„ç­›é€‰æ¡ä»¶
              // å¿…é¡»æ˜¯ AI çš„æ¶ˆæ¯ (.ai)
              // å¿…é¡»æ˜¯è½¬è´¦ç±»å‹ (.is-transfer)
              // å¿…é¡»æ˜¯æˆ‘ä»¬æ ‡è®°ä¸ºâ€œå¾…å¤„ç†â€çš„ (data-status="pending")
              if (
                bubble.classList.contains("ai") &&
                bubble.classList.contains("is-transfer") &&
                bubble.dataset.status === "pending"
              ) {
                // 3. åªæœ‰æ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼Œæ‰æ‰§è¡Œåç»­é€»è¾‘
                const timestamp = parseInt(bubble.dataset.timestamp);
                if (!isNaN(timestamp)) {
                  showTransferActionModal(timestamp);
                }
              }
            });

          // åœ¨ init() çš„äº‹ä»¶ç›‘å¬åŒºåŸŸæ·»åŠ 
          document
            .getElementById("transfer-action-accept")
            .addEventListener("click", () =>
              handleUserTransferResponse("accepted"),
            );
          document
            .getElementById("transfer-action-decline")
            .addEventListener("click", () =>
              handleUserTransferResponse("declined"),
            );
          document
            .getElementById("transfer-action-cancel")
            .addEventListener("click", hideTransferActionModal);

          document
            .getElementById("chat-list-title")
            .addEventListener("click", renderCallHistoryScreen);

          // 2. ç»‘å®šé€šè¯è®°å½•é¡µé¢çš„â€œè¿”å›â€æŒ‰é’®
          document
            .getElementById("call-history-back-btn")
            .addEventListener("click", () => {
              // è¿”å›åˆ°èŠå¤©åˆ—è¡¨é¡µé¢ï¼Œè€Œä¸æ˜¯èŠå¤©ç•Œé¢
              showScreen("chat-list-screen");
            });

          // 3. ç›‘å¬å¡ç‰‡ç‚¹å‡»çš„é€»è¾‘ä¿æŒä¸å˜
          document
            .getElementById("call-history-list")
            .addEventListener("click", (e) => {
              const card = e.target.closest(".call-record-card");
              if (card && card.dataset.recordId) {
                showCallTranscript(parseInt(card.dataset.recordId));
              }
            });

          // 4. å…³é—­è¯¦æƒ…å¼¹çª—çš„é€»è¾‘ä¿æŒä¸å˜
          document
            .getElementById("close-transcript-modal-btn")
            .addEventListener("click", () => {
              document
                .getElementById("call-transcript-modal")
                .classList.remove("visible");
            });

          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              // 1. æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯è¯­éŸ³æ¡
              const voiceBody = e.target.closest(".voice-message-body");
              if (!voiceBody) return;

              // 2. æ‰¾åˆ°ç›¸å…³çš„DOMå…ƒç´ 
              const bubble = voiceBody.closest(".message-bubble");
              if (!bubble) return;

              const spinner = voiceBody.querySelector(".loading-spinner");
              const transcriptEl = bubble.querySelector(".voice-transcript");

              // å¦‚æœæ­£åœ¨åŠ è½½ä¸­ï¼Œåˆ™ä¸å“åº”ç‚¹å‡»
              if (bubble.dataset.state === "loading") {
                return;
              }

              // 3. å¦‚æœæ–‡å­—å·²ç»å±•å¼€ï¼Œåˆ™æ”¶èµ·
              if (bubble.dataset.state === "expanded") {
                transcriptEl.style.display = "none";
                bubble.dataset.state = "collapsed";
              }
              // 4. å¦‚æœæ˜¯æ”¶èµ·çŠ¶æ€ï¼Œåˆ™å¼€å§‹â€œè½¬å½•â€æµç¨‹
              else {
                bubble.dataset.state = "loading"; // è¿›å…¥åŠ è½½çŠ¶æ€
                spinner.style.display = "block"; // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»

                // æ¨¡æ‹Ÿ1.5ç§’çš„è¯­éŸ³è¯†åˆ«è¿‡ç¨‹
                setTimeout(() => {
                  // æ£€æŸ¥æ­¤æ—¶å…ƒç´ æ˜¯å¦è¿˜å­˜åœ¨ï¼ˆå¯èƒ½ç”¨æˆ·å·²ç»åˆ‡æ¢äº†èŠå¤©ï¼‰
                  if (document.body.contains(bubble)) {
                    const voiceText = bubble.dataset.voiceText || "(æ— æ³•è¯†åˆ«)";
                    transcriptEl.textContent = voiceText; // å¡«å……æ–‡å­—

                    spinner.style.display = "none"; // éšè—åŠ è½½åŠ¨ç”»
                    transcriptEl.style.display = "block"; // æ˜¾ç¤ºæ–‡å­—
                    bubble.dataset.state = "expanded"; // è¿›å…¥å±•å¼€çŠ¶æ€
                  }
                }, 500);
              }
            });

          document
            .getElementById("chat-header-status")
            .addEventListener("click", handleEditStatusClick);

          // åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
          document
            .getElementById("selection-share-btn")
            .addEventListener("click", () => {
              if (selectedMessages.size > 0) {
                openShareTargetPicker(); // æ‰“å¼€æˆ‘ä»¬å³å°†åˆ›å»ºçš„ç›®æ ‡é€‰æ‹©å™¨
              }
            });

          // åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
          document
            .getElementById("confirm-share-target-btn")
            .addEventListener("click", async () => {
              const sourceChat = state.chats[state.activeChatId];
              const selectedTargetIds = Array.from(
                document.querySelectorAll(".share-target-checkbox:checked"),
              ).map((cb) => cb.dataset.chatId);

              if (selectedTargetIds.length === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ†äº«çš„èŠå¤©ã€‚");
                return;
              }

              // 1. æ‰“åŒ…èŠå¤©è®°å½•
              const sharedHistory = [];
              const sortedTimestamps = [...selectedMessages].sort(
                (a, b) => a - b,
              );
              for (const timestamp of sortedTimestamps) {
                const msg = sourceChat.history.find(
                  (m) => m.timestamp === timestamp,
                );
                if (msg) {
                  sharedHistory.push(msg);
                }
              }

              // 2. åˆ›å»ºåˆ†äº«å¡ç‰‡æ¶ˆæ¯å¯¹è±¡
              const shareCardMessage = {
                role: "user",
                senderName: sourceChat.isGroup
                  ? sourceChat.settings.myNickname || "æˆ‘"
                  : "æˆ‘",
                type: "share_card",
                timestamp: Date.now(),
                payload: {
                  sourceChatName: sourceChat.name,
                  title: `æ¥è‡ªâ€œ${sourceChat.name}â€çš„èŠå¤©è®°å½•`,
                  sharedHistory: sharedHistory,
                },
              };

              // 3. å¾ªç¯å‘é€åˆ°æ‰€æœ‰ç›®æ ‡èŠå¤©
              for (const targetId of selectedTargetIds) {
                const targetChat = state.chats[targetId];
                if (targetChat) {
                  targetChat.history.push(shareCardMessage);
                  await db.chats.put(targetChat);
                }
              }

              // 4. æ”¶å°¾å·¥ä½œ
              document
                .getElementById("share-target-modal")
                .classList.remove("visible");
              exitSelectionMode(); // é€€å‡ºå¤šé€‰æ¨¡å¼
              await showCustomAlert(
                "åˆ†äº«æˆåŠŸ",
                `èŠå¤©è®°å½•å·²æˆåŠŸåˆ†äº«åˆ° ${selectedTargetIds.length} ä¸ªä¼šè¯ä¸­ã€‚`,
              );
              renderChatList(); // åˆ·æ–°åˆ—è¡¨ï¼Œå¯èƒ½ä¼šæœ‰æ–°æ¶ˆæ¯æç¤º
            });

          // ç»‘å®šå–æ¶ˆæŒ‰é’®
          document
            .getElementById("cancel-share-target-btn")
            .addEventListener("click", () => {
              document
                .getElementById("share-target-modal")
                .classList.remove("visible");
            });

          // åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              // å¤„ç†åˆ†äº«å¡ç‰‡çš„ç‚¹å‡»
              const shareCard = e.target.closest(
                ".link-share-card[data-timestamp]",
              );
              if (
                shareCard &&
                shareCard.closest(".message-bubble.is-link-share")
              ) {
                const timestamp = parseInt(shareCard.dataset.timestamp);
                openSharedHistoryViewer(timestamp);
              }
            });

          // ç»‘å®šæŸ¥çœ‹å™¨çš„å…³é—­æŒ‰é’®
          document
            .getElementById("close-shared-history-viewer-btn")
            .addEventListener("click", () => {
              document
                .getElementById("shared-history-viewer-modal")
                .classList.remove("visible");
            });

          // åˆ›å»ºæ–°å‡½æ•°æ¥å¤„ç†æ¸²æŸ“é€»è¾‘
          function openSharedHistoryViewer(timestamp) {
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find((m) => m.timestamp === timestamp);
            if (!message || message.type !== "share_card") return;

            const viewerModal = document.getElementById(
              "shared-history-viewer-modal",
            );
            const viewerTitle = document.getElementById(
              "shared-history-viewer-title",
            );
            const viewerContent = document.getElementById(
              "shared-history-viewer-content",
            );

            viewerTitle.textContent = message.payload.title;
            viewerContent.innerHTML = ""; // æ¸…ç©ºæ—§å†…å®¹

            // å¤ç”¨ createMessageElement æ¥æ¸²æŸ“æ¯ä¸€æ¡è¢«åˆ†äº«çš„æ¶ˆæ¯
            message.payload.sharedHistory.forEach((sharedMsg) => {
              // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ sourceChat å¯¹è±¡ï¼Œä»¥ç¡®ä¿å¤´åƒã€æ˜µç§°ç­‰æ­£ç¡®
              const sourceChat =
                Object.values(state.chats).find(
                  (c) => c.name === message.payload.sourceChatName,
                ) || chat;
              const bubbleEl = createMessageElement(sharedMsg, sourceChat);
              if (bubbleEl) {
                viewerContent.appendChild(bubbleEl);
              }
            });

            viewerModal.classList.add("visible");
          }

          audioPlayer.addEventListener("timeupdate", updateMusicProgressBar);

          audioPlayer.addEventListener("pause", () => {
            if (state.musicState.isActive) {
              state.musicState.isPlaying = false;
              updatePlayerUI();
            }
          });
          audioPlayer.addEventListener("play", () => {
            if (state.musicState.isActive) {
              state.musicState.isPlaying = true;
              updatePlayerUI();
            }
          });

          document
            .getElementById("playlist-body")
            .addEventListener("click", async (e) => {
              const target = e.target;
              if (target.classList.contains("delete-track-btn")) {
                const index = parseInt(target.dataset.index);
                const track = state.musicState.playlist[index];
                const confirmed = await showCustomConfirm(
                  "åˆ é™¤æ­Œæ›²",
                  `ç¡®å®šè¦ä»æ’­æ”¾åˆ—è¡¨ä¸­åˆ é™¤ã€Š${track.name}ã€‹å—ï¼Ÿ`,
                );
                if (confirmed) {
                  deleteTrack(index);
                }
                return;
              }

              if (target.classList.contains("cover-btn")) {
                const index = parseInt(target.dataset.index);
                if (!isNaN(index)) {
                  handleCoverUpload(index);
                }
                return; // å¤„ç†å®Œå°±é€€å‡ºï¼Œé¿å…è§¦å‘å…¶ä»–é€»è¾‘
              }

              if (target.classList.contains("lyrics-btn")) {
                const index = parseInt(target.dataset.index);
                if (isNaN(index)) return;

                // 1. å¼¹çª—è¯¢é—®ç”¨æˆ·é€‰æ‹©ï¼ˆå·²ç§»é™¤å›¾æ ‡ï¼‰
                const choice = await showChoiceModal("é€‰æ‹©æ­Œè¯æ¥æº", [
                  { text: "ä½¿ç”¨ç½‘ç»œURL", value: "url" },
                  { text: "ä»æœ¬åœ°ä¸Šä¼ ", value: "local" },
                ]);

                let lrcContent = null;

                // 2. æ ¹æ®é€‰æ‹©æ‰§è¡Œä¸åŒæ“ä½œ
                if (choice === "url") {
                  const url = await showCustomPrompt(
                    "æ­Œè¯URL",
                    "è¯·è¾“å…¥.lrcæ­Œè¯æ–‡ä»¶çš„ç½‘ç»œé“¾æ¥",
                  );
                  if (url && url.trim()) {
                    try {
                      const response = await fetch(url.trim());
                      if (response.ok) {
                        lrcContent = await response.text();
                      } else {
                        alert("æ— æ³•è·å–æ­Œè¯æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®ã€‚");
                      }
                    } catch (error) {
                      alert("è·å–æ­Œè¯å¤±è´¥: " + error.message);
                    }
                  }
                } else if (choice === "local") {
                  lrcContent = await new Promise((resolve) => {
                    const lrcInput =
                      document.getElementById("lrc-upload-input");
                    const handler = (event) => {
                      const file = event.target.files[0];
                      if (file) {
                        const reader = new FileReader();
                        reader.onload = (re) => resolve(re.target.result);
                        reader.readAsText(file);
                      } else {
                        resolve(null);
                      }
                      lrcInput.removeEventListener("change", handler);
                      lrcInput.value = "";
                    };
                    lrcInput.addEventListener("change", handler);
                    lrcInput.click();
                  });
                }

                // 3. å¦‚æœæˆåŠŸè·å–åˆ°æ­Œè¯ï¼Œå°±ä¿å­˜å¹¶æ›´æ–°
                if (lrcContent !== null) {
                  state.musicState.playlist[index].lrcContent = lrcContent;
                  await saveGlobalPlaylist();
                  alert("æ­Œè¯å¯¼å…¥æˆåŠŸï¼");
                  if (state.musicState.currentIndex === index) {
                    state.musicState.parsedLyrics = parseLRC(lrcContent);
                    renderLyrics();
                  }
                }
              }
            });

          document
            .querySelector(".progress-bar")
            .addEventListener("click", (e) => {
              if (!audioPlayer.duration) return;
              const progressBar = e.currentTarget;
              const barWidth = progressBar.clientWidth;
              const clickX = e.offsetX;
              audioPlayer.currentTime =
                (clickX / barWidth) * audioPlayer.duration;
            });

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰â€œå·²æ’¤å›æ¶ˆæ¯â€çš„ç‚¹å‡»äº‹ä»¶
          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              // æ£€æŸ¥è¢«ç‚¹å‡»çš„å…ƒç´ æˆ–å…¶çˆ¶å…ƒç´ æ˜¯å¦æ˜¯â€œå·²æ’¤å›â€æç¤º
              const placeholder = e.target.closest(
                ".recalled-message-placeholder",
              );
              if (!placeholder) return; // å¦‚æœä¸æ˜¯ï¼Œå°±é€€å‡º

              // å¦‚æœæ˜¯ï¼Œå°±ä»èŠå¤©è®°å½•ä¸­æ‰¾åˆ°å¯¹åº”çš„æ•°æ®å¹¶æ˜¾ç¤º
              const chat = state.chats[state.activeChatId];
              const wrapper = placeholder.closest(".message-wrapper"); // æ‰¾åˆ°å®ƒçš„çˆ¶å®¹å™¨
              if (chat && wrapper) {
                // ä»çˆ¶å®¹å™¨ä¸Šæ‰¾åˆ°æ—¶é—´æˆ³
                const timestamp = parseInt(wrapper.dataset.timestamp);
                const recalledMsg = chat.history.find(
                  (m) => m.timestamp === timestamp,
                );

                if (recalledMsg && recalledMsg.recalledData) {
                  let originalContentText = "";
                  const recalled = recalledMsg.recalledData;

                  if (recalled.originalType === "text") {
                    originalContentText = `åŸæ–‡: "${recalled.originalContent}"`;
                  } else {
                    originalContentText = `æ’¤å›äº†ä¸€æ¡[${recalled.originalType}]ç±»å‹çš„æ¶ˆæ¯`;
                  }
                  showCustomAlert("å·²æ’¤å›çš„æ¶ˆæ¯", originalContentText);
                }
              }
            });

          document
            .getElementById("close-category-manager-btn")
            .addEventListener("click", () => {
              document
                .getElementById("world-book-category-manager-modal")
                .classList.remove("visible");
              renderWorldBookScreen(); // å…³é—­ååˆ·æ–°ä¸»åˆ—è¡¨
            });
          document
            .getElementById("add-new-category-btn")
            .addEventListener("click", addNewCategory);
          document
            .getElementById("existing-categories-list")
            .addEventListener("click", (e) => {
              if (e.target.classList.contains("delete-group-btn")) {
                const categoryId = parseInt(e.target.dataset.id);
                deleteCategory(categoryId);
              }
            });

          // --- è‡ªå®šä¹‰å¤´åƒæ¡†åŠŸèƒ½äº‹ä»¶ç»‘å®š ---

          // æ‰“å¼€â€œé€‰æ‹©â€å¼¹çª—çš„æŒ‰é’®
          document
            .getElementById("chat-settings-modal")
            .addEventListener("click", (e) => {
              if (e.target.classList.contains("change-frame-btn")) {
                openFrameSelectorModal(e.target.dataset.type);
              }
            });
          document
            .getElementById("member-settings-modal")
            .addEventListener("click", (e) => {
              if (e.target.classList.contains("change-frame-btn")) {
                openFrameSelectorModal("member", editingMemberId);
              }
            });

          // â€œé€‰æ‹©â€å¼¹çª—å†…çš„æŒ‰é’®
          // â€œé€‰æ‹©â€å¼¹çª—å†…çš„æŒ‰é’®ï¼ˆå·²ä¿®æ­£ï¼‰
          document
            .getElementById("manage-custom-frames-btn")
            .addEventListener("click", () => {
              // 1. å…ˆå…³é—­å½“å‰çš„é€‰æ‹©å¼¹çª—
              document
                .getElementById("avatar-frame-modal")
                .classList.remove("visible");

              // 2. ç„¶åå†æ‰“å¼€ç®¡ç†å¼¹çª—
              openFrameManager();
            });
          document
            .getElementById("cancel-frame-settings-btn")
            .addEventListener("click", () =>
              document
                .getElementById("avatar-frame-modal")
                .classList.remove("visible"),
            );
          document
            .getElementById("save-frame-settings-btn")
            .addEventListener("click", saveSelectedFrames);

          // â€œç®¡ç†â€å¼¹çª—å†…çš„æŒ‰é’®
          document
            .getElementById("upload-custom-frame-btn")
            .addEventListener("click", handleUploadCustomFrame);
          document
            .getElementById("close-frame-manager-btn")
            .addEventListener("click", () => {
              document
                .getElementById("custom-frame-manager-modal")
                .classList.remove("visible");
              // å…³é—­ç®¡ç†åï¼Œåˆ·æ–°é€‰æ‹©ç•Œé¢ï¼Œå› ä¸ºåˆ—è¡¨å¯èƒ½å˜äº†
              openFrameSelectorModal(
                currentFrameSelection.type,
                currentFrameSelection.target,
              );
            });

          // èŠå¤©åˆ—è¡¨å·¦æ»‘åŠŸèƒ½JSé€»è¾‘
          const chatListEl = document.getElementById("chat-list");
          let chatSwipeState = {
            isDragging: false,
            startX: 0,
            activeContent: null,
          };

          // å…³é—­æ‰€æœ‰å·²æ»‘å¼€çš„é¡¹
          function resetAllChatSwipes(exceptThisOne = null) {
            document
              .querySelectorAll(".chat-list-item-content.swiped")
              .forEach((content) => {
                if (content !== exceptThisOne) {
                  content.classList.remove("swiped");
                }
              });
          }

          chatListEl.addEventListener("mousedown", (e) => {
            const content = e.target.closest(".chat-list-item-content");
            if (content) {
              resetAllChatSwipes(content);
              chatSwipeState.isDragging = true;
              chatSwipeState.startX = e.pageX;
              chatSwipeState.activeContent = content;
              // é˜»æ­¢æ‹–åŠ¨æ—¶é€‰ä¸­æ–‡æœ¬
              e.preventDefault();
            }
          });

          document.addEventListener("mousemove", (e) => {
            if (!chatSwipeState.isDragging || !chatSwipeState.activeContent)
              return;
            const diffX = e.pageX - chatSwipeState.startX;
            if (diffX < 0 && diffX > -170) {
              // åªå…è®¸å‘å·¦æ»‘, é™åˆ¶æœ€å¤§è·ç¦»
              chatSwipeState.activeContent.style.transition = "none"; // æ»‘åŠ¨æ—¶ç¦ç”¨åŠ¨ç”»
              chatSwipeState.activeContent.style.transform = `translateX(${diffX}px)`;
            }
          });

          document.addEventListener("mouseup", (e) => {
            if (!chatSwipeState.isDragging || !chatSwipeState.activeContent)
              return;

            chatSwipeState.activeContent.style.transition =
              "transform 0.3s ease";
            const transformStyle = window.getComputedStyle(
              chatSwipeState.activeContent,
            ).transform;
            const currentTranslateX = new DOMMatrix(transformStyle).m41;

            if (currentTranslateX < -60) {
              // æ»‘åŠ¨è¶…è¿‡é˜ˆå€¼
              chatSwipeState.activeContent.classList.add("swiped");
            } else {
              chatSwipeState.activeContent.classList.remove("swiped");
            }
            chatSwipeState.activeContent.style.transform = ""; // æ¸…é™¤å†…è”æ ·å¼ï¼Œäº¤ç”±CSS classæ§åˆ¶

            // é‡ç½®çŠ¶æ€
            chatSwipeState.isDragging = false;
            chatSwipeState.activeContent = null;
          });

          // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶çš„å…¼å®¹
          chatListEl.addEventListener(
            "touchstart",
            (e) => {
              const content = e.target.closest(".chat-list-item-content");
              if (content) {
                resetAllChatSwipes(content);
                chatSwipeState.isDragging = true;
                chatSwipeState.startX = e.touches[0].pageX;
                chatSwipeState.activeContent = content;
              }
            },
            { passive: true },
          );

          chatListEl.addEventListener(
            "touchmove",
            (e) => {
              if (!chatSwipeState.isDragging || !chatSwipeState.activeContent)
                return;
              const diffX = e.touches[0].pageX - chatSwipeState.startX;
              if (diffX < 0 && diffX > -170) {
                chatSwipeState.activeContent.style.transition = "none";
                chatSwipeState.activeContent.style.transform = `translateX(${diffX}px)`;
              }
            },
            { passive: true },
          );

          chatListEl.addEventListener("touchend", (e) => {
            if (!chatSwipeState.isDragging || !chatSwipeState.activeContent)
              return;

            chatSwipeState.activeContent.style.transition =
              "transform 0.3s ease";
            const transformStyle = window.getComputedStyle(
              chatSwipeState.activeContent,
            ).transform;
            const currentTranslateX = new DOMMatrix(transformStyle).m41;

            if (currentTranslateX < -60) {
              chatSwipeState.activeContent.classList.add("swiped");
            } else {
              chatSwipeState.activeContent.classList.remove("swiped");
            }
            chatSwipeState.activeContent.style.transform = "";

            chatSwipeState.isDragging = false;
            chatSwipeState.activeContent = null;
          });

          // èŠå¤©åˆ—è¡¨æ“ä½œæŒ‰é’®ç‚¹å‡»äº‹ä»¶
          chatListEl.addEventListener("click", async (e) => {
            const target = e.target;
            if (target.classList.contains("swipe-action-btn")) {
              const container = target.closest(
                ".chat-list-item-swipe-container",
              );
              if (!container) return;

              const chatId = container.dataset.chatId;
              const chat = state.chats[chatId];
              if (!chat) return;

              if (
                target.classList.contains("pin") ||
                target.classList.contains("unpin")
              ) {
                // ç½®é¡¶æˆ–å–æ¶ˆç½®é¡¶
                chat.isPinned = !chat.isPinned;
                await db.chats.put(chat);
                await renderChatList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°æ’åº
              } else if (target.classList.contains("delete")) {
                // åˆ é™¤
                const confirmed = await showCustomConfirm(
                  "åˆ é™¤å¯¹è¯",
                  `ç¡®å®šè¦åˆ é™¤ä¸ "${chat.name}" çš„æ•´ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`,
                  { confirmButtonClass: "btn-danger" },
                );
                if (confirmed) {
                  if (
                    state.musicState.isActive &&
                    state.musicState.activeChatId === chat.id
                  )
                    await endListenTogetherSession(false);
                  delete state.chats[chat.id];
                  if (state.activeChatId === chat.id) state.activeChatId = null;
                  await db.chats.delete(chat.id);
                  await renderChatList();
                } else {
                  // å¦‚æœå–æ¶ˆåˆ é™¤ï¼Œåˆ™æŠŠæ»‘å—æ”¶å›å»
                  const content = container.querySelector(
                    ".chat-list-item-content",
                  );
                  if (content) content.classList.remove("swiped");
                }
              }
            }
          });

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰ç‚¹å‡»å’Œå‹¾é€‰äº‹ä»¶ï¼Œæ•ˆç‡æ›´é«˜
          worldBookCheckboxesContainer.addEventListener("click", (e) => {
            const header = e.target.closest(".wb-category-header");
            // å¦‚æœç‚¹å‡»çš„æ˜¯æ–‡ä»¶å¤¹å¤´éƒ¨ï¼Œå¹¶ä¸”ä¸æ˜¯ç‚¹åœ¨å¤é€‰æ¡†ä¸Š
            if (header && !e.target.matches('input[type="checkbox"]')) {
              const categoryId = header.querySelector(".wb-category-checkbox")
                ?.dataset.categoryId;
              if (categoryId) {
                const bookContainer =
                  worldBookCheckboxesContainer.querySelector(
                    `.wb-book-container[data-container-for="${categoryId}"]`,
                  );
                if (bookContainer) {
                  header.classList.toggle("collapsed");
                  bookContainer.classList.toggle("collapsed");
                }
              }
            }
          });

          worldBookCheckboxesContainer.addEventListener("change", (e) => {
            const target = e.target;

            // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ†ç±»çš„â€œå…¨é€‰â€å¤é€‰æ¡†
            if (target.classList.contains("wb-category-checkbox")) {
              const categoryId = target.dataset.categoryId;
              const isChecked = target.checked;
              // æ‰¾åˆ°è¿™ä¸ªåˆ†ç±»ä¸‹çš„æ‰€æœ‰ä¹¦ç±å¤é€‰æ¡†ï¼Œå¹¶å°†å®ƒä»¬çš„çŠ¶æ€è®¾ç½®ä¸ºä¸åˆ†ç±»å¤é€‰æ¡†ä¸€è‡´
              const bookCheckboxes =
                worldBookCheckboxesContainer.querySelectorAll(
                  `input.wb-book-checkbox[data-parent-category="${categoryId}"]`,
                );
              bookCheckboxes.forEach((cb) => (cb.checked = isChecked));
            }

            // å¦‚æœç‚¹å‡»çš„æ˜¯å•ä¸ªä¹¦ç±çš„å¤é€‰æ¡†
            if (target.classList.contains("wb-book-checkbox")) {
              const categoryId = target.dataset.parentCategory;
              if (categoryId) {
                // æ£€æŸ¥å®ƒæ˜¯å¦å±äºä¸€ä¸ªåˆ†ç±»
                const categoryCheckbox =
                  worldBookCheckboxesContainer.querySelector(
                    `input.wb-category-checkbox[data-category-id="${categoryId}"]`,
                  );
                const allBookCheckboxes =
                  worldBookCheckboxesContainer.querySelectorAll(
                    `input.wb-book-checkbox[data-parent-category="${categoryId}"]`,
                  );
                // æ£€æŸ¥è¯¥åˆ†ç±»ä¸‹æ˜¯å¦æ‰€æœ‰ä¹¦ç±éƒ½è¢«é€‰ä¸­äº†
                const allChecked = Array.from(allBookCheckboxes).every(
                  (cb) => cb.checked,
                );
                // åŒæ­¥åˆ†ç±»â€œå…¨é€‰â€å¤é€‰æ¡†çš„çŠ¶æ€
                if (categoryCheckbox) categoryCheckbox.checked = allChecked;
              }
            }

            // æ¯æ¬¡å˜æ›´åéƒ½æ›´æ–°é¡¶éƒ¨çš„å·²é€‰æ•°é‡æ˜¾ç¤º
            updateWorldBookSelectionDisplay();
          });

          // --- ç¾åŒ–åŠŸèƒ½äº‹ä»¶ç»‘å®š ---
          const themeEditor = document.getElementById("theme-css-editor");

          // é¡µé¢åŠ è½½æ—¶ï¼ŒåŠ è½½ä¸»é¢˜åˆ—è¡¨å¹¶æ˜¾ç¤ºæ¨¡æ¿
          await loadThemesToDropdown();
          themeEditor.value = THEME_CSS_TEMPLATE;

          // ç»‘å®šä¸‹æ‹‰æ¡†é€‰æ‹©äº‹ä»¶
          document
            .getElementById("theme-selector")
            .addEventListener("change", handleThemeSelection);

          // ç»‘å®šæ‰€æœ‰æ“ä½œæŒ‰é’®
          document
            .getElementById("apply-theme-btn")
            .addEventListener("click", () => applyThemeCss(themeEditor.value));
          document
            .getElementById("save-theme-btn")
            .addEventListener("click", saveCurrentTheme);
          document
            .getElementById("save-as-new-theme-btn")
            .addEventListener("click", saveAsNewTheme);
          document
            .getElementById("rename-theme-btn")
            .addEventListener("click", renameSelectedTheme);
          document
            .getElementById("delete-theme-btn")
            .addEventListener("click", deleteSelectedTheme);
          document
            .getElementById("export-theme-btn")
            .addEventListener("click", exportTheme);
          document
            .getElementById("reset-theme-css-btn")
            .addEventListener("click", async () => {
              const confirmed = await showCustomConfirm(
                "é‡ç½®CSS",
                "ç¡®å®šè¦å°†CSSé‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿å—ï¼Ÿ\nå½“å‰ç¼–è¾‘æ¡†å†…çš„ä»£ç å°†ä¸¢å¤±ã€‚",
                { confirmButtonClass: "btn-danger" },
              );

              if (confirmed) {
                const editor = document.getElementById("theme-css-editor");
                // æ¢å¤ä¸ºé»˜è®¤çš„æ³¨é‡Šæ¨¡æ¿
                editor.value = THEME_CSS_TEMPLATE;
                // ç«‹å³åº”ç”¨æ•ˆæœ
                applyThemeCss(THEME_CSS_TEMPLATE);

                // é‡ç½®ä¸‹æ‹‰æ¡†é€‰æ‹©çŠ¶æ€
                document.getElementById("theme-selector").value = "";
                state.globalSettings.activeThemeId = null;

                alert("å·²é‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿ (è¯·ç‚¹å‡»'ä¿å­˜'ä»¥åº”ç”¨æ›´æ”¹åˆ°ç³»ç»Ÿ)");
              }
            });
          document
            .getElementById("manage-char-css-btn")
            .addEventListener("click", openCharCssManager);
          // ç»‘å®šå¯¼å…¥æŒ‰é’®å’Œéšè—çš„æ–‡ä»¶é€‰æ‹©å™¨
          document
            .getElementById("import-theme-btn")
            .addEventListener("click", () => {
              document.getElementById("import-theme-input").click();
            });
          document
            .getElementById("import-theme-input")
            .addEventListener("change", (e) => {
              importTheme(e.target.files[0]);
              e.target.value = null; // æ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
            });

          document
            .getElementById("api-preset-select")
            .addEventListener("change", handleApiPresetSelectChange);
          document
            .getElementById("manage-api-presets-btn")
            .addEventListener("click", openApiPresetManager);

          // é”å±åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨

          // 1. é”å±å£çº¸ä¸Šä¼ 
          document
            .getElementById("lockscreen-wallpaper-upload-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (file) {
                const dataUrl = await new Promise((res, rej) => {
                  const reader = new FileReader();
                  reader.onload = () => res(reader.result);
                  reader.onerror = () => rej(reader.error);
                  reader.readAsDataURL(file);
                });
                newLockscreenWallpaperBase64 = dataUrl;
                renderWallpaperScreen(); // ä¸Šä¼ åå®æ—¶é¢„è§ˆ
              }
            });

          // 2. å¯†ç è¾“å…¥æ¡†æŒ‰é’®
          document
            .getElementById("password-confirm-btn")
            .addEventListener("click", checkPassword);
          document
            .getElementById("password-cancel-btn")
            .addEventListener("click", hidePasswordModal);
          // å…è®¸åœ¨è¾“å…¥æ¡†å†…æŒ‰å›è½¦é”®ç¡®è®¤
          document
            .getElementById("password-input-field")
            .addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                checkPassword();
              }
            });

          // 3. å¸¦æœ‰åŠ¨ç”»æ•ˆæœçš„ä¸Šæ»‘è§£é”æ‰‹åŠ¿
          const lockScreen = document.getElementById("lock-screen");
          const unlockHint = document.getElementById("unlock-hint");
          let touchStartY = 0;
          let isSwiping = false;

          // ç»Ÿä¸€çš„å¼€å§‹å¤„ç†å‡½æ•°
          const handleUnlockStart = (e) => {
            if (
              document
                .getElementById("password-modal-overlay")
                .classList.contains("visible")
            )
              return;

            // (ä½ åŸæ¥çš„å…¶ä»–é€»è¾‘ä¿æŒä¸å˜)
            const blurBg = document.getElementById(
              "lock-screen-background-blur",
            );
            if (state.globalSettings.password) {
              blurBg.style.backgroundImage = lockScreen.style.backgroundImage;
              blurBg.style.display = "block";
            } else {
              document.getElementById("home-screen").classList.add("active");
            }

            touchStartY = getEventCoords(e).y; // ä½¿ç”¨è¾…åŠ©å‡½æ•°è·å–Yåæ ‡
            isSwiping = true;
            lockScreen.style.transition = "none";
            unlockHint.style.transition = "none";
          };

          // ç»Ÿä¸€çš„ç§»åŠ¨å¤„ç†å‡½æ•°
          const handleUnlockMove = (e) => {
            if (!isSwiping) return;
            const currentY = getEventCoords(e).y; // ä½¿ç”¨è¾…åŠ©å‡½æ•°
            let diffY = currentY - touchStartY;
            // (ä½ åŸæ¥çš„å…¶ä»–é€»è¾‘ä¿æŒä¸å˜)
            if (diffY > 0) diffY = 0;
            lockScreen.style.transform = `translateY(${diffY}px)`;
            unlockHint.style.opacity = Math.max(0, 1 - Math.abs(diffY) / 100);
            if (state.globalSettings.password) {
              const blurBg = document.getElementById(
                "lock-screen-background-blur",
              );
              blurBg.style.opacity = Math.min(1, Math.abs(diffY) / 80);
            }
          };

          // ç»Ÿä¸€çš„ç»“æŸå¤„ç†å‡½æ•°
          const handleUnlockEnd = (e) => {
            if (!isSwiping) return;
            isSwiping = false;

            lockScreen.style.transition = "transform 0.3s ease-out";
            unlockHint.style.transition = "opacity 0.3s ease-out";
            const blurBg = document.getElementById(
              "lock-screen-background-blur",
            );

            // æ³¨æ„ï¼štouchendäº‹ä»¶çš„åæ ‡åœ¨ e.changedTouches[0]
            const touchEndY = e.changedTouches
              ? e.changedTouches[0].clientY
              : e.pageY;
            const swipeDistance = touchStartY - touchEndY;

            if (swipeDistance > 80) {
              lockScreen.style.transform = "translateY(-100%)";
              setTimeout(() => {
                if (state.globalSettings.password) {
                  showPasswordModal();
                } else {
                  unlockPhone();
                }
              }, 300);
            } else {
              lockScreen.style.transform = "translateY(0)";
              unlockHint.style.opacity = "1";
              if (state.globalSettings.password) {
                blurBg.style.opacity = "0";
                setTimeout(() => {
                  blurBg.style.display = "none";
                }, 300);
              } else {
                document
                  .getElementById("home-screen")
                  .classList.remove("active");
              }
            }
          };

          // 2. ç»‘å®šä¸¤ç§äº‹ä»¶åˆ°åŒä¸€å¥—å¤„ç†é€»è¾‘ä¸Š
          lockScreen.addEventListener("touchstart", handleUnlockStart, {
            passive: true,
          });
          lockScreen.addEventListener("touchmove", handleUnlockMove, {
            passive: true,
          });
          lockScreen.addEventListener("touchend", handleUnlockEnd, {
            passive: true,
          });

          lockScreen.addEventListener("mousedown", handleUnlockStart);
          // æ³¨æ„ï¼šmousemoveå’Œmouseupæœ€å¥½ç»‘å®šåœ¨documentä¸Šï¼Œé˜²æ­¢é¼ æ ‡æ‹–å‡ºèŒƒå›´åå¤±æ•ˆ
          document.addEventListener("mousemove", handleUnlockMove);
          document.addEventListener("mouseup", handleUnlockEnd);

          // ã€å…¨æ–°ã€‘ä¸ºèŠå¤©åº•éƒ¨å·¥å…·æ æ·»åŠ é¼ æ ‡æ‹–åŠ¨æ»šåŠ¨åŠŸèƒ½
          const actionsTopBar = document.getElementById(
            "chat-input-actions-top",
          );
          let isDown = false;
          let startX;
          let scrollLeft;

          actionsTopBar.addEventListener("mousedown", (e) => {
            isDown = true;
            actionsTopBar.classList.add("grabbing"); // æ·»åŠ ä¸€ä¸ªclassæ¥æ”¹å˜é¼ æ ‡æ ·å¼
            startX = e.pageX - actionsTopBar.offsetLeft;
            scrollLeft = actionsTopBar.scrollLeft;
          });

          actionsTopBar.addEventListener("mouseleave", () => {
            isDown = false;
            actionsTopBar.classList.remove("grabbing");
          });

          actionsTopBar.addEventListener("mouseup", () => {
            isDown = false;
            actionsTopBar.classList.remove("grabbing");
          });

          actionsTopBar.addEventListener("mousemove", (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - actionsTopBar.offsetLeft;
            const walk = (x - startX) * 2; // ä¹˜ä»¥2å¯ä»¥å¢åŠ æ‹–åŠ¨é€Ÿåº¦ï¼Œæ„Ÿè§‰æ›´çµæ•
            actionsTopBar.scrollLeft = scrollLeft - walk;
          });

          document
            .getElementById("location-cancel-btn")
            .addEventListener("click", () => {
              document
                .getElementById("send-location-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("location-confirm-btn")
            .addEventListener("click", sendUserLocation);

          // ã€å…¨æ–°ã€‘ä¸ºå®šä½æ¨¡æ€æ¡†çš„â€œæ·»åŠ é€”ç»ç‚¹â€æŒ‰é’®ç»‘å®šäº‹ä»¶
          document
            .getElementById("add-trajectory-point-btn")
            .addEventListener("click", () => {
              // é™åˆ¶æœ€å¤šæ·»åŠ 3ä¸ªé€”ç»ç‚¹ï¼Œé˜²æ­¢UIè¿‡äºæ‹¥æŒ¤
              if (
                document.querySelectorAll(".trajectory-point-input").length < 3
              ) {
                addTrajectoryPointInput();
              } else {
                alert("æœ€å¤šåªèƒ½æ·»åŠ 3ä¸ªé€”ç»ç‚¹å“¦ï¼");
              }
            });

          document
            .getElementById("send-location-btn")
            .addEventListener("click", () => {
              document.getElementById("trajectory-points-container").innerHTML =
                "";
              document
                .getElementById("send-location-modal")
                .classList.add("visible");
            });

          document
            .getElementById("reroll-btn")
            .addEventListener("click", handleRerollClick);

          // --- æ‚¬æµ®æ­Œè¯æ è®¾ç½®åŠŸèƒ½ ---
          document
            .getElementById("lyrics-settings-btn")
            .addEventListener("click", (e) => {
              e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡è§¦å‘æ‹–åŠ¨æˆ–æ‰“å¼€æ’­æ”¾å™¨
              document
                .getElementById("lyrics-settings-modal")
                .classList.add("visible");
            });

          document
            .getElementById("close-lyrics-settings-btn")
            .addEventListener("click", async () => {
              // ä¿å­˜è®¾ç½®åˆ°å…¨å±€çŠ¶æ€å¹¶å†™å…¥æ•°æ®åº“
              state.globalSettings.lyricsBarSettings = lyricsBarSettings;
              await db.globalSettings.put(state.globalSettings);
              document
                .getElementById("lyrics-settings-modal")
                .classList.remove("visible");
              alert("è®¾ç½®å·²ä¿å­˜ï¼");
            });

          document
            .getElementById("reset-lyrics-settings-btn")
            .addEventListener("click", () => {
              // æ¢å¤åˆ°é»˜è®¤å€¼
              lyricsBarSettings = {
                fontSize: 14,
                bgOpacity: 0,
                fontColor: "#FFFFFF",
                showOnClose: true,
              };
              applyLyricsSettings(); // åº”ç”¨é»˜è®¤è®¾ç½®
            });

          // å®æ—¶æ›´æ–°æ ·å¼
          document
            .getElementById("lyrics-font-size-slider")
            .addEventListener("input", (e) => {
              lyricsBarSettings.fontSize = e.target.value;
              applyLyricsSettings();
            });
          document
            .getElementById("lyrics-bg-opacity-slider")
            .addEventListener("input", (e) => {
              lyricsBarSettings.bgOpacity = e.target.value;
              applyLyricsSettings();
            });
          document
            .getElementById("lyrics-font-color-picker")
            .addEventListener("input", (e) => {
              lyricsBarSettings.fontColor = e.target.value;
              applyLyricsSettings();
            });

          // æ­Œè¯æ ä¸Šçš„å…³é—­æŒ‰é’®
          document
            .querySelector("#floating-lyrics-bar .close-btn")
            .addEventListener("click", (e) => {
              e.stopPropagation();
              document.getElementById("floating-lyrics-bar").style.display =
                "none";
            });

          // æ’­æ”¾å™¨é‡Œçš„â€œæ‚¬æµ®/éšè—â€å¼€å…³
          document
            .getElementById("toggle-lyrics-bar-btn")
            .addEventListener("click", async (e) => {
              lyricsBarSettings.showOnClose = !lyricsBarSettings.showOnClose;
              e.target.textContent = lyricsBarSettings.showOnClose
                ? "æ‚¬æµ®"
                : "éšè—";
              e.target.style.opacity = lyricsBarSettings.showOnClose
                ? "1"
                : "0.5";
              // ç«‹å³ä¿å­˜è¿™ä¸ªè®¾ç½®
              state.globalSettings.lyricsBarSettings = lyricsBarSettings;
              await db.globalSettings.put(state.globalSettings);
            });

          // åœ¨é¡µé¢åŠ è½½æ—¶ï¼Œå°±åº”ç”¨ä¸€æ¬¡å·²ä¿å­˜çš„è®¾ç½®
          applyLyricsSettings();
          // â€œæŸ¥è§’è‰²æ‰‹æœºâ€åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨

          // 1. ç»‘å®šä¸»å±å¹•ä¸Šçš„â€œæŸ¥æ‰‹æœºâ€APPå›¾æ ‡
          const checkPhoneAppIcon = document.querySelector(
            '.app-icon[data-app-id="check-phone"]',
          );
          if (checkPhoneAppIcon) {
            checkPhoneAppIcon.onclick = openCharacterSelectionScreen; // ä¿®æ”¹onclickäº‹ä»¶
          }

          // 2. è§’è‰²é€‰æ‹©åˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
          document
            .getElementById("character-selection-list")
            .addEventListener("click", (e) => {
              const item = e.target.closest(".character-select-item");
              if (item && item.dataset.chatId) {
                openCharacterPhone(item.dataset.chatId);
              }
            });

          // è§’è‰²æ‰‹æœºèŠå¤©åˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
          document
            .getElementById("character-chat-list")
            .addEventListener("click", (e) => {
              const item = e.target.closest(".chat-list-item");
              if (item && item.dataset.contactName) {
                const isUserChat = item.dataset.isUserChat === "true";
                console.log("ã€è¯Šæ–­æ—¥å¿— 2ã€‘: ç‚¹å‡»äº†èŠå¤©åˆ—è¡¨é¡¹", {
                  contactName: item.dataset.contactName,
                  isUserChat: isUserChat,
                });

                // å°†è”ç³»äººåå­—å’Œâ€œèº«ä»½è¯â€ä¸€èµ·ä¼ é€’ç»™æ¸²æŸ“å‡½æ•°
                renderCharacterChatHistory(
                  item.dataset.contactName,
                  isUserChat,
                );
                showCharacterPhonePage("character-chat-history-screen");
              }
            });

          // 3. è§’è‰²æ‰‹æœºé¡¶éƒ¨çš„â€œåˆ·æ–°â€å’Œâ€œæ¸…ç©ºâ€æŒ‰é’®
          document
            .getElementById("generate-character-data-btn")
            .addEventListener("click", generateCharacterPhoneData);
          document
            .getElementById("clear-character-data-btn")
            .addEventListener("click", clearCharacterPhoneData);

          // è§’è‰²æ‰‹æœºå†…éƒ¨ç»Ÿä¸€è¿”å›äº‹ä»¶ç›‘å¬å™¨
          document
            .getElementById("character-phone-container")
            .addEventListener("click", (e) => {
              const backBtn = e.target.closest(".back-btn");
              if (!backBtn) return;

              // æ£€æŸ¥æ˜¯è¿”å›åˆ°è§’è‰²æ‰‹æœºå†…éƒ¨é¡µé¢ï¼Œè¿˜æ˜¯è¿”å›åˆ°ä¸»å±å¹•
              if (backBtn.dataset.targetPage) {
                showCharacterPhonePage(backBtn.dataset.targetPage);
              } else if (backBtn.dataset.targetScreen) {
                showScreen(backBtn.dataset.targetScreen);
              }
            });

          // è§’è‰²æ‰‹æœºæ—¥è®°APPäº‹ä»¶ç›‘å¬å™¨
          document
            .getElementById("character-app-grid")
            .addEventListener("click", (e) => {
              const icon = e.target.closest(".app-icon");
              if (icon && icon.querySelector(".label").textContent === "æ—¥è®°") {
                renderCharacterDiary();
              }
            });
          document
            .getElementById("generate-diary-entry-btn")
            .addEventListener("click", generateNewDiaryEntry);

          // â€œæŸ¥æ‰‹æœºâ€å†…å®¹å•æ¡åˆ é™¤åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("character-phone-container")
            .addEventListener("click", (e) => {
              const deleteBtn = e.target.closest(".item-delete-btn");
              if (deleteBtn) {
                // å¤„ç†å¾®ä¿¡æ¶ˆæ¯åˆ é™¤
                if (deleteBtn.classList.contains("message-delete-btn")) {
                  const contactName = deleteBtn.dataset.contactName;
                  const index = parseInt(deleteBtn.dataset.index);
                  if (contactName && !isNaN(index)) {
                    handleCharacterChatMessageDeletion(contactName, index);
                  }
                }
                // å¤„ç†å…¶ä»–åˆ—è¡¨åˆ é™¤
                else {
                  const dataType = deleteBtn.dataset.type;
                  const index = parseInt(deleteBtn.dataset.index);
                  if (dataType && !isNaN(index)) {
                    handleCharacterDataDeletion(dataType, index);
                  }
                }
              }
            });

          // NPCåº“ç®¡ç†åŠŸèƒ½äº‹ä»¶ç»‘å®š

          // èŠå¤©è®¾ç½®é‡Œçš„â€œç®¡ç†NPCåº“â€æŒ‰é’®
          document
            .getElementById("chat-settings-modal")
            .addEventListener("click", (e) => {
              if (e.target.id === "manage-npcs-btn") {
                // å…ˆå…³é—­èŠå¤©è®¾ç½®ï¼Œå†æ‰“å¼€NPCç®¡ç†
                document
                  .getElementById("chat-settings-modal")
                  .classList.remove("visible");
                openNpcManager();
              }
            });

          // NPCç®¡ç†ç•Œé¢çš„è¿”å›æŒ‰é’®
          document
            .getElementById("back-from-npc-management")
            .addEventListener("click", () => {
              // è¿”å›æ—¶ï¼Œé‡æ–°æ‰“å¼€èŠå¤©è®¾ç½®
              showScreen("chat-interface-screen");
              document.getElementById("chat-settings-btn").click();
            });

          // NPCç®¡ç†ç•Œé¢çš„â€œ+â€æŒ‰é’®
          document
            .getElementById("add-new-npc-btn")
            .addEventListener("click", () => openNpcEditor(null));

          // --- åå°æ´»åŠ¨è®¾ç½®ç•Œé¢çš„äº‹ä»¶ç»‘å®š ---

          // 1. æ€»å¼€å…³çš„äº‹ä»¶
          document
            .getElementById("background-activity-switch")
            .addEventListener("change", () => {
              // æ¯æ¬¡ç‚¹å‡»æ€»å¼€å…³ï¼Œéƒ½é‡æ–°æ¸²æŸ“ä¸€æ¬¡è¯¦ç»†è®¾ç½®åŒºï¼ˆå®ƒä¼šæ ¹æ®å¼€å…³çŠ¶æ€è‡ªåŠ¨æ˜¾ç¤ºæˆ–éšè—ï¼‰
              renderBackgroundFrequencySelector();
            });

          // 2. å…¨é€‰æŒ‰é’®
          document
            .getElementById("bg-select-all-chars")
            .addEventListener("click", () => {
              document
                .querySelectorAll(".bg-char-checkbox")
                .forEach((checkbox) => {
                  checkbox.checked = true;
                });
            });

          // 3. å…¨ä¸é€‰æŒ‰é’®
          document
            .getElementById("bg-deselect-all-chars")
            .addEventListener("click", () => {
              document
                .querySelectorAll(".bg-char-checkbox")
                .forEach((checkbox) => {
                  checkbox.checked = false;
                });
            });

          document
            .querySelector("#background-activity-details")
            .addEventListener("click", async (e) => {
              // æ³¨æ„è¿™é‡ŒåŠ äº† async
              if (e.target.classList.contains("bg-freq-btn")) {
                const freq = e.target.dataset.freq;
                const selectedCheckboxes = document.querySelectorAll(
                  ".bg-char-checkbox:checked",
                );

                if (selectedCheckboxes.length === 0) {
                  alert("è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªè§’è‰²ï¼");
                  return;
                }

                const config =
                  state.globalSettings.backgroundActivityConfig || {};
                selectedCheckboxes.forEach((checkbox) => {
                  const chatId = checkbox.dataset.chatId;
                  if (freq === "none") {
                    delete config[chatId];
                  } else {
                    config[chatId] = freq;
                  }
                });

                state.globalSettings.backgroundActivityConfig = config;

                // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬æ–°åŠ çš„å…³é”®ä»£ç ï¼â˜…â˜…â˜…
                await db.globalSettings.put(state.globalSettings);

                renderBackgroundFrequencySelector();

                const freqTextMap = {
                  low: "ä½",
                  medium: "ä¸­",
                  high: "é«˜",
                  none: "å…³é—­",
                };
                const freqText = freqTextMap[freq];
                alert(
                  `å·²ä¸º ${selectedCheckboxes.length} ä¸ªè§’è‰²å°†åå°æ´»åŠ¨é¢‘ç‡è®¾ä¸º "${freqText}"`,
                );
              }
            });
          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºæ‰€æœ‰å¯ç¼–è¾‘å…ƒç´ ç»Ÿä¸€ç»‘å®šç‚¹å‡»äº‹ä»¶

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºæ‰€æœ‰å¯ç¼–è¾‘å…ƒç´ ç»Ÿä¸€ç»‘å®šç‚¹å‡»äº‹ä»¶
          document
            .getElementById("home-screen")
            .addEventListener("click", async (e) => {
              // <-- æŠŠè¿™è¡Œä¹Ÿæ”¹æˆ async
              // ä½¿ç”¨ .closest() æ¥ç¡®ä¿å³ä½¿ç‚¹å‡»åˆ°å­å…ƒç´ ä¹Ÿèƒ½æ­£ç¡®è§¦å‘
              const editableText = e.target.closest(".editable-text");
              if (editableText) {
                handleEditText(editableText);
                return; // å¤„ç†å®Œå°±é€€å‡ºï¼Œé¿å…é‡å¤è§¦å‘
              }

              const editableImage = e.target.closest(".editable-image");
              if (editableImage) {
                // 1. åˆ¤æ–­è¢«ç‚¹å‡»çš„å›¾ç‰‡æ˜¯ä¸æ˜¯ä¸»å±å¹•çš„é‚£ä¸ªå¤§å¤´åƒ
                if (editableImage.id === "profile-avatar-img") {
                  // 2. å¦‚æœæ˜¯ï¼Œå°±å¼¹å‡ºä¸€ä¸ªé€‰æ‹©èœå•
                  const choice = await showChoiceModal("ç¼–è¾‘å¤´åƒ", [
                    { text: "æ›´æ¢å¤´åƒå›¾ç‰‡", value: "avatar" },
                    { text: "æ›´æ¢å¤´åƒæ¡†", value: "frame" },
                  ]);

                  // 3. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ï¼Œæ‰§è¡Œä¸åŒçš„æ“ä½œ
                  if (choice === "avatar") {
                    handleEditImage(editableImage); // è°ƒç”¨åŸæ¥çš„æ›´æ¢å›¾ç‰‡å‡½æ•°
                  } else if (choice === "frame") {
                    openFrameSelectorModal("home_profile"); // è°ƒç”¨æˆ‘ä»¬æ–°å¢çš„æ›´æ¢å¤´åƒæ¡†å‡½æ•°
                  }
                } else {
                  // 4. å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ä¸»å¤´åƒï¼ˆæ¯”å¦‚æ˜¯å…¶ä»–å°ç»„ä»¶çš„å›¾ç‰‡ï¼‰ï¼Œå°±è¿˜æ‰§è¡ŒåŸæ¥çš„é€»è¾‘
                  handleEditImage(editableImage);
                }

                return;
              }
            });

          // â–¼â€œæŸ¥æ‰‹æœºâ€å†…å®¹å•æ¡åˆ é™¤åŠŸèƒ½
          /**
           * å¤„ç†è§’è‰²æ‰‹æœºå†…æ•°æ®åˆ é™¤çš„é€šç”¨å‡½æ•°
           * @param {string} dataType - è¦åˆ é™¤çš„æ•°æ®ç±»å‹, æ¯”å¦‚ 'memos', 'shoppingCart'
           * @param {number} index - è¦åˆ é™¤çš„æ•°æ®åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
           */
          async function handleCharacterDataDeletion(dataType, index) {
            if (!activeCharacterPhoneId) return;
            const chat = state.chats[activeCharacterPhoneId];

            let dataArray;

            if (dataType.includes(".")) {
              const keys = dataType.split(".");
              dataArray = chat.characterPhoneData[keys[0]][keys[1]];
            } else {
              dataArray = chat.characterPhoneData[dataType];
            }

            if (!chat || !dataArray) return;

            const itemToDelete = dataArray[index];
            if (!itemToDelete) return;

            const confirmed = await showCustomConfirm(
              "ç¡®è®¤åˆ é™¤",
              "ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ",
              {
                confirmButtonClass: "btn-danger",
              },
            );

            if (confirmed) {
              dataArray.splice(index, 1);
              await db.chats.put(chat);

              // æ ¹æ®åˆ é™¤çš„ç±»å‹ï¼Œé‡æ–°æ¸²æŸ“å¯¹åº”çš„APPç•Œé¢
              switch (dataType) {
                case "memos":
                  renderCharacterMemos();
                  break;
                case "shoppingCart":
                  renderCharacterShoppingCart();
                  break;
                case "browserHistory":
                  renderCharacterBrowser();
                  break;
                case "diary":
                  renderCharacterDiary();
                  break;
                case "bank.transactions":
                  renderCharacterBank();
                  break; // æ–°å¢
                case "trajectory":
                  renderCharacterTrajectory();
                  break; // æ–°å¢
                case "appUsage":
                  renderCharacterAppUsage();
                  break; // æ–°å¢
                case "photoAlbum":
                  renderCharacterPhotoAlbum();
                  break; // æ–°å¢
              }
              alert("è®°å½•å·²åˆ é™¤ã€‚");
            }
          }
          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰åˆ é™¤æŒ‰é’®çš„ç‚¹å‡»
          document
            .getElementById("character-phone-container")
            .addEventListener("click", (e) => {
              if (e.target.classList.contains("item-delete-btn")) {
                const dataType = e.target.dataset.type;
                const index = parseInt(e.target.dataset.index);
                if (dataType && !isNaN(index)) {
                  handleCharacterDataDeletion(dataType, index);
                }
              }
            });

          // â€œæŸ¥æ‰‹æœºâ€å†…å®¹å•æ¡åˆ é™¤åŠŸèƒ½
          /**
           * å¤„ç†è§’è‰²æ‰‹æœºå†…æ•°æ®åˆ é™¤çš„é€šç”¨å‡½æ•°
           * @param {string} dataType - è¦åˆ é™¤çš„æ•°æ®ç±»å‹, æ¯”å¦‚ 'memos', 'shoppingCart'
           * @param {number} index - è¦åˆ é™¤çš„æ•°æ®åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
           */
          async function handleCharacterDataDeletion(dataType, index) {
            if (!activeCharacterPhoneId) return;
            const chat = state.chats[activeCharacterPhoneId];

            let dataArray;
            // å¤„ç†åƒ bank.transactions è¿™æ ·çš„åµŒå¥—æ•°æ®
            if (dataType.includes(".")) {
              const keys = dataType.split(".");
              dataArray = chat.characterPhoneData[keys[0]][keys[1]];
            } else {
              dataArray = chat.characterPhoneData[dataType];
            }

            if (!chat || !dataArray) return;

            const itemToDelete = dataArray[index];
            if (!itemToDelete) return;

            const confirmed = await showCustomConfirm(
              "ç¡®è®¤åˆ é™¤",
              "ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ",
              {
                confirmButtonClass: "btn-danger",
              },
            );

            if (confirmed) {
              dataArray.splice(index, 1);
              await db.chats.put(chat);

              // æ ¹æ®åˆ é™¤çš„ç±»å‹ï¼Œé‡æ–°æ¸²æŸ“å¯¹åº”çš„APPç•Œé¢
              switch (dataType) {
                case "memos":
                  renderCharacterMemos();
                  break;
                case "shoppingCart":
                  renderCharacterShoppingCart();
                  break;
                case "browserHistory":
                  renderCharacterBrowser();
                  break;
                case "diary":
                  renderCharacterDiary();
                  break;
                case "bank.transactions":
                  renderCharacterBank();
                  break;
                case "trajectory":
                  renderCharacterTrajectory();
                  break;
                case "appUsage":
                  renderCharacterAppUsage();
                  break;
                case "photoAlbum":
                  renderCharacterPhotoAlbum();
                  break;
              }
              alert("è®°å½•å·²åˆ é™¤ã€‚");
            }
          }

          startGroupSimulation(); // å¯åŠ¨ç¾¤èŠä¸“å±çš„åå°æ—¶é’Ÿ
          handleAutoBackupTimer();
          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œç›‘å¬æ•´ä¸ªåŠ¨æ€åˆ—è¡¨çš„â€œç„¦ç‚¹ç§»å‡ºâ€äº‹ä»¶
          document
            .getElementById("qzone-posts-list")
            .addEventListener("focusout", (e) => {
              // å¦‚æœæ˜¯è¯„è®ºè¾“å…¥æ¡†å¤±å»äº†ç„¦ç‚¹
              if (e.target.classList.contains("comment-input")) {
                const commentInput = e.target;
                // å¹¶ä¸”è¾“å…¥æ¡†æ˜¯ç©ºçš„
                if (commentInput.value.trim() === "") {
                  // å°±é‡ç½®å®ƒçš„çŠ¶æ€ï¼Œå–æ¶ˆå›å¤
                  commentInput.placeholder = "å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹";
                  delete commentInput.dataset.replyTo;
                }
              }
            });

          // ä¸ºæ—¶é—´æ„ŸçŸ¥å¼€å…³æ·»åŠ å®æ—¶äº¤äº’äº‹ä»¶
          document
            .getElementById("time-perception-toggle")
            .addEventListener("change", (e) => {
              const customTimeContainer = document.getElementById(
                "custom-time-container",
              );
              customTimeContainer.style.display = e.target.checked
                ? "none"
                : "block";
            });

          document
            .getElementById("char-heart-btn")
            .addEventListener("click", openInnerVoiceModal);

          document
            .getElementById("close-inner-voice-modal")
            .addEventListener("click", () => {
              document
                .getElementById("inner-voice-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("inner-voice-history-btn")
            .addEventListener("click", toggleInnerVoiceHistory);
          document
            .getElementById("back-from-history-btn")
            .addEventListener("click", toggleInnerVoiceHistory);

          /**
           * å¯¼å‡ºå½“å‰è§’è‰²çš„èŠå¤©è®°å½•
           */
          async function exportChatHistory() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            if (!chat) return;

            // 1. åˆ›å»ºä¸€ä¸ªåªåŒ…å«èŠå¤©è®°å½•å’Œè§’è‰²åçš„å¯¹è±¡
            const exportData = {
              characterName: chat.name,
              exportedAt: new Date().toISOString(),
              history: chat.history,
            };

            // 2. å°†è¿™ä¸ªå¯¹è±¡è½¬æ¢ä¸ºæ ¼å¼åŒ–çš„JSONå­—ç¬¦ä¸²
            const jsonString = JSON.stringify(exportData, null, 2);

            // 3. åˆ›å»ºä¸€ä¸ªBlobå¯¹è±¡
            const blob = new Blob([jsonString], { type: "application/json" });

            // 4. åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ä¸‹è½½é“¾æ¥
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");

            // 5. è®¾ç½®ä¸‹è½½é“¾æ¥çš„å±æ€§ï¼ŒåŒ…æ‹¬æ–‡ä»¶å
            const dateStr = new Date().toISOString().split("T")[0];
            link.href = url;
            link.download = `[${chat.name}]-èŠå¤©è®°å½•-${dateStr}.json`;

            // 6. æ¨¡æ‹Ÿç‚¹å‡»é“¾æ¥æ¥è§¦å‘ä¸‹è½½
            document.body.appendChild(link);
            link.click();

            // 7. æ¸…ç†ä¸´æ—¶åˆ›å»ºçš„å…ƒç´ å’ŒURL
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            await showCustomAlert(
              "å¯¼å‡ºæˆåŠŸ",
              `ä¸â€œ${chat.name}â€çš„èŠå¤©è®°å½•å·²å¼€å§‹ä¸‹è½½ï¼`,
            );
          }

          /**
           * å¯¼å…¥èŠå¤©è®°å½•åˆ°å½“å‰è§’è‰²
           */
          async function importChatHistory(file) {
            if (!file) return;
            if (!state.activeChatId) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const data = JSON.parse(e.target.result);

                // å…³é”®éªŒè¯ï¼šæ£€æŸ¥å¯¼å…¥çš„æ–‡ä»¶æ˜¯å¦åŒ…å«ä¸€ä¸ªåä¸º 'history' çš„æ•°ç»„
                if (!data.history || !Array.isArray(data.history)) {
                  throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘æœ‰æ•ˆçš„'history'æ•°æ®ã€‚");
                }

                const chat = state.chats[state.activeChatId];

                // å®‰å…¨è­¦å‘Šï¼šæé†’ç”¨æˆ·è¿™å°†è¦†ç›–ç°æœ‰è®°å½•
                const confirmed = await showCustomConfirm(
                  "ç¡®è®¤å¯¼å…¥",
                  `è¿™å°†ä¼šã€è¦†ç›–ã€‘ä½ ä¸â€œ${chat.name}â€çš„å½“å‰æ‰€æœ‰èŠå¤©è®°å½•ã€‚æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`,
                  { confirmButtonClass: "btn-danger" },
                );

                if (confirmed) {
                  // æ›¿æ¢å†å²è®°å½•
                  chat.history = data.history;
                  // ä¿å­˜åˆ°æ•°æ®åº“
                  await db.chats.put(chat);
                  // åˆ·æ–°ç•Œé¢
                  renderChatInterface(state.activeChatId);
                  renderChatList(); // åˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯
                  await showCustomAlert(
                    "å¯¼å…¥æˆåŠŸ",
                    "èŠå¤©è®°å½•å·²æˆåŠŸå¯¼å…¥å¹¶è¦†ç›–ï¼",
                  );
                }
              } catch (error) {
                console.error("å¯¼å…¥èŠå¤©è®°å½•å¤±è´¥:", error);
                await showCustomAlert(
                  "å¯¼å…¥å¤±è´¥",
                  `æ— æ³•å¯¼å…¥æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºæ­£ç¡®çš„èŠå¤©è®°å½•å¤‡ä»½æ–‡ä»¶ã€‚\n\né”™è¯¯: ${error.message}`,
                );
              }
            };
            reader.readAsText(file, "UTF-8");
          }

          // â–¼æ°”æ³¡æ ·å¼é¢„è®¾å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½

          /**
           * å¯¼å‡ºå½“å‰é€‰ä¸­çš„æ°”æ³¡æ ·å¼é¢„è®¾
           */
          async function exportSelectedBubblePreset() {
            const selectEl = document.getElementById(
              "bubble-style-preset-select",
            );
            const selectedId = parseInt(selectEl.value);

            if (!selectedId) {
              alert("è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦å¯¼å‡ºçš„é¢„è®¾ã€‚");
              return;
            }

            const preset = await db.bubbleStylePresets.get(selectedId);
            if (!preset) {
              alert("æ‰¾ä¸åˆ°é€‰ä¸­çš„é¢„è®¾ã€‚");
              return;
            }

            // å‡†å¤‡è¦å¯¼å‡ºçš„æ•°æ®
            const exportData = {
              presetName: preset.name,
              presetCss: preset.css,
            };

            // åˆ›å»ºå¹¶è§¦å‘ä¸‹è½½
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `[EPhoneæ°”æ³¡]${preset.name}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }

          /**
           * å¯¼å…¥æ°”æ³¡é¢„è®¾ (æ”¯æŒ JSON, TXT, CSS, DOCX)
           * å¦‚æœæ˜¯ JSONï¼Œä¿å­˜ä¸ºé¢„è®¾ï¼›å¦‚æœæ˜¯ TXT/DOCXï¼Œç›´æ¥å¡«å…¥è¾“å…¥æ¡†
           */
          function importBubblePreset(file) {
            if (!file) return;

            const fileName = file.name.toLowerCase();
            const customCssInput = document.getElementById("custom-css-input"); // è·å–æ°”æ³¡CSSè¾“å…¥æ¡†

            // --- æƒ…å†µA: Word æ–‡æ¡£ ---
            if (fileName.endsWith(".docx")) {
              const reader = new FileReader();
              reader.onload = function (e) {
                mammoth
                  .extractRawText({ arrayBuffer: e.target.result })
                  .then(function (result) {
                    customCssInput.value = result.value; // å¡«å…¥è¾“å…¥æ¡†
                    updateSettingsPreview(); // åˆ·æ–°é¢„è§ˆ
                    alert(
                      "å·²ä»Wordæå–CSSä»£ç åˆ°è¾“å…¥æ¡†ï¼(è¯·ç‚¹å‡»â€œä¿å­˜â€ä»¥å­˜ä¸ºé¢„è®¾)",
                    );
                  })
                  .catch(function (err) {
                    alert("è¯»å–Wordæ–‡ä»¶å¤±è´¥");
                  });
              };
              reader.readAsArrayBuffer(file);
              return;
            }

            // --- æƒ…å†µB: æ–‡æœ¬æ–‡ä»¶ ---
            if (fileName.endsWith(".txt") || fileName.endsWith(".css")) {
              const reader = new FileReader();
              reader.onload = function (e) {
                customCssInput.value = e.target.result; // å¡«å…¥è¾“å…¥æ¡†
                updateSettingsPreview(); // åˆ·æ–°é¢„è§ˆ
                alert("å·²è¯»å–CSSä»£ç åˆ°è¾“å…¥æ¡†ï¼(è¯·ç‚¹å‡»â€œä¿å­˜â€ä»¥å­˜ä¸ºé¢„è®¾)");
              };
              reader.readAsText(file);
              return;
            }

            // --- æƒ…å†µC: JSON æ–‡ä»¶ (ä¿æŒåŸæœ‰é€»è¾‘) ---
            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const data = JSON.parse(e.target.result);
                // éªŒè¯æ–‡ä»¶å†…å®¹æ˜¯å¦æ­£ç¡®
                if (data.presetName && typeof data.presetCss !== "undefined") {
                  const newPreset = {
                    name: `${data.presetName} (å¯¼å…¥)`,
                    css: data.presetCss,
                  };
                  const newId = await db.bubbleStylePresets.add(newPreset);

                  if (!state.bubbleStylePresets) state.bubbleStylePresets = [];
                  state.bubbleStylePresets.push({ id: newId, ...newPreset });

                  // åˆ·æ–°ä¸‹æ‹‰æ¡†å¹¶è‡ªåŠ¨é€‰ä¸­æ–°å¯¼å…¥çš„é¢„è®¾
                  renderBubblePresetSelector();
                  document.getElementById("bubble-style-preset-select").value =
                    newId;
                  handlePresetSelectChange();
                  await showCustomAlert(
                    "å¯¼å…¥æˆåŠŸ",
                    `æ°”æ³¡é¢„è®¾ "${newPreset.name}" å·²æˆåŠŸå¯¼å…¥ï¼`,
                  );
                } else {
                  // å¦‚æœä¸æ˜¯æ ‡å‡†é¢„è®¾JSONï¼Œå°è¯•ç›´æ¥å¡«å…¥è¾“å…¥æ¡†
                  customCssInput.value = e.target.result;
                  updateSettingsPreview();
                  alert("JSONæ ¼å¼ä¸æ˜¯æ ‡å‡†é¢„è®¾ï¼Œå·²å°†å†…å®¹å¡«å…¥è¾“å…¥æ¡†ã€‚");
                }
              } catch (error) {
                // è§£æå‡ºé”™ï¼Œå½“ä½œçº¯æ–‡æœ¬å¡«å…¥
                customCssInput.value = e.target.result;
                updateSettingsPreview();
                alert("å·²å°†æ–‡ä»¶å†…å®¹å¡«å…¥è¾“å…¥æ¡†ã€‚");
              }
            };
            reader.readAsText(file);
          }

          // --- å¡”ç½—ç‰Œå åœåŠŸèƒ½äº‹ä»¶ç»‘å®š ---
          document
            .getElementById("open-tarot-btn")
            .addEventListener("click", openTarotModal);
          document
            .getElementById("close-tarot-modal-btn")
            .addEventListener("click", () => {
              document
                .getElementById("tarot-divination-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("draw-tarot-cards-btn")
            .addEventListener("click", handleDrawCards);
          document
            .getElementById("back-to-tarot-setup-btn")
            .addEventListener("click", () => {
              document.getElementById("tarot-result-view").style.display =
                "none";
              document.getElementById("tarot-setup-view").style.display =
                "block";
            });
          document
            .getElementById("send-tarot-result-btn")
            .addEventListener("click", sendTarotReadingToChat);
          document
            .getElementById("tarot-history-btn")
            .addEventListener("click", openTarotHistory);
          document
            .getElementById("back-to-tarot-main-btn")
            .addEventListener("click", () => {
              document.getElementById("tarot-history-view").style.display =
                "none";
              document.getElementById("tarot-setup-view").style.display =
                "block";
            });
          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†å†å²è®°å½•çš„åˆ é™¤æŒ‰é’®
          document
            .getElementById("tarot-history-list")
            .addEventListener("click", (e) => {
              if (e.target.classList.contains("tarot-history-delete-btn")) {
                const readingId = parseInt(e.target.dataset.id);
                if (!isNaN(readingId)) {
                  deleteTarotReading(readingId);
                }
              }
            });

          // 1. åˆå§‹åŒ–æ—¶åˆ›å»ºé»˜è®¤å°ç»„
          await initializeDefaultGroups();
          /* === ä¿®å¤åçš„ä¸»å±å¹•æ»‘åŠ¨é€»è¾‘ï¼ˆæ”¯æŒPCé¼ æ ‡æ‹–æ‹½ï¼‰ === */
          function initHomeScreenSlider() {
            const slider = document.querySelector(".home-screen-slider");
            const dots = document.querySelectorAll(".pagination-dots .dot");

            if (!slider || dots.length === 0) return;

            // 1. ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼ˆç”¨äºæ›´æ–°å°åœ†ç‚¹çŠ¶æ€ï¼‰
            slider.addEventListener("scroll", () => {
              const pageIndex = Math.round(
                slider.scrollLeft / slider.clientWidth,
              );
              dots.forEach((dot, index) => {
                dot.classList.toggle("active", index === pageIndex);
              });
            });

            // 2. PCç«¯é¼ æ ‡æ‹–æ‹½æ»‘åŠ¨é€»è¾‘
            let isDown = false;
            let startX;
            let scrollLeft;

            slider.addEventListener("mousedown", (e) => {
              isDown = true;
              slider.style.cursor = "grabbing"; // æ”¹å˜é¼ æ ‡æ ·å¼
              startX = e.pageX - slider.offsetLeft;
              scrollLeft = slider.scrollLeft;
              // é˜²æ­¢æ‹–åŠ¨æ—¶é€‰ä¸­æ–‡æœ¬
              e.preventDefault();
            });

            slider.addEventListener("mouseleave", () => {
              isDown = false;
              slider.style.cursor = "default";
            });

            slider.addEventListener("mouseup", () => {
              isDown = false;
              slider.style.cursor = "default";

              // é¼ æ ‡æ¾å¼€æ—¶ï¼Œè‡ªåŠ¨å¸é™„åˆ°æœ€è¿‘çš„ä¸€é¡µï¼ˆæ¨¡æ‹Ÿç¿»é¡µæ•ˆæœï¼‰
              const pageWidth = slider.clientWidth;
              const currentPage = Math.round(slider.scrollLeft / pageWidth);
              slider.scrollTo({
                left: currentPage * pageWidth,
                behavior: "smooth",
              });
            });

            slider.addEventListener("mousemove", (e) => {
              if (!isDown) return;
              e.preventDefault();
              const x = e.pageX - slider.offsetLeft;
              const walk = (x - startX) * 2; // ä¹˜ä»¥2å¯ä»¥è®©æ»‘åŠ¨æ›´çµæ•
              slider.scrollLeft = scrollLeft - walk;
            });
          }

          initHomeScreenSlider(); // åˆå§‹åŒ–ä¸»å±å¹•æ»‘åŠ¨åŠŸèƒ½

          // --- é¢œè‰²é€‰æ‹©å™¨ä¸æ–‡æœ¬æ¡†è”åŠ¨é€»è¾‘ ---
          const colorPicker = document.getElementById(
            "home-icon-widget-text-color-picker",
          );
          const colorInput = document.getElementById(
            "home-icon-widget-text-color-input",
          );

          // 1. å½“é€‰è‰²ç›˜å˜åŒ–æ—¶ -> åŒæ­¥ç»™æ–‡æœ¬æ¡† + å®æ—¶åº”ç”¨
          colorPicker.addEventListener("input", (e) => {
            const color = e.target.value;
            colorInput.value = color.toUpperCase(); // åŒæ­¥æ–‡å­—
            applyHomeIconWidgetTextColor(color); // å®æ—¶åº”ç”¨
          });

          // 2. å½“æ–‡æœ¬æ¡†è¾“å…¥æ—¶ -> éªŒè¯ -> åŒæ­¥ç»™é€‰è‰²ç›˜ + å®æ—¶åº”ç”¨
          colorInput.addEventListener("input", (e) => {
            let val = e.target.value;

            // è‡ªåŠ¨æ·»åŠ  # å· (å¦‚æœç”¨æˆ·å¿˜äº†åŠ )
            if (val.length > 0 && !val.startsWith("#")) {
              val = "#" + val;
            }

            // ç®€å•çš„æ­£åˆ™éªŒè¯ï¼šå¿…é¡»æ˜¯ # åŠ ä¸Š 6ä½ 0-9/A-F
            const hexRegex = /^#([0-9A-F]{3}){1,2}$/i;

            if (hexRegex.test(val)) {
              // å¦‚æœæ ¼å¼æ­£ç¡®
              colorPicker.value = val; // åŒæ­¥é€‰è‰²ç›˜
              applyHomeIconWidgetTextColor(val); // å®æ—¶åº”ç”¨
              // (å¯é€‰) å¯ä»¥åœ¨è¿™é‡Œå»æ‰é”™è¯¯æç¤ºæ ·å¼
              colorInput.style.color = "inherit";
            } else {
              // å¦‚æœæ ¼å¼ä¸å¯¹ï¼Œä¸åº”ç”¨ï¼Œä½†ä¹Ÿä¸é˜»æ­¢è¾“å…¥ (å¯ä»¥æŠŠå­—å˜çº¢æç¤º)
              colorInput.style.color = "red";
            }
          });

          // 3. å½“æ–‡æœ¬æ¡†å¤±å»ç„¦ç‚¹æ—¶ï¼Œå¦‚æœå†…å®¹ä¸å®Œæ•´ï¼Œé‡ç½®å›é€‰è‰²ç›˜çš„å€¼
          colorInput.addEventListener("blur", () => {
            colorInput.value = colorPicker.value.toUpperCase();
            colorInput.style.color = "inherit";
          });

          // ä¸»å±å¹•å­—ä½“é˜´å½±å¼€å…³çš„å®æ—¶é¢„è§ˆäº‹ä»¶
          document
            .getElementById("remove-home-font-shadow-toggle")
            .addEventListener("change", (e) => {
              document
                .getElementById("phone-screen")
                .classList.toggle("no-home-font-shadow", e.target.checked);
            });
          // å® ç‰©åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨
          // 1. ç»‘å®šè¾“å…¥æ¡†ä¸Šæ–¹çš„å® ç‰©å›¾æ ‡æŒ‰é’®
          document
            .getElementById("pet-action-btn")
            .addEventListener("click", openPetModal);

          // 2. ç»‘å®šå® ç‰©å¼¹çª—å†…çš„å„ç§æŒ‰é’®
          document
            .getElementById("pet-modal-cancel-btn")
            .addEventListener("click", () => {
              document.getElementById("pet-modal").classList.remove("visible");
              currentPetData = null; // å–æ¶ˆæ—¶ä¹Ÿè¦æ¸…ç†
            });
          document
            .getElementById("pet-modal-save-btn")
            .addEventListener("click", savePetSettings);

          // 3. å®æ—¶æ›´æ–°é¢„è§ˆ
          document
            .getElementById("pet-type-input")
            .addEventListener("input", updatePetPreview);
          document
            .getElementById("pet-name-input")
            .addEventListener("input", updatePetPreview);
          document
            .getElementById("pet-image-input")
            .addEventListener("input", updatePetPreview);

          // 4. â€œåœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºâ€å¼€å…³çš„äº¤äº’
          document
            .getElementById("pet-display-toggle")
            .addEventListener("change", (e) => {
              document.getElementById("pet-position-controls").style.display = e
                .target.checked
                ? "block"
                : "none";
            });

          // 5. å°ºå¯¸æ»‘å—çš„äº¤äº’
          const sizeSlider = document.getElementById("pet-size-slider");
          sizeSlider.addEventListener("input", () => {
            document.getElementById("pet-size-value").textContent =
              `${sizeSlider.value}px`;
          });

          // 6. ç»‘å®šæ›´æ¢è‡ªå®šä¹‰å›¾ç‰‡çš„ç‚¹å‡»äº‹ä»¶
          document
            .getElementById("pet-preview-display")
            .addEventListener("click", () => {
              document.getElementById("pet-custom-image-input").click();
            });
          document
            .getElementById("pet-custom-image-input")
            .addEventListener("change", (e) => {
              const file = e.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                  // å°†å›¾ç‰‡çš„Base64é“¾æ¥ç›´æ¥å¡«å…¥è¾“å…¥æ¡†
                  document.getElementById("pet-image-input").value =
                    event.target.result;
                  updatePetPreview(); // å¹¶æ›´æ–°é¢„è§ˆ
                };
                reader.readAsDataURL(file);
              }
            });

          // 7. ç»‘å®šäº’åŠ¨æŒ‰é’® (ä½¿ç”¨äº‹ä»¶å§”æ‰˜)
          document
            .getElementById("pet-interaction-area")
            .addEventListener("click", (e) => {
              if (e.target.tagName === "BUTTON" && e.target.dataset.action) {
                handlePetInteraction(e.target.dataset.action);
              }
            });

          // 8. åˆå§‹åŒ–å® ç‰©çš„æ‹–åŠ¨åŠŸèƒ½
          initPetDragging();
          // å® ç‰©èŠå¤©åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("send-to-pet-btn")
            .addEventListener("click", handleSendToPet);
          document
            .getElementById("pet-chat-input")
            .addEventListener("keypress", (e) => {
              if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                document.getElementById("send-to-pet-btn").click();
              }
            });

          // ä¸ºå® ç‰©èŠå¤©çª—å£çš„â€œå¤–éƒ¨â€ç‚¹å‡»æ·»åŠ å…³é—­åŠŸèƒ½
          const petChatModal = document.getElementById("pet-chat-modal");
          petChatModal.addEventListener("click", (e) => {
            if (e.target === petChatModal) {
              // åªæœ‰ç‚¹å‡»ç°è‰²é®ç½©å±‚æ‰å…³é—­
              petChatModal.classList.remove("visible");
            }
          });

          // ä¸ºâ€œæ”¾ç”Ÿå® ç‰©â€æŒ‰é’®ç»‘å®šäº‹ä»¶
          document
            .getElementById("pet-abandon-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;

              const confirmed = await showCustomConfirm(
                "ç¡®è®¤æ”¾ç”Ÿ",
                "ç¡®å®šè¦å…³é—­å® ç‰©ç³»ç»Ÿå—ï¼Ÿè¿™å°†ä¼šé‡ç½®æ‰€æœ‰å® ç‰©æ•°æ®ï¼ˆæ•°å€¼ã€èŠå¤©è®°å½•ç­‰ï¼‰ï¼Œä½†ä¸ä¼šåˆ é™¤ä½ çš„è®¾ç½®ã€‚ä½ å¯ä»¥éšæ—¶é‡æ–°é¢†å…»ã€‚",
                { confirmButtonClass: "btn-danger" },
              );

              if (confirmed) {
                const chat = state.chats[state.activeChatId];
                chat.settings.petAdopted = false; // å…³é—­é¢†å…»çŠ¶æ€
                delete chat.settings.pet; // åˆ é™¤å® ç‰©æ•°æ®å¯¹è±¡

                await db.chats.put(chat);

                renderChatPet(); // ä»èŠå¤©ç•Œé¢ç§»é™¤å® ç‰©
                document
                  .getElementById("pet-modal")
                  .classList.remove("visible"); // å…³é—­å¼¹çª—
                alert("å® ç‰©å·²æ”¾ç”Ÿï¼Œæ±Ÿæ¹–å†è§ï¼");
              }
            });

          // ç»‘å®šçº¿ä¸‹æ¨¡å¼é¢„è®¾çš„ä¸‹æ‹‰æ¡†å’Œç®¡ç†æŒ‰é’®
          document
            .getElementById("offline-preset-select")
            .addEventListener("change", handleOfflinePresetSelection);
          document
            .getElementById("manage-offline-presets-btn")
            .addEventListener("click", openOfflinePresetManager);

          // èŠå¤©æ€»ç»“åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("view-summaries-btn")
            .addEventListener("click", openSummaryViewer);
          document
            .getElementById("close-summary-viewer-btn")
            .addEventListener("click", () => {
              document
                .getElementById("summary-viewer-modal")
                .classList.remove("visible");
              // å…³é—­åé‡æ–°æ‰“å¼€è®¾ç½®å¼¹çª—ï¼Œå›åˆ°ä¸Šä¸€çº§
              document.getElementById("chat-settings-btn").click();
            });

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ€»ç»“åˆ—è¡¨ä¸­çš„æ‰€æœ‰æŒ‰é’®
          document
            .getElementById("summary-list")
            .addEventListener("click", (e) => {
              const editBtn = e.target.closest(".edit-summary-btn");
              if (editBtn) {
                const timestamp = parseInt(editBtn.dataset.timestamp);
                editSummary(timestamp);
                return;
              }

              const deleteBtn = e.target.closest(".delete-summary-btn");
              if (deleteBtn) {
                const timestamp = parseInt(deleteBtn.dataset.timestamp);
                deleteSummary(timestamp);
                return;
              }

              // å¤„ç†å•æ¡ç²¾ç®€æŒ‰é’®çš„ç‚¹å‡»
              const conciseBtn = e.target.closest(".concise-summary-btn");
              if (conciseBtn) {
                const timestamp = parseInt(conciseBtn.dataset.timestamp);
                handleConciseSummary(timestamp);
                return;
              }
            });

          // ä¸ºâ€œå…¨éƒ¨ç²¾ç®€â€æŒ‰é’®ç»‘å®šäº‹ä»¶
          document
            .getElementById("concise-all-summaries-btn")
            .addEventListener("click", handleConciseAllSummaries);

          document
            .getElementById("chat-settings-modal")
            .addEventListener("click", (e) => {
              if (e.target.id === "manual-summary-btn") {
                // ç‚¹å‡»åå…ˆå…³é—­è®¾ç½®å¼¹çª—
                document
                  .getElementById("chat-settings-modal")
                  .classList.remove("visible");
                // ã€è°ƒç”¨æˆ‘ä»¬æ–°åˆ›å»ºçš„é€‰æ‹©å‡½æ•°ï¼Œè€Œä¸æ˜¯ç›´æ¥æ€»ç»“
                openManualSummaryOptions();
              }
            });

          // è§’è‰²æ‰‹æœºå¤–è§‚è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
          document
            .getElementById("character-phone-container")
            .addEventListener("click", (e) => {
              // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œåˆ¤æ–­ç‚¹å‡»çš„æ˜¯å“ªä¸ªæŒ‰é’®
              if (e.target.id === "upload-char-phone-wallpaper-btn") {
                document
                  .getElementById("char-phone-wallpaper-upload-input")
                  .click();
              } else if (e.target.id === "remove-char-phone-wallpaper-btn") {
                handleCharPhoneWallpaperChange(""); // ä¼ å…¥ç©ºå­—ç¬¦ä¸²æ¥ç§»é™¤å£çº¸
              } else {
                const changeIconButton = e.target.closest(".change-icon-btn");
                if (changeIconButton) {
                  const iconId = changeIconButton.dataset.iconId;
                  handleChangeCharPhoneIcon(iconId);
                }
              }
            });

          // ç›‘å¬å£çº¸æ–‡ä»¶é€‰æ‹©
          document
            .getElementById("char-phone-wallpaper-upload-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (file) {
                const dataUrl = await new Promise((res) => {
                  const reader = new FileReader();
                  reader.onload = () => res(reader.result);
                  reader.readAsDataURL(file);
                });
                handleCharPhoneWallpaperChange(dataUrl);
              }
              event.target.value = null; // æ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
            });

          /* è§’è‰²å¾®åšèµ„æ–™ç¼–è¾‘å™¨äº‹ä»¶ç»‘å®š */

          // 1. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºè§’è‰²å¾®åšç¼–è¾‘å¼¹çª—å†…çš„æ‰€æœ‰æŒ‰é’®ç»‘å®šäº‹ä»¶
          document
            .getElementById("char-weibo-editor-modal")
            .addEventListener("click", (e) => {
              // a. å¦‚æœç‚¹å‡»çš„æ˜¯â€œæ›´æ¢å¤´åƒæ¡†â€æŒ‰é’®
              if (e.target.classList.contains("change-frame-btn")) {
                const type = e.target.dataset.type; // è·å–æŒ‰é’®ç±»å‹ 'char-weibo'
                const targetId = currentViewingWeiboProfileId; // è·å–å½“å‰æ­£åœ¨æŸ¥çœ‹çš„è§’è‰²ID

                // è°ƒç”¨å¤´åƒæ¡†é€‰æ‹©å‡½æ•°ï¼Œå¹¶ä¼ å…¥æ­£ç¡®çš„å‚æ•°
                openFrameSelectorModal(type, targetId);
              }
              // b. å¦‚æœç‚¹å‡»çš„æ˜¯â€œå–æ¶ˆâ€æŒ‰é’®
              else if (e.target.id === "cancel-char-weibo-editor-btn") {
                document
                  .getElementById("char-weibo-editor-modal")
                  .classList.remove("visible");
              }
              // c. å¦‚æœç‚¹å‡»çš„æ˜¯â€œä¿å­˜â€æŒ‰é’®
              else if (e.target.id === "save-char-weibo-editor-btn") {
                saveCharWeiboProfile();
              }
            });

          // 2. ä¸ºè§’è‰²æ‰‹æœºçš„å›¾ç‰‡ä¸Šä¼ è¾“å…¥æ¡†ç»‘å®šäº‹ä»¶ï¼ˆè¿™æ˜¯ä¹‹å‰å°±æœ‰çš„ï¼Œç¡®ä¿å®ƒåœ¨æ­£ç¡®çš„ä½ç½®ï¼‰
          setupFileUpload("char-weibo-editor-avatar-input", (base64) => {
            document.getElementById("char-weibo-editor-avatar-preview").src =
              base64;
          });
          setupFileUpload("char-weibo-editor-bg-input", (base64) => {
            document.getElementById("char-weibo-editor-bg-preview").src =
              base64;
          });

          /* è§’è‰²æ‰‹æœºå°ç»„ä»¶ä¸Šä¼ åŠŸèƒ½äº‹ä»¶ç»‘å®š */

          // è¾…åŠ©å‡½æ•°ï¼šå¤„ç†å›¾ç‰‡ä¸Šä¼ çš„é€šç”¨é€»è¾‘
          const handleWidgetUpload = async (widgetKey, inputFileId) => {
            const fileInput = document.getElementById(inputFileId);
            const file = fileInput.files[0];
            if (!file) return;

            const dataUrl = await new Promise((res) => {
              const reader = new FileReader();
              reader.onload = () => res(reader.result);
              reader.readAsDataURL(file);
            });

            const chat = state.chats[activeCharacterPhoneId];
            if (!chat.characterPhoneData.widgets) {
              chat.characterPhoneData.widgets = {};
            }
            chat.characterPhoneData.widgets[widgetKey] = dataUrl;

            await db.chats.put(chat);
            renderCharPhoneAppearanceScreen(); // åˆ·æ–°è®¾ç½®é¡µé¢„è§ˆ
            openCharacterPhone(activeCharacterPhoneId); // åˆ·æ–°æ‰‹æœºä¸»å±å¹•
            alert("å°ç»„ä»¶å›¾ç‰‡å·²æ›´æ–°ï¼");
            fileInput.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©
          };

          // è¾…åŠ©å‡½æ•°ï¼šå¤„ç†å›¾ç‰‡ç§»é™¤çš„é€šç”¨é€»è¾‘
          const handleWidgetRemove = async (widgetKey) => {
            const chat = state.chats[activeCharacterPhoneId];
            if (
              chat.characterPhoneData.widgets &&
              chat.characterPhoneData.widgets[widgetKey]
            ) {
              delete chat.characterPhoneData.widgets[widgetKey];
              await db.chats.put(chat);
              renderCharPhoneAppearanceScreen();
              openCharacterPhone(activeCharacterPhoneId);
              alert("å°ç»„ä»¶å›¾ç‰‡å·²ç§»é™¤ï¼");
            }
          };

          // ä¸ºå››ä¸ªæ–°æŒ‰é’®ç»‘å®šäº‹ä»¶
          document
            .getElementById("upload-widget-1-btn")
            .addEventListener("click", () => {
              document
                .getElementById("char-phone-widget-1-upload-input")
                .click();
            });
          document
            .getElementById("remove-widget-1-btn")
            .addEventListener("click", () => {
              handleWidgetRemove("widget1_url");
            });
          document
            .getElementById("char-phone-widget-1-upload-input")
            .addEventListener("change", () => {
              handleWidgetUpload(
                "widget1_url",
                "char-phone-widget-1-upload-input",
              );
            });

          document
            .getElementById("upload-widget-2-btn")
            .addEventListener("click", () => {
              document
                .getElementById("char-phone-widget-2-upload-input")
                .click();
            });
          document
            .getElementById("remove-widget-2-btn")
            .addEventListener("click", () => {
              handleWidgetRemove("widget2_url");
            });
          document
            .getElementById("char-phone-widget-2-upload-input")
            .addEventListener("change", () => {
              handleWidgetUpload(
                "widget2_url",
                "char-phone-widget-2-upload-input",
              );
            });

          // è§’è‰²æ‰‹æœºå¤–è§‚é¢„è®¾åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("char-phone-preset-selector")
            .addEventListener("change", handleCharPhonePresetSelection);
          document
            .getElementById("apply-char-phone-preset-btn")
            .addEventListener("click", applySelectedCharPhonePreset);
          document
            .getElementById("save-char-phone-preset-btn")
            .addEventListener("click", saveCurrentCharPhonePreset);
          document
            .getElementById("update-char-phone-preset-btn")
            .addEventListener("click", updateSelectedCharPhonePreset);
          document
            .getElementById("rename-char-phone-preset-btn")
            .addEventListener("click", renameSelectedCharPhonePreset);
          document
            .getElementById("delete-char-phone-preset-btn")
            .addEventListener("click", deleteSelectedCharPhonePreset);
          document
            .getElementById("export-char-phone-preset-btn")
            .addEventListener("click", exportCharPhonePreset);
          document
            .getElementById("import-char-phone-preset-btn")
            .addEventListener("click", () => {
              document.getElementById("import-char-phone-preset-input").click();
            });
          document
            .getElementById("import-char-phone-preset-input")
            .addEventListener("change", (e) => {
              importCharPhonePreset(e.target.files[0]);
              e.target.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
            });

          // è§’è‰²æ‰‹æœºAppå†…å£çº¸åŠŸèƒ½äº‹ä»¶ç»‘å®š

          // ç›‘å¬â€œä¸Šä¼ â€æŒ‰é’®çš„ç‚¹å‡»ï¼Œå»è§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨
          document
            .getElementById("upload-char-phone-app-wallpaper-btn")
            .addEventListener("click", () => {
              document
                .getElementById("char-phone-app-wallpaper-upload-input")
                .click();
            });

          // ç›‘å¬æ–‡ä»¶é€‰æ‹©å™¨çš„å˜åŒ–
          document
            .getElementById("char-phone-app-wallpaper-upload-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (file) {
                const dataUrl = await new Promise((res) => {
                  const reader = new FileReader();
                  reader.onload = () => res(reader.result);
                  reader.readAsDataURL(file);
                });
                // æ–‡ä»¶è¯»å–æˆåŠŸåï¼Œç«‹åˆ»è°ƒç”¨å¤„ç†å‡½æ•°æ¥ä¿å­˜å’Œåº”ç”¨
                handleCharPhoneAppWallpaperChange(dataUrl);
              }
              event.target.value = null; // æ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
            });

          // ç›‘å¬â€œç§»é™¤â€æŒ‰é’®çš„ç‚¹å‡»
          document
            .getElementById("remove-char-phone-app-wallpaper-btn")
            .addEventListener("click", () => {
              // è°ƒç”¨å¤„ç†å‡½æ•°ï¼Œå¹¶ä¼ å…¥ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºç§»é™¤
              handleCharPhoneAppWallpaperChange("");
            });

          // å¿ƒå£°èƒŒæ™¯æ›´æ¢åŠŸèƒ½äº‹ä»¶ç›‘å¬
          document
            .getElementById("change-inner-voice-bg-btn")
            .addEventListener("click", handleInnerVoiceBgChange);

          document
            .getElementById("inner-voice-bg-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (!file) return;

              // å°†å›¾ç‰‡æ–‡ä»¶è½¬æ¢ä¸ºBase64ï¼Œä»¥ä¾¿ä¿å­˜å’Œæ˜¾ç¤º
              const dataUrl = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
              });

              // è°ƒç”¨ä¿å­˜å‡½æ•°
              await saveInnerVoiceBackground(dataUrl);

              // æ¯æ¬¡ç”¨å®Œåæ¸…ç©ºï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
              event.target.value = null;
            });

          // æƒ…ä¾£ç©ºé—´å–æ¶ˆå’Œè§£é™¤â–¼â–¼â–¼
          document
            .getElementById("ls-cancel-space-btn")
            .addEventListener("click", handleCancelLoversSpace);
          document
            .getElementById("ls-disconnect-space-btn")
            .addEventListener("click", handleDisconnectLoversSpace);

          document
            .getElementById("member-management-list")
            .addEventListener("click", (e) => {
              const button = e.target.closest(".action-btn");
              if (!button) return;

              const action = button.dataset.action;
              const memberId = button.dataset.memberId;

              if (!action || !memberId) return;

              // --- å¤„ç†ç”¨æˆ·è‡ªå·±çš„æŒ‰é’® ---
              if (memberId === "user") {
                if (action === "set-nickname") handleSetUserNickname();
                if (action === "set-title") handleSetUserTitle();
                // ç”¨æˆ·ç‚¹å‡»è‡ªå·±çš„â€œè§£ç¦â€æŒ‰é’®
                if (action === "unmute-self") {
                  handleUserUnmute();
                }
                return;
              }

              // --- å¤„ç†å…¶ä»–æˆå‘˜çš„æŒ‰é’® ---
              switch (action) {
                case "toggle-admin":
                  handleToggleAdmin(memberId);
                  break;
                case "set-title":
                  handleSetMemberTitle(memberId);
                  break;
                case "transfer-owner":
                  handleTransferOwnership(memberId);
                  break;
                case "remove-member":
                  removeMemberFromGroup(memberId);
                  break;
                case "mute-member": // ç¦è¨€/è§£ç¦ç»Ÿä¸€èµ°è¿™é‡Œ
                  handleMuteMember(memberId);
                  break;
              }
            });

          // ç¾¤å…¬å‘ŠåŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("group-announcement-btn")
            .addEventListener("click", openGroupAnnouncementModal);

          // ç»‘å®šç”¨æˆ·è¡¨æƒ…é¢æ¿çš„æ‰¹é‡åˆ é™¤æŒ‰é’®
          document
            .getElementById("edit-user-stickers-btn")
            .addEventListener("click", toggleUserStickerSelectionMode);
          document
            .getElementById("done-user-stickers-btn")
            .addEventListener("click", toggleUserStickerSelectionMode);
          document
            .getElementById("delete-selected-user-stickers-btn")
            .addEventListener("click", handleBulkDeleteUserStickers);

          // å…³é—­é¢æ¿æ—¶ï¼Œä¹Ÿè¦é€€å‡ºé€‰æ‹©æ¨¡å¼
          document
            .getElementById("close-sticker-panel-btn")
            .addEventListener("click", () => {
              exitUserStickerSelectionMode();
              stickerPanel.classList.remove("visible");
            });

          // è¾…åŠ©å‡½æ•°ï¼šå¤„ç†åˆ é™¤åˆ†ç±»æŒ‰é’®çš„ç‚¹å‡»
          function onStickerCategoryDelete(deleteButtonElement) {
            const categoryId = parseInt(deleteButtonElement.dataset.categoryId);
            const categoryName = deleteButtonElement.dataset.categoryName;

            // *** è°ƒè¯•å…³é”®ç‚¹ (Debugging Point) ***
            // è¯·åœ¨æµè§ˆå™¨ä¸­æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° "Console" (æ§åˆ¶å°) æ ‡ç­¾é¡µã€‚
            // ç‚¹å‡»åˆ é™¤æŒ‰é’®åï¼Œåœ¨è¿™é‡ŒæŸ¥çœ‹è¾“å‡ºçš„IDå’Œåç§°æ˜¯å¦æ˜¯æ‚¨ç‚¹å‡»çš„é‚£ä¸€ä¸ªã€‚
            console.log(
              `[è°ƒè¯•] å‡†å¤‡åˆ é™¤åˆ†ç±»: ID=${categoryId}, åç§°='${categoryName}'`,
            );

            if (!isNaN(categoryId) && categoryName) {
              handleDeleteStickerCategory(categoryId, categoryName);
            } else {
              console.error(
                "[é”™è¯¯] æ— æ³•ä»æŒ‰é’®è·å–æœ‰æ•ˆçš„åˆ†ç±»IDæˆ–åç§°ã€‚",
                deleteButtonElement.dataset,
              );
              alert("åˆ é™¤å¤±è´¥ï¼šæ— æ³•è·å–åˆ†ç±»ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ä»£ç æˆ–åˆ·æ–°é¡µé¢ã€‚");
            }
          }

          // è¾…åŠ©å‡½æ•°ï¼šå¤„ç†åˆ‡æ¢åˆ†ç±»æŒ‰é’®çš„ç‚¹å‡»
          function onStickerCategorySelect(categoryButtonElement) {
            const categoryIdStr = categoryButtonElement.dataset.categoryId;
            activeStickerCategoryId =
              categoryIdStr === "uncategorized"
                ? "uncategorized"
                : parseInt(categoryIdStr);
            renderStickerPanel(); // åˆ‡æ¢åˆ†ç±»å¹¶é‡æ–°æ¸²æŸ“è¡¨æƒ…åˆ—è¡¨
          }

          // ç»‘å®šè§’è‰²è¡¨æƒ…ç®¡ç†é¡µçš„æ‰¹é‡åˆ é™¤æŒ‰é’®
          document
            .getElementById("edit-char-stickers-btn")
            .addEventListener("click", toggleCharStickerSelectionMode);
          document
            .getElementById("done-char-stickers-btn")
            .addEventListener("click", toggleCharStickerSelectionMode);
          document
            .getElementById("delete-selected-char-stickers-btn")
            .addEventListener("click", handleBulkDeleteCharStickers);

          // è¿”å›èŠå¤©è®¾ç½®æ—¶ï¼Œä¹Ÿè¦é€€å‡ºé€‰æ‹©æ¨¡å¼
          document
            .getElementById("back-from-sticker-manager")
            .addEventListener("click", () => {
              exitCharStickerSelectionMode();
              showScreen("chat-interface-screen");
              document.getElementById("chat-settings-btn").click();
            });

          // å¿ƒå£°é¢æ¿ç¼–è¾‘æŒ‰é’®äº‹ä»¶ç›‘å¬
          document
            .getElementById("inner-voice-modal")
            .addEventListener("click", (e) => {
              if (e.target.closest("#inner-voice-edit-btn")) {
                showInnerVoiceEditOptions();
              }
            });

          // å¿ƒå£°æ ·å¼ç¼–è¾‘å™¨äº‹ä»¶ç»‘å®š
          const ivEditorModal = document.getElementById(
            "inner-voice-editor-modal",
          );
          const ivPanel = document.getElementById("inner-voice-main-panel");

          // å®æ—¶é¢„è§ˆåŠŸèƒ½
          ivEditorModal.addEventListener("input", (e) => {
            const targetId = e.target.id;
            const value = e.target.value;

            switch (targetId) {
              case "iv-color-clothing":
                ivPanel.style.setProperty("--iv-color-clothing", value);
                break;
              case "iv-color-behavior":
                ivPanel.style.setProperty("--iv-color-behavior", value);
                break;
              case "iv-color-thoughts":
                ivPanel.style.setProperty("--iv-color-thoughts", value);
                break;
              case "iv-color-naughty":
                ivPanel.style.setProperty("--iv-color-naughty", value);
                break;
              case "iv-card-bg-color":
                ivPanel.style.setProperty("--iv-card-bg-rgb", hexToRgb(value));
                break;
              case "iv-opacity-slider":
                document.getElementById("iv-opacity-value").textContent =
                  `${Math.round(value * 100)}%`;
                ivPanel.style.setProperty("--iv-card-opacity", value);
                break;

              case "iv-icon-color":
                ivPanel.style.setProperty("--iv-icon-color", value);
                break;
            }
          });

          // ä¿å­˜æŒ‰é’®
          document
            .getElementById("iv-editor-save-btn")
            .addEventListener("click", saveInnerVoiceStyles);

          // å–æ¶ˆæŒ‰é’®
          document
            .getElementById("iv-editor-cancel-btn")
            .addEventListener("click", () => {
              ivEditorModal.classList.remove("visible");
              // å–æ¶ˆæ—¶ï¼Œé‡æ–°åº”ç”¨ä¸€ä¸‹ä¿å­˜å¥½çš„æ ·å¼ï¼Œä»¥æ’¤é”€é¢„è§ˆæ”¹åŠ¨
              applySavedInnerVoiceStyles();
            });

          // AIç”Ÿæˆç¾¤æˆå‘˜åŠŸèƒ½äº‹ä»¶ç»‘å®š
          document
            .getElementById("ai-generate-members-btn")
            .addEventListener("click", openAiGenerateMembersModal);
          document
            .getElementById("cancel-ai-generate-members-btn")
            .addEventListener("click", () => {
              document
                .getElementById("ai-generate-members-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("confirm-ai-generate-members-btn")
            .addEventListener("click", handleGenerateMembers);

          // é¢„è®¾åŠŸèƒ½æŒ‰é’®
          document
            .getElementById("dating-preset-select")
            .addEventListener("change", handleDatingPresetSelect);
          document
            .getElementById("manage-dating-presets-btn")
            .addEventListener("click", openDatingPresetManager);

          // --- è¡¨æƒ…åˆ†ç±»åŠŸèƒ½äº‹ä»¶ç»‘å®š ---
          document
            .getElementById("move-selected-stickers-btn")
            .addEventListener("click", openStickerCategoryModal);
          document
            .getElementById("cancel-sticker-category-btn")
            .addEventListener("click", () => {
              document
                .getElementById("sticker-category-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("confirm-sticker-category-btn")
            .addEventListener("click", handleMoveStickers);
          // é«˜çº§å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨
          document
            .getElementById("advanced-transfer-btn")
            .addEventListener("click", openAdvancedTransferModal);

          document
            .getElementById("close-advanced-transfer-btn")
            .addEventListener("click", () => {
              document
                .getElementById("advanced-transfer-modal")
                .classList.remove("visible");
            });

          document
            .getElementById("export-selected-data-btn")
            .addEventListener("click", exportChunkedData);

          document
            .getElementById("import-chunked-data-btn")
            .addEventListener("click", () => {
              document.getElementById("import-chunked-data-input").click();
            });

          document
            .getElementById("import-chunked-data-input")
            .addEventListener("change", (e) => {
              const file = e.target.files[0];
              if (file) {
                importChunkedData(file);
              }
              e.target.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©
            });
          document
            .getElementById("export-for-330-btn")
            .addEventListener("click", exportDataFor330);

          // ä¸ºâ€œå…¼å®¹330æ ¼å¼å¯¼å…¥â€æŒ‰é’®ç»‘å®šäº‹ä»¶
          document
            .getElementById("import-from-330-btn")
            .addEventListener("click", () => {
              // ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œè§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨
              document.getElementById("import-from-330-input").click();
            });

          // ä¸ºéšè—çš„æ–‡ä»¶é€‰æ‹©å™¨ç»‘å®šchangeäº‹ä»¶
          document
            .getElementById("import-from-330-input")
            .addEventListener("change", (e) => {
              const file = e.target.files[0];
              if (file) {
                // å½“ç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶åï¼Œè°ƒç”¨æˆ‘ä»¬çš„æ ¸å¿ƒå¯¼å…¥å‡½æ•°
                importFrom330Format(file);
              }
              // æ¯æ¬¡ç”¨å®Œåæ¸…ç©ºï¼Œè¿™æ ·ç”¨æˆ·ä¸‹æ¬¡è¿˜èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
              e.target.value = null;
            });

          document
            .getElementById("compress-all-images-btn")
            .addEventListener("click", compressAllImagesInDB);
          document
            .getElementById("export-data-stream-btn")
            .addEventListener("click", exportDataStream);
          // åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œç²˜è´´ä¸‹é¢è¿™è¡Œä»£ç 
          document
            .getElementById("reset-app-names-btn")
            .addEventListener("click", resetAppNamesToDefault);
          document.addEventListener("DOMContentLoaded", function () {
            const toggleCheckbox = document.getElementById("dark-mode-toggle");
            const storageKey = "darkModeManualPref";
            const darkReaderOptions = {
              brightness: 100,
              contrast: 90,
              sepia: 10,
            };
            const manualPref = localStorage.getItem(storageKey);
            if (manualPref === "true") {
              DarkReader.enable(darkReaderOptions);
              toggleCheckbox.checked = true;
            } else if (manualPref === "false") {
              DarkReader.disable();
              toggleCheckbox.checked = false;
            } else {
              DarkReader.auto(darkReaderOptions);
              setTimeout(() => {
                toggleCheckbox.checked = DarkReader.isEnabled();
              }, 100);
            }
            toggleCheckbox.addEventListener("change", function () {
              if (this.checked) {
                DarkReader.enable(darkReaderOptions);
                localStorage.setItem(storageKey, "true");
              } else {
                DarkReader.disable();
                localStorage.setItem(storageKey, "false");
              }
            });
          });

          document
            .getElementById("sticker-category-tabs")
            .addEventListener("click", (event) => {
              const target = event.target;

              // --- å§”æ‰˜å¤„ç†ã€åˆ é™¤ã€‘æŒ‰é’®çš„ç‚¹å‡» ---
              if (target.classList.contains("sticker-category-delete-btn")) {
                event.stopPropagation();

                const parentBtn = target.closest(".sticker-category-btn");
                if (parentBtn) {
                  const categoryId = parseInt(parentBtn.dataset.categoryId);
                  const categoryName = parentBtn.dataset.categoryName;

                  if (!isNaN(categoryId) && categoryName) {
                    handleDeleteStickerCategory(categoryId, categoryName);
                  }
                }
                return;
              }

              // --- å§”æ‰˜å¤„ç†ã€åˆ‡æ¢åˆ†ç±»ã€‘æŒ‰é’®çš„ç‚¹å‡» ---
              const categoryBtn = target.closest(".sticker-category-btn");
              if (categoryBtn) {
                const categoryIdStr = categoryBtn.dataset.categoryId;
                activeStickerCategoryId =
                  categoryIdStr === "uncategorized"
                    ? "uncategorized"
                    : parseInt(categoryIdStr);
                renderStickerPanel(); // åˆ‡æ¢åˆ†ç±»å¹¶é‡æ–°æ¸²æŸ“è¡¨æƒ…åˆ—è¡¨
              }
            });

          // --- äº²å¯†å€¼é¢æ¿äº‹ä»¶ç»‘å®š ---

          // 1. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºæ•´ä¸ªèŠå¤©åˆ—è¡¨ç»‘å®šç‚¹å‡»äº‹ä»¶
          document
            .getElementById("chat-list")
            .addEventListener("click", (e) => {
              // æ£€æŸ¥è¢«ç‚¹å‡»çš„æ˜¯å¦æ˜¯æˆ‘ä»¬çš„äº²å¯†å€¼æŒ‰é’®
              const intimacyBtn = e.target.closest(".intimacy-btn");
              if (intimacyBtn) {
                const chatId = intimacyBtn.dataset.chatId;
                if (chatId) {
                  openIntimacyPanel(chatId);
                }
              }
            });

          // 2. ä¸ºé¢æ¿çš„å…³é—­æŒ‰é’®ç»‘å®šäº‹ä»¶
          document
            .getElementById("close-intimacy-panel")
            .addEventListener("click", () => {
              document
                .getElementById("intimacy-panel")
                .classList.remove("visible");
            });

          document
            .getElementById("open-intimacy-panel-btn")
            .addEventListener("click", () =>
              openIntimacyPanel(state.activeChatId),
            );

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºåŠ¨æ€é¡µé¢çš„å¤´éƒ¨æŒ‰é’®ç»‘å®šäº‹ä»¶
          document
            .getElementById("qzone-screen")
            .addEventListener("click", (e) => {
              // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯æ¸…ç©ºæŒ‰é’®
              const clearBtn = e.target.closest("#clear-qzone-posts-btn");
              if (clearBtn) {
                clearAllQzonePosts(); // å¦‚æœæ˜¯ï¼Œå°±è°ƒç”¨æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„å‡½æ•°
                return;
              }
            });

          // 1. ç»‘å®šä¸»å±å¹•ä¸Šçš„â€œå…”kè®°è´¦â€å›¾æ ‡ç‚¹å‡»äº‹ä»¶
          document
            .getElementById("tukey-accounting-app-icon")
            .addEventListener("click", () => {
              // æ‰“å¼€æ—¶ï¼Œç¡®ä¿é»˜è®¤æ˜¾ç¤ºè®°è´¦ç¾¤èŠ
              switchTukeyView("tukey-group-chat-view");
              showScreen("tukey-accounting-screen");
            });

          // 2. ä¸ºâ€œå…”kè®°è´¦â€çš„åº•éƒ¨å¯¼èˆªæ ç»‘å®šäº‹ä»¶å§”æ‰˜
          document
            .getElementById("tukey-bottom-nav")
            .addEventListener("click", (e) => {
              const navItem = e.target.closest(".tukey-nav-item");
              if (navItem && navItem.dataset.view) {
                switchTukeyView(navItem.dataset.view);
              }
            });

          // æŠ¥è¡¨é¡µé¢çš„ç‚¹å‡»äº‹ä»¶ï¼ˆå¤„ç†åˆ é™¤ï¼‰
          document
            .getElementById("tukey-reports-view")
            .addEventListener("click", (e) => {
              // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†åˆ é™¤æŒ‰é’®
              const deleteBtn = e.target.closest(".delete-record-btn");
              if (deleteBtn) {
                const recordId = parseInt(deleteBtn.dataset.id);
                if (!isNaN(recordId)) {
                  deleteTukeyAccountingRecord(recordId);
                }
              }
            });

          // â€œkkæŸ¥å²—â€åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨
          document
            .getElementById("kk-checkin-app-icon")
            .addEventListener("click", openKkCheckin);

          document
            .getElementById("kk-char-selection-list")
            .addEventListener("click", (e) => {
              const item = e.target.closest(".character-select-item");
              if (item && item.dataset.chatId) {
                openKkHouseView(item.dataset.chatId);
              }
            });

          document
            .getElementById("kk-back-from-house-view")
            .addEventListener("click", () =>
              showScreen("kk-char-selection-screen"),
            );
          document
            .getElementById("kk-back-from-area-view")
            .addEventListener("click", () =>
              showScreen("kk-house-view-screen"),
            );
          document
            .getElementById("close-kk-computer-modal")
            .addEventListener("click", () =>
              document
                .getElementById("kk-computer-modal")
                .classList.remove("visible"),
            );

          document
            .getElementById("close-file-explorer-modal-btn")
            .addEventListener("click", () =>
              document
                .getElementById("kk-file-explorer-modal")
                .classList.remove("visible"),
            );
          document
            .getElementById("kk-reset-search-btn")
            .addEventListener("click", handleResetKkHouse);
          document
            .getElementById("kk-continue-search-btn")
            .addEventListener("click", handleContinueKkSearch);

          document
            .getElementById("close-kk-computer-modal")
            .addEventListener("click", () =>
              document
                .getElementById("kk-computer-modal")
                .classList.remove("visible"),
            );

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†ç”µè„‘æ¡Œé¢æ‰€æœ‰å›¾æ ‡çš„ç‚¹å‡»
          document
            .getElementById("kk-computer-desktop")
            .addEventListener("click", (e) => {
              const icon = e.target.closest(".kk-desktop-icon");
              if (!icon) return;

              const computerData =
                state.chats[activeKkCharId]?.houseData?.computer;
              if (!computerData) {
                showCustomAlert("é”™è¯¯", "æ‰¾ä¸åˆ°ç”µè„‘æ•°æ®ã€‚");
                return;
              }

              switch (icon.id) {
                case "kk-browser-icon":
                  const history = computerData.browser_history || [];
                  // ã€ä¿®æ”¹ã€‘ä¸å†ç”¨ showCustomAlertï¼Œæ”¹ç”¨æ–°å†™çš„åˆ—è¡¨å±•ç¤ºå‡½æ•°
                  showComputerContentList(
                    "æµè§ˆå™¨å†å² (ç‚¹å‡»åˆ†äº«)",
                    history,
                    "æµè§ˆå™¨",
                  );
                  break;

                case "kk-movies-icon":
                  const movies = computerData.movies || [];
                  // ã€ä¿®æ”¹ã€‘åŒä¸Š
                  showComputerContentList("Dç›˜ç”µå½± (ç‚¹å‡»åˆ†äº«)", movies, "Dç›˜");
                  break;

                case "kk-files-icon":
                  // ä¿æŒåŸæ ·ï¼Œæ‰“å¼€æ–‡ä»¶æµè§ˆå™¨
                  // æ³¨æ„ï¼šå¦‚æœä½ æƒ³è®©æ–‡ä»¶ä¹Ÿèƒ½åˆ†äº«ï¼Œéœ€è¦å» openFileExplorer å‡½æ•°é‡Œæ”¹ï¼Œ
                  // ä½†æ–‡ä»¶ç›®å‰æ˜¯ç‚¹å‡»æŸ¥çœ‹å†…å®¹ï¼Œå»ºè®®ä¿æŒç°çŠ¶æˆ–åœ¨æŸ¥çœ‹å™¨é‡ŒåŠ åˆ†äº«æŒ‰é’®
                  openFileExplorer();
                  break;

                case "kk-secret-folder-icon":
                  const secretFolder = computerData.secret_folder;
                  if (secretFolder) {
                    showCustomConfirm(
                      "åŠ å¯†è®¿é—®",
                      `ä½ å°è¯•æ‰“å¼€æ–‡ä»¶ "${secretFolder.fileName}"ã€‚<br><br>è¿™æ˜¯ä¸€ä¸ªåŠ å¯†æ–‡ä»¶å¤¹ï¼Œæ˜¯å¦ç»§ç»­è®¿é—®ï¼Ÿ`,
                    ).then((confirmed) => {
                      if (confirmed) {
                        // ã€ä¿®æ”¹ã€‘è§£å¯†åç›´æ¥å¼¹å‡ºåˆ†äº«ç¡®è®¤æ¡†ï¼Œè€Œä¸æ˜¯åªæ˜¾ç¤º Alert
                        openComputerItemShareModal(
                          secretFolder.fileName,
                          secretFolder.content,
                          "åŠ å¯†æ–‡ä»¶å¤¹",
                        );
                      }
                    });
                  } else {
                    showCustomAlert("æœªå‘ç°", "æ²¡æœ‰æ‰¾åˆ°éšç§˜æ–‡ä»¶å¤¹ã€‚");
                  }
                  break;

                case "kk-steam-icon":
                  openSteamScreen();
                  break;
              }
            });

          document
            .getElementById("close-kk-file-viewer-btn")
            .addEventListener("click", closeFileViewer);
          document
            .getElementById("kk-file-viewer-modal")
            .addEventListener("click", (e) => {
              if (e.target.id === "kk-file-viewer-modal") {
                closeFileViewer();
              }
            });

          document
            .getElementById("close-file-explorer-modal-btn")
            .addEventListener("click", () =>
              document
                .getElementById("kk-file-explorer-modal")
                .classList.remove("visible"),
            );

          // 1. ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ–‡ä»¶åˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶
          document
            .getElementById("kk-file-list")
            .addEventListener("click", (e) => {
              // æ£€æŸ¥è¢«ç‚¹å‡»çš„æ˜¯å¦æ˜¯ä¸€ä¸ªæ–‡ä»¶é¡¹
              const fileItem = e.target.closest(".kk-file-item");
              if (fileItem) {
                // ä»data-*å±æ€§ä¸­å®‰å…¨åœ°è¯»å–æ•°æ®
                const fileName = fileItem.dataset.fileName;
                const fileContent = fileItem.dataset.fileContent;
                if (fileName && fileContent) {
                  openFileViewer(fileName, fileContent);
                }
              }
            });

          // 2. ç»‘å®šæ–°å¼¹çª—çš„å…³é—­æŒ‰é’®
          document
            .getElementById("close-kk-file-viewer-btn")
            .addEventListener("click", closeFileViewer);
          document
            .getElementById("kk-file-viewer-modal")
            .addEventListener("click", (e) => {
              // ç‚¹å‡»é®ç½©å±‚ä¹Ÿå¯ä»¥å…³é—­
              if (e.target.id === "kk-file-viewer-modal") {
                closeFileViewer();
              }
            });

          // Steamæ¸¸æˆåº“å¼¹çª—çš„äº‹ä»¶
          document
            .getElementById("close-kk-steam-modal-btn")
            .addEventListener("click", () => {
              document
                .getElementById("kk-steam-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("kk-generate-more-games-btn")
            .addEventListener("click", generateMoreSteamGames);

          // ä¸ºSteamæ¸¸æˆåˆ—è¡¨æ·»åŠ åˆ é™¤æŒ‰é’®çš„äº‹ä»¶å§”æ‰˜
          document
            .getElementById("kk-steam-games-list")
            .addEventListener("click", async (e) => {
              const deleteBtn = e.target.closest(".item-delete-btn");
              if (deleteBtn) {
                const index = parseInt(deleteBtn.dataset.index);
                const confirmed = await showCustomConfirm(
                  "åˆ é™¤è®°å½•",
                  "ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¸¸æˆè®°å½•å—ï¼Ÿ",
                  {
                    confirmButtonClass: "btn-danger",
                  },
                );
                if (confirmed) {
                  const chat = state.chats[activeKkCharId];
                  chat.houseData.computer.steam_games.splice(index, 1);
                  await db.chats.put(chat);
                  renderSteamScreen();
                }
              }
            });

          /* --- kkæŸ¥å²—-ç›‘æ§åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ --- */
          document
            .getElementById("kk-house-view-screen")
            .addEventListener("click", (e) => {
              // ç‚¹å‡»â€œæŸ¥çœ‹ç›‘æ§â€å›¾æ ‡
              if (e.target.closest("#kk-surveillance-icon")) {
                openSurveillanceView(activeKkCharId);
              }
            });

          document
            .getElementById("kk-back-from-monitor")
            .addEventListener("click", () => {
              // ä»ç›‘æ§ç•Œé¢è¿”å›åˆ°æˆ¿å±‹æ€»è§ˆç•Œé¢
              showScreen("kk-house-view-screen");
            });

          // ç‚¹å‡»ç›‘æ§ä¸­å¿ƒçš„â€œåˆ·æ–°â€æŒ‰é’®
          document
            .getElementById("kk-refresh-monitor-btn")
            .addEventListener("click", async () => {
              if (!activeKkCharId) return;
              const chat = state.chats[activeKkCharId];
              if (chat && chat.houseData) {
                // è°ƒç”¨æ–°çš„â€œæ›´æ–°â€å‡½æ•°
                const newSurveillanceData =
                  await generateSurveillanceUpdate(activeKkCharId);
                if (newSurveillanceData) {
                  chat.houseData.surveillanceData = {
                    timestamp: Date.now(),
                    characterLocation: newSurveillanceData.characterLocation,
                    feeds: newSurveillanceData.feeds,
                  };
                  await db.chats.put(chat);
                  renderSurveillanceView(chat.houseData.surveillanceData);
                  alert("æ‰€æœ‰ç›‘æ§ç”»é¢å·²åˆ·æ–°ï¼");
                }
              }
            });

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰ç›‘æ§ç”»é¢çš„ç‚¹å‡»äº‹ä»¶
          document
            .getElementById("kk-monitor-grid")
            .addEventListener("click", (e) => {
              const monitorItem = e.target.closest(".kk-monitor-item");
              if (!monitorItem) return;

              const areaName = monitorItem.dataset.areaName;
              const interactionButton = e.target.closest(".monitor-btn");

              // å¦‚æœç‚¹å‡»çš„æ˜¯äº’åŠ¨æŒ‰é’®
              if (interactionButton) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å¡ç‰‡æœ¬èº«
                const action = interactionButton.dataset.action;
                handleMonitorInteraction(areaName, action, monitorItem);
              }
              // å¦åˆ™ï¼Œç‚¹å‡»çš„æ˜¯å¡ç‰‡çš„å…¶ä»–åŒºåŸŸ
              else {
                openKkAreaView(areaName);
              }
            });

          // æŸ¥æ‰‹æœº-ç”ŸæˆèŠå¤©é€‰æ‹©å™¨äº‹ä»¶ç»‘å®š
          document
            .getElementById("cancel-chat-gen-btn")
            .addEventListener("click", () => {
              document
                .getElementById("chat-gen-selector-modal")
                .classList.remove("visible");
            });

          // éšæœºå¼€å…³åˆ‡æ¢æ—¶ï¼Œå¯ç”¨/ç¦ç”¨åˆ—è¡¨
          document
            .getElementById("chat-gen-random-checkbox")
            .addEventListener("change", (e) => {
              const list = document.getElementById("chat-gen-list");
              if (e.target.checked) {
                list.style.opacity = "0.5";
                list.style.pointerEvents = "none";
                // æ¸…ç©ºæ‰€æœ‰å‹¾é€‰
                list
                  .querySelectorAll('input[type="checkbox"]')
                  .forEach((cb) => (cb.checked = false));
              } else {
                list.style.opacity = "1";
                list.style.pointerEvents = "auto";
              }
            });

          document
            .getElementById("confirm-chat-gen-btn")
            .addEventListener("click", () => {
              const isRandom = document.getElementById(
                "chat-gen-random-checkbox",
              ).checked;
              let selectedTargets = null;

              if (!isRandom) {
                // å¦‚æœä¸æ˜¯éšæœºï¼Œæ”¶é›†é€‰ä¸­çš„å¯¹è±¡
                selectedTargets = [];
                document
                  .querySelectorAll("#chat-gen-list input:checked")
                  .forEach((checkbox) => {
                    selectedTargets.push({
                      name: checkbox.dataset.name,
                      persona: checkbox.dataset.persona,
                    });
                  });

                if (selectedTargets.length === 0) {
                  alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªèŠå¤©å¯¹è±¡ï¼Œæˆ–è€…å¼€å¯éšæœºæ¨¡å¼ã€‚");
                  return;
                }
              }

              document
                .getElementById("chat-gen-selector-modal")
                .classList.remove("visible");
              // è°ƒç”¨ç”Ÿæˆå‡½æ•°ï¼Œä¼ å…¥é€‰ä¸­çš„ç›®æ ‡ï¼ˆå¦‚æœæ˜¯éšæœºåˆ™ä¸ºnullï¼‰
              generateCharacterPhoneDataSegment("chats", selectedTargets);
            });
          // å¿«æ·å›å¤äº‹ä»¶ç»‘å®š
          document
            .getElementById("quick-reply-btn")
            .addEventListener("click", openQuickReplyModal);

          document
            .getElementById("add-quick-reply-btn")
            .addEventListener("click", addNewQuickReply);

          document
            .getElementById("close-quick-reply-btn")
            .addEventListener("click", () => {
              document
                .getElementById("quick-reply-modal")
                .classList.remove("visible");
            });

          document
            .getElementById("export-quick-reply-btn")
            .addEventListener("click", exportQuickReplies);

          document
            .getElementById("import-quick-reply-btn")
            .addEventListener("click", () => {
              document.getElementById("import-quick-reply-input").click();
            });

          document
            .getElementById("import-quick-reply-input")
            .addEventListener("change", (e) => {
              importQuickReplies(e.target.files[0]);
              e.target.value = null;
            });

          // æ—¶é—´è½´åŠŸèƒ½äº‹ä»¶ç»‘å®š (æ›´æ–°ç‰ˆ)
          // æ³¨æ„ ID å˜æˆäº† timeline-branch-btn
          document
            .getElementById("timeline-branch-btn")
            .addEventListener("click", openBranchingModal);

          document
            .getElementById("create-branch-btn")
            .addEventListener("click", createBranchCheckpoint);
          document
            .getElementById("restart-chat-btn")
            .addEventListener("click", restartChatBranch);
          document
            .getElementById("close-branching-modal-btn")
            .addEventListener("click", () => {
              document
                .getElementById("branching-modal")
                .classList.remove("visible");
            });

          // åœ¨ init() å†…éƒ¨æ·»åŠ ï¼š
          document
            .getElementById("aurora-media-btn")
            .addEventListener("click", openAuroraSetupModal);
          document
            .getElementById("cancel-aurora-setup")
            .addEventListener("click", () => {
              document
                .getElementById("aurora-setup-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("confirm-aurora-setup")
            .addEventListener("click", confirmAuroraSetup);
          document
            .getElementById("aurora-close-player")
            .addEventListener("click", closeAuroraPlayer);
          // æå…‰æ¨¡å¼åˆ‡æ¢äº‹ä»¶ç»‘å®š
          // è¾…åŠ©å‡½æ•°ï¼šå»æ‰æ–‡ä»¶åç¼€
          const autoFillAuroraTitle = (file) => {
            if (file) {
              // è·å–æ–‡ä»¶åï¼Œå»æ‰æœ€åä¸€ä¸ªç‚¹ä¹‹åçš„å†…å®¹
              const fileName = file.name.replace(/\.[^/.]+$/, "");
              document.getElementById("aurora-title-input").value = fileName;
            }
          };

          // ç›‘å¬è§†é¢‘æ–‡ä»¶é€‰æ‹©
          document
            .getElementById("aurora-video-file")
            .addEventListener("change", (e) => {
              if (e.target.files.length > 0) {
                autoFillAuroraTitle(e.target.files[0]);
              }
            });

          // ç›‘å¬æ–‡æœ¬æ–‡ä»¶é€‰æ‹©
          document
            .getElementById("aurora-text-file")
            .addEventListener("change", (e) => {
              if (e.target.files.length > 0) {
                autoFillAuroraTitle(e.target.files[0]);
              }
            });

          // ---------------- [ä¿®æ”¹å¼€å§‹] ä¿®å¤æ–‡æœ¬é”™ä½é—®é¢˜ ----------------
          // æ¼«æ¸¸é˜…è¯»è¿›åº¦è‡ªåŠ¨ä¿å­˜ & å®æ—¶ä¸Šä¸‹æ–‡æ›´æ–°åŠŸèƒ½
          const textViewer = document.getElementById("aurora-text-viewer");
          let saveProgressTimer = null;

          // è¾…åŠ©å‡½æ•°ï¼šè·å–å½“å‰å¯è§†åŒºåŸŸçš„æ–‡æœ¬
          function updateCurrentReadingContext() {
            if (!auroraState.textContent) return;

            const scrollHeight =
              textViewer.scrollHeight - textViewer.clientHeight;
            const scrollTop = textViewer.scrollTop;

            // é˜²æ­¢é™¤ä»¥0
            const scrollPercentage =
              scrollHeight > 0 ? scrollTop / scrollHeight : 0;
            const totalLength = auroraState.textContent.length;

            // è®¡ç®—ä¸­å¿ƒç‚¹ç´¢å¼•
            const centerIndex = Math.floor(totalLength * scrollPercentage);

            // æˆªå–å‰åå„ 500 å­—ï¼Œä¿è¯ä¸Šä¸‹æ–‡è¶³å¤Ÿ
            const start = Math.max(0, centerIndex - 500);
            const end = Math.min(totalLength, centerIndex + 500);

            // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šç›´æ¥æŠŠè¿™æ®µæ–‡å­—å­˜è¿›å…¨å±€çŠ¶æ€ï¼Œä¾›AIéšæ—¶è¯»å– â˜…â˜…â˜…
            auroraState.currentSegmentText = auroraState.textContent.substring(
              start,
              end,
            );

            return scrollPercentage; // è¿”å›è¿›åº¦ç»™ä¸‹é¢ä¿å­˜ç”¨
          }

          textViewer.addEventListener("scroll", () => {
            // 1. å®æ—¶æ›´æ–°å½“å‰é˜…è¯»ç‰‡æ®µï¼ˆæ— è®ºæ˜¯å¦åœ¨ä¹¦æ¶æ¨¡å¼ï¼‰
            const currentProgress = updateCurrentReadingContext();

            // 2. æ£€æŸ¥å½“å‰æ˜¯å¦å¤„äºä¹¦æ¶é˜…è¯»æ¨¡å¼ï¼ˆç”¨äºä¿å­˜è¿›åº¦åˆ°æ•°æ®åº“ï¼‰
            if (
              !auroraState.active ||
              auroraState.mode !== "text" ||
              !auroraState.currentBookId
            ) {
              return;
            }

            // 3. é˜²æŠ–å¤„ç†ï¼šç”¨æˆ·åœæ­¢æ»šåŠ¨ 0.5 ç§’åæ‰ä¿å­˜æ•°æ®åº“ï¼Œé¿å…å¡é¡¿
            if (saveProgressTimer) clearTimeout(saveProgressTimer);

            saveProgressTimer = setTimeout(async () => {
              // ç¡®ä¿è¿›åº¦åœ¨ 0 åˆ° 1 ä¹‹é—´
              const progress = Math.max(0, Math.min(1, currentProgress));

              try {
                await db.auroraBooks.update(auroraState.currentBookId, {
                  progress: progress,
                });
              } catch (error) {
                console.error("ä¿å­˜é˜…è¯»è¿›åº¦å¤±è´¥:", error);
              }
            }, 500);
          });
          // ---------------- [ä¿®æ”¹ç»“æŸ] ----------------

          document
            .querySelectorAll('input[name="aurora-mode"]')
            .forEach((radio) => {
              radio.addEventListener("change", toggleAuroraInputs);
            });

          // ç»‘å®š GitHub æ‰‹åŠ¨ä¸Šä¼ æŒ‰é’®
          const githubBtn = document.getElementById("manual-github-backup-btn");
          if (githubBtn) {
            githubBtn.addEventListener("click", () =>
              uploadBackupToGitHub(false),
            );
          }
          // ç»‘å®š GitHub æ¢å¤æŒ‰é’®
          const githubRestoreBtn = document.getElementById(
            "manual-github-restore-btn",
          );
          const gitStreamUploadBtn = document.getElementById(
            "git-stream-upload-btn",
          );
          if (gitStreamUploadBtn) {
            gitStreamUploadBtn.addEventListener(
              "click",
              uploadBackupToGitHubStream,
            );
          }

          const gitStreamRestoreBtn = document.getElementById(
            "git-stream-restore-btn",
          );
          if (gitStreamRestoreBtn) {
            gitStreamRestoreBtn.addEventListener(
              "click",
              restoreBackupFromGitHubStream,
            );
          }

          if (githubRestoreBtn) {
            githubRestoreBtn.addEventListener("click", restoreBackupFromGitHub);
          }
          // --- KKæŸ¥å²—ä¸“ç”¨å¼¹çª—å…³é—­äº‹ä»¶ ---
          document
            .getElementById("kk-item-share-close-btn")
            .addEventListener("click", () => {
              document
                .getElementById("kk-item-share-modal")
                .classList.remove("visible");
            });

          // ç‚¹å‡»é®ç½©å±‚ä¹Ÿå¯ä»¥å…³é—­
          document
            .getElementById("kk-item-share-modal")
            .addEventListener("click", (e) => {
              if (e.target.id === "kk-item-share-modal") {
                e.target.classList.remove("visible");
              }
            });

          // ç¡®ä¿ä½ åœ¨ HTML é‡ŒåŠ äº† id="kk-wardrobe-btn"
          const wardrobeEntryBtn = document.getElementById("kk-wardrobe-btn");
          if (wardrobeEntryBtn) {
            wardrobeEntryBtn.addEventListener("click", openKkWardrobe);
          }

          // 2. ç»‘å®šè¡£æŸœå†…éƒ¨çš„â€œè¿”å›â€æŒ‰é’®
          document
            .getElementById("kk-back-from-wardrobe")
            .addEventListener("click", () => {
              // è¿”å›åˆ°æˆ¿å±‹æ€»è§ˆ
              showScreen("kk-house-view-screen");
            });

          // 3. ç»‘å®šâ€œé‡ç½®è¡£æŸœâ€æŒ‰é’®
          document
            .getElementById("kk-wardrobe-refresh-btn")
            .addEventListener("click", async () => {
              const confirmed = await showCustomConfirm(
                "é‡ç½®è¡£æŸœ",
                "ç¡®å®šè¦æ¸…ç©ºå¹¶é‡æ–°ç”Ÿæˆæ‰€æœ‰è¡£æœå—ï¼Ÿ",
                {
                  confirmButtonClass: "btn-danger",
                },
              );
              if (confirmed) {
                await generateWardrobeData(activeKkCharId); // é‡æ–°ç”Ÿæˆ
                currentOutfit = {
                  ä¸Šè£…: null,
                  ä¸‹è£…: null,
                  é…é¥°: null,
                  ç‰¹æ®Š: null,
                };
                renderWardrobeUI();
              }
            });

          // 4. ç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢ (ä½¿ç”¨äº‹ä»¶å§”æ‰˜)
          document
            .querySelector(".wardrobe-tabs")
            .addEventListener("click", (e) => {
              if (e.target.classList.contains("wardrobe-tab")) {
                activeWardrobeCategory = e.target.dataset.cat;
                renderWardrobeUI();
              }
            });

          // 5. ç»‘å®šâ€œè¯•ç©¿â€æŒ‰é’®
          document
            .getElementById("wardrobe-try-on-btn")
            .addEventListener("click", handleTryOn);
          const sysNotifSwitch = document.getElementById(
            "system-notification-switch",
          );
          if (sysNotifSwitch) {
            sysNotifSwitch.addEventListener("change", (e) => {
              if (e.target.checked) {
                // ç”¨æˆ·å°è¯•å¼€å¯
                if (!("Notification" in window)) {
                  alert("æŠ±æ­‰ï¼Œä½ çš„è®¾å¤‡æˆ–æµè§ˆå™¨ä¸æ”¯æŒç³»ç»Ÿé€šçŸ¥ã€‚");
                  e.target.checked = false;
                } else if (Notification.permission === "granted") {
                  // å·²ç»æ˜¯æˆæƒçŠ¶æ€ï¼Œæ— éœ€æ“ä½œ
                  new Notification("EPhone", {
                    body: "æµ‹è¯•é€šçŸ¥ï¼šç³»ç»Ÿé€šçŸ¥åŠŸèƒ½æ­£å¸¸ï¼",
                  });
                } else if (Notification.permission !== "denied") {
                  // è¯·æ±‚æƒé™
                  Notification.requestPermission().then((permission) => {
                    if (permission === "granted") {
                      new Notification("EPhone", {
                        body: "æˆåŠŸå¼€å¯ï¼ä»¥åæ”¶åˆ°æ¶ˆæ¯ä¼šæœ‰å¼¹çª—å“¦ã€‚",
                      });
                    } else {
                      e.target.checked = false;
                      alert(
                        "ä½ æ‹’ç»äº†é€šçŸ¥æƒé™ã€‚å¦‚éœ€å¼€å¯ï¼Œè¯·åœ¨æ‰‹æœºç³»ç»Ÿè®¾ç½®ä¸­å…è®¸æœ¬åº”ç”¨å‘é€é€šçŸ¥ã€‚",
                      );
                    }
                  });
                } else {
                  // ä¹‹å‰è¢«æ‹’ç»è¿‡
                  alert(
                    "æƒé™å·²è¢«æ‹’ç»ã€‚è¯·å‰å¾€æ‰‹æœºã€è®¾ç½® -> é€šçŸ¥ã€‘ä¸­æ‰¾åˆ°æœ¬åº”ç”¨ï¼Œæ‰‹åŠ¨å¼€å¯é€šçŸ¥æƒé™ã€‚",
                  );
                  e.target.checked = false;
                }
              }
            });
          }
          // --- æƒ…ä¾£å¤´åƒåº“åŠŸèƒ½äº‹ä»¶ ---

          // 1. æ‰“å¼€ç®¡ç†å¼¹çª—
          document
            .getElementById("manage-couple-avatar-library-btn")
            .addEventListener("click", (e) => {
              // é˜»æ­¢å†’æ³¡é˜²æ­¢å…³é—­è®¾ç½®å¼¹çª—ï¼ˆè§†æƒ…å†µè€Œå®šï¼Œè¿™é‡Œå»ºè®®å…ˆä¸å…³é—­è®¾ç½®å¼¹çª—ï¼Œæˆ–è€…å±‚å æ˜¾ç¤ºï¼‰
              // ä¸ºäº†ä½“éªŒæ›´å¥½ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆéšè—èŠå¤©è®¾ç½®å¼¹çª—
              document
                .getElementById("chat-settings-modal")
                .classList.remove("visible");
              openCoupleAvatarLibraryModal();
            });

          // 2. å…³é—­ç®¡ç†å¼¹çª— (è¿”å›è®¾ç½®)
          document
            .getElementById("close-couple-avatar-library-btn")
            .addEventListener("click", () => {
              document
                .getElementById("couple-avatar-library-modal")
                .classList.remove("visible");
              // é‡æ–°æ‰“å¼€è®¾ç½®å¼¹çª—
              document.getElementById("chat-settings-btn").click();
            });

          // 3. æ‰“å¼€æ·»åŠ å¼¹çª—
          document
            .getElementById("add-couple-avatar-btn")
            .addEventListener("click", () => {
              // æ¸…ç©ºè¾“å…¥
              document.getElementById("new-couple-my-avatar-preview").src =
                "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png";
              document.getElementById("new-couple-char-avatar-preview").src =
                "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png";
              document.getElementById("new-couple-desc-input").value = "";
              document.getElementById("new-couple-my-avatar-input").value = "";
              document.getElementById("new-couple-char-avatar-input").value =
                "";

              document
                .getElementById("add-couple-avatar-modal")
                .classList.add("visible");
            });

          // 4. å…³é—­æ·»åŠ å¼¹çª—
          document
            .getElementById("cancel-add-couple-avatar-btn")
            .addEventListener("click", () => {
              document
                .getElementById("add-couple-avatar-modal")
                .classList.remove("visible");
            });

          // 5. ä¿å­˜æ–°æƒ…å¤´
          document
            .getElementById("save-couple-avatar-btn")
            .addEventListener("click", async () => {
              const myAvatarSrc = document.getElementById(
                "new-couple-my-avatar-preview",
              ).src;
              const charAvatarSrc = document.getElementById(
                "new-couple-char-avatar-preview",
              ).src;
              const desc = document
                .getElementById("new-couple-desc-input")
                .value.trim();

              if (
                myAvatarSrc.includes("placeholder") ||
                charAvatarSrc.includes("placeholder")
              ) {
                alert("è¯·ä¸Šä¼ ä¸¤å¼ å¤´åƒï¼");
                return;
              }
              if (!desc) {
                alert("è¯·è¾“å…¥æè¿°ï¼Œè¿™å¾ˆé‡è¦ï¼ŒAIé å®ƒæ¥é€‰æ‹©å¤´åƒï¼");
                return;
              }

              const chat = state.chats[state.activeChatId];
              if (!chat.settings.coupleAvatarLibrary)
                chat.settings.coupleAvatarLibrary = [];

              const newPair = {
                id: "couple_" + Date.now(),
                userAvatar: myAvatarSrc,
                charAvatar: charAvatarSrc,
                description: desc,
              };

              chat.settings.coupleAvatarLibrary.push(newPair);
              await db.chats.put(chat);

              document
                .getElementById("add-couple-avatar-modal")
                .classList.remove("visible");
              renderCoupleAvatarLibraryList(); // åˆ·æ–°åˆ—è¡¨
              alert("æƒ…ä¾£å¤´åƒæ·»åŠ æˆåŠŸï¼");
            });

          // 6. å›¾ç‰‡ä¸Šä¼ é¢„è§ˆç»‘å®š (å¤ç”¨é€šç”¨çš„ä¸Šä¼ å‡½æ•°)
          setupFileUpload("new-couple-my-avatar-input", (base64) => {
            document.getElementById("new-couple-my-avatar-preview").src =
              base64;
          });
          setupFileUpload("new-couple-char-avatar-input", (base64) => {
            document.getElementById("new-couple-char-avatar-preview").src =
              base64;
          });

          // æ ¸å¿ƒå‡½æ•°ï¼šæ‰“å¼€ç®¡ç†å¼¹çª—
          function openCoupleAvatarLibraryModal() {
            if (!state.activeChatId) return;
            renderCoupleAvatarLibraryList();
            document
              .getElementById("couple-avatar-library-modal")
              .classList.add("visible");
          }

          // æ ¸å¿ƒå‡½æ•°ï¼šæ¸²æŸ“åˆ—è¡¨
          function renderCoupleAvatarLibraryList() {
            const listEl = document.getElementById(
              "couple-avatar-library-list",
            );
            const chat = state.chats[state.activeChatId];
            const library = chat.settings.coupleAvatarLibrary || [];

            listEl.innerHTML = "";

            if (library.length === 0) {
              listEl.innerHTML =
                '<p style="text-align:center; color:#999; padding:20px;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»æ·»åŠ ç¬¬ä¸€å¯¹æƒ…å¤´å§ï¼</p>';
              return;
            }

            library.forEach((pair, index) => {
              const item = document.createElement("div");
              item.style.cssText = `
            background: #fff; padding: 10px; border-radius: 12px; 
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        `;

              item.innerHTML = `
            <div style="display:flex; justify-content:center; gap: 15px; align-items:center;">
                <div style="text-align:center;">
                    <img src="${pair.userAvatar}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid #eee;">
                    <div style="font-size:10px; color:#666; margin-top:2px;">æˆ‘</div>
                </div>
                <div style="font-size:20px;">â¤ï¸</div>
                <div style="text-align:center;">
                    <img src="${pair.charAvatar}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid #eee;">
                    <div style="font-size:10px; color:#666; margin-top:2px;">Ta</div>
                </div>
            </div>
            <div style="font-size:13px; color:#333; background:#f9f9f9; padding:8px; border-radius:6px;">
                <strong>æè¿°ï¼š</strong>${pair.description}
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="moe-btn-mini apply-pair-btn" style="background:#4caf50; color:white;">åº”ç”¨</button>
                <button class="moe-btn-mini delete-pair-btn" style="background:#ff3b30; color:white;">åˆ é™¤</button>
            </div>
        `;

              // ç»‘å®šåˆ é™¤
              item.querySelector(".delete-pair-btn").onclick = async () => {
                if (confirm("ç¡®å®šè¦åˆ é™¤è¿™å¯¹æƒ…å¤´å—ï¼Ÿ")) {
                  chat.settings.coupleAvatarLibrary.splice(index, 1);
                  await db.chats.put(chat);
                  renderCoupleAvatarLibraryList();
                }
              };

              // ç»‘å®šæ‰‹åŠ¨åº”ç”¨
              item.querySelector(".apply-pair-btn").onclick = async () => {
                chat.settings.aiAvatar = pair.charAvatar;
                chat.settings.myAvatar = pair.userAvatar;
                chat.settings.isCoupleAvatar = true;
                chat.settings.coupleAvatarDescription = pair.description;
                await db.chats.put(chat);

                // å¦‚æœèŠå¤©ç•Œé¢å¼€ç€ï¼Œåˆ·æ–°å®ƒ
                if (
                  document
                    .getElementById("chat-interface-screen")
                    .classList.contains("active")
                ) {
                  renderChatInterface(chat.id);
                }
                alert("å·²åº”ç”¨æ­¤æƒ…ä¾£å¤´åƒï¼");
              };

              listEl.appendChild(item);
            });
          }
          // 1. åŠ è½½æ•°æ®åˆ°å†…å­˜
          state.passerbyAvatars = await db.passerbyAvatars.toArray();

          // 2. ç»‘å®šè®¾ç½®é¡µé¢çš„æŒ‰é’®
          document
            .getElementById("manage-passerby-avatars-btn")
            .addEventListener("click", openPasserbyManager);
          document
            .getElementById("add-passerby-avatar-btn")
            .addEventListener("click", handleAddPasserbyAvatar);

          // 3. ç»‘å®šå¼¹çª—å†…çš„æŒ‰é’®
          document
            .getElementById("close-passerby-manager-btn")
            .addEventListener("click", () => {
              document
                .getElementById("passerby-avatar-manager-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("bulk-add-passerby-btn")
            .addEventListener("click", handleAddPasserbyAvatar);

          // 4. ç»‘å®šæ–‡ä»¶è¾“å…¥æ¡†
          document
            .getElementById("passerby-upload-input")
            .addEventListener("change", handlePasserbyFileChange);
          initAuroraDrag(); // åˆå§‹åŒ–æ‹–æ‹½
          initAuroraFontControl();
          initAuroraResize();
          initVideoBubbleDrag(); // åˆå§‹åŒ–è§†é¢‘æ‚¬æµ®çƒæ‹–æ‹½
          initLoversSpace();
          initTaobao();
          initTukeyAccounting();
          initDesktopManager();

          // ===================================================================
          // 5. å¯åŠ¨ï¼

          // åº”ç”¨å£çº¸å¹¶æ›´æ–°æ‰€æœ‰æ—¶é’Ÿ
          applyLockscreenWallpaper();
          updateLockClock();

          // 1. è¯»å–ã€åº”ç”¨å¹¶ç›‘å¬â€œå¯ç”¨é”å±â€è®¾ç½®
          const enableLockScreenToggle = document.getElementById(
            "enable-lock-screen-toggle",
          );
          const lockScreenEnabled =
            localStorage.getItem("lockScreenEnabled") !== "false";
          enableLockScreenToggle.checked = lockScreenEnabled;

          // 2. è¯»å–ã€åº”ç”¨å¹¶ç›‘å¬â€œæ˜¾ç¤ºçŠ¶æ€æ â€è®¾ç½®
          const showStatusBarToggle = document.getElementById(
            "show-status-bar-toggle",
          );
          const statusBar = document.getElementById("status-bar");
          // è¯»å–ä¿å­˜çš„çŠ¶æ€ï¼Œå¦‚æœæ²¡ä¿å­˜è¿‡ï¼Œé»˜è®¤æ˜¯ true (æ˜¾ç¤º)
          const showStatusBar =
            localStorage.getItem("showStatusBar") !== "false";
          // è®©å¼€å…³çš„çŠ¶æ€å’Œä¿å­˜çš„çŠ¶æ€åŒæ­¥
          showStatusBarToggle.checked = showStatusBar;
          // æ ¹æ®ä¿å­˜çš„çŠ¶æ€ï¼Œå†³å®šä¸€åŠ è½½è¿›æ¥æ—¶æ˜¯å¦æ˜¾ç¤ºçŠ¶æ€æ 
          if (showStatusBar) {
            statusBar.style.display = "flex";
          } else {
            statusBar.style.display = "none";
          }

          // 3. ç»™å¼€å…³æ·»åŠ â€œå˜åŒ–â€ç›‘å¬å™¨ï¼Œè¿™æ ·ä½ æ¯æ¬¡ç‚¹å‡»å®ƒéƒ½ä¼šä¿å­˜çŠ¶æ€
          showStatusBarToggle.addEventListener("change", (e) => {
            const isEnabled = e.target.checked;
            // a. å°†æ–°çš„å¼€å…³çŠ¶æ€ (true æˆ– false) ä¿å­˜åˆ°æµè§ˆå™¨çš„ localStorage é‡Œ
            localStorage.setItem("showStatusBar", isEnabled);
            // b. ç«‹åˆ»æ ¹æ®æ–°çš„çŠ¶æ€æ¥æ˜¾ç¤ºæˆ–éšè—çŠ¶æ€æ 
            statusBar.style.display = isEnabled ? "flex" : "none";
          });

          // 4. æ ¹æ®æœ€ç»ˆçš„é”å±è®¾ç½®ï¼Œå†³å®šåº”ç”¨å¯åŠ¨æ—¶ç¬¬ä¸€ä¸ªæ˜¾ç¤ºçš„å±å¹•
          if (lockScreenEnabled) {
            lockPhone(); // å¦‚æœè®¾ç½®æ˜¯â€œå¯ç”¨â€ï¼Œå°±é”å®šæ‰‹æœº
          } else {
            showScreen("home-screen"); // å¦åˆ™ï¼Œç›´æ¥è¿›å…¥ä¸»å±å¹•
          }
        }
        function renderLoginOverlay() {
          if (document.getElementById("login-overlay")) return;

          // 1. å¼•å…¥å­—ä½“
          if (!document.getElementById("pixel-font-link")) {
            const fontLink = document.createElement("link");
            fontLink.id = "pixel-font-link";
            fontLink.href =
              "https://fonts.googleapis.com/css2?family=VT323&display=swap";
            fontLink.rel = "stylesheet";
            document.head.appendChild(fontLink);
          }

          // 2. æ ·å¼å®šä¹‰
          const style = document.createElement("style");
          style.innerHTML = `
            #login-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: #dbc6c6; 
                z-index: 99999;
                display: flex; flex-direction: column;
                justify-content: center; align-items: center;
                font-family: 'VT323', monospace;
                overflow: hidden;
            }

            /* --- æœºèº« --- */
            .gameboy-body {
                width: 360px; height: 640px;
                background-color: #eed7d5; /* æ¯ç«ç‘°ç²‰ */
                border-radius: 60px;
                box-shadow: 
                    20px 20px 60px #c5b0ae, 
                    -20px -20px 60px #fffaf8,
                    inset 2px 2px 5px rgba(255,255,255,0.5);
                border: 6px solid #e6cfcd;
                display: flex; flex-direction: column;
                align-items: center;
                padding: 30px; box-sizing: border-box; position: relative;
            }

            /* --- å±å¹•å¤–æ¡† --- */
            .screen-bezel {
                width: 100%;
                background-color: #dcbdbb;
                border-radius: 40px 40px 50px 40px;
                padding: 20px; box-sizing: border-box;
                box-shadow: inset 3px 3px 10px rgba(0,0,0,0.1);
                display: flex; flex-direction: column; align-items: center;
                margin-bottom: 30px; position: relative;
            }
            .bezel-dots { position: absolute; top: 12px; left: 25px; display: flex; gap: 6px; }
            .dot { width: 6px; height: 6px; border-radius: 50%; background: #b09896; opacity: 0.5;}

            /* --- æ¶²æ™¶å±å¹• --- */
            .screen-lcd {
                width: 100%; height: 320px;
                background-color: #4a3b3b;
                border-radius: 20px;
                box-shadow: inset 0 0 15px rgba(0,0,0,0.6);
                background-image: 
                    linear-gradient(rgba(255, 192, 203, 0.03) 1px, transparent 1px),
                    linear-gradient(90deg, rgba(255, 192, 203, 0.03) 1px, transparent 1px);
                background-size: 4px 4px;
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                color: #fce4ec; text-shadow: 0 0 4px rgba(252, 228, 236, 0.6);
                position: relative; overflow: hidden;
            }
            
            .scanline {
                width: 100%; height: 100%; position: absolute; left: 0; top: 0;
                background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
                background-size: 100% 4px; pointer-events: none; z-index: 5; opacity: 0.3;
            }

            .game-logo { font-size: 28px; margin-bottom: 30px; letter-spacing: 4px; opacity: 0.9; }

            /* --- è¾“å…¥æ¡†ç»„ (åŒ…å«è¡Œèµ°çš„å°äºº) --- */
            .input-group {
                width: 85%;
                position: relative;
                margin-bottom: 25px; /* å¢åŠ é—´è·ç»™å°äººç•™ä½ç½® */
            }

            .pixel-input {
                width: 100%; height: 40px;
                background: rgba(255, 255, 255, 0.1);
                border: 2px solid #8d7878;
                border-radius: 10px;
                color: #fff;
                font-family: 'VT323', monospace;
                font-size: 20px;
                padding: 0 10px;
                text-align: center;
                outline: none;
                transition: all 0.3s;
                box-sizing: border-box; /* ç¡®ä¿paddingä¸æ’‘å¤§å®½åº¦ */
            }
            .pixel-input:focus {
                background: rgba(255, 255, 255, 0.2);
                border-color: #f8a5c2;
                box-shadow: 0 0 10px rgba(248, 165, 194, 0.4);
            }
            .pixel-input::placeholder { color: rgba(252, 228, 236, 0.3); font-size: 18px; }

            /* --- è¡Œèµ°çš„å°äººåŠ¨ç”» --- */
            .walker {
                position: absolute;
                /* æ”¾åœ¨è¾“å…¥æ¡†ä¸Šæ–¹è¾¹æ¡†çš„ä½ç½® */
                top: -38px; 
                height: 40px; /* ç¨å¾®å¤§ä¸€ç‚¹ç‚¹ */
                width: auto;
                z-index: 10;
                pointer-events: none; /* è®©é¼ æ ‡ç‚¹å‡»ç©¿é€å›¾ç‰‡ï¼Œä¸å½±å“ç‚¹è¾“å…¥æ¡† */
                image-rendering: pixelated; /* ä¿æŒåƒç´ æ¸…æ™° */
            }

            /* å®šä¹‰è¡Œèµ°åŠ¨ç”»ï¼šä»å·¦è·‘åˆ°å³ï¼Œç„¶åç¬é—´å›åˆ°å·¦è¾¹å¾ªç¯ */
            @keyframes walkRight {
                0% { left: -10px; }
                100% { left: calc(100% - 30px); } 
            }

            .walker-uid {
                animation: walkRight 8s linear infinite;
            }
            
            .walker-pwd {
                /* ç¨å¾®æ…¢ä¸€ç‚¹ï¼Œå¹¶ä¸”æœ‰å»¶è¿Ÿï¼Œåˆ¶é€ è·ç¦»æ„Ÿ */
                animation: walkRight 9s linear infinite; 
                animation-delay: -4s; /* è´Ÿå»¶è¿Ÿè¡¨ç¤ºåŠ¨ç”»ä¸€å¼€å§‹å°±åœ¨ä¸­é—´ */
            }

            #login-msg { height: 20px; font-size: 16px; color: #fab1a0; margin-top: 5px; }

            /* --- æ“æ§åŒº --- */
            .controls-area { width: 100%; flex: 1; position: relative; }

            .d-pad { position: absolute; top: 20px; left: 20px; width: 100px; height: 100px; }
            .d-pad-h, .d-pad-v {
                background: #b5a3a3; border-radius: 10px;
                box-shadow: inset 2px 2px 5px rgba(255,255,255,0.2), 3px 3px 5px rgba(0,0,0,0.1);
                position: absolute;
            }
            .d-pad-h { width: 100px; height: 34px; top: 33px; }
            .d-pad-v { width: 34px; height: 100px; left: 33px; }
            .d-pad-center {
                width: 34px; height: 34px; background: #b5a3a3;
                position: absolute; top: 33px; left: 33px; z-index: 2;
                border-radius: 50%; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
            }

            .action-btns { position: absolute; top: 30px; right: 20px; display: flex; gap: 20px; transform: rotate(-10deg); }
            .round-btn {
                width: 55px; height: 55px; border-radius: 50%; border: none; cursor: pointer;
                font-family: 'VT323', monospace; font-size: 24px; color: rgba(255,255,255,0.6);
                display: flex; justify-content: center; align-items: center;
                box-shadow: 0 6px 0 rgba(0,0,0,0.15), 0 10px 10px rgba(0,0,0,0.1);
                transition: transform 0.1s; position: relative;
            }
            .btn-a { background: radial-gradient(circle at 30% 30%, #eababa, #cd8d8d); margin-top: -20px; }
            .btn-b { background: radial-gradient(circle at 30% 30%, #c4d4c4, #8fa08f); margin-top: 20px; }
            .round-btn:active { transform: translateY(6px); box-shadow: 0 0 0 rgba(0,0,0,0.15); }
            .btn-label { position: absolute; bottom: -25px; width: 100%; text-align: center; color: #bcaaaa; font-size: 14px; font-weight: bold; }

            .options-group { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 30px; }
            .pill-btn { width: 60px; height: 16px; background: #cbbaba; border-radius: 20px; transform: rotate(-15deg); box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); }
            .speakers { position: absolute; bottom: 30px; right: 30px; display: flex; gap: 5px; transform: rotate(-15deg); }
            .sp-slot { width: 6px; height: 6px; background: rgba(0,0,0,0.05); border-radius: 50%; box-shadow: inset 1px 1px 1px rgba(0,0,0,0.1); }
          `;
          document.head.appendChild(style);

          // 3. HTMLç»“æ„
          const overlay = document.createElement("div");
          overlay.id = "login-overlay";

          overlay.innerHTML = `
            <div class="gameboy-body">
                <div class="screen-bezel">
                    <div class="bezel-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    
                    <div class="screen-lcd">
                        <div class="scanline"></div>
                        <div class="game-logo">E-PHONE TUKI</div>
                        
                        <!-- è´¦å·è¾“å…¥æ¡†ç»„ -->
                        <div class="input-group">
                            <img src="https://i.postimg.cc/bwyK9rVr/1000109644.png" class="walker walker-uid" alt="char1">
                            <input type="text" id="login-uid" class="pixel-input" placeholder="ACCOUNT ID" spellcheck="false" autocomplete="off">
                        </div>

                        <!-- å¯†ç è¾“å…¥æ¡†ç»„ -->
                        <div class="input-group">
                            <img src="https://i.postimg.cc/NjsWkFCQ/test.png" class="walker walker-pwd" alt="char2">
                            <input type="password" id="login-pwd" class="pixel-input" placeholder="PASSWORD" autocomplete="off">
                        </div>
                        
                        <p id="login-msg">WAITING...</p>
                        
                        <div style="margin-top: 15px; font-size: 14px; color: rgba(252, 228, 236, 0.5);">â— REC</div>
                    </div>
                    
                    <div style="margin-top: 10px; color: #a69292; font-size: 12px; letter-spacing: 1px; font-weight: bold;">
                        Ephone TUKI ^ Ì³- â€§Ì« â€¢ Ì³^à¸…
                    </div>
                </div>

                <div class="controls-area">
                    <div class="d-pad">
                        <div class="d-pad-h"></div><div class="d-pad-v"></div><div class="d-pad-center"></div>
                    </div>
                    <div class="action-btns">
                        <div style="position:relative;">
                             <button id="btn-login-reset" class="round-btn btn-b">B</button>
                             <div class="btn-label">RESET</div>
                        </div>
                        <div style="position:relative;">
                             <button id="btn-login-submit" class="round-btn btn-a">A</button>
                             <div class="btn-label">START</div>
                        </div>
                    </div>
                    <div class="options-group">
                        <div class="pill-btn"></div><div class="pill-btn"></div>
                    </div>
                    <div class="speakers">
                        <div class="sp-slot"></div><div class="sp-slot"></div><div class="sp-slot"></div>
                        <div class="sp-slot"></div><div class="sp-slot"></div><div class="sp-slot"></div>
                    </div>
                </div>
            </div>
            <div style="margin-top: 25px; font-size: 14px; color: #7f6e6e;">
                PRESS <span style="color:#cd8d8d; font-weight:bold;">( A )</span> TO LOGIN
            </div>
          `;

          document.body.prepend(overlay);

          // 4. äº‹ä»¶ç»‘å®š
          const submitBtn = document.getElementById("btn-login-submit");
          const resetBtn = document.getElementById("btn-login-reset");
          const uidInput = document.getElementById("login-uid");
          const pwdInput = document.getElementById("login-pwd");

          function handleLoginTrigger() {
            const msg = document.getElementById("login-msg");
            if (msg) msg.textContent = "CONNECTING...";
            setTimeout(() => {
              if (typeof tryLogin === "function") {
                tryLogin();
              } else {
                console.error("tryLogin function missing");
              }
            }, 200);
          }

          submitBtn.onclick = handleLoginTrigger;
          resetBtn.onclick = () => {
            pwdInput.value = "";
            const msg = document.getElementById("login-msg");
            if (msg) msg.textContent = "CLEARED";
            pwdInput.focus();
          };
          pwdInput.onkeypress = function (e) {
            if (e.key === "Enter") handleLoginTrigger();
          };

          const bindVisualEffect = (btn) => {
            const down = () => {
              btn.style.transform = "translateY(6px)";
              btn.style.boxShadow = "none";
            };
            const up = () => {
              btn.style.transform = "translateY(0)";
              btn.style.boxShadow =
                "0 6px 0 rgba(0,0,0,0.15), 0 10px 10px rgba(0,0,0,0.1)";
            };
            btn.addEventListener("mousedown", down);
            btn.addEventListener("mouseup", up);
            btn.addEventListener("mouseleave", up);
            btn.addEventListener("touchstart", down, { passive: true });
            btn.addEventListener("touchend", up);
          };
          bindVisualEffect(submitBtn);
          bindVisualEffect(resetBtn);
        }

        // 2. éªŒè¯ä¸å¯åŠ¨å‡½æ•°
        async function tryLogin() {
          // è·å–å…ƒç´ 
          const uidEl = document.getElementById("login-uid");
          const pwdEl = document.getElementById("login-pwd");
          const msgEl = document.getElementById("login-msg");
          const submitBtn = document.getElementById("btn-login-submit");

          // å®‰å…¨æ£€æŸ¥
          if (!uidEl || !pwdEl) {
            console.error("æ‰¾ä¸åˆ°ç™»å½•è¾“å…¥æ¡†ï¼Œè¯·åˆ·æ–°é¡µé¢");
            return;
          }

          const uid = uidEl.value.trim();
          const pwd = pwdEl.value.trim();

          if (!uid || !pwd) {
            msgEl.textContent = "è¯·è¾“å…¥å®Œæ•´çš„è´¦å·å’Œå¯†ç ";
            if (msgEl) msgEl.style.color = "#ff453a"; // çº¢è‰²è­¦å‘Š
            return;
          }

          // 1. è®¾ç½®åŠ è½½çŠ¶æ€
          msgEl.style.color = "#fab1a0"; // æ¢å¤é»˜è®¤é¢œè‰²
          msgEl.textContent = "VERIFYING...";
          if (submitBtn) submitBtn.disabled = true; // é˜²æ­¢é‡å¤ç‚¹å‡»

          try {
            // 2. å‘èµ·ç½‘ç»œè¯·æ±‚ (ä½ çš„æ–°é€»è¾‘)
            const res = await fetch(
              "https://puppy-subscription-api.zeabur.app/api/verify",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ account: uid, password: pwd }),
              },
            );

            // å¤„ç†ç½‘ç»œå±‚é¢çš„é”™è¯¯ (å¦‚404, 500)
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }

            const data = await res.json();

            // 3. å¤„ç†éªŒè¯ç»“æœ
            if (data.success) {
              // --- éªŒè¯æˆåŠŸ ---
              msgEl.style.color = "#32d74b"; // ç»¿è‰²æˆåŠŸ
              msgEl.textContent = "éªŒè¯é€šè¿‡ï¼Œæ­£åœ¨è¿›å…¥...";

              // ä¿å­˜ç™»å½•çŠ¶æ€
              localStorage.setItem("ephone_saved_uid", uid);
              // åŒæ—¶ä¿å­˜ä½ çš„æ–°éªŒè¯æ ‡è®°
              localStorage.setItem("ephone_auth", "true");

              // åˆå§‹åŒ–æ•°æ®åº“ (ä½¿ç”¨ uid ä½œä¸ºæ•°æ®åº“æ ‡è¯†)
              initDatabase(uid);

              // ç§»é™¤é®ç½©åŠ¨ç”»
              const overlay = document.getElementById("login-overlay");
              if (overlay) {
                overlay.style.transition = "opacity 0.5s ease";
                overlay.style.opacity = "0";
                setTimeout(() => overlay.remove(), 500);
              }

              // å¯åŠ¨ App
              init();
            } else {
              // --- éªŒè¯å¤±è´¥ (ä¸šåŠ¡é€»è¾‘æ‹’ç»ï¼Œå¦‚å¯†ç é”™è¯¯) ---
              throw new Error(data.message || "è´¦å·æˆ–å¯†ç é”™è¯¯");
            }
          } catch (error) {
            // --- é”™è¯¯å¤„ç† ---
            console.error("ç™»å½•å‡ºé”™:", error);
            msgEl.style.color = "#ff453a"; // çº¢è‰²è­¦å‘Š
            // æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æ˜¾ç¤º"ç½‘ç»œè¿æ¥å¤±è´¥"
            msgEl.textContent = error.message.includes("fetch")
              ? "ç½‘ç»œè¿æ¥å¤±è´¥"
              : error.message || "éªŒè¯å¤±è´¥";

            // æŒ‰é’®è§†è§‰åé¦ˆ (å˜çº¢ä¸€ä¸‹)
            if (submitBtn) {
              const originalBg = submitBtn.style.background;
              submitBtn.style.background = "#ff453a";
              setTimeout(
                () => (submitBtn.style.background = originalBg || ""),
                500,
              );
              submitBtn.disabled = false; // æ¢å¤æŒ‰é’®å¯ç”¨
            }
          }
        }

        // ==========================================
        // â–¼â–¼â–¼ è‡ªåŠ¨ç™»å½•åˆ¤æ–­ (ä¸»å…¥å£) â–¼â–¼â–¼
        // ==========================================

        // æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²ç™»å½•
        const savedUid = localStorage.getItem("ephone_saved_uid");

        if (savedUid) {
          console.log(`[Auto Login] æ£€æµ‹åˆ°å·²ç™»å½•è´¦å·: ${savedUid}`);
          try {
            // å·²ç™»å½•ï¼šç›´æ¥åˆå§‹åŒ–æ•°æ®åº“å¹¶å¯åŠ¨ï¼Œä¸æ˜¾ç¤ºç™»å½•æ¡†
            initDatabase(savedUid);
            init();
          } catch (e) {
            console.error("è‡ªåŠ¨ç™»å½•å‡ºé”™ï¼Œé‡ç½®çŠ¶æ€:", e);
            localStorage.removeItem("ephone_saved_uid");
            renderLoginOverlay();
          }
        } else {
          // æœªç™»å½•ï¼šæ˜¾ç¤ºç™»å½•æ¡†
          renderLoginOverlay();
        }

        // ==========================================
        // â–¼â–¼â–¼ é€€å‡ºç™»å½•æŒ‰é’®äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        // ==========================================
        // æ”¾åœ¨ä¸€ä¸ªå®šæ—¶å™¨é‡Œï¼Œç¡®ä¿ logout-btn å·²ç»åŠ è½½å‡ºæ¥
        setTimeout(() => {
          const logoutBtn = document.getElementById("logout-btn");
          if (logoutBtn) {
            // ç§»é™¤æ—§çš„ç›‘å¬å™¨é˜²æ­¢é‡å¤
            const newBtn = logoutBtn.cloneNode(true);
            logoutBtn.parentNode.replaceChild(newBtn, logoutBtn);

            newBtn.addEventListener("click", async () => {
              // ä½¿ç”¨åŸç”Ÿçš„ confirmï¼Œé˜²æ­¢ showCustomConfirm æ²¡åŠ è½½
              if (confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) {
                localStorage.removeItem("ephone_saved_uid");
                window.location.reload();
              }
            });
          }
        }, 1000);

        /*
         * ===================================================================
         * === å…¨å±€æ¥å£ (Public API for other scripts) ===
         * ===================================================================
         * å°†ä¸»åº”ç”¨çš„æ ¸å¿ƒåŠŸèƒ½æš´éœ²ç»™å…¶ä»–è„šæœ¬æ–‡ä»¶ï¼ˆå¦‚ game-hall.jsï¼‰ä½¿ç”¨
         */
        window.openChat = openChat;
        window.openChat = openChat;
        // ã€æ–°å¢ã€‘æŠŠè·³è½¬å‡½æ•°æš´éœ²ç»™å…¨å±€ï¼Œä»¥ä¾¿åœ¨å¼¹çª—ä¸­ç‚¹å‡»è°ƒç”¨
        window.jumpToMessage = async function (timestamp) {
          // 1. å…³é—­æ‰€æœ‰å¯èƒ½æŒ¡ä½è§†çº¿çš„æ¨¡æ€æ¡†
          document
            .querySelectorAll(".modal")
            .forEach((el) => el.classList.remove("visible"));
          document
            .getElementById("custom-modal-overlay")
            .classList.remove("visible");
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          // åˆ‡æ¢å›èŠå¤©ç•Œé¢
          showScreen("chat-interface-screen");

          // ç®€å•çš„æ»šåŠ¨å®ç°
          setTimeout(() => {
            const bubble = document.querySelector(
              `.message-bubble[data-timestamp="${timestamp}"]`,
            );
            if (bubble) {
              bubble.scrollIntoView({ behavior: "auto", block: "center" });
              bubble.classList.add("flash"); // é—ªçƒç‰¹æ•ˆ
              setTimeout(() => bubble.classList.remove("flash"), 1500);
            } else {
              alert(
                "è¯¥æ¶ˆæ¯ä¸åœ¨å½“å‰æ˜¾ç¤ºèŒƒå›´å†…ï¼ˆå¯èƒ½å¤ªä¹…è¿œï¼‰ï¼Œè¯·å…ˆç‚¹å‡»'åŠ è½½æ›´å¤š'ã€‚",
              );
            }
          }, 300);
        };

        window.triggerAiResponse = triggerAiResponse;
        window.openLoversSpaceFromCard = openLoversSpaceFromCard;
      });

      (function () {
        "use strict";

        // ä¸‹è½½å›¾ç‰‡çš„æ ¸å¿ƒå‡½æ•°
        function downloadImage(imageSrc, filename) {
          try {
            // åˆ›å»ºä¸€ä¸ªéšè—çš„ä¸‹è½½é“¾æ¥
            const link = document.createElement("a");
            link.href = imageSrc;
            link.download = filename;
            link.style.display = "none";

            document.body.appendChild(link);
            link.click(); // è§¦å‘ä¸‹è½½

            // çŸ­æš‚å»¶è¿Ÿåç§»é™¤é“¾æ¥
            setTimeout(() => {
              document.body.removeChild(link);
            }, 100);

            console.log("âœ… [NAIä¸‹è½½] å¼€å§‹ä¸‹è½½å›¾ç‰‡:", filename);

            // æ˜¾ç¤ºä¸‹è½½æç¤º
            showDownloadToast();
          } catch (error) {
            console.error("âŒ [NAIä¸‹è½½] ä¸‹è½½å¤±è´¥:", error);
            showDownloadToast("ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•", "error");
          }
        }

        // æ˜¾ç¤ºä¸‹è½½æç¤ºï¼ˆä¸´æ—¶Toastï¼‰
        function showDownloadToast(
          message = "ğŸ“¥ å›¾ç‰‡ä¸‹è½½ä¸­...",
          type = "success",
        ) {
          const toast = document.createElement("div");
          toast.textContent = message;
          toast.style.cssText = `
			            position: fixed;
			            bottom: 20px;
			            right: 20px;
			            background: ${type === "success" ? "#4CAF50" : "#f44336"};
			            color: white;
			            padding: 12px 24px;
			            border-radius: 8px;
			            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
			            z-index: 10000;
			            font-size: 14px;
			            pointer-events: none;
			            opacity: 0;
			            transform: translateY(20px);
			            transition: all 0.3s ease;
			        `;

          document.body.appendChild(toast);

          // åŠ¨ç”»è¿›å…¥
          setTimeout(() => {
            toast.style.opacity = "1";
            toast.style.transform = "translateY(0)";
          }, 10);

          // 2ç§’åæ·¡å‡ºå¹¶ç§»é™¤
          setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transform = "translateY(-20px)";
            setTimeout(() => {
              toast.remove();
            }, 300);
          }, 2000);
        }

        // ç”Ÿæˆæ™ºèƒ½æ–‡ä»¶å
        function generateFilename(imgElement) {
          // å°è¯•ä»titleå±æ€§è·å–promptï¼ˆç”¨äºæ–‡ä»¶åï¼‰
          const title =
            imgElement.getAttribute("title") ||
            imgElement.getAttribute("alt") ||
            "";

          // æ¸…ç†titleï¼Œæå–å‰30ä¸ªæœ‰æ•ˆå­—ç¬¦
          let cleanTitle = title
            .replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g, "_") // ä¿ç•™ä¸­è‹±æ–‡å­—æ¯æ•°å­—å’Œç©ºæ ¼
            .replace(/\s+/g, "_") // ç©ºæ ¼è½¬ä¸‹åˆ’çº¿
            .substring(0, 30);

          if (!cleanTitle) {
            cleanTitle = "NAI_Image";
          }

          // æ·»åŠ æ—¶é—´æˆ³ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰
          const timestamp = new Date()
            .toISOString()
            .replace(/[-:]/g, "")
            .replace("T", "_")
            .split(".")[0]; // æ ¼å¼ï¼š20250124_123045

          // ç”Ÿæˆæ–‡ä»¶å
          return `${cleanTitle}_${timestamp}.png`;
        }

        // ä¸ºå›¾ç‰‡æ·»åŠ åŒå‡»æ—¶çš„è§†è§‰åé¦ˆ
        function addVisualFeedback(imgElement) {
          const originalTransform = imgElement.style.transform || "";
          const originalTransition = imgElement.style.transition || "";

          // æ·»åŠ ç¼©æ”¾åŠ¨ç”»
          imgElement.style.transition = "transform 0.15s ease";
          imgElement.style.transform = "scale(0.95)";

          setTimeout(() => {
            imgElement.style.transform = originalTransform;
            setTimeout(() => {
              imgElement.style.transition = originalTransition;
            }, 150);
          }, 150);
        }

        // ä¸‰å‡»æ£€æµ‹ç›¸å…³å˜é‡
        let clickCount = 0;
        let clickTimer = null;
        let lastClickedElement = null;

        // å…¨å±€äº‹ä»¶ç›‘å¬å™¨ï¼ˆäº‹ä»¶å§”æ‰˜ - ä¸‰å‡»è§¦å‘ï¼‰
        document.addEventListener(
          "click",
          function (e) {
            const target = e.target;

            // æ£€æŸ¥æ˜¯å¦æ˜¯NAIå›¾ç‰‡ï¼ˆrealimag-image æˆ– naiimag-imageï¼‰
            if (
              target.tagName === "IMG" &&
              (target.classList.contains("realimag-image") ||
                target.classList.contains("naiimag-image"))
            ) {
              // å¦‚æœç‚¹å‡»çš„æ˜¯åŒä¸€ä¸ªå…ƒç´ ï¼Œå¢åŠ è®¡æ•°
              if (target === lastClickedElement) {
                clickCount++;
              } else {
                // ç‚¹å‡»äº†ä¸åŒçš„å…ƒç´ ï¼Œé‡ç½®è®¡æ•°
                clickCount = 1;
                lastClickedElement = target;
              }

              // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
              if (clickTimer) {
                clearTimeout(clickTimer);
              }

              // å¦‚æœè¾¾åˆ°ä¸‰å‡»
              if (clickCount === 3) {
                // é‡ç½®è®¡æ•°
                clickCount = 0;
                lastClickedElement = null;

                // é˜»æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶å†’æ³¡
                e.preventDefault();
                e.stopPropagation();

                console.log("ğŸ–¼ï¸ [NAIä¸‹è½½] æ£€æµ‹åˆ°ä¸‰å‡»NAIå›¾ç‰‡");

                // æ·»åŠ è§†è§‰åé¦ˆ
                addVisualFeedback(target);

                // è·å–å›¾ç‰‡æºï¼ˆå¯èƒ½æ˜¯base64æˆ–URLï¼‰
                const imageSrc = target.src;

                if (!imageSrc || imageSrc === "about:blank") {
                  console.warn("âš ï¸ [NAIä¸‹è½½] å›¾ç‰‡æºä¸ºç©ºï¼Œæ— æ³•ä¸‹è½½");
                  showDownloadToast("å›¾ç‰‡åŠ è½½ä¸­ï¼Œè¯·ç¨åé‡è¯•", "error");
                  return;
                }

                // ç”Ÿæˆæ–‡ä»¶å
                const filename = generateFilename(target);

                // è§¦å‘ä¸‹è½½
                downloadImage(imageSrc, filename);
              } else {
                // è®¾ç½®å®šæ—¶å™¨ï¼Œ500msåé‡ç½®è®¡æ•°ï¼ˆå¦‚æœç”¨æˆ·åœæ­¢ç‚¹å‡»ï¼‰
                clickTimer = setTimeout(() => {
                  clickCount = 0;
                  lastClickedElement = null;
                }, 500);
              }
            }
          },
          true,
        ); // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿ä¼˜å…ˆå¤„ç†

        console.log("âœ… [NAIä¸‹è½½] ä¸‰å‡»ä¸‹è½½åŠŸèƒ½å·²åˆå§‹åŒ–");
        console.log("ğŸ’¡ [NAIä¸‹è½½] æç¤ºï¼šä¸‰å‡»ä»»æ„NAIå›¾ç‰‡å³å¯ä¸‹è½½");
      })();
    </script>

    <input
      type="file"
      id="character-card-input"
      accept=".png, .json"
      style="display: none"
    />

    <input
      type="file"
      id="world-book-import-input"
      accept=".json, .jsonl"
      style="display: none"
    />
    <input type="file" id="ludo-qbank-import-input" accept=".json" hidden />
    <input type="file" id="inner-voice-bg-input" accept="image/*" hidden />
    <input type="file" id="script-kill-import-input" accept=".json" hidden />
    </div>
  </body>
</html>
