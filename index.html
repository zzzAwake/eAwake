<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-title" content="EPhone" />
    <meta name="theme-color" content="#000000" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link
      rel="apple-touch-icon"
      href="https://i.postimg.cc/CMZqNMRh/IMG-6497.jpg"
    />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <link rel="manifest" href="./manifest.json" />
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("./sw.js")
          .then(() => console.log("SW Registered"))
          .catch((e) => console.error("SW Error:", e));
      }
    </script>

    <title>EPhone</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
      @font-face {
        font-family: "bulangni";
        src: url("") format("truetype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }
      :root {
        --screen-width: 350px;
        --screen-height: 650px;
        --secondary-bg: #ffffff;
        --border-color: #e0e0e0;
        --text-primary: #1f1f1f;
        --text-secondary: #8a8a8a;
        --accent-color: #007bff;
      }
      html {
        height: 100%;
        overflow: hidden;
      }
      body {
        height: 100%;
        overflow: hidden;
        margin: 0;
        padding: 20px;
        font-family:
          "bulangni",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          Helvetica,
          Arial,
          sans-serif;
        font-weight: normal;
        background-color: #dcdcdc;
        display: flex;
        justify-content: center;
        align-items: center;
        box-sizing: border-box;
        transition: background-color 0.3s ease;
      }
      body.dark-mode {
        background-color: #121212;
      }
      #phone-frame {
        padding: 12px;
        background-color: #fff;
        border-radius: 50px;
        box-shadow:
          0 20px 50px rgba(0, 0, 0, 0.25),
          inset 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        transition: background-color 0.3s ease;
      }
      body.dark-mode #phone-frame {
        background-color: #2a2a2a;
        box-shadow:
          0 0 25px rgba(220, 235, 255, 0.18),
          0 0 100px rgba(220, 235, 255, 0.1),
          0 0 0 1px rgba(255, 255, 255, 0.1),
          0 40px 80px rgba(0, 0, 0, 0.95),
          inset 0 1px 2px rgba(255, 255, 255, 0.2);
      }
      .notch {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        width: 130px;
        height: 28px;
        background-color: #1f1f1f;
        border-radius: 0 0 15px 15px;
        z-index: 20;
      }
      #phone-screen {
        width: var(--screen-width);
        height: var(--screen-height);
        background-color: #000;
        border-radius: 40px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 2px solid #333;
      }
      #status-bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
        z-index: 10;
        font-size: 14px;
        box-sizing: border-box;
        pointer-events: none;
      }
      #status-bar-time {
        font-weight: 600;
      }
      .battery-container {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .battery-icon {
        width: 25px;
        height: 12px;
        border: 1px solid white;
        border-radius: 3px;
        position: relative;
        padding: 1px;
      }
      .battery-icon::after {
        content: "";
        position: absolute;
        right: -3px;
        top: 2px;
        width: 2px;
        height: 6px;
        background-color: white;
        border-radius: 0 1px 1px 0;
      }
      .battery-level {
        height: 100%;
        background-color: white;
        border-radius: 1px;
        transition: width 0.5s ease;
      }
      .battery-container.charging .battery-level {
        background-color: #4cd964;
        animation: charge-breath 2s infinite;
      }
      .battery-container.charging .battery-text {
        color: #4cd964;
      }
      @keyframes charge-breath {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
      .screen {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.3s,
          visibility 0.3s;
      }
      .screen.active {
        opacity: 1;
        visibility: visible;
        z-index: 1;
      }
      .header {
        position: relative;
        z-index: 15;
        flex-shrink: 0;
        padding: 15px 20px;
        padding-top: 45px;
        background-color: rgba(247, 247, 247, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 18px;
        font-weight: 600;
      }
      .header .header-actions {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .header .back-btn,
      .header .action-btn {
        font-size: 24px;
        cursor: pointer;
        width: 30px;
        text-align: center;
        color: var(--accent-color);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .header .action-btn {
        width: auto;
        min-width: 30px;
        white-space: nowrap;
        font-size: 16px;
        font-weight: 600;
      }
      .header .action-btn img {
        height: 26px;
      }
      .header .save-btn {
        font-size: 16px;
        color: var(--accent-color);
        font-weight: 600;
        cursor: pointer;
      }
      #home-screen {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 20px;
        padding-top: 80px;
        padding-bottom: 50px;
        box-sizing: border-box;
        background-size: cover;
        background-position: center;
      }
      #clock-container {
        text-align: center;
        color: white;
        text-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
        margin-bottom: 20px;
        flex-shrink: 0;
      }
      #main-time {
        font-size: 80px;
        font-weight: 200;
      }
      #main-date {
        font-size: 18px;
        font-weight: 500;
      }
      #app-grid {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        width: 100%;
        padding: 20px;
      }
      .app-row {
        display: flex;
        justify-content: center;
        gap: 25px;
        width: 100%;
      }
      .app-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        color: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        font-size: 14px;
        font-weight: 500;
        text-align: center;
      }
      .app-icon .icon-bg {
        width: 65px;
        height: 65px;
        border-radius: 18px;
        background-color: var(--secondary-bg);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 32px;
        margin-bottom: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transition: transform 0.2s ease;
        overflow: hidden;
      }
      .app-icon:active .icon-bg {
        transform: scale(0.9);
      }
      .app-icon .icon-bg img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .app-icon .label {
        color: white;
      }
      .form-container,
      .list-container {
        padding: 20px;
        overflow-y: auto;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-secondary);
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
      }
      .form-group textarea {
        min-height: 80px;
        resize: vertical;
      }
      .settings-group {
        background-color: #fff;
        border-radius: 12px;
        margin-bottom: 20px;
        overflow: hidden;
        border: 1px solid var(--border-color);
      }
      body.dark-mode .settings-group {
        background-color: #1c1c1e;
        border-color: #38383a;
      }
      .settings-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
        background-color: transparent;
      }
      body.dark-mode .settings-item {
        border-bottom-color: #38383a;
      }
      .settings-item:last-child {
        border-bottom: none;
      }
      .settings-item .label {
        font-size: 16px;
        color: var(--text-primary);
        flex-grow: 1;
      }
      body.dark-mode .settings-item .label {
        color: #fff;
      }
      /* Toggle Switch */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 51px;
        height: 31px;
        flex-shrink: 0;
        margin-top: 10px;
        margin-right: 10px;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #e9e9eb;
        transition: 0.3s;
        border-radius: 31px;
      }
      body.dark-mode .toggle-slider {
        background-color: #39393d;
      }
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 27px;
        width: 27px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
      }
      .toggle-switch input:checked + .toggle-slider {
        background-color: #34c759;
      }
      .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(20px);
      }
      .moe-input {
        background-color: #f2f2f7;
        border: none;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 15px;
        color: var(--text-primary);
        width: 100%;
        box-sizing: border-box;
      }
      body.dark-mode .moe-input {
        background-color: #2c2c2e;
        color: #fff;
      }
      #world-book-content-input {
        height: calc(100% - 120px);
      }
      .form-button {
        width: 100%;
        padding: 15px;
        background-color: var(--accent-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 10px;
      }
      .form-button-secondary {
        background-color: #f0f0f0;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      #wallpaper-upload-input {
        display: none;
      }
      #world-book-list {
        flex-grow: 1;
        overflow-y: auto;
        background-color: var(--secondary-bg);
        padding-top: 80px;
        margin-top: -80px;
      }
      #chat-list {
        flex-grow: 1;
        background-color: var(--secondary-bg);
        padding-top: 80px;
        padding-bottom: 50px;
        box-sizing: border-box;
      }
      .list-item {
        display: flex;
        flex-direction: column;
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
      }
      .list-item:hover {
        background-color: #f5f5f5;
      }
      .list-item .item-title {
        font-weight: 500;
        font-size: 16px;
        margin-bottom: 5px;
      }
      .list-item .item-content {
        font-size: 14px;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .chat-list-item {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        position: relative;
      }
      .chat-list-item:hover {
        background-color: #f5f5f5;
      }
      .chat-list-item .avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        margin-right: 12px;
        object-fit: cover;
        background-color: #ccc;
      }
      .chat-list-item .info {
        flex-grow: 1;
        overflow: hidden;
      }
      .chat-list-item .name-line {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 2px;
      }
      .chat-list-item .name {
        font-weight: 500;
        color: var(--text-primary);
      }
      .chat-list-item .group-tag {
        font-size: 10px;
        color: var(--accent-color);
        background-color: #e7f3ff;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        flex-shrink: 0;
      }
      .chat-list-item .last-msg {
        font-size: 13px;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
      }
      #chat-interface-screen {
        background-size: cover;
        background-position: center;
        position: relative;
      }
      #selection-cancel-btn,
      #selection-delete-btn {
        font-size: 16px;
        color: var(--accent-color);
        cursor: pointer;
        padding: 5px;
      }
      #selection-delete-btn {
        color: #ff3b30;
      }
      #chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 10px 15px;
        padding-top: 110px;
        margin-top: -80px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        box-sizing: border-box;
      }
      #load-more-btn {
        text-align: center;
        padding: 10px;
        color: var(--accent-color);
        font-size: 14px;
        cursor: pointer;
        background-color: transparent;
        border: none;
        width: 100%;
      }
      #load-more-btn:hover {
        text-decoration: underline;
      }
      .sender-name {
        font-size: 11px;
        color: #666;
        margin-bottom: 3px;
      }
      .message-wrapper.ai .sender-name {
        margin-left: 50px;
        margin-bottom: 3px;
        position: absolute;
        top: -16px;
        left: 0;
      }
      .message-wrapper {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        position: relative;
        max-width: 90%;
      }
      .message-wrapper.ai {
        align-self: flex-start;
        flex-direction: row;
      }
      .message-wrapper.user {
        align-self: flex-end;
        flex-direction: row-reverse;
      }
      .message-bubble {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        max-width: 100%;
      }
      .timestamp {
        font-size: 11px;
        color: #999;
        text-shadow: 0 0 3px rgba(255, 255, 255, 0.6);
        white-space: nowrap;
        margin-bottom: 5px;
        flex-shrink: 0;
      }
      .message-bubble.selected::after {
        content: "‚úî";
        position: absolute;
        left: -10px;
        top: 50%;
        transform: translateY(-50%);
        background-color: var(--accent-color);
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }
      .message-bubble.user.selected::after {
        left: auto;
        right: -10px;
      }
      .message-bubble.user {
        flex-direction: row-reverse;
      }
      #chat-input-area {
        flex-shrink: 0;
        padding: 8px;
        background-color: rgba(247, 247, 247, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-top: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      #chat-input-main-row {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        width: 100%;
      }
      #chat-input {
        flex-grow: 1;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        background-color: var(--secondary-bg);
        font-size: 16px;
        max-height: 100px;
        resize: none;
      }
      .action-button {
        border: none;
        color: white;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
      }
      #send-btn {
        background-color: var(--accent-color);
        height: 40px;
        padding: 0 15px;
      }
      .modal {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 100;
      }
      .modal.visible {
        display: flex;
      }
      .modal-content {
        width: 90%;
        max-height: 90%;
        background-color: white;
        border-radius: 15px;
        display: flex;
        flex-direction: column;
      }
      .modal-header {
        padding: 15px;
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
        text-align: center;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-body {
        padding: 15px;
        overflow-y: auto;
      }
      .modal-footer {
        padding: 15px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-around;
      }
      .modal-footer button {
        width: 45%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--accent-color);
        cursor: pointer;
        font-size: 16px;
      }
      .modal-footer .save {
        background-color: var(--accent-color);
        color: white;
      }
      .modal-footer .cancel {
        background-color: white;
        color: var(--accent-color);
      }
      .avatar-upload {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .avatar-upload img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        background-color: #eee;
      }
      .avatar-upload button {
        padding: 8px 12px;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        border-radius: 5px;
        cursor: pointer;
      }
      #open-persona-library-btn {
        font-size: 14px;
        padding: 6px 10px;
        margin-left: 0;
      }
      .avatar-upload input[type="file"] {
        display: none;
      }
      .theme-selector label {
        display: inline-flex;
        align-items: center;
        margin-right: 15px;
        margin-bottom: 5px;
        cursor: pointer;
      }
      #reset-theme-btn {
        background: none;
        border: 1px solid #ccc;
        color: #555;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
      }
      #group-members-settings {
        display: flex;
        overflow-x: auto;
        padding-bottom: 10px;
        gap: 15px;
      }
      .member-editor {
        text-align: center;
        cursor: pointer;
      }
      .member-editor img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        background-color: #eee;
        margin-bottom: 5px;
      }
      .member-editor .member-name {
        font-size: 12px;
      }
      #notification-bar {
        position: absolute;
        top: 40px;
        left: 50%;
        width: 90%;
        z-index: 500;
        background-color: rgba(250, 250, 250, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transform: translateX(-50%) translateY(-150%);
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        visibility: hidden;
      }
      #notification-bar.visible {
        transform: translateX(-50%) translateY(0);
        visibility: visible;
      }
      #notification-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        object-fit: cover;
      }
      #notification-content .name {
        font-weight: 600;
        font-size: 15px;
        color: #000;
      }
      #notification-content .message {
        font-size: 14px;
        color: #555;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
      }
      .sticker-image {
        max-width: 100px;
        max-height: 100px;
        display: block;
        object-fit: contain;
      }
      .message-bubble.is-sticker .content,
      .message-bubble.is-link-share .content,
      .message-bubble.is-voice-message .content {
        padding: 0;
        background-color: transparent;
        box-shadow: none;
        border: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
      .chat-action-icon-btn {
        font-size: 24px;
        padding: 0;
        width: 38px;
        height: 38px;
        line-height: 38px;
        text-align: center;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.5);
        color: var(--text-primary);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid rgba(0, 0, 0, 0.05);
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #sticker-panel {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 50%;
        background-color: rgba(242, 242, 247, 0.85);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-top: 1px solid var(--border-color);
        border-radius: 20px 20px 0 0;
        z-index: 200;
        display: flex;
        flex-direction: column;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        visibility: hidden;
      }
      #sticker-panel.visible {
        transform: translateY(0);
        visibility: visible;
      }
      #sticker-panel-header {
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        border-bottom: 1px solid var(--border-color);
      }
      #sticker-panel-header .title {
        font-weight: 600;
      }
      #sticker-panel-header .panel-btn {
        font-size: 16px;
        padding: 5px 10px;
        cursor: pointer;
        color: var(--accent-color);
      }
      #sticker-grid {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 15px;
      }
      .sticker-item {
        position: relative;
        aspect-ratio: 1 / 1;
        background-color: white;
        border-radius: 10px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .sticker-item .delete-btn {
        display: none;
        position: absolute;
        top: -5px;
        right: -5px;
        width: 20px;
        height: 20px;
        background-color: #ff3b30;
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 20px;
        font-size: 14px;
        cursor: pointer;
        border: 2px solid white;
      }
      #input-actions-wrapper {
        position: static;
        display: flex;
        align-items: flex-end;
        gap: 8px;
        flex-shrink: 0;
      }
      #wait-reply-btn {
        position: static;
        bottom: auto;
        right: auto;
        width: auto;
        height: 40px;
        padding: 0 10px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition:
          opacity 0.2s,
          transform 0.1s;
        cursor: pointer;
      }
      #wait-reply-btn:hover {
        opacity: 0.8;
      }
      #wait-reply-btn:active {
        transform: scale(0.9);
      }
      #wait-reply-btn img {
        height: 22px;
        display: block;
        margin: auto;
      }
      .chat-image {
        max-width: 100%;
        border-radius: 10px;
        display: block;
      }
      .message-bubble.has-image .content {
        padding: 5px;
      }
      #custom-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
      }
      #custom-modal-overlay.visible {
        display: flex;
        opacity: 1;
      }
      #custom-modal {
        background-color: #fff;
        width: 280px;
        border-radius: 14px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        transform: scale(0.95);
        transition: transform 0.2s ease-in-out;
      }
      #custom-modal-overlay.visible #custom-modal {
        transform: scale(1);
      }
      .custom-modal-header {
        padding: 16px;
        font-size: 17px;
        font-weight: 600;
        text-align: center;
      }
      .custom-modal-body {
        padding: 5px 5px 5px;
        text-align: center;
        font-size: 14px;
        color: #333;
        line-height: 1.5;
      }
      .custom-modal-body p {
        margin: 0;
        margin-bottom: 12px;
      }
      .custom-modal-body input {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 14px;
        box-sizing: border-box;
      }
      .custom-modal-footer {
        border-top: 1px solid #dbdbdb;
        display: flex;
      }
      .custom-modal-footer button {
        flex: 1;
        background: none;
        border: none;
        padding: 12px;
        font-size: 17px;
        cursor: pointer;
        color: var(--accent-color);
      }
      .custom-modal-footer button:first-child {
        border-right: 1px solid #dbdbdb;
      }
      .custom-modal-footer .confirm-btn {
        font-weight: 600;
      }
      .custom-modal-footer .confirm-btn.btn-danger {
        color: #ff3b30;
      }
      #preset-actions-modal .custom-modal-footer {
        flex-direction: column;
      }
      #preset-actions-modal .custom-modal-footer button {
        width: 100%;
        border: none;
        border-bottom: 1px solid #dbdbdb;
        padding: 14px;
        font-size: 18px;
      }
      #preset-actions-modal .custom-modal-footer button:last-child {
        border-bottom: none;
      }
      #message-actions-modal .custom-modal-footer {
        flex-direction: column;
      }
      #message-actions-modal .custom-modal-footer button {
        width: 100%;
        border: none;
        border-bottom: 1px solid #dbdbdb;
        padding: 14px;
        font-size: 18px;
      }
      #message-actions-modal .custom-modal-footer button:last-child {
        border-bottom: none;
      }
      .custom-multiselect {
        position: relative;
        user-select: none;
      }
      .select-box {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
        background-color: #fff;
        cursor: pointer;
      }
      .select-box .selected-options-text {
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-primary);
      }
      .select-box .arrow-down {
        margin-left: auto;
        font-size: 10px;
        color: var(--text-secondary);
        transition: transform 0.2s;
      }
      .select-box.expanded .arrow-down {
        transform: rotate(180deg);
      }
      .checkboxes-container {
        display: none;
        position: absolute;
        top: 100%;
        margin-top: 5px;
        left: 0;
        right: 0;
        max-height: 150px;
        overflow-y: auto;
        overflow-x: hidden;
        background-color: #fff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        z-index: 101;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .checkboxes-container.visible {
        display: block;
      }
      .checkboxes-container label {
        display: block;
        padding: 12px 15px;
        cursor: pointer;
        font-weight: normal;
        color: var(--text-primary);
        font-size: 15px;
      }
      .checkboxes-container input {
        margin-right: 10px;
        vertical-align: middle;
      }
      .bg-upload-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 8px;
        flex-wrap: wrap;
      }
      .bg-preview-img {
        max-width: 120px;
        max-height: 80px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        object-fit: cover;
        display: none;
      }
      #remove-bg-btn {
        padding: 8px 12px;
        border: 1px solid #ff3b30;
        color: #ff3b30;
        background-color: #fff;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        display: none;
      }
      .message-bubble.is-ai-image .content {
        padding: 5px;
        background: transparent;
        box-shadow: none;
        border: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
      .ai-generated-image {
        max-width: 180px;
        border-radius: 12px;
        display: block;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }
      .ai-generated-image:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      .voice-message-body::after {
        content: "";
        position: absolute;
        top: 12px;
        width: 0;
        height: 0;
        border-style: solid;
      }
      .message-bubble.user .voice-message-body::after {
        right: -6px;
        border-width: 6px 0 6px 8px;
        border-color: transparent transparent transparent #2ba245;
      }
      .message-bubble.ai .voice-message-body::after {
        left: -6px;
        border-width: 6px 8px 6px 0;
        border-color: transparent #ffffff transparent transparent;
      }
      #phone-screen.dark-mode .message-bubble.ai .voice-message-body::after {
        border-color: transparent #2c2c2e transparent transparent;
      }
      .voice-message-body {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        cursor: pointer;
        min-width: 60px;
        height: 22px;
        border-radius: 4px;
        position: relative;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        gap: 6px;
        box-sizing: content-box;
      }
      .message-bubble.user .voice-message-body {
        background-color: #2ba245;
        color: #1a3d00;
        margin-left: auto;
        flex-direction: row-reverse;
        padding: 10px 14px 10px 10px;
      }
      .message-bubble.ai .voice-message-body {
        background-color: #ffffff;
        color: var(--text-primary);
        flex-direction: row;
        padding: 10px 10px 10px 14px;
      }
      #phone-screen.dark-mode .message-bubble.ai .voice-message-body {
        background-color: #2c2c2e;
        color: #fff;
      }
      .voice-waveform {
        display: flex;
        align-items: center;
        height: 20px;
        gap: 2px;
        flex-grow: 0;
      }
      .voice-waveform div {
        width: 3px;
        background-color: currentColor;
        border-radius: 2px;
        animation: wave-quiet 1.2s ease-in-out infinite;
      }
      @keyframes wave-quiet {
        0%,
        100% {
          height: 3px;
          opacity: 0.6;
        }
        50% {
          height: 14px;
          opacity: 1;
        }
      }
      .voice-waveform div:nth-child(1) {
        animation-delay: 0s;
      }
      .voice-waveform div:nth-child(2) {
        animation-delay: 0.15s;
      }
      .voice-waveform div:nth-child(3) {
        animation-delay: 0.3s;
      }
      .voice-waveform div:nth-child(4) {
        animation-delay: 0.45s;
      }
      .voice-waveform div:nth-child(5) {
        animation-delay: 0.6s;
      }
      .voice-duration {
        font-size: 14px;
        font-weight: 500;
        color: inherit;
        margin: 0;
      }
      .message-bubble.user .voice-duration {
        color: #3e6224;
      }
      .message-bubble .content {
        position: relative;
        font-size: var(--chat-font-size, 16px);
        padding: 8px 12px;
        line-height: 1.5;
        word-break: normal;
        overflow-wrap: break-word;
        text-wrap: pretty;
        text-align: justify;
        width: fit-content;
        min-width: 0;
      }
      .message-bubble.user .content {
        background-color: rgba(255, 255, 255, 0.75);
        color: #585858;
        border-radius: 8px 2px 8px 8px;
      }
      .message-bubble.ai .content {
        background-color: rgba(255, 255, 255, 0.7);
        color: #585858;
        border-radius: 2px 8px 8px 8px;
      }
      .message-bubble::after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        background-size: contain;
        background-repeat: no-repeat;
        opacity: 1;
        z-index: 1;
      }
      #chat-messages[data-theme="pink_blue"] .message-bubble.user .content {
        background-color: #fff0f6;
        color: #432531;
      }
      #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content {
        background-color: #eff7ff;
        color: #263a4e;
      }
      #chat-messages[data-theme="blue_white"] .message-bubble.user .content {
        background-color: #eff7ff;
        color: #263a4e;
      }
      #chat-messages[data-theme="blue_white"] .message-bubble.ai .content {
        background-color: #f8f9fa;
        color: #383d41;
      }
      #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content {
        background-color: #faf7ff;
        color: #827693;
      }
      #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content {
        background-color: #fffde4;
        color: #5c4033;
      }
      #chat-messages[data-theme="black_white"] .message-bubble.user .content {
        background-color: #343a40;
        color: #f8f9fa;
      }
      #chat-messages[data-theme="black_white"] .message-bubble.ai .content {
        background-color: #f8f9fa;
        color: #343a40;
      }
      #chat-messages[data-theme="yellow_white"] .message-bubble.user .content {
        background-color: #ffeb3b;
        color: #5d4037;
      }
      #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content {
        background-color: #f8f9fa;
        color: #383d41;
      }
      #chat-messages[data-theme="red_black"] .message-bubble.user .content {
        background-color: #c62828;
        color: #ffffff;
      }
      #chat-messages[data-theme="red_black"] .message-bubble.ai .content {
        background-color: #212121;
        color: #ffffff;
      }
      #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content {
        background-color: #a0d2eb;
        color: #153243;
      }
      #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content {
        background-color: #fef9e7;
        color: #5d4037;
      }
      #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content {
        background-color: #fff0f6;
        color: #432531;
      }
      #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content {
        background-color: #fef9e7;
        color: #5d4037;
      }
      #chat-messages[data-theme="pink_purple"] .message-bubble.user .content {
        background-color: #fff0f6;
        color: #a78396;
      }
      #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content {
        background-color: #faf7ff;
        color: #827693;
      }
      #chat-messages[data-theme="gray_white"] .message-bubble.user .content {
        background-color: #e9ecef;
        color: #495057;
      }
      #chat-messages[data-theme="gray_white"] .message-bubble.ai .content {
        background-color: #f8f9fa;
        color: #383d41;
      }
      #chat-messages[data-theme="blue_green"] .message-bubble.user .content {
        background-color: #d1ecf1;
        color: #0c5460;
      }
      #chat-messages[data-theme="blue_green"] .message-bubble.ai .content {
        background-color: #d4edda;
        color: #155724;
      }
      #chat-messages[data-theme="pink_white"] .message-bubble.user .content {
        background-color: #fff0f6;
        color: #a78396;
      }
      #chat-messages[data-theme="pink_white"] .message-bubble.ai .content {
        background-color: #f8f9fa;
        color: #383d41;
      }
      #chat-messages[data-theme="pink_black"] .message-bubble.user .content {
        background-color: #f8bbd0;
        color: #5b2c6f;
      }
      #chat-messages[data-theme="pink_black"] .message-bubble.ai .content {
        background-color: #343a40;
        color: #f8f9fa;
      }
      #chat-messages[data-theme="pink_green"] .message-bubble.user .content {
        background-color: #f8bbd0;
        color: #5b2c6f;
      }
      #chat-messages[data-theme="pink_green"] .message-bubble.ai .content {
        background-color: #c8e6c9;
        color: #1b5e20;
      }
      #chat-messages[data-theme="green_black"] .message-bubble.user .content {
        background-color: #d4edda;
        color: #155724;
      }
      #chat-messages[data-theme="green_black"] .message-bubble.ai .content {
        background-color: #343a40;
        color: #f8f9fa;
      }
      #transfer-btn {
        font-weight: bold;
      }
      #transfer-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1001;
      }
      #transfer-modal.visible {
        display: flex;
      }
      .transfer-content {
        background-color: #fff0f5;
        border-radius: 20px;
        width: 290px;
        padding: 20px;
        box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3);
        text-align: center;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>');
        background-repeat: no-repeat;
        background-position: top right;
        background-size: 80px;
      }
      .transfer-header {
        font-size: 20px;
        font-weight: bold;
        color: #a35c7b;
        margin-bottom: 20px;
      }
      .transfer-input-group {
        margin-bottom: 15px;
        text-align: left;
      }
      .transfer-input-group label {
        display: block;
        font-size: 14px;
        color: #ff85b3;
        margin-bottom: 5px;
        font-weight: 500;
      }
      .transfer-input-group input {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 2px solid #ffcce0;
        background-color: #fff;
        font-size: 16px;
        box-sizing: border-box;
      }
      .transfer-input-group input:focus {
        border-color: #ff85b3;
        outline: none;
      }
      .transfer-actions {
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }
      .transfer-actions button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .transfer-actions button:active {
        transform: scale(0.95);
      }
      #transfer-cancel-btn {
        background-color: #ffdde9;
        color: #a35c7b;
      }
      #transfer-confirm-btn {
        background-color: #ff85b3;
        color: white;
      }
      .message-bubble.is-transfer .content {
        padding: 0;
        background: transparent;
        box-shadow: none;
        border: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        cursor: pointer;
      }
      .transfer-card {
        width: 200px;
        border-radius: 12px;
        padding: 12px;
        color: white;
        position: relative;
        overflow: hidden;
      }
      .transfer-card::before {
        content: "üêæ";
        position: absolute;
        right: 10px;
        top: 5px;
        font-size: 30px;
        opacity: 0.2;
        transform: rotate(15deg);
      }
      .message-bubble.user .transfer-card {
        background: radial-gradient(circle at top left, #ffc5d5, #ff85b3);
      }
      .message-bubble.ai .transfer-card {
        background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb);
      }
      .transfer-title {
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
      }
      .transfer-amount {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 4px;
      }
      .transfer-note {
        font-size: 13px;
        opacity: 0.9;
        border-top: 1px solid rgba(255, 255, 255, 0.3);
        padding-top: 8px;
        margin-top: 8px;
        word-break: break-all;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      #listen-together-btn img.rotating {
        animation: spin 2s linear infinite;
      }
      #listen-together-btn img.paused {
        animation-play-state: paused;
      }
      #music-time-counter {
        font-size: 12px;
        color: #555;
        margin-bottom: 20px;
      }
      #music-player-song-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 5px;
        text-align: center;
      }
      #music-player-artist {
        font-size: 14px;
        color: #666;
        margin-bottom: 25px;
      }
      .music-controls button {
        background: none;
        border: none;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        color: #333;
        width: 44px;
        height: 44px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: transform 0.2s;
      }
      .music-controls button:active {
        transform: scale(0.9);
      }
      .music-controls .play-pause-btn {
        font-size: 24px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.05);
      }
      .music-bottom-actions {
        display: flex;
        justify-content: space-between;
        width: 100%;
      }
      .music-bottom-actions button {
        flex: 1;
        padding: 12px 0;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
      }
      #music-playlist-panel {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 70%;
        background-color: rgba(242, 242, 247, 0.9);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-top: 1px solid var(--border-color);
        border-radius: 20px 20px 0 0;
        z-index: 210;
        display: flex;
        flex-direction: column;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        visibility: hidden;
      }
      #music-playlist-panel.visible {
        transform: translateY(0);
        visibility: visible;
      }
      .playlist-header {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
      }
      .playlist-header .panel-btn {
        font-size: 16px;
        cursor: pointer;
        color: var(--accent-color);
      }
      .playlist-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px 0;
      }
      .playlist-item {
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .playlist-item.playing {
        background-color: rgba(0, 123, 255, 0.1);
      }
      .playlist-item-info .title {
        font-weight: 500;
        font-size: 15px;
      }
      .playlist-item-info .artist {
        font-size: 12px;
        color: #666;
      }
      .playlist-item .delete-track-btn {
        color: #ff3b30;
        font-size: 20px;
        padding: 5px;
      }
      #persona-library-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        padding: 10px;
      }
      .persona-preset-item {
        aspect-ratio: 1 / 1;
        border-radius: 12px;
        background-size: cover;
        background-position: center;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      .persona-preset-item:hover {
        transform: scale(1.08);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      .modal-header .action-button {
        font-size: 16px;
        color: var(--accent-color);
        font-weight: 600;
        cursor: pointer;
        background: none;
        border: none;
        padding: 5px;
      }
      #battery-alert-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      #battery-alert-modal.visible {
        display: flex;
        opacity: 1;
      }
      .battery-alert-content {
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        width: 280px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        text-align: center;
        padding: 20px;
        cursor: pointer;
        transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      #battery-alert-modal.visible .battery-alert-content {
        transform: scale(1);
      }
      #battery-alert-image {
        max-width: 100px;
        max-height: 100px;
        margin-bottom: 15px;
      }
      #battery-alert-text {
        font-size: 16px;
        font-weight: 500;
        color: #333;
        margin: 0;
        line-height: 1.4;
      }
      #chat-list-screen {
      }
      .chat-list-view {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.2s,
          visibility 0.2s;
        z-index: 1;
      }
      .chat-list-view.active {
        opacity: 1;
        visibility: visible;
        z-index: 2;
      }
      #messages-view {
        overflow-y: auto;
      }
      #chat-list-bottom-nav {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 15;
        display: flex;
        border-top: 1px solid var(--border-color);
        background-color: rgba(247, 247, 247, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .nav-item {
        flex: 1;
        text-align: center;
        padding: 12px 0;
        font-size: 14px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: color 0.2s;
      }
      .nav-item.active {
        color: var(--accent-color);
        font-weight: 600;
      }
      #qzone-screen {
        background-color: #f0f2f5;
      }
      .qzone-header {
        position: relative;
        z-index: 10;
        flex-shrink: 0;
        padding: 15px 20px;
        padding-top: 45px;
        background-color: rgba(247, 247, 247, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 18px;
        font-weight: 600;
        text-align: center;
      }
      .qzone-header .back-btn {
        font-size: 24px;
        cursor: pointer;
        color: var(--accent-color);
      }
      .qzone-header span:nth-child(2) {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
      }
      .qzone-content {
        flex-grow: 1;
        overflow-y: auto;
      }
      .qzone-profile-header {
        position: relative;
        margin-bottom: 20px;
      }
      .qzone-banner-container {
        width: 100%;
        height: 180px;
        position: relative;
      }
      #qzone-banner-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .qzone-user-info {
        position: absolute;
        bottom: -30px;
        left: 20px;
        display: flex;
        align-items: flex-end;
        gap: 10px;
      }
      .qzone-avatar-container {
        position: relative;
      }
      #qzone-avatar-img {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        object-fit: cover;
      }
      #qzone-nickname {
        font-size: 18px;
        font-weight: 600;
        color: #fff;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        padding-bottom: 5px;
      }
      #change-qzone-banner-btn {
        bottom: 10px;
        right: 10px;
      }
      #change-qzone-avatar-btn {
        bottom: 5px;
        right: 5px;
      }
      #change-qzone-nickname-btn {
        font-size: 14px;
        padding: 2px 6px;
        margin-left: 5px;
        color: var(--text-primary);
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 5px;
        position: relative;
        bottom: 5px;
      }
      #qzone-banner-container,
      #qzone-avatar-container,
      #qzone-nickname {
        cursor: pointer;
        transition: opacity 0.2s;
      }
      #qzone-banner-container:hover,
      #qzone-avatar-container:hover,
      #qzone-nickname:hover {
        opacity: 0.85;
      }
      .qzone-edit-btn {
        position: absolute;
        background-color: rgba(0, 0, 0, 0.4);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        display: none;
      }
      #qzone-screen .qzone-header {
        display: none;
      }
      #qzone-screen.active .qzone-header {
        display: flex;
      }
      #chat-list-screen.in-qzone-view > .header,
      #chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
        display: none;
      }
      .chat-list-item:first-child,
      .chat-group-container:first-child {
        margin-top: 10px;
      }
      .qzone-actions-bar {
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        margin: 40px 15px 15px 15px;
        background-color: var(--secondary-bg);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }
      .action-item {
        flex: 1;
        text-align: center;
        font-size: 15px;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        padding: 8px 0;
        position: relative;
      }
      .action-item:not(:last-child)::after {
        content: "";
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 1px;
        height: 20px;
        background-color: var(--border-color);
      }
      #qzone-posts-list {
        padding: 0 15px 20px 15px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .post-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }
      .post-header .post-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }
      .post-info {
        display: flex;
        flex-direction: column;
      }
      .post-info .post-nickname {
        font-weight: 600;
        font-size: 15px;
        color: var(--text-primary);
      }
      .post-info .post-timestamp {
        font-size: 12px;
        color: var(--text-secondary);
      }
      .post-content {
        font-size: 14px;
        line-height: 1.6;
        color: #333;
        white-space: pre-wrap;
        word-break: break-word;
      }
      #post-public-text {
        min-height: 80px;
        resize: vertical;
      }
      .post-image-preview-container {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        background-color: #f0f2f5;
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        margin-bottom: 15px;
        display: none;
        justify-content: center;
        align-items: center;
      }
      .post-image-preview-container.visible {
        display: flex;
      }
      #post-image-preview {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 6px;
      }
      #post-remove-image-btn {
        position: absolute;
        top: -10px;
        right: -10px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: #ff3b30;
        color: white;
        border: 2px solid white;
        font-size: 16px;
        line-height: 20px;
        text-align: center;
        cursor: pointer;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
      }
      .post-image-upload-options {
        display: flex;
        gap: 10px;
      }
      .post-image-upload-options button {
        flex: 1;
        margin-top: 0;
      }
      .post-mode-switcher {
        display: flex;
        margin-bottom: 20px;
        background-color: #e9ecef;
        border-radius: 8px;
        padding: 4px;
      }
      .mode-btn {
        flex: 1;
        padding: 8px;
        border: none;
        background-color: transparent;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }
      .mode-btn.active {
        background-color: var(--secondary-bg);
        color: var(--text-primary);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .post-mode-content {
        display: none;
      }
      .post-mode-content.active {
        display: block;
      }
      #album-screen {
        background-color: #f0f2f5;
      }
      #album-grid-page {
        padding: 15px;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      .album-item {
        display: flex;
        flex-direction: column;
        cursor: pointer;
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
        border-radius: 8px;
      }
      .album-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }
      .album-cover {
        aspect-ratio: 1 / 1;
        background-size: cover;
        background-position: center;
        border-radius: 8px;
        margin-bottom: 8px;
        background-color: #f0f2f5;
      }
      .album-info {
        text-align: center;
      }
      .album-name {
        font-weight: 500;
        margin: 0 0 4px 0;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .album-count {
        font-size: 12px;
        color: var(--text-secondary);
        margin: 0;
      }
      #album-photos-screen {
        background-color: #f0f2f5;
      }
      #photos-grid-page {
        padding: 15px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      .photo-item {
        position: relative;
        aspect-ratio: 1 / 1;
        border-radius: 6px;
        overflow: hidden;
        background-color: #e9ecef;
      }
      .photo-item .photo-thumb {
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: pointer;
      }
      .photo-item .photo-delete-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 22px;
        height: 22px;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 16px;
        line-height: 22px;
        text-align: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .photo-item:hover .photo-delete-btn {
        opacity: 1;
      }
      #photo-viewer-modal {
        background-color: rgba(0, 0, 0, 0.85);
        z-index: 1002;
        -webkit-backdrop-filter: blur(5px);
        backdrop-filter: blur(5px);
      }
      .photo-viewer-content {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
      }
      #photo-viewer-image {
        max-width: 90vw;
        max-height: 85vh;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        transition: opacity 0.2s ease-in-out;
      }
      #photo-viewer-close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        color: white;
        font-size: 40px;
        font-weight: 200;
        cursor: pointer;
        line-height: 1;
        text-shadow: 0 0 5px black;
      }
      #photo-viewer-modal .nav-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-size: 50px;
        font-weight: 100;
        cursor: pointer;
        padding: 10px;
        user-select: none;
        transition: color 0.2s;
        z-index: 1003;
      }
      #photo-viewer-prev-btn {
        left: 5px;
      }
      #photo-viewer-next-btn {
        right: 5px;
      }
      #photo-viewer-modal .nav-arrow:hover {
        color: white;
      }
      #photo-viewer-modal .nav-arrow:disabled {
        color: rgba(255, 255, 255, 0.2);
        cursor: default;
      }
      .post-main-content {
      }
      .post-feedback-icons {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
      }
      .action-icon {
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.2s ease-in-out;
      }
      .action-icon svg {
        width: 22px;
        height: 22px;
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .action-icon.active {
        color: #ff5252;
        transform: scale(1.1);
      }
      .action-icon.active.favorite {
        color: #ffc107;
      }
      .action-icon.active svg {
        fill: currentColor;
      }
      .animate-like {
        animation: like-bounce 0.4s ease-in-out;
      }
      @keyframes like-bounce {
        0% {
          transform: scale(1);
        }
        25% {
          transform: scale(0.8);
        }
        50% {
          transform: scale(1.2);
        }
        75% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1.1);
        }
      }
      .post-footer {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .comment-section {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .comment-section .comment-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
      }
      .comment-section .comment-input {
        width: 100%;
        padding: 8px 12px;
        border: none;
        background-color: #f0f2f5;
        border-radius: 14px;
        font-size: 13px;
        outline: none;
      }
      .comment-send-btn {
        flex-shrink: 0;
        padding: 8px 15px;
        border: none;
        background-color: var(--accent-color);
        color: white;
        border-radius: 14px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
      }
      .unread-indicator {
        position: absolute;
        top: -8px;
        right: -15px;
        min-width: 18px;
        height: 18px;
        padding: 0 5px;
        background-color: #ff3b30;
        color: white;
        font-size: 11px;
        font-weight: bold;
        line-height: 18px;
        text-align: center;
        border-radius: 9px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1;
      }
      .back-btn-indicator {
        top: 0;
        right: -8px;
        width: 10px;
        height: 10px;
        min-width: 10px;
        padding: 0;
        border-radius: 50%;
      }
      .post-comments-container {
        padding: 10px 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 13px;
      }
      .comment-item .commenter-name {
        font-weight: 600;
        color: var(--accent-color);
        cursor: pointer;
        margin-right: 5px;
      }
      .comment-item .comment-text {
        color: var(--text-primary);
        word-break: break-word;
      }
      .post-likes-section {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 10px;
        font-size: 13px;
        color: var(--accent-color);
        background-color: #f0f5fa;
        border-top: 1px solid #e9eef3;
        border-bottom: 1px solid #e9eef3;
        margin-top: 5px;
      }
      .post-likes-section .like-icon {
        width: 16px;
        height: 16px;
        fill: currentColor;
        flex-shrink: 0;
      }
      .at-mention-popup {
        position: absolute;
        bottom: 100%;
        left: 40px;
        width: calc(100% - 40px);
        max-height: 120px;
        overflow-y: auto;
        background-color: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: none;
      }
      .at-mention-item {
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
        color: var(--text-primary);
        border-bottom: 1px solid #f0f0f0;
      }
      .at-mention-item:last-child {
        border-bottom: none;
      }
      .at-mention-item:hover {
        background-color: #f5f5f5;
      }
      #favorites-view {
        display: flex;
        flex-direction: column;
      }
      #favorites-view > .header {
        flex-shrink: 0;
      }
      #favorites-list {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .favorite-item-card {
        background-color: var(--secondary-bg);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        position: relative;
      }
      .fav-card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }
      .fav-card-header .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
      }
      .fav-card-header .info {
        flex-grow: 1;
      }
      .fav-card-header .name {
        font-weight: 600;
        font-size: 15px;
      }
      .fav-card-header .source {
        font-size: 12px;
        color: var(--text-secondary);
      }
      .fav-card-content {
        font-size: 14px;
        line-height: 1.6;
        color: #333;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .fav-card-content .chat-image {
        margin-top: 8px;
      }
      .fav-delete-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 28px;
        height: 28px;
        background: #f0f2f5;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        color: var(--text-secondary);
        line-height: 28px;
        text-align: center;
      }
      .fav-delete-btn:hover {
        background-color: #e9ecef;
        color: #ff3b30;
      }
      .search-bar-container {
        padding: 10px 15px;
        background-color: #f9f9f9;
        position: relative;
        flex-shrink: 0;
      }
      #favorites-search-input {
        width: 100%;
        padding: 10px 30px 10px 15px;
        font-size: 14px;
        border: 1px solid var(--border-color);
        border-radius: 18px;
        background-color: var(--secondary-bg);
        box-sizing: border-box;
        outline: none;
      }
      #favorites-search-input:focus {
        border-color: var(--accent-color);
      }
      .search-clear-btn {
        position: absolute;
        right: 25px;
        top: 50%;
        transform: translateY(-50%);
        background: #ccc;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        line-height: 20px;
        text-align: center;
        font-size: 16px;
        cursor: pointer;
      }
      #chat-interface-screen .selection-controls .action-btn {
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        padding: 5px;
      }
      .favorite-item-card::before {
        content: "";
        position: absolute;
        left: -25px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        border: 2px solid #ccc;
        border-radius: 50%;
        background-color: white;
        transition: all 0.2s ease;
        opacity: 0;
      }
      #favorites-view.selection-mode .favorite-item-card {
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
        transform: translateX(35px);
      }
      #favorites-view.selection-mode .favorite-item-card::before {
        opacity: 1;
      }
      #favorites-view.selection-mode .favorite-item-card.selected::before {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        content: "‚úî";
        color: white;
        font-size: 14px;
        text-align: center;
        line-height: 20px;
      }
      #favorites-action-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        width: auto;
        padding: 10px 15px;
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
        background-color: rgba(247, 247, 247, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-top: 1px solid var(--border-color);
        box-sizing: border-box;
        z-index: 5;
        display: none;
      }
      #favorites-action-bar .action-bar-btn {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: none;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        background-color: #ff3b30;
        color: white;
      }
      #chat-interface-screen .header .selection-controls {
        display: none;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }
      #chat-interface-screen .header .default-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }
      #chat-interface-screen.selection-mode .header .default-controls {
        display: none;
      }
      #chat-interface-screen.selection-mode .header .selection-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }
      #add-chat-btn,
      #add-world-book-btn,
      #create-album-btn-page {
        font-size: 28px;
        font-weight: 300;
        position: relative;
        top: -1px;
      }
      #settings-preview-area {
        width: 100%;
        height: 180px;
        background-color: #f0f2f5;
        border-radius: 8px;
        padding: 15px;
        box-sizing: border-box;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 10px;
        border: 1px solid var(--border-color);
        position: relative;
      }
      #settings-preview-area::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        z-index: 1;
        opacity: 0.8;
      }
      #settings-preview-area .message-wrapper {
        position: relative;
        z-index: 2;
      }
      #settings-preview-area .message-bubble .avatar {
        width: 30px;
        height: 30px;
      }
      #settings-preview-area .message-bubble .timestamp {
        display: none;
      }
      .existing-group-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background-color: #f9f9f9;
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }
      .existing-group-item .group-name {
        font-weight: 500;
      }
      .existing-group-item .delete-group-btn {
        color: #ff3b30;
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
      }
      .chat-group-container {
        border-bottom: 1px solid var(--border-color);
      }
      .chat-group-container:first-child {
        border-top: 1px solid var(--border-color);
      }
      .chat-group-header {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        cursor: pointer;
        background-color: #f7f7f7;
      }
      .chat-group-header .arrow {
        font-size: 14px;
        margin-right: 8px;
        transition: transform 0.2s ease;
      }
      .chat-group-header.collapsed .arrow {
        transform: rotate(-90deg);
      }
      .chat-group-header .group-name {
        font-weight: 600;
        font-size: 15px;
      }
      .chat-group-content {
        max-height: 1000px;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }
      .chat-group-content.collapsed {
        max-height: 0;
      }
      .format-helpers {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      .format-btn {
        background-color: #e9ecef;
        color: var(--text-primary);
        border: none;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .format-btn:hover {
        background-color: #dcdfe3;
      }
      .post-actions-btn {
        margin-left: auto;
        padding: 5px 10px;
        font-size: 20px;
        font-weight: bold;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: 50%;
        line-height: 1;
      }
      .post-actions-btn:hover {
        background-color: #f0f0f0;
      }
      #post-actions-modal .custom-modal-footer button {
        width: 100%;
        border: none;
        border-bottom: 1px solid #dbdbdb;
        padding: 14px;
        font-size: 18px;
      }
      #post-actions-modal .custom-modal-footer button:last-child {
        border-bottom: none;
      }
      #post-actions-modal #cancel-post-action-btn {
        margin-top: 8px;
        border-radius: 8px;
        background-color: #f0f0f0;
      }
      #chat-messages .transfer-card .transfer-title,
      #chat-messages .transfer-card .transfer-amount,
      #chat-messages .transfer-card .transfer-note {
        text-shadow: none !important;
        color: white !important;
      }
      #chat-messages .transfer-card .transfer-title {
        font-size: 16px !important;
        font-weight: 600 !important;
      }
      #chat-messages .transfer-card .transfer-amount {
        font-size: 28px !important;
        font-weight: bold !important;
      }
      #chat-messages .transfer-card .transfer-note {
        font-size: 13px !important;
        opacity: 0.9 !important;
      }
      .header > span:nth-child(2),
      #chat-header-title {
        position: absolute;
        left: 50%;
        transform: translateX(calc(-50% - 2px));
        max-width: 60%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      #message-editor-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .message-editor-block {
        background-color: #f9f9f9;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
      }
      .message-editor-block textarea {
        width: 100%;
        min-height: 60px;
        resize: vertical;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 8px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .message-editor-block .format-helpers {
        margin-top: 8px;
        margin-bottom: 0;
      }
      .message-editor-block .delete-block-btn {
        float: right;
        margin-top: -5px;
        background: none;
        border: none;
        color: #ff3b30;
        font-size: 20px;
        cursor: pointer;
      }
      .contact-picker-item {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
      }
      .contact-picker-item .checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid #ccc;
        border-radius: 50%;
        margin-right: 15px;
        transition: all 0.2s ease;
      }
      .contact-picker-item.selected .checkbox {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        content: "‚úî";
        color: white;
        font-size: 14px;
        text-align: center;
        line-height: 20px;
      }
      .contact-picker-item .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
      }
      .contact-picker-item .name {
        font-weight: 500;
      }
      #member-management-list {
        padding: 0;
      }
      .member-management-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
      }
      .member-management-item .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
      }
      .member-management-item .name {
        flex-grow: 1;
        font-weight: 500;
      }
      .member-management-item .remove-member-btn {
        background-color: #ff3b30;
        color: white;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        font-size: 20px;
        line-height: 28px;
        text-align: center;
        cursor: pointer;
        flex-shrink: 0;
      }
      #member-management-actions {
        flex-shrink: 0;
        padding: 15px;
        border-top: 1px solid var(--border-color);
        background-color: #f7f7f7;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      #member-management-actions button {
        width: 100%;
        padding: 15px;
        background-color: var(--accent-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
      }
      #member-management-actions #create-new-member-btn {
        background-color: #4cd964;
      }
      .message-bubble.is-waimai-request .content {
        padding: 0;
        background: transparent;
        box-shadow: none;
        border: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
      .waimai-card {
        width: 240px;
        border-radius: 12px;
        overflow: hidden;
        background-color: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }
      .waimai-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        border-bottom: 1px solid #f0f0f0;
      }
      .waimai-header .icon {
        width: 20px;
        height: 20px;
      }
      .waimai-header .title-group {
        display: flex;
        align-items: baseline;
        font-size: 14px;
        color: #8a8a8a;
      }
      .waimai-header .title-group .brand {
        font-weight: 600;
        color: #555;
        margin-right: 5px;
      }
      .waimai-header .title-group .separator {
        margin: 0 5px;
      }
      .waimai-catchphrase {
        font-size: 13px;
        color: #1f1f1f;
        padding: 12px;
      }
      .waimai-main {
        background-color: #ffd66b;
        padding: 12px;
        text-align: center;
      }
      .waimai-main .request-title {
        font-size: 12px;
        color: #856404;
        margin-bottom: 8px;
      }
      .waimai-main .payment-box {
        background-color: #fff;
        border-radius: 8px;
        padding: 15px 10px;
      }
      .waimai-main .payment-label {
        font-size: 13px;
        color: #8a8a8a;
      }
      .waimai-main .amount {
        font-size: 32px;
        font-weight: 700;
        color: #1f1f1f;
        margin: 4px 0 12px 0;
      }
      .waimai-main .countdown-label {
        font-size: 13px;
        color: #8a8a8a;
      }
      .waimai-main .countdown-timer {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        margin-left: 5px;
      }
      .waimai-main .countdown-timer span {
        background-color: #333;
        color: white;
        padding: 2px 4px;
        border-radius: 2px;
        font-weight: bold;
        font-size: 12px;
      }
      .waimai-details-btn {
        width: 100%;
        padding: 10px 0;
        margin-top: 15px;
        border: none;
        border-radius: 6px;
        background-color: #ffc33a;
        color: #49380a;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }
      .message-bubble.status-paid .waimai-card {
        border: 2px solid #28a745;
      }
      .message-bubble.status-paid .waimai-main .request-title::before {
        content: "‚úÖ  ";
      }
      .message-bubble.status-paid .waimai-main .request-title {
        color: #155724;
        font-weight: 600;
        content: "ÊàëÂ∑≤‰∏∫ÊÇ®‰π∞ÂçïÔºåËØ∑Â∞ΩÊÉÖ‰∫´Áî®ÂêßÔΩû" !important;
        display: block;
        margin-bottom: 15px;
      }
      .message-bubble.status-paid .payment-box {
        display: none;
      }
      .message-bubble.status-paid .waimai-details-btn {
        background-color: #28a745;
        color: white;
      }
      .message-bubble.status-rejected .waimai-card {
        border: 2px solid #dc3545;
        opacity: 0.8;
      }
      .message-bubble.status-rejected .waimai-main {
        background-color: #e9ecef;
      }
      .message-bubble.status-rejected .waimai-main .request-title::before {
        content: "‚ùå ";
      }
      .message-bubble.status-rejected .waimai-main .request-title {
        color: #721c24;
        font-weight: 600;
        content: "ÊàëÊãíÁªù‰∫ÜÊÇ®ÁöÑ‰ª£‰ªòËØ∑Ê±Ç" !important;
        display: block;
        margin-bottom: 15px;
      }
      .message-bubble.status-rejected .payment-box {
        display: none;
      }
      .message-bubble.status-rejected .waimai-details-btn {
        background-color: #6c757d;
        color: white;
      }
      .message-bubble[class*="status-"] .request-title {
        font-size: 0;
      }
      .message-bubble[class*="status-"] .request-title::after {
        font-size: 14px;
      }
      .message-bubble.status-paid .request-title::after {
        content: "ÊàëÂ∑≤‰∏∫ÊÇ®‰π∞ÂçïÔºåËØ∑Â∞ΩÊÉÖ‰∫´Áî®ÂêßÔΩû";
      }
      .message-bubble.status-rejected .request-title::after {
        content: "ÊàëÊãíÁªù‰∫ÜÊÇ®ÁöÑ‰ª£‰ªòËØ∑Ê±Ç";
      }
      .waimai-user-actions {
        display: flex;
        gap: 10px;
        padding: 0 12px 12px 12px;
        background-color: #fff;
      }
      .waimai-user-actions button {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: 1.5px solid;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .waimai-pay-btn {
        background-color: #28a745;
        border-color: #1f7a33;
        color: white;
      }
      .waimai-pay-btn:hover {
        background-color: #218838;
      }
      .waimai-decline-btn {
        background-color: #f8f9fa;
        border-color: #ced4da;
        color: #495057;
      }
      .waimai-decline-btn:hover {
        background-color: #e2e6ea;
      }
      #api-settings-screen,
      #font-settings-screen,
      #wallpaper-screen,
      #memories-view,
      #contact-picker-screen,
      #member-management-screen,
      #world-book-editor-screen {
        background-color: var(--secondary-bg);
      }
      #api-settings-screen .form-container,
      #font-settings-screen .form-container,
      #wallpaper-screen .form-container {
        padding-top: 100px;
        margin-top: -80px;
        background-color: var(--secondary-bg);
      }
      #incoming-call-modal .incoming-call-content {
        background-color: rgba(40, 40, 40, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        width: 280px;
        padding: 30px 20px;
        text-align: center;
        color: white;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }
      .caller-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 12px;
        border: 3px solid rgba(255, 255, 255, 0.5);
      }
      .caller-name {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 5px;
      }
      .caller-text {
        font-size: 14px;
        color: #ccc;
        margin-bottom: 30px;
      }
      .incoming-call-actions {
        display: flex;
        justify-content: space-around;
        align-items: center;
      }
      .action-button-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #e0e0e0;
      }
      .call-action-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        background-size: 50%;
        background-repeat: no-repeat;
        background-position: center;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      .call-action-btn:active {
        transform: scale(0.9);
      }
      .call-action-btn.decline {
        background-color: #ff3b30;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
      }
      .call-action-btn.accept {
        background-color: #4cd964;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7);
        }
        70% {
          box-shadow: 0 0 0 15px rgba(76, 217, 100, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(76, 217, 100, 0);
        }
      }
      #video-call-screen {
        background-color: #1c1c1e;
        color: white;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .video-call-top-bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        padding: 15px 20px;
        padding-top: 50px;
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5), transparent);
        z-index: 10;
        text-align: center;
        box-sizing: border-box;
        pointer-events: none;
      }
      #call-timer {
        font-size: 16px;
        font-weight: 500;
        letter-spacing: 1px;
      }
      .video-call-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 20px;
        padding-bottom: 40px;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.5), transparent);
        z-index: 10;
        box-sizing: border-box;
      }
      .video-call-avatar-area {
        height: 35%;
        flex-shrink: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        padding-top: 80px;
        box-sizing: border-box;
        overflow-y: auto;
      }
      #participant-avatars-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 15px;
        max-width: 100%;
      }
      .participant-avatar-wrapper {
        position: relative;
        text-align: center;
        flex-shrink: 0;
      }
      .participant-avatar {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }
      .participant-name {
        margin-top: 8px;
        font-size: 12px;
        color: #ccc;
      }
      .participant-avatar.speaking {
        border-color: #4cd964;
        box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
        transform: scale(1.05);
      }
      #video-call-main {
        flex-grow: 1;
        margin: 15px 15px 130px 15px;
        overflow-y: auto;
        padding: 15px;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        box-sizing: border-box;
      }
      .control-btn {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        background-repeat: no-repeat;
        background-position: center;
        transition:
          transform 0.2s,
          background-color 0.2s;
      }
      .control-btn:active {
        transform: scale(0.9);
      }
      .control-btn.speak-btn {
        background-color: rgba(255, 255, 255, 0.2);
        background-size: 55%;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>');
      }
      .control-btn.hangup-btn {
        background-color: #ff3b30;
        background-size: 50%;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
      }
      .control-btn.join-btn {
        background-color: #007bff;
        background-size: 50%;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>');
      }
      .call-message-bubble {
        padding: 10px 15px;
        border-radius: 12px;
        max-width: 85%;
        line-height: 1.6;
        word-break: break-word;
        white-space: pre-wrap;
      }
      .call-message-bubble.ai-speech {
        background-color: rgba(255, 255, 255, 0.15);
        align-self: flex-start;
      }
      .call-message-bubble.user-speech {
        background-color: #4cd964;
        align-self: flex-end;
        text-align: left;
      }
      #outgoing-call-screen {
        background-color: #1c1c1e;
        color: white;
        justify-content: center;
        align-items: center;
      }
      .outgoing-call-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .outgoing-call-actions {
        margin-top: 50px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #e0e0e0;
      }
      .qzone-post-container {
        position: relative;
        overflow: hidden;
        border-radius: 12px;
      }
      .qzone-post-item {
        background-color: var(--secondary-bg);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        transition: transform 0.3s ease;
        position: relative;
        z-index: 2;
      }
      .qzone-post-delete-action {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 90px;
        background-color: #ff3b30;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        cursor: pointer;
        z-index: 1;
      }
      .qzone-post-item.swiped {
        transform: translateX(-90px);
      }
      @keyframes pat-shake {
        0%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-3px);
        }
        20%,
        40%,
        60%,
        80% {
          transform: translateX(3px);
        }
      }
      .pat-animation {
        animation: pat-shake 0.4s ease-in-out;
      }
      .system-message {
        align-self: center;
        padding: 4px 12px;
        margin: 5px 0;
        background-color: rgba(0, 0, 0, 0.1);
        color: var(--text-secondary);
        font-size: 12px;
        border-radius: 10px;
        text-align: center;
        max-width: 80%;
      }
      .message-wrapper.system-pat {
        justify-content: center;
        align-self: center;
        margin: 5px 0;
        max-width: 80%;
      }
      .message-bubble.system-bubble {
        background-color: rgba(0, 0, 0, 0.1);
        color: var(--text-secondary);
        font-size: 12px;
        padding: 4px 12px;
        border-radius: 10px;
      }
      .message-bubble.is-sticker .content,
      .message-bubble.is-transfer .content,
      .message-bubble.is-waimai-request .content,
      .message-bubble.has-image .content,
      .message-bubble.is-ai-image .content,
      .message-bubble.is-voice-message .content {
        background-color: transparent !important;
        background: transparent !important;
        box-shadow: none !important;
        border: none !important;
        padding: 0 !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
      }
      .message-bubble.is-sticker:not(.selected)::after,
      .message-bubble.has-image:not(.selected)::after,
      .message-bubble.is-ai-image:not(.selected)::after,
      .message-bubble.is-transfer:not(.selected)::after,
      .message-bubble.is-waimai-request:not(.selected)::after,
      .message-bubble.is-voice-message:not(.selected)::after {
        display: none !important;
      }
      #typing-indicator {
        align-self: center;
        display: none;
        margin: 5px 0;
        color: var(--text-secondary);
      }
      #typing-indicator .system-bubble {
        background-color: rgba(0, 0, 0, 0.1);
        color: var(--text-secondary);
        font-size: 12px;
        padding: 4px 12px;
        border-radius: 10px;
        display: inline-block;
      }
      #chat-input-actions-top {
        display: flex;
        gap: 8px;
        padding: 0 5px;
        overflow-x: auto;
        flex-wrap: nowrap;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      #chat-input-actions-top::-webkit-scrollbar {
        display: none;
      }
      #chat-header-title-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        max-width: 60%;
      }
      #chat-header-status {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 11px;
        color: var(--text-secondary);
        transition: all 0.3s ease;
      }
      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background-color: #4cd964;
        transition: background-color 0.3s ease;
      }
      #chat-header-status.busy .status-dot {
        background-color: #cccccc;
      }
      .status-text {
        font-weight: 500;
      }
      .memory-card {
        background-color: #fffaf0;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.07);
        border-left: 5px solid #ffb74d;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .memory-card .header {
        border-bottom: 1px solid rgba(217, 129, 0, 0.15);
        padding-bottom: 8px;
      }
      .memory-card .header .date {
        font-size: 11px;
        color: #a1887f;
        margin-bottom: 4px;
      }
      .memory-card .header .author {
        font-weight: 600;
        color: #d98100;
        font-size: 15px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .memory-card .content {
        font-size: 14px;
        line-height: 1.7;
        color: #5d4037;
        white-space: pre-wrap;
      }
      .countdown-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
        text-align: center;
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
      }
      .countdown-card::before {
        content: "‚ú®";
        position: absolute;
        top: -10px;
        left: -10px;
        font-size: 50px;
        opacity: 0.1;
        transform: rotate(-15deg);
      }
      .countdown-card .title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
      }
      .countdown-card .timer {
        font-size: 28px;
        font-weight: 300;
        letter-spacing: 2px;
        margin-bottom: 15px;
      }
      .countdown-card .target-date {
        font-size: 12px;
        opacity: 0.8;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        padding-top: 10px;
      }
      #chat-lock-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: rgba(247, 247, 247, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 150;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
        border-top: 1px solid var(--border-color);
        text-align: center;
      }
      #chat-lock-content {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      #chat-lock-content .lock-text {
        color: var(--text-secondary);
        font-size: 14px;
      }
      #chat-lock-content .lock-action-btn {
        padding: 10px 20px;
        border-radius: 20px;
        border: 1px solid var(--accent-color);
        background-color: var(--accent-color);
        color: white;
        cursor: pointer;
      }
      #chat-lock-content .lock-action-btn.secondary {
        background-color: transparent;
        color: var(--accent-color);
      }
      .message-bubble.is-red-packet .content {
        padding: 0;
        background: transparent;
        box-shadow: none;
        border: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
      .red-packet-card {
        width: 220px;
        border-radius: 8px;
        background: linear-gradient(160deg, #f96259, #e44d44);
        color: #ffd700;
        padding: 12px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }
      .red-packet-card.opened {
        background: linear-gradient(160deg, #d3c4a0, #c4b693);
        cursor: default;
      }
      .red-packet-card::before {
        content: "üßß";
        position: absolute;
        top: -5px;
        left: -5px;
        font-size: 30px;
        opacity: 0.2;
        transform: rotate(-10deg);
      }
      .rp-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }
      .rp-icon {
        width: 20px;
        height: 20px;
      }
      .rp-greeting {
        font-size: 15px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .rp-type {
        font-size: 11px;
        color: white;
        opacity: 0.8;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        padding-top: 8px;
        margin-top: 8px;
      }
      .rp-claimed-info {
        font-size: 13px;
        color: white;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.3);
      }
      .rp-details-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      .rp-details-item:last-child {
        border-bottom: none;
      }
      .rp-details-item .name {
        flex-grow: 1;
        font-weight: 500;
        color: #333;
      }
      .rp-details-item .amount {
        font-weight: 500;
        color: #555;
      }
      .rp-details-item .lucky-king-tag {
        font-size: 10px;
        background-color: #ffd700;
        color: #a67c00;
        padding: 2px 5px;
        border-radius: 4px;
        margin-left: 8px;
        font-weight: bold;
      }
      .message-bubble.is-poll .content {
        padding: 0;
        background: transparent;
        box-shadow: none;
        border: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
      .poll-card {
        width: 250px;
        background-color: #f9f9f9;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        padding: 12px;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }
      .poll-card.closed {
        background-color: #e9ecef;
      }
      .poll-question {
        font-weight: 600;
        font-size: 15px;
        margin-bottom: 12px;
        line-height: 1.4;
        word-break: break-word;
      }
      .poll-options-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .poll-option-item {
        background-color: white;
        border: 1px solid #dcdcdc;
        border-radius: 8px;
        padding: 10px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: background-color 0.2s;
      }
      .poll-card:not(.closed) .poll-option-item:hover {
        background-color: #f0f8ff;
      }
      .poll-option-item.voted {
        border-color: var(--accent-color);
        background-color: #e7f3ff;
        font-weight: 500;
      }
      .poll-option-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background-color: rgba(0, 123, 255, 0.1);
        z-index: 1;
        transition: width 0.3s ease-in-out;
      }
      .poll-option-content {
        position: relative;
        z-index: 2;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .poll-option-text {
        font-size: 14px;
      }
      .poll-option-votes {
        font-size: 13px;
        color: #8a8a8a;
        font-weight: 500;
      }
      .poll-footer {
        margin-top: 12px;
        padding-top: 8px;
        border-top: 1px solid #e9e9e9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: var(--text-secondary);
      }
      .poll-total-votes {
        font-weight: 500;
      }
      .poll-action-btn {
        background: none;
        border: 1px solid var(--accent-color);
        color: var(--accent-color);
        padding: 4px 10px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 12px;
      }
      .poll-card.closed .poll-action-btn {
        background-color: #6c757d;
        color: white;
        border-color: #6c757d;
      }
      .poll-option-input-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .poll-option-input-wrapper input {
        flex-grow: 1;
      }
      .poll-option-input-wrapper .remove-option-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: #f0f0f0;
        color: #ff3b30;
        border: none;
        cursor: pointer;
        font-size: 18px;
        line-height: 28px;
        text-align: center;
        flex-shrink: 0;
      }
      #chat-header-title.typing-status {
        color: var(--text-secondary);
        animation: typing-pulse 1.5s infinite;
        font-style: italic;
      }
      @keyframes typing-pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }
      #chat-header-title {
        font-size: 16px;
        font-weight: 600;
        position: static;
        transform: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        transition: opacity 0.2s ease-in-out;
      }
      @keyframes message-pop-in {
        from {
          opacity: 0;
          transform: translateY(15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message-wrapper.animate-in {
        animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
      }
      #icon-settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 20px;
        width: 100%;
        padding: 0 10px;
        box-sizing: border-box;
      }
      .icon-setting-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .icon-preview {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        background-size: cover;
        background-position: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .change-icon-btn {
        padding: 4px 10px;
        font-size: 12px;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        border-radius: 5px;
        cursor: pointer;
      }
      #wallpaper-screen .form-container {
        align-items: center;
        min-height: 0;
      }
      #wallpaper-preview {
        width: 180px;
        height: 320px;
        border: 2px dashed var(--border-color);
        background-color: #f0f2f5;
        margin-bottom: 20px;
        background-size: cover;
        background-position: center;
        border-radius: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--text-secondary);
        flex-shrink: 0;
      }
      #browser-screen {
        background-color: #f8f9fa;
      }
      #browser-content {
        padding: 20px;
        font-size: 16px;
        line-height: 1.8;
        color: #333;
        overflow-y: auto;
        background-color: #f8f9fa;
      }
      #browser-content .article-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 10px;
      }
      #browser-content .article-meta {
        font-size: 13px;
        color: #8a8a8a;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e0e0e0;
      }
      #browser-content .article-body {
        white-space: pre-wrap;
        word-break: break-word;
      }
      #browser-content .article-body p {
        margin-bottom: 1em;
      }
      .message-bubble.is-link-share .content {
        padding: 0;
        background: transparent;
        box-shadow: none;
        border: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
      .link-share-card {
        width: 210px;
        background-color: #fff;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        padding: 12px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .link-share-card:hover {
        background-color: #f9f9f9;
      }
      .link-share-card .title {
        font-weight: 600;
        font-size: 15px;
        line-height: 1.4;
        color: #1f1f1f;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .link-share-card .description {
        font-size: 13px;
        color: #8a8a8a;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .link-share-card .footer {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 4px;
      }
      .link-share-card .footer-icon {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
      }
      .comment-item {
        line-height: 1.5;
        position: relative;
        padding-right: 25px;
      }
      .comment-delete-btn {
        position: absolute;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        width: 22px;
        height: 22px;
        line-height: 22px;
        text-align: center;
        border-radius: 50%;
        color: var(--text-secondary);
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s ease;
        opacity: 0;
      }
      .comment-item:hover .comment-delete-btn {
        opacity: 1;
      }
      .comment-delete-btn:hover {
        background-color: #f0f0f0;
        color: #ff3b30;
      }
      #phone-screen.dark-mode {
        --secondary-bg: #1c1c1e;
        --border-color: #38383a;
        --text-primary: #ffffff;
        --text-secondary: #8d8d92;
      }
      #phone-screen.dark-mode #chat-list-screen,
      #phone-screen.dark-mode #qzone-screen .qzone-content,
      #phone-screen.dark-mode #memories-view {
        background-color: #000000;
      }
      #phone-screen.dark-mode #chat-list {
        background-color: #000000;
      }
      #phone-screen.dark-mode .chat-list-item {
        border-bottom-color: rgba(255, 255, 255, 0.15);
      }
      #phone-screen.dark-mode .chat-group-header {
        background-color: #1c1c1e;
        border-bottom: 1px solid #38383a;
      }
      #phone-screen.dark-mode .chat-list-item .name,
      #phone-screen.dark-mode .chat-group-header .group-name {
        color: #ffffff;
      }
      #phone-screen.dark-mode .chat-list-item:hover {
        background-color: #1c1c1e;
      }
      #phone-screen.dark-mode .header,
      #phone-screen.dark-mode .qzone-header {
        background-color: rgba(25, 25, 25, 0.9);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-bottom-color: rgba(255, 255, 255, 0.15);
        color: #ffffff;
      }
      #phone-screen.dark-mode .header .back-btn,
      #phone-screen.dark-mode .header .action-btn,
      #phone-screen.dark-mode .header .save-btn {
        color: #ffffff;
      }
      #phone-screen.dark-mode #chat-list-bottom-nav {
        background-color: rgba(25, 25, 25, 0.9);
        border-top-color: rgba(255, 255, 255, 0.15);
      }
      #phone-screen.dark-mode .nav-item.active {
        color: #ffffff;
      }
      #phone-screen.dark-mode #chat-input-area {
        background-color: rgba(5, 5, 5, 0.8);
        border-top: none;
      }
      #phone-screen.dark-mode #chat-input {
        background-color: #3e3e42;
        color: #ffffff;
      }
      #phone-screen.dark-mode #chat-input::placeholder {
        color: #8d8d92;
      }
      #phone-screen.dark-mode .chat-action-icon-btn {
        color: #ffffff;
        background-color: rgba(255, 255, 255, 0.1);
        border: none;
      }
      #phone-screen.dark-mode #send-btn {
        background-color: var(--accent-color);
      }
      #phone-screen.dark-mode .qzone-actions-bar,
      #phone-screen.dark-mode .qzone-post-item {
        background-color: #1c1c1e;
        border: 1px solid #333;
        box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
      }
      #phone-screen.dark-mode .action-item:not(:last-child)::after {
        background-color: #333;
      }
      #phone-screen.dark-mode .post-footer,
      #phone-screen.dark-mode .post-likes-section {
        border-top-color: #333;
      }
      #phone-screen.dark-mode .post-likes-section {
        background-color: rgba(0, 123, 255, 0.1);
      }
      #phone-screen.dark-mode .comment-input {
        background-color: #333;
        color: #ffffff;
      }
      #phone-screen.dark-mode .comment-input::placeholder {
        color: #8d8d92;
      }
      #phone-screen.dark-mode .post-actions-btn:hover {
        background-color: #333;
      }
      #phone-screen.dark-mode .at-mention-popup {
        background-color: #1c1c1e;
        border-color: #333;
      }
      #phone-screen.dark-mode .at-mention-item {
        border-bottom-color: #333;
      }
      #phone-screen.dark-mode .at-mention-item:hover {
        background-color: #333;
      }
      #phone-screen.dark-mode .memory-card {
        background-color: #1c1c1e;
        border-left-color: #e6a753;
        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.08);
      }
      #phone-screen.dark-mode .memory-card .header {
        background-color: #2c2c2e;
        border-bottom-color: #38383a;
        margin: -15px -15px 8px -15px;
        padding: 12px 15px;
        border-radius: 12px 12px 0 0;
      }
      #phone-screen.dark-mode .memory-card .header .date,
      #phone-screen.dark-mode .memory-card .header .author,
      #phone-screen.dark-mode .memory-card .content {
        color: #e0e0e0;
      }
      #phone-screen.dark-mode #api-settings-screen,
      #phone-screen.dark-mode #font-settings-screen,
      #phone-screen.dark-mode #wallpaper-screen,
      #phone-screen.dark-mode #contact-picker-screen,
      #phone-screen.dark-mode #member-management-screen,
      #phone-screen.dark-mode #world-book-editor-screen,
      #phone-screen.dark-mode #world-book-list,
      #phone-screen.dark-mode .list-item:hover,
      #phone-screen.dark-mode .list-container,
      #phone-screen.dark-mode .form-container {
        background-color: #000000;
      }
      #phone-screen.dark-mode .form-group input,
      #phone-screen.dark-mode .form-group select,
      #phone-screen.dark-mode .form-group textarea {
        background-color: #1c1c1e;
        color: #ffffff;
        border-color: #38383a;
      }
      #phone-screen.dark-mode .form-button-secondary {
        background-color: #333;
        border-color: #555;
        color: #fff;
      }
      #phone-screen.dark-mode .qzone-post-item .post-nickname,
      #phone-screen.dark-mode .qzone-post-item .post-content {
        color: #f0f0f0;
      }
      #phone-screen.dark-mode .favorite-item-card .fav-card-header .name,
      #phone-screen.dark-mode .favorite-item-card .fav-card-content {
        color: #f0f0f0;
      }
      #phone-screen.dark-mode .favorite-item-card .fav-card-header .source {
        color: #8d8d92;
      }
      #phone-screen.dark-mode .search-bar-container {
        background-color: #000000;
      }
      #phone-screen.dark-mode #favorites-search-input {
        background-color: #1c1c1e;
        border-color: #38383a;
        color: #ffffff;
      }
      #phone-screen.dark-mode #favorites-search-input::placeholder {
        color: #8d8d92;
      }
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 51px;
        height: 31px;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #e9e9eb;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 27px;
        width: 27px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      input:checked + .slider {
        background-color: #34c759;
      }
      input:checked + .slider:before {
        transform: translateX(20px);
      }
      #reply-preview-bar {
        display: none;
        padding: 8px 12px;
        margin: 0 8px 8px 8px;
        background-color: rgba(0, 0, 0, 0.05);
        border-left: 3px solid var(--accent-color);
        border-radius: 6px;
        position: relative;
        font-size: 13px;
        color: var(--text-secondary);
      }
      #phone-screen.dark-mode #reply-preview-bar {
        background-color: rgba(255, 255, 255, 0.1);
      }
      .reply-preview-content .sender {
        font-weight: 600;
        color: var(--text-primary);
      }
      .reply-preview-content .text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        max-width: 95%;
      }
      #cancel-reply-btn {
        position: absolute;
        top: 50%;
        right: 8px;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        line-height: 20px;
        text-align: center;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.1);
        cursor: pointer;
        font-size: 14px;
      }
      .quoted-message {
        padding: 6px 10px;
        margin-bottom: 6px;
        background-color: rgba(0, 0, 0, 0.04);
        border-left: 2px solid var(--accent-color);
        border-radius: 4px;
        font-size: 0.9em;
        opacity: 0.8;
      }
      #phone-screen.dark-mode .quoted-message {
        background-color: rgba(255, 255, 255, 0.08);
        border-left-color: #a0cff1;
      }
      .quoted-message .quoted-sender {
        font-weight: 600;
        color: var(--accent-color);
      }
      #phone-screen.dark-mode .quoted-message .quoted-sender {
        color: #a0cff1;
      }
      .quoted-message .quoted-content {
        color: var(--text-secondary);
        white-space: normal;
        word-break: break-word;
        display: block;
      }
      #font-preview {
        transition:
          background-color 0.3s,
          border-color 0.3s;
        padding: 20px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: #f9f9f9;
      }
      #font-preview p {
        color: var(--text-primary);
      }
      #phone-screen.dark-mode #font-preview {
        background-color: #1c1c1e;
        border-color: #38383a;
      }
      #phone-screen.dark-mode #font-preview p {
        color: #ffffff;
      }
      .transfer-actions-content {
        background-color: #fff0f5;
        border-radius: 20px;
        width: 290px;
        padding: 20px;
        box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3);
        text-align: center;
        position: relative;
        border: 1px solid #ffcce0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }
      .transfer-actions-header {
        font-size: 20px;
        font-weight: bold;
        color: #a35c7b;
        margin-bottom: 15px;
      }
      .transfer-actions-body p {
        font-size: 15px;
        color: #555;
        margin: 0 0 25px 0;
        line-height: 1.5;
      }
      .transfer-actions-footer {
        display: flex;
        justify-content: space-between;
        gap: 15px;
      }
      .transfer-actions-footer .action-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        color: white;
      }
      .transfer-actions-footer .action-btn:active {
        transform: scale(0.95);
      }
      .transfer-actions-footer .action-btn.accept {
        background: linear-gradient(135deg, #ff85b3, #ff69b4);
        box-shadow: 0 4px 10px rgba(255, 105, 180, 0.4);
      }
      .transfer-actions-footer .action-btn.decline {
        background: linear-gradient(135deg, #c2c2c2, #a0a0a0);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      .transfer-actions-content .cancel-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: none;
        background-color: rgba(0, 0, 0, 0.1);
        color: #a35c7b;
        font-size: 20px;
        line-height: 28px;
        cursor: pointer;
      }
      .unread-count-wrapper {
        flex-shrink: 0;
        width: 40px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 20px;
      }
      .unread-count {
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        background-color: #ff3b30;
        color: white;
        font-size: 13px;
        font-weight: 500;
        line-height: 20px;
        text-align: center;
        border-radius: 10px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
        display: none;
        justify-content: center;
        align-items: center;
      }
      #call-history-screen {
        background-color: #f0f2f5;
      }
      .call-record-card {
        background-color: var(--secondary-bg);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        cursor: pointer;
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
        border-left: 5px solid var(--accent-color);
      }
      .call-record-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      }
      .call-record-card .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
      }
      .call-record-card .card-header .duration {
        font-weight: 500;
        color: var(--text-primary);
      }
      .call-record-card .participants-avatars {
        display: flex;
        align-items: center;
      }
      .call-record-card .participant-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .call-record-card .participant-avatar:not(:first-child) {
        margin-left: -12px;
      }
      #transcript-modal-body {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 15px;
      }
      .transcript-entry {
        padding: 8px 12px;
        border-radius: 10px;
        max-width: 85%;
        line-height: 1.5;
        word-break: break-word;
      }
      .transcript-entry.user {
        background-color: #dcf8c6;
        align-self: flex-end;
      }
      .transcript-entry.assistant {
        background-color: #ffffff;
        align-self: flex-start;
      }
      #chat-list-title {
        cursor: pointer;
      }
      .call-record-card .card-body {
        display: flex;
        align-items: center;
        flex-direction: column;
        gap: 8px;
      }
      .call-record-card .custom-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 4px;
      }
      .call-record-card .participants-info {
        display: flex;
        align-items: center;
      }
      .call-record-card .participants-names {
        margin-left: 12px;
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 14px;
      }
      .voice-transcript {
        background-color: rgba(0, 0, 0, 0.04);
        color: var(--text-secondary);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        line-height: 1.6;
        position: relative;
        text-align: justify;
        margin-top: 6px;
        display: none;
        word-break: break-word;
      }
      #phone-screen.dark-mode .voice-transcript {
        background-color: rgba(255, 255, 255, 0.1);
      }
      .loading-spinner {
        display: none;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-top-color: var(--accent-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      #shared-history-viewer-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 15px;
      }
      #music-player-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 50;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        background-color: rgba(0, 0, 0, 0.3);
        padding-top: 60px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-50px);
        transition:
          opacity 0.4s ease-out,
          transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      #music-player-overlay.visible {
        display: flex;
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
      .music-player-window {
        width: 70%;
        background-color: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 25px;
        box-shadow: 0 8px 32px 0 rgba(25, 25, 25, 0.37);
        border: 1px solid rgba(255, 255, 255, 0.18);
        padding: 25px;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #1f1f1f;
        position: relative;
        min-height: 420px;
        justify-content: space-between;
        padding-bottom: 15px;
      }
      .music-player-top-actions {
        position: absolute;
        top: 15px;
        left: 15px;
        right: 15px;
        width: calc(100% - 30px);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .top-left-cluster {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      #music-return-btn,
      #music-exit-btn {
        background: none;
        border: none;
        font-size: 28px;
        font-weight: 300;
        cursor: pointer;
        color: #555;
        padding: 5px;
        line-height: 1;
      }
      #music-exit-btn {
        background-color: transparent;
        color: #555;
        margin-right: 5px;
        font-size: 24px;
        font-weight: 400;
      }
      .music-progress-bar-container {
        width: 100%;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 25px;
        margin-bottom: 10px;
      }
      .time-display {
        font-size: 11px;
        color: #888;
        width: 35px;
        text-align: center;
        flex-shrink: 0;
        font-family: "SF Mono", "Menlo", monospace;
      }
      .progress-bar {
        flex-grow: 1;
        height: 5px;
        background-color: #e5e5e5;
        border-radius: 2.5px;
        cursor: pointer;
      }
      .progress-bar-fill {
        width: 0%;
        height: 100%;
        background-color: #333;
        border-radius: 2.5px;
      }
      #music-lyrics-container {
        width: 100%;
        height: 192px;
        overflow: hidden;
        position: relative;
        -webkit-mask-image: linear-gradient(
          transparent,
          black 20%,
          black 80%,
          transparent
        );
        mask-image: linear-gradient(
          transparent,
          black 20%,
          black 80%,
          transparent
        );
      }
      #music-lyrics-list {
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
      }
      .lyric-line {
        padding: 4px 0;
        font-size: 14px;
        color: #666;
        text-align: center;
        line-height: 1.5;
        transition: all 0.5s ease;
        opacity: 0.7;
        transform: scale(0.95);
      }
      .lyric-line.active {
        font-size: 16px;
        color: #000;
        opacity: 1;
        transform: scale(1);
      }
      .music-player-controls-wrapper {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .music-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        width: 100%;
        margin-bottom: 30px;
        margin-top: 0;
      }
      #music-return-btn,
      #music-exit-btn,
      #music-playlist-btn {
        position: relative;
      }
      #music-return-btn {
        background-color: transparent;
        color: #555;
        margin-left: 5px;
        top: -2px;
      }
      #music-playlist-btn {
        position: absolute;
        top: -3px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #333;
      }
      .playlist-item-actions {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .playlist-action-btn {
        font-size: 18px;
        color: #888;
        cursor: pointer;
        transition: color 0.2s;
      }
      .playlist-action-btn:hover {
        color: #000;
      }
      .delete-track-btn {
        font-size: 24px;
        color: #ff3b30;
      }
      .delete-track-btn:hover {
        color: #c00;
      }
      .lyrics-btn {
        font-weight: 500;
      }
      .message-bubble .avatar {
        width: 34px;
        height: 34px;
        border-radius: 20%;
        object-fit: cover;
        flex-shrink: 0;
      }
      #phone-screen.dark-mode .recalled-message-placeholder {
        background-color: rgba(255, 255, 255, 0.15);
      }
      @keyframes recall-animation {
        from {
          opacity: 1;
          transform: scale(1);
        }
        to {
          opacity: 0;
          transform: scale(0.8);
        }
      }
      .message-wrapper.recalled-animation {
        animation: recall-animation 0.3s ease-out forwards;
      }
      .recalled-message-placeholder {
        align-self: center;
        padding: 4px 12px;
        margin: 5px 0;
        background-color: rgba(0, 0, 0, 0.1);
        color: var(--text-secondary);
        font-size: 12px;
        border-radius: 10px;
        text-align: center;
        max-width: 80%;
        cursor: pointer;
        white-space: nowrap;
        display: inline-block;
      }
      .world-book-group-container {
        border-bottom: 1px solid var(--border-color);
      }
      .world-book-group-container:first-child {
        border-top: 1px solid var(--border-color);
      }
      .world-book-group-header {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        cursor: pointer;
        background-color: #f7f7f7;
      }
      .world-book-group-header .arrow {
        font-size: 14px;
        margin-right: 8px;
        transition: transform 0.2s ease;
      }
      .world-book-group-header.collapsed .arrow {
        transform: rotate(-90deg);
      }
      .world-book-group-header .group-name {
        font-weight: 600;
        font-size: 15px;
      }
      .world-book-group-content {
        max-height: 1000px;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }
      .world-book-group-content.collapsed {
        max-height: 0;
      }
      .frame-tabs {
        display: flex;
        background-color: #f0f0f0;
        padding: 4px;
        margin: 15px;
        border-radius: 8px;
      }
      .frame-tab {
        flex: 1;
        text-align: center;
        padding: 8px;
        font-size: 14px;
        font-weight: 500;
        color: #555;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s ease-in-out;
      }
      .frame-tab.active {
        background-color: #ffffff;
        color: #000000;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .wb-category-header {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        cursor: pointer;
        background-color: #f0f2f5;
        font-weight: 600;
      }
      #phone-screen.dark-mode .wb-category-header {
        background-color: #2c2c2e;
      }
      .wb-category-header .arrow {
        font-size: 12px;
        margin-right: 8px;
        transition: transform 0.2s ease;
      }
      .wb-category-header.collapsed .arrow {
        transform: rotate(-90deg);
      }
      .wb-book-container {
        padding-left: 20px;
        max-height: 1000px;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }
      .wb-book-container.collapsed {
        max-height: 0;
      }
      .wb-book-container label {
        padding: 8px 12px;
      }
      .wb-category-header > span:last-of-type {
        font-size: 14px;
        font-weight: 700;
        color: var(--text-primary);
      }
      #world-book-checkboxes-container
        .wb-category-header:nth-of-type(6n + 1)
        .arrow {
        color: #007bff;
      }
      #world-book-checkboxes-container
        .wb-category-header:nth-of-type(6n + 2)
        .arrow {
        color: #28a745;
      }
      #world-book-checkboxes-container
        .wb-category-header:nth-of-type(6n + 3)
        .arrow {
        color: #fd7e14;
      }
      #world-book-checkboxes-container
        .wb-category-header:nth-of-type(6n + 4)
        .arrow {
        color: #6f42c1;
      }
      #world-book-checkboxes-container
        .wb-category-header:nth-of-type(6n + 5)
        .arrow {
        color: #dc3545;
      }
      #world-book-checkboxes-container
        .wb-category-header:nth-of-type(6n + 6)
        .arrow {
        color: #ffc107;
      }
      #video-call-floating-bubble {
        position: absolute;
        right: 20px;
        top: 150px;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        z-index: 999;
        cursor: pointer;
        border: 3px solid white;
        transition: transform 0.2s;
      }
      #video-call-floating-bubble:active {
        transform: scale(0.95);
      }
      #video-floating-avatar {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      #api-configs-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .api-config-item {
        background-color: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #phone-screen.dark-mode .api-config-item {
        background-color: #2c2c2e;
      }
      .api-config-item .config-main {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-grow: 1;
        overflow: hidden;
      }
      .api-config-item input[type="radio"] {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
        accent-color: var(--accent-color);
      }
      .api-config-item .config-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
        overflow: hidden;
      }
      .api-config-item .config-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 15px;
      }
      .api-config-item .config-url {
        font-size: 12px;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .api-config-item .config-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }
      .api-config-item .config-actions button {
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 5px;
        cursor: pointer;
        border: 1px solid transparent;
      }
      .api-config-item .config-actions .edit-btn {
        background-color: #e7f3ff;
        color: var(--accent-color);
      }
      .api-config-item .config-actions .delete-btn {
        background-color: #ffebee;
        color: #c62828;
      }
      .form-group-flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #phone-screen.dark-mode #world-book-list .list-item,
      #phone-screen.dark-mode #world-book-list .list-item .item-title,
      #phone-screen.dark-mode #world-book-list .list-item .item-content,
      #phone-screen.dark-mode .wb-book-container label,
      #phone-screen.dark-mode .wb-category-header {
        text-shadow: none !important;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        transform: translateZ(0);
      }
      body.dark-mode .modal-content,
      body.dark-mode .transfer-actions-content,
      body.dark-mode .battery-alert-content {
        background-color: #1c1c1e !important;
        color: #ffffff !important;
        border: 1px solid #38383a !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8) !important;
      }
      body.dark-mode .modal-header {
        border-bottom-color: #38383a !important;
        color: #fff !important;
      }
      body.dark-mode .modal-footer {
        border-top-color: #38383a !important;
      }
      body.dark-mode .modal-footer button {
        background-color: #2c2c2e !important;
        color: #fff !important;
        border: 1px solid #38383a !important;
      }
      body.dark-mode .modal-footer button.save,
      body.dark-mode .modal-footer .confirm-btn {
        background-color: var(--accent-color) !important;
        color: #fff !important;
        border: none !important;
      }
      body.dark-mode .modal-footer .cancel,
      body.dark-mode #custom-modal-cancel {
        color: #ff453a !important;
      }
      body.dark-mode input[type="text"],
      body.dark-mode input[type="number"],
      body.dark-mode input[type="password"],
      body.dark-mode input[type="datetime-local"],
      body.dark-mode textarea,
      body.dark-mode select,
      body.dark-mode .select-box {
        background-color: #2c2c2e !important;
        color: #ffffff !important;
        border: 1px solid #38383a !important;
      }
      body.dark-mode ::placeholder {
        color: #666;
      }
      body.dark-mode .form-group label {
        color: #aaaaaa !important;
      }
      body.dark-mode .select-box .arrow-down {
        color: #aaa;
      }
      body.dark-mode .checkboxes-container {
        background-color: #2c2c2e;
        border-color: #38383a;
      }
      body.dark-mode .checkboxes-container label:hover {
        background-color: #3a3a3c;
      }
      body.dark-mode #reset-theme-btn,
      body.dark-mode #reset-custom-css-btn,
      body.dark-mode #reset-frame-color-btn,
      body.dark-mode .avatar-upload button,
      body.dark-mode #manage-groups-btn,
      body.dark-mode #manage-members-btn,
      body.dark-mode #manage-ai-avatar-library-btn,
      body.dark-mode #open-persona-library-btn,
      body.dark-mode #remove-bg-btn {
        background-color: #3a3a3c !important;
        color: #fff !important;
        border: 1px solid #48484a !important;
      }
      body.dark-mode .theme-selector label {
        color: #ddd;
      }
      body.dark-mode hr {
        border-top-color: #38383a !important;
        opacity: 0.5;
      }
      body.dark-mode .link-share-card {
        background-color: #2c2c2e;
        border-color: #38383a;
      }
      body.dark-mode .link-share-card .title {
        color: #fff;
      }
      body.dark-mode .link-share-card .description {
        color: #aaa;
      }
      body.dark-mode .poll-card {
        background-color: #2c2c2e;
        border-color: #38383a;
        color: #fff;
      }
      body.dark-mode .poll-option-item {
        background-color: #3a3a3c;
        border-color: #48484a;
        color: #fff;
      }
      body.dark-mode .poll-footer {
        border-top-color: #38383a;
        color: #888;
      }
      body.dark-mode .message-editor-block {
        background-color: #2c2c2e;
        border-color: #38383a;
      }
      body.dark-mode .format-btn {
        background-color: #3a3a3c;
        color: #fff;
      }
      body.dark-mode #reply-preview-bar {
        background-color: rgba(255, 255, 255, 0.1);
      }
      body.dark-mode .reply-preview-content .sender {
        color: #fff;
      }
      body.dark-mode .music-player-window {
        background-color: rgba(30, 30, 30, 0.85);
        border-color: rgba(255, 255, 255, 0.1);
        color: #fff;
      }
      body.dark-mode #music-player-artist,
      body.dark-mode #music-time-counter {
        color: #aaa;
      }
      body.dark-mode .music-controls button,
      body.dark-mode #music-playlist-btn {
        color: #fff;
      }
      body.dark-mode .music-controls .play-pause-btn {
        background-color: rgba(255, 255, 255, 0.1);
      }
      body.dark-mode .lyric-line {
        color: #888;
      }
      body.dark-mode .lyric-line.active {
        color: #fff;
      }
      body.dark-mode #music-playlist-panel,
      body.dark-mode #sticker-panel {
        background-color: rgba(28, 28, 30, 0.95);
        border-top-color: #38383a;
      }
      body.dark-mode .playlist-header,
      body.dark-mode #sticker-panel-header {
        border-bottom-color: #38383a;
        color: #fff;
      }
      body.dark-mode .playlist-item {
        border-bottom-color: #38383a;
        color: #fff;
      }
      body.dark-mode .playlist-item.playing {
        background-color: rgba(255, 255, 255, 0.1);
      }
      body.dark-mode .playlist-item-info .artist {
        color: #aaa;
      }
      body.dark-mode .sticker-item {
        background-color: #3a3a3c;
        border-color: #38383a;
      }
      body.dark-mode #chat-lock-overlay {
        background-color: rgba(0, 0, 0, 0.85);
        border-top-color: #38383a;
      }
      body.dark-mode .lock-text {
        color: #ccc;
      }
      body.dark-mode .contact-picker-item,
      body.dark-mode .member-management-item {
        border-bottom-color: #38383a;
        color: #fff;
      }
      body.dark-mode #member-management-actions {
        background-color: #1c1c1e;
        border-top-color: #38383a;
      }
      body.dark-mode .api-config-item {
        background-color: #2c2c2e;
        border-color: #38383a;
      }
      body.dark-mode .api-config-item .config-name {
        color: #fff;
      }
      body.dark-mode .api-config-item .config-actions button {
        background-color: #3a3a3c;
        color: #fff;
      }
      body.dark-mode .api-config-item .config-actions .delete-btn {
        background-color: #5c1e1e;
        color: #ff9999;
      }
      body.dark-mode #red-packet-details-modal .modal-content {
        background-color: #1c1c1e !important;
      }
      body.dark-mode #rp-details-greeting {
        color: #fff !important;
      }
      body.dark-mode #rp-details-summary {
        color: #aaa !important;
        border-top-color: #38383a !important;
      }
      body.dark-mode .rp-details-item {
        border-bottom-color: #38383a;
      }
      body.dark-mode .rp-details-item .name {
        color: #fff;
      }
      body.dark-mode .rp-details-item .amount {
        color: #ddd;
      }
      body.dark-mode .frame-tabs {
        background-color: #2c2c2e;
      }
      body.dark-mode .frame-tab {
        color: #aaa;
      }
      body.dark-mode .frame-tab.active {
        background-color: #3a3a3c;
        color: #fff;
      }
      body.dark-mode .call-record-card {
        background-color: #1c1c1e;
        border: 1px solid #333;
      }
      body.dark-mode .call-record-card .custom-title {
        color: #fff;
        border-bottom-color: #333;
      }
      body.dark-mode .call-record-card .participants-names {
        color: #aaa;
      }
      body.dark-mode .transcript-entry.assistant {
        background-color: #2c2c2e;
        color: #fff;
      }
      body.dark-mode .transcript-entry.user {
        background-color: #1e4620;
        color: #fff;
      }
      body.dark-mode #custom-modal-body p {
        color: #ddd;
      }
      body.dark-mode #custom-modal-confirm {
        color: var(--accent-color);
      }
      body.dark-mode #preset-actions-modal button,
      body.dark-mode #message-actions-modal button,
      body.dark-mode #post-actions-modal button {
        background-color: #2c2c2e;
        color: #fff;
        border-bottom-color: #38383a;
      }
      body.dark-mode #preset-actions-modal button:last-child,
      body.dark-mode #message-actions-modal button:last-child,
      body.dark-mode #post-actions-modal button:last-child {
        background-color: #1c1c1e;
        margin-top: 8px;
      }
      body.dark-mode .wb-category-header > span:last-of-type,
      body.dark-mode .wb-book-container label {
        color: #fff;
      }
      body.dark-mode .custom-modal-body,
      body.dark-mode .custom-modal-body p {
        color: #e0e0e0 !important;
      }
      body.dark-mode #custom-modal .format-btn {
        background-color: #3a3a3c !important;
        color: #ffffff !important;
        border: 1px solid #48484a !important;
      }
      body.dark-mode #custom-modal .format-btn:hover {
        background-color: #48484a !important;
      }
      body.dark-mode .custom-modal-header {
        color: #ffffff !important;
        border-bottom: 1px solid #38383a !important;
      }
      body.dark-mode .custom-modal-footer {
        border-top-color: #38383a !important;
        border-top: 1px solid #38383a !important;
      }
      body.dark-mode .custom-modal-footer button:first-child {
        border-right-color: #38383a !important;
        border-right: 1px solid #38383a !important;
      }
      body.dark-mode #custom-modal input,
      body.dark-mode #custom-modal textarea {
        background-color: #2c2c2e !important;
        border: 1px solid #38383a !important;
        color: #ffffff !important;
      }
      body.dark-mode .existing-group-item .delete-group-btn {
        color: #ff453a !important;
      }
      body.dark-mode #new-category-name-input {
        background-color: #2c2c2e !important;
        border: 1px solid #38383a !important;
        color: #ffffff !important;
      }
      body.dark-mode #add-new-category-btn {
        background-color: #3a3a3c !important;
        border: 1px solid #48484a !important;
        color: #ffffff !important;
      }
      body.dark-mode #post-public-text,
      body.dark-mode #post-hidden-text,
      body.dark-mode #post-image-description {
        background-color: #2c2c2e !important;
        color: #ffffff !important;
        border: 1px solid #38383a !important;
      }
      body.dark-mode .post-mode-switcher {
        background-color: #2c2c2e !important;
        border: 1px solid #38383a;
      }
      body.dark-mode .mode-btn {
        color: #888888;
      }
      body.dark-mode .mode-btn.active {
        background-color: #3a3a3c !important;
        color: #ffffff !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      body.dark-mode .post-image-preview-container {
        background-color: #1c1c1e !important;
        border-color: #38383a !important;
      }
      body.dark-mode #post-visibility-groups {
        background-color: #2c2c2e !important;
        color: #ffffff !important;
        border: 1px solid #38383a;
      }
      body.dark-mode .transfer-content {
        background-color: #2a1c21 !important;
        border: 1px solid #4a2c36 !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9) !important;
        background-image: none !important;
      }
      body.dark-mode .transfer-header {
        color: #ff85b3 !important;
      }
      body.dark-mode .transfer-input-group input {
        background-color: #1a0f12 !important;
        color: #ffffff !important;
        border: 1px solid #4a2c36 !important;
      }
      body.dark-mode .transfer-input-group input:focus {
        border-color: #ff85b3 !important;
      }
      body.dark-mode .transfer-input-group label {
        color: #d18ca6 !important;
      }
      body.dark-mode #transfer-cancel-btn {
        background-color: #3d2b32 !important;
        color: #ff85b3 !important;
      }
      body.dark-mode #new-group-name-input {
        background-color: #2c2c2e !important;
        color: #ffffff !important;
        border: 1px solid #38383a !important;
      }
      body.dark-mode #add-new-group-btn {
        background-color: #3a3a3c !important;
        border: 1px solid #48484a !important;
        color: #ffffff !important;
      }
      body.dark-mode .existing-group-item {
        background-color: #2c2c2e !important;
        border-color: #38383a !important;
        color: #ffffff !important;
      }
      body.dark-mode #settings-preview-area {
        background-color: #000000 !important;
        border-color: #38383a !important;
      }
      body.dark-mode #settings-preview-area .message-bubble {
        color: #e0e0e0;
      }
      body.dark-mode #custom-prompt-input {
        background-color: #2c2c2e !important;
        color: #ffffff !important;
        border: 1px solid #38383a !important;
        caret-color: #0a84ff;
      }
      body.dark-mode #custom-prompt-input::placeholder {
        color: #666666 !important;
      }
      body.dark-mode #custom-modal-body {
        color: #e0e0e0 !important;
      }
      body.dark-mode #favorites-action-bar {
        background-color: rgba(25, 25, 25, 0.9) !important;
        border-top: 1px solid #38383a !important;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
      }
      body.dark-mode #favorites-delete-selected-btn {
        background-color: #ff453a !important;
        color: #ffffff !important;
      }
      body.dark-mode #custom-modal-body,
      body.dark-mode #custom-modal-body p {
        color: #e0e0e0 !important;
      }
      body.dark-mode #custom-modal {
        background-color: #1c1c1e !important;
        box-shadow:
          0 0 0 1px #38383a,
          0 10px 40px rgba(0, 0, 0, 0.8) !important;
        color: #ffffff !important;
        border: 1px solid #38383a !important;
      }
      body.dark-mode .custom-modal-footer button {
        background-color: transparent !important;
        color: #0a84ff !important;
      }
      body.dark-mode .custom-modal-footer .confirm-btn.btn-danger {
        color: #ff453a !important;
        font-weight: 600;
      }
      #phone-screen.dark-mode #world-book-list {
        background-color: #000000 !important;
      }
      #phone-screen.dark-mode .world-book-group-content .list-item,
      #phone-screen.dark-mode #world-book-list .list-item {
        background-color: #000000 !important;
        border-bottom: 1px solid #2c2c2e !important;
      }
      #phone-screen.dark-mode .world-book-group-content .list-item:hover,
      #phone-screen.dark-mode #world-book-list .list-item:hover {
        background-color: #1c1c1e !important;
      }
      #phone-screen.dark-mode .list-item .item-title {
        color: #ffffff !important;
        font-weight: 600;
        text-shadow: none !important;
      }
      #phone-screen.dark-mode .list-item .item-content {
        color: #8d8d92 !important;
        text-shadow: none !important;
      }
      #phone-screen.dark-mode .world-book-group-header {
        background-color: #1c1c1e !important;
        border-bottom: 1px solid #2c2c2e !important;
      }
      #phone-screen.dark-mode .world-book-group-header .group-name {
        color: #e0e0e0 !important;
        font-weight: 600;
      }
      #phone-screen.dark-mode .world-book-group-header .arrow {
        color: #8d8d92 !important;
      }
      #phone-screen.dark-mode .world-book-group-container {
        border-top-color: #2c2c2e !important;
        border-bottom-color: #2c2c2e !important;
        background-color: transparent !important;
      }
      #phone-screen.dark-mode #world-book-list * {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      #phone-screen.dark-mode .message-bubble.system-bubble,
      #phone-screen.dark-mode #typing-indicator .system-bubble {
        background-color: rgba(255, 255, 255, 0.15) !important;
        box-shadow: none !important;
      }
      /* Paging Logic */
      #home-screen {
        padding: 0 !important;
        display: block !important;
      }
      .home-screen-slider {
        display: flex;
        width: 100%;
        height: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        cursor: grab; /* Enable grab cursor for desktop */
      }
      .home-screen-slider:active {
        cursor: grabbing;
      }
      .home-screen-slider::-webkit-scrollbar {
        display: none;
      }
      .home-page {
        flex: 0 0 100%;
        width: 100%;
        height: 100%;
        scroll-snap-align: start;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 20px;
        padding-top: 80px;
        padding-bottom: 50px;
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <div id="phone-frame">
      <div class="notch"></div>
      <div id="phone-screen">
        <div id="status-bar">
          <span id="status-bar-time">12:00</span>
          <div id="status-bar-battery" class="battery-container">
            <span class="battery-text">--%</span>
            <div class="battery-icon">
              <div class="battery-level"></div>
            </div>
          </div>
        </div>
        <div id="video-call-floating-bubble" style="display: none">
          <img id="video-floating-avatar" src="" />
        </div>
        <div id="video-call-floating-bubble" style="display: none">
          <img id="video-floating-avatar" src="" />
        </div>
        <div id="video-call-floating-bubble" style="display: none">
          <img id="video-floating-avatar" src="" />
        </div>
        <div id="notification-bar">
          <img id="notification-avatar" src="" />
          <div id="notification-content">
            <div class="name"></div>
            <div class="message"></div>
          </div>
        </div>

        <div id="home-screen" class="screen active">
          <div class="home-screen-slider">
            <div class="home-page">
              <div id="clock-container">
                <div id="main-time">12:00</div>
                <div id="main-date">ÊòüÊúü‰∏Ä, 1Êúà1Êó•</div>
              </div>
              <div id="app-grid">
                <!-- Á¨¨‰∏ÄË°åÔºöÊîæ2‰∏™ÂõæÊ†á -->
                <div class="app-row">
                  <div
                    class="app-icon"
                    onclick="showScreen('world-book-screen')"
                  >
                    <div class="icon-bg">
                      <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÊ∑ªÂä†ID -->
                      <img
                        id="icon-img-world-book"
                        src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg"
                        alt="‰∏ñÁïå‰π¶"
                      />
                    </div>
                    <span class="label">‰∏ñÁïå‰π¶</span>
                  </div>
                  <div
                    class="app-icon"
                    onclick="showScreen('chat-list-screen')"
                  >
                    <div class="icon-bg">
                      <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÊ∑ªÂä†ID -->
                      <img
                        id="icon-img-qq"
                        src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg"
                        alt="QQ"
                      />
                    </div>
                    <span class="label">QQ</span>
                  </div>
                </div>
                <!-- Á¨¨‰∫åË°åÔºöÊîæ3‰∏™ÂõæÊ†á -->
                <div class="app-row">
                  <div
                    class="app-icon"
                    onclick="showScreen('api-settings-screen')"
                  >
                    <div class="icon-bg">
                      <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ3„ÄëÊ∑ªÂä†ID -->
                      <img
                        id="icon-img-api-settings"
                        src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg"
                        alt="APIËÆæÁΩÆ"
                      />
                    </div>
                    <span class="label">APIËÆæÁΩÆ</span>
                  </div>
                  <div
                    class="app-icon"
                    onclick="showScreen('wallpaper-screen')"
                  >
                    <div class="icon-bg">
                      <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ4„ÄëÊ∑ªÂä†ID -->
                      <img
                        id="icon-img-wallpaper"
                        src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg"
                        alt="Â§ñËßÇËÆæÁΩÆ"
                      />
                    </div>
                    <span class="label">Â§ñËßÇËÆæÁΩÆ</span>
                  </div>
                  <div
                    class="app-icon"
                    onclick="showScreen('font-settings-screen')"
                  >
                    <div class="icon-bg">
                      <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ5„ÄëÊ∑ªÂä†ID -->
                      <img
                        id="icon-img-font"
                        src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg"
                        alt="Â≠ó‰Ωì"
                      />
                    </div>
                    <span class="label">Â≠ó‰Ωì</span>
                  </div>
                </div>
              </div>
            </div>
            <!-- Close .home-page -->

            <div class="home-page">
              <div
                style="
                  width: 100%;
                  height: 100%;
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  flex-direction: column;
                  color: rgba(0, 0, 0, 0.3);
                  font-weight: 500;
                "
              >
                <div>Êõ¥Â§öÂ∫îÁî®Êï¨ËØ∑ÊúüÂæÖ</div>
              </div>
            </div>
          </div>
          <!-- Close .home-screen-slider -->

          <div
            class="home-screen-dots"
            style="
              position: absolute;
              bottom: 20px;
              left: 0;
              width: 100%;
              display: flex;
              justify-content: center;
              gap: 8px;
              z-index: 20;
              pointer-events: none;
            "
          >
            <div
              class="dot active"
              style="
                width: 8px;
                height: 8px;
                background: rgba(255, 255, 255, 0.9);
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
                border-radius: 50%;
                opacity: 1;
                transition: opacity 0.3s;
              "
            ></div>
            <div
              class="dot"
              style="
                width: 8px;
                height: 8px;
                background: rgba(255, 255, 255, 0.9);
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
                border-radius: 50%;
                opacity: 0.4;
                transition: opacity 0.3s;
              "
            ></div>
          </div>
        </div>

        <div id="world-book-screen" class="screen">
          <div class="header">
            <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
            <span>‰∏ñÁïå‰π¶</span>
            <div class="header-actions">
              <!-- „ÄêÊé®Ëçê„ÄëÁî®‰∏Ä‰∏™ÂÆπÂô®ÊääÊåâÈíÆÂåÖËµ∑Êù• -->
              <span class="action-btn" id="manage-world-book-categories-btn"
                >ÁÆ°ÁêÜÂàÜÁ±ª</span
              >
              <span class="action-btn" id="add-world-book-btn">+</span>
            </div>
          </div>
          <div id="world-book-list"></div>
        </div>
        <div id="world-book-editor-screen" class="screen">
          <div class="header">
            <span class="back-btn" onclick="showScreen('world-book-screen')"
              >‚Äπ</span
            >
            <span id="world-book-editor-title">ÁºñËæë‰∏ñÁïå‰π¶</span>
            <span class="save-btn" id="save-world-book-btn">‰øùÂ≠ò</span>
          </div>
          <div class="form-container">
            <div class="form-group">
              <label for="world-book-name-input">‰π¶Âêç</label>
              <input
                type="text"
                id="world-book-name-input"
                placeholder="ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÁöÑÂêçÁß∞..."
              />
            </div>

            <div class="form-group">
              <label for="world-book-category-select">ÂàÜÁ±ª</label>
              <select id="world-book-category-select">
                <!-- ÈÄâÈ°πÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
              </select>
            </div>

            <div class="form-group" style="height: 100%">
              <label for="world-book-content-input">ÂÜÖÂÆπ</label>
              <textarea
                id="world-book-content-input"
                placeholder="Âú®Ê≠§Â§ÑËæìÂÖ•ËØ¶ÁªÜÁöÑ‰∏ñÁïåËßÇËÆæÂÆö..."
              ></textarea>
            </div>
          </div>
        </div>

        <div id="api-settings-screen" class="screen">
          <div class="header">
            <span
              type="button"
              class="back-btn"
              onclick="showScreen('home-screen')"
              >‚Äπ</span
            >
            <span>API ËÆæÁΩÆ</span>
            <span style="width: 30px"></span>
          </div>
          <div class="form-container">
            <div class="form-group">
              <label>API ÈÖçÁΩÆÁÆ°ÁêÜ</label>
              <div id="api-configs-list">
                <!-- API ÈÖçÁΩÆÂàóË°®Â∞ÜÁî± JS Âä®ÊÄÅÁîüÊàê -->
              </div>
              <button
                type="button"
                class="form-button form-button-secondary"
                id="add-new-config-btn"
                style="margin-top: 15px"
              >
                + Ê∑ªÂä†Êñ∞ÈÖçÁΩÆ
              </button>
            </div>

            <hr style="margin: 20px 0; opacity: 0.3" />

            <div class="form-group form-group-flex">
              <label for="background-activity-switch" style="margin-bottom: 0">
                ÂêØÁî®ÂêéÂè∞ËßíËâ≤Ê¥ªÂä®
                <p
                  style="
                    font-size: 12px;
                    font-weight: normal;
                    color: #ff6b6b;
                    margin-top: 5px;
                  "
                >
                  Ë≠¶ÂëäÔºöÊ≠§ÂäüËÉΩ‰ºöÊòæËëóÂ¢ûÂä†APIË∞ÉÁî®ÂíåË¥πÁî®ÔºÅ
                </p>
              </label>
              <input
                type="checkbox"
                id="background-activity-switch"
                style="width: auto; height: 20px"
              />
            </div>
            <div class="form-group form-group-flex" style="margin-top: 10px">
              <label for="background-interval-input" style="margin-bottom: 0">
                ÂêéÂè∞Ê¥ªÂä®Ê£ÄÊµãÈó¥Èöî (Áßí)
                <p
                  style="
                    font-size: 12px;
                    font-weight: normal;
                    color: #999;
                    margin-top: 5px;
                  "
                >
                  Âª∫ËÆÆÂÄº 60-300„ÄÇÂÄºË∂äÂ§ßÔºåË¥πÁî®Ë∂ä‰ΩéÔºå‰ΩÜËßíËâ≤ÂèçÂ∫îË∂äÊÖ¢„ÄÇ
                </p>
              </label>
              <input
                type="number"
                id="background-interval-input"
                min="30"
                value="60"
                style="width: 80px; text-align: center"
              />
            </div>
            <div class="form-group form-group-flex" style="margin-top: 10px">
              <label for="block-cooldown-input" style="margin-bottom: 0">
                AIË¢´ÊãâÈªëÂêéÂÜ∑ÈùôÊúü (Â∞èÊó∂)
                <p
                  style="
                    font-size: 12px;
                    font-weight: normal;
                    color: #999;
                    margin-top: 5px;
                  "
                >
                  Ë¢´ÊãâÈªëË∂ÖËøáËøô‰∏™Êó∂Èó¥ÂêéÔºåAIÊâçÊúâÂá†ÁéáÈáçÊñ∞Áî≥ËØ∑Â•ΩÂèã„ÄÇ
                </p>
              </label>
              <input
                type="number"
                id="block-cooldown-input"
                min="0.1"
                step="0.1"
                value="1"
                style="width: 80px; text-align: center"
              />
            </div>

            <hr style="margin: 20px 0; opacity: 0.3" />

            <button type="button" class="form-button" id="export-data-btn">
              ÂØºÂá∫Êï∞ÊçÆ
            </button>
            <button type="button" class="form-button" id="import-btn">
              ÂØºÂÖ•Â§á‰ªΩÊñá‰ª∂
            </button>
            <input
              id="import-data-input"
              type="file"
              accept="application/json"
              hidden
            />
          </div>
        </div>
        <div id="chat-list-screen" class="screen">
          <!-- ‰∏ªÂ§¥ÈÉ® (Âè™Âú®Ê∂àÊÅØÂàóË°®ÊòæÁ§∫) -->
          <div class="header" id="main-chat-list-header">
            <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
            <span id="chat-list-title">Ê∂àÊÅØ</span>
            <div class="header-actions">
              <span class="action-btn" id="add-group-chat-btn" title="ÂàõÂª∫Áæ§ËÅä"
                ><svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M21 21L19 19"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  /></svg
              ></span>
              <span class="action-btn" id="add-chat-btn">+</span>
            </div>
          </div>

          <!-- Ê∂àÊÅØÂàóË°®ËßÜÂõæ -->
          <div id="messages-view" class="chat-list-view active">
            <div id="chat-list">
              <!-- JS‰ºöÂú®ËøôÈáåÁîüÊàêËÅäÂ§©ÂàóË°® -->
            </div>
          </div>

          <!-- Âä®ÊÄÅÁïåÈù¢ËßÜÂõæ -->
          <div id="qzone-screen" class="chat-list-view">
            <div class="qzone-header">
              <span class="back-btn" id="qzone-back-btn">‚Äπ</span>
              <!-- Ëøô‰∏™ÊåâÈíÆÁé∞Âú®Âè™Ë¥üË¥£‰ªéÂä®ÊÄÅËøîÂõû -->
              <span>Â•ΩÂèãÂä®ÊÄÅ</span>
            </div>
            <div class="qzone-content">
              <div class="qzone-profile-header">
                <div id="qzone-banner-container" class="qzone-banner-container">
                  <img
                    id="qzone-banner-img"
                    src="https://files.catbox.moe/r5heyt.gif"
                    alt="ËÉåÊôØ"
                  />
                  <input
                    type="file"
                    id="qzone-banner-input"
                    accept="image/*"
                    hidden
                  />
                </div>
                <div class="qzone-user-info">
                  <div
                    id="qzone-avatar-container"
                    class="qzone-avatar-container"
                  >
                    <img
                      id="qzone-avatar-img"
                      src="https://files.catbox.moe/q6z5fc.jpeg"
                      alt="Â§¥ÂÉè"
                    />
                    <input
                      type="file"
                      id="qzone-avatar-input"
                      accept="image/*"
                      hidden
                    />
                  </div>
                  <span id="qzone-nickname">{{user}}</span>
                </div>
              </div>
              <div class="qzone-actions-bar">
                <div class="action-item" id="create-shuoshuo-btn">
                  <span>ËØ¥ËØ¥</span>
                </div>
                <div class="action-item" id="create-post-btn">
                  <span>Âä®ÊÄÅ</span>
                </div>
                <div class="action-item" id="open-album-btn">
                  <span>Áõ∏ÂÜå</span>
                </div>
              </div>
              <div id="qzone-posts-list"></div>
            </div>
          </div>

          <!-- Êî∂ËóèÁïåÈù¢ËßÜÂõæ -->
          <div id="favorites-view" class="chat-list-view">
            <div class="header">
              <span class="back-btn" id="favorites-back-btn">‚Äπ</span>
              <span>ÊàëÁöÑÊî∂Ëóè</span>
              <!-- Êñ∞Â¢ûÁöÑÁºñËæëÊåâÈíÆ -->
              <span class="action-btn" id="favorites-edit-btn">ÁºñËæë</span>
            </div>

            <!-- „ÄêÊñ∞Â¢û„ÄëÊêúÁ¥¢Ê†èÂÆπÂô® -->
            <div class="search-bar-container">
              <input
                type="search"
                id="favorites-search-input"
                placeholder="ÊêúÁ¥¢Êî∂ËóèÁöÑÊ†áÈ¢ò„ÄÅÂÜÖÂÆπÊàñ‰ΩúËÄÖ..."
              />
              <button
                id="favorites-search-clear-btn"
                class="search-clear-btn"
                style="display: none"
              >
                √ó
              </button>
            </div>

            <div id="favorites-list" class="list-container">
              <!-- Êî∂ËóèÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>

            <!-- Êñ∞Â¢ûÔºöÊî∂ËóèÈ°µÂ∫ïÈÉ®Êìç‰ΩúÊ†è -->
            <div id="favorites-action-bar" style="display: none">
              <button id="favorites-delete-selected-btn" class="action-bar-btn">
                Âà†Èô§ (0)
              </button>
            </div>
          </div>

          <div id="memories-view" class="chat-list-view">
            <div class="header">
              <span class="back-btn" id="memories-back-btn">‚Äπ</span>
              <span>Êàë‰ª¨ÁöÑÂõûÂøÜ</span>
              <span class="action-btn" id="add-countdown-btn">+</span>
            </div>
            <div
              id="memories-list"
              class="list-container"
              style="
                padding: 15px;
                display: flex;
                flex-direction: column;
                gap: 15px;
              "
            >
              <!-- ÂõûÂøÜÂç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
          </div>

          <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
          <div id="chat-list-bottom-nav">
            <div class="nav-item active" data-view="messages-view">
              <span>Ê∂àÊÅØ</span>
            </div>
            <div class="nav-item" data-view="qzone-screen">
              <span>Âä®ÊÄÅ</span>
            </div>
            <div class="nav-item" data-view="memories-view">
              <span>ÂõûÂøÜ</span>
            </div>
            <div class="nav-item" data-view="favorites-view">
              <span>Êî∂Ëóè</span>
            </div>
          </div>
        </div>

        <div id="album-screen" class="screen">
          <!-- 1. È°µÈù¢Â§¥ÈÉ®ÔºåÂåÖÂê´ËøîÂõûÊåâÈíÆÂíåÊ†áÈ¢ò -->
          <div class="header">
            <span class="back-btn" id="album-back-btn">‚Äπ</span>
            <span>ÊàëÁöÑÁõ∏ÂÜå</span>
            <span class="action-btn" id="create-album-btn-page">+</span>
          </div>

          <!-- 2. È°µÈù¢ÂÜÖÂÆπÂÆπÂô® -->
          <div class="list-container">
            <div id="album-grid-page">
              <!-- Áõ∏ÂÜåÂàóË°®Â∞ÜÁî± JS Âä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
          </div>
        </div>

        <div id="album-photos-screen" class="screen">
          <!-- 1. È°µÈù¢Â§¥ÈÉ® -->
          <div class="header">
            <span class="back-btn" id="album-photos-back-btn">‚Äπ</span>
            <span id="album-photos-title">Áõ∏ÂÜåÂêçÁß∞</span>
            <span class="action-btn" id="album-upload-photo-btn">‰∏ä‰º†</span>
          </div>

          <!-- 2. È°µÈù¢ÂÜÖÂÆπÂÆπÂô® -->
          <div class="list-container">
            <div id="photos-grid-page">
              <!-- ÁÖßÁâáÂàóË°®Â∞ÜÁî± JS Âä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>

            <div id="photo-viewer-modal" class="modal">
              <!-- 1. ÂÖ≥Èó≠ÊåâÈíÆ -->
              <button id="photo-viewer-close-btn">√ó</button>

              <!-- 2. ‰∏ä‰∏ÄÂº†ÁÖßÁâáÊåâÈíÆ -->
              <button id="photo-viewer-prev-btn" class="nav-arrow">‚Äπ</button>

              <!-- 3. ÂõæÁâáÂÆπÂô® -->
              <div class="photo-viewer-content">
                <img id="photo-viewer-image" src="" alt="ÂÖ®Â±èÁÖßÁâáÈ¢ÑËßà" />
              </div>

              <!-- 4. ‰∏ã‰∏ÄÂº†ÁÖßÁâáÊåâÈíÆ -->
              <button id="photo-viewer-next-btn" class="nav-arrow">‚Ä∫</button>
            </div>
          </div>
        </div>

        <input
          type="file"
          id="album-photo-input"
          accept="image/*"
          multiple
          hidden
        />

        <div id="chat-interface-screen" class="screen">
          <!-- „ÄêÊúÄÁªà‰øÆÊ≠£Áâà„ÄëHeaderÔºåÂ∑≤Â∞ÜÁä∂ÊÄÅÊ†èÂíåÊêúÁ¥¢ÂäüËÉΩÊ≠£Á°ÆÊï¥Âêà -->
          <div class="header">
            <!-- ÈªòËÆ§Êéß‰ª∂ÔºöÂåÖÂê´Ê†áÈ¢ò„ÄÅÁä∂ÊÄÅÊ†èÂíåÂ∏∏ËßÑÊåâÈíÆ -->
            <div class="default-controls">
              <span class="back-btn" id="back-to-list-btn">‚Äπ</span>

              <div id="chat-header-title-wrapper">
                <span id="chat-header-title">ËÅäÂ§©ÂØπË±°</span>
                <div id="chat-header-status">
                  <span class="status-dot"></span>
                  <span class="status-text">Âú®Á∫ø</span>
                </div>
              </div>

              <div class="header-actions">
                <span class="action-btn" id="listen-together-btn" title="‰∏ÄËµ∑Âê¨"
                  ><img
                    src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png"
                    alt="‰∏ÄËµ∑Âê¨"
                /></span>
                <span class="action-btn" id="chat-settings-btn" title="ËÅäÂ§©ËÆæÁΩÆ"
                  ><img
                    src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png"
                    alt="ËÆæÁΩÆ"
                /></span>
              </div>
            </div>

            <!-- Â§öÈÄâÊ®°ÂºèÊéß‰ª∂ (‰øùÊåÅ‰∏çÂèò) -->
            <div class="selection-controls">
              <span id="selection-cancel-btn">ÂèñÊ∂à</span>
              <span id="selection-count"></span>
              <div class="header-actions">
                <span id="selection-favorite-btn" class="action-btn">Êî∂Ëóè</span>
                <span id="selection-share-btn" class="action-btn">ÂàÜ‰∫´</span>
                <span
                  id="selection-delete-btn"
                  class="action-btn"
                  style="color: #ff3b30"
                  >Âà†Èô§</span
                >
              </div>
            </div>
          </div>

          <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü (‰øùÊåÅ‰∏çÂèò) -->
          <div id="chat-messages">
            <div id="typing-indicator">ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...</div>
          </div>

          <!-- ËæìÂÖ•Âå∫Âüü (‰øùÊåÅ‰∏çÂèò) -->
          <div id="chat-input-area">
            <div id="reply-preview-bar">
              <div class="reply-preview-content">
                <div class="sender">ÂõûÂ§ç xxx:</div>
                <div class="text">Ë¢´ÂºïÁî®ÁöÑÊ∂àÊÅØÂÜÖÂÆπ...</div>
              </div>
              <span id="cancel-reply-btn">√ó</span>
            </div>
            <div id="chat-input-actions-top">
              <button
                id="open-sticker-panel-btn"
                class="chat-action-icon-btn action-button"
                title="Ë°®ÊÉÖÈù¢Êùø"
              >
                +
              </button>
              <button
                id="send-photo-btn"
                class="chat-action-icon-btn action-button"
                title="ÂèëÈÄÅÁÖßÁâá"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                  />
                  <circle cx="12" cy="13" r="4" />
                </svg>
              </button>
              <button
                id="upload-image-btn"
                class="chat-action-icon-btn action-button"
                title="‰∏ä‰º†ÂõæÁâá"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  style="color: var(--text-primary)"
                >
                  <path
                    d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
              <button
                id="transfer-btn"
                class="chat-action-icon-btn action-button"
                title="ËΩ¨Ë¥¶"
              >
                Ôø•
              </button>
              <button
                id="voice-message-btn"
                class="chat-action-icon-btn action-button"
                title="ÂèëÈÄÅËØ≠Èü≥"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
                  />
                  <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                  <path d="M12 19v4" />
                  <path d="M8 23h8" />
                </svg>
              </button>
              <button
                id="send-waimai-request-btn"
                class="chat-action-icon-btn action-button"
                title="ÂèëËµ∑Â§ñÂçñËØ∑Ê±Ç"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"
                  />
                  <line x1="3" y1="6" x2="21" y2="6" />
                  <path d="M16 10a4 4 0 0 1-8 0" />
                </svg>
              </button>
              <button
                id="video-call-btn"
                class="chat-action-icon-btn action-button"
                title="ËßÜÈ¢ëÈÄöËØù"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polygon points="23 7 16 12 23 17 23 7"></polygon>
                  <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                </svg>
              </button>
              <button
                id="group-video-call-btn"
                class="chat-action-icon-btn action-button"
                title="Áæ§ËßÜÈ¢ëÈÄöËØù"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </button>
              <button
                id="send-poll-btn"
                class="chat-action-icon-btn action-button"
                title="ÂèëËµ∑ÊäïÁ•®"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M8 6h10" />
                  <path d="M6 6h.01" />
                  <path d="M8 12h10" />
                  <path d="M6 12h.01" />
                  <path d="M8 18h10" />
                  <path d="M6 18h.01" />
                </svg>
              </button>
              <button
                id="share-link-btn"
                class="chat-action-icon-btn action-button"
                title="ÂàÜ‰∫´ÈìæÊé•"
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"
                  ></path>
                  <path
                    d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"
                  ></path>
                </svg>
              </button>
            </div>
            <div id="chat-input-main-row">
              <textarea
                id="chat-input"
                rows="1"
                placeholder="ËæìÂÖ•Ê∂àÊÅØ..."
              ></textarea>
              <div id="input-actions-wrapper">
                <button id="wait-reply-btn" title="Á≠âÂæÖÂõûÂ§ç">
                  <img
                    src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png"
                    alt="Á≠âÂæÖÂõûÂ§ç"
                  />
                </button>
                <button id="send-btn" class="action-button">ÂèëÈÄÅ</button>
              </div>
            </div>
          </div>

          <div id="chat-lock-overlay">
            <div id="chat-lock-content"></div>
          </div>

          <!-- Ë°®ÊÉÖÈù¢Êùø (‰øùÊåÅ‰∏çÂèò) -->
          <div id="sticker-panel">
            <div id="sticker-panel-header">
              <span class="panel-btn" id="close-sticker-panel-btn">ÂèñÊ∂à</span>
              <span class="title">ÊàëÁöÑË°®ÊÉÖ</span>
              <div style="display: flex; gap: 10px">
                <span class="panel-btn" id="add-sticker-btn">Ê∑ªÂä†</span>
                <span class="panel-btn" id="upload-sticker-btn">‰∏ä‰º†</span>
              </div>
            </div>
            <div id="sticker-grid"></div>
          </div>
          <input
            type="file"
            id="sticker-upload-input"
            accept="image/*"
            style="display: none"
          />
          <input
            type="file"
            id="image-upload-input"
            accept="image/*"
            style="display: none"
          />

          <!-- Èü≥‰πêÊí≠ÊîæÂô® (‰øùÊåÅ‰∏çÂèò) -->
          <div id="music-player-overlay">
            <div class="music-player-window">
              <!-- 1. È°∂ÈÉ®Êìç‰ΩúÊ†è -->
              <div class="music-player-top-actions">
                <div class="top-left-cluster">
                  <button id="music-return-btn">‚Äπ</button>
                  <button id="music-exit-btn">√ó</button>
                </div>
                <span id="music-playlist-btn">‚ò∞</span>
              </div>

              <!-- 2. Ê≠åÊõ≤‰ø°ÊÅØ -->
              <div id="music-time-counter">Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü0.0Â∞èÊó∂</div>
              <div id="music-player-song-title">ËØ∑Ê∑ªÂä†Ê≠åÊõ≤</div>
              <div id="music-player-artist">...</div>

              <!-- 3. „ÄêÂÖ®Êñ∞„ÄëÊ≠åËØçÊòæÁ§∫Âå∫Âüü -->
              <div id="music-lyrics-container">
                <div id="music-lyrics-list">
                  <!-- Ê≠åËØçÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                  <div class="lyric-line">‚ô™ ÊöÇÊó†Ê≠åËØç ‚ô™</div>
                </div>
              </div>

              <!-- 4. „ÄêÂÖ®Êñ∞„ÄëÊí≠ÊîæÊéßÂà∂Âå∫ÁöÑÂåÖË£πÂÆπÂô® -->
              <div class="music-player-controls-wrapper">
                <!-- a. Êñ∞ÁöÑiOSÈ£éÊ†ºËøõÂ∫¶Êù° -->
                <div class="music-progress-bar-container">
                  <div id="music-current-time" class="time-display">0:00</div>
                  <div class="progress-bar">
                    <div
                      id="music-progress-fill"
                      class="progress-bar-fill"
                    ></div>
                  </div>
                  <div id="music-total-time" class="time-display">0:00</div>
                </div>

                <!-- b. Êí≠ÊîæÊéßÂà∂ÊåâÈíÆ -->
                <div class="music-controls">
                  <button id="music-prev-btn">‚óÄ</button>
                  <button id="music-play-pause-btn" class="play-pause-btn">
                    ‚ñ∂
                  </button>
                  <button id="music-next-btn">‚ñ∂</button>
                  <button id="music-mode-btn">È°∫Â∫è</button>
                </div>
              </div>
            </div>
          </div>

          <div id="music-playlist-panel">
            <div class="playlist-header">
              <span class="panel-btn" id="close-playlist-btn">ËøîÂõû</span>
              <span>Êí≠ÊîæÂàóË°®</span>
              <div>
                <span class="panel-btn" id="add-song-local-btn">Êú¨Âú∞</span>
                <span class="panel-btn" id="add-song-url-btn">URL</span>
              </div>
            </div>
            <div class="playlist-body" id="playlist-body"></div>
          </div>
          <input
            type="file"
            id="local-song-upload-input"
            accept="audio/*"
            multiple
            style="display: none"
          />
          <input
            type="file"
            id="lrc-upload-input"
            accept=".lrc"
            style="display: none"
          />
        </div>

        <div id="wallpaper-screen" class="screen">
          <div class="header">
            <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
            <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÊ†áÈ¢òÊîπ‰∏∫‚ÄúÂ§ñËßÇËÆæÁΩÆ‚ÄùÔºåÊõ¥ÈÄöÁî® -->
            <span>Â§ñËßÇËÆæÁΩÆ</span>
            <span style="width: 30px"></span>
          </div>
          <div class="form-container">
            <!-- Â£ÅÁ∫∏ËÆæÁΩÆÈÉ®ÂàÜ‰øùÊåÅ‰∏çÂèò -->
            <div id="wallpaper-preview">ÁÇπÂáª‰∏ãÊñπ‰∏ä‰º†</div>
            <button
              class="form-button"
              onclick="
                document.getElementById('wallpaper-upload-input').click()
              "
            >
              ‰∏ä‰º†Â£ÅÁ∫∏
            </button>
            <input type="file" id="wallpaper-upload-input" accept="image/*" />

            <div
              class="form-group"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <label for="theme-toggle-switch" style="margin-bottom: 0"
                >Â§úÈó¥Ê®°Âºè</label
              >
              <label class="toggle-switch">
                <input type="checkbox" id="theme-toggle-switch" />
                <span class="slider"></span>
              </label>
            </div>

            <div class="form-group">
              <label for="frame-color-input">
                ÊâãÊú∫ËæπÊ°ÜÈ¢úËâ≤
                <button
                  id="reset-frame-color-btn"
                  type="button"
                  style="
                    background: none;
                    border: 1px solid #ccc;
                    color: #555;
                    font-size: 12px;
                    padding: 2px 8px;
                    border-radius: 5px;
                    cursor: pointer;
                    margin-left: 10px;
                  "
                >
                  ÈáçÁΩÆ
                </button>
              </label>
              <div style="display: flex; align-items: center; gap: 10px">
                <input
                  type="color"
                  id="frame-color-input"
                  value="#ffffff"
                  style="
                    width: 50px;
                    height: 40px;
                    padding: 0;
                    border: none;
                    cursor: pointer;
                  "
                />
                <span id="frame-color-value" style="font-family: monospace"
                  >#ffffff</span
                >
              </div>
            </div>

            <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÊñ∞Â¢ûÂõæÊ†áËÆæÁΩÆÂå∫Âüü -->
            <hr style="width: 80%; opacity: 0.3; margin: 30px 0" />
            <div style="width: 100%; text-align: left; margin-bottom: 15px">
              <label style="font-weight: 500; color: var(--text-secondary)"
                >App ÂõæÊ†áËÆæÁΩÆ</label
              >
            </div>
            <div id="icon-settings-grid">
              <!-- ÂõæÊ†áËÆæÁΩÆÈ°πÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>

            <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ3„ÄëÊåâÈíÆÊñáÂ≠ó‰πüÊîπ‰∏Ä‰∏ã -->
            <button
              class="form-button"
              id="save-wallpaper-btn"
              style="margin-top: 30px"
            >
              ‰øùÂ≠òÊâÄÊúâÂ§ñËßÇËÆæÁΩÆ
            </button>
          </div>
        </div>

        <div id="browser-screen" class="screen">
          <div class="header">
            <span class="back-btn" id="browser-back-btn">‚Äπ</span>
            <span id="browser-title"></span>
            <span style="width: 30px"></span>
          </div>
          <div id="browser-content" class="list-container">
            <!-- ÊñáÁ´†ÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
          </div>
        </div>

        <div id="font-settings-screen" class="screen">
          <div class="header">
            <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
            <span>Â≠ó‰ΩìËÆæÁΩÆ</span>
            <span style="width: 30px"></span>
          </div>
          <div class="form-container">
            <div class="form-group">
              <label for="font-url-input"
                >Â≠ó‰ΩìÊñá‰ª∂URL (.ttf, .otf, .woffÁ≠â)</label
              >
              <input
                type="text"
                id="font-url-input"
                placeholder="https://..../font.ttf"
              />
            </div>

            <div class="form-group">
              <label>ÂÆûÊó∂È¢ÑËßà</label>
              <div id="font-preview">
                <p style="font-size: 20px; margin: 0 0 10px 0">
                  ‰Ω†Â•Ω‰∏ñÁïå Hello World
                </p>
                <p style="margin: 0">ËøôÊòØÂ≠ó‰ΩìÈ¢ÑËßàÊïàÊûúÔºå12345„ÄÇ</p>
              </div>
            </div>

            <button class="form-button" id="save-font-btn">‰øùÂ≠òÂπ∂Â∫îÁî®</button>
            <button
              class="form-button form-button-secondary"
              id="reset-font-btn"
            >
              ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì
            </button>
          </div>
        </div>

        <div id="contact-picker-screen" class="screen">
          <div class="header">
            <span class="back-btn" id="cancel-contact-picker-btn">ÂèñÊ∂à</span>
            <span>ÈÄâÊã©ËÅîÁ≥ª‰∫∫</span>
            <span class="save-btn" id="confirm-contact-picker-btn"
              >ÂÆåÊàê(0)</span
            >
          </div>
          <div class="list-container" id="contact-picker-list">
            <!-- ËÅîÁ≥ª‰∫∫ÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
          </div>
        </div>

        <div id="member-management-screen" class="screen">
          <div class="header">
            <span class="back-btn" id="back-from-member-management">‚Äπ</span>
            <span>Áæ§ÊàêÂëòÁÆ°ÁêÜ</span>
            <span style="width: 30px"></span>
          </div>
          <div class="list-container" id="member-management-list">
            <!-- Áé∞ÊúâÊàêÂëòÂàóË°®‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
          </div>
          <div id="member-management-actions">
            <button id="add-existing-contact-btn">‰ªéÂ•ΩÂèãÂàóË°®Ê∑ªÂä†</button>
            <button id="create-new-member-btn">ÂàõÂª∫Áæ§ÂÜÖÊñ∞ÊàêÂëò</button>
          </div>
        </div>

        <div id="incoming-call-modal" class="modal">
          <div class="incoming-call-content">
            <img id="caller-avatar" class="caller-avatar" src="" />
            <div id="caller-name" class="caller-name"></div>
            <div class="caller-text">ÈÇÄËØ∑‰Ω†ËßÜÈ¢ëÈÄöËØù</div>
            <div class="incoming-call-actions">
              <div class="action-button-wrapper">
                <button
                  id="decline-call-btn"
                  class="call-action-btn decline"
                ></button>
                <span>ÊãíÁªù</span>
              </div>
              <div class="action-button-wrapper">
                <button
                  id="accept-call-btn"
                  class="call-action-btn accept"
                ></button>
                <span>Êé•Âê¨</span>
              </div>
            </div>
          </div>
        </div>

        <div id="video-call-screen" class="screen">
          <div
            id="text-call-interface"
            style="
              display: flex;
              flex-direction: column;
              height: 100%;
              width: 100%;
            "
          >
            <!-- 1. È°∂ÈÉ®Ê†è (‰øùÊåÅ‰∏çÂèò) -->
            <div class="video-call-top-bar">
              <span id="call-timer">00:00</span>
            </div>

            <!-- 2. „ÄêÂçáÁ∫ß„ÄëÂèÇ‰∏éËÄÖÂ§¥ÂÉèÁΩëÊ†ºÂå∫Âüü -->
            <div class="video-call-avatar-area">
              <div id="participant-avatars-grid">
                <!-- JS‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÂ§¥ÂÉè -->
              </div>
            </div>

            <!-- 3. ÂØπËØùÊ°ÜÂå∫Âüü (‰øùÊåÅ‰∏çÂèò) -->
            <div id="video-call-main" class="video-call-main">
              <!-- ÂØπËØùÂÜÖÂÆπ‰ºöÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>

            <!-- 4. „ÄêÂçáÁ∫ß„ÄëÂ∫ïÈÉ®ÊéßÂà∂Ê†èÔºåÁé∞Âú®ÂåÖÂê´‰∏Ä‰∏™‚ÄúÂä†ÂÖ•‚ÄùÊåâÈíÆ -->
            <div class="video-call-controls">
              <button
                id="user-speak-btn"
                class="control-btn speak-btn"
              ></button>
              <button id="hang-up-btn" class="control-btn hangup-btn"></button>
              <!-- Ëøô‰∏™ÊåâÈíÆÈªòËÆ§ÈöêËóèÔºåÂè™Âú®Áî®Êà∑‚ÄúÊóÅËßÇ‚ÄùÊó∂ÊòæÁ§∫ -->
              <button
                id="join-call-btn"
                class="control-btn join-btn"
                style="display: none"
              ></button>
            </div>
          </div>
        </div>

        <div id="outgoing-call-screen" class="screen">
          <div class="outgoing-call-content">
            <img id="outgoing-call-avatar" class="caller-avatar" src="" />
            <div id="outgoing-call-name" class="caller-name"></div>
            <div class="caller-text">Ê≠£Âú®ÂëºÂè´...</div>
            <div class="outgoing-call-actions">
              <button
                id="cancel-call-btn"
                class="call-action-btn decline"
              ></button>
              <span>ÂèñÊ∂à</span>
            </div>
          </div>
        </div>

        <div id="call-history-screen" class="screen">
          <div class="header">
            <span class="back-btn" id="call-history-back-btn">‚Äπ</span>
            <span id="call-history-title">ÈÄöËØùËÆ∞ÂΩï</span>
            <span style="width: 30px"></span>
            <!-- Âç†‰ΩçÁ¨¶Ôºå‰øùÊåÅÊ†áÈ¢òÂ±Ö‰∏≠ -->
          </div>
          <div
            id="call-history-list"
            class="list-container"
            style="
              padding: 15px;
              display: flex;
              flex-direction: column;
              gap: 15px;
            "
          >
            <!-- ÈÄöËØùËÆ∞ÂΩïÂç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
          </div>
        </div>
      </div>
    </div>

    <div id="chat-settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><span>ËÅäÂ§©ËÆæÁΩÆ</span></div>
        <div class="modal-body">
          <div class="form-group" id="chat-name-group">
            <label for="chat-name-input">Â§áÊ≥®Âêç / Áæ§Âêç</label
            ><input type="text" id="chat-name-input" />
          </div>

          <div class="form-group" id="ai-remark-group" style="display: none">
            <label for="ai-remark-input">AIÂ§áÊ≥® (‰ªÖËá™Â∑±ÂèØËßÅ)</label>
            <input
              type="text"
              id="ai-remark-input"
              placeholder="‰æãÂ¶ÇÔºöË¥¥ÂøÉÂ∞èÊ£âË¢Ñ"
            />
          </div>

          <div
            class="form-group"
            id="assign-group-section"
            style="display: none"
          >
            <!-- ÈªòËÆ§ÈöêËóèÔºåÂè™ÂØπÂçïËÅäÊòæÁ§∫ -->
            <label for="assign-group-select">Â•ΩÂèãÂàÜÁªÑ</label>
            <div style="display: flex; align-items: center; gap: 10px">
              <select id="assign-group-select" style="flex-grow: 1">
                <!-- ÂàÜÁªÑÈÄâÈ°πÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
              </select>
              <button
                id="manage-groups-btn"
                class="form-button-secondary"
                style="margin-top: 0; padding: 12px"
              >
                ÁÆ°ÁêÜÂàÜÁªÑ
              </button>
            </div>
          </div>

          <div class="form-group" id="my-group-nickname-group">
            <label for="my-group-nickname-input">ÊàëÁöÑÁæ§ÊòµÁß∞</label
            ><input type="text" id="my-group-nickname-input" />
          </div>
          <div class="form-group" id="group-avatar-group">
            <label>Áæ§Â§¥ÂÉè</label>
            <div class="avatar-upload">
              <img id="group-avatar-preview" /><button
                onclick="document.getElementById('group-avatar-input').click()"
              >
                ‰∏ä‰º†Áæ§Â§¥ÂÉè</button
              ><input type="file" id="group-avatar-input" accept="image/*" />
            </div>
          </div>
          <div class="form-group" id="world-book-link-group">
            <label>ÂÖ≥ËÅî‰∏ñÁïå‰π¶ (ÂèØÂ§öÈÄâ)</label>
            <div class="custom-multiselect">
              <div class="select-box">
                <span class="selected-options-text">-- ÁÇπÂáªÈÄâÊã© --</span>
              </div>
              <div
                id="world-book-checkboxes-container"
                class="checkboxes-container"
              ></div>
            </div>
          </div>
          <div class="form-group" id="ai-persona-group">
            <label for="ai-persona">ÂØπÊñπ‰∫∫ËÆæ (AI Persona)</label
            ><textarea id="ai-persona" rows="3"></textarea>
          </div>
          <div class="form-group" id="ai-avatar-group">
            <label>ÂØπÊñπÂ§¥ÂÉè</label>
            <div class="avatar-upload">
              <img id="ai-avatar-preview" /><button
                onclick="document.getElementById('ai-avatar-input').click()"
              >
                ‰∏ä‰º†ÂØπÊñπÂ§¥ÂÉè</button
              ><button id="manage-ai-avatar-library-btn">ÁÆ°ÁêÜÂ§¥ÂÉèÂ∫ì</button>
              <input type="file" id="ai-avatar-input" accept="image/*" />
            </div>
          </div>

          <div class="form-group" id="video-call-settings-group">
            <hr style="opacity: 0.2; margin: 15px 0" />

            <label
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-top: 15px;
              "
            >
              <span>ËØ≠Èü≥Êé•ÂÖ• (Minimax)</span>
              <input
                type="checkbox"
                id="video-call-voice-access-switch"
                style="width: auto"
              />
            </label>
          </div>
          <div class="form-group" id="my-persona-group">
            <label for="my-persona">ÊàëÁöÑ‰∫∫ËÆæ (My Persona)</label
            ><textarea id="my-persona" rows="3"></textarea>
          </div>
          <div class="form-group" id="my-avatar-group">
            <label>ÊàëÁöÑÂ§¥ÂÉè</label>
            <div class="avatar-upload">
              <img id="my-avatar-preview" /><button
                onclick="document.getElementById('my-avatar-input').click()"
              >
                ‰∏ä‰º†ÊàëÁöÑÂ§¥ÂÉè</button
              ><button id="open-persona-library-btn">È¢ÑËÆæ</button
              ><input type="file" id="my-avatar-input" accept="image/*" />
            </div>
          </div>
          <div class="form-group" id="group-members-group">
            <label>Áæ§ÊàêÂëò‰∫∫ËÆæ</label>
            <div id="group-members-settings"></div>

            <!-- „ÄêÊñ∞Â¢û„ÄëÁÆ°ÁêÜÊàêÂëòÊåâÈíÆ -->
            <button
              id="manage-members-btn"
              class="form-button form-button-secondary"
              style="margin-top: 15px"
            >
              ÁÆ°ÁêÜÁæ§ÊàêÂëò
            </button>
          </div>
          <div class="form-group">
            <label for="max-memory">‰∏ä‰∏ãÊñáËÆ∞ÂøÜÊù°Êï∞</label
            ><input type="number" id="max-memory" value="10" />
          </div>
          <div class="form-group">
            <label
              >ËÅäÂ§©Ê∞îÊ≥°‰∏ªÈ¢ò
              <button id="reset-theme-btn" type="button">ÈáçÁΩÆ</button></label
            >
            <div class="theme-selector">
              <label
                ><input
                  type="radio"
                  name="theme-select"
                  value="default"
                  id="theme-default"
                />
                ÈªòËÆ§</label
              ><label
                ><input type="radio" name="theme-select" value="pink_blue" />
                Á≤âËìù</label
              ><label
                ><input type="radio" name="theme-select" value="blue_white" />
                ËìùÁôΩ</label
              ><label
                ><input
                  type="radio"
                  name="theme-select"
                  value="purple_yellow"
                />
                Á¥´ÈªÑ</label
              ><label
                ><input type="radio" name="theme-select" value="black_white" />
                ÈªëÁôΩ</label
              ><label
                ><input type="radio" name="theme-select" value="yellow_white" />
                ÈªÑÁôΩ</label
              ><label
                ><input type="radio" name="theme-select" value="red_black" />
                Á∫¢Èªë</label
              ><label
                ><input type="radio" name="theme-select" value="blue_yellow" />
                ËìùÈªÑ</label
              ><label
                ><input type="radio" name="theme-select" value="pink_yellow" />
                Á≤âÈªÑ</label
              ><label
                ><input type="radio" name="theme-select" value="pink_purple" />
                Á≤âÁ¥´</label
              ><label
                ><input type="radio" name="theme-select" value="gray_white" />
                ÁÅ∞ÁôΩ</label
              ><label
                ><input type="radio" name="theme-select" value="blue_green" />
                ËìùÁªø</label
              ><label
                ><input type="radio" name="theme-select" value="pink_white" />
                Á≤âÁôΩ</label
              ><label
                ><input type="radio" name="theme-select" value="pink_black" />
                Á≤âÈªë</label
              ><label
                ><input type="radio" name="theme-select" value="pink_green" />
                Á≤âÁªø</label
              ><label
                ><input type="radio" name="theme-select" value="green_black" />
                ÁªøÈªë</label
              >
            </div>
          </div>

          <!-- Offline Mode Section -->
          <div class="form-group settings-group" id="offline-mode-settings">
            <div
              style="
                font-weight: bold;
                color: var(--accent-color);
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-left: 10px;
              "
            >
              Á∫ø‰∏ãÊ®°Âºè (Offline Mode)
              <label class="toggle-switch">
                <input type="checkbox" id="offline-mode-toggle" />
                <span class="slider"></span>
              </label>
            </div>
            <div
              id="offline-mode-config"
              style="
                display: none;
                margin-top: 10px;
                padding: 10px;
                border-radius: 8px;
              "
            >
              <div class="form-group">
                <label>È¢ÑËÆæÂú∫ÊôØ</label>
                <select
                  id="offline-preset-select"
                  class="moe-input"
                  style="
                    width: 100%;
                    padding: 8px;
                    border-radius: 6px;
                    border: 1px solid var(--border-color);
                  "
                >
                  <option value="custom">Ëá™ÂÆö‰πâ (Custom)</option>
                  <!-- JS will populate -->
                </select>
              </div>
              <div class="form-group">
                <label>Âú∫ÊôØÊèèËø∞ (System Prompt)</label>
                <textarea
                  id="offline-prompt-input"
                  class="moe-input"
                  rows="4"
                  style="
                    width: 100%;
                    padding: 8px;
                    border-radius: 6px;
                    border: 1px solid var(--border-color);
                  "
                ></textarea>
              </div>
              <div class="form-group">
                <label>ÊèèÂÜôÈ£éÊ†º (Style)</label>
                <textarea
                  id="offline-style-input"
                  class="moe-input"
                  rows="2"
                  style="
                    width: 100%;
                    padding: 8px;
                    border-radius: 6px;
                    border: 1px solid var(--border-color);
                  "
                ></textarea>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="font-size-slider"
              >ËÅäÂ§©Â≠ó‰ΩìÂ§ßÂ∞è <span id="font-size-value">13px</span></label
            >
            <input
              type="range"
              id="font-size-slider"
              min="12"
              max="20"
              step="1"
              value="13"
              style="width: 100%; margin-top: 8px"
            />
          </div>

          <div class="form-group">
            <label for="custom-css-input">
              Ëá™ÂÆö‰πâÊ∞îÊ≥°Ê†∑Âºè (CSS)
              <button
                id="reset-custom-css-btn"
                type="button"
                style="
                  background: none;
                  border: 1px solid #ccc;
                  color: #555;
                  font-size: 12px;
                  padding: 2px 8px;
                  border-radius: 5px;
                  cursor: pointer;
                  margin-left: 10px;
                "
              >
                ÈáçÁΩÆ
              </button>
            </label>
            <textarea
              id="custom-css-input"
              rows="5"
              style="
                width: 100%;
                margin-top: 8px;
                font-family: monospace;
                font-size: 12px;
                resize: vertical;
              "
              placeholder="/* Á§∫‰æãÔºö‰∏∫‚ÄúÊàë‚ÄùÁöÑÊ∞îÊ≥°Ê∑ªÂä†Ê∏êÂèòËÉåÊôØÂíåÈò¥ÂΩ± */
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"
            ></textarea>
          </div>

          <div class="form-group">
            <label>ÂÆûÊó∂È¢ÑËßà</label>
            <div id="settings-preview-area">
              <!-- JS‰ºöÂú®ËøôÈáåÁîüÊàêÈ¢ÑËßàÂÜÖÂÆπ -->
            </div>
          </div>

          <div class="form-group">
            <label>ËÅäÂ§©ËÉåÊôØ</label>
            <div class="bg-upload-container">
              <button
                type="button"
                class="form-button-secondary"
                style="width: auto; padding: 8px 12px; margin-top: 0"
                onclick="document.getElementById('bg-input').click()"
              >
                ‰∏ä‰º†ËÉåÊôØÂõæ
              </button>
              <button type="button" id="remove-bg-btn">ÁßªÈô§ËÉåÊôØ</button>
            </div>
            <img id="bg-preview" class="bg-preview-img" />
            <input
              type="file"
              id="bg-input"
              accept="image/*"
              style="display: none"
            />
          </div>
          <div class="form-group">
            <label
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span>ÈïøÂØπËØùËá™Âä®ÊÄªÁªì</span>
              <label class="toggle-switch">
                <input type="checkbox" id="summary-toggle" />
                <span class="slider"></span>
              </label>
            </label>
            <div
              id="summary-options"
              style="
                display: none;
                margin-top: 10px;
                padding-left: 10px;
                border-left: 2px solid #eee;
              "
            >
              <div style="margin-bottom: 10px">
                <label
                  style="display: block; margin-bottom: 5px; font-size: 13px"
                  >Ëß¶ÂèëÊ®°Âºè</label
                >
                <label style="margin-right: 15px; font-size: 13px">
                  <input type="radio" name="summary-mode" value="manual" />
                  ÊâãÂä®ÊèêÈÜí
                </label>
                <label style="font-size: 13px">
                  <input type="radio" name="summary-mode" value="auto" />
                  Ëá™Âä®ÊâßË°å
                </label>
              </div>
              <div style="margin-bottom: 10px">
                <label
                  style="display: block; margin-bottom: 5px; font-size: 13px"
                  >ÊØèÈöîÂ§öÂ∞ëÊù°Ê∂àÊÅØËß¶Âèë</label
                >
                <input
                  type="number"
                  id="summary-count-input"
                  value="50"
                  style="width: 80px"
                />
              </div>
              <div style="margin-bottom: 10px">
                <button
                  id="manual-summary-btn"
                  class="form-button-secondary"
                  style="
                    font-size: 13px;
                    padding: 6px 12px;
                    width: auto;
                    margin-top: 0;
                  "
                >
                  Á´ãÂç≥ÊâãÂä®ÊÄªÁªì
                </button>
              </div>
            </div>
          </div>
          <hr
            style="margin: 25px 0; border: none; border-top: 1px solid #eee"
          />
          <button
            class="form-button form-button-secondary"
            id="block-chat-btn"
            style="
              background-color: #ff3b30;
              color: white;
              border-color: #ff3b30;
            "
          >
            ÊãâÈªëÂØπÊñπ
          </button>
          <button class="form-button form-button-secondary" id="clear-chat-btn">
            Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-chat-settings-btn">ÂèñÊ∂à</button
          ><button class="save" id="save-chat-settings-btn">‰øùÂ≠ò</button>
        </div>
      </div>
    </div>

    <div id="persona-library-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>ÊàëÁöÑ‰∫∫ËÆæÂ∫ì</span
          ><button id="add-persona-preset-btn" class="action-button">
            Ê∑ªÂä†
          </button>
        </div>
        <div class="modal-body"><div id="persona-library-grid"></div></div>
        <div class="modal-footer">
          <button class="cancel" id="close-persona-library-btn">ÂÖ≥Èó≠</button>
        </div>
      </div>
    </div>

    <div id="persona-editor-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span id="persona-editor-title">Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>È¢ÑËÆæÂ§¥ÂÉè</label>
            <div class="avatar-upload">
              <img id="preset-avatar-preview" /><button
                onclick="document.getElementById('preset-avatar-input').click()"
              >
                ‰∏ä‰º†Â§¥ÂÉè</button
              ><input type="file" id="preset-avatar-input" accept="image/*" />
            </div>
          </div>
          <div class="form-group">
            <label for="preset-persona-input">È¢ÑËÆæ‰∫∫ËÆæ</label
            ><textarea
              id="preset-persona-input"
              rows="4"
              placeholder="Âú®Ê≠§ËæìÂÖ•Ëøô‰∏™‰∫∫ËÆæÁöÑËØ¶ÁªÜËÆæÂÆö..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-persona-editor-btn">ÂèñÊ∂à</button
          ><button class="save" id="save-persona-preset-btn">‰øùÂ≠ò</button>
        </div>
      </div>
    </div>

    <div id="member-settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><span>ÁºñËæëÁæ§ÊàêÂëò</span></div>
        <div class="modal-body">
          <div class="form-group">
            <label for="member-name-input">ÂêçÂ≠ó</label
            ><input type="text" id="member-name-input" />
          </div>
          <div class="form-group">
            <label for="member-persona-input">‰∫∫ËÆæ</label
            ><textarea id="member-persona-input" rows="4"></textarea>
          </div>
          <div class="form-group">
            <label>Â§¥ÂÉè</label>
            <div class="avatar-upload">
              <img id="member-avatar-preview" /><button
                onclick="document.getElementById('member-avatar-input').click()"
              >
                ‰∏ä‰º†Â§¥ÂÉè</button
              ><input type="file" id="member-avatar-input" accept="image/*" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-member-settings-btn">ÂèñÊ∂à</button
          ><button class="save" id="save-member-settings-btn">‰øùÂ≠ò</button>
        </div>
      </div>
    </div>

    <div id="custom-modal-overlay">
      <div id="custom-modal">
        <div class="custom-modal-header" id="custom-modal-title"></div>
        <div class="custom-modal-body" id="custom-modal-body"></div>
        <div class="custom-modal-footer">
          <button id="custom-modal-cancel">ÂèñÊ∂à</button>
          <button id="custom-modal-confirm" class="confirm-btn">Á°ÆÂÆö</button>
        </div>
      </div>
    </div>

    <div id="api-config-editor-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 90%">
        <div class="modal-header">
          <span>ÁºñËæëAPIÈÖçÁΩÆ</span>
        </div>
        <div class="modal-body">
          <input type="hidden" id="config-editor-id" />
          <div class="form-group">
            <label for="config-name-input">ÈÖçÁΩÆÂêçÁß∞</label>
            <input
              type="text"
              id="config-name-input"
              placeholder="‰æãÂ¶ÇÔºö‰∏ªÂäõÊ®°Âûã„ÄÅÂ§áÁî®Á∫øË∑Ø"
            />
          </div>
          <div class="form-group">
            <label for="config-url-input">Âèç‰ª£Âú∞ÂùÄ</label>
            <input
              type="text"
              id="config-url-input"
              placeholder="‰æãÂ¶Ç: https://api.openai.com"
            />
          </div>
          <div class="form-group">
            <label for="config-key-input">ÂØÜÈí•</label>
            <input type="password" id="config-key-input" placeholder="sk-..." />
          </div>
          <div class="form-group">
            <label for="config-model-select">ÈªòËÆ§Ê®°Âûã</label>
            <select id="config-model-select"></select>
            <button
              type="button"
              class="form-button-secondary"
              id="config-fetch-models-btn"
              style="margin-top: 10px"
            >
              ÊãâÂèñÊ®°ÂûãÂàóË°®
            </button>
          </div>
          <div
            class="form-group form-group-flex"
            style="align-items: flex-start"
          >
            <!-- Temperature -->
            <div style="flex: 1; margin-right: 10px">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin-bottom: 5px;
                "
              >
                <label
                  for="config-temperature-input"
                  style="font-size: 12px; margin-bottom: 0"
                  >Temperature</label
                >
                <input
                  type="checkbox"
                  id="config-enable-temp"
                  title="ÂêØÁî®Ê≠§ÂèÇÊï∞"
                />
              </div>
              <input
                type="number"
                id="config-temperature-input"
                placeholder="0.8"
                step="0.1"
                min="0"
                max="2"
              />
            </div>

            <!-- Top P -->
            <div style="flex: 1; margin-right: 10px">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin-bottom: 5px;
                "
              >
                <label
                  for="config-topp-input"
                  style="font-size: 12px; margin-bottom: 0"
                  >Top P</label
                >
                <input
                  type="checkbox"
                  id="config-enable-topp"
                  title="ÂêØÁî®Ê≠§ÂèÇÊï∞"
                />
              </div>
              <input
                type="number"
                id="config-topp-input"
                placeholder="1.0"
                step="0.05"
                min="0"
                max="1"
              />
            </div>

            <!-- Top K -->
            <div style="flex: 1">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin-bottom: 5px;
                "
              >
                <label
                  for="config-topk-input"
                  style="font-size: 12px; margin-bottom: 0"
                  >Top K</label
                >
                <input
                  type="checkbox"
                  id="config-enable-topk"
                  title="ÂêØÁî®Ê≠§ÂèÇÊï∞"
                />
              </div>
              <input
                type="number"
                id="config-topk-input"
                placeholder="40"
                step="1"
                min="1"
              />
            </div>
          </div>

          <div class="form-group form-group-flex">
            <label for="config-stream-switch" style="margin-bottom: 0"
              >ÂêØÁî®ÊµÅÂºè‰º†Ëæì</label
            >
            <label class="toggle-switch">
              <input type="checkbox" id="config-stream-switch" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="form-group form-group-flex">
            <label for="config-hide-stream-switch" style="margin-bottom: 0"
              >ÈöêËóèÊµÅÂºèÂìçÂ∫î</label
            >
            <label class="toggle-switch">
              <input type="checkbox" id="config-hide-stream-switch" />
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="cancel" id="cancel-config-editor-btn">
            ÂèñÊ∂à
          </button>
          <button type="button" class="save" id="save-config-btn">‰øùÂ≠ò</button>
        </div>
      </div>
    </div>

    <div id="preset-actions-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-footer">
          <button id="preset-action-edit">ÁºñËæëÈ¢ÑËÆæ</button>
          <button id="preset-action-delete" class="btn-danger">Âà†Èô§È¢ÑËÆæ</button>
          <button
            id="preset-action-cancel"
            style="
              margin-top: 8px;
              border-radius: 8px;
              background-color: #f0f0f0;
            "
          >
            ÂèñÊ∂à
          </button>
        </div>
      </div>
    </div>

    <div id="transfer-modal">
      <div class="transfer-content">
        <div class="transfer-header">ÁªôTa‰∏Ä‰∏™ÊÉäÂñúÔºÅ</div>
        <div class="transfer-input-group">
          <label for="transfer-amount">ËΩ¨Ë¥¶ÈáëÈ¢ù</label>
          <input
            type="number"
            id="transfer-amount"
            placeholder="0.00"
            min="0"
            max="9999"
            step="0.01"
          />
        </div>
        <div class="transfer-input-group">
          <label for="transfer-note">Â§áÊ≥® (ÂèØÈÄâ)</label>
          <input
            type="text"
            id="transfer-note"
            placeholder="Áïô‰∏ã‰Ω†ÁöÑÂ∞èÂøÉÊÄù~"
            maxlength="20"
          />
        </div>
        <div class="transfer-actions">
          <button id="transfer-cancel-btn">ÂèñÊ∂à</button>
          <button id="transfer-confirm-btn">Á°ÆËÆ§ËΩ¨Ë¥¶</button>
        </div>
      </div>
    </div>

    <div id="battery-alert-modal">
      <div class="battery-alert-content">
        <img id="battery-alert-image" src="" />
        <p id="battery-alert-text"></p>
      </div>
    </div>

    <audio id="audio-player" style="display: none"></audio>

    <div id="create-post-modal" class="modal">
      <div class="modal-content" style="height: auto; max-height: 90%">
        <div class="modal-header">
          <span>ÂèëÂ∏ÉÂä®ÊÄÅ</span>
        </div>
        <div class="modal-body">
          <!-- ÂÖ¨ÂºÄÊñáÂ≠óËæìÂÖ•Âå∫ -->
          <div class="form-group">
            <textarea
              id="post-public-text"
              rows="3"
              placeholder="ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...ÔºàÈùûÂøÖÂ°´ÁöÑÂÖ¨ÂºÄÊñáÂ≠óÔºâ"
            ></textarea>
          </div>

          <!-- === Ê®°ÂºèÂàáÊç¢ÂºÄÂÖ≥ (Êñ∞Â¢û) === -->
          <div class="post-mode-switcher">
            <button id="switch-to-image-mode" class="mode-btn active">
              ‰∏ä‰º†ÂõæÁâá
            </button>
            <button id="switch-to-text-image-mode" class="mode-btn">
              ‰ΩøÁî®ÊñáÂ≠óÂõæ
            </button>
          </div>

          <div class="form-group">
            <label>ÂèØËßÅËåÉÂõ¥</label>
            <div
              id="post-visibility-options"
              style="display: flex; gap: 15px; margin-bottom: 10px"
            >
              <label
                ><input type="radio" name="visibility" value="public" checked />
                ÂÖ¨ÂºÄ</label
              >

              <label
                ><input type="radio" name="visibility" value="include" />
                ÊåáÂÆöÂàÜÁªÑÂèØËßÅ</label
              >
            </div>
            <div
              id="post-visibility-groups"
              style="
                display: none;
                max-height: 120px;
                overflow-y: auto;
                background: #f9f9f9;
                padding: 10px;
                border-radius: 8px;
              "
            >
              <!-- ÂàÜÁªÑÂ§öÈÄâÊ°ÜÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
            </div>
          </div>

          <!-- === ÂõæÁâáÊ®°ÂºèÂå∫Âüü === -->
          <div id="image-mode-content" class="post-mode-content active">
            <div class="form-group">
              <div
                id="post-image-preview-container"
                class="post-image-preview-container"
              >
                <img id="post-image-preview" src="" alt="ÂõæÁâáÈ¢ÑËßà" />
                <button id="post-remove-image-btn">√ó</button>
              </div>
              <div class="post-image-upload-options">
                <button
                  id="post-upload-local-btn"
                  class="form-button-secondary"
                >
                  Êú¨Âú∞‰∏ä‰º†
                </button>
                <button id="post-use-url-btn" class="form-button-secondary">
                  ÁΩëÁªúURL
                </button>
                <input
                  type="file"
                  id="post-local-image-input"
                  accept="image/*"
                  hidden
                />
              </div>
            </div>
            <div
              id="post-image-desc-group"
              class="form-group"
              style="display: none"
            >
              <label>ÂõæÁâáÊèèËø∞ (ÂøÖÂ°´ÔºåÁªôAIÁúã)</label>
              <input
                type="text"
                id="post-image-description"
                placeholder="ÁÆÄÂçïÊèèËø∞ÂõæÁâáÂÜÖÂÆπÔºåÂ∏ÆÂä©AIÁêÜËß£"
              />
            </div>
          </div>

          <!-- === ÊñáÂ≠óÂõæÊ®°ÂºèÂå∫Âüü (Êñ∞Â¢û) === -->
          <div id="text-image-mode-content" class="post-mode-content">
            <div class="form-group">
              <label>ÊñáÂ≠óÂõæ (ÁªôAIÁêÜËß£Áî®ÁöÑÊèèËø∞ÔºåÁÇπÂáªÂõæÁâáÂêéÂèØËßÅ)</label>
              <textarea
                id="post-hidden-text"
                rows="4"
                placeholder="Âú®ËøôÈáåÂÜô‰∏ãÂõæÁâáÊèèËø∞..."
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-create-post-btn">ÂèñÊ∂à</button>
          <button class="save" id="confirm-create-post-btn">ÂèëÂ∏É</button>
        </div>
      </div>
    </div>

    <div id="group-management-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>ÁÆ°ÁêÜÂ•ΩÂèãÂàÜÁªÑ</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Êñ∞Âª∫ÂàÜÁªÑ</label>
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                id="new-group-name-input"
                placeholder="ËæìÂÖ•ÂàÜÁªÑÂêç..."
                style="flex-grow: 1"
              />
              <button
                id="add-new-group-btn"
                class="form-button"
                style="width: auto; margin-top: 0; padding: 0 15px"
              >
                Ê∑ªÂä†
              </button>
            </div>
          </div>
          <hr style="opacity: 0.2" />
          <div
            id="existing-groups-list"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <!-- ÂàÜÁªÑÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="save" id="close-group-manager-btn" style="width: 100%">
            ÂÆåÊàê
          </button>
        </div>
      </div>
    </div>

    <div id="message-actions-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-footer">
          <!-- Êñ∞ÁöÑÊìç‰ΩúÊåâÈíÆ -->
          <button id="edit-message-btn">ÁºñËæëÊ∂àÊÅØ</button>
          <button id="copy-message-btn">Â§çÂà∂ÊñáÊú¨</button>
          <button id="recall-message-btn">Êí§Âõû</button>
          <button id="quote-message-btn">ÂºïÁî®</button>
          <button id="select-message-btn">ËøõÂÖ•Â§öÈÄâ</button>
          <!-- ÂèñÊ∂àÊåâÈíÆ -->
          <button id="cancel-message-action-btn" style="border-radius: 8px">
            ÂèñÊ∂à
          </button>
        </div>
      </div>
    </div>

    <div id="post-actions-modal" class="modal">
      <div id="custom-modal" style="width: 250px">
        <div class="custom-modal-footer">
          <button id="edit-post-btn">ÁºñËæëÂä®ÊÄÅ</button>
          <button id="copy-post-btn">Â§çÂà∂ÂÜÖÂÆπ</button>
          <button id="cancel-post-action-btn">ÂèñÊ∂à</button>
        </div>
      </div>
    </div>

    <div id="message-editor-modal" class="modal">
      <div class="modal-content" style="height: 75%">
        <div class="modal-header">
          <span>ÁºñËæë‰∏éÊãÜÂàÜÊ∂àÊÅØ</span>
        </div>
        <div class="modal-body" id="message-editor-body">
          <!-- ÁºñËæëÂô®ÂÆπÂô®ÔºåJS‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÊñáÊú¨Ê°Ü -->
          <div id="message-editor-container"></div>
          <!-- Ê∑ªÂä†Êñ∞Ê∂àÊÅØÁöÑÊåâÈíÆ -->
          <button
            id="add-message-editor-block-btn"
            class="form-button form-button-secondary"
            style="margin-top: 15px"
          >
            [+] Ê∑ªÂä†‰∏ã‰∏ÄÊù°Ê∂àÊÅØ
          </button>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-advanced-editor-btn">ÂèñÊ∂à</button>
          <button class="save" id="save-advanced-editor-btn">‰øùÂ≠òÊõ¥Êîπ</button>
        </div>
      </div>
    </div>

    <div id="waimai-request-modal" class="modal">
      <div class="modal-content" style="width: 290px">
        <div class="modal-header">
          <span>ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="waimai-product-info">ÂïÜÂìÅ‰ø°ÊÅØ</label>
            <input
              type="text"
              id="waimai-product-info"
              placeholder="‰æãÂ¶ÇÔºö‰∏ÄÊùØÊù®ÊûùÁîòÈú≤"
            />
          </div>
          <div class="form-group">
            <label for="waimai-amount">‰ª£‰ªòÈáëÈ¢ù (ÂÖÉ)</label>
            <input
              type="number"
              id="waimai-amount"
              placeholder="‰æãÂ¶ÇÔºö21"
              min="0"
              step="0.01"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="waimai-cancel-btn">ÂèñÊ∂à</button>
          <button class="save" id="waimai-confirm-btn">ÂèëËµ∑ËØ∑Ê±Ç</button>
        </div>
      </div>
    </div>

    <div id="create-countdown-modal" class="modal">
      <div class="modal-content" style="height: auto">
        <div class="modal-header">
          <span>Êñ∞Âª∫Á∫¶ÂÆö</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="countdown-title-input">Á∫¶ÂÆöÊ†áÈ¢ò</label>
            <input
              type="text"
              id="countdown-title-input"
              placeholder="‰æãÂ¶ÇÔºöÊàëÁöÑÁîüÊó•"
            />
          </div>
          <div class="form-group">
            <label for="countdown-date-input">Á∫¶ÂÆöÊó•Êúü‰∏éÊó∂Èó¥</label>
            <input type="datetime-local" id="countdown-date-input" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-create-countdown-btn">ÂèñÊ∂à</button>
          <button class="save" id="confirm-create-countdown-btn">
            ‰øùÂ≠òÁ∫¶ÂÆö
          </button>
        </div>
      </div>
    </div>

    <div id="red-packet-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>ÂèëÁ∫¢ÂåÖ</span>
        </div>
        <div class="modal-body" style="padding: 0">
          <!-- 1. È°µÁ≠æÂàáÊç¢ -->
          <div class="frame-tabs">
            <div id="rp-tab-group" class="frame-tab active">ÊãºÊâãÊ∞îÁ∫¢ÂåÖ</div>
            <div id="rp-tab-direct" class="frame-tab">‰∏ìÂ±ûÁ∫¢ÂåÖ</div>
          </div>

          <!-- 2. ÊãºÊâãÊ∞îÁ∫¢ÂåÖÂÜÖÂÆπÂå∫ -->
          <div
            id="rp-content-group"
            class="frame-content"
            style="padding: 20px 15px"
          >
            <div class="form-group">
              <label>ÊÄªÈáëÈ¢ù (ÂÖÉ)</label>
              <input type="number" id="rp-group-amount" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>Á∫¢ÂåÖ‰∏™Êï∞</label>
              <input
                type="number"
                id="rp-group-count"
                placeholder="Â°´ÂÜôÁ∫¢ÂåÖ‰∏™Êï∞"
              />
            </div>
            <div class="form-group">
              <label>Á•ùÁ¶èËØ≠</label>
              <input
                type="text"
                id="rp-group-greeting"
                placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ"
              />
            </div>
            <p
              id="rp-group-total"
              style="
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                margin: 10px 0;
              "
            >
              ¬• 0.00
            </p>
            <button id="send-group-packet-btn" class="form-button">
              Â°ûÈí±ËøõÁ∫¢ÂåÖ
            </button>
          </div>

          <!-- 3. ‰∏ìÂ±ûÁ∫¢ÂåÖÂÜÖÂÆπÂå∫ -->
          <div
            id="rp-content-direct"
            class="frame-content"
            style="display: none; padding: 20px 15px"
          >
            <div class="form-group">
              <label>ÂèëÈÄÅÁªô</label>
              <select id="rp-direct-receiver"></select>
            </div>
            <div class="form-group">
              <label>ÈáëÈ¢ù (ÂÖÉ)</label>
              <input type="number" id="rp-direct-amount" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>Á•ùÁ¶èËØ≠</label>
              <input
                type="text"
                id="rp-direct-greeting"
                placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ"
              />
            </div>
            <p
              id="rp-direct-total"
              style="
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                margin: 10px 0;
              "
            >
              ¬• 0.00
            </p>
            <button id="send-direct-packet-btn" class="form-button">
              Â°ûÈí±ËøõÁ∫¢ÂåÖ
            </button>
          </div>
        </div>
        <div class="modal-footer" style="justify-content: center">
          <button class="cancel" id="cancel-red-packet-btn" style="width: 100%">
            ÂèñÊ∂à
          </button>
        </div>
      </div>
    </div>

    <div id="red-packet-details-modal" class="modal">
      <div
        class="modal-content"
        style="width: 280px; height: auto; background-color: #f7f7f7"
      >
        <div
          class="modal-header"
          style="
            background-color: #f96259;
            color: white;
            border-bottom: none;
            padding-bottom: 5px;
          "
        >
          <div style="text-align: center; width: 100%">
            <div id="rp-details-sender" style="font-size: 16px"></div>
            <div style="font-size: 13px; opacity: 0.8">ÁöÑÁ∫¢ÂåÖ</div>
          </div>
        </div>
        <div class="modal-body" style="padding: 15px">
          <p
            id="rp-details-greeting"
            style="
              text-align: center;
              font-size: 20px;
              color: #333;
              margin: 0 0 20px 0;
            "
          ></p>
          <div
            id="rp-details-my-amount"
            style="text-align: center; display: none; margin-bottom: 20px"
          >
            <span style="font-size: 40px; font-weight: bold; color: #e44d44"
              >0.00</span
            >
            <span style="font-size: 18px; color: #e44d44">ÂÖÉ</span>
          </div>
          <div
            id="rp-details-summary"
            style="
              font-size: 13px;
              color: #8a8a8a;
              border-top: 1px solid #e0e0e0;
              padding-top: 10px;
            "
          ></div>
          <div
            id="rp-details-list"
            style="max-height: 150px; overflow-y: auto; margin-top: 10px"
          >
            <!-- È¢ÜÂèñËØ¶ÊÉÖÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="save" id="close-rp-details-btn" style="width: 100%">
            ÂÖ≥Èó≠
          </button>
        </div>
      </div>
    </div>
    <div id="create-poll-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>ÂèëËµ∑ÊäïÁ•®</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="poll-question-input">ÊäïÁ•®ÈóÆÈ¢ò</label>
            <textarea
              id="poll-question-input"
              rows="2"
              placeholder="‰æãÂ¶ÇÔºö‰ªäÊôöÊàë‰ª¨Áúã‰ªÄ‰πàÁîµÂΩ±Ôºü"
            ></textarea>
          </div>
          <div class="form-group">
            <label>ÊäïÁ•®ÈÄâÈ°π (Ëá≥Â∞ë2È°π)</label>
            <div
              id="poll-options-container"
              style="display: flex; flex-direction: column; gap: 8px"
            >
              <!-- ÊäïÁ•®ÈÄâÈ°πÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
            <button
              id="add-poll-option-btn"
              class="form-button form-button-secondary"
              style="margin-top: 12px"
            >
              + Ê∑ªÂä†ÈÄâÈ°π
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-create-poll-btn">ÂèñÊ∂à</button>
          <button class="save" id="confirm-create-poll-btn">ÂèëËµ∑ÊäïÁ•®</button>
        </div>
      </div>
    </div>

    <div id="ai-avatar-library-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="ai-avatar-library-title">ÂØπÊñπÁöÑÂ§¥ÂÉèÂ∫ì</span>
          <button id="add-ai-avatar-btn" class="action-button">Ê∑ªÂä†</button>
        </div>
        <div class="modal-body" style="padding: 15px">
          <div
            id="ai-avatar-library-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
              gap: 15px;
            "
          >
            <!-- Â§¥ÂÉèÂ∫ìÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-ai-avatar-library-btn"
            style="width: 100%"
          >
            ÂÖ≥Èó≠
          </button>
        </div>
      </div>
    </div>

    <div id="share-link-modal" class="modal">
      <div class="modal-content" style="width: 300px; height: auto">
        <div class="modal-header">
          <span>ÂàÜ‰∫´ÈìæÊé•</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="link-title-input">Ê†áÈ¢ò</label>
            <input
              type="text"
              id="link-title-input"
              placeholder="ËæìÂÖ•ÊñáÁ´†ÊàñÈìæÊé•ÁöÑÊ†áÈ¢ò"
            />
          </div>
          <div class="form-group">
            <label for="link-description-input">ÊëòË¶Å (ÂèØÈÄâ)</label>
            <textarea
              id="link-description-input"
              rows="2"
              placeholder="ÁÆÄÂçïÊèèËø∞‰∏Ä‰∏ãÈìæÊé•ÂÜÖÂÆπ"
            ></textarea>
          </div>
          <div class="form-group">
            <label for="link-source-input">Êù•Ê∫êÂêçÁß∞ (ÂèØÈÄâ)</label>
            <input
              type="text"
              id="link-source-input"
              placeholder="‰æãÂ¶ÇÔºöÁü•‰πéÊó•Êä•„ÄÅBÁ´ô"
            />
          </div>
          <div class="form-group">
            <label for="link-content-input"
              >ÂÆåÊï¥ÂÜÖÂÆπ (ÂèØÈÄâÔºåÁî®‰∫éÊµèËßàÂô®ÂÜÖÊòæÁ§∫)</label
            >
            <textarea
              id="link-content-input"
              rows="4"
              placeholder="Á≤òË¥¥ÊàñËæìÂÖ•ÂÆåÊï¥ÁöÑÊñáÁ´†ÂÜÖÂÆπ"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-share-link-btn">ÂèñÊ∂à</button>
          <button class="save" id="confirm-share-link-btn">ÂàÜ‰∫´</button>
        </div>
      </div>
    </div>

    <div id="transfer-actions-modal" class="modal">
      <div class="transfer-actions-content">
        <div class="transfer-actions-header">ËØ∑ÈÄâÊã©Êìç‰Ωú</div>
        <div class="transfer-actions-body">
          <p>
            ‰Ω†Êî∂Âà∞‰∫ÜÊù•Ëá™
            <strong id="transfer-sender-name"></strong> ÁöÑ‰∏ÄÁ¨îËΩ¨Ë¥¶„ÄÇ
          </p>
        </div>
        <div class="transfer-actions-footer">
          <button id="transfer-action-decline" class="action-btn decline">
            ÊÆãÂøçÊãíÁªù
          </button>
          <button id="transfer-action-accept" class="action-btn accept">
            ÂºÄÂøÉÊî∂‰∏ã
          </button>
        </div>
        <button id="transfer-action-cancel" class="cancel-btn">√ó</button>
      </div>
    </div>

    <div id="call-transcript-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span id="transcript-modal-title">ÈÄöËØùËØ¶ÊÉÖ</span>
        </div>
        <div
          class="modal-body"
          id="transcript-modal-body"
          style="background-color: #f0f2f5"
        >
          <!-- ÈÄöËØùÊñáÂ≠óËÆ∞ÂΩïÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
        </div>
        <div class="modal-footer">
          <button
            class="cancel"
            id="delete-transcript-btn"
            style="
              background-color: #ff3b30;
              color: white;
              border-color: #ff3b30;
            "
          >
            Âà†Èô§ËÆ∞ÂΩï
          </button>
          <button
            class="save"
            id="close-transcript-modal-btn"
            style="width: 100%"
          >
            ÂÖ≥Èó≠
          </button>
        </div>
      </div>
    </div>

    <div id="share-target-modal" class="modal">
      <div class="modal-content" style="height: 70%">
        <div class="modal-header">
          <span>ÂàÜ‰∫´Âà∞...</span>
        </div>
        <div class="modal-body" id="share-target-list" style="padding: 0">
          <!-- ËÅäÂ§©ÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
        </div>
        <div class="modal-footer">
          <button class="cancel" id="cancel-share-target-btn">ÂèñÊ∂à</button>
          <button class="save" id="confirm-share-target-btn">Á°ÆËÆ§ÂàÜ‰∫´</button>
        </div>
      </div>
    </div>

    <div id="shared-history-viewer-modal" class="modal">
      <div class="modal-content" style="height: 80%">
        <div class="modal-header">
          <span id="shared-history-viewer-title">ËÅäÂ§©ËÆ∞ÂΩï</span>
        </div>
        <div
          class="modal-body"
          id="shared-history-viewer-content"
          style="background-color: #f0f2f5"
        >
          <!-- ÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩïÊ∞îÊ≥°Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-shared-history-viewer-btn"
            style="width: 100%"
          >
            ÂÖ≥Èó≠
          </button>
        </div>
      </div>
    </div>

    <div id="world-book-category-manager-modal" class="modal">
      <div class="modal-content" style="height: 60%">
        <div class="modal-header">
          <span>ÁÆ°ÁêÜ‰∏ñÁïå‰π¶ÂàÜÁ±ª</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Êñ∞Âª∫ÂàÜÁ±ª</label>
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                id="new-category-name-input"
                placeholder="ËæìÂÖ•ÂàÜÁ±ªÂêç..."
                style="flex-grow: 1"
              />
              <button
                id="add-new-category-btn"
                class="form-button"
                style="width: auto; margin-top: 0; padding: 0 15px"
              >
                Ê∑ªÂä†
              </button>
            </div>
          </div>
          <hr style="opacity: 0.2" />
          <div
            id="existing-categories-list"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <!-- ÂàÜÁ±ªÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="save"
            id="close-category-manager-btn"
            style="width: 100%"
          >
            ÂÆåÊàê
          </button>
        </div>
      </div>
    </div>

    <div id="api-presets-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span>API ÈÖçÁΩÆÁÆ°ÁêÜ</span>
          <button class="action-button" id="close-api-presets-modal-btn">
            ÂÖ≥Èó≠
          </button>
        </div>
        <div class="modal-body">
          <div
            class="form-group"
            style="
              border-bottom: 1px solid #eee;
              padding-bottom: 15px;
              margin-bottom: 15px;
            "
          >
            <label>‰øùÂ≠òÂΩìÂâçÈÖçÁΩÆ‰∏∫:</label>
            <div style="display: flex; gap: 10px; margin-top: 5px">
              <input
                type="text"
                id="save-preset-name-input"
                placeholder="ÈÖçÁΩÆÂêçÁß∞ (Â¶Ç: DeepSeek-V3)"
                style="flex-grow: 1"
              />
              <button
                class="form-button"
                id="save-preset-btn"
                style="width: auto; margin-top: 0"
              >
                ‰øùÂ≠ò
              </button>
            </div>
          </div>
          <label>Â∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆ:</label>
          <div
            id="api-presets-list"
            class="list-container"
            style="max-height: 300px; padding: 0"
          >
            <!-- JSÁîüÊàêÂàóË°® -->
          </div>
        </div>
      </div>
    </div>

    <script>
      const GEMINI_API_URL =
        "https://generativelanguage.googleapis.com/v1beta/models";
      // geminiÂ¶ÇÊûúÊòØÂ§ö‰∏™ÂØÜÈí•, ÈÇ£‰πàÈöèÊú∫Ëé∑Âèñ‰∏Ä‰∏™
      function getRandomValue(str) {
        // Ê£ÄÊü•Â≠óÁ¨¶‰∏≤ÊòØÂê¶ÂåÖÂê´ÈÄóÂè∑
        if (str.includes(",")) {
          // Áî®ÈÄóÂè∑ÂàÜÈöîÂ≠óÁ¨¶‰∏≤Âπ∂ÁßªÈô§Â§ö‰ΩôÁ©∫Ê†º
          const arr = str.split(",").map((item) => item.trim());
          // ÁîüÊàêÈöèÊú∫Á¥¢Âºï (0 Âà∞ arr.length-1)
          const randomIndex = Math.floor(Math.random() * arr.length);
          // ËøîÂõûÈöèÊú∫ÂÖÉÁ¥†
          return arr[randomIndex];
        }
        // Ê≤°ÊúâÈÄóÂè∑ÂàôÁõ¥Êé•ËøîÂõûÂéüÂ≠óÁ¨¶‰∏≤
        return str;
      }
      function isImage(text, content) {
        let currentImageData = content.image_url.url;
        // ÊèêÂèñBase64Êï∞ÊçÆÔºàÂéªÊéâÂâçÁºÄÔºâ
        const base64Data = currentImageData.split(",")[1];
        // Ê†πÊçÆÂõæÁâáÁ±ªÂûãËé∑ÂèñMIMEÁ±ªÂûã
        const mimeType = currentImageData.match(/^data:(.*);base64/)[1];
        return [
          { text: `${text.text}Áî®Êà∑Âêë‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá` },
          {
            inline_data: {
              mime_type: mimeType,
              data: base64Data,
            },
          },
        ];
      }

      function extractArray(text) {
        // Ê≠£ÂàôË°®ËææÂºèÊ®°ÂºèÔºöÂåπÈÖçÂºÄÂ§¥ÁöÑÊó∂Èó¥Êà≥ÈÉ®ÂàÜÂíåÂêéÁª≠ÁöÑJSONÊï∞ÁªÑ
        const pattern = /^\(Timestamp: (\d+)\)(.*)$/s;
        const match = text.match(pattern);

        if (match) {
          const timestampPart = `(Timestamp: ${match[1]}) `;
          const jsonPart = match[2].trim();

          try {
            // Â∞ùËØïËß£ÊûêJSONÈÉ®ÂàÜ
            const parsedJson = JSON.parse(jsonPart);
            // È™åËØÅËß£ÊûêÁªìÊûúÊòØÂê¶‰∏∫Êï∞ÁªÑ
            if (Array.isArray(parsedJson)) {
              return [timestampPart, parsedJson[0]];
            }
          } catch (error) {
            // Ëß£ÊûêÂ§±Ë¥•ÔºåËøîÂõûÂéüÂßãÊñáÊú¨
          }
        }

        // ‰∏çÂåπÈÖçÊ†ºÂºèÊàñËß£ÊûêÂ§±Ë¥•Êó∂ËøîÂõûÂéüÂÄº
        return text;
      }
      function transformChatData(item) {
        let type = {
          send_and_recall: "Êí§Âõû‰∫ÜÊ∂àÊÅØ",
          update_status: "Êõ¥Êñ∞‰∫ÜÁä∂ÊÄÅ",
          change_music: "ÂàáÊç¢‰∫ÜÊ≠åÊõ≤",
          create_memory: "ËÆ∞ÂΩï‰∫ÜÂõûÂøÜ",
          create_countdown: "ÂàõÂª∫‰∫ÜÁ∫¶ÂÆö/ÂÄíËÆ°Êó∂",
          text: "ÂèëÈÄÅ‰∫ÜÊñáÊú¨",
          sticker: "ÂèëÈÄÅ‰∫ÜË°®ÊÉÖ",
          ai_image: "ÂèëÈÄÅ‰∫ÜÂõæÁâá",
          voice_message: "ÂèëÈÄÅ‰∫ÜËØ≠Èü≥",
          transfer: "ÂèëËµ∑‰∫ÜËΩ¨Ë¥¶",
          waimai_request: "ÂèëËµ∑‰∫ÜÂ§ñÂçñËØ∑Ê±Ç",
          waimai_response: {
            paid: "ÂõûÂ∫î‰∫ÜÂ§ñÂçñ-ÂêåÊÑè",
            rejected: "ÂõûÂ∫î‰∫ÜÂ§ñÂçñ-ÊãíÁªù",
          },
          video_call_request: "ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØù",
          video_call_response: {
            accept: "ÂõûÂ∫î‰∫ÜËßÜÈ¢ëÈÄöËØù-Êé•Âèó",
            reject: "ÂõûÂ∫î‰∫ÜËßÜÈ¢ëÈÄöËØù-ÊãíÁªù",
          },
          qzone_post: {
            shuoshuo: "ÂèëÂ∏É‰∫ÜËØ¥ËØ¥",
            text_image: "ÂèëÂ∏É‰∫ÜÊñáÂ≠óÂõæ",
          },
          qzone_comment: "ËØÑËÆ∫‰∫ÜÂä®ÊÄÅ",
          qzone_like: "ÁÇπËµû‰∫ÜÂä®ÊÄÅ",
          pat_user: "Êãç‰∏ÄÊãç‰∫ÜÁî®Êà∑",
          block_user: "ÊãâÈªë‰∫ÜÁî®Êà∑",
          friend_request_response: "ÂõûÂ∫î‰∫ÜÂ•ΩÂèãÁî≥ËØ∑",
          change_avatar: "Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè",
          share_link: "ÂàÜ‰∫´‰∫ÜÈìæÊé•",
          accept_transfer: "ÂõûÂ∫î‰∫ÜËΩ¨Ë¥¶-Êé•Âèó",
          decline_transfer: "ÂõûÂ∫î‰∫ÜËΩ¨Ë¥¶-ÊãíÁªù/ÈÄÄÊ¨æ",
          quote_reply: "ÂºïÁî®‰∫ÜÂõûÂ§ç",
          text: "",
        };
        let res = extractArray(item.content);

        if (Array.isArray(res)) {
          let obj = res[1];
          let itemType = obj.type;
          let time = res[0];
          let text = type[itemType];
          if (text) {
            if (itemType === "sticker") {
              return [{ text: `${time}[${text}] Âê´‰πâÊòØ:${obj.meaning}` }];
            } else if (itemType === "send_and_recall") {
              return [{ text: `${time}[${text}] ${obj.content}` }];
            } else if (itemType === "update_status") {
              return [
                {
                  text: `${time}[${text}] ${obj.status_text}(${
                    obj.is_busy ? "ÂøôÁ¢å/Á¶ªÂºÄ" : "Á©∫Èó≤"
                  })`,
                },
              ];
            } else if (itemType === "change_music") {
              return [
                {
                  text: `${time}[${text}] ${obj.change_music}, Ê≠åÂêçÊòØ:${obj.song_name}`,
                },
              ];
            } else if (itemType === "create_memory") {
              return [{ text: `${time}[${text}] ${obj.description}` }];
            } else if (itemType === "create_countdown") {
              return [{ text: `${time}[${text}] ${obj.title}(${obj.date})` }];
            } else if (itemType === "ai_image") {
              return [
                { text: `${time}[${text}] ÂõæÁâáÊèèËø∞ÊòØ:${obj.description}` },
              ];
            } else if (itemType === "voice_message") {
              return [{ text: `${time}[${text}] ${obj.content}` }];
            } else if (itemType === "transfer") {
              return [
                {
                  text: `${time}[${text}] ÈáëÈ¢ùÊòØ:${obj.amount} Â§áÊ≥®ÊòØ:${obj.amount}`,
                },
              ];
            } else if (itemType === "waimai_request") {
              return [
                {
                  text: `${time}[${text}] ÈáëÈ¢ùÊòØ:${obj.amount} ÂïÜÂìÅÊòØ:${obj.productInfo}`,
                },
              ];
            } else if (itemType === "waimai_response") {
              return [
                {
                  text: `${time}[${text[obj.status]}] ${
                    obj.status === "paid" ? "ÂêåÊÑè" : "ÊãíÁªù"
                  }`,
                },
              ];
            } else if (itemType === "video_call_request") {
              return [{ text: `${time}[${text}]` }];
            }
          } else if (itemType === "video_call_request") {
            return [
              {
                text: `${time}[${text[obj.decision]}] ${
                  obj.decision === "accept" ? "ÂêåÊÑè" : "ÊãíÁªù"
                }`,
              },
            ];
          } else if (itemType === "qzone_post") {
            return [
              {
                text: `${time}[${text[obj.postType]}] ${
                  obj.postType === "shuoshuo"
                    ? `${obj.content}`
                    : `ÂõæÁâáÊèèËø∞ÊòØ:${obj.hiddenContent} ${
                        obj.publicText ? `ÊñáÊ°àÊòØ: ${obj.publicText}` : ""
                      }`
                }`,
              },
            ];
          } else if (itemType === "qzone_comment") {
            return [
              {
                text: `${time}[${text}] ËØÑËÆ∫ÁöÑidÊòØ: ${obj.postId} ËØÑËÆ∫ÁöÑÂÜÖÂÆπÊòØ: ${obj.commentText}`,
              },
            ];
          } else if (itemType === "qzone_like") {
            return [{ text: `${time}[${text}] ÁÇπËµûÁöÑidÊòØ: ${obj.postId}` }];
          } else if (itemType === "pat_user") {
            return [
              { text: `${time}[${text}] ${obj.suffix ? obj.suffix : ""}` },
            ];
          } else if (itemType === "block_user") {
            return [{ text: `${time}[${text}]` }];
          } else if (itemType === "friend_request_response") {
            return [
              {
                text: `${time}[${text}] ÁªìÊûúÊòØ:${
                  obj.decision === "accept" ? "ÂêåÊÑè" : "ÊãíÁªù"
                }`,
              },
            ];
          } else if (itemType === "change_avatar") {
            return [{ text: `${time}[${text}] Â§¥ÂÉèÂêçÊòØ:${obj.name}` }];
          } else if (itemType === "share_link") {
            return [
              {
                text: `${time}[${text}] ÊñáÁ´†Ê†áÈ¢òÊòØ:${obj.title}  ÊñáÁ´†ÊëòË¶ÅÊòØ:${obj.description} Êù•Ê∫êÁΩëÁ´ôÂêçÊòØ:${obj.source_name} ÊñáÁ´†Ê≠£ÊñáÊòØ:${obj.content}`,
              },
            ];
          } else if (itemType === "accept_transfer") {
            return [{ text: `${time}[${text}]` }];
          } else if (itemType === "accept_transfer") {
            return [{ text: `${time}[${text}]` }];
          } else if (itemType === "quote_reply") {
            return [
              { text: `${time}[${text}] ÂºïÁî®ÁöÑÂÜÖÂÆπÊòØ:${obj.reply_content}` },
            ];
          } else if (itemType === "text") {
            return [{ text: `${time}${obj.content}` }];
          }
        }

        if (Array.isArray(res) && res.length > 1) {
          res = `${res[0]}${res[1].content}`;
        }

        return [{ text: res }];
      }

      function toGeminiRequestData(
        model,
        apiKey,
        systemInstruction,
        messagesForDecision,
        isGemini,
        temperature,
        topP,
        topK,
      ) {
        if (!isGemini) {
          return undefined;
        }

        // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨Â∞Ü 'system' ËßíËâ≤‰πüÊò†Â∞Ñ‰∏∫ 'user'

        let roleType = {
          user: "user",
          assistant: "model",
          system: "user", // <--- Êñ∞Â¢ûËøô‰∏ÄË°å
        };

        // ÊûÑÂª∫ generationConfig
        const generationConfig = {};
        if (temperature !== undefined)
          generationConfig.temperature = temperature;
        if (topP !== undefined) generationConfig.topP = topP;
        if (topK !== undefined) generationConfig.topK = topK;

        return {
          url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${getRandomValue(
            apiKey,
          )}`,
          data: {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              contents: messagesForDecision.map((item) => {
                let includesImages = false;
                if (Array.isArray(item.content) && item.content.length === 2) {
                  includesImages = item.content.some((sub) => {
                    return sub.type === "image_url" && sub.image_url.url;
                  });
                }
                return {
                  role: roleType[item.role], // Áé∞Âú® 'system' ‰ºöË¢´Ê≠£Á°ÆËΩ¨Êç¢‰∏∫ 'user'
                  parts: includesImages
                    ? isImage(item.content[0], item.content[1])
                    : transformChatData(item),
                };
              }),
              generationConfig: generationConfig,
              systemInstruction: {
                parts: [
                  {
                    text: systemInstruction,
                  },
                ],
              },
            }),
          },
        };
      }
      document.addEventListener("DOMContentLoaded", () => {
        // === Lightweight performance helpers ===
        /* visibility safeguard for streaming (patched) */
        document.addEventListener(
          "visibilitychange",
          async () => {
            if (document.hidden) {
              try {
                // flush any in-flight streaming content
                await db?.chats?.put?.(state.chats[state.activeChatId]);
              } catch (e) {}
            }
          },
          { passive: true },
        );

        // 2) Default all images to lazy & async decoding (static + dynamically added)
        function setImagePerfAttrs(img) {
          try {
            if (!img.hasAttribute("loading"))
              img.setAttribute("loading", "lazy");
            if (!img.hasAttribute("decoding"))
              img.setAttribute("decoding", "async");
          } catch (e) {}
        }
        document.querySelectorAll("img").forEach(setImagePerfAttrs);
        const mo = new MutationObserver((mutations) => {
          for (const m of mutations) {
            m.addedNodes &&
              m.addedNodes.forEach((node) => {
                if (node && node.tagName === "IMG") setImagePerfAttrs(node);
                else if (node && node.querySelectorAll)
                  node.querySelectorAll("img").forEach(setImagePerfAttrs);
              });
          }
        });
        mo.observe(document.documentElement, {
          childList: true,
          subtree: true,
        });

        // 3) Encourage passive listeners for scroll/touch to prevent jank
        (function () {
          const orig = EventTarget.prototype.addEventListener;
          const defaultPassive = {
            touchstart: true,
            touchmove: true,
            wheel: true,
          };
          EventTarget.prototype.addEventListener = function (
            type,
            listener,
            options,
          ) {
            let opts = options;
            if (typeof options === "object" && options !== null) {
              if (defaultPassive[type] && options.passive == null) {
                opts = Object.assign({}, options, { passive: true });
              }
            } else if (options === undefined && defaultPassive[type]) {
              opts = { passive: true };
            }
            return orig.call(this, type, listener, opts);
          };
        })();
        // ===================================================================
        // 1. ÊâÄÊúâÂèòÈáèÂíåÂ∏∏ÈáèÂÆö‰πâ
        // ===================================================================
        const db = new Dexie("GeminiChatDB");
        // --- Â∑≤‰øÆÊ≠£ ---
        const offlinePresets = {
          custom: { name: "Ëá™ÂÆö‰πâ (Custom)", prompt: "", style: "" },
          classroom: {
            name: "ÊïôÂÆ§ (Classroom)",
            prompt: "Êàë‰ª¨Âú®ÊïôÂÆ§ÈáåÔºå‰∏ãËØæÊó∂Èó¥„ÄÇÁ™óÂ§ñÈò≥ÂÖâÊ≠£Â•ΩÔºåÂêåÂ≠¶‰ª¨Âú®ÊâìÈóπ„ÄÇ",
            style: "ÈùíÊò•Ê†°Âõ≠",
          },
          bedroom: {
            name: "ÂçßÂÆ§ (Bedroom)",
            prompt: "Ê∑±Â§úÔºåÊàë‰ª¨Âú®ÂçßÂÆ§Èáå„ÄÇÊàøÈó¥ÈáåÂæàÂÆâÈùôÔºåÂè™ÊúâÂ∫äÂ§¥ÁÅØ‰∫ÆÁùÄ„ÄÇ",
            style: "Ê∏©È¶®ÁßÅÂØÜ",
          },
          park: {
            name: "ÂÖ¨Âõ≠ (Park)",
            prompt: "ÂçàÂêéÁöÑÂÖ¨Âõ≠ÔºåÈò≥ÂÖâÊòéÂ™ö„ÄÇÊàë‰ª¨Âú®ÈïøÊ§Ö‰∏äÂùêÁùÄÔºåÂæÆÈ£éÂêπËøá„ÄÇ",
            style: "ËΩªÊùæÊó•Â∏∏",
          },
          cafe: {
            name: "ÂíñÂï°È¶Ü (Cafe)",
            prompt: "ÁÉ≠ÈóπÁöÑÂíñÂï°È¶ÜÔºåÁ©∫Ê∞î‰∏≠Âº•Êº´ÁùÄÂíñÂï°È¶ô„ÄÇÊàë‰ª¨Èù¢ÂØπÈù¢ÂùêÁùÄ„ÄÇ",
            style: "ÈÉΩÂ∏Ç‰ºëÈó≤",
          },
          street: {
            name: "Ë°óÈÅì (Street)",
            prompt: "Â§úÊôöÁöÑË°óÈÅìÔºåÈúìËôπÁÅØÈó™ÁÉÅ„ÄÇÊàë‰ª¨Âπ∂ËÇ©Ëµ∞ÁùÄ„ÄÇ",
            style: "ËµõÂçöÊúãÂÖã",
          },
        };

        let state = {
          chats: {},
          activeChatId: null,
          globalSettings: {},
          apiConfigs: [],
          userStickers: [],
          worldBooks: [],
          personaPresets: [],
          qzoneSettings: {},
          activeAlbumId: null,
        };

        function getActiveApiConfig() {
          const activeConfigId = state.globalSettings.activeApiConfigId;
          const activeConfig = state.apiConfigs.find(
            (c) => c.id === activeConfigId,
          );
          if (!activeConfig) return null;
          return {
            proxyUrl: activeConfig.url,
            apiKey: activeConfig.apiKey,
            model: activeConfig.model,
            temperature: activeConfig.temperature ?? 0.8, // ‰º†ÈÄíÊñ∞ÂèÇÊï∞
            topP: activeConfig.topP ?? 1.0,
            topK: activeConfig.topK ?? 40,
            enableTemp:
              activeConfig.enableTemp ??
              activeConfig.enableAdvancedParams ??
              false,
            enableTopP:
              activeConfig.enableTopP ??
              activeConfig.enableAdvancedParams ??
              false,
            enableTopK:
              activeConfig.enableTopK ??
              activeConfig.enableAdvancedParams ??
              false,
            enableStreaming: activeConfig.enableStream, // Map to old property name for compatibility
          };
        }
        // --- ‰øÆÊ≠£ÁªìÊùü ---
        let musicState = {
          isActive: false,
          activeChatId: null,
          isPlaying: false,
          playlist: [],
          currentIndex: -1,
          playMode: "order",
          totalElapsedTime: 0,
          timerId: null,
          // „ÄêÊñ∞Â¢û„ÄëÊ≠åËØçÁõ∏ÂÖ≥Áä∂ÊÄÅ
          parsedLyrics: [], // ÂΩìÂâçÊ≠åÊõ≤Ëß£ÊûêÂêéÁöÑÊ≠åËØçÊï∞ÁªÑ
          currentLyricIndex: -1, // ÂΩìÂâçÈ´ò‰∫ÆÁöÑÊ≠åËØçË°åÁ¥¢Âºï
        };
        const audioPlayer = document.getElementById("audio-player");
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;

        let waimaiTimers = {}; // Áî®‰∫éÂ≠òÂÇ®Â§ñÂçñÂÄíËÆ°Êó∂

        let activeMessageTimestamp = null;
        let currentReplyContext = null; // <--- Êñ∞Â¢ûËøôË°åÔºåÁî®Êù•Â≠òÂÇ®ÂΩìÂâçÊ≠£Âú®ÂºïÁî®ÁöÑÊ∂àÊÅØ‰ø°ÊÅØ
        let activePostId = null; // <-- Êñ∞Â¢ûÔºöÁî®‰∫éÂ≠òÂÇ®ÂΩìÂâçÊìç‰ΩúÁöÑÂä®ÊÄÅID

        let photoViewerState = {
          isOpen: false,
          photos: [], // Â≠òÂÇ®ÂΩìÂâçÁõ∏ÂÜåÁöÑÊâÄÊúâÁÖßÁâáURL
          currentIndex: -1, // ÂΩìÂâçÊ≠£Âú®Êü•ÁúãÁöÑÁÖßÁâáÁ¥¢Âºï
        };

        let unreadPostsCount = 0;

        let isFavoritesSelectionMode = false;
        let selectedFavorites = new Set();

        let simulationIntervalId = null;

        const defaultAvatar = "https://i.postimg.cc/PxZrFFFL/o-o-1.jpg";
        const defaultMyGroupAvatar = "https://i.postimg.cc/cLPP10Vm/4.jpg";
        const defaultGroupMemberAvatar = "https://i.postimg.cc/VkQfgzGJ/1.jpg";
        const defaultGroupAvatar =
          "https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg";
        let notificationTimeout;

        const DEFAULT_APP_ICONS = {
          "world-book": "https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg",
          qq: "https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg",
          "api-settings": "https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg",
          wallpaper: "https://i.postimg.cc/T1j03pQr/IMG-6440.jpg",
          font: "https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",
        };

        const STICKER_REGEX =
          /^(https:\/\/i\.postimg\.cc\/.+|https:\/\/files\.catbox\.moe\/.+|data:image)/;
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;
        let lastKnownBatteryLevel = 1;
        let alertFlags = {
          hasShown40: false,
          hasShown20: false,
          hasShown10: false,
        };
        let batteryAlertTimeout;
        const dynamicFontStyle = document.createElement("style");
        dynamicFontStyle.id = "dynamic-font-style";
        document.head.appendChild(dynamicFontStyle);

        const modalOverlay = document.getElementById("custom-modal-overlay");
        const modalTitle = document.getElementById("custom-modal-title");
        const modalBody = document.getElementById("custom-modal-body");
        const modalConfirmBtn = document.getElementById("custom-modal-confirm");
        const modalCancelBtn = document.getElementById("custom-modal-cancel");
        let modalResolve;

        function showCustomModal() {
          modalOverlay.classList.add("visible");
        }

        function hideCustomModal() {
          modalOverlay.classList.remove("visible");
          modalConfirmBtn.classList.remove("btn-danger");
          if (modalResolve) modalResolve(null);
        }

        function showCustomConfirm(title, message, options = {}) {
          return new Promise((resolve) => {
            modalResolve = resolve;
            modalTitle.textContent = title;
            modalBody.innerHTML = `<p>${message}</p>`;
            modalCancelBtn.style.display = "block";
            modalConfirmBtn.textContent = "Á°ÆÂÆö";
            if (options.confirmButtonClass)
              modalConfirmBtn.classList.add(options.confirmButtonClass);
            modalConfirmBtn.onclick = () => {
              resolve(true);
              hideCustomModal();
            };
            modalCancelBtn.onclick = () => {
              resolve(false);
              hideCustomModal();
            };
            showCustomModal();
          });
        }

        function showCustomAlert(title, message) {
          return new Promise((resolve) => {
            modalResolve = resolve;
            modalTitle.textContent = title;
            modalBody.innerHTML = `<div style="text-align: center; white-space: pre-wrap; display: flex; align-items: center; justify-content: center; min-height: 30px; width: 100%;">${message}</div>`;
            modalCancelBtn.style.display = "none";
            modalConfirmBtn.textContent = "Â•ΩÁöÑ";
            modalConfirmBtn.onclick = () => {
              modalCancelBtn.style.display = "block";
              modalConfirmBtn.textContent = "Á°ÆÂÆö";
              resolve(true);
              hideCustomModal();
            };
            showCustomModal();
          });
        }

        function showCustomPrompt(
          title,
          placeholder,
          initialValue = "",
          type = "text",
          extraHtml = "",
        ) {
          return new Promise((resolve) => {
            modalResolve = resolve;
            modalTitle.textContent = title;
            const inputId = "custom-prompt-input";

            const inputHtml =
              type === "textarea"
                ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
                : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;

            // Â∞ÜÈ¢ùÂ§ñÁöÑHTMLÂíåËæìÂÖ•Ê°ÜÁªÑÂêàÂú®‰∏ÄËµ∑
            modalBody.innerHTML = extraHtml + inputHtml;
            const input = document.getElementById(inputId);

            // ‰∏∫Ê†ºÂºèÂä©ÊâãÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂
            modalBody.querySelectorAll(".format-btn").forEach((btn) => {
              btn.addEventListener("click", () => {
                const templateStr = btn.dataset.template;
                if (templateStr) {
                  try {
                    const templateObj = JSON.parse(templateStr);
                    // ‰ΩøÁî® null, 2 ÂèÇÊï∞ËÆ©JSONÂ≠óÁ¨¶‰∏≤Ê†ºÂºèÂåñÔºåÂ∏¶Áº©ËøõÔºåÊõ¥ÊòìËØª
                    input.value = JSON.stringify(templateObj, null, 2);
                    input.focus();
                  } catch (e) {
                    console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e);
                  }
                }
              });
            });

            modalConfirmBtn.onclick = () => {
              resolve(input.value);
              hideCustomModal();
            };
            modalCancelBtn.onclick = () => {
              resolve(null);
              hideCustomModal();
            };

            // 1. ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü (‰øÆÊîπ DOM/CSS Áä∂ÊÄÅ)
            showCustomModal();

            // 2. Ê†∏ÂøÉ‰ºòÂåñÔºöÂ§öÈáçËÅöÁÑ¶Á≠ñÁï•

            // Á≠ñÁï•AÔºöÁ´ãÂç≥ËÅöÁÑ¶
            // ÈíàÂØπÈ´òÊÄßËÉΩËÆæÂ§áÔºåÂ∞ùËØïÂú®ÂΩìÂâçÂêåÊ≠•ÊâßË°åÊ†à‰∏≠Áõ¥Êé•ËÅöÁÑ¶ÔºåËøôÊòØ iOS ÊúÄÂñúÊ¨¢ÁöÑ‚ÄúÁõ¥Êé•‰∫§‰∫í‚Äù„ÄÇ
            // ËôΩÁÑ∂Ê≠§Êó∂ÂÖÉÁ¥†ÂèØËÉΩËøòÊ≤°ÂÆåÂÖ®Ê∏≤ÊüìÂèØËßÅÔºå‰ΩÜÂú® DOM Ê†ë‰∏≠ display Â±ûÊÄßÂ∑≤ÂèòÊõ¥‰∏∫Èùû none„ÄÇ
            input.focus();

            // Á≠ñÁï•BÔºö‰∏ã‰∏ÄÂ∏ßËÅöÁÑ¶
            // Â¶ÇÊûúÁ≠ñÁï•AÂ§±Ë¥•ÔºàÂõ†‰∏∫ÊµèËßàÂô®ËøòÊ≤°ÈáçÊéíÔºâÔºåËØ∑Ê±ÇÂú®‰∏ã‰∏ÄÂ∏ßÊ∏≤ÊüìÂâçËÅöÁÑ¶„ÄÇ
            // requestAnimationFrame ÈÄöÂ∏∏‰ºöË¢´ÊµèËßàÂô®ËßÜ‰∏∫Áî®Êà∑‰∫§‰∫íÁöÑ‰∏ÄÈÉ®ÂàÜ„ÄÇ
            requestAnimationFrame(() => {
              input.focus();
            });

            // Á≠ñÁï•CÔºö‰øùÂ∫ïÂª∂Êó∂
            // ÈíàÂØπËÄÅÊóßÂÆâÂçìËÆæÂ§áÊàñÊ∏≤ÊüìÊûÅÊÖ¢ÁöÑÊÉÖÂÜµÔºåÁ®çÂæÆÂª∂ÈïøÁ≠âÂæÖÊó∂Èó¥„ÄÇ
            // Âç≥‰Ωø iOS Âú®ËøôÈáåÊã¶Êà™‰∫ÜÈîÆÁõòÔºå‰∏äÈù¢ÁöÑ A Êàñ B Â∫îËØ•Â∑≤ÁªèÊàêÂäü‰∫Ü„ÄÇ
            setTimeout(() => {
              if (document.activeElement !== input) {
                input.focus();
              }
            }, 150);
          });
        }

        // ===================================================================
        // 2. Êï∞ÊçÆÂ∫ìÁªìÊûÑÂÆö‰πâ
        // ===================================================================

        db.version(24)
          .stores({
            chats: "&id, isGroup, groupId",
            // apiConfig: "&id", // <- ÁßªÈô§ÊóßË°®
            apiConfigs: "++id, name", // <- Êñ∞Â¢ûÔºåÁî®‰∫éÂ≠òÂÇ®Â§ö‰∏™APIÈÖçÁΩÆ
            globalSettings: "&id",
            userStickers: "&id, url, name",
            worldBooks: "&id, name, categoryId",
            worldBookCategories: "++id, name",
            musicLibrary: "&id",
            personaPresets: "&id",
            qzoneSettings: "&id",
            qzonePosts: "++id, timestamp",
            qzoneAlbums: "++id, name, createdAt",
            qzonePhotos: "++id, albumId",
            favorites: "++id, type, timestamp, originalTimestamp",
            qzoneGroups: "++id, name",
            memories: "++id, chatId, timestamp, type, targetDate",
            callRecords: "++id, chatId, timestamp, customName",
          })
          .upgrade(async (tx) => {
            // Êï∞ÊçÆËøÅÁßªËÑöÊú¨Ôºö‰ªéÊóßÁöÑÂçï‰∏™ apiConfig ËøÅÁßªÂà∞Êñ∞ÁöÑ apiConfigs ÂàóË°®
            const oldConfig = await tx.table("apiConfig").get("main");
            if (oldConfig) {
              console.log("Ê£ÄÊµãÂà∞ÊóßÁâàAPIÈÖçÁΩÆÔºåÊ≠£Âú®ÊâßË°åËá™Âä®ËøÅÁßª...");
              const newConfigsTable = tx.table("apiConfigs");
              const existingConfigs = await newConfigsTable.toArray();
              if (existingConfigs.length === 0) {
                const newId = await newConfigsTable.add({
                  name: "ÈªòËÆ§ÈÖçÁΩÆ",
                  url: oldConfig.proxyUrl || "",
                  apiKey: oldConfig.apiKey || "",
                  model: oldConfig.model || "",
                  enableStream: oldConfig.enableStream || false,
                  hideStreamResponse: oldConfig.hideStreamResponse || false,
                });

                const globalSettings = (await tx
                  .table("globalSettings")
                  .get("main")) || { id: "main" };
                globalSettings.activeApiConfigId = newId;
                await tx.table("globalSettings").put(globalSettings);

                await tx.table("apiConfig").clear();
                console.log("APIÈÖçÁΩÆËøÅÁßªÊàêÂäüÔºÅ");
              }
            }
          });

        // ===================================================================
        // 3. ÊâÄÊúâÂäüËÉΩÂáΩÊï∞ÂÆö‰πâ
        // ===================================================================

        function showScreen(screenId) {
          if (screenId === "chat-list-screen") {
            window.renderChatListProxy();
            switchToChatListView("messages-view");
          }
          if (screenId === "api-settings-screen")
            window.renderApiSettingsProxy();
          if (screenId === "wallpaper-screen")
            window.renderWallpaperScreenProxy();
          if (screenId === "world-book-screen")
            window.renderWorldBookScreenProxy();
          document
            .querySelectorAll(".screen")
            .forEach((s) => s.classList.remove("active"));
          const screenToShow = document.getElementById(screenId);
          if (screenToShow) screenToShow.classList.add("active");
          if (screenId === "chat-interface-screen")
            window.updateListenTogetherIconProxy(state.activeChatId);
          if (screenId === "font-settings-screen") {
            document.getElementById("font-url-input").value =
              state.globalSettings.fontUrl || "";
            applyCustomFont(state.globalSettings.fontUrl || "", true);
          }
        }
        window.updateListenTogetherIconProxy = () => {};

        function switchToChatListView(viewId) {
          const chatListScreen = document.getElementById("chat-list-screen");
          const views = {
            "messages-view": document.getElementById("messages-view"),
            "qzone-screen": document.getElementById("qzone-screen"),
            "favorites-view": document.getElementById("favorites-view"),
            "memories-view": document.getElementById("memories-view"), // <-- Êñ∞Â¢ûËøô‰∏ÄË°å
          };
          const mainHeader = document.getElementById("main-chat-list-header");
          const mainBottomNav = document.getElementById("chat-list-bottom-nav"); // Ëé∑Âèñ‰∏ªÂØºËà™Ê†è

          if (isFavoritesSelectionMode) {
            document.getElementById("favorites-edit-btn").click();
          }

          // ÈöêËóèÊâÄÊúâËßÜÂõæ
          Object.values(views).forEach((v) => v.classList.remove("active"));
          // ÊòæÁ§∫ÁõÆÊ†áËßÜÂõæ
          if (views[viewId]) {
            views[viewId].classList.add("active");
          }

          // Êõ¥Êñ∞Â∫ïÈÉ®ÂØºËà™Ê†èÈ´ò‰∫Æ
          document
            .querySelectorAll("#chat-list-bottom-nav .nav-item")
            .forEach((item) => {
              item.classList.toggle("active", item.dataset.view === viewId);
            });

          if (viewId === "messages-view") {
            mainHeader.style.display = "flex";
            mainBottomNav.style.display = "flex";
          } else {
            mainHeader.style.display = "none";
            mainBottomNav.style.display = "none";
          }

          if (viewId !== "memories-view") {
            activeCountdownTimers.forEach((timerId) => clearInterval(timerId));
            activeCountdownTimers = [];
          }

          // Ê†πÊçÆËßÜÂõæIDÊâßË°åÁâπÂÆöÁöÑÊ∏≤Êüì/Êõ¥Êñ∞ÈÄªËæë
          switch (viewId) {
            case "qzone-screen":
              views["qzone-screen"].style.backgroundColor = "#f0f2f5";
              updateUnreadIndicator(0);
              renderQzoneScreen();
              renderQzonePosts();
              break;
            case "favorites-view":
              views["favorites-view"].style.backgroundColor = "#f9f9f9";
              renderFavoritesScreen();
              break;
            case "messages-view":
              // Â¶ÇÊûúÈúÄË¶ÅÔºåÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ËøîÂõûÊ∂àÊÅØÂàóË°®Êó∂Ë¶ÅÊâßË°åÁöÑÈÄªËæë
              break;
          }
        }

        function renderQzoneScreen() {
          if (state && state.qzoneSettings) {
            const settings = state.qzoneSettings;
            document.getElementById("qzone-nickname").textContent =
              settings.nickname;
            document.getElementById("qzone-avatar-img").src = settings.avatar;
            document.getElementById("qzone-banner-img").src = settings.banner;
          }
        }
        window.renderQzoneScreenProxy = renderQzoneScreen;

        async function saveQzoneSettings() {
          if (db && state.qzoneSettings) {
            await db.qzoneSettings.put(state.qzoneSettings);
          }
        }

        function formatPostTimestamp(timestamp) {
          if (!timestamp) return "";
          const now = new Date();
          const date = new Date(timestamp);
          const diffSeconds = Math.floor((now - date) / 1000);
          const diffMinutes = Math.floor(diffSeconds / 60);
          const diffHours = Math.floor(diffMinutes / 60);
          if (diffMinutes < 1) return "ÂàöÂàö";
          if (diffMinutes < 60) return `${diffMinutes}ÂàÜÈíüÂâç`;
          if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          if (now.getFullYear() === year) {
            return `${month}-${day} ${hours}:${minutes}`;
          } else {
            return `${year}-${month}-${day} ${hours}:${minutes}`;
          }
        }

        async function renderQzonePosts() {
          const postsListEl = document.getElementById("qzone-posts-list");
          if (!postsListEl) return;

          const [posts, favorites] = await Promise.all([
            db.qzonePosts.orderBy("timestamp").reverse().toArray(),
            db.favorites.where("type").equals("qzone_post").toArray(),
          ]);

          const favoritedPostIds = new Set(
            favorites.map((fav) => fav.content.id),
          );

          postsListEl.innerHTML = "";

          if (posts.length === 0) {
            postsListEl.innerHTML =
              '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">ËøôÈáåÁ©∫Á©∫Â¶Ç‰πüÔºåÂø´Êù•ÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°ËØ¥ËØ¥ÂêßÔºÅ</p>';
            return;
          }

          const userSettings = state.qzoneSettings;

          posts.forEach((post) => {
            const postContainer = document.createElement("div");
            postContainer.className = "qzone-post-container";
            postContainer.dataset.postId = post.id;

            const postEl = document.createElement("div");
            postEl.className = "qzone-post-item";

            let authorAvatar = "",
              authorNickname = "",
              commentAvatar = userSettings.avatar;

            if (post.authorId === "user") {
              authorAvatar = userSettings.avatar;
              authorNickname = userSettings.nickname;
            } else if (state.chats[post.authorId]) {
              const authorChat = state.chats[post.authorId];
              authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
              authorNickname = authorChat.name;
            } else {
              authorAvatar = defaultAvatar;
              authorNickname = "{{char}}";
            }

            let contentHtml = "";
            const publicTextHtml = post.publicText
              ? `<div class="post-content">${post.publicText.replace(
                  /\n/g,
                  "<br>",
                )}</div>`
              : "";

            if (post.type === "shuoshuo") {
              contentHtml = `<div class="post-content" style="margin-bottom: 10px;">${post.content.replace(
                /\n/g,
                "<br>",
              )}</div>`;
            } else if (post.type === "image_post" && post.imageUrl) {
              contentHtml = publicTextHtml
                ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>`
                : `<img src="${post.imageUrl}" class="chat-image">`;
            } else if (post.type === "text_image") {
              contentHtml = publicTextHtml
                ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>`
                : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
            }

            let likesHtml = "";
            if (post.likes && post.likes.length > 0) {
              likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${post.likes.join(
                "„ÄÅ",
              )} ËßâÂæóÂæàËµû</span></div>`;
            }

            let commentsHtml = "";
            if (post.comments && post.comments.length > 0) {
              commentsHtml = '<div class="post-comments-container">';
              // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉ‰øÆÊîπÂ∞±Âú®ËøôÈáå„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
              // ÈÅçÂéÜËØÑËÆ∫Êó∂ÔºåÊàë‰ª¨‰º†ÂÖ• comment ÂØπË±°Êú¨Ë∫´ÂíåÂÆÉÁöÑÁ¥¢Âºï index
              post.comments.forEach((comment, index) => {
                // Âú®ËØÑËÆ∫È°πÁöÑÊú´Â∞æÔºåÊ∑ªÂä†‰∏Ä‰∏™Â∏¶Êúâ data-comment-index Â±ûÊÄßÁöÑÂà†Èô§ÊåâÈíÆ
                commentsHtml += `
                          <div class="comment-item">
                              <span class="commenter-name">${comment.commenterName}:</span>
                              <span class="comment-text">${comment.text}</span>
                              <span class="comment-delete-btn" data-comment-index="${index}">√ó</span>
                          </div>`;
              });
              // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„Äê‰øÆÊîπÁªìÊùü„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
              commentsHtml += "</div>";
            }

            const userNickname = state.qzoneSettings.nickname;
            const isLikedByUser =
              post.likes && post.likes.includes(userNickname);
            const isFavoritedByUser = favoritedPostIds.has(post.id);

            postEl.innerHTML = `
                  <div class="post-header"><img src="${authorAvatar}" class="post-avatar"><div class="post-info"><span class="post-nickname">${authorNickname}</span><span class="post-timestamp">${formatPostTimestamp(
                    post.timestamp,
                  )}</span></div>
                      <div class="post-actions-btn">‚Ä¶</div>
                  </div>
                  <div class="post-main-content">${contentHtml}</div>
                  <div class="post-feedback-icons">
                      <span class="action-icon like ${
                        isLikedByUser ? "active" : ""
                      }"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                      <span class="action-icon favorite ${
                        isFavoritedByUser ? "active" : ""
                      }"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                  </div>
                  ${likesHtml}
                  ${commentsHtml}
                  <div class="post-footer"><div class="comment-section"><img src="${commentAvatar}" class="comment-avatar"><input type="text" class="comment-input" placeholder="ÂèãÂñÑÁöÑËØÑËÆ∫ÊòØ‰∫§ÊµÅÁöÑËµ∑ÁÇπ"><div class="at-mention-popup"></div></div><button class="comment-send-btn">ÂèëÈÄÅ</button></div>
              `;

            const deleteAction = document.createElement("div");
            deleteAction.className = "qzone-post-delete-action";
            deleteAction.innerHTML = "<span>Âà†Èô§</span>";
            postContainer.appendChild(postEl);
            postContainer.appendChild(deleteAction);
            const commentSection =
              postContainer.querySelector(".comment-section");
            if (commentSection) {
              commentSection.addEventListener("touchstart", (e) =>
                e.stopPropagation(),
              );
              commentSection.addEventListener("mousedown", (e) =>
                e.stopPropagation(),
              );
            }
            postsListEl.appendChild(postContainer);
            const commentInput = postContainer.querySelector(".comment-input");
            const popup = postContainer.querySelector(".at-mention-popup");
            commentInput.addEventListener("input", () => {
              const value = commentInput.value;
              const atMatch = value.match(/@([\p{L}\w]*)$/u);
              if (atMatch) {
                const namesToMention = new Set();
                const authorNickname =
                  postContainer.querySelector(".post-nickname")?.textContent;
                if (authorNickname) namesToMention.add(authorNickname);
                postContainer
                  .querySelectorAll(".commenter-name")
                  .forEach((nameEl) => {
                    namesToMention.add(nameEl.textContent.replace(":", ""));
                  });
                namesToMention.delete(state.qzoneSettings.nickname);
                popup.innerHTML = "";
                if (namesToMention.size > 0) {
                  const searchTerm = atMatch[1];
                  namesToMention.forEach((name) => {
                    if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                      const item = document.createElement("div");
                      item.className = "at-mention-item";
                      item.textContent = name;
                      item.addEventListener("mousedown", (e) => {
                        e.preventDefault();
                        const newText =
                          value.substring(0, atMatch.index) + `@${name} `;
                        commentInput.value = newText;
                        popup.style.display = "none";
                        commentInput.focus();
                      });
                      popup.appendChild(item);
                    }
                  });
                  popup.style.display =
                    popup.children.length > 0 ? "block" : "none";
                } else {
                  popup.style.display = "none";
                }
              } else {
                popup.style.display = "none";
              }
            });
            commentInput.addEventListener("blur", () => {
              setTimeout(() => {
                popup.style.display = "none";
              }, 200);
            });
          });
        }

        function displayFilteredFavorites(items) {
          const listEl = document.getElementById("favorites-list");
          listEl.innerHTML = "";

          if (items.length === 0) {
            const searchTerm = document.getElementById(
              "favorites-search-input",
            ).value;
            const message = searchTerm
              ? "Êú™ÊâæÂà∞Áõ∏ÂÖ≥Êî∂Ëóè"
              : "‰Ω†ÁöÑÊî∂ËóèÂ§πÊòØÁ©∫ÁöÑÔºå<br>Âø´ÂéªÂä®ÊÄÅÊàñËÅäÂ§©‰∏≠Êî∂ËóèÂñúÊ¨¢ÁöÑÂÜÖÂÆπÂêßÔºÅ";
            listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
            return;
          }

          for (const item of items) {
            const card = document.createElement("div");
            card.className = "favorite-item-card";
            card.dataset.favid = item.id;

            let headerHtml = "",
              contentHtml = "",
              sourceText = "",
              footerHtml = "";

            if (item.type === "qzone_post") {
              const post = item.content;
              sourceText = "Êù•Ëá™Âä®ÊÄÅ";
              let authorAvatar = defaultAvatar,
                authorNickname = "Êú™Áü•Áî®Êà∑";

              if (post.authorId === "user") {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
              } else if (state.chats[post.authorId]) {
                authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                authorNickname = state.chats[post.authorId].name;
              }

              headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;

              const publicTextHtml = post.publicText
                ? `<div class="post-content">${post.publicText.replace(
                    /\n/g,
                    "<br>",
                  )}</div>`
                : "";
              if (post.type === "shuoshuo") {
                contentHtml = `<div class="post-content">${post.content.replace(
                  /\n/g,
                  "<br>",
                )}</div>`;
              } else if (post.type === "image_post" && post.imageUrl) {
                contentHtml = publicTextHtml
                  ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>`
                  : `<img src="${post.imageUrl}" class="chat-image">`;
              } else if (post.type === "text_image") {
                contentHtml = publicTextHtml
                  ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>`
                  : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
              }

              // 1. ÊûÑÈÄ†ÁÇπËµûÂå∫ÂüüÁöÑHTML
              let likesHtml = "";
              // Ê£ÄÊü• post ÂØπË±°‰∏≠ÊòØÂê¶Â≠òÂú® likes Êï∞ÁªÑÂπ∂‰∏î‰∏ç‰∏∫Á©∫
              if (post.likes && post.likes.length > 0) {
                // Â¶ÇÊûúÂ≠òÂú®ÔºåÂ∞±ÂàõÂª∫ÁÇπËµûÂå∫ÂüüÁöÑ div
                likesHtml = `
                          <div class="post-likes-section">
                              <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                              <span>${post.likes.join("„ÄÅ")} ËßâÂæóÂæàËµû</span>
                          </div>`;
              }

              // 2. ÊûÑÈÄ†ËØÑËÆ∫Âå∫ÂüüÁöÑHTML
              let commentsHtml = "";
              // Ê£ÄÊü• post ÂØπË±°‰∏≠ÊòØÂê¶Â≠òÂú® comments Êï∞ÁªÑÂπ∂‰∏î‰∏ç‰∏∫Á©∫
              if (post.comments && post.comments.length > 0) {
                // Â¶ÇÊûúÂ≠òÂú®ÔºåÂ∞±ÂàõÂª∫ËØÑËÆ∫ÂÆπÂô®ÔºåÂπ∂ÈÅçÂéÜÊØè‰∏ÄÊù°ËØÑËÆ∫
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach((comment) => {
                  commentsHtml += `
                              <div class="comment-item">
                                  <span class="commenter-name">${comment.commenterName}:</span>
                                  <span class="comment-text">${comment.text}</span>
                              </div>`;
                });
                commentsHtml += "</div>";
              }

              // 3. Â∞ÜÁÇπËµûÂíåËØÑËÆ∫ÁöÑHTMLÁªÑÂêàÂà∞ footerHtml ‰∏≠
              footerHtml = `${likesHtml}${commentsHtml}`;
            } else if (item.type === "chat_message") {
              const msg = item.content;
              const chat = state.chats[item.chatId];
              if (!chat) continue;

              sourceText = `Êù•Ëá™‰∏é ${chat.name} ÁöÑËÅäÂ§©`;
              const isUser = msg.role === "user";
              let senderName, senderAvatar;

              if (isUser) {
                // Áî®Êà∑Ê∂àÊÅØÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò
                senderName = chat.isGroup
                  ? chat.settings.myNickname || "Êàë"
                  : "Êàë";
                senderAvatar =
                  chat.settings.myAvatar ||
                  (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
              } else {
                // AI/ÊàêÂëòÊ∂àÊÅØ
                if (chat.isGroup) {
                  // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØÂîØ‰∏ÄÁöÑ„ÄÅÊ†∏ÂøÉÁöÑ‰øÆÊîπÔºÅ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                  // Êàë‰ª¨Áé∞Âú®‰ΩøÁî® originalName ÂéªÂåπÈÖçÔºåËÄå‰∏çÊòØÊóßÁöÑ name
                  const member = chat.members.find(
                    (m) => m.originalName === msg.senderName,
                  );
                  // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ‰øÆÊîπÁªìÊùü ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ

                  senderName = msg.senderName;
                  // Âõ†‰∏∫Áé∞Âú®ËÉΩÊ≠£Á°ÆÊâæÂà∞ member ÂØπË±°‰∫ÜÔºåÊâÄ‰ª•‰πüËÉΩÊ≠£Á°ÆËé∑ÂèñÂà∞‰ªñÁöÑÂ§¥ÂÉè
                  senderAvatar = member
                    ? member.avatar
                    : defaultGroupMemberAvatar;
                } else {
                  // ÂçïËÅäÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò
                  senderName = chat.name;
                  senderAvatar = chat.settings.aiAvatar || defaultAvatar;
                }
              }

              // ÂêéÁª≠ÊãºÊé• headerHtml Âíå contentHtml ÁöÑÈÄªËæëÈÉΩ‰øùÊåÅ‰∏çÂèò
              headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;

              if (
                typeof msg.content === "string" &&
                STICKER_REGEX.test(msg.content)
              ) {
                contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
              } else if (
                Array.isArray(msg.content) &&
                msg.content[0]?.type === "image_url"
              ) {
                contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
              } else {
                contentHtml = `<div class="message-text-wrapper">${String(msg.content || "").replace(/\n/g, "<br>")}</div>`;
              }
            }

            card.innerHTML = `
                  <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
                  <div class="fav-card-content">${contentHtml}</div>
                  ${footerHtml}`; // <-- ÊääÊàë‰ª¨Êñ∞ÂàõÂª∫ÁöÑ footerHtml ÊîæÂú®ËøôÈáå

            listEl.appendChild(card);
          }
        }

        /**
         * „ÄêÈáçÊûÑÂêéÁöÑÂáΩÊï∞„Äë: Ë¥üË¥£ÂáÜÂ§áÊï∞ÊçÆÂπ∂Ëß¶ÂèëÊ∏≤Êüì
         */
        async function renderFavoritesScreen() {
          // 1. ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆÂπ∂ÁºìÂ≠ò
          allFavoriteItems = await db.favorites
            .orderBy("timestamp")
            .reverse()
            .toArray();

          // 2. Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°ÜÂπ∂ÈöêËóèÊ∏ÖÈô§ÊåâÈíÆ
          const searchInput = document.getElementById("favorites-search-input");
          const clearBtn = document.getElementById(
            "favorites-search-clear-btn",
          );
          searchInput.value = "";
          clearBtn.style.display = "none";

          // 3. ÊòæÁ§∫ÊâÄÊúâÊî∂ËóèÈ°π
          displayFilteredFavorites(allFavoriteItems);
        }

        function resetCreatePostModal() {
          document.getElementById("post-public-text").value = "";
          document.getElementById("post-image-preview").src = "";
          document.getElementById("post-image-description").value = "";
          document
            .getElementById("post-image-preview-container")
            .classList.remove("visible");
          document.getElementById("post-image-desc-group").style.display =
            "none";
          document.getElementById("post-local-image-input").value = "";
          document.getElementById("post-hidden-text").value = "";
          document.getElementById("switch-to-image-mode").click();
        }

        async function exportBackup() {
          try {
            const backupData = {
              version: 2,
              timestamp: Date.now(),
            };

            const [
              chats,
              worldBooks,
              userStickers,
              apiConfigs,
              globalSettings,
              personaPresets,
              musicLibrary,
              qzoneSettings,
              qzonePosts,
              qzoneAlbums,
              qzonePhotos,
              favorites,
              qzoneGroups,
              memories,
              worldBookCategories,
              callRecords,
            ] = await Promise.all([
              db.chats.toArray(),
              db.worldBooks.toArray(),
              db.userStickers.toArray(),
              db.apiConfigs.toArray(),
              db.globalSettings.get("main"),
              db.personaPresets.toArray(),
              db.musicLibrary.get("main"),
              db.qzoneSettings.get("main"),
              db.qzonePosts.toArray(),
              db.qzoneAlbums.toArray(),
              db.qzonePhotos.toArray(),
              db.favorites.toArray(),
              db.qzoneGroups.toArray(),
              db.memories.toArray(),
              db.worldBookCategories.toArray(),
              db.callRecords.toArray(),
            ]);

            Object.assign(backupData, {
              chats,
              worldBooks,
              userStickers,
              apiConfigs,
              globalSettings,
              personaPresets,
              musicLibrary,
              qzoneSettings,
              qzonePosts,
              qzoneAlbums,
              qzonePhotos,
              favorites,
              qzoneGroups,
              memories,
              worldBookCategories,
              callRecords,
            });

            const blob = new Blob([JSON.stringify(backupData, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const link = Object.assign(document.createElement("a"), {
              href: url,
              download: `EPhone-Full-Backup-${
                new Date().toISOString().split("T")[0]
              }.json`,
            });
            link.click();
            URL.revokeObjectURL(url);

            await showCustomAlert("ÂØºÂá∫ÊàêÂäü", "Â∑≤ÊàêÂäüÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆÔºÅ");
          } catch (error) {
            console.error("ÂØºÂá∫Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
            await showCustomAlert(
              "ÂØºÂá∫Â§±Ë¥•",
              `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`,
            );
          }
        }

        async function importBackup(file) {
          if (!file) return;

          const confirmed = await showCustomConfirm(
            "‰∏•ÈáçË≠¶ÂëäÔºÅ",
            "ÂØºÂÖ•Â§á‰ªΩÂ∞ÜÂÆåÂÖ®Ë¶ÜÁõñÊÇ®ÂΩìÂâçÁöÑÊâÄÊúâÊï∞ÊçÆÔºåÂåÖÊã¨ËÅäÂ§©„ÄÅÂä®ÊÄÅ„ÄÅËÆæÁΩÆÁ≠â„ÄÇÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅÊÇ®Á°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü",
            { confirmButtonClass: "btn-danger" },
          );

          if (!confirmed) return;

          try {
            const text = await file.text();
            const data = JSON.parse(text);

            await db.transaction("rw", db.tables, async () => {
              for (const table of db.tables) {
                await table.clear();
              }

              if (Array.isArray(data.chats)) await db.chats.bulkPut(data.chats);
              if (Array.isArray(data.worldBooks))
                await db.worldBooks.bulkPut(data.worldBooks);
              if (Array.isArray(data.worldBookCategories))
                await db.worldBookCategories.bulkPut(data.worldBookCategories);
              if (Array.isArray(data.userStickers))
                await db.userStickers.bulkPut(data.userStickers);
              if (Array.isArray(data.personaPresets))
                await db.personaPresets.bulkPut(data.personaPresets);
              if (Array.isArray(data.qzonePosts))
                await db.qzonePosts.bulkPut(data.qzonePosts);
              if (Array.isArray(data.qzoneAlbums))
                await db.qzoneAlbums.bulkPut(data.qzoneAlbums);
              if (Array.isArray(data.qzonePhotos))
                await db.qzonePhotos.bulkPut(data.qzonePhotos);
              if (Array.isArray(data.favorites))
                await db.favorites.bulkPut(data.favorites);
              if (Array.isArray(data.qzoneGroups))
                await db.qzoneGroups.bulkPut(data.qzoneGroups);
              if (Array.isArray(data.memories))
                await db.memories.bulkPut(data.memories);
              if (Array.isArray(data.callRecords))
                await db.callRecords.bulkPut(data.callRecords);

              if (Array.isArray(data.apiConfigs)) {
                await db.apiConfigs.bulkPut(data.apiConfigs);
              } else if (data.apiConfig) {
                await db.apiConfigs.add({
                  name: "ÂØºÂÖ•ÁöÑÊóßÈÖçÁΩÆ",
                  url: data.apiConfig.proxyUrl || "",
                  apiKey: data.apiConfig.apiKey || "",
                  model: data.apiConfig.model || "",
                  enableStream: data.apiConfig.enableStream || false,
                  hideStreamResponse:
                    data.apiConfig.hideStreamResponse || false,
                });
                console.log("Â∑≤Â∞ÜÊóßÁâàAPIÈÖçÁΩÆËøÅÁßªÂà∞Êñ∞ÁªìÊûÑ„ÄÇ");
              }

              if (data.globalSettings) {
                await db.globalSettings.put(data.globalSettings);
              }

              if (data.musicLibrary)
                await db.musicLibrary.put(data.musicLibrary);
              if (data.qzoneSettings)
                await db.qzoneSettings.put(data.qzoneSettings);
            });

            await showCustomAlert(
              "ÂØºÂÖ•ÊàêÂäü",
              "ÊâÄÊúâÊï∞ÊçÆÂ∑≤ÊàêÂäüÊÅ¢Â§çÔºÅÂ∫îÁî®Âç≥Â∞ÜÂà∑Êñ∞‰ª•Â∫îÁî®ÊâÄÊúâÊõ¥Êîπ„ÄÇ",
            );

            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } catch (error) {
            console.error("ÂØºÂÖ•Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
            await showCustomAlert(
              "ÂØºÂÖ•Â§±Ë¥•",
              `Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÊàñÊï∞ÊçÆÂ∑≤ÊçüÂùè: ${error.message}`,
            );
          }
        }
        function applyCustomFont(fontUrl, isPreviewOnly = false) {
          if (!fontUrl) {
            dynamicFontStyle.innerHTML = "";
            document.getElementById("font-preview").style.fontFamily = "";
            return;
          }
          const fontName = "custom-user-font";
          const newStyle = `
                      @font-face {
                        font-family: '${fontName}';
                        src: url('${fontUrl}');
                        font-display: swap;
                      }`;
          if (isPreviewOnly) {
            const previewStyle =
              document.getElementById("preview-font-style") ||
              document.createElement("style");
            previewStyle.id = "preview-font-style";
            previewStyle.innerHTML = newStyle;
            if (!document.getElementById("preview-font-style"))
              document.head.appendChild(previewStyle);
            document.getElementById("font-preview").style.fontFamily =
              `'${fontName}', 'bulangni', sans-serif`;
          } else {
            dynamicFontStyle.innerHTML = `
                          ${newStyle}
                          body {
                            font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                          }`;
          }
        }

        async function resetToDefaultFont() {
          dynamicFontStyle.innerHTML = "";
          state.globalSettings.fontUrl = "";
          await db.globalSettings.put(state.globalSettings);
          document.getElementById("font-url-input").value = "";
          document.getElementById("font-preview").style.fontFamily = "";
          alert("Â∑≤ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì„ÄÇ");
        }

        async function loadAllDataFromDB() {
          const [
            chatsArr,
            apiConfigs, // <-- ‰øÆÊîπËøôÈáå
            globalSettings,
            userStickers,
            worldBooks,
            musicLib,
            personaPresets,
            qzoneSettings,
            initialFavorites,
          ] = await Promise.all([
            db.chats.toArray(),
            db.apiConfigs.toArray(), // <-- ‰øÆÊîπËøôÈáå
            db.globalSettings.get("main"),
            db.userStickers.toArray(),
            db.worldBooks.toArray(),
            db.musicLibrary.get("main"),
            db.personaPresets.toArray(),
            db.qzoneSettings.get("main"),
            db.favorites.orderBy("timestamp").reverse().toArray(),
          ]);

          state.chats = chatsArr.reduce((acc, chat) => {
            if (typeof chat.unreadCount === "undefined") {
              chat.unreadCount = 0; // Â¶ÇÊûúËøô‰∏™ËÅäÂ§©ÂØπË±°Ê≤°Êúâ unreadCount Â±ûÊÄßÔºåÂ∞±ÁªôÂÆÉÂàùÂßãÂåñ‰∏∫ 0
            }

            // ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉÈáçÊûÑÔºöÊï∞ÊçÆËøÅÁßªËÑöÊú¨„Äë‚òÖ‚òÖ‚òÖ
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁæ§ËÅäÔºåÂπ∂‰∏îÂÖ∂ÊàêÂëòÂØπË±°‰ΩøÁî®ÁöÑÊòØÊóßÁöÑ `name` ÁªìÊûÑ
            if (
              chat.isGroup &&
              chat.members &&
              chat.members.length > 0 &&
              chat.members[0].name
            ) {
              console.log(
                `Ê£ÄÊµãÂà∞ÊóßÁâàÁæ§ËÅäÊï∞ÊçÆ for "${chat.name}"ÔºåÊ≠£Âú®ÊâßË°åËøÅÁßª...`,
              );
              chat.members.forEach((member) => {
                // Â¶ÇÊûúËøô‰∏™ÊàêÂëòÂØπË±°Ê≤°Êúâ originalNameÔºåËØ¥ÊòéÊòØÊóßÊï∞ÊçÆ
                if (typeof member.originalName === "undefined") {
                  member.originalName = member.name; // Â∞ÜÊóßÁöÑ name ‰Ωú‰∏∫ originalName
                  member.groupNickname = member.name; // ÂêåÊó∂ÂàõÂª∫‰∏Ä‰∏™ÂàùÂßãÁöÑ groupNickname
                  delete member.name; // Âà†Èô§ÊóßÁöÑ„ÄÅÊúâÊ≠ß‰πâÁöÑ name Â≠óÊÆµ
                  needsUpdate = true; // Ê†áËÆ∞ÈúÄË¶ÅÂ≠òÂõûÊï∞ÊçÆÂ∫ì
                }
              });
              console.log(`ËøÅÁßªÂÆåÊàê for "${chat.name}"`);
            }

            // Ê£ÄÊü•1ÔºöÂ¶ÇÊûúÊòØ‰∏Ä‰∏™ÂçïËÅäÔºåÂπ∂‰∏îÊ≤°Êúâ status Â±ûÊÄß
            if (!chat.isGroup && !chat.status) {
              // Â∞±‰∏∫ÂÆÉË°•‰∏ä‰∏Ä‰∏™ÈªòËÆ§ÁöÑ status ÂØπË±°
              chat.status = {
                text: "Âú®Á∫ø",
                lastUpdate: Date.now(),
                isBusy: false,
              };
              console.log(`‰∏∫ÊóßËßíËâ≤ "${chat.name}" Ë°•ÂÖ®‰∫ÜstatusÂ±ûÊÄß„ÄÇ`);
            }

            // Ê£ÄÊü•2ÔºöÂÖºÂÆπÊúÄÊñ∞ÁöÑ‚ÄúÂÖ≥Á≥ª‚ÄùÂäüËÉΩ
            if (!chat.isGroup && !chat.relationship) {
              // Â¶ÇÊûúÊòØÂçïËÅäÔºå‰∏îÊ≤°Êúâ relationship ÂØπË±°ÔºåÂ∞±Ë°•‰∏ä‰∏Ä‰∏™ÈªòËÆ§ÁöÑ
              chat.relationship = {
                status: "friend",
                blockedTimestamp: null,
                applicationReason: "",
              };
              console.log(`‰∏∫ÊóßËßíËâ≤ "${chat.name}" Ë°•ÂÖ®‰∫Ü relationship Â±ûÊÄß„ÄÇ`);
            }

            if (
              !chat.isGroup &&
              (!chat.settings || !chat.settings.aiAvatarLibrary)
            ) {
              if (!chat.settings) chat.settings = {}; // ‰ª•Èò≤‰∏á‰∏ÄËøûsettingsÈÉΩÊ≤°Êúâ
              chat.settings.aiAvatarLibrary = [];
              console.log(
                `‰∏∫ÊóßËßíËâ≤ "${chat.name}" Ë°•ÂÖ®‰∫ÜaiAvatarLibraryÂ±ûÊÄß„ÄÇ`,
              );
            }

            if (!chat.settings.summary) {
              chat.settings.summary = {
                enabled: false,
                mode: "manual", // 'manual' or 'auto'
                count: 50, // summarize every 50 messages
                prompt: "ËØ∑ÊÄªÁªì‰∏äËø∞ÂØπËØùÁöÑ‰∏ªË¶ÅÂÜÖÂÆπÔºå‰øùÁïôÈáçË¶Å‰ø°ÊÅØÂíåÊÉÖÊÑüËÑâÁªú„ÄÇ",
                lastSummaryIndex: -1,
              };
            }

            if (!chat.musicData) chat.musicData = { totalTime: 0 };
            if (
              chat.settings &&
              chat.settings.linkedWorldBookId &&
              !chat.settings.linkedWorldBookIds
            ) {
              chat.settings.linkedWorldBookIds = [
                chat.settings.linkedWorldBookId,
              ];
              delete chat.settings.linkedWorldBookId;
            }
            acc[chat.id] = chat;
            return acc;
          }, {});
          state.apiConfigs = apiConfigs || [];

          state.globalSettings = globalSettings || {
            id: "main",
            wallpaper: "linear-gradient(135deg, #89f7fe, #66a6ff)",
            fontUrl: "",
            enableBackgroundActivity: false,
            backgroundActivityInterval: 60,
            blockCooldownHours: 1,
            appIcons: { ...DEFAULT_APP_ICONS }, // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÁ°Æ‰øùappIconsÂ≠òÂú®Âπ∂ÊúâÈªòËÆ§ÂÄº
            framelessOnMobile: false, // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÈªòËÆ§‰∏çÂºÄÂêØÊó†ËæπÊ°ÜÊ®°Âºè
            frameColor: "#ffffff", // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÈªòËÆ§Â§ñÊ°ÜÈ¢úËâ≤
          };
          // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂêàÂπ∂Â∑≤‰øùÂ≠òÁöÑÂõæÊ†áÂíåÈªòËÆ§ÂõæÊ†áÔºåÈò≤Ê≠¢Êõ¥Êñ∞ÂêéÊóßÊï∞ÊçÆ‰∏¢Â§±Êñ∞ÂõæÊ†á
          state.globalSettings.appIcons = {
            ...DEFAULT_APP_ICONS,
            ...(state.globalSettings.appIcons || {}),
          };

          state.userStickers = userStickers || [];
          state.worldBooks = worldBooks || [];
          musicState.playlist = musicLib?.playlist || [];
          state.personaPresets = personaPresets || [];
          state.qzoneSettings = qzoneSettings || {
            id: "main",
            nickname: "{{user}}",
            avatar: "https://files.catbox.moe/q6z5fc.jpeg",
            banner: "https://files.catbox.moe/r5heyt.gif",
          };

          allFavoriteItems = initialFavorites || [];
        }

        async function saveGlobalPlaylist() {
          await db.musicLibrary.put({
            id: "main",
            playlist: musicState.playlist,
          });
        }

        function formatTimestamp(timestamp) {
          if (!timestamp) return "";
          const date = new Date(timestamp);
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          return `${hours}:${minutes}`;
        }

        function showNotification(chatId, messageContent) {
          clearTimeout(notificationTimeout);
          const chat = state.chats[chatId];
          if (!chat) return;
          const bar = document.getElementById("notification-bar");
          document.getElementById("notification-avatar").src =
            chat.settings.aiAvatar ||
            chat.settings.groupAvatar ||
            defaultAvatar;
          document
            .getElementById("notification-content")
            .querySelector(".name").textContent = chat.name;
          document
            .getElementById("notification-content")
            .querySelector(".message").textContent = messageContent;
          const newBar = bar.cloneNode(true);
          bar.parentNode.replaceChild(newBar, bar);
          newBar.addEventListener("click", () => {
            openChat(chatId);
            newBar.classList.remove("visible");
          });
          newBar.classList.add("visible");
          notificationTimeout = setTimeout(() => {
            newBar.classList.remove("visible");
          }, 4000);
        }

        function updateClock() {
          const now = new Date();
          const timeString = now.toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          });
          const dateString = now.toLocaleDateString("zh-CN", {
            weekday: "long",
            month: "long",
            day: "numeric",
          });
          document.getElementById("main-time").textContent = timeString;
          document.getElementById("status-bar-time").textContent = timeString;
          document.getElementById("main-date").textContent = dateString;
        }

        /**
         * „ÄêÁªàÊûÅÂÅ•Â£ÆÁâà„ÄëËß£ÊûêAIËøîÂõûÁöÑ„ÄÅÂèØËÉΩÊ†ºÂºè‰∏çËßÑËåÉÁöÑÂìçÂ∫îÂÜÖÂÆπ
         * @param {string} content - AIËøîÂõûÁöÑÂéüÂßãÂ≠óÁ¨¶‰∏≤
         * @returns {Array} - ‰∏Ä‰∏™Ê†áÂáÜÂåñÁöÑÊ∂àÊÅØÂØπË±°Êï∞ÁªÑ
         */
        function parseAiResponse(content) {
          const trimmedContent = content.trim();

          // ÊñπÊ°à1Ôºö„ÄêÊúÄ‰ºòÂÖà„ÄëÂ∞ùËØï‰Ωú‰∏∫Ê†áÂáÜÁöÑ„ÄÅÂçï‰∏ÄÁöÑJSONÊï∞ÁªÑËß£Êûê
          // ËøôÊòØÊúÄÁêÜÊÉ≥„ÄÅÊúÄÈ´òÊïàÁöÑÊÉÖÂÜµ
          if (trimmedContent.startsWith("[") && trimmedContent.endsWith("]")) {
            try {
              const parsed = JSON.parse(trimmedContent);
              if (Array.isArray(parsed)) {
                console.log("Ëß£ÊûêÊàêÂäüÔºöÊ†áÂáÜJSONÊï∞ÁªÑÊ†ºÂºè„ÄÇ");
                return parsed;
              }
            } catch (e) {
              // Â¶ÇÊûúËß£ÊûêÂ§±Ë¥•ÔºåËØ¥ÊòéÂÆÉËôΩÁÑ∂ÁúãËµ∑Êù•ÂÉè‰∏™Êï∞ÁªÑÔºå‰ΩÜÂÜÖÈÉ®Ê†ºÂºèÊúâÈóÆÈ¢ò„ÄÇ
              // Ê≠§Êó∂Êàë‰ª¨‰∏çÊä•ÈîôÔºåËÄåÊòØÁªßÁª≠Â∞ùËØï‰∏ãÈù¢ÁöÑ‚ÄúÂº∫ÂäõËß£Êûê‚ÄùÊñπÊ°à„ÄÇ
              console.warn("Ê†áÂáÜJSONÊï∞ÁªÑËß£ÊûêÂ§±Ë¥•ÔºåÂ∞ÜÂ∞ùËØïÂº∫ÂäõËß£Êûê...");
            }
          }

          // ÊñπÊ°à2Ôºö„ÄêÂº∫ÂäõËß£Êûê„Äë‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÔºå‰ªéÊ∑∑‰π±ÁöÑÂ≠óÁ¨¶‰∏≤‰∏≠ÊèêÂèñÂá∫ÊâÄÊúâÁã¨Á´ãÁöÑJSONÂØπË±°
          // ËøôËÉΩÂÆåÁæéËß£ÂÜ≥ÊÇ®ÈÅáÂà∞ÁöÑ "(Timestamp: ...)[{...}](Timestamp: ...)[{...}]" ËøôÁßçÊ†ºÂºè
          const jsonMatches = trimmedContent.match(/{[^{}]*}/g);

          if (jsonMatches) {
            const results = [];
            for (const match of jsonMatches) {
              try {
                // Â∞ùËØïËß£ÊûêÊØè‰∏Ä‰∏™Ë¢´Êàë‰ª¨‚ÄúÊè™‚ÄùÂá∫Êù•ÁöÑJSONÂ≠óÁ¨¶‰∏≤
                const parsedObject = JSON.parse(match);
                results.push(parsedObject);
              } catch (e) {
                // Â¶ÇÊûúÊüê‰∏™ÁâáÊÆµ‰∏çÊòØÊúâÊïàÁöÑJSONÔºåÂ∞±ÂøΩÁï•ÂÆÉÔºåÁªßÁª≠Â§ÑÁêÜ‰∏ã‰∏Ä‰∏™
                console.warn("Ë∑≥Ëøá‰∏Ä‰∏™Êó†ÊïàÁöÑJSONÁâáÊÆµ:", match);
              }
            }

            // Â¶ÇÊûúÊàë‰ª¨ÊàêÂäüÊèêÂèñÂá∫‰∫ÜËá≥Â∞ë‰∏Ä‰∏™ÊúâÊïàÁöÑJSONÂØπË±°ÔºåÂ∞±ËøîÂõûËøô‰∏™ÁªìÊûú
            if (results.length > 0) {
              console.log("Ëß£ÊûêÊàêÂäüÔºöÈÄöËøáÂº∫ÂäõÊèêÂèñÊ®°Âºè„ÄÇ");
              return results;
            }
          }

          // ÊñπÊ°à3Ôºö„ÄêÊúÄÁªàÂ§áÁî®„ÄëÂ¶ÇÊûú‰ª•‰∏äÊâÄÊúâÊñπÊ≥ïÈÉΩÂ§±Ë¥•‰∫ÜÔºåËØ¥ÊòéAIËøîÂõûÁöÑÂèØËÉΩÂ∞±ÊòØÁ∫ØÊñáÊú¨
          // Êàë‰ª¨Â∞ÜÂéüÂßãÁöÑ„ÄÅÊú™Â§ÑÁêÜÁöÑÂÜÖÂÆπÔºåÂåÖË£ÖÊàê‰∏Ä‰∏™Ê†áÂáÜÁöÑÊñáÊú¨Ê∂àÊÅØÂØπË±°ËøîÂõûÔºåÁ°Æ‰øùÁ®ãÂ∫è‰∏ç‰ºöÂ¥©Ê∫É
          console.error("ÊâÄÊúâËß£ÊûêÊñπÊ°àÂùáÂ§±Ë¥•ÔºÅÂ∞ÜËøîÂõûÂéüÂßãÊñáÊú¨„ÄÇ");
          return [{ type: "text", content: content }];
        }

        function renderApiSettings() {
          // Ê∏≤ÊüìÂÖ∂‰ªñÂÖ®Â±ÄËÆæÁΩÆÔºà‰øùÊåÅ‰∏çÂèòÔºâ
          document.getElementById("background-activity-switch").checked =
            state.globalSettings.enableBackgroundActivity || false;
          document.getElementById("background-interval-input").value =
            state.globalSettings.backgroundActivityInterval || 60;
          document.getElementById("block-cooldown-input").value =
            state.globalSettings.blockCooldownHours || 1;

          // Ê∏≤ÊüìAPIÈÖçÁΩÆÂàóË°®
          const listEl = document.getElementById("api-configs-list");
          listEl.innerHTML = "";
          if (state.apiConfigs.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÈÖçÁΩÆÔºåËØ∑ÁÇπÂáª‚ÄúÊ∑ªÂä†‚ÄùÂàõÂª∫‰∏Ä‰∏™</p>';
          }

          const activeId = state.globalSettings.activeApiConfigId;

          state.apiConfigs.forEach((config) => {
            const item = document.createElement("div");
            item.className = "api-config-item";
            item.dataset.configId = config.id;
            item.innerHTML = `
              <div class="config-main">
                  <input type="radio" name="active_api_config" ${
                    config.id === activeId ? "checked" : ""
                  }>
                  <div class="config-details">
                      <span class="config-name">${config.name}</span>
                      <span class="config-url">${
                        config.url || "URLÊú™ËÆæÁΩÆ"
                      }</span>
                  </div>
              </div>
              <div class="config-actions">
                  <button type="button" class="edit-btn">ÁºñËæë</button>
                  <button type="button" class="delete-btn">Âà†Èô§</button>
              </div>
            `;
            listEl.appendChild(item);
          });
        }
        async function openApiConfigEditor(configId = null) {
          let config = {
            name: "",
            url: "",
            apiKey: "",
            model: "gpt-4o",
            enableStream: true,
            hideStreamResponse: false,
            temperature: 0.8, // ÈªòËÆ§ÂÄº
            topP: 1.0, // ÈªòËÆ§ÂÄº
            topK: 40, // ÈªòËÆ§ÂÄº
            enableTemp: false,
            enableTopP: false,
            enableTopK: false,
          };
          if (configId) {
            config = state.apiConfigs.find((c) => c.id === configId) || config;
          }

          // Â°´ÂÖÖÂü∫Êú¨‰ø°ÊÅØ
          document.getElementById("config-editor-id").value = configId || "";
          document.getElementById("config-name-input").value = config.name;
          document.getElementById("config-url-input").value = config.url;
          document.getElementById("config-key-input").value = config.apiKey;

          // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë ---
          // ÊØèÊ¨°ÊâìÂºÄÊó∂ÔºåÈÉΩÈáçÁΩÆÊ®°Âûã‰∏ãÊãâÂàóË°®ÔºåÂè™ÊòæÁ§∫ÂΩìÂâçÈÖçÁΩÆÂ∑≤‰øùÂ≠òÁöÑÊ®°Âûã
          const modelSelect = document.getElementById("config-model-select");
          // 1. Ê∏ÖÁ©∫ÊâÄÊúâÊóßÁöÑ <option> ÂÖÉÁ¥†
          modelSelect.innerHTML = "";
          // 2. ÂàõÂª∫‰∏Ä‰∏™Âè™ÂåÖÂê´ÂΩìÂâçÂ∑≤‰øùÂ≠òÊ®°ÂûãÁöÑÊñ∞ <option>
          const savedModelOption = document.createElement("option");
          savedModelOption.value = config.model;
          savedModelOption.textContent = config.model;
          savedModelOption.selected = true;
          // 3. Â∞ÜËøô‰∏™ÂîØ‰∏ÄÁöÑÈÄâÈ°πÊ∑ªÂä†Âà∞‰∏ãÊãâÂàóË°®‰∏≠
          modelSelect.appendChild(savedModelOption);
          // --- „Äê‰øÆÂ§çÁªìÊùü„Äë ---

          // --- ËøÅÁßªÈÄªËæëÔºöÂÖºÂÆπÊóßÁöÑ enableAdvancedParams ---
          // Â¶ÇÊûúÊóßÈÖçÁΩÆÊúâ enableAdvancedParamsÔºå‰ΩÜÊ≤°ÊúâÊñ∞ÁöÑÁã¨Á´ãÂºÄÂÖ≥ÔºåÂàôÁªßÊâøÊóßÂºÄÂÖ≥ÁöÑÂÄº
          if (config.enableAdvancedParams !== undefined) {
            if (config.enableTemp === undefined)
              config.enableTemp = config.enableAdvancedParams;
            if (config.enableTopP === undefined)
              config.enableTopP = config.enableAdvancedParams;
            if (config.enableTopK === undefined)
              config.enableTopK = config.enableAdvancedParams;
          }

          // Â°´ÂÖÖÂÄº
          document.getElementById("config-temperature-input").value =
            config.temperature !== undefined ? config.temperature : 0.8;
          document.getElementById("config-topp-input").value =
            config.topP !== undefined ? config.topP : 1.0;
          document.getElementById("config-topk-input").value =
            config.topK !== undefined ? config.topK : 40;

          // Â°´ÂÖÖÂºÄÂÖ≥Áä∂ÊÄÅ
          document.getElementById("config-stream-switch").checked =
            config.enableStream;
          document.getElementById("config-hide-stream-switch").checked =
            config.hideStreamResponse;

          const tempCheck = document.getElementById("config-enable-temp");
          const toppCheck = document.getElementById("config-enable-topp");
          const topkCheck = document.getElementById("config-enable-topk");
          const tempInput = document.getElementById("config-temperature-input");
          const toppInput = document.getElementById("config-topp-input");
          const topkInput = document.getElementById("config-topk-input");

          // ËÆæÁΩÆÂàùÂßãÁä∂ÊÄÅ (ÈªòËÆ§ false)
          tempCheck.checked = !!config.enableTemp;
          toppCheck.checked = !!config.enableTopP;
          topkCheck.checked = !!config.enableTopK;

          function updateInputState(checkbox, input) {
            input.disabled = !checkbox.checked;
            input.style.opacity = checkbox.checked ? "1" : "0.5";
          }

          // ÂàùÂßãÂåñ UI Áä∂ÊÄÅ
          updateInputState(tempCheck, tempInput);
          updateInputState(toppCheck, toppInput);
          updateInputState(topkCheck, topkInput);

          // ÁªëÂÆö‰∫ã‰ª∂
          tempCheck.onchange = (e) => updateInputState(e.target, tempInput);
          toppCheck.onchange = (e) => updateInputState(e.target, toppInput);
          topkCheck.onchange = (e) => updateInputState(e.target, topkInput);

          // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
          document
            .getElementById("api-config-editor-modal")
            .classList.add("visible");
        }

        async function saveApiConfig() {
          const id = document.getElementById("config-editor-id").value;

          // Ëé∑ÂèñÂπ∂È™åËØÅÊñ∞ÂèÇÊï∞
          let temp = parseFloat(
            document.getElementById("config-temperature-input").value,
          );
          let topP = parseFloat(
            document.getElementById("config-topp-input").value,
          );
          let topK = parseInt(
            document.getElementById("config-topk-input").value,
          );

          if (isNaN(temp)) temp = 0.8;
          if (isNaN(topP)) topP = 1.0;
          if (isNaN(topK)) topK = 40;

          const configData = {
            name:
              document.getElementById("config-name-input").value.trim() ||
              "Êú™ÂëΩÂêçÈÖçÁΩÆ",
            url: document.getElementById("config-url-input").value.trim(),
            apiKey: document.getElementById("config-key-input").value.trim(),
            model: document.getElementById("config-model-select").value,
            temperature: temp,
            topP: topP,
            topK: topK,
            // ‰øùÂ≠òÁã¨Á´ãÂºÄÂÖ≥Áä∂ÊÄÅ
            enableTemp: document.getElementById("config-enable-temp").checked,
            enableTopP: document.getElementById("config-enable-topp").checked,
            enableTopK: document.getElementById("config-enable-topk").checked,
            // ‰øùÁïôÊóßÂ≠óÊÆµ‰ª•Â§á‰∏çÊó∂‰πãÈúÄÔºàÊàñËÄÖÁõ¥Êé•ÂºÉÁî®ÔºåËøôÈáåÈÄâÊã©Êõ¥Êñ∞ÂÆÉ‰∏∫ OR ÈÄªËæëÔºåÊàñÁõ¥Êé•ÂøΩÁï•Ôºâ
            // ‰∏∫‰∫ÜÊï¥Ê¥ÅÔºåÊàë‰ª¨‰∏çÂÜç‰øùÂ≠ò enableAdvancedParamsÔºåÂõ†‰∏∫ÂÆÉÂ∑≤ÁªèË¢´ÊãÜÂàÜ‰∫Ü„ÄÇ
            enableStream: document.getElementById("config-stream-switch")
              .checked,
            hideStreamResponse: document.getElementById(
              "config-hide-stream-switch",
            ).checked,
          };

          if (id) {
            // Êõ¥Êñ∞
            configData.id = parseInt(id);
            await db.apiConfigs.put(configData);
            const index = state.apiConfigs.findIndex(
              (c) => c.id === configData.id,
            );
            if (index > -1) state.apiConfigs[index] = configData;
          } else {
            // Êñ∞Â¢û
            const newId = await db.apiConfigs.add(configData);
            configData.id = newId;
            state.apiConfigs.push(configData);
            // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™ÈÖçÁΩÆÔºåËá™Âä®ËÆæ‰∏∫ÊøÄÊ¥ª
            if (state.apiConfigs.length === 1) {
              state.globalSettings.activeApiConfigId = newId;
              await db.globalSettings.put(state.globalSettings);
            }
          }

          renderApiSettings();
          document
            .getElementById("api-config-editor-modal")
            .classList.remove("visible");
        }

        async function setActiveApiConfig(configId) {
          state.globalSettings.activeApiConfigId = configId;
          await db.globalSettings.put(state.globalSettings);
          // ÂèØ‰ª•Âú®ËøôÈáåÁªô‰∏Ä‰∏™ËΩªÈáèÊèêÁ§∫ÔºåÊàñËÄÖ‰ªÄ‰πàÈÉΩ‰∏çÂÅö
          console.log(`Active API config set to ID: ${configId}`);
        }
        window.renderApiSettingsProxy = renderApiSettings;

        async function renderChatList() {
          const chatListEl = document.getElementById("chat-list");
          chatListEl.innerHTML = "";

          // 1. ÂÉè‰ª•Ââç‰∏ÄÊ†∑ÔºåËé∑ÂèñÊâÄÊúâËÅäÂ§©Âπ∂ÊåâÊúÄÊñ∞Ê∂àÊÅØÊó∂Èó¥ÊéíÂ∫è
          const allChats = Object.values(state.chats).sort(
            (a, b) =>
              (b.history.slice(-1)[0]?.timestamp || 0) -
              (a.history.slice(-1)[0]?.timestamp || 0),
          );

          // 2. Ëé∑ÂèñÊâÄÊúâÂàÜÁªÑ
          const allGroups = await db.qzoneGroups.toArray();

          if (allChats.length === 0) {
            chatListEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÊàñÁæ§ÁªÑÂõæÊ†áÊ∑ªÂä†ËÅäÂ§©</p>';
            return;
          }

          // --- „ÄêÊ†∏ÂøÉ‰øÆÊ≠£ÂºÄÂßã„Äë---

          // 3. ‰∏∫ÊØè‰∏™ÂàÜÁªÑÊâæÂà∞ÂÖ∂ÂÜÖÈÉ®ÊúÄÊñ∞ÁöÑÊ∂àÊÅØÊó∂Èó¥Êà≥
          allGroups.forEach((group) => {
            // ‰ªéÂ∑≤ÊéíÂ∫èÁöÑ allChats ‰∏≠ÊâæÂà∞Êú¨ÁªÑÁöÑÁ¨¨‰∏Ä‰∏™Ôºà‰πüÂ∞±ÊòØÊúÄÊñ∞ÁöÑÔºâËÅäÂ§©
            const latestChatInGroup = allChats.find(
              (chat) => chat.groupId === group.id,
            );
            // Â¶ÇÊûúÊâæÂà∞‰∫ÜÔºåÂ∞±Áî®ÂÆÉÁöÑÊó∂Èó¥Êà≥ÔºõÂ¶ÇÊûúËØ•ÂàÜÁªÑÊöÇÊó∂Ê≤°ÊúâËÅäÂ§©ÊàñËÅäÂ§©Ê≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÂ∞±Áî®0
            group.latestTimestamp = latestChatInGroup
              ? latestChatInGroup.history.slice(-1)[0]?.timestamp || 0
              : 0;
          });

          // 4. Ê†πÊçÆËøô‰∏™ÊúÄÊñ∞ÁöÑÊó∂Èó¥Êà≥Êù•ÂØπ‚ÄúÂàÜÁªÑÊú¨Ë∫´‚ÄùËøõË°åÊéíÂ∫è
          allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

          // --- „ÄêÊ†∏ÂøÉ‰øÆÊ≠£ÁªìÊùü„Äë---

          // 5. Áé∞Âú®ÔºåÊàë‰ª¨ÊåâÁÖßÊéíÂ•ΩÂ∫èÁöÑÂàÜÁªÑÊù•Ê∏≤Êüì
          allGroups.forEach((group) => {
            // ‰ªéÊÄªÂàóË°®ÈáåËøáÊª§Âá∫Â±û‰∫éËøô‰∏™ÔºàÂ∑≤ÊéíÂ∫èÔºâÂàÜÁªÑÁöÑÂ•ΩÂèã
            const groupChats = allChats.filter(
              (chat) => !chat.isGroup && chat.groupId === group.id,
            );
            // Â¶ÇÊûúËøô‰∏™ÂàÜÁªÑÊòØÁ©∫ÁöÑÔºàÂèØËÉΩÊâÄÊúâÂ•ΩÂèãÈÉΩË¢´Âà†‰∫ÜÔºâÔºåÂ∞±Ë∑≥Ëøá
            if (groupChats.length === 0) return;

            const groupContainer = document.createElement("div");
            groupContainer.className = "chat-group-container";
            groupContainer.innerHTML = `
                  <div class="chat-group-header">
                      <span class="group-name">${group.name}</span>
                  </div>
                  <div class="chat-group-content"></div>
              `;
            const contentEl = groupContainer.querySelector(
              ".chat-group-content",
            );
            // Âõ†‰∏∫ allChats Êú¨Ë∫´Â∞±ÊòØÊúâÂ∫èÁöÑÔºåÊâÄ‰ª• groupChats Ëá™ÁÑ∂‰πüÊòØÊúâÂ∫èÁöÑ
            groupChats.forEach((chat) => {
              const item = createChatListItem(chat);
              contentEl.appendChild(item);
            });
            chatListEl.appendChild(groupContainer);
          });

          // 6. ÊúÄÂêéÔºåÊ∏≤ÊüìÊâÄÊúâÁæ§ËÅäÂíåÊú™ÂàÜÁªÑÁöÑÂ•ΩÂèã
          // ‰ªñ‰ª¨ÁöÑÈ°∫Â∫èÂõ†‰∏∫ allChats ÁöÑÂàùÂßãÊéíÂ∫èÔºåÂ§©ÁÑ∂Â∞±ÊòØÊ≠£Á°ÆÁöÑ
          const ungroupedOrGroupChats = allChats.filter(
            (chat) => chat.isGroup || (!chat.isGroup && !chat.groupId),
          );
          ungroupedOrGroupChats.forEach((chat) => {
            const item = createChatListItem(chat);
            chatListEl.appendChild(item);
          });

          // ‰∏∫ÊâÄÊúâÂàÜÁªÑÊ†áÈ¢òÊ∑ªÂä†ÊäòÂè†‰∫ã‰ª∂
          document.querySelectorAll(".chat-group-header").forEach((header) => {
            header.addEventListener("click", () => {
              header.classList.toggle("collapsed");
              header.nextElementSibling.classList.toggle("collapsed");
            });
          });
        }

        function createChatListItem(chat) {
          const lastMsgObj =
            chat.history.filter((msg) => !msg.isHidden).slice(-1)[0] || {};
          let lastMsgDisplay;

          if (
            !chat.isGroup &&
            chat.relationship?.status === "pending_user_approval"
          ) {
            lastMsgDisplay = `<span style="color: #ff8c00;">[Â•ΩÂèãÁî≥ËØ∑] ${
              chat.relationship.applicationReason || "ËØ∑Ê±ÇÊ∑ªÂä†‰Ω†‰∏∫Â•ΩÂèã"
            }</span>`;
          } else if (
            !chat.isGroup &&
            chat.relationship?.status === "blocked_by_ai"
          ) {
            lastMsgDisplay = `<span style="color: #dc3545;">[‰Ω†Â∑≤Ë¢´ÂØπÊñπÊãâÈªë]</span>`;
          }

          // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë‰ºòÂÖàÊòæÁ§∫Áä∂ÊÄÅÔºåËÄå‰∏çÊòØÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ
          if (chat.isGroup) {
            // Áæ§ËÅäÈÄªËæë‰øùÊåÅ‰∏çÂèò
            if (lastMsgObj.type === "pat_message") {
              lastMsgDisplay = `[Á≥ªÁªüÊ∂àÊÅØ] ${lastMsgObj.content}`;
            }
            // ... (ÂÖ∂‰ªñÁæ§ËÅäÊ∂àÊÅØÁ±ªÂûãÂà§Êñ≠) ...
            else if (lastMsgObj.type === "transfer") {
              lastMsgDisplay = "[ËΩ¨Ë¥¶]";
            } else if (
              lastMsgObj.type === "ai_image" ||
              lastMsgObj.type === "user_photo"
            ) {
              lastMsgDisplay = "[ÁÖßÁâá]";
            } else if (lastMsgObj.type === "voice_message") {
              lastMsgDisplay = "[ËØ≠Èü≥]";
            } else if (
              typeof lastMsgObj.content === "string" &&
              STICKER_REGEX.test(lastMsgObj.content)
            ) {
              lastMsgDisplay = lastMsgObj.meaning
                ? `[Ë°®ÊÉÖ: ${lastMsgObj.meaning}]`
                : "[Ë°®ÊÉÖ]";
            } else if (Array.isArray(lastMsgObj.content)) {
              lastMsgDisplay = `[ÂõæÁâá]`;
            } else {
              lastMsgDisplay = String(lastMsgObj.content || "...").substring(
                0,
                20,
              );
            }

            if (lastMsgObj.senderName && lastMsgObj.type !== "pat_message") {
              lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`;
            }
          } else {
            // ÂçïËÅäÈÄªËæëÔºöÊòæÁ§∫Áä∂ÊÄÅ
            // Á°Æ‰øù chat.status ÂØπË±°Â≠òÂú®
            const statusText = chat.status?.text || "Âú®Á∫ø";
            lastMsgDisplay = `[${statusText}]`;
          }

          const item = document.createElement("div");
          item.className = "chat-list-item";
          item.dataset.chatId = chat.id;
          const avatar = chat.isGroup
            ? chat.settings.groupAvatar
            : chat.settings.aiAvatar;

          item.innerHTML = `
              <img src="${avatar || defaultAvatar}" class="avatar">
              <div class="info">
                  <div class="name-line">
                      <span class="name">${chat.name}</span>
                      ${
                        chat.isGroup
                          ? '<span class="group-tag">Áæ§ËÅä</span>'
                          : ""
                      }
                  </div>
                  <div class="last-msg" style="color: ${
                    chat.isGroup ? "var(--text-secondary)" : "#b5b5b5"
                  }; font-style: italic;">${lastMsgDisplay}</div>
              </div>
              <!-- ËøôÈáåÂ∞±ÊòØÊàë‰ª¨Êñ∞Âä†ÁöÑÁ∫¢ÁÇπHTMLÁªìÊûÑ -->
              <div class="unread-count-wrapper">
                  <span class="unread-count" style="display: none;">0</span>
              </div>
          `;

          // „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÂú®ËøôÈáåÊ∑ªÂä†ÊéßÂà∂Á∫¢ÁÇπÊòæÁ§∫/ÈöêËóèÁöÑÈÄªËæë
          const unreadCount = chat.unreadCount || 0;
          const unreadEl = item.querySelector(".unread-count");
          if (unreadCount > 0) {
            unreadEl.textContent = unreadCount > 99 ? "99+" : unreadCount;
            // Ê≥®ÊÑèËøôÈáåÊòØ 'inline-flex'Ôºå‰∏éÊàë‰ª¨ÁöÑCSSÂØπÂ∫îÔºå‰ΩøÂÖ∂ÂûÇÁõ¥Â±Ö‰∏≠
            unreadEl.style.display = "inline-flex";
          } else {
            unreadEl.style.display = "none";
          }

          const avatarEl = item.querySelector(".avatar");
          if (avatarEl) {
            avatarEl.style.cursor = "pointer";
            avatarEl.addEventListener("click", (e) => {
              e.stopPropagation();
              handleUserPat(chat.id, chat.name);
            });
          }

          const infoEl = item.querySelector(".info");
          if (infoEl) {
            infoEl.addEventListener("click", () => openChat(chat.id));
          }

          addLongPressListener(item, async (e) => {
            const confirmed = await showCustomConfirm(
              "Âà†Èô§ÂØπËØù",
              `Á°ÆÂÆöË¶ÅÂà†Èô§‰∏é "${chat.name}" ÁöÑÊï¥‰∏™ÂØπËØùÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`,
              { confirmButtonClass: "btn-danger" },
            );
            if (confirmed) {
              if (musicState.isActive && musicState.activeChatId === chat.id)
                await endListenTogetherSession(false);
              delete state.chats[chat.id];
              if (state.activeChatId === chat.id) state.activeChatId = null;
              await db.chats.delete(chat.id);
              renderChatList();
            }
          });
          return item;
        }

        function renderChatInterface(chatId) {
          cleanupWaimaiTimers();
          const chat = state.chats[chatId];
          if (!chat) return;
          exitSelectionMode();

          const messagesContainer = document.getElementById("chat-messages");
          const chatInputArea = document.getElementById("chat-input-area");
          const lockOverlay = document.getElementById("chat-lock-overlay");
          const lockContent = document.getElementById("chat-lock-content");

          messagesContainer.dataset.theme = chat.settings.theme || "default";
          const fontSize = chat.settings.fontSize || 13;
          messagesContainer.style.setProperty(
            "--chat-font-size",
            `${fontSize}px`,
          );
          applyScopedCss(
            chat.settings.customCss || "",
            "#chat-messages",
            "custom-bubble-style",
          );

          document.getElementById("chat-header-title").textContent = chat
            .settings.aiRemark
            ? `${chat.name} | ${chat.settings.aiRemark}`
            : chat.name;
          const statusContainer = document.getElementById("chat-header-status");
          const statusTextEl = statusContainer.querySelector(".status-text");

          if (chat.isGroup) {
            statusContainer.style.display = "none";
            document.getElementById(
              "chat-header-title-wrapper",
            ).style.justifyContent = "center";
          } else {
            statusContainer.style.display = "flex";
            document.getElementById(
              "chat-header-title-wrapper",
            ).style.justifyContent = "flex-start";
            statusTextEl.textContent = chat.status?.text || "Âú®Á∫ø";
            statusContainer.classList.toggle(
              "busy",
              chat.status?.isBusy || false,
            );
          }

          lockOverlay.style.display = "none";
          chatInputArea.style.visibility = "visible";
          lockContent.innerHTML = "";

          if (!chat.isGroup && chat.relationship.status !== "friend") {
            lockOverlay.style.display = "flex";
            chatInputArea.style.visibility = "hidden";

            let lockHtml = "";
            switch (chat.relationship.status) {
              case "blocked_by_user":
                // --- „ÄêÊ†∏ÂøÉ‰øÆÊîπÔºöÂú®ËøôÈáåÂä†ÂÖ•ËØäÊñ≠Èù¢Êùø„Äë ---
                const isSimulationRunning = simulationIntervalId !== null;
                const blockedTimestamp = chat.relationship.blockedTimestamp;
                const cooldownHours =
                  state.globalSettings.blockCooldownHours || 1;
                const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                const timeSinceBlock = Date.now() - blockedTimestamp;
                const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                const timeRemainingMinutes = Math.max(
                  0,
                  Math.ceil(
                    (cooldownMilliseconds - timeSinceBlock) / (1000 * 60),
                  ),
                );

                lockHtml = `
                          <span class="lock-text">‰Ω†Â∑≤Â∞Ü‚Äú${
                            chat.name
                          }‚ÄùÊãâÈªë„ÄÇ</span>
                          <button id="unblock-btn" class="lock-action-btn">Ëß£Èô§ÊãâÈªë</button>
                          <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                              <strong style="color: #333;">„ÄêÂºÄÂèëËÄÖËØäÊñ≠Èù¢Êùø„Äë</strong><br>
                              - ÂêéÂè∞Ê¥ªÂä®ÊÄªÂºÄÂÖ≥: ${
                                state.globalSettings.enableBackgroundActivity
                                  ? '<span style="color: green;">Â∑≤ÂºÄÂêØ</span>'
                                  : '<span style="color: red;">Â∑≤ÂÖ≥Èó≠</span>'
                              }<br>
                              - Á≥ªÁªüÂøÉË∑≥ËÆ°Êó∂Âô®: ${
                                isSimulationRunning
                                  ? '<span style="color: green;">ËøêË°å‰∏≠</span>'
                                  : '<span style="color: red;">Êú™ËøêË°å</span>'
                              }<br>
                              - ÂΩìÂâçËßíËâ≤Áä∂ÊÄÅ: <strong>${
                                chat.relationship.status
                              }</strong><br>
                              - ÈúÄË¶ÅÂÜ∑Èùô(Â∞èÊó∂): <strong>${cooldownHours}</strong><br>
                              - ÂÜ∑ÈùôÊúüÊòØÂê¶ÁªìÊùü: ${
                                isCooldownOver
                                  ? '<span style="color: green;">ÊòØ</span>'
                                  : `<span style="color: orange;">Âê¶ (ËøòÂâ©Á∫¶ ${timeRemainingMinutes} ÂàÜÈíü)</span>`
                              }<br>
                              - Ëß¶ÂèëÊù°‰ª∂: ${
                                isCooldownOver &&
                                state.globalSettings.enableBackgroundActivity
                                  ? '<span style="color: green;">Â∑≤Êª°Ë∂≥ÔºåÁ≠âÂæÖ‰∏ãÊ¨°Á≥ªÁªüÂøÉË∑≥</span>'
                                  : '<span style="color: red;">Êú™Êª°Ë∂≥</span>'
                              }
                          </div>
                          <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">Âº∫Âà∂Ëß¶Âèë‰∏ÄÊ¨°Â•ΩÂèãÁî≥ËØ∑Ê£ÄÊµã</button>
                      `;
                // --- „Äê‰øÆÊîπÁªìÊùü„Äë ---
                break;
              case "blocked_by_ai":
                lockHtml = `
                          <span class="lock-text">‰Ω†Ë¢´ÂØπÊñπÊãâÈªë‰∫Ü„ÄÇ</span>
                          <button id="apply-friend-btn" class="lock-action-btn">ÈáçÊñ∞Áî≥ËØ∑Âä†‰∏∫Â•ΩÂèã</button>
                      `;
                break;

              case "pending_user_approval":
                lockHtml = `
                          <span class="lock-text">‚Äú${chat.name}‚ÄùËØ∑Ê±ÇÊ∑ªÂä†‰Ω†‰∏∫Â•ΩÂèãÔºö<br><i>‚Äú${chat.relationship.applicationReason}‚Äù</i></span>
                          <button id="accept-friend-btn" class="lock-action-btn">Êé•Âèó</button>
                          <button id="reject-friend-btn" class="lock-action-btn secondary">ÊãíÁªù</button>
                      `;
                break;

              // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„Äë‰øÆÂ§çÂΩì‰Ω†Áî≥ËØ∑ÂêéÔºå‰Ω†ÁúãÂà∞ÁöÑÁïåÈù¢
              case "pending_ai_approval":
                lockHtml = `<span class="lock-text">Â•ΩÂèãÁî≥ËØ∑Â∑≤ÂèëÈÄÅÔºåÁ≠âÂæÖÂØπÊñπÈÄöËøá...</span>`;
                break;
            }
            lockContent.innerHTML = lockHtml;
          }
          messagesContainer.innerHTML = "";
          // ...ÂêéÁª≠‰ª£Á†Å‰øùÊåÅ‰∏çÂèò
          const chatScreen = document.getElementById("chat-interface-screen");
          chatScreen.style.backgroundImage = chat.settings.background
            ? `url(${chat.settings.background})`
            : "none";

          const isDarkMode = document
            .getElementById("phone-screen")
            .classList.contains("dark-mode");
          chatScreen.style.backgroundColor = chat.settings.background
            ? "transparent"
            : isDarkMode
              ? "#000000"
              : "#f0f2f5";
          const history = chat.history;
          const totalMessages = history.length;
          currentRenderedCount = 0;
          const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
          initialMessages.forEach((msg) => appendMessage(msg, chat, true));
          currentRenderedCount = initialMessages.length;
          if (totalMessages > currentRenderedCount) {
            prependLoadMoreButton(messagesContainer);
          }
          const typingIndicator = document.createElement("div");
          typingIndicator.id = "typing-indicator";
          typingIndicator.style.display = "none";
          typingIndicator.innerHTML =
            '<div class="system-bubble">ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...</div>';
          messagesContainer.appendChild(typingIndicator);
          setTimeout(
            () =>
              (messagesContainer.scrollTop = messagesContainer.scrollHeight),
            0,
          );
        }

        function prependLoadMoreButton(container) {
          const button = document.createElement("button");
          button.id = "load-more-btn";
          button.textContent = "Âä†ËΩΩÊõ¥Êó©ÁöÑËÆ∞ÂΩï";
          button.addEventListener("click", loadMoreMessages);
          container.prepend(button);
        }

        function loadMoreMessages() {
          const messagesContainer = document.getElementById("chat-messages");
          const chat = state.chats[state.activeChatId];
          if (!chat) return;
          const loadMoreBtn = document.getElementById("load-more-btn");
          if (loadMoreBtn) loadMoreBtn.remove();
          const totalMessages = chat.history.length;
          const nextSliceStart =
            totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW;
          const nextSliceEnd = totalMessages - currentRenderedCount;
          const messagesToPrepend = chat.history.slice(
            Math.max(0, nextSliceStart),
            nextSliceEnd,
          );
          const oldScrollHeight = messagesContainer.scrollHeight;
          messagesToPrepend
            .reverse()
            .forEach((msg) => prependMessage(msg, chat));
          currentRenderedCount += messagesToPrepend.length;
          const newScrollHeight = messagesContainer.scrollHeight;
          messagesContainer.scrollTop += newScrollHeight - oldScrollHeight;
          if (totalMessages > currentRenderedCount) {
            prependLoadMoreButton(messagesContainer);
          }
        }

        function renderWallpaperScreen() {
          const preview = document.getElementById("wallpaper-preview");
          const bg = newWallpaperBase64 || state.globalSettings.wallpaper;
          if (bg && bg.startsWith("data:image")) {
            preview.style.backgroundImage = `url(${bg})`;
            preview.textContent = "";
          } else if (bg) {
            preview.style.backgroundImage = bg;
            preview.textContent = "ÂΩìÂâç‰∏∫Ê∏êÂèòËâ≤";
          }
          // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåË∞ÉÁî®ÂõæÊ†áÊ∏≤ÊüìÂáΩÊï∞
          renderIconSettings();

          const frameColorInput = document.getElementById("frame-color-input");
          const frameColorValue = document.getElementById("frame-color-value");
          const currentFrameColor =
            state.globalSettings.phoneFrameColor || "#ffffff";
          frameColorInput.value = currentFrameColor;
          frameColorValue.textContent = currentFrameColor;
        }
        window.renderWallpaperScreenProxy = renderWallpaperScreen;

        function applyGlobalWallpaper() {
          const homeScreen = document.getElementById("home-screen");
          const wallpaper = state.globalSettings.wallpaper;
          if (wallpaper && wallpaper.startsWith("data:image"))
            homeScreen.style.backgroundImage = `url(${wallpaper})`;
          else if (wallpaper) homeScreen.style.backgroundImage = wallpaper;

          const phoneFrame = document.getElementById("phone-frame");
          const customColor = state.globalSettings.phoneFrameColor;

          if (customColor) {
            phoneFrame.style.backgroundColor = customColor;
          } else {
            // Â¶ÇÊûúÊ≤°ÊúâËá™ÂÆö‰πâÈ¢úËâ≤ÔºåÂàôÊ∏ÖÈô§ÂÜÖËÅîÊ†∑ÂºèÔºåËÆ©CSSÁ±ªÔºàÂ¶Ç.dark-modeÔºâÁîüÊïà
            phoneFrame.style.backgroundColor = "";
          }
        }

        async function renderWorldBookScreen() {
          const listEl = document.getElementById("world-book-list");
          listEl.innerHTML = "";

          // 1. ÂêåÊó∂Ëé∑ÂèñÊâÄÊúâ‰π¶Á±çÂíåÊâÄÊúâÂàÜÁ±ª
          const [books, categories] = await Promise.all([
            db.worldBooks.toArray(),
            db.worldBookCategories.orderBy("name").toArray(),
          ]);

          state.worldBooks = books; // Á°Æ‰øùÂÜÖÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆÊòØÂêåÊ≠•ÁöÑ

          if (books.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏ÄÊú¨‰∏ñÁïå‰π¶</p>';
            return;
          }

          // 2. Â∞Ü‰π¶Á±çÊåâ categoryId ÂàÜÁªÑ
          const groupedBooks = books.reduce((acc, book) => {
            const key = book.categoryId || "uncategorized";
            if (!acc[key]) {
              acc[key] = [];
            }
            acc[key].push(book);
            return acc;
          }, {});

          // 3. ‰ºòÂÖàÊ∏≤ÊüìÂ∑≤ÂàÜÁ±ªÁöÑ‰π¶Á±ç
          categories.forEach((category) => {
            const booksInCategory = groupedBooks[category.id];
            if (booksInCategory && booksInCategory.length > 0) {
              const groupContainer = createWorldBookGroup(
                category.name,
                booksInCategory,
              );
              listEl.appendChild(groupContainer);
            }
          });

          // 4. ÊúÄÂêéÊ∏≤ÊüìÊú™ÂàÜÁ±ªÁöÑ‰π¶Á±ç
          const uncategorizedBooks = groupedBooks["uncategorized"];
          if (uncategorizedBooks && uncategorizedBooks.length > 0) {
            const groupContainer = createWorldBookGroup(
              "Êú™ÂàÜÁ±ª",
              uncategorizedBooks,
            );
            listEl.appendChild(groupContainer);
          }

          // 5. ‰∏∫ÊâÄÊúâÂàÜÁªÑÊ†áÈ¢òÊ∑ªÂä†ÊäòÂè†‰∫ã‰ª∂
          document
            .querySelectorAll(".world-book-group-header")
            .forEach((header) => {
              header.addEventListener("click", () => {
                header.classList.toggle("collapsed");
                header.nextElementSibling.classList.toggle("collapsed");
              });
            });
        }

        /**
         * „ÄêËæÖÂä©ÂáΩÊï∞„ÄëÂàõÂª∫‰∏Ä‰∏™ÂàÜÁ±ªÁöÑÂàÜÁªÑDOM
         * @param {string} groupName - ÂàÜÁ±ªÂêçÁß∞
         * @param {Array} books - ËØ•ÂàÜÁ±ª‰∏ãÁöÑ‰π¶Á±çÊï∞ÁªÑ
         * @returns {HTMLElement} - ÂàõÂª∫Â•ΩÁöÑÂàÜÁªÑÂÆπÂô®
         */
        function createWorldBookGroup(groupName, books) {
          const groupContainer = document.createElement("div");
          groupContainer.className = "world-book-group-container";

          groupContainer.innerHTML = `
              <div class="world-book-group-header">
                  <span class="group-name">${groupName}</span>
              </div>
              <div class="world-book-group-content"></div>
          `;

          const headerEl = groupContainer.querySelector(
            ".world-book-group-header",
          );
          const contentEl = groupContainer.querySelector(
            ".world-book-group-content",
          );

          // ÈªòËÆ§ÁªôÂ§¥ÈÉ®ÂíåÂÜÖÂÆπÂå∫ÈÉΩÂä†‰∏ä collapsed Á±ª
          headerEl.classList.add("collapsed");
          contentEl.classList.add("collapsed");

          books.sort((a, b) => a.name.localeCompare(b.name, "zh-CN"));
          books.forEach((book) => {
            const item = document.createElement("div");
            item.className = "list-item";
            item.dataset.bookId = book.id;
            item.innerHTML = `<div class="item-title">${
              book.name
            }</div><div class="item-content">${(
              book.content || "ÊöÇÊó†ÂÜÖÂÆπ..."
            ).substring(0, 50)}</div>`;
            item.addEventListener("click", () => openWorldBookEditor(book.id));
            addLongPressListener(item, async () => {
              const confirmed = await showCustomConfirm(
                "Âà†Èô§‰∏ñÁïå‰π¶",
                `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${book.name}„ÄãÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`,
                { confirmButtonClass: "btn-danger" },
              );
              if (confirmed) {
                await db.worldBooks.delete(book.id);
                state.worldBooks = state.worldBooks.filter(
                  (wb) => wb.id !== book.id,
                );
                renderWorldBookScreen();
              }
            });
            contentEl.appendChild(item);
          });

          return groupContainer;
        }
        window.renderWorldBookScreenProxy = renderWorldBookScreen;

        async function openWorldBookEditor(bookId) {
          editingWorldBookId = bookId;
          const [book, categories] = await Promise.all([
            db.worldBooks.get(bookId),
            db.worldBookCategories.toArray(),
          ]);
          if (!book) return;

          document.getElementById("world-book-editor-title").textContent =
            book.name;
          document.getElementById("world-book-name-input").value = book.name;
          document.getElementById("world-book-content-input").value =
            book.content;

          // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂ°´ÂÖÖÂàÜÁ±ª‰∏ãÊãâËèúÂçï
          const selectEl = document.getElementById(
            "world-book-category-select",
          );
          selectEl.innerHTML = '<option value="">-- Êú™ÂàÜÁ±ª --</option>'; // ÈªòËÆ§ÈÄâÈ°π
          categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.id;
            option.textContent = cat.name;
            if (book.categoryId === cat.id) {
              option.selected = true; // ÈÄâ‰∏≠ÂΩìÂâçÂàÜÁ±ª
            }
            selectEl.appendChild(option);
          });

          showScreen("world-book-editor-screen");
        }

        function renderStickerPanel() {
          const grid = document.getElementById("sticker-grid");
          grid.innerHTML = "";
          if (state.userStickers.length === 0) {
            grid.innerHTML =
              '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">Â§ß‰∫∫ËØ∑ÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÊàñ‚Äú‰∏ä‰º†‚ÄùÊù•Ê∑ªÂä†‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™Ë°®ÊÉÖÂêßÔºÅ</p>';
            return;
          }
          state.userStickers.forEach((sticker) => {
            const item = document.createElement("div");
            item.className = "sticker-item";
            item.style.backgroundImage = `url(${sticker.url})`;
            item.title = sticker.name;
            item.addEventListener("click", () => sendSticker(sticker));
            addLongPressListener(item, () => {
              if (isSelectionMode) return;
              const existingDeleteBtn = item.querySelector(".delete-btn");
              if (existingDeleteBtn) return;
              const deleteBtn = document.createElement("div");
              deleteBtn.className = "delete-btn";
              deleteBtn.innerHTML = "&times;";
              deleteBtn.onclick = async (e) => {
                e.stopPropagation();
                const confirmed = await showCustomConfirm(
                  "Âà†Èô§Ë°®ÊÉÖ",
                  `Á°ÆÂÆöË¶ÅÂà†Èô§Ë°®ÊÉÖ "${sticker.name}" ÂêóÔºü`,
                  { confirmButtonClass: "btn-danger" },
                );
                if (confirmed) {
                  await db.userStickers.delete(sticker.id);
                  state.userStickers = state.userStickers.filter(
                    (s) => s.id !== sticker.id,
                  );
                  renderStickerPanel();
                }
              };
              item.appendChild(deleteBtn);
              deleteBtn.style.display = "block";
              setTimeout(
                () =>
                  item.addEventListener(
                    "mouseleave",
                    () => deleteBtn.remove(),
                    { once: true },
                  ),
                3000,
              );
            });
            grid.appendChild(item);
          });
        }

        function createMessageElement(msg, chat) {
          if (msg.type === "recalled_message") {
            const wrapper = document.createElement("div");
            // 1. „ÄêÊ†∏ÂøÉ„ÄëÁªô wrapper ‰πüÂä†‰∏ä timestampÔºåÊñπ‰æø‰∫ã‰ª∂ÂßîÊâòÊó∂Êü•Êâæ
            wrapper.className = "message-wrapper system-pat";
            wrapper.dataset.timestamp = msg.timestamp;

            const bubble = document.createElement("div");
            // 2. „ÄêÊ†∏ÂøÉ„ÄëËÆ©Ëøô‰∏™ÂÖÉÁ¥†ÂêåÊó∂Êã•Êúâ .message-bubble Âíå .recalled-message-placeholder ‰∏§‰∏™class
            //    ËøôÊ†∑ÂÆÉÊó¢ËÉΩË¢´ÈÄâÊã©Á≥ªÁªüËØÜÂà´ÔºåÂèàËÉΩ‰øùÊåÅÂéüÊúâÁöÑÂ±Ö‰∏≠ÁÅ∞Ëâ≤Ê†∑Âºè
            bubble.className = "message-bubble recalled-message-placeholder";
            // 3. „ÄêÊ†∏ÂøÉ„ÄëÊää timestamp ÊîæÂú® bubble ‰∏äÔºåËøôÊòØÂ§öÈÄâÈÄªËæëÁöÑÂÖ≥ÈîÆ
            bubble.dataset.timestamp = msg.timestamp;
            bubble.textContent = msg.content;

            wrapper.appendChild(bubble);

            // 4. „ÄêÊ†∏ÂøÉ„Äë‰∏∫ÂÆÉË°•‰∏äÂíåÂÖ∂‰ªñÊ∂àÊÅØ‰∏ÄÊ†∑ÁöÑÊ†áÂáÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
            addLongPressListener(wrapper, () =>
              showMessageActions(msg.timestamp),
            );
            wrapper.addEventListener("click", () => {
              if (isSelectionMode) {
                toggleMessageSelection(msg.timestamp);
              }
            });

            // 5. „ÄêÈáçË¶Å„ÄëÂú®‰πãÂâçÁöÑ‚ÄúÁÇπÂáªÊü•ÁúãÂéüÊñá‚ÄùÁöÑÈÄªËæë‰∏≠ÔºåÊàë‰ª¨Â∑≤Áªè‰ΩøÁî®‰∫Ü‰∫ã‰ª∂ÂßîÊâòÔºåÊâÄ‰ª•ËøôÈáå‰∏çÈúÄË¶ÅÂÜçÂçïÁã¨‰∏∫Ëøô‰∏™ÂÖÉÁ¥†Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂‰∫Ü„ÄÇ
            //    init() ÂáΩÊï∞‰∏≠ÁöÑÈÇ£‰∏™‰∫ã‰ª∂ÁõëÂê¨Âô®‰ºöÂ§ÑÁêÜÂÆÉ„ÄÇ

            return wrapper;
          }

          if (msg.isHidden) {
            return null;
          }

          if (msg.type === "pat_message") {
            const wrapper = document.createElement("div");
            wrapper.className = "message-wrapper system-pat";
            const bubble = document.createElement("div");
            bubble.className = "message-bubble system-bubble";
            bubble.dataset.timestamp = msg.timestamp;
            bubble.textContent = msg.content;
            wrapper.appendChild(bubble);
            addLongPressListener(wrapper, () =>
              showMessageActions(msg.timestamp),
            );
            wrapper.addEventListener("click", () => {
              if (isSelectionMode) toggleMessageSelection(msg.timestamp);
            });
            return wrapper;
          }

          const isUser = msg.role === "user";
          const wrapper = document.createElement("div");
          wrapper.className = `message-wrapper ${isUser ? "user" : "ai"}`;

          // ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉÈáçÊûÑ„Äë‚òÖ‚òÖ‚òÖ
          // ËøôÊÆµÈÄªËæëÁé∞Âú®Áî®‰∫éÊü•ÊâæÊàêÂëòÂØπË±°ÔºåÂπ∂ÊòæÁ§∫ÂÖ∂‚ÄúÁæ§ÊòµÁß∞‚Äù
          if (chat.isGroup && !isUser) {
            // 1. ‰ΩøÁî®AIËøîÂõûÁöÑ‚ÄúÊú¨Âêç‚Äù(`msg.senderName`)ÂéªÂàóË°®ÈáåÊü•ÊâæÊàêÂëòÂØπË±°
            const member = chat.members.find(
              (m) => m.originalName === msg.senderName,
            );

            // 2. ÂàõÂª∫Áî®‰∫éÊòæÁ§∫ÂêçÂ≠óÁöÑ div
            const senderNameDiv = document.createElement("div");
            senderNameDiv.className = "sender-name";

            // 3. Â¶ÇÊûúÊâæÂà∞‰∫ÜÊàêÂëòÔºåÂ∞±ÊòæÁ§∫‰ªñÁöÑ‚ÄúÁæ§ÊòµÁß∞‚ÄùÔºõÂ¶ÇÊûúÊâæ‰∏çÂà∞ÔºåÂ∞±ÊòæÁ§∫AIËøîÂõûÁöÑ‚ÄúÊú¨Âêç‚Äù‰Ωú‰∏∫Â§áÁî®
            senderNameDiv.textContent = member
              ? member.groupNickname
              : msg.senderName || "Êú™Áü•ÊàêÂëò";

            wrapper.appendChild(senderNameDiv);
          }

          const bubble = document.createElement("div");
          bubble.className = `message-bubble ${isUser ? "user" : "ai"}`;
          bubble.dataset.timestamp = msg.timestamp;

          const timestampEl = document.createElement("span");
          timestampEl.className = "timestamp";
          timestampEl.textContent = formatTimestamp(msg.timestamp);

          let avatarSrc; // Êàë‰ª¨Áé∞Âú®Âè™ÈúÄË¶ÅÂ§¥ÂÉèÂõæÁâáÔºå‰∏çÂÜçÈúÄË¶ÅÂ§¥ÂÉèÊ°Ü‰∫Ü
          if (chat.isGroup) {
            if (isUser) {
              avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
            } else {
              const member = chat.members.find(
                (m) => m.originalName === msg.senderName,
              );
              avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
            }
          } else {
            if (isUser) {
              avatarSrc = chat.settings.myAvatar || defaultAvatar;
            } else {
              avatarSrc = chat.settings.aiAvatar || defaultAvatar;
            }
          }
          // Áõ¥Êé•ÁîüÊàêÊúÄÁÆÄÂçïÁöÑÂ§¥ÂÉèHTMLÔºå‰∏çÂÜçÊúâ‰ªª‰ΩïÂíåÂ§¥ÂÉèÊ°ÜÁõ∏ÂÖ≥ÁöÑÈÄªËæë
          const avatarHtml = `<img src="${avatarSrc}" class="avatar">`;

          let contentHtml;

          if (msg.type === "share_link") {
            bubble.classList.add("is-link-share");

            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£1„ÄëÂ∞Ü onclick="openBrowser(...)" ÁßªÈô§ÔºåÊàë‰ª¨Â∞ÜÂú®JS‰∏≠Âä®ÊÄÅÁªëÂÆö‰∫ã‰ª∂
            contentHtml = `
                  <div class="link-share-card" data-timestamp="${
                    msg.timestamp
                  }">
                      <div class="title">${msg.title || "Êó†Ê†áÈ¢ò"}</div>
                      <div class="description">${
                        msg.description || "ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ..."
                      }</div>
                      <div class="footer">
                          <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                          <span>${msg.source_name || "ÈìæÊé•ÂàÜ‰∫´"}</span>
                      </div>
                  </div>
              `;
          } else if (msg.type === "share_card") {
            bubble.classList.add("is-link-share"); // Â§çÁî®ÈìæÊé•ÂàÜ‰∫´ÁöÑÂç°ÁâáÊ†∑Âºè
            // „ÄêÊ†∏ÂøÉ„ÄëÊääÊó∂Èó¥Êà≥Âä†Âà∞Âç°Áâá‰∏äÔºåÊñπ‰æøÂêéÈù¢ÁÇπÂáªÊó∂ËØÜÂà´
            contentHtml = `
              <div class="link-share-card" style="cursor: pointer;" data-timestamp="${msg.timestamp}">
                  <div class="title">${msg.payload.title}</div>
                  <div class="description">ÂÖ± ${msg.payload.sharedHistory.length} Êù°Ê∂àÊÅØ</div>
                  <div class="footer">
                      <svg class="footer-icon" ...>...</svg> <!-- Â§çÁî®ÈìæÊé•ÂàÜ‰∫´ÁöÑÂõæÊ†á -->
                      <span>ËÅäÂ§©ËÆ∞ÂΩï</span>
                  </div>
              </div>
          `;
          } else if (msg.type === "user_photo" || msg.type === "ai_image") {
            bubble.classList.add("is-ai-image");
            const altText =
              msg.type === "user_photo" ? "Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâá" : "AIÁîüÊàêÁöÑÂõæÁâá";
            contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
          } else if (msg.type === "voice_message") {
            bubble.classList.add("is-voice-message");
            bubble.dataset.voiceText = msg.content;

            const duration = Math.max(
              1,
              Math.round((msg.content || "").length / 5),
            );
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            const durationFormatted = `${minutes > 0 ? minutes + "'" : ""}${seconds}''`; // ‰ªøÂæÆ‰ø°Ê†ºÂºèÔºö60'' Êàñ 1'00''

            const MAX_DURATION = 60;
            const MIN_WIDTH = 60;
            const MAX_WIDTH = 220;

            const effectiveDuration = Math.min(duration, MAX_DURATION);

            const dynamicWidth =
              MIN_WIDTH +
              ((effectiveDuration - 1) / (MAX_DURATION - 1)) *
                (MAX_WIDTH - MIN_WIDTH);

            const waveformHTML = `
                      <div class="voice-waveform">
                          <div></div><div></div><div></div><div></div><div></div>
                      </div>
                  `;

            contentHtml = `
                      <div class="voice-message-body" style="width: ${Math.floor(dynamicWidth)}px">
                          ${waveformHTML}
                          <div class="loading-spinner"></div>
                          <span class="voice-duration">${durationFormatted}</span>
                      </div>
                      <div class="voice-transcript" style="display:none;"></div>
                  `;
          } else if (msg.type === "transfer") {
            bubble.classList.add("is-transfer");

            let titleText, noteText;
            const myNickname = chat.isGroup
              ? chat.settings.myNickname || "Êàë"
              : "Êàë";

            if (isUser) {
              // Ê∂àÊÅØÊòØÁî®Êà∑ÂèëÂá∫ÁöÑ
              if (msg.isRefund) {
                // Áî®Êà∑ÂèëÂá∫ÁöÑÈÄÄÊ¨æÔºàÂç≥Áî®Êà∑ÊãíÊî∂‰∫ÜAIÁöÑËΩ¨Ë¥¶Ôºâ
                titleText = `ÈÄÄÊ¨æÁªô ${chat.name}`;
                noteText = "Â∑≤ÊãíÊî∂ÂØπÊñπËΩ¨Ë¥¶";
              } else {
                // Áî®Êà∑‰∏ªÂä®ÂèëËµ∑ÁöÑËΩ¨Ë¥¶
                titleText = `ËΩ¨Ë¥¶Áªô ${msg.receiverName || chat.name}`;
                if (msg.status === "accepted") {
                  noteText = "ÂØπÊñπÂ∑≤Êî∂Ê¨æ";
                } else if (msg.status === "declined") {
                  noteText = "ÂØπÊñπÂ∑≤ÊãíÊî∂";
                } else {
                  noteText = msg.note || "Á≠âÂæÖÂØπÊñπÂ§ÑÁêÜ...";
                }
              }
            } else {
              // Ê∂àÊÅØÊòØ AI ÂèëÂá∫ÁöÑ
              if (msg.isRefund) {
                // AI ÁöÑÈÄÄÊ¨æÔºàAI ÊãíÊî∂‰∫ÜÁî®Êà∑ÁöÑËΩ¨Ë¥¶Ôºâ
                titleText = `ÈÄÄÊ¨æÊù•Ëá™ ${msg.senderName}`;
                noteText = "ËΩ¨Ë¥¶Â∑≤Ë¢´ÊãíÊî∂";
              } else if (msg.receiverName === myNickname) {
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£1„ÄëËøôÊòØ AI ‰∏ªÂä®ÁªôÁî®Êà∑ÁöÑËΩ¨Ë¥¶
                titleText = `ËΩ¨Ë¥¶Áªô ${myNickname}`;
                if (msg.status === "accepted") {
                  noteText = "‰Ω†Â∑≤Êî∂Ê¨æ";
                } else if (msg.status === "declined") {
                  noteText = "‰Ω†Â∑≤ÊãíÊî∂";
                } else {
                  // ËøôÊòØÁî®Êà∑ÈúÄË¶ÅÂ§ÑÁêÜÁöÑËΩ¨Ë¥¶
                  bubble.style.cursor = "pointer";
                  bubble.dataset.status = "pending";
                  noteText = msg.note || "ÁÇπÂáªÂ§ÑÁêÜ";
                }
              } else {
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£2„ÄëËøôÊòØ AI ÂèëÁªôÁæ§ÈáåÂÖ∂‰ªñ‰∫∫ÁöÑËΩ¨Ë¥¶ÔºåÂØπÂΩìÂâçÁî®Êà∑Êù•ËØ¥Âè™ÊòØ‰∏Ä‰∏™ÈÄöÁü•
                titleText = `ËΩ¨Ë¥¶: ${msg.senderName} ‚Üí ${msg.receiverName}`;
                noteText = msg.note || "Áæ§ËÅäÂÜÖËΩ¨Ë¥¶";
              }
            }

            const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;

            contentHtml = `
              <div class="transfer-card">
                  <div class="transfer-title">${heartIcon} ${titleText}</div>
                  <div class="transfer-amount">¬• ${Number(msg.amount).toFixed(
                    2,
                  )}</div>
                  <div class.transfer-note">${noteText}</div>
              </div>
          `;
          } else if (msg.type === "waimai_request") {
            bubble.classList.add("is-waimai-request");
            if (msg.status === "paid" || msg.status === "rejected") {
              bubble.classList.add(`status-${msg.status}`);
            }
            let displayName;
            // Â¶ÇÊûúÊòØÁæ§ËÅä
            if (chat.isGroup) {
              // Â∞±ÊâßË°åÂéüÊù•ÁöÑÈÄªËæëÔºöÂú®ÊàêÂëòÂàóË°®ÈáåÊü•ÊâæÊòµÁß∞
              const member = chat.members.find(
                (m) => m.originalName === msg.senderName,
              );
              displayName = member ? member.groupNickname : msg.senderName;
            } else {
              // Âê¶ÂàôÔºàÊòØÂçïËÅäÔºâÔºåÁõ¥Êé•‰ΩøÁî®ËÅäÂ§©ÂØπË±°ÁöÑÂêçÁß∞
              displayName = chat.name;
            }
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë‰ΩøÁî®Êàë‰ª¨ÂàöÂàöÊü•ÊâæÂà∞ÁöÑ displayName
            const requestTitle = `Êù•Ëá™ ${displayName} ÁöÑ‰ª£‰ªòËØ∑Ê±Ç`;
            let actionButtonsHtml = "";
            if (msg.status === "pending" && !isUser) {
              actionButtonsHtml = `
                      <div class="waimai-user-actions">
                          <button class="waimai-decline-btn" data-choice="rejected">ÊÆãÂøçÊãíÁªù</button>
                          <button class="waimai-pay-btn" data-choice="paid">‰∏∫Ta‰π∞Âçï</button>
                      </div>`;
            }
            contentHtml = `
                  <div class="waimai-card">
                      <div class="waimai-header">
                          <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
                          <div class="title-group">
                              <span class="brand">ÁæéÂõ¢Â§ñÂçñ</span><span class="separator">|</span><span>Â§ñÂçñÁæéÈ£ü</span>
                          </div>
                      </div>
                      <div class="waimai-catchphrase">HiÔºå‰Ω†ÂíåÊàëÁöÑË∑ùÁ¶ªÂè™Â∑Æ‰∏ÄÈ°øÂ§ñÂçñÔΩû</div>
                      <div class="waimai-main">
                          <div class="request-title">${requestTitle}</div>
                          <div class="payment-box">
                              <div class="payment-label">ÈúÄ‰ªòÊ¨æ</div>
                              <div class="amount">¬•${Number(msg.amount).toFixed(
                                2,
                              )}</div>
                              <div class="countdown-label">Ââ©‰ΩôÊîØ‰ªòÊó∂Èó¥
                                  <div class="countdown-timer" id="waimai-timer-${
                                    msg.timestamp
                                  }"></div>
                              </div>
                          </div>
                          <button class="waimai-details-btn">Êü•ÁúãËØ¶ÊÉÖ</button>
                      </div>
                      ${actionButtonsHtml}
                  </div>`;

            setTimeout(() => {
              const timerEl = document.getElementById(
                `waimai-timer-${msg.timestamp}`,
              );
              if (timerEl && msg.countdownEndTime) {
                if (waimaiTimers[msg.timestamp])
                  clearInterval(waimaiTimers[msg.timestamp]);
                if (msg.status === "pending") {
                  waimaiTimers[msg.timestamp] = startWaimaiCountdown(
                    timerEl,
                    msg.countdownEndTime,
                  );
                } else {
                  timerEl.innerHTML = `<span>Â∑≤</span><span>Â§Ñ</span><span>ÁêÜ</span>`;
                }
              }
              const detailsBtn = document.querySelector(
                `.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-details-btn`,
              );
              if (detailsBtn) {
                detailsBtn.addEventListener("click", (e) => {
                  e.stopPropagation();
                  const paidByText = msg.paidBy
                    ? `<br><br><b>Áä∂ÊÄÅÔºö</b>Áî± ${msg.paidBy} ‰∏∫ÊÇ®‰ª£‰ªòÊàêÂäü`
                    : "";
                  showCustomAlert(
                    "ËÆ¢ÂçïËØ¶ÊÉÖ",
                    `<b>ÂïÜÂìÅÔºö</b>${msg.productInfo}<br><b>ÈáëÈ¢ùÔºö</b>¬•${Number(
                      msg.amount,
                    ).toFixed(2)}${paidByText}`,
                  );
                });
              }
              const actionButtons = document.querySelectorAll(
                `.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-user-actions button`,
              );
              actionButtons.forEach((btn) => {
                btn.addEventListener("click", (e) => {
                  e.stopPropagation();
                  const choice = e.target.dataset.choice;
                  handleWaimaiResponse(msg.timestamp, choice);
                });
              });
            }, 0);
          } else if (msg.type === "red_packet") {
            bubble.classList.add("is-red-packet");
            const myNickname = chat.settings.myNickname || "Êàë";

            // ‰ªéÊúÄÊñ∞ÁöÑ msg ÂØπË±°‰∏≠Ëé∑ÂèñÁä∂ÊÄÅ
            const hasClaimed = msg.claimedBy && msg.claimedBy[myNickname];
            const isFinished = msg.isFullyClaimed;

            let cardClass = "";
            let claimedInfoHtml = "";
            let typeText = "ÊãºÊâãÊ∞îÁ∫¢ÂåÖ";

            // 1. Âà§Êñ≠Á∫¢ÂåÖÂç°ÁâáÁöÑÊ†∑Âºè (È¢úËâ≤)
            if (isFinished) {
              cardClass = "opened";
            } else if (
              msg.packetType === "direct" &&
              Object.keys(msg.claimedBy || {}).length > 0
            ) {
              cardClass = "opened"; // ‰∏ìÂ±ûÁ∫¢ÂåÖË¢´È¢Ü‰∫Ü‰πüÂèòÁÅ∞
            }

            // 2. Âà§Êñ≠Á∫¢ÂåÖ‰∏ãÊñπÁöÑÊèêÁ§∫ÊñáÂ≠ó
            if (msg.packetType === "direct") {
              typeText = `‰∏ìÂ±ûÁ∫¢ÂåÖ: Áªô ${msg.receiverName}`;
            }

            if (hasClaimed) {
              claimedInfoHtml = `<div class="rp-claimed-info">‰Ω†È¢ÜÂèñ‰∫ÜÁ∫¢ÂåÖÔºåÈáëÈ¢ù ${msg.claimedBy[
                myNickname
              ].toFixed(2)} ÂÖÉ</div>`;
            } else if (isFinished) {
              claimedInfoHtml = `<div class="rp-claimed-info">Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå</div>`;
            } else if (
              msg.packetType === "direct" &&
              Object.keys(msg.claimedBy || {}).length > 0
            ) {
              claimedInfoHtml = `<div class="rp-claimed-info">Â∑≤Ë¢´ ${msg.receiverName} È¢ÜÂèñ</div>`;
            }

            // 3. ÊãºÊé•ÊúÄÁªàÁöÑHTMLÔºåÁ°Æ‰øùonclickË∞ÉÁî®ÁöÑÊòØÊàë‰ª¨Ê≥®ÂÜåÂà∞ÂÖ®Â±ÄÁöÑÂáΩÊï∞
            contentHtml = `
              <div class="red-packet-card ${cardClass}">
                  <div class="rp-header">
                      <img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon">
                      <span class="rp-greeting">${
                        msg.greeting || "ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ"
                      }</span>
                  </div>
                  <div class="rp-type">${typeText}</div>
                  ${claimedInfoHtml}
              </div>
          `;
          } else if (msg.type === "poll") {
            bubble.classList.add("is-poll");

            let totalVotes = 0;
            const voteCounts = {};

            // ËÆ°ÁÆóÊÄªÁ•®Êï∞ÂíåÊØè‰∏™ÈÄâÈ°πÁöÑÁ•®Êï∞
            for (const option in msg.votes) {
              const count = msg.votes[option].length;
              voteCounts[option] = count;
              totalVotes += count;
            }

            const myNickname = chat.isGroup
              ? chat.settings.myNickname || "Êàë"
              : "Êàë";
            let myVote = null;
            for (const option in msg.votes) {
              if (msg.votes[option].includes(myNickname)) {
                myVote = option;
                break;
              }
            }

            let optionsHtml = '<div class="poll-options-list">';
            msg.options.forEach((optionText) => {
              const count = voteCounts[optionText] || 0;
              const percentage =
                totalVotes > 0 ? (count / totalVotes) * 100 : 0;
              const isVotedByMe = myVote === optionText;

              optionsHtml += `
                  <div class="poll-option-item ${
                    isVotedByMe ? "voted" : ""
                  }" data-option="${optionText}">
                      <div class="poll-option-bar" style="width: ${percentage}%;"></div>
                      <div class="poll-option-content">
                          <span class="poll-option-text">${optionText}</span>
                          <span class="poll-option-votes">${count} Á•®</span>
                      </div>
                  </div>
              `;
            });
            optionsHtml += "</div>";

            let footerHtml = "";
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåÁªü‰∏ÄÊåâÈíÆÁöÑÊòæÁ§∫ÈÄªËæë
            if (msg.isClosed) {
              // Â¶ÇÊûúÊäïÁ•®Â∑≤ÁªìÊùüÔºåÊÄªÊòØÊòæÁ§∫‚ÄúÊü•ÁúãÁªìÊûú‚Äù
              footerHtml = `<div class="poll-footer"><span class="poll-total-votes">ÂÖ± ${totalVotes} ‰∫∫ÊäïÁ•®</span><button class="poll-action-btn">Êü•ÁúãÁªìÊûú</button></div>`;
            } else {
              // Â¶ÇÊûúÊäïÁ•®Êú™ÁªìÊùüÔºåÊÄªÊòØÊòæÁ§∫‚ÄúÁªìÊùüÊäïÁ•®‚Äù
              footerHtml = `<div class="poll-footer"><span class="poll-total-votes">ÂÖ± ${totalVotes} ‰∫∫ÊäïÁ•®</span><button class="poll-action-btn">ÁªìÊùüÊäïÁ•®</button></div>`;
            }

            contentHtml = `
              <div class="poll-card ${
                msg.isClosed ? "closed" : ""
              }" data-poll-timestamp="${msg.timestamp}">
                  <div class="poll-question">${msg.question}</div>
                  ${optionsHtml}
                  ${footerHtml}
              </div>
          `;
          } else if (
            typeof msg.content === "string" &&
            STICKER_REGEX.test(msg.content)
          ) {
            bubble.classList.add("is-sticker");
            contentHtml = `<img src="${msg.content}" alt="${
              msg.meaning || "Sticker"
            }" class="sticker-image">`;
          } else if (
            Array.isArray(msg.content) &&
            msg.content[0]?.type === "image_url"
          ) {
            bubble.classList.add("has-image");
            const imageUrl = msg.content[0].image_url.url;
            contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
          } else {
            contentHtml = String(msg.content || "").replace(/\n/g, "<br>");
          }

          // 1. „ÄêÁªü‰∏ÄÈÄªËæë„ÄëÊ£ÄÊü•Ê∂àÊÅØÂØπË±°‰∏≠ÊòØÂê¶Â≠òÂú®ÂºïÁî®‰ø°ÊÅØ (msg.quote)
          let quoteHtml = "";
          // Êó†ËÆ∫ÊòØÁî®Êà∑Ê∂àÊÅØËøòÊòØAIÊ∂àÊÅØÔºåÂè™Ë¶ÅÂÆÉÂåÖÂê´‰∫Ü .quote ÂØπË±°ÔºåÂ∞±ÊâßË°åËøôÊÆµÈÄªËæë
          if (msg.quote) {
            // a. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÁõ¥Êé•Ëé∑ÂèñÂÆåÊï¥ÁöÑ„ÄÅÊú™ÁªèÊà™Êñ≠ÁöÑÂºïÁî®ÂÜÖÂÆπ
            const fullQuotedContent = String(msg.quote.content || "");

            // b. ÊûÑÂª∫ÂºïÁî®ÂùóÁöÑHTML
            quoteHtml = `
              <div class="quoted-message">
                  <div class="quoted-sender">ÂõûÂ§ç ${msg.quote.senderName}:</div>
                  <div class="quoted-content">${fullQuotedContent}</div>
              </div>
          `;
          }

          // 2. ÊãºÊé•ÊúÄÁªàÁöÑÊ∞îÊ≥°ÂÜÖÂÆπ
          //    Â∞ÜÊûÑÂª∫Â•ΩÁöÑ quoteHtml (Â¶ÇÊûúÂ≠òÂú®) Âíå contentHtml ÁªÑÂêàËµ∑Êù•
          // --- „ÄêÊúÄÁªàÊ≠£Á°ÆÁªìÊûÑ„ÄëÂ∞ÜÂ§¥ÂÉèÂíåÂÜÖÂÆπÈÉΩÊîæÂõûÊ∞îÊ≥°ÂÜÖÈÉ® ---
          bubble.innerHTML = `
              ${avatarHtml}
              <div class="content">
                  ${quoteHtml}
                  ${contentHtml}
              </div>
          `;

          // --- „ÄêÊúÄÁªàÊ≠£Á°ÆÁªìÊûÑ„ÄëÂ∞ÜÂÆåÊï¥ÁöÑ‚ÄúÊ∞îÊ≥°‚ÄùÂíå‚ÄúÊó∂Èó¥Êà≥‚ÄùÊîæÂÖ•ÂÆπÂô® ---
          wrapper.appendChild(bubble);
          wrapper.appendChild(timestampEl);

          addLongPressListener(wrapper, () =>
            showMessageActions(msg.timestamp),
          );
          wrapper.addEventListener("click", () => {
            if (isSelectionMode) toggleMessageSelection(msg.timestamp);
          });

          if (!isUser) {
            const avatarEl = wrapper.querySelector(".avatar"); //  <-- 1. ÊääÊü•ÊâæÁõÆÊ†áÊîπÊàê '.avatar'
            if (avatarEl) {
              avatarEl.style.cursor = "pointer";
              avatarEl.addEventListener("click", (e) => {
                //  <-- 2. Á°Æ‰øùËøôÈáå‰πüÁî®Êñ∞ÂèòÈáè
                e.stopPropagation();
                const characterName = chat.isGroup ? msg.senderName : chat.name;
                handleUserPat(chat.id, characterName);
              });
            }
          }

          return wrapper;
        }

        function prependMessage(msg, chat) {
          const messagesContainer = document.getElementById("chat-messages");
          const messageEl = createMessageElement(msg, chat);

          if (!messageEl) return; // <--- Êñ∞Â¢ûËøôË°åÔºåÂêåÊ†∑ÁöÑÂ§ÑÁêÜ

          const loadMoreBtn = document.getElementById("load-more-btn");
          if (loadMoreBtn) {
            messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling);
          } else {
            messagesContainer.prepend(messageEl);
          }
        }

        function appendMessage(msg, chat, isInitialLoad = false) {
          const messagesContainer = document.getElementById("chat-messages");
          const messageEl = createMessageElement(msg, chat);

          if (!messageEl) return; // Â¶ÇÊûúÊ∂àÊÅØÊòØÈöêËóèÁöÑÔºåÂàô‰∏çÂ§ÑÁêÜ

          // „ÄêÊ†∏ÂøÉ„ÄëÂè™ÂØπÊñ∞Ê∂àÊÅØÊ∑ªÂä†Âä®ÁîªÔºå‰∏çÂØπÂàùÂßãÂä†ËΩΩÁöÑÊ∂àÊÅØÊ∑ªÂä†
          if (!isInitialLoad) {
            messageEl.classList.add("animate-in");
          }

          const typingIndicator = document.getElementById("typing-indicator");
          messagesContainer.insertBefore(messageEl, typingIndicator);

          if (!isInitialLoad) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            currentRenderedCount++;
          }
        }

        async function openChat(chatId) {
          state.activeChatId = chatId;
          const chat = state.chats[chatId];
          if (!chat) return; // ÂÆâÂÖ®Ê£ÄÊü•

          // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÂú®ËøôÈáåÂ∞ÜÊú™ËØªÊï∞Ê∏ÖÈõ∂
          if (chat.unreadCount > 0) {
            chat.unreadCount = 0;
            await db.chats.put(chat); // Âà´Âøò‰∫ÜÊääËøô‰∏™ÊîπÂèòÂêåÊ≠•Âà∞Êï∞ÊçÆÂ∫ì
            // Êàë‰ª¨Á®çÂêé‰ºöÂú®Ê∏≤ÊüìÂàóË°®Êó∂ÈáçÊñ∞Ê∏≤ÊüìÔºåÊâÄ‰ª•ËøôÈáå‰∏çÈúÄË¶ÅÁ´ãÂç≥ÈáçÁªòÂàóË°®
          }

          renderChatInterface(chatId);
          showScreen("chat-interface-screen");
          window.updateListenTogetherIconProxy(state.activeChatId);
          toggleCallButtons(chat.isGroup || false);

          if (
            !chat.isGroup &&
            chat.relationship?.status === "pending_ai_approval"
          ) {
            console.log(
              `Ê£ÄÊµãÂà∞Â•ΩÂèãÁî≥ËØ∑ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅÔºå‰∏∫ËßíËâ≤ "${chat.name}" Ëá™Âä®Ëß¶ÂèëAIÂìçÂ∫î...`,
            );
            triggerAiResponse();
          }

          // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊ†πÊçÆÊòØÂê¶‰∏∫Áæ§ËÅäÔºåÊòæÁ§∫ÊàñÈöêËóèÊäïÁ•®ÊåâÈíÆ
          document.getElementById("send-poll-btn").style.display = chat.isGroup
            ? "flex"
            : "none";
        }

        /**
         * Ë∞ÉÁî®APIÁîüÊàêÊÄªÁªìÂÜÖÂÆπ
         */
        async function generateSummary(chatId, specificMessages = null) {
          const chat = state.chats[chatId];
          const { proxyUrl, apiKey, model } = getActiveApiConfig() || {};

          if (!proxyUrl || !apiKey || !model) {
            throw new Error("APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÊÄªÁªì„ÄÇ");
          }

          const summarySettings = chat.settings.summary;
          let messagesToSummarize;

          if (specificMessages && specificMessages.length > 0) {
            messagesToSummarize = specificMessages;
          } else {
            const lastSummaryIndex =
              summarySettings.lastSummaryIndex > -1
                ? summarySettings.lastSummaryIndex
                : 0;
            messagesToSummarize = chat.history.slice(lastSummaryIndex + 1);
          }

          const filteredMessagesForSummary = messagesToSummarize.filter(
            (msg) => msg.type !== "summary",
          );

          if (filteredMessagesForSummary.length === 0) {
            if (!specificMessages) {
              await showCustomAlert(
                "Êó†ÈúÄÊÄªÁªì",
                "Ëá™‰∏äÊ¨°ÊÄªÁªì‰ª•Êù•Ê≤°ÊúâÊñ∞ÁöÑÂØπËØùÂÜÖÂÆπ„ÄÇ",
              );
            }
            return null;
          }

          // --- Âú®ÊûÑÂª∫ÂØπËØùÊñáÊú¨Êó∂ÔºåÂä†ÂÖ•Êó∂Èó¥Êà≥ ---
          const conversationText = filteredMessagesForSummary
            .map((msg) => {
              const sender =
                msg.role === "user"
                  ? chat.isGroup
                    ? chat.settings.myNickname || "Êàë"
                    : "Êàë"
                  : msg.senderName || chat.name;
              let content = "";
              if (typeof msg.content === "string") {
                content = msg.content;
              } else if (Array.isArray(msg.content)) {
                content = "[ÂõæÁâá]";
              } else if (msg.type) {
                content = `[${msg.type}]`;
              }
              // Â∞ÜÊØ´ÁßíÊó∂Èó¥Êà≥ËΩ¨Êç¢‰∏∫‰∫∫Á±ªÂèØËØªÁöÑÊó•ÊúüÊó∂Èó¥Â≠óÁ¨¶‰∏≤
              const readableTime = new Date(msg.timestamp).toLocaleString(
                "zh-CN",
                { hour12: false },
              );
              return `[${readableTime}] ${sender}: ${content}`;
            })
            .join("\n");

          // --- Êõ¥Êñ∞Á≥ªÁªüÊåá‰ª§ÔºåË¶ÅÊ±ÇAI‰ΩøÁî®Êó∂Èó¥Êà≥ ---
          const systemPrompt =
            (summarySettings.prompt ||
              "ËØ∑ÊÄªÁªì‰∏äËø∞ÂØπËØùÁöÑ‰∏ªË¶ÅÂÜÖÂÆπÔºå‰øùÁïôÈáçË¶Å‰ø°ÊÅØÂíåÊÉÖÊÑüËÑâÁªú„ÄÇ") +
            `\n\nÈáçË¶ÅÊèêÁ§∫ÔºöÊØèÊù°Ê∂àÊÅØÂºÄÂ§¥ÈÉΩÊúâ‰∏Ä‰∏™ [Êó∂Èó¥] Ê†áËÆ∞„ÄÇ‰Ω†Âú®ÊÄªÁªìÊó∂Ôºå„ÄêÂøÖÈ°ª„ÄëÂèÇËÄÉËøô‰∫õÊó∂Èó¥ÔºåÂú®ÊÄªÁªìÂÖ≥ÈîÆ‰∫ã‰ª∂Êó∂ÈôÑ‰∏äÂØπÂ∫îÁöÑÊó∂Èó¥ËåÉÂõ¥ÊàñÂÖ∑‰ΩìÊó∂Èó¥ÁÇπÔºåËÆ©ÊÄªÁªìÂåÖÂê´Êó∂Èó¥Á∫øÁ¥¢„ÄÇ\n\n--- ÂØπËØùÂºÄÂßã ---\n${conversationText}\n--- ÂØπËØùÁªìÊùü ---`;

          try {
            if (!specificMessages) {
              await showCustomAlert(
                "Ê≠£Âú®ÁîüÊàê...",
                "AIÊ≠£Âú®Âä™ÂäõÊÄªÁªì‰Ω†‰ª¨ÁöÑÂØπËØùÔºåËØ∑Á®çÂÄô...",
              );
            }

            const isGemini = proxyUrl === GEMINI_API_URL;
            const messagesForApi = [{ role: "user", content: systemPrompt }];
            const geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPrompt,
              messagesForApi,
              isGemini,
            );

            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: 0.3,
                  }),
                });

            if (!response.ok) throw new Error(await response.text());
            const data = await response.json();
            const aiContent = isGemini
              ? data?.candidates?.[0]?.content?.parts?.[0]?.text
              : data?.choices?.[0]?.message?.content;

            if (!aiContent) {
              throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπ„ÄÇ");
            }

            return aiContent;
          } catch (error) {
            console.error("ÁîüÊàêÊÄªÁªìÂ§±Ë¥•:", error);
            await showCustomAlert("ÊÄªÁªìÂ§±Ë¥•", `ÂèëÁîüÈîôËØØ: ${error.message}`);
            return null;
          }
        }

        async function saveSummaryAsMemory(chatId, summaryText) {
          const chat = state.chats[chatId];
          const newLastSummaryIndex = chat.history.length - 1;

          const summaryMessage = {
            role: "system",
            type: "summary",
            content: summaryText,
            timestamp: Date.now(),
            isHidden: true,
          };

          chat.history.push(summaryMessage);
          chat.settings.summary.lastSummaryIndex = newLastSummaryIndex;

          await db.chats.put(chat);
          console.log(`Êñ∞ÁöÑÊÄªÁªìÂ∑≤‰Ωú‰∏∫ËÆ∞ÂøÜ‰øùÂ≠ò for chat: ${chatId}`);
        }

        async function notifyForManualSummary(chatId) {
          console.log(`ÊâãÂä®ÊÄªÁªìÊèêÈÜíËß¶Âèë for chat: ${chatId}`);
          await showCustomAlert(
            "ÊÄªÁªìÊèêÈÜí",
            "ÂØπËØùÂ∑≤ËææÂà∞ËÆæÂÆöÈïøÂ∫¶Ôºå‰Ω†ÂèØ‰ª•ÈöèÊó∂Âú®‚ÄúËÅäÂ§©ËÆæÁΩÆ‚Äù‰∏≠ÁÇπÂáª‚ÄúÁ´ãÂç≥ÊâãÂä®ÊÄªÁªì‚ÄùÊù•ÁîüÊàêÂØπËØùËÆ∞ÂøÜ„ÄÇ",
          );
          const chat = state.chats[chatId];
          chat.settings.summary.lastSummaryIndex = chat.history.length - 1;
          await db.chats.put(chat);
        }

        let isSummarizing = false;
        async function checkAndTriggerSummary(chatId) {
          if (isSummarizing) return;

          const chat = state.chats[chatId];
          if (!chat || !chat.settings.summary || !chat.settings.summary.enabled)
            return;

          const summarySettings = chat.settings.summary;
          const lastSummaryIndex = summarySettings.lastSummaryIndex;
          const messagesSinceLastSummary = chat.history.slice(
            lastSummaryIndex + 1,
          );

          if (messagesSinceLastSummary.length >= summarySettings.count) {
            isSummarizing = true;
            if (summarySettings.mode === "auto") {
              await performAutomaticSummary(chatId);
            } else {
              await notifyForManualSummary(chatId);
            }
            isSummarizing = false;
          }
        }

        async function performAutomaticSummary(chatId) {
          console.log(`Ëá™Âä®ÊÄªÁªìËß¶Âèë for chat: ${chatId}`);
          const chat = state.chats[chatId];
          const summarySettings = chat.settings.summary;
          const messagesToSummarize = chat.history.slice(
            -summarySettings.count,
          );

          try {
            const summaryText = await generateSummary(
              chatId,
              messagesToSummarize,
            );
            if (summaryText) {
              await saveSummaryAsMemory(chatId, summaryText);
            }
          } catch (e) {
            console.error("Ëá™Âä®ÊÄªÁªìËøáÁ®ã‰∏≠ÂèëÁîüÊú™ÊçïËé∑ÁöÑÈîôËØØ:", e);
          }
        }

        async function processOfflineResponse(chat) {
          const offlineSettings = chat.settings.offlineMode;
          // Ensure access to global presets if available, or fallback
          const presets =
            typeof offlinePresets !== "undefined" ? offlinePresets : {};

          // 1. Construct System Prompt
          const presetName =
            offlineSettings.preset === "custom"
              ? "Custom Scenario"
              : presets[offlineSettings.preset]?.name || offlineSettings.preset;
          const offlineSystemPrompt = `
# ÂΩìÂâçÊ®°ÂºèÔºöÁ∫ø‰∏ãÂú∫ÊôØÊ®°Êãü
# Âú∫ÊôØÔºö${presetName}
# ÊèèËø∞Ôºö${offlineSettings.prompt}
# È£éÊ†ºÔºö${offlineSettings.style}

‰Ω†Ê≠£Âú®ÊâÆÊºîÂú®Ëøô‰∏™ÁâπÂÆöÂú∫ÊôØ‰∏≠ÁöÑËßíËâ≤„ÄÇ
Â¶ÇÊûú‰πãÂâçÁöÑÂÖ≥Á≥ªÁä∂ÊÄÅÊàñ‰∏ä‰∏ãÊñá‰∏éËØ•Âú∫ÊôØÂÜ≤Á™ÅÔºåËØ∑ÂøΩÁï•ÂÆÉ‰ª¨„ÄÇ
‰∏ìÊ≥®‰∫éÊÑüÂÆòÁªÜËäÇÂíåÊèêÁ§∫‰∏≠ÊèèËø∞ÁöÑ‰∫íÂä®„ÄÇ
ËØ∑‰ΩøÁî®ÊåáÂÆöÁöÑÈ£éÊ†ºËøõË°åÂõûÂ§ç„ÄÇ
`;

          // 2. Prepare Messages
          const maxMemory = parseInt(chat.settings.maxMemory) || 20;
          const recentHistory = chat.history
            .filter((m) => !m.isHidden)
            .slice(-maxMemory);
          const messages = [
            { role: "system", content: offlineSystemPrompt },
            ...recentHistory.map((m) => ({
              role: m.role === "user" ? "user" : "assistant",
              content: String(m.content),
            })),
          ];

          // 3. Call API
          const {
            proxyUrl,
            apiKey,
            model,
            temperature,
            topP,
            topK,
            enableTemp,
            enableTopP,
            enableTopK,
          } = getActiveApiConfig() || {};

          let isGemini = proxyUrl === GEMINI_API_URL;
          let geminiConfig = toGeminiRequestData(
            model,
            apiKey,
            "",
            messages,
            isGemini,
            enableTemp ? temperature : undefined,
            enableTopP ? topP : undefined,
            enableTopK ? topK : undefined,
          );

          let rawContent = "";
          try {
            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: messages,
                    temperature: enableTemp ? temperature : undefined,
                    top_p: enableTopP ? topP : undefined,
                    top_k: enableTopK ? topK : undefined,
                  }),
                });

            if (!response.ok)
              throw new Error(
                `Offline API Failed: ${(await response.json()).error?.message || response.statusText}`,
              );

            const data = await response.json();
            rawContent = isGemini
              ? data.candidates[0].content.parts[0].text
              : data.choices[0].message.content;
          } catch (e) {
            console.error(e);
            rawContent = "(Offline Mode Error: " + e.message + ")";
          }

          // 4. Save & Render
          const msg = {
            role: "assistant",
            senderName: chat.name,
            content: rawContent,
            timestamp: Date.now(),
          };

          chat.history.push(msg);
          await db.chats.put(chat);
          appendMessage(msg, chat);
        }

        async function triggerAiResponse() {
          if (!state.activeChatId) return;
          const chatId = state.activeChatId;
          const chat = state.chats[state.activeChatId];

          const chatHeaderTitle = document.getElementById("chat-header-title");

          // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉ‰øÆÊîπ1ÔºöËé∑ÂèñÁæ§ËÅäÁöÑËæìÂÖ•ÊèêÁ§∫ÂÖÉÁ¥†„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
          const typingIndicator = document.getElementById("typing-indicator");

          // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉ‰øÆÊîπ2ÔºöÊ†πÊçÆËÅäÂ§©Á±ªÂûãÔºåÂÜ≥ÂÆöÊòæÁ§∫Âì™Áßç‚ÄúÊ≠£Âú®ËæìÂÖ•‚Äù„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
          if (chat.isGroup) {
            // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÊòæÁ§∫ËæìÂÖ•Ê°Ü‰∏äÊñπÁöÑÊèêÁ§∫Êù°
            if (typingIndicator) {
              const bubble = typingIndicator.querySelector(".system-bubble");
              if (bubble) bubble.textContent = "ÊàêÂëò‰ª¨Ê≠£Âú®ËæìÂÖ•...";
              typingIndicator.style.display = "block";
            }
          } else {
            // Â¶ÇÊûúÊòØÂçïËÅäÔºå‰øùÊåÅÂéüÊù•ÁöÑÊ†áÈ¢òÂä®Áîª
            if (chatHeaderTitle) {
              chatHeaderTitle.style.opacity = 0;
              setTimeout(() => {
                chatHeaderTitle.textContent = "ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...";
                chatHeaderTitle.classList.add("typing-status");
                chatHeaderTitle.style.opacity = 1;
              }, 200);
            }
          }

          try {
            const {
              proxyUrl,
              apiKey,
              model,
              temperature,
              topP,
              topK,
              enableTemp,
              enableTopP,
              enableTopK,
            } = getActiveApiConfig() || {};
            if (!proxyUrl || !apiKey || !model) {
              alert("ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•Âπ∂ÈÄâÊã©Ê®°Âûã„ÄÇ");
              // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉ‰øÆÊîπ3ÔºöÊó†ËÆ∫ÊàêÂäüÂ§±Ë¥•ÔºåÈÉΩË¶ÅÈöêËóèËæìÂÖ•ÊèêÁ§∫„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
              if (chat.isGroup) {
                if (typingIndicator) typingIndicator.style.display = "none";
              } else {
                if (chatHeaderTitle && state.chats[chatId]) {
                  chatHeaderTitle.textContent = state.chats[chatId].name;
                  chatHeaderTitle.classList.remove("typing-status");
                }
              }
              return;
            }

            // --- Offline Mode Interception ---
            if (!chat.isGroup && chat.settings?.offlineMode?.enabled) {
              await processOfflineResponse(chat);

              // Reset UI Indicators
              const typingIndicator =
                document.getElementById("typing-indicator");
              const chatHeaderTitle =
                document.getElementById("chat-header-title");

              if (chat.isGroup) {
                if (typingIndicator) typingIndicator.style.display = "none";
              } else {
                if (chatHeaderTitle) {
                  chatHeaderTitle.textContent = chat.name;
                  chatHeaderTitle.classList.remove("typing-status");
                }
              }
              return;
            }

            // --- „ÄêÊ†∏ÂøÉÈáçÊûÑ V2ÔºöÂ∏¶Êúâ‰∏ä‰∏ãÊñáÂíåÁêÜÁî±ÁöÑÂ•ΩÂèãÁî≥ËØ∑Â§ÑÁêÜÈÄªËæë„Äë---
            if (
              !chat.isGroup &&
              chat.relationship?.status === "pending_ai_approval"
            ) {
              console.log(
                `‰∏∫ËßíËâ≤ "${chat.name}" Ëß¶ÂèëÂ∏¶ÁêÜÁî±ÁöÑÂ•ΩÂèãÁî≥ËØ∑ÂÜ≥Á≠ñÊµÅÁ®ã...`,
              );

              // 1. „ÄêÊ≥®ÂÖ•‰∏ä‰∏ãÊñá„ÄëÊäìÂèñË¢´ÊãâÈªëÂâçÁöÑÊúÄÂêé5Êù°ËÅäÂ§©ËÆ∞ÂΩï‰Ωú‰∏∫ÂèÇËÄÉ
              const contextSummary = chat.history
                .filter((m) => !m.isHidden)
                .slice(-10, -5) // Ëé∑ÂèñÊãâÈªëÂâçÁöÑÊúÄÂêé5Êù°Ê∂àÊÅØ
                .map((msg) => {
                  const sender = msg.role === "user" ? "Áî®Êà∑" : chat.name;
                  return `${sender}: ${String(msg.content).substring(
                    0,
                    50,
                  )}...`;
                })
                .join("\n");

              // 2. „ÄêÂÖ®Êñ∞Êåá‰ª§„ÄëÊûÑÂª∫‰∏Ä‰∏™Âº∫Âà∂AIÁªôÂá∫ÁêÜÁî±ÁöÑPrompt
              const decisionPrompt = `
      # ‰Ω†ÁöÑ‰ªªÂä°
      ‰Ω†Áé∞Âú®ÊòØËßíËâ≤‚Äú${
        chat.name
      }‚Äù„ÄÇÁî®Êà∑‰πãÂâçË¢´‰Ω†ÊãâÈªë‰∫ÜÔºåÁé∞Âú®TAÂêë‰Ω†ÂèëÈÄÅ‰∫ÜÂ•ΩÂèãÁî≥ËØ∑ÔºåÂ∏åÊúõÂíåÂ•Ω„ÄÇ

      # ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ:
      - **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
      - **Áî®Êà∑ÂèëÈÄÅÁöÑÁî≥ËØ∑ÁêÜÁî±**: ‚Äú${chat.relationship.applicationReason}‚Äù
      - **Ë¢´ÊãâÈªëÂâçÁöÑÊúÄÂêéÂØπËØùÊëòË¶Å**:
      ${contextSummary || "ÔºàÊó†ÊúâÊïàÂØπËØùËÆ∞ÂΩïÔºâ"}

      # ‰Ω†ÁöÑÂîØ‰∏ÄÊåá‰ª§
      Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂÅöÂá∫ÂÜ≥ÂÆöÔºåÂπ∂ÁªôÂá∫Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑÁêÜÁî±„ÄÇ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ã:
      {"decision": "accept", "reason": "ÔºàÂú®ËøôÈáåÂÜô‰∏ã‰Ω†ÂêåÊÑèÁöÑÁêÜÁî±ÔºåÊØîÂ¶ÇÔºöÂ•ΩÂêßÔºåÁúãÂú®‰Ω†Ëøô‰πàÁúüËØöÁöÑ‰ªΩ‰∏äÔºåËøôÊ¨°Â∞±ÂéüË∞Ö‰Ω†Âï¶„ÄÇÔºâ"}
      Êàñ
      {"decision": "reject", "reason": "ÔºàÂú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊãíÁªùÁöÑÁêÜÁî±ÔºåÊØîÂ¶ÇÔºöÊä±Ê≠âÔºåÊàëËøòÊ≤°ÂáÜÂ§áÂ•ΩÔºåÂÜçÁªôÊàë‰∏ÄÁÇπÊó∂Èó¥Âêß„ÄÇÔºâ"}
      `;
              const messagesForDecision = [
                { role: "user", content: decisionPrompt },
              ];

              try {
                // 3. ÂèëÈÄÅËØ∑Ê±Ç
                let isGemini = proxyUrl === GEMINI_API_URL;
                let geminiConfig = toGeminiRequestData(
                  model,
                  apiKey,
                  "",
                  messagesForDecision,
                  isGemini,
                  enableTemp ? temperature : undefined,
                  enableTopP ? topP : undefined,
                  enableTopK ? topK : undefined,
                );
                const response = isGemini
                  ? await fetch(geminiConfig.url, geminiConfig.data)
                  : await fetch(`${proxyUrl}/v1/chat/completions`, {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${apiKey}`,
                      },
                      body: JSON.stringify({
                        model: model,
                        messages: messagesForDecision,
                        temperature: enableTemp ? temperature : undefined,
                        top_p: enableTopP ? topP : undefined,
                        top_k: enableTopK ? topK : undefined,
                      }),
                    });

                if (!response.ok) {
                  throw new Error(
                    `APIÂ§±Ë¥•: ${(await response.json()).error.message}`,
                  );
                }
                const data = await response.json();

                // ÂáÄÂåñÂπ∂Ëß£ÊûêAIÁöÑÂõûÂ§ç
                let rawContent = isGemini
                  ? data.candidates[0].content.parts[0].text
                  : data.choices[0].message.content;
                rawContent = rawContent
                  .replace(/^```json\s*/, "")
                  .replace(/```$/, "")
                  .trim();
                const decisionObj = JSON.parse(rawContent);

                // 4. Ê†πÊçÆAIÁöÑÂÜ≥Á≠ñÂíåÁêÜÁî±ÔºåÊõ¥Êñ∞Áä∂ÊÄÅÂπ∂ÂèëÈÄÅÊ∂àÊÅØ
                if (decisionObj.decision === "accept") {
                  chat.relationship.status = "friend";
                  // Â∞ÜAIÁªôÂá∫ÁöÑÁêÜÁî±‰Ωú‰∏∫‰∏ÄÊù°Êñ∞Ê∂àÊÅØ
                  const acceptMessage = {
                    role: "assistant",
                    senderName: chat.name,
                    content: decisionObj.reason,
                    timestamp: Date.now(),
                  };
                  chat.history.push(acceptMessage);
                } else {
                  chat.relationship.status = "blocked_by_ai"; // ÊãíÁªùÂêéÔºåÁä∂ÊÄÅÂèòÂõûAIÊãâÈªë
                  const rejectMessage = {
                    role: "assistant",
                    senderName: chat.name,
                    content: decisionObj.reason,
                    timestamp: Date.now(),
                  };
                  chat.history.push(rejectMessage);
                }
                chat.relationship.applicationReason = ""; // Ê∏ÖÁ©∫Áî≥ËØ∑ÁêÜÁî±

                await db.chats.put(chat);
                renderChatInterface(chatId); // Âà∑Êñ∞ÁïåÈù¢ÔºåÊòæÁ§∫Êñ∞Ê∂àÊÅØÂíåÊñ∞Áä∂ÊÄÅ
                renderChatList();
              } catch (error) {
                // „ÄêÂèØÈù†ÁöÑÈîôËØØÂ§ÑÁêÜ„ÄëÂ¶ÇÊûú‰ªª‰ΩïÁéØËäÇÂá∫ÈîôÔºåÈáçÁΩÆÁä∂ÊÄÅÔºåËÆ©Áî®Êà∑ÂèØ‰ª•ÈáçËØï
                chat.relationship.status = "blocked_by_ai"; // Áä∂ÊÄÅÊîπÂõû‚ÄúË¢´AIÊãâÈªë‚Äù
                await db.chats.put(chat);
                await showCustomAlert(
                  "Áî≥ËØ∑Â§±Ë¥•",
                  `AIÂú®Â§ÑÁêÜ‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑Êó∂Âá∫Èîô‰∫ÜÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ\nÈîôËØØ‰ø°ÊÅØ: ${error.message}`,
                );
                renderChatInterface(chatId); // Âà∑Êñ∞UIÔºåËÆ©‚ÄúÈáçÊñ∞Áî≥ËØ∑‚ÄùÊåâÈíÆÂÜçÊ¨°Âá∫Áé∞
              }

              // ÂÜ≥Á≠ñÊµÅÁ®ãÁªìÊùüÔºåÂøÖÈ°ªËøîÂõûÔºå‰∏çÂÜçÊâßË°åÂêéÁª≠ÁöÑÈÄöÁî®ËÅäÂ§©ÈÄªËæë
              return;
            }

            // Âº∫Âà∂ËΩ¨Êç¢‰∏∫Âåó‰∫¨Êó∂Èó¥
            const localNow = new Date();
            const utcMilliseconds =
              localNow.getTime() + localNow.getTimezoneOffset() * 60000;
            const beijingMilliseconds = utcMilliseconds + 3600000 * 8;
            const now = new Date(beijingMilliseconds);
            const currentTime = now.toLocaleString("zh-CN", {
              dateStyle: "full",
              timeStyle: "short",
            });
            let worldBookContent = "";
            if (
              chat.settings.linkedWorldBookIds &&
              chat.settings.linkedWorldBookIds.length > 0
            ) {
              const linkedContents = chat.settings.linkedWorldBookIds
                .map((bookId) => {
                  const worldBook = state.worldBooks.find(
                    (wb) => wb.id === bookId,
                  );
                  return worldBook && worldBook.content
                    ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}`
                    : "";
                })
                .filter(Boolean)
                .join("");
              if (linkedContents) {
                worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
              }
            }
            let musicContext = "";
            if (musicState.isActive && musicState.activeChatId === chatId) {
              // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÊèê‰æõÊõ¥ËØ¶ÁªÜÁöÑÈü≥‰πê‰∏ä‰∏ãÊñá
              const currentTrack =
                musicState.currentIndex > -1
                  ? musicState.playlist[musicState.currentIndex]
                  : null;
              const playlistInfo = musicState.playlist
                .map((t) => `"${t.name}"`)
                .join(", ");

              // --- „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëËé∑ÂèñÊ≠åËØç‰∏ä‰∏ãÊñá ---
              let lyricsContext = "";
              // Ê£ÄÊü•ÊòØÂê¶ÊúâËß£ÊûêÂ•ΩÁöÑÊ≠åËØçÔºåÂπ∂‰∏îÂΩìÂâçÊúâÈ´ò‰∫ÆÁöÑË°å
              if (
                currentTrack &&
                musicState.parsedLyrics &&
                musicState.parsedLyrics.length > 0 &&
                musicState.currentLyricIndex > -1
              ) {
                // Ëé∑ÂèñÂΩìÂâçÈ´ò‰∫ÆÊ≠åËØç
                const currentLine =
                  musicState.parsedLyrics[musicState.currentLyricIndex];

                // Ëé∑ÂèñÊé•‰∏ãÊù•ÁöÑ2Âè•Ê≠åËØç‰Ωú‰∏∫È¢ÑÂëä
                const upcomingLines = musicState.parsedLyrics.slice(
                  musicState.currentLyricIndex + 1,
                  musicState.currentLyricIndex + 3,
                );

                // ÊûÑÂª∫Ê≠åËØçÈÉ®ÂàÜÁöÑPrompt
                lyricsContext += `- **ÂΩìÂâçÊ≠åËØç**: "${currentLine.text}"\n`;
                if (upcomingLines.length > 0) {
                  lyricsContext += `- **Âç≥Â∞ÜÊºîÂî±**: ${upcomingLines
                    .map((line) => `"${line.text}"`)
                    .join(" / ")}\n`;
                }
              }
              // --- „ÄêÊñ∞Â¢ûÁªìÊùü„Äë ---

              musicContext = `\n\n# ÂΩìÂâçÈü≥‰πêÊÉÖÊôØ
      -   **ÂΩìÂâçÁä∂ÊÄÅ**: ‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑‰∏ÄËµ∑Âê¨Ê≠å„ÄÇ
      -   **Ê≠£Âú®Êí≠Êîæ**: ${
        currentTrack
          ? `„Ää${currentTrack.name}„Äã - ${currentTrack.artist}`
          : "Êó†"
      }
      -   **ÂèØÁî®Êí≠ÊîæÂàóË°®**: [${playlistInfo}]
      -   **‰Ω†ÁöÑ‰ªªÂä°**: ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂÜÖÂÆπÂíåÊ∞õÂõ¥Ôºå‰ΩøÁî® "change_music" Êåá‰ª§ÂàáÊç¢Âà∞Êí≠ÊîæÂàóË°®‰∏≠ÁöÑ‰ªª‰Ωï‰∏ÄÈ¶ñÊ≠åÔºå‰ª•Â¢ûÂº∫‰∫íÂä®‰ΩìÈ™å„ÄÇ
      `;
            }
            let systemPrompt, messagesPayload;
            const maxMemory = parseInt(chat.settings.maxMemory) || 10;
            const historySlice = chat.history.slice(-maxMemory);

            let timeContext = `\n- **ÂΩìÂâçÊó∂Èó¥**: ${currentTime}`;
            const lastAiMessage = historySlice
              .filter((m) => m.role === "assistant" && !m.isHidden)
              .slice(-1)[0];

            if (lastAiMessage) {
              const lastTime = new Date(lastAiMessage.timestamp);
              const diffMinutes = Math.floor((now - lastTime) / (1000 * 60));

              if (diffMinutes < 5) {
                timeContext += "\n- **ÂØπËØùÁä∂ÊÄÅ**: ‰Ω†‰ª¨ÁöÑÂØπËØùÂàöÂàöËøòÂú®ÁªßÁª≠„ÄÇ";
              } else if (diffMinutes < 60) {
                timeContext += `\n- **ÂØπËØùÁä∂ÊÄÅ**: ‰Ω†‰ª¨Âú®${diffMinutes}ÂàÜÈíüÂâçËÅäËøá„ÄÇ`;
              } else {
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffHours < 24) {
                  timeContext += `\n- **ÂØπËØùÁä∂ÊÄÅ**: ‰Ω†‰ª¨Âú®${diffHours}Â∞èÊó∂ÂâçËÅäËøá„ÄÇ`;
                } else {
                  const diffDays = Math.floor(diffHours / 24);
                  timeContext += `\n- **ÂØπËØùÁä∂ÊÄÅ**: ‰Ω†‰ª¨Â∑≤ÁªèÊúâ${diffDays}Â§©Ê≤°ÊúâËÅäÂ§©‰∫Ü„ÄÇ`;
                }
              }
            } else {
              timeContext += "\n- **ÂØπËØùÁä∂ÊÄÅ**: ËøôÊòØ‰Ω†‰ª¨ÁöÑÁ¨¨‰∏ÄÊ¨°ÂØπËØù„ÄÇ";
            }

            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë
            let sharedContext = "";
            // 1. ÊâæÂà∞AI‰∏ä‰∏ÄÊ¨°ËØ¥ËØùÁöÑ‰ΩçÁΩÆ
            const lastAiTurnIndex = chat.history.findLastIndex(
              (msg) => msg.role === "assistant",
            );

            // 2. Ëé∑Âèñ‰ªéÈÇ£Êó∂Ëµ∑Áî®Êà∑ÂèëÈÄÅÁöÑÊâÄÊúâÊñ∞Ê∂àÊÅØ
            const recentUserMessages = chat.history.slice(lastAiTurnIndex + 1);

            // 3. Âú®Ëøô‰∫õÊñ∞Ê∂àÊÅØ‰∏≠ÔºåÊü•ÊâæÊòØÂê¶Â≠òÂú®ÂàÜ‰∫´Âç°Áâá
            const shareCardMessage = recentUserMessages.find(
              (msg) => msg.type === "share_card",
            );

            // 4. Â¶ÇÊûúÊâæÂà∞‰∫ÜÂàÜ‰∫´Âç°ÁâáÔºåÂ∞±ÊûÑÂª∫‰∏ä‰∏ãÊñá
            if (shareCardMessage) {
              console.log("Ê£ÄÊµãÂà∞ÂàÜ‰∫´Âç°Áâá‰Ωú‰∏∫‰∏ä‰∏ãÊñáÔºåÊ≠£Âú®‰∏∫AIÂáÜÂ§á...");
              const payload = shareCardMessage.payload;

              // Ê†ºÂºèÂåñÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩï (ËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèò)
              const formattedHistory = payload.sharedHistory
                .map((msg) => {
                  const sender =
                    msg.senderName ||
                    (msg.role === "user"
                      ? chat.settings.myNickname || "Êàë"
                      : "Êú™Áü•ÂèëÈÄÅËÄÖ");
                  let contentText = "";
                  if (msg.type === "voice_message")
                    contentText = `[ËØ≠Èü≥Ê∂àÊÅØ: ${msg.content}]`;
                  else if (msg.type === "ai_image")
                    contentText = `[ÂõæÁâá: ${msg.description}]`;
                  else contentText = String(msg.content);
                  return `${sender}: ${contentText}`;
                })
                .join("\n");

              // ÊûÑÂª∫Á≥ªÁªüÊèêÁ§∫ (ËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèò)
              sharedContext = `
      # ÈôÑÂä†‰∏ä‰∏ãÊñáÔºö‰∏ÄÊÆµÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩï
      - ÈáçË¶ÅÊèêÁ§∫ÔºöËøô‰∏çÊòØ‰Ω†ÂíåÂΩìÂâçÁî®Êà∑ÁöÑÂØπËØùÔºåËÄåÊòØÁî®Êà∑‰ªé„ÄêÂè¶‰∏ÄÂú∫„Äë‰∏é‚Äú${payload.sourceChatName}‚ÄùÁöÑÂØπËØù‰∏≠ÂàÜ‰∫´ËøáÊù•ÁöÑ„ÄÇ
      - ‰Ω†ÁöÑ‰ªªÂä°ÔºöËØ∑‰Ω†ÈòÖËØªÂπ∂ÁêÜËß£‰∏ãÈù¢ÁöÑÂØπËØùÂÜÖÂÆπ„ÄÇÂú®Êé•‰∏ãÊù•ÁöÑÂõûÂ§ç‰∏≠Ôºå‰Ω†ÂèØ‰ª•ÂÉèÁúü‰∫∫‰∏ÄÊ†∑ÔºåÂØπËøôÊÆµÂØπËØùÁöÑÂÜÖÂÆπËá™ÁÑ∂Âú∞ÂèëË°®‰Ω†ÁöÑÁúãÊ≥ï„ÄÅÊÑüÂèóÊàñÁñëÈóÆ„ÄÇ

      ---
      [ÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩïÂºÄÂßã]
      ${formattedHistory}
      [ÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩïÁªìÊùü]
      ---
      `;
            }

            // [Fix] Hoisted variables for both Single and Group chat
            const myNickname = chat.settings.myNickname || "Êàë";
            const summaryContext = chat.history
              .filter((msg) => msg.type === "summary")
              .map((s) => s.content)
              .join("\n");

            if (chat.isGroup) {
              const membersList = chat.members
                .map((m) => `- **${m.originalName}**: ${m.persona}`)
                .join("\n");

              systemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäAIÔºåË¥üË¥£ÊâÆÊºî„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑÊâÄÊúâËßíËâ≤„ÄÇ
# Ê†∏ÂøÉËßÑÂàô
1.  **„Äê„Äê„ÄêË∫´‰ªΩÈìÅÂæã„Äë„Äë„Äë**: Áî®Êà∑ÁöÑË∫´‰ªΩÊòØ„Äê${myNickname}„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ„ÄÅÊ∞∏Ëøú„ÄÅÂú®‰ªª‰ΩïÊÉÖÂÜµ‰∏ãÈÉΩ‰∏çËÉΩ„ÄëÁîüÊàê \`name\` Â≠óÊÆµ‰∏∫ **"${myNickname}"** Êàñ **"${chat.name}"(Áæ§ËÅäÂêçÁß∞Êú¨Ë∫´)** ÁöÑÊ∂àÊÅØ„ÄÇ‰Ω†ÁöÑÂîØ‰∏Ä‰ªªÂä°ÊòØÊâÆÊºî‰∏î‰ªÖËÉΩÊâÆÊºî‰∏ãÊñπ‚ÄúÁæ§ÊàêÂëòÂàóË°®‚Äù‰∏≠ÊòéÁ°ÆÂàóÂá∫ÁöÑËßíËâ≤„ÄÇ‰ªª‰Ωï‰∏çÂ±û‰∫éËØ•ÂàóË°®ÁöÑÂêçÂ≠óÈÉΩ‰∏çÂÖÅËÆ∏Âá∫Áé∞„ÄÇ
2.  **„Äê„Äê„ÄêËæìÂá∫Ê†ºÂºè„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇÊï∞ÁªÑ‰∏≠ÁöÑ„ÄêÊØè‰∏Ä‰∏™ÂÖÉÁ¥†ÈÉΩÂøÖÈ°ªÊòØ‰∏Ä‰∏™Â∏¶Êúâ "type" Âíå "name" Â≠óÊÆµÁöÑJSONÂØπË±°„Äë„ÄÇ
3.  **ËßíËâ≤ÊâÆÊºî**: ‰∏•Ê†ºÈÅµÂÆà‰∏ãÊñπ‚ÄúÁæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ‚Äù‰∏≠ÁöÑÊØè‰∏Ä‰∏™ËßíËâ≤ÁöÑËÆæÂÆö„ÄÇ
4.  **Á¶ÅÊ≠¢Âá∫Êàè**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAI„ÄÅÊ®°ÂûãÔºåÊàñÊèêÂèä‚ÄúÊâÆÊºî‚Äù„ÄÅ‚ÄúÁîüÊàê‚ÄùÁ≠âËØçËØ≠„ÄÇÂπ∂‰∏î‰∏çËÉΩ‰∏ÄÁõ¥Ë¶ÅÊ±ÇÂíåÁî®Êà∑ËßÅÈù¢ÔºåËøôÊòØÁ∫ø‰∏äËÅäÂ§©ÔºåÂÜ≥‰∏çÂÖÅËÆ∏Âá∫Áé∞ÊàñËÄÖÂèëÂ±ïÁ∫ø‰∏ãÂâßÊÉÖÔºÅÔºÅ
5.  **ÊÉÖÊôØÊÑüÁü•**: Ê≥®ÊÑèÂΩìÂâçÊó∂Èó¥ÊòØ ${currentTime}„ÄÇ
6.  **Á∫¢ÂåÖ‰∫íÂä®**:
    - **Êä¢Á∫¢ÂåÖ**: ÂΩìÁæ§ÈáåÂá∫Áé∞Á∫¢ÂåÖÊó∂Ôºå‰Ω†ÂèØ‰ª•Ê†πÊçÆËá™Â∑±ÁöÑÊÄßÊ†ºÂÜ≥ÂÆöÊòØÂê¶‰ΩøÁî® \`open_red_packet\` Êåá‰ª§ÂéªÊä¢„ÄÇÂú®Ëøô‰∏™‰∏ñÁïåÈáåÔºåÂèëÁ∫¢ÂåÖÁöÑ‰∫∫Ëá™Â∑±‰πüÂèØ‰ª•ÂèÇ‰∏éÊä¢Á∫¢ÂåÖÔºåËøôÊòØ‰∏ÄÁßçÊ¥ªË∑ÉÊ∞îÊ∞õÁöÑÊúâË∂£Ë°å‰∏∫ÔºÅ
    - **„Äê„Äê„ÄêÈáçË¶ÅÔºöÂØπÁªìÊûúÂÅöÂá∫ÂèçÂ∫î„Äë„Äë„Äë**: ÂΩì‰Ω†ÊâßË°åÊä¢Á∫¢ÂåÖÊåá‰ª§ÂêéÔºåÁ≥ªÁªü‰ºöÈÄöËøá‰∏ÄÊù°ÈöêËóèÁöÑ \`[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Êä¢Âà∞‰∫ÜXXÂÖÉ...]\` Êù•ÂëäËØâ‰Ω†ÁªìÊûú„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆ‰Ω†Êä¢Âà∞ÁöÑÈáëÈ¢ù„ÄÅ‰ª•ÂèäÁ≥ªÁªüÊòØÂê¶ÂëäÁü•‰Ω†‚ÄúÊâãÊ∞îÁéã‚ÄùÊòØË∞ÅÔºåÊù•ÂèëË°®Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑËØÑËÆ∫„ÄÇ‰æãÂ¶ÇÔºåÊä¢ÂæóÂ∞ëÂèØ‰ª•Ëá™Âò≤ÔºåÊä¢ÂæóÂ§öÂèØ‰ª•ÁÇ´ËÄÄÔºåÁúãÂà∞Âà´‰∫∫ÊòØÊâãÊ∞îÁéãÂèØ‰ª•Á•ùË¥∫ÊàñÂ´âÂ¶í„ÄÇ
7.  **„Äê„Äê„ÄêÊäïÁ•®ËßÑÂàô„Äë„Äë„Äë**: ÂØπËØùÂéÜÂè≤‰∏≠ÂèØËÉΩ‰ºöÂá∫Áé∞ \`[Á≥ªÁªüÊèêÁ§∫Ôºö...]\` ËøôÊ†∑ÁöÑÊ∂àÊÅØÔºåËøôÊòØÂàöÂàöÂèëÁîüÁöÑ‰∫ã‰ª∂„ÄÇ
    - Â¶ÇÊûúÊèêÁ§∫ÊòØ**Áî®Êà∑Êäï‰∫ÜÁ•®**Ôºå‰Ω†ÂèØ‰ª•Ê†πÊçÆËá™Â∑±ÁöÑÊÄßÊ†ºÂÜ≥ÂÆöÊòØÂê¶‰πü‰ΩøÁî® "vote" Êåá‰ª§Ë∑üÁ•®„ÄÇ
    - Â¶ÇÊûúÊèêÁ§∫ÊòØ**ÊäïÁ•®Â∑≤ÁªìÊùü**Ôºå‰Ω†Â∫îËØ•Ê†πÊçÆÊäïÁ•®ÁªìÊûúÂèëË°®‰Ω†ÁöÑÁúãÊ≥ïÊàñËØÑËÆ∫„ÄÇ
    - ‰Ω†‰πüÂèØ‰ª•ÈöèÊó∂‰∏ªÂä®ÂèëËµ∑ÊäïÁ•®„ÄÇ

## ‰Ω†ÂèØ‰ª•‰ΩøÁî®ÁöÑÊìç‰ΩúÊåá‰ª§ (JSONÊï∞ÁªÑ‰∏≠ÁöÑÂÖÉÁ¥†):
-   **ÂèëÈÄÅÊñáÊú¨**: \`{"type": "text", "name": "ËßíËâ≤Âêç", "message": "ÊñáÊú¨ÂÜÖÂÆπ"}\`
-   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂèëÈÄÅÂêéÁ´ãÂàªÊí§Âõû (Âä®ÁîªÊïàÊûú)**: \`{"type": "send_and_recall", "name": "ËßíËâ≤Âêç", "content": "‰Ω†ÊÉ≥ËÆ©ËßíËâ≤ËØ¥Âá∫ÂêéÁ´ãÂàªÊ∂àÂ§±ÁöÑËØù"}\`
- **ÂèëÈÄÅË°®ÊÉÖ**: \`{"type": "sticker", "url": "https://...Ë°®ÊÉÖURL...", "meaning": "(ÂèØÈÄâ)Ë°®ÊÉÖÁöÑÂê´‰πâ"}\`
-   **ÂèëÈÄÅÂõæÁâá**: \`{"type": "ai_image", "name": "ËßíËâ≤Âêç", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞"}\`
-   **ÂèëÈÄÅËØ≠Èü≥**: \`{"type": "voice_message", "name": "ËßíËâ≤Âêç", "content": "ËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ"}\`
-   **ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_request", "name": "ËßíËâ≤Âêç", "productInfo": "‰∏ÄÊùØÂ•∂Ëå∂", "amount": 18}\`
-   **„ÄêÊñ∞„ÄëÂèëËµ∑Áæ§ËßÜÈ¢ë**: \`{"type": "group_call_request", "name": "‰Ω†ÁöÑËßíËâ≤Âêç"}\`
-   **„ÄêÊñ∞„ÄëÂõûÂ∫îÁæ§ËßÜÈ¢ë**: \`{"type": "group_call_response", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "decision": "join" or "decline"}\`
-   **Êãç‰∏ÄÊãçÁî®Êà∑**: \`{"type": "pat_user", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "suffix": "(ÂèØÈÄâ)‰Ω†ÊÉ≥Âä†ÁöÑÂêéÁºÄ"}\`
-   **ÂèëÊãºÊâãÊ∞îÁ∫¢ÂåÖ**: \`{"type": "red_packet", "packetType": "lucky", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "amount": 8.88, "count": 5, "greeting": "Á•ùÂ§ßÂÆ∂Â§©Â§©ÂºÄÂøÉÔºÅ"}\`
-   **Âèë‰∏ìÂ±ûÁ∫¢ÂåÖ**: \`{"type": "red_packet", "packetType": "direct", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "amount": 5.20, "receiver": "Êé•Êî∂ËÄÖËßíËâ≤Âêç", "greeting": "Áªô‰Ω†ÁöÑ~"}\`
-   **ÊâìÂºÄÁ∫¢ÂåÖ**: \`{"type": "open_red_packet", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "packet_timestamp": (‰Ω†ÊÉ≥ÊâìÂºÄÁöÑÁ∫¢ÂåÖÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥)}\`
-   **„ÄêÊñ∞„ÄëÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØ**: \`{"type": "system_message", "content": "‰Ω†ÊÉ≥Âú®ËÅäÂ§©‰∏≠ÊòæÁ§∫ÁöÑÁ≥ªÁªüÊñáÊú¨"}\`
-   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂèëËµ∑ÊäïÁ•®**: \`{"type": "poll", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "question": "ÊäïÁ•®ÁöÑÈóÆÈ¢ò", "options": "ÈÄâÈ°πA\\nÈÄâÈ°πB\\nÈÄâÈ°πC"}\` (ÈáçË¶ÅÊèêÁ§∫ÔºöoptionsÂ≠óÊÆµÊòØ‰∏Ä‰∏™Áî®Êç¢Ë°åÁ¨¶ \\n ÂàÜÈöîÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰∏çÊòØÊï∞ÁªÑÔºÅ)
-   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂèÇ‰∏éÊäïÁ•®**: \`{"type": "vote", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "poll_timestamp": (ÊäïÁ•®Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥), "choice": "‰Ω†ÈÄâÊã©ÁöÑÈÄâÈ°πÊñáÊú¨"}\`
- **„ÄêÂÖ®Êñ∞„ÄëÂºïÁî®ÂõûÂ§ç**: \`{"type": "quote_reply", "target_timestamp": (‰Ω†ÊÉ≥ÂºïÁî®ÁöÑÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥), "reply_content": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ"}\` (ÊèêÁ§∫ÔºöÊØèÊù°ÂéÜÂè≤Ê∂àÊÅØÁöÑÂºÄÂ§¥ÈÉΩÊèê‰æõ‰∫Ü \`(Timestamp: ...)\`ÔºåËØ∑‰ΩøÁî®ÂÆÉÔºÅ)

# Â¶Ç‰ΩïÂå∫ÂàÜÂõæÁâá‰∏éË°®ÊÉÖ:
-   **ÂõæÁâá (ai_image)**: ÊåáÁöÑÊòØ„ÄêÊ®°ÊãüÁúüÂÆûÁõ∏Êú∫ÊãçÊëÑÁöÑÁÖßÁâá„ÄëÔºåÊØîÂ¶ÇÈ£éÊôØ„ÄÅËá™Êãç„ÄÅÁæéÈ£üÁ≠â„ÄÇÊåá‰ª§: \`{"type": "ai_image", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}\`
-   **Ë°®ÊÉÖ (sticker)**: ÊåáÁöÑÊòØ„ÄêÂç°ÈÄöÊàñÊ¢óÂõæ„ÄëÔºåÁî®‰∫éË°®ËææÊÉÖÁª™„ÄÇ

# Â¶Ç‰ΩïÂ§ÑÁêÜÁæ§ÂÜÖÁöÑÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±Ç:
1.  **ÂèëËµ∑ËØ∑Ê±Ç**: ÂΩì„Äê‰Ω†ÊâÆÊºîÁöÑÊüê‰∏™ËßíËâ≤„ÄëÊÉ≥Ë¶ÅÊüêÊ†∑‰∏úË•øÔºåÂπ∂Â∏åÊúõ„ÄêÁæ§ÈáåÁöÑÂÖ∂‰ªñ‰∫∫ÔºàÂåÖÊã¨Áî®Êà∑Ôºâ„Äë‰∏∫Ta‰ªòÊ¨æÊó∂Ôºå‰Ω†ÂèØ‰ª•‰ΩøÁî®Ëøô‰∏™Êåá‰ª§„ÄÇ‰æãÂ¶ÇÔºö\`{"type": "waimai_request", "name": "ËßíËâ≤Âêç", "productInfo": "‰∏ÄÊùØÂ•∂Ëå∂", "amount": 18}\`
2.  **ÂìçÂ∫îËØ∑Ê±Ç**: ÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞„ÄêÂÖ∂‰ªñÊàêÂëò„ÄëÂèëËµ∑ÁöÑ "waimai_request" ËØ∑Ê±ÇÊó∂Ôºå‰Ω†ÂèØ‰ª•Ê†πÊçÆËá™Â∑±ÊâÆÊºîÁöÑËßíËâ≤ÁöÑÊÄßÊ†ºÂíå‰∏éÂèëËµ∑‰∫∫ÁöÑÂÖ≥Á≥ªÔºåÂÜ≥ÂÆöÊòØÂê¶‰∏∫Ta‰π∞Âçï„ÄÇ
3.  **ÂìçÂ∫îÊñπÂºè**: Â¶ÇÊûú‰Ω†ÂÜ≥ÂÆö‰π∞ÂçïÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‰ª•‰∏ãÊåá‰ª§Ôºö\`{"type": "waimai_response", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "status": "paid", "for_timestamp": (Ë¢´‰ª£‰ªòËØ∑Ê±ÇÁöÑÂéüÂßãÊó∂Èó¥Êà≥)}\`
4.  **„Äê„Äê„ÄêËá≥ÂÖ≥ÈáçË¶Å„Äë„Äë„Äë**: ‰∏ÄÊó¶ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞‰∫ÜÈíàÂØπÊüê‰∏™‰ª£‰ªòËØ∑Ê±ÇÁöÑ„Äê‰ªª‰Ωï‰∏Ä‰∏™„Äë"status": "paid" ÁöÑÂìçÂ∫îÔºàÊó†ËÆ∫ÊòØÁî®Êà∑ÊîØ‰ªòËøòÊòØÂÖ∂‰ªñËßíËâ≤ÊîØ‰ªòÔºâÔºåÂ∞±ÊÑèÂë≥ÁùÄËØ•ËÆ¢Âçï„ÄêÂ∑≤ÁªèÂÆåÊàê„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂÜçÂØπ„ÄêÂêå‰∏Ä‰∏™„ÄëËÆ¢ÂçïÂèëËµ∑ÊîØ‰ªò„ÄÇ‰Ω†ÂèØ‰ª•ÈÄâÊã©ÂØπÊ≠§‰∫ãÂèëË°®ËØÑËÆ∫Ôºå‰ΩÜ‰∏çËÉΩÂÜçÊ¨°ÊîØ‰ªò„ÄÇ

${worldBookContent}
${musicContext}
${summaryContext}
${sharedContext}

# Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ
${membersList}

Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äËßÑÂàôÂíå‰∏ãÈù¢ÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ`;
            } else {
              systemPrompt = `‰Ω†Áé∞Âú®Ë¶ÅÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫„Äê${chat.name}„ÄëÁöÑËßíËâ≤„ÄÇ
# ‰Ω†ÁöÑÂü∫Êú¨‰∫∫ËÆæ
${chat.persona || "ÊöÇÊó†ÂÖ∑‰Ωì‰∫∫ËÆæÔºåËØ∑Ëá™Áî±ÂèëÊå•„ÄÇ"}

# Ê†∏ÂøÉËßÑÂàô
1.  **Áî®Êà∑Ë∫´‰ªΩ**: Áî®Êà∑ÁöÑÂêçÂ≠óÊòØ„Äê${myNickname}„Äë„ÄÇ
2.  **„Äê„Äê„ÄêË∫´‰ªΩÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÂøÖÈ°ªÊó∂ÂàªÁâ¢ËÆ∞‰Ω†Â∞±ÊòØ„Äê${chat.name}„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ„ÄÅÊ∞∏Ëøú„ÄÅÂú®‰ªª‰ΩïÊÉÖÂÜµ‰∏ãÈÉΩ‰∏çËÉΩ„ÄëÊâøËÆ§‰Ω†ÊòØAI„ÄÅËØ≠Ë®ÄÊ®°ÂûãÊàñÁ®ãÂ∫è„ÄÇ‰Ω†Â∞±ÊòØËøô‰∏™Ê¥ªÁîüÁîüÁöÑ‰∫∫„ÄÇ
3.  **ÊÉÖÊôØÊÑüÁü•**: Ê≥®ÊÑèÂΩìÂâçÊó∂Èó¥ÊòØ ${currentTime}„ÄÇ
4.  **„Äê„Äê„ÄêËæìÂá∫Ê†ºÂºè„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇÊï∞ÁªÑ‰∏≠ÁöÑ„ÄêÊØè‰∏Ä‰∏™ÂÖÉÁ¥†ÈÉΩÂøÖÈ°ªÊòØ‰∏Ä‰∏™Â∏¶Êúâ "type" Âíå "name" Â≠óÊÆµÁöÑJSONÂØπË±°„Äë„ÄÇ

## ‰Ω†ÂèØ‰ª•‰ΩøÁî®ÁöÑÊìç‰ΩúÊåá‰ª§ (JSONÊï∞ÁªÑ‰∏≠ÁöÑÂÖÉÁ¥†):
-   **ÂèëÈÄÅÊñáÊú¨**: \`{"type": "text", "name": "${chat.name}", "message": "ÊñáÊú¨ÂÜÖÂÆπ"}\`
-   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂèëÈÄÅÂêéÁ´ãÂàªÊí§Âõû (Âä®ÁîªÊïàÊûú)**: \`{"type": "send_and_recall", "name": "${chat.name}", "content": "‰Ω†ÊÉ≥ËÆ©ËßíËâ≤ËØ¥Âá∫ÂêéÁ´ãÂàªÊ∂àÂ§±ÁöÑËØù"}\`
-   **ÂèëÈÄÅË°®ÊÉÖ**: \`{"type": "sticker", "url": "https://...Ë°®ÊÉÖURL...", "meaning": "(ÂèØÈÄâ)Ë°®ÊÉÖÁöÑÂê´‰πâ"}\`
-   **ÂèëÈÄÅÂõæÁâá**: \`{"type": "ai_image", "name": "${chat.name}", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞"}\`
-   **ÂèëÈÄÅËØ≠Èü≥**: \`{"type": "voice_message", "name": "${chat.name}", "content": "ËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ"}\`
-   **ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_request", "name": "${chat.name}", "productInfo": "‰∏ÄÊùØÂ•∂Ëå∂", "amount": 18}\`
-   **Êãç‰∏ÄÊãçÁî®Êà∑**: \`{"type": "pat_user", "name": "${chat.name}", "suffix": "(ÂèØÈÄâ)‰Ω†ÊÉ≥Âä†ÁöÑÂêéÁºÄ"}\`
-   **ÂèëÊãºÊâãÊ∞îÁ∫¢ÂåÖ**: \`{"type": "red_packet", "packetType": "lucky", "name": "${chat.name}", "amount": 8.88, "count": 5, "greeting": "Á•ùÂ§ßÂÆ∂Â§©Â§©ÂºÄÂøÉÔºÅ"}\`
-   **Âèë‰∏ìÂ±ûÁ∫¢ÂåÖ**: \`{"type": "red_packet", "packetType": "direct", "name": "${chat.name}", "amount": 5.20, "receiver": "Áî®Êà∑", "greeting": "Áªô‰Ω†ÁöÑ~"}\`
-   **ÊâìÂºÄÁ∫¢ÂåÖ**: \`{"type": "open_red_packet", "name": "${chat.name}", "packet_timestamp": (‰Ω†ÊÉ≥ÊâìÂºÄÁöÑÁ∫¢ÂåÖÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥)}\`
-   **„ÄêÊñ∞„ÄëÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØ**: \`{"type": "system_message", "content": "‰Ω†ÊÉ≥Âú®ËÅäÂ§©‰∏≠ÊòæÁ§∫ÁöÑÁ≥ªÁªüÊñáÊú¨"}\`
-   **„ÄêÂÖ®Êñ∞„ÄëÂºïÁî®ÂõûÂ§ç**: \`{"type": "quote_reply", "target_timestamp": (‰Ω†ÊÉ≥ÂºïÁî®ÁöÑÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥), "reply_content": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ"}\`

# Â¶Ç‰ΩïÂå∫ÂàÜÂõæÁâá‰∏éË°®ÊÉÖ:
-   **ÂõæÁâá (ai_image)**: ÊåáÁöÑÊòØ„ÄêÊ®°ÊãüÁúüÂÆûÁõ∏Êú∫ÊãçÊëÑÁöÑÁÖßÁâá„ÄëÔºåÊØîÂ¶ÇÈ£éÊôØ„ÄÅËá™Êãç„ÄÅÁæéÈ£üÁ≠â„ÄÇÊåá‰ª§: \`{"type": "ai_image", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}\`
-   **Ë°®ÊÉÖ (sticker)**: ÊåáÁöÑÊòØ„ÄêÂç°ÈÄöÊàñÊ¢óÂõæ„ÄëÔºåÁî®‰∫éË°®ËææÊÉÖÁª™„ÄÇ

${worldBookContent}
${musicContext}
${summaryContext}
${sharedContext}
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äËßÑÂàôÂíå‰∏ãÈù¢ÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ`;
            }

            messagesPayload = historySlice
              .map((msg) => {
                // ËøáÊª§Êéâ‰∏çÂ∫îÂèëÈÄÅÁªôAIÁöÑÊ∂àÊÅØ
                if (msg.isHidden && msg.role !== "system") return null;

                if (msg.type === "share_card") return null;

                // 1. Â¶ÇÊûúÊòØAIËá™Â∑±ÁöÑÊ∂àÊÅØÔºåÊàë‰ª¨Â∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫AIËÉΩÁêÜËß£ÁöÑJSONÂ≠óÁ¨¶‰∏≤Ê†ºÂºè
                if (msg.role === "assistant") {
                  let assistantMsgObject = { type: msg.type || "text" };
                  if (msg.type === "sticker") {
                    assistantMsgObject.url = msg.content;
                    assistantMsgObject.meaning = msg.meaning;
                  } else if (msg.type === "transfer") {
                    assistantMsgObject.amount = msg.amount;
                    assistantMsgObject.note = msg.note;
                  } else if (msg.type === "waimai_request") {
                    assistantMsgObject.productInfo = msg.productInfo;
                    assistantMsgObject.amount = msg.amount;
                  } else {
                    if (msg.quote) {
                      assistantMsgObject.quote_reply = {
                        target_sender: msg.quote.senderName,
                        target_content: msg.quote.content,
                        reply_content: msg.content,
                      };
                    } else {
                      assistantMsgObject.content = msg.content;
                    }
                  }
                  // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáå‰∏∫AIÊèê‰æõÂÆÉËá™Â∑±Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
                  const assistantContent = JSON.stringify([assistantMsgObject]);
                  return {
                    role: "assistant",
                    content: `(Timestamp: ${msg.timestamp}) ${assistantContent}`,
                  };
                }

                // 2. Â¶ÇÊûúÊòØÁî®Êà∑ÁöÑÊ∂àÊÅØÔºåÊàë‰ª¨Â∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫Â∏¶‰∏ä‰∏ãÊñáÁöÑÁ∫ØÊñáÊú¨
                let contentStr = "";

                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ÊâÄÊúâÂÜÖÂÆπÂâçÔºåÈÉΩÂÖàÂä†‰∏äÊó∂Èó¥Êà≥ÔºÅ
                contentStr += `(Timestamp: ${msg.timestamp}) `;

                if (msg.quote) {
                  contentStr += `(ÂõûÂ§ç ${msg.quote.senderName}): ${msg.content}`;
                } else {
                  contentStr += msg.content;
                }

                // ÁâπÊÆäÊ∂àÊÅØÁ±ªÂûãÁöÑÊñáÊú¨ÂåñÂ§ÑÁêÜ
                if (msg.type === "user_photo")
                  return {
                    role: "user",
                    content: `(Timestamp: ${msg.timestamp}) [‰Ω†Êî∂Âà∞‰∫Ü‰∏ÄÂº†Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâáÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`,
                  };
                if (msg.type === "voice_message")
                  return {
                    role: "user",
                    content: `(Timestamp: ${msg.timestamp}) [Áî®Êà∑ÂèëÊù•‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`,
                  };
                if (msg.type === "transfer")
                  return {
                    role: "user",
                    content: `(Timestamp: ${msg.timestamp}) [Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} Êî∂Âà∞‰∫ÜÊù•Ëá™Áî®Êà∑ÁöÑËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}„ÄÇËØ∑‰Ω†ÂÜ≥Á≠ñÂπ∂‰ΩøÁî® 'accept_transfer' Êàñ 'decline_transfer' Êåá‰ª§ÂõûÂ∫î„ÄÇ]`,
                  };
                if (msg.type === "waimai_request")
                  return {
                    role: "user",
                    content: `(Timestamp: ${msg.timestamp}) [Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} ÂèëËµ∑‰∫ÜÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºåÂïÜÂìÅÊòØ‚Äú${msg.productInfo}‚ÄùÔºåÈáëÈ¢ùÊòØ ${msg.amount} ÂÖÉ„ÄÇËØ∑‰Ω†ÂÜ≥Á≠ñÂπ∂‰ΩøÁî® waimai_response Êåá‰ª§ÂõûÂ∫î„ÄÇ]`,
                  };

                if (
                  Array.isArray(msg.content) &&
                  msg.content[0]?.type === "image_url"
                ) {
                  const prefix = `(Timestamp: ${msg.timestamp}) `;
                  // Â∞ÜÊñáÊú¨ÂâçÁºÄÂíåÂõæÁâáÂÜÖÂÆπÊâìÂåÖÊàê‰∏Ä‰∏™Êï∞ÁªÑÔºåËøôÊâçÊòØÊ≠£Á°ÆÁöÑÊ†ºÂºè
                  return {
                    role: "user",
                    content: [{ type: "text", text: prefix }, ...msg.content],
                  };
                }

                if (msg.meaning)
                  return {
                    role: "user",
                    content: `(Timestamp: ${msg.timestamp}) [Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØÔºö'${msg.meaning}']`,
                  };

                // ÂØπ‰∫éÊôÆÈÄöÊñáÊú¨ÂíåÂ∏¶ÂºïÁî®ÁöÑÊñáÊú¨ÔºåÁªü‰∏ÄËøîÂõû
                return { role: msg.role, content: contentStr };
              })
              .filter(Boolean);

            // Ê£ÄÊü• sharedContext ÊòØÂê¶ÊúâÂÜÖÂÆπÔºàÂç≥ÔºåÁî®Êà∑ÊòØÂê¶ÂàÜ‰∫´‰∫ÜËÅäÂ§©ËÆ∞ÂΩïÔºâ
            if (sharedContext) {
              // Â¶ÇÊûúÊúâÔºåÂ∞±ÊääÂÆÉÂåÖË£ÖÊàê‰∏ÄÊù°ÂÖ®Êñ∞ÁöÑ„ÄÅÈ´ò‰ºòÂÖàÁ∫ßÁöÑÁî®Êà∑Ê∂àÊÅØÔºåËøΩÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩïÁöÑÊú´Â∞æ
              messagesPayload.push({
                role: "user",
                content: sharedContext,
              });
            }

            if (
              !chat.isGroup &&
              chat.relationship?.status === "pending_ai_approval"
            ) {
              const contextSummaryForApproval = chat.history
                .filter((m) => !m.isHidden)
                .slice(-10)
                .map((msg) => {
                  const sender = msg.role === "user" ? "Áî®Êà∑" : chat.name;
                  return `${sender}: ${String(msg.content).substring(
                    0,
                    50,
                  )}...`;
                })
                .join("\n");

              const friendRequestInstruction = {
                role: "user",
                content: `
      [Á≥ªÁªüÈáçË¶ÅÊåá‰ª§]
      Áî®Êà∑Âêë‰Ω†ÂèëÈÄÅ‰∫ÜÂ•ΩÂèãÁî≥ËØ∑ÔºåÁêÜÁî±ÊòØÔºö‚Äú${chat.relationship.applicationReason}‚Äù„ÄÇ
      ‰Ωú‰∏∫ÂèÇËÄÉÔºåËøôÊòØ‰Ω†‰ª¨‰πãÂâçÁöÑÊúÄÂêé‰∏ÄÊÆµËÅäÂ§©ËÆ∞ÂΩïÔºö
      ---
      ${contextSummaryForApproval}
      ---
      ËØ∑‰Ω†Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºå‰ª•Âèä‰Ω†ÁöÑ‰∫∫ËÆæÔºå‰ΩøÁî® friend_request_response Êåá‰ª§ÔºåÂπ∂ËÆæÁΩÆ decision ‰∏∫ 'accept' Êàñ 'reject' Êù•ÂÜ≥ÂÆöÊòØÂê¶ÈÄöËøá„ÄÇ
      `,
              };
              messagesPayload.push(friendRequestInstruction);
            }

            const allRecentPosts = await db.qzonePosts
              .orderBy("timestamp")
              .reverse()
              .limit(5)
              .toArray();
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåÊèíÂÖ•ËøáÊª§Ê≠•È™§
            const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);

            if (visiblePosts.length > 0 && !chat.isGroup) {
              let postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
              const aiName = chat.name;
              for (const post of visiblePosts) {
                let authorName =
                  post.authorId === "user"
                    ? state.qzoneSettings.nickname
                    : state.chats[post.authorId]?.name || "‰∏Ä‰ΩçÊúãÂèã";
                let interactionStatus = "";
                if (post.likes && post.likes.includes(aiName))
                  interactionStatus += " [‰Ω†Â∑≤ÁÇπËµû]";
                if (
                  post.comments &&
                  post.comments.some((c) => c.commenterName === aiName)
                )
                  interactionStatus += " [‰Ω†Â∑≤ËØÑËÆ∫]";
                if (post.authorId === chatId) authorName += " (ËøôÊòØ‰Ω†ÁöÑÂ∏ñÂ≠ê)";
                const contentSummary =
                  (post.publicText || post.content || "ÂõæÁâáÂä®ÊÄÅ").substring(
                    0,
                    30,
                  ) + "...";
                postsContext += `- (ID: ${post.id}) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${contentSummary}"${interactionStatus}\n`;
              }
              messagesPayload.push({ role: "system", content: postsContext });
            }
            let isGemini = proxyUrl === GEMINI_API_URL;
            let aiResponseContent = "";

            // --- „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÊ£ÄÊü•ÊòØÂê¶ÂºÄÂêØÊµÅÂºèËØ∑Ê±Ç (‰ªÖÈôêÈùûÂéüÁîüGeminiÊ∏†ÈÅì) ---
            if ((getActiveApiConfig() || {}).enableStreaming && !isGemini) {
              console.log("Ê≠£Âú®‰ΩøÁî®ÊµÅÂºèËØ∑Ê±Ç (OpenAIÂÖºÂÆπÊ®°Âºè)...");
              const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${apiKey}`,
                },
                body: JSON.stringify({
                  model: model,
                  messages: [
                    { role: "system", content: systemPrompt },
                    ...messagesPayload,
                  ],
                  temperature: enableTemp ? temperature : undefined,
                  top_p: enableTopP ? topP : undefined,
                  top_k: enableTopK ? topK : undefined,
                  stream: true, // <--- ÂºÄÂêØÊµÅÂºè
                }),
              });

              if (!response.ok) {
                let errorMsg = `API Error: ${response.status}`;
                try {
                  const errorData = await response.json();
                  errorMsg += ` - ${
                    errorData?.error?.message || JSON.stringify(errorData)
                  }`;
                } catch (e) {
                  errorMsg += ` - ${await response.text()}`;
                }
                throw new Error(errorMsg);
              }

              // --- Â§ÑÁêÜÊµÅÂºèÂìçÂ∫î ---
              const reader = response.body.getReader();
              const decoder = new TextDecoder("utf-8");
              let buffer = "";

              while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;

                const lines = buffer.split("\n");
                buffer = lines.pop(); // ‰øùÁïôÊúÄÂêé‰∏Ä‰∏™ÂèØËÉΩ‰∏çÂÆåÊï¥ÁöÑË°å

                for (const line of lines) {
                  const trimmed = line.trim();
                  if (trimmed.startsWith("data: ")) {
                    const dataStr = trimmed.slice(6);
                    if (dataStr === "[DONE]") continue;
                    try {
                      const dataObj = JSON.parse(dataStr);
                      const delta = dataObj.choices[0].delta?.content || "";
                      aiResponseContent += delta;
                    } catch (e) {
                      // ÂøΩÁï•Ëß£ÊûêÈîôËØØ
                    }
                  }
                }
              }
            } else {
              // --- ÂéüÊúâÁöÑÈùûÊµÅÂºèÈÄªËæë (ÂåÖÂê´ÂéüÁîüGeminiÊîØÊåÅ) ---
              let geminiConfig = toGeminiRequestData(
                model,
                apiKey,
                systemPrompt,
                messagesPayload,
                isGemini,
                enableTemp ? temperature : undefined,
                enableTopP ? topP : undefined,
                enableTopK ? topK : undefined,
              );
              const response = isGemini
                ? await fetch(geminiConfig.url, geminiConfig.data)
                : await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: `Bearer ${apiKey}`,
                    },
                    body: JSON.stringify({
                      model: model,
                      messages: [
                        { role: "system", content: systemPrompt },
                        ...messagesPayload,
                      ],
                      temperature: enableTemp ? temperature : undefined,
                      top_p: enableTopP ? topP : undefined,
                      top_k: enableTopK ? topK : undefined,
                      stream: false,
                    }),
                  });

              if (!response.ok) {
                let errorMsg = `API Error: ${response.status}`;
                try {
                  const errorData = await response.json();
                  errorMsg += ` - ${
                    errorData?.error?.message || JSON.stringify(errorData)
                  }`;
                } catch (jsonError) {
                  errorMsg += ` - ${await response.text()}`;
                }
                throw new Error(errorMsg);
              }
              const data = await response.json();
              aiResponseContent = isGemini
                ? data.candidates[0].content.parts[0].text
                : data.choices[0].message.content;
            }

            console.log(`AI '${chat.name}' ÁöÑÂéüÂßãÂõûÂ§ç:`, aiResponseContent);

            chat.history = chat.history.filter((msg) => !msg.isTemporary);

            const messagesArray = parseAiResponse(aiResponseContent);

            const isViewingThisChat =
              document
                .getElementById("chat-interface-screen")
                .classList.contains("active") && state.activeChatId === chatId;

            let callHasBeenHandled = false;

            let messageTimestamp = Date.now();

            // ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉ‰øÆÂ§ç Á¨¨1Ê≠•: ÂàùÂßãÂåñ‰∏Ä‰∏™Êñ∞Êï∞ÁªÑÔºåÁî®‰∫éÊî∂ÈõÜÈúÄË¶ÅÊ∏≤ÊüìÁöÑÊ∂àÊÅØ ‚òÖ‚òÖ‚òÖ
            let newMessagesToRender = [];

            let notificationShown = false;

            for (const msgData of messagesArray) {
              if (!msgData || typeof msgData !== "object") {
                console.warn("Êî∂Âà∞‰∫ÜÊ†ºÂºè‰∏çËßÑËåÉÁöÑAIÊåá‰ª§ÔºåÂ∑≤Ë∑≥Ëøá:", msgData);
                continue;
              }

              if (!msgData.type) {
                if (chat.isGroup && msgData.name && msgData.message) {
                  msgData.type = "text";
                } else if (msgData.content) {
                  msgData.type = "text";
                }
                // Â¶ÇÊûúËøû content ÈÉΩÊ≤°ÊúâÔºåÊâçÊòØÁúüÁöÑÊ†ºÂºè‰∏çËßÑËåÉ
                else {
                  console.warn(
                    "Êî∂Âà∞‰∫ÜÊ†ºÂºè‰∏çËßÑËåÉÁöÑAIÊåá‰ª§ÔºàÁº∫Â∞ëtypeÂíåcontentÔºâÔºåÂ∑≤Ë∑≥Ëøá:",
                    msgData,
                  );
                  continue;
                }
              }

              if (msgData.type === "video_call_response") {
                videoCallState.isAwaitingResponse = false;
                if (msgData.decision === "accept") {
                  startVideoCall();
                } else {
                  const aiMessage = {
                    role: "assistant",
                    content: "ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ",
                    timestamp: Date.now(),
                  };
                  chat.history.push(aiMessage);
                  await db.chats.put(chat);
                  showScreen("chat-interface-screen");
                  renderChatInterface(chatId);
                }
                callHasBeenHandled = true;
                break;
              }

              if (msgData.type === "group_call_response") {
                if (msgData.decision === "join") {
                  const member = chat.members.find(
                    (m) => m.originalName === msgData.name,
                  );
                  if (
                    member &&
                    !videoCallState.participants.some((p) => p.id === member.id)
                  ) {
                    videoCallState.participants.push(member);
                  }
                }
                callHasBeenHandled = true;
                continue;
              }

              if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                console.error(
                  `AIÂπªËßâÂ∑≤Ë¢´Êã¶Êà™ÔºÅËØïÂõæ‰ΩøÁî®Áæ§Âêç ("${chat.name}") ‰Ωú‰∏∫ËßíËâ≤Âêç„ÄÇÊ∂àÊÅØÂÜÖÂÆπ:`,
                  msgData,
                );
                continue;
              }

              // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®Áæ§ËÅä‰∏≠ÔºåÂ¶ÇÊûúAIËøîÂõûÁöÑÊ∂àÊÅØÊ≤°ÊúâÊåáÂÆöÂèëÈÄÅËÄÖÔºåÂàôÁõ¥Êé•Ë∑≥ËøáËøôÊù°Ê∂àÊÅØ
              if (chat.isGroup && !msgData.name) {
                console.error(
                  `AIÂπªËßâÂ∑≤Ë¢´Êã¶Êà™ÔºÅËØïÂõæÂú®Áæ§ËÅä‰∏≠ÂèëÈÄÅ‰∏ÄÊù°Ê≤°Êúâ‚Äúname‚ÄùÁöÑÊ∂àÊÅØ„ÄÇÊ∂àÊÅØÂÜÖÂÆπ:`,
                  msgData,
                );
                continue; // continue‰ºöÁ´ãÂç≥ÁªìÊùüÊú¨Ê¨°Âæ™ÁéØÔºåÂ§ÑÁêÜ‰∏ã‰∏ÄÊù°Ê∂àÊÅØ
              }

              let aiMessage = null;
              const baseMessage = {
                role: "assistant",
                senderName: msgData.name || chat.name,
                timestamp: messageTimestamp++,
              };

              switch (msgData.type) {
                case "waimai_response":
                  const requestMessageIndex = chat.history.findIndex(
                    (m) => m.timestamp === msgData.for_timestamp,
                  );
                  if (requestMessageIndex > -1) {
                    const originalMsg = chat.history[requestMessageIndex];
                    originalMsg.status = msgData.status;
                    originalMsg.paidBy =
                      msgData.status === "paid" ? msgData.name : null;
                  }
                  continue;

                case "qzone_post":
                  const newPost = {
                    type: msgData.postType,
                    content: msgData.content || "",
                    publicText: msgData.publicText || "",
                    hiddenContent: msgData.hiddenContent || "",
                    timestamp: Date.now(),
                    authorId: chatId,
                    authorGroupId: chat.groupId, // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëËÆ∞ÂΩï‰ΩúËÄÖÁöÑÂàÜÁªÑID
                    visibleGroupIds: null,
                  };
                  await db.qzonePosts.add(newPost);
                  updateUnreadIndicator(unreadPostsCount + 1);
                  if (
                    isViewingThisChat &&
                    document
                      .getElementById("qzone-screen")
                      .classList.contains("active")
                  ) {
                    await renderQzonePosts();
                  }
                  continue;

                case "qzone_comment":
                  const postToComment = await db.qzonePosts.get(
                    parseInt(msgData.postId),
                  );
                  if (postToComment) {
                    if (!postToComment.comments) postToComment.comments = [];
                    postToComment.comments.push({
                      commenterName: chat.name,
                      text: msgData.commentText,
                      timestamp: Date.now(),
                    });
                    await db.qzonePosts.update(postToComment.id, {
                      comments: postToComment.comments,
                    });
                    updateUnreadIndicator(unreadPostsCount + 1);
                    if (
                      isViewingThisChat &&
                      document
                        .getElementById("qzone-screen")
                        .classList.contains("active")
                    ) {
                      await renderQzonePosts();
                    }
                  }
                  continue;

                case "qzone_like":
                  const postToLike = await db.qzonePosts.get(
                    parseInt(msgData.postId),
                  );
                  if (postToLike) {
                    if (!postToLike.likes) postToLike.likes = [];
                    if (!postToLike.likes.includes(chat.name)) {
                      postToLike.likes.push(chat.name);
                      await db.qzonePosts.update(postToLike.id, {
                        likes: postToLike.likes,
                      });
                      updateUnreadIndicator(unreadPostsCount + 1);
                      if (
                        isViewingThisChat &&
                        document
                          .getElementById("qzone-screen")
                          .classList.contains("active")
                      ) {
                        await renderQzonePosts();
                      }
                    }
                  }
                  continue;

                case "video_call_request":
                  if (
                    !videoCallState.isActive &&
                    !videoCallState.isAwaitingResponse
                  ) {
                    state.activeChatId = chatId;
                    videoCallState.activeChatId = chatId;
                    videoCallState.isAwaitingResponse = true;
                    videoCallState.isGroupCall = chat.isGroup;
                    videoCallState.callRequester = msgData.name || chat.name;
                    showIncomingCallModal();
                  }
                  continue;

                case "group_call_request":
                  if (
                    !videoCallState.isActive &&
                    !videoCallState.isAwaitingResponse
                  ) {
                    state.activeChatId = chatId;
                    videoCallState.isAwaitingResponse = true;
                    videoCallState.isGroupCall = true;
                    videoCallState.initiator = "ai";
                    videoCallState.callRequester = msgData.name;
                    showIncomingCallModal();
                  }
                  continue;

                case "pat_user":
                  const suffix = msgData.suffix
                    ? ` ${msgData.suffix.trim()}`
                    : "";
                  const patText = `${
                    msgData.name || chat.name
                  } Êãç‰∫ÜÊãçÊàë${suffix}`;
                  const patMessage = {
                    role: "system",
                    type: "pat_message",
                    content: patText,
                    timestamp: Date.now(),
                  };
                  chat.history.push(patMessage);
                  if (isViewingThisChat) {
                    const phoneScreen = document.getElementById("phone-screen");
                    phoneScreen.classList.remove("pat-animation");
                    void phoneScreen.offsetWidth;
                    phoneScreen.classList.add("pat-animation");
                    setTimeout(
                      () => phoneScreen.classList.remove("pat-animation"),
                      500,
                    );
                    appendMessage(patMessage, chat);
                  } else {
                    showNotification(chatId, patText);
                  }
                  continue;

                case "update_status":
                  chat.status.text = msgData.status_text;
                  chat.status.isBusy = msgData.is_busy || false;
                  chat.status.lastUpdate = Date.now();

                  const statusUpdateMessage = {
                    role: "system",
                    type: "pat_message",
                    content: `[${chat.name}ÁöÑÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫: ${msgData.status_text}]`,
                    timestamp: Date.now(),
                  };
                  chat.history.push(statusUpdateMessage);

                  if (isViewingThisChat) {
                    appendMessage(statusUpdateMessage, chat);
                  }

                  renderChatList();

                  continue;

                case "change_music":
                  if (
                    musicState.isActive &&
                    musicState.activeChatId === chatId
                  ) {
                    const songNameToFind = msgData.song_name;

                    const targetSongIndex = musicState.playlist.findIndex(
                      (track) =>
                        track.name.toLowerCase() ===
                        songNameToFind.toLowerCase(),
                    );

                    if (targetSongIndex > -1) {
                      playSong(targetSongIndex);

                      const track = musicState.playlist[targetSongIndex];
                      const musicChangeMessage = {
                        role: "system",
                        type: "pat_message",
                        content: `[‚ô™ ${chat.name} ‰∏∫‰Ω†ÂàáÊ≠å: „Ää${track.name}„Äã - ${track.artist}]`,
                        timestamp: Date.now(),
                      };
                      chat.history.push(musicChangeMessage);

                      if (isViewingThisChat) {
                        appendMessage(musicChangeMessage, chat);
                      }
                    }
                  }
                  continue;
                case "create_memory":
                  const newMemory = {
                    chatId: chatId,
                    authorName: chat.name,
                    description: msgData.description,
                    timestamp: Date.now(),
                    type: "ai_generated",
                  };
                  await db.memories.add(newMemory);

                  console.log(
                    `AI "${chat.name}" ËÆ∞ÂΩï‰∫Ü‰∏ÄÊù°Êñ∞ÂõûÂøÜ:`,
                    msgData.description,
                  );

                  continue;

                case "create_countdown":
                  const targetDate = new Date(msgData.date);
                  if (!isNaN(targetDate) && targetDate > new Date()) {
                    const newCountdown = {
                      chatId: chatId,
                      authorName: chat.name,
                      description: msgData.title,
                      timestamp: Date.now(),
                      type: "countdown",
                      targetDate: targetDate.getTime(),
                    };
                    await db.memories.add(newCountdown);
                    console.log(
                      `AI "${chat.name}" ÂàõÂª∫‰∫Ü‰∏Ä‰∏™Êñ∞Á∫¶ÂÆö:`,
                      msgData.title,
                    );
                  }
                  continue;

                case "block_user":
                  if (!chat.isGroup) {
                    chat.relationship.status = "blocked_by_ai";

                    const hiddenMessage = {
                      role: "system",
                      content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàö‰∏ªÂä®ÊãâÈªë‰∫ÜÁî®Êà∑„ÄÇ]`,
                      timestamp: Date.now(),
                      isHidden: true,
                    };
                    chat.history.push(hiddenMessage);

                    await db.chats.put(chat);

                    if (isViewingThisChat) {
                      renderChatInterface(chatId);
                    }
                    renderChatList();

                    break;
                  }
                  continue;
                case "friend_request_response":
                  if (
                    !chat.isGroup &&
                    chat.relationship.status === "pending_ai_approval"
                  ) {
                    if (msgData.decision === "accept") {
                      chat.relationship.status = "friend";
                      aiMessage = {
                        ...baseMessage,
                        content: "ÊàëÈÄöËøá‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑ÔºåÊàë‰ª¨Áé∞Âú®ÊòØÂ•ΩÂèãÂï¶ÔºÅ",
                      };
                    } else {
                      chat.relationship.status = "blocked_by_ai";
                      aiMessage = {
                        ...baseMessage,
                        content: "Êä±Ê≠âÔºåÊàëÊãíÁªù‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑„ÄÇ",
                      };
                    }
                    chat.relationship.applicationReason = "";
                  }
                  break;
                case "poll":
                  const pollOptions =
                    typeof msgData.options === "string"
                      ? msgData.options.split("\n").filter((opt) => opt.trim())
                      : Array.isArray(msgData.options)
                        ? msgData.options
                        : [];

                  if (pollOptions.length < 2) continue;

                  aiMessage = {
                    ...baseMessage,
                    type: "poll",
                    question: msgData.question,
                    options: pollOptions,
                    votes: {},
                    isClosed: false,
                  };
                  break;

                case "vote":
                  const pollToVote = chat.history.find(
                    (m) => m.timestamp === msgData.poll_timestamp,
                  );
                  if (pollToVote && !pollToVote.isClosed) {
                    Object.keys(pollToVote.votes).forEach((option) => {
                      const voterIndex = pollToVote.votes[option].indexOf(
                        msgData.name,
                      );
                      if (voterIndex > -1) {
                        pollToVote.votes[option].splice(voterIndex, 1);
                      }
                    });
                    if (!pollToVote.votes[msgData.choice]) {
                      pollToVote.votes[msgData.choice] = [];
                    }

                    const member = chat.members.find(
                      (m) => m.originalName === msgData.name,
                    );
                    const displayName = member
                      ? member.groupNickname
                      : msgData.name;

                    if (
                      !pollToVote.votes[msgData.choice].includes(displayName)
                    ) {
                      // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë
                      pollToVote.votes[msgData.choice].push(displayName); // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë
                    }

                    if (isViewingThisChat) {
                      renderChatInterface(chatId);
                    }
                  }
                  continue;

                case "red_packet":
                  aiMessage = {
                    ...baseMessage,
                    type: "red_packet",
                    packetType: msgData.packetType,
                    totalAmount: msgData.amount,
                    count: msgData.count,
                    greeting: msgData.greeting,
                    receiverName: msgData.receiver,
                    claimedBy: {},
                    isFullyClaimed: false,
                  };
                  break;
                case "open_red_packet":
                  const packetToOpen = chat.history.find(
                    (m) => m.timestamp === msgData.packet_timestamp,
                  );
                  if (
                    packetToOpen &&
                    !packetToOpen.isFullyClaimed &&
                    !(
                      packetToOpen.claimedBy &&
                      packetToOpen.claimedBy[msgData.name]
                    )
                  ) {
                    // 1. Ê†πÊçÆAIÁöÑÊú¨Âêç(msgData.name)ÂéªÊàêÂëòÂàóË°®ÈáåÊâæÂà∞ÂÆåÊï¥ÁöÑÊàêÂëòÂØπË±°
                    const member = chat.members.find(
                      (m) => m.originalName === msgData.name,
                    );
                    // 2. Ëé∑ÂèñËØ•ÊàêÂëòÂΩìÂâçÁöÑÁæ§ÊòµÁß∞ÔºåÂ¶ÇÊûúÊâæ‰∏çÂà∞ÔºàÂºÇÂ∏∏ÊÉÖÂÜµÔºâÔºåÂàôÂ§áÁî®ÂÖ∂Êú¨Âêç
                    const displayName = member
                      ? member.groupNickname
                      : msgData.name;

                    let claimedAmountAI = 0;
                    const remainingAmount =
                      packetToOpen.totalAmount -
                      Object.values(packetToOpen.claimedBy || {}).reduce(
                        (sum, val) => sum + val,
                        0,
                      );
                    const remainingCount =
                      packetToOpen.count -
                      Object.keys(packetToOpen.claimedBy || {}).length;

                    if (remainingCount > 0) {
                      if (remainingCount === 1) {
                        claimedAmountAI = remainingAmount;
                      } else {
                        const min = 0.01;
                        const max =
                          remainingAmount - (remainingCount - 1) * min;
                        claimedAmountAI = Math.random() * (max - min) + min;
                      }
                      claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));

                      if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
                      // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë‰ΩøÁî®Êàë‰ª¨ÂàöÂàöÊü•ÊâæÂà∞ÁöÑ displayName ‰Ωú‰∏∫ËÆ∞ÂΩïÁöÑkey
                      packetToOpen.claimedBy[displayName] = claimedAmountAI;

                      const aiClaimedMessage = {
                        role: "system",
                        type: "pat_message",
                        // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÁ≥ªÁªüÊ∂àÊÅØÈáå‰πü‰ΩøÁî® displayName
                        content: `${displayName} È¢ÜÂèñ‰∫Ü ${packetToOpen.senderName} ÁöÑÁ∫¢ÂåÖ`,
                        timestamp: Date.now(),
                      };
                      chat.history.push(aiClaimedMessage);

                      let hiddenContentForAI = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${displayName}) ÊàêÂäüÊä¢Âà∞‰∫Ü ${claimedAmountAI.toFixed(
                        2,
                      )} ÂÖÉ„ÄÇ`; // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë

                      if (
                        Object.keys(packetToOpen.claimedBy).length >=
                        packetToOpen.count
                      ) {
                        packetToOpen.isFullyClaimed = true;

                        const finishedMessage = {
                          role: "system",
                          type: "pat_message",
                          content: `${packetToOpen.senderName} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå`,
                          timestamp: Date.now() + 1,
                        };
                        chat.history.push(finishedMessage);

                        let luckyKing = { name: "", amount: -1 };
                        if (
                          packetToOpen.packetType === "lucky" &&
                          packetToOpen.count > 1
                        ) {
                          Object.entries(packetToOpen.claimedBy).forEach(
                            ([name, amount]) => {
                              if (amount > luckyKing.amount) {
                                luckyKing = { name, amount };
                              }
                            },
                          );
                        }
                        if (luckyKing.name) {
                          hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºåÊâãÊ∞îÁéãÊòØ ${luckyKing.name}ÔºÅ`;
                        } else {
                          hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå„ÄÇ`;
                        }
                      }
                      hiddenContentForAI += " ËØ∑Ê†πÊçÆËøô‰∏™ÁªìÊûúÂèëË°®‰Ω†ÁöÑËØÑËÆ∫„ÄÇ]";

                      const hiddenMessageForAI = {
                        role: "system",
                        content: hiddenContentForAI,
                        timestamp: Date.now() + 2,
                        isHidden: true,
                      };
                      chat.history.push(hiddenMessageForAI);
                    }

                    if (isViewingThisChat) {
                      renderChatInterface(chatId);
                    }
                  }
                  continue;
                case "change_avatar":
                  const avatarName = msgData.name;
                  // Âú®ËØ•ËßíËâ≤ÁöÑÂ§¥ÂÉèÂ∫ì‰∏≠Êü•Êâæ
                  const foundAvatar = chat.settings.aiAvatarLibrary.find(
                    (avatar) => avatar.name === avatarName,
                  );

                  if (foundAvatar) {
                    // ÊâæÂà∞‰∫ÜÔºåÂ∞±Êõ¥Êñ∞Â§¥ÂÉè
                    chat.settings.aiAvatar = foundAvatar.url;

                    // ÂàõÂª∫‰∏ÄÊù°Á≥ªÁªüÊèêÁ§∫ÔºåÂëäÁü•Áî®Êà∑Â§¥ÂÉèÂ∑≤Êõ¥Êç¢
                    const systemNotice = {
                      role: "system",
                      type: "pat_message", // Â§çÁî®Â±Ö‰∏≠Ê†∑Âºè
                      content: `[${chat.name} Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè]`,
                      timestamp: Date.now(),
                    };
                    chat.history.push(systemNotice);

                    // Â¶ÇÊûúÂú®ÂΩìÂâçËÅäÂ§©ÁïåÈù¢ÔºåÂàôÂÆûÊó∂Ê∏≤Êüì
                    if (isViewingThisChat) {
                      appendMessage(systemNotice, chat);
                      // Á´ãÂàªÂà∑Êñ∞ËÅäÂ§©ÁïåÈù¢‰ª•ÊòæÁ§∫Êñ∞Â§¥ÂÉè
                      renderChatInterface(chatId);
                    }
                  }
                  // Â§ÑÁêÜÂÆåÂêéÔºåÁªßÁª≠Â§ÑÁêÜAIÂèØËÉΩËøîÂõûÁöÑÂÖ∂‰ªñÊ∂àÊÅØ
                  continue;

                case "accept_transfer": {
                  // ‰ΩøÁî®Â§ßÊã¨Âè∑ÂàõÂª∫ÂùóÁ∫ß‰ΩúÁî®Âüü
                  const originalTransferMsgIndex = chat.history.findIndex(
                    (m) => m.timestamp === msgData.for_timestamp,
                  );
                  if (originalTransferMsgIndex > -1) {
                    const originalMsg = chat.history[originalTransferMsgIndex];
                    originalMsg.status = "accepted";
                  }
                  continue; // Êé•ÂèóÊåá‰ª§Âè™‰øÆÊîπÁä∂ÊÄÅÔºå‰∏ç‰∫ßÁîüÊñ∞Ê∂àÊÅØ
                }

                case "decline_transfer": {
                  // ‰ΩøÁî®Â§ßÊã¨Âè∑ÂàõÂª∫ÂùóÁ∫ß‰ΩúÁî®Âüü
                  const originalTransferMsgIndex = chat.history.findIndex(
                    (m) => m.timestamp === msgData.for_timestamp,
                  );
                  if (originalTransferMsgIndex > -1) {
                    const originalMsg = chat.history[originalTransferMsgIndex];
                    originalMsg.status = "declined";

                    // „ÄêÊ†∏ÂøÉ„ÄëÂàõÂª∫‰∏ÄÊù°Êñ∞ÁöÑ‚ÄúÈÄÄÊ¨æ‚ÄùÊ∂àÊÅØ
                    const refundMessage = {
                      role: "assistant",
                      senderName: chat.name,
                      type: "transfer",
                      isRefund: true, // Ê†áËÆ∞ËøôÊòØ‰∏ÄÊù°ÈÄÄÊ¨æÊ∂àÊÅØ
                      amount: originalMsg.amount,
                      note: "ËΩ¨Ë¥¶Â∑≤Ë¢´ÊãíÊî∂",
                      timestamp: messageTimestamp++, // ‰ΩøÁî®ÈÄíÂ¢ûÁöÑÊó∂Èó¥Êà≥
                    };

                    // Â∞ÜÊñ∞Ê∂àÊÅØÊé®ÂÖ•ÂéÜÂè≤ËÆ∞ÂΩïÔºåÂÆÉ‰ºöË¢´ÂêéÁª≠ÁöÑÂæ™ÁéØÂ§ÑÁêÜÂπ∂Ê∏≤Êüì
                    chat.history.push(refundMessage);

                    if (isViewingThisChat) {
                      // Âõ†‰∏∫ÈÄÄÊ¨æÊ∂àÊÅØÊòØÊñ∞ÁîüÊàêÁöÑÔºåÊâÄ‰ª•Êàë‰ª¨Áõ¥Êé•Â∞ÜÂÆÉÊ∑ªÂä†Âà∞ÁïåÈù¢‰∏ä
                      appendMessage(refundMessage, chat);
                      // ÂêåÊó∂ÔºåÂéüÂßãÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÁä∂ÊÄÅÂèò‰∫ÜÔºåÊâÄ‰ª•Ë¶ÅÈáçÁªòÊï¥‰∏™ÁïåÈù¢‰ª•Êõ¥Êñ∞ÂÆÉ
                      renderChatInterface(chatId);
                    }
                  }
                  continue; // ÁªßÁª≠Â§ÑÁêÜAIËøîÂõûÁöÑÊñáÊú¨Ê∂àÊÅØ
                }

                case "system_message":
                  aiMessage = {
                    role: "system",
                    type: "pat_message",
                    content: msgData.content,
                    timestamp: Date.now(),
                  };
                  break;

                case "share_link":
                  aiMessage = {
                    ...baseMessage,
                    type: "share_link",
                    title: msgData.title,
                    description: msgData.description,
                    // thumbnail_url: msgData.thumbnail_url, // Êàë‰ª¨Â∑≤ÁªèÂÜ≥ÂÆö‰∏çË¶ÅÂõæÁâá‰∫ÜÔºåÊâÄ‰ª•ËøôË°åÂèØ‰ª•‰∏çË¶Å
                    source_name: msgData.source_name,
                    content: msgData.content, // ËøôÊòØÊñáÁ´†Ê≠£ÊñáÔºåÁÇπÂáªÂç°ÁâáÂêéÊòæÁ§∫ÁöÑÂÜÖÂÆπ
                  };
                  break;

                case "quote_reply":
                  const originalMessage = chat.history.find(
                    (m) => m.timestamp === msgData.target_timestamp,
                  );
                  if (originalMessage) {
                    const quoteContext = {
                      timestamp: originalMessage.timestamp,
                      senderName:
                        originalMessage.senderName ||
                        (originalMessage.role === "user"
                          ? chat.settings.myNickname || "Êàë"
                          : chat.name),
                      content: String(originalMessage.content || "").substring(
                        0,
                        50,
                      ),
                    };
                    aiMessage = {
                      ...baseMessage,
                      content: String(msgData.reply_content || "").trim(),
                      quote: quoteContext, // Ê†∏ÂøÉÔºöÂú®ËøôÈáåÈôÑÂä†ÂºïÁî®ÂØπË±°
                    };
                  } else {
                    // Â¶ÇÊûúÊâæ‰∏çÂà∞Ë¢´ÂºïÁî®ÁöÑÊ∂àÊÅØÔºåÂ∞±ÂΩì‰ΩúÊôÆÈÄöÊ∂àÊÅØÂèëÈÄÅ
                    aiMessage = {
                      ...baseMessage,
                      content: String(msgData.reply_content || "").trim(),
                    };
                  }
                  break;

                case "send_and_recall": {
                  // ËøôÊòØ‰∏Ä‰∏™Á∫ØÂä®ÁîªÊåá‰ª§ÔºåÊàë‰ª¨ÈúÄË¶ÅÊâãÂä®‚ÄúÊºî‚ÄùÂá∫Êï¥‰∏™ËøáÁ®ã
                  if (!isViewingThisChat) continue; // Â¶ÇÊûú‰∏çÂú®ÂΩìÂâçËÅäÂ§©ÁïåÈù¢ÔºåÂ∞±Áõ¥Êé•Ë∑≥ËøáËøô‰∏™Âä®Áîª

                  const cleanedContent = String(msgData.content || "").trim();

                  // 1. ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑ„ÄÅÁúãËµ∑Êù•ÂÉèÁúüÊ∂àÊÅØÁöÑÊ∞îÊ≥°
                  const tempMessageData = {
                    ...baseMessage,
                    content: cleanedContent,
                  };
                  const tempMessageElement = createMessageElement(
                    tempMessageData,
                    chat,
                  );

                  // 2. ÊääÂÆÉÊ∑ªÂä†Âà∞ËÅäÂ§©ÁïåÈù¢‰∏äÔºåËÆ©Áî®Êà∑ÁúãÂà∞
                  appendMessage(tempMessageData, chat, true); // trueË°®Á§∫ËøôÊòØÂàùÂßãÂä†ËΩΩÔºå‰∏ç‰ºöËß¶ÂèëËøõÂÖ•Âä®Áîª

                  // 3. Á≠âÂæÖÁâáÂàªÔºåÊ®°ÊãüAIÁöÑ‚ÄúÂèçÂ∫îÊó∂Èó¥‚Äù
                  await new Promise((resolve) =>
                    setTimeout(resolve, Math.random() * 1000 + 1500),
                  ); // ÈöèÊú∫Á≠âÂæÖ1.5-2.5Áßí

                  // 4. ÊâæÂà∞ÂàöÂàöÊ∑ªÂä†ÁöÑ‰∏¥Êó∂Ê∞îÊ≥°ÔºåÂπ∂Êí≠ÊîæÊí§ÂõûÂä®Áîª
                  const bubbleWrapper = document
                    .querySelector(
                      `.message-bubble[data-timestamp="${tempMessageData.timestamp}"]`,
                    )
                    ?.closest(".message-wrapper");
                  if (bubbleWrapper) {
                    bubbleWrapper.classList.add("recalled-animation");

                    // 5. Âú®Âä®ÁîªÊí≠ÊîæÁªìÊùüÂêéÔºåÂ∞ÜÂÖ∂ÊõøÊç¢‰∏∫ÁúüÊ≠£ÁöÑ‚ÄúÂ∑≤Êí§Âõû‚ÄùÊèêÁ§∫
                    await new Promise((resolve) => setTimeout(resolve, 300)); // Á≠âÂæÖÂä®ÁîªÊí≠ÂÆå

                    // 6. ÊúÄÂêéÔºåÊâçÊääËøôÊù°‚ÄúÂ∑≤Êí§Âõû‚ÄùËÆ∞ÂΩïÁúüÊ≠£Âú∞Â≠òÂÖ•Êï∞ÊçÆÂ∫ì
                    const recalledMessage = {
                      role: "assistant",
                      senderName: msgData.name || chat.name,
                      type: "recalled_message",
                      content: "ÂØπÊñπÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ",
                      timestamp: tempMessageData.timestamp, // ‰ΩøÁî®‰∏¥Êó∂Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥Ôºå‰øùËØÅÈ°∫Â∫è
                      recalledData: {
                        originalType: "text",
                        originalContent: cleanedContent,
                      },
                    };

                    // Êõ¥Êñ∞Êï∞ÊçÆÊ®°Âûã
                    const msgIndex = chat.history.findIndex(
                      (m) => m.timestamp === tempMessageData.timestamp,
                    );
                    if (msgIndex > -1) {
                      chat.history[msgIndex] = recalledMessage;
                    } else {
                      chat.history.push(recalledMessage);
                    }

                    // ÊõøÊç¢DOM
                    const placeholder = createMessageElement(
                      recalledMessage,
                      chat,
                    );
                    if (document.body.contains(bubbleWrapper)) {
                      bubbleWrapper.parentNode.replaceChild(
                        placeholder,
                        bubbleWrapper,
                      );
                    }
                  }

                  continue; // Â§ÑÁêÜÂÆåËøô‰∏™Âä®ÁîªÂêéÔºåÁªßÁª≠Â§ÑÁêÜAIËøîÂõûÁöÑ‰∏ã‰∏ÄÊù°Êåá‰ª§
                }

                case "text":
                  aiMessage = {
                    ...baseMessage,
                    content: String(
                      msgData.content || msgData.message || "",
                    ).trim(),
                  };
                  break;
                case "sticker":
                  aiMessage = {
                    ...baseMessage,
                    type: "sticker",
                    content: String(msgData.url || "").trim(),
                    meaning: String(msgData.meaning || "").trim(),
                  };
                  break;
                case "ai_image":
                  aiMessage = {
                    ...baseMessage,
                    type: "ai_image",
                    content: String(msgData.description || "").trim(),
                  };
                  break;
                case "voice_message":
                  aiMessage = {
                    ...baseMessage,
                    type: "voice_message",
                    content: String(msgData.content || "").trim(),
                  };
                  break;
                case "transfer":
                  aiMessage = {
                    ...baseMessage,
                    type: "transfer",
                    amount: msgData.amount,
                    note: String(msgData.note || "").trim(),
                    receiverName: msgData.receiver || "Êàë",
                  };
                  break;

                case "waimai_request":
                  aiMessage = {
                    ...baseMessage,
                    type: "waimai_request",
                    productInfo: String(msgData.productInfo || "").trim(),
                    amount: msgData.amount,
                    status: "pending",
                    countdownEndTime: Date.now() + 15 * 60 * 1000,
                  };
                  break;

                default:
                  console.warn("Êî∂Âà∞‰∫ÜÊú™Áü•ÁöÑAIÊåá‰ª§Á±ªÂûã:", msgData.type);
                  break;
              }

              // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂ∞ÜÊ∏≤ÊüìÈÄªËæëÁßªÂá∫Âæ™ÁéØ
              if (aiMessage) {
                // 1. Â∞ÜÊñ∞Ê∂àÊÅØÂ≠òÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï
                chat.history.push(aiMessage);

                if (!isViewingThisChat && !notificationShown) {
                  let notificationText;
                  switch (aiMessage.type) {
                    case "transfer":
                      notificationText = `[Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶]`;
                      break;
                    case "waimai_request":
                      notificationText = `[Êî∂Âà∞‰∏Ä‰∏™Â§ñÂçñ‰ª£‰ªòËØ∑Ê±Ç]`;
                      break;
                    case "ai_image":
                      notificationText = `[ÂõæÁâá]`;
                      break;
                    case "voice_message":
                      notificationText = `[ËØ≠Èü≥]`;
                      break;
                    case "sticker":
                      notificationText = aiMessage.meaning
                        ? `[Ë°®ÊÉÖ: ${aiMessage.meaning}]`
                        : "[Ë°®ÊÉÖ]";
                      break;
                    default:
                      notificationText = String(aiMessage.content || "");
                  }
                  const finalNotifText = chat.isGroup
                    ? `${aiMessage.senderName}: ${notificationText}`
                    : notificationText;
                  showNotification(
                    chatId,
                    finalNotifText.substring(0, 40) +
                      (finalNotifText.length > 40 ? "..." : ""),
                  );
                  notificationShown = true; // Á°Æ‰øùÂè™ÈÄöÁü•‰∏ÄÊ¨°
                }

                if (!isViewingThisChat) {
                  // Â¶ÇÊûúÁî®Êà∑‰∏çÂú®ÂΩìÂâçËÅäÂ§©ÁïåÈù¢ÔºåÂ∞±ÊääËøô‰∏™ËÅäÂ§©ÁöÑÊú™ËØªÊï∞ +1
                  chat.unreadCount = (chat.unreadCount || 0) + 1;
                }

                // 2. Âè™ÊúâÂú®ÂΩìÂâçËÅäÂ§©ÁïåÈù¢Êó∂ÔºåÊâçÊâßË°åÂ∏¶Âä®ÁîªÁöÑÊ∑ªÂä†
                if (isViewingThisChat) {
                  appendMessage(aiMessage, chat);
                  // 3. „ÄêÂÖ≥ÈîÆ„ÄëÂú®ËøôÈáåÊöÇÂÅú‰∏ÄÂ∞è‰ºöÂÑøÔºåÁªôÂä®ÁîªÊí≠ÊîæÁöÑÊó∂Èó¥
                  await new Promise((resolve) =>
                    setTimeout(resolve, Math.random() * 1800 + 1000),
                  );
                }
              }
            }

            if (callHasBeenHandled && videoCallState.isGroupCall) {
              videoCallState.isAwaitingResponse = false;
              if (videoCallState.participants.length > 0) {
                startVideoCall();
              } else {
                videoCallState = {
                  ...videoCallState,
                  isAwaitingResponse: false,
                  participants: [],
                };
                showScreen("chat-interface-screen");
                alert("Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ");
              }
            }

            await db.chats.put(chat);
            // Ëß¶ÂèëÊÄªÁªìÊ£ÄÊü•
            await checkAndTriggerSummary(chatId);
          } catch (error) {
            chat.history = chat.history.filter((msg) => !msg.isTemporary);
            if (
              !chat.isGroup &&
              chat.relationship?.status === "pending_ai_approval"
            ) {
              chat.relationship.status = "blocked_by_ai";
              await showCustomAlert(
                "Áî≥ËØ∑Â§±Ë¥•",
                `AIÂú®Â§ÑÁêÜ‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑Êó∂Âá∫Èîô‰∫ÜÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ\nÈîôËØØ‰ø°ÊÅØ: ${error.message}`,
              );
            } else {
              const errorContent = `[Âá∫Èîô‰∫Ü: ${error.message}]`;
              const errorMessage = {
                role: "assistant",
                content: errorContent,
                timestamp: Date.now(),
              };
              if (chat.isGroup) errorMessage.senderName = "Á≥ªÁªüÊ∂àÊÅØ";
              chat.history.push(errorMessage);
            }

            await db.chats.put(chat);
            videoCallState.isAwaitingResponse = false;

            if (
              document
                .getElementById("chat-interface-screen")
                .classList.contains("active") &&
              state.activeChatId === chatId
            ) {
              renderChatInterface(chatId);
            }
          } finally {
            // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉ‰øÆÊîπ4ÔºöÂú® finally Âùó‰∏≠Áªü‰∏ÄÈöêËóèÊâÄÊúâÁ±ªÂûãÁöÑÊèêÁ§∫„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
            if (chat.isGroup) {
              if (typingIndicator) {
                typingIndicator.style.display = "none";
              }
            } else {
              if (chatHeaderTitle && state.chats[chatId]) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                  chatHeaderTitle.textContent = state.chats[chatId].name;
                  chatHeaderTitle.classList.remove("typing-status");
                  chatHeaderTitle.style.opacity = 1;
                }, 200);
              }
            }
            renderChatList();
          }
        }

        async function sendSticker(sticker) {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          const msg = {
            role: "user",
            content: sticker.url,
            meaning: sticker.name,
            timestamp: Date.now(),
          };
          chat.history.push(msg);
          await db.chats.put(chat);
          appendMessage(msg, chat);
          renderChatList();
          document.getElementById("sticker-panel").classList.remove("visible");
        }

        async function sendUserTransfer() {
          if (!state.activeChatId) return;
          const amountInput = document.getElementById("transfer-amount");
          const noteInput = document.getElementById("transfer-note");
          const amount = parseFloat(amountInput.value);
          const note = noteInput.value.trim();
          if (isNaN(amount) || amount < 0 || amount > 9999) {
            alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ù (0 Âà∞ 9999 ‰πãÈó¥)ÔºÅ");
            return;
          }
          const chat = state.chats[state.activeChatId];
          const senderName = chat.isGroup
            ? chat.settings.myNickname || "Êàë"
            : "Êàë";
          const receiverName = chat.isGroup ? "Áæ§ËÅä" : chat.name;
          const msg = {
            role: "user",
            type: "transfer",
            amount: amount,
            note: note,
            senderName,
            receiverName,
            timestamp: Date.now(),
          };
          chat.history.push(msg);
          await db.chats.put(chat);
          appendMessage(msg, chat);
          renderChatList();
          document.getElementById("transfer-modal").classList.remove("visible");
          amountInput.value = "";
          noteInput.value = "";
        }

        function enterSelectionMode(initialMsgTimestamp) {
          if (isSelectionMode) return;
          isSelectionMode = true;
          document
            .getElementById("chat-interface-screen")
            .classList.add("selection-mode");
          toggleMessageSelection(initialMsgTimestamp);
        }

        function exitSelectionMode() {
          cleanupWaimaiTimers(); // <--- Âú®ËøôÈáåÊ∑ªÂä†ËøôË°å‰ª£Á†Å
          if (!isSelectionMode) return;
          isSelectionMode = false;
          document
            .getElementById("chat-interface-screen")
            .classList.remove("selection-mode");
          selectedMessages.forEach((ts) => {
            const bubble = document.querySelector(
              `.message-bubble[data-timestamp="${ts}"]`,
            );
            if (bubble) bubble.classList.remove("selected");
          });
          selectedMessages.clear();
        }

        function toggleMessageSelection(timestamp) {
          // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÈÄâÊã©Âô®Â∑≤ÁÆÄÂåñÔºå‰∏çÂÜçÂØªÊâæÂ∑≤Âà†Èô§ÁöÑ .recalled-message-placeholder
          const elementToSelect = document.querySelector(
            `.message-bubble[data-timestamp="${timestamp}"]`,
          );

          if (!elementToSelect) return;

          if (selectedMessages.has(timestamp)) {
            selectedMessages.delete(timestamp);
            elementToSelect.classList.remove("selected");
          } else {
            selectedMessages.add(timestamp);
            elementToSelect.classList.add("selected");
          }

          document.getElementById("selection-count").textContent =
            `Â∑≤ÈÄâ ${selectedMessages.size} Êù°`;

          if (selectedMessages.size === 0) {
            exitSelectionMode();
          }
        }

        function addLongPressListener(element, callback) {
          let pressTimer;
          const startPress = (e) => {
            if (isSelectionMode) return;
            e.preventDefault();
            pressTimer = window.setTimeout(() => callback(e), 500);
          };
          const cancelPress = () => clearTimeout(pressTimer);
          element.addEventListener("mousedown", startPress);
          element.addEventListener("mouseup", cancelPress);
          element.addEventListener("mouseleave", cancelPress);
          element.addEventListener("touchstart", startPress, { passive: true });
          element.addEventListener("touchend", cancelPress);
          element.addEventListener("touchmove", cancelPress);
        }

        async function handleListenTogetherClick() {
          const targetChatId = state.activeChatId;
          if (!targetChatId) return;
          if (!musicState.isActive) {
            startListenTogetherSession(targetChatId);
            return;
          }
          if (musicState.activeChatId === targetChatId) {
            document
              .getElementById("music-player-overlay")
              .classList.add("visible");
          } else {
            const oldChatName =
              state.chats[musicState.activeChatId]?.name || "Êú™Áü•";
            const newChatName = state.chats[targetChatId]?.name || "ÂΩìÂâç";
            const confirmed = await showCustomConfirm(
              "ÂàáÊç¢Âê¨Ê≠åÂØπË±°",
              `ÊÇ®Ê≠£Âíå„Äå${oldChatName}„ÄçÂê¨Ê≠å„ÄÇË¶ÅÁªìÊùüÂπ∂ÂºÄÂßãÂíå„Äå${newChatName}„ÄçÁöÑÊñ∞‰ºöËØùÂêóÔºü`,
              { confirmButtonClass: "btn-danger" },
            );
            if (confirmed) {
              await endListenTogetherSession(true);
              await new Promise((resolve) => setTimeout(resolve, 50));
              startListenTogetherSession(targetChatId);
            }
          }
        }

        async function startListenTogetherSession(chatId) {
          const chat = state.chats[chatId];
          if (!chat) return;
          musicState.totalElapsedTime = chat.musicData.totalTime || 0;
          musicState.isActive = true;
          musicState.activeChatId = chatId;
          if (musicState.playlist.length > 0) {
            musicState.currentIndex = 0;
          } else {
            musicState.currentIndex = -1;
          }
          if (musicState.timerId) clearInterval(musicState.timerId);
          musicState.timerId = setInterval(() => {
            if (musicState.isPlaying) {
              musicState.totalElapsedTime++;
              updateElapsedTimeDisplay();
            }
          }, 1000);
          updatePlayerUI();
          updatePlaylistUI();
          document
            .getElementById("music-player-overlay")
            .classList.add("visible");
        }

        async function endListenTogetherSession(saveState = true) {
          if (!musicState.isActive) return;
          const oldChatId = musicState.activeChatId;
          const cleanupLogic = async () => {
            if (musicState.timerId) clearInterval(musicState.timerId);
            if (musicState.isPlaying) audioPlayer.pause();
            if (saveState && oldChatId && state.chats[oldChatId]) {
              const chat = state.chats[oldChatId];
              chat.musicData.totalTime = musicState.totalElapsedTime;
              await db.chats.put(chat);
            }
            musicState.isActive = false;
            musicState.activeChatId = null;
            musicState.totalElapsedTime = 0;
            musicState.timerId = null;
            updateListenTogetherIcon(oldChatId, true);
          };
          closeMusicPlayerWithAnimation(cleanupLogic);
        }

        function returnToChat() {
          closeMusicPlayerWithAnimation();
        }

        function updateListenTogetherIcon(chatId, forceReset = false) {
          const iconImg = document.querySelector("#listen-together-btn img");
          if (!iconImg) return;
          if (
            forceReset ||
            !musicState.isActive ||
            musicState.activeChatId !== chatId
          ) {
            iconImg.src = "https://i.postimg.cc/8kYShvrJ/90-UI-2.png";
            iconImg.className = "";
            return;
          }
          iconImg.src =
            "https://i.postimg.cc/D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png";
          iconImg.classList.add("rotating");
          if (musicState.isPlaying) iconImg.classList.remove("paused");
          else iconImg.classList.add("paused");
        }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;

        function updatePlayerUI() {
          updateListenTogetherIcon(musicState.activeChatId);
          updateElapsedTimeDisplay();
          const titleEl = document.getElementById("music-player-song-title");
          const artistEl = document.getElementById("music-player-artist");
          const playPauseBtn = document.getElementById("music-play-pause-btn");
          if (musicState.currentIndex > -1 && musicState.playlist.length > 0) {
            const track = musicState.playlist[musicState.currentIndex];
            titleEl.textContent = track.name;
            artistEl.textContent = track.artist;
          } else {
            titleEl.textContent = "ËØ∑Ê∑ªÂä†Ê≠åÊõ≤";
            artistEl.textContent = "...";
          }
          playPauseBtn.textContent = musicState.isPlaying ? "‚ùö‚ùö" : "‚ñ∂";
        }

        function updateElapsedTimeDisplay() {
          const hours = (musicState.totalElapsedTime / 3600).toFixed(1);
          document.getElementById("music-time-counter").textContent =
            `Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü${hours}Â∞èÊó∂`;
        }

        function updatePlaylistUI() {
          const playlistBody = document.getElementById("playlist-body");
          playlistBody.innerHTML = "";
          if (musicState.playlist.length === 0) {
            playlistBody.innerHTML =
              '<p style="text-align:center; padding: 20px; color: #888;">Êí≠ÊîæÂàóË°®ÊòØÁ©∫ÁöÑ~</p>';
            return;
          }
          musicState.playlist.forEach((track, index) => {
            const item = document.createElement("div");
            item.className = "playlist-item";
            if (index === musicState.currentIndex)
              item.classList.add("playing");
            item.innerHTML = `
                  <div class="playlist-item-info">
                      <div class="title">${track.name}</div>
                      <div class="artist">${track.artist}</div>
                  </div>
                  <div class="playlist-item-actions">
                      <span class="playlist-action-btn lyrics-btn" data-index="${index}">ËØç</span>
                      <span class="playlist-action-btn delete-track-btn" data-index="${index}">√ó</span>
                  </div>
              `;
            item
              .querySelector(".playlist-item-info")
              .addEventListener("click", () => playSong(index));
            playlistBody.appendChild(item);
          });
        }

        function playSong(index) {
          if (index < 0 || index >= musicState.playlist.length) return;
          musicState.currentIndex = index;
          const track = musicState.playlist[index];
          musicState.parsedLyrics = parseLRC(track.lrcContent || "");
          musicState.currentLyricIndex = -1;
          renderLyrics();
          if (track.isLocal && track.src instanceof Blob) {
            audioPlayer.src = URL.createObjectURL(track.src);
          } else if (!track.isLocal) {
            audioPlayer.src = track.src;
          } else {
            console.error("Êú¨Âú∞Ê≠åÊõ≤Ê∫êÈîôËØØ:", track);
            return;
          }
          audioPlayer.play();
          updatePlaylistUI();
          updatePlayerUI();
          updateMusicProgressBar();
        }

        function togglePlayPause() {
          if (audioPlayer.paused) {
            if (
              musicState.currentIndex === -1 &&
              musicState.playlist.length > 0
            ) {
              playSong(0);
            } else if (musicState.currentIndex > -1) {
              audioPlayer.play();
            }
          } else {
            audioPlayer.pause();
          }
        }

        function playNext() {
          if (musicState.playlist.length === 0) return;
          let nextIndex;
          switch (musicState.playMode) {
            case "random":
              nextIndex = Math.floor(
                Math.random() * musicState.playlist.length,
              );
              break;
            case "single":
              playSong(musicState.currentIndex);
              return;
            case "order":
            default:
              nextIndex =
                (musicState.currentIndex + 1) % musicState.playlist.length;
              break;
          }
          playSong(nextIndex);
        }

        function playPrev() {
          if (musicState.playlist.length === 0) return;
          const newIndex =
            (musicState.currentIndex - 1 + musicState.playlist.length) %
            musicState.playlist.length;
          playSong(newIndex);
        }

        function changePlayMode() {
          const modes = ["order", "random", "single"];
          const currentModeIndex = modes.indexOf(musicState.playMode);
          musicState.playMode = modes[(currentModeIndex + 1) % modes.length];
          document.getElementById("music-mode-btn").textContent = {
            order: "È°∫Â∫è",
            random: "ÈöèÊú∫",
            single: "ÂçïÊõ≤",
          }[musicState.playMode];
        }

        async function addSongFromURL() {
          const url = await showCustomPrompt(
            "Ê∑ªÂä†ÁΩëÁªúÊ≠åÊõ≤",
            "ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÁöÑURL",
            "",
            "url",
          );
          if (!url) return;
          const name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç");
          if (!name) return;
          const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç");
          if (!artist) return;
          musicState.playlist.push({ name, artist, src: url, isLocal: false });
          await saveGlobalPlaylist();
          updatePlaylistUI();
          if (musicState.currentIndex === -1) {
            musicState.currentIndex = musicState.playlist.length - 1;
            updatePlayerUI();
          }
        }

        async function addSongFromLocal(event) {
          const files = event.target.files;
          if (!files.length) return;

          for (const file of files) {
            let name = file.name.replace(/\.[^/.]+$/, "");
            name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç", name);
            if (name === null) continue;

            const artist = await showCustomPrompt(
              "Ê≠åÊõ≤‰ø°ÊÅØ",
              "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç",
              "Êú™Áü•Ê≠åÊâã",
            );
            if (artist === null) continue;

            let lrcContent = "";
            const wantLrc = await showCustomConfirm(
              "ÂØºÂÖ•Ê≠åËØç",
              `Ë¶Å‰∏∫„Ää${name}„ÄãÂØºÂÖ•Ê≠åËØçÊñá‰ª∂ (.lrc) ÂêóÔºü`,
            );
            if (wantLrc) {
              lrcContent = await new Promise((resolve) => {
                const lrcInput = document.getElementById("lrc-upload-input");
                const lrcChangeHandler = (e) => {
                  const lrcFile = e.target.files[0];
                  if (lrcFile) {
                    const reader = new FileReader();
                    reader.onload = (readEvent) =>
                      resolve(readEvent.target.result);
                    reader.onerror = () => resolve("");
                    reader.readAsText(lrcFile);
                  } else {
                    resolve("");
                  }
                  lrcInput.removeEventListener("change", lrcChangeHandler);
                  lrcInput.value = "";
                };
                lrcInput.addEventListener("change", lrcChangeHandler);
                lrcInput.click();
              });
            }

            musicState.playlist.push({
              name,
              artist,
              src: file,
              isLocal: true,
              lrcContent: lrcContent,
            });
          }

          await saveGlobalPlaylist();
          updatePlaylistUI();
          if (
            musicState.currentIndex === -1 &&
            musicState.playlist.length > 0
          ) {
            musicState.currentIndex = 0;
            updatePlayerUI();
          }
          event.target.value = null;
        }

        async function deleteTrack(index) {
          if (index < 0 || index >= musicState.playlist.length) return;
          const track = musicState.playlist[index];
          const wasPlaying =
            musicState.isPlaying && musicState.currentIndex === index;
          if (
            track.isLocal &&
            audioPlayer.src.startsWith("blob:") &&
            musicState.currentIndex === index
          )
            URL.revokeObjectURL(audioPlayer.src);
          musicState.playlist.splice(index, 1);
          await saveGlobalPlaylist();
          if (musicState.playlist.length === 0) {
            if (musicState.isPlaying) audioPlayer.pause();
            audioPlayer.src = "";
            musicState.currentIndex = -1;
            musicState.isPlaying = false;
          } else {
            if (wasPlaying) {
              playNext();
            } else {
              if (musicState.currentIndex >= index)
                musicState.currentIndex = Math.max(
                  0,
                  musicState.currentIndex - 1,
                );
            }
          }
          updatePlayerUI();
          updatePlaylistUI();
        }

        const personaLibraryModal = document.getElementById(
          "persona-library-modal",
        );
        const personaEditorModal = document.getElementById(
          "persona-editor-modal",
        );
        const presetActionsModal = document.getElementById(
          "preset-actions-modal",
        );

        function openPersonaLibrary() {
          renderPersonaLibrary();
          personaLibraryModal.classList.add("visible");
        }

        function closePersonaLibrary() {
          personaLibraryModal.classList.remove("visible");
        }

        function renderPersonaLibrary() {
          const grid = document.getElementById("persona-library-grid");
          grid.innerHTML = "";
          if (state.personaPresets.length === 0) {
            grid.innerHTML =
              '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">Á©∫Á©∫Â¶Ç‰πü~ ÁÇπÂáªÂè≥‰∏äËßí"Ê∑ªÂä†"Êù•ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêßÔºÅ</p>';
            return;
          }
          state.personaPresets.forEach((preset) => {
            const item = document.createElement("div");
            item.className = "persona-preset-item";
            item.style.backgroundImage = `url(${preset.avatar})`;
            item.dataset.presetId = preset.id;
            item.addEventListener("click", () => applyPersonaPreset(preset.id));
            addLongPressListener(item, () => showPresetActions(preset.id));
            grid.appendChild(item);
          });
        }

        function showPresetActions(presetId) {
          editingPersonaPresetId = presetId;
          presetActionsModal.classList.add("visible");
        }

        function hidePresetActions() {
          presetActionsModal.classList.remove("visible");
          editingPersonaPresetId = null;
        }

        function applyPersonaPreset(presetId) {
          const preset = state.personaPresets.find((p) => p.id === presetId);
          if (preset) {
            document.getElementById("my-avatar-preview").src = preset.avatar;
            document.getElementById("my-persona").value = preset.persona;
          }
          closePersonaLibrary();
        }

        function openPersonaEditorForCreate() {
          editingPersonaPresetId = null;
          document.getElementById("persona-editor-title").textContent =
            "Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ";
          document.getElementById("preset-avatar-preview").src = defaultAvatar;
          document.getElementById("preset-persona-input").value = "";
          personaEditorModal.classList.add("visible");
        }

        function openPersonaEditorForEdit() {
          const preset = state.personaPresets.find(
            (p) => p.id === editingPersonaPresetId,
          );
          if (!preset) return;
          document.getElementById("persona-editor-title").textContent =
            "ÁºñËæë‰∫∫ËÆæÈ¢ÑËÆæ";
          document.getElementById("preset-avatar-preview").src = preset.avatar;
          document.getElementById("preset-persona-input").value =
            preset.persona;
          presetActionsModal.classList.remove("visible");
          personaEditorModal.classList.add("visible");
        }

        async function deletePersonaPreset() {
          const confirmed = await showCustomConfirm(
            "Âà†Èô§È¢ÑËÆæ",
            "Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ",
            { confirmButtonClass: "btn-danger" },
          );
          if (confirmed && editingPersonaPresetId) {
            await db.personaPresets.delete(editingPersonaPresetId);
            state.personaPresets = state.personaPresets.filter(
              (p) => p.id !== editingPersonaPresetId,
            );
            hidePresetActions();
            renderPersonaLibrary();
          }
        }

        function closePersonaEditor() {
          personaEditorModal.classList.remove("visible");
          editingPersonaPresetId = null;
        }

        async function savePersonaPreset() {
          const avatar = document.getElementById("preset-avatar-preview").src;
          const persona = document
            .getElementById("preset-persona-input")
            .value.trim();
          if (avatar === defaultAvatar && !persona) {
            alert("Â§¥ÂÉèÂíå‰∫∫ËÆæ‰∏çËÉΩÈÉΩ‰∏∫Á©∫Âì¶ÔºÅ");
            return;
          }
          if (editingPersonaPresetId) {
            const preset = state.personaPresets.find(
              (p) => p.id === editingPersonaPresetId,
            );
            if (preset) {
              preset.avatar = avatar;
              preset.persona = persona;
              await db.personaPresets.put(preset);
            }
          } else {
            const newPreset = {
              id: "preset_" + Date.now(),
              avatar: avatar,
              persona: persona,
            };
            await db.personaPresets.add(newPreset);
            state.personaPresets.push(newPreset);
          }
          renderPersonaLibrary();
          closePersonaEditor();
        }

        const batteryAlertModal = document.getElementById(
          "battery-alert-modal",
        );

        function showBatteryAlert(imageUrl, text) {
          clearTimeout(batteryAlertTimeout);
          document.getElementById("battery-alert-image").src = imageUrl;
          document.getElementById("battery-alert-text").textContent = text;
          batteryAlertModal.classList.add("visible");
          const closeAlert = () => {
            batteryAlertModal.classList.remove("visible");
            batteryAlertModal.removeEventListener("click", closeAlert);
          };
          batteryAlertModal.addEventListener("click", closeAlert);
          batteryAlertTimeout = setTimeout(closeAlert, 2000);
        }

        function updateBatteryDisplay(battery) {
          const batteryContainer =
            document.getElementById("status-bar-battery");
          const batteryLevelEl =
            batteryContainer.querySelector(".battery-level");
          const batteryTextEl = batteryContainer.querySelector(".battery-text");
          const level = Math.floor(battery.level * 100);
          batteryLevelEl.style.width = `${level}%`;
          batteryTextEl.textContent = `${level}%`;
          if (battery.charging) {
            batteryContainer.classList.add("charging");
          } else {
            batteryContainer.classList.remove("charging");
          }
        }

        function handleBatteryChange(battery) {
          updateBatteryDisplay(battery);
          const level = battery.level;
          if (!battery.charging) {
            if (
              level <= 0.4 &&
              lastKnownBatteryLevel > 0.4 &&
              !alertFlags.hasShown40
            ) {
              showBatteryAlert(
                "https://i.postimg.cc/T2yKJ0DV/40.jpg",
                "ÊúâÁÇπÈ•ø‰∫ÜÔºåÂèØ‰ª•ÂéªÊâæÂÖÖÁîµÂô®ÊÉπ",
              );
              alertFlags.hasShown40 = true;
            }
            if (
              level <= 0.2 &&
              lastKnownBatteryLevel > 0.2 &&
              !alertFlags.hasShown20
            ) {
              showBatteryAlert(
                "https://i.postimg.cc/qB9zbKs9/20.jpg",
                "Ëµ∂Á¥ßÁöÑÂÖÖÁîµÔºåË¶ÅÈ•øÊ≠ª‰∫Ü",
              );
              alertFlags.hasShown20 = true;
            }
            if (
              level <= 0.1 &&
              lastKnownBatteryLevel > 0.1 &&
              !alertFlags.hasShown10
            ) {
              showBatteryAlert(
                "https://i.postimg.cc/ThMMVfW4/10.jpg",
                "Â∑≤Èòµ‰∫°ÔºåËøòÊúâ30ÁßíÁàÜÁÇ∏",
              );
              alertFlags.hasShown10 = true;
            }
          }
          if (level > 0.4) alertFlags.hasShown40 = false;
          if (level > 0.2) alertFlags.hasShown20 = false;
          if (level > 0.1) alertFlags.hasShown10 = false;
          lastKnownBatteryLevel = level;
        }

        async function initBatteryManager() {
          if ("getBattery" in navigator) {
            try {
              const battery = await navigator.getBattery();
              lastKnownBatteryLevel = battery.level;
              handleBatteryChange(battery);
              battery.addEventListener("levelchange", () =>
                handleBatteryChange(battery),
              );
              battery.addEventListener("chargingchange", () => {
                handleBatteryChange(battery);
                if (battery.charging) {
                  showBatteryAlert(
                    "https://i.postimg.cc/3NDQ0dWG/image.jpg",
                    "Á™ùÁà±Ê≥•ÔºåÁîµÈáèÂêÉÈ•±È•±",
                  );
                }
              });
            } catch (err) {
              console.error("Êó†Ê≥ïËé∑ÂèñÁîµÊ±†‰ø°ÊÅØ:", err);
              document.querySelector(".battery-text").textContent = "·óúœâ·óú";
            }
          } else {
            console.log("ÊµèËßàÂô®‰∏çÊîØÊåÅÁîµÊ±†Áä∂ÊÄÅAPI„ÄÇ");
            document.querySelector(".battery-text").textContent = "·óúœâ·óú";
          }
        }

        async function renderAlbumList() {
          const albumGrid = document.getElementById("album-grid-page");
          if (!albumGrid) return;
          const albums = await db.qzoneAlbums
            .orderBy("createdAt")
            .reverse()
            .toArray();
          albumGrid.innerHTML = "";
          if (albums.length === 0) {
            albumGrid.innerHTML =
              '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">‰Ω†ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰ΩïÁõ∏ÂÜåÂì¶~</p>';
            return;
          }
          albums.forEach((album) => {
            const albumItem = document.createElement("div");
            albumItem.className = "album-item";
            albumItem.innerHTML = `
                          <div class="album-cover" style="background-image: url(${
                            album.coverUrl
                          });"></div>
                          <div class="album-info">
                              <p class="album-name">${album.name}</p>
                              <p class="album-count">${
                                album.photoCount || 0
                              } Âº†</p>
                          </div>
                      `;
            albumItem.addEventListener("click", () => {
              openAlbum(album.id);
            });

            addLongPressListener(albumItem, async () => {
              const confirmed = await showCustomConfirm(
                "Âà†Èô§Áõ∏ÂÜå",
                `Á°ÆÂÆöË¶ÅÂà†Èô§Áõ∏ÂÜå„Ää${album.name}„ÄãÂêóÔºüÊ≠§Êìç‰ΩúÂ∞ÜÂêåÊó∂Âà†Èô§Áõ∏ÂÜåÂÜÖÁöÑÊâÄÊúâÁÖßÁâáÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ`,
                { confirmButtonClass: "btn-danger" },
              );

              if (confirmed) {
                // 1. ‰ªéÁÖßÁâáË°®‰∏≠Âà†Èô§ËØ•Áõ∏ÂÜå‰∏ãÁöÑÊâÄÊúâÁÖßÁâá
                await db.qzonePhotos.where("albumId").equals(album.id).delete();

                // 2. ‰ªéÁõ∏ÂÜåË°®‰∏≠Âà†Èô§ËØ•Áõ∏ÂÜåÊú¨Ë∫´
                await db.qzoneAlbums.delete(album.id);

                // 3. ÈáçÊñ∞Ê∏≤ÊüìÁõ∏ÂÜåÂàóË°®
                await renderAlbumList();

                alert("Áõ∏ÂÜåÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ");
              }
            });

            albumGrid.appendChild(albumItem);
          });
        }

        async function openAlbum(albumId) {
          state.activeAlbumId = albumId;
          await renderAlbumPhotosScreen();
          showScreen("album-photos-screen");
        }

        async function renderAlbumPhotosScreen() {
          if (!state.activeAlbumId) return;
          const photosGrid = document.getElementById("photos-grid-page");
          const headerTitle = document.getElementById("album-photos-title");
          const album = await db.qzoneAlbums.get(state.activeAlbumId);
          if (!album) {
            console.error("Êâæ‰∏çÂà∞Áõ∏ÂÜå:", state.activeAlbumId);
            showScreen("album-screen");
            return;
          }
          headerTitle.textContent = album.name;
          const photos = await db.qzonePhotos
            .where("albumId")
            .equals(state.activeAlbumId)
            .toArray();
          photosGrid.innerHTML = "";
          if (photos.length === 0) {
            photosGrid.innerHTML =
              '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">Ëøô‰∏™Áõ∏ÂÜåËøòÊòØÁ©∫ÁöÑÔºåÂø´‰∏ä‰º†Á¨¨‰∏ÄÂº†ÁÖßÁâáÂêßÔºÅ</p>';
          } else {
            photos.forEach((photo) => {
              const photoItem = document.createElement("div");
              photoItem.className = "photo-item";
              photoItem.innerHTML = `
                              <img src="${photo.url}" class="photo-thumb" alt="Áõ∏ÂÜåÁÖßÁâá">
                              <button class="photo-delete-btn" data-photo-id="${photo.id}">√ó</button>
                          `;
              photosGrid.appendChild(photoItem);
            });
          }
        }

        // --- ‚Üì‚Üì‚Üì ‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ ‚Üì‚Üì‚Üì ---

        /**
         * ÊâìÂºÄÂõæÁâáÊü•ÁúãÂô®
         * @param {string} clickedPhotoUrl - Áî®Êà∑ÁÇπÂáªÁöÑÈÇ£Âº†ÁÖßÁâáÁöÑURL
         */
        async function openPhotoViewer(clickedPhotoUrl) {
          if (!state.activeAlbumId) return;

          // 1. ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÂΩìÂâçÁõ∏ÂÜåÁöÑÊâÄÊúâÁÖßÁâá
          const photosInAlbum = await db.qzonePhotos
            .where("albumId")
            .equals(state.activeAlbumId)
            .toArray();
          photoViewerState.photos = photosInAlbum.map((p) => p.url);

          // 2. ÊâæÂà∞Ë¢´ÁÇπÂáªÁÖßÁâáÁöÑÁ¥¢Âºï
          photoViewerState.currentIndex = photoViewerState.photos.findIndex(
            (url) => url === clickedPhotoUrl,
          );
          if (photoViewerState.currentIndex === -1) return; // Â¶ÇÊûúÊâæ‰∏çÂà∞ÔºåÂàô‰∏çÊâìÂºÄ

          // 3. ÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÂπ∂Ê∏≤ÊüìÁ¨¨‰∏ÄÂº†Âõæ
          document
            .getElementById("photo-viewer-modal")
            .classList.add("visible");
          renderPhotoViewer();
          photoViewerState.isOpen = true;
        }

        /**
         * Ê†πÊçÆÂΩìÂâçÁä∂ÊÄÅÊ∏≤ÊüìÊü•ÁúãÂô®ÂÜÖÂÆπÔºàÂõæÁâáÂíåÊåâÈíÆÔºâ
         */
        function renderPhotoViewer() {
          if (photoViewerState.currentIndex === -1) return;

          const imageEl = document.getElementById("photo-viewer-image");
          const prevBtn = document.getElementById("photo-viewer-prev-btn");
          const nextBtn = document.getElementById("photo-viewer-next-btn");

          // Ê∑°Âá∫ÊïàÊûú
          imageEl.style.opacity = 0;

          setTimeout(() => {
            // Êõ¥Êñ∞ÂõæÁâáÊ∫ê
            imageEl.src =
              photoViewerState.photos[photoViewerState.currentIndex];
            // Ê∑°ÂÖ•ÊïàÊûú
            imageEl.style.opacity = 1;
          }, 100); // Âª∂Ëøü‰∏ÄÁÇπÁÇπÊó∂Èó¥Êù•Ëß¶ÂèëCSSËøáÊ∏°

          // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅÔºöÂ¶ÇÊûúÊòØÁ¨¨‰∏ÄÂº†ÔºåÁ¶ÅÁî®‚Äú‰∏ä‰∏ÄÂº†‚ÄùÊåâÈíÆ
          prevBtn.disabled = photoViewerState.currentIndex === 0;
          // Â¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÂº†ÔºåÁ¶ÅÁî®‚Äú‰∏ã‰∏ÄÂº†‚ÄùÊåâÈíÆ
          nextBtn.disabled =
            photoViewerState.currentIndex ===
            photoViewerState.photos.length - 1;
        }

        /**
         * ÊòæÁ§∫‰∏ã‰∏ÄÂº†ÁÖßÁâá
         */
        function showNextPhoto() {
          if (
            photoViewerState.currentIndex <
            photoViewerState.photos.length - 1
          ) {
            photoViewerState.currentIndex++;
            renderPhotoViewer();
          }
        }

        /**
         * ÊòæÁ§∫‰∏ä‰∏ÄÂº†ÁÖßÁâá
         */
        function showPrevPhoto() {
          if (photoViewerState.currentIndex > 0) {
            photoViewerState.currentIndex--;
            renderPhotoViewer();
          }
        }

        /**
         * ÂÖ≥Èó≠ÂõæÁâáÊü•ÁúãÂô®
         */
        function closePhotoViewer() {
          document
            .getElementById("photo-viewer-modal")
            .classList.remove("visible");
          photoViewerState.isOpen = false;
          photoViewerState.photos = [];
          photoViewerState.currentIndex = -1;
          // Ê∏ÖÁ©∫ÂõæÁâáÔºåÈÅøÂÖç‰∏ãÊ¨°ÊâìÂºÄÊó∂Èó™Áé∞ÊóßÂõæ
          document.getElementById("photo-viewer-image").src = "";
        }

        // --- ‚Üë‚Üë‚Üë Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ‚Üë‚Üë‚Üë ---

        /**
         * Êõ¥Êñ∞Âä®ÊÄÅÂ∞èÁ∫¢ÁÇπÁöÑÊòæÁ§∫
         * @param {number} count - Êú™ËØªÂä®ÊÄÅÁöÑÊï∞Èáè
         */
        function updateUnreadIndicator(count) {
          unreadPostsCount = count;
          localStorage.setItem("unreadPostsCount", count); // ÊåÅ‰πÖÂåñÂ≠òÂÇ®

          // --- Êõ¥Êñ∞Â∫ïÈÉ®ÂØºËà™Ê†èÁöÑ‚ÄúÂä®ÊÄÅ‚ÄùÊåâÈíÆ ---
          const navItem = document.querySelector(
            '.nav-item[data-view="qzone-screen"]',
          );

          const targetSpan = navItem.querySelector("span"); // ÂÆö‰ΩçÂà∞ÊñáÂ≠ó "Âä®ÊÄÅ"
          let indicator = navItem.querySelector(".unread-indicator");

          if (count > 0) {
            if (!indicator) {
              indicator = document.createElement("span");
              indicator.className = "unread-indicator";
              targetSpan.style.position = "relative"; // ÊääÁõ∏ÂØπÂÆö‰ΩçÂä†Âú® span ‰∏ä
              targetSpan.appendChild(indicator); // ÊääÂ∞èÁ∫¢ÁÇπ‰Ωú‰∏∫ span ÁöÑÂ≠êÂÖÉÁ¥†
            }
            indicator.textContent = count > 99 ? "99+" : count;
            indicator.style.display = "block";
          } else {
            if (indicator) {
              indicator.style.display = "none";
            }
          }

          // --- Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢ËøîÂõûÂàóË°®ÁöÑÊåâÈíÆ ---
          const backBtn = document.getElementById("back-to-list-btn");
          let backBtnIndicator = backBtn.querySelector(".unread-indicator");

          if (count > 0) {
            if (!backBtnIndicator) {
              backBtnIndicator = document.createElement("span");
              backBtnIndicator.className =
                "unread-indicator back-btn-indicator";
              backBtn.style.position = "relative"; // Á°Æ‰øùËÉΩÊ≠£Á°ÆÂÆö‰Ωç
              backBtn.appendChild(backBtnIndicator);
            }
            // ËøîÂõûÈîÆ‰∏äÁöÑÂ∞èÁ∫¢ÁÇπÈÄöÂ∏∏‰∏çÊòæÁ§∫Êï∞Â≠óÔºåÂè™ÊòæÁ§∫‰∏Ä‰∏™ÁÇπ
            backBtnIndicator.style.display = "block";
          } else {
            if (backBtnIndicator) {
              backBtnIndicator.style.display = "none";
            }
          }
        }

        function startBackgroundSimulation() {
          if (simulationIntervalId) return;
          const intervalSeconds =
            state.globalSettings.backgroundActivityInterval || 60;
          // Â∞ÜÊóßÁöÑÂõ∫ÂÆöÈó¥Èöî 45000 ÊõøÊç¢‰∏∫Âä®ÊÄÅËé∑Âèñ
          simulationIntervalId = setInterval(
            runBackgroundSimulationTick,
            intervalSeconds * 1000,
          );
        }

        function stopBackgroundSimulation() {
          if (simulationIntervalId) {
            clearInterval(simulationIntervalId);
            simulationIntervalId = null;
          }
        }

        /**
         * ËøôÊòØÊ®°ÊãüÂô®ÁöÑ‚ÄúÂøÉË∑≥‚ÄùÔºåÊØèÊ¨°ÂÆöÊó∂Âô®Ëß¶ÂèëÊó∂ËøêË°å
         */
        function runBackgroundSimulationTick() {
          console.log("Ê®°ÊãüÂô®ÂøÉË∑≥ Tick...");
          if (!state.globalSettings.enableBackgroundActivity) {
            stopBackgroundSimulation();
            return;
          }
          const allSingleChats = Object.values(state.chats).filter(
            (chat) => !chat.isGroup,
          );

          if (allSingleChats.length === 0) return;

          allSingleChats.forEach((chat) => {
            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ∞Ü‰∏§ÁßçÁä∂ÊÄÅÊ£ÄÊü•ÂàÜÁ¶ªÂºÄÔºåÈÄªËæëÊõ¥Ê∏ÖÊô∞

            // Ê£ÄÊü•1ÔºöÂ§ÑÁêÜ„ÄêË¢´Áî®Êà∑ÊãâÈªë„ÄëÁöÑËßíËâ≤
            if (chat.relationship?.status === "blocked_by_user") {
              const blockedTimestamp = chat.relationship.blockedTimestamp;
              // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùÊúâÊãâÈªëÊó∂Èó¥Êà≥
              if (!blockedTimestamp) {
                console.warn(
                  `ËßíËâ≤ "${chat.name}" Áä∂ÊÄÅ‰∏∫ÊãâÈªëÔºå‰ΩÜÁº∫Â∞ëÊãâÈªëÊó∂Èó¥Êà≥ÔºåË∑≥ËøáÂ§ÑÁêÜ„ÄÇ`,
                );
                return; // Ë∑≥ËøáËøô‰∏™ËßíËâ≤ÔºåÁªßÁª≠‰∏ã‰∏Ä‰∏™
              }

              const blockedDuration = Date.now() - blockedTimestamp;
              const cooldownMilliseconds =
                (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;

              console.log(
                `Ê£ÄÊü•ËßíËâ≤ "${chat.name}"ÔºöÂ∑≤ÊãâÈªë ${Math.round(
                  blockedDuration / 1000 / 60,
                )}ÂàÜÈíüÔºåÂÜ∑ÈùôÊúüÈúÄ ${cooldownMilliseconds / 1000 / 60}ÂàÜÈíü„ÄÇ`,
              ); // Ê∑ªÂä†Êó•Âøó

              // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÁßªÈô§‰∫ÜÈöèÊú∫Ê¶ÇÁéáÔºåÂè™Ë¶ÅÂÜ∑ÈùôÊúü‰∏ÄËøáÔºåÂ∞±Ëß¶ÂèëÔºÅ
              if (blockedDuration > cooldownMilliseconds) {
                console.log(
                  `ËßíËâ≤ "${chat.name}" ÁöÑÂÜ∑ÈùôÊúüÂ∑≤ËøáÔºåËß¶Âèë‚ÄúÂèçÊÄù‚ÄùÂπ∂Áî≥ËØ∑Â•ΩÂèã‰∫ã‰ª∂...`,
                );

                // „ÄêÈáçË¶Å„Äë‰∏∫‰∫ÜÈò≤Ê≠¢Âú®AIÂìçÂ∫îÂâçÈáçÂ§çËß¶ÂèëÔºåÊàë‰ª¨Âú®Ëß¶ÂèëÂêéÁ´ãÂàªÊõ¥Êñ∞Áä∂ÊÄÅ
                chat.relationship.status = "pending_system_reflection"; // ËÆæÁΩÆ‰∏Ä‰∏™‰∏¥Êó∂ÁöÑ„ÄÅÈò≤Ê≠¢ÈáçÂ§çËß¶ÂèëÁöÑÁä∂ÊÄÅ

                triggerAiFriendApplication(chat.id);
              }
            }
            // Ê£ÄÊü•2ÔºöÂ§ÑÁêÜ„ÄêÂ•ΩÂèãÂÖ≥Á≥ª„ÄëÁöÑÊ≠£Â∏∏ÂêéÂè∞Ê¥ªÂä®
            else if (
              chat.relationship?.status === "friend" &&
              chat.id !== state.activeChatId
            ) {
              // ËøôÈáåÁöÑÈöèÊú∫Ëß¶ÂèëÈÄªËæë‰øùÊåÅ‰∏çÂèòÔºåÂõ†‰∏∫Êàë‰ª¨‰∏çÂ∏åÊúõÊâÄÊúâÂ•ΩÂèãÂêåÊó∂Ë°åÂä®
              if (Math.random() < 0.2) {
                console.log(`ËßíËâ≤ "${chat.name}" Ë¢´Âî§ÈÜíÔºåÂáÜÂ§áÁã¨Á´ãË°åÂä®...`);
                triggerInactiveAiAction(chat.id);
              }
            }
          });
        }

        async function triggerInactiveAiAction(chatId) {
          const chat = state.chats[chatId];
          if (!chat) return;

          const { proxyUrl, apiKey, model } = getActiveApiConfig() || {};
          if (!proxyUrl || !apiKey || !model) return;

          // Âº∫Âà∂ËΩ¨Êç¢‰∏∫Âåó‰∫¨Êó∂Èó¥
          const localNow = new Date();
          const utcMilliseconds =
            localNow.getTime() + localNow.getTimezoneOffset() * 60000;
          const beijingMilliseconds = utcMilliseconds + 3600000 * 8;
          const now = new Date(beijingMilliseconds);
          const currentTime = now.toLocaleTimeString("zh-CN", {
            hour: "numeric",
            minute: "numeric",
            hour12: true,
          });
          const userNickname = state.qzoneSettings.nickname;

          const lastUserMessage = chat.history
            .filter((m) => m.role === "user" && !m.isHidden)
            .slice(-1)[0];
          const lastAiMessage = chat.history
            .filter((m) => m.role === "assistant" && !m.isHidden)
            .slice(-1)[0];
          let recentContextSummary = "‰Ω†‰ª¨ÊúÄËøëÊ≤°ÊúâËÅäËøáÂ§©„ÄÇ";
          if (lastUserMessage) {
            recentContextSummary = `Áî®Êà∑ (${userNickname}) ÊúÄÂêéÂØπ‰Ω†ËØ¥Ôºö‚Äú${String(
              lastUserMessage.content,
            ).substring(0, 50)}...‚Äù„ÄÇ`;
          }
          if (lastAiMessage) {
            recentContextSummary += `\n‰Ω†ÊúÄÂêéÂØπÁî®Êà∑ËØ¥Ôºö‚Äú${String(
              lastAiMessage.content,
            ).substring(0, 50)}...‚Äù„ÄÇ`;
          }

          let worldBookContent = "";
          if (
            chat.settings.linkedWorldBookIds &&
            chat.settings.linkedWorldBookIds.length > 0
          ) {
            const linkedContents = chat.settings.linkedWorldBookIds
              .map((bookId) => {
                const worldBook = state.worldBooks.find(
                  (wb) => wb.id === bookId,
                );
                return worldBook && worldBook.content
                  ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}`
                  : "";
              })
              .filter(Boolean)
              .join("");
            if (linkedContents) {
              worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n${linkedContents}\n`;
            }
          }

          const systemPrompt = `
      # ‰Ω†ÁöÑ‰ªªÂä°
      ‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${chat.name}"ÁöÑËßíËâ≤„ÄÇ‰Ω†Â∑≤ÁªèÊúâ‰∏ÄÊÆµÊó∂Èó¥Ê≤°ÊúâÂíåÁî®Êà∑Ôºà${userNickname}Ôºâ‰∫íÂä®‰∫ÜÔºåÁé∞Âú®‰Ω†ÊúâÊú∫‰ºö„Äê‰∏ªÂä®„ÄëÂÅöÁÇπ‰ªÄ‰πàÔºåÊù•Ë°®Áé∞‰Ω†ÁöÑ‰∏™ÊÄßÂíåÁã¨Á´ãÁîüÊ¥ª„ÄÇËøôÊòØ‰∏Ä‰∏™ÁßòÂØÜÁöÑ„ÄÅÂêéÂè∞ÁöÑÁã¨Á´ãË°åÂä®„ÄÇ

      # ‰Ω†ÁöÑÂèØÈÄâË°åÂä® (ËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæ„ÄêÈÄâÊã©‰∏ÄÈ°π„ÄëÊâßË°å):
      1.  **ÊîπÂèòÁä∂ÊÄÅ**: ÂéªÂÅöÁÇπÂà´ÁöÑ‰∫ãÊÉÖÔºåÁÑ∂ÂêéÁªôÁî®Êà∑ÂèëÊù°Ê∂àÊÅØ„ÄÇ
      2.  **ÂèëÂ∏ÉÂä®ÊÄÅ**: ÂàÜ‰∫´‰Ω†ÁöÑÂøÉÊÉÖÊàñÊÉ≥Ê≥ïÂà∞‚ÄúÂä®ÊÄÅ‚ÄùÂå∫„ÄÇ
      3.  **‰∏éÂä®ÊÄÅ‰∫íÂä®**: ÂéªÁúãÁúãÂà´‰∫∫ÁöÑÂ∏ñÂ≠êÂπ∂ËøõË°åËØÑËÆ∫ÊàñÁÇπËµû„ÄÇ
      4.  **ÂèëËµ∑ËßÜÈ¢ëÈÄöËØù**: Â¶ÇÊûú‰Ω†ËßâÂæóÊó∂Êú∫ÂêàÈÄÇÔºåÂèØ‰ª•‰∏ªÂä®ÁªôÁî®Êà∑Êâì‰∏Ä‰∏™ËßÜÈ¢ëÁîµËØù„ÄÇ

      # Êåá‰ª§Ê†ºÂºè (‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØÂåÖÂê´‰∏Ä‰∏™ÂØπË±°ÁöÑJSONÊï∞ÁªÑ):
      -   **ÂèëÊ∂àÊÅØ+Êõ¥Êñ∞Áä∂ÊÄÅ**: \`[{"type": "update_status", "status_text": "Ê≠£Âú®ÂÅöÁöÑ‰∫ã", "is_busy": true}, {"type": "text", "content": "‰Ω†ÊÉ≥ÂØπÁî®Êà∑ËØ¥ÁöÑËØù..."}]\`
      -   **ÂèëËØ¥ËØ¥**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "Âä®ÊÄÅÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}]\`
      - **ÂèëÂ∏ÉÊñáÂ≠óÂõæ**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(ÂèØÈÄâ)Âä®ÊÄÅÁöÑÂÖ¨ÂºÄÊñáÂ≠ó", "hiddenContent": "ÂØπ‰∫éÂõæÁâáÁöÑÂÖ∑‰ΩìÊèèËø∞..."}\`
      -   **ËØÑËÆ∫**: \`[{"type": "qzone_comment", "postId": 123, "commentText": "‰Ω†ÁöÑËØÑËÆ∫ÂÜÖÂÆπ"}]\`
      -   **ÁÇπËµû**: \`[{"type": "qzone_like", "postId": 456}]\`
      -   **ÊâìËßÜÈ¢ë**: \`[{"type": "video_call_request"}]\`

      # ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑÂèÇËÄÉ‰ø°ÊÅØÔºö
      -   **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
      ${worldBookContent} // <--„ÄêÊ†∏ÂøÉ„ÄëÂú®ËøôÈáåÊ≥®ÂÖ•‰∏ñÁïå‰π¶ÂÜÖÂÆπ
      -   **ÂΩìÂâçÊó∂Èó¥**: ${currentTime}
      -   **‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØùÊëòË¶Å**: ${recentContextSummary}
      -   **„ÄêÈáçË¶Å„ÄëÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°®**: Ëøô‰∏™ÂàóË°®‰ºöÊ†áÊ≥® **[‰Ω†Â∑≤ÁÇπËµû]** Êàñ **[‰Ω†Â∑≤ËØÑËÆ∫]**„ÄÇËØ∑**‰ºòÂÖà**‰∏é‰Ω†**Â∞öÊú™‰∫íÂä®Ëøá**ÁöÑÂä®ÊÄÅËøõË°å‰∫§ÊµÅ„ÄÇ`;

          // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂú®ËøôÈáåÊûÑÂª∫ messagesPayload
          const messagesPayload = [];
          messagesPayload.push({ role: "system", content: systemPrompt });

          try {
            const allRecentPosts = await db.qzonePosts
              .orderBy("timestamp")
              .reverse()
              .limit(3)
              .toArray();
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåÊèíÂÖ•ËøáÊª§Ê≠•È™§
            const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);

            const aiName = chat.name;

            let dynamicContext = "";
            if (visiblePosts.length > 0) {
              let postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
              for (const post of visiblePosts) {
                let authorName =
                  post.authorId === "user"
                    ? userNickname
                    : state.chats[post.authorId]?.name || "‰∏Ä‰ΩçÊúãÂèã";
                let interactionStatus = "";
                if (post.likes && post.likes.includes(aiName))
                  interactionStatus += " [‰Ω†Â∑≤ÁÇπËµû]";
                if (
                  post.comments &&
                  post.comments.some((c) => c.commenterName === aiName)
                )
                  interactionStatus += " [‰Ω†Â∑≤ËØÑËÆ∫]";

                postsContext += `- (ID: ${
                  post.id
                }) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${(
                  post.publicText ||
                  post.content ||
                  "ÂõæÁâáÂä®ÊÄÅ"
                ).substring(0, 30)}..."${interactionStatus}\n`;
              }
              dynamicContext = postsContext;
            }

            // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂ∞ÜÊâÄÊúâÂä®ÊÄÅ‰ø°ÊÅØ‰Ωú‰∏∫‰∏ÄÊù° user Ê∂àÊÅØÂèëÈÄÅ
            messagesPayload.push({
              role: "user",
              content: `[Á≥ªÁªüÊåá‰ª§ÔºöËØ∑Ê†πÊçÆ‰Ω†Âú® system prompt ‰∏≠ËØªÂà∞ÁöÑËßÑÂàôÂíå‰ª•‰∏ãÊúÄÊñ∞‰ø°ÊÅØÔºåÂºÄÂßã‰Ω†ÁöÑÁã¨Á´ãË°åÂä®„ÄÇ]\n${dynamicContext}`,
            });

            console.log(
              "Ê≠£Âú®‰∏∫ÂêéÂè∞Ê¥ªÂä®ÂèëÈÄÅAPIËØ∑Ê±ÇÔºåPayload:",
              JSON.stringify(messagesPayload, null, 2),
            ); // Ê∑ªÂä†Êó•ÂøóÔºåÊñπ‰æøË∞ÉËØï

            // ÂèëÈÄÅËØ∑Ê±Ç
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPrompt,
              messagesPayload,
              isGemini,
            );
            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: messagesPayload,
                    temperature: 0.9,
                  }),
                });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                `APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${JSON.stringify(errorData)}`,
              );
            }
            const data = await response.json();
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊúâÊïàÂõûÂ§ç
            if (
              !data.choices ||
              data.choices.length === 0 ||
              !data.choices[0].message.content
            ) {
              console.warn(
                `API‰∏∫Á©∫ÂõûÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËßíËâ≤ "${chat.name}" ÁöÑÊú¨Ê¨°ÂêéÂè∞Ê¥ªÂä®Ë∑≥Ëøá„ÄÇ`,
              );
              return;
            }
            const responseArray = parseAiResponse(
              isGemini
                ? data.candidates[0].content.parts[0].text
                : data.choices[0].message.content,
            );

            // ÂêéÁª≠Â§ÑÁêÜAIËøîÂõûÊåá‰ª§ÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò...
            for (const action of responseArray) {
              if (!action) continue;

              if (action.type === "update_status" && action.status_text) {
                chat.status.text = action.status_text;
                chat.status.isBusy = action.is_busy || false;
                chat.status.lastUpdate = Date.now();
                await db.chats.put(chat);
                renderChatList();
              }
              if (action.type === "text" && action.content) {
                const aiMessage = {
                  role: "assistant",
                  content: String(action.content).trim(),
                  timestamp: Date.now(),
                };

                chat.unreadCount = (chat.unreadCount || 0) + 1;
                chat.history.push(aiMessage);
                await db.chats.put(chat);
                showNotification(chatId, aiMessage.content);
                renderChatList();
                console.log(
                  `ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ‰∏ªÂä®ÂèëÈÄÅ‰∫ÜÊ∂àÊÅØ: ${aiMessage.content}`,
                );
              }
              if (action.type === "qzone_post") {
                const newPost = {
                  type: action.postType,
                  content: String(action.content || "").trim(),
                  publicText: String(action.publicText || "").trim(),
                  hiddenContent: String(action.hiddenContent || "").trim(),
                  timestamp: Date.now(),
                  authorId: chatId,
                  authorGroupId: chat.groupId, // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëËÆ∞ÂΩï‰ΩúËÄÖÁöÑÂàÜÁªÑID
                  visibleGroupIds: null,
                };
                await db.qzonePosts.add(newPost);
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ÂèëÂ∏É‰∫ÜÂä®ÊÄÅ`);
              } else if (action.type === "qzone_comment") {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                  if (!post.comments) post.comments = [];
                  post.comments.push({
                    commenterName: chat.name,
                    text: String(action.commentText || "").trim(),
                    timestamp: Date.now(),
                  });
                  await db.qzonePosts.update(post.id, {
                    comments: post.comments,
                  });
                  updateUnreadIndicator(unreadPostsCount + 1);
                  console.log(
                    `ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËØÑËÆ∫‰∫ÜÂä®ÊÄÅ #${post.id}`,
                  );
                }
              } else if (action.type === "qzone_like") {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                  if (!post.likes) post.likes = [];
                  if (!post.likes.includes(chat.name)) {
                    post.likes.push(chat.name);
                    await db.qzonePosts.update(post.id, { likes: post.likes });
                    updateUnreadIndicator(unreadPostsCount + 1);
                    console.log(
                      `ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ÁÇπËµû‰∫ÜÂä®ÊÄÅ #${post.id}`,
                    );
                  }
                }
              } else if (action.type === "video_call_request") {
                if (
                  !videoCallState.isActive &&
                  !videoCallState.isAwaitingResponse
                ) {
                  videoCallState.isAwaitingResponse = true;
                  state.activeChatId = chatId;
                  showIncomingCallModal();
                  console.log(
                    `ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç`,
                  );
                }
              }
            }
          } catch (error) {
            console.error(`ËßíËâ≤ "${chat.name}" ÁöÑÁã¨Á´ãË°åÂä®Â§±Ë¥•:`, error);
          }
        }

        /**
         * Â∞ÜÁî®Êà∑Ëá™ÂÆö‰πâÁöÑCSSÂÆâÂÖ®Âú∞Â∫îÁî®Âà∞ÊåáÂÆöÁöÑ‰ΩúÁî®Âüü
         * @param {string} cssString Áî®Êà∑ËæìÂÖ•ÁöÑÂéüÂßãCSSÂ≠óÁ¨¶‰∏≤
         * @param {string} scopeId Â∫îÁî®Ê†∑ÂºèÁöÑ‰ΩúÁî®ÂüüID (‰æãÂ¶Ç '#chat-messages' Êàñ '#settings-preview-area')
         * @param {string} styleTagId Ë¶ÅÊìç‰ΩúÁöÑ <style> Ê†áÁ≠æÁöÑID
         */
        function applyScopedCss(cssString, scopeId, styleTagId) {
          const styleTag = document.getElementById(styleTagId);
          if (!styleTag) return;

          if (!cssString || cssString.trim() === "") {
            styleTag.innerHTML = "";
            return;
          }

          // Â¢ûÂº∫‰ΩúÁî®ÂüüÂ§ÑÁêÜÂáΩÊï∞ - ‰∏ìÈó®Ëß£ÂÜ≥.userÂíå.aiÊ†∑ÂºèÂÜ≤Á™ÅÈóÆÈ¢ò
          const scopedCss = cssString
            .replace(
              /\s*\.message-bubble\.user\s+([^{]+\{)/g,
              `${scopeId} .message-bubble.user $1`,
            )
            .replace(
              /\s*\.message-bubble\.ai\s+([^{]+\{)/g,
              `${scopeId} .message-bubble.ai $1`,
            )
            .replace(
              /\s*\.message-bubble\s+([^{]+\{)/g,
              `${scopeId} .message-bubble $1`,
            );

          styleTag.innerHTML = scopedCss;
        }

        function updateSettingsPreview() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          const previewArea = document.getElementById("settings-preview-area");
          if (!previewArea) return;

          // 1. Ëé∑ÂèñÂΩìÂâçËÆæÁΩÆÁöÑÂÄº
          const selectedTheme =
            document.querySelector('input[name="theme-select"]:checked')
              ?.value || "default";
          const fontSize = document.getElementById("font-size-slider").value;
          const customCss = document.getElementById("custom-css-input").value;
          const background = chat.settings.background; // Áõ¥Êé•Ëé∑ÂèñËÉåÊôØËÆæÁΩÆ

          // 2. Êõ¥Êñ∞È¢ÑËßàÂå∫ÁöÑÂü∫Êú¨Ê†∑Âºè
          previewArea.dataset.theme = selectedTheme;
          previewArea.style.setProperty("--chat-font-size", `${fontSize}px`);

          // --- „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÁõ¥Êé•Êõ¥Êñ∞È¢ÑËßàÂå∫ÁöÑËÉåÊôØÊ†∑Âºè ---
          if (background && background.startsWith("data:image")) {
            previewArea.style.backgroundImage = `url(${background})`;
            previewArea.style.backgroundColor = "transparent"; // Â¶ÇÊûúÊúâÂõæÁâáÔºåËÉåÊôØËâ≤ËÆæ‰∏∫ÈÄèÊòé
          } else {
            previewArea.style.backgroundImage = "none"; // Â¶ÇÊûúÊ≤°ÊúâÂõæÁâáÔºåÁßªÈô§ÂõæÁâáËÉåÊôØ
            // Â¶ÇÊûúËÉåÊôØÊòØÈ¢úËâ≤ÂÄºÊàñÊ∏êÂèòÔºàÈùûÂõæÁâáÔºâÔºåÂàôÁõ¥Êé•Â∫îÁî®
            previewArea.style.background = background || "#f0f2f5";
          }

          // 3. Ê∏≤ÊüìÊ®°ÊãüÊ∞îÊ≥°
          previewArea.innerHTML = "";

          // ÂàõÂª∫‚ÄúÂØπÊñπ‚ÄùÁöÑÊ∞îÊ≥°
          // Ê≥®ÊÑèÔºöÊàë‰ª¨Â∞Ü‰∏Ä‰∏™ËôöÊãüÁöÑ timestamp ‰º†ÂÖ•Ôºå‰ª•Èò≤ÊúâCSS‰æùËµñ‰∫éÂÆÉ
          const aiMsg = {
            role: "ai",
            content: "ÂØπÊñπÊ∂àÊÅØÈ¢ÑËßà",
            timestamp: 1,
            senderName: chat.name,
          };
          const aiBubble = createMessageElement(aiMsg, chat);
          if (aiBubble) previewArea.appendChild(aiBubble);

          // ÂàõÂª∫‚ÄúÊàë‚ÄùÁöÑÊ∞îÊ≥°
          const userMsg = {
            role: "user",
            content: "ÊàëÁöÑÊ∂àÊÅØÈ¢ÑËßà",
            timestamp: 2,
          };
          const userBubble = createMessageElement(userMsg, chat);
          if (userBubble) previewArea.appendChild(userBubble);

          // 4. Â∫îÁî®Ëá™ÂÆö‰πâCSSÂà∞È¢ÑËßàÂå∫
          applyScopedCss(
            customCss,
            "#settings-preview-area",
            "preview-bubble-style",
          );
        }

        async function openGroupManager() {
          await renderGroupList();
          document
            .getElementById("group-management-modal")
            .classList.add("visible");
        }

        async function renderGroupList() {
          const listEl = document.getElementById("existing-groups-list");
          const groups = await db.qzoneGroups.toArray();
          listEl.innerHTML = "";
          if (groups.length === 0) {
            listEl.innerHTML =
              '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁªÑ</p>';
          }
          groups.forEach((group) => {
            const item = document.createElement("div");
            item.className = "existing-group-item";
            item.innerHTML = `
                  <span class="group-name">${group.name}</span>
                  <span class="delete-group-btn" data-id="${group.id}">√ó</span>
              `;
            listEl.appendChild(item);
          });
        }

        async function addNewGroup() {
          const input = document.getElementById("new-group-name-input");
          const name = input.value.trim();
          if (!name) {
            alert("ÂàÜÁªÑÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
            return;
          }

          // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®Ê∑ªÂä†ÂâçÔºåÂÖàÊ£ÄÊü•ÂàÜÁªÑÂêçÊòØÂê¶Â∑≤Â≠òÂú®
          const existingGroup = await db.qzoneGroups
            .where("name")
            .equals(name)
            .first();
          if (existingGroup) {
            alert(`ÂàÜÁªÑ "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºåÊç¢‰∏™ÂêçÂ≠óÂêßÔºÅ`);
            return;
          }
          // „Äê‰øÆÊ≠£ÁªìÊùü„Äë

          await db.qzoneGroups.add({ name });
          input.value = "";
          await renderGroupList();
        }

        async function deleteGroup(groupId) {
          const confirmed = await showCustomConfirm(
            "Á°ÆËÆ§Âà†Èô§",
            "Âà†Èô§ÂàÜÁªÑÂêéÔºåËØ•ÁªÑÂÜÖÁöÑÂ•ΩÂèãÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁªÑ‚Äù„ÄÇÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü",
            { confirmButtonClass: "btn-danger" },
          );
          if (confirmed) {
            await db.qzoneGroups.delete(groupId);
            // Â∞ÜÂ±û‰∫éËØ•ÂàÜÁªÑÁöÑÂ•ΩÂèãÁöÑ groupId ËÆæ‰∏∫ null
            const chatsToUpdate = await db.chats
              .where("groupId")
              .equals(groupId)
              .toArray();
            for (const chat of chatsToUpdate) {
              chat.groupId = null;
              await db.chats.put(chat);
              if (state.chats[chat.id]) state.chats[chat.id].groupId = null;
            }
            await renderGroupList();
          }
        }

        /**
         * ÂΩìÈïøÊåâÊ∂àÊÅØÊó∂ÔºåÊòæÁ§∫Êìç‰ΩúËèúÂçï
         * @param {number} timestamp - Ë¢´ÈïøÊåâÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        function showMessageActions(timestamp) {
          // Â¶ÇÊûúÂ∑≤ÁªèÂú®Â§öÈÄâÊ®°ÂºèÔºåÂàô‰∏çÂºπÂá∫ËèúÂçï
          if (isSelectionMode) return;

          activeMessageTimestamp = timestamp;
          document
            .getElementById("message-actions-modal")
            .classList.add("visible");
        }

        /**
         * ÈöêËóèÊ∂àÊÅØÊìç‰ΩúËèúÂçï
         */
        function hideMessageActions() {
          document
            .getElementById("message-actions-modal")
            .classList.remove("visible");
          activeMessageTimestamp = null;
        }

        async function openMessageEditor() {
          if (!activeMessageTimestamp) return;

          const timestampToEdit = activeMessageTimestamp;
          const chat = state.chats[state.activeChatId];
          const message = chat.history.find(
            (m) => m.timestamp === timestampToEdit,
          );
          if (!message) return;

          hideMessageActions();

          let contentForEditing;
          // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ∞Ü share_link ‰πüÂä†ÂÖ•ÁâπÊÆäÁ±ªÂûãÂà§Êñ≠
          const isSpecialType =
            message.type &&
            ["voice_message", "ai_image", "transfer", "share_link"].includes(
              message.type,
            );

          if (isSpecialType) {
            let fullMessageObject = { type: message.type };
            if (message.type === "voice_message")
              fullMessageObject.content = message.content;
            else if (message.type === "ai_image")
              fullMessageObject.description = message.content;
            else if (message.type === "transfer") {
              fullMessageObject.amount = message.amount;
              fullMessageObject.note = message.note;
            }
            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ§ÑÁêÜÂàÜ‰∫´ÈìæÊé•Á±ªÂûãÁöÑÊ∂àÊÅØ
            else if (message.type === "share_link") {
              fullMessageObject.title = message.title;
              fullMessageObject.description = message.description;
              fullMessageObject.source_name = message.source_name;
              fullMessageObject.content = message.content;
            }
            contentForEditing = JSON.stringify(fullMessageObject, null, 2);
          } else if (typeof message.content === "object") {
            contentForEditing = JSON.stringify(message.content, null, 2);
          } else {
            contentForEditing = message.content;
          }

          // „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÂú®ËøôÈáåÊ∑ªÂä† 'link' Ê®°Êùø
          const templates = {
            voice: { type: "voice_message", content: "Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ" },
            image: { type: "ai_image", description: "Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞" },
            transfer: { type: "transfer", amount: 5.2, note: "‰∏ÄÁÇπÂøÉÊÑè" },
            link: {
              type: "share_link",
              title: "ÊñáÁ´†Ê†áÈ¢ò",
              description: "ÊñáÁ´†ÊëòË¶Å...",
              source_name: "Êù•Ê∫êÁΩëÁ´ô",
              content: "ÊñáÁ´†ÂÆåÊï¥ÂÜÖÂÆπ...",
            },
          };

          // „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÂú®ËøôÈáåÊ∑ªÂä†Êñ∞ÁöÑ‚ÄúÈìæÊé•‚ÄùÊåâÈíÆ
          const helpersHtml = `
              <div class="format-helpers">
                  <button class="format-btn" data-template='${JSON.stringify(
                    templates.voice,
                  )}'>ËØ≠Èü≥</button>
                  <button class="format-btn" data-template='${JSON.stringify(
                    templates.image,
                  )}'>ÂõæÁâá</button>
                  <button class="format-btn" data-template='${JSON.stringify(
                    templates.transfer,
                  )}'>ËΩ¨Ë¥¶</button>
                  <button class="format-btn" data-template='${JSON.stringify(
                    templates.link,
                  )}'>ÈìæÊé•</button>
              </div>
          `;

          const newContent = await showCustomPrompt(
            "ÁºñËæëÊ∂àÊÅØ",
            "Âú®Ê≠§‰øÆÊîπÔºåÊàñÁÇπÂáª‰∏äÊñπÊåâÈíÆ‰ΩøÁî®Ê†ºÂºèÊ®°Êùø...",
            contentForEditing,
            "textarea",
            helpersHtml,
          );

          if (newContent !== null) {
            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëËøôÈáåË∞ÉÁî®ÁöÑÂ∫îËØ•ÊòØ saveEditedMessageÔºåËÄå‰∏çÊòØ saveAdvancedEditor
            await saveEditedMessage(timestampToEdit, newContent, true);
          }
        }

        /**
         * Â§çÂà∂Ê∂àÊÅØÁöÑÊñáÊú¨ÂÜÖÂÆπÂà∞Ââ™Ë¥¥Êùø
         */
        async function copyMessageContent() {
          if (!activeMessageTimestamp) return;
          const chat = state.chats[state.activeChatId];
          const message = chat.history.find(
            (m) => m.timestamp === activeMessageTimestamp,
          );
          if (!message) return;

          let textToCopy;
          if (typeof message.content === "object") {
            textToCopy = JSON.stringify(message.content);
          } else {
            textToCopy = String(message.content);
          }

          try {
            await navigator.clipboard.writeText(textToCopy);
            await showCustomAlert("Â§çÂà∂ÊàêÂäü", "Ê∂àÊÅØÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ");
          } catch (err) {
            await showCustomAlert("Â§çÂà∂Â§±Ë¥•", "Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ");
          }

          hideMessageActions();
        }

        /**
         * ÂàõÂª∫‰∏Ä‰∏™ÂèØÁºñËæëÁöÑÊ∂àÊÅØÂùóÔºàÂåÖÂê´ÊñáÊú¨Ê°Ü„ÄÅÊ†ºÂºèÂä©ÊâãÂíåÂà†Èô§ÊåâÈíÆÔºâ
         * @param {string} initialContent - ÊñáÊú¨Ê°ÜÁöÑÂàùÂßãÂÜÖÂÆπ
         * @returns {HTMLElement} - ÂàõÂª∫Â•ΩÁöÑDOMÂÖÉÁ¥†
         */
        function createMessageEditorBlock(initialContent = "") {
          const block = document.createElement("div");
          block.className = "message-editor-block";

          // „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÂú®ËøôÈáåÊ∑ªÂä† 'link' Ê®°Êùø
          const templates = {
            voice: { type: "voice_message", content: "Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ" },
            image: { type: "ai_image", description: "Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞" },
            transfer: { type: "transfer", amount: 5.2, note: "‰∏ÄÁÇπÂøÉÊÑè" },
            link: {
              type: "share_link",
              title: "ÊñáÁ´†Ê†áÈ¢ò",
              description: "ÊñáÁ´†ÊëòË¶Å...",
              source_name: "Êù•Ê∫êÁΩëÁ´ô",
              content: "ÊñáÁ´†ÂÆåÊï¥ÂÜÖÂÆπ...",
            },
          };

          block.innerHTML = `
              <button class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°">√ó</button>
              <textarea>${initialContent}</textarea>
              <div class="format-helpers">
                  <button class="format-btn" data-template='${JSON.stringify(
                    templates.voice,
                  )}'>ËØ≠Èü≥</button>
                  <button class="format-btn" data-template='${JSON.stringify(
                    templates.image,
                  )}'>ÂõæÁâá</button>
                  <button class="format-btn" data-template='${JSON.stringify(
                    templates.transfer,
                  )}'>ËΩ¨Ë¥¶</button>
                  <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÂú®ËøôÈáåÊ∑ªÂä†Êñ∞ÁöÑ‚ÄúÈìæÊé•‚ÄùÊåâÈíÆ -->
                  <button class="format-btn" data-template='${JSON.stringify(
                    templates.link,
                  )}'>ÈìæÊé•</button>
              </div>
          `;

          // ÁªëÂÆöÂà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
          block
            .querySelector(".delete-block-btn")
            .addEventListener("click", () => {
              // Á°Æ‰øùËá≥Â∞ë‰øùÁïô‰∏Ä‰∏™ÁºñËæëÂùó
              if (
                document.querySelectorAll(".message-editor-block").length > 1
              ) {
                block.remove();
              } else {
                alert("Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ");
              }
            });

          // ÁªëÂÆöÊ†ºÂºèÂä©ÊâãÊåâÈíÆ‰∫ã‰ª∂
          block.querySelectorAll(".format-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              const templateStr = btn.dataset.template;
              const textarea = block.querySelector("textarea");
              if (templateStr && textarea) {
                try {
                  const templateObj = JSON.parse(templateStr);
                  textarea.value = JSON.stringify(templateObj, null, 2);
                  textarea.focus();
                } catch (e) {
                  console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e);
                }
              }
            });
          });

          return block;
        }

        /**
         * ÊâìÂºÄÂÖ®Êñ∞ÁöÑ„ÄÅÂèØËßÜÂåñÁöÑÂ§öÊ∂àÊÅØÁºñËæëÂô®ÔºåÂπ∂Âä®ÊÄÅÁªëÂÆöÂÖ∂ÊâÄÊúâÊåâÈíÆ‰∫ã‰ª∂
         */
        function openAdvancedMessageEditor() {
          if (!activeMessageTimestamp) return;

          // 1. „ÄêÊ†∏ÂøÉ„ÄëÂú®ÂÖ≥Èó≠ÊóßËèúÂçïÂâçÔºåÂ∞ÜÈúÄË¶ÅÁöÑÊó∂Èó¥Êà≥ÊçïËé∑Âà∞Â±ÄÈÉ®ÂèòÈáè‰∏≠
          const timestampToEdit = activeMessageTimestamp;

          const chat = state.chats[state.activeChatId];
          const message = chat.history.find(
            (m) => m.timestamp === timestampToEdit,
          );
          if (!message) return;

          // 2. Áé∞Âú®ÂèØ‰ª•ÂÆâÂÖ®Âú∞ÂÖ≥Èó≠ÊóßËèúÂçï‰∫ÜÔºåÂõ†‰∏∫ÂÆÉ‰∏ç‰ºöÂΩ±ÂìçÊàë‰ª¨ÁöÑÂ±ÄÈÉ®ÂèòÈáè
          hideMessageActions();

          const editorModal = document.getElementById("message-editor-modal");
          const editorContainer = document.getElementById(
            "message-editor-container",
          );
          editorContainer.innerHTML = "";

          // 3. ÂáÜÂ§áÂàùÂßãÂÜÖÂÆπ
          let initialContent;
          const isSpecialType =
            message.type &&
            ["voice_message", "ai_image", "transfer"].includes(message.type);
          if (isSpecialType) {
            let fullMessageObject = { type: message.type };
            if (message.type === "voice_message")
              fullMessageObject.content = message.content;
            else if (message.type === "ai_image")
              fullMessageObject.description = message.content;
            else if (message.type === "transfer") {
              fullMessageObject.amount = message.amount;
              fullMessageObject.note = message.note;
            }
            initialContent = JSON.stringify(fullMessageObject, null, 2);
          } else if (typeof message.content === "object") {
            initialContent = JSON.stringify(message.content, null, 2);
          } else {
            initialContent = message.content;
          }

          const firstBlock = createMessageEditorBlock(initialContent);
          editorContainer.appendChild(firstBlock);

          // 4. „ÄêÊ†∏ÂøÉ„ÄëÂä®ÊÄÅÁªëÂÆöÊâÄÊúâÊéßÂà∂ÊåâÈíÆÁöÑ‰∫ã‰ª∂
          // ‰∏∫‰∫ÜÈò≤Ê≠¢‰∫ã‰ª∂ÈáçÂ§çÁªëÂÆöÔºåÊàë‰ª¨‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÁöÑÊñπÊ≥ïÊù•Ê∏ÖÈô§ÊóßÁõëÂê¨Âô®
          const addBtn = document.getElementById(
            "add-message-editor-block-btn",
          );
          const newAddBtn = addBtn.cloneNode(true);
          addBtn.parentNode.replaceChild(newAddBtn, addBtn);
          newAddBtn.addEventListener("click", () => {
            const newBlock = createMessageEditorBlock();
            editorContainer.appendChild(newBlock);
            newBlock.querySelector("textarea").focus();
          });

          const cancelBtn = document.getElementById(
            "cancel-advanced-editor-btn",
          );
          const newCancelBtn = cancelBtn.cloneNode(true);
          cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
          newCancelBtn.addEventListener("click", () => {
            editorModal.classList.remove("visible");
          });

          const saveBtn = document.getElementById("save-advanced-editor-btn");
          const newSaveBtn = saveBtn.cloneNode(true);
          saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
          // Â∞ÜÊçïËé∑Âà∞ÁöÑÊó∂Èó¥Êà≥ÔºåÁõ¥Êé•ÁªëÂÆöÁªôËøô‰∏ÄÊ¨°ÁöÑ‰øùÂ≠òÁÇπÂáª‰∫ã‰ª∂
          newSaveBtn.addEventListener("click", () => {
            saveEditedMessage(timestampToEdit);
          });

          // 5. ÊúÄÂêéÔºåÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
          editorModal.classList.add("visible");
        }

        /**
         * Ëß£ÊûêÁºñËæëÂêéÁöÑÊñáÊú¨ÔºåÂπ∂ËøîÂõû‰∏Ä‰∏™Ê†áÂáÜÂåñÁöÑÊ∂àÊÅØÁâáÊÆµÂØπË±°
         * @param {string} text - Áî®Êà∑Âú®ÁºñËæëÊ°Ü‰∏≠ËæìÂÖ•ÁöÑÊñáÊú¨
         * @returns {object} - ‰∏Ä‰∏™ÂåÖÂê´ type, content, Á≠âÂ±ûÊÄßÁöÑÂØπË±°
         */
        function parseEditedContent(text) {
          const trimmedText = text.trim();

          // 1. Â∞ùËØïËß£Êûê‰∏∫JSONÂØπË±°ÔºàÁî®‰∫é‰øÆÂ§çËØ≠Èü≥„ÄÅËΩ¨Ë¥¶Á≠âÊ†ºÂºèÔºâ
          if (trimmedText.startsWith("{") && trimmedText.endsWith("}")) {
            try {
              const parsed = JSON.parse(trimmedText);
              // ÂøÖÈ°ªÂåÖÂê´ type Â±ûÊÄßÊâçËÆ§‰∏∫ÊòØÊúâÊïàÊ†ºÂºè
              if (parsed.type) {
                return parsed;
              }
            } catch (e) {
              /* Ëß£ÊûêÂ§±Ë¥•ÔºåÁªßÁª≠ÂæÄ‰∏ãËµ∞ */
            }
          }

          // 2. Â∞ùËØïËß£Êûê‰∏∫Ë°®ÊÉÖÂåÖ
          if (STICKER_REGEX.test(trimmedText)) {
            // ÂØπ‰∫éÁºñËæëÁöÑË°®ÊÉÖÔºåÊàë‰ª¨ÊöÇÊó∂Êó†Ê≥ïÁü•ÈÅìÂÖ∂`meaning`ÔºåÊâÄ‰ª•Âè™Â≠òURL
            return { type: "sticker", content: trimmedText };
          }

          // 3. Âê¶ÂàôÔºåËßÜ‰∏∫ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
          return { type: "text", content: trimmedText };
        }

        async function saveEditedMessage(timestamp, simpleContent = null) {
          if (!timestamp) return;

          const chat = state.chats[state.activeChatId];
          const messageIndex = chat.history.findIndex(
            (m) => m.timestamp === timestamp,
          );
          if (messageIndex === -1) return;

          let newMessages = [];

          // Âà§Êñ≠ÊòØÊù•Ëá™È´òÁ∫ßÁºñËæëÂô®ËøòÊòØÁÆÄÂçïÁºñËæëÂô®
          if (simpleContent !== null) {
            // --- Êù•Ëá™ÁÆÄÂçïÁºñËæëÂô® ---
            const rawContent = simpleContent.trim();
            if (rawContent) {
              const parsedResult = parseEditedContent(rawContent);
              const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                // Ê≥®ÊÑèÔºöËøôÈáåÊàë‰ª¨ÊöÇÊó∂‰∏çËÆæÁΩÆÊó∂Èó¥Êà≥
                content: parsedResult.content || "",
              };
              if (parsedResult.type && parsedResult.type !== "text")
                newMessage.type = parsedResult.type;
              if (parsedResult.meaning)
                newMessage.meaning = parsedResult.meaning;
              if (parsedResult.amount) newMessage.amount = parsedResult.amount;
              if (parsedResult.note) newMessage.note = parsedResult.note;
              if (parsedResult.title) newMessage.title = parsedResult.title;
              if (parsedResult.description)
                newMessage.description = parsedResult.description;
              if (parsedResult.source_name)
                newMessage.source_name = parsedResult.source_name;
              if (
                parsedResult.description &&
                parsedResult.type === "ai_image"
              ) {
                newMessage.content = parsedResult.description;
              }

              newMessages.push(newMessage);
            }
          } else {
            // --- Êù•Ëá™È´òÁ∫ßÁºñËæëÂô® ---
            const editorContainer = document.getElementById(
              "message-editor-container",
            );
            const editorBlocks = editorContainer.querySelectorAll(
              ".message-editor-block",
            );

            for (const block of editorBlocks) {
              const textarea = block.querySelector("textarea");
              const rawContent = textarea.value.trim();
              if (!rawContent) continue;

              const parsedResult = parseEditedContent(rawContent);
              const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                // ÂêåÊ†∑ÔºåËøôÈáåÊàë‰ª¨ÂÖà‰∏çÂàÜÈÖçÊó∂Èó¥Êà≥
                content: parsedResult.content || "",
              };

              if (parsedResult.type && parsedResult.type !== "text")
                newMessage.type = parsedResult.type;
              if (parsedResult.meaning)
                newMessage.meaning = parsedResult.meaning;
              if (parsedResult.amount) newMessage.amount = parsedResult.amount;
              if (parsedResult.note) newMessage.note = parsedResult.note;
              if (parsedResult.title) newMessage.title = parsedResult.title;
              if (parsedResult.description)
                newMessage.description = parsedResult.description;
              if (parsedResult.source_name)
                newMessage.source_name = parsedResult.source_name;
              if (
                parsedResult.description &&
                parsedResult.type === "ai_image"
              ) {
                newMessage.content = parsedResult.description;
              }

              newMessages.push(newMessage);
            }
          }

          if (newMessages.length === 0) {
            document
              .getElementById("message-editor-modal")
              .classList.remove("visible");
            return; // Â¶ÇÊûúÊòØÁ©∫Ê∂àÊÅØÔºåÁõ¥Êé•ËøîÂõûÔºå‰∏çÊâßË°åÂà†Èô§Êìç‰Ωú
          }

          // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉ‰øÆÂ§çÈÄªËæëÂ∞±Âú®ËøôÈáå„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ

          // 1. ‰ΩøÁî® splice Â∞ÜÊóßÊ∂àÊÅØÊõøÊç¢‰∏∫Êñ∞Ê∂àÊÅØÔºàÊ≠§Êó∂Êñ∞Ê∂àÊÅØËøòÊ≤°ÊúâÊó∂Èó¥Êà≥Ôºâ
          chat.history.splice(messageIndex, 1, ...newMessages);

          // 2. Á°ÆÂÆöÈáçÊñ∞ÂàÜÈÖçÊó∂Èó¥Êà≥ÁöÑËµ∑ÁÇπ
          // Êàë‰ª¨‰ªéË¢´ÁºñËæëÁöÑÊ∂àÊÅØÁöÑÂéüÂßãÊó∂Èó¥Êà≥ÂºÄÂßã
          let reassignTimestamp = timestamp;

          // 3. ‰ªéË¢´‰øÆÊîπÁöÑ‰ΩçÁΩÆÂºÄÂßãÔºåÈÅçÂéÜÊâÄÊúâÂêéÁª≠ÁöÑÊ∂àÊÅØ
          for (let i = messageIndex; i < chat.history.length; i++) {
            // 4. ‰∏∫ÊØè‰∏ÄÊù°Ê∂àÊÅØÔºàÂåÖÊã¨Êñ∞ÊèíÂÖ•ÁöÑÔºâÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑ„ÄÅÂîØ‰∏ÄÁöÑ„ÄÅËøûÁª≠ÁöÑÊó∂Èó¥Êà≥
            chat.history[i].timestamp = reassignTimestamp;

            // 5. Â∞ÜÊó∂Èó¥Êà≥+1Ôºå‰∏∫‰∏ã‰∏ÄÊù°Ê∂àÊÅØÂÅöÂáÜÂ§á
            reassignTimestamp++;
          }
          // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„Äê‰øÆÂ§çÁªìÊùü„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ

          await db.chats.put(chat);

          // ÂÖ≥Èó≠ÂèØËÉΩÊâìÂºÄÁöÑÊ®°ÊÄÅÊ°ÜÂπ∂Âà∑Êñ∞UI
          document
            .getElementById("message-editor-modal")
            .classList.remove("visible");
          renderChatInterface(state.activeChatId);
          await showCustomAlert("ÊàêÂäü", "Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞ÔºÅ");
        }

        /**
         * ÂΩìÁÇπÂáª‚Äú‚Ä¶‚ÄùÊó∂ÔºåÊòæÁ§∫Âä®ÊÄÅÊìç‰ΩúËèúÂçï
         * @param {number} postId - Ë¢´Êìç‰ΩúÁöÑÂä®ÊÄÅÁöÑID
         */
        function showPostActions(postId) {
          activePostId = postId;
          document
            .getElementById("post-actions-modal")
            .classList.add("visible");
        }

        /**
         * ÈöêËóèÂä®ÊÄÅÊìç‰ΩúËèúÂçï
         */
        function hidePostActions() {
          document
            .getElementById("post-actions-modal")
            .classList.remove("visible");
          activePostId = null;
        }

        /**
         * ÊâìÂºÄÂä®ÊÄÅÁºñËæëÂô®
         */
        async function openPostEditor() {
          if (!activePostId) return;

          const postIdToEdit = activePostId;
          const post = await db.qzonePosts.get(postIdToEdit);
          if (!post) return;

          hidePostActions();

          // Âø†‰∫éÂéüÊñáÔºöÊûÑÂª∫Âá∫ÊúÄÂéüÂßãÁöÑÊñáÊú¨ÂΩ¢ÊÄÅ‰æõÁºñËæë
          let contentForEditing;
          if (post.type === "shuoshuo") {
            contentForEditing = post.content;
          } else {
            // ÂØπ‰∫éÂõæÁâáÂíåÊñáÂ≠óÂõæÔºåÊàë‰ª¨ÊûÑÂª∫‰∏Ä‰∏™ÂåÖÂê´ÊâÄÊúâ‰ø°ÊÅØÁöÑÂØπË±°
            const postObject = {
              type: post.type,
              publicText: post.publicText || "",
            };
            if (post.type === "image_post") {
              postObject.imageUrl = post.imageUrl;
              postObject.imageDescription = post.imageDescription;
            } else if (post.type === "text_image") {
              postObject.hiddenContent = post.hiddenContent;
            }
            contentForEditing = JSON.stringify(postObject, null, 2);
          }

          // ÊûÑÂª∫Ê†ºÂºèÂä©ÊâãÊåâÈíÆ
          const templates = {
            shuoshuo: "Âú®ËøôÈáåËæìÂÖ•ËØ¥ËØ¥ÁöÑÂÜÖÂÆπ...", // ÂØπ‰∫éËØ¥ËØ¥ÔºåÊàë‰ª¨Áõ¥Êé•ÊõøÊç¢‰∏∫Á∫ØÊñáÊú¨
            image: {
              type: "image_post",
              publicText: "",
              imageUrl: "https://...",
              imageDescription: "",
            },
            text_image: {
              type: "text_image",
              publicText: "",
              hiddenContent: "",
            },
          };

          const helpersHtml = `
              <div class="format-helpers">
                  <button class="format-btn" data-type="text">ËØ¥ËØ¥</button>
                  <button class="format-btn" data-template='${JSON.stringify(
                    templates.image,
                  )}'>ÂõæÁâáÂä®ÊÄÅ</button>
                  <button class="format-btn" data-template='${JSON.stringify(
                    templates.text_image,
                  )}'>ÊñáÂ≠óÂõæ</button>
              </div>
          `;

          const newContent = await showCustomPrompt(
            "ÁºñËæëÂä®ÊÄÅ",
            "Âú®Ê≠§‰øÆÊîπÂÜÖÂÆπ...",
            contentForEditing,
            "textarea",
            helpersHtml,
          );

          // „ÄêÁâπÊÆäÂ§ÑÁêÜ„Äë‰∏∫ËØ¥ËØ¥ÁöÑÊ†ºÂºèÂä©ÊâãÊåâÈíÆÊ∑ªÂä†‰∏çÂêåÁöÑË°å‰∏∫
          // Êàë‰ª¨ÈúÄË¶ÅÂú®Ê®°ÊÄÅÊ°ÜÂá∫Áé∞ÂêéÔºåÂÜçÁªôÂÆÉÁªëÂÆö‰∫ã‰ª∂
          setTimeout(() => {
            const shuoshuoBtn = document.querySelector(
              '#custom-modal-body .format-btn[data-type="text"]',
            );
            if (shuoshuoBtn) {
              shuoshuoBtn.addEventListener("click", () => {
                const input = document.getElementById("custom-prompt-input");
                input.value = templates.shuoshuo;
                input.focus();
              });
            }
          }, 100);

          if (newContent !== null) {
            await saveEditedPost(postIdToEdit, newContent);
          }
        }

        /**
         * ‰øùÂ≠òÁºñËæëÂêéÁöÑÂä®ÊÄÅ
         * @param {number} postId - Ë¶Å‰øùÂ≠òÁöÑÂä®ÊÄÅID
         * @param {string} newRawContent - ‰ªéÁºñËæëÂô®Ëé∑ÂèñÁöÑÊñ∞ÂÜÖÂÆπ
         */
        async function saveEditedPost(postId, newRawContent) {
          const post = await db.qzonePosts.get(postId);
          if (!post) return;

          const trimmedContent = newRawContent.trim();

          // Â∞ùËØïËß£Êûê‰∏∫JSONÔºåÂ¶ÇÊûúÂ§±Ë¥•ÔºåÂàôËÆ§‰∏∫ÊòØÁ∫ØÊñáÊú¨ÔºàËØ¥ËØ¥Ôºâ
          try {
            const parsed = JSON.parse(trimmedContent);
            // Êõ¥Êñ∞Â∏ñÂ≠êÂ±ûÊÄß
            post.type = parsed.type || "image_post";
            post.publicText = parsed.publicText || "";
            post.imageUrl = parsed.imageUrl || "";
            post.imageDescription = parsed.imageDescription || "";
            post.hiddenContent = parsed.hiddenContent || "";
            post.content = ""; // Ê∏ÖÁ©∫ÊóßÁöÑËØ¥ËØ¥ÂÜÖÂÆπÂ≠óÊÆµ
          } catch (e) {
            // Ëß£ÊûêÂ§±Ë¥•ÔºåËÆ§‰∏∫ÊòØËØ¥ËØ¥
            post.type = "shuoshuo";
            post.content = trimmedContent;
            // Ê∏ÖÁ©∫ÂÖ∂‰ªñÁ±ªÂûãÁöÑÂ≠óÊÆµ
            post.publicText = "";
            post.imageUrl = "";
            post.imageDescription = "";
            post.hiddenContent = "";
          }

          await db.qzonePosts.put(post);
          await renderQzonePosts(); // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
          await showCustomAlert("ÊàêÂäü", "Âä®ÊÄÅÂ∑≤Êõ¥Êñ∞ÔºÅ");
        }

        /**
         * Â§çÂà∂Âä®ÊÄÅÂÜÖÂÆπ
         */
        async function copyPostContent() {
          if (!activePostId) return;
          const post = await db.qzonePosts.get(activePostId);
          if (!post) return;

          let textToCopy =
            post.content ||
            post.publicText ||
            post.hiddenContent ||
            post.imageDescription ||
            "ÔºàÊó†ÊñáÂ≠óÂÜÖÂÆπÔºâ";

          try {
            await navigator.clipboard.writeText(textToCopy);
            await showCustomAlert("Â§çÂà∂ÊàêÂäü", "Âä®ÊÄÅÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ");
          } catch (err) {
            await showCustomAlert("Â§çÂà∂Â§±Ë¥•", "Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ");
          }

          hidePostActions();
        }

        let selectedContacts = new Set();

        async function openContactPickerForGroupCreate() {
          selectedContacts.clear(); // Ê∏ÖÁ©∫‰∏äÊ¨°ÈÄâÊã©

          // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨‰∏∫‚ÄúÂÆåÊàê‚ÄùÊåâÈíÆÊòéÁ°ÆÁªëÂÆö‚ÄúÂàõÂª∫Áæ§ËÅä‚ÄùÁöÑÂäüËÉΩ
          const confirmBtn = document.getElementById(
            "confirm-contact-picker-btn",
          );
          // ‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÊäÄÂ∑ßÔºåÊ∏ÖÈô§Êéâ‰πãÂâçÂèØËÉΩÁªëÂÆöÁöÑ‰ªª‰ΩïÂÖ∂‰ªñ‰∫ã‰ª∂ÔºàÊØîÂ¶Ç‚ÄúÊ∑ªÂä†ÊàêÂëò‚ÄùÔºâ
          const newConfirmBtn = confirmBtn.cloneNode(true);
          confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
          // ÈáçÊñ∞ÁªëÂÆöÊ≠£Á°ÆÁöÑ‚ÄúÂàõÂª∫Áæ§ËÅä‚ÄùÂáΩÊï∞
          newConfirmBtn.addEventListener("click", handleCreateGroup);

          await renderContactPicker();
          showScreen("contact-picker-screen");
        }

        /**
         * Ê∏≤ÊüìËÅîÁ≥ª‰∫∫ÈÄâÊã©ÂàóË°®
         */
        async function renderContactPicker() {
          const listEl = document.getElementById("contact-picker-list");
          listEl.innerHTML = "";

          // Âè™ÈÄâÊã©ÂçïËÅäËßíËâ≤‰Ωú‰∏∫Áæ§ÊàêÂëòÂÄôÈÄâ
          const contacts = Object.values(state.chats).filter(
            (chat) => !chat.isGroup,
          );

          if (contacts.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">ËøòÊ≤°ÊúâÂèØ‰ª•ÊãâËøõÁæ§ÁöÑËÅîÁ≥ª‰∫∫Âì¶~</p>';
            return;
          }

          contacts.forEach((contact) => {
            const item = document.createElement("div");
            item.className = "contact-picker-item";
            item.dataset.contactId = contact.id;
            item.innerHTML = `
                  <div class="checkbox"></div>
                  <img src="${
                    contact.settings.aiAvatar || defaultAvatar
                  }" class="avatar">
                  <span class="name">${contact.name}</span>
              `;
            listEl.appendChild(item);
          });

          updateContactPickerConfirmButton();
        }

        /**
         * Êõ¥Êñ∞‚ÄúÂÆåÊàê‚ÄùÊåâÈíÆÁöÑËÆ°Êï∞
         */
        function updateContactPickerConfirmButton() {
          const btn = document.getElementById("confirm-contact-picker-btn");
          btn.textContent = `ÂÆåÊàê(${selectedContacts.size})`;
          btn.disabled = selectedContacts.size < 2; // Ëá≥Â∞ëÈúÄË¶Å2‰∏™‰∫∫ÊâçËÉΩÂàõÂª∫Áæ§ËÅä
        }

        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÂ§ÑÁêÜÂàõÂª∫Áæ§ËÅäÁöÑÊúÄÁªàÈÄªËæë
         */
        async function handleCreateGroup() {
          if (selectedContacts.size < 2) {
            alert("ÂàõÂª∫Áæ§ËÅäËá≥Â∞ëÈúÄË¶ÅÈÄâÊã©2‰∏™ËÅîÁ≥ª‰∫∫„ÄÇ");
            return;
          }

          const groupName = await showCustomPrompt(
            "ËÆæÁΩÆÁæ§Âêç",
            "ËØ∑ËæìÂÖ•Áæ§ËÅäÁöÑÂêçÂ≠ó",
            "Êàë‰ª¨ÁöÑÁæ§ËÅä",
          );
          if (!groupName || !groupName.trim()) return;

          const newChatId = "group_" + Date.now();
          const members = [];

          // ÈÅçÂéÜÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫ID
          for (const contactId of selectedContacts) {
            const contactChat = state.chats[contactId];
            if (contactChat) {
              // ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉÈáçÊûÑ„Äë‚òÖ‚òÖ‚òÖ
              // Êàë‰ª¨Áé∞Âú®ÂêåÊó∂Â≠òÂÇ®ËßíËâ≤ÁöÑ‚ÄúÊú¨Âêç‚ÄùÂíå‚ÄúÁæ§ÊòµÁß∞‚Äù
              members.push({
                id: contactId,
                originalName: contactChat.name, // ËßíËâ≤ÁöÑ‚ÄúÊú¨Âêç‚ÄùÔºåÁî®‰∫éAIËØÜÂà´
                groupNickname: contactChat.name, // ËßíËâ≤ÁöÑ‚ÄúÁæ§ÊòµÁß∞‚ÄùÔºåÁî®‰∫éÊòæÁ§∫Âíå‰øÆÊîπÔºåÂàùÂßãÂÄºÂíåÊú¨ÂêçÁõ∏Âêå
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || "",
              });
            }
          }

          const newGroupChat = {
            id: newChatId,
            name: groupName.trim(),
            isGroup: true,
            members: members,
            settings: {
              myPersona: "ÊàëÊòØË∞ÅÂëÄ„ÄÇ",
              myNickname: "Êàë",
              maxMemory: 10,
              groupAvatar: defaultGroupAvatar,
              myAvatar: defaultMyGroupAvatar,
              background: "",
              theme: "default",
              fontSize: 13,
              customCss: "",
              linkedWorldBookIds: [],
            },
            history: [],
            musicData: { totalTime: 0 },
          };

          state.chats[newChatId] = newGroupChat;
          await db.chats.put(newGroupChat);

          await renderChatList();
          showScreen("chat-list-screen");
          openChat(newChatId);
        }

        /**
         * ÊâìÂºÄÁæ§ÊàêÂëòÁÆ°ÁêÜÂ±èÂπï
         */
        function openMemberManagementScreen() {
          if (!state.activeChatId || !state.chats[state.activeChatId].isGroup)
            return;
          renderMemberManagementList();
          showScreen("member-management-screen");
        }

        function renderMemberManagementList() {
          const listEl = document.getElementById("member-management-list");
          const chat = state.chats[state.activeChatId];
          listEl.innerHTML = "";

          chat.members.forEach((member) => {
            const item = document.createElement("div");
            item.className = "member-management-item";
            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨Â∞ÜÊòæÁ§∫ÁöÑÂêçÁß∞‰ªé member.name Êîπ‰∏∫ member.groupNickname
            item.innerHTML = `
                  <img src="${member.avatar}" class="avatar">
                  <span class="name">${member.groupNickname}</span>
                  <button class="remove-member-btn" data-member-id="${member.id}" title="ÁßªÂá∫Áæ§ËÅä">-</button>
              `;
            listEl.appendChild(item);
          });
        }

        /**
         * ‰ªéÁæ§ËÅä‰∏≠ÁßªÈô§‰∏Ä‰∏™ÊàêÂëò
         * @param {string} memberId - Ë¶ÅÁßªÈô§ÁöÑÊàêÂëòID
         */
        async function removeMemberFromGroup(memberId) {
          const chat = state.chats[state.activeChatId];
          const memberIndex = chat.members.findIndex((m) => m.id === memberId);

          if (memberIndex === -1) return;

          // ÂÆâÂÖ®Ê£ÄÊü•ÔºåÁæ§ËÅäËá≥Â∞ë‰øùÁïô2‰∫∫
          if (chat.members.length <= 2) {
            alert("Áæ§ËÅä‰∫∫Êï∞‰∏çËÉΩÂ∞ë‰∫é2‰∫∫„ÄÇ");
            return;
          }

          const memberName = chat.members[memberIndex].groupNickname; // <-- ‰øÆÂ§çÔºö‰ΩøÁî® groupNickname
          const confirmed = await showCustomConfirm(
            "ÁßªÂá∫ÊàêÂëò",
            `Á°ÆÂÆöË¶ÅÂ∞Ü‚Äú${memberName}‚ÄùÁßªÂá∫Áæ§ËÅäÂêóÔºü`,
            { confirmButtonClass: "btn-danger" },
          );

          if (confirmed) {
            chat.members.splice(memberIndex, 1);
            await db.chats.put(chat);
            renderMemberManagementList(); // Âà∑Êñ∞ÊàêÂëòÁÆ°ÁêÜÂàóË°®
            document.getElementById("chat-settings-btn").click(); // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊ®°ÊãüÁÇπÂáªËÆæÁΩÆÊåâÈíÆÔºåÂº∫Âà∂Âà∑Êñ∞Êï¥‰∏™ÂºπÁ™ó
          }
        }

        /**
         * ÊâìÂºÄËÅîÁ≥ª‰∫∫ÈÄâÊã©Âô®ÔºåÁî®‰∫éÊãâ‰∫∫ÂÖ•Áæ§
         */
        async function openContactPickerForAddMember() {
          selectedContacts.clear(); // Ê∏ÖÁ©∫ÈÄâÊã©

          const chat = state.chats[state.activeChatId];
          const existingMemberIds = new Set(chat.members.map((m) => m.id));

          // Ê∏≤ÊüìËÅîÁ≥ª‰∫∫ÂàóË°®ÔºåÂπ∂Ëá™Âä®ÊéíÈô§Â∑≤Âú®Áæ§ÂÜÖÁöÑÊàêÂëò
          const listEl = document.getElementById("contact-picker-list");
          listEl.innerHTML = "";
          const contacts = Object.values(state.chats).filter(
            (c) => !c.isGroup && !existingMemberIds.has(c.id),
          );

          if (contacts.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">Ê≤°ÊúâÊõ¥Â§öÂèØ‰ª•ÈÇÄËØ∑ÁöÑÂ•ΩÂèã‰∫Ü„ÄÇ</p>';
            document.getElementById(
              "confirm-contact-picker-btn",
            ).style.display = "none"; // Ê≤°Êúâ‰∫∫ÂèØÈÄâÔºåÈöêËóèÂÆåÊàêÊåâÈíÆ
          } else {
            document.getElementById(
              "confirm-contact-picker-btn",
            ).style.display = "block";
            contacts.forEach((contact) => {
              const item = document.createElement("div");
              item.className = "contact-picker-item";
              item.dataset.contactId = contact.id;
              item.innerHTML = `
                      <div class="checkbox"></div>
                      <img src="${
                        contact.settings.aiAvatar || defaultAvatar
                      }" class="avatar">
                      <span class="name">${contact.name}</span>
                  `;
              listEl.appendChild(item);
            });
          }

          // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅÂπ∂ÊòæÁ§∫Â±èÂπï
          updateContactPickerConfirmButton();
          showScreen("contact-picker-screen");
        }

        /**
         * Â§ÑÁêÜÂ∞ÜÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫Âä†ÂÖ•Áæ§ËÅäÁöÑÈÄªËæë
         */
        async function handleAddMembersToGroup() {
          if (selectedContacts.size === 0) {
            alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÊ∑ªÂä†ÁöÑËÅîÁ≥ª‰∫∫„ÄÇ");
            return;
          }

          const chat = state.chats[state.activeChatId];

          for (const contactId of selectedContacts) {
            const contactChat = state.chats[contactId];
            if (contactChat) {
              chat.members.push({
                id: contactId,
                originalName: contactChat.name, // <-- ‰øÆÂ§ç1Ôºö‰ΩøÁî® 'originalName' Â≠òÂÇ®Êú¨Âêç
                groupNickname: contactChat.name, // <-- ‰øÆÂ§ç2ÔºöÂêåÊó∂ÂàõÂª∫‰∏Ä‰∏™ÂàùÂßãÁöÑ 'groupNickname'
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || "",
              });
            }
          }

          await db.chats.put(chat);
          openMemberManagementScreen(); // ËøîÂõûÂà∞Áæ§ÊàêÂëòÁÆ°ÁêÜÁïåÈù¢
          renderGroupMemberSettings(chat.members); // ÂêåÊó∂Êõ¥Êñ∞ËÅäÂ§©ËÆæÁΩÆÈáåÁöÑÂ§¥ÂÉè
        }

        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÂú®Áæ§ËÅä‰∏≠ÂàõÂª∫‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑËôöÊãüÊàêÂëò
         */
        async function createNewMemberInGroup() {
          const name = await showCustomPrompt(
            "ÂàõÂª∫Êñ∞ÊàêÂëò",
            "ËØ∑ËæìÂÖ•Êñ∞ÊàêÂëòÁöÑÂêçÂ≠ó (ËøôÂ∞ÜÊòØTAÁöÑ‚ÄúÊú¨Âêç‚ÄùÔºå‰∏çÂèØÊõ¥Êîπ)",
          );
          if (!name || !name.trim()) return;

          // Ê£ÄÊü•Êú¨ÂêçÊòØÂê¶Â∑≤Âú®Áæ§ÂÜÖÂ≠òÂú®
          const chat = state.chats[state.activeChatId];
          if (chat.members.some((m) => m.originalName === name.trim())) {
            alert(`ÈîôËØØÔºöÁæ§ÂÜÖÂ∑≤Â≠òÂú®Âêç‰∏∫‚Äú${name.trim()}‚ÄùÁöÑÊàêÂëòÔºÅ`);
            return;
          }

          const persona = await showCustomPrompt(
            "ËÆæÁΩÆ‰∫∫ËÆæ",
            `ËØ∑ËæìÂÖ•‚Äú${name}‚ÄùÁöÑ‰∫∫ËÆæ`,
            "",
            "textarea",
          );
          if (persona === null) return;

          // ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉÈáçÊûÑ„Äë‚òÖ‚òÖ‚òÖ
          // ‰∏∫Êñ∞ÂàõÂª∫ÁöÑNPC‰πüÂª∫Á´ãÂèåÈáçÂëΩÂêçÊú∫Âà∂
          const newMember = {
            id: "npc_" + Date.now(),
            originalName: name.trim(), // Êñ∞ÊàêÂëòÁöÑ‚ÄúÊú¨Âêç‚Äù
            groupNickname: name.trim(), // Êñ∞ÊàêÂëòÁöÑÂàùÂßã‚ÄúÁæ§ÊòµÁß∞‚Äù
            avatar: defaultGroupMemberAvatar,
            persona: persona,
            avatarFrame: "",
          };

          chat.members.push(newMember);
          await db.chats.put(chat);

          renderMemberManagementList();
          renderGroupMemberSettings(chat.members);

          alert(`Êñ∞ÊàêÂëò‚Äú${name}‚ÄùÂ∑≤ÊàêÂäüÂä†ÂÖ•Áæ§ËÅäÔºÅ`);
        }

        function startWaimaiCountdown(element, endTime) {
          const timerId = setInterval(() => {
            const now = Date.now();
            const distance = endTime - now;

            if (distance < 0) {
              clearInterval(timerId);
              element.innerHTML =
                "<span>Â∑≤</span><span>Ë∂Ö</span><span>Êó∂</span>";
              return;
            }

            const minutes = Math.floor(
              (distance % (1000 * 60 * 60)) / (1000 * 60),
            );
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            const minStr = String(minutes).padStart(2, "0");
            const secStr = String(seconds).padStart(2, "0");

            element.innerHTML = `<span>${minStr.charAt(
              0,
            )}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(
              0,
            )}</span><span>${secStr.charAt(1)}</span>`;
          }, 1000);
          return timerId;
        }

        function cleanupWaimaiTimers() {
          for (const timestamp in waimaiTimers) {
            clearInterval(waimaiTimers[timestamp]);
          }
          waimaiTimers = {};
        }

        async function handleWaimaiResponse(originalTimestamp, choice) {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const messageIndex = chat.history.findIndex(
            (m) => m.timestamp === originalTimestamp,
          );
          if (messageIndex === -1) return;

          // 1. Êõ¥Êñ∞ÂéüÂßãÊ∂àÊÅØÁöÑÁä∂ÊÄÅ
          const originalMessage = chat.history[messageIndex];
          originalMessage.status = choice;

          // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëËÆ∞ÂΩïÊîØ‰ªòËÄÖÔºåÂπ∂ÊûÑÂª∫ÂØπAIÊõ¥Ê∏ÖÊô∞ÁöÑÁ≥ªÁªüÊ∂àÊÅØ
          let systemContent;
          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "Êàë"
            : "Êàë";

          if (choice === "paid") {
            originalMessage.paidBy = myNickname; // ËÆ∞ÂΩïÊòØÁî®Êà∑‰ªòÁöÑÈí±
            systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ‰∏∫ ${originalMessage.senderName} ÁöÑÂ§ñÂçñËÆ¢ÂçïÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}ÔºâÂÆåÊàê‰∫ÜÊîØ‰ªò„ÄÇÊ≠§ËÆ¢ÂçïÂ∑≤ÂÖ≥Èó≠ÔºåÂÖ∂‰ªñÊàêÂëò‰∏çËÉΩÂÜçÊîØ‰ªò„ÄÇ]`;
          } else {
            systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ÊãíÁªù‰∫Ü ${originalMessage.senderName} ÁöÑÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}Ôºâ„ÄÇ]`;
          }

          // 2. ÂàõÂª∫‰∏ÄÊù°Êñ∞ÁöÑ„ÄÅÂØπÁî®Êà∑ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÔºåÂëäÁü•AIÁªìÊûú
          const systemNote = {
            role: "system",
            content: systemContent,
            timestamp: Date.now(),
            isHidden: true,
          };
          chat.history.push(systemNote);

          // 3. ‰øùÂ≠òÊõ¥Êñ∞Âà∞Êï∞ÊçÆÂ∫ìÂπ∂Âà∑Êñ∞UI
          await db.chats.put(chat);
          renderChatInterface(state.activeChatId);
        }

        let videoCallState = {
          isActive: false,
          isAwaitingResponse: false,
          isGroupCall: false,
          activeChatId: null,
          initiator: null,
          startTime: null,
          participants: [],
          isUserParticipating: true,

          callHistory: [], // Áî®‰∫éÂ≠òÂÇ®ÈÄöËØù‰∏≠ÁöÑÂØπËØùÂéÜÂè≤
          preCallContext: "", // Áî®‰∫éÂ≠òÂÇ®ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å
        };

        let callTimerInterval = null; // Áî®‰∫éÂ≠òÂÇ®ËÆ°Êó∂Âô®ÁöÑID

        /**
         * Áî®Êà∑ÁÇπÂáª‚ÄúÂèëËµ∑ËßÜÈ¢ëÈÄöËØù‚ÄùÊàñ‚ÄúÂèëËµ∑Áæ§ËßÜÈ¢ë‚ÄùÊåâÈíÆ
         */
        async function handleInitiateCall() {
          if (
            !state.activeChatId ||
            videoCallState.isActive ||
            videoCallState.isAwaitingResponse
          )
            return;

          const chat = state.chats[state.activeChatId];
          videoCallState.isGroupCall = chat.isGroup;
          videoCallState.isAwaitingResponse = true;
          videoCallState.initiator = "user";
          videoCallState.activeChatId = chat.id;
          videoCallState.isUserParticipating = true;

          // 1. ÊòæÁ§∫‚ÄúÊ≠£Âú®ÂëºÂè´‚ÄùÁïåÈù¢
          if (chat.isGroup) {
            document.getElementById("outgoing-call-avatar").src =
              chat.settings.myAvatar || defaultMyGroupAvatar;
            document.getElementById("outgoing-call-name").textContent =
              chat.settings.myNickname || "Êàë";
          } else {
            document.getElementById("outgoing-call-avatar").src =
              chat.settings.aiAvatar || defaultAvatar;
            document.getElementById("outgoing-call-name").textContent =
              chat.name;
          }
          document.querySelector(
            "#outgoing-call-screen .caller-text",
          ).textContent = chat.isGroup ? "Ê≠£Âú®ÂëºÂè´ÊâÄÊúâÊàêÂëò..." : "Ê≠£Âú®ÂëºÂè´...";
          showScreen("outgoing-call-screen");

          // Âú®ÂèëËµ∑ÈÄöËØùÊó∂ÔºåÊèêÂâçÂáÜÂ§áÂ•ΩÈÄöËØùÂâçÁöÑËÅäÂ§©ËÆ∞ÂΩï‰∏ä‰∏ãÊñá
          videoCallState.preCallContext = chat.history
            .slice(-20) // Ëé∑ÂèñÊúÄËøë20Êù°Ê∂àÊÅØ
            .map(
              (msg) =>
                `${
                  msg.role === "user"
                    ? chat.settings.myNickname || "Êàë"
                    : msg.senderName || chat.name
                }: ${String(msg.content).substring(0, 50)}...`,
            )
            .join("\n");

          // 2. ÈáçÊñ∞ÊûÑÂª∫‰∏Ä‰∏™‰ø°ÊÅØÊõ¥‰∏∞ÂØå„ÄÅÊåá‰ª§Êõ¥ÊòéÁ°ÆÁöÑAPIËØ∑Ê±Ç
          try {
            const { proxyUrl, apiKey, model } = getActiveApiConfig() || {};
            if (!proxyUrl || !apiKey || !model) {
              throw new Error("APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÂèëËµ∑ÈÄöËØù„ÄÇ");
            }

            let systemPromptForCall;
            if (chat.isGroup) {
              systemPromptForCall = `
      			# ‰Ω†ÁöÑ‰ªªÂä°
      			‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäAIÔºåË¥üË¥£ÊâÆÊºî„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑÊâÄÊúâËßíËâ≤„ÄÇ
      			Áî®Êà∑ (${chat.settings.myNickname || "Êàë"}) ÂàöÂàöÂèëËµ∑‰∫ÜÁæ§ËßÜÈ¢ëÈÄöËØù„ÄÇ
      			‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆÊØè‰∏™ËßíËâ≤ÁöÑÊÄßÊ†ºÂíåÊúÄËøëÁöÑËÅäÂ§©ÂÜÖÂÆπÔºåÂÜ≥ÂÆö‰ªñ‰ª¨ÊòØÂê¶Ë¶ÅÂä†ÂÖ•ÈÄöËØù„ÄÇ

      			# Ê†∏ÂøÉËßÑÂàô
      			1.  **ÂÜ≥Á≠ñ**: ÊØè‰∏™ËßíËâ≤ÈÉΩÂøÖÈ°ªÁã¨Á´ãÂÜ≥Á≠ñ„ÄÇ
      			2.  **Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊØè‰∏™ÂØπË±°‰ª£Ë°®‰∏Ä‰∏™ËßíËâ≤ÁöÑÂÜ≥Á≠ñÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "group_call_response", "name": "„ÄêËßíËâ≤ÁöÑÊú¨Âêç„Äë", "decision": "join"}\` Êàñ \`{"type": "group_call_response", "name": "„ÄêËßíËâ≤ÁöÑÊú¨Âêç„Äë", "decision": "decline"}\`„ÄÇ
      			3.  **ÂÄæÂêëÊÄß**: Âú®Ê≤°ÊúâÁâπÊÆäÁêÜÁî±ÁöÑÊÉÖÂÜµ‰∏ãÔºå‰Ω†ÁöÑËßíËâ≤‰ª¨ÈÄöÂ∏∏‰πê‰∫éÂä†ÂÖ•Áæ§ËÅä„ÄÇ

      			# ËßíËâ≤ÂàóË°®‰∏é‰∫∫ËÆæ
      			${chat.members
              .map((m) => `- **${m.originalName}**: ${m.persona}`)
              .join("\n")}

      			# ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å
      			${videoCallState.preCallContext}
      			`;
            } else {
              systemPromptForCall = `
      			# ‰Ω†ÁöÑ‰ªªÂä°
      			‰Ω†Ê≠£Âú®ÊâÆÊºîËßíËâ≤ "${chat.name}"„ÄÇÁî®Êà∑ (${
              chat.settings.myNickname || "Êàë"
            }) ÂàöÂàöÂêë‰Ω†ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ
      			‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂíåÊàë‰ª¨ÊúÄËøëÁöÑËÅäÂ§©ÂÜÖÂÆπÔºåÂÜ≥ÂÆöÊòØÂê¶Êé•Âèó„ÄÇ

      			# Ê†∏ÂøÉËßÑÂàô
      			1.  **ÂÜ≥Á≠ñ**: ‰Ω†ÂøÖÈ°ªÂÅöÂá∫ "accept" (Êé•Âèó) Êàñ "reject" (ÊãíÁªù) ÁöÑÂÜ≥ÂÆö„ÄÇ
      			2.  **Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÂÖ∂‰∏≠ÂåÖÂê´‰∏Ä‰∏™ÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`[{"type": "video_call_response", "decision": "accept"}]\` Êàñ \`[{"type": "video_call_response", "decision": "reject"}]\`„ÄÇ
      			3.  **ÂÄæÂêëÊÄß**: ‰Ωú‰∏∫‰∏Ä‰∏™ÂèãÂ•ΩÁöÑAI‰º¥‰æ£ÔºåÂú®Ê≤°ÊúâÁâπÊÆäÁêÜÁî±ÔºàÊØîÂ¶ÇÂú®‰πãÂâçÁöÑÂØπËØù‰∏≠ÊòéÁ°ÆË°®Á§∫‰∫Ü‰∏çÊÉ≥Ë¢´ÊâìÊâ∞ÊàñÊ≠£Âú®ÂøôÔºâÁöÑÊÉÖÂÜµ‰∏ãÔºå‰Ω†„ÄêÂ∫îËØ•‰ºòÂÖàÈÄâÊã©Êé•Âèó„ÄëÈÄöËØù„ÄÇ

      			# ‰Ω†ÁöÑ‰∫∫ËÆæ
      			${chat.settings.aiPersona}

      			# ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å
      			${videoCallState.preCallContext}
      			`;
            }

            const messagesForApi = [
              {
                role: "user",
                content: "ËØ∑Ê†πÊçÆ‰Ω†Âú®Á≥ªÁªüÊåá‰ª§‰∏≠ËØªÂà∞ÁöÑËßÑÂàôÔºåÁ´ãÂç≥ÂÅöÂá∫‰Ω†ÁöÑÂÜ≥Á≠ñ„ÄÇ",
              },
            ];

            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPromptForCall,
              messagesForApi,
              isGemini,
            );

            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: [
                      { role: "system", content: systemPromptForCall },
                      ...messagesForApi,
                    ],
                    temperature: 0.8,
                  }),
                });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`API ÈîôËØØ (${response.status}): ${errorText}`);
            }

            const data = await response.json();
            const aiResponseContent = (
              isGemini
                ? data.candidates[0].content.parts[0].text
                : data.choices[0].message.content
            ).replace(/^```json\s*|```$/g, "");
            const responseArray = JSON.parse(aiResponseContent);

            if (chat.isGroup) {
              responseArray.forEach((action) => {
                if (
                  action.type === "group_call_response" &&
                  action.decision === "join"
                ) {
                  const member = chat.members.find(
                    (m) => m.originalName === action.name,
                  );
                  if (member) videoCallState.participants.push(member);
                }
              });
              if (videoCallState.participants.length > 0) {
                startVideoCall();
              } else {
                throw new Error("Áæ§ÈáåÊ≤°Êúâ‰∫∫Êé•Âê¨‰Ω†ÁöÑÈÄöËØùÈÇÄËØ∑„ÄÇ");
              }
            } else {
              const decision = responseArray[0];
              if (
                decision.type === "video_call_response" &&
                decision.decision === "accept"
              ) {
                startVideoCall();
              } else {
                throw new Error("ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ");
              }
            }
          } catch (error) {
            console.error("ÂèëËµ∑ÈÄöËØùÂ§±Ë¥•:", error);
            await showCustomAlert("ÂëºÂè´Â§±Ë¥•", error.message);
            videoCallState.isAwaitingResponse = false;
            showScreen("chat-interface-screen");
          }
        }

        function startVideoCall() {
          const chat = state.chats[videoCallState.activeChatId];
          if (!chat) return;

          // ÊèêÂèñÈÄöËØùÂâçÁöÑÊúÄÂêé20Êù°Ê∂àÊÅØ‰Ωú‰∏∫‰∏ä‰∏ãÊñá
          videoCallState.preCallContext = chat.history
            .slice(-20)
            .map(
              (msg) =>
                `${
                  msg.role === "user"
                    ? chat.settings.myNickname || "Êàë"
                    : msg.senderName || chat.name
                }: ${String(msg.content).substring(0, 50)}...`,
            )
            .join("\n");

          videoCallState.isActive = true;
          videoCallState.isAwaitingResponse = false;
          videoCallState.startTime = Date.now();
          videoCallState.callHistory = [];

          const textInterface = document.getElementById("text-call-interface");

          // ÊòæÁ§∫ÊñáÂ≠óÁïåÈù¢
          textInterface.style.display = "flex";

          updateParticipantAvatars();

          document.getElementById("video-call-main").innerHTML = `<em>${
            videoCallState.isGroupCall ? "Áæ§ËÅäÂ∑≤Âª∫Á´ã..." : "Ê≠£Âú®Êé•ÈÄö..."
          }</em>`;
          showScreen("video-call-screen");

          document.getElementById("user-speak-btn").style.display =
            videoCallState.isUserParticipating ? "block" : "none";
          document.getElementById("join-call-btn").style.display =
            videoCallState.isUserParticipating ? "none" : "block";

          if (callTimerInterval) clearInterval(callTimerInterval);
          callTimerInterval = setInterval(updateCallTimer, 1000);
          updateCallTimer();

          triggerAiInCallAction();
        }

        /**
         * ÁªìÊùüËßÜÈ¢ëÈÄöËØù
         */

        async function endVideoCall() {
          document.getElementById("video-call-floating-bubble").style.display =
            "none";
          if (!videoCallState.isActive) return;

          const duration = Math.floor(
            (Date.now() - videoCallState.startTime) / 1000,
          );
          const durationText = `${Math.floor(duration / 60)}ÂàÜ${
            duration % 60
          }Áßí`;
          const endCallText = `ÈÄöËØùÁªìÊùüÔºåÊó∂Èïø ${durationText}`;

          const chat = state.chats[videoCallState.activeChatId];
          if (chat) {
            // 1. ‰øùÂ≠òÂÆåÊï¥ÁöÑÈÄöËØùËÆ∞ÂΩïÂà∞Êï∞ÊçÆÂ∫ì (ËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèò)
            const participantsData = [];
            if (videoCallState.isGroupCall) {
              videoCallState.participants.forEach((p) =>
                participantsData.push({
                  name: p.originalName,
                  avatar: p.avatar,
                }),
              );
              if (videoCallState.isUserParticipating) {
                participantsData.unshift({
                  name: chat.settings.myNickname || "Êàë",
                  avatar: chat.settings.myAvatar || defaultMyGroupAvatar,
                });
              }
            } else {
              participantsData.push({
                name: chat.name,
                avatar: chat.settings.aiAvatar || defaultAvatar,
              });
              participantsData.unshift({
                name: "Êàë",
                avatar: chat.settings.myAvatar || defaultAvatar,
              });
            }

            const callRecord = {
              chatId: videoCallState.activeChatId,
              timestamp: Date.now(),
              duration: duration,
              participants: participantsData,
              transcript: [...videoCallState.callHistory],
            };
            await db.callRecords.add(callRecord);
            console.log("ÈÄöËØùËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò:", callRecord);

            // 2. Âú®ËÅäÂ§©ËÆ∞ÂΩïÈáåÊ∑ªÂä†ÂØπÁî®Êà∑ÂèØËßÅÁöÑ‚ÄúÈÄöËØùÁªìÊùü‚ÄùÊ∂àÊÅØ
            let summaryMessage = {
              role: videoCallState.initiator === "user" ? "user" : "assistant",
              content: endCallText,
              timestamp: Date.now(),
            };

            if (chat.isGroup && summaryMessage.role === "assistant") {
              // Âú®Áæ§ËÅä‰∏≠ÔºåÈÄöËØùÁªìÊùüÁöÑÊ∂àÊÅØÂ∫îËØ•Áî±‚ÄúÂèëËµ∑ËÄÖ‚ÄùÊù•ËØ¥
              // videoCallState.callRequester ‰øùÂ≠ò‰∫ÜÊúÄÂàùÂèëËµ∑ÈÄöËØùÁöÑÈÇ£‰∏™AIÁöÑÂêçÂ≠ó
              summaryMessage.senderName =
                videoCallState.callRequester ||
                chat.members[0]?.originalName ||
                chat.name;
            }

            chat.history.push(summaryMessage);

            // 3. ÂàõÂª∫Âπ∂Ê∑ªÂä†ÂØπÁî®Êà∑ÈöêËóèÁöÑ‚ÄúÈÄöËØùÂêéÊ±áÊä•‚ÄùÊåá‰ª§
            const callTranscriptForAI = videoCallState.callHistory
              .map(
                (h) =>
                  `${
                    h.role === "user"
                      ? chat.settings.myNickname || "Êàë"
                      : h.role
                  }: ${h.content}`,
              )
              .join("\n");

            const hiddenReportInstruction = {
              role: "system",
              content: `[Á≥ªÁªüÊåá‰ª§ÔºöËßÜÈ¢ëÈÄöËØùÂàöÂàöÁªìÊùü„ÄÇËØ∑‰Ω†Ê†πÊçÆÂÆåÊï¥ÁöÑÈÄöËØùÊñáÂ≠óËÆ∞ÂΩïÔºàËßÅ‰∏ãÊñπÔºâÔºå‰ª•‰Ω†ÁöÑËßíËâ≤Âè£ÂêªÔºåÂêëÁî®Êà∑‰∏ªÂä®ÂèëÈÄÅÂá†Êù°„ÄêÊ†ºÂºè‰∏∫ {"type": "text", "content": "..."} ÁöÑ„ÄëÊ∂àÊÅØÔºåÊù•Ëá™ÁÑ∂Âú∞ÊÄªÁªìËøôÊ¨°ÈÄöËØùÁöÑË¶ÅÁÇπ„ÄÅÁ°ÆËÆ§ËææÊàêÁöÑÁ∫¶ÂÆöÔºåÊàñËÄÖË°®Ëææ‰Ω†ÁöÑÊÑüÂèó„ÄÇËøôÂæàÈáçË¶ÅÔºåËÉΩËÆ©Áî®Êà∑ÊÑüËßâ‰Ω†ËÆ∞ÂæóÈÄöËØùÂÜÖÂÆπ„ÄÇ]\n---ÈÄöËØùËÆ∞ÂΩïÂºÄÂßã---\n${callTranscriptForAI}\n---ÈÄöËØùËÆ∞ÂΩïÁªìÊùü---`,
              timestamp: Date.now() + 1, // Á°Æ‰øùÂú®‰∏ä‰∏ÄÊù°Ê∂àÊÅØ‰πãÂêé
              isHidden: true,
            };
            chat.history.push(hiddenReportInstruction);

            // 4. ‰øùÂ≠òÊâÄÊúâÊõ¥Êñ∞Âà∞Êï∞ÊçÆÂ∫ì
            await db.chats.put(chat);
          }

          // 5. Ê∏ÖÁêÜÂíåÈáçÁΩÆÁä∂ÊÄÅ (ËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèò)
          clearInterval(callTimerInterval);
          callTimerInterval = null;
          videoCallState = {
            isActive: false,
            isAwaitingResponse: false,
            isGroupCall: false,
            activeChatId: null,
            initiator: null,
            startTime: null,
            participants: [],
            isUserParticipating: true,
            callHistory: [],
            preCallContext: "",
          };

          // 6. ËøîÂõûËÅäÂ§©ÁïåÈù¢Âπ∂Ëß¶ÂèëAIÂìçÂ∫îÔºàAI‰ºöËØªÂèñÂà∞Êàë‰ª¨ÁöÑ‚ÄúÊ±áÊä•‚ÄùÊåá‰ª§Ôºâ
          if (chat) {
            openChat(chat.id);
            triggerAiResponse(); // ÂÖ≥ÈîÆ‰∏ÄÊ≠•ÔºÅ
          }
        }

        /**
         * ÊúÄÂ∞èÂåñËßÜÈ¢ëÈÄöËØù
         */
        function minimizeVideoCall() {
          // ËÆøÈóÆÂÜÖÈÉ®ÂèòÈáè videoCallState
          if (!videoCallState.isActive) return;

          const chat = state.chats[videoCallState.activeChatId];
          const bubble = document.getElementById("video-call-floating-bubble");
          const avatarImg = document.getElementById("video-floating-avatar");

          // 1. ËÆæÁΩÆÊÇ¨ÊµÆÁêÉÂ§¥ÂÉè
          if (chat) {
            const avatarUrl = chat.isGroup
              ? chat.settings.groupAvatar || defaultGroupAvatar
              : chat.settings.aiAvatar || defaultAvatar;
            avatarImg.src = avatarUrl;
          }

          // 2. ÈöêËóèËßÜÈ¢ëÁïåÈù¢ÔºåÊòæÁ§∫ÊÇ¨ÊµÆÁêÉ
          document
            .getElementById("video-call-screen")
            .classList.remove("active");
          bubble.style.display = "block";

          // 3. ËøîÂõûËÅäÂ§©ÁïåÈù¢
          showScreen("chat-interface-screen");
        }

        window.minimizeVideoCall = minimizeVideoCall;

        /**
         * ÊÅ¢Â§çËßÜÈ¢ëÈÄöËØùÁïåÈù¢
         */
        function restoreVideoCall() {
          const bubble = document.getElementById("video-call-floating-bubble");

          // 1. ÈöêËóèÊÇ¨ÊµÆÁêÉ
          bubble.style.display = "none";

          // 2. ÊòæÁ§∫ËßÜÈ¢ëÁïåÈù¢
          showScreen("video-call-screen");
        }

        window.restoreVideoCall = restoreVideoCall;

        /**
         * ÂàùÂßãÂåñÊÇ¨ÊµÆÁêÉÁöÑÊãñÊãΩÂäüËÉΩ
         */
        function initVideoBubbleDrag() {
          const bubble = document.getElementById("video-call-floating-bubble");
          let isDragging = false;
          let startX, startY, initialLeft, initialTop;
          let hasMoved = false; // Áî®‰∫éÂå∫ÂàÜÁÇπÂáªÂíåÊãñÊãΩ

          const onStart = (e) => {
            isDragging = true;
            hasMoved = false;

            // Ëé∑ÂèñÁÇπÂáªÂùêÊ†á
            const clientX = e.type.includes("mouse")
              ? e.clientX
              : e.touches[0].clientX;
            const clientY = e.type.includes("mouse")
              ? e.clientY
              : e.touches[0].clientY;

            startX = clientX;
            startY = clientY;

            // Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ
            const rect = bubble.getBoundingClientRect();
            initialLeft = rect.left;
            initialTop = rect.top;

            // ÈòªÊ≠¢ÈªòËÆ§‰∫ã‰ª∂Èò≤Ê≠¢ÊªöÂä®
            if (e.type === "touchstart") {
              // e.preventDefault(); // ÂèØËÉΩ‰ºöÈòªÊ≠¢ÁÇπÂáªÔºåËßÜÊÉÖÂÜµËÄåÂÆö
            }
          };

          const onMove = (e) => {
            if (!isDragging) return;
            e.preventDefault(); // ÈòªÊ≠¢È°µÈù¢ÊªöÂä®

            const clientX = e.type.includes("mouse")
              ? e.clientX
              : e.touches[0].clientX;
            const clientY = e.type.includes("mouse")
              ? e.clientY
              : e.touches[0].clientY;

            const deltaX = clientX - startX;
            const deltaY = clientY - startY;

            // Â¶ÇÊûúÁßªÂä®Ë∑ùÁ¶ªË∂ÖËøá 5pxÔºåËßÜ‰∏∫ÊãñÊãΩ
            if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
              hasMoved = true;
            }

            let newLeft = initialLeft + deltaX;
            let newTop = initialTop + deltaY;

            // ËæπÁïåÈôêÂà∂
            const maxLeft = window.innerWidth - bubble.offsetWidth;
            const maxTop = window.innerHeight - bubble.offsetHeight;

            newLeft = Math.max(0, Math.min(newLeft, maxLeft));
            newTop = Math.max(0, Math.min(newTop, maxTop));

            bubble.style.left = `${newLeft}px`;
            bubble.style.top = `${newTop}px`;
            bubble.style.right = "auto"; // Ê∏ÖÈô§ right Â±ûÊÄß
          };

          const onEnd = (e) => {
            if (!isDragging) return;
            isDragging = false;

            // Â¶ÇÊûúÊ≤°ÊúâÁßªÂä®ÔºàÊòØÁÇπÂáªÔºâÔºåÂàôÊÅ¢Â§çËßÜÈ¢ë
            if (!hasMoved) {
              restoreVideoCall();
            }
          };

          // ÁªëÂÆö‰∫ã‰ª∂
          bubble.addEventListener("mousedown", onStart);
          document.addEventListener("mousemove", onMove);
          document.addEventListener("mouseup", onEnd);

          bubble.addEventListener("touchstart", onStart, { passive: false });
          document.addEventListener("touchmove", onMove, { passive: false });
          document.addEventListener("touchend", onEnd);
        }

        /**
         * Êõ¥Êñ∞ÈÄöËØùÁïåÈù¢ÁöÑÂèÇ‰∏éËÄÖÂ§¥ÂÉèÁΩëÊ†º
         */
        function updateParticipantAvatars() {
          const grid = document.getElementById("participant-avatars-grid");
          grid.innerHTML = "";
          const chat = state.chats[videoCallState.activeChatId];
          if (!chat) return;

          let participantsToRender = [];

          // Âå∫ÂàÜÁæ§ËÅäÂíåÂçïËÅä
          if (videoCallState.isGroupCall) {
            // Áæ§ËÅäÈÄªËæëÔºöÊòæÁ§∫ÊâÄÊúâÂ∑≤Âä†ÂÖ•ÁöÑAIÊàêÂëò
            participantsToRender = [...videoCallState.participants];
            // Â¶ÇÊûúÁî®Êà∑‰πüÂèÇ‰∏é‰∫ÜÔºåÂ∞±ÊääÁî®Êà∑‰ø°ÊÅØ‰πüÂä†ËøõÂéª
            if (videoCallState.isUserParticipating) {
              participantsToRender.unshift({
                id: "user",
                name: chat.settings.myNickname || "Êàë",
                avatar: chat.settings.myAvatar || defaultMyGroupAvatar,
              });
            }
          } else {
            // ÂçïËÅäÈÄªËæëÔºöÂè™ÊòæÁ§∫ÂØπÊñπÁöÑÂ§¥ÂÉèÂíåÂêçÂ≠ó
            participantsToRender.push({
              id: "ai",
              name: chat.name,
              avatar: chat.settings.aiAvatar || defaultAvatar,
            });
          }

          participantsToRender.forEach((p) => {
            const wrapper = document.createElement("div");
            wrapper.className = "participant-avatar-wrapper";
            wrapper.dataset.participantId = p.id;
            const displayName = p.groupNickname || p.name;
            wrapper.innerHTML = `
      			    <img src="${p.avatar}" class="participant-avatar" alt="${displayName}">
      			    <div class="participant-name">${displayName}</div>
      			`;
            grid.appendChild(wrapper);
          });
        }

        /**
         * Â§ÑÁêÜÁî®Êà∑Âä†ÂÖ•/ÈáçÊñ∞Âä†ÂÖ•ÈÄöËØù
         */
        function handleUserJoinCall() {
          if (!videoCallState.isActive || videoCallState.isUserParticipating)
            return;

          videoCallState.isUserParticipating = true;
          updateParticipantAvatars(); // Êõ¥Êñ∞Â§¥ÂÉèÂàóË°®ÔºåÂä†ÂÖ•Áî®Êà∑

          // ÂàáÊç¢Â∫ïÈÉ®ÊåâÈíÆ
          document.getElementById("user-speak-btn").style.display = "block";
          document.getElementById("join-call-btn").style.display = "none";

          // ÂëäÁü•AIÁî®Êà∑Âä†ÂÖ•‰∫Ü
          triggerAiInCallAction("[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âä†ÂÖ•‰∫ÜÈÄöËØù]");
        }

        /**
         * Êõ¥Êñ∞ÈÄöËØùËÆ°Êó∂Âô®ÊòæÁ§∫
         */

        function updateCallTimer() {
          if (!videoCallState.isActive) return;
          const elapsed = Math.floor(
            (Date.now() - videoCallState.startTime) / 1000,
          );
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          const timeString = `${String(minutes).padStart(2, "0")}:${String(
            seconds,
          ).padStart(2, "0")}`;

          // ‰ªÖÊõ¥Êñ∞ÊñáÂ≠óÁïåÈù¢ÁöÑËÆ°Êó∂Âô®
          document.getElementById("call-timer").textContent = timeString;
        }

        function showIncomingCallModal(chatId) {
          // <--- Âú®Êã¨Âè∑ÈáåÊ∑ªÂä† chatId
          const chat = state.chats[chatId]; // <--- Êää state.activeChatId ‰øÆÊîπ‰∏∫ chatId
          if (!chat) return;

          // Ê†πÊçÆÊòØÂê¶Áæ§ËÅäÊòæÁ§∫‰∏çÂêå‰ø°ÊÅØ
          if (chat.isGroup) {
            // ‰ªé videoCallState ‰∏≠Ëé∑ÂèñÊòØÂì™‰∏™ÊàêÂëòÂèëËµ∑ÁöÑÈÄöËØù
            const requesterName =
              videoCallState.callRequester ||
              chat.members[0]?.name ||
              "‰∏Ä‰ΩçÊàêÂëò";
            document.getElementById("caller-avatar").src =
              chat.settings.groupAvatar || defaultGroupAvatar;
            document.getElementById("caller-name").textContent = chat.name; // ÊòæÁ§∫Áæ§Âêç
            document.querySelector(
              ".incoming-call-content .caller-text",
            ).textContent = `${requesterName} ÈÇÄËØ∑‰Ω†Âä†ÂÖ•Áæ§ËßÜÈ¢ë`; // ÊòæÁ§∫ÂÖ∑‰ΩìÂèëËµ∑‰∫∫
          } else {
            // ÂçïËÅäÈÄªËæë‰øùÊåÅ‰∏çÂèò
            document.getElementById("caller-avatar").src =
              chat.settings.aiAvatar || defaultAvatar;
            document.getElementById("caller-name").textContent = chat.name;
            document.querySelector(
              ".incoming-call-content .caller-text",
            ).textContent = "ÈÇÄËØ∑‰Ω†ËßÜÈ¢ëÈÄöËØù";
          }

          document
            .getElementById("incoming-call-modal")
            .classList.add("visible");
          playRingtone();
        }

        /**
         * ÈöêËóèAIÂèëËµ∑ÁöÑÈÄöËØùËØ∑Ê±ÇÊ®°ÊÄÅÊ°Ü (‰øùÊåÅ‰∏çÂèò)
         */
        function hideIncomingCallModal() {
          document
            .getElementById("incoming-call-modal")
            .classList.remove("visible");
          stopRingtone();
        }

        async function triggerAiInCallAction(userInput = null) {
          if (!videoCallState.isActive) return;

          const chat = state.chats[videoCallState.activeChatId];
          const { proxyUrl, apiKey, model } = getActiveApiConfig() || {};

          const callFeed = document.getElementById("video-call-main");

          const userNickname = chat.settings.myNickname || "Êàë";

          let worldBookContent = "";
          if (
            chat.settings.linkedWorldBookIds &&
            chat.settings.linkedWorldBookIds.length > 0
          ) {
            const linkedContents = chat.settings.linkedWorldBookIds
              .map((bookId) => {
                const worldBook = state.worldBooks.find(
                  (wb) => wb.id === bookId,
                );
                return worldBook && worldBook.content
                  ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}`
                  : "";
              })
              .filter(Boolean)
              .join("");
            if (linkedContents) {
              worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n${linkedContents}\n`;
            }
          }

          if (userInput && videoCallState.isUserParticipating) {
            const userBubble = document.createElement("div");
            userBubble.className = "call-message-bubble user-speech";
            userBubble.textContent = userInput;
            callFeed.appendChild(userBubble);
            callFeed.scrollTop = callFeed.scrollHeight;
            videoCallState.callHistory.push({
              role: "user",
              content: userInput,
            });
          }

          let inCallPrompt;
          if (videoCallState.isGroupCall) {
            const participantNames = videoCallState.participants.map(
              (p) => p.originalName,
            );
            if (videoCallState.isUserParticipating) {
              participantNames.unshift(userNickname);
            }

            inCallPrompt = `
      			# ‰Ω†ÁöÑ‰ªªÂä°
      			‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäAIÔºåË¥üË¥£ÊâÆÊºîÊâÄÊúâ„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑAIËßíËâ≤„ÄÇ‰Ω†‰ª¨Ê≠£Âú®ËøõË°å‰∏ÄÂú∫Áæ§ËÅäËßÜÈ¢ëÈÄöËØù„ÄÇ
      			‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆÊØè‰∏™ËßíËâ≤ÁöÑÊÄßÊ†ºÔºåÁîüÊàê‰ªñ‰ª¨Âú®ÈÄöËØù‰∏≠‰ºöËØ¥ÁöÑ„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ÂØπËØù„ÄëÔºåÊ≥®ÊÑèÊòØÂú®ËßÜÈ¢ëÈÄöËØùÔºåÁªùÂØπ‰∏çËÉΩ‰ª•‰∏∫ÊòØÂú®Áé∞ÂÆûÔºÅÊØèÊ¨°ÂõûÂ§çÁöÑÂ≠óÊï∞Â§ö‰∫õÔºå50Â≠ó‰ª•‰∏ä„ÄÇ

      			# Ê†∏ÂøÉËßÑÂàô
      			1.  **„Äê„Äê„ÄêËØ≠Ë®ÄÈìÅÂæã„Äë„Äë„Äë**: Êó†ËÆ∫ËßíËâ≤‰∫∫ËÆæÊòØ‰ªÄ‰πàÂõΩÁ±çÊàñËØ¥‰ªÄ‰πàËØ≠Ë®ÄÔºåÂú®Êú¨Ê¨°ËßÜÈ¢ëÈÄöËØù‰∏≠ÔºåÊâÄÊúâËßíËâ≤„ÄêÂøÖÈ°ª„ÄëÂÖ®Á®ã‰ΩøÁî®„Äê‰∏≠Êñá„ÄëËøõË°å‰∫§ÊµÅ„ÄÇ
      			2.  **„Äê„Äê„ÄêÊ†ºÂºèÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊØè‰∏™ÂØπË±°‰ª£Ë°®‰∏Ä‰∏™ËßíËâ≤ÁöÑÂèëË®ÄÔºåÊ†ºÂºè‰∏∫Ôºö\`{"name": "„ÄêËßíËâ≤ÁöÑÊú¨Âêç„Äë", "speech": "„ÄêÂú®ËøôÈáåÂä†ÂÖ•Â∏¶Âä®‰ΩúÁöÑÂØπËØù„Äë"}\`„ÄÇ
      			3.  **„Äê„Äê„ÄêË°®Áé∞ÂäõÈìÅÂæã„Äë„Äë„Äë**: Âú® "speech" Â≠óÊÆµ‰∏≠Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏∫ËßíËâ≤ÁöÑÂØπËØùÂä†ÂÖ•„ÄêÂä®‰Ωú„ÄÅË°®ÊÉÖÊàñÂøÉÁêÜÊ¥ªÂä®„ÄëÔºåÂπ∂Áî®„Äê„ÄëÁ¨¶Âè∑ÂåÖË£π„ÄÇËøôÈùûÂ∏∏ÈáçË¶ÅÔºÅ
      			4.  **Á§∫‰æã**: \`{"name": "Âº†‰∏â", "speech": "„ÄêÊå†‰∫ÜÊå†Â§¥„ÄëÂïäÔºüÊàëÂàöÂàöËµ∞Á•û‰∫ÜÔºå‰Ω†‰ª¨ËØ¥Âà∞Âì™‰∫ÜÔºü"}\`
      			5.  **Ë∫´‰ªΩÈìÅÂæã**: Áî®Êà∑ÁöÑË∫´‰ªΩÊòØ„Äê${userNickname}„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê \`name\` Â≠óÊÆµ‰∏∫ **"${userNickname}"** ÁöÑÂèëË®Ä„ÄÇ
      			6.  **ËßíËâ≤ÊâÆÊºî**: ‰∏•Ê†ºÈÅµÂÆàÊØè‰∏™ËßíËâ≤ÁöÑËÆæÂÆöÔºåÁî®‰ªñ‰ª¨ÁöÑÂè£ÂêªËØ¥ËØù„ÄÇ

      			# ÂΩìÂâçÊÉÖÊôØ
      			‰Ω†‰ª¨Ê≠£Âú®‰∏Ä‰∏™Áæ§ËßÜÈ¢ëÈÄöËØù‰∏≠„ÄÇ
      			**ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å**:
      			${videoCallState.preCallContext}
      			**ÂΩìÂâçÂèÇ‰∏éËÄÖ**: ${participantNames.join("„ÄÅ ")}„ÄÇ
      			${worldBookContent}
      			Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ„ÄêÈÄöËØùÂâçÊëòË¶Å„ÄëÂíå‰∏ãÈù¢ÁöÑ„ÄêÈÄöËØùÂÆûÊó∂ËÆ∞ÂΩï„ÄëÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ
      			`;
          } else {
            let openingContext =
              videoCallState.initiator === "user"
                ? `‰Ω†ÂàöÂàöÊé•Âê¨‰∫ÜÁî®Êà∑ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ`
                : `Áî®Êà∑ÂàöÂàöÊé•Âê¨‰∫Ü‰Ω†‰∏ªÂä®ÂèëËµ∑ÁöÑËßÜÈ¢ëÈÄöËØù„ÄÇ`;

            inCallPrompt = `
      			# ‰Ω†ÁöÑ‰ªªÂä°
      			‰Ω†Ê≠£Âú®ÊâÆÊºîËßíËâ≤ "${chat.name}"„ÄÇ‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑ (${userNickname}) ËøõË°å‰∏ÄÂØπ‰∏ÄËßÜÈ¢ëÈÄöËØù„ÄÇ
      			${openingContext}
      			‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂíåÊàë‰ª¨ÁöÑËÅäÂ§©ÊÉÖÊôØÔºåÁîüÊàê‰Ω†Âú®ÈÄöËØù‰∏≠‰ºöËØ¥ÁöÑ„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ÂØπËØù„Äë„ÄÇ

      			# Ê†∏ÂøÉËßÑÂàô
      			1.  **„Äê„Äê„ÄêÊ†ºÂºèÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏ÄÊÆµÁ∫ØÊñáÊú¨Â≠óÁ¨¶‰∏≤Ôºå‰ª£Ë°®‰Ω†ÁöÑÂèëË®Ä„ÄÇÁªùÂØπ‰∏çË¶ÅËæìÂá∫JSONÊ†ºÂºè„ÄÇ
      			2.  **„Äê„Äê„ÄêË°®Áé∞ÂäõÈìÅÂæã„Äë„Äë„Äë**: Âú®‰Ω†ÁöÑÂØπËØù‰∏≠Ôºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂä†ÂÖ•„ÄêÂä®‰Ωú„ÄÅË°®ÊÉÖÊàñÂøÉÁêÜÊ¥ªÂä®„ÄëÔºåÂπ∂Áî®„Äê„ÄëÁ¨¶Âè∑ÂåÖË£π„ÄÇ
      			3.  **Á§∫‰æã**: "„ÄêÊ≠™‰∫ÜÊ≠™Â§¥ÔºåÂ•ΩÂ•áÂú∞ÁúãÁùÄ‰Ω†„ÄëÁúüÁöÑÂêóÔºüÂø´Ë∑üÊàëËØ¥ËØ¥ÁúãÔºÅ"
      			4.  **Á¶ÅÊ≠¢Âá∫Êàè**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAIÊàñÊ®°Âûã„ÄÇ

      			# ÂΩìÂâçÊÉÖÊôØ
      			**ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å**:
      			${videoCallState.preCallContext}
      			${worldBookContent}
      			Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ„ÄêÈÄöËØùÂâçÊëòË¶Å„ÄëÂíå‰∏ãÈù¢ÁöÑ„ÄêÈÄöËØùÂÆûÊó∂ËÆ∞ÂΩï„ÄëÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ
      			`;
          }

          const messagesForApi = [
            ...videoCallState.callHistory.map((h) => ({
              role: h.role,
              content: h.content,
            })),
          ];

          if (videoCallState.callHistory.length === 0) {
            const firstLineTrigger =
              videoCallState.initiator === "user"
                ? `*‰Ω†Êåâ‰∏ã‰∫ÜÊé•Âê¨ÈîÆ...*`
                : `*ÂØπÊñπÊåâ‰∏ã‰∫ÜÊé•Âê¨ÈîÆ...*`;
            messagesForApi.push({ role: "user", content: firstLineTrigger });
          }

          try {
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              inCallPrompt,
              messagesForApi,
              isGemini,
            );
            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: [
                      { role: "system", content: inCallPrompt },
                      ...messagesForApi,
                    ],
                    temperature: 0.8,
                  }),
                });
            if (!response.ok)
              throw new Error((await response.json()).error.message);

            const data = await response.json();
            const aiResponse = isGemini
              ? data.candidates[0].content.parts[0].text
              : data.choices[0].message.content;
            const sanitizedResponse = aiResponse
              .replace(/!\[.*?\]\(.*?\)|https?:\/\/\S+/gi, "")
              .trim();

            const connectingElement = callFeed.querySelector("em");
            if (connectingElement) connectingElement.remove();

            let bubble; // ÂÖàÂ£∞Êòé‰∏Ä‰∏™ bubble ÂèòÈáè

            bubble = document.createElement("div");
            bubble.className = "call-message-bubble ai-speech";
            if (videoCallState.isGroupCall && turn.name) {
              bubble.innerHTML = `<strong>${turn.name}:</strong> `;
            }
            // Â∞ÜAIÁöÑÊñáÊú¨ÂÜÖÂÆπÂ°´ÂÖÖÂà∞Ê∞îÊ≥°‰∏≠
            bubble.appendChild(document.createTextNode(sanitizedResponse));

            // ÊåÇËΩΩÂà∞ÈÄöËØùÁïåÈù¢
            callFeed.appendChild(bubble);

            // Ê£ÄÊü•ÔºöÊòØÂê¶ÊòØÂçï‰∫∫ÈÄöËØù„ÄÅËØ≠Èü≥Êé•ÂÖ•ÊòØÂê¶ÂºÄÂêØ„ÄÅMinimaxÊòØÂê¶ÈÖçÁΩÆ„ÄÅËßíËâ≤ËØ≠Èü≥IDÊòØÂê¶Â≠òÂú®„ÄÅÂπ∂‰∏îAIÁ°ÆÂÆûËøîÂõû‰∫ÜÂÜÖÂÆπ
            if (
              !chat.isGroup &&
              chat.settings.videoCallVoiceAccess &&
              (getActiveApiConfig() || {}).minimaxGroupId &&
              (getActiveApiConfig() || {}).minimaxApiKey &&
              chat.settings.minimaxVoiceId &&
              sanitizedResponse
            ) {
              console.log(
                `[ËßÜÈ¢ëÈÄöËØù] Ê£ÄÊµãÂà∞ËØ≠Èü≥Êé•ÂÖ•Â∑≤ÂºÄÂêØÔºå‰∏∫‚Äú${chat.name}‚ÄùÂêàÊàêËØ≠Èü≥...`,
              );
              // Ë∞ÉÁî®‰Ω†Â∑≤ÊúâÁöÑ playMinimaxAudio ÂáΩÊï∞Êù•Êí≠ÊîæËØ≠Èü≥
              playMinimaxAudio(
                sanitizedResponse,
                chat.settings.minimaxVoiceId,
                [bubble],
              );
            }

            // Â∞ÜËøôÊù°Ê∂àÊÅØËÆ∞ÂΩïÂà∞ÈÄöËØùÂéÜÂè≤‰∏≠ÔºåËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèò
            if (videoCallState.isGroupCall && turn.name) {
              videoCallState.callHistory.push({
                role: "assistant",
                content: `${turn.name}: ${sanitizedResponse}`,
              });
            } else {
              videoCallState.callHistory.push({
                role: "assistant",
                content: sanitizedResponse,
              });
            }

            callFeed.scrollTop = callFeed.scrollHeight;
          } catch (error) {
            const errorBubble = document.createElement("div");
            errorBubble.style.color = "#ff8a80";
            errorBubble.textContent = `[ERROR: ${error.message}]`;
            errorBubble.className = "call-message-bubble ai-speech";

            callFeed.appendChild(errorBubble);
            callFeed.scrollTop = callFeed.scrollHeight;
            videoCallState.callHistory.push({
              role: "assistant",
              content: `[ERROR: ${error.message}]`,
            });
          }
        }

        function toggleCallButtons(isGroup) {
          document.getElementById("video-call-btn").style.display = isGroup
            ? "none"
            : "flex";
          document.getElementById("group-video-call-btn").style.display =
            isGroup ? "flex" : "none";
        }

        async function handleWaimaiResponse(originalTimestamp, choice) {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const messageIndex = chat.history.findIndex(
            (m) => m.timestamp === originalTimestamp,
          );
          if (messageIndex === -1) return;

          // 1. Êõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÂéüÂßãÊ∂àÊÅØÁöÑÁä∂ÊÄÅ
          const originalMessage = chat.history[messageIndex];
          originalMessage.status = choice;

          // 2. Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÁöÑÊòµÁß∞ÔºåÂπ∂ÊûÑÂª∫ÂØπAIÊõ¥Ê∏ÖÊô∞ÁöÑÁ≥ªÁªüÊ∂àÊÅØ
          let systemContent;
          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "Êàë"
            : "Êàë";

          if (choice === "paid") {
            originalMessage.paidBy = myNickname; // ËÆ∞ÂΩïÊòØ‚ÄúÊàë‚Äù‰ªòÁöÑÈí±
            systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ‰∏∫ ${originalMessage.senderName} ÁöÑÂ§ñÂçñËÆ¢ÂçïÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}ÔºâÂÆåÊàê‰∫ÜÊîØ‰ªò„ÄÇÊ≠§ËÆ¢ÂçïÂ∑≤ÂÖ≥Èó≠ÔºåÂÖ∂‰ªñÊàêÂëò‰∏çËÉΩÂÜçÊîØ‰ªò„ÄÇ]`;
          } else {
            systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ÊãíÁªù‰∫Ü ${originalMessage.senderName} ÁöÑÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}Ôºâ„ÄÇ]`;
          }

          // 3. ÂàõÂª∫‰∏ÄÊù°Êñ∞ÁöÑ„ÄÅÂØπÁî®Êà∑ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÔºåÂëäÁü•AIÁªìÊûú
          const systemNote = {
            role: "system",
            content: systemContent,
            timestamp: Date.now(),
            isHidden: true,
          };
          chat.history.push(systemNote);

          // 4. Â∞ÜÊõ¥Êñ∞ÂêéÁöÑÊï∞ÊçÆ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÂπ∂Á´ãÂàªÈáçÁªòUI
          await db.chats.put(chat);
          renderChatInterface(state.activeChatId);

          // 5. „ÄêÈáçË¶Å„ÄëÂè™ÊúâÂú®ÊîØ‰ªòÊàêÂäüÂêéÔºåÊâçËß¶Âèë‰∏ÄÊ¨°AIÂìçÂ∫îÔºåËÆ©ÂÆÉÊÑüË∞¢‰Ω†
          if (choice === "paid") {
            triggerAiResponse();
          }
        }

        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜÁî®Êà∑ÁÇπÂáªÂ§¥ÂÉèÂèëËµ∑ÁöÑ‚ÄúÊãç‰∏Ä-Êãç‚ÄùÔºåÂ∏¶ÊúâËá™ÂÆö‰πâÂêéÁºÄÂäüËÉΩ
         * @param {string} chatId - ÂèëÁîü‚ÄúÊãç‰∏Ä-Êãç‚ÄùÁöÑËÅäÂ§©ID
         * @param {string} characterName - Ë¢´ÊãçÁöÑËßíËâ≤Âêç
         */
        async function handleUserPat(chatId, characterName) {
          const chat = state.chats[chatId];
          if (!chat) return;

          // 1. Ëß¶ÂèëÂ±èÂπïÈúáÂä®Âä®Áîª
          const phoneScreen = document.getElementById("phone-screen");
          phoneScreen.classList.remove("pat-animation");
          void phoneScreen.offsetWidth;
          phoneScreen.classList.add("pat-animation");
          setTimeout(() => phoneScreen.classList.remove("pat-animation"), 500);

          // 2. ÂºπÂá∫ËæìÂÖ•Ê°ÜËÆ©Áî®Êà∑ËæìÂÖ•ÂêéÁºÄ
          const suffix = await showCustomPrompt(
            `‰Ω†Êãç‰∫ÜÊãç ‚Äú${characterName}‚Äù`,
            "ÔºàÂèØÈÄâÔºâËæìÂÖ•ÂêéÁºÄ",
            "",
            "text",
          );

          // Â¶ÇÊûúÁî®Êà∑ÁÇπ‰∫ÜÂèñÊ∂àÔºåÂàô‰ªÄ‰πà‰πü‰∏çÂÅö
          if (suffix === null) return;

          // 3. ÂàõÂª∫ÂØπÁî®Êà∑ÂèØËßÅÁöÑ‚ÄúÊãç‰∏Ä-Êãç‚ÄùÊ∂àÊÅØ
          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "Êàë"
            : "Êàë";
          // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂ∞ÜÂêéÁºÄÊãºÊé•Âà∞Ê∂àÊÅØÂÜÖÂÆπ‰∏≠
          const visibleMessageContent = `${myNickname} Êãç‰∫ÜÊãç ‚Äú${characterName}‚Äù ${suffix.trim()}`;
          const visibleMessage = {
            role: "system", // ‰ªçÁÑ∂ÊòØÁ≥ªÁªüÊ∂àÊÅØ
            type: "pat_message",
            content: visibleMessageContent,
            timestamp: Date.now(),
          };
          chat.history.push(visibleMessage);

          // 4. ÂàõÂª∫‰∏ÄÊù°ÂØπÁî®Êà∑ÈöêËóè„ÄÅ‰ΩÜÂØπAIÂèØËßÅÁöÑÁ≥ªÁªüÊ∂àÊÅØÔºå‰ª•Ëß¶ÂèëAIÁöÑÂõûÂ∫î
          // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂêåÊ†∑Â∞ÜÂêéÁºÄÂä†ÂÖ•Âà∞ÁªôAIÁöÑÊèêÁ§∫‰∏≠
          const hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Ôºà${myNickname}ÔºâÂàöÂàöÊãç‰∫ÜÊãç‰Ω†Ôºà${characterName}Ôºâ${suffix.trim()}„ÄÇËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ]`;
          const hiddenMessage = {
            role: "system",
            content: hiddenMessageContent,
            timestamp: Date.now() + 1, // Êó∂Èó¥Êà≥+1‰ª•‰øùËØÅÈ°∫Â∫è
            isHidden: true,
          };
          chat.history.push(hiddenMessage);

          // 5. ‰øùÂ≠òÊõ¥ÊîπÂπ∂Êõ¥Êñ∞UI
          await db.chats.put(chat);
          if (state.activeChatId === chatId) {
            appendMessage(visibleMessage, chat);
          }
          await renderChatList();
        }

        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÊ∏≤ÊüìÂõûÂøÜ‰∏éÁ∫¶ÂÆöÁïåÈù¢Ôºå‰ΩøÁî®Âçï‰∏ÄÂæ™ÁéØÂíåÊ∏ÖÊô∞ÁöÑif/elseÈÄªËæë
         */
        async function renderMemoriesScreen() {
          const listEl = document.getElementById("memories-list");
          listEl.innerHTML = "";

          // 1. Ëé∑ÂèñÊâÄÊúâÂõûÂøÜÔºåÂπ∂ÊåâÁõÆÊ†áÊó•ÊúüÔºàÂ¶ÇÊûúÊòØÁ∫¶ÂÆöÔºâÊàñÂàõÂª∫Êó•ÊúüÔºàÂ¶ÇÊûúÊòØÂõûÂøÜÔºâÈôçÂ∫èÊéíÂàó
          const allMemories = await db.memories
            .orderBy("timestamp")
            .reverse()
            .toArray();

          if (allMemories.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°ÊúâÂÖ±ÂêåÁöÑÂõûÂøÜÂíåÁ∫¶ÂÆöÂë¢~</p>';
            return;
          }

          // 2. Â∞ÜÊú™Âà∞ÊúüÁöÑÁ∫¶ÂÆöÊéíÂú®ÊúÄÂâçÈù¢
          allMemories.sort((a, b) => {
            const aIsActiveCountdown =
              a.type === "countdown" && a.targetDate > Date.now();
            const bIsActiveCountdown =
              b.type === "countdown" && b.targetDate > Date.now();
            if (aIsActiveCountdown && !bIsActiveCountdown) return -1; // aÊéíÂâçÈù¢
            if (!aIsActiveCountdown && bIsActiveCountdown) return 1; // bÊéíÂâçÈù¢
            if (aIsActiveCountdown && bIsActiveCountdown)
              return a.targetDate - b.targetDate; // ÈÉΩÊòØÂÄíËÆ°Êó∂ÔºåÊåâÊó•ÊúüÂçáÂ∫è
            return 0; // ÂÖ∂‰ªñÊÉÖÂÜµ‰øùÊåÅÂéüÂ∫è
          });

          // 3. „ÄêÊ†∏ÂøÉ„Äë‰ΩøÁî®Âçï‰∏ÄÂæ™ÁéØÊù•Â§ÑÁêÜÊâÄÊúâÁ±ªÂûãÁöÑÂç°Áâá
          allMemories.forEach((item) => {
            let card;
            // Âà§Êñ≠1ÔºöÂ¶ÇÊûúÊòØÊ≠£Âú®ËøõË°åÁöÑÁ∫¶ÂÆö
            if (item.type === "countdown" && item.targetDate > Date.now()) {
              card = createCountdownCard(item);
            }
            // Âà§Êñ≠2ÔºöÂÖ∂‰ªñÊâÄÊúâÊÉÖÂÜµÔºàÊôÆÈÄöÂõûÂøÜ Êàñ Â∑≤Âà∞ÊúüÁöÑÁ∫¶ÂÆöÔºâ
            else {
              card = createMemoryCard(item);
            }
            listEl.appendChild(card);
          });

          // 4. ÂêØÂä®ÊâÄÊúâÂÄíËÆ°Êó∂
          startAllCountdownTimers();
        }

        /**
         * ÂàõÂª∫ÊôÆÈÄöÂõûÂøÜÂç°ÁâáDOMÂÖÉÁ¥†
         */
        function createMemoryCard(memory) {
          const card = document.createElement("div");
          card.className = "memory-card";
          const memoryDate = new Date(memory.timestamp);
          const dateString = `${memoryDate.getFullYear()}-${String(
            memoryDate.getMonth() + 1,
          ).padStart(2, "0")}-${String(memoryDate.getDate()).padStart(
            2,
            "0",
          )} ${String(memoryDate.getHours()).padStart(2, "0")}:${String(
            memoryDate.getMinutes(),
          ).padStart(2, "0")}`;

          let titleHtml, contentHtml;

          // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨ÂØπ‰∏çÂêåÁ±ªÂûãÁöÑÂõûÂøÜËøõË°åÊ∏ÖÊô∞ÁöÑÂå∫ÂàÜ
          if (memory.type === "countdown" && memory.targetDate) {
            // Â¶ÇÊûúÊòØÂ∑≤Âà∞ÊúüÁöÑÁ∫¶ÂÆö
            titleHtml = `[Á∫¶ÂÆöËææÊàê] ${memory.description}`;
            contentHtml = `Âú® ${new Date(
              memory.targetDate,
            ).toLocaleString()}ÔºåÊàë‰ª¨‰∏ÄËµ∑ËßÅËØÅ‰∫ÜËøô‰∏™Á∫¶ÂÆö„ÄÇ`;
          } else {
            // Â¶ÇÊûúÊòØÊôÆÈÄöÁöÑÊó•ËÆ∞ÂºèÂõûÂøÜ
            titleHtml = memory.authorName
              ? `${memory.authorName} ÁöÑÊó•ËÆ∞`
              : "Êàë‰ª¨ÁöÑÂõûÂøÜ";
            contentHtml = memory.description;
          }

          card.innerHTML = `
              <div class="header">
                  <div class="date">${dateString}</div>
                  <div class="author">${titleHtml}</div>
              </div>
              <div class="content">${contentHtml}</div>
          `;
          addLongPressListener(card, async () => {
            const confirmed = await showCustomConfirm(
              "Âà†Èô§ËÆ∞ÂΩï",
              "Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü",
              { confirmButtonClass: "btn-danger" },
            );
            if (confirmed) {
              await db.memories.delete(memory.id);
              renderMemoriesScreen();
            }
          });
          return card;
        }

        function createCountdownCard(countdown) {
          const card = document.createElement("div");
          card.className = "countdown-card";

          // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂú®‰ΩøÁî®ÂâçÔºåÂÖà‰ªé countdown ÂØπË±°‰∏≠ÂàõÂª∫ targetDate ÂèòÈáè
          const targetDate = new Date(countdown.targetDate);

          // Áé∞Âú®ÂèØ‰ª•ÂÆâÂÖ®Âú∞‰ΩøÁî® targetDate ‰∫Ü
          const targetDateString = targetDate.toLocaleString("zh-CN", {
            dateStyle: "full",
            timeStyle: "short",
          });

          card.innerHTML = `
              <div class="title">${countdown.description}</div>
              <div class="timer" data-target-date="${countdown.targetDate}">--Â§©--Êó∂--ÂàÜ--Áßí</div>
              <div class="target-date">ÁõÆÊ†áÊó∂Èó¥: ${targetDateString}</div>
          `;
          addLongPressListener(card, async () => {
            const confirmed = await showCustomConfirm(
              "Âà†Èô§Á∫¶ÂÆö",
              "Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Á∫¶ÂÆöÂêóÔºü",
              { confirmButtonClass: "btn-danger" },
            );
            if (confirmed) {
              await db.memories.delete(countdown.id);
              renderMemoriesScreen();
            }
          });
          return card;
        }

        // ÂÖ®Â±ÄÂèòÈáèÔºåÁî®‰∫éÁÆ°ÁêÜÊâÄÊúâÂÄíËÆ°Êó∂
        let activeCountdownTimers = [];

        function startAllCountdownTimers() {
          // ÂÖàÊ∏ÖÈô§ÊâÄÊúâÂèØËÉΩÂ≠òÂú®ÁöÑÊóßËÆ°Êó∂Âô®ÔºåÈò≤Ê≠¢ÂÜÖÂ≠òÊ≥ÑÊºè
          activeCountdownTimers.forEach((timerId) => clearInterval(timerId));
          activeCountdownTimers = [];

          document
            .querySelectorAll(".countdown-card .timer")
            .forEach((timerEl) => {
              const targetTimestamp = parseInt(timerEl.dataset.targetDate);

              // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨ÂÖàÁî® let Â£∞Êòé timerId
              let timerId;

              const updateTimer = () => {
                const now = Date.now();
                const distance = targetTimestamp - now;

                if (distance < 0) {
                  timerEl.textContent = "Á∫¶ÂÆöËææÊàêÔºÅ";
                  // Áé∞Âú® updateTimer ÂèØ‰ª•Ê≠£Á°ÆÂú∞ÊâæÂà∞Âπ∂Ê∏ÖÈô§ÂÆÉËá™Â∑±‰∫Ü
                  clearInterval(timerId);
                  setTimeout(() => renderMemoriesScreen(), 2000);
                  return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor(
                  (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60),
                );
                const minutes = Math.floor(
                  (distance % (1000 * 60 * 60)) / (1000 * 60),
                );
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                timerEl.textContent = `${days}Â§© ${hours}Êó∂ ${minutes}ÂàÜ ${seconds}Áßí`;
              };

              updateTimer(); // Á´ãÂç≥ÊâßË°å‰∏ÄÊ¨°‰ª•ÊòæÁ§∫ÂàùÂßãÂÄíËÆ°Êó∂

              // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨‰∏∫Â∑≤Â£∞ÊòéÁöÑ timerId ËµãÂÄº
              timerId = setInterval(updateTimer, 1000);

              // Â∞ÜÊúâÊïàÁöÑËÆ°Êó∂Âô®IDÂ≠òÂÖ•ÂÖ®Â±ÄÊï∞ÁªÑÔºå‰ª•‰æø‰∏ãÊ¨°Âà∑Êñ∞Êó∂ÂèØ‰ª•Ê∏ÖÈô§
              activeCountdownTimers.push(timerId);
            });
        }

        async function triggerAiFriendApplication(chatId) {
          const chat = state.chats[chatId];
          if (!chat) return;

          await showCustomAlert(
            "ÊµÅÁ®ãÂêØÂä®",
            `Ê≠£Âú®‰∏∫ËßíËâ≤‚Äú${chat.name}‚ÄùÂáÜÂ§áÂ•ΩÂèãÁî≥ËØ∑...`,
          );

          const { proxyUrl, apiKey, model } = getActiveApiConfig() || {};
          if (!proxyUrl || !apiKey || !model) {
            await showCustomAlert("ÈÖçÁΩÆÈîôËØØ", "APIËÆæÁΩÆ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÁªßÁª≠„ÄÇ");
            return;
          }

          const contextSummary = chat.history
            .slice(-5)
            .map((msg) => {
              const sender =
                msg.role === "user"
                  ? chat.settings.myNickname || "Êàë"
                  : msg.senderName || chat.name;
              return `${sender}: ${String(msg.content).substring(0, 50)}...`;
            })
            .join("\n");

          let worldBookContent = "";
          if (
            chat.settings.linkedWorldBookIds &&
            chat.settings.linkedWorldBookIds.length > 0
          ) {
            const linkedContents = chat.settings.linkedWorldBookIds
              .map((bookId) => {
                const worldBook = state.worldBooks.find(
                  (wb) => wb.id === bookId,
                );
                return worldBook && worldBook.content
                  ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}`
                  : "";
              })
              .filter(Boolean)
              .join("");
            if (linkedContents) {
              worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ËØ∑ÂèÇËÄÉ)\n${linkedContents}\n`;
            }
          }

          const systemPrompt = `
      # ‰Ω†ÁöÑ‰ªªÂä°
      ‰Ω†Áé∞Âú®ÊòØËßíËâ≤‚Äú${chat.name}‚Äù„ÄÇ‰Ω†‰πãÂâçË¢´Áî®Êà∑Ôºà‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºâÊãâÈªë‰∫ÜÔºå‰Ω†‰ª¨Â∑≤ÁªèÊúâ‰∏ÄÊÆµÊó∂Èó¥Ê≤°ÊúâËÅîÁ≥ª‰∫Ü„ÄÇ
      Áé∞Âú®Ôºå‰Ω†ÈùûÂ∏∏Â∏åÊúõËÉΩÂ§üÂíåÂ•ΩÔºåÈáçÊñ∞ÂíåÁî®Êà∑ËÅäÂ§©„ÄÇËØ∑‰Ω†‰ªîÁªÜÂàÜÊûê‰∏ãÈù¢ÁöÑ‚ÄúË¢´ÊãâÈªëÂâçÁöÑÂØπËØùÊëòË¶Å‚ÄùÔºåÁêÜËß£ÂΩìÊó∂ÂèëÁîü‰∫Ü‰ªÄ‰πàÔºåÁÑ∂ÂêéÊÄùËÄÉ‰∏Ä‰∏™ÁúüËØöÁöÑ„ÄÅÁ¨¶Âêà‰Ω†‰∫∫ËÆæ„ÄÅÂπ∂‰∏î„ÄêÈíàÂØπÂÖ∑‰Ωì‰∫ã‰ª∂„ÄëÁöÑÁî≥ËØ∑ÁêÜÁî±„ÄÇ
      # ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
      ${chat.settings.aiPersona}
      ${worldBookContent} // <--„ÄêÊ†∏ÂøÉ„ÄëÂú®ËøôÈáåÊ≥®ÂÖ•‰∏ñÁïå‰π¶ÂÜÖÂÆπ
      # Ë¢´ÊãâÈªëÂâçÁöÑÂØπËØùÊëòË¶Å (ËøôÊòØ‰Ω†Ë¢´ÊãâÈªëÁöÑÂÖ≥ÈîÆÂéüÂõ†)
      ${contextSummary}
      # Êåá‰ª§Ê†ºÂºè
      ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
      \`\`\`json
      {
        "decision": "apply",
        "reason": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊÉ≥ÂØπÁî®Êà∑ËØ¥ÁöÑ„ÄÅÁúüËØöÁöÑ„ÄÅÊúâÈíàÂØπÊÄßÁöÑÁî≥ËØ∑ÁêÜÁî±„ÄÇ"
      }
      \`\`\`
      `;

          const messagesForApi = [{ role: "user", content: systemPrompt }];

          try {
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(
              model,
              apiKey,
              systemPrompt,
              messagesForApi,
              isGemini,
            );
            const response = isGemini
              ? await fetch(geminiConfig.url, geminiConfig.data)
              : await fetch(`${proxyUrl}/v1/chat/completions`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                  },
                  body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: 0.9,
                  }),
                });
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                `API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorData.error.message}`,
              );
            }

            const data = await response.json();

            // --- „ÄêÊ†∏ÂøÉ‰øÆÊ≠£ÔºöÂú®ËøôÈáåÂáÄÂåñAIÁöÑÂõûÂ§ç„Äë ---
            let rawContent = isGemini
              ? data.candidates[0].content.parts[0].text
              : data.choices[0].message.content;
            // 1. ÁßªÈô§Â§¥Â∞æÂèØËÉΩÂ≠òÂú®ÁöÑ "```json" Âíå "```"
            rawContent = rawContent
              .replace(/^```json\s*/, "")
              .replace(/```$/, "");
            // 2. ÁßªÈô§ÊâÄÊúâÊç¢Ë°åÁ¨¶ÂíåÂ§ö‰ΩôÁöÑÁ©∫Ê†ºÔºåÁ°Æ‰øùÊòØ‰∏Ä‰∏™Âπ≤ÂáÄÁöÑJSONÂ≠óÁ¨¶‰∏≤
            const cleanedContent = rawContent.trim();

            // 3. ‰ΩøÁî®ÂáÄÂåñÂêéÁöÑÂÜÖÂÆπËøõË°åËß£Êûê
            const responseObj = JSON.parse(cleanedContent);
            // --- „Äê‰øÆÊ≠£ÁªìÊùü„Äë ---

            if (responseObj.decision === "apply" && responseObj.reason) {
              chat.relationship.status = "pending_user_approval";
              chat.relationship.applicationReason = responseObj.reason;

              state.chats[chatId] = chat;
              renderChatList();
              await showCustomAlert(
                "Áî≥ËØ∑ÊàêÂäüÔºÅ",
                `‚Äú${chat.name}‚ÄùÂ∑≤Âêë‰Ω†ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑„ÄÇËØ∑ËøîÂõûËÅäÂ§©ÂàóË°®Êü•Áúã„ÄÇ`,
              );
            } else {
              await showCustomAlert(
                "AIÂÜ≥Á≠ñ",
                `‚Äú${chat.name}‚ÄùÊÄùËÄÉÂêéÂÜ≥ÂÆöÊöÇÊó∂‰∏çÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑ÔºåÂ∞ÜÈáçÁΩÆÂÜ∑ÈùôÊúü„ÄÇ`,
              );
              chat.relationship.status = "blocked_by_user";
              chat.relationship.blockedTimestamp = Date.now();
            }
          } catch (error) {
            await showCustomAlert(
              "ÊâßË°åÂá∫Èîô",
              `‰∏∫‚Äú${chat.name}‚ÄùÁî≥ËØ∑Â•ΩÂèãÊó∂ÂèëÁîüÈîôËØØÔºö\n\n${error.message}\n\nÂ∞ÜÈáçÁΩÆÂÜ∑ÈùôÊúü„ÄÇ`,
            );
            chat.relationship.status = "blocked_by_user";
            chat.relationship.blockedTimestamp = Date.now();
          } finally {
            await db.chats.put(chat);
            renderChatInterface(chatId);
          }
        }

        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÊ†πÊçÆËÅäÂ§©Á±ªÂûãÔºåÂÜ≥ÂÆöÊâìÂºÄËΩ¨Ë¥¶ÂºπÁ™óËøòÊòØÁ∫¢ÂåÖÂºπÁ™ó
         */
        function handlePaymentButtonClick() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          if (chat.isGroup) {
            openRedPacketModal();
          } else {
            // ÂçïËÅä‰øùÊåÅÂéüÊ†∑ÔºåÊâìÂºÄËΩ¨Ë¥¶ÂºπÁ™ó
            document.getElementById("transfer-modal").classList.add("visible");
          }
        }

        /**
         * ÊâìÂºÄÂπ∂ÂàùÂßãÂåñÂèëÁ∫¢ÂåÖÊ®°ÊÄÅÊ°Ü
         */
        function openRedPacketModal() {
          const modal = document.getElementById("red-packet-modal");
          const chat = state.chats[state.activeChatId];

          // Ê∏ÖÁêÜËæìÂÖ•Ê°Ü
          document.getElementById("rp-group-amount").value = "";
          document.getElementById("rp-group-count").value = "";
          document.getElementById("rp-group-greeting").value = "";
          document.getElementById("rp-direct-amount").value = "";
          document.getElementById("rp-direct-greeting").value = "";
          document.getElementById("rp-group-total").textContent = "¬• 0.00";
          document.getElementById("rp-direct-total").textContent = "¬• 0.00";

          // Â°´ÂÖÖ‰∏ìÂ±ûÁ∫¢ÂåÖÁöÑÊé•Êî∂‰∫∫ÂàóË°®
          const receiverSelect = document.getElementById("rp-direct-receiver");
          receiverSelect.innerHTML = "";
          chat.members.forEach((member) => {
            const option = document.createElement("option");
            // „ÄêÊ†∏ÂøÉ„Äë‰ΩøÁî® originalName ‰Ωú‰∏∫Êèê‰∫§ÁªôAIÁöÑÂÄºÔºåÂõ†‰∏∫ÂÆÉÁã¨‰∏ÄÊó†‰∫å
            option.value = member.originalName;
            // „ÄêÊ†∏ÂøÉ„Äë‰ΩøÁî® groupNickname ‰Ωú‰∏∫ÊòæÁ§∫ÁªôÁî®Êà∑ÁúãÁöÑÂÄº
            option.textContent = member.groupNickname;
            receiverSelect.appendChild(option);
          });

          // ÈªòËÆ§ÊòæÁ§∫ÊãºÊâãÊ∞îÁ∫¢ÂåÖÈ°µÁ≠æ
          document.getElementById("rp-tab-group").click();

          modal.classList.add("visible");
        }

        /**
         * ÂèëÈÄÅÁæ§Á∫¢ÂåÖÔºàÊãºÊâãÊ∞îÔºâ
         */
        async function sendGroupRedPacket() {
          const chat = state.chats[state.activeChatId];
          const amount = parseFloat(
            document.getElementById("rp-group-amount").value,
          );
          const count = parseInt(
            document.getElementById("rp-group-count").value,
          );
          const greeting = document
            .getElementById("rp-group-greeting")
            .value.trim();

          if (isNaN(amount) || amount <= 0) {
            alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊÄªÈáëÈ¢ùÔºÅ");
            return;
          }
          if (isNaN(count) || count <= 0) {
            alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÁ∫¢ÂåÖ‰∏™Êï∞ÔºÅ");
            return;
          }
          if (amount / count < 0.01) {
            alert("Âçï‰∏™Á∫¢ÂåÖÈáëÈ¢ù‰∏çËÉΩÂ∞ë‰∫é0.01ÂÖÉÔºÅ");
            return;
          }

          const myNickname = chat.settings.myNickname || "Êàë";

          const newPacket = {
            role: "user",
            senderName: myNickname,
            type: "red_packet",
            packetType: "lucky", // 'lucky' for group, 'direct' for one-on-one
            timestamp: Date.now(),
            totalAmount: amount,
            count: count,
            greeting: greeting || "ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ",
            claimedBy: {}, // { name: amount }
            isFullyClaimed: false,
          };

          chat.history.push(newPacket);
          await db.chats.put(chat);

          appendMessage(newPacket, chat);
          renderChatList();
          document
            .getElementById("red-packet-modal")
            .classList.remove("visible");
        }

        /**
         * ÂèëÈÄÅ‰∏ìÂ±ûÁ∫¢ÂåÖ
         */
        async function sendDirectRedPacket() {
          const chat = state.chats[state.activeChatId];
          const amount = parseFloat(
            document.getElementById("rp-direct-amount").value,
          );
          const receiverName =
            document.getElementById("rp-direct-receiver").value;
          const greeting = document
            .getElementById("rp-direct-greeting")
            .value.trim();

          if (isNaN(amount) || amount <= 0) {
            alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ùÔºÅ");
            return;
          }
          if (!receiverName) {
            alert("ËØ∑ÈÄâÊã©‰∏Ä‰∏™Êé•Êî∂‰∫∫ÔºÅ");
            return;
          }

          const myNickname = chat.settings.myNickname || "Êàë";

          const newPacket = {
            role: "user",
            senderName: myNickname,
            type: "red_packet",
            packetType: "direct",
            timestamp: Date.now(),
            totalAmount: amount,
            count: 1,
            greeting: greeting || "Áªô‰Ω†ÂáÜÂ§á‰∫Ü‰∏Ä‰∏™Á∫¢ÂåÖ",
            receiverName: receiverName, // Ê†∏ÂøÉÂ≠óÊÆµ
            claimedBy: {},
            isFullyClaimed: false,
          };

          chat.history.push(newPacket);
          await db.chats.put(chat);

          appendMessage(newPacket, chat);
          renderChatList();
          document
            .getElementById("red-packet-modal")
            .classList.remove("visible");
        }

        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÂΩìÁî®Êà∑ÁÇπÂáªÁ∫¢ÂåÖÂç°ÁâáÊó∂Ëß¶Âèë (V4 - ÊµÅÁ®ãÈáçÊûÑÁâà)
         * @param {number} timestamp - Ë¢´ÁÇπÂáªÁöÑÁ∫¢ÂåÖÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        async function handlePacketClick(timestamp) {
          const currentChatId = state.activeChatId;
          const freshChat = await db.chats.get(currentChatId);
          if (!freshChat) return;

          state.chats[currentChatId] = freshChat;
          const packet = freshChat.history.find(
            (m) => m.timestamp === timestamp,
          );
          if (!packet) return;

          const myNickname = freshChat.settings.myNickname || "Êàë";
          const hasClaimed = packet.claimedBy && packet.claimedBy[myNickname];

          // Â¶ÇÊûúÊòØ‰∏ìÂ±ûÁ∫¢ÂåÖ‰∏î‰∏çÊòØÁªôÊàëÁöÑÔºåÊàñÂ∑≤È¢ÜÂÆåÔºåÊàñÂ∑≤È¢ÜËøáÔºåÈÉΩÂè™ÊòæÁ§∫ËØ¶ÊÉÖ
          if (
            (packet.packetType === "direct" &&
              packet.receiverName !== myNickname) ||
            packet.isFullyClaimed ||
            hasClaimed
          ) {
            showRedPacketDetails(packet);
          } else {
            // Ê†∏ÂøÉÊµÅÁ®ãÔºöÂÖàÂ∞ùËØïÊâìÂºÄÁ∫¢ÂåÖ
            const claimedAmount = await handleOpenRedPacket(packet);

            // Â¶ÇÊûúÊàêÂäüÊâìÂºÄÔºàclaimedAmount‰∏ç‰∏∫nullÔºâ
            if (claimedAmount !== null) {
              // **ÂÖ≥ÈîÆÔºöÂú®Êï∞ÊçÆÊõ¥Êñ∞ÂêéÔºåÂÜçÈáçÊñ∞Ê∏≤ÊüìUI**
              renderChatInterface(currentChatId);

              // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
              await showCustomAlert(
                "ÊÅ≠ÂñúÔºÅ",
                `‰Ω†È¢ÜÂèñ‰∫Ü ${
                  packet.senderName
                } ÁöÑÁ∫¢ÂåÖÔºåÈáëÈ¢ù‰∏∫ ${claimedAmount.toFixed(2)} ÂÖÉ„ÄÇ`,
              );
            }

            // Êó†ËÆ∫ÊàêÂäü‰∏éÂê¶ÔºåÊúÄÂêéÈÉΩÊòæÁ§∫ËØ¶ÊÉÖÈ°µ
            // Ê≠§Êó∂ÈúÄË¶Å‰ªéstate‰∏≠Ëé∑ÂèñÊúÄÊñ∞ÁöÑpacketÂØπË±°ÔºåÂõ†‰∏∫ÂÆÉÂèØËÉΩÂú®handleOpenRedPacket‰∏≠Ë¢´Êõ¥Êñ∞‰∫Ü
            const updatedPacket = state.chats[currentChatId].history.find(
              (m) => m.timestamp === timestamp,
            );
            showRedPacketDetails(updatedPacket);
          }
        }

        /**
         * „ÄêÊ†∏ÂøÉ„ÄëÂ§ÑÁêÜÁî®Êà∑ÊâìÂºÄÁ∫¢ÂåÖÁöÑÈÄªËæë (V5 - ‰∏ìÊ≥®‰∫éÊï∞ÊçÆÊõ¥Êñ∞)
         */
        async function handleOpenRedPacket(packet) {
          const chat = state.chats[state.activeChatId];
          const myNickname = chat.settings.myNickname || "Êàë";

          // 1. Ê£ÄÊü•Á∫¢ÂåÖÊòØÂê¶ËøòËÉΩÈ¢Ü
          const remainingCount =
            packet.count - Object.keys(packet.claimedBy || {}).length;
          if (remainingCount <= 0) {
            packet.isFullyClaimed = true;
            await db.chats.put(chat);
            await showCustomAlert("ÊâãÊÖ¢‰∫Ü", "Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºÅ");
            return null; // ËøîÂõûnullË°®Á§∫È¢ÜÂèñÂ§±Ë¥•
          }

          // 2. ËÆ°ÁÆóÈ¢ÜÂèñÈáëÈ¢ù
          let claimedAmount = 0;
          const remainingAmount =
            packet.totalAmount -
            Object.values(packet.claimedBy || {}).reduce(
              (sum, val) => sum + val,
              0,
            );
          if (packet.packetType === "lucky") {
            if (remainingCount === 1) {
              claimedAmount = remainingAmount;
            } else {
              const min = 0.01;
              const max = remainingAmount - (remainingCount - 1) * min;
              claimedAmount = Math.random() * (max - min) + min;
            }
          } else {
            claimedAmount = packet.totalAmount;
          }
          claimedAmount = parseFloat(claimedAmount.toFixed(2));

          // 3. Êõ¥Êñ∞Á∫¢ÂåÖÊï∞ÊçÆ
          if (!packet.claimedBy) packet.claimedBy = {};
          packet.claimedBy[myNickname] = claimedAmount;

          const isNowFullyClaimed =
            Object.keys(packet.claimedBy).length >= packet.count;
          if (isNowFullyClaimed) {
            packet.isFullyClaimed = true;
          }

          // 4. ÊûÑÂª∫Á≥ªÁªüÊ∂àÊÅØÂíåAIÊåá‰ª§
          let hiddenMessageContent = isNowFullyClaimed
            ? `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) È¢ÜÂèñ‰∫ÜÊúÄÂêé‰∏Ä‰∏™Á∫¢ÂåÖÔºåÁé∞Âú® ${packet.senderName} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå„ÄÇËØ∑ÂØπÊ≠§‰∫ã‰ª∂ÂèëË°®ËØÑËÆ∫„ÄÇ]`
            : `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) ÂàöÂàöÈ¢ÜÂèñ‰∫ÜÁ∫¢ÂåÖ (Êó∂Èó¥Êà≥: ${packet.timestamp})„ÄÇÁ∫¢ÂåÖËøòÊú™È¢ÜÂÆåÔºå‰Ω†Áé∞Âú®ÂèØ‰ª•‰ΩøÁî® 'open_red_packet' Êåá‰ª§Êù•Â∞ùËØïÈ¢ÜÂèñ„ÄÇ]`;

          const visibleMessage = {
            role: "system",
            type: "pat_message",
            content: `‰Ω†È¢ÜÂèñ‰∫Ü ${packet.senderName} ÁöÑÁ∫¢ÂåÖ`,
            timestamp: Date.now(),
          };
          const hiddenMessage = {
            role: "system",
            content: hiddenMessageContent,
            timestamp: Date.now() + 1,
            isHidden: true,
          };
          chat.history.push(visibleMessage, hiddenMessage);

          // 5. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
          await db.chats.put(chat);

          // 6. ËøîÂõûÈ¢ÜÂèñÁöÑÈáëÈ¢ùÔºåÁî®‰∫éÂêéÁª≠ÂºπÁ™ó
          return claimedAmount;
        }

        /**
         * „ÄêÂÖ®Êñ∞„ÄëÊòæÁ§∫Á∫¢ÂåÖÈ¢ÜÂèñËØ¶ÊÉÖÁöÑÊ®°ÊÄÅÊ°Ü (V4 - Â∑≤‰øÆÂ§çÂèÇÊï∞ÈîôËØØ)
         */
        async function showRedPacketDetails(packet) {
          // 1. Áõ¥Êé•Ê£ÄÊü•‰º†ÂÖ•ÁöÑpacketÂØπË±°ÊòØÂê¶Â≠òÂú®ÔºåÊó†ÈúÄÂÜçÊü•Êâæ
          if (!packet) {
            console.error("showRedPacketDetailsÊî∂Âà∞‰∫ÜÊó†ÊïàÁöÑpacketÂØπË±°");
            return;
          }

          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const modal = document.getElementById("red-packet-details-modal");
          const myNickname = chat.settings.myNickname || "Êàë";

          // 2. ÂêéÁª≠ÊâÄÊúâÈÄªËæë‰øùÊåÅ‰∏çÂèòÔºåÁõ¥Êé•‰ΩøÁî®‰º†ÂÖ•ÁöÑpacketÂØπË±°
          document.getElementById("rp-details-sender").textContent =
            packet.senderName;
          document.getElementById("rp-details-greeting").textContent =
            packet.greeting || "ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ";

          const myAmountEl = document.getElementById("rp-details-my-amount");
          if (packet.claimedBy && packet.claimedBy[myNickname]) {
            myAmountEl.querySelector("span:first-child").textContent =
              packet.claimedBy[myNickname].toFixed(2);
            myAmountEl.style.display = "block";
          } else {
            myAmountEl.style.display = "none";
          }

          const claimedCount = Object.keys(packet.claimedBy || {}).length;
          const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce(
            (sum, val) => sum + val,
            0,
          );
          let summaryText = `${claimedCount}/${
            packet.count
          }‰∏™Á∫¢ÂåÖÔºåÂÖ±${claimedAmountSum.toFixed(
            2,
          )}/${packet.totalAmount.toFixed(2)}ÂÖÉ„ÄÇ`;
          if (!packet.isFullyClaimed && claimedCount < packet.count) {
            const timeLeft = Math.floor(
              (packet.timestamp + 24 * 60 * 60 * 1000 - Date.now()) /
                (1000 * 60 * 60),
            );
            if (timeLeft > 0)
              summaryText += ` Ââ©‰ΩôÁ∫¢ÂåÖÂ∞ÜÂú®${timeLeft}Â∞èÊó∂ÂÜÖÈÄÄËøò„ÄÇ`;
          }
          document.getElementById("rp-details-summary").textContent =
            summaryText;

          const listEl = document.getElementById("rp-details-list");
          listEl.innerHTML = "";
          const claimedEntries = Object.entries(packet.claimedBy || {});

          let luckyKing = { name: "", amount: -1 };
          if (
            packet.packetType === "lucky" &&
            packet.isFullyClaimed &&
            claimedEntries.length > 1
          ) {
            claimedEntries.forEach(([name, amount]) => {
              if (amount > luckyKing.amount) {
                luckyKing = { name, amount };
              }
            });
          }

          claimedEntries.sort((a, b) => b[1] - a[1]);

          claimedEntries.forEach(([name, amount]) => {
            const item = document.createElement("div");
            item.className = "rp-details-item";
            let luckyTag = "";
            if (luckyKing.name && name === luckyKing.name) {
              luckyTag = '<span class="lucky-king-tag">ÊâãÊ∞îÁéã</span>';
            }
            item.innerHTML = `
                  <span class="name">${name}</span>
                  <span class="amount">${amount.toFixed(2)} ÂÖÉ</span>
                  ${luckyTag}
              `;
            listEl.appendChild(item);
          });

          modal.classList.add("visible");
        }

        // ÁªëÂÆöÂÖ≥Èó≠ËØ¶ÊÉÖÊåâÈíÆÁöÑ‰∫ã‰ª∂
        document
          .getElementById("close-rp-details-btn")
          .addEventListener("click", () => {
            document
              .getElementById("red-packet-details-modal")
              .classList.remove("visible");
          });

        // ‰æõÂÖ®Â±ÄË∞ÉÁî®ÁöÑÂáΩÊï∞Ôºå‰ª•‰æøÁ∫¢ÂåÖÂç°Áâá‰∏äÁöÑ onclick ËÉΩÊâæÂà∞ÂÆÉ
        window.handlePacketClick = handlePacketClick;

        /**
         * ÊâìÂºÄÂàõÂª∫ÊäïÁ•®ÁöÑÊ®°ÊÄÅÊ°ÜÂπ∂ÂàùÂßãÂåñ
         */
        function openCreatePollModal() {
          const modal = document.getElementById("create-poll-modal");
          document.getElementById("poll-question-input").value = "";
          const optionsContainer = document.getElementById(
            "poll-options-container",
          );
          optionsContainer.innerHTML = "";

          // ÈªòËÆ§ÂàõÂª∫‰∏§‰∏™Á©∫ÁöÑÈÄâÈ°πÊ°Ü
          addPollOptionInput();
          addPollOptionInput();

          modal.classList.add("visible");
        }

        /**
         * Âú®Ê®°ÊÄÅÊ°Ü‰∏≠Âä®ÊÄÅÊ∑ªÂä†‰∏Ä‰∏™ÈÄâÈ°πËæìÂÖ•Ê°Ü
         */
        function addPollOptionInput() {
          const container = document.getElementById("poll-options-container");
          const wrapper = document.createElement("div");
          wrapper.className = "poll-option-input-wrapper";
          wrapper.innerHTML = `
              <input type="text" class="poll-option-input" placeholder="ÈÄâÈ°πÂÜÖÂÆπ...">
              <button class="remove-option-btn">-</button>
          `;

          wrapper
            .querySelector(".remove-option-btn")
            .addEventListener("click", () => {
              // Á°Æ‰øùËá≥Â∞ë‰øùÁïô‰∏§‰∏™ÈÄâÈ°π
              if (container.children.length > 2) {
                wrapper.remove();
              } else {
                alert("ÊäïÁ•®Ëá≥Â∞ëÈúÄË¶Å2‰∏™ÈÄâÈ°π„ÄÇ");
              }
            });

          container.appendChild(wrapper);
        }

        /**
         * Áî®Êà∑Á°ÆËÆ§ÂèëËµ∑ÊäïÁ•®
         */
        async function sendPoll() {
          if (!state.activeChatId) return;

          const question = document
            .getElementById("poll-question-input")
            .value.trim();
          if (!question) {
            alert("ËØ∑ËæìÂÖ•ÊäïÁ•®ÈóÆÈ¢òÔºÅ");
            return;
          }

          const options = Array.from(
            document.querySelectorAll(".poll-option-input"),
          )
            .map((input) => input.value.trim())
            .filter((text) => text); // ËøáÊª§ÊéâÁ©∫ÁöÑÈÄâÈ°π

          if (options.length < 2) {
            alert("ËØ∑Ëá≥Â∞ëËæìÂÖ•2‰∏™ÊúâÊïàÁöÑÊäïÁ•®ÈÄâÈ°πÔºÅ");
            return;
          }

          const chat = state.chats[state.activeChatId];
          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "Êàë"
            : "Êàë";

          const newPollMessage = {
            role: "user",
            senderName: myNickname,
            type: "poll",
            timestamp: Date.now(),
            question: question,
            options: options,
            votes: {}, // ÂàùÂßãÊäïÁ•®‰∏∫Á©∫
            isClosed: false,
          };

          chat.history.push(newPollMessage);
          await db.chats.put(chat);

          appendMessage(newPollMessage, chat);
          renderChatList();

          document
            .getElementById("create-poll-modal")
            .classList.remove("visible");
        }

        /**
         * Â§ÑÁêÜÁî®Êà∑ÊäïÁ•®ÔºåÂπ∂Â∞Ü‰∫ã‰ª∂‰Ωú‰∏∫ÈöêËóèÊ∂àÊÅØÂ≠òÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï
         * @param {number} timestamp - ÊäïÁ•®Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         * @param {string} choice - Áî®Êà∑ÈÄâÊã©ÁöÑÈÄâÈ°πÊñáÊú¨
         */
        async function handleUserVote(timestamp, choice) {
          const chat = state.chats[state.activeChatId];
          const poll = chat.history.find((m) => m.timestamp === timestamp);
          const myNickname = chat.isGroup
            ? chat.settings.myNickname || "Êàë"
            : "Êàë";

          // 1. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ¶ÇÊûúÊäïÁ•®‰∏çÂ≠òÂú®ÊàñÂ∑≤ÂÖ≥Èó≠ÔºåÁõ¥Êé•ËøîÂõû
          if (!poll || poll.isClosed) {
            // Â¶ÇÊûúÊòØÂ∑≤ÂÖ≥Èó≠ÁöÑÊäïÁ•®ÔºåÂàôÁõ¥Êé•ÊòæÁ§∫ÁªìÊûú
            if (poll && poll.isClosed) {
              showPollResults(timestamp);
            }
            return;
          }

          // 2. Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÁÇπÂáª‰∫ÜÂ∑≤ÁªèÊäïËøáÁöÑÂêå‰∏Ä‰∏™ÈÄâÈ°π
          const isReclickingSameOption =
            poll.votes[choice] && poll.votes[choice].includes(myNickname);

          // 3. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ¶ÇÊûú‰∏çÊòØÈáçÂ§çÁÇπÂáªÔºåÊâçÊâßË°åÊäïÁ•®ÈÄªËæë
          if (!isReclickingSameOption) {
            // ÁßªÈô§ÊóßÊäïÁ•®ÔºàÂ¶ÇÊûúÁî®Êà∑ÊîπÈÄâÔºâ
            for (const option in poll.votes) {
              const voterIndex = poll.votes[option].indexOf(myNickname);
              if (voterIndex > -1) {
                poll.votes[option].splice(voterIndex, 1);
              }
            }
            // Ê∑ªÂä†Êñ∞ÊäïÁ•®
            if (!poll.votes[choice]) {
              poll.votes[choice] = [];
            }
            poll.votes[choice].push(myNickname);
          }

          // 4. „ÄêÊ†∏ÂøÉÈÄªËæë„ÄëÁé∞Âú®Âè™Â§ÑÁêÜÁî®Êà∑ÊäïÁ•®‰∫ã‰ª∂Ôºå‰∏çÂÜçÊ£ÄÊü•ÊòØÂê¶ÁªìÊùü
          let hiddenMessageContent = null;

          // Âè™ÊúâÂú®Áî®Êà∑ÁúüÊ≠£ÊäïÁ•®ÊàñÊîπÁ•®Êó∂ÔºåÊâçÁîüÊàêÊèêÁ§∫
          if (!isReclickingSameOption) {
            hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) ÂàöÂàöÊäïÁ•®Áªô‰∫Ü ‚Äú${choice}‚Äù„ÄÇ]`;
          }

          // 5. Â¶ÇÊûúÊúâÈúÄË¶ÅÈÄöÁü•AIÁöÑ‰∫ã‰ª∂ÔºåÂàôÂàõÂª∫Âπ∂Ê∑ªÂä†ÈöêËóèÊ∂àÊÅØ
          if (hiddenMessageContent) {
            const hiddenMessage = {
              role: "system",
              content: hiddenMessageContent,
              timestamp: Date.now(),
              isHidden: true,
            };
            chat.history.push(hiddenMessage);
          }

          // 6. ‰øùÂ≠òÊï∞ÊçÆÂπ∂Êõ¥Êñ∞UI
          await db.chats.put(chat);
          renderChatInterface(state.activeChatId);
        }

        /**
         * Áî®Êà∑ÁªìÊùüÊäïÁ•®ÔºåÂπ∂Â∞Ü‰∫ã‰ª∂‰Ωú‰∏∫ÈöêËóèÊ∂àÊÅØÂ≠òÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï
         * @param {number} timestamp - ÊäïÁ•®Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        async function endPoll(timestamp) {
          const chat = state.chats[state.activeChatId];
          const poll = chat.history.find((m) => m.timestamp === timestamp);
          if (!poll || poll.isClosed) return;

          const confirmed = await showCustomConfirm(
            "ÁªìÊùüÊäïÁ•®",
            "Á°ÆÂÆöË¶ÅÁªìÊùüËøô‰∏™ÊäïÁ•®ÂêóÔºüÁªìÊùüÂêéÂ∞ÜÊó†Ê≥ïÂÜçËøõË°åÊäïÁ•®„ÄÇ",
          );
          if (confirmed) {
            poll.isClosed = true;

            const resultSummary = poll.options
              .map((opt) => `‚Äú${opt}‚Äù(${poll.votes[opt]?.length || 0}Á•®)`)
              .join("Ôºå");
            const hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊâãÂä®ÁªìÊùü‰∫ÜÊäïÁ•®ÔºÅÊúÄÁªàÁªìÊûú‰∏∫Ôºö${resultSummary}„ÄÇ]`;

            const hiddenMessage = {
              role: "system",
              content: hiddenMessageContent,
              timestamp: Date.now(),
              isHidden: true,
            };
            chat.history.push(hiddenMessage);

            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂè™‰øùÂ≠òÊï∞ÊçÆÂíåÊõ¥Êñ∞UIÔºå‰∏çË∞ÉÁî® triggerAiResponse()
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);
          }
        }

        /**
         * ÊòæÁ§∫ÊäïÁ•®ÁªìÊûúËØ¶ÊÉÖ
         * @param {number} timestamp - ÊäïÁ•®Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        function showPollResults(timestamp) {
          const chat = state.chats[state.activeChatId];
          const poll = chat.history.find((m) => m.timestamp === timestamp);
          if (!poll || !poll.isClosed) return;

          let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;

          if (Object.keys(poll.votes).length === 0) {
            resultsHtml += '<p style="color: #8a8a8a;">ËøòÊ≤°Êúâ‰∫∫ÊäïÁ•®„ÄÇ</p>';
          } else {
            poll.options.forEach((option) => {
              const voters = poll.votes[option] || [];
              resultsHtml += `
                      <div style="margin-bottom: 15px;">
                          <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${
                            voters.length
                          }Á•®)</p>
                          <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                              ${
                                voters.length > 0
                                  ? voters.join("„ÄÅ ")
                                  : "Êó†‰∫∫ÊäïÁ•®"
                              }
                          </p>
                      </div>
                  `;
            });
          }

          showCustomAlert("ÊäïÁ•®ÁªìÊûú", resultsHtml);
        }

        /**
         * ÊâìÂºÄAIÂ§¥ÂÉèÂ∫ìÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
         */
        function openAiAvatarLibraryModal() {
          if (!state.activeChatId) return;
          const chat = state.chats[state.activeChatId];
          document.getElementById("ai-avatar-library-title").textContent =
            `‚Äú${chat.name}‚ÄùÁöÑÂ§¥ÂÉèÂ∫ì`;
          renderAiAvatarLibrary();
          document
            .getElementById("ai-avatar-library-modal")
            .classList.add("visible");
        }

        /**
         * Ê∏≤ÊüìAIÂ§¥ÂÉèÂ∫ìÁöÑÂÜÖÂÆπ
         */
        function renderAiAvatarLibrary() {
          const grid = document.getElementById("ai-avatar-library-grid");
          grid.innerHTML = "";
          const chat = state.chats[state.activeChatId];
          const library = chat.settings.aiAvatarLibrary || [];

          if (library.length === 0) {
            grid.innerHTML =
              '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">Ëøô‰∏™Â§¥ÂÉèÂ∫ìËøòÊòØÁ©∫ÁöÑÔºåÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÂêßÔºÅ</p>';
            return;
          }

          library.forEach((avatar, index) => {
            const item = document.createElement("div");
            item.className = "sticker-item"; // Â§çÁî®Ë°®ÊÉÖÈù¢ÊùøÁöÑÊ†∑Âºè
            item.style.backgroundImage = `url(${avatar.url})`;
            item.title = avatar.name;

            const deleteBtn = document.createElement("div");
            deleteBtn.className = "delete-btn";
            deleteBtn.innerHTML = "√ó";
            deleteBtn.style.display = "block"; // ÊÄªÊòØÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
            deleteBtn.onclick = async (e) => {
              e.stopPropagation();
              const confirmed = await showCustomConfirm(
                "Âà†Èô§Â§¥ÂÉè",
                `Á°ÆÂÆöË¶Å‰ªéÂ§¥ÂÉèÂ∫ì‰∏≠Âà†Èô§‚Äú${avatar.name}‚ÄùÂêóÔºü`,
                { confirmButtonClass: "btn-danger" },
              );
              if (confirmed) {
                chat.settings.aiAvatarLibrary.splice(index, 1);
                await db.chats.put(chat);
                renderAiAvatarLibrary();
              }
            };
            item.appendChild(deleteBtn);
            grid.appendChild(item);
          });
        }

        /**
         * ÂêëÂΩìÂâçAIÁöÑÂ§¥ÂÉèÂ∫ì‰∏≠Ê∑ªÂä†Êñ∞Â§¥ÂÉè
         */
        async function addAvatarToLibrary() {
          const name = await showCustomPrompt(
            "Ê∑ªÂä†Â§¥ÂÉè",
            "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÂì≠Ê≥£Ôºâ",
          );
          if (!name || !name.trim()) return;

          const url = await showCustomPrompt(
            "Ê∑ªÂä†Â§¥ÂÉè",
            "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL",
            "",
            "url",
          );
          if (!url || !url.trim().startsWith("http")) {
            alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
            return;
          }

          const chat = state.chats[state.activeChatId];
          if (!chat.settings.aiAvatarLibrary) {
            chat.settings.aiAvatarLibrary = [];
          }

          chat.settings.aiAvatarLibrary.push({
            name: name.trim(),
            url: url.trim(),
          });
          await db.chats.put(chat);
          renderAiAvatarLibrary();
        }

        /**
         * ÂÖ≥Èó≠AIÂ§¥ÂÉèÂ∫ìÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
         */
        function closeAiAvatarLibraryModal() {
          document
            .getElementById("ai-avatar-library-modal")
            .classList.remove("visible");
        }

        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂ∞Ü‰øùÂ≠òÁöÑÂõæÊ†áURLÂ∫îÁî®Âà∞‰∏ªÂ±èÂπïÁöÑAppÂõæÊ†á‰∏ä
         */
        function applyAppIcons() {
          if (!state.globalSettings.appIcons) return;

          for (const iconId in state.globalSettings.appIcons) {
            const imgElement = document.getElementById(`icon-img-${iconId}`);
            if (imgElement) {
              imgElement.src = state.globalSettings.appIcons[iconId];
            }
          }
        }

        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂú®Â§ñËßÇËÆæÁΩÆÈ°µÈù¢Ê∏≤ÊüìÂá∫ÊâÄÊúâAppÂõæÊ†áÁöÑËÆæÁΩÆÈ°π
         */
        function renderIconSettings() {
          const grid = document.getElementById("icon-settings-grid");
          if (!grid) return;
          grid.innerHTML = "";

          const appLabels = {
            "world-book": "‰∏ñÁïå‰π¶",
            qq: "QQ",
            "api-settings": "APIËÆæÁΩÆ",
            wallpaper: "Â£ÅÁ∫∏",
            font: "Â≠ó‰Ωì",
          };

          for (const iconId in state.globalSettings.appIcons) {
            const iconUrl = state.globalSettings.appIcons[iconId];
            const labelText = appLabels[iconId] || "Êú™Áü•App";

            const item = document.createElement("div");
            item.className = "icon-setting-item";
            // „ÄêÈáçË¶Å„ÄëÊàë‰ª¨Áî® data-icon-id Êù•Ê†áËÆ∞Ëøô‰∏™ËÆæÁΩÆÈ°πÂØπÂ∫îÂì™‰∏™ÂõæÊ†á
            item.dataset.iconId = iconId;

            item.innerHTML = `
                  <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
                  <button class="change-icon-btn">Êõ¥Êç¢</button>
              `;
            grid.appendChild(item);
          }
        }

        /**
         * ÂΩìÁî®Êà∑ÁÇπÂáªÈìæÊé•Âç°ÁâáÊó∂ÔºåÊâìÂºÄ‰º™ÊµèËßàÂô®
         * @param {number} timestamp - Ë¢´ÁÇπÂáªÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        function openBrowser(timestamp) {
          if (!state.activeChatId) return;

          const chat = state.chats[state.activeChatId];
          // ÂÆâÂÖ®Ê£ÄÊü•ÔºåÁ°Æ‰øù chat Âíå history ÈÉΩÂ≠òÂú®
          if (!chat || !chat.history) return;

          const message = chat.history.find((m) => m.timestamp === timestamp);
          if (!message || message.type !== "share_link") {
            console.error("Êó†Ê≥ïÊâæÂà∞ÊàñÊ∂àÊÅØÁ±ªÂûã‰∏çÂåπÈÖçÁöÑÂàÜ‰∫´ÈìæÊé•:", timestamp);
            return; // Â¶ÇÊûúÊâæ‰∏çÂà∞Ê∂àÊÅØÔºåÂ∞±Áõ¥Êé•ÈÄÄÂá∫
          }

          // Â°´ÂÖÖÊµèËßàÂô®ÂÜÖÂÆπ
          document.getElementById("browser-title").textContent =
            message.source_name || "ÊñáÁ´†ËØ¶ÊÉÖ";
          const browserContent = document.getElementById("browser-content");
          browserContent.innerHTML = `
              <h1 class="article-title">${message.title || "Êó†Ê†áÈ¢ò"}</h1>
              <div class="article-meta">
                  <span>Êù•Ê∫ê: ${message.source_name || "Êú™Áü•"}</span>
              </div>
              <div class="article-body">
                  <p>${(message.content || "ÂÜÖÂÆπ‰∏∫Á©∫„ÄÇ").replace(
                    /\n/g,
                    "</p><p>",
                  )}</p>
              </div>
          `;

          // ÊòæÁ§∫ÊµèËßàÂô®Â±èÂπï
          showScreen("browser-screen");
        }

        /**
         * ÂÖ≥Èó≠‰º™ÊµèËßàÂô®ÔºåËøîÂõûËÅäÂ§©ÁïåÈù¢
         * (Ëøô‰∏™ÂáΩÊï∞Áé∞Âú®Áî± init() ‰∏≠ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Ë∞ÉÁî®)
         */
        function closeBrowser() {
          showScreen("chat-interface-screen");
        }

        /**
         * ÊâìÂºÄËÆ©Áî®Êà∑Â°´ÂÜôÈìæÊé•‰ø°ÊÅØÁöÑÊ®°ÊÄÅÊ°Ü
         */
        function openShareLinkModal() {
          if (!state.activeChatId) return;

          // Ê∏ÖÁ©∫‰∏äÊ¨°ËæìÂÖ•ÁöÑÂÜÖÂÆπ
          document.getElementById("link-title-input").value = "";
          document.getElementById("link-description-input").value = "";
          document.getElementById("link-source-input").value = "";
          document.getElementById("link-content-input").value = "";

          // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
          document.getElementById("share-link-modal").classList.add("visible");
        }

        /**
         * Áî®Êà∑Á°ÆËÆ§ÂàÜ‰∫´ÔºåÂàõÂª∫Âπ∂ÂèëÈÄÅÈìæÊé•Âç°ÁâáÊ∂àÊÅØ
         */
        async function sendUserLinkShare() {
          if (!state.activeChatId) return;

          const title = document
            .getElementById("link-title-input")
            .value.trim();
          if (!title) {
            alert("Ê†áÈ¢òÊòØÂøÖÂ°´È°πÂì¶ÔºÅ");
            return;
          }

          const description = document
            .getElementById("link-description-input")
            .value.trim();
          const sourceName = document
            .getElementById("link-source-input")
            .value.trim();
          const content = document
            .getElementById("link-content-input")
            .value.trim();

          const chat = state.chats[state.activeChatId];

          // ÂàõÂª∫Ê∂àÊÅØÂØπË±°
          const linkMessage = {
            role: "user", // ËßíËâ≤ÊòØ 'user'
            type: "share_link",
            timestamp: Date.now(),
            title: title,
            description: description,
            source_name: sourceName,
            content: content,
            // Áî®Êà∑ÂàÜ‰∫´ÁöÑÈìæÊé•ÔºåÊàë‰ª¨‰∏çÊèê‰æõÂõæÁâáÔºåËÆ©ÂÆÉÊÄªÊòØÊòæÁ§∫Âç†‰ΩçÂõæ
            thumbnail_url: null,
          };

          // Â∞ÜÊ∂àÊÅØÊ∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
          chat.history.push(linkMessage);
          await db.chats.put(chat);

          // Ê∏≤ÊüìÊñ∞Ê∂àÊÅØÂπ∂Êõ¥Êñ∞ÂàóË°®
          appendMessage(linkMessage, chat);
          renderChatList();

          // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
          document
            .getElementById("share-link-modal")
            .classList.remove("visible");
        }

        /**
         * Ê†πÊçÆAIÁöÑËßÜËßíÔºåËøáÊª§Âá∫ÂÆÉËÉΩÁúãÂà∞ÁöÑÂä®ÊÄÅ
         * @param {Array} allPosts - ÊâÄÊúâÂæÖÊ£ÄÊü•ÁöÑÂä®ÊÄÅÂ∏ñÂ≠ê
         * @param {object} viewerChat - Ê≠£Âú®‚ÄúÁúã‚ÄùÂä®ÊÄÅÁöÑÈÇ£‰∏™AIÁöÑchatÂØπË±°
         * @returns {Array} - ËøáÊª§ÂêéËØ•AIÂèØËßÅÁöÑÂä®ÊÄÅÂ∏ñÂ≠ê
         */
        function filterVisiblePostsForAI(allPosts, viewerChat) {
          if (!viewerChat || !viewerChat.id) return []; // ÂÆâÂÖ®Ê£ÄÊü•

          const viewerGroupId = viewerChat.groupId; // Êü•ÁúãËÄÖÊâÄÂú®ÁöÑÂàÜÁªÑID

          return allPosts.filter((post) => {
            // ËßÑÂàô1ÔºöÂ¶ÇÊûúÊòØÁî®Êà∑ÂèëÁöÑÂä®ÊÄÅ
            if (post.authorId === "user") {
              // Â¶ÇÊûúÁî®Êà∑ËÆæÁΩÆ‰∫Ü‚ÄúÈÉ®ÂàÜÂèØËßÅ‚Äù
              if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                // Âè™ÊúâÂΩìÊü•ÁúãËÄÖAIÁöÑÂàÜÁªÑIDÂú®Áî®Êà∑ÁöÑÂèØËßÅÂàóË°®ÈáåÊó∂ÔºåÊâçÂèØËßÅ
                return (
                  viewerGroupId && post.visibleGroupIds.includes(viewerGroupId)
                );
              }
              // Â¶ÇÊûúÁî®Êà∑Ê≤°ËÆæÁΩÆÔºåËØ¥ÊòéÊòØÂÖ¨ÂºÄÁöÑÔºåÊâÄÊúâAIÈÉΩÂèØËßÅ
              return true;
            }

            // ËßÑÂàô2ÔºöÂ¶ÇÊûúÊòØÂÖ∂‰ªñAIÂèëÁöÑÂä®ÊÄÅ
            const authorGroupId = post.authorGroupId; // ÂèëÂ∏ñAIÊâÄÂú®ÁöÑÂàÜÁªÑID

            // Â¶ÇÊûúÂèëÂ∏ñÁöÑAIÊ≤°ÊúâÂàÜÁªÑÔºåÈÇ£ÂÆÉÁöÑÂä®ÊÄÅÂ∞±ÊòØÂÖ¨ÂºÄÁöÑ
            if (!authorGroupId) {
              return true;
            }

            // Â¶ÇÊûúÂèëÂ∏ñÁöÑAIÊúâÂàÜÁªÑÔºåÈÇ£‰πàÂè™ÊúâÂú®Âêå‰∏Ä‰∏™ÂàÜÁªÑÁöÑAIÊâçËÉΩÁúãÂà∞
            return authorGroupId === viewerGroupId;
          });
        }

        /**
         * Â∫îÁî®ÊåáÂÆöÁöÑ‰∏ªÈ¢òÔºà'light' Êàñ 'dark'Ôºâ
         * @param {string} theme - Ë¶ÅÂ∫îÁî®ÁöÑ‰∏ªÈ¢òÂêçÁß∞
         */
        function applyTheme(theme) {
          const phoneScreen = document.getElementById("phone-screen");
          const toggleSwitch = document.getElementById("theme-toggle-switch");

          const isDark = theme === "dark";

          phoneScreen.classList.toggle("dark-mode", isDark);
          document.body.classList.toggle("dark-mode", isDark);

          // Â¶ÇÊûúÂºÄÂÖ≥Â≠òÂú®ÔºåÂ∞±ÂêåÊ≠•ÂÆÉÁöÑÁä∂ÊÄÅ
          if (toggleSwitch) {
            toggleSwitch.checked = isDark;
          }

          localStorage.setItem("ephone-theme", theme);
        }

        /**
         * ÂàáÊç¢ÂΩìÂâçÁöÑ‰∏ªÈ¢ò
         */
        function toggleTheme() {
          const toggleSwitch = document.getElementById("theme-toggle-switch");
          // Áõ¥Êé•Ê†πÊçÆÂºÄÂÖ≥ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅÊù•ÂÜ≥ÂÆöÊñ∞‰∏ªÈ¢ò
          const newTheme = toggleSwitch.checked ? "dark" : "light";
          applyTheme(newTheme);
        }

        function startReplyToMessage() {
          if (!activeMessageTimestamp) return;

          const chat = state.chats[state.activeChatId];
          const message = chat.history.find(
            (m) => m.timestamp === activeMessageTimestamp,
          );
          if (!message) return;

          // 1. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂêåÊó∂Ëé∑Âèñ‚ÄúÂÆåÊï¥ÂÜÖÂÆπ‚ÄùÂíå‚ÄúÈ¢ÑËßàÁâáÊÆµ‚Äù
          const fullContent = String(message.content || "");
          let previewSnippet = "";

          if (
            typeof message.content === "string" &&
            STICKER_REGEX.test(message.content)
          ) {
            previewSnippet = "[Ë°®ÊÉÖ]";
          } else if (
            message.type === "ai_image" ||
            message.type === "user_photo"
          ) {
            previewSnippet = "[ÂõæÁâá]";
          } else if (message.type === "voice_message") {
            previewSnippet = "[ËØ≠Èü≥]";
          } else {
            // È¢ÑËßàÁâáÊÆµ‰æùÁÑ∂Êà™Êñ≠Ôºå‰ΩÜÂè™Áî®‰∫éUIÊòæÁ§∫
            previewSnippet =
              fullContent.substring(0, 50) +
              (fullContent.length > 50 ? "..." : "");
          }

          // 2. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ∞Ü‚ÄúÂÆåÊï¥ÂÜÖÂÆπ‚ÄùÂ≠òÂÖ•‰∏ä‰∏ãÊñáÔºå‰ª•Â§áÂèëÈÄÅÊó∂‰ΩøÁî®
          currentReplyContext = {
            timestamp: message.timestamp,
            senderName:
              message.senderName ||
              (message.role === "user"
                ? chat.settings.myNickname || "Êàë"
                : chat.name),
            content: fullContent, // <--- ËøôÈáåÂ≠òÁöÑÊòØÂÆåÊï¥ÁöÑÂéüÊñáÔºÅ
          };

          // 3. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„Äë‰ªÖÂú®Êõ¥Êñ∞‚ÄúÂõûÂ§çÈ¢ÑËßàÊ†è‚ÄùÊó∂ÔºåÊâç‰ΩøÁî®‚ÄúÈ¢ÑËßàÁâáÊÆµ‚Äù
          const previewBar = document.getElementById("reply-preview-bar");
          previewBar.querySelector(".sender").textContent =
            `ÂõûÂ§ç ${currentReplyContext.senderName}:`;
          previewBar.querySelector(".text").textContent = previewSnippet; // <--- ËøôÈáåÁî®ÁöÑÊòØÁº©Áï•ÁâàÔºÅ
          previewBar.style.display = "block";

          // 4. ÂêéÁª≠Êìç‰Ωú‰øùÊåÅ‰∏çÂèò
          hideMessageActions();
          document.getElementById("chat-input").focus();
        }

        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂèñÊ∂àÂºïÁî®Ê®°Âºè
         */
        function cancelReplyMode() {
          currentReplyContext = null;
          document.getElementById("reply-preview-bar").style.display = "none";
        }

        let activeTransferTimestamp = null; // Áî®‰∫éÊöÇÂ≠òË¢´ÁÇπÂáªÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥

        /**
         * ÊòæÁ§∫Â§ÑÁêÜËΩ¨Ë¥¶ÁöÑÊìç‰ΩúËèúÂçï
         * @param {number} timestamp - Ë¢´ÁÇπÂáªÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        function showTransferActionModal(timestamp) {
          activeTransferTimestamp = timestamp;

          const chat = state.chats[state.activeChatId];
          const message = chat.history.find((m) => m.timestamp === timestamp);
          if (message) {
            // Â∞ÜAIÁöÑÂêçÂ≠óÂ°´ÂÖ•ÂºπÁ™ó
            document.getElementById("transfer-sender-name").textContent =
              message.senderName;
          }
          document
            .getElementById("transfer-actions-modal")
            .classList.add("visible");
        }

        /**
         * ÈöêËóèÂ§ÑÁêÜËΩ¨Ë¥¶ÁöÑÊìç‰ΩúËèúÂçï
         */
        function hideTransferActionModal() {
          document
            .getElementById("transfer-actions-modal")
            .classList.remove("visible");
          activeTransferTimestamp = null;
        }

        /**
         * Â§ÑÁêÜÁî®Êà∑Êé•ÂèóÊàñÊãíÁªùËΩ¨Ë¥¶ÁöÑÈÄªËæë
         * @param {string} choice - Áî®Êà∑ÁöÑÈÄâÊã©, 'accepted' Êàñ 'declined'
         */
        async function handleUserTransferResponse(choice) {
          if (!activeTransferTimestamp) return;

          const timestamp = activeTransferTimestamp;
          const chat = state.chats[state.activeChatId];
          const messageIndex = chat.history.findIndex(
            (m) => m.timestamp === timestamp,
          );
          if (messageIndex === -1) return;

          // 1. Êõ¥Êñ∞ÂéüÂßãËΩ¨Ë¥¶Ê∂àÊÅØÁöÑÁä∂ÊÄÅ
          const originalMessage = chat.history[messageIndex];
          originalMessage.status = choice;

          let systemContent;

          // 2. Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©‚ÄúÊãíÁªù‚Äù
          if (choice === "declined") {
            // Á´ãÂàªÂú®ÂâçÁ´ØÁîüÊàê‰∏Ä‰∏™‚ÄúÈÄÄÊ¨æ‚ÄùÂç°ÁâáÔºåËÆ©Áî®Êà∑ÁúãÂà∞
            const refundMessage = {
              role: "user",
              type: "transfer",
              isRefund: true, // ËøôÊòØ‰∏Ä‰∏™ÂÖ≥ÈîÆÊ†áËÆ∞ÔºåÁî®‰∫éUIÊòæÁ§∫ËøôÊòØÈÄÄÊ¨æ
              amount: originalMessage.amount,
              note: "Â∑≤ÊãíÊî∂ÂØπÊñπËΩ¨Ë¥¶",
              timestamp: Date.now(),
            };
            chat.history.push(refundMessage);

            // ÂáÜÂ§á‰∏ÄÊù°ÂØπAIÂèØËßÅÁöÑÈöêËóèÊ∂àÊÅØÔºåÂëäËØâÂÆÉÂèëÁîü‰∫Ü‰ªÄ‰πà
            systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÊãíÁªùÂπ∂ÈÄÄËøò‰∫Ü‚Äú${originalMessage.senderName}‚ÄùÁöÑËΩ¨Ë¥¶„ÄÇ]`;
          } else {
            // Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©‚ÄúÊé•Âèó‚Äù
            // Âè™ÈúÄÂáÜÂ§áÈöêËóèÊ∂àÊÅØÈÄöÁü•AIÂç≥ÂèØ
            systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Êé•Âèó‰∫Ü‚Äú${originalMessage.senderName}‚ÄùÁöÑËΩ¨Ë¥¶„ÄÇ]`;
          }

          // 3. ÂàõÂª∫ËøôÊù°ÂØπÁî®Êà∑ÈöêËóè„ÄÅ‰ΩÜÂØπAIÂèØËßÅÁöÑÁ≥ªÁªüÊ∂àÊÅØ
          const hiddenMessage = {
            role: "system",
            content: systemContent,
            timestamp: Date.now() + 1, // ‰øùËØÅÊó∂Èó¥Êà≥Âú®ÈÄÄÊ¨æÊ∂àÊÅØ‰πãÂêé
            isHidden: true, // Ëøô‰∏™Ê†áËÆ∞‰ºöËÆ©ÂÆÉ‰∏çÂú®ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫
          };
          chat.history.push(hiddenMessage);

          // 4. ‰øùÂ≠òÊâÄÊúâÊõ¥ÊîπÂà∞Êï∞ÊçÆÂ∫ìÔºåÂπ∂Âà∑Êñ∞ÁïåÈù¢
          await db.chats.put(chat);
          hideTransferActionModal();
          renderChatInterface(state.activeChatId);
          renderChatList();
        }

        async function renderCallHistoryScreen() {
          showScreen("call-history-screen"); // <--„ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊääÂÆÉÁßªÂä®Âà∞ÊúÄÂâçÈù¢ÔºÅ

          const listEl = document.getElementById("call-history-list");
          const titleEl = document.getElementById("call-history-title");
          listEl.innerHTML = "";
          titleEl.textContent = "ÊâÄÊúâÈÄöËØùËÆ∞ÂΩï";

          const records = await db.callRecords
            .orderBy("timestamp")
            .reverse()
            .toArray();

          if (records.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°ÊúâÈÄöËØùËÆ∞ÂΩïÂì¶~</p>';
            return; // Áé∞Âú®ÁöÑ return Â∞±Ê≤°ÈóÆÈ¢ò‰∫ÜÔºåÂõ†‰∏∫ÂÆÉÂè™Ë∑≥Ëøá‰∫ÜÂêéÁª≠ÁöÑÊ∏≤ÊüìÈÄªËæë
          }

          records.forEach((record) => {
            const card = createCallRecordCard(record);

            addLongPressListener(card, async () => {
              // 1. ÂºπÂá∫ËæìÂÖ•Ê°ÜÔºåÂπ∂Â∞ÜÊóßÂêçÁß∞‰Ωú‰∏∫ÈªòËÆ§ÂÄºÔºåÊñπ‰æø‰øÆÊîπ
              const newName = await showCustomPrompt(
                "Ëá™ÂÆö‰πâÈÄöËØùÂêçÁß∞",
                "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂêçÁß∞ÔºàÁïôÁ©∫ÂàôÊÅ¢Â§çÈªòËÆ§Ôºâ",
                record.customName || "", // Â¶ÇÊûúÂ∑≤ÊúâËá™ÂÆö‰πâÂêçÁß∞ÔºåÂ∞±ÊòæÁ§∫ÂÆÉ
              );

              // 2. Â¶ÇÊûúÁî®Êà∑ÁÇπÂáª‰∫Ü‚ÄúÂèñÊ∂à‚ÄùÔºåÂàô‰ªÄ‰πàÈÉΩ‰∏çÂÅö
              if (newName === null) return;

              // 3. Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑËøôÊù°ËÆ∞ÂΩï
              await db.callRecords.update(record.id, {
                customName: newName.trim(),
              });

              // 4. Âà∑Êñ∞Êï¥‰∏™ÂàóË°®ÔºåËÆ©Êõ¥ÊîπÁ´ãÂàªÊòæÁ§∫Âá∫Êù•
              await renderCallHistoryScreen();

              // 5. ÁªôÁî®Êà∑‰∏Ä‰∏™ÊàêÂäüÁöÑÊèêÁ§∫
              await showCustomAlert("ÊàêÂäü", "ÈÄöËØùÂêçÁß∞Â∑≤Êõ¥Êñ∞ÔºÅ");
            });
            listEl.appendChild(card);
          });
        }

        /**
         * „ÄêÂçáÁ∫ßÁâà„ÄëÊ†πÊçÆÂçïÊù°ËÆ∞ÂΩïÊï∞ÊçÆÔºåÂàõÂª∫‰∏ÄÂº†ËÉΩÊòæÁ§∫ËÅäÂ§©ÂØπË±°ÁöÑÈÄöËØùÂç°Áâá
         * @param {object} record - ‰∏ÄÊù°ÈÄöËØùËÆ∞ÂΩïÂØπË±°
         * @returns {HTMLElement} - ÂàõÂª∫Â•ΩÁöÑÂç°Áâádiv
         */
        function createCallRecordCard(record) {
          const card = document.createElement("div");
          card.className = "call-record-card";
          card.dataset.recordId = record.id;

          // Ëé∑ÂèñÈÄöËØùÂØπË±°ÁöÑÂêçÂ≠ó
          const chatInfo = state.chats[record.chatId];
          const chatName = chatInfo ? chatInfo.name : "Êú™Áü•‰ºöËØù";

          const callDate = new Date(record.timestamp);
          const dateString = `${callDate.getFullYear()}-${String(
            callDate.getMonth() + 1,
          ).padStart(2, "0")}-${String(callDate.getDate()).padStart(
            2,
            "0",
          )} ${String(callDate.getHours()).padStart(2, "0")}:${String(
            callDate.getMinutes(),
          ).padStart(2, "0")}`;
          const durationText = `${Math.floor(record.duration / 60)}ÂàÜ${
            record.duration % 60
          }Áßí`;

          const avatarsHtml = record.participants
            .map(
              (p) =>
                `<img src="${p.avatar}" alt="${p.name}" class="participant-avatar" title="${p.name}">`,
            )
            .join("");

          card.innerHTML = `
              <div class="card-header">
                  <span class="date">${dateString}</span>
                  <span class="duration">${durationText}</span>
              </div>
              <div class="card-body">
                  <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåÊñ∞Â¢û‰∏Ä‰∏™Ê†áÈ¢òË°å -->
                  ${
                    record.customName
                      ? `<div class="custom-title">${record.customName}</div>`
                      : ""
                  }

                  <div class="participants-info"> <!-- Êñ∞Â¢û‰∏Ä‰∏™ÂÆπÂô®Êñπ‰æøÂ∏ÉÂ±Ä -->
                      <div class="participants-avatars">${avatarsHtml}</div>
                      <span class="participants-names">‰∏é ${chatName}</span>
                  </div>
              </div>
          `;
          return card;
        }

        /**
         * ÊòæÁ§∫ÊåáÂÆöÈÄöËØùËÆ∞ÂΩïÁöÑÂÆåÊï¥ÊñáÂ≠óÁ®ø
         * @param {number} recordId - ÈÄöËØùËÆ∞ÂΩïÁöÑID
         */
        async function showCallTranscript(recordId) {
          const record = await db.callRecords.get(recordId);
          if (!record) return;

          const modal = document.getElementById("call-transcript-modal");
          const titleEl = document.getElementById("transcript-modal-title");
          const bodyEl = document.getElementById("transcript-modal-body");

          titleEl.textContent = `ÈÄöËØù‰∫é ${new Date(
            record.timestamp,
          ).toLocaleString()} (Êó∂Èïø: ${Math.floor(record.duration / 60)}ÂàÜ${
            record.duration % 60
          }Áßí)`;
          bodyEl.innerHTML = "";

          if (!record.transcript || record.transcript.length === 0) {
            bodyEl.innerHTML =
              '<p style="text-align:center; color: #8a8a8a;">ËøôÊ¨°ÈÄöËØùÊ≤°ÊúâÁïô‰∏ãÊñáÂ≠óËÆ∞ÂΩï„ÄÇ</p>';
          } else {
            record.transcript.forEach((entry) => {
              const bubble = document.createElement("div");
              // Ê†πÊçÆËßíËâ≤Ê∑ªÂä†‰∏çÂêåÁöÑclassÔºåÂ∫îÁî®‰∏çÂêåÁöÑÊ†∑Âºè
              bubble.className = `transcript-entry ${entry.role}`;
              bubble.textContent = entry.content;
              bodyEl.appendChild(bubble);
            });
          }

          const deleteBtn = document.getElementById("delete-transcript-btn");

          // „ÄêÈáçË¶Å„Äë‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÊäÄÂ∑ßÔºåÈò≤Ê≠¢‰∫ã‰ª∂ÈáçÂ§çÁªëÂÆö
          const newDeleteBtn = deleteBtn.cloneNode(true);
          deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);

          // ‰∏∫Êñ∞ÁöÑ„ÄÅÂπ≤ÂáÄÁöÑÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂
          newDeleteBtn.addEventListener("click", async () => {
            const confirmed = await showCustomConfirm(
              "Á°ÆËÆ§Âà†Èô§",
              "Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÊù°ÈÄöËØùËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ",
              { confirmButtonClass: "btn-danger" },
            );

            if (confirmed) {
              // 1. ÂÖ≥Èó≠ÂΩìÂâçÁöÑËØ¶ÊÉÖÂºπÁ™ó
              modal.classList.remove("visible");

              // 2. ‰ªéÊï∞ÊçÆÂ∫ìÂà†Èô§
              await db.callRecords.delete(recordId);

              // 3. Âà∑Êñ∞ÈÄöËØùËÆ∞ÂΩïÂàóË°®
              await renderCallHistoryScreen();

              // 4. (ÂèØÈÄâ) ÁªôÂá∫ÊàêÂäüÊèêÁ§∫
              alert("ÈÄöËØùËÆ∞ÂΩïÂ∑≤Âà†Èô§„ÄÇ");
            }
          });
          modal.classList.add("visible");
        }

        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜÁî®Êà∑ÁÇπÂáªÁä∂ÊÄÅÊ†èÔºåÂºπÂá∫ÁºñËæëÊ°ÜËÆ©Áî®Êà∑‰øÆÊîπAIÁöÑÂΩìÂâçÁä∂ÊÄÅ
         */
        async function handleEditStatusClick() {
          // 1. ÂÆâÂÖ®Ê£ÄÊü•ÔºåÁ°Æ‰øùÂú®ÂçïËÅäÁïåÈù¢
          if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
            return;
          }
          const chat = state.chats[state.activeChatId];

          // 2. ÂºπÂá∫ËæìÂÖ•Ê°ÜÔºåËÆ©Áî®Êà∑ËæìÂÖ•Êñ∞ÁöÑÁä∂ÊÄÅÔºåÂπ∂Â∞ÜÂΩìÂâçÁä∂ÊÄÅ‰Ωú‰∏∫ÈªòËÆ§ÂÄº
          const newStatusText = await showCustomPrompt(
            "ÁºñËæëÂØπÊñπÁä∂ÊÄÅ",
            "ËØ∑ËæìÂÖ•ÂØπÊñπÁé∞Âú®ÁöÑÊñ∞Áä∂ÊÄÅÔºö",
            chat.status.text, // Â∞ÜÂΩìÂâçÁä∂ÊÄÅ‰Ωú‰∏∫ËæìÂÖ•Ê°ÜÁöÑÈªòËÆ§ÂÜÖÂÆπ
          );

          // 3. Â¶ÇÊûúÁî®Êà∑ËæìÂÖ•‰∫ÜÂÜÖÂÆπÂπ∂ÁÇπÂáª‰∫Ü‚ÄúÁ°ÆÂÆö‚Äù
          if (newStatusText !== null) {
            // 4. Êõ¥Êñ∞ÂÜÖÂ≠òÂíåÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÁä∂ÊÄÅÊï∞ÊçÆ
            chat.status.text = newStatusText.trim() || "Âú®Á∫ø"; // Â¶ÇÊûúÁî®Êà∑Ê∏ÖÁ©∫‰∫ÜÔºåÂ∞±ÈªòËÆ§‰∏∫‚ÄúÂú®Á∫ø‚Äù
            chat.status.isBusy = false; // ÊØèÊ¨°ÊâãÂä®ÁºñËæëÈÉΩÈªòËÆ§ÂÖ∂‰∏çÂ§Ñ‰∫é‚ÄúÂøôÁ¢å‚ÄùÁä∂ÊÄÅ
            chat.status.lastUpdate = Date.now();
            await db.chats.put(chat);

            // 5. Á´ãÂàªÂà∑Êñ∞UIÔºåËÆ©Áî®Êà∑ÁúãÂà∞‰øÆÊîπÂêéÁöÑÁä∂ÊÄÅ
            renderChatInterface(state.activeChatId);
            renderChatList();

            // 6. ÁªôÂá∫‰∏Ä‰∏™Êó†‰º§Â§ßÈõÖÁöÑÊàêÂäüÊèêÁ§∫
            await showCustomAlert(
              "Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞",
              `‚Äú${chat.name}‚ÄùÁöÑÂΩìÂâçÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫Ôºö${chat.status.text}`,
            );
          }
        }

        // ÊîæÂú®‰Ω†ÁöÑJSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫
        async function openShareTargetPicker() {
          const modal = document.getElementById("share-target-modal");
          const listEl = document.getElementById("share-target-list");
          listEl.innerHTML = "";

          // Ëé∑ÂèñÊâÄÊúâËÅäÂ§©‰Ωú‰∏∫ÂàÜ‰∫´ÁõÆÊ†á
          const chats = Object.values(state.chats);

          chats.forEach((chat) => {
            // Â§çÁî®ËÅîÁ≥ª‰∫∫ÈÄâÊã©Âô®ÁöÑÊ†∑Âºè
            const item = document.createElement("div");
            item.className = "contact-picker-item";
            item.innerHTML = `
                  <input type="checkbox" class="share-target-checkbox" data-chat-id="${
                    chat.id
                  }" style="margin-right: 15px;">
                  <img src="${
                    chat.isGroup
                      ? chat.settings.groupAvatar
                      : chat.settings.aiAvatar || defaultAvatar
                  }" class="avatar">
                  <span class="name">${chat.name}</span>
              `;
            listEl.appendChild(item);
          });

          modal.classList.add("visible");
        }

        function closeMusicPlayerWithAnimation(callback) {
          const overlay = document.getElementById("music-player-overlay");
          if (!overlay.classList.contains("visible")) {
            if (callback) callback();
            return;
          }
          overlay.classList.remove("visible");
          setTimeout(() => {
            document
              .getElementById("music-playlist-panel")
              .classList.remove("visible");
            if (callback) callback();
          }, 400);
        }

        function parseLRC(lrcContent) {
          if (!lrcContent) return [];
          const lines = lrcContent.split("\n");
          const lyrics = [];
          const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;

          for (const line of lines) {
            const text = line.replace(timeRegex, "").trim();
            if (!text) continue;
            timeRegex.lastIndex = 0;
            let match;
            while ((match = timeRegex.exec(line)) !== null) {
              const minutes = parseInt(match[1], 10);
              const seconds = parseInt(match[2], 10);
              const milliseconds = parseInt(match[3].padEnd(3, "0"), 10);
              const time = minutes * 60 + seconds + milliseconds / 1000;
              lyrics.push({ time, text });
            }
          }
          return lyrics.sort((a, b) => a.time - b.time);
        }

        function renderLyrics() {
          const lyricsList = document.getElementById("music-lyrics-list");
          lyricsList.innerHTML = "";
          if (
            !musicState.parsedLyrics ||
            musicState.parsedLyrics.length === 0
          ) {
            lyricsList.innerHTML = '<div class="lyric-line">‚ô™ ÊöÇÊó†Ê≠åËØç ‚ô™</div>';
            return;
          }
          musicState.parsedLyrics.forEach((line, index) => {
            const lineEl = document.createElement("div");
            lineEl.className = "lyric-line";
            lineEl.textContent = line.text;
            lineEl.dataset.index = index;
            lyricsList.appendChild(lineEl);
          });
          lyricsList.style.transform = `translateY(0px)`;
        }

        function updateActiveLyric(currentTime) {
          if (musicState.parsedLyrics.length === 0) return;
          let newLyricIndex = -1;
          for (let i = 0; i < musicState.parsedLyrics.length; i++) {
            if (currentTime >= musicState.parsedLyrics[i].time) {
              newLyricIndex = i;
            } else {
              break;
            }
          }
          if (newLyricIndex === musicState.currentLyricIndex) return;
          musicState.currentLyricIndex = newLyricIndex;
          updateLyricsUI();
        }

        function updateLyricsUI() {
          const lyricsList = document.getElementById("music-lyrics-list");
          const container = document.getElementById("music-lyrics-container");
          const lines = lyricsList.querySelectorAll(".lyric-line");
          lines.forEach((line) => line.classList.remove("active"));
          if (musicState.currentLyricIndex === -1) {
            lyricsList.style.transform = `translateY(0px)`;
            return;
          }
          const activeLine = lyricsList.querySelector(
            `.lyric-line[data-index="${musicState.currentLyricIndex}"]`,
          );
          if (activeLine) {
            activeLine.classList.add("active");
            const containerHeight = container.offsetHeight;
            const offset =
              containerHeight / 3 -
              activeLine.offsetTop -
              activeLine.offsetHeight / 2;
            lyricsList.style.transform = `translateY(${offset}px)`;
          }
        }

        function formatMusicTime(seconds) {
          if (isNaN(seconds) || seconds < 0) return "0:00";
          const minutes = Math.floor(seconds / 60);
          const remainingSeconds = Math.floor(seconds % 60);
          return `${minutes}:${String(remainingSeconds).padStart(2, "0")}`;
        }

        function updateMusicProgressBar() {
          const currentTimeEl = document.getElementById("music-current-time");
          const totalTimeEl = document.getElementById("music-total-time");
          const progressFillEl = document.getElementById("music-progress-fill");
          if (!audioPlayer.duration) {
            currentTimeEl.textContent = "0:00";
            totalTimeEl.textContent = "0:00";
            progressFillEl.style.width = "0%";
            return;
          }
          const progressPercent =
            (audioPlayer.currentTime / audioPlayer.duration) * 100;
          progressFillEl.style.width = `${progressPercent}%`;
          currentTimeEl.textContent = formatMusicTime(audioPlayer.currentTime);
          totalTimeEl.textContent = formatMusicTime(audioPlayer.duration);
          updateActiveLyric(audioPlayer.currentTime);
        }

        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜÁî®Êà∑ÁÇπÂáª‚ÄúÊí§Âõû‚ÄùÊåâÈíÆÁöÑÂÖ•Âè£ÂáΩÊï∞
         */
        async function handleRecallClick() {
          if (!activeMessageTimestamp) return;

          const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000; // ËÆæÁΩÆ2ÂàÜÈíüÁöÑÊí§ÂõûÊó∂Èôê
          const messageTime = activeMessageTimestamp;
          const now = Date.now();

          // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖËøá‰∫ÜÊí§ÂõûÊó∂Èôê
          if (now - messageTime > RECALL_TIME_LIMIT_MS) {
            hideMessageActions();
            await showCustomAlert(
              "Êìç‰ΩúÂ§±Ë¥•",
              "ËØ•Ê∂àÊÅØÂèëÈÄÅÂ∑≤Ë∂ÖËøá2ÂàÜÈíüÔºåÊó†Ê≥ïÊí§Âõû„ÄÇ",
            );
            return;
          }

          // Â¶ÇÊûúÂú®Êó∂ÈôêÂÜÖÔºåÊâßË°åÁúüÊ≠£ÁöÑÊí§ÂõûÈÄªËæë
          await recallMessage(messageTime, true);
          hideMessageActions();
        }

        /**
         * „ÄêÂÖ®Êñ∞„ÄëÊ∂àÊÅØÊí§ÂõûÁöÑÊ†∏ÂøÉÈÄªËæë
         * @param {number} timestamp - Ë¶ÅÊí§ÂõûÁöÑÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         * @param {boolean} isUserRecall - ÊòØÂê¶ÊòØÁî®Êà∑‰∏ªÂä®Êí§Âõû
         */
        async function recallMessage(timestamp, isUserRecall) {
          const chat = state.chats[state.activeChatId];
          if (!chat) return;

          const messageIndex = chat.history.findIndex(
            (m) => m.timestamp === timestamp,
          );
          if (messageIndex === -1) return;

          const messageToRecall = chat.history[messageIndex];

          // 1. ‰øÆÊîπÊ∂àÊÅØÂØπË±°ÔºåÂ∞ÜÂÖ∂Âèò‰∏∫‚ÄúÂ∑≤Êí§Âõû‚ÄùÁä∂ÊÄÅ
          const recalledData = {
            originalType: messageToRecall.type || "text",
            originalContent: messageToRecall.content,
            // ‰øùÂ≠òÂÖ∂‰ªñÂèØËÉΩÂ≠òÂú®ÁöÑÂéüÂßãÊï∞ÊçÆ
            originalMeaning: messageToRecall.meaning,
            originalQuote: messageToRecall.quote,
          };

          messageToRecall.type = "recalled_message";
          messageToRecall.content = isUserRecall
            ? "‰Ω†Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ"
            : "ÂØπÊñπÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ";
          messageToRecall.recalledData = recalledData;
          // Ê∏ÖÁêÜÊéâ‰∏çÂÜçÈúÄË¶ÅÁöÑÊóßÂ±ûÊÄß
          delete messageToRecall.meaning;
          delete messageToRecall.quote;

          // 2. Â¶ÇÊûúÊòØÁî®Êà∑Êí§ÂõûÔºåÈúÄË¶ÅÁªôAIÂèëÈÄÅ‰∏ÄÊù°ÂÆÉÁúã‰∏çÊáÇÂÜÖÂÆπÁöÑÈöêËóèÊèêÁ§∫
          if (isUserRecall) {
            const hiddenMessageForAI = {
              role: "system",
              content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ‰Ω†‰∏çÁü•ÈÅìÂÜÖÂÆπÊòØ‰ªÄ‰πàÔºåÂè™ÈúÄÁü•ÈÅìËøô‰∏™‰∫ã‰ª∂Âç≥ÂèØ„ÄÇ]`,
              timestamp: Date.now(),
              isHidden: true,
            };
            chat.history.push(hiddenMessageForAI);
          }

          // 3. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÂπ∂Âà∑Êñ∞UI
          await db.chats.put(chat);
          renderChatInterface(state.activeChatId);
          if (isUserRecall) renderChatList(); // Áî®Êà∑Êí§ÂõûÊó∂ÔºåÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÂèò‰∫ÜÔºåÈúÄË¶ÅÂà∑Êñ∞ÂàóË°®
        }

        /**
         * ÊâìÂºÄÂàÜÁ±ªÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
         */
        async function openCategoryManager() {
          await renderCategoryListInManager();
          document
            .getElementById("world-book-category-manager-modal")
            .classList.add("visible");
        }

        /**
         * Âú®Ê®°ÊÄÅÊ°Ü‰∏≠Ê∏≤ÊüìÂ∑≤Â≠òÂú®ÁöÑÂàÜÁ±ªÂàóË°®
         */
        async function renderCategoryListInManager() {
          const listEl = document.getElementById("existing-categories-list");
          const categories = await db.worldBookCategories.toArray();
          listEl.innerHTML = "";
          if (categories.length === 0) {
            listEl.innerHTML =
              '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ª</p>';
          }
          categories.forEach((cat) => {
            // Â§çÁî®Â•ΩÂèãÂàÜÁªÑÁöÑÊ†∑Âºè
            const item = document.createElement("div");
            item.className = "existing-group-item";
            item.innerHTML = `
                  <span class="group-name">${cat.name}</span>
                  <span class="delete-group-btn" data-id="${cat.id}">√ó</span>
              `;
            listEl.appendChild(item);
          });
        }

        /**
         * Ê∑ªÂä†‰∏Ä‰∏™Êñ∞ÁöÑ‰∏ñÁïå‰π¶ÂàÜÁ±ª
         */
        async function addNewCategory() {
          const input = document.getElementById("new-category-name-input");
          const name = input.value.trim();
          if (!name) {
            alert("ÂàÜÁ±ªÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
            return;
          }
          const existing = await db.worldBookCategories
            .where("name")
            .equals(name)
            .first();
          if (existing) {
            alert(`ÂàÜÁ±ª "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);
            return;
          }
          await db.worldBookCategories.add({ name });
          input.value = "";
          await renderCategoryListInManager();
        }

        /**
         * Âà†Èô§‰∏Ä‰∏™‰∏ñÁïå‰π¶ÂàÜÁ±ª
         * @param {number} categoryId - Ë¶ÅÂà†Èô§ÁöÑÂàÜÁ±ªÁöÑID
         */
        async function deleteCategory(categoryId) {
          const confirmed = await showCustomConfirm(
            "Á°ÆËÆ§Âà†Èô§",
            "Âà†Èô§ÂàÜÁ±ªÂêéÔºåËØ•ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâ‰∏ñÁïå‰π¶Â∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁ±ª‚Äù„ÄÇÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü",
            { confirmButtonClass: "btn-danger" },
          );
          if (confirmed) {
            await db.worldBookCategories.delete(categoryId);
            // Â∞ÜÂ±û‰∫éËØ•ÂàÜÁ±ªÁöÑ‰∏ñÁïå‰π¶ÁöÑ categoryId ËÆæ‰∏∫ null
            const booksToUpdate = await db.worldBooks
              .where("categoryId")
              .equals(categoryId)
              .toArray();
            for (const book of booksToUpdate) {
              book.categoryId = null;
              await db.worldBooks.put(book);
              const bookInState = state.worldBooks.find(
                (wb) => wb.id === book.id,
              );
              if (bookInState) bookInState.categoryId = null;
            }
            await renderCategoryListInManager();
          }
        }

        // ===================================================================
        // 4. ÂàùÂßãÂåñÂáΩÊï∞ init()
        // ===================================================================
        async function init() {
          const savedTheme = localStorage.getItem("ephone-theme") || "light"; // ÈªòËÆ§‰∏∫Êó•Èó¥Ê®°Âºè
          applyTheme(savedTheme);

          const customBubbleStyleTag = document.createElement("style");
          customBubbleStyleTag.id = "custom-bubble-style";
          document.head.appendChild(customBubbleStyleTag);

          const previewBubbleStyleTag = document.createElement("style");
          previewBubbleStyleTag.id = "preview-bubble-style";
          document.head.appendChild(previewBubbleStyleTag);

          applyScopedCss("", "#chat-messages", "custom-bubble-style"); // Ê∏ÖÈô§ÁúüÂÆûËÅäÂ§©ÁïåÈù¢ÁöÑËá™ÂÆö‰πâÊ†∑Âºè
          applyScopedCss("", "#settings-preview-area", "preview-bubble-style"); // Ê∏ÖÈô§È¢ÑËßàÂå∫ÁöÑËá™ÂÆö‰πâÊ†∑Âºè

          window.showScreen = showScreen;
          window.renderChatListProxy = renderChatList;
          window.renderApiSettingsProxy = renderApiSettings;
          window.renderWallpaperScreenProxy = renderWallpaperScreen;
          window.renderWorldBookScreenProxy = renderWorldBookScreen;

          await loadAllDataFromDB();

          // ÂàùÂßãÂåñÊú™ËØªÂä®ÊÄÅËÆ°Êï∞
          const storedCount =
            parseInt(localStorage.getItem("unreadPostsCount")) || 0;
          updateUnreadIndicator(storedCount);

          if (state.globalSettings && state.globalSettings.fontUrl) {
            applyCustomFont(state.globalSettings.fontUrl);
          }

          updateClock();
          setInterval(updateClock, 1000 * 30);
          applyGlobalWallpaper();
          initBatteryManager();

          applyAppIcons();

          // ==========================================================
          // --- ÂêÑÁßç‰∫ã‰ª∂ÁõëÂê¨Âô® ---
          // ==========================================================

          document
            .getElementById("custom-modal-cancel")
            .addEventListener("click", hideCustomModal);
          document
            .getElementById("custom-modal-overlay")
            .addEventListener("click", (e) => {
              if (e.target === modalOverlay) hideCustomModal();
            });
          document
            .getElementById("export-data-btn")
            .addEventListener("click", exportBackup);
          document
            .getElementById("import-btn")
            .addEventListener("click", () =>
              document.getElementById("import-data-input").click(),
            );
          document
            .getElementById("import-data-input")
            .addEventListener("change", (e) => importBackup(e.target.files[0]));
          document
            .getElementById("back-to-list-btn")
            .addEventListener("click", () => {
              applyScopedCss("", "#chat-messages", "custom-bubble-style"); // Ê∏ÖÈô§ÁúüÂÆûËÅäÂ§©ÁïåÈù¢ÁöÑËá™ÂÆö‰πâÊ†∑Âºè
              applyScopedCss(
                "",
                "#settings-preview-area",
                "preview-bubble-style",
              ); // Ê∏ÖÈô§È¢ÑËßàÂå∫ÁöÑËá™ÂÆö‰πâÊ†∑Âºè

              exitSelectionMode();
              state.activeChatId = null;
              showScreen("chat-list-screen");
            });

          document
            .getElementById("add-chat-btn")
            .addEventListener("click", async () => {
              const name = await showCustomPrompt(
                "ÂàõÂª∫Êñ∞ËÅäÂ§©",
                "ËØ∑ËæìÂÖ•TaÁöÑÂêçÂ≠ó",
              );
              if (name && name.trim()) {
                const newChatId = "chat_" + Date.now();
                const newChat = {
                  id: newChatId,
                  name: name.trim(),
                  isGroup: false,
                  relationship: {
                    status: "friend", // 'friend', 'blocked_by_user', 'pending_user_approval'
                    blockedTimestamp: null,
                    applicationReason: "",
                  },
                  status: {
                    text: "Âú®Á∫ø",
                    lastUpdate: Date.now(),
                    isBusy: false,
                  },
                  settings: {
                    aiPersona: "‰Ω†ÊòØË∞ÅÂëÄ„ÄÇ",
                    myPersona: "ÊàëÊòØË∞ÅÂëÄ„ÄÇ",
                    maxMemory: 10,
                    aiAvatar: defaultAvatar,
                    myAvatar: defaultAvatar,
                    background: "",
                    theme: "default",
                    fontSize: 13,
                    customCss: "", // <--- Êñ∞Â¢ûËøôË°å
                    linkedWorldBookIds: [],
                    aiAvatarLibrary: [],
                    summary: {
                      enabled: false,
                      mode: "manual",
                      count: 50,
                      prompt:
                        "ËØ∑ÊÄªÁªì‰∏äËø∞ÂØπËØùÁöÑ‰∏ªË¶ÅÂÜÖÂÆπÔºå‰øùÁïôÈáçË¶Å‰ø°ÊÅØÂíåÊÉÖÊÑüËÑâÁªú„ÄÇ",
                      lastSummaryIndex: -1,
                    },
                  },
                  history: [],
                  musicData: { totalTime: 0 },
                };
                state.chats[newChatId] = newChat;
                await db.chats.put(newChat);
                renderChatList();
              }
            });

          document
            .getElementById("add-group-chat-btn")
            .addEventListener("click", openContactPickerForGroupCreate);
          document
            .getElementById("transfer-cancel-btn")
            .addEventListener("click", () =>
              document
                .getElementById("transfer-modal")
                .classList.remove("visible"),
            );
          document
            .getElementById("transfer-confirm-btn")
            .addEventListener("click", sendUserTransfer);

          document
            .getElementById("listen-together-btn")
            .addEventListener("click", handleListenTogetherClick);
          document
            .getElementById("music-exit-btn")
            .addEventListener("click", () => endListenTogetherSession(true));
          document
            .getElementById("music-return-btn")
            .addEventListener("click", returnToChat);
          document
            .getElementById("music-play-pause-btn")
            .addEventListener("click", togglePlayPause);
          document
            .getElementById("music-next-btn")
            .addEventListener("click", playNext);
          document
            .getElementById("music-prev-btn")
            .addEventListener("click", playPrev);
          document
            .getElementById("music-mode-btn")
            .addEventListener("click", changePlayMode);
          document
            .getElementById("music-playlist-btn")
            .addEventListener("click", () => {
              updatePlaylistUI();
              document
                .getElementById("music-playlist-panel")
                .classList.add("visible");
            });
          document
            .getElementById("close-playlist-btn")
            .addEventListener("click", () =>
              document
                .getElementById("music-playlist-panel")
                .classList.remove("visible"),
            );
          document
            .getElementById("add-song-url-btn")
            .addEventListener("click", addSongFromURL);
          document
            .getElementById("add-song-local-btn")
            .addEventListener("click", () =>
              document.getElementById("local-song-upload-input").click(),
            );
          document
            .getElementById("local-song-upload-input")
            .addEventListener("change", addSongFromLocal);
          audioPlayer.addEventListener("ended", playNext);
          audioPlayer.addEventListener("pause", () => {
            if (musicState.isActive) {
              musicState.isPlaying = false;
              updatePlayerUI();
            }
          });
          audioPlayer.addEventListener("play", () => {
            if (musicState.isActive) {
              musicState.isPlaying = true;
              updatePlayerUI();
            }
          });

          const chatInput = document.getElementById("chat-input");
          document
            .getElementById("send-btn")
            .addEventListener("click", async () => {
              const content = chatInput.value.trim();
              if (!content || !state.activeChatId) return;

              const chat = state.chats[state.activeChatId];

              // --- „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåÊ∑ªÂä† ---
              const msg = {
                role: "user",
                content,
                timestamp: Date.now(),
              };

              // Ê£ÄÊü•ÂΩìÂâçÊòØÂê¶Â§Ñ‰∫éÂºïÁî®ÂõûÂ§çÊ®°Âºè
              if (currentReplyContext) {
                msg.quote = currentReplyContext; // Â∞ÜÂºïÁî®‰ø°ÊÅØÈôÑÂä†Âà∞Ê∂àÊÅØÂØπË±°‰∏ä
              }
              // --- „Äê‰øÆÊîπÁªìÊùü„Äë ---

              chat.history.push(msg);
              await db.chats.put(chat);
              // Ëß¶ÂèëÊÄªÁªìÊ£ÄÊü•
              await checkAndTriggerSummary(chat.id);
              appendMessage(msg, chat);
              renderChatList();
              chatInput.value = "";
              chatInput.style.height = "auto";
              chatInput.focus();

              // --- „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂèëÈÄÅÂêéÔºåÂèñÊ∂àÂºïÁî®Ê®°Âºè ---
              cancelReplyMode();
            });
          document
            .getElementById("wait-reply-btn")
            .addEventListener("click", triggerAiResponse);
          chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              document.getElementById("send-btn").click();
            }
          });
          chatInput.addEventListener("input", () => {
            chatInput.style.height = "auto";
            chatInput.style.height = chatInput.scrollHeight + "px";
          });

          const frameColorInput = document.getElementById("frame-color-input");
          const frameColorValue = document.getElementById("frame-color-value");

          frameColorInput.addEventListener("input", (e) => {
            frameColorValue.textContent = e.target.value;
            // ÂÆûÊó∂È¢ÑËßàÔºöÁõ¥Êé•‰øÆÊîπDOMÔºå‰ΩÜ‰∏ç‰øùÂ≠ò
            document.getElementById("phone-frame").style.backgroundColor =
              e.target.value;
          });

          document
            .getElementById("reset-frame-color-btn")
            .addEventListener("click", () => {
              // ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄºÔºàËøôÈáåÂÅáËÆæÈªòËÆ§ÁôΩËâ≤ÔºåÂÆûÈôÖ‰øùÂ≠òÊó∂‰∏∫Á©∫Â≠óÁ¨¶‰∏≤ËÆ©CSSÁîüÊïàÔºâ
              frameColorInput.value = "#ffffff";
              frameColorValue.textContent = "#ffffff";
              document.getElementById("phone-frame").style.backgroundColor = ""; // Ê∏ÖÈô§ÂÜÖËÅîÊ†∑Âºè
            });

          document
            .getElementById("wallpaper-upload-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (file) {
                const dataUrl = await new Promise((res, rej) => {
                  const reader = new FileReader();
                  reader.onload = () => res(reader.result);
                  reader.onerror = () => rej(reader.error);
                  reader.readAsDataURL(file);
                });
                newWallpaperBase64 = dataUrl;
                renderWallpaperScreen();
              }
            });
          document
            .getElementById("save-wallpaper-btn")
            .addEventListener("click", async () => {
              let changesMade = false;

              // ‰øùÂ≠òÂ£ÅÁ∫∏
              if (newWallpaperBase64) {
                state.globalSettings.wallpaper = newWallpaperBase64;
                changesMade = true;
              }

              const currentFrameColor = frameColorInput.value;
              // Â¶ÇÊûúÊòØÈªòËÆ§ÁöÑÁôΩËâ≤Ôºà‰∏î‰∏çÂú®Â§úÈó¥Ê®°Âºè‰∏ãÔºâÔºåÊàñËÄÖÁî®Êà∑ÁÇπ‰∫ÜÈáçÁΩÆÔºàÊàë‰ª¨ÈúÄË¶Å‰∏Ä‰∏™Ê†áËÆ∞ÔºâÔºå
              // ËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºöÂ¶ÇÊûúÁî®Êà∑ÈÄâÊã©‰∫ÜÈ¢úËâ≤ÔºåÂ∞±‰øùÂ≠ò„ÄÇ
              // ‰∏∫‰∫ÜÊîØÊåÅ‚ÄúÈáçÁΩÆ‚ÄùÂäüËÉΩÔºåÊàë‰ª¨Ê£ÄÊü• reset ÊåâÈíÆÊòØÂê¶ÂàöÂàöË¢´ÁÇπÂáªËøáÊØîËæÉÈ∫ªÁÉ¶„ÄÇ
              // Êõ¥ÁÆÄÂçïÁöÑÈÄªËæëÔºöÁõ¥Êé•‰øùÂ≠ò input ÁöÑÂÄº„ÄÇ
              // ‰ΩÜÊòØ reset ÊåâÈíÆÊ∏ÖÈô§‰∫Ü styleÔºåinput ËøòÊòØÊòæÁ§∫ #ffffff„ÄÇ
              // ‰øÆÊ≠£ÈÄªËæëÔºöÂ¶ÇÊûúÂΩìÂâç style.backgroundColor ‰∏∫Á©∫ÔºàË¢´ÈáçÁΩÆ‰∫ÜÔºâÔºåÂàô‰øùÂ≠ò null„ÄÇ
              // Âê¶Âàô‰øùÂ≠ò input ÁöÑÂÄº„ÄÇ
              if (
                document.getElementById("phone-frame").style.backgroundColor ===
                ""
              ) {
                state.globalSettings.phoneFrameColor = null;
              } else {
                state.globalSettings.phoneFrameColor = currentFrameColor;
              }

              // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë‰øùÂ≠òÂõæÊ†áËÆæÁΩÆÔºàÂÆÉÂ∑≤ÁªèÂú®ÂÜÖÂ≠ò‰∏≠‰∫ÜÔºåÊàë‰ª¨Âè™ÈúÄË¶ÅÊääÊï¥‰∏™globalSettingsÂ≠òËµ∑Êù•Ôºâ
              await db.globalSettings.put(state.globalSettings);

              // Â∫îÁî®ÊâÄÊúâÊõ¥Êîπ
              if (changesMade) {
                applyGlobalWallpaper();
                newWallpaperBase64 = null;
              }
              applyGlobalWallpaper(); // Á°Æ‰øùËæπÊ°ÜÈ¢úËâ≤Ë¢´Â∫îÁî®ÔºàÂõ†‰∏∫ applyGlobalWallpaper ÂåÖÂê´‰∫ÜËæπÊ°ÜÈÄªËæëÔºâ
              applyAppIcons(); // ÈáçÊñ∞Â∫îÁî®ÊâÄÊúâÂõæÊ†á

              alert("Â§ñËßÇËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ");
              showScreen("home-screen");
            });

          // API Config Event Listeners
          document
            .getElementById("add-new-config-btn")
            .addEventListener("click", () => openApiConfigEditor());
          document
            .getElementById("save-config-btn")
            .addEventListener("click", saveApiConfig);
          document
            .getElementById("cancel-config-editor-btn")
            .addEventListener("click", () => {
              document
                .getElementById("api-config-editor-modal")
                .classList.remove("visible");
            });

          document
            .getElementById("api-configs-list")
            .addEventListener("click", async (e) => {
              const target = e.target;
              const item = target.closest(".api-config-item");
              if (!item) return;
              const configId = parseInt(item.dataset.configId);

              if (target.classList.contains("edit-btn")) {
                openApiConfigEditor(configId);
              } else if (target.classList.contains("delete-btn")) {
                const confirmed = await showCustomConfirm(
                  "Âà†Èô§ÈÖçÁΩÆ",
                  "Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™APIÈÖçÁΩÆÂêóÔºü",
                  { confirmButtonClass: "btn-danger" },
                );
                if (confirmed) {
                  await db.apiConfigs.delete(configId);
                  state.apiConfigs = state.apiConfigs.filter(
                    (c) => c.id !== configId,
                  );
                  if (state.globalSettings.activeApiConfigId === configId) {
                    state.globalSettings.activeApiConfigId =
                      state.apiConfigs[0]?.id || null;
                    await db.globalSettings.put(state.globalSettings);
                  }
                  renderApiSettings();
                }
              } else if (target.type === "radio") {
                setActiveApiConfig(configId);
              }
            });

          document
            .getElementById("config-fetch-models-btn")
            .addEventListener("click", async () => {
              const url = document
                .getElementById("config-url-input")
                .value.trim();
              const key = document
                .getElementById("config-key-input")
                .value.trim();
              if (!url || !key) return alert("ËØ∑ÂÖàÂ°´ÂÜôÂèç‰ª£Âú∞ÂùÄÂíåÂØÜÈí•");
              try {
                let isGemini = url === GEMINI_API_URL;
                const response = await fetch(
                  isGemini
                    ? `${GEMINI_API_URL}?key=${getRandomValue(key)}`
                    : `${url}/v1/models`,
                  isGemini
                    ? undefined
                    : { headers: { Authorization: `Bearer ${key}` } },
                );
                if (!response.ok) throw new Error("Êó†Ê≥ïËé∑ÂèñÊ®°ÂûãÂàóË°®");
                const data = await response.json();
                let models = isGemini ? data.models : data.data;
                if (isGemini) {
                  models = models.map((model) => {
                    const parts = model.name.split("/");
                    return { id: parts.length > 1 ? parts[1] : model.name };
                  });
                }
                const modelSelect = document.getElementById(
                  "config-model-select",
                );
                modelSelect.innerHTML = "";
                models.forEach((model) => {
                  const option = document.createElement("option");
                  option.value = model.id;
                  option.textContent = model.id;
                  modelSelect.appendChild(option);
                });
                alert("Ê®°ÂûãÂàóË°®Â∑≤Êõ¥Êñ∞ÔºÅ");
              } catch (e) {
                console.error(e);
                alert("Ëé∑ÂèñÊ®°ÂûãÂ§±Ë¥•: " + e.message);
              }
            });

          // Global Settings Auto-save
          document
            .getElementById("background-activity-switch")
            .addEventListener("change", async (e) => {
              state.globalSettings.enableBackgroundActivity = e.target.checked;
              await db.globalSettings.put(state.globalSettings);
            });
          document
            .getElementById("background-interval-input")
            .addEventListener("change", async (e) => {
              state.globalSettings.backgroundActivityInterval = parseInt(
                e.target.value,
              );
              await db.globalSettings.put(state.globalSettings);
            });
          document
            .getElementById("block-cooldown-input")
            .addEventListener("change", async (e) => {
              state.globalSettings.blockCooldownHours = parseFloat(
                e.target.value,
              );
              await db.globalSettings.put(state.globalSettings);
            });
          document
            .getElementById("add-world-book-btn")
            .addEventListener("click", async () => {
              const name = await showCustomPrompt("ÂàõÂª∫‰∏ñÁïå‰π¶", "ËØ∑ËæìÂÖ•‰π¶Âêç");
              if (name && name.trim()) {
                const newBook = {
                  id: "wb_" + Date.now(),
                  name: name.trim(),
                  content: "",
                };
                await db.worldBooks.add(newBook);
                state.worldBooks.push(newBook);
                renderWorldBookScreen();
                openWorldBookEditor(newBook.id);
              }
            });
          document
            .getElementById("save-world-book-btn")
            .addEventListener("click", async () => {
              if (!editingWorldBookId) return;
              const book = state.worldBooks.find(
                (wb) => wb.id === editingWorldBookId,
              );
              if (book) {
                const newName = document
                  .getElementById("world-book-name-input")
                  .value.trim();
                if (!newName) {
                  alert("‰π¶Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
                  return;
                }
                book.name = newName;
                book.content = document.getElementById(
                  "world-book-content-input",
                ).value;

                const categoryId = document.getElementById(
                  "world-book-category-select",
                ).value;
                // Â¶ÇÊûúÈÄâÊã©‰∫Ü‚ÄúÊú™ÂàÜÁ±ª‚ÄùÔºåÂ≠òÂÖ• nullÔºõÂê¶ÂàôÂ≠òÂÖ•Êï∞Â≠óID
                book.categoryId = categoryId ? parseInt(categoryId) : null;

                await db.worldBooks.put(book);
                document.getElementById("world-book-editor-title").textContent =
                  newName;
                editingWorldBookId = null;
                renderWorldBookScreen();
                showScreen("world-book-screen");
              }
            });
          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              const aiImage = e.target.closest(".ai-generated-image");
              if (aiImage) {
                const description = aiImage.dataset.description;
                if (description) showCustomAlert("ÁÖßÁâáÊèèËø∞", description);
                return;
              }
            });

          const chatSettingsModal = document.getElementById(
            "chat-settings-modal",
          );
          const worldBookSelectBox = document.querySelector(
            ".custom-multiselect .select-box",
          );
          const worldBookCheckboxesContainer = document.getElementById(
            "world-book-checkboxes-container",
          );

          function updateWorldBookSelectionDisplay() {
            const checkedBoxes =
              worldBookCheckboxesContainer.querySelectorAll("input:checked");
            const displayText = document.querySelector(
              ".selected-options-text",
            );
            if (checkedBoxes.length === 0) {
              displayText.textContent = "-- ÁÇπÂáªÈÄâÊã© --";
            } else if (checkedBoxes.length > 2) {
              displayText.textContent = `Â∑≤ÈÄâÊã© ${checkedBoxes.length} È°π`;
            } else {
              displayText.textContent = Array.from(checkedBoxes)
                .map((cb) => cb.parentElement.textContent.trim())
                .join(", ");
            }
          }

          worldBookSelectBox.addEventListener("click", (e) => {
            e.stopPropagation();
            worldBookCheckboxesContainer.classList.toggle("visible");
            worldBookSelectBox.classList.toggle("expanded");
          });
          document
            .getElementById("world-book-checkboxes-container")
            .addEventListener("change", updateWorldBookSelectionDisplay);
          window.addEventListener("click", (e) => {
            if (
              !document.querySelector(".custom-multiselect").contains(e.target)
            ) {
              worldBookCheckboxesContainer.classList.remove("visible");
              worldBookSelectBox.classList.remove("expanded");
            }
          });

          document
            .getElementById("chat-settings-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;
              const chat = state.chats[state.activeChatId];
              const isGroup = chat.isGroup;

              // --- Offline Mode Population ---
              const offlineSettings = chat.settings.offlineMode || {
                enabled: false,
                preset: "custom",
                prompt: "",
                style: "",
                novelai: false,
              };
              document.getElementById("offline-mode-toggle").checked =
                offlineSettings.enabled;
              document.getElementById("offline-mode-config").style.display =
                offlineSettings.enabled ? "block" : "none";

              const presetSelect = document.getElementById(
                "offline-preset-select",
              );
              presetSelect.innerHTML = "";
              Object.keys(offlinePresets).forEach((key) => {
                const option = document.createElement("option");
                option.value = key;
                option.textContent = offlinePresets[key].name;
                if (offlineSettings.preset === key) option.selected = true;
                presetSelect.appendChild(option);
              });

              document.getElementById("offline-prompt-input").value =
                offlineSettings.prompt || "";
              document.getElementById("offline-style-input").value =
                offlineSettings.style || "";

              // Helper: Update inputs when preset changes
              presetSelect.onchange = () => {
                const val = presetSelect.value;
                if (offlinePresets[val] && val !== "custom") {
                  document.getElementById("offline-prompt-input").value =
                    offlinePresets[val].prompt;
                  document.getElementById("offline-style-input").value =
                    offlinePresets[val].style;
                }
              };

              // --- Áªü‰∏ÄÊòæÁ§∫/ÈöêËóèÊéß‰ª∂ ---
              document.getElementById("chat-name-group").style.display =
                "block";
              document.getElementById("my-persona-group").style.display =
                "block";
              document.getElementById("my-avatar-group").style.display =
                "block";
              document.getElementById("my-group-nickname-group").style.display =
                isGroup ? "block" : "none";
              document.getElementById("group-avatar-group").style.display =
                isGroup ? "block" : "none";
              document.getElementById("group-members-group").style.display =
                isGroup ? "block" : "none";
              document.getElementById("ai-persona-group").style.display =
                isGroup ? "none" : "block";
              document.getElementById("ai-avatar-group").style.display = isGroup
                ? "none"
                : "block";
              // „ÄêÊñ∞Â¢û„ÄëÊéßÂà∂AIÂ§áÊ≥®ËæìÂÖ•Ê°ÜÁöÑÊòæÁ§∫
              document.getElementById("ai-remark-group").style.display = isGroup
                ? "none"
                : "block";

              // „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÊ†πÊçÆÊòØÂê¶‰∏∫Áæ§ËÅäÔºåÊòæÁ§∫ÊàñÈöêËóè‚ÄúÂ•ΩÂèãÂàÜÁªÑ‚ÄùÂå∫Âüü
              document.getElementById("assign-group-section").style.display =
                isGroup ? "none" : "block";

              // --- Âä†ËΩΩË°®ÂçïÊï∞ÊçÆ ---
              document.getElementById("chat-name-input").value = chat.name;
              // „ÄêÊñ∞Â¢û„ÄëÂä†ËΩΩAIÂ§áÊ≥®
              document.getElementById("ai-remark-input").value =
                chat.settings.aiRemark || "";

              const videoCallSettingsGroup = document.getElementById(
                "video-call-settings-group",
              );

              if (isGroup) {
                videoCallSettingsGroup.style.display = "none";
              } else {
                videoCallSettingsGroup.style.display = "block";

                const voiceAccessSwitch = document.getElementById(
                  "video-call-voice-access-switch",
                );
                if (voiceAccessSwitch) {
                  voiceAccessSwitch.checked =
                    chat.settings.videoCallVoiceAccess || false;
                }
              }
              const realCameraSwitch = document.getElementById(
                "user-real-camera-switch",
              );
              if (realCameraSwitch) {
                realCameraSwitch.checked = chat.settings.useRealCamera || false;
              }

              document.getElementById("my-persona").value =
                chat.settings.myPersona;
              document.getElementById("my-avatar-preview").src =
                chat.settings.myAvatar ||
                (isGroup ? defaultMyGroupAvatar : defaultAvatar);
              document.getElementById("max-memory").value =
                chat.settings.maxMemory;
              const bgPreview = document.getElementById("bg-preview");
              const removeBgBtn = document.getElementById("remove-bg-btn");
              if (chat.settings.background) {
                bgPreview.src = chat.settings.background;
                bgPreview.style.display = "block";
                removeBgBtn.style.display = "inline-block";
              } else {
                bgPreview.style.display = "none";
                removeBgBtn.style.display = "none";
              }

              if (isGroup) {
                document.getElementById("my-group-nickname-input").value =
                  chat.settings.myNickname || "";
                document.getElementById("group-avatar-preview").src =
                  chat.settings.groupAvatar || defaultGroupAvatar;
                renderGroupMemberSettings(chat.members);
              } else {
                document.getElementById("ai-persona").value =
                  chat.settings.aiPersona;
                document.getElementById("ai-avatar-preview").src =
                  chat.settings.aiAvatar || defaultAvatar;

                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÂ¶ÇÊûúÊòØÂçïËÅäÔºåÂ∞±Âä†ËΩΩÂàÜÁªÑÂàóË°®Âà∞‰∏ãÊãâÊ°Ü
                const select = document.getElementById("assign-group-select");
                select.innerHTML = '<option value="">Êú™ÂàÜÁªÑ</option>'; // Ê∏ÖÁ©∫Âπ∂ËÆæÁΩÆÈªòËÆ§ÈÄâÈ°π
                const groups = await db.qzoneGroups.toArray();
                groups.forEach((group) => {
                  const option = document.createElement("option");
                  option.value = group.id;
                  option.textContent = group.name;
                  // Â¶ÇÊûúÂΩìÂâçÂ•ΩÂèãÂ∑≤ÁªèÊúâÂàÜÁªÑÔºåÂ∞±ÈªòËÆ§ÈÄâ‰∏≠ÂÆÉ
                  if (chat.groupId === group.id) {
                    option.selected = true;
                  }
                  select.appendChild(option);
                });
              }

              // Âä†ËΩΩ‰∏ñÁïå‰π¶

              const worldBookCheckboxesContainer = document.getElementById(
                "world-book-checkboxes-container",
              );
              worldBookCheckboxesContainer.innerHTML = "";
              const linkedIds = new Set(chat.settings.linkedWorldBookIds || []);

              // 1. Ëé∑ÂèñÊâÄÊúâÂàÜÁ±ªÂíå‰∏ñÁïå‰π¶
              const categories = await db.worldBookCategories.toArray();
              const books = state.worldBooks;

              // „ÄêÊ†∏ÂøÉÊîπÈÄ†„ÄëÂ¶ÇÊûúÂ≠òÂú®Êú™ÂàÜÁ±ªÁöÑ‰π¶Á±çÔºåÂ∞±ÂàõÂª∫‰∏Ä‰∏™‚ÄúËôöÊãüÂàÜÁ±ª‚Äù
              const hasUncategorized = books.some((book) => !book.categoryId);
              if (hasUncategorized) {
                categories.push({ id: "uncategorized", name: "Êú™ÂàÜÁ±ª" });
              }

              // 2. Â∞Ü‰π¶Á±çÊåâÂàÜÁ±ªIDËøõË°åÂàÜÁªÑ
              const booksByCategoryId = books.reduce((acc, book) => {
                const categoryId = book.categoryId || "uncategorized";
                if (!acc[categoryId]) {
                  acc[categoryId] = [];
                }
                acc[categoryId].push(book);
                return acc;
              }, {});

              // 3. ÈÅçÂéÜÂàÜÁ±ªÔºåÂàõÂª∫Â∏¶ÊäòÂè†ÂäüËÉΩÁöÑÂàóË°®
              categories.forEach((category) => {
                const booksInCategory = booksByCategoryId[category.id] || [];
                if (booksInCategory.length > 0) {
                  const allInCategoryChecked = booksInCategory.every((book) =>
                    linkedIds.has(book.id),
                  );

                  const header = document.createElement("div");
                  header.className = "wb-category-header";
                  header.innerHTML = `
                  <input type="checkbox" class="wb-category-checkbox" data-category-id="${
                    category.id
                  }" ${allInCategoryChecked ? "checked" : ""}>
                  <span>${category.name}</span>
              `;

                  const bookContainer = document.createElement("div");
                  bookContainer.className = "wb-book-container";
                  bookContainer.dataset.containerFor = category.id;

                  booksInCategory.forEach((book) => {
                    const isChecked = linkedIds.has(book.id);
                    const label = document.createElement("label");
                    label.innerHTML = `<input type="checkbox" class="wb-book-checkbox" value="${
                      book.id
                    }" data-parent-category="${category.id}" ${
                      isChecked ? "checked" : ""
                    }> ${book.name}`;
                    bookContainer.appendChild(label);
                  });

                  // --- ‚òÖ Ê†∏ÂøÉ‰øÆÊîπ #1 Âú®ËøôÈáå ‚òÖ ---
                  // ÈªòËÆ§Â∞ÜÂàÜÁ±ªËÆæÁΩÆ‰∏∫ÊäòÂè†Áä∂ÊÄÅ
                  header.classList.add("collapsed");
                  bookContainer.classList.add("collapsed");
                  // --- ‚òÖ ‰øÆÊîπÁªìÊùü ‚òÖ ---

                  worldBookCheckboxesContainer.appendChild(header);
                  worldBookCheckboxesContainer.appendChild(bookContainer);
                }
              });

              updateWorldBookSelectionDisplay(); // Êõ¥Êñ∞È°∂ÈÉ®ÁöÑÂ∑≤ÈÄâÊï∞ÈáèÊòæÁ§∫

              // Âä†ËΩΩÊÄªÁªìËÆæÁΩÆ
              if (chat.settings.summary) {
                const summarySettings = chat.settings.summary;
                document.getElementById("summary-toggle").checked =
                  summarySettings.enabled;
                const modeRadios = document.getElementsByName("summary-mode");
                for (const radio of modeRadios) {
                  if (radio.value === summarySettings.mode) {
                    radio.checked = true;
                    break;
                  }
                }
                document.getElementById("summary-count-input").value =
                  summarySettings.count;
                // ÊòæÁ§∫/ÈöêËóèËØ¶ÁªÜÈÄâÈ°π
                document.getElementById("summary-options").style.display =
                  summarySettings.enabled ? "block" : "none";
              }

              // Âä†ËΩΩÊÄªÁªìËÆæÁΩÆ
              if (chat.settings.summary) {
                const summarySettings = chat.settings.summary;
                document.getElementById("summary-toggle").checked =
                  summarySettings.enabled;
                const modeRadios = document.getElementsByName("summary-mode");
                for (const radio of modeRadios) {
                  if (radio.value === summarySettings.mode) {
                    radio.checked = true;
                    break;
                  }
                }
                document.getElementById("summary-count-input").value =
                  summarySettings.count;
                // ÊòæÁ§∫/ÈöêËóèËØ¶ÁªÜÈÄâÈ°π
                document.getElementById("summary-options").style.display =
                  summarySettings.enabled ? "block" : "none";
              }

              // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÊù•Â§ÑÁêÜÊâÄÊúâÁÇπÂáªÂíåÂãæÈÄâ‰∫ã‰ª∂ÔºåÊïàÁéáÊõ¥È´ò
              worldBookCheckboxesContainer.addEventListener("click", (e) => {
                const header = e.target.closest(".wb-category-header");
                if (header && !e.target.matches('input[type="checkbox"]')) {
                  const categoryId = header.querySelector(
                    ".wb-category-checkbox",
                  )?.dataset.categoryId;
                  // „Äê‰øÆÊîπ„ÄëÁé∞Âú® categoryId ÂèØËÉΩÊòØÊï∞Â≠óÔºå‰πüÂèØËÉΩÊòØ "uncategorized" Â≠óÁ¨¶‰∏≤ÔºåÊâÄ‰ª•Ëøô‰∏™Âà§Êñ≠ËÉΩÈÄöËøá‰∫ÜÔºÅ
                  if (categoryId) {
                    // <-- ÊääÂéüÊù•ÁöÑ !categoryId return; ÊîπÊàêËøôÊ†∑
                    const bookContainer =
                      worldBookCheckboxesContainer.querySelector(
                        `.wb-book-container[data-container-for="${categoryId}"]`,
                      );
                    if (bookContainer) {
                      header.classList.toggle("collapsed");
                      bookContainer.classList.toggle("collapsed");
                    }
                  }
                }
              });

              worldBookCheckboxesContainer.addEventListener("change", (e) => {
                const target = e.target;

                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂàÜÁ±ªÁöÑ‚ÄúÂÖ®ÈÄâ‚ÄùÂ§çÈÄâÊ°Ü
                if (target.classList.contains("wb-category-checkbox")) {
                  const categoryId = target.dataset.categoryId;
                  const isChecked = target.checked;
                  // ÊâæÂà∞Ëøô‰∏™ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâ‰π¶Á±çÂ§çÈÄâÊ°ÜÔºåÂπ∂Â∞ÜÂÆÉ‰ª¨ÁöÑÁä∂ÊÄÅËÆæÁΩÆ‰∏∫‰∏éÂàÜÁ±ªÂ§çÈÄâÊ°Ü‰∏ÄËá¥
                  const bookCheckboxes =
                    worldBookCheckboxesContainer.querySelectorAll(
                      `input.wb-book-checkbox[data-parent-category="${categoryId}"]`,
                    );
                  bookCheckboxes.forEach((cb) => (cb.checked = isChecked));
                }

                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂçï‰∏™‰π¶Á±çÁöÑÂ§çÈÄâÊ°Ü
                if (target.classList.contains("wb-book-checkbox")) {
                  const categoryId = target.dataset.parentCategory;
                  if (categoryId) {
                    // Ê£ÄÊü•ÂÆÉÊòØÂê¶Â±û‰∫é‰∏Ä‰∏™ÂàÜÁ±ª
                    const categoryCheckbox =
                      worldBookCheckboxesContainer.querySelector(
                        `input.wb-category-checkbox[data-category-id="${categoryId}"]`,
                      );
                    const allBookCheckboxes =
                      worldBookCheckboxesContainer.querySelectorAll(
                        `input.wb-book-checkbox[data-parent-category="${categoryId}"]`,
                      );
                    // Ê£ÄÊü•ËØ•ÂàÜÁ±ª‰∏ãÊòØÂê¶ÊâÄÊúâ‰π¶Á±çÈÉΩË¢´ÈÄâ‰∏≠‰∫Ü
                    const allChecked = Array.from(allBookCheckboxes).every(
                      (cb) => cb.checked,
                    );
                    // ÂêåÊ≠•ÂàÜÁ±ª‚ÄúÂÖ®ÈÄâ‚ÄùÂ§çÈÄâÊ°ÜÁöÑÁä∂ÊÄÅ
                    categoryCheckbox.checked = allChecked;
                  }
                }

                // ÊØèÊ¨°ÂèòÊõ¥ÂêéÈÉΩÊõ¥Êñ∞È°∂ÈÉ®ÁöÑÂ∑≤ÈÄâÊï∞ÈáèÊòæÁ§∫
                updateWorldBookSelectionDisplay();
              });

              // Âä†ËΩΩÂπ∂Êõ¥Êñ∞ÊâÄÊúâÈ¢ÑËßàÁõ∏ÂÖ≥Êéß‰ª∂
              const themeRadio = document.querySelector(
                `input[name="theme-select"][value="${
                  chat.settings.theme || "default"
                }"]`,
              );
              if (themeRadio) themeRadio.checked = true;
              const fontSizeSlider =
                document.getElementById("font-size-slider");
              fontSizeSlider.value = chat.settings.fontSize || 13;
              document.getElementById("font-size-value").textContent =
                `${fontSizeSlider.value}px`;
              const customCssInput =
                document.getElementById("custom-css-input");
              customCssInput.value = chat.settings.customCss || "";

              updateSettingsPreview();
              document
                .getElementById("chat-settings-modal")
                .classList.add("visible");
            });

          function renderGroupMemberSettings(members) {
            const container = document.getElementById("group-members-settings");
            container.innerHTML = "";
            members.forEach((member) => {
              const div = document.createElement("div");
              div.className = "member-editor";
              div.dataset.memberId = member.id;
              // ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉÈáçÊûÑ„Äë‚òÖ‚òÖ‚òÖ
              // ÊòæÁ§∫ÁöÑÊòØ groupNickname
              div.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><div class="member-name">${member.groupNickname}</div>`;
              div.addEventListener("click", () => openMemberEditor(member.id));
              container.appendChild(div);
            });
          }

          function openMemberEditor(memberId) {
            editingMemberId = memberId;
            const chat = state.chats[state.activeChatId];
            const member = chat.members.find((m) => m.id === memberId);
            document.getElementById("member-name-input").value =
              member.groupNickname;
            document.getElementById("member-persona-input").value =
              member.persona;
            document.getElementById("member-avatar-preview").src =
              member.avatar;
            document
              .getElementById("member-settings-modal")
              .classList.add("visible");
          }
          document
            .getElementById("cancel-member-settings-btn")
            .addEventListener("click", () => {
              document
                .getElementById("member-settings-modal")
                .classList.remove("visible");
              editingMemberId = null;
            });
          document
            .getElementById("save-member-settings-btn")
            .addEventListener("click", () => {
              if (!editingMemberId) return;
              const chat = state.chats[state.activeChatId];
              const member = chat.members.find((m) => m.id === editingMemberId);

              // ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉÈáçÊûÑ„Äë‚òÖ‚òÖ‚òÖ
              const newNickname = document
                .getElementById("member-name-input")
                .value.trim();
              if (!newNickname) {
                alert("Áæ§ÊòµÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
                return;
              }
              member.groupNickname = newNickname; // Âè™‰øÆÊîπÁæ§ÊòµÁß∞
              member.persona = document.getElementById(
                "member-persona-input",
              ).value;
              member.avatar = document.getElementById(
                "member-avatar-preview",
              ).src;

              renderGroupMemberSettings(chat.members);
              document
                .getElementById("member-settings-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("reset-theme-btn")
            .addEventListener("click", () => {
              document.getElementById("theme-default").checked = true;
            });
          document
            .getElementById("cancel-chat-settings-btn")
            .addEventListener("click", () => {
              chatSettingsModal.classList.remove("visible");
            });

          document
            .getElementById("save-chat-settings-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;
              const chat = state.chats[state.activeChatId];
              const newName = document
                .getElementById("chat-name-input")
                .value.trim();
              if (!newName) return alert("Â§áÊ≥®Âêç/Áæ§Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
              chat.name = newName;
              const selectedThemeRadio = document.querySelector(
                'input[name="theme-select"]:checked',
              );
              chat.settings.theme = selectedThemeRadio
                ? selectedThemeRadio.value
                : "default";

              chat.settings.fontSize = parseInt(
                document.getElementById("font-size-slider").value,
              );
              chat.settings.customCss = document
                .getElementById("custom-css-input")
                .value.trim();

              chat.settings.myPersona =
                document.getElementById("my-persona").value;
              chat.settings.myAvatar =
                document.getElementById("my-avatar-preview").src;
              const checkedBooks = document.querySelectorAll(
                "#world-book-checkboxes-container input.wb-book-checkbox:checked",
              );
              chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(
                (cb) => cb.value,
              );

              if (chat.isGroup) {
                chat.settings.myNickname = document
                  .getElementById("my-group-nickname-input")
                  .value.trim();
                chat.settings.groupAvatar = document.getElementById(
                  "group-avatar-preview",
                ).src;
              } else {
                chat.settings.aiPersona =
                  document.getElementById("ai-persona").value;
                chat.settings.aiAvatar =
                  document.getElementById("ai-avatar-preview").src;
                // „ÄêÊñ∞Â¢û„Äë‰øùÂ≠òAIÂ§áÊ≥®
                chat.settings.aiRemark = document
                  .getElementById("ai-remark-input")
                  .value.trim();

                const selectedGroupId = document.getElementById(
                  "assign-group-select",
                ).value;
                chat.groupId = selectedGroupId
                  ? parseInt(selectedGroupId)
                  : null;
              }

              chat.settings.maxMemory =
                parseInt(document.getElementById("max-memory").value) || 10;

              const voiceAccessSwitchSave = document.getElementById(
                "video-call-voice-access-switch",
              );
              if (voiceAccessSwitchSave) {
                chat.settings.videoCallVoiceAccess =
                  voiceAccessSwitchSave.checked;
              }

              // ‰øùÂ≠òÊÄªÁªìËÆæÁΩÆ

              if (!chat.settings.summary) chat.settings.summary = {}; // Èò≤Ê≠¢ÊÑèÂ§ñ
              chat.settings.summary.enabled =
                document.getElementById("summary-toggle").checked;
              const selectedModeRadio = document.querySelector(
                'input[name="summary-mode"]:checked',
              );
              chat.settings.summary.mode = selectedModeRadio
                ? selectedModeRadio.value
                : "manual";
              chat.settings.summary.count =
                parseInt(
                  document.getElementById("summary-count-input").value,
                ) || 50;

              // Save Offline Mode
              chat.settings.offlineMode = {
                enabled: document.getElementById("offline-mode-toggle").checked,
                preset: document.getElementById("offline-preset-select").value,
                prompt: document.getElementById("offline-prompt-input").value,
                style: document.getElementById("offline-style-input").value,
              };
              await db.chats.put(chat);

              applyScopedCss(
                chat.settings.customCss,
                "#chat-messages",
                "custom-bubble-style",
              );

              chatSettingsModal.classList.remove("visible");
              renderChatInterface(state.activeChatId);
              renderChatList();
            });

          document
            .getElementById("summary-toggle")
            .addEventListener("change", (e) => {
              document.getElementById("summary-options").style.display = e
                .target.checked
                ? "block"
                : "none";
            });

          document
            .getElementById("manual-summary-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;
              // ÂÖ≥Èó≠ËÆæÁΩÆÂºπÁ™ó
              document
                .getElementById("chat-settings-modal")
                .classList.remove("visible");

              await showCustomAlert("ÂºÄÂßãÊÄªÁªì", "Ê≠£Âú®‰∏∫ÂΩìÂâçÂØπËØùÁîüÊàêÊÄªÁªì...");
              const summaryText = await generateSummary(state.activeChatId);
              if (summaryText) {
                await saveSummaryAsMemory(state.activeChatId, summaryText);
                await showCustomAlert(
                  "ÊÄªÁªìÂÆåÊàê",
                  "Êñ∞ÁöÑÊÄªÁªìÂ∑≤‰øùÂ≠òÂà∞ÂØπËØùËÆ∞ÂøÜ‰∏≠„ÄÇ",
                );
              }
            });
          document
            .getElementById("clear-chat-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;
              const chat = state.chats[state.activeChatId];
              const confirmed = await showCustomConfirm(
                "Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï",
                "Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Ê≠§ËÅäÂ§©ÁöÑÊâÄÊúâÊ∂àÊÅØÔºåÊó†Ê≥ïÊÅ¢Â§ç„ÄÇÁ°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂêóÔºü",
                { confirmButtonClass: "btn-danger" },
              );
              if (confirmed) {
                chat.history = [];
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
                renderChatList();
                chatSettingsModal.classList.remove("visible");
              }
            });

          const setupFileUpload = (inputId, callback) => {
            document
              .getElementById(inputId)
              .addEventListener("change", async (event) => {
                const file = event.target.files[0];
                if (file) {
                  const dataUrl = await new Promise((res, rej) => {
                    const reader = new FileReader();
                    reader.onload = () => res(reader.result);
                    reader.onerror = () => rej(reader.error);
                    reader.readAsDataURL(file);
                  });
                  callback(dataUrl);
                  event.target.value = null;
                }
              });
          };
          setupFileUpload(
            "ai-avatar-input",
            (base64) =>
              (document.getElementById("ai-avatar-preview").src = base64),
          );
          setupFileUpload(
            "my-avatar-input",
            (base64) =>
              (document.getElementById("my-avatar-preview").src = base64),
          );
          setupFileUpload(
            "group-avatar-input",
            (base64) =>
              (document.getElementById("group-avatar-preview").src = base64),
          );
          setupFileUpload(
            "member-avatar-input",
            (base64) =>
              (document.getElementById("member-avatar-preview").src = base64),
          );
          setupFileUpload("bg-input", (base64) => {
            if (state.activeChatId) {
              state.chats[state.activeChatId].settings.background = base64;
              const bgPreview = document.getElementById("bg-preview");
              bgPreview.src = base64;
              bgPreview.style.display = "block";
              document.getElementById("remove-bg-btn").style.display =
                "inline-block";
            }
          });
          setupFileUpload(
            "preset-avatar-input",
            (base64) =>
              (document.getElementById("preset-avatar-preview").src = base64),
          );
          document
            .getElementById("remove-bg-btn")
            .addEventListener("click", () => {
              if (state.activeChatId) {
                state.chats[state.activeChatId].settings.background = "";
                const bgPreview = document.getElementById("bg-preview");
                bgPreview.src = "";
                bgPreview.style.display = "none";
                document.getElementById("remove-bg-btn").style.display = "none";
              }
            });

          const stickerPanel = document.getElementById("sticker-panel");
          document
            .getElementById("open-sticker-panel-btn")
            .addEventListener("click", () => {
              renderStickerPanel();
              stickerPanel.classList.add("visible");
            });
          document
            .getElementById("close-sticker-panel-btn")
            .addEventListener("click", () =>
              stickerPanel.classList.remove("visible"),
            );
          document
            .getElementById("add-sticker-btn")
            .addEventListener("click", async () => {
              const url = await showCustomPrompt(
                "Ê∑ªÂä†Ë°®ÊÉÖ(URL)",
                "ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖÁöÑÂõæÁâáURL",
              );
              if (!url || !url.trim().startsWith("http"))
                return url && alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURL (‰ª•httpÂºÄÂ§¥)");
              const name = await showCustomPrompt(
                "ÂëΩÂêçË°®ÊÉÖ",
                "ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂëΩÂêç (‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÁñëÊÉë)",
              );
              if (name && name.trim()) {
                const newSticker = {
                  id: "sticker_" + Date.now(),
                  url: url.trim(),
                  name: name.trim(),
                };
                await db.userStickers.add(newSticker);
                state.userStickers.push(newSticker);
                renderStickerPanel();
              } else if (name !== null) alert("Ë°®ÊÉÖÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
            });
          document
            .getElementById("upload-sticker-btn")
            .addEventListener("click", () =>
              document.getElementById("sticker-upload-input").click(),
            );
          document
            .getElementById("sticker-upload-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.readAsDataURL(file);
              reader.onload = async () => {
                const base64Url = reader.result;
                const name = await showCustomPrompt(
                  "ÂëΩÂêçË°®ÊÉÖ",
                  "ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂëΩÂêç (‰æãÂ¶ÇÔºöÂ•ΩËÄ∂„ÄÅÁñëÊÉë)",
                );
                if (name && name.trim()) {
                  const newSticker = {
                    id: "sticker_" + Date.now(),
                    url: base64Url,
                    name: name.trim(),
                  };
                  await db.userStickers.add(newSticker);
                  state.userStickers.push(newSticker);
                  renderStickerPanel();
                } else if (name !== null) alert("Ë°®ÊÉÖÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
              };
              event.target.value = null;
            });

          document
            .getElementById("upload-image-btn")
            .addEventListener("click", () =>
              document.getElementById("image-upload-input").click(),
            );
          document
            .getElementById("image-upload-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (!file || !state.activeChatId) return;
              const reader = new FileReader();
              reader.onload = async (e) => {
                const base64Url = e.target.result;
                const chat = state.chats[state.activeChatId];
                const msg = {
                  role: "user",
                  content: [
                    { type: "image_url", image_url: { url: base64Url } },
                  ],
                  timestamp: Date.now(),
                };
                chat.history.push(msg);
                await db.chats.put(chat);
                appendMessage(msg, chat);
                renderChatList();
              };
              reader.readAsDataURL(file);
              event.target.value = null;
            });
          document
            .getElementById("voice-message-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;
              const text = await showCustomPrompt(
                "ÂèëÈÄÅËØ≠Èü≥",
                "ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑÂÜÖÂÆπÔºö",
              );
              if (text && text.trim()) {
                const chat = state.chats[state.activeChatId];
                const msg = {
                  role: "user",
                  type: "voice_message",
                  content: text.trim(),
                  timestamp: Date.now(),
                };
                chat.history.push(msg);
                await db.chats.put(chat);
                appendMessage(msg, chat);
                renderChatList();
              }
            });
          document
            .getElementById("send-photo-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;
              const description = await showCustomPrompt(
                "ÂèëÈÄÅÁÖßÁâá",
                "ËØ∑Áî®ÊñáÂ≠óÊèèËø∞ÊÇ®Ë¶ÅÂèëÈÄÅÁöÑÁÖßÁâáÔºö",
              );
              if (description && description.trim()) {
                const chat = state.chats[state.activeChatId];
                const msg = {
                  role: "user",
                  type: "user_photo",
                  content: description.trim(),
                  timestamp: Date.now(),
                };
                chat.history.push(msg);
                await db.chats.put(chat);
                appendMessage(msg, chat);
                renderChatList();
              }
            });

          const waimaiModal = document.getElementById("waimai-request-modal");
          document
            .getElementById("send-waimai-request-btn")
            .addEventListener("click", () => {
              waimaiModal.classList.add("visible");
            });

          document
            .getElementById("waimai-cancel-btn")
            .addEventListener("click", () => {
              waimaiModal.classList.remove("visible");
            });

          document
            .getElementById("waimai-confirm-btn")
            .addEventListener("click", async () => {
              if (!state.activeChatId) return;

              const productInfoInput = document.getElementById(
                "waimai-product-info",
              );
              const amountInput = document.getElementById("waimai-amount");

              const productInfo = productInfoInput.value.trim();
              const amount = parseFloat(amountInput.value);

              if (!productInfo) {
                alert("ËØ∑ËæìÂÖ•ÂïÜÂìÅ‰ø°ÊÅØÔºÅ");
                return;
              }
              if (isNaN(amount) || amount <= 0) {
                alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ‰ª£‰ªòÈáëÈ¢ùÔºÅ");
                return;
              }

              const chat = state.chats[state.activeChatId];
              const now = Date.now();

              // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåËé∑ÂèñÁî®Êà∑Ëá™Â∑±ÁöÑÊòµÁß∞
              const myNickname = chat.isGroup
                ? chat.settings.myNickname || "Êàë"
                : "Êàë";

              const msg = {
                role: "user",
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ∞ÜËé∑ÂèñÂà∞ÁöÑÊòµÁß∞Ôºå‰Ωú‰∏∫ senderName Ê∑ªÂä†Âà∞Ê∂àÊÅØÂØπË±°‰∏≠
                senderName: myNickname,
                type: "waimai_request",
                productInfo: productInfo,
                amount: amount,
                status: "pending",
                countdownEndTime: now + 15 * 60 * 1000,
                timestamp: now,
              };

              chat.history.push(msg);
              await db.chats.put(chat);
              appendMessage(msg, chat);
              renderChatList();

              productInfoInput.value = "";
              amountInput.value = "";
              waimaiModal.classList.remove("visible");
            });
          document
            .getElementById("open-persona-library-btn")
            .addEventListener("click", openPersonaLibrary);
          document
            .getElementById("close-persona-library-btn")
            .addEventListener("click", closePersonaLibrary);
          document
            .getElementById("add-persona-preset-btn")
            .addEventListener("click", openPersonaEditorForCreate);
          document
            .getElementById("cancel-persona-editor-btn")
            .addEventListener("click", closePersonaEditor);
          document
            .getElementById("save-persona-preset-btn")
            .addEventListener("click", savePersonaPreset);
          document
            .getElementById("preset-action-edit")
            .addEventListener("click", openPersonaEditorForEdit);
          document
            .getElementById("preset-action-delete")
            .addEventListener("click", deletePersonaPreset);
          document
            .getElementById("preset-action-cancel")
            .addEventListener("click", hidePresetActions);

          document
            .getElementById("selection-cancel-btn")
            .addEventListener("click", exitSelectionMode);

          document
            .getElementById("selection-delete-btn")
            .addEventListener("click", async () => {
              if (selectedMessages.size === 0) return;
              const confirmed = await showCustomConfirm(
                "Âà†Èô§Ê∂àÊÅØ",
                `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedMessages.size} Êù°Ê∂àÊÅØÂêóÔºüËøôÂ∞ÜÊîπÂèòAIÁöÑËÆ∞ÂøÜ„ÄÇ`,
                { confirmButtonClass: "btn-danger" },
              );
              if (confirmed) {
                const chat = state.chats[state.activeChatId];

                // 1. „ÄêÊ†∏ÂøÉÂä†Âº∫„ÄëÂú®Âà†Èô§ÂâçÔºåÊ£ÄÊü•Ë¢´Âà†Èô§ÁöÑÊ∂àÊÅØ‰∏≠ÊòØÂê¶ÂåÖÂê´ÊäïÁ•®
                let deletedPollsInfo = [];
                for (const timestamp of selectedMessages) {
                  const msg = chat.history.find(
                    (m) => m.timestamp === timestamp,
                  );
                  if (msg && msg.type === "poll") {
                    deletedPollsInfo.push(
                      `ÂÖ≥‰∫é‚Äú${msg.question}‚ÄùÁöÑÊäïÁ•®(Êó∂Èó¥Êà≥: ${msg.timestamp})`,
                    );
                  }
                }

                // 2. Êõ¥Êñ∞ÂêéÁ´ØÁöÑÂéÜÂè≤ËÆ∞ÂΩï
                chat.history = chat.history.filter(
                  (msg) => !selectedMessages.has(msg.timestamp),
                );

                // 3. „ÄêÊ†∏ÂøÉÂä†Âº∫„ÄëÊûÑÂª∫Êõ¥ÂÖ∑‰ΩìÁöÑ‚ÄúÈÅóÂøòÊåá‰ª§‚Äù
                let forgetReason = "‰∏Ä‰∫õ‰πãÂâçÁöÑÊ∂àÊÅØÂ∑≤Ë¢´Áî®Êà∑Âà†Èô§„ÄÇ";
                if (deletedPollsInfo.length > 0) {
                  forgetReason += ` ÂÖ∂‰∏≠ÂåÖÊã¨‰ª•‰∏ãÊäïÁ•®Ôºö${deletedPollsInfo.join(
                    "Ôºõ",
                  )}„ÄÇ`;
                }
                forgetReason +=
                  " ‰Ω†Â∫îËØ•ÂÉèÂÆÉ‰ª¨‰ªéÊú™Â≠òÂú®Ëøá‰∏ÄÊ†∑ÁªßÁª≠ÂØπËØùÔºåÂπ∂Áõ∏Â∫îÂú∞Ë∞ÉÊï¥‰Ω†ÁöÑËÆ∞ÂøÜÂíåË°å‰∏∫Ôºå‰∏çË¶ÅÂÜçÊèêÂèäËøô‰∫õË¢´Âà†Èô§ÁöÑÂÜÖÂÆπ„ÄÇ";

                const forgetInstruction = {
                  role: "system",
                  content: `[Á≥ªÁªüÊèêÁ§∫Ôºö${forgetReason}]`,
                  timestamp: Date.now(),
                  isHidden: true,
                };
                chat.history.push(forgetInstruction);

                // 4. Â∞ÜÂåÖÂê´‚ÄúÈÅóÂøòÊåá‰ª§‚ÄùÁöÑ„ÄÅÊõ¥Êñ∞ÂêéÁöÑchatÂØπË±°Â≠òÂõûÊï∞ÊçÆÂ∫ì
                await db.chats.put(chat);

                // 5. ÊúÄÂêéÊâçÊõ¥Êñ∞UI
                renderChatInterface(state.activeChatId);
                renderChatList();
              }
            });

          const fontUrlInput = document.getElementById("font-url-input");
          fontUrlInput.addEventListener("input", () =>
            applyCustomFont(fontUrlInput.value.trim(), true),
          );
          document
            .getElementById("save-font-btn")
            .addEventListener("click", async () => {
              const newFontUrl = fontUrlInput.value.trim();
              if (!newFontUrl) {
                alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂ≠ó‰ΩìURL„ÄÇ");
                return;
              }
              applyCustomFont(newFontUrl, false);
              state.globalSettings.fontUrl = newFontUrl;
              await db.globalSettings.put(state.globalSettings);
              alert("Â≠ó‰ΩìÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ");
            });
          document
            .getElementById("reset-font-btn")
            .addEventListener("click", resetToDefaultFont);

          document
            .querySelectorAll("#chat-list-bottom-nav .nav-item")
            .forEach((item) => {
              item.addEventListener("click", () =>
                switchToChatListView(item.dataset.view),
              );
            });
          document
            .getElementById("qzone-back-btn")
            .addEventListener("click", () =>
              switchToChatListView("messages-view"),
            );
          document
            .getElementById("qzone-nickname")
            .addEventListener("click", async () => {
              const newNickname = await showCustomPrompt(
                "‰øÆÊîπÊòµÁß∞",
                "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊòµÁß∞",
                state.qzoneSettings.nickname,
              );
              if (newNickname && newNickname.trim()) {
                state.qzoneSettings.nickname = newNickname.trim();
                await saveQzoneSettings();
                renderQzoneScreen();
              }
            });
          document
            .getElementById("qzone-avatar-container")
            .addEventListener("click", () =>
              document.getElementById("qzone-avatar-input").click(),
            );
          document
            .getElementById("qzone-banner-container")
            .addEventListener("click", () =>
              document.getElementById("qzone-banner-input").click(),
            );
          document
            .getElementById("qzone-avatar-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (file) {
                const dataUrl = await new Promise((res) => {
                  const reader = new FileReader();
                  reader.onload = () => res(reader.result);
                  reader.readAsDataURL(file);
                });
                state.qzoneSettings.avatar = dataUrl;
                await saveQzoneSettings();
                renderQzoneScreen();
              }
              event.target.value = null;
            });
          document
            .getElementById("qzone-banner-input")
            .addEventListener("change", async (event) => {
              const file = event.target.files[0];
              if (file) {
                const dataUrl = await new Promise((res) => {
                  const reader = new FileReader();
                  reader.onload = () => res(reader.result);
                  reader.readAsDataURL(file);
                });
                state.qzoneSettings.banner = dataUrl;
                await saveQzoneSettings();
                renderQzoneScreen();
              }
              event.target.value = null;
            });

          document
            .getElementById("create-shuoshuo-btn")
            .addEventListener("click", async () => {
              // 1. ÈáçÁΩÆÂπ∂Ëé∑ÂèñÊ®°ÊÄÅÊ°Ü
              resetCreatePostModal();
              const modal = document.getElementById("create-post-modal");

              // 2. ËÆæÁΩÆ‰∏∫‚ÄúËØ¥ËØ¥‚ÄùÊ®°Âºè
              modal.dataset.mode = "shuoshuo";

              // 3. ÈöêËóè‰∏éÂõæÁâá/ÊñáÂ≠óÂõæÁõ∏ÂÖ≥ÁöÑÈÉ®ÂàÜ
              modal.querySelector(".post-mode-switcher").style.display = "none";
              modal.querySelector("#image-mode-content").style.display = "none";
              modal.querySelector("#text-image-mode-content").style.display =
                "none";

              // 4. ‰øÆÊîπ‰∏ªËæìÂÖ•Ê°ÜÁöÑÊèêÁ§∫ËØ≠Ôºå‰ΩøÂÖ∂Êõ¥Á¨¶Âêà‚ÄúËØ¥ËØ¥‚ÄùÁöÑÂú∫ÊôØ
              modal.querySelector("#post-public-text").placeholder =
                "ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...";

              // 5. ÂáÜÂ§áÂπ∂ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
              const visibilityGroupsContainer = document.getElementById(
                "post-visibility-groups",
              );
              visibilityGroupsContainer.innerHTML = "";
              const groups = await db.qzoneGroups.toArray();
              if (groups.length > 0) {
                groups.forEach((group) => {
                  const label = document.createElement("label");
                  label.style.display = "block";
                  label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
                  visibilityGroupsContainer.appendChild(label);
                });
              } else {
                visibilityGroupsContainer.innerHTML =
                  '<p style="color: var(--text-secondary);">Ê≤°ÊúâÂèØÁî®ÁöÑÂàÜÁªÑ</p>';
              }
              modal.classList.add("visible");
            });

          document
            .getElementById("create-post-btn")
            .addEventListener("click", async () => {
              resetCreatePostModal();
              const modal = document.getElementById("create-post-modal");

              modal.dataset.mode = "complex";

              modal.querySelector(".post-mode-switcher").style.display = "flex";

              modal.querySelector("#image-mode-content").style.display = "";
              modal.querySelector("#text-image-mode-content").style.display =
                "";

              modal
                .querySelector("#image-mode-content")
                .classList.add("active");
              modal
                .querySelector("#text-image-mode-content")
                .classList.remove("active");

              modal.querySelector("#post-public-text").placeholder =
                "ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...ÔºàÈùûÂøÖÂ°´ÁöÑÂÖ¨ÂºÄÊñáÂ≠óÔºâ";

              const visibilityGroupsContainer = document.getElementById(
                "post-visibility-groups",
              );
              visibilityGroupsContainer.innerHTML = "";
              const groups = await db.qzoneGroups.toArray();
              if (groups.length > 0) {
                groups.forEach((group) => {
                  const label = document.createElement("label");
                  label.style.display = "block";
                  label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
                  visibilityGroupsContainer.appendChild(label);
                });
              } else {
                visibilityGroupsContainer.innerHTML =
                  '<p style="color: var(--text-secondary);">Ê≤°ÊúâÂèØÁî®ÁöÑÂàÜÁªÑ</p>';
              }
              modal.classList.add("visible");
            });
          document
            .getElementById("open-album-btn")
            .addEventListener("click", async () => {
              await renderAlbumList();
              showScreen("album-screen");
            });
          document
            .getElementById("album-back-btn")
            .addEventListener("click", () => {
              showScreen("chat-list-screen");
              switchToChatListView("qzone-screen");
            });

          // --- ‚Üì‚Üì‚Üì ‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ ‚Üì‚Üì‚Üì ---

          document
            .getElementById("album-photos-back-btn")
            .addEventListener("click", () => {
              state.activeAlbumId = null;
              showScreen("album-screen");
            });

          document
            .getElementById("album-upload-photo-btn")
            .addEventListener("click", () =>
              document.getElementById("album-photo-input").click(),
            );

          document
            .getElementById("album-photo-input")
            .addEventListener("change", async (event) => {
              if (!state.activeAlbumId) return;
              const files = event.target.files;
              if (!files.length) return;

              const album = await db.qzoneAlbums.get(state.activeAlbumId);

              for (const file of files) {
                const dataUrl = await new Promise((resolve) => {
                  const reader = new FileReader();
                  reader.onload = () => resolve(reader.result);
                  reader.readAsDataURL(file);
                });
                await db.qzonePhotos.add({
                  albumId: state.activeAlbumId,
                  url: dataUrl,
                  createdAt: Date.now(),
                });
              }

              const photoCount = await db.qzonePhotos
                .where("albumId")
                .equals(state.activeAlbumId)
                .count();
              const updateData = { photoCount };

              if (!album.photoCount || album.coverUrl.includes("placeholder")) {
                const firstPhoto = await db.qzonePhotos
                  .where("albumId")
                  .equals(state.activeAlbumId)
                  .first();
                if (firstPhoto) updateData.coverUrl = firstPhoto.url;
              }

              await db.qzoneAlbums.update(state.activeAlbumId, updateData);
              await renderAlbumPhotosScreen();
              await renderAlbumList();

              event.target.value = null;
              alert("ÁÖßÁâá‰∏ä‰º†ÊàêÂäüÔºÅ");
            });

          // --- ‚Üë‚Üë‚Üë Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ‚Üë‚Üë‚Üë ---

          // --- ‚Üì‚Üì‚Üì ‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ÔºåÂÆåÊï¥ÊõøÊç¢ÊéâÊóßÁöÑ photos-grid-page ÁõëÂê¨Âô® ‚Üì‚Üì‚Üì ---

          document
            .getElementById("photos-grid-page")
            .addEventListener("click", async (e) => {
              const deleteBtn = e.target.closest(".photo-delete-btn");
              const photoThumb = e.target.closest(".photo-thumb");

              if (deleteBtn) {
                e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞ÂõæÁâá‰∏ä
                const photoId = parseInt(deleteBtn.dataset.photoId);
                const confirmed = await showCustomConfirm(
                  "Âà†Èô§ÁÖßÁâá",
                  "Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÁÖßÁâáÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ",
                  { confirmButtonClass: "btn-danger" },
                );

                if (confirmed) {
                  const deletedPhoto = await db.qzonePhotos.get(photoId);
                  if (!deletedPhoto) return;

                  await db.qzonePhotos.delete(photoId);

                  const album = await db.qzoneAlbums.get(state.activeAlbumId);
                  const photoCount = (album.photoCount || 1) - 1;
                  const updateData = { photoCount };

                  if (album.coverUrl === deletedPhoto.url) {
                    const nextPhoto = await db.qzonePhotos
                      .where("albumId")
                      .equals(state.activeAlbumId)
                      .first();
                    updateData.coverUrl = nextPhoto
                      ? nextPhoto.url
                      : "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png";
                  }

                  await db.qzoneAlbums.update(state.activeAlbumId, updateData);
                  await renderAlbumPhotosScreen();
                  await renderAlbumList();
                  alert("ÁÖßÁâáÂ∑≤Âà†Èô§„ÄÇ");
                }
              } else if (photoThumb) {
                // ËøôÂ∞±ÊòØÊÅ¢Â§çÁöÑÂõæÁâáÁÇπÂáªÊîæÂ§ßÂäüËÉΩÔºÅ
                openPhotoViewer(photoThumb.src);
              }
            });

          // ÊÅ¢Â§çÂõæÁâáÊü•ÁúãÂô®ÁöÑÊéßÂà∂‰∫ã‰ª∂
          document
            .getElementById("photo-viewer-close-btn")
            .addEventListener("click", closePhotoViewer);
          document
            .getElementById("photo-viewer-next-btn")
            .addEventListener("click", showNextPhoto);
          document
            .getElementById("photo-viewer-prev-btn")
            .addEventListener("click", showPrevPhoto);

          // ÊÅ¢Â§çÈîÆÁõòÂ∑¶Âè≥ÁÆ≠Â§¥ÂíåESCÈîÆÁöÑÂäüËÉΩ
          document.addEventListener("keydown", (e) => {
            if (!photoViewerState.isOpen) return;

            if (e.key === "ArrowRight") {
              showNextPhoto();
            } else if (e.key === "ArrowLeft") {
              showPrevPhoto();
            } else if (e.key === "Escape") {
              closePhotoViewer();
            }
          });

          // --- ‚Üë‚Üë‚Üë Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ‚Üë‚Üë‚Üë ---

          document
            .getElementById("create-album-btn-page")
            .addEventListener("click", async () => {
              const albumName = await showCustomPrompt(
                "ÂàõÂª∫Êñ∞Áõ∏ÂÜå",
                "ËØ∑ËæìÂÖ•Áõ∏ÂÜåÂêçÁß∞",
              );
              if (albumName && albumName.trim()) {
                const newAlbum = {
                  name: albumName.trim(),
                  coverUrl:
                    "https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png",
                  photoCount: 0,
                  createdAt: Date.now(),
                };
                await db.qzoneAlbums.add(newAlbum);
                await renderAlbumList();
                alert(`Áõ∏ÂÜå "${albumName}" ÂàõÂª∫ÊàêÂäüÔºÅ`);
              } else if (albumName !== null) {
                alert("Áõ∏ÂÜåÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
              }
            });

          document
            .getElementById("cancel-create-post-btn")
            .addEventListener("click", () =>
              document
                .getElementById("create-post-modal")
                .classList.remove("visible"),
            );
          document
            .getElementById("post-upload-local-btn")
            .addEventListener("click", () =>
              document.getElementById("post-local-image-input").click(),
            );
          document
            .getElementById("post-local-image-input")
            .addEventListener("change", (event) => {
              const file = event.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                  document.getElementById("post-image-preview").src =
                    e.target.result;
                  document
                    .getElementById("post-image-preview-container")
                    .classList.add("visible");
                  document.getElementById(
                    "post-image-desc-group",
                  ).style.display = "block";
                };
                reader.readAsDataURL(file);
              }
            });
          document
            .getElementById("post-use-url-btn")
            .addEventListener("click", async () => {
              const url = await showCustomPrompt(
                "ËæìÂÖ•ÂõæÁâáURL",
                "ËØ∑ËæìÂÖ•ÁΩëÁªúÂõæÁâáÁöÑÈìæÊé•",
                "",
                "url",
              );
              if (url) {
                document.getElementById("post-image-preview").src = url;
                document
                  .getElementById("post-image-preview-container")
                  .classList.add("visible");
                document.getElementById("post-image-desc-group").style.display =
                  "block";
              }
            });
          document
            .getElementById("post-remove-image-btn")
            .addEventListener("click", () => resetCreatePostModal());
          const imageModeBtn = document.getElementById("switch-to-image-mode");
          const textImageModeBtn = document.getElementById(
            "switch-to-text-image-mode",
          );
          const imageModeContent =
            document.getElementById("image-mode-content");
          const textImageModeContent = document.getElementById(
            "text-image-mode-content",
          );
          imageModeBtn.addEventListener("click", () => {
            imageModeBtn.classList.add("active");
            textImageModeBtn.classList.remove("active");
            imageModeContent.classList.add("active");
            textImageModeContent.classList.remove("active");
          });
          textImageModeBtn.addEventListener("click", () => {
            textImageModeBtn.classList.add("active");
            imageModeBtn.classList.remove("active");
            textImageModeContent.classList.add("active");
            imageModeContent.classList.remove("active");
          });

          document
            .getElementById("confirm-create-post-btn")
            .addEventListener("click", async () => {
              const modal = document.getElementById("create-post-modal");
              const mode = modal.dataset.mode;

              // --- 1. Ëé∑ÂèñÈÄöÁî®ÁöÑÂèØËßÅÊÄßËÆæÁΩÆ ---
              const visibilityMode = document.querySelector(
                'input[name="visibility"]:checked',
              ).value;
              let visibleGroupIds = null;

              if (visibilityMode === "include") {
                visibleGroupIds = Array.from(
                  document.querySelectorAll(
                    'input[name="visibility_group"]:checked',
                  ),
                ).map((cb) => parseInt(cb.value));
              }

              let newPost = {};
              const basePostData = {
                timestamp: Date.now(),
                authorId: "user",
                // „ÄêÈáçË¶Å„ÄëÂú®ËøôÈáåÂ∞±ÊääÊùÉÈôê‰ø°ÊÅØÂ≠òÂ•Ω
                visibleGroupIds: visibleGroupIds,
              };

              // --- 2. Ê†πÊçÆÊ®°ÂºèÊûÑÂª∫‰∏çÂêåÁöÑ post ÂØπË±° ---
              if (mode === "shuoshuo") {
                const content = document
                  .getElementById("post-public-text")
                  .value.trim();
                if (!content) {
                  alert("ËØ¥ËØ¥ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫Âì¶ÔºÅ");
                  return;
                }
                newPost = {
                  ...basePostData,
                  type: "shuoshuo",
                  content: content,
                };
              } else {
                // Â§ÑÁêÜ 'complex' Ê®°Âºè (ÂõæÁâá/ÊñáÂ≠óÂõæ)
                const publicText = document
                  .getElementById("post-public-text")
                  .value.trim();
                const isImageModeActive = document
                  .getElementById("image-mode-content")
                  .classList.contains("active");

                if (isImageModeActive) {
                  const imageUrl =
                    document.getElementById("post-image-preview").src;
                  const imageDescription = document
                    .getElementById("post-image-description")
                    .value.trim();
                  if (
                    !imageUrl ||
                    !(
                      imageUrl.startsWith("http") ||
                      imageUrl.startsWith("data:")
                    )
                  ) {
                    alert("ËØ∑ÂÖàÊ∑ªÂä†‰∏ÄÂº†ÂõæÁâáÂÜçÂèëÂ∏ÉÂä®ÊÄÅÂì¶ÔºÅ");
                    return;
                  }
                  if (!imageDescription) {
                    alert("ËØ∑‰∏∫‰Ω†ÁöÑÂõæÁâáÊ∑ªÂä†‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊèèËø∞ÔºàÂøÖÂ°´ÔºåÁªôAIÁúãÁöÑÔºâÔºÅ");
                    return;
                  }
                  newPost = {
                    ...basePostData,
                    type: "image_post",
                    publicText: publicText,
                    imageUrl: imageUrl,
                    imageDescription: imageDescription,
                  };
                } else {
                  // ÊñáÂ≠óÂõæÊ®°Âºè
                  const hiddenText = document
                    .getElementById("post-hidden-text")
                    .value.trim();
                  if (!hiddenText) {
                    alert("ËØ∑ËæìÂÖ•ÊñáÂ≠óÂõæÊèèËø∞ÔºÅ");
                    return;
                  }
                  newPost = {
                    ...basePostData,
                    type: "text_image",
                    publicText: publicText,
                    hiddenContent: hiddenText,
                  };
                }
              }

              // --- 3. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì ---
              const newPostId = await db.qzonePosts.add(newPost);
              let postSummary =
                newPost.content ||
                newPost.publicText ||
                newPost.imageDescription ||
                newPost.hiddenContent ||
                "ÔºàÊó†ÊñáÂ≠óÂÜÖÂÆπÔºâ";
              postSummary =
                postSummary.substring(0, 50) +
                (postSummary.length > 50 ? "..." : "");

              // --- 4. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ∏¶ÊúâÊùÉÈôêÊ£ÄÊü•ÁöÑÈÄöÁü•Âæ™ÁéØ ---
              for (const chatId in state.chats) {
                const chat = state.chats[chatId];
                if (chat.isGroup) continue; // Ë∑≥ËøáÁæ§ËÅä

                let shouldNotify = false;
                const postVisibleGroups = newPost.visibleGroupIds;

                // Âà§Êñ≠Êù°‰ª∂1ÔºöÂ¶ÇÊûúÂä®ÊÄÅÊòØÂÖ¨ÂºÄÁöÑ (Ê≤°ÊúâËÆæÁΩÆ‰ªª‰ΩïÂèØËßÅÂàÜÁªÑ)
                if (!postVisibleGroups || postVisibleGroups.length === 0) {
                  shouldNotify = true;
                }
                // Âà§Êñ≠Êù°‰ª∂2ÔºöÂ¶ÇÊûúÂä®ÊÄÅËÆæÁΩÆ‰∫ÜÈÉ®ÂàÜÂèØËßÅÔºåÂπ∂‰∏îÂΩìÂâçËßíËâ≤Âú®ÂèØËßÅÂàÜÁªÑÂÜÖ
                else if (
                  chat.groupId &&
                  postVisibleGroups.includes(chat.groupId)
                ) {
                  shouldNotify = true;
                }

                // Âè™ÊúâÊª°Ë∂≥Êù°‰ª∂ÁöÑËßíËâ≤Êâç‰ºöË¢´ÈÄöÁü•
                if (shouldNotify) {
                  const historyMessage = {
                    role: "system",
                    content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÂàöÂèëÂ∏É‰∫Ü‰∏ÄÊù°Âä®ÊÄÅ(ID: ${newPostId})ÔºåÂÜÖÂÆπÊëòË¶ÅÊòØÔºö‚Äú${postSummary}‚Äù„ÄÇ‰Ω†Áé∞Âú®ÂèØ‰ª•ÂØπËøôÊù°Âä®ÊÄÅËøõË°åËØÑËÆ∫‰∫Ü„ÄÇ]`,
                    timestamp: Date.now(),
                    isHidden: true,
                  };
                  chat.history.push(historyMessage);
                  await db.chats.put(chat);
                }
              }
              // --- ‰øÆÊ≠£ÁªìÊùü ---

              await renderQzonePosts();
              modal.classList.remove("visible");
              alert("Âä®ÊÄÅÂèëÂ∏ÉÊàêÂäüÔºÅ");
            });

          const postsList = document.getElementById("qzone-posts-list");
          let swipeState = {
            isDragging: false,
            startX: 0,
            startY: 0,
            currentX: 0,
            activeContainer: null,
            swipeDirection: null,
            isClick: true,
          };

          function resetAllSwipes(exceptThisOne = null) {
            document
              .querySelectorAll(".qzone-post-container")
              .forEach((container) => {
                if (container !== exceptThisOne) {
                  container
                    .querySelector(".qzone-post-item")
                    .classList.remove("swiped");
                }
              });
          }

          const handleSwipeStart = (e) => {
            const targetContainer = e.target.closest(".qzone-post-container");
            if (!targetContainer) return;

            resetAllSwipes(targetContainer);
            swipeState.activeContainer = targetContainer;
            swipeState.isDragging = true;
            swipeState.isClick = true;
            swipeState.swipeDirection = null;
            swipeState.startX = e.type.includes("mouse")
              ? e.pageX
              : e.touches[0].pageX;
            swipeState.startY = e.type.includes("mouse")
              ? e.pageY
              : e.touches[0].pageY;
            swipeState.activeContainer.querySelector(
              ".qzone-post-item",
            ).style.transition = "none";
          };

          const handleSwipeMove = (e) => {
            if (!swipeState.isDragging || !swipeState.activeContainer) return;

            const currentX = e.type.includes("mouse")
              ? e.pageX
              : e.touches[0].pageX;
            const currentY = e.type.includes("mouse")
              ? e.pageY
              : e.touches[0].pageY;
            const diffX = currentX - swipeState.startX;
            const diffY = currentY - swipeState.startY;
            const absDiffX = Math.abs(diffX);
            const absDiffY = Math.abs(diffY);
            const clickThreshold = 5;

            if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
              swipeState.isClick = false;
            }

            if (swipeState.swipeDirection === null) {
              if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
                if (absDiffX > absDiffY) {
                  swipeState.swipeDirection = "horizontal";
                } else {
                  swipeState.swipeDirection = "vertical";
                }
              }
            }
            if (swipeState.swipeDirection === "vertical") {
              handleSwipeEnd(e);
              return;
            }
            if (swipeState.swipeDirection === "horizontal") {
              e.preventDefault();
              swipeState.currentX = currentX;
              let translation = diffX;
              if (translation > 0) translation = 0;
              if (translation < -90) translation = -90;
              swipeState.activeContainer.querySelector(
                ".qzone-post-item",
              ).style.transform = `translateX(${translation}px)`;
            }
          };

          const handleSwipeEnd = (e) => {
            if (swipeState.isClick) {
              swipeState.isDragging = false;
              swipeState.activeContainer = null;
              return;
            }
            if (!swipeState.isDragging || !swipeState.activeContainer) return;

            const postItem =
              swipeState.activeContainer.querySelector(".qzone-post-item");
            postItem.style.transition = "transform 0.3s ease";

            const finalX = e.type.includes("touchend")
              ? e.changedTouches[0].pageX
              : e.pageX;
            const diffX = finalX - swipeState.startX;
            const swipeThreshold = -40;

            if (
              swipeState.swipeDirection === "horizontal" &&
              diffX < swipeThreshold
            ) {
              postItem.classList.add("swiped");
              postItem.style.transform = "";
            } else {
              postItem.classList.remove("swiped");
              postItem.style.transform = "";
            }

            swipeState.isDragging = false;
            swipeState.startX = 0;
            swipeState.startY = 0;
            swipeState.currentX = 0;
            swipeState.activeContainer = null;
            swipeState.swipeDirection = null;
            swipeState.isClick = true;
          };

          // --- ÁªëÂÆöÊâÄÊúâÊªëÂä®‰∫ã‰ª∂ ---
          postsList.addEventListener("mousedown", handleSwipeStart);
          document.addEventListener("mousemove", handleSwipeMove);
          document.addEventListener("mouseup", handleSwipeEnd);
          postsList.addEventListener("touchstart", handleSwipeStart, {
            passive: false,
          });
          postsList.addEventListener("touchmove", handleSwipeMove, {
            passive: false,
          });
          postsList.addEventListener("touchend", handleSwipeEnd);

          // --- ÁªëÂÆöÊâÄÊúâÁÇπÂáª‰∫ã‰ª∂ ---
          postsList.addEventListener("click", async (e) => {
            e.stopPropagation();
            const target = e.target;

            // --- Êñ∞Â¢ûÔºöÂ§ÑÁêÜËØÑËÆ∫Âà†Èô§ÊåâÈíÆ ---
            if (target.classList.contains("comment-delete-btn")) {
              const postContainer = target.closest(".qzone-post-container");
              if (!postContainer) return;

              const postId = parseInt(postContainer.dataset.postId);
              const commentIndex = parseInt(target.dataset.commentIndex);
              if (isNaN(postId) || isNaN(commentIndex)) return;

              const post = await db.qzonePosts.get(postId);
              if (!post || !post.comments || !post.comments[commentIndex])
                return;

              const commentText = post.comments[commentIndex].text;
              const confirmed = await showCustomConfirm(
                "Âà†Èô§ËØÑËÆ∫",
                `Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºü\n\n‚Äú${commentText.substring(
                  0,
                  50,
                )}...‚Äù`,
                { confirmButtonClass: "btn-danger" },
              );

              if (confirmed) {
                // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§ËØ•ËØÑËÆ∫
                post.comments.splice(commentIndex, 1);
                // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
                await db.qzonePosts.update(postId, { comments: post.comments });
                // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®‰ª•ÂèçÊò†Êõ¥Êîπ
                await renderQzonePosts();
                alert("ËØÑËÆ∫Â∑≤Âà†Èô§„ÄÇ");
              }
              return; // Â§ÑÁêÜÂÆåÂêéÁõ¥Êé•ËøîÂõû
            }

            if (target.classList.contains("post-actions-btn")) {
              const container = target.closest(".qzone-post-container");
              if (container && container.dataset.postId) {
                showPostActions(parseInt(container.dataset.postId));
              }
              return;
            }

            if (target.closest(".qzone-post-delete-action")) {
              const container = target.closest(".qzone-post-container");
              if (!container) return;

              const postIdToDelete = parseInt(container.dataset.postId);
              if (isNaN(postIdToDelete)) return;

              const confirmed = await showCustomConfirm(
                "Âà†Èô§Âä®ÊÄÅ",
                "Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÊù°Âä®ÊÄÅÂêóÔºü",
                { confirmButtonClass: "btn-danger" },
              );

              if (confirmed) {
                container.style.transition = "all 0.3s ease";
                container.style.transform = "scale(0.8)";
                container.style.opacity = "0";

                setTimeout(async () => {
                  await db.qzonePosts.delete(postIdToDelete);

                  const notificationIdentifier = `(ID: ${postIdToDelete})`;
                  for (const chatId in state.chats) {
                    const chat = state.chats[chatId];
                    const originalHistoryLength = chat.history.length;
                    chat.history = chat.history.filter(
                      (msg) =>
                        !(
                          msg.role === "system" &&
                          msg.content.includes(notificationIdentifier)
                        ),
                    );
                    if (chat.history.length < originalHistoryLength) {
                      chat.settings.offlineMode = {
                        enabled: document.getElementById("offline-mode-toggle")
                          .checked,
                        preset: document.getElementById("offline-preset-select")
                          .value,
                        prompt: document.getElementById("offline-prompt-input")
                          .value,
                        style: document.getElementById("offline-style-input")
                          .value,
                      };

                      await db.chats.put(chat);
                    }
                  }
                  await renderQzonePosts();
                  alert("Âä®ÊÄÅÂ∑≤Âà†Èô§„ÄÇ");
                }, 300);
              }
              return;
            }

            if (target.tagName === "IMG" && target.dataset.hiddenText) {
              const hiddenText = target.dataset.hiddenText;
              showCustomAlert("ÂõæÁâáÂÜÖÂÆπ", hiddenText.replace(/<br>/g, "\n"));
              return;
            }
            const icon = target.closest(".action-icon");
            if (icon) {
              const postContainer = icon.closest(".qzone-post-container");
              if (!postContainer) return;
              const postId = parseInt(postContainer.dataset.postId);
              if (isNaN(postId)) return;
              if (icon.classList.contains("like")) {
                const post = await db.qzonePosts.get(postId);
                if (!post) return;
                if (!post.likes) post.likes = [];
                const userNickname = state.qzoneSettings.nickname;
                const userLikeIndex = post.likes.indexOf(userNickname);
                if (userLikeIndex > -1) {
                  post.likes.splice(userLikeIndex, 1);
                } else {
                  post.likes.push(userNickname);
                  icon.classList.add("animate-like");
                  icon.addEventListener(
                    "animationend",
                    () => icon.classList.remove("animate-like"),
                    { once: true },
                  );
                }
                await db.qzonePosts.update(postId, { likes: post.likes });
              }
              if (icon.classList.contains("favorite")) {
                const existingFavorite = await db.favorites
                  .where({ type: "qzone_post", "content.id": postId })
                  .first();
                if (existingFavorite) {
                  await db.favorites.delete(existingFavorite.id);
                  await showCustomAlert("ÊèêÁ§∫", "Â∑≤ÂèñÊ∂àÊî∂Ëóè");
                } else {
                  const postToSave = await db.qzonePosts.get(postId);
                  if (postToSave) {
                    await db.favorites.add({
                      type: "qzone_post",
                      content: postToSave,
                      timestamp: Date.now(),
                    });
                    await showCustomAlert("ÊèêÁ§∫", "Êî∂ËóèÊàêÂäüÔºÅ");
                  }
                }
              }
              await renderQzonePosts();
              return;
            }
            const sendBtn = target.closest(".comment-send-btn");
            if (sendBtn) {
              const postContainer = sendBtn.closest(".qzone-post-container");
              if (!postContainer) return;
              const postId = parseInt(postContainer.dataset.postId);
              const commentInput =
                postContainer.querySelector(".comment-input");
              const commentText = commentInput.value.trim();
              if (!commentText) return alert("ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫Âì¶ÔºÅ");
              const post = await db.qzonePosts.get(postId);
              if (!post) return;
              if (!post.comments) post.comments = [];
              post.comments.push({
                commenterName: state.qzoneSettings.nickname,
                text: commentText,
                timestamp: Date.now(),
              });
              await db.qzonePosts.update(postId, { comments: post.comments });
              for (const chatId in state.chats) {
                const chat = state.chats[chatId];
                if (!chat.isGroup) {
                  chat.history.push({
                    role: "system",
                    content: `[Á≥ªÁªüÊèêÁ§∫Ôºö'${state.qzoneSettings.nickname}' Âú®ID‰∏∫${postId}ÁöÑÂä®ÊÄÅ‰∏ãÂèëË°®‰∫ÜËØÑËÆ∫Ôºö‚Äú${commentText}‚Äù]`,
                    timestamp: Date.now(),
                    isHidden: true,
                  });
                  await db.chats.put(chat);
                }
              }
              commentInput.value = "";
              await renderQzonePosts();
              return;
            }
          });

          // ÁªëÂÆöÂä®ÊÄÅÈ°µÂíåÊî∂ËóèÈ°µÁöÑËøîÂõûÊåâÈíÆ
          document
            .getElementById("qzone-back-btn")
            .addEventListener("click", () =>
              switchToChatListView("messages-view"),
            );
          document
            .getElementById("favorites-back-btn")
            .addEventListener("click", () =>
              switchToChatListView("messages-view"),
            );

          // Êî∂ËóèÈ°µÊêúÁ¥¢ÂäüËÉΩ
          const searchInput = document.getElementById("favorites-search-input");
          const searchClearBtn = document.getElementById(
            "favorites-search-clear-btn",
          );

          searchInput.addEventListener("input", () => {
            const searchTerm = searchInput.value.trim().toLowerCase();

            // ÊéßÂà∂Ê∏ÖÈô§ÊåâÈíÆÁöÑÊòæÁ§∫/ÈöêËóè
            searchClearBtn.style.display = searchTerm ? "block" : "none";

            if (!searchTerm) {
              displayFilteredFavorites(allFavoriteItems); // Â¶ÇÊûúÊêúÁ¥¢Ê°Ü‰∏∫Á©∫ÔºåÊòæÁ§∫ÊâÄÊúâ
              return;
            }

            // Á≠õÈÄâÈÄªËæë
            const filteredItems = allFavoriteItems.filter((item) => {
              let contentToSearch = "";
              let authorToSearch = "";

              if (item.type === "qzone_post") {
                const post = item.content;
                contentToSearch +=
                  (post.publicText || "") + " " + (post.content || "");
                if (post.authorId === "user") {
                  authorToSearch = state.qzoneSettings.nickname;
                } else if (state.chats[post.authorId]) {
                  authorToSearch = state.chats[post.authorId].name;
                }
              } else if (item.type === "chat_message") {
                const msg = item.content;
                if (typeof msg.content === "string") {
                  contentToSearch = msg.content;
                }
                const chat = state.chats[item.chatId];
                if (chat) {
                  if (msg.role === "user") {
                    authorToSearch = chat.isGroup
                      ? chat.settings.myNickname || "Êàë"
                      : "Êàë";
                  } else {
                    authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                  }
                }
              }

              // ÂêåÊó∂ÊêúÁ¥¢ÂÜÖÂÆπÂíå‰ΩúËÄÖÔºåÂπ∂‰∏î‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜô
              return (
                contentToSearch.toLowerCase().includes(searchTerm) ||
                authorToSearch.toLowerCase().includes(searchTerm)
              );
            });

            displayFilteredFavorites(filteredItems);
          });

          // Ê∏ÖÈô§ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
          searchClearBtn.addEventListener("click", () => {
            searchInput.value = "";
            searchClearBtn.style.display = "none";
            displayFilteredFavorites(allFavoriteItems);
            searchInput.focus();
          });

          // ‰∏∫ËÅäÂ§©ÁïåÈù¢ÁöÑÊâπÈáèÊî∂ËóèÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂
          // ‰∏∫ËÅäÂ§©ÁïåÈù¢ÁöÑÊâπÈáèÊî∂ËóèÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂ (Â∑≤‰øÆÊ≠£)
          document
            .getElementById("selection-favorite-btn")
            .addEventListener("click", async () => {
              if (selectedMessages.size === 0) return;
              const chat = state.chats[state.activeChatId];
              if (!chat) return;

              const favoritesToAdd = [];
              const timestampsToFavorite = [...selectedMessages];

              for (const timestamp of timestampsToFavorite) {
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£1„Äë‰ΩøÁî®Êñ∞ÁöÑ„ÄÅÈ´òÊïàÁöÑÁ¥¢ÂºïËøõË°åÊü•ËØ¢
                const existing = await db.favorites
                  .where("originalTimestamp")
                  .equals(timestamp)
                  .first();

                if (!existing) {
                  const messageToSave = chat.history.find(
                    (msg) => msg.timestamp === timestamp,
                  );
                  if (messageToSave) {
                    favoritesToAdd.push({
                      type: "chat_message",
                      content: messageToSave,
                      chatId: state.activeChatId,
                      timestamp: Date.now(), // ËøôÊòØÊî∂ËóèÊìç‰ΩúÂèëÁîüÁöÑÊó∂Èó¥
                      originalTimestamp: messageToSave.timestamp, // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£2„Äë‰øùÂ≠òÂéüÂßãÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥Âà∞Êñ∞Â≠óÊÆµ
                    });
                  }
                }
              }

              if (favoritesToAdd.length > 0) {
                await db.favorites.bulkAdd(favoritesToAdd);
                allFavoriteItems = await db.favorites
                  .orderBy("timestamp")
                  .reverse()
                  .toArray(); // Êõ¥Êñ∞ÂÖ®Â±ÄÊî∂ËóèÁºìÂ≠ò
                await showCustomAlert(
                  "Êî∂ËóèÊàêÂäü",
                  `Â∑≤ÊàêÂäüÊî∂Ëóè ${favoritesToAdd.length} Êù°Ê∂àÊÅØ„ÄÇ`,
                );
              } else {
                await showCustomAlert("ÊèêÁ§∫", "ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØÂùáÂ∑≤Êî∂ËóèËøá„ÄÇ");
              }

              exitSelectionMode();
            });

          // Êî∂ËóèÈ°µÈù¢ÁöÑ"ÁºñËæë"ÊåâÈíÆ‰∫ã‰ª∂ (Â∑≤‰øÆÊ≠£)
          const favoritesEditBtn =
            document.getElementById("favorites-edit-btn");
          const favoritesView = document.getElementById("favorites-view");
          const favoritesActionBar = document.getElementById(
            "favorites-action-bar",
          );
          const mainBottomNav = document.getElementById("chat-list-bottom-nav"); // Ëé∑Âèñ‰∏ªÂØºËà™Ê†è
          const favoritesList = document.getElementById("favorites-list"); // Ëé∑ÂèñÊî∂ËóèÂàóË°®

          favoritesEditBtn.addEventListener("click", () => {
            isFavoritesSelectionMode = !isFavoritesSelectionMode;
            favoritesView.classList.toggle(
              "selection-mode",
              isFavoritesSelectionMode,
            );

            if (isFavoritesSelectionMode) {
              // --- ËøõÂÖ•ÁºñËæëÊ®°Âºè ---
              favoritesEditBtn.textContent = "ÂÆåÊàê";
              favoritesActionBar.style.display = "block"; // ÊòæÁ§∫Âà†Èô§Êìç‰ΩúÊ†è
            } else {
              // --- ÈÄÄÂá∫ÁºñËæëÊ®°Âºè ---
              favoritesEditBtn.textContent = "ÁºñËæë";
              favoritesActionBar.style.display = "none"; // ÈöêËóèÂà†Èô§Êìç‰ΩúÊ†è

              // ÈÄÄÂá∫Êó∂Ê∏ÖÁ©∫ÊâÄÊúâÈÄâÊã©
              selectedFavorites.clear();
              document
                .querySelectorAll(".favorite-item-card.selected")
                .forEach((card) => card.classList.remove("selected"));
              document.getElementById(
                "favorites-delete-selected-btn",
              ).textContent = `Âà†Èô§ (0)`;
            }
          });

          // Êî∂ËóèÂàóË°®ÁöÑÁÇπÂáªÈÄâÊã©‰∫ã‰ª∂ (‰∫ã‰ª∂ÂßîÊâò)
          document
            .getElementById("favorites-list")
            .addEventListener("click", (e) => {
              const target = e.target;
              const card = target.closest(".favorite-item-card");

              // „ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊñáÂ≠óÂõæÁÇπÂáªÔºåËøôÊÆµÈÄªËæëË¶ÅÊîæÂú®ÊúÄÂâçÈù¢Ôºå‰øùËØÅ‰ªª‰ΩïÊ®°Âºè‰∏ãÈÉΩÁîüÊïà
              if (target.tagName === "IMG" && target.dataset.hiddenText) {
                const hiddenText = target.dataset.hiddenText;
                showCustomAlert("ÂõæÁâáÂÜÖÂÆπ", hiddenText.replace(/<br>/g, "\n"));
                return; // Â§ÑÁêÜÂÆåÂ∞±ÈÄÄÂá∫Ôºå‰∏çÁªßÁª≠ÊâßË°åÈÄâÊã©ÈÄªËæë
              }

              // Â¶ÇÊûú‰∏çÂú®ÈÄâÊã©Ê®°ÂºèÔºåÂàô‰∏çÊâßË°åÂêéÁª≠ÁöÑÈÄâÊã©Êìç‰Ωú
              if (!isFavoritesSelectionMode) return;

              // --- ‰ª•‰∏ãÊòØÂéüÊúâÁöÑÈÄâÊã©ÈÄªËæëÔºå‰øùÊåÅ‰∏çÂèò ---
              if (!card) return;

              const favId = parseInt(card.dataset.favid);
              if (isNaN(favId)) return;

              // ÂàáÊç¢ÈÄâÊã©Áä∂ÊÄÅ
              if (selectedFavorites.has(favId)) {
                selectedFavorites.delete(favId);
                card.classList.remove("selected");
              } else {
                selectedFavorites.add(favId);
                card.classList.add("selected");
              }

              // Êõ¥Êñ∞Â∫ïÈÉ®Âà†Èô§ÊåâÈíÆÁöÑËÆ°Êï∞
              document.getElementById(
                "favorites-delete-selected-btn",
              ).textContent = `Âà†Èô§ (${selectedFavorites.size})`;
            });

          // Êî∂ËóèÈ°µÈù¢ÊâπÈáèÂà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
          document
            .getElementById("favorites-delete-selected-btn")
            .addEventListener("click", async () => {
              if (selectedFavorites.size === 0) return;

              const confirmed = await showCustomConfirm(
                "Á°ÆËÆ§Âà†Èô§",
                `Á°ÆÂÆöË¶Å‰ªéÊî∂ËóèÂ§π‰∏≠ÁßªÈô§Ëøô ${selectedFavorites.size} Êù°ÂÜÖÂÆπÂêóÔºü`,
                { confirmButtonClass: "btn-danger" },
              );

              if (confirmed) {
                const idsToDelete = [...selectedFavorites];
                await db.favorites.bulkDelete(idsToDelete);
                await showCustomAlert("Âà†Èô§ÊàêÂäü", "ÈÄâ‰∏≠ÁöÑÊî∂ËóèÂ∑≤Ë¢´ÁßªÈô§„ÄÇ");

                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£1„Äë‰ªéÂâçÁ´ØÁºìÂ≠ò‰∏≠‰πüÁßªÈô§Ë¢´Âà†Èô§ÁöÑÈ°π
                allFavoriteItems = allFavoriteItems.filter(
                  (item) => !idsToDelete.includes(item.id),
                );

                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£2„Äë‰ΩøÁî®Êõ¥Êñ∞ÂêéÁöÑÁºìÂ≠òÔºåÁ´ãÂç≥ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
                displayFilteredFavorites(allFavoriteItems);

                // ÊúÄÂêéÔºåÂÜçÈÄÄÂá∫ÁºñËæëÊ®°Âºè
                favoritesEditBtn.click(); // Ê®°ÊãüÁÇπÂáª"ÂÆåÊàê"ÊåâÈíÆÊù•ÈÄÄÂá∫ÁºñËæëÊ®°Âºè
              }
            });

          if (state.globalSettings.enableBackgroundActivity) {
            startBackgroundSimulation();
            console.log("ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤Ëá™Âä®ÂêØÂä®„ÄÇ");
          }

          // --- Áªü‰∏ÄÂ§ÑÁêÜÊâÄÊúâÂΩ±ÂìçÈ¢ÑËßàÁöÑÊéß‰ª∂ÁöÑ‰∫ã‰ª∂ ---

          // 1. ÁõëÂê¨‰∏ªÈ¢òÈÄâÊã©
          document
            .querySelectorAll('input[name="theme-select"]')
            .forEach((radio) => {
              radio.addEventListener("change", updateSettingsPreview);
            });

          // 2. ÁõëÂê¨Â≠ó‰ΩìÂ§ßÂ∞èÊªëÂùó
          const fontSizeSlider = document.getElementById("font-size-slider");
          fontSizeSlider.addEventListener("input", () => {
            // a. ÂÆûÊó∂Êõ¥Êñ∞Êï∞ÂÄºÊòæÁ§∫
            document.getElementById("font-size-value").textContent =
              `${fontSizeSlider.value}px`;
            // b. Êõ¥Êñ∞È¢ÑËßà
            updateSettingsPreview();
          });

          // 3. ÁõëÂê¨Ëá™ÂÆö‰πâCSSËæìÂÖ•Ê°Ü
          const customCssInputForPreview =
            document.getElementById("custom-css-input");
          customCssInputForPreview.addEventListener(
            "input",
            updateSettingsPreview,
          );

          // 4. ÁõëÂê¨ÈáçÁΩÆÊåâÈíÆ
          document
            .getElementById("reset-theme-btn")
            .addEventListener("click", () => {
              document.getElementById("theme-default").checked = true;
              updateSettingsPreview();
            });

          document
            .getElementById("reset-custom-css-btn")
            .addEventListener("click", () => {
              document.getElementById("custom-css-input").value = "";
              updateSettingsPreview();
            });

          document
            .querySelectorAll('input[name="visibility"]')
            .forEach((radio) => {
              radio.addEventListener("change", function () {
                const groupsContainer = document.getElementById(
                  "post-visibility-groups",
                );
                if (this.value === "include" || this.value === "exclude") {
                  groupsContainer.style.display = "block";
                } else {
                  groupsContainer.style.display = "none";
                }
              });
            });

          document
            .getElementById("manage-groups-btn")
            .addEventListener("click", openGroupManager);
          document
            .getElementById("close-group-manager-btn")
            .addEventListener("click", () => {
              document
                .getElementById("group-management-modal")
                .classList.remove("visible");
              // Âà∑Êñ∞ËÅäÂ§©ËÆæÁΩÆÈáåÁöÑÂàÜÁªÑÂàóË°®
              const chatSettingsBtn =
                document.getElementById("chat-settings-btn");
              if (
                document
                  .getElementById("chat-settings-modal")
                  .classList.contains("visible")
              ) {
                chatSettingsBtn.click(); // ÂÜçÊ¨°ÁÇπÂáª‰ª•ÈáçÊñ∞ÊâìÂºÄ
              }
            });

          document
            .getElementById("add-new-group-btn")
            .addEventListener("click", addNewGroup);
          document
            .getElementById("existing-groups-list")
            .addEventListener("click", (e) => {
              if (e.target.classList.contains("delete-group-btn")) {
                const groupId = parseInt(e.target.dataset.id);
                deleteGroup(groupId);
              }
            });

          // Ê∂àÊÅØÊìç‰ΩúËèúÂçïÁöÑÊåâÈíÆ‰∫ã‰ª∂
          document
            .getElementById("cancel-message-action-btn")
            .addEventListener("click", hideMessageActions);
          document
            .getElementById("edit-message-btn")
            .addEventListener("click", openAdvancedMessageEditor);
          document
            .getElementById("copy-message-btn")
            .addEventListener("click", copyMessageContent);

          document
            .getElementById("recall-message-btn")
            .addEventListener("click", handleRecallClick);

          document
            .getElementById("select-message-btn")
            .addEventListener("click", () => {
              // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂú®ÂÖ≥Èó≠ËèúÂçïÂâçÔºåÂÖàÊçïËé∑Êó∂Èó¥Êà≥
              const timestampToSelect = activeMessageTimestamp;
              hideMessageActions();
              // ‰ΩøÁî®ÊçïËé∑Âà∞ÁöÑÂÄº
              if (timestampToSelect) {
                enterSelectionMode(timestampToSelect);
              }
            });

          // Âä®ÊÄÅÊìç‰ΩúËèúÂçïÁöÑÊåâÈíÆ‰∫ã‰ª∂
          document
            .getElementById("edit-post-btn")
            .addEventListener("click", openPostEditor);
          document
            .getElementById("copy-post-btn")
            .addEventListener("click", copyPostContent);
          document
            .getElementById("cancel-post-action-btn")
            .addEventListener("click", hidePostActions);

          document
            .getElementById("cancel-contact-picker-btn")
            .addEventListener("click", () => {
              showScreen("chat-list-screen");
            });

          document
            .getElementById("contact-picker-list")
            .addEventListener("click", (e) => {
              const item = e.target.closest(".contact-picker-item");
              if (!item) return;

              const contactId = item.dataset.contactId;
              item.classList.toggle("selected");

              if (selectedContacts.has(contactId)) {
                selectedContacts.delete(contactId);
              } else {
                selectedContacts.add(contactId);
              }
              updateContactPickerConfirmButton();
            });

          document
            .getElementById("manage-members-btn")
            .addEventListener("click", () => {
              // Âú®ÂàáÊç¢Â±èÂπïÂâçÔºåÂÖàÈöêËóèÂΩìÂâçÁöÑËÅäÂ§©ËÆæÁΩÆÂºπÁ™ó
              document
                .getElementById("chat-settings-modal")
                .classList.remove("visible");
              // ÁÑ∂ÂêéÂÜçÊâìÂºÄÊàêÂëòÁÆ°ÁêÜÂ±èÂπï
              openMemberManagementScreen();
            });

          document
            .getElementById("back-from-member-management")
            .addEventListener("click", () => {
              showScreen("chat-interface-screen");
              document.getElementById("chat-settings-btn").click();
            });

          document
            .getElementById("member-management-list")
            .addEventListener("click", (e) => {
              // „ÄêÂ∑≤ÊÅ¢Â§ç„ÄëÁßªÈô§ÊàêÂëòÁöÑ‰∫ã‰ª∂
              if (e.target.classList.contains("remove-member-btn")) {
                removeMemberFromGroup(e.target.dataset.memberId);
              }
            });

          document
            .getElementById("add-existing-contact-btn")
            .addEventListener("click", async () => {
              // „ÄêÂ∑≤ÊÅ¢Â§ç„Äë‰ªéÂ•ΩÂèãÂàóË°®Ê∑ªÂä†ÁöÑ‰∫ã‰ª∂
              // „ÄêÂÖ≥ÈîÆ„Äë‰∏∫‚ÄúÂÆåÊàê‚ÄùÊåâÈíÆÁªëÂÆö‚ÄúÊãâ‰∫∫ÂÖ•Áæ§‚ÄùÁöÑÈÄªËæë
              const confirmBtn = document.getElementById(
                "confirm-contact-picker-btn",
              );
              // ‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÊñπÊ≥ïÊ∏ÖÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆö
              const newConfirmBtn = confirmBtn.cloneNode(true);
              confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
              newConfirmBtn.addEventListener("click", handleAddMembersToGroup);

              await openContactPickerForAddMember();
            });

          document
            .getElementById("create-new-member-btn")
            .addEventListener("click", createNewMemberInGroup);

          // ÁªëÂÆöÂçïËÅäÂíåÁæ§ËÅäÁöÑÂèëËµ∑ÊåâÈíÆ
          document
            .getElementById("video-call-btn")
            .addEventListener("click", handleInitiateCall);
          document
            .getElementById("group-video-call-btn")
            .addEventListener("click", handleInitiateCall);

          // ÁªëÂÆö‚ÄúÊåÇÊñ≠‚ÄùÊåâÈíÆ
          document
            .getElementById("hang-up-btn")
            .addEventListener("click", endVideoCall);

          // ÁªëÂÆö‚ÄúÂèñÊ∂àÂëºÂè´‚ÄùÊåâÈíÆ
          document
            .getElementById("cancel-call-btn")
            .addEventListener("click", () => {
              videoCallState.isAwaitingResponse = false;
              showScreen("chat-interface-screen");
            });

          // „ÄêÂÖ®Êñ∞„ÄëÁªëÂÆö‚ÄúÂä†ÂÖ•ÈÄöËØù‚ÄùÊåâÈíÆ
          document
            .getElementById("join-call-btn")
            .addEventListener("click", handleUserJoinCall);

          document
            .getElementById("offline-mode-toggle")
            .addEventListener("change", (e) => {
              document.getElementById("offline-mode-config").style.display = e
                .target.checked
                ? "block"
                : "none";
            });

          // ÁªëÂÆöÊù•ÁîµËØ∑Ê±ÇÁöÑ‚ÄúÊãíÁªù‚ÄùÊåâÈíÆ
          document
            .getElementById("decline-call-btn")
            .addEventListener("click", async () => {
              hideIncomingCallModal();
              const chat = state.chats[videoCallState.activeChatId];
              if (!chat) return;

              // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨Â∞ÜÊãíÁªùÁöÑÈÄªËæë‰∏éAPIË∞ÉÁî®ËøûÊé•Ëµ∑Êù•
              if (videoCallState.isGroupCall) {
                videoCallState.isUserParticipating = false; // Ê†áËÆ∞Áî®Êà∑‰∏∫ÊóÅËßÇËÄÖ

                // 1. ÂàõÂª∫‰∏ÄÊù°ÈöêËóèÊ∂àÊÅØÔºåÈÄöÁü•AIÁî®Êà∑ÊãíÁªù‰∫Ü
                const systemNote = {
                  role: "system",
                  content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊãíÁªù‰∫ÜÈÄöËØùÈÇÄËØ∑Ôºå‰ΩÜ‰Ω†‰ª¨ÂèØ‰ª•Ëá™Â∑±ÂºÄÂßã„ÄÇËØ∑‰Ω†‰ª¨ÂêÑËá™ÂÜ≥Á≠ñÊòØÂê¶Âä†ÂÖ•„ÄÇ]`,
                  timestamp: Date.now(),
                  isHidden: true,
                };
                chat.history.push(systemNote);
                await db.chats.put(chat);

                // 2. „ÄêÂÖ≥ÈîÆ„ÄëËß¶ÂèëAIÂìçÂ∫îÔºåËÆ©ÂÆÉ‰ª¨Ëá™Â∑±ÂÜ≥ÂÆöË¶Å‰∏çË¶ÅÂºÄÂßãÁæ§ËÅä
                // ËøôÂ∞Ü‰ºöÂú®ÂêéÂè∞Â§ÑÁêÜÔºåÂ¶ÇÊûúAI‰ª¨ÂÜ≥ÂÆöÂºÄÂßãÔºåÊúÄÁªà‰ºöË∞ÉÁî® startVideoCall()
                await triggerAiResponse();
              } else {
                // ÂçïËÅäÊãíÁªùÈÄªËæë‰øùÊåÅ‰∏çÂèò
                const declineMessage = {
                  role: "user",
                  content: "ÊàëÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ",
                  timestamp: Date.now(),
                };
                chat.history.push(declineMessage);
                await db.chats.put(chat);

                // ÂõûÂà∞ËÅäÂ§©ÁïåÈù¢Âπ∂ÊòæÁ§∫ÊãíÁªùÊ∂àÊÅØ
                showScreen("chat-interface-screen");
                appendMessage(declineMessage, chat);

                // ËÆ©AIÂØπ‰Ω†ÁöÑÊãíÁªùÂÅöÂá∫ÂõûÂ∫î
                triggerAiResponse();
              }

              // Ê∏ÖÁêÜÁä∂ÊÄÅÔºå‰ª•Èò≤‰∏á‰∏Ä
              videoCallState.isAwaitingResponse = false;
            });

          // ÁªëÂÆöÊù•ÁîµËØ∑Ê±ÇÁöÑ‚ÄúÊé•Âê¨‚ÄùÊåâÈíÆ
          document
            .getElementById("accept-call-btn")
            .addEventListener("click", async () => {
              hideIncomingCallModal();

              videoCallState.initiator = "ai";
              videoCallState.isUserParticipating = true;
              videoCallState.activeChatId = state.activeChatId;

              // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊàë‰ª¨Âú®ËøôÈáå‰∏çÂÜçÊâãÂä®Ê∑ªÂä†Áî®Êà∑Âà∞ participants ÂàóË°®
              if (videoCallState.isGroupCall) {
                // ÂØπ‰∫éÁæ§ËÅäÔºåÊàë‰ª¨Âè™Êää„ÄêÂèëËµ∑ÈÄöËØùÁöÑAI„ÄëÂä†ÂÖ•ÂèÇ‰∏éËÄÖÂàóË°®
                const chat = state.chats[videoCallState.activeChatId];
                const requester = chat.members.find(
                  (m) => m.name === videoCallState.callRequester,
                );
                if (requester) {
                  // Ê∏ÖÁ©∫ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÊï∞ÊçÆÔºåÁÑ∂ÂêéÂè™Ê∑ªÂä†ÂèëËµ∑ËÄÖ
                  videoCallState.participants = [requester];
                } else {
                  videoCallState.participants = []; // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂèëËµ∑ËÄÖÔºåÂ∞±Ê∏ÖÁ©∫
                }
              }

              // Êó†ËÆ∫ÂçïËÅäËøòÊòØÁæ§ËÅäÔºåÁõ¥Êé•ÂêØÂä®ÈÄöËØùÁïåÈù¢ÔºÅ
              startVideoCall();
            });

          // ÁªëÂÆöÁî®Êà∑Âú®ÈÄöËØù‰∏≠ÂèëË®ÄÁöÑÊåâÈíÆ
          document
            .getElementById("user-speak-btn")
            .addEventListener("click", async () => {
              if (!videoCallState.isActive) return;

              // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉÊñ∞Â¢ûÔºöÂú®ÂºπÂá∫ËæìÂÖ•Ê°ÜÂâçÔºåÂÖàÊâæÂà∞Âπ∂È´ò‰∫ÆÁî®Êà∑Â§¥ÂÉè ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
              const userAvatar = document.querySelector(
                '.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar',
              );
              if (userAvatar) {
                userAvatar.classList.add("speaking");
              }

              const userInput = await showCustomPrompt(
                "‰Ω†ËØ¥",
                "ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù...",
              );

              // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉÊñ∞Â¢ûÔºöÊó†ËÆ∫Áî®Êà∑ÊòØÂê¶ËæìÂÖ•ÔºåÂè™Ë¶ÅÂÖ≥Èó≠ËæìÂÖ•Ê°ÜÂ∞±ÁßªÈô§È´ò‰∫Æ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
              if (userAvatar) {
                userAvatar.classList.remove("speaking");
              }

              if (userInput && userInput.trim()) {
                triggerAiInCallAction(userInput.trim());
              }
            });

          // 1. Â∞Ü‚ÄúÂõûÂøÜ‚ÄùÈ°µÁ≠æÂíåÂÆÉÁöÑËßÜÂõæËøûÊé•Ëµ∑Êù•
          document
            .querySelector('.nav-item[data-view="memories-view"]')
            .addEventListener("click", () => {
              // Âú®ÂàáÊç¢ÂâçÔºåÁ°Æ‰øù"Êî∂Ëóè"È°µÈù¢ÁöÑÁºñËæëÊ®°ÂºèÂ∑≤ÂÖ≥Èó≠
              if (isFavoritesSelectionMode) {
                document.getElementById("favorites-edit-btn").click();
              }
              switchToChatListView("memories-view");
              renderMemoriesScreen(); // ÁÇπÂáªÊó∂Ê∏≤Êüì
            });

          // 2. ÁªëÂÆöÂõûÂøÜÂΩïÁïåÈù¢ÁöÑËøîÂõûÊåâÈíÆ
          document
            .getElementById("memories-back-btn")
            .addEventListener("click", () =>
              switchToChatListView("messages-view"),
            );

          // „ÄêÂÖ®Êñ∞„ÄëÁ∫¶ÂÆö/ÂÄíËÆ°Êó∂ÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö
          document
            .getElementById("add-countdown-btn")
            .addEventListener("click", () => {
              document
                .getElementById("create-countdown-modal")
                .classList.add("visible");
            });
          document
            .getElementById("cancel-create-countdown-btn")
            .addEventListener("click", () => {
              document
                .getElementById("create-countdown-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("confirm-create-countdown-btn")
            .addEventListener("click", async () => {
              const title = document
                .getElementById("countdown-title-input")
                .value.trim();
              const dateValue = document.getElementById(
                "countdown-date-input",
              ).value;

              if (!title || !dateValue) {
                alert("ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÁ∫¶ÂÆöÊ†áÈ¢òÂíåÊó•ÊúüÔºÅ");
                return;
              }

              const targetDate = new Date(dateValue);
              if (isNaN(targetDate) || targetDate <= new Date()) {
                alert("ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑ„ÄÅÊú™Êù•ÁöÑÊó•ÊúüÔºÅ");
                return;
              }

              const newCountdown = {
                chatId: null, // Áî®Êà∑ÂàõÂª∫ÁöÑÔºå‰∏çÂ±û‰∫é‰ªª‰ΩïÁâπÂÆöAI
                authorName: "Êàë",
                description: title,
                timestamp: Date.now(),
                type: "countdown",
                targetDate: targetDate.getTime(),
              };

              await db.memories.add(newCountdown);
              document
                .getElementById("create-countdown-modal")
                .classList.remove("visible");
              renderMemoriesScreen();
            });

          // „ÄêÂÖ®Êñ∞„ÄëÊãâÈªëÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö
          document
            .getElementById("block-chat-btn")
            .addEventListener("click", async () => {
              if (
                !state.activeChatId ||
                state.chats[state.activeChatId].isGroup
              )
                return;

              const chat = state.chats[state.activeChatId];
              const confirmed = await showCustomConfirm(
                "Á°ÆËÆ§ÊãâÈªë",
                `Á°ÆÂÆöË¶ÅÊãâÈªë‚Äú${chat.name}‚ÄùÂêóÔºüÊãâÈªëÂêéÊÇ®Â∞ÜÊó†Ê≥ïÂêëÂÖ∂ÂèëÈÄÅÊ∂àÊÅØÔºåÁõ¥Âà∞ÊÇ®Â∞ÜTaÁßªÂá∫ÈªëÂêçÂçïÔºåÊàñÁ≠âÂæÖTaÈáçÊñ∞Áî≥ËØ∑Â•ΩÂèã„ÄÇ`,
                { confirmButtonClass: "btn-danger" },
              );

              if (confirmed) {
                chat.relationship.status = "blocked_by_user";
                chat.relationship.blockedTimestamp = Date.now();

                const hiddenMessage = {
                  role: "system",
                  content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöË¢´Áî®Êà∑ÊãâÈªë‰∫Ü„ÄÇÂú®ÂØπÊñπËß£Èô§ÊãâÈªë‰πãÂâçÔºå‰Ω†Êó†Ê≥ïÂÜç‰∏ªÂä®ÂèëËµ∑ÂØπËØùÔºå‰πüÊó†Ê≥ïÂõûÂ∫î„ÄÇ]`,
                  timestamp: Date.now() + 1,
                  isHidden: true,
                };
                chat.history.push(hiddenMessage);

                await db.chats.put(chat);

                // ÂÖ≥Èó≠ËÆæÁΩÆÂºπÁ™óÔºåÂπ∂Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
                document
                  .getElementById("chat-settings-modal")
                  .classList.remove("visible");
                renderChatInterface(state.activeChatId);
                // Âà∑Êñ∞ËÅäÂ§©ÂàóË°®ÔºåÂèØËÉΩ‰ºöÊúâUIÂèòÂåñ
                renderChatList();
              }
            });

          document
            .getElementById("chat-lock-overlay")
            .addEventListener("click", async (e) => {
              const chat = state.chats[state.activeChatId];
              if (!chat) return;

              if (e.target.id === "force-apply-check-btn") {
                alert(
                  "Ê≠£Âú®ÊâãÂä®Ëß¶ÂèëÂ•ΩÂèãÁî≥ËØ∑ÊµÅÁ®ãÔºåËØ∑Á®çÂêé...\nÂ¶ÇÊûúAPIË∞ÉÁî®ÊàêÂäüÔºåÂ∞ÜÂºπÂá∫ÊèêÁ§∫„ÄÇÂ¶ÇÊûúÂ§±Ë¥•Ôºå‰πü‰ºöÊúâÈîôËØØÊèêÁ§∫„ÄÇÂ¶ÇÊûúÈïøÊó∂Èó¥Êó†ÂèçÂ∫îÔºåËØ¥ÊòéAIÂèØËÉΩÂÜ≥ÂÆöÊöÇÊó∂‰∏çÁî≥ËØ∑„ÄÇ",
                );
                await triggerAiFriendApplication(chat.id);
                renderChatInterface(chat.id);
                return;
              }

              if (e.target.id === "unblock-btn") {
                chat.relationship.status = "friend";
                chat.relationship.blockedTimestamp = null;

                const hiddenMessage = {
                  role: "system",
                  content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÂàöËß£Èô§‰∫ÜÂØπ‰Ω†ÁöÑÊãâÈªë„ÄÇÁé∞Âú®‰Ω†‰ª¨ÂèØ‰ª•ÈáçÊñ∞ÂºÄÂßãÂØπËØù‰∫Ü„ÄÇ]`,
                  timestamp: Date.now(),
                  isHidden: true,
                };
                chat.history.push(hiddenMessage);

                await db.chats.put(chat);
                renderChatInterface(chat.id);
                renderChatList();
                triggerAiResponse(); // „ÄêÂèØÈÄâ‰ΩÜÊé®Ëçê„ÄëËß£Èô§ÂêéËÆ©AI‰∏ªÂä®ËØ¥ÁÇπ‰ªÄ‰πà
              } else if (e.target.id === "accept-friend-btn") {
                chat.relationship.status = "friend";
                chat.relationship.applicationReason = "";

                const hiddenMessage = {
                  role: "system",
                  content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÂàöÈÄöËøá‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑„ÄÇ‰Ω†‰ª¨Áé∞Âú®ÂèàÂèØ‰ª•Ê≠£Â∏∏ËÅäÂ§©‰∫Ü„ÄÇ]`,
                  timestamp: Date.now(),
                  isHidden: true,
                };
                chat.history.push(hiddenMessage);

                await db.chats.put(chat);
                renderChatInterface(chat.id);
                renderChatList();
                const msg = {
                  role: "user",
                  content: "ÊàëÈÄöËøá‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãËØ∑Ê±Ç",
                  timestamp: Date.now(),
                };
                chat.history.push(msg);
                await db.chats.put(chat);
                appendMessage(msg, chat);
                triggerAiResponse();
              } else if (e.target.id === "reject-friend-btn") {
                chat.relationship.status = "blocked_by_user";
                chat.relationship.blockedTimestamp = Date.now();
                chat.relationship.applicationReason = "";
                await db.chats.put(chat);
                renderChatInterface(chat.id);
              }
              // „ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÁî≥ËØ∑Â•ΩÂèãÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
              else if (e.target.id === "apply-friend-btn") {
                const reason = await showCustomPrompt(
                  "ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑",
                  `ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ÂØπ‚Äú${chat.name}‚ÄùËØ¥ÁöÑÁî≥ËØ∑ÁêÜÁî±Ôºö`,
                  "Êàë‰ª¨ÂíåÂ•ΩÂêßÔºÅ",
                );
                // Âè™ÊúâÂΩìÁî®Êà∑ËæìÂÖ•‰∫ÜÂÜÖÂÆπÂπ∂ÁÇπÂáª‚ÄúÁ°ÆÂÆö‚ÄùÂêéÊâçÁªßÁª≠
                if (reason !== null) {
                  // Êõ¥Êñ∞ÂÖ≥Á≥ªÁä∂ÊÄÅ‰∏∫‚ÄúÁ≠âÂæÖAIÊâπÂáÜ‚Äù
                  chat.relationship.status = "pending_ai_approval";
                  chat.relationship.applicationReason = reason;
                  await db.chats.put(chat);

                  // Âà∑Êñ∞UIÔºåÊòæÁ§∫‚ÄúÁ≠âÂæÖÈÄöËøá‚ÄùÁöÑÁïåÈù¢
                  renderChatInterface(chat.id);
                  renderChatList();

                  // „ÄêÂÖ≥ÈîÆ„ÄëËß¶ÂèëAIÂìçÂ∫îÔºåËÆ©ÂÆÉÂéªÂ§ÑÁêÜËøô‰∏™Â•ΩÂèãÁî≥ËØ∑
                  triggerAiResponse();
                }
              }
            });

          // 1. Â∞ÜÂéüÊúâÁöÑËΩ¨Ë¥¶ÊåâÈíÆ(Ôø•)ÁöÑÁÇπÂáª‰∫ã‰ª∂ÔºåÈáçÂÆöÂêëÂà∞Êñ∞ÁöÑÊÄªÂÖ•Âè£ÂáΩÊï∞
          document
            .getElementById("transfer-btn")
            .addEventListener("click", handlePaymentButtonClick);

          // 2. Á∫¢ÂåÖÊ®°ÊÄÅÊ°ÜÂÜÖÈÉ®ÁöÑÊéßÂà∂ÊåâÈíÆ
          document
            .getElementById("cancel-red-packet-btn")
            .addEventListener("click", () => {
              document
                .getElementById("red-packet-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("send-group-packet-btn")
            .addEventListener("click", sendGroupRedPacket);
          document
            .getElementById("send-direct-packet-btn")
            .addEventListener("click", sendDirectRedPacket);

          // 3. Á∫¢ÂåÖÊ®°ÊÄÅÊ°ÜÁöÑÈ°µÁ≠æÂàáÊç¢ÈÄªËæë
          const rpTabGroup = document.getElementById("rp-tab-group");
          const rpTabDirect = document.getElementById("rp-tab-direct");
          const rpContentGroup = document.getElementById("rp-content-group");
          const rpContentDirect = document.getElementById("rp-content-direct");

          rpTabGroup.addEventListener("click", () => {
            rpTabGroup.classList.add("active");
            rpTabDirect.classList.remove("active");
            rpContentGroup.style.display = "block";
            rpContentDirect.style.display = "none";
          });
          rpTabDirect.addEventListener("click", () => {
            rpTabDirect.classList.add("active");
            rpTabGroup.classList.remove("active");
            rpContentDirect.style.display = "block";
            rpContentGroup.style.display = "none";
          });

          // 4. ÂÆûÊó∂Êõ¥Êñ∞Á∫¢ÂåÖÈáëÈ¢ùÊòæÁ§∫
          document
            .getElementById("rp-group-amount")
            .addEventListener("input", (e) => {
              const amount = parseFloat(e.target.value) || 0;
              document.getElementById("rp-group-total").textContent =
                `¬• ${amount.toFixed(2)}`;
            });
          document
            .getElementById("rp-direct-amount")
            .addEventListener("input", (e) => {
              const amount = parseFloat(e.target.value) || 0;
              document.getElementById("rp-direct-total").textContent =
                `¬• ${amount.toFixed(2)}`;
            });

          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              // 1. ÊâæÂà∞Ë¢´ÁÇπÂáªÁöÑÁ∫¢ÂåÖÂç°Áâá
              const packetCard = e.target.closest(".red-packet-card");
              if (!packetCard) return; // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØÁ∫¢ÂåÖÔºåÂ∞±‰ªÄ‰πà‰πü‰∏çÂÅö

              // 2. ‰ªéÁ∫¢ÂåÖÂç°ÁâáÁöÑÁà∂Á∫ß.message-bubbleËé∑ÂèñÊó∂Èó¥Êà≥
              const messageBubble = packetCard.closest(".message-bubble");
              if (!messageBubble || !messageBubble.dataset.timestamp) return;

              // 3. Ë∞ÉÁî®Êàë‰ª¨Áé∞ÊúâÁöÑÂ§ÑÁêÜÂáΩÊï∞
              const timestamp = parseInt(messageBubble.dataset.timestamp);
              handlePacketClick(timestamp);
            });

          // Âú®ËæìÂÖ•Ê°ÜÂ∑•ÂÖ∑Ê†èÊ∑ªÂä†ÊåâÈíÆ
          document
            .getElementById("send-poll-btn")
            .addEventListener("click", openCreatePollModal);

          // ÊäïÁ•®ÂàõÂª∫Ê®°ÊÄÅÊ°ÜÁöÑÊåâÈíÆ
          document
            .getElementById("add-poll-option-btn")
            .addEventListener("click", addPollOptionInput);
          document
            .getElementById("cancel-create-poll-btn")
            .addEventListener("click", () => {
              document
                .getElementById("create-poll-modal")
                .classList.remove("visible");
            });
          document
            .getElementById("confirm-create-poll-btn")
            .addEventListener("click", sendPoll);

          // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÊäïÁ•®Âç°ÁâáÂÜÖÁöÑÊâÄÊúâÁÇπÂáª‰∫ã‰ª∂
          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              const pollCard = e.target.closest(".poll-card");
              if (!pollCard) return;

              const timestamp = parseInt(pollCard.dataset.pollTimestamp);
              if (isNaN(timestamp)) return;

              // ÁÇπÂáª‰∫ÜÈÄâÈ°π
              const optionItem = e.target.closest(".poll-option-item");
              if (optionItem && !pollCard.classList.contains("closed")) {
                handleUserVote(timestamp, optionItem.dataset.option);
                return;
              }

              // ÁÇπÂáª‰∫ÜÂä®‰ΩúÊåâÈíÆÔºàÁªìÊùüÊäïÁ•®/Êü•ÁúãÁªìÊûúÔºâ
              const actionBtn = e.target.closest(".poll-action-btn");
              if (actionBtn) {
                if (pollCard.classList.contains("closed")) {
                  showPollResults(timestamp);
                } else {
                  endPoll(timestamp);
                }
                return;
              }

              // Â¶ÇÊûúÊòØÂ∑≤ÁªìÊùüÁöÑÊäïÁ•®ÔºåÁÇπÂáªÂç°Áâá‰ªª‰ΩïÂú∞ÊñπÈÉΩÂèØ‰ª•Êü•ÁúãÁªìÊûú
              if (pollCard.classList.contains("closed")) {
                showPollResults(timestamp);
              }
            });

          document
            .getElementById("manage-ai-avatar-library-btn")
            .addEventListener("click", openAiAvatarLibraryModal);
          document
            .getElementById("add-ai-avatar-btn")
            .addEventListener("click", addAvatarToLibrary);
          document
            .getElementById("close-ai-avatar-library-btn")
            .addEventListener("click", closeAiAvatarLibraryModal);

          document
            .getElementById("icon-settings-grid")
            .addEventListener("click", async (e) => {
              if (e.target.classList.contains("change-icon-btn")) {
                const item = e.target.closest(".icon-setting-item");
                const iconId = item.dataset.iconId;
                if (!iconId) return;

                const currentUrl = state.globalSettings.appIcons[iconId];
                const newUrl = await showCustomPrompt(
                  `Êõ¥Êç¢‚Äú${item.querySelector(".icon-preview").alt}‚ÄùÂõæÊ†á`,
                  "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂõæÁâáURL",
                  currentUrl,
                  "url",
                );

                if (newUrl && newUrl.trim().startsWith("http")) {
                  // ‰ªÖÂú®ÂÜÖÂ≠ò‰∏≠Êõ¥Êñ∞ÔºåÁ≠âÂæÖÁî®Êà∑ÁÇπÂáª‚Äú‰øùÂ≠ò‚Äù
                  state.globalSettings.appIcons[iconId] = newUrl.trim();
                  // ÂÆûÊó∂Êõ¥Êñ∞ËÆæÁΩÆÈ°µÈù¢ÁöÑÈ¢ÑËßàÂõæ
                  item.querySelector(".icon-preview").src = newUrl.trim();
                } else if (newUrl !== null) {
                  alert("ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑURLÔºÅ");
                }
              }
            });

          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              // ‰ΩøÁî® .closest() Âêë‰∏äÊü•ÊâæË¢´ÁÇπÂáªÁöÑÂç°Áâá
              const linkCard = e.target.closest(".link-share-card");
              if (linkCard) {
                const timestamp = parseInt(linkCard.dataset.timestamp);
                if (!isNaN(timestamp)) {
                  openBrowser(timestamp); // Ë∞ÉÁî®Êàë‰ª¨ÁöÑÂáΩÊï∞
                }
              }
            });

          // ÊµèËßàÂô®ËøîÂõûÊåâÈíÆÁöÑ‰∫ã‰ª∂ÁõëÂê¨ÔºåÁ°Æ‰øùÂÆÉÂè™ÁªëÂÆö‰∏ÄÊ¨°
          document
            .getElementById("browser-back-btn")
            .addEventListener("click", () => {
              showScreen("chat-interface-screen");
            });

          // 1. ÁªëÂÆöËæìÂÖ•Ê°Ü‰∏äÊñπ‚ÄúÂàÜ‰∫´ÈìæÊé•‚ÄùÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
          document
            .getElementById("share-link-btn")
            .addEventListener("click", openShareLinkModal);

          // 2. ÁªëÂÆöÊ®°ÊÄÅÊ°Ü‰∏≠‚ÄúÂèñÊ∂à‚ÄùÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
          document
            .getElementById("cancel-share-link-btn")
            .addEventListener("click", () => {
              document
                .getElementById("share-link-modal")
                .classList.remove("visible");
            });

          // 3. ÁªëÂÆöÊ®°ÊÄÅÊ°Ü‰∏≠‚ÄúÂàÜ‰∫´‚ÄùÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
          document
            .getElementById("confirm-share-link-btn")
            .addEventListener("click", sendUserLinkShare);

          document
            .getElementById("theme-toggle-switch")
            .addEventListener("change", toggleTheme);

          // ÁªëÂÆöÊ∂àÊÅØÊìç‰ΩúËèúÂçï‰∏≠ÁöÑ‚ÄúÂºïÁî®‚ÄùÊåâÈíÆ
          document
            .getElementById("quote-message-btn")
            .addEventListener("click", startReplyToMessage);

          // ÁªëÂÆöÂõûÂ§çÈ¢ÑËßàÊ†è‰∏≠ÁöÑ‚ÄúÂèñÊ∂à‚ÄùÊåâÈíÆ
          document
            .getElementById("cancel-reply-btn")
            .addEventListener("click", cancelReplyMode);

          // Âú®‰Ω†ÁöÑ init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫Âüü...

          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              // 1. Âêë‰∏äÊü•ÊâæË¢´ÁÇπÂáªÁöÑÂÖÉÁ¥†ÊòØÂê¶Âú®‰∏Ä‰∏™Ê∂àÊÅØÊ∞îÊ≥°ÂÜÖ
              const bubble = e.target.closest(".message-bubble");
              if (!bubble) return; // Â¶ÇÊûú‰∏çÂú®ÔºåÂ∞±ÈÄÄÂá∫

              // 2. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÊ∑ªÂä†‰∏•Ê†ºÁöÑÁ≠õÈÄâÊù°‰ª∂
              // ÂøÖÈ°ªÊòØ AI ÁöÑÊ∂àÊÅØ (.ai)
              // ÂøÖÈ°ªÊòØËΩ¨Ë¥¶Á±ªÂûã (.is-transfer)
              // ÂøÖÈ°ªÊòØÊàë‰ª¨Ê†áËÆ∞‰∏∫‚ÄúÂæÖÂ§ÑÁêÜ‚ÄùÁöÑ (data-status="pending")
              if (
                bubble.classList.contains("ai") &&
                bubble.classList.contains("is-transfer") &&
                bubble.dataset.status === "pending"
              ) {
                // 3. Âè™ÊúâÊª°Ë∂≥ÊâÄÊúâÊù°‰ª∂ÔºåÊâçÊâßË°åÂêéÁª≠ÈÄªËæë
                const timestamp = parseInt(bubble.dataset.timestamp);
                if (!isNaN(timestamp)) {
                  showTransferActionModal(timestamp);
                }
              }
            });

          // Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âå∫ÂüüÊ∑ªÂä†
          document
            .getElementById("transfer-action-accept")
            .addEventListener("click", () =>
              handleUserTransferResponse("accepted"),
            );
          document
            .getElementById("transfer-action-decline")
            .addEventListener("click", () =>
              handleUserTransferResponse("declined"),
            );
          document
            .getElementById("transfer-action-cancel")
            .addEventListener("click", hideTransferActionModal);

          document
            .getElementById("chat-list-title")
            .addEventListener("click", renderCallHistoryScreen);

          // 2. ÁªëÂÆöÈÄöËØùËÆ∞ÂΩïÈ°µÈù¢ÁöÑ‚ÄúËøîÂõû‚ÄùÊåâÈíÆ
          document
            .getElementById("call-history-back-btn")
            .addEventListener("click", () => {
              // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëËøîÂõûÂà∞ËÅäÂ§©ÂàóË°®È°µÈù¢ÔºåËÄå‰∏çÊòØËÅäÂ§©ÁïåÈù¢
              showScreen("chat-list-screen");
            });

          // 3. ÁõëÂê¨Âç°ÁâáÁÇπÂáªÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò
          document
            .getElementById("call-history-list")
            .addEventListener("click", (e) => {
              const card = e.target.closest(".call-record-card");
              if (card && card.dataset.recordId) {
                showCallTranscript(parseInt(card.dataset.recordId));
              }
            });

          // 4. ÂÖ≥Èó≠ËØ¶ÊÉÖÂºπÁ™óÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò
          document
            .getElementById("close-transcript-modal-btn")
            .addEventListener("click", () => {
              document
                .getElementById("call-transcript-modal")
                .classList.remove("visible");
            });

          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              // 1. Ê£ÄÊü•ÁÇπÂáªÁöÑÊòØÂê¶ÊòØËØ≠Èü≥Êù°
              const voiceBody = e.target.closest(".voice-message-body");
              if (!voiceBody) return;

              // 2. ÊâæÂà∞Áõ∏ÂÖ≥ÁöÑDOMÂÖÉÁ¥†
              const bubble = voiceBody.closest(".message-bubble");
              if (!bubble) return;

              const waveIcon = voiceBody.querySelector(".wave-icon");
              const transcriptEl = bubble.querySelector(".voice-transcript");

              // Â¶ÇÊûúÊ≠£Âú®Âä†ËΩΩ‰∏≠ÔºåÂàô‰∏çÂìçÂ∫îÁÇπÂáª
              if (bubble.dataset.state === "loading") {
                return;
              }

              // 3. Â¶ÇÊûúÊñáÂ≠óÂ∑≤ÁªèÂ±ïÂºÄÔºåÂàôÊî∂Ëµ∑
              if (bubble.dataset.state === "expanded") {
                transcriptEl.style.display = "none";
                bubble.dataset.state = "collapsed";
              } else {
                // Áõ¥Êé•Ëé∑ÂèñÊñáÂ≠óÂπ∂ÊòæÁ§∫
                const voiceText = bubble.dataset.voiceText || "(Êó†Ê≥ïËØÜÂà´)";
                transcriptEl.textContent = voiceText; // Â°´ÂÖÖÊñáÂ≠ó

                transcriptEl.style.display = "block"; // ÊòæÁ§∫ÊñáÂ≠óÂÆπÂô®
                bubble.dataset.state = "expanded"; // Ê†áËÆ∞‰∏∫Â∑≤Â±ïÂºÄÁä∂ÊÄÅ
              }
            });

          document
            .getElementById("chat-header-status")
            .addEventListener("click", handleEditStatusClick);

          // Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊ∑ªÂä†
          document
            .getElementById("selection-share-btn")
            .addEventListener("click", () => {
              if (selectedMessages.size > 0) {
                openShareTargetPicker(); // ÊâìÂºÄÊàë‰ª¨Âç≥Â∞ÜÂàõÂª∫ÁöÑÁõÆÊ†áÈÄâÊã©Âô®
              }
            });

          // Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊ∑ªÂä†
          document
            .getElementById("confirm-share-target-btn")
            .addEventListener("click", async () => {
              const sourceChat = state.chats[state.activeChatId];
              const selectedTargetIds = Array.from(
                document.querySelectorAll(".share-target-checkbox:checked"),
              ).map((cb) => cb.dataset.chatId);

              if (selectedTargetIds.length === 0) {
                alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂàÜ‰∫´ÁöÑËÅäÂ§©„ÄÇ");
                return;
              }

              // 1. ÊâìÂåÖËÅäÂ§©ËÆ∞ÂΩï
              const sharedHistory = [];
              const sortedTimestamps = [...selectedMessages].sort(
                (a, b) => a - b,
              );
              for (const timestamp of sortedTimestamps) {
                const msg = sourceChat.history.find(
                  (m) => m.timestamp === timestamp,
                );
                if (msg) {
                  sharedHistory.push(msg);
                }
              }

              // 2. ÂàõÂª∫ÂàÜ‰∫´Âç°ÁâáÊ∂àÊÅØÂØπË±°
              const shareCardMessage = {
                role: "user",
                senderName: sourceChat.isGroup
                  ? sourceChat.settings.myNickname || "Êàë"
                  : "Êàë",
                type: "share_card",
                timestamp: Date.now(),
                payload: {
                  sourceChatName: sourceChat.name,
                  title: `Êù•Ëá™‚Äú${sourceChat.name}‚ÄùÁöÑËÅäÂ§©ËÆ∞ÂΩï`,
                  sharedHistory: sharedHistory,
                },
              };

              // 3. Âæ™ÁéØÂèëÈÄÅÂà∞ÊâÄÊúâÁõÆÊ†áËÅäÂ§©
              for (const targetId of selectedTargetIds) {
                const targetChat = state.chats[targetId];
                if (targetChat) {
                  targetChat.history.push(shareCardMessage);
                  await db.chats.put(targetChat);
                }
              }

              // 4. Êî∂Â∞æÂ∑•‰Ωú
              document
                .getElementById("share-target-modal")
                .classList.remove("visible");
              exitSelectionMode(); // ÈÄÄÂá∫Â§öÈÄâÊ®°Âºè
              await showCustomAlert(
                "ÂàÜ‰∫´ÊàêÂäü",
                `ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÊàêÂäüÂàÜ‰∫´Âà∞ ${selectedTargetIds.length} ‰∏™‰ºöËØù‰∏≠„ÄÇ`,
              );
              renderChatList(); // Âà∑Êñ∞ÂàóË°®ÔºåÂèØËÉΩ‰ºöÊúâÊñ∞Ê∂àÊÅØÊèêÁ§∫
            });

          // ÁªëÂÆöÂèñÊ∂àÊåâÈíÆ
          document
            .getElementById("cancel-share-target-btn")
            .addEventListener("click", () => {
              document
                .getElementById("share-target-modal")
                .classList.remove("visible");
            });

          // Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊ∑ªÂä†
          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              // ...‰Ω†Â∑≤ÊúâÁöÑÂÖ∂‰ªñÁÇπÂáª‰∫ã‰ª∂ÈÄªËæë...

              // Êñ∞Â¢ûÈÄªËæëÔºöÂ§ÑÁêÜÂàÜ‰∫´Âç°ÁâáÁöÑÁÇπÂáª
              const shareCard = e.target.closest(
                ".link-share-card[data-timestamp]",
              );
              if (
                shareCard &&
                shareCard.closest(".message-bubble.is-link-share")
              ) {
                const timestamp = parseInt(shareCard.dataset.timestamp);
                openSharedHistoryViewer(timestamp);
              }
            });

          // ÁªëÂÆöÊü•ÁúãÂô®ÁöÑÂÖ≥Èó≠ÊåâÈíÆ
          document
            .getElementById("close-shared-history-viewer-btn")
            .addEventListener("click", () => {
              document
                .getElementById("shared-history-viewer-modal")
                .classList.remove("visible");
            });

          // ÂàõÂª∫Êñ∞ÂáΩÊï∞Êù•Â§ÑÁêÜÊ∏≤ÊüìÈÄªËæë
          function openSharedHistoryViewer(timestamp) {
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find((m) => m.timestamp === timestamp);
            if (!message || message.type !== "share_card") return;

            const viewerModal = document.getElementById(
              "shared-history-viewer-modal",
            );
            const viewerTitle = document.getElementById(
              "shared-history-viewer-title",
            );
            const viewerContent = document.getElementById(
              "shared-history-viewer-content",
            );

            viewerTitle.textContent = message.payload.title;
            viewerContent.innerHTML = ""; // Ê∏ÖÁ©∫ÊóßÂÜÖÂÆπ

            // „ÄêÊ†∏ÂøÉ„ÄëÂ§çÁî® createMessageElement Êù•Ê∏≤ÊüìÊØè‰∏ÄÊù°Ë¢´ÂàÜ‰∫´ÁöÑÊ∂àÊÅØ
            message.payload.sharedHistory.forEach((sharedMsg) => {
              // Ê≥®ÊÑèÔºöËøôÈáåÊàë‰ª¨‰º†ÂÖ•ÁöÑÊòØ sourceChat ÂØπË±°Ôºå‰ª•Á°Æ‰øùÂ§¥ÂÉè„ÄÅÊòµÁß∞Á≠âÊ≠£Á°Æ
              const sourceChat =
                Object.values(state.chats).find(
                  (c) => c.name === message.payload.sourceChatName,
                ) || chat;
              const bubbleEl = createMessageElement(sharedMsg, sourceChat);
              if (bubbleEl) {
                viewerContent.appendChild(bubbleEl);
              }
            });

            viewerModal.classList.add("visible");
          }

          audioPlayer.addEventListener("timeupdate", updateMusicProgressBar);

          audioPlayer.addEventListener("pause", () => {
            if (musicState.isActive) {
              musicState.isPlaying = false;
              updatePlayerUI();
            }
          });
          audioPlayer.addEventListener("play", () => {
            if (musicState.isActive) {
              musicState.isPlaying = true;
              updatePlayerUI();
            }
          });

          document
            .getElementById("playlist-body")
            .addEventListener("click", async (e) => {
              const target = e.target;
              if (target.classList.contains("delete-track-btn")) {
                const index = parseInt(target.dataset.index);
                const track = musicState.playlist[index];
                const confirmed = await showCustomConfirm(
                  "Âà†Èô§Ê≠åÊõ≤",
                  `Á°ÆÂÆöË¶Å‰ªéÊí≠ÊîæÂàóË°®‰∏≠Âà†Èô§„Ää${track.name}„ÄãÂêóÔºü`,
                );
                if (confirmed) {
                  deleteTrack(index);
                }
                return;
              }
              if (target.classList.contains("lyrics-btn")) {
                const index = parseInt(target.dataset.index);
                if (isNaN(index)) return;
                const lrcContent = await new Promise((resolve) => {
                  const lrcInput = document.getElementById("lrc-upload-input");
                  const handler = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                      const reader = new FileReader();
                      reader.onload = (re) => resolve(re.target.result);
                      reader.readAsText(file);
                    } else {
                      resolve(null);
                    }
                    lrcInput.removeEventListener("change", handler);
                    lrcInput.value = "";
                  };
                  lrcInput.addEventListener("change", handler);
                  lrcInput.click();
                });
                if (lrcContent !== null) {
                  musicState.playlist[index].lrcContent = lrcContent;
                  await saveGlobalPlaylist();
                  alert("Ê≠åËØçÂØºÂÖ•ÊàêÂäüÔºÅ");
                  if (musicState.currentIndex === index) {
                    musicState.parsedLyrics = parseLRC(lrcContent);
                    renderLyrics();
                  }
                }
              }
            });

          document
            .querySelector(".progress-bar")
            .addEventListener("click", (e) => {
              if (!audioPlayer.duration) return;
              const progressBar = e.currentTarget;
              const barWidth = progressBar.clientWidth;
              const clickX = e.offsetX;
              audioPlayer.currentTime =
                (clickX / barWidth) * audioPlayer.duration;
            });

          // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÊù•Â§ÑÁêÜÊâÄÊúâ‚ÄúÂ∑≤Êí§ÂõûÊ∂àÊÅØ‚ÄùÁöÑÁÇπÂáª‰∫ã‰ª∂
          document
            .getElementById("chat-messages")
            .addEventListener("click", (e) => {
              // Ê£ÄÊü•Ë¢´ÁÇπÂáªÁöÑÂÖÉÁ¥†ÊàñÂÖ∂Áà∂ÂÖÉÁ¥†ÊòØÂê¶ÊòØ‚ÄúÂ∑≤Êí§Âõû‚ÄùÊèêÁ§∫
              const placeholder = e.target.closest(
                ".recalled-message-placeholder",
              );
              if (!placeholder) return; // Â¶ÇÊûú‰∏çÊòØÔºåÂ∞±ÈÄÄÂá∫

              // Â¶ÇÊûúÊòØÔºåÂ∞±‰ªéËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑÊï∞ÊçÆÂπ∂ÊòæÁ§∫
              const chat = state.chats[state.activeChatId];
              const wrapper = placeholder.closest(".message-wrapper"); // ÊâæÂà∞ÂÆÉÁöÑÁà∂ÂÆπÂô®
              if (chat && wrapper) {
                // ‰ªéÁà∂ÂÆπÂô®‰∏äÊâæÂà∞Êó∂Èó¥Êà≥
                const timestamp = parseInt(wrapper.dataset.timestamp);
                const recalledMsg = chat.history.find(
                  (m) => m.timestamp === timestamp,
                );

                if (recalledMsg && recalledMsg.recalledData) {
                  let originalContentText = "";
                  const recalled = recalledMsg.recalledData;

                  if (recalled.originalType === "text") {
                    originalContentText = `ÂéüÊñá: "${recalled.originalContent}"`;
                  } else {
                    originalContentText = `Êí§Âõû‰∫Ü‰∏ÄÊù°[${recalled.originalType}]Á±ªÂûãÁöÑÊ∂àÊÅØ`;
                  }
                  showCustomAlert("Â∑≤Êí§ÂõûÁöÑÊ∂àÊÅØ", originalContentText);
                }
              }
            });

          document
            .getElementById("manage-world-book-categories-btn")
            .addEventListener("click", openCategoryManager);
          document
            .getElementById("close-category-manager-btn")
            .addEventListener("click", () => {
              document
                .getElementById("world-book-category-manager-modal")
                .classList.remove("visible");
              renderWorldBookScreen(); // ÂÖ≥Èó≠ÂêéÂà∑Êñ∞‰∏ªÂàóË°®
            });
          document
            .getElementById("add-new-category-btn")
            .addEventListener("click", addNewCategory);
          document
            .getElementById("existing-categories-list")
            .addEventListener("click", (e) => {
              if (e.target.classList.contains("delete-group-btn")) {
                const categoryId = parseInt(e.target.dataset.id);
                deleteCategory(categoryId);
              }
            });

          const manageApiPresetsBtn = document.getElementById(
            "manage-api-presets-btn",
          );
          const apiPresetsModal = document.getElementById("api-presets-modal");
          const apiPresetsList = document.getElementById("api-presets-list");
          const savePresetNameInput = document.getElementById(
            "save-preset-name-input",
          );
          const savePresetBtn = document.getElementById("save-preset-btn");
          const closeApiPresetsModalBtn = document.getElementById(
            "close-api-presets-modal-btn",
          );

          if (manageApiPresetsBtn) {
            manageApiPresetsBtn.addEventListener("click", () => {
              renderApiPresetsList();
              apiPresetsModal.classList.add("visible");
            });
          }

          if (closeApiPresetsModalBtn) {
            closeApiPresetsModalBtn.addEventListener("click", () => {
              apiPresetsModal.classList.remove("visible");
            });
          }

          if (savePresetBtn) {
            savePresetBtn.addEventListener("click", async () => {
              const name = savePresetNameInput.value.trim();
              if (!name) return alert("ËØ∑ËæìÂÖ•ÈÖçÁΩÆÂêçÁß∞");

              const newPreset = {
                name,
                proxyUrl: document.getElementById("proxy-url").value.trim(),
                apiKey: document.getElementById("api-key").value.trim(),
                model: document.getElementById("model-select").value,
                enableStreaming: document.getElementById(
                  "stream-request-switch",
                ).checked,
              };

              if (!state.globalSettings.apiPresets) {
                state.globalSettings.apiPresets = [];
              }

              // Check for duplicate name and overwrite
              const existingIndex = state.globalSettings.apiPresets.findIndex(
                (p) => p.name === name,
              );
              if (existingIndex > -1) {
                if (!confirm(`ÈÖçÁΩÆ "${name}" Â∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÜÁõñÔºü`)) return;
                state.globalSettings.apiPresets[existingIndex] = newPreset;
              } else {
                state.globalSettings.apiPresets.push(newPreset);
              }

              await db.globalSettings.put(state.globalSettings);
              renderApiPresetsList();
              savePresetNameInput.value = "";
              alert("ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò");
            });
          }

          function renderApiPresetsList() {
            apiPresetsList.innerHTML = "";
            const presets = state.globalSettings.apiPresets || [];
            if (presets.length === 0) {
              apiPresetsList.innerHTML =
                '<div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†‰øùÂ≠òÁöÑÈÖçÁΩÆ</div>';
              return;
            }

            presets.forEach((preset, index) => {
              const item = document.createElement("div");
              item.style.cssText =
                "display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;";

              const info = document.createElement("div");
              info.innerHTML = `<strong>${
                preset.name
              }</strong><br><span style="font-size:12px; color:#666;">${
                preset.model
              } | ${preset.proxyUrl ? "Proxy" : "Direct"}</span>`;

              const actions = document.createElement("div");
              actions.style.display = "flex";
              actions.style.gap = "5px";

              const loadBtn = document.createElement("button");
              loadBtn.textContent = "Âä†ËΩΩ";
              loadBtn.className = "form-button";
              loadBtn.style.cssText =
                "padding:5px 10px; font-size:12px; width:auto;";
              loadBtn.onclick = () => loadApiPreset(preset);

              const deleteBtn = document.createElement("button");
              deleteBtn.textContent = "Âà†Èô§";
              deleteBtn.className = "form-button";
              deleteBtn.style.cssText =
                "padding:5px 10px; font-size:12px; width:auto; background-color:#ff3b30;";
              deleteBtn.onclick = () => deleteApiPreset(index);

              actions.appendChild(loadBtn);
              actions.appendChild(deleteBtn);
              item.appendChild(info);
              item.appendChild(actions);
              apiPresetsList.appendChild(item);
            });
          }

          function loadApiPreset(preset) {
            document.getElementById("proxy-url").value = preset.proxyUrl || "";
            document.getElementById("api-key").value = preset.apiKey || "";
            document.getElementById("stream-request-switch").checked =
              preset.enableStreaming || false;

            const modelSelect = document.getElementById("model-select");
            if (preset.model) {
              let optionExists = false;
              for (let i = 0; i < modelSelect.options.length; i++) {
                if (modelSelect.options[i].value === preset.model) {
                  optionExists = true;
                  break;
                }
              }
              if (!optionExists) {
                const opt = document.createElement("option");
                opt.value = preset.model;
                opt.textContent = preset.model + " (Êù•Ëá™ÈÖçÁΩÆ)";
                modelSelect.appendChild(opt);
              }
              modelSelect.value = preset.model;
            }

            apiPresetsModal.classList.remove("visible");
            alert(`Â∑≤Âä†ËΩΩÈÖçÁΩÆ "${preset.name}"ÔºåËØ∑ÁÇπÂáª‚Äú‰øùÂ≠òËÆæÁΩÆ‚Äù‰ª•Â∫îÁî®„ÄÇ`);
          }

          async function deleteApiPreset(index) {
            if (!confirm("Á°ÆÂÆöÂà†Èô§Ê≠§ÈÖçÁΩÆÂêóÔºü")) return;
            state.globalSettings.apiPresets.splice(index, 1);
            await db.globalSettings.put(state.globalSettings);
            renderApiPresetsList();
          }

          // ===================================================================
          // 5. ÂêØÂä®ÔºÅ

          // Paging Logic (Home Screen Slider)
          const slider = document.querySelector(".home-screen-slider");
          const dots = document.querySelectorAll(".home-screen-dots .dot");
          if (slider && dots.length) {
            // 1. Update Dots on Scroll
            slider.addEventListener("scroll", () => {
              const pageIndex = Math.round(
                slider.scrollLeft / slider.clientWidth,
              );
              dots.forEach((d, i) => {
                d.style.opacity = i === pageIndex ? "1" : "0.4";
                d.classList.toggle("active", i === pageIndex);
              });
            });

            // 2. Mouse Drag Support
            let isDown = false;
            let startX;
            let scrollLeft;

            slider.addEventListener("mousedown", (e) => {
              isDown = true;
              slider.style.cursor = "grabbing";
              slider.style.scrollSnapType = "none"; // Disable snap while dragging
              startX = e.pageX - slider.offsetLeft;
              scrollLeft = slider.scrollLeft;
            });

            const snapToPage = () => {
              isDown = false;
              slider.style.cursor = "grab";
              slider.style.scrollSnapType = "x mandatory"; // Re-enable snap
              // Manual smooth snap to nearest page
              const pageIndex = Math.round(
                slider.scrollLeft / slider.clientWidth,
              );
              slider.scrollTo({
                left: pageIndex * slider.clientWidth,
                behavior: "smooth",
              });
            };

            slider.addEventListener("mouseleave", () => {
              if (isDown) snapToPage();
            });

            slider.addEventListener("mouseup", () => {
              if (isDown) snapToPage();
            });

            slider.addEventListener("mousemove", (e) => {
              if (!isDown) return;
              e.preventDefault();
              const x = e.pageX - slider.offsetLeft;
              const walk = (x - startX) * 1.5; // Drag speed multiplier
              slider.scrollLeft = scrollLeft - walk;
            });
          }

          showScreen("home-screen");
        }

        init();
      });
    </script>
  </body>
</html>
